{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"Istio &amp; Service Mesh \u6218\u672f\u6559\u7a0b","text":"<p>Started at Augest 2021 By Jacob Xi </p>"},{"location":"#about-this-tutorial","title":"About this tutorial","text":"<p>This books is my 7th tech books published in almost 5 months. And this book is my most exhausted and hardworking book so far. The weather is getting cooler and cooler\ud83e\udd76 and  double eleven is around the corner. Totally no idea what should I buy. Really appricate our team colleagues and friends' support and instruction.</p> <p></p>"},{"location":"#description","title":"Description","text":"<p><code>istio</code> \u662f\u7531 Google\u3001IBM\u3001Lyft \u7b49\u5171\u540c\u5f00\u6e90\u7684 <code>Service Mesh</code>\uff08\u670d\u52a1\u7f51\u683c\uff09\u6846\u67b6\uff0c\u4e8e2017\u5e74\u521d\u5f00\u59cb\u8fdb\u5165\u5927\u4f17\u89c6\u91ce\u3002<code>Kubernetes</code> \u89e3\u51b3\u4e86\u4e91\u539f\u751f\u5e94\u7528\u7684\u90e8\u7f72\u95ee\u9898\uff0c<code>istio</code> \u89e3\u51b3\u7684\u662f\u5e94\u7528\u7684\u670d\u52a1\uff08\u6d41\u91cf\uff09\u6cbb\u7406\u95ee\u9898\u3002\u968f\u7740 2018\u5e747\u670831\u65e5 istio 1.0 \u53d1\u5e03\uff0cistio \u672c\u8eab\u5df2\u7ecf\u65e5\u8d8b\u7a33\u5b9a\u3002</p> <p>\u4e3b\u9898\u6709\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ul> <li>\u5fae\u670d\u52a1\u548c Service Mesh \u6838\u5fc3\u7ec4\u4ef6 \uff08Service Mesh \u67b6\u6784\u5206\u6790\uff0c\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\uff0c\u8d1f\u8f7d\u5747\u8861\u5668\uff0c \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565\uff0c \u8fde\u63a5\u6c60\uff0c\u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff09</li> <li>Service Mesh \u5b9e\u6218<ul> <li><code>VirtualService</code> \u5728 Istio \u670d\u52a1\u7f51\u683c\u4e2d\u5b9a\u4e49\u8def\u7531\u89c4\u5219\uff0c\u63a7\u5236\u8def\u7531\u5982\u4f55\u8def\u7531\u5230\u670d\u52a1\u4e0a\u3002</li> <li><code>DestinationRule</code> \u662f <code>VirtualService</code> \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6\u3002</li> <li><code>ServiceEntry</code> \u662f\u901a\u5e38\u7528\u4e8e\u5728 Istio \u670d\u52a1\u7f51\u683c\u4e4b\u5916\u542f\u7528\u5bf9\u670d\u52a1\u7684\u8bf7\u6c42\u3002</li> <li><code>Gateway</code> \u4e3a <code>HTTP/TCP</code> \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u6700\u5e38\u89c1\u7684\u662f\u5728\u7f51\u683c\u7684\u8fb9\u7f18\u7684\u64cd\u4f5c\uff0c\u4ee5\u542f\u7528\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\u6d41\u91cf\u3002</li> </ul> </li> <li>Istio\u57fa\u7840\u6559\u5b66</li> <li>Istio\u9ad8\u7ea7\u6559\u5b66 (1.10.3)-Bookinfo \u6d41\u91cf\u7ba1\u7406</li> <li>Istio \u9ad8\u7ea7\u6559\u5b66\u4e0e\u5b9e\u8df5</li> <li>\u5b9e\u9a8c\u4e0e\u6559\u5b66bookinfo(istio-1.3)-old</li> <li>JenkinsX + Istio\u6e10\u8fdb\u5f0f\u4ea4\u4ed8</li> <li>Tetrate Istio\u57fa\u7840\u57f9\u8bad\u4e0e\u5b9e\u9a8c\u6d4b\u8bd5</li> <li>Istio\u65e5\u5e38\u64cd\u4f5c\u4e0e\u6280\u5de7</li> </ul> <p> </p> <p>Envoy \u5165\u95e8\u6559\u7a0b</p> <p>https://tetrate-academy.thinkific.com/certificates/5b9sjc8qmc</p>"},{"location":"#previous-on-my-technolog-book","title":"Previous on my Technolog book","text":"<p>\u624b\u6478\u624b Jenkins \u6218\u672f\u6559\u7a0b (\u5927\u5e08\u7248\uff09</p> <p>\u624b\u6478\u624b Elasticsearch7 \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Redis \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Chef &amp; Ansible \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b \u5206\u5e03\u5f0f\u4e0e\u6d41\u5f0f\u7cfb\u7edf (In progress)</p> <p>Azure 103&amp;900 Tutorial (In progress)</p> <p>\u624b\u6478\u624b Linux Performance &amp; \u9762\u8bd5\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Databases \u5168\u6559\u7a0b</p> <p>AWS Certified Data Analytics Tutorial</p>"},{"location":"#salut-cest-moi","title":"Salut! C'est Moi","text":"<p>petite a petit l'oiseau fait son nid</p> <p>Hello, this is me, Jacob. Currently, I'm working as DevOps and Cloud Engineer in SAP, and I'm the certified AWS Solution Architect and Certified Azure Administrator, Kubernetes Specialist, Jenkins CI/CD and ElasticStack enthusiast. </p> <p>I was working as Backend Engineer in New York City and achieved my CS master degree in SIT, America. Believe it or not, I'll keep writing, more and more books will come out at such dramatic and unprecedented 2021. </p> <p>If you have anything want to talk to me directly, you can reach out for via email xichao2015@outlook.com\u3002</p> <p>Salute, c'est moi, Jacob. Actuellement, je travaille en tant qu'ing\u00e9nieur DevOps et Cloud dans SAP, et je suis architecte de solution AWS certifi\u00e9 et administrateur Azure certifi\u00e9, sp\u00e9cialiste Kubernetes et passionn\u00e9 de CI/CD.</p> <p>Je travaillais en tant qu'ing\u00e9nieur backend \u00e0 New York et j'ai obtenu mon master CS \u00e0 SIT, en Am\u00e9rique. Croyez-le ou non, je continuerai \u00e0 \u00e9crire, de plus en plus de livres sortiront cette ann\u00e9e.</p>"},{"location":"#tutorial-content","title":"Tutorial content","text":"<ul> <li>\u7b2c\u4e00\u7ae0: \u5fae\u670d\u52a1\u548c Service Mesh \u6838\u5fc3\u7ec4\u4ef6<ul> <li>\u7b2c\u4e00\u8282 Service Mesh \u5b66\u4e60\u4e0e\u67b6\u6784\u5206\u6790</li> <li>\u7b2c\u4e8c\u8282 \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3</li> <li>\u7b2c\u4e09\u8282 \u8d1f\u8f7d\u5747\u8861\u5668</li> <li>\u7b2c\u56db\u8282 \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565</li> <li>\u7b2c\u4e94\u8282 \u8fde\u63a5\u6c60\uff1a\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u5f02</li> <li>\u7b2c\u516d\u8282 \u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff1a\u7f51\u5173\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u4f5c\u7528</li> <li>\u7b2c\u4e03\u8282 \u5fae\u670d\u52a1\u6cbb\u7406\u7684\u914d\u7f6e\u4e2d\u5fc3</li> <li>\u7b2c\u516b\u8282 Trace \u66f4\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898</li> <li>\u7b2c\u4e5d\u8282 \u5229\u7528 Prometheus \u548c Grafana \u6536\u96c6\u76d1\u63a7\u6570\u636e</li> </ul> </li> <li>\u7b2c\u4e8c\u7ae0: Service Mesh \u5b9e\u6218<ul> <li>\u7b2c\u4e00\u8282 Service Mesh \u5f00\u6e90\u4ea7\u54c1\u4e2d\u7684\u6280\u672f\u9009\u578b</li> <li>\u7b2c\u4e8c\u8282 \u6700\u5e38\u7528\u7684\u6570\u636e\u9762 Envoy\u4ecb\u7ecd </li> <li>\u7b2c\u4e09\u8282 Istio \u5165\u95e8\uff1a\u57fa\u4e8e\u6700\u65b0 1.7 \u7248\u672c\u7684\u73af\u5883\u642d\u5efa\u548c\u4ecb\u7ecd</li> <li>\u7b2c\u56db\u8282 xDS\uff1a\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u901a\u4fe1\u6865\u6881</li> <li>\u7b2c\u4e94\u8282 Ingress \u548c Egress\uff1a\u5165\u53e3\u6d41\u91cf\u548c\u51fa\u53e3\u6d41\u91cf\u63a7\u5236</li> <li>\u7b2c\u516d\u8282 \u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u7248\u672c\u63a7\u5236</li> <li>\u7b2c\u4e03\u8282 \u5982\u4f55\u5229\u7528\u7ec4\u4ef6\u505a\u5230\u670d\u52a1\u7684\u53ef\u89c2\u6d4b\u6027</li> <li>\u7b2c\u516b\u8282 Proj\u9879\u76ee\u843d\u5730: Go \u5b9e\u73b0 Service Mesh</li> <li>\u7b2c\u4e5d\u8282 Service Mesh \u843d\u5730\u548c\u5c55\u671b</li> <li>\u7b2c\u5341\u8282 Mesh\u7684\u672a\u6765\u53d1\u5c55\u4e0e\u53ef\u884c\u6027\u65b9\u5411</li> </ul> </li> <li>\u7b2c\u4e09\u7ae0: Istio\u57fa\u7840\u6559\u5b66<ul> <li>\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c(Service Mesh)\u662f\u4ec0\u4e48?</li> <li>\u7b2c\u4e8c\u8282 Istio \u67b6\u6784\u4e0e\u6280\u672f</li> <li>\u7b2c\u4e09\u8282 Istio \u670d\u52a1\u53d1\u73b0\u548c Pilot\u7684\u67b6\u6784\u673a\u5236</li> <li>\u7b2c\u56db\u8282 Gateway \u8bbe\u8ba1\u4e0e\u5b9e\u73b0</li> <li>\u7b2c\u4e94\u8282 Istio \u7070\u5ea6\u53d1\u5e03\u4e0e\u6280\u672f\u5b9e\u73b0</li> <li>\u7b2c\u516d\u8282 xDS\u534f\u8bae\u89e3\u6790</li> <li>\u7b2c\u4e03\u8282 Mixer\u57fa\u7840\u4e0e\u5b9e\u73b0</li> </ul> </li> <li>\u7b2c\u56db\u7ae0: Istio(1.10.3)-Bookinfo \u6d41\u91cf\u7ba1\u7406<ul> <li>\u7b2c\u4e00\u8282 2021 Service Mesh &amp; Istio \u4ecb\u7ecd/\u5b89\u88c5(1.10.3)</li> <li>\u7b2c\u4e8c\u8282 \u4f7f\u7528 Istio \u5b9e\u73b0\u975e\u4fb5\u5165\u6d41\u91cf\u6cbb\u7406</li> <li>\u7b2c\u4e09\u8282 Istio \u6d41\u91cf\u7ba1\u7406\u4e4b\u6545\u969c\u6ce8\u5165</li> <li>\u7b2c\u56db\u8282 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def</li> </ul> </li> <li>\u7b2c\u4e94\u7ae0: Istio(1.10.3)-Bookinfo \u6d41\u91cf\u7ba1\u7406<ul> <li>\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u7684\u57fa\u672c\u7279\u5f81</li> <li>\u7b2c\u4e8c\u8282 Istio \u57fa\u672c\u4ecb\u7ecd</li> <li>\u7b2c\u4e09\u8282 Istio, Service Mesh \u5feb\u901f\u5165\u95e8Istio 1.1.16 </li> <li>\u7b2c\u56db\u8282 \u7528Helm\u90e8\u7f72Istio</li> <li>\u7b2c\u4e94\u8282 Istio \u5e38\u7528\u529f\u80fd \uff08\u81ea\u52a8/\u624b\u52a8\u90e8\u7f72Istio\u5e94\u7528\uff09</li> <li>\u7b2c\u516d\u8282 \u4f7f\u7528 Istio Dashboard Grafana / Prometheus</li> <li>\u7b2c\u4e03\u8282 \u4f7f\u7528 Istio Dashboard</li> <li>\u7b2c\u516b\u8282 \u4f7f\u7528Kiali</li> <li>\u7b2c\u4e5d\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u76ee\u6807\u89c4\u5219/\u9ed8\u8ba4\u8def\u7531/\u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb)</li> <li>\u7b2c\u5341\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u91d1\u4e1d\u96c0\u90e8\u7f72/\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531/URI\u8fdb\u884c\u91cd\u5b9a\u5411)</li> <li>\u7b2c\u5341\u4e00\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u901a\u4fe1\u8d85\u65f6/\u6545\u969c\u91cd\u8bd5/\u5165\u53e3~\u51fa\u53e3\u6d41\u91cf\u7ba1\u7406)</li> <li>\u7b2c\u5341\u4e8c\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u670d\u52a1\u7194\u65ad/\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5/\u6ce8\u5165\u4e2d\u65ad/\u6d41\u91cf\u590d\u5236)</li> <li>\u7b2c\u5341\u4e09\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(\u7b80\u4ecb/Denier\u8bbf\u95ee\u63a7\u5236/Listchecker\u8bbf\u95ee\u63a7\u5236)</li> <li>\u7b2c\u5341\u56db\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(MemQuota\u670d\u52a1\u9650\u6d41/Mixer\u5bf9\u8c61\u7684\u5b9a\u4e49/RedisQuota\u670d\u52a1\u9650\u6d41)</li> <li>\u7b2c\u5341\u4e94\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528 - \u4e3aPrometheus\u5b9a\u4e49\u76d1\u63a7\u6307\u6807</li> <li>\u7b2c\u5341\u516d\u8282 \u4f7f\u7528stdio\u8f93\u51fa\u81ea\u5b9a\u4e49\u65e5\u5fd7</li> <li>\u7b2c\u5341\u4e03\u8282 \u4f7f\u7528Fluentd\u8f93\u51fa\u65e5\u5fd7</li> <li>\u7b2c\u5341\u516b\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa\uff08\u542f\u7528mTLS\\\u52a0\u56fa\u6982\u8ff0)</li> <li>\u7b2c\u5341\u4e5d\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa(RBAC\u8bbe\u7f6e\\\u62cd\u9519))</li> <li>\u7b2c\u4e8c\u5341\u8282 Istio\u7684\u8bd5\u7528\u5efa\u8bae</li> </ul> </li> <li>\u7b2c\u516d\u7ae0: \u5b9e\u9a8c\u4e0e\u6559\u5b66bookinfo(istio-1.3)-old<ul> <li>L1 Docker for Mac\u5b89\u88c5istio(k8s-1.10/istio-1.3)</li> <li>L2 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u670d\u52a1\u7248\u672c/\u57fa\u4e8e\u6743\u91cd/\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9)</li> <li>L3 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u5ef6\u8fdf\u8bbf\u95ee/\u4e2d\u65ad\u8bbf\u95ee/\u4e0d\u540c\u73af\u5883/\u670d\u52a1\u7f51\u683c\u5916)</li> </ul> </li> <li>\u7b2c\u4e03\u7ae0: JenkinsX + Istio\u6e10\u8fdb\u5f0f\u4ea4\u4ed8<ul> <li>L1 Kubernetes \u4e2d\u7684\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u84dd\u7eff\u90e8\u7f72\u548c\u91d1\u4e1d\u96c0\u90e8\u7f72, shipper, Istio, Flagger</li> <li>L2 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8</li> <li>L3 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u90e8\u7f72</li> </ul> </li> <li>\u7b2c\u516b\u7ae0: Tetrate Istio\u57fa\u7840\u57f9\u8bad\u4e0e\u5b9e\u9a8c\u6d4b\u8bd5<ul> <li>\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8</li> <li>\u7b2c\u4e8c\u8282 \u5b89\u88c5 Istio</li> <li>\u7b2c\u4e09\u8282 \u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7</li> <li>\u7b2c\u56db\u8282 \u6d41\u91cf\u7ba1\u7406</li> <li>\u7b2c\u4e94\u8282 \u6d41\u91cf\u7ba1\u7406\u5b9e\u9a8c\u4e0e\u6d4b\u8bd5</li> <li>\u7b2c\u516d\u8282 Istio Secuirty</li> <li>\u7b2c\u4e03\u8282 Istio\u9ad8\u7ea7\u529f\u80fd</li> <li>\u7b2c\u516b\u8282 Istio \u95ee\u9898\u6392\u67e5</li> <li>\u7b2c\u4e5d\u8282 \u5b9e\u9645\u6848\u4f8b</li> <li>\u7b2c\u5341\u8282 \u672f\u8bed\u8868</li> </ul> </li> <li>\u7b2c\u4e5d\u7ae0: Istio\u65e5\u5e38\u64cd\u4f5c\u4e0e\u6280\u5de7<ul> <li>\u7b2c\u4e00\u8282 istio\u6d45\u6790 (Slide\u5907\u6848\uff09</li> <li>\u7b2c\u4e8c\u8282 Istio \u5b89\u5168\u6700\u4f73\u5b9e\u8df5</li> <li>\u7b2c\u4e09\u8282 \u8bb0\u4e00\u6b21 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def</li> <li>\u7b2c\u56db\u8282 \u4f7f\u7528 Istio \u7684\u5341\u4e2a\u6280\u5de7</li> </ul> </li> </ul>"},{"location":"#to-be-continue","title":"To be continue","text":"<p>I will put more effort do finish \"Azure 103&amp;900 Tutorial book\" and \"Distributed Message System Book\" this month hopefully. And starting working on \"AWS Solution Arcitect\" and \"Prometheus &amp; APM monitoring\", please waiting for it.\ud83d\ude42</p> <p> </p>"},{"location":"chap1/1chap1_learn_SM/","title":"\u7b2c\u4e00\u8282 Service Mesh \u5b66\u4e60\u4e0e\u67b6\u6784\u5206\u6790","text":""},{"location":"chap1/1chap1_learn_SM/#1-service-mesh","title":"1\u3001\u4e3a\u4ec0\u4e48\u8981\u5b66\u4e60 Service Mesh\uff1f","text":"<ul> <li>\u5fae\u670d\u52a1\u5728\u4e1a\u5185\u7684\u5b9e\u8df5\u5df2\u7ecf\u4ece\u6d41\u884c\u8d70\u5411\u6210\u719f</li> <li>\u5fae\u670d\u52a1\u67b6\u6784\u4f7f\u5e94\u7528\u7a0b\u5e8f\u66f4\u6613\u4e8e\u6269\u5c55\u3001\u66f4\u5feb\u5f00\u53d1\uff0c\u4ece\u800c\u52a0\u901f\u521b\u65b0\u5e76\u7f29\u77ed\u65b0\u529f\u80fd\u7684\u4e0a\u5e02\u65f6\u95f4</li> <li>\u4e0e\u5355\u4f53\u5e94\u7528\u76f8\u6bd4\uff0c\u5fae\u670d\u52a1\u80fd\u591f\u66f4\u597d\u5730\u6ee1\u8db3\u4e92\u8054\u7f51\u65f6\u4ee3\u4e1a\u52a1\u5feb\u901f\u53d8\u5316\u7684\u9700\u8981</li> </ul>"},{"location":"chap1/1chap1_learn_SM/#1-1","title":"1-1 \u5fae\u670d\u52a1\u67b6\u6784\u4e5f\u4e0d\u662f\u94f6\u5f39","text":"<p>Service Mesh \uff08\u670d\u52a1\u7f51\u683c\uff09\u662f\u4e00\u4e2a\u7528\u4e8e\u5904\u7406\u670d\u52a1\u548c\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff1a</p> <p>\u901a\u8fc7 sidecar \u6a21\u5f0f\u5c06\u539f\u672c\u5728 SDK \u4e2d\u7684\u4ee3\u7801\u72ec\u7acb\u51fa\u6765\uff0c\u7528\u63a7\u5236\u9762\u4ee3\u66ff\u914d\u7f6e\u4e2d\u5fc3\u7684\u90e8\u5206\u529f\u80fd\uff0c\u4ee5\u900f\u660e\u4ee3\u7406\u7684\u5f62\u5f0f\u63d0\u4f9b\u5b89\u5168\u3001\u5feb\u901f\u3001\u53ef\u9760\u7684\u670d\u52a1\u95f4\u901a\u4fe1\uff0c\u540c\u65f6\u4e5f\u80fd\u5b9e\u73b0\u5fae\u670d\u52a1\u6240\u9700\u7684\u57fa\u672c\u7ec4\u4ef6\u529f\u80fd\u3002</p> <p>\u4f60\u53ef\u4ee5\u628a Service Mesh \u770b\u4f5c\u662f\u5206\u5e03\u5f0f\u7684\u5fae\u670d\u52a1\u4ee3\u7406\u3002</p>"},{"location":"chap1/1chap1_learn_SM/#2service-mesh","title":"2\u3001Service Mesh\uff1a\u4ece\u5355\u4f53\u670d\u52a1\u51fa\u53d1\uff0c\u72ec\u7acb\u4e8e\u4e1a\u52a1\u6f14\u8fdb\u7684\u5fae\u670d\u52a1\u67b6\u6784","text":""},{"location":"chap1/1chap1_learn_SM/#2-1","title":"2-1 \u5355\u4f53\u670d\u52a1\u67b6\u6784\u6709\u54ea\u4e9b\u95ee\u9898","text":"<ul> <li>\u6240\u6709\u7684\u529f\u80fd\u6a21\u5757\u90fd\u5728\u4e00\u4e2a\u4ee3\u7801\u4ed3\u5e93\uff0c\u5e76\u4e14\u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u8fdb\u7a0b\u5185\uff0c\u662f\u4e00\u4e2a\u5178\u578b\u7684\u5355\u4f53\u67b6\u6784\u3002</li> <li>\u5927\u91cf\u590d\u6742\u7684\u4e1a\u52a1\u5197\u6742\u5728\u4e00\u4e2a\u5355\u4f53\u5e94\u7528\u4e2d\uff0c\u9020\u6210\u4e86\u4eba\u5458\u6c9f\u901a\u6210\u672c\u548c\u53d1\u5e03\u8fed\u4ee3\u6210\u672c\u7684\u6025\u5267\u4e0a\u5347\u3002</li> </ul>"},{"location":"chap1/1chap1_learn_SM/#2-2","title":"2-2 \u5355\u4f53\u670d\u52a1\u7684\u95ee\u9898","text":"<ol> <li>\u4eba\u5458\u534f\u4f5c\u95ee\u9898</li> <li>\u90e8\u7f72\u95ee\u9898</li> <li>\u67b6\u6784\u6f14\u8fdb\u95ee\u9898</li> <li>\u7a0b\u5e8f\u7a33\u5b9a\u6027\u95ee\u9898</li> </ol> <p>\u5728\u5355\u4f53\u5e94\u7528\u4e2d\uff0c\u67d0\u4e2a\u6a21\u5757\u51fa\u73b0 Bug \u65f6\uff0c\u6bd4\u5982\u56e0\u4e3a\u758f\u5ffd\u9020\u6210\u4e86 OOM (\u7a0b\u5e8f\u5185\u5b58\u4e0d\u8db3)\uff0c\u5bfc\u81f4\u7a0b\u5e8f panic\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u6574\u4e2a\u7f51\u7ad9\u6216\u8005 App \u4e0d\u53ef\u7528\u3002\u4e00\u4e2a\u6a21\u5757\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u4e86\u6574\u4e2a\u5e94\u7528\u6302\u6389\uff0c\u8fd9\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u662f\u65e0\u6cd5\u63a5\u53d7\u7684\u3002</p> <p>\u968f\u7740\u4e92\u8054\u7f51\u4e1a\u52a1\u7684\u53d1\u5c55\uff0c\u6574\u4f53\u4e1a\u52a1\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u4ee5\u4e0a\u95ee\u9898\u8d8a\u6765\u8d8a\u660e\u663e\uff0c\u5355\u4f53\u670d\u52a1\u5df2\u7ecf\u65e0\u6cd5\u5e94\u5bf9\u5982\u6b64\u590d\u6742\u7684\u4e1a\u52a1\u573a\u666f\u4e86\u3002\u4e92\u8054\u7f51\u884c\u4e1a\u4e5f\u4ece\u67b6\u6784\u4e0a\u9010\u6b65\u5f00\u59cb\u4e86\u670d\u52a1\u62c6\u5206\uff0c\u8fdb\u5165\u4e86 SOA \uff08Service-Oriented Architecture \u9762\u5411\u670d\u52a1\u7684\u67b6\u6784\uff09\u65f6\u4ee3\u3002</p>"},{"location":"chap1/1chap1_learn_SM/#2-3","title":"2-3 \u5fae\u670d\u52a1\u6709\u54ea\u4e9b\u4f18\u52bf","text":"<p>\u5fae\u670d\u52a1\u662f\u4e00\u79cd\u5f00\u53d1\u8f6f\u4ef6\u7684\u67b6\u6784\u548c\u7ec4\u7ec7\u65b9\u6cd5\uff0c\u5176\u4e2d\u8f6f\u4ef6\u7531\u901a\u8fc7\u660e\u786e\u5b9a\u4e49\u7684 API \u8fdb\u884c\u901a\u4fe1\u7684\u5c0f\u578b\u72ec\u7acb\u670d\u52a1\u7ec4\u6210\uff0c\u8fd9\u4e9b\u670d\u52a1\u7531\u5404\u4e2a\u5c0f\u578b\u72ec\u7acb\u56e2\u961f\u8d1f\u8d23\u3002\u5fae\u670d\u52a1\u67b6\u6784\u4f7f\u5e94\u7528\u7a0b\u5e8f\u66f4\u6613\u4e8e\u6269\u5c55\u3001\u66f4\u5feb\u5f00\u53d1\uff0c\u4ece\u800c\u52a0\u901f\u521b\u65b0\u5e76\u7f29\u77ed\u65b0\u529f\u80fd\u7684\u4e0a\u5e02\u65f6\u95f4</p> <p>1.\u654f\u6377\u5f00\u53d1</p> <p>2.\u6280\u672f\u81ea\u7531</p> <p>3.\u5f39\u6027\u6269\u7f29\u5bb9</p> <p>4.\u7ec4\u7ec7\u5339\u914d</p> <p>\u5fae\u670d\u52a1\u67b6\u6784\u53ef\u4ee5\u975e\u5e38\u597d\u5730\u4e0e\u7ec4\u7ec7\u67b6\u6784\u76f8\u5339\u914d\uff0c\u6bd4\u5982\u4e00\u4e2a\u77ed\u89c6\u9891\u4e1a\u52a1\uff0c\u5728\u4e1a\u52a1\u53d1\u5c55\u5230\u4e00\u5b9a\u9636\u6bb5\uff0c\u5f88\u81ea\u7136\u5730\u4f1a\u62c6\u5206\u51fa\u7528\u6237\u589e\u957f\u90e8\u95e8\u548c\u5185\u5bb9\u90e8\u95e8\u3002</p>"},{"location":"chap1/1chap1_learn_SM/#2-4-service-mesh","title":"2-4 Service Mesh\uff0c\u4e2d\u6587\u540d\u53eb\u4f5c\u670d\u52a1\u7f51\u683c","text":"<p>\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5c06\u53ef\u4ee5\u914d\u7f6e\u7684\u4ee3\u7406\u5c42\u548c\u670d\u52a1\u90e8\u7f72\u5728\u4e00\u8d77\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u57fa\u7840\u8bbe\u65bd\u5c42\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5e76\u63d0\u4f9b\u901a\u7528\u7684\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u8eab\u4efd\u9a8c\u8bc1\u3001\u7cbe\u51c6\u8def\u7531\u3001\u670d\u52a1\u9274\u6743\u7b49\u57fa\u7840\u529f\u80fd\u3002</p>"},{"location":"chap1/1chap1_learn_SM/#2-5-service-mesh","title":"2-5 Service Mesh \u7684\u6f14\u8fdb\u5386\u7a0b","text":"<p>sidecar \u65f6\u4ee3</p> <p>\u5b9e\u9645\u4e0a\u65e9\u57282013\u5e74\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u67b6\u6784\u7684\u5927\u89c4\u6a21\u5e94\u7528\u65b9 Netflix\uff0c \u5c31\u53d1\u73b0\u4e86\u5fae\u670d\u52a1\u67b6\u6784\u5728\u8de8\u8bed\u8a00\u4e0a\u7684\u95ee\u9898\u3002Netflix \u5927\u91cf\u4f7f\u7528 Java \u6280\u672f\u6808\uff0c\u4f46\u56e0\u4e3a\u516c\u53f8\u7684\u4e1a\u52a1\u53d1\u5c55\uff0c\u4f7f\u7528\u5355\u4e00\u6280\u672f\u6808\u662f\u4e0d\u73b0\u5b9e\u7684</p> <p>\u628a SDK \u91cc\u7684\u529f\u80fd\u8f6c\u79fb\u5230 sidecar \u4e2d\u3002</p> <p> </p> <p>\u6240\u8c13 sidecar\uff0c \u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u90e8\u7f72\u5728\u672c\u5730\u7684\u4ee3\u7406\u670d\u52a1\u5668\uff0c\u5b83\u65e2\u63a5\u7ba1\u4e86\u5165\u53e3\u6d41\u91cf\uff0c\u4e5f\u63a5\u7ba1\u4e86\u51fa\u53e3\u6d41\u91cf\u3002</p> <p>\u5176\u5b9e\u8fd9\u79cd\u6a21\u5f0f\u8981\u8ffd\u6eaf\u5230 Web Server \u7684\u65f6\u4ee3\uff0c\u6bd4\u5982 Nginx + Php-fpm \u8fd9\u79cd\u6a21\u5f0f\uff0c\u5b9e\u9645\u4e0a Nginx \u4e5f\u662f\u5145\u5f53\u4e86 sidecar \u7684\u89d2\u8272\uff0c\u53ea\u662f\u901a\u4fe1\u534f\u8bae\u7531\u6bd4\u8f83\u5e38\u89c1\u7684 HTTP \uff0c\u53d8\u6210\u4e86 FastCGI \uff0c\u53e6\u5916 Nginx \u53ea\u662f\u4ee3\u7406\u4e86\u5165\u53e3\u6d41\u91cf\uff0c\u5e76\u672a\u4ee3\u7406\u51fa\u53e3\u6d41\u91cf\u3002</p> <p>\u521d\u4ee3 Service Mesh</p> <p>\u7b2c\u4e00\u4ee3 Service Mesh\uff0c\u5176\u4e2d\u6bd4\u8f83\u51fa\u540d\u7684\u662f Linkerd \u548c Envoy\u3002</p> <p>\u5728\u8fd9\u4e00\u4ee3 Service Mesh \u4e2d\uff0c\u5df2\u7ecf\u4e0d\u518d\u4f9d\u8d56\u7279\u5b9a\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u6700\u91cd\u8981\u7684\u662f\u5b83\u7684\u51fa\u53d1\u70b9\u5df2\u7ecf\u4e0d\u662f\u89e3\u51b3\u591a\u8bed\u8a00\u7684\u95ee\u9898\uff0c\u800c\u662f\u4ece\u7edf\u4e00\u6d41\u91cf\u5904\u7406\u6a21\u578b\u7684\u89d2\u5ea6\uff0c\u5f62\u6210\u4e86\u4e00\u5957\u7edf\u4e00\u7684\u6d41\u91cf\u63a7\u5236\u7684\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u4f46\u662f\u521d\u4ee3 Service Mesh \u6709\u4e00\u4e2a\u81f4\u547d\u7684\u95ee\u9898\uff08\u5176\u5b9e\u4e5f\u4e00\u76f4\u5b58\u5728\u4e8e\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff09\uff0c\u5c31\u662f\u7f3a\u4e4f\u7edf\u4e00\u7684\u7ba1\u63a7\u624b\u6bb5\uff0c\u6bd4\u5982 sidecar \u7684\u670d\u52a1\u6cbb\u7406\u76f8\u5173\u914d\u7f6e\u6587\u4ef6\u7684\u7ef4\u62a4\uff0c\u53ef\u80fd\u9700\u8981\u8fd0\u7ef4\u624b\u52a8\u7ef4\u62a4\u3001\u65e0\u6cd5\u96c6\u4e2d\u7ba1\u7406\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u539f\u56e0\uff0c\u63a7\u5236\u9762\u8bde\u751f\u4e86\u3002</p> <p>\u65b0\u4e00\u4ee3 Service Mesh</p> <p>\u65b0\u4e00\u4ee3 Service Mesh\uff0c\u5c31\u662f\u5927\u5bb6\u719f\u77e5\u7684 Istio \u4e86\u3002\u5b83\u5f15\u5165\u4e86\u63a7\u5236\u9762\u7684\u6982\u5ff5\uff0c\u8ba9 Service Mesh \u6210\u4e3a\u5b8c\u5168\u4f53\u3002</p> <p>Istio \u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u63a7\u5236\u9762\u548c Kubernetes \u6df1\u5ea6\u7ed1\u5b9a\uff0c\u65e9\u671f\u7248\u672c\u5c06\u6d41\u91cf\u6cbb\u7406\u7684\u529f\u80fd\u653e\u5728 mixer \u4e2d\uff0c\u5f62\u6210\u4e86\u4e00\u5957\u5b8c\u6574\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\u3002\u63a7\u5236\u9762\u8d1f\u8d23\u4e86\u8d44\u6e90\u7ba1\u7406\u3001\u914d\u7f6e\u4e0b\u53d1\u3001\u8bc1\u4e66\u7ba1\u7406\u7b49\u529f\u80fd\uff0c\u89e3\u51b3\u4e86\u6570\u636e\u9762\u914d\u7f6e\u96be\u4ee5\u7ba1\u7406\u7684\u95ee\u9898\u3002</p>"},{"location":"chap1/1chap1_learn_SM/#2-6-service-mesh","title":"2-6 Service Mesh \u7684\u4f18\u52bf","text":"<p>1.\u8bed\u8a00\u65e0\u5173</p> <p>Service Mesh \u505a\u5230\u4e86\u771f\u6b63\u7684\u8bed\u8a00\u65e0\u5173\uff1a\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u67b6\u6784\u8981\u4e3a\u5404\u79cd\u8bed\u8a00\u5f00\u53d1 SDK \uff0c\u800c Service Mesh \u5c06 SDK \u7684\u529f\u80fd\u96c6\u6210\u5230 sidecar \u4e2d\uff0c\u5b9e\u73b0\u4e86\u771f\u6b63\u7684\u8bed\u8a00\u65e0\u5173\u6027\u3002</p> <p>2.\u57fa\u7840\u8bbe\u65bd\u72ec\u7acb\u6f14\u8fdb</p> <p>Service Mesh \u67b6\u6784\u5c06\u6846\u67b6\u4e2d\u548c\u4e1a\u52a1\u65e0\u5173\u7684\u901a\u7528\u529f\u80fd\u653e\u5728 sidecar \u4e2d\uff0c\u5347\u7ea7\u65f6\u53ea\u8981\u5347\u7ea7 sidecar \u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u6837\u505a\u5230\u4e86\u57fa\u7840\u8bbe\u65bd\u7684\u72ec\u7acb\u6f14\u8fdb\u3002</p> <p>\u5b9e\u9645\u4e0a\u8fd9\u79cd\u505a\u6cd5\u4e5f\u5e26\u6765\u4e86\u53e6\u5916\u4e00\u4e2a\u597d\u5904\uff1a\u5199\u6846\u67b6\u7684\u65f6\u5019\u4e0d\u7528\u518d\u8003\u8651\u592a\u591a\u7684\u5411\u540e\u517c\u5bb9\u6027\uff0c\u964d\u4f4e\u4e86\u7f16\u5199\u4ee3\u7801\u7684\u5fc3\u667a\u8d1f\u62c5\u3002</p> <p>3.\u53ef\u89c2\u6d4b\u6027</p> <p>\u53ef\u89c2\u6d4b\u6027\u4e00\u822c\u5305\u542b\u4e24\u4e2a\u90e8\u5206\uff1a\u76d1\u63a7\u62a5\u8b66\u548c\u94fe\u8def\u8ffd\u8e2a\u3002</p> <ul> <li>\u76d1\u63a7\u62a5\u8b66\u53ef\u4ee5\u901a\u8fc7\u6570\u636e\u9762\u7684 Metrics \u96c6\u6210\uff0c\u65e0\u611f\u77e5\u5730\u505a\u5230\u7cfb\u7edf\u76d1\u63a7\u62a5\u8b66\uff0c\u51cf\u5c11\u4e86\u4e1a\u52a1\u548c\u6846\u67b6\u7684\u91cd\u590d\u5de5\u4f5c\u3002</li> <li>\u81f3\u4e8e\u94fe\u8def\u8ffd\u8e2a\uff0c\u56e0\u4e3a\u9700\u8981\u901a\u8fc7 header \u5c06 traceid \u4f20\u9012\u4e0b\u53bb\uff0c\u6240\u4ee5\u8fd8\u662f\u9700\u8981\u5ba2\u6237\u7aef\u7684 SDK \u5c06 traceid \u901a\u8fc7 header \u4f20\u9012\u3002\u4e0d\u8fc7\u8fd9\u4e2a\u505a\u6cd5\u4e5f\u7b80\u5316\u4e86 Trace SDK \u7684\u5c01\u88c5\u3002</li> </ul> <p>4.\u8fb9\u7f18\u7f51\u5173\u7edf\u4e00</p> <p>\u5b9e\u9645\u4e0a sidecar \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u7f51\u5173/\u53cd\u5411\u4ee3\u7406\uff0c\u81ea\u7136\u53ef\u4ee5\u5c06\u4ee5\u524d Nginx/Kong \u4e4b\u7c7b\u7684\u7cfb\u7edf\u7f51\u5173\u8fc1\u79fb\u5230 sidecar \u4e0a\u6765\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7ef4\u62a4\u4e00\u5957\u7edf\u4e00\u7684\u4ee3\u7801\u3002</p> <p>\u66f4\u8fdb\u4e00\u6b65\uff0c\u53ef\u4ee5\u5c06\u4ee5\u524d\u8fb9\u7f18\u7f51\u5173\u7684\u5de5\u4f5c\uff0c\u6bd4\u5982\u9274\u6743\u3001 trace \u521d\u59cb\u5316\u7b49\u5de5\u4f5c\u4e0b\u6c89\u5230 sidecar \u4e0a\uff0c\u8fdb\u4e00\u6b65\u7b80\u5316\u7cfb\u7edf\u7f51\u5173\u7684\u529f\u80fd\u3002</p>"},{"location":"chap1/1chap1_learn_SM/#2-6-service-mesh_1","title":"2-6 Service Mesh \u7684\u57fa\u7840\u7ec4\u4ef6\u53ca\u5e38\u89c1\u540d\u8bcd","text":"<p>Service Mesh \u4e00\u4e2a\u6700\u91cd\u8981\u7684\u53d8\u9769\uff0c\u5c31\u662f\u5f15\u5165\u4e86\u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u7684\u6982\u5ff5\uff0c\u8fd9\u4e2a\u6982\u5ff5\u4e5f\u5e76\u975e Service Mesh \u65b0\u521b\u7684\u6982\u5ff5\uff0c\u5b9e\u9645\u4e0a\u5728 SDN (\u8f6f\u4ef6\u5b9a\u4e49\u7f51\u7edc)\u4e2d\u5c31\u6709\u4e86\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u6982\u5ff5\u3002</p> <p>1 \u6570\u636e\u9762(Data Plane)</p> <p>\u8d1f\u8d23\u6570\u636e\u7684\u8f6c\u53d1\uff0c\u4e00\u822c\u6211\u4eec\u5e38\u89c1\u7684\u901a\u7528\u7f51\u5173\u3001Web Server\uff0c\u6bd4\u5982 Nginx\u3001Traefik \u90fd\u53ef\u4ee5\u8ba4\u4e3a\u662f\u6570\u636e\u9762\u7684\u4e00\u79cd\u3002\u5728 Service Mesh \u7684\u5f00\u6e90\u4e16\u754c\u4e2d\uff0cEnvoy \u53ef\u4ee5\u8bf4\u662f\u6700\u77e5\u540d\u7684\u6570\u636e\u9762\u4e86\u3002</p> <p>\u53e6\u5916\u6570\u636e\u9762\u5e76\u975e\u5c40\u9650\u4e8e\u7f51\u5173\u7c7b\u4ea7\u54c1\uff0c\u5b9e\u9645\u4e0a\u67d0\u4e9b RPC \u6846\u67b6\u4e5f\u53ef\u4ee5\u5145\u5f53\u6570\u636e\u9762\uff0c\u6bd4\u5982 gRPC \u5c31\u5df2\u7ecf\u652f\u6301\u5b8c\u6574\u7684 xDS(\u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u7684\u4ea4\u4e92\u534f\u8bae)\uff0c\u4e5f\u53ef\u4ee5\u5f53\u4f5c\u6570\u636e\u9762\u4f7f\u7528\u3002</p> <p>\u4e00\u822c\u6211\u4eec\u628a\u8d1f\u8d23\u6570\u636e\u8f6c\u53d1\u7684\u6570\u636e\u9762\u79f0\u4e3a sidecar\uff08\u8fb9\u8f66\uff09\u3002</p> <p>2 \u63a7\u5236\u9762(Control Plane)</p> <p>\u901a\u8fc7 xDS \u534f\u8bae\u5bf9\u6570\u636e\u9762\u8fdb\u884c\u914d\u7f6e\u4e0b\u53d1\uff0c\u4ee5\u63a7\u5236\u6570\u636e\u9762\u7684\u884c\u4e3a\uff0c\u6bd4\u5982\u8def\u7531\u8f6c\u53d1\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u6cbb\u7406\u7b49\u914d\u7f6e\u4e0b\u53d1\u3002</p> <p>\u63a7\u5236\u9762\u7684\u51fa\u73b0\u89e3\u51b3\u4e86\u65e0\u8bba\u662f\u6846\u67b6\u8fd8\u662f\u6570\u636e\u9762\u3001sidecar \u90fd\u7f3a\u4e4f\u63a7\u5236\u80fd\u529b\u7684\u5f0a\u7aef\uff0c\u800c\u4e14\u4e4b\u524d\u53ea\u80fd\u901a\u8fc7\u8fd0\u7ef4\u6279\u91cf\u4fee\u6539 CONF \u6765\u63a7\u5236\u6570\u636e\u9762\u3001\u5bfc\u81f4\u89c4\u6a21\u4e0a\u5347\u65f6\u7eaf\u4eba\u5de5\u7ef4\u62a4\u6210\u672c\u4ee5\u53ca\u5927\u5e45\u5ea6\u4e0a\u5347\u7684\u9519\u8bef\u6982\u7387\u7b49\u95ee\u9898\u4e5f\u5f97\u5230\u4e86\u5f88\u597d\u7684\u89e3\u51b3\u3002</p> <p>\u5b9e\u9645\u4e0a Service Mesh \u9700\u8981\u7684\u57fa\u7840\u7ec4\u4ef6\u548c\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u6ca1\u6709\u592a\u5927\u7684\u5dee\u522b\uff0c\u5f88\u591a\u516c\u53f8\u9009\u62e9\u81ea\u7814\u63a7\u5236\u9762\u5c31\u662f\u4e3a\u4e86\u517c\u5bb9\u8001\u7248\u672c\u5fae\u670d\u52a1\u7684\u57fa\u7840\u7ec4\u4ef6\u3002</p>"},{"location":"chap1/1chap1_learn_SM/#2-8-service-mesh","title":"2-8 Service Mesh \u7684\u57fa\u7840\u7ec4\u4ef6","text":"<ul> <li>\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\uff1a\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u7ec4\u4ef6\u3002\u670d\u52a1\u901a\u8fc7\u6ce8\u518c\u81ea\u8eab\u8282\u70b9\uff0c\u8ba9\u8c03\u7528\u65b9\u670d\u52a1\u53d1\u73b0\u88ab\u8c03\u65b9\u670d\u52a1\u8282\u70b9\uff0c\u4ee5\u8fbe\u5230\u670d\u52a1\u95f4\u70b9\u5bf9\u70b9\u901a\u4fe1\u7684\u76ee\u7684\u3002</li> <li>\u914d\u7f6e\u4e2d\u5fc3\uff1a\u7528\u4e8e\u670d\u52a1\u7684\u57fa\u7840\u914d\u7f6e\u66f4\u65b0\uff0c\u4ee5\u8fbe\u5230\u4ee3\u7801\u548c\u914d\u7f6e\u5206\u79bb\u7684\u76ee\u7684\u3002\u51cf\u5c11\u670d\u52a1\u7684\u53d1\u5e03\u6b21\u6570\uff0c\u914d\u7f6e\u53d1\u5e03\u53ef\u4ee5\u66f4\u5feb\u66f4\u53ca\u65f6\u5730\u53d8\u66f4\u670d\u52a1\u3002</li> <li>API \u7f51\u5173\uff1a\u901a\u8fc7\u7edf\u4e00\u7684\u7f51\u5173\u5c42\uff0c\u6536\u655b\u670d\u52a1\u7684\u7edf\u4e00\u9274\u6743\u5c42\u3001\u94fe\u8def ID \u751f\u6210\u7b49\u57fa\u7840\u670d\u52a1\uff0c\u5e76\u805a\u5408\u540e\u7aef\u670d\u52a1\u4e3a\u5ba2\u6237\u7aef\u63d0\u4f9b RESTful \u63a5\u53e3\u3002\u53e6\u5916 API \u7f51\u5173\u4e5f\u8d1f\u8d23\u5357\u5317\u5411\u6d41\u91cf(\u5916\u7f51\u5165\u53e3\u6d41\u91cf)\u7684\u6d41\u91cf\u6cbb\u7406\u3002</li> <li>\u670d\u52a1\u6cbb\u7406\uff1a\u901a\u8fc7\u9650\u6d41\u3001\u7194\u65ad\u7b49\u57fa\u7840\u7ec4\u4ef6\uff0c\u675c\u7edd\u5fae\u670d\u52a1\u67b6\u6784\u51fa\u73b0\u96ea\u5d29\u7684\u9690\u60a3\u3002</li> <li>\u94fe\u8def\u8ffd\u8e2a\uff1a\u901a\u8fc7 trace \u5c06\u6574\u4e2a\u5fae\u670d\u52a1\u94fe\u8def\u6e05\u6670\u5730\u7ed8\u5236\u51fa\u6765\uff0c\u5e76\u8fdb\u884c\u7cbe\u51c6\u7684\u6545\u969c\u6392\u67e5\uff0c\u6781\u5927\u5730\u964d\u4f4e\u4e86\u6545\u969c\u6392\u67e5\u7684\u96be\u5ea6\u3002</li> <li>\u76d1\u63a7\u544a\u8b66\uff1a\u901a\u8fc7 Prometheus \u548c Grafana \u8fd9\u6837\u7684\u57fa\u7840\u7ec4\u4ef6\uff0c\u7ed8\u5236\u670d\u52a1\u72b6\u6001\u76d1\u63a7\u5927\u76d8\uff0c\u9488\u5bf9\u8d44\u6e90\u3001\u670d\u52a1\u3001\u4e1a\u52a1\u5404\u9879\u6307\u6807\uff0c\u505a\u7cbe\u51c6\u7684\u76d1\u63a7\u62a5\u8b66\u3002</li> </ul>"},{"location":"chap1/1chap1_learn_SM/#2-9-service-mesh","title":"2-9 Service Mesh \u540d\u8bcd\u89e3\u91ca","text":"<ul> <li>Upstream: \u4e0a\u6e38\u670d\u52a1\uff0c\u5982\u679c A \u670d\u52a1\u8c03\u7528 B \u670d\u52a1\uff0c\u5728 A \u670d\u52a1\u7684\u89c6\u89d2\u6765\u770b\uff0cB \u670d\u52a1\u5c31\u662f\u4e0a\u6e38\u670d\u52a1\uff0c\u4f46\u662f\u5728\u4e2d\u6587\u7684\u8bed\u5883\u4e2d\uff0c\u7ecf\u5e38\u88ab\u53eb\u4f5c\u201c\u4e0b\u6e38\u670d\u52a1\u201d\u3002\u6240\u4ee5\u5728\u6574\u4e2a\u8bfe\u7a0b\u4e2d\uff0c\u4e3a\u4e86\u907f\u514d\u8bed\u8a00\u4e0a\u7684\u6b67\u4e49\uff0c\u6211\u4f1a\u76f4\u63a5\u4f7f\u7528upstream\uff0c\u800c\u4e0d\u662f\u4e2d\u6587\u7ffb\u8bd1\u3002\u5728\u4e2d\u6587\u7684\u8bed\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b22\u79f0\u5b83\u4e3a\u670d\u52a1\u7aef\u6216\u8005\u88ab\u8c03\u7528\u65b9\u3002</li> <li>Downstream: \u4e0b\u6e38\u670d\u52a1\uff0c\u5982\u679c A \u670d\u52a1\u8c03\u7528 B \u670d\u52a1\uff0c\u5728 B \u670d\u52a1\u7684\u89c6\u89d2\u4e2d\uff0cA \u670d\u52a1\u5c31\u662f\u4e0b\u6e38\u670d\u52a1\u3002\u5728\u4e2d\u6587\u7684\u8bed\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b22\u53eb\u5ba2\u6237\u7aef\u6216\u8005\u8c03\u7528\u65b9\u3002</li> <li>Endpoint\uff1a\u6307\u7684\u662f\u670d\u52a1\u8282\u70b9\uff0c\u6bd4\u5982 A \u670d\u52a1\u6709 192.168.2.11 \u548c 192.168.2.12 \u4e24\u4e2a\u670d\u52a1\u8282\u70b9\u3002</li> <li>Cluster\uff1a\u6307\u7684\u662f\u670d\u52a1\u96c6\u7fa4\uff0c\u6bd4\u5982 A \u670d\u52a1\u6709 192.168.2.11 \u548c 92.168.2.12 \u4e24\u4e2a\u670d\u52a1\u8282\u70b9\uff0c\u90a3\u4e48A\u670d\u52a1\u5c31\u662f Cluster\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7406\u89e3\u4e3a Service</li> <li>Node\uff1a\u5728 Kubernetes \u8bed\u5883\u4e2d\uff0c\u6307\u7684\u662f\u627f\u8f7d pod \u7684\u670d\u52a1\u5668\uff0c\u4f46\u5728\u5fae\u670d\u52a1\u7684\u8bed\u5883\u4e2d\uff0c\u66f4\u591a\u7684\u7b49\u540c\u4e8eEndpoint\u3002</li> <li>Route\uff1a\u6307\u7684\u662f Service Mesh \u4e2d\u7684\u8def\u7531\u914d\u7f6e\uff0c\u6bd4\u5982 A \u670d\u52a1\u8bbf\u95ee B \u670d\u52a1\uff0c\u8981\u5339\u914d\u5230\u4e00\u5b9a\u7684\u89c4\u5219\uff0c\u6bd4\u5982 header \u4e2d\u8981\u5e26\u6709\u670d\u52a1\u540d(<code>-H servicename:B</code>)\uff0c\u624d\u80fd\u591f\u62ff\u5230 B \u670d\u52a1\u7684\u8bbf\u95ee\u65b9\u5f0f\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u6216\u8005\u9759\u6001\u5217\u8868\u8bbf\u95ee\u5230 B \u670d\u52a1\u7684\u8282\u70b9\u3002</li> <li>Listener\uff1a\u6307\u7684\u662f Service Mesh \u7684\u76d1\u542c\u7aef\u53e3\uff0c\u901a\u5e38\u6211\u4eec\u8bbf\u95ee Service Mesh \u7684\u6570\u636e\u9762\uff0c\u9700\u8981\u77e5\u9053\u6570\u636e\u9762\u7684\u76d1\u542c\u7aef\u53e3\u3002</li> </ul>"},{"location":"chap1/2chap1_service_register/","title":"\u7b2c\u4e8c\u8282 \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3","text":"<p>\u5fae\u670d\u52a1\u5176\u4e2d\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\uff0c\u662f\u6700\u5148\u9700\u8981\u89e3\u51b3\u7684\u95ee\u9898\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u670d\u52a1\u6ce8\u518c\u4e0e\u53d1\u73b0\u5c31\u662f\u4fdd\u8bc1\u5f53\u670d\u52a1\u4e0a\u4e0b\u7ebf\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u670d\u52a1\u6d88\u8d39\u8005\u548c\u670d\u52a1\u63d0\u4f9b\u8005\u80fd\u591f\u4fdd\u6301\u6b63\u5e38\u901a\u4fe1\u3002</p> <p>\u800c\u5728\u5206\u5e03\u5f0f\u67b6\u6784\u4e2d\uff0c\u670d\u52a1\u4f1a\u6ce8\u518c\u5230\u6ce8\u518c\u4e2d\u5fc3\uff0c\u5f53\u670d\u52a1\u9700\u8981\u8c03\u7528\u5176\u4ed6\u670d\u52a1\u65f6\uff0c\u5c31\u5230\u8fd9\u91cc\u627e\u5230\u670d\u52a1\u7684\u5730\u5740\uff0c\u8fdb\u884c\u8c03\u7528\u3002</p> <p>\u6ce8\u518c\u4e2d\u5fc3\u662f\u5fae\u670d\u52a1\u4e2d\u6700\u91cd\u8981\u7684\u5185\u5bb9\uff0c\u4e5f\u662f\u548c SOA \u67b6\u6784\u4e2d\u7684\u96c6\u4e2d\u603b\u7ebf\u901a\u4fe1\u6700\u5927\u7684\u533a\u522b\u70b9\u3002</p>"},{"location":"chap1/2chap1_service_register/#1","title":"1\u3001\u670d\u52a1\u6ce8\u518c\u53d1\u73b0","text":"<p>\u5047\u8bbe\u5728\u5355\u4f53\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u670d\u52a1\uff0c\u8fd9\u4e2a\u670d\u52a1\u524d\u9762\u5c31\u662f\u50cf Nginx \u8fd9\u6837\u7684\u7f51\u5173\u7cfb\u7edf\uff0c\u8d1f\u8d23\u8d1f\u8f7d\u5747\u8861\uff0c\u800c\u540e\u7aef\u7684\u673a\u5668\u8282\u70b9\u4e5f\u662f\u6211\u4eec\u624b\u52a8\u914d\u7f6e\u4e0a\u53bb\u7684\uff0c\u6bd4\u5982</p> <pre><code>upstream backend { \n  server 10.0.0.1:80; \n  server 10.0.0.2:80; \n}\n</code></pre> <p>\u5982\u679c\u673a\u5668\u4e0d\u591f\u7528\u4e86\uff0c\u589e\u52a0\u4e00\u4e2a\u8282\u70b9\uff0c\u7136\u540e reload \u4e00\u4e0b Nginx \u5c31\u597d\u4e86\u3002\u8fd9\u6837\u7684\u914d\u7f6e\uff0c\u67b6\u6784\u8fd0\u884c\u5f97\u8fd8\u7b97\u7a33\u5b9a\uff0c\u7ef4\u62a4\u6210\u672c\u516c\u53f8\u4e5f\u8fd8\u53ef\u4ee5\u63a5\u53d7\u3002</p> <p>\u968f\u7740\u9879\u76ee\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u4fee\u6b63 Bug \u548c\u6b63\u786e\u5730\u6dfb\u52a0\u65b0\u529f\u80fd\u53d8\u5f97\u66f4\u52a0\u56f0\u96be\uff0c\u4f60\u9009\u62e9\u7ee7\u7eed\u62c6\u5206\u670d\u52a1\u3002\u6162\u6162\u5730\uff0c\u4f60\u62c6\u5206\u7684\u670d\u52a1\u6570\u91cf\u4e0a\u5347\u5230\u4e86\u4e24\u4f4d\u6570\uff0c\u4f46\u662f\u4f60\u53d1\u73b0\u6bcf\u6b21\u56e0\u4e3a\u673a\u5668\u8d1f\u8f7d\u74f6\u9888\u800c\u589e\u52a0\u673a\u5668\u65f6\uff0c\u9700\u8981\u4fee\u6539\u5f88\u591a\u4efd\u5185\u7f51\u7f51\u5173\u914d\u7f6e\uff0c \u8fd9\u65e0\u5f62\u4e2d\u53ef\u4ee5\u9884\u6599\u5230\uff0c\u4fee\u6539\u914d\u7f6e\u5e26\u6765\u7684\u7ef4\u62a4\u6210\u672c\u548c\u51fa\u9519\u7684\u6982\u7387\u90fd\u4f1a\u5448\u6307\u6570\u7ea7\u589e\u52a0\u3002</p> <p>\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u7684\u529e\u6cd5\uff1a\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u3002</p> <p> </p> <ul> <li>\u670d\u52a1\u5728\u542f\u52a8\u65f6\uff0c\u5c06\u81ea\u5df1\u7684\u4fe1\u606f\u6ce8\u518c\u5230\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u4e2d\uff0c\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u4f1a\u5b58\u50a8\u8fd9\u4e9b\u4fe1\u606f\u3002</li> <li>\u670d\u52a1\u6d88\u8d39\u8005\u53ef\u4ece\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u67e5\u8be2\u670d\u52a1\u63d0\u4f9b\u8005\u7684\u7f51\u7edc\u5730\u5740\uff0c\u5e76\u4f7f\u7528\u8be5\u5730\u5740\u8c03\u7528\u670d\u52a1\u63d0\u4f9b\u8005\u63a5\u53e3\u3002</li> <li>\u800c\u5f53\u670d\u52a1\u63d0\u4f9b\u8005\u7f51\u7edc\u5730\u5740\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u4f1a\u91cd\u65b0\u6ce8\u518c\u5230\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u3002</li> <li>\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u670d\u52a1\u6d88\u8d39\u8005\u5c31\u65e0\u987b\u4eba\u5de5\u4fee\u6539\u63d0\u4f9b\u8005\u7684\u7f51\u7edc\u5730\u5740\u4e86\u3002</li> </ul>"},{"location":"chap1/2chap1_service_register/#2","title":"2\u3001\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3","text":"<p>\u5177\u4f53\u600e\u6837\u5229\u7528\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u89e3\u51b3\u591a\u4e2a\u670d\u52a1\u95f4\u7684\u901a\u4fe1\u95ee\u9898\u5462\uff1f</p> <p>\u89e3\u51b3\u591a\u4e2a\u670d\u52a1\u95f4\u901a\u4fe1\u95ee\u9898\u7684\u5de5\u5177\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3 \u6240\u4ee5\u6709\u4e9b\u4eba\u4e5f\u4f1a\u628a\u6ce8\u518c\u4e2d\u5fc3\u53eb\u4f5c\u540d\u5b57\u670d\u52a1\uff0c\u987e\u540d\u601d\u4e49\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7 \u670d\u52a1\u540d\u67e5\u627e\u5bf9\u5e94\u7684\u670d\u52a1\u5730\u5740\u7684\u670d\u52a1\uff0c\u5728\u5206\u5e03\u5f0f\u67b6\u6784\u4e2d\uff0c\u6ce8\u518c\u4e2d\u5fc3\u627f\u63a5\u4e86\u670d\u52a1\u7684\u5730\u5740\u5f55\u5165\u548c\u67e5\u627e\u529f\u80fd</p>"},{"location":"chap1/2chap1_service_register/#3","title":"3\u3001\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u5eb7\u68c0\u67e5\u8bbe\u8ba1","text":""},{"location":"chap1/2chap1_service_register/#3-1","title":"3-1 \u670d\u52a1\u4e3b\u52a8\u63a2\u6d3b","text":"<p>\u670d\u52a1\u901a\u8fc7\u5b9a\u65f6\u53d1\u9001\u7eed\u79df\u4fe1\u606f\u5230\u6ce8\u518c\u4e2d\u5fc3\uff0c\u4ee5\u8868\u660e\u81ea\u5df1\u8282\u70b9\u7684\u5b58\u6d3b\u3002</p> <p>\u4e3b\u52a8\u63a2\u6d3b\u7684\u65b9\u5f0f\u5176\u5b9e\u662f\u6211\u4eec\u5728\u4f7f\u7528\u6ce8\u518c\u4e2d\u5fc3\u65f6\u7528\u5f97\u6700\u591a\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c\u5982\u679c\u4f60\u7684\u670d\u52a1\u96c6\u7fa4\u89c4\u6a21\u4e0d\u5927\uff0c\u6216\u8005\u9009\u7528\u4e86\u7c7b\u4f3c Eureka \u8fd9\u6837\u7684\u6700\u7ec8\u4e00\u81f4\u6027\u7684\u6ce8\u518c\u4e2d\u5fc3\uff0c\u670d\u52a1\u4e3b\u52a8\u63a2\u6d3b\u7edd\u5bf9\u662f\u4f60\u7684\u6700\u4f18\u7684\u9009\u62e9</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u6700\u5927\u7a0b\u5ea6\u907f\u514d\u4e86\u5728Kubernetes\u73af\u5883\u4e2d\uff0c\u56e0\u4e3a IP \u91cd\u7528\u5bfc\u81f4\u8282\u70b9\u5728\u65e7\u7684\u670d\u52a1\u4e0a\u4f9d\u7136\u5b58\u6d3b\u7684\u95ee\u9898\uff0c\u6bd5\u7adf\u7eed\u79df\u4fe1\u606f\u90fd\u662f\u5e26\u7740\u670d\u52a1\u4fe1\u606f\u4e0a\u62a5\u5230\u6ce8\u518c\u4e2d\u5fc3\u7684\u3002</p> <p>\u4e3b\u52a8\u63a2\u6d3b\u7684\u6700\u5927\u95ee\u9898\uff1a \u9020\u6210\u6ce8\u518c\u4e2d\u5fc3\u7684\u5199\u64cd\u4f5c\u53d8\u591a</p> <p>\u5728\u670d\u52a1\u53d1\u5e03\u65f6\uff0c\u8282\u70b9\u4f1a\u4ea7\u751f\u6bd4\u8f83\u5927\u7684\u53d8\u52a8\uff0c\u6ce8\u518c\u4e2d\u5fc3\u7684\u5199\u538b\u529b\u4e5f\u5c31\u4f1a\u53d8\u5927\u3002</p> <p>\u800c\u4e14\u5f3a\u4e00\u81f4\u6027\u7684\u6ce8\u518c\u4e2d\u5fc3\uff0c\u8282\u70b9\u53d8\u5316\u4e00\u5b9a\u8981\u4e3b\u8282\u70b9\u786e\u8ba4\uff0c\u5982\u679c\u6ca1\u6709\u505a\u6ce8\u518c\u4e2d\u5fc3\u7684\u8bfb\u5199\u5206\u79bb\uff0c\u5c31\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u901a\u77e5\u4e8b\u4ef6\uff0c\u5bf9\u5e26\u5bbd\u3001CPU \u6765\u8bf4\u90fd\u662f\u707e\u96be\u6027\u7684\u95ee\u9898\uff0c\u8fd9\u4e2a\u65f6\u5019\u6ce8\u518c\u4e2d\u5fc3\u5df2\u7ecf\u5b8c\u5168\u6ca1\u6709\u529e\u6cd5\u54cd\u5e94 TTL \u7684\u79df\u7ea6\u8bf7\u6c42\uff0c\u4e5f\u4f1a\u5bfc\u81f4\u5927\u91cf\u7684\u8282\u70b9\u5931\u6548</p> <p>\u4e3b\u52a8\u79df\u7ea6\uff0c\u5176\u5b9e\u5e76\u4e0d\u8db3\u4ee5\u8bf4\u660e\u670d\u52a1\u662f\u5065\u5eb7\u7684\uff0c\u6bd5\u7adf\u6709\u4e9b\u60c5\u51b5\u4e0b\uff0c\u670d\u52a1\u867d\u7136\u65e0\u6cd5\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u4e86\uff0c\u4f46\u8fd8\u662f\u53ef\u4ee5\u5bf9\u5916\u53d1\u9001\u79df\u7ea6\u8bf7\u6c42\u7684\u3002</p>"},{"location":"chap1/2chap1_service_register/#3-2","title":"3-2 \u6ce8\u518c\u4e2d\u5fc3\u4e3b\u52a8\u53d1\u8d77\u5065\u5eb7\u68c0\u67e5","text":"<p>\u670d\u52a1\u5728\u8fdb\u884c\u670d\u52a1\u6ce8\u518c\u65f6\uff0c\u5411\u6ce8\u518c\u4e2d\u5fc3\u8868\u660e\u81ea\u5df1\u7684\u5065\u5eb7\u68c0\u67e5\u63a5\u53e3\uff0c\u6bd4\u5982 /ping \u6216\u8005 TCP \u7aef\u53e3\uff0c\u6ce8\u518c\u4e2d\u5fc3\u901a\u8fc7\u5b9a\u65f6\u8bbf\u95ee\u7684\u65b9\u5f0f\uff0c\u63a2\u660e\u8282\u70b9\u662f\u5426\u5b58\u6d3b\u3002</p> <p>\u7b2c\u4e8c\u79cd\u65b9\u6848\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u89e3\u51b3\u4e86\u670d\u52a1\u4e3b\u52a8\u63a2\u6d3b\u5e76\u4e0d\u80fd\u8bf4\u660e\u670d\u52a1\u5065\u5eb7\u7684\u95ee\u9898\uff0c\u6bd5\u7adf\u901a\u8fc7 <code>/ping</code>\u8fd9\u79cd\u5065\u5eb7\u68c0\u67e5\u63a5\u53e3\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53ef\u4ee5\u8bf4\u660e\u670d\u52a1\u7684\u5065\u5eb7\u5ea6\u3002\u5728Kubernetes\u73af\u5883\u4e2d\uff0c\u4e5f\u662f\u901a\u8fc7\u5bf9 Pod \u8fdb\u884c\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6765\u5224\u5b9a Pod \u7684\u5065\u5eb7\u5ea6\u7684\u3002</p> <p>\u4f46\u8fd9\u4e2a\u65b9\u6848\u4e5f\u6709\u4e00\u4e9b\u95ee\u9898\uff1a</p> <p>\u6bd4\u5982\u4e0a\u9762\u63d0\u5230\u7684 IP \u91cd\u7528\u95ee\u9898\uff0c\u5982\u679c\u4e24\u4e2a\u670d\u52a1\u90fd\u7528\u4e86 <code>/ping</code>\u63a5\u53e3\u505a\u5065\u5eb7\u68c0\u67e5\uff0c\u5e76\u4e14\u7aef\u53e3\u4e00\u81f4\uff0c\u5c31\u5f88\u5bb9\u6613\u53d1\u751f\u8282\u70b9\u5728\u65e7\u670d\u52a1\u88ab\u91cd\u65b0\u6fc0\u6d3b\u7684\u95ee\u9898\u3002\u5f53\u7136\u4e5f\u6709\u76f8\u5e94\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u5c31\u662f\u53c2\u8003 <code>Envoy</code> \u505a\u670d\u52a1\u540d\u79f0\u7684 <code>check</code>\u3002</p>"},{"location":"chap1/2chap1_service_register/#3-3","title":"3-3 \u6ce8\u518c\u4e2d\u5fc3\u4e0d\u8fdb\u884c\u4efb\u4f55\u5065\u5eb7\u68c0\u67e5\uff0c\u7531\u8c03\u7528\u65b9\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5","text":"<p>\u6ce8\u518c\u4e2d\u5fc3\u4e0d\u8fdb\u884c\u4efb\u4f55\u63a2\u6d3b\u673a\u5236\uff0c\u5168\u90e8\u7531\u8c03\u7528\u65b9\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u4e3b\u52a8\u548c\u88ab\u52a8\u63a2\u6d3b\u3002</p> <p>\u7b2c\u4e09\u79cd\u65b9\u6848\u5c31\u6bd4\u8f83\u6781\u7aef\u4e86\uff0c\u4e0d\u505a\u4efb\u4f55\u5065\u5eb7\u68c0\u67e5\uff0c\u5b8c\u5168\u9760\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u80fd\u529b\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u4e5f\u662f\u6709\u5e94\u7528\u573a\u666f\u7684\uff0c\u5982\u679c\u4f7f\u7528\u4e86 gRPC \u8fd9\u6837\u6bd4\u8f83\u5b8c\u5584\u7684 RPC \u5e93\uff0c\u4e00\u822c\u90fd\u6709\u81ea\u52a8\u6458\u9664\u8282\u70b9\u7684\u80fd\u529b\u3002\u4f46\u6211\u4eec\u4e5f\u8981\u8003\u8651\u5230\u8fd9\u4e2a\u65b9\u6848\u7684\u4e0d\u8db3\uff0c\u5982\u679c IP \u88ab\u91cd\u7528\uff0c\u8282\u70b9\u5f88\u5927\u6982\u7387\u4f1a\u4e00\u76f4\u5b58\u5728\u5728\u65e7\u670d\u52a1\u4e2d\uff0c\u8fd9\u6837\u7684\u810f\u6570\u636e\u968f\u65f6\u90fd\u662f\u98ce\u9669\u70b9\u3002</p> <p>\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u7ed3\u5408\u524d\u9762\u4e24\u4e2a\u65b9\u6848\uff0c\u4f18\u5316\u6b64\u65b9\u6848\u3002\u4f60\u53ef\u4ee5\u5728\u505a\u5065\u5eb7\u68c0\u67e5\u7684\u540c\u65f6\uff0c\u6ce8\u518c\u4e2d\u5fc3\u4e0b\u53d1\u5305\u542b\u5065\u5eb7\u8282\u70b9\u548c\u975e\u5065\u5eb7\u8282\u70b9\u7684\u6570\u636e\u5230\u670d\u52a1\u8282\u70b9\uff0c\u5e76\u9488\u5bf9\u5065\u5eb7\u68c0\u67e5\u672a\u901a\u8fc7\u7684\u5220\u9664\u8282\u70b9\u8bbe\u7f6e\u4e00\u4e2a\u8f83\u957f\u7684\u8fc7\u671f\u65f6\u95f4\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u89e3\u51b3 IP \u91cd\u7528\u4ea7\u751f\u810f\u6570\u636e\u7684\u95ee\u9898\u4e86\u3002</p>"},{"location":"chap1/2chap1_service_register/#4","title":"4\u3001\u6ce8\u518c\u4e2d\u5fc3\u9009\u578b","text":"<p>\u6211\u6765\u7b80\u5355\u89e3\u91ca\u4e00\u4e0b CAP \u7406\u8bba\uff0c\u4e00\u81f4\u6027\uff08Consistency\uff09\u3001\u53ef\u7528\u6027\uff08Availability\uff09\u3001\u5206\u533a\u5bb9\u9519\u6027\uff08Partition tolerance\uff09\uff0cCAP \u4e0d\u53ef\u80fd\u90fd\u53d6\uff0c\u53ea\u80fd\u53d6\u5176\u4e2d2\u4e2a\u3002</p> <p>\u6240\u4ee5\u5728\u9009\u578b\u7684\u65f6\u5019\uff0c\u4f18\u5148\u9009\u62e9 AP \u7684\u7cfb\u7edf\u3002\u5982\u679c\u6280\u672f\u6808\u662f Go \uff0c\u4f46\u53c8\u62c5\u5fc3 Java \u7684\u7ec4\u4ef6\u4e0d\u597d\u7ef4\u62a4\uff0c\u4f60\u4e5f\u53ef\u4ee5\u8003\u8651\u81ea\u7814\u6ce8\u518c\u4e2d\u5fc3\uff0c\u5f53\u7136 CP \u7684\u6ce8\u518c\u4e2d\u5fc3\u5e76\u975e\u4e0d\u53ef\u7528\uff0c\u5728\u670d\u52a1\u96c6\u7fa4\u89c4\u6a21\u6bd4\u8f83\u5c0f\u7684\u60c5\u51b5\u4e0b\uff0c\u4e5f\u662f\u53ef\u4ee5\u9009\u62e9\u7684\u3002</p>"},{"location":"chap1/2chap1_service_register/#5","title":"5\u3001\u642d\u5efa\u4e00\u4e2a\u9ad8\u53ef\u7528\u3001\u5065\u58ee\u7684\u6ce8\u518c\u4e2d\u5fc3","text":""},{"location":"chap1/2chap1_service_register/#5-1","title":"5-1 \u5728\u5f15\u5165\u6ce8\u518c\u4e2d\u5fc3\u53ef\u80fd\u4f1a\u9047\u7684\u95ee\u9898","text":"<ul> <li>\u6ce8\u518c\u4e2d\u5fc3\u5b8c\u5168\u6545\u969c\u4e86\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f</li> <li>\u6ce8\u518c\u4e2d\u5fc3\u56e0\u4e3a\u9ad8\u8d1f\u8f7d\uff0c\u63a8\u9001\u4e86\u5f02\u5e38\u7684\u6570\u636e\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f</li> <li>\u65b0\u52a0\u5165\u7684\u673a\u5668\uff0c\u51fa\u73b0\u4e86\u7f51\u7edc\u8fde\u901a\u6027\u95ee\u9898\uff08\u6ce8\u518c\u4e2d\u5fc3\u548c\u673a\u5668\u7f51\u7edc\u6b63\u5e38\uff0c\u4f46\u670d\u52a1\u673a\u5668\u4e4b\u95f4\u7f51\u7edc\u5f02\u5e38\uff09\uff0c\u5e94\u8be5\u600e\u6837\u5e94\u5bf9\uff1f</li> <li>\u670d\u52a1\u662f\u5426\u5e94\u8be5\u5b8c\u5168\u4fe1\u4efb\u6ce8\u518c\u4e2d\u5fc3\u63a8\u9001\u7684\u6570\u636e\uff1f</li> <li>\u670d\u52a1\u53d1\u5e03\u540e\uff0c\u8282\u9891\u7e41\u53d8\u66f4\u9020\u6210 N\u00d7M \u6b21\u4e8b\u4ef6\u901a\u77e5\uff0c\u5f62\u6210\u5e7f\u64ad\u98ce\u66b4\uff0c\u8be5\u5982\u4f55\u89e3\u51b3\uff1f</li> </ul> <p>\u7b2c\u4e09\u65b9\u57fa\u7840\u8bbe\u65bd\uff0c\u6bd4\u5982 MySQL \u3001Redis \uff0c\u8fd9\u79cd\u6570\u636e\u5c42\u7684\u4e2d\u95f4\u4ef6\uff0c\u6211\u4eec\u80af\u5b9a\u662f\u8981\u5b8c\u5168\u4fe1\u4efb\u5176\u4e2d\u7684\u6570\u636e\u7684\u3002\u4f46\u5bf9\u4e8e\u6ce8\u518c\u4e2d\u5fc3\uff0c\u4fe1\u4efb\u63a8\u9001\u6570\u636e\u7684\u98ce\u9669\u975e\u5e38\u5927\u3002</p> <p>1. \u6ce8\u518c\u4e2d\u5fc3\u5b8c\u5168\u6545\u969c\u4e86\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f</p> <p>\u6240\u4ee5\u53ea\u8981\u5728\u8fdb\u7a0b\u4e2d\u7f13\u5b58\u670d\u52a1\u7684\u8282\u70b9\uff0c\u5f71\u54cd\u9762\u5c31\u53ef\u63a7\u3002</p> <p>\u5f53\u6ce8\u518c\u4e2d\u5fc3\u5b8c\u5168\u6545\u969c\u7684\u65f6\u5019\uff0c\u670d\u52a1\u6ce8\u518c\u529f\u80fd\u662f\u5931\u6548\u7684\uff0c\u6b64\u65f6\u7684\u6269\u5bb9\u64cd\u4f5c\u65e0\u6cd5\u8fdb\u884c\u3002</p> <p>\u5982\u679c\u5728\u5bb9\u5668\u4e2d\uff0c\u56e0\u4e3a Pod \u6eda\u52a8\u5347\u7ea7\u7684\u539f\u56e0\u9020\u6210\u4f1a\u5148\u542f\u52a8\u65b0\u7684 Pod\uff0c\u4e00\u5b9a\u8981\u5728\u7a0b\u5e8f\u542f\u52a8\u6ce8\u518c\u5931\u8d25\u65f6\u629b\u51fa\u5f02\u5e38\uff0c\u4f7f\u7a0b\u5e8f\u65e0\u6cd5\u542f\u52a8\uff0c\u5426\u5219\u5bb9\u5668 IP \u7684\u53d8\u5316\u4e5f\u4f1a\u5bfc\u81f4\u670d\u52a1\u7684\u8bbf\u95ee\u5f02\u5e38\u3002</p> <p>2. \u6ce8\u518c\u4e2d\u5fc3\u56e0\u4e3a\u9ad8\u8d1f\u8f7d\uff0c\u63a8\u9001\u4e86\u5f02\u5e38\u7684\u6570\u636e\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f</p> <p>\u4f46\u968f\u7740\u5fae\u670d\u52a1\u89c4\u6a21\u7684\u589e\u5927\uff0c\u6ce8\u518c\u4e2d\u5fc3\u5f88\u6709\u53ef\u80fd\u9047\u5230\u74f6\u9888\u3002\u4e00\u65e6\u51fa\u73b0\u9ad8\u8d1f\u8f7d\uff0c\u4f1a\u4f7f\u670d\u52a1\u548c\u6ce8\u518c\u4e2d\u5fc3\u4e4b\u95f4\u7684\u5065\u5eb7\u68c0\u67e5\u6216\u4fdd\u6d3b\u51fa\u73b0\u95ee\u9898\uff0c\u6ce8\u518c\u4e2d\u5fc3\u4f7f\u8282\u70b9\u5f02\u5e38\u4e0b\u7ebf\uff0c\u53ea\u63a8\u9001\u90e8\u5206\u8282\u70b9\u6570\u636e\u5230\u8ba2\u9605\u7684\u670d\u52a1\u3002</p> <p>\u8fd9\u4e2a\u95ee\u9898\u770b\u4f3c\u4e0d\u4e25\u91cd\uff0c\u4f46\u4e00\u65e6\u63a8\u9001\u4e86\u8fc7\u5c11\u7684\u8282\u70b9\u5230\u670d\u52a1\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u8c03\u670d\u52a1\u6253\u6302\u88ab\u8c03\u670d\u52a1\uff0c\u957f\u65f6\u95f4\u4e0d\u80fd\u6062\u590d\uff0c\u751a\u81f3\u4f1a\u5bfc\u81f4\u6574\u4e2a\u5fae\u670d\u52a1\u96c6\u7fa4\u96ea\u5d29\u3002</p> <p>\u89e3\u51b3\u6b64\u7c7b\u95ee\u9898\uff0c</p> <ul> <li>\u6211\u4eec\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u7684\u670d\u52a1\u53d1\u73b0 SDK \u4e2d\u52a0\u5165\u81ea\u6211\u4fdd\u62a4\u673a\u5236\uff1a</li> <li>\u4e00\u65e6\u670d\u52a1\u7684\u8282\u70b9\u6570\u91cf\u4e0b\u964d\u8d85\u8fc7\u4e00\u5b9a\u9608\u503c\uff0c\u5c31\u8fdb\u5165\u81ea\u6211\u4fdd\u62a4\u72b6\u6001\uff0c\u653e\u5f03\u4f7f\u7528\u65b0\u63a8\u9001\u8fc7\u6765\u7684\u670d\u52a1\u6ce8\u518c\u4fe1\u606f\u3002</li> </ul> <p>3. \u65b0\u52a0\u5165\u7684\u673a\u5668\uff0c\u51fa\u73b0\u4e86\u7f51\u7edc\u8fde\u901a\u6027\u95ee\u9898\uff08\u6ce8\u518c\u4e2d\u5fc3\u548c\u673a\u5668\u7f51\u7edc\u6b63\u5e38\uff0c\u4f46\u670d\u52a1\u673a\u5668\u4e4b\u95f4\u7f51\u7edc\u5f02\u5e38\uff09\uff0c\u5e94\u8be5\u600e\u6837\u5e94\u5bf9\uff1f</p> <p>\u5b9e\u9645\u4e0a\u7f51\u7edc\u8fde\u901a\u6027\u95ee\u9898\u662f\u6bd4\u8f83\u5bb9\u6613\u53d1\u751f\u7684\uff0c\u5f80\u5f80\u51fa\u4e8e\u5b89\u5168\u8003\u8651\uff0c\u5404\u4e2a\u90e8\u95e8\u4e4b\u95f4\u53ef\u80fd\u4f1a\u5904\u5728\u4e0d\u540c\u7684 VPC \uff0c\u4f46\u73b0\u5b9e\u4e2d\u53c8\u6709\u4e92\u76f8\u8bbf\u95ee\u7684\u60c5\u51b5\uff0c\u4e00\u65e6\u7f51\u7edc\u89c4\u5219\u7ef4\u62a4\u4e0d\u597d\uff0c\u5f88\u5bb9\u6613\u51fa\u73b0\u65b0\u6dfb\u52a0\u7684\u673a\u5668\u6ce8\u518c\u4e2d\u5fc3\u7684\u7f51\u6bb5\u53ef\u4ee5\u8bbf\u95ee\uff0c\u4f46\u662f\u670d\u52a1\u4e4b\u95f4\u5374\u65e0\u6cd5\u8bbf\u95ee\u7684\u60c5\u51b5\u3002</p> <p>\u5728\u6ce8\u518c\u4e2d\u5fc3\u7684\u4f7f\u7528\u573a\u666f\u4e2d\uff0c\u7f51\u7edc\u6545\u969c\u662f\u6211\u4eec\u6700\u4f18\u5148\u8003\u8651\u7684\u95ee\u9898\uff0c\u5982\u679c\u53d1\u751f\u4e86\u5206\u533a\u6545\u969c\uff0c\u95ee\u9898 2 \u63cf\u8ff0\u7684\u60c5\u51b5\u4e5f\u4f1a\u53d1\u751f\u3002</p> <p>\u89e3\u51b3\u6b64\u7c7b\u95ee\u9898\u5462\uff0c\u8fd9\u4e2a\u5c31\u8981\u53d1\u6325\u8d1f\u8f7d\u5747\u8861\u5668\u6a21\u5757\u7684\u4f5c\u7528\u4e86\uff1a\u5728\u8d1f\u8f7d\u5747\u8861\u4e2d\u6211\u4eec\u53ef\u4ee5\u52a0\u5165\u88ab\u52a8\u5065\u5eb7\u68c0\u67e5\uff08\u8282\u70b9\u7194\u65ad\uff09\u548c\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6765\u5728\u5ba2\u6237\u7aef\u4e3b\u52a8\u5254\u9664\u5931\u6548\u7684\u8282\u70b9\u3002</p> <p>4. \u670d\u52a1\u662f\u5426\u5e94\u8be5\u5b8c\u5168\u4fe1\u4efb\u6ce8\u518c\u4e2d\u5fc3\u63a8\u9001\u7684\u6570\u636e\uff1f</p> <p>Service Mesh \u6570\u636e\u9762\u4e4b\u4e00 Envoy \u7684\u505a\u6cd5\uff1a</p> <ul> <li>\u76f8\u6bd4\u6ce8\u518c\u4e2d\u5fc3\u7684\u6570\u636e</li> <li>\u66f4\u4fe1\u4efb\u672c\u5730\u6570\u636e</li> <li>\u6240\u4ee5 Envoy \u8bbe\u8ba1\u4e86 2\u00d72 \u77e9\u9635\u6765\u51b3\u5b9a\u8282\u70b9\u662f\u5426\u5e94\u8be5\u8def\u7531\u3002</li> </ul> <p> </p> <p>\u53ea\u6709\u5728\u5065\u5eb7\u68c0\u67e5\u5931\u8d25\u548c\u6ce8\u518c\u4e2d\u5fc3\u672a\u53d1\u73b0\u7684\u60c5\u51b5\u624d\u4f1a\u5220\u9664\u8282\u70b9\uff0c\u53ea\u8981\u5065\u5eb7\u68c0\u67e5\u6210\u529f\uff0c\u65e0\u8bba\u662f\u5426\u53d1\u73b0\u6b64\u8282\u70b9\uff0c\u90fd\u4f1a\u8def\u7531\u3002</p> <p>5. \u670d\u52a1\u53d1\u5e03\u540e\uff0c\u8282\u70b9\u9891\u7e41\u53d8\u66f4\u9020\u6210 N\u00d7M \u6b21\u4e8b\u4ef6\u901a\u77e5\uff0c\u5f62\u6210\u5e7f\u64ad\u98ce\u66b4\uff0c\u8be5\u5982\u4f55\u89e3\u51b3\uff1f</p> <p>\u53ef\u80fd\u5bfc\u81f4\u95ee\u9898 2 \u7684\u53d1\u751f\u3002\u5927\u91cf\u5e7f\u64ad\u4e8b\u4ef6\u7684\u53d1\u751f\uff0c\u6324\u5360\u7f51\u7edc\u5e26\u5bbd\uff0c\u751a\u81f3\u4f1a\u5bfc\u81f4\u7f51\u7edc\u5e26\u5bbd\u5360\u6ee1\uff0c\u6b64\u65f6\u6ce8\u518c\u4e2d\u5fc3\u548c\u670d\u52a1\u95f4\u7684\u5065\u5eb7\u68c0\u67e5\u6216\u4fdd\u6d3b\uff0c\u90fd\u4f1a\u56e0\u4e3a\u5e26\u5bbd\u4e0d\u8db3\u9020\u6210\u4fe1\u606f\u4e22\u5931\uff0c\u4f7f\u6ce8\u518c\u4e2d\u5fc3\u63a8\u9001\u9519\u8bef\u7684\u6570\u636e\u3002</p> <p>\u5982\u4f55\u89e3\u51b3\u5462\uff1f</p> <p>\u5176\u5b9e\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4e8b\u4ef6\u6d88\u606f\u5408\u5e76\u63a8\u9001\u3002\u5728 Istio \u7684 Pilot \u7684\u6a21\u5757\u4e2d\uff0c\u5b9e\u73b0\u4e86\u4e00\u79cd\u5408\u5e76\u673a\u5236\uff0c100ms \u5185\u6709\u65b0\u7684\u4e8b\u4ef6\u6d88\u606f\u65f6\uff0c\u4fbf\u4f1a\u7ee7\u7eed\u7b49\u5f85\u4e0b\u4e00\u6761\uff0c\u6700\u591a\u7b49\u5f85 1s\uff0c\u5f53\u7136\u65f6\u95f4\u7684\u53c2\u6570\u662f\u53ef\u4ee5\u914d\u7f6e\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u8bf4\u7684\u662f\u9ed8\u8ba4\u53c2\u6570\u3002</p>"},{"location":"chap1/2chap1_service_register/#6service-mesh","title":"6\u3001Service Mesh \u4e2d\u7684\u6ce8\u518c\u4e2d\u5fc3","text":"<p>\u5b9e\u9645\u4e0a\u5728 Service Mesh \u65b9\u6848\u4e2d\uff0c\u670d\u52a1\u8282\u70b9\u53d1\u73b0\u7684\u95ee\u9898\u7528\u4f20\u7edf\u7684\u6ce8\u518c\u4e2d\u5fc3\u65b9\u6848\u4e5f\u662f\u53ef\u4ee5\u89e3\u51b3\u7684\uff0c\u4f46\u5982\u679c\u6d89\u53ca Kubernetes \u548c ECS \u8de8\u96c6\u7fa4\u8bbf\u95ee\uff0c\u6700\u597d\u8fd8\u662f\u652f\u6301 Envoy \u5b9a\u4e49\u7684 xDS \u534f\u8bae\u4e2d\u7684 EDS \u534f\u8bae\u3002</p> <p>EDS\u662f endpoint discovery service \u7684\u7f29\u5199\uff0c\u65e0\u8bba\u662f Istio\uff0c\u8fd8\u662f\u6700\u65b0\u7248\u672c\u7684 gRPC\uff0c\u90fd\u5df2\u7ecf\u9ed8\u8ba4\u652f\u6301\u4e86 EDS \u534f\u8bae\uff0c\u53ef\u4ee5\u8bf4EDS \u5b9e\u9645\u4e0a\u5df2\u7ecf\u662f\u670d\u52a1\u53d1\u73b0\u7684\u89c4\u8303\u4e86\u3002</p> <p>\u5728 Service Mesh \u65b9\u6848\u4e2d\uff0c\u56e0\u4e3a\u5927\u591a\u662f\u548c Kubernetes \u96c6\u7fa4\u7ed3\u5408\u7684\u65b9\u6848\uff0c\u6240\u4ee5\u4f60\u8981\u7279\u522b\u6ce8\u610f\u53d1\u7248\u6216\u8005\u81ea\u52a8\u6269\u7f29\u5bb9\u5f15\u8d77\u7684\u8282\u70b9 IP \u53d8\u5316\u7684\u95ee\u9898\u3002\u8282\u70b9\u7684\u9891\u7e41\u53d8\u5316\uff0c\u5bf9\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u58ee\u6027\u63d0\u51fa\u4e86\u66f4\u9ad8\u7684\u8981\u6c42</p> <p>\u9664\u4e86\u7528\u4f20\u7edf\u7684\u6ce8\u518c\u4e2d\u5fc3\u7ec4\u4ef6\u5916\uff0cKubernetes \u5185\u90e8\u7684\u53d1\u73b0\u673a\u5236\u5728 Service Mesh \u4e2d\u4e5f\u5f97\u5230\u4e86\u5e7f\u6cdb\u5e94\u7528\uff0c\u4f8b\u5982 Istio\u901a\u8fc7\u76d1\u542c Kubernetes Pod \u7684\u53d8\u5316\uff0c\u5b9e\u73b0\u670d\u52a1\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u670d\u52a1\u81ea\u8eab\u6765\u505a\u670d\u52a1\u6ce8\u518c\u4e86\u3002</p>"},{"location":"chap1/2chap1_service_register/#7service-mesh","title":"7\u3001Service Mesh \u4e2d\u5b9e\u73b0\u7684\u6ce8\u518c\u53d1\u73b0\u529f\u80fd\u4f18\u52bf","text":""},{"location":"chap1/2chap1_service_register/#7-1-sidecar","title":"7-1 \u65e0\u987b\u670d\u52a1\u81ea\u8eab\u6ce8\u518c\uff0c\u7531 sidecar \u4ee3\u7406\u6ce8\u518c","text":"<p>sidecar \u901a\u8fc7\u63a5\u53d7\u63a7\u5236\u9762\u4e0b\u53d1\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u8fdb\u884c\u670d\u52a1\u6ce8\u518c\u3002\u76f8\u5bf9\u4e8e\u670d\u52a1\u81ea\u8eab\u6ce8\u518c\uff0c\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11\u670d\u52a1\u81ea\u8eab\u5f00\u53d1\u7684\u5de5\u4f5c\u91cf\uff0c\u540c\u65f6\u4e5f\u5f88\u5bb9\u6613\u505a\u5230\u6ce8\u518c\u7684\u914d\u7f6e\u4fe1\u606f\u4e00\u81f4\u5316\u3002</p> <p>\u6bd4\u5982\u5982\u679c\u670d\u52a1\u81ea\u5df1\u6ce8\u518c\uff0c\u5176\u5b9e\u5f88\u96be\u63a7\u5236\u670d\u52a1\u6ce8\u518c\u7684 metadata \u4fe1\u606f\uff0c\u5728 SDK \u4e2d\u5f88\u96be\u7ea6\u675f\u548c\u5347\u7ea7\uff0c\u6bd4\u5982\u8fd0\u884c\u73af\u5883\u3001\u5730\u57df\u3001\u5065\u5eb7\u68c0\u67e5\u65b9\u5f0f\u7b49\u3002</p> <p>sidecar \u4ee3\u7406\u8fd8\u5e26\u6765\u4e86\u53ef\u4ee5\u968f\u65f6\u66f4\u65b0 meta \u4fe1\u606f\u7684\u597d\u5904</p> <p>\u5728\u4f20\u7edf\u7684 SDK \u6a21\u5f0f\u4e2d\uff0c\u4f60\u60f3\u8981\u52a8\u6001\u8c03\u6574\u670d\u52a1\u7684\u6743\u91cd\u3001metadata \u7b49\u4fe1\u606f\u7684\u65f6\u5019\uff0c\u9700\u8981\u91cd\u65b0\u53d1\u5e03\u7248\u672c\uff0c\u6216\u8005\u4f9d\u9760\u914d\u7f6e\u4e2d\u5fc3\u7684\u80fd\u529b\uff0c\u4f46\u8fd9\u4e9b\u63a7\u5236\u4fe1\u606f\u5f80\u5f80\u6563\u843d\u5728\u5404\u4e2a\u670d\u52a1\u4e2d\uff0c\u4e0d\u65b9\u4fbf\u7ba1\u7406\uff0c\u5728 Service Mesh \u4e2d\u4f60\u53ea\u9700\u8981\u4f9d\u9760\u63a7\u5236\u9762\u7684\u80fd\u529b\uff0c\u5c31\u53ef\u4ee5\u8f7b\u677e\u505a\u5230\u4e86\u3002</p>"},{"location":"chap1/2chap1_service_register/#7-2","title":"7-2 \u901a\u8fc7\u63a7\u5236\u9762\u805a\u5408\u591a\u79cd\u3001\u591a\u4e2a\u6ce8\u518c\u4e2d\u5fc3\u6570\u636e","text":"<p>\u50cf Istio \u7684 pilot \u6a21\u5757\uff0c\u5728 1.1 \u7248\u672c\u5c31\u652f\u6301\u4e86\u5355\u63a7\u5236\u9762\u591a\u96c6\u7fa4\u7684\u529f\u80fd\uff0c\u901a\u8fc7 pilot \u5c06\u591a\u4e2a\u6ce8\u518c\u4e2d\u5fc3\u7684\u6570\u636e\u805a\u5408\uff0c\u53ef\u4ee5\u6709\u6548\u964d\u4f4e\u5355\u4e00\u6ce8\u518c\u4e2d\u5fc3\u7684\u8bfb\u5199\u538b\u529b\uff0c\u4f7f\u6ce8\u518c\u4e2d\u5fc3\u66f4\u5bb9\u6613\u6c34\u5e73\u6269\u5c55\u3002</p> <p>\u6bd4\u5982\u5728\u5b9e\u8df5\u4e2d\uff0c\u6211\u5c31\u5c06\u591a\u4e2a Consul \u6570\u636e\u4e2d\u5fc3\u7684\u6570\u636e\u901a\u8fc7 pilot \u6a21\u5757\u805a\u5408\uff0c\u7136\u540e\u63d0\u4f9b xDS \u534f\u8bae\uff0c\u4f9b\u670d\u52a1\u53d1\u73b0\u4f7f\u7528\uff0c\u5b9e\u73b0\u4e86\u865a\u62df\u673a\u5230 Kubernetes \u73af\u5883\u7684\u65e0\u7f1d\u8fc1\u79fb\u3002</p>"},{"location":"chap1/2chap1_service_register/#7-3-sidecar-check","title":"7-3 \u901a\u8fc7 sidecar \u63d0\u4f9b\u670d\u52a1\u6b63\u786e\u6027 check \u529f\u80fd","text":"<p>\u9645\u4e0a\u5982\u679c\u670d\u52a1 IP \u53d1\u751f\u53d8\u5316\uff0c\u53c8\u7528\u4e86\u540c\u6837\u7684 ping \u63a5\u53e3\u65f6\uff0c\u5065\u5eb7\u68c0\u67e5\u4f1a\u51fa\u73b0\u9519\u8bef\u3002\u800c\u901a\u8fc7 sidecar \u6a21\u5f0f\uff0c\u5f53\u53d1\u73b0\u670d\u52a1 ping \u63a5\u53e3\u8fc7\u6765\u7684\u6d41\u91cf\u65f6\uff0c\u8fdb\u884c\u670d\u52a1\u540d\u79f0\u7684\u68c0\u6d4b\uff0c\u901a\u8fc7 header \u4e2d\u589e\u52a0\u670d\u52a1\u540d\u79f0\u4e0e\u672c\u5730\u670d\u52a1\u540d\u79f0\u505a\u6821\u9a8c\u7684\u65b9\u5f0f\u8fdb\u884c\u68c0\u6d4b\uff0c\u53ef\u4ee5\u6709\u6548\u907f\u514d\u8fd9\u6837\u7684\u9519\u8bef\u3002</p> <p> </p>"},{"location":"chap1/3chap1_load_balancer/","title":"\u7b2c\u4e09\u8282 \u8d1f\u8f7d\u5747\u8861\u5668","text":""},{"location":"chap1/3chap1_load_balancer/#1","title":"1\u3001\u670d\u52a1\u53d1\u73b0\u540e\u5982\u4f55\u5b9e\u73b0\u8282\u70b9\u4fdd\u62a4","text":""},{"location":"chap1/3chap1_load_balancer/#1-1","title":"1-1 \u670d\u52a1\u53d1\u73b0\u540e\u5982\u4f55\u5b9e\u73b0\u8282\u70b9\u4fdd\u62a4","text":"<p>\u8d1f\u8f7d\u5747\u8861\uff08Load Balance\uff09\uff0c\u662f\u4e00\u79cd\u7f51\u7edc\u6d41\u91cf\u5206\u914d\u6280\u672f\uff0c\u7528\u4e8e\u89e3\u51b3\u5355\u53f0\u673a\u5668\u6027\u80fd\u51fa\u73b0\u74f6\u9888\u65f6\uff0c\u9700\u8981\u591a\u53f0\u673a\u5668\u5206\u644a\u5904\u7406\u6d41\u91cf\u7684\u60c5\u51b5</p> <p>load \u5728\u4e2d\u6587\u91cc\u4e5f\u6709\u201c\u91cf\u201d\u7684\u610f\u601d\uff0c\u5728\u8fd9\u91cc\u53ef\u4ee5\u7406\u89e3\u4e3a\u673a\u5668\u7684\u5de5\u4f5c\u91cf\uff0c\u90a3\u4e48 Load Balance \u5c31\u662f\u8ba9\u6bcf\u53f0\u673a\u5668\u5e73\u644a\u5904\u7406\u7684\u5de5\u4f5c\u91cf\uff08\u8bf7\u6c42\u91cf\uff09\u3002</p> <p>\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u5b9e\u73b0\u65b9\u5f0f\u3002</p> <ul> <li> <p>\u786c\u4ef6\u8d1f\u8f7d\u5747\u8861\uff1a\u6bd4\u8f83\u5e38\u89c1\u7684\u786c\u4ef6\u8d1f\u8f7d\u5747\u8861\u5668\u6709NetScaler\u3001F5\u3001Radware\uff0cArray \u7b49\uff0c\u7531\u4e13\u4e1a\u7684\u786c\u4ef6\u516c\u53f8\u751f\u4ea7\uff0c\u4e00\u822c\u5728\u4e92\u8054\u7f51\u516c\u53f8\u7684\u65e9\u671f\u9636\u6bb5\u8fdb\u884c\u4f7f\u7528\uff0c\u4f46\u662f\u7531\u4e8e\u4ef7\u683c\u6602\u8d35\uff0c\u73b0\u5728\u4e92\u8054\u7f51\u516c\u53f8\u5f88\u5c11\u4f7f\u7528\u4e86\u3002</p> </li> <li> <p>DNS \u8d1f\u8f7d\u5747\u8861\uff1a\u901a\u8fc7\u57df\u540d\u8fd4\u56de\u540e\u7aef\u8282\u70b9 IP \u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u540e\u7aef IP \u8bbe\u7f6e\u6743\u91cd\u3002\u56e0\u4e3a DNS \u89e3\u6790\u5b58\u5728\u7f13\u5b58\u5ef6\u65f6\u7684\u95ee\u9898\uff0c\u6240\u4ee5\u5728\u5185\u7f51\u8f83\u5c11\u4f7f\u7528\u3002\u4f46\u5bf9\u4e8e\u5927\u6d41\u91cf\u7684 Web \u548c App\uff0c\u5165\u53e3\u5c42\u4e00\u822c\u4f1a\u4f7f\u7528\u6b64\u79cd\u65b9\u5f0f\u505a\u8d1f\u8f7d\u5747\u8861\uff0c\u540e\u7aef\u591a\u7ec4\u56db\u5c42 LB \u505a\u8d1f\u8f7d\u5747\u8861\u3002</p> </li> </ul> <p> </p> <ul> <li>\u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861\uff1a\u6bd4\u8f83\u6d41\u884c\u7684\u662f Nginx\u3001HAproxy\u3001LVS \u7b49\uff0c<ul> <li>\u50cf LVS \u662f\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u6027\u80fd\u8f83\u9ad8\uff1b</li> <li>Nginx\u3001HAproxy \u4e3b\u8981\u7528\u4e8e\u4e03\u5c42\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u6709\u8f83\u591a\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u540c\u65f6\u6d41\u91cf\u76f8\u5bf9\u4e8e\u56db\u5c42\u4f1a\u66f4\u52a0\u5747\u8861\u3002</li> <li>\u50cf\u6211\u4eec\u5e38\u7528\u7684\u4e91\u5382\u5546\uff0c\u6bd4\u5982\u963f\u91cc\u4e91\u7684 SLB \u540c\u65f6\u63d0\u4f9b\u4e86\u57fa\u4e8e LVS \u7684\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u548c\u57fa\u4e8e\u4e03\u5c42\u7684 Tengine \u8d1f\u8f7d\u5747\u8861\u5668\u4f9b\u5927\u5bb6\u9009\u62e9\u3002</li> </ul> </li> </ul> <p> </p> <ul> <li> <p>\u7a0b\u5e8f\u5185\u8d1f\u8f7d\u5747\u8861\uff1a\u4e25\u683c\u6765\u8bf4\u5b83\u5c5e\u4e8e\u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861\u7684\u4e00\u79cd\uff0c\u53ea\u662f\u628a\u8d1f\u8f7d\u5747\u8861\u7684\u7b56\u7565\u653e\u5728\u4e86\u670d\u52a1\u5185\u90e8\u3002\u5bf9\u4e8e\u5fae\u670d\u52a1\u67b6\u6784\u6765\u8bf4\uff0c\u670d\u52a1\u5185\u90e8\u505a\u8d1f\u8f7d\u5747\u8861\u66f4\u5408\u9002\uff0c\u56e0\u4e3a\u5fae\u670d\u52a1\u5c31\u662f\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u53d1\u73b0\u670d\u52a1\u8282\u70b9\u7684\uff0c\u5728\u7a0b\u5e8f\u5185\u90e8\u9009\u53d6\u5408\u9002\u7684\u6d41\u91cf\u8282\u70b9\u81ea\u7136\u66f4\u52a0\u5408\u7406\u3002</p> </li> <li> <p>Serivce Mesh \u8d1f\u8f7d\u5747\u8861\uff1a\u5229\u7528 sidecar \u505a\u7a0b\u5e8f\u5185\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5c5e\u4e8e\u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861\u7684\u4e00\u79cd\uff0c\u76f8\u6bd4 SDK \u5185\u8d1f\u8f7d\u5747\u8861\uff0c\u53ef\u4ee5\u968f\u65f6\u66f4\u65b0\u5404\u79cd\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3002</p> </li> </ul>"},{"location":"chap1/3chap1_load_balancer/#1-2","title":"1-2 \u5e38\u7528\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5","text":"<ul> <li> <p>Round Robin\uff1a\u7b80\u5355\u8f6e\u8be2\u7b97\u6cd5\uff0c\u9002\u5408\u540e\u7aef\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\u3002\u5e94\u7528\u573a\u666f\u8f83\u5c11\uff0c\u4f46\u7b97\u6cd5\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a <code>O(1)</code>\uff0c \u53ef\u4ee5\u5728\u9884\u5148\u5224\u65ad\u540e\u7aef\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528\u3002</p> </li> <li> <p>Weighted Round Robin\uff1a\u901a\u8fc7\u53d6\u6700\u5927\u516c\u7ea6\u6570\u7684\u65b9\u5f0f\uff0c\u505a\u7b80\u5355\u8f6e\u8be2\u3002\u56e0\u4e3a\u6743\u91cd\u591a\u7684\u8282\u70b9\u4f1a\u6bd4\u8f83\u96c6\u4e2d\uff0cNginx\u53d1\u660e\u4e86\u4e00\u79cd\u5e73\u6ed1\u52a0\u6743\u8f6e\u8be2\uff0c\u901a\u8fc7\u7b97\u6cd5\u5c06\u6743\u91cd\u5927\u7684\u8282\u70b9\u5206\u6563\u5f00\uff0c\u4f46\u5728\u670d\u52a1\u91cd\u542f\u65f6\u4f9d\u7136\u4f1a\u51fa\u73b0\u8282\u70b9\u8bf7\u6c42\u8f83\u4e3a\u96c6\u4e2d\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>Weighted Random\uff1a\u901a\u8fc7\u968f\u673a\u7684\u65b9\u5f0f\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u914d\u5408\u4e8c\u5206\u67e5\u627e\uff0c\u53ef\u4ee5\u5c06\u65f6\u95f4\u590d\u6742\u5ea6\u964d\u5230<code>O(log^n)</code>\u3002\u8be5\u7b97\u6cd5\u5bf9\u4e8e\u540e\u7aef\u8282\u70b9\u975e\u5e38\u5747\u8861\uff0c\u4e0d\u4f1a\u51fa\u73b0\u52a0\u6743\u8f6e\u8be2\u5bfc\u81f4\u7684\u91cd\u542f\u65f6\u8282\u70b9\u8bf7\u6c42\u8f83\u4e3a\u96c6\u4e2d\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>Two Random Choices\uff1a\u76ee\u524d\u6bd4\u8f83\u6d41\u884c\u7684\u7b97\u6cd5\uff0c\u9002\u5408\u540e\u7aef\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\uff0c\u901a\u8fc7\u4e24\u6b21\u968f\u673a\u7b97\u6cd5\uff0c\u83b7\u53d6\u5230\u4e24\u4e2a\u8282\u70b9\uff0c\u7136\u540e\u5bf9\u6bd4\u8282\u70b9\u7684 CPU \u8d1f\u8f7d\uff0c\u5ef6\u65f6\u60c5\u51b5\u7b49\u4fe1\u606f\uff0c\u83b7\u53d6\u4e00\u4e2a\u6700\u4f18\u7684\u8282\u70b9\uff0c\u597d\u5904\u662f\u540e\u7aef\u8282\u70b9\u7684 CPU \u6216\u8005\u5ef6\u65f6\u4f1a\u6bd4\u8f83\u5747\u8861\uff0c\u56e0\u4e3a\u5206\u533a\u548c\u865a\u62df\u673a\u786c\u4ef6\u914d\u7f6e\u7684\u539f\u56e0\uff0c\u6b64\u79cd\u505a\u6cd5\u53ef\u4ee5\u52a8\u6001\u8c03\u8282\u540e\u7aef\u8282\u70b9\u8d1f\u8f7d\uff0c\u5728\u751f\u4ea7\u4e2d\u662f\u975e\u5e38\u597d\u7684\u9009\u62e9\u3002</p> </li> <li> <p>Sticky Session\uff08\u4f1a\u8bdd\u4fdd\u6301\uff09\uff1a\u6839\u636e\u5ba2\u6237\u7aef IP \u6216\u8005 Cookie \u8fdb\u884c\u4f1a\u8bdd\u4fdd\u6301\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u540c\u4e00\u4e2a\u5ba2\u6237\u7aef\uff0c\u6bcf\u6b21\u9009\u53d6\u7684\u540e\u7aef\u8282\u70b9 IP \u4fdd\u6301\u4e00\u81f4\uff0c\u4e3b\u8981\u662f\u7528\u4e8e\u767b\u5f55\u9a8c\u8bc1\u7684\u4f1a\u8bdd\u4fdd\u6301\u3002\u5b9e\u9645\u4e0a\u6b64\u79cd\u7b97\u6cd5\u8ba9\u670d\u52a1\u53d8\u6210\u4e86\u6709\u72b6\u6001\u670d\u52a1\uff0c\u53e6\u5916\u5bf9\u4e8e\u540e\u7aef\u8d1f\u8f7d\u4e5f\u4f1a\u4e0d\u5747\u8861\uff0c\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u5df2\u7ecf\u8f83\u5c11\u4f7f\u7528\u3002\u5982\u679c\u60f3\u8981\u8fdb\u884c Session \u7684\u4fdd\u6301\uff0c\u5927\u591a\u662f\u5c06 Session \u5b58\u50a8\u5728\u5916\u90e8\u5b58\u50a8\u4e2d\uff0c\u6bd4\u5982 Redis \u7b49\u3002</p> </li> </ul>"},{"location":"chap1/3chap1_load_balancer/#1-3","title":"1-3 \u670d\u52a1\u53d1\u73b0\u540e\u7684\u8282\u70b9\u4fdd\u62a4","text":""},{"location":"chap1/3chap1_load_balancer/#1-3-1","title":"1-3-1 \u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5","text":"<p>\u53d7\u6ce8\u518c\u4e2d\u5fc3\u7684\u7f51\u7edc\u5206\u533a\u6545\u969c\u7b49\u539f\u56e0\u5f71\u54cd\uff0c\u5728\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u8fdb\u884c\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\uff0c\u662f\u907f\u514d\u6b64\u7c7b\u60c5\u51b5\u53d1\u751f\u7684\u6700\u4f73\u6a21\u5f0f\uff0c\u4f46\u957f\u65f6\u95f4\u7684\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u4f1a\u4ea7\u751f\u5927\u91cf\u65e0\u7528\u7684 ping \u64cd\u4f5c\uff0c\u9020\u6210\u4e0d\u5fc5\u8981\u7684\u673a\u5668\u8d1f\u8f7d\u635f\u5931\u3002</p> <p>\u6240\u4ee5\u5728\u5b9e\u8df5\u4e2d\uff0c\u5efa\u8bae\u9009\u62e9\u83b7\u53d6\u8fc7\u5c11\u7684\u8282\u70b9\u65f6\u624d\u89e6\u53d1\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6a21\u5f0f\u3002</p> <p>\u5f53\u83b7\u53d6\u8282\u70b9\u8fc7\u5c11\u3001\u8fdb\u5165\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u7684\u6a21\u5f0f\u65f6\u4f1a\u89e6\u53d1\u5bf9\u540e\u7aef\u8282\u70b9\u7684 ping \u64cd\u4f5c\uff0c\u8fd9\u4e2a\u8fc7\u5c11\u7684\u9608\u503c\u53ef\u4ee5\u6839\u636e\u516c\u53f8\u8d1f\u8f7d\u60c5\u51b5\u786e\u5b9a\u3002\u6bd4\u5982\u5728\u5b9e\u9645\u64cd\u4f5c\u4e2d\uff0c\u5982\u679c\u673a\u5668\u8d1f\u8f7d\u957f\u671f\u5904\u4e8e\u6bd4\u8f83\u9ad8\u7684\u6c34\u4f4d\uff0c\u4f60\u53ef\u4ee5\u91c7\u7528\u4e00\u4e2a\u6bd4\u8f83\u4fdd\u5b88\u7684\u6570\u503c\uff0c\u6bd4\u5982\u5c0f\u4e8e 80% \u7684\u65f6\u5019\u89e6\u53d1\u3002</p> <p>\u4e3a\u4e86\u80fd\u591f\u4fdd\u8bc1\u4e24\u53f0\u673a\u5668\u81f3\u5c11\u80fd\u591f\u4e0b\u6389\u4e00\u53f0\uff0c\u91c7\u7528\u4e86 </p> <pre><code>(currentNodeNum+1)/nodeCount &lt; 80% \n</code></pre> <p>\u4ee5\u4fdd\u8bc1\u81f3\u5c11\u4e0b\u6389\u4e00\u4e2a\u8282\u70b9\u3002\u5176\u4e2d nodeCount \u4e3a 15 \u5206\u949f\u524d\u7684\u670d\u52a1\u8282\u70b9\u603b\u6570\uff0c\u5f53\u7136\u8fd9\u6837\u662f\u4e00\u4e2a\u7ecf\u9a8c\u503c\uff0c\u4f60\u4e5f\u53ef\u4ee5\u6839\u636e\u516c\u53f8\u7684\u5b9e\u9645\u60c5\u51b5\u9002\u5f53\u8c03\u6574\u3002</p> <p>\u5728\u5bb9\u5668\u73af\u5883\u4e2d\uff0c\u6269\u7f29\u5bb9\u65f6\u53ef\u80fd\u4f1a\u89e6\u53d1\u8282\u70b9\u7684\u81ea\u6211\u4fdd\u62a4\u6a21\u5f0f\uff0c\u9020\u6210\u4e00\u5b9a\u7684\u77ed\u65f6\u95f4\u6d41\u91cf\u635f\u5931\uff0c\u4f46\u76f8\u5bf9\u4e8e\u56e0\u4e3a\u6d41\u91cf\u6253\u5230\u4e86\u9519\u8bef\u7684\u8282\u70b9\u4e0a\u5f15\u53d1\u7684\u96ea\u5d29\uff0c\u6211\u8ba4\u4e3a\u6b64\u79cd\u60c5\u51b5\u8fd8\u662f\u53ef\u4ee5\u63a5\u53d7\u7684\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#1-3-2","title":"1-3-2 \u6050\u614c\u9608\u503c","text":"<p>\u4f9d\u636e\u5065\u5eb7\u68c0\u67e5\u7684\u7ed3\u679c\u5224\u65ad\u540e\u7aef\u8282\u70b9\u662f\u5426\u6b63\u5e38\uff0c\u8fd9\u79cd\u65b9\u5f0f\u867d\u7136\u53ef\u4ee5\u4fdd\u8bc1\u7f51\u7edc\u5206\u533a\u5f02\u5e38\u60c5\u51b5\u4e0b\u8282\u70b9\u95f4\u7684\u8fde\u901a\u6027</p> <p>\u4f46\u5982\u679c\u540e\u7aef\u8282\u70b9\u5927\u91cf\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709\u5c11\u6570\u8282\u70b9\u80fd\u591f\u901a\u8fc7\u5065\u5eb7\u68c0\u67e5\u3002\u6b64\u79cd\u60c5\u51b5\u4e0b\uff0c\u5c11\u91cf\u7684\u8282\u70b9\u663e\u7136\u662f\u65e0\u6cd5\u63d0\u4f9b\u6b63\u5e38\u670d\u52a1\u7684\u3002</p> <p>\u56de\u6eda:</p> <p>\u56e0\u4e3a\u670d\u52a1\u53d1\u7248\u5bfc\u81f4\u7684\u670d\u52a1\u8282\u70b9\u591a\u6570\u6216\u8005\u5168\u90e8\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\u4e5f\u5f88\u5bb9\u6613\u51fa\u73b0\uff0c\u6b64\u65f6\u4f60\u7684\u9996\u9009\u64cd\u4f5c\u4e00\u5b9a\u662f\u56de\u6eda\u3002</p> <p>\u56de\u6eda\u671f\u95f4\uff0c\u8282\u70b9\u7684\u53ef\u7528\u662f\u6709\u5148\u540e\u987a\u5e8f\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u5b8c\u5168\u4fe1\u4efb\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u7684\u7ed3\u679c\uff0c\u4f1a\u5bfc\u81f4\u6d41\u91cf\u5168\u90e8\u8def\u7531\u5230\u65b0\u56de\u6eda\u6210\u529f\u7684\u8282\u70b9\u4e0a\uff0c\u9020\u6210\u65b0\u542f\u52a8\u7684\u8282\u70b9\u4f1a\u7acb\u5373\u88ab\u6253\u6302\u3002</p> <ul> <li>\u89e3\u51b3\u4e0a\u9762\u4e24\u79cd\u95ee\u9898\u7684\u529e\u6cd5\u4e00\u79cd\u662f\u670d\u52a1\u6cbb\u7406\u4e2d\u7684\u9650\u6d41\uff0c</li> <li>\u53e6\u5916\u4e00\u79cd\u529e\u6cd5\u5c31\u662f\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u7684\u6050\u614c\u9608\u503c\u3002 </li> </ul> <p>\u5f53\u5065\u5eb7\u68c0\u67e5\u540e\u8282\u70b9\u4f9d\u7136\u5c11\u4e8e\u8bbe\u5b9a\u7684\u9608\u503c\uff0c\u5219\u5ffd\u7565\u5065\u5eb7\u68c0\u67e5\u7ed3\u679c\uff0c\u5c06\u6d41\u91cf\u8def\u7531\u5230\u5168\u90e8\u7684\u8282\u70b9\uff0c\u5305\u62ec\u4e0d\u5065\u5eb7\u7684\u8282\u70b9\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u8d1f\u8f7d\u7684\u5747\u8861\uff0c\u4e5f\u4e0d\u4f1a\u628a\u6d41\u91cf\u96c6\u4e2d\u5230\u8fc7\u5c11\u7684\u8282\u70b9\uff0c\u5bfc\u81f4\u670d\u52a1\u5904\u4e8e\u201c\u96ea\u5d29\u201d\u7684\u72b6\u6001\u3002</p> <p>\u8fd9\u4e2a\u9608\u503c\u7684\u8bbe\u7f6e\u4e5f\u662f\u6bd4\u8f83\u8bb2\u7a76\u7684\uff0c\u867d\u7136 Envoy \u5b98\u65b9\u9ed8\u8ba4\u503c\u662f 50%\uff0c\u4f46\u6211\u89c9\u5f97\u8fd9\u5e76\u4e0d\u662f\u6700\u5408\u9002\u7684\u8bbe\u7f6e\uff1a50% \u7684\u9608\u503c\u592a\u8fc7\u6fc0\u8fdb\uff0c\u5f88\u5bb9\u6613\u8fbe\u5230\u89e6\u53d1\u6761\u4ef6\u3002</p> <p>\u800c\u5f53\u4f60\u7406\u89e3\u4e86\u8fd9\u4e2a\u9608\u503c\u7684\u4f5c\u7528\uff0c\u5c31\u4f1a\u660e\u767d\u5f53\u7ebf\u4e0a\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u8282\u70b9\u662f\u4f1a\u8d8b\u4e8e\u5168\u90e8\u4e0d\u53ef\u7528\u7684\uff0c\u6240\u4ee5\u7ebf\u4e0a\u6211\u628a\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u4e3a 10%\u3002\u56e0\u4e3a\u968f\u7740\u6545\u969c\u8282\u70b9\u53d8\u591a\uff0c\u5269\u4e0b\u7684\u5c11\u91cf\u8282\u70b9\u4e5f\u625b\u4e0d\u4f4f\u8c03\u7528\u65b9\u7684\u6240\u6709\u6d41\u91cf\uff0c\u5269\u4f59\u7684\u8282\u70b9\u4f1a\u6162\u6162\u8d8b\u8fd1\u6211\u4eec\u8bbe\u7f6e\u7684\u9608\u503c\uff0c\u4e00\u6837\u53ef\u4ee5\u8fbe\u5230\u6050\u614c\u9608\u503c\u8bbe\u7f6e\u7684\u76ee\u7684\uff0c\u800c\u4e14\u4e5f\u4e0d\u4f1a\u56e0\u4e3a\u53ea\u662f\u5c11\u91cf\u8282\u70b9\u6545\u969c\uff0c\u89e6\u53d1\u9608\u503c\u5bfc\u81f4\u7684\u9519\u8bef\u6d41\u91cf\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#1-3-3","title":"1-3-3 \u88ab\u52a8\u5065\u5eb7\u68c0\u67e5","text":"<p>\u6709\u4e9b\u65f6\u5019\u5355\u7eaf\u9760\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u4f9d\u7136\u65e0\u6cd5\u907f\u514d\u9519\u8bef\u7684\u6d41\u91cf\uff0c\u6bd5\u7adf\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u53ea\u662f\u901a\u8fc7\u7279\u5b9a\u7684 ping \u63a5\u53e3\u6216\u8005 TCP \u63a2\u6d3b\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5\u7684\uff0c\u8fd9\u4e9b\u5e76\u4e0d\u662f\u670d\u52a1\u7684\u771f\u5b9e\u6d41\u91cf\uff0c\u7279\u522b\u662f\u5728\u4f7f\u7528 TCP \u63a2\u6d3b\u7684\u65f6\u5019\uff0c\u66f4\u5bb9\u6613\u51fa\u73b0\u95ee\u9898\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u88ab\u52a8\u5065\u5eb7\u68c0\u67e5\u4e86\uff0c\u901a\u8fc7\u771f\u5b9e\u6d41\u91cf\u6765\u5224\u65ad\u8282\u70b9\u662f\u5426\u6b63\u5e38\uff0c\u4e5f\u5c31\u662f\u5229\u7528\u8282\u70b9\u7194\u65ad\u5668\u3002</p> <p>\u548c\u670d\u52a1\u7ea7\u522b\u7684\u7194\u65ad\u5668\u4e00\u6837\uff0c\u8282\u70b9\u7194\u65ad\u5668\u4e5f\u662f\u901a\u8fc7\u72b6\u6001\u7801\u5224\u65ad\u670d\u52a1\u662f\u5426\u6b63\u5e38\uff0c\u5047\u5982\u540e\u7aef\u662f HTTP \u670d\u52a1\uff0c\u6211\u4eec\u901a\u5e38\u4f1a\u5c06 499 \u4ee5\u4e0a\u7684\u9519\u8bef\u7801\u8ba4\u4e3a\u662f\u540e\u7aef\u670d\u52a1\u9519\u8bef\u3002</p> <p>\u901a\u8fc7\u8bb0\u5f55 10s \u7684\u6ed1\u52a8\u7a97\u53e3\u5185\u7684\u9519\u8bef\u7801\u6bd4\u4f8b\uff0c\u5f53\u540e\u7aef\u8282\u70b9\u7684\u9519\u8bef\u6bd4\u4f8b\u8fbe\u5230\u6211\u4eec\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\uff0c\u4fbf\u5c06\u540e\u7aef\u8282\u70b9\u4ece\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u79fb\u9664\u3002\u5f53\u7136\u4f60\u4e5f\u8981\u8003\u8651\u4e0d\u80fd\u6458\u9664\u8fc7\u591a\u7684\u8282\u70b9\uff0c\u6240\u4ee5\u7194\u65ad\u5668\u9700\u8981\u8bbe\u7f6e\u548c\u81ea\u6211\u4fdd\u62a4\u76f8\u540c\u7684\u89e6\u53d1\u9608\u503c\uff0c\u4ee5\u907f\u514d\u8fc7\u591a\u7684\u8282\u70b9\u88ab\u79fb\u51fa\u5f15\u53d1\u201c\u96ea\u5d29\u201d\u3002</p> <p> </p>"},{"location":"chap1/3chap1_load_balancer/#2","title":"2\u3001\u5982\u4f55\u5b9e\u73b0\u67d3\u8272\u548c\u5730\u57df\u4f18\u5148","text":""},{"location":"chap1/3chap1_load_balancer/#2-1","title":"2-1 \u8282\u70b9\u67d3\u8272","text":"<p>\u8282\u70b9\u67d3\u8272\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u628a\u67d0\u4e00\u7c7b\u8282\u70b9\u6253\u4e0a\u76f8\u540c\u7684\u6807\u7b7e\uff0c\u7136\u540e\u8d1f\u8f7d\u5747\u8861\u5668\u6839\u636e\u6807\u7b7e\u6765\u5206\u53d1\u6d41\u91cf\u3002</p> <p>\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u67d3\u8272\u6709\u5f88\u591a\u4f5c\u7528\uff0c\u6bd4\u5982\u91d1\u4e1d\u96c0\u53d1\u5e03\u3001A/B\u6d4b\u8bd5\u3001\u6545\u969c\u6f14\u7ec3\u3001\u6d41\u91cf\u533a\u5206\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u67d3\u8272\u6765\u5b9e\u73b0\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#2-1-1","title":"2-1-1 \u5982\u4f55\u64cd\u4f5c\u5462","text":"<ul> <li>\u9996\u5148\u6211\u4eec\u9700\u8981\u5728\u7f51\u5173\u5c42\uff0c\u6839\u636e header \u4fe1\u606f\u6216\u8005\u6743\u91cd\u5bf9\u6d41\u91cf\u8fdb\u884c\u67d3\u8272\u3002</li> </ul> <p>\u6bd4\u5982\u5728\u5ba2\u6237\u7aef\u7684\u67d0\u4e9b\u7248\u672c\u4e2d\u5199\u5165\u67d3\u8272\u7684 header\uff0c\u5c31\u50cf <code>X-TAG=canary</code>\uff1b\u4e5f\u53ef\u4ee5\u5728\u7f51\u5173\u5c42\u5bf9\u6d41\u91cf\u6309\u7167\u6bd4\u4f8b\u5206\u6d41\uff0c\u6bd4\u5982 1% \u7684\u6d41\u91cf\u6253\u4e0a\u91d1\u4e1d\u96c0\u7684\u6807\u7b7e\u8fdb\u884c\u7070\u5ea6\u6d4b\u8bd5\u3002</p> <ul> <li>\u5728\u6ce8\u518c\u4e2d\u5fc3\u4e5f\u9700\u8981\u5199\u5165\u5bf9\u5e94\u7684 MetaData \u4fe1\u606f\uff0c\u7528\u4e8e\u5728\u8d1f\u8f7d\u5747\u8861\u5c42\u8fdb\u884c\u6d41\u91cf\u7684\u8fc7\u6ee4</li> </ul> <p>\u6bd4\u5982\u5728\u6ce8\u518c\u4e2d\u5fc3\u7684 MetaData \u4fe1\u606f\u4e2d\u5b9a\u4e49 <code>lb_tags</code> \u7684\u5b57\u6bb5\uff0c\u6570\u636e\u4e3a <code>[stage:canary, v:1.2]</code>\uff0c\u5728 LB \u8fdb\u884c\u5339\u914d\u7684\u65f6\u5019\uff0c\u5e26\u6709\u91d1\u4e1d\u96c0 header \u7684\u8bf7\u6c42\uff0c\u5c31\u4f1a\u8bf7\u6c42\u5230 <code>lb_tags</code> \u5305\u542b canary \u7684\u8282\u70b9\u4e0a\u9762\u3002</p> <p> </p> <p>\u53e6\u5916\u6211\u4eec\u4e5f\u9700\u8981\u8003\u8651\u6ca1\u6709\u5339\u914d\u5230\u5bf9\u5e94\u8282\u70b9\u65f6\u7684\u964d\u7ea7\u7b56\u7565\uff0c\u53c2\u8003 Envoy \u4e2d\u7684\u914d\u7f6e\uff0c\u4e00\u822c\u6709\u5982\u4e0b\u51e0\u79cd\uff1a</p> <p> </p> <p>\u6bd4\u5982\u5728\u91d1\u4e1d\u96c0\u8fd9\u79cd\u7b56\u7565\u4e2d\uff0c\u6211\u4eec\u5c06\u6807\u6ce8 canary \u7684 tag \u7684\u8282\u70b9\uff0c\u914d\u7f6e <code>DEFAULT_SUBSET</code>\uff0c\u8fd9\u6837\u5982\u679c\u91d1\u4e1d\u96c0\u7684\u8282\u70b9\u4e0d\u5b58\u5728\u7684\u8bdd\uff0c\u5c31\u4f1a\u8bbf\u95ee prod \u7684\u8282\u70b9\uff0c</p> <p>\u5c06\u6807\u6ce8 prod \u7684\u8282\u70b9\u914d\u7f6e <code>NO_ENDPOINT</code>\uff0c\u8fd9\u6837 prod \u7684\u8282\u70b9\u5c31\u4e0d\u4f1a\u6709\u67d3\u8272\u7684\u964d\u7ea7\u7b56\u7565\uff0c\u800c\u662f\u4f7f\u7528\u6211\u4eec\u4e4b\u524d\u914d\u7f6e\u7684\u81ea\u6211\u4fdd\u62a4\u7b56\u7565\u4e86\u3002</p> <p>\u67d3\u8272\u662f\u8d1f\u8f7d\u5747\u8861\u5668\u5229\u7528\u8282\u70b9\u4e0a\u7684\u6807\u7b7e\u8fdb\u884c\u6d41\u91cf\u8def\u7531\uff0c\u540c\u6837\u5730\u57df\u4f18\u5148\u8bbf\u95ee\u4e5f\u9700\u8981\u5229\u7528\u5728\u8282\u70b9\u4e0a\u6253\u4e0a\u5730\u57df\u6807\u7b7e\uff0c\u8ba9\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u5730\u57df\u4f18\u5148\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#2-2","title":"2-2 \u5730\u57df\u4f18\u5148\u8bbf\u95ee","text":""},{"location":"chap1/3chap1_load_balancer/#2-2-1","title":"2-2-1 \u5730\u57df\u4f18\u5148\u8bbf\u95ee","text":"<p>\u5728 Envoy \u4e2d\u4e5f\u88ab\u79f0\u4e3a zone \u611f\u77e5\u8def\u7531</p> <ul> <li>\u59cb\u53d1\u96c6\u7fa4\uff1a\u8c03\u7528\u65b9\uff0c\u4e5f\u5c31\u662f Client \u7aef\u7684\u670d\u52a1\u8282\u70b9\u96c6\u5408\u3002</li> <li>\u4e0a\u6e38\u96c6\u7fa4\uff1a\u88ab\u8c03\u7528\u65b9\uff0c\u4e5f\u5c31\u662f Server \u7aef\u7684\u670d\u52a1\u8282\u70b9\u96c6\u5408\u3002</li> <li>zone: \u533a\u57df\uff08Region\uff09\u548c\u53ef\u7528\u533a\uff08Availability Zone\uff0cAZ\uff09</li> </ul> <p>zone \u611f\u77e5\u8def\u7531\uff0c\u4f1a\u6839\u636e\u59cb\u53d1\u96c6\u7fa4\u7684\u6240\u5728\u533a\u8282\u70b9\u6570\u91cf\u548c\u76ee\u6807\u96c6\u7fa4\u7684\u6240\u5728\u533a\u8282\u70b9\u6570\u91cf\uff0c\u52a8\u6001\u8ba1\u7b97\u51fa\u4e00\u4e2a\u5bf9\u5e94\u7684\u6bd4\u4f8b\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#2-2-2","title":"2-2-2 \u5730\u57df\u6240\u5728\u533a\u9759\u6001\u52a0\u6743","text":"<p>\u8fd9\u79cd\u7b97\u6cd5\u6700\u5927\u7684\u95ee\u9898\uff0c\u662f\u5f88\u96be\u4fdd\u8bc1\u59cb\u53d1\u96c6\u7fa4\u548c\u4e0a\u6e38\u96c6\u7fa4\u7684\u6240\u5728\u533a\u662f\u4e00\u4e00\u5bf9\u5e94\u4e14\u6bd4\u4f8b\u76f8\u540c\u7684\uff0c</p> <p>\u6bd4\u5982\u59cb\u53d1\u96c6\u7fa4 A \u6240\u5728\u7684 c \u533a\u662f 50%\uff0c\u800c\u4e0a\u6e38\u96c6\u7fa4 B \u6240\u5728\u7684 c \u533a\u53ea\u6709 20%\uff0c\u8fd9\u6837\u5982\u679c\u53ea\u662f\u7b80\u5355\u7684\u9759\u6001\u52a0\u6743\uff0c\u5c31\u4f1a\u5bfc\u81f4\u59cb\u53d1\u96c6\u7fa4 c \u533a\u7684\u6d41\u91cf\u5c06\u4e0a\u6e38\u96c6\u7fa4 c \u533a\u6253\u6302\u3002</p> <p>\u5b9e\u9645\u4e0a\u5728\u5fae\u670d\u52a1\u6846\u67b6 Dubbo \u4e2d\u4e5f\u91c7\u7528\u4e86\u7c7b\u4f3c\u7684\u7b97\u6cd5\uff0c\u4f46\u8fd9\u79cd\u7b97\u6cd5\u5bf9\u8fd0\u7ef4\u73af\u5883\u8981\u6c42\u6bd4\u8f83\u9ad8\uff0c\u5e76\u4e0d\u9002\u5408\u7528\u5728\u771f\u5b9e\u7684\u73af\u5883\u4e2d\u3002</p> <p>zone \u611f\u77e5\u8def\u7531\u89e3\u51b3\u7684\u6700\u5927\u7684\u95ee\u9898\uff0c\u5c31\u662f\u5bf9\u8fd0\u7ef4\u73af\u5883\u7684\u4f9d\u8d56\u3002\u901a\u8fc7\u52a8\u6001\u8ba1\u7b97\u4e0a\u4e0b\u6e38\u7684\u8282\u70b9\u6570\uff0c\u5c06\u6d41\u91cf\u6b63\u786e\u5730\u8def\u7531\u5230\u5404\u4e2a\u5206\u533a\u3002\u867d\u7136\u4f1a\u4ea7\u751f\u4e00\u4e9b\u56e0\u73af\u5883\u5e26\u6765\u7684\u5ef6\u65f6\u95ee\u9898\uff0c\u4f46\u907f\u514d\u4e86\u6253\u6302\u4e0a\u6e38\u96c6\u7fa4\u7684\u98ce\u9669\u3002</p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\uff1a</p> <p>1.\u59cb\u53d1\u96c6\u7fa4\u7684\u672c\u5730 zone \u8282\u70b9\u6570\u91cf\u5c0f\u4e8e\u6216\u8005\u7b49\u4e8e\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u8282\u70b9\u6570\u91cf</p> <p>\u53ea\u9700\u5c06\u6d41\u91cf\u5168\u90e8\u6253\u5230\u5bf9\u5e94\u7684\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u7684\u8282\u70b9\u5c31\u53ef\u4ee5\u4e86\uff0c\u53e6\u5916\u8ba1\u7b97\u51fa\u7684\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728\u533a\u5269\u4f59\u7684\u6d41\u91cf\u6bd4\u4f8b\uff0c\u7528\u4e8e\u670d\u52a1\u5176\u4ed6\u6240\u5728\u533a\u96c6\u7fa4\u7684\u6d41\u91cf\u3002</p> <p>2. \u59cb\u53d1\u96c6\u7fa4\u7684\u672c\u5730 zone \u8282\u70b9\u6570\u91cf\u5927\u4e8e\u6216\u8005\u7b49\u4e8e\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u8282\u70b9\u6570\u91cf</p> <p>\u8fd9\u4e2a\u65f6\u5019\u5c31\u6ca1\u529e\u6cd5\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u4e86\uff0c\u56e0\u4e3a\u6b64\u79cd\u505a\u6cd5\u5f88\u660e\u663e\u4f1a\u5bfc\u81f4\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728\u533a\u7684\u6d41\u91cf\u4e0d\u5747\u8861\u3002\u8fd9\u65f6\u6211\u4eec\u5c31\u9700\u8981\u5c06\u5269\u4f59\u7684\u6d41\u91cf\u8def\u7531\u5230\u5176\u4ed6 zone \u7684\u4e0a\u6e38\u96c6\u7fa4\u4e86\u3002</p> <p>zone \u611f\u77e5\u8def\u7531\u5bf9\u4e8e\u964d\u4f4e\u56e0\u4e3a\u8de8\u5730\u57df\u8de8\u533a\u7684\u8bf7\u6c42\u5f15\u8d77\u7684\u5ef6\u65f6\u589e\u9ad8\u95ee\u9898\uff0c\u6709\u660e\u663e\u7684\u6548\u679c\uff0c\u4f46\u4f9d\u8d56\u4e8e\u83b7\u53d6\u672c\u5730\u6240\u5728 zone \u7684\u59cb\u53d1\u96c6\u7fa4\u8282\u70b9\u6570\u91cf\u3002</p> <p>\u5728\u5206\u5e03\u5f0f\u573a\u666f\u4e2d\uff0c\u5982\u679c\u8282\u70b9\u6570\u91cf\u53d1\u751f\u53d8\u5316\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u77ac\u95f4\u7684\u6d41\u91cf\u4e0d\u5747\u8861\uff0c\u6b64\u65f6\u6211\u4eec\u8981\u53ca\u65f6\u9000\u51fa\u6b64\u79cd\u6a21\u5f0f\u4ee5\u907f\u514d\u5f15\u53d1\u96ea\u5d29\uff0c\u4e5f\u56e0\u4e3a\u8fd9\u79cd\u95ee\u9898\uff0c\u6211\u4eec\u5f15\u5165\u4e86\u57fa\u4e8e P2C \u6280\u672f\uff08Pick of two choices\uff0c\u4e24\u79cd\u968f\u673a\u9009\u62e9\uff09\u7684\u52a8\u6001\u52a0\u6743\u8d1f\u8f7d\u5747\u8861\u6a21\u5f0f\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#2-3-ewma","title":"2-3 \u5ef6\u65f6\u3001\u8d1f\u8f7d\u52a0\u6743\uff08EWMA\uff09","text":"<p>\u5b9e\u9645\u4e0a\u57fa\u4e8e P2C \u7b97\u6cd5\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u662f\u8fd1\u5e74\u6765\u6700\u6d41\u884c\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff0c\u6211\u4eec\u5e38\u89c1\u7684 Service Mesh \u63a7\u5236\u9762\uff0c\u6bd4\u5982 Envoy\u3001Linkerd\uff0c\u9ed8\u8ba4\u90fd\u63d0\u4f9b\u57fa\u4e8e P2C \u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff0c\u53e6\u5916\u6700\u5e38\u7528\u7684\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u5668 Nginx\uff0c\u5728\u5176\u6536\u8d39\u7248\u672c NGINX plus \u4e2d\uff0c\u540c\u6837\u63d0\u4f9b\u4e86 P2C \u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u3002</p> <p> </p> <p>\u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684\u52a8\u6001\u52a0\u6743\u8d1f\u8f7d\u5747\u8861\uff0cP2C \u89e3\u51b3\u7684\u6700\u5927\u95ee\u9898\uff0c\u5c31\u662f\u201c\u7f8a\u7fa4\u6548\u5e94\u201d\u3002</p> <p>\u7f8a\u7fa4\u6548\u5e94\uff1a\u5f53\u67d0\u4e00\u8282\u70b9\u51fa\u73b0\u5ef6\u65f6\u6216\u8005 CPU \u8d1f\u8f7d\u8fc7\u9ad8\u65f6\uff0c\u59cb\u53d1\u96c6\u7fa4\u7684\u591a\u4e2a\u8282\u70b9\u90fd\u53d1\u73b0\u4e86\u8fd9\u4e2a\u8282\u70b9\u5ef6\u65f6/CPU \u8d1f\u8f7d\u8fc7\u9ad8\u7684\u95ee\u9898\uff0c\u5f88\u5bb9\u6613\u9020\u6210\u8fc7\u591a\u7684\u6d41\u91cf\u8def\u7531\u5230\u540c\u4e00\u8282\u70b9\uff0c\u9020\u6210\u8d1f\u8f7d\u4e0d\u5747\u8861\u3002</p> <p>\u56e0\u4e3a P2C \u662f\u968f\u673a\u83b7\u53d6\u4e24\u4e2a\u8282\u70b9\uff0c\u7136\u540e\u83b7\u5f97\u52a0\u6743\u503c\u7b97\u6cd5\u540e\u6700\u5927\u7684\u8282\u70b9\uff0c\u6240\u4ee5\u9700\u8981\u4e00\u4e2a\u52a0\u6743\u7b97\u6cd5\u7528\u6765\u5224\u65ad\u54ea\u4e2a\u8282\u70b9\u7684\u52a0\u6743\u503c\u66f4\u5927\u3002\u8d1f\u8f7d\u7387\u7684\u7b97\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>client_success / server_cpumath.Sqrt(latency+1)(inflight+1)\n</code></pre> <p>\u4e0b\u9762\u7b80\u5355\u89e3\u91ca\u4e00\u4e0b\u5404\u53c2\u6570\u7684\u610f\u4e49\u3002</p> <ul> <li><code>client_success</code>: \u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u6210\u529f\u7387</li> <li><code>server_cpu</code>: \u901a\u8fc7\u6bcf\u6b21\u8bf7\u6c42 response \u7684 header \u8fd4\u56de\uff0c\u670d\u52a1\u7aef\u7684 CPU \u77ac\u65f6\u503c</li> <li>latency\uff1a\u5ba2\u6237\u7aef\u8ba1\u7b97\u7684\u5ef6\u65f6</li> <li>inflight\uff1a \u6b63\u5728\u53d1\u9001\u4e2d\u7684\u8bf7\u6c42\u6570\u91cf</li> </ul> <p>\u5728\u8fd9\u91cc\u7684\u516c\u5f0f\u4e2d\uff0c\u6211\u4eec\u5e76\u6ca1\u6709\u52a0\u4e0a\u8282\u70b9\u7684\u9759\u6001\u6743\u91cd\u3002\u548c Envoy \u4e00\u6837\uff0c\u6211\u4eec\u53ea\u5728\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\u91c7\u7528\u6b64\u79cd\u7b97\u6cd5\uff0c\u56e0\u4e3aP2C \u7b97\u6cd5\u4f1a\u5bfc\u81f4\u540e\u7aef\u8282\u70b9\u7684\u5b9e\u9645\u6743\u91cd\u548c\u914d\u7f6e\u7684\u6743\u91cd\u76f8\u5dee\u6bd4\u8f83\u5927\uff0c\u7ed9\u8fd0\u7ef4\u4e2d\u7684\u4e34\u65f6\u8c03\u6574\u8282\u70b9\u6743\u91cd\u548c\u91d1\u4e1d\u96c0\u53d1\u5e03\u5e26\u6765\u4e00\u5b9a\u7684\u56f0\u6270\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#2-4-ewma","title":"2-4 EWMA \u8ba1\u7b97\u5ef6\u65f6\u548c\u5ba2\u6237\u7aef\u6210\u529f\u7387","text":"<p>\u53ef\u4ee5\u901a\u8fc7\u6ed1\u52a8\u7a97\u53e3\u7684\u65b9\u5f0f\u8ba1\u7b97 10s \u5185\u7684\u5ef6\u65f6\u5e73\u5747\u503c\u548c\u5ba2\u6237\u7aef\u6210\u529f\u7387\uff0c\u4f46\u8fd9\u79cd\u65b9\u5f0f\u6d88\u8017\u7684\u5185\u5b58\u6bd4\u8f83\u5927\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u9009\u62e9 EWMA\uff08Exponentially Weighted Averages\uff0c\u6307\u6570\u79fb\u52a8\u52a0\u6743\u5e73\u5747\uff09\u7684\u7b97\u6cd5\u6765\u8ba1\u7b97\u5ef6\u65f6\u548c\u5ba2\u6237\u7aef\u6210\u529f\u7387\u3002</p> <p> </p> <ul> <li>Vt \u4ee3\u8868\u7b2c t \u6b21\u8bf7\u6c42\u65f6\u7684 EWMA \u503c\uff0cVt-1 \u4ee3\u8868\u7b2c t-1 \u6b21\u8bf7\u6c42\u7684 EWMA \u503c\uff1b</li> <li>\u03b8t \u4ee3\u8868\u7b2c t \u6b21\u8bf7\u6c42\u7684\u5b9e\u9645\u8017\u65f6\uff0c\u6240\u4ee5\u03b2\u8d8a\u5c0f\uff0cVt \u8d8a\u63a5\u8fd1\u672c\u6b21\u8bf7\u6c42\u8017\u65f6\u3002</li> </ul> <p>\u5728\u5b9e\u9645\u4e2d\u03b2\u503c\u7684\u516c\u5f0f\uff1a<code>\u03b2= math.Exp(float64(-td) / float64(tau))</code>\uff0c \u5176\u4e2d td \u4e3a\u5f53\u524d\u65f6\u95f4\u548c\u4e0a\u6b21\u54cd\u5e94\u540e\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee\uff0ctau \u4e3a\u8870\u51cf\u7cfb\u6570\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#2-5","title":"2-5 \u8d1f\u8f7d\u5747\u8861\u4e2d\u7684\u5e38\u89c1\u95ee\u9898","text":""},{"location":"chap1/3chap1_load_balancer/#2-5-1","title":"2-5-1 \u4e3a\u4ec0\u4e48\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u4e2d\u6d41\u91cf\u4f1a\u4e0d\u5747\u8861\uff1f","text":"<p>Nginx \u8fd9\u6837\u7684\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u6d88\u8017\u6bd4\u8f83\u5927\uff0c\u7406\u8bba\u4e0a\u4e00\u53f0\u9ad8\u914d\u7f6e\u7684\u670d\u52a1\u5668\u5927\u6982\u80fd\u627f\u53d7 10w \u7ea7\u522b QPS \u7684\u8d1f\u8f7d\uff0c\u8ba9\u6211\u4eec\u8fc7\u65e9\u5730\u9047\u5230\u4e86\u5355\u673a\u74f6\u9888\u3002\u6240\u4ee5\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u901a\u5e38\u6211\u4eec\u4f1a\u9009\u53d6\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u4f46\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u6700\u5927\u7684\u95ee\u9898\u5c31\u662f\u6d41\u91cf\u4e0d\u5747\u8861\u3002</p> <p>\u56e0\u4e3a\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u57fa\u4e8e\u8fde\u63a5\u505a\u8d1f\u8f7d\u5747\u8861\uff0c\u5f53\u6211\u4eec\u6458\u6389\u67d0\u4e00\u4e2a\u8282\u70b9\uff0c\u4e5f\u5c31\u662f\u628a\u67d0\u4e2a\u8282\u70b9\u7684\u6743\u91cd\u8bbe\u7f6e\u4e3a 0 \u7684\u65f6\u5019\uff0c\u7531\u4e8e\u8fde\u63a5\u8fd8\u662f\u4fdd\u6301\u7684\uff0c\u6d41\u91cf\u4f9d\u7136\u4f1a\u6253\u5230\u8fd9\u4e2a\u8282\u70b9\uff0c\u6240\u4ee5\u4f7f\u7528\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u5f88\u591a\u65f6\u5019\u8981\u7b49\u5f85\u4e00\u6574\u5929\u624d\u80fd\u5c06\u8282\u70b9\u65e0\u635f\u5730\u6458\u6389\u3002\u8fd9\u5728\u5916\u7f51\u7f51\u5173\u7684\u6458\u53d6\u4e2d\u4e5f\u7279\u522b\u5e38\u89c1\u3002</p> <p>\u4e5f\u6b63\u662f\u8fd9\u79cd\u57fa\u4e8e\u8fde\u63a5\u7684\u673a\u5236\uff0c\u5bfc\u81f4\u67d0\u4e9b\u8fde\u63a5\u8bf7\u6c42 QPS \u9ad8\u3001\u67d0\u4e9b\u8fde\u63a5\u8bf7\u6c42 QPS \u4f4e\u7684\u60c5\u51b5\u4e5f\u5f88\u5bb9\u6613\u51fa\u73b0\u3002</p> <p>\u53e6\u5916\u5f53\u6211\u4eec\u505a\u670d\u52a1\u53d1\u5e03\u65f6\uff0c\u67d0\u4e2a\u8282\u70b9\u91cd\u542f\u540e\u4f1a\u51fa\u73b0\u6d41\u91cf\u5f88\u4f4e\u7684\u60c5\u51b5\uff0c\u4e5f\u662f\u56e0\u4e3a\u56db\u5c42\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u5df2\u7ecf\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u5efa\u7acb\u4e86\u8fde\u63a5\uff0c\u65b0\u52a0\u5165\u7684\u8282\u70b9\u5f80\u5f80\u9700\u8981\u8f83\u957f\u65f6\u95f4\u624d\u4f1a\u8d1f\u8f7d\u8d8b\u4e8e\u5747\u8861\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#2-5-2","title":"2-5-2 \u8d1f\u8f7d\u5747\u8861\u540e\u5404\u8282\u70b9\u6d41\u91cf\u5747\u8861\uff0c\u540e\u7aef\u670d\u52a1\u7684\u8d1f\u8f7d\u5c31\u4e00\u5b9a\u4e00\u81f4\u5417\uff1f","text":"<p>\u5b9e\u9645\u4e0a\uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u786c\u4ef6\u7684\u5dee\u5f02\uff0c\u7279\u522b\u662f\u865a\u62df\u673a\u5b58\u5728\u8d85\u5356\u7b49\u73b0\u8c61\uff0c\u5f88\u96be\u4fdd\u8bc1\u540c\u89c4\u683c\u7684\u670d\u52a1\u5668\u80fd\u591f\u5904\u7406\u540c\u6837\u7684 QPS \u91cf\u7ea7\uff0c\u6240\u4ee5\u540e\u7aef\u670d\u52a1\u5668\u7684\u8d1f\u8f7d\u5f88\u96be\u4e00\u81f4\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u6839\u636e\u5ef6\u65f6\u548c CPU \u60c5\u51b5\u7684\u4e00\u4e9b\u52a0\u6743\u7b56\u7565\u505a\u5904\u7406\u4e86\u3002</p>"},{"location":"chap1/3chap1_load_balancer/#2-5-3","title":"2-5-3 \u8282\u70b9\u4e0b\u7ebf\u540e\u5982\u4f55\u53ca\u65f6\u6458\u6389\u8282\u70b9\uff1f","text":"<p>\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u7b49\u5f85\u6ce8\u518c\u4e2d\u5fc3\u7684\u901a\u77e5\uff0c\u4f46\u56e0\u4e3a\u6ce8\u518c\u4e2d\u5fc3\u7684\u4e2d\u5fc3\u5316\u5f02\u6b65\u63a8\u9001\u673a\u5236\uff0c\u5f80\u5f80\u6536\u5230\u4fe1\u606f\u4e0d\u591f\u53ca\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7 upsteam \u8282\u70b9\u8fd4\u56de\u670d\u52a1\u5065\u5eb7\u68c0\u67e5\u5931\u8d25\u7684\u5934\u4fe1\u606f\uff0c\u8ba9\u5ba2\u6237\u7aef\u53ef\u4ee5\u5feb\u901f\u6458\u6389\u4e0d\u5065\u5eb7\u7684\u8282\u70b9\u3002</p>"},{"location":"chap1/4chap1_router/","title":"\u7b2c\u56db\u8282 \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565","text":""},{"location":"chap1/4chap1_router/#1","title":"1\u3001\u9488\u5bf9\u4e0d\u540c\u7684\u6d41\u91cf\u5b9e\u73b0\u591a\u79cd\u8def\u7531\u7b56\u7565","text":"<p>\u8def\u7531\u5668: \u6839\u636e\u4e0d\u540c\u89c4\u5219\u8fdb\u884c\u6d41\u91cf\u63a7\u5236\u548c\u8f6c\u53d1</p> <p>\u5b9e\u9645\u4e0a\u8def\u7531\u8fd9\u4e2a\u62bd\u8c61\u7684\u6982\u5ff5\u88ab\u63d0\u53ca\uff0c\u751a\u81f3\u8fbe\u5230\u6838\u5fc3\u7684\u4f4d\u7f6e\uff0c\u66f4\u591a\u7684\u662f\u5728 Service Mesh \u67b6\u6784\u4e2d\u3002\u5728\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u8def\u7531\u867d\u7136\u4e5f\u5b58\u5728\uff0c\u4f46\u56e0\u4e3a\u4e0d\u9700\u8981\u8fdb\u884c\u4e3b\u52a8\u914d\u7f6e\uff0c\u5b58\u5728\u611f\u5e76\u4e0d\u662f\u5f88\u5f3a\u3002</p> <p>\u800c\u5728 Service Mesh \u67b6\u6784\u4e2d\uff0c\u6570\u636e\u9762\u90fd\u662f\u901a\u8fc7\u63a7\u5236\u9762\u7684\u914d\u7f6e\u4e0b\u53d1\u9a71\u52a8\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u5fc5\u987b\u5f3a\u884c\u58f0\u660e\u8def\u7531\u914d\u7f6e\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u8c03\u7528\u51fa\u73b0 404 \u7684\u9519\u8bef\u3002</p> <p>\u8fd9\u79cd\u58f0\u660e\u5f0f\u7684\u67b6\u6784\u65b9\u5f0f\u4e5f\u8bb8\u56e0\u4e3a\u914d\u7f6e\u5e26\u6765\u4e86\u4e00\u4e9b\u4e0d\u4fbf\uff0c\u5374\u63d0\u9ad8\u4e86\u67b6\u6784\u7684\u53ef\u63a7\u6027\uff0c\u4e0d\u4f1a\u51fa\u73b0\u4f20\u7edf\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u65e0\u6cd5\u77e5\u9053\u8c03\u7528\u4e86\u51e0\u4e2a\u670d\u52a1\u7684\u95ee\u9898\u3002</p>"},{"location":"chap1/4chap1_router/#1-1-envoy","title":"1-1 Envoy \u4e2d\u7684\u8def\u7531\u914d\u7f6e","text":"<pre><code>{\n    \"version_info\": \"2020-12-07T01:38:20Z\",\n    \"route_config\": {\n        \"name\": \"9080\",\n        \"virtual_hosts\": [{\n            \"name\": \"details.default.svc.cluster:9080\",\n            \"domains\": [\n                \"details.default.svc.cluster:9080\",\n            ],\n            \"routes\": [{\n                \"match\": {\n                    \"prefix\": \"/\"\n                },\n                \"route\": {\n                    \"cluster\": \"outbound|9080||details.default.svc.cluster\",\n                    \"timeout\": \"10s\",\n                    \"max_grpc_timeout\": \"10s\"\n                },\n                \"per_filter_config\": {\n                    \"mixer\": {\n                    }\n                }\n            }]\n        }]\n    }\n}\n</code></pre> <ul> <li> <p>name\uff1a\u4e3b\u8981\u662f\u5bf9\u5e94 listener\uff08\u76d1\u542c\u5668\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a sidecar \u7684\u76d1\u542c\u7aef\u53e3\uff09\u7684\u540d\u79f0\uff0c\u8fd9\u91cc\u7528\u7aef\u53e3\u4f5c\u4e3a\u540d\u5b57\uff0c\u5df2\u7ecf\u786e\u4fdd\u4e86\u552f\u4e00\u6027\u3002\u901a\u5e38\u6211\u4eec\u7684\u8def\u7531\u914d\u7f6e\u9488\u5bf9\u6bcf\u79cd\u534f\u8bae\u4f1a\u6709\u4e24\u4efd\uff08Client \u7aef\u8def\u7531\u548c Server \u7aef\u8def\u7531\uff09\uff0c\u8fd9\u4e00\u8bb2\uff0c\u6211\u4eec\u4e3b\u8981\u8bb2\u89e3 Client \u7aef\uff0c\u4e5f\u5c31\u662f\u8c03\u7528\u65b9\u7684\u8def\u7531\u914d\u7f6e\u3002\u56e0\u4e3a\u8c03\u7528\u65b9\u7684\u8def\u7531\u914d\u7f6e\u76f8\u5bf9\u6bd4\u8f83\u590d\u6742\uff0c\u7406\u89e3\u4e86\u8c03\u7528\u65b9\u914d\u7f6e\uff0c\u88ab\u8c03\u7528\u7aef\u5c31\u5f88\u5bb9\u6613\u7406\u89e3\u4e86\u3002</p> </li> <li> <p>domains\uff1a\u5728 Envoy \u4e2d\u4f1a\u5148\u505a\u4e00\u5c42\u521d\u6b65\u7684\u8fc7\u6ee4\uff0c\u8fd9\u5c42\u8fc7\u6ee4\u5c31\u662f\u670d\u52a1\u57df\u540d\uff08\u540d\u79f0\uff09\uff0c\u8fd9\u5c42\u5339\u914d\u975e\u5e38\u7b80\u5355\uff0c\u57fa\u672c\u4e0a\u5c31\u662f\u5b57\u7b26\u4e32\u7684\u5bf9\u6bd4\uff0c\u6240\u4ee5\u901f\u5ea6\u4f1a\u5f88\u5feb\uff0c\u8fd9\u6837\u5c31\u907f\u514d\u4e86\u76f4\u63a5\u904d\u5386\u6240\u6709\u8def\u7531\u5e26\u6765\u7684\u4e0d\u5fc5\u8981\u7684\u6027\u80fd\u6d88\u8017\u3002</p> </li> <li> <p>routes\uff1a\u670d\u52a1\u7684\u8def\u7531\u914d\u7f6e\uff0c\u53ef\u4ee5\u6ce8\u610f\u5230\u8fd9\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u8981\u8bbf\u95ee\u7684\u670d\u52a1\u8bbe\u7f6e\u591a\u6761\u8def\u7531\u914d\u7f6e\u3002\u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u7684\u8def\u7531\u89c4\u5219\uff0c\u8fdb\u884c\u4e0d\u540c\u7684 filter \u914d\u7f6e\u3002</p> </li> <li> <p>routes\uff1a\u670d\u52a1\u7684\u8def\u7531\u914d\u7f6e\uff0c\u53ef\u4ee5\u6ce8\u610f\u5230\u8fd9\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u8981\u8bbf\u95ee\u7684\u670d\u52a1\u8bbe\u7f6e\u591a\u6761\u8def\u7531\u914d\u7f6e\u3002\u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u7684\u8def\u7531\u89c4\u5219\uff0c\u8fdb\u884c\u4e0d\u540c\u7684 filter \u914d\u7f6e\u3002</p> </li> </ul> <p>routers \u6570\u7ec4\u7ed3\u6784</p> <ul> <li>match\uff1a \u7528\u4e8e\u8def\u7531\u5339\u914d\uff0c\u7a0b\u5e8f\u4f1a\u904d\u5386\u5339\u914d\u6b64\u5b57\u6bb5\u5230\u5bf9\u5e94\u7684\u8def\u7531\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u914d\u7f6e header\u3001path\u3001pathPrefix \u7b49\u3002</li> <li>route\uff1a \u4e3b\u8981\u662f\u5339\u914d\u5230\u8fd9\u6761\u8def\u7531\u7684\u57fa\u672c\u89c4\u5219\u8bbe\u7f6e\u3002\u6bd4\u5982 Cluster \u5b57\u6bb5\u662f\u8fd9\u6761\u8def\u7531\u5bf9\u5e94\u7684\u670d\u52a1\u540d\uff0c\u8fd9\u4e5f\u662f\u8def\u7531\u6a21\u5757\u6700\u6838\u5fc3\u7684\u4f5c\u7528\uff0c\u901a\u8fc7\u8def\u7531\u89c4\u5219\u5339\u914d\u5230\u5408\u9002\u7684\u670d\u52a1\u540d\uff0c\u7136\u540e\u8fdb\u884c\u8f6c\u53d1\u3002 <ul> <li>\u6bd4\u5982\u5728\u6b64\u914d\u7f6e\u5b9e\u4f8b\u4e2d<code>\"details.default.svc.cluster:9080\"</code>\u7684\u670d\u52a1\u4f1a\u88ab\u8f6c\u53d1\u5230<code>\"outbound|9080||details.default.svc.cluster\"</code>\u5bf9\u5e94\u7684\u670d\u52a1\u8282\u70b9\u4e0a\u9762\u3002\u53e6\u5916\u4e24\u4e2a\u5b57\u6bb5\u5219\u662f\u670d\u52a1\u8f6c\u53d1\u7684\u8d85\u65f6\u65f6\u95f4\u3002</li> </ul> </li> <li><code>per_filter_config</code>\uff1a \u8def\u7531\u5bf9\u5e94\u7684\u4e2d\u95f4\u4ef6\u914d\u7f6e\uff0c\u7528\u4e8e\u670d\u52a1\u6cbb\u7406\u7684\u9650\u6d41\u3001\u7194\u65ad\u7b49\u3002</li> </ul>"},{"location":"chap1/4chap1_router/#1-2","title":"1-2 \u7cbe\u51c6\u6d41\u91cf\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03","text":"<p>\u91d1\u4e1d\u96c0\u53d1\u5e03\u4e5f\u53eb\u7070\u5ea6\u53d1\u5e03\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u5c06\u5c11\u91cf\u7684\u751f\u4ea7\u6d41\u91cf\u8def\u7531\u5230\u7ebf\u4e0a\u670d\u52a1\u7684\u65b0\u7248\u672c\u4e2d\uff0c\u4ee5\u9a8c\u8bc1\u65b0\u7248\u672c\u7684\u51c6\u786e\u6027\u548c\u7a33\u5b9a\u6027\u3002</p> <pre><code>{\n  \"route_config\": {\n    \"virtual_hosts\": [\n      {\n        \"name\": \"helloworld\",\n        \"domains\": [\"*\"],\n        \"routes\": [\n          {\n            \"prefix\": \"/\",\n            \"weighted_clusters\": {\n              \"clusters\" : [\n                { \"name\" : \"helloworld|stage=canary\", \"weight\" : 1},\n                { \"name\" : \"helloworld|stage=prod\", \"weight\" : 99 },\n              ]\n            }\n          }\n        ]\n      }\n    ]\n  }\n}\n</code></pre> <p>\u76f8\u5bf9\u4e8e\u524d\u9762\u7684 Cluster \u7684\u914d\u7f6e\uff0c\u8fd9\u91cc\u591a\u51fa\u4e86 <code>weighted_clusters</code> \u7684\u914d\u7f6e\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0cEnvoy \u4f1a\u6309\u7167\u6743\u91cd\u5c06\u6d41\u91cf\u8def\u7531\u5230 <code>HelloWorld</code>\u8fd9\u4e2a\u670d\u52a1\u4e0d\u540c\u7684\u7248\u672c\u4e2d\uff0cname \u4e2d\u7684 <code>stage=canary</code> \u53ef\u4ee5\u7406\u89e3\u4e3a\u6ce8\u518c\u4e2d\u5fc3\u7684\u9488\u5bf9\u4e0d\u540c\u8282\u70b9\u7684 tag\uff0c\u5728 Pilot \u4e2d\u4f1a\u88ab\u5f53\u4f5c\u670d\u52a1\u540d\u7684\u4e00\u90e8\u5206\u62fc\u5728\u670d\u52a1\u540d\u4e2d\u3002</p> <p>\u5f53\u7136\uff0c\u548c\u4e4b\u524d\u5728\u8d1f\u8f7d\u5747\u8861\u6a21\u5757\u4e2d\u8bb2\u5230\u7684\u67d3\u8272\u4e00\u6837\uff0c\u6211\u4eec\u9700\u8981\u9488\u5bf9\u673a\u5668\u6216\u8005 Pod \u6253\u4e0a\u6807\u7b7e\uff0c\u6bd4\u5982\u5728\u8fdb\u884c CD \u53d1\u5e03\u7684\u65f6\u5019\uff0c\u5c06\u7528\u4e8e\u91d1\u4e1d\u96c0\u7684 Pod \u6253\u4e0a stage=canary \u7684\u6807\u7b7e\uff0c\u8fd9\u6837\u6211\u4eec\u518d\u66f4\u65b0\u5ba2\u6237\u7aef\u7684\u8def\u7531\u914d\u7f6e\uff0c\u5c31\u4f1a\u6709 1% \u7684\u6d41\u91cf\u8def\u7531\u5230\u91d1\u4e1d\u96c0\u7684 Pod \u4e0a\u4e86</p> <p>\u5176\u5b9e\uff0c\u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684 Kubernetes \u6216\u8005 ECS \u7070\u5ea6\u53d1\u5e03\u53ea\u80fd\u8fdb\u884c\u8282\u70b9\u7ef4\u5ea6\u7684\u7070\u5ea6\uff0c\u8fd9\u91cc\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03\u5c06\u6d41\u91cf\u53d8\u5f97\u66f4\u52a0\u7cbe\u51c6\u53ef\u63a7\u3002</p> <p>\u6211\u4eec\u5728\u5165\u53e3\u7f51\u5173\u5c42\uff0c\u8fdb\u884c\u8def\u7531\u6d41\u91cf\u5206\u914d\uff0c\u8fd9\u4e2a\u65f6\u5019\u5212\u51fa\u4e00\u90e8\u5206\u6d41\u91cf\u7528\u4f5c canary \u7684\u7070\u5ea6\uff0c\u5269\u4f59\u7684\u66f4\u591a\u6d41\u91cf\u7528\u4e8e\u6b63\u5f0f\u7248\u672c\uff0c\u8fd9\u6837\u5c31\u65e0\u987b\u5728 CD \u53d1\u5e03\u65f6\u505a\u6539\u53d8\u8c03\u7528\u65b9\u914d\u7f6e\u7684\u64cd\u4f5c\u4e86\uff0c\u53ea\u9700\u8981\u542f\u52a8\u4e00\u4e2a\u5e26\u6709\u91d1\u4e1d\u96c0 stage=canary \u6807\u7b7e\u7684 Pod\uff0c\u5c31\u53ef\u4ee5\u4ee5\u6700\u5c0f\u5316\u7684\u4ee3\u4ef7\u5b8c\u6210\u7070\u5ea6\u670d\u52a1\u4e86\u3002</p>"},{"location":"chap1/4chap1_router/#1-3","title":"1-3 \u8def\u7531\u4e2d\u95f4\u4ef6","text":"<p>\u4e3a\u4e86\u914d\u7f6e\u7684\u7075\u6d3b\u6027\uff0c\u4e00\u822c\u6211\u4eec\u4f1a\u628a\u5404\u79cd\u4e2d\u95f4\u4ef6\u653e\u5728\u8def\u7531\u5c42\uff0c\u8fd9\u6837\u5c31\u80fd\u6839\u636e path \u6216\u8005 header \u8def\u7531\u5339\u914d\u540e\u8fdb\u884c\u7075\u6d3b\u7684\u4e2d\u95f4\u4ef6\u914d\u7f6e\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u9700\u8981\u5bf9\u670d\u52a1 A \u7684 <code>\"/test\"</code> \u7684 path \u8fdb\u884c\u5355\u72ec\u7684\u9650\u6d41\u914d\u7f6e\uff0c\u5c31\u53ef\u4ee5\u5efa\u7acb\u4e00\u4e2a route \u7684match \u8bbe\u7f6e\u4e3a<code>path:/test</code>\uff0c\u8fd9\u6837\u5c31\u505a\u5230\u9488\u5bf9\u67d0\u4e00\u4e2a <code>path</code> \u8fdb\u884c\u9650\u6d41\uff0c\u800c\u8fd9\u4e2a\u914d\u7f6e\u4e0d\u4f1a\u5f71\u54cd\u5176\u4ed6\u7684\u8def\u7531\u89c4\u5219\u3002</p> <p>\u867d\u7136\u8fd9\u91cc\u53ea\u4e3e\u4f8b\u4e86\u9650\u6d41\uff0c\u4f46\u5176\u4ed6\u7684\u4e2d\u95f4\u4ef6\uff0c\u6bd4\u5982\u7194\u65ad\u3001\u6545\u969c\u6ce8\u5165\u3001\u65e5\u5fd7\uff0c\u90fd\u662f\u4e00\u6837\u7684\u9053\u7406\u3002</p>"},{"location":"chap1/4chap1_router/#1-4","title":"1-4 \u670d\u52a1\u91cd\u5199","text":"<p>Cluster \u7684\u914d\u7f6e\u653e\u5728\u4e86\u8def\u7531\u91cc\uff0c\u4e5f\u5c31\u662f\u6839\u636e\u4e0d\u540c\u7684\u8def\u7531\u53ef\u4ee5\u914d\u7f6e\u4e0d\u540c\u7684 Cluster\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u80fd\u6839\u636e\u4e0d\u540c\u7684 path \u5c06\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684 upstream \u670d\u52a1\u4e86\u3002</p>"},{"location":"chap1/4chap1_router/#1-5-rds","title":"1-5 RDS \u8def\u7531\u53d1\u73b0\u670d\u52a1","text":"<p>\u548c\u670d\u52a1\u8282\u70b9\u53d1\u73b0\u4e00\u6837\uff0c\u5f15\u5165\u8def\u7531\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u901a\u8fc7\u52a8\u6001\u53d1\u73b0\u8def\u7531\u7684\u53d8\u5316\uff0c\u505a\u5230\u52a8\u6001\u66f4\u65b0\u8c03\u7528\u7aef\u8def\u7531\u914d\u7f6e\uff0c\u4ee5\u8fbe\u5230\u8def\u7531\u4e2d\u95f4\u4ef6\u7b49\u914d\u7f6e\u66f4\u65b0\u7684\u529f\u80fd\u3002\u8fd9\u79cd\u505a\u6cd5\u4e5f\u8ba9\u8def\u7531\u8fd9\u4e2a\u529f\u80fd\u5728 Service Mesh \u67b6\u6784\u4e2d\u53d1\u6325\u66f4\u5927\u7684\u4ef7\u503c\u3002</p> <p> </p>"},{"location":"chap1/4chap1_router/#2","title":"2\u3001\u670d\u52a1\u6cbb\u7406\u4e4b\u9650\u6d41\u7194\u65ad","text":"<p>\u5fae\u670d\u52a1\u9700\u8981\u6cbb\u7406\u662f\u56e0\u4e3a\u5f71\u54cd\u4e86\u5fae\u670d\u52a1\u96c6\u7fa4\u7684\u7a33\u5b9a\u6027\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u624b\u6bb5\u8fdb\u884c\u5e72\u9884\uff0c\u6bd4\u5982\u9650\u6d41\u3001\u7194\u65ad\u3001\u964d\u7ea7\u7b49\uff0c\u786e\u4fdd\u5fae\u670d\u52a1\u96c6\u7fa4\u7684\u7a33\u5b9a\u6027\u3002</p>"},{"location":"chap1/4chap1_router/#2-1","title":"2-1 \u9650\u6d41","text":"<p>\u9650\u6d41\u662f\u6307\u5f53\u6d41\u91cf\u8d85\u51fa\u670d\u52a1\u8bbe\u8ba1\u4e4b\u521d\u7684\u627f\u8f7d\u91cf\u65f6\uff0c\u901a\u8fc7\u4e00\u5b9a\u7684\u7b97\u6cd5\uff0c\u5c06\u65e0\u6cd5\u5904\u7406\u7684\u6d41\u91cf\u4e22\u5f03\uff0c\u4ee5\u4fdd\u8bc1\u670d\u52a1\u7684\u7a33\u5b9a\u6027\u3002</p>"},{"location":"chap1/4chap1_router/#2-1-1","title":"2-1-1 \u5e38\u7528\u7684\u9650\u6d41\u7b97\u6cd5","text":"<p>\u8ba1\u6570\u5668 :</p> <p>\u8ba1\u6570\u5668\u662f\u6700\u5bb9\u6613\u5b9e\u73b0\u7684\u9650\u6d41\u7b97\u6cd5\uff0c\u5176\u5b9e\u5b83\u7684\u539f\u7406\u975e\u5e38\u7b80\u5355\uff1a\u8bb0\u5f55\u4e00\u5b9a\u65f6\u95f4\u5185\u7684\u8bf7\u6c42\u6570\u91cf\uff0c\u5c06\u8d85\u8fc7\u9608\u503c\u7684\u8bf7\u6c42\u62e6\u622a\u6389\u3002</p> <p>\u8fd9\u79cd\u7b97\u6cd5\u5bf9\u4e8e\u5fae\u670d\u52a1\u9650\u6d41\u8fd9\u4e2a\u573a\u666f\u6765\u8bf4\u5176\u5b9e\u4e5f\u591f\u7528\u4e86\uff0c\u4f46\u8ba1\u6570\u5668\u7b97\u6cd5\u6709\u4e2a\u5f88\u660e\u663e\u7684\u95ee\u9898\uff1a\u5728\u4e34\u754c\u533a\u95f4\u5bb9\u6613\u4fc3\u53d1\u9519\u8bef\u7684\u9650\u6d41\u5224\u5b9a\u3002</p> <p>\u5047\u5982\u8bbe\u5b9a\u8bf7\u6c42\u8bb0\u5f55\u65f6\u95f4\u4e3a 1s\uff0c\u9650\u6d41\u89e6\u53d1\u9608\u503c\u4e3a 100\uff0c\u5728\u4e0a\u4e00\u4e2a\u8bb0\u5f55\u533a\u95f4\u7684\u6700\u540e 100ms \u548c\u5f53\u524d\u8bb0\u5f55\u533a\u95f4\u7684\u524d 100ms \u90fd\u53d1\u751f\u4e86\u63a5\u8fd1\u9608\u503c\u7684\u8bf7\u6c42\u91cf 90\uff0c\u5f88\u660e\u663e\u8fd9\u6837\u5c31\u65e0\u6cd5\u89e6\u53d1\u9650\u6d41\u9608\u503c\uff0c\u4f46\u5374\u8d85\u8fc7\u4e86\u7cfb\u7edf\u7684\u6700\u5927\u8d1f\u8f7d\u3002</p>"},{"location":"chap1/4chap1_router/#2-1-2","title":"2-1-2 \u6ed1\u52a8\u7a97\u53e3","text":"<p>\u6ed1\u52a8\u7a97\u53e3\u5c31\u662f\u4e3a\u4e86\u89e3\u51b3\u7b80\u5355\u8ba1\u6570\u5668\u7684\u95ee\u9898\u3002</p> <p>\u5047\u5b9a\u8bbe\u7f6e 100ms \u4e3a\u4e00\u4e2a\u7a97\u53e3\uff0c\u90a3\u4e48 1s \u5185\u4f1a\u6709 10 \u4e2a\u7a97\u53e3\uff0c\u8fd9\u6837\u5373\u4fbf\u4e24\u4e2a\u4e34\u8fd1\u7684\u7a97\u53e3\u90fd\u53d1\u751f\u4e86\u63a5\u8fd1\u9608\u503c\u7684\u8bf7\u6c42\u91cf\uff0c\u4e5f\u80fd\u591f\u901a\u8fc7\u8ba1\u7b97\u524d 10 \u4e2a\u7a97\u53e3\u7684\u603b\u91cf\uff0c\u89e6\u53d1\u9650\u6d41\u9608\u503c\u3002</p> <p>\u6309\u7167\u8ba1\u6570\u5668\u4e2d\u7684\u60c5\u51b5\uff0c\u4e24\u4e2a\u4e34\u8fd1\u7a97\u53e3\u7684\u8bf7\u6c42\u91cf\u5171\u8ba1 180\uff0c\u663e\u7136\u4f1a\u89e6\u53d1\u9608\u503c\u3002</p> <p> </p>"},{"location":"chap1/4chap1_router/#2-1-3","title":"2-1-3 \u6f0f\u6876","text":"<p>\u6f0f\u6876\u662f\u4e00\u79cd\u975e\u5e38\u5e73\u6ed1\u7684\u9650\u6d41\u7b97\u6cd5\u3002</p> <p>\u5b83\u5728\u4e00\u5b9a\u65f6\u95f4\u5185\u5141\u8bb8\u901a\u8fc7\u6052\u5b9a\u6570\u91cf\u8bf7\u6c42\uff0c\u5982\u679c\u8fd9\u4e2a\u65f6\u95f4\u5185\u8bf7\u6c42\u6570\u91cf\u8d85\u8fc7\u8fd9\u4e2a\u91cf\uff0c\u5c31\u4f1a\u89e6\u53d1\u9650\u6d41\u3002\u4e3e\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u6bd4\u5982 1s \u5185\u8bbe\u7f6e\u5141\u8bb8 1000 \u4e2a\u8bf7\u6c42\u7684\u9608\u503c\uff0c\u90a3\u4e48\u6bcf 1ms \u5c31\u4f1a\u4ea7\u751f\u4e00\u4e2a\u5141\u8bb8\u901a\u8fc7\u7684\u8bf7\u6c42\u3002\u5982\u679c\u8d85\u8fc7\u8fd9\u4e2a\u503c\uff0c\u5c31\u4f1a\u88ab\u9650\u5236\u6389\u3002</p> <p>\u8fd9\u79cd\u7b97\u6cd5\u867d\u7136\u975e\u5e38\u5e73\u6ed1\uff0c\u4f46\u5374\u5e26\u6765\u4e86\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\uff1a\u9650\u6d41\u8fc7\u4e8e\u4e25\u683c\u3002</p> <p>\u867d\u7136\u6211\u4eec\u8bbe\u7f6e\u4e86\u6bcf\u79d2 1000 \u4e2a\u8bf7\u6c42\uff0c\u4f46\u5982\u679c\u8fd9 1s \u5185\u7684\u8bf7\u6c42\u4e0d\u5747\u5300\u4e5f\u4f1a\u89e6\u53d1\u9650\u6d41\u3002\u5b9e\u9645\u4e0a\uff0c\u8fd9\u79cd\u7b97\u6cd5\u5e76\u4e0d\u592a\u9002\u5408\u5fae\u670d\u52a1\u573a\u666f\uff0c\u5b83\u66f4\u9002\u5408\u9650\u5236\u6211\u4eec\u8bf7\u6c42\u5916\u90e8\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u60c5\u51b5\uff0c\u6bd4\u5982\u67d0\u4e2a\u7b2c\u4e09\u65b9\u63a8\u9001\u7684\u63a5\u53e3\u9650\u5236\u4e86\u6211\u4eec\u6bcf\u79d2\u7684\u8bf7\u6c42\u91cf\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u7528\u6f0f\u6876\u7b97\u6cd5\u53ef\u4ee5\u9650\u5236\u81ea\u8eab\u7684\u5bf9\u5916\u8bf7\u6c42\u91cf\u3002</p> <p> </p>"},{"location":"chap1/4chap1_router/#2-1-4","title":"2-1-4 \u4ee4\u724c\u6876","text":"<p>\u4ee4\u724c\u6876\uff08Token Bucket\uff09\u662f\u6f0f\u6876\u9650\u6d41\u7684\u4e00\u79cd\u4f18\u5316\u65b9\u6848\u3002\u5728\u5fae\u670d\u52a1\u573a\u666f\u4e2d\uff0c\u57fa\u672c\u4e0a\u90fd\u9009\u62e9\u4e86\u6b64\u79cd\u65b9\u6cd5\uff0c\u56e0\u4e3a\u8fd9\u79cd\u65b9\u5f0f\u9650\u6d41\u6bd4\u8f83\u5e73\u6ed1\uff0c\u4e5f\u4e0d\u4f1a\u4ea7\u751f\u6f0f\u6876\u9519\u6740\u8bf7\u6c42\u7684\u95ee\u9898\u3002\u4ee4\u724c\u6876\u5141\u8bb8\u4e00\u5b9a\u7684\u7a81\u53d1\u6d41\u91cf\uff0c\u6240\u4ee5\u975e\u5e38\u9002\u5408\u5fae\u670d\u52a1\u573a\u666f\u3002</p> <p>\u4ee4\u724c\u6876\u548c\u6f0f\u6876\u5728\u57fa\u672c\u5b9e\u73b0\u539f\u7406\u4e0a\u5dee\u4e0d\u591a\uff0c\u6700\u5927\u7684\u533a\u522b\u662f\u9650\u5236\u89d2\u5ea6\u4e0d\u540c\uff0c\u6f0f\u6876\u662f\u9650\u5236\u6d41\u51fa\u7684\u901f\u5ea6\uff0c\u800c\u4ee4\u724c\u6876\u662f\u9650\u5236\u4ee4\u724c\u6d41\u5165\u7684\u901f\u5ea6\u3002</p> <p>\u4ee4\u724c\u6876\u4f1a\u5355\u72ec\u7ef4\u62a4\u4e00\u4e2a\u4ee4\u724c\u7684\u5b58\u50a8\u6876\uff0c\u8fd9\u4e2a\u6876\u4f1a\u6301\u7eed\u653e\u5165\u4ee4\u724c\uff0c\u5e76\u4e14\u914d\u5408\u8bbe\u7f6e\u4e00\u4e2a burst \u7684\u53c2\u6570\uff0c\u4f5c\u4e3a\u4ee4\u724c\u7684\u5b58\u50a8\u4e0a\u9650\uff1b\u800c\u653e\u5165\u4ee4\u724c\u7684\u6bcf\u79d2\u901f\u5ea6\u4e3a\u6bcf\u79d2 limit \u4e2a\uff0c\u7528\u6237\u8bf7\u6c42\u4f1a\u6e90\u6e90\u4e0d\u65ad\u5730\u6d88\u8017\u6876\u4e2d\u7684\u4ee4\u724c\u3002\u5f53\u4ee4\u724c\u6876\u5185\u7684\u4ee4\u724c\u8017\u5149\uff0c\u5c31\u4f1a\u89e6\u53d1\u9650\u6d41</p> <p> </p> <ul> <li>limit\uff1a\u6bcf\u79d2\u5f80\u6876\u4e2d\u653e\u5165\u7684\u4ee4\u724c\u6570\u91cf\u3002\u56e0\u4e3a\u540d\u79f0\u7684\u539f\u56e0\uff0c\u8fd9\u4e2a\u503c\u5f88\u5bb9\u6613\u88ab\u7406\u89e3\u4e3a\u9650\u6d41\u503c\uff0c\u8fd9\u6837\u7684\u7406\u89e3\u5b9e\u9645\u4e0a\u662f\u9519\u8bef\u7684\uff0c\u4ee4\u724c\u6876\u7684\u9650\u6d41\u503c\u9700\u8981\u7ed3\u5408 burst \u4e00\u8d77\u786e\u5b9a\u3002</li> <li>burst\uff1a\u5b57\u9762\u4e0a\u770b\u662f\u7a81\u53d1\u7684\u610f\u601d\uff0c\u867d\u7136\u5b83\u80fd\u8d77\u5230\u7a81\u53d1\u7684\u4f5c\u7528\uff0c\u4f46\u5b9e\u9645\u610f\u601d\u662f\u4ee4\u724c\u6876\u7684\u5bb9\u91cf\u5927\u5c0f\u3002</li> </ul> <p>\u5728\u67d0\u4e2a\u65f6\u95f4\u7247\u5185\uff0c\u6d88\u8017\u7684\u901f\u5ea6\u5927\u4e8e\u4e86\u4ee4\u724c\u7684\u751f\u6210\u901f\u5ea6\uff0c\u53c8\u6ca1\u6709\u5b58\u91cf\uff0c\u5c31\u4f1a\u89e6\u53d1\u9650\u6d41\u4e86\u3002</p>"},{"location":"chap1/4chap1_router/#2-1-5","title":"2-1-5 \u5355\u673a\u9650\u6d41\u548c\u5168\u5c40\u9650\u6d41","text":"<p>\u5168\u5c40\u9650\u6d41\uff1a\u6307\u7684\u662f\u4e00\u7ec4\u5fae\u670d\u52a1\u96c6\u7fa4\uff0c\u901a\u8fc7\u5916\u90e8\u5b58\u50a8\u5bf9\u96c6\u7fa4\u6574\u4f53\u6d41\u91cf\u505a\u9650\u6d41\u3002</p> <p>\u8fd9\u79cd\u60c5\u51b5\u56e0\u4e3a\u9700\u8981\u4f9d\u8d56\u5916\u90e8\u5b58\u50a8\u6240\u4ee5\u6bd4\u8f83\u96be\u5b9e\u73b0\uff0c\u6bd5\u7adf\u548c\u5916\u90e8\u5b58\u50a8\u7684\u4ea4\u4e92\u9700\u8981\u589e\u52a0\u989d\u5916\u5ef6\u65f6\u3002\u5168\u5c40\u9650\u6d41\u6bd4\u8f83\u9002\u5408\u540e\u7aef DB \u6709\u541e\u5410\u91cf\u9650\u5236\u7684\u60c5\u51b5\uff0c\u6709\u4e9b\u573a\u666f\u9700\u8981\u6269\u5bb9 Web \u673a\u5668\uff0c\u8fd9\u4e2a\u65f6\u5019\u8bf7\u6c42\u91cf\u53ef\u80fd\u4f1a\u589e\u52a0\uff0c\u4f1a\u9020\u6210\u5bf9 DB \u8bf7\u6c42\u91cf\u7684\u589e\u52a0\uff0c\u6240\u4ee5\u9700\u8981\u8bbe\u7f6e\u4e00\u4e2a\u5168\u5c40\u9650\u6d41\u503c\u9632\u6b62\u5bf9 DB \u7684\u51b2\u51fb\u3002</p> <p>\u5355\u673a\u9650\u6d41\uff1a\u6307\u7684\u662f\u4e00\u7ec4\u5fae\u670d\u52a1\u96c6\u7fa4\uff0c\u901a\u8fc7\u5bf9\u5355\u4e2a\u673a\u5668\u7684\u9650\u6d41\uff0c\u8fbe\u5230\u670d\u52a1\u6574\u4f53\u9650\u6d41\u7684\u76ee\u7684\u3002</p> <p>\u5728\u5fae\u670d\u52a1\u573a\u666f\u4e2d\uff0c\u56e0\u4e3a\u5168\u5c40\u9650\u6d41\u6bd4\u8f83\u96be\u505a\u5230\uff0c\u6240\u4ee5\u5355\u673a\u9650\u6d41\u5e94\u7528\u5f97\u6bd4\u8f83\u591a\u3002\u5355\u673a\u9650\u6d41\u53ef\u4ee5\u9002\u5e94\u5927\u90e8\u5206\u573a\u666f\uff0c\u6bd5\u7adf\u5728\u5206\u5e03\u5f0f\u573a\u666f\u4e2d\uff0c\u5355\u4e00\u673a\u5668\u8d1f\u8f7d\u63a7\u5236\u4f4f\uff0c\u5927\u591a\u6570\u573a\u666f\u4e5f\u5c31\u80fd\u63a7\u5236\u4f4f\u6574\u4e2a\u96c6\u7fa4\u7684\u8d1f\u8f7d\u3002</p> <p>\u8fd9\u79cd\u9650\u6d41\u4e5f\u4e0d\u5f71\u54cd\u6269\u7f29\u5bb9\uff0cWeb \u673a\u5668\u56e0\u4e3a\u8d1f\u8f7d\u4e0d\u8db3\u53ef\u4ee5\u968f\u65f6\u6a2a\u5411\u6269\u5bb9\uff0c\u6b64\u65f6\u5355\u673a\u9650\u6d41\u503c\u4e0d\u9700\u8981\u6539\u52a8\uff1b</p> <p>\u800c\u5728\u5168\u5c40\u9650\u6d41\u4e2d\uff0c\u5f53 Web \u673a\u5668\u6269\u5bb9\u65f6\uff0c\u4e5f\u9700\u8981\u9650\u6d41\u503c\u968f\u4e4b\u6539\u52a8\uff0c\u4e3a\u6269\u7f29\u5bb9\u5e26\u6765\u4e86\u4e0d\u4fbf\u3002</p>"},{"location":"chap1/4chap1_router/#2-2","title":"2-2 \u7194\u65ad","text":"<p>\u7194\u65ad\u4e5f\u53eb\u65ad\u8def\u5668\uff0c\u65ad\u8def\u5668\u662f\u4e00\u79cd\u5f00\u5173\u6a21\u5f0f\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u53c2\u8003\u7535\u8def\u7cfb\u7edf\u4e2d\u7684\u8fc7\u8f7d\u4fdd\u62a4\u673a\u5236\u3002\u5f53\u7ebf\u8def\u53d1\u751f\u77ed\u8def\u6216\u8005\u8fc7\u8f7d\u65f6\uff0c\u65ad\u8def\u5668\u80fd\u591f\u53ca\u65f6\u5207\u65ad\u7535\u8def\uff0c\u9632\u6b62\u53d1\u751f\u8fc7\u70ed\u3001\u8d77\u706b\u7b49\u6545\u969c</p> <p>\u7194\u65ad\u7ec4\u4ef6\u6709\u4e09\u79cd\u72b6\u6001</p> <ul> <li>Closed\uff08\u5173\u95ed\uff09\uff1a\u9ed8\u8ba4\u521d\u59cb\u72b6\u6001\u4e3a\u5173\u95ed\u3002</li> <li>Open\uff08\u5f00\u542f\uff09\uff1a\u5047\u5b9a\u6211\u4eec\u8bbe\u7f6e 10s \u7684\u6ed1\u52a8\u7a97\u53e3\uff0c\u5f53 10s \u5185\u7684\u9519\u8bef\u6bd4\u4f8b\u8fbe\u5230\u6211\u4eec\u8bbe\u5b9a\u9608\u503c\u7684 90% \uff0c\u6b64\u65f6\u72b6\u6001\u4f1a\u4ece Closed \u6539\u53d8\u4e3a Open\u3002</li> <li>HalfOpen\uff08\u534a\u5f00\uff09\uff1a\u518d\u7ecf\u8fc7\u4e00\u4e2a 10s \u7684\u7a97\u53e3\u671f\uff0c\u6b64\u65f6\u7194\u65ad\u5668\u4f1a\u81ea\u52a8\u4ece Open \u8f6c\u79fb\u5230 HalfOpen \u72b6\u6001\u3002\u5728\u8fd9\u4e2a\u72b6\u6001\u4e0b\uff0c\u6211\u4eec\u4f1a\u6309\u7167\u7ebf\u6027\u7684\u65b9\u5f0f\u6765\u653e\u884c\u6d41\u91cf\uff0c\u516c\u5f0f\u5982\u4e0b\uff1a<code>0.5 * (Now() - Start())/Duration</code></li> </ul> <p>\u76f4\u5230 10s \u7684\u6ed1\u52a8\u7a97\u53e3\u5185\u63a5\u53e3\u6210\u529f\u7387\u91cd\u65b0\u6062\u590d\u5230 90% \u624d\u4f1a\u8f6c\u79fb\u5230 Closed \u72b6\u6001\uff0c\u53cd\u4e4b\u7ee7\u7eed\u53d8\u66f4\u4e3a Open \u72b6\u6001\u3002</p> <p>\u7194\u65ad\u7684\u539f\u7406\u548c\u5b9e\u73b0\u90fd\u6bd4\u8f83\u7b80\u5355\uff0c\u4f46\u6ce8\u610f\u4ee5\u4e0b\u53c2\u6570\u8981\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8bbe\u7f6e\u3002</p> <p> </p> <ul> <li>\u6ed1\u52a8\u7a97\u53e3\u65f6\u95f4\uff1a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u6211\u4e00\u822c\u8bbe\u7f6e\u4e3a 10s\uff0c\u6ce8\u610f\u8fd9\u4e2a\u503c\u4e0d\u80fd\u592a\u957f\uff0c\u5426\u5219\u7194\u65ad\u7684\u6062\u590d\u65f6\u95f4\u4e5f\u4f1a\u968f\u4e4b\u53d8\u957f\u3002</li> <li>\u89e6\u53d1\u6761\u4ef6\uff1a\u5047\u5982\u662f HTTP \u670d\u52a1\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e0b\uff0c\u8fd9\u4e2a\u503c\u6211\u8bbe\u7f6e\u4e3a <code>499-600</code> \u4e4b\u95f4\u7684\u9519\u8bef\u7801\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a 499 \u9519\u8bef\u7801\u548c 5xx \u7684\u9519\u8bef\u7801\uff08499 \u9519\u8bef\u7801\u4ee3\u8868\u5ba2\u6237\u7aef\u4e3b\u52a8\u65ad\u5f00\uff0c\u4e00\u822c\u662f\u8d85\u65f6\u5f15\u8d77\u7684\uff0c\u800c 5xx \u9519\u8bef\u7801\u5728 HTTP \u4e2d\u662f\u670d\u52a1\u7aef\u9519\u8bef\uff09\u3002</li> </ul> <p>\u5982\u679c\u662f\u975e HTTP \u670d\u52a1\uff0c\u5728 Service Mesh \u4f53\u7cfb\u4e0b\uff0c\u6211\u4f1a\u628a gRPC \u6216\u8005 Dubbo \u7684\u9519\u8bef\u7801\u8f6c\u6210\u5bf9\u5e94\u7684 HTTP \u9519\u8bef\u7801\u8fdb\u884c\u7edf\u4e00\u7684\u5904\u7406\u3002\u5177\u4f53\u7684\u8f6c\u6362\u89c4\u5219\uff0c\u5c31\u9700\u8981\u4f60\u6839\u636e\u81ea\u5df1\u7684\u7406\u89e3\u8fdb\u884c\u8bbe\u7f6e\u4e86\u3002</p> <p>\u6ce8\u610f\u4e00\u822c Service Mesh \u4e2d\u7684\u7194\u65ad\u4e0d\u4f1a\u7edf\u8ba1\u4e1a\u52a1\u7684\u9519\u8bef\u7801\u505a\u7194\u65ad\u5904\u7406\uff0c\u53ea\u7edf\u8ba1\u7cfb\u7edf\u5c42\u9762\u7684\u9519\u8bef\u3002</p> <p> </p>"},{"location":"chap1/5chap1_conn_pool/","title":"\u7b2c\u4e94\u8282 \u8fde\u63a5\u6c60\uff1a\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u5f02","text":"<p>\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u522b\uff0cHTTP \u8fde\u63a5\u6c60\u548c HTTP/2 \u8fde\u63a5\u6c60\u7684\u5dee\u522b\u3002\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u534f\u8bae\u6b63\u597d\u7b26\u5408\u8fd9\u91cc\u7684\u4e24\u4e2a\u7279\u6027\uff1aHTTP \u8fde\u63a5\u662f\u963b\u585e\u7684\u3001\u65e0\u6cd5\u590d\u7528\u7684\uff0cHTTP/2 \u7684\u8fde\u63a5\u662f\u975e\u963b\u585e\u7684\u3001\u591a\u8def\u590d\u7528\u7684\u3002</p>"},{"location":"chap1/5chap1_conn_pool/#1-connection","title":"1\u3001\u8fde\u63a5 Connection","text":"<p>TCP \u8fde\u63a5\u7684\u82f1\u8bed\u662f Transmission Control Protocol Connection\u3002</p> <p>\u5728\u8ba1\u7b97\u673a\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u63d0\u5230\u6709\u72b6\u6001\u548c\u65e0\u72b6\u6001\uff1b</p> <p>\u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u6211\u4eec\u4e5f\u7ecf\u5e38\u4f1a\u63d0\u5230\u6709\u72b6\u6001\u670d\u52a1\u548c\u65e0\u72b6\u6001\u670d\u52a1\u3002</p>"},{"location":"chap1/5chap1_conn_pool/#1-1","title":"1-1 \u65e0\u72b6\u6001\u670d\u52a1","text":"<p>\u5176\u5b9e\u662f\u6307\u670d\u52a1\u5185\u5b58\u6216\u8005\u672c\u5730\u4e0d\u4fdd\u5b58\u4efb\u4f55\u8282\u70b9\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u505a\u5230\u670d\u52a1\u6269\u7f29\u5bb9\u3001\u8fc1\u79fb\u7684\u673a\u5668\u65e0\u5173\u6027</p>"},{"location":"chap1/5chap1_conn_pool/#1-2","title":"1-2 \u6709\u72b6\u6001\u670d\u52a1","text":"<p>\u670d\u52a1\u6240\u5728\u7684\u673a\u5668\u4e0a\u5b58\u6709\u8282\u70b9\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\u548c\u67d0\u4e2a\u5ba2\u6237\u7aef\u5efa\u7acb\u4e86 session \u8fde\u63a5\u3002\u5728\u8d1f\u8f7d\u5747\u8861\u6a21\u5757\u6211\u4eec\u63d0\u5230\u4e86\u4e00\u79cd\u4f1a\u8bdd\u4fdd\u6301\uff08Sticky Sessions\uff09\u7684\u6280\u672f\uff0c\u8fd9\u79cd\u5c31\u5c5e\u4e8e\u6709\u72b6\u6001\u7684\u670d\u52a1\u3002</p> <p>HTTP \u670d\u52a1\u662f\u65e0\u72b6\u6001\u7684\uff0c\u56e0\u4e3a\u5927\u591a\u6570\u60c5\u51b5 HTTP \u662f\u77ed\u8fde\u63a5\u7684\u3002\u76f8\u5bf9\u800c\u8a00\u5728\u4e00\u4e9b\u9700\u8981\u957f\u8fde\u63a5\u7684\u573a\u666f\uff0c\u56e0\u4e3a\u8fde\u63a5\u672c\u8eab\u7684\u6709\u72b6\u6001\u7684\u7279\u6027\uff0c\u7ecf\u5e38\u4f1a\u5728\u8fde\u63a5\u4e0a\u5b58\u50a8\u4e00\u4e9b\u8fde\u63a5\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u8fd9\u6837\u670d\u52a1\u4e5f\u6210\u4e86\u6709\u72b6\u6001\u670d\u52a1\u3002</p> <p>TCP \u8fde\u63a5\u5b9a\u4e49</p> <p>The reliability and flow control mechanisms described above require that TCPs initialize and maintain certain status information for each data stream. The combination of this information, including sockets, sequence numbers, and window sizes, is called a connection.</p>"},{"location":"chap1/5chap1_conn_pool/#2http","title":"2\u3001HTTP","text":""},{"location":"chap1/5chap1_conn_pool/#2-1","title":"2-1 \u77ed\u8fde\u63a5\u548c\u957f\u8fde\u63a5","text":"<p>\u5b9e\u9645\u4e0a\u8fde\u63a5\u5e76\u6ca1\u6709\u957f\u77ed\u4e4b\u5206\uff0c\u53ea\u662f\u53d6\u51b3\u4e8e\u4f20\u8f93\u5b8c\u6570\u636e\u540e\u662f\u5426\u65ad\u5f00\uff0c\u6bd5\u7adf HTTP \u534f\u8bae\u4e5f\u662f\u57fa\u4e8e TCP \u534f\u8bae\u5b9e\u73b0\u7684</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u957f\u77ed\u8fde\u63a5\u7684\u53eb\u6cd5\u5462\uff1f</p> <p>\u8fd9\u662f\u56e0\u4e3a HTTP \u534f\u8bae\u591a\u7528\u4e8e Web \u4e2d\uff0cWeb \u7684\u4ea4\u4e92\u65b9\u5f0f\u591a\u662f\u4e00\u6765\u4e00\u56de\u7684\u6a21\u5f0f\uff0c\u8fd9\u6837\u7684\u5e94\u7528\u573a\u666f\u4e0b\uff0c\u4e0d\u9700\u8981\u670d\u52a1\u7aef\u63a8\u6570\u636e\uff0c\u6240\u4ee5\u5efa\u7acb\u8fde\u63a5\u540e\u7acb\u5373\u91ca\u653e\u4e5f\u662f\u5b8c\u5168\u53ef\u4ee5\u7684\u3002</p> <p>\u5b9e\u9645\u4e0a\u968f\u7740\u4e92\u8054\u7f51\u7684\u53d1\u5c55\uff0c\u8bf7\u6c42\u91cf\u8d8a\u6765\u8d8a\u5927\uff0c\u4ee5\u5f80\u7684\u77ed\u8fde\u63a5\u6a21\u5f0f\u9891\u7e41\u7684\u5efa\u7acb\u2014\u91ca\u653e\u8fde\u63a5\uff0c\u9020\u6210\u670d\u52a1\u5668\u8d44\u6e90\u4ea7\u751f\u4e0d\u5fc5\u8981\u7684\u6d88\u8017\uff0c</p> <ul> <li>\u4f46\u73b0\u5728 HTTP \u534f\u8bae\u5f80\u5f80\u4f1a\u5229\u7528 <code>Connection: Keep-alive</code>\u8ba9\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4fdd\u6301\u957f\u8fde\u63a5\uff0c\u4f7f\u8fde\u63a5\u53ef\u4ee5\u91cd\u7528\uff1b</li> <li>\u5f53\u9700\u8981\u4e3b\u52a8\u65ad\u5f00\u8fde\u63a5\u7684\u65f6\u5019\uff0c\u53d1\u9001 <code>Connection: close</code> \u5c31\u53ef\u4ee5\u4e86\u3002</li> </ul>"},{"location":"chap1/5chap1_conn_pool/#3","title":"3\u3001\u8fde\u63a5\u6c60\u7684\u5b9e\u73b0","text":"<p>\u8fde\u63a5\u6c60\u5c31\u662f\u5c06\u5e94\u7528\u6240\u9700\u7684\u8fde\u63a5\u5bf9\u8c61\u653e\u5728\u6c60\u4e2d\uff0c\u6bcf\u6b21\u8bbf\u95ee\u65f6\u4ece\u6c60\u4e2d\u83b7\u53d6\uff0c\u4f7f\u7528\u5b8c\u6bd5\u518d\u653e\u56de\u6c60\u4e2d\uff0c\u4ee5\u8fbe\u5230\u8fde\u63a5\u590d\u7528\u7684\u76ee\u7684\uff0c\u51cf\u5c11\u521b\u5efa\u3001\u9500\u6bc1\u8fde\u63a5\u8fc7\u7a0b\u4e2d\u4e0d\u5fc5\u8981\u6d88\u8017\u7684\u8d44\u6e90\u3002</p> <p>HTTP \u662f\u4e00\u79cd\u963b\u585e\u5f0f\u534f\u8bae\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f ping-pong \u8fd9\u79cd\u4e00\u6765\u4e00\u56de\u7684\u6a21\u5f0f\uff0c\u5047\u8bbe\u4e00\u4e2a ping \u8bf7\u6c42\u4ece\u5ba2\u6237\u7aef\u53d1\u5230\u670d\u52a1\u5668\u7aef\uff0c\u90a3\u4e48\u8fd9\u6761\u8fde\u63a5\u4e00\u5b9a\u8981\u7b49\u5230\u670d\u52a1\u7aef\u8fd4\u56de\u4e86 pong \u4fe1\u606f\uff0c\u624d\u80fd\u7ee7\u7eed\u53d1\u9001\u4e0b\u4e00\u6761 ping \u4fe1\u606f\u3002</p> <p>HTTP \u65e0\u6cd5\u590d\u7528\u8fde\u63a5\uff0c\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u8bf7\u6c42\u6bd4\u8f83\u591a\uff0c\u4f1a\u9020\u6210\u8bf7\u6c42\u7684\u963b\u585e\uff0c\u6240\u4ee5HTTP \u9700\u8981\u8fde\u63a5\u6c60\u8fd9\u6837\u7684\u6570\u636e\u7ed3\u6784\u505a\u5e76\u884c\u8bf7\u6c42\u3002</p> <ul> <li>\u7b80\u5355\u6765\u8bf4\uff0c\u6211\u4eec\u53ea\u8981\u5efa\u7acb\u591a\u6761\u8fde\u63a5\uff0c\u7528\u4e00\u4e2a\u6570\u7ec4\u7ef4\u62a4\u591a\u6761\u8fde\u63a5\u5c31\u884c\u4e86\uff1b</li> <li>\u5982\u679c\u4f7f\u7528\u4e00\u6761\u8fde\u63a5\uff0c\u90a3\u4e48\u4ece\u6570\u7ec4\u91cc\u62ff\u51fa\u8fd9\u6761\u8fde\u63a5\uff0c\u4f7f\u7528\u5b8c\u518d\u653e\u5165\u6570\u7ec4\u5373\u53ef\u3002</li> <li>\u5f53\u6570\u7ec4\u4e3a\u7a7a\u65f6\uff0c\u53ea\u8981\u5efa\u7acb\u65b0\u7684\u8fde\u63a5\u5c31\u53ef\u4ee5\u4e86\u3002</li> </ul> <p> </p> <p>\u5177\u4f53\u7684\u5b9e\u73b0\u4f60\u53ef\u4ee5\u53c2\u8003 go-micro \u7684\u901a\u7528\u8fde\u63a5\u6c60\u8bbe\u8ba1\uff1a</p> <pre><code>package pool\nimport (\n    \"sync\"\n    \"time\"\n    \"github.com/google/uuid\"\n    \"github.com/micro/go-micro/v2/transport\"\n)\ntype pool struct {\n    size int // \u8fde\u63a5\u6c60\u5927\u5c0f\uff0c\u5f88\u591a\u7c7b\u5e93\u4e5f\u53eb\u4f5c maxIdleConns\uff0c\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\n    // \u591a\u4e45\u540e\u8fde\u63a5\u4f1a\u65ad\u5f00\uff0c\u5f88\u591a\u8fde\u63a5\u6c60\u4f1a\u5728\u4e00\u5b9a\u65f6\u95f4\u540e\u65ad\u5f00\u8fde\u63a5\uff0c\u7136\u540e\u5c06\u65b0\u9c9c\u7684\u8fde\u63a5\u653e\u5165\u8fde\u63a5\u6c60\n    // \u6bd4\u5982 HTTP \u4e2d\u56e0\u4e3a\u670d\u52a1\u5668\u7aef\u56e0\u4e3a keepalive \u8fc7\u671f\uff0c\u4f1a\u4e3b\u52a8\u65ad\u5f00\u8fde\u63a5\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u8bbe\u7f6e\u4e00\u4e2a\u6bd4 keepalive \u65f6\u95f4\u77ed\u7684 TTL\n    // \u786e\u4fdd\u8fde\u63a5\u5148\u88ab\u79fb\u51fa\uff0c\u5c31\u4e0d\u4f1a\u62ff\u5230\u5df2\u65ad\u5f00\u7684\u8fde\u63a5\u4e86\n    ttl  time.Duration\n    // go-micro \u8fde\u63a5\u5c42\u62bd\u8c61\u7c7b\uff0c\u5f53\u4f5c\u8fde\u63a5\u5bf9\u8c61\u7c7b\u5373\u53ef\n    tr   transport.Transport\n    sync.Mutex // \u4e92\u65a5\u9501\n    conns map[string][]*poolConn // \u5b58\u50a8\u8fde\u63a5\u5bf9\u8c61\u7684\u6570\u7ec4\n}\ntype poolConn struct {\n    transport.Client // go-micro \u62bd\u8c61\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u5c42\u5bf9\u8c61\n    id      string // \u552f\u4e00 ID\n    created time.Time // \u8fde\u63a5\u521b\u5efa\u65f6\u95f4\n}\n// \u521b\u5efa\u8fde\u63a5\u6c60\u5bf9\u8c61\nfunc newPool(options Options) *pool {\n    return &amp;pool{\n        size:  options.Size,\n        tr:    options.Transport,\n        ttl:   options.TTL,\n        conns: make(map[string][]*poolConn),\n    }\n}\n// \u5173\u95ed\u8fde\u63a5\u6c60\uff0c\u91ca\u653e\u6240\u6709\u8fde\u63a5\nfunc (p *pool) Close() error {\n    p.Lock()\n    for k, c := range p.conns {\n        for _, conn := range c {\n            conn.Client.Close()\n        }\n        delete(p.conns, k)\n    }\n    p.Unlock()\n    return nil\n}\n// \u83b7\u53d6\u4e00\u4e2a\u8fde\u63a5\u5bf9\u8c61\nfunc (p *pool) Get(addr string, opts ...transport.DialOption) (Conn, error) {\n    p.Lock()\n    conns := p.conns[addr] //\u6839\u636e\u5730\u5740\u83b7\u53d6\u8fde\u63a5\u6c60\u6570\u7ec4\n    // \u5faa\u73af\u76f4\u5230\u62ff\u5230\u4e00\u4e2a\u53ef\u7528\u7684\u8fde\u63a5\n    // \u5426\u5219\u521b\u5efa\u4e00\u4e2a\u65b0\u8fde\u63a5\u8fd4\u56de\n    for len(conns) &gt; 0 {\n        // \u83b7\u53d6\u4e00\u4e2a\u8fde\u63a5\n        conn := conns[len(conns)-1]\n        conns = conns[:len(conns)-1]\n        p.conns[addr] = conns\n        // \u5982\u679c\u8d85\u65f6\u5219\u4e3b\u52a8\u5173\u95ed\u8fde\u63a5\n        if d := time.Since(conn.Created()); d &gt; p.ttl {\n            conn.Client.Close()\n            continue\n        }\n        // \u83b7\u5f97\u4e86\u53ef\u7528\u7684\u8fde\u63a5\uff0c\u8fd4\u56de\u65b0\u8fde\u63a5\n        p.Unlock()\n        return conn, nil\n    }\n    p.Unlock()\n    // \u521b\u5efa\u65b0\u8fde\u63a5\n    c, err := p.tr.Dial(addr, opts...)\n    if err != nil {\n        return nil, err\n    }\n    return &amp;poolConn{\n        Client:  c,\n        id:      uuid.New().String(),\n        created: time.Now(),\n    }, nil\n}\n// \u4f7f\u7528\u5b8c\u5c06\u8fde\u63a5\u653e\u56de\u8fde\u63a5\u6c60\nfunc (p *pool) Release(conn Conn, err error) error {\n    // \u5982\u679c\u4e0a\u5c42\u53d1\u751f\u9519\u8bef\uff0c\u5219\u4e0d\u653e\u56de\u8fde\u63a5\u6c60\n    if err != nil {\n        return conn.(*poolConn).Client.Close()\n    }\n    // \u653e\u5165\u6ca1\u6709\u9519\u8bef\u7684\u8fde\u63a5\n    p.Lock()\n    conns := p.conns[conn.Remote()]\n    if len(conns) &gt;= p.size {\n        p.Unlock()\n        return conn.(*poolConn).Client.Close()\n    }\n    p.conns[conn.Remote()] = append(conns, conn.(*poolConn))\n    p.Unlock()\n    return nil\n}\n</code></pre> <p>\u5b9e\u9645\u4e0a\u50cf DB \u5c42\u7684\u534f\u8bae\uff0c\u6bd4\u5982 Redis\u3001MySQL \u4e5f\u7c7b\u4f3c HTTP \u7684\u4e00\u6765\u4e00\u56de\u7684\u534f\u8bae\uff0c\u6240\u4ee5\u8fd9\u5957\u8fde\u63a5\u6c60\u7684\u8bbe\u8ba1\u4e5f\u53ef\u4ee5\u5e94\u7528\u5728 Redis \u548c MySQL \u4e0a\u9762\uff0c\u53ef\u4ee5\u8bf4\u5e94\u7528\u975e\u5e38\u5e7f\u6cdb\u3002</p>"},{"location":"chap1/5chap1_conn_pool/#maxidleconns","title":"MaxIdleConns \u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570","text":"<p>\u8fd9\u4e2a\u503c\u7ecf\u5e38\u4f1a\u548c MaxConns \u641e\u6df7\uff0c\u4f46\u4f60\u8981\u6ce8\u610f\u8fd9\u4e2a\u503c\u4e0d\u662f\u6700\u5927\u8fde\u63a5\u6570\uff0c\u800c\u662f\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\uff0c\u7ed3\u5408\u6211\u4eec\u4e0a\u9762\u8bb2\u7684\u8fde\u63a5\u6c60\u5b9e\u73b0\u539f\u7406\uff0c\u8fd9\u4e2a\u503c\u53ef\u4ee5\u7406\u89e3\u4e3a\u8fde\u63a5\u6c60\u7684\u5927\u5c0f\u3002</p> <p>\u8fd9\u4e2a\u503c\u7684\u8bbe\u7f6e\u5f88\u6709\u8bb2\u7a76\uff0c\u9700\u8981\u7ed3\u5408\u540e\u7aef\u670d\u52a1\u7684\u8fde\u63a5\u627f\u8f7d\u80fd\u529b\u8bbe\u7f6e\u3002\u5982\u679c\u8bbe\u7f6e\u5f97\u592a\u5927\uff0c\u5047\u5982\u8bbe\u7f6e 1000\uff0c\u59cb\u53d1\u96c6\u7fa4\u6709 100 \u53f0\u673a\u5668\uff0c\u90a3\u4e48\u5c31\u4f1a\u5efa\u7acb 10w \u7684\u6301\u4e45\u8fde\u63a5\uff0c\u8fd9\u5bf9\u540e\u7aef\u670d\u52a1\u7684\u538b\u529b\u53ef\u60f3\u800c\u77e5\u3002\u4f46\u4e5f\u4e0d\u80fd\u8bbe\u7f6e\u5f97\u592a\u5c0f\uff0c\u4e3e\u4e2a\u6781\u7aef\u7684\u4f8b\u5b50\uff0c\u5047\u5982\u8bbe\u7f6e 1\uff0c\u5f53\u5e76\u53d1\u6570\u91cf\u4e0a\u53bb\u65f6\uff0c\u4f1a\u51fa\u73b0\u4e24\u79cd\u60c5\u51b5\uff1a</p> <ul> <li>\u5982\u679c\u8fde\u63a5\u6c60\u6ee1\u4e86\uff0c\u5c31\u4f1a\u5efa\u7acb\u65b0\u7684\u8fde\u63a5\uff0c\u4e0d\u65ad\u5efa\u7acb\u7684\u65b0\u8fde\u63a5\u4f1a\u8017\u5149\u540e\u7aef\u670d\u52a1\u7684\u8d44\u6e90\uff1b</li> <li>\u65b0\u5efa\u7acb\u7684\u8fde\u63a5\u5728\u7528\u5b8c\u4e4b\u540e\uff0c\u6709\u4e24\u79cd\u9009\u62e9\u2014\u2014\u8fde\u63a5\u6c60\u6709\u4f59\u91cf\u7684\u60c5\u51b5\u4f1a\u653e\u5165\u8fde\u63a5\u6c60\uff0c\u53cd\u4e4b\u4f1a\u76f4\u63a5\u4e22\u5f03\uff0c\u8fd9\u79cd\u60c5\u51b5\u5728\u77ac\u95f4\u5f88\u5bb9\u6613\u51fa\u73b0\uff0c\u8fde\u63a5\u6c60\u6301\u7eed\u77ac\u95f4\u88ab\u7a7a\u95f2\u8fde\u63a5\u5360\u6ee1\uff08\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\u7684\u53eb\u6cd5\u4e5f\u7531\u6b64\u5f97\u6765\uff09\uff0c\u5bfc\u81f4\u65b0\u8fde\u63a5\u65e0\u6cd5\u653e\u56de\u8fde\u63a5\u6c60\uff0c\u8fdb\u800c\u4e22\u5f03\uff0c\u8fd9\u6837\u5c31\u4f1a\u5f62\u6210\u5efa\u7acb\u8fde\u63a5\u2014\u7528\u5b8c\u4e22\u5f03\u7684\u6076\u6027\u5faa\u73af\uff0c\u8fde\u63a5\u6c60\u7684\u4f5c\u7528\u4e5f\u5c31\u6d88\u5931\u4e86\uff0c\u9000\u5316\u6210\u4e86\u77ed\u8fde\u63a5\u3002</li> </ul> <p>\u7ecf\u9a8c\u503c\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u8fde\u63a5\u6c60\u5bb9\u91cf\u8bbe\u7f6e\u5728 10-100 \u7684\u533a\u95f4\u5185\u662f\u6bd4\u8f83\u5408\u7406\u7684\u3002</p>"},{"location":"chap1/5chap1_conn_pool/#4http2","title":"4\u3001HTTP/2","text":"<p>HTTP/2 \u8bbe\u8ba1\u7684\u6700\u5927\u76ee\u7684\u5c31\u662f\u89e3\u51b3 HTTP \u8fde\u63a5\u963b\u585e\u7684\u95ee\u9898\u3002\u5f53\u7136\u4e5f\u6709\u5f88\u591a\u5176\u4ed6\u5185\u5bb9\u7684\u4f18\u5316\uff0c\u6bd4\u5982 header \u5934\u90e8\u538b\u7f29\u3001\u57fa\u4e8e\u4e8c\u8fdb\u5236\u7684\u4f20\u8f93\u534f\u8bae\u7b49\u3002\u4f46\u6211\u4eec\u8fd8\u662f\u628a\u5173\u6ce8\u70b9\u96c6\u4e2d\u5230\u8fde\u63a5\u5c42\u9762\u3002</p>"},{"location":"chap1/5chap1_conn_pool/#4-1","title":"4-1 \u5176\u4ed6\u5185\u5bb9\u7684\u4f18\u5316","text":"<p>\u6bd4\u5982 header \u5934\u90e8\u538b\u7f29\u3001\u57fa\u4e8e\u4e8c\u8fdb\u5236\u7684\u4f20\u8f93\u534f\u8bae\u7b49\u3002\u4f46\u6211\u4eec\u8fd8\u662f\u628a\u5173\u6ce8\u70b9\u96c6\u4e2d\u5230\u8fde\u63a5\u5c42\u9762\u3002</p>"},{"location":"chap1/5chap1_conn_pool/#4-2-multiplexing","title":"4-2 \u591a\u8def\u590d\u7528\uff08Multiplexing\uff09","text":"<p>HTTP/2 \u4e2d\u7684\u591a\u8def\u590d\u7528\uff0c\u6307\u7684\u662f\u5728\u4e00\u6761\u8fde\u63a5\u4e2d\u53ef\u4ee5\u540c\u65f6\u5904\u7406\u591a\u4e2a\u8bf7\u6c42\uff0c\u8fd9\u6b63\u662f\u89e3\u51b3\u4e86 HTTP \u4e2d\u4e00\u4e2a\u8fde\u63a5\u540c\u65f6\u53ea\u80fd\u5904\u7406\u4e00\u4e2a\u8bf7\u6c42\u7684\u95ee\u9898\u3002\u8fd9\u548c Linux IO \u591a\u8def\u590d\u7528\u662f\u4e0d\u662f\u4e5f\u6709\u4e9b\u7c7b\u4f3c\uff1f\u4e4b\u6240\u4ee5\u90fd\u53eb\u591a\u8def\u590d\u7528\uff0c\u5c31\u662f\u56e0\u4e3a\u5b83\u4eec\u57fa\u672c\u4e0a\u90fd\u590d\u7528\u4e86\u67d0\u4e2a\u901a\u9053\uff0c\u6bd4\u5982HTTP/2 \u590d\u7528\u4e86\u8fde\u63a5\uff0cLinux IO \u590d\u7528\u4e86\u8fdb\u7a0b\u3002</p> <p>HTTP/2 \u62bd\u8c61\u51fa\u4e86\u4e00\u79cd\u6d41\uff08stream\uff09\u7684\u6982\u5ff5\uff0c\u5ba2\u6237\u7aef\u5728\u5df2\u7ecf\u5efa\u7acb\u7684\u8fde\u63a5\u4e0a\u53d1\u9001\u6d41\uff0c\u800c\u4e0d\u662f\u50cf HTTP 1.0 \u4e00\u6837\u76f4\u63a5\u53d1\u9001\u6570\u636e\u5305\uff0c\u6bcf\u4e2a\u6d41\u90fd\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bc6\u53f7\uff0c\u8fd9\u6837\u5ba2\u6237\u7aef\u5c31\u53ef\u4ee5\u4e0d\u7ba1\u670d\u52a1\u7aef\u662f\u5426\u5df2\u7ecf\u8fd4\u56de\u6570\u636e\u800c\u4e0d\u65ad\u5f80\u670d\u52a1\u7aef\u53d1\u9001\u65b0\u7684\u6d41\u3002</p> <p>\u56e0\u4e3a\u6bcf\u4e2a\u6d41\u6709\u72ec\u7acb\u7684 ID\uff0c\u5728\u670d\u52a1\u7aef\u8fd4\u56de\u5904\u7406\u6d41\u7684\u6570\u636e\u5305\u65f6\uff0c\u53ea\u8981\u6839\u636e\u8fd9\u4e2a\u6d41\u7684 ID \u627e\u5230\u53d1\u9001\u7684\u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u4e00\u4e00\u5bf9\u5e94\u3002</p> <p>\u8fd9\u4e2a\u6d41\u6211\u4eec\u53ef\u4ee5\u7406\u89e3\u6210\u4e00\u4e2a\u865a\u62df\u8fde\u63a5</p> <p>\u5728\u4ee3\u7801\u5b9e\u73b0\u65f6\uff0c\u4e5f\u53ef\u4ee5\u770b\u5230 stream \u5176\u5b9e\u5c31\u662f\u7528\u865a\u62df\u8fde\u63a5\u7684\u65b9\u5f0f\u5b9e\u73b0\u7684\u3002\u6211\u4eec\u5728\u4e00\u6761 TCP \u8fde\u63a5\u4e0a\uff0c\u5efa\u7acb\u4e86\u5f88\u591a\u865a\u62df\u8fde\u63a5\uff0c\u8fd9\u4e9b\u865a\u62df\u8fde\u63a5\uff08\u4e5f\u5c31\u662f\u6d41\uff09\u7684\u521b\u5efa\u51e0\u4e4e\u6ca1\u6709\u6210\u672c\uff0c\u5728\u6bcf\u6b21\u53d1\u9001\u65b0\u7684\u8bf7\u6c42\u524d\uff0c\u76f4\u63a5 new stream() \u8fd4\u56de\u65b0\u7684\u6570\u636e\u6d41\uff08\u865a\u62df\u8fde\u63a5\uff09\uff0c\u7136\u540e\u53d1\u9001\u6570\u636e\u5373\u53ef\u3002</p> <p> </p>"},{"location":"chap1/5chap1_conn_pool/#4-3-http2","title":"4-3 HTTP/2 \u5230\u5e95\u9700\u4e0d\u9700\u8981\u8fde\u63a5\u6c60\uff1f","text":"<p>\u9700\u8981\uff0c\u4f46\u548c\u4f20\u7edf\u7684\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u4e5f\u5c31\u662f HTTP 1.0 \u7684\u8fde\u63a5\u6c60\u6709\u4e00\u4e9b\u533a\u522b\u3002\u5b9e\u9645\u4e0aHTTP/2 \u5df2\u7ecf\u590d\u7528\u4e86\u8fde\u63a5\uff0c\u4ece\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u8bb2\u5b9e\u73b0\u8fde\u63a5\u6c60\u5df2\u7ecf\u6ca1\u6709\u592a\u591a\u610f\u4e49\u4e86\uff0c\u591a\u8def\u590d\u7528\u505a\u5230\u4e00\u6761\u8fde\u63a5\u5c31\u53ef\u4ee5\u4e86\uff0c\u4f46\u56e0\u4e3a HTTP 2 .0 \u8fd8\u662f\u57fa\u4e8e TCP \u8fde\u63a5\u7684\uff0c\u800c TCP \u5b58\u5728\u961f\u5934\u963b\u585e\u7684\u95ee\u9898\uff0c\u6bd4\u5982\u67d0\u6761\u8fde\u63a5\u7a81\u7136\u9047\u5230\u4e86\u7f51\u7edc\u91cd\u4f20\uff0c\u6b64\u65f6\u4f1a\u963b\u585e\u8fde\u63a5\u3002\u53e6\u5916\u5728\u4e00\u4e9b\u9ad8\u5e76\u53d1\u573a\u666f\uff0c\u4e00\u6761\u8fde\u63a5\u96be\u4ee5\u8dd1\u6ee1\u5e26\u5bbd\uff0c\u4e5f\u9700\u8981\u521b\u5efa\u591a\u6761\u8fde\u63a5\u3002</p> <p>\u6240\u4ee5 HTTP/2 \u7684\u8fde\u63a5\u6c60\u5b9e\u73b0\u6709\u6240\u4e0d\u540c\uff0c\u65b0\u8fde\u63a5\u7684\u521b\u5efa\u6761\u4ef6\u5f80\u5f80\u662f\u4f9d\u636e maxConcurrentStreams \u7684\u53c2\u6570\uff0c\u5f53\u540c\u65f6\u8bf7\u6c42\u4e2d\u7684 stream \u7684\u6570\u91cf\u8d85\u8fc7\u4e0a\u9650\u65f6\uff0c\u624d\u521b\u5efa\u65b0\u7684\u8fde\u63a5\u3002</p> <p>\u6240\u4ee5\u5728 gRPC \u548c HTTP/2 \u4e2d\u8fd9\u4e2a\u53c2\u6570\u7684\u8bbe\u7f6e\u975e\u5e38\u91cd\u8981\uff0c\u5b83\u7684\u91cd\u8981\u6027\u53ef\u4ee5\u7b49\u540c\u4e8e\u4e0a\u9762\u8bb2\u7684 MaxIdleConns \u53c2\u6570\u3002\u8fd9\u6837\u7684\u8bbe\u8ba1\u4e5f\u5f88\u597d\u7406\u89e3\uff0c\u56e0\u4e3a HTTP/2 \u5df2\u7ecf\u53ef\u4ee5\u590d\u7528\u540c\u4e00\u6761\u8fde\u63a5\u53d1\u9001\u591a\u4e2a\u8bf7\u6c42\u4e86\uff0c\u81ea\u7136\u6ca1\u6709\u5fc5\u8981\u4e00\u4e2a\u8bf7\u6c42\u521b\u5efa\u4e00\u4e2a\u8fde\u63a5\uff0c\u53ea\u9700\u7b49\u8fd9\u4e2a\u8fde\u63a5\u65e0\u6cd5\u6ee1\u8db3\u8bbe\u7f6e\u7684\u6700\u5927 stream \u7684\u6761\u4ef6\u65f6\u624d\u5efa\u7acb\u65b0\u7684\u8fde\u63a5\u3002</p>"},{"location":"chap1/6chap1_apigateway_kong/","title":"\u7b2c\u516d\u8282 \u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff1a\u7f51\u5173\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u4f5c\u7528","text":""},{"location":"chap1/6chap1_apigateway_kong/#1api-gateway","title":"1\u3001API Gateway","text":"<p>\u5b9e\u9645\u4e0a API Gateway \u53ef\u4ee5\u7b49\u540c\u4e8e\u5fae\u670d\u52a1\u7f51\u5173\u3002</p> <p>\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u968f\u7740\u5fae\u670d\u52a1\u7684\u62c6\u5206\uff0c\u8fd9\u4e9b\u5fae\u670d\u52a1\u4e0d\u53ef\u80fd\u540c\u65f6\u63d0\u4f9b\u5bf9\u5916\u670d\u52a1\uff0c\u8fd9\u6837\u5c31\u9700\u8981\u4e00\u4e2a\u7f51\u5173\u7cfb\u7edf\uff0c\u627f\u63a5\u5916\u7f51\u7684\u6d41\u91cf\u3002</p> <p>\u6709\u4e86API \u7f51\u5173\uff0c\u5404\u4e2a API \u670d\u52a1\u63d0\u4f9b\u56e2\u961f\u53ef\u4ee5\u4e13\u6ce8\u81ea\u5df1\u7684\u4e1a\u52a1\u903b\u8f91\u5904\u7406\uff0c\u800c API \u7f51\u5173\u5219\u66f4\u4e13\u6ce8\u4e8e\u5b89\u5168\u3001\u6d41\u91cf\u3001\u8def\u7531\u7b49\u95ee\u9898\u3002</p>"},{"location":"chap1/6chap1_apigateway_kong/#1-1","title":"1-1 \u5fae\u670d\u52a1\u7f51\u5173\u4e3b\u8981\u63d0\u4f9b\u54ea\u4e9b\u529f\u80fd","text":"<ul> <li>\u7edf\u4e00\u6d41\u91cf\u63a5\u5165\uff1a\u63d0\u4f9b\u7edf\u4e00\u7684\u6d41\u91cf\u5165\u53e3\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7531\u7edf\u4e00\u7684\u5165\u53e3\u7ba1\u7406\u6d41\u91cf\uff0c\u8bbe\u7f6e\u5404\u79cd\u7b56\u7565\uff0c\u6bd4\u5982\u7edf\u4e00\u7684 Token \u8ba4\u8bc1\u7b49\u3002</li> <li>\u4e1a\u52a1\u805a\u5408\uff1a\u5728\u5177\u4f53\u7684\u4e1a\u52a1\u4e2d\uff0c\u7ecf\u5e38\u9700\u8981\u805a\u5408\u591a\u4e2a\u670d\u52a1\u7684\u7ed3\u679c\u96c6\uff0c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ef\u4ee5\u7531 API \u7f51\u5173\u805a\u5408\u6570\u636e\u7136\u540e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> <li>\u534f\u8bae\u8f6c\u6362\uff1a\u4e00\u822c\u5165\u53e3\u5c42\uff0c\u591a\u4f7f\u7528 HTTP \u534f\u8bae\u7684 RESTful \u63a5\u53e3\uff0c\u800c\u540e\u7aef\u670d\u52a1\u7684\u534f\u8bae\u53ef\u80fd\u6709\u591a\u79cd\uff0c\u6bd4\u5982 gRPC\u3001Thrift \u7b49\u3002</li> <li>\u4e2d\u95f4\u4ef6\u7b56\u7565\uff1a\u8bbe\u7f6e\u7edf\u4e00\u7684\u4e2d\u95f4\u4ef6\u7b56\u7565\u5c42\uff0c\u53ef\u4ee5\u5728\u8fd9\u4e00\u5c42\u505a\u4e00\u4e9b\u9650\u6d41\u7194\u65ad\u3001\u5357\u5317\u5411\u6d41\u91cf\u7684\u670d\u52a1\u6cbb\u7406\u529f\u80fd\u3002</li> <li>\u5b89\u5168\u8ba4\u8bc1\uff1a\u4e00\u4e9b Token \u8ba4\u8bc1\u529f\u80fd\uff0c\u6bd4\u5982\u6570\u636e\u662f\u5426\u88ab\u7be1\u6539\u7684\u8ba4\u8bc1\uff0c\u53ef\u4ee5\u5728 API \u7f51\u5173\u4e2d\u505a\uff0c\u8fd9\u4e5f\u662f\u7ecf\u5e38\u7528\u5230\u7684\u529f\u80fd\u3002</li> <li>\u8bc1\u4e66\u7ba1\u7406\uff1a\u968f\u7740\u5bf9\u5916\u7f51\u5b89\u5168\u6027\u80fd\u8981\u6c42\u7684\u589e\u9ad8\uff0c\u73b0\u5728\u57fa\u672c\u4e0a\u90fd\u8981\u5bf9\u5916\u63d0\u4f9b HTTPS \u7684\u670d\u52a1\uff0c\u4ee5\u4fdd\u8bc1\u6570\u636e\u4e0d\u4f1a\u88ab\u52ab\u6301\u3001\u7be1\u6539\u7b49\u95ee\u9898\uff0c\u5728\u8fd9\u4e00\u5c42\u505a\u8bc1\u4e66\u5bf9\u5185\u7f51\u7684\u62c6\u5378\u975e\u5e38\u5408\u9002\u3002\u7531\u4e00\u4e2a\u7edf\u4e00\u7684\u5165\u53e3\u7ba1\u7406\u63a5\u53e3\uff0c\u964d\u4f4e\u4e86\u8bc1\u4e66\u66f4\u6362\u65f6\u7684\u590d\u6742\u5ea6\u3002</li> </ul>"},{"location":"chap1/6chap1_apigateway_kong/#1-2","title":"1-2 \u5e38\u7528\u5fae\u670d\u52a1\u7f51\u5173\u4ecb\u7ecd","text":"<ul> <li>Kong\uff1a\u51e0\u4e4e\u662f\u76ee\u524d\u6700\u6d41\u884c\u7684\u5fae\u670d\u52a1\u7f51\u5173\uff0c\u5185\u7f6e\u4e86\u591a\u79cd\u7f51\u5173\u6240\u9700\u8981\u7684\u529f\u80fd\uff0c\u540e\u9762\u6211\u4eec\u5c06\u8be6\u7ec6\u4ecb\u7ecd\u3002</li> </ul> <ul> <li>Spring Cloud Zuul\uff1a\u4f5c\u4e3a Spring Cloud \u7684\u4e00\u90e8\u5206\uff0c\u63d0\u4f9b\u4e86\u5fae\u670d\u52a1\u6240\u9700\u8981\u7684\u7f51\u5173\u7684\u5927\u90e8\u5206\u529f\u80fd\uff0c\u6700\u5927\u7684\u4f18\u52bf\u662f\u5bf9 Java \u7cfb\u7edf\u53cb\u597d\u3002\u4e25\u683c\u6765\u8bf4Zuul \u66f4\u50cf\u662f\u4e00\u4e2a\u5fae\u670d\u52a1\u7f51\u5173\u7684\u6846\u67b6\uff0c\u800c\u4e0d\u662f\u72ec\u7acb\u7684\u4ea7\u54c1\u3002</li> </ul> <ul> <li>Traefik\uff1a\u57fa\u4e8e Go \u8bed\u8a00\u5b9e\u73b0\u7684\u5fae\u670d\u52a1\u7f51\u5173\uff0c\u4ee3\u7801\u7ed3\u6784\u6e05\u6670\u7b80\u5355\uff0c\u9002\u5408\u505a\u4e8c\u6b21\u5f00\u53d1\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u72ec\u7acb\u7684\u4ea7\u54c1\u4f7f\u7528\uff0c\u5bf9\u4e91\u539f\u751f\u652f\u6301\u53cb\u597d\u3002\u5982\u679c\u6280\u672f\u6808\u662f Go \u8bed\u8a00\uff0c\u503c\u5f97\u4e00\u8bd5\u3002</li> </ul>"},{"location":"chap1/6chap1_apigateway_kong/#1-3","title":"1-3\u3001\u53cc\u91cd\u7f51\u5173\uff08\u7cfb\u7edf\u7f51\u5173\u548c\u4e1a\u52a1\u7f51\u5173\uff09","text":"<p>\u5355\u4e00\u7684\u7f51\u5173\u7cfb\u7edf\u5df2\u7ecf\u4e0d\u80fd\u6ee1\u8db3\u7ec4\u7ec7\u67b6\u6784\u548c\u4e1a\u52a1\u7684\u53d1\u5c55\u4e86\uff0c\u6240\u4ee5\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u591a\u91c7\u7528\u53cc\u91cd\u7f51\u5173\u7ed3\u6784\u3002</p> <p>\u8fd9\u79cd\u7ed3\u6784\u7531\u591a\u4e2a\u7cfb\u7edf\u7f51\u5173\u548c\u591a\u4e2a\u4e1a\u52a1\u805a\u5408\u7f51\u5173\u7ec4\u6210</p> <p>\u8fd9\u6837\u914d\u5408\u662f\u56e0\u4e3a\u7cfb\u7edf\u7f51\u5173\u591a\u7531\u5e38\u89c1\u7684 Nginx \u7cfb\u7f51\u5173\u6784\u6210\uff0c\u4f7f\u7528 Nginx \u7cfb\u7684\u7f51\u5173\u5bf9\u8fd0\u7ef4\u53cb\u597d\uff0c\u65b9\u4fbf\u8fd0\u7ef4\u505a\u4e00\u4e9b\u76d1\u63a7\u3001\u65e5\u5fd7\u3001\u5b89\u5168\u7b56\u7565\uff1b\u4f46\u5f80\u5f80\u5bf9\u7814\u53d1\u4eba\u5458\u4e0d\u592a\u53cb\u597d\uff0c\u4e0d\u65b9\u4fbf\u6269\u5c55\u3002\u6240\u4ee5\u540e\u6765\u589e\u52a0\u4e86\u4e1a\u52a1\u7f51\u5173\uff0c\u7528\u4e8e\u670d\u52a1\u7684\u805a\u5408\uff0c\u8fd9\u5c42\u7f51\u5173\u56e0\u4e3a\u9700\u8981\u505a\u4e00\u4e9b\u4e1a\u52a1\u7684\u805a\u5408\u7b56\u7565\uff0c\u5e73\u65f6\u6539\u52a8\u4f1a\u6bd4\u8f83\u591a\u3002</p> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4e24\u4e2a\u7f51\u5173\u76f8\u4e92\u914d\u5408\uff0c\u65e2\u65b9\u4fbf\u4e86\u8fd0\u7ef4\u7ef4\u62a4\uff0c\u4e5f\u65b9\u4fbf\u4e86\u7814\u53d1\u4eba\u5458\u6269\u5c55\uff0c\u8fbe\u5230\u67d0\u79cd\u5e73\u8861\u3002</p> <p>\u8fd9\u4e9b\u7f51\u5173\u4f1a\u6839\u636e\u4e1a\u52a1\u7ef4\u5ea6\u62c6\u5206\uff0c\u6bd4\u5982\u5206\u4e3a\u7528\u6237\u7cfb\u7edf\u7f51\u5173\u548c\u5185\u5bb9\u7cfb\u7edf\u7f51\u5173\u3002\u8fd9\u6837\u62c6\u5206\u7684\u76ee\u7684\uff0c\u662f\u9632\u6b62\u7531\u5355\u4e00\u7f51\u5173\u7684\u6545\u969c\u5e26\u6765\u5168\u7ad9\u7684\u4e0d\u53ef\u7528\uff0c\u4ece\u800c\u8fbe\u5230\u964d\u4f4e\u6545\u969c\u5f71\u54cd\u9762\u7684\u6548\u679c\u3002</p> <p> </p>"},{"location":"chap1/6chap1_apigateway_kong/#2-kong","title":"2\u3001\u5fae\u670d\u52a1\u7f51\u5173 Kong","text":"<p>https://codechina.csdn.net/mirrors/Kong/kong?utm_source=csdn_github_accelerator</p> <p>\u5f00\u6e90\u7f51\u5173 Kong\u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684 API \u7f51\u5173\uff0c\u57fa\u4e8e OpenResty + Lua \u5f00\u53d1\uff0c\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u529f\u80fd\u4ee5\u53ca\u9ad8\u5ea6\u7075\u6d3b\u7684\u6269\u5c55\u6027\uff0c\u53ef\u4ee5\u901a\u8fc7\u63d2\u4ef6\u7684\u65b9\u5f0f\u6269\u5c55 Kong \u7684\u529f\u80fd\u3002</p> <p> </p> <p>Kong \u4f5c\u4e3a\u5fae\u670d\u52a1\u7f51\u5173\uff0c\u6700\u5927\u7684\u4f18\u52bf\u5c31\u662f\u62bd\u8c61\u51fa\u4e86\u5fae\u670d\u52a1\u7f51\u5173\u7684\u4e00\u5957\u6a21\u578b\uff0c\u800c\u4e0d\u9700\u8981\u50cf OpenResty \u90a3\u6837\u624b\u52a8\u914d\u7f6e\u3002</p>"},{"location":"chap1/6chap1_apigateway_kong/#2-1","title":"2-1 \u5fae\u670d\u52a1\u7f51\u5173\u7684\u4e00\u5957\u6a21\u578b","text":"<ul> <li>service\uff1a\u670d\u52a1\u5bf9\u5e94\u7684\u540e\u7aef\u7684\u5fae\u670d\u52a1\u548c API\u3002\u4e00\u822c\u60c5\u51b5\u4e0b\u628a\u4e00\u7ec4 API \u96c6\u5408\u6210\u4e3a\u4e00\u4e2a\u670d\u52a1\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u540e\u7aef\u7684\u5fae\u670d\u52a1\u3002</li> <li>router\uff1a\u8def\u7531\u6307\u7684\u662f\u6d41\u91cf\u5230\u8fbe API \u7f51\u5173\u540e\uff0c\u5982\u4f55\u627e\u5230\u540e\u7aef\u5bf9\u5e94\u7684\u670d\u52a1\u3002</li> <li>Admin API\uff1aKong \u4e2d\u7684 RESTful \u7684\u5185\u90e8 API \u63a5\u53e3\u3002 API \u63a5\u53e3\u53ef\u4ee5\u5728\u96c6\u7fa4\u7684\u4efb\u610f\u8282\u70b9\u8fd0\u884c\uff0c\u6700\u7ec8\u540c\u6b65\u5230\u6240\u6709\u96c6\u7fa4\u7684\u8282\u70b9\u3002\u7528\u4e8e\u7ba1\u7406 Kong \u7684\u5404\u79cd\u884c\u4e3a\uff0c\u6bd4\u5982\u6dfb\u52a0 service\u3001router \u7b49\u3002</li> <li>Plugins\uff1aKong \u7684\u63d2\u4ef6\u7cfb\u7edf\u3002\u5229\u7528\u63d2\u4ef6\u7cfb\u7edf\uff0c\u6211\u4eec\u6dfb\u52a0\u65b0\u529f\u80fd\u5c31\u4e0d\u9700\u8981\u6539\u52a8 Kong \u7684\u6838\u5fc3\u4ee3\u7801\u3002\u63d2\u4ef6\u7cfb\u7edf\u81ea\u5e26\u8db3\u591f\u591a\u7684\u529f\u80fd\uff0c\u6bd4\u5982\u8ba4\u8bc1\u3001\u9650\u6d41\u3001\u65e5\u5fd7\u3001Metrics \u7b49\u3002</li> <li>Load Balancing\uff1aKong\u63d0\u4f9b\u4e86\u4e24\u79cd\u8d1f\u8f7d\u5747\u8861\u65b9\u5f0f\uff0cDNS \u548c\u5185\u7f6e\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u3002\u5229\u7528 DNS \u6a21\u5f0f\uff0c\u53ef\u4ee5\u548c Consul \u7ed3\u5408\uff0c\u5b9e\u73b0\u670d\u52a1\u53d1\u73b0\u3002\u5185\u7f6e\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5219\u9700\u8981\u81ea\u5df1\u624b\u52a8\u7ef4\u62a4\u540e\u7aef\u8282\u70b9\u3002</li> </ul>"},{"location":"chap1/6chap1_apigateway_kong/#2-2-konga","title":"2-2 Konga","text":"<p>Kong \u5b98\u65b9\u5e76\u6ca1\u6709\u4e3a\u5f00\u6e90\u7248\u672c\u63d0\u4f9b\u56fe\u5f62\u754c\u9762\uff0chttps://github.com/PGBI/kong-dashboard</p> <p> </p> <p><code>DB Mode\uff080.x-1.0\uff09\u2192 DB-less Mode(1.1-1.5)\u2192 Hybird Mode(2.0+)</code></p> <ul> <li>DB Mode\uff1a\u6700\u65e9\u7684 Kong \u7248\u672c\u5c31\u662f\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6bcf\u4e2a Kong \u90fd\u8fde\u63a5\u4e86\u540e\u7aef DB\uff0c\u8fd9\u4e2a DB \u53ef\u9009\u4e3a PostgreSQL \u6216\u8005 Cassandra\u3002\u4f46\u662f\u8fd9\u4e2a\u6a21\u5f0f\u4e4b\u524d\u6709\u4e2a\u5f88\u4e25\u91cd\u7684 Bug\uff0c\u5c31\u662f\u5728\u6d41\u91cf\u5927\u7684\u65f6\u5019\u66f4\u65b0\u8def\u7531\u914d\u7f6e\uff0c\u4f1a\u5bfc\u81f4 Kong \u4ea7\u751f\u5267\u70c8\u7684\u6296\u52a8\u3002</li> <li>DB-less Mode\uff1a\u65e0\u6570\u636e\u5e93\u6a21\u5f0f\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7\u58f0\u660e\u5f0f\u7684\u914d\u7f6e\u65b9\u5f0f\u6765\u8fd0\u884c Kong\u3002\u8fd9\u79cd\u65b9\u5f0f\u4ece\u67d0\u79cd\u610f\u4e49\u6765\u8bf4\u662f\u4e00\u79cd\u5012\u9000\uff0c\u56e0\u4e3a\u5b83\u8ba9 Kong \u65e0\u6cd5\u901a\u8fc7 API \u63a7\u5236\uff0c\u4e5f\u5c31\u662f\u56de\u5230\u4e86\u539f\u59cb\u7684 Nginx \u914d\u7f6e\u6a21\u5f0f\uff0c\u76f8\u5f53\u4e8e Service Mesh \u5931\u53bb\u4e86\u63a7\u5236\u9762\u3002\u4f46\u4e5f\u56e0\u4e3a\u56de\u5f52\u4e86\u539f\u59cb\u7684\u65b9\u5f0f\uff0c\u4e0d\u4f1a\u51fa\u73b0 DB Mode \u66f4\u65b0\u914d\u7f6e\u65f6\u5bfc\u81f4\u7684\u4e00\u4e9b\u6296\u52a8\u95ee\u9898\u3002</li> <li>Hybird Mode\uff1a\u5176\u5b9e\u4e5f\u5c31\u662f\u5f15\u5165\u4e86 Service Mesh \u4e2d\u7684\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u6a21\u5f0f\u3002\u76f8\u5bf9\u4e8e\u4e0a\u9762\u4e24\u79cd\u6a21\u5f0f\u6709\u5de8\u5927\u7684\u67b6\u6784\u4f18\u52bf\uff0cHybird Mode \u901a\u8fc7\u63a7\u5236\u9762\u6536\u655b\u4e86\u6570\u636e\u5e93\u7684\u64cd\u4f5c\u884c\u4e3a\uff0cKong \u7684\u6570\u636e\u8282\u70b9\u4e0d\u9700\u8981\u518d\u76f4\u63a5\u8fde\u63a5\u5230 DB \u5c42\u3002\u8fd9\u79cd\u6a21\u5f0f\u6709\u4ee5\u4e0b\u4e24\u79cd\u4f18\u52bf\u3002<ul> <li>\u4ec5\u63a7\u5236\u9762\u8282\u70b9\u9700\u8981\u8fde\u63a5\u5230 DB\uff0c\u800c\u4e0d\u662f\u6240\u6709\u6570\u636e\u8282\u70b9\u8fde\u63a5\u5230 DB\uff0c\u5bf9 DB \u7684\u538b\u529b\u5927\u5927\u51cf\u5c11\uff0c\u4e5f\u5c31\u964d\u4f4e\u4e86\u6570\u636e\u9762\u51fa\u73b0\u6296\u52a8\u7684\u6982\u7387\u3002</li> <li>\u6613\u4e8e\u7ba1\u7406\uff0c\u4e0d\u7528\u50cf\u4e4b\u524d\u7684 API \u8c03\u7528 Kong \u7684\u6570\u636e\u8282\u70b9\u65f6\u518d\u64cd\u4f5c Admin API \u53d8\u66f4\uff0c\u53ea\u9700\u4e0e\u63a7\u5236\u9762\u4ea4\u4e92\u5373\u53ef\u3002</li> </ul> </li> </ul> <p> </p>"},{"location":"chap1/6chap1_apigateway_kong/#2-3","title":"2-3 \u56fe\u5f62\u5316\u805a\u5408\u5c42","text":"<p>\u7edf\u7f51\u5173\u548c\u4e1a\u52a1\u7f51\u5173\u7684\u67b6\u6784\uff0c\u5b9e\u9645\u4e0a\u8fd9\u6837\u505a\u589e\u52a0\u4e86\u4e00\u6761\u8bf7\u6c42\u94fe\u8def\u3002\u6211\u4eec\u8fd9\u6837\u505a\u662f\u56e0\u4e3a\u4e1a\u52a1\u7f51\u5173\u9891\u7e41\u66f4\u65b0\uff0c\u90a3\u4e48\u6709\u6ca1\u6709\u529e\u6cd5\u51cf\u5c11\u8fd9\u79cd\u66f4\u65b0\u9891\u7387\u5462\uff1f</p> <p>\u5b9e\u9645\u4e0a Uber \u5df2\u7ecf\u5728\u67d0\u65b9\u9762\u505a\u51fa\u4e86\u52a8\u4f5c\uff0c\u90a3\u5c31\u662f\u901a\u8fc7\u56fe\u5f62\u5316\u754c\u9762\u7684\u65b9\u5f0f\uff0c\u805a\u5408\u540e\u7aef API\u3002</p> <p> </p>"},{"location":"chap1/6chap1_apigateway_kong/#2-4","title":"2-4 \u957f\u8fde\u7f51\u5173","text":"<p>\u8fd9\u91cc\u7684\u957f\u8fde\u7f51\u5173\uff0c\u6307\u7684\u662f\u901a\u8fc7\u79c1\u6709\u534f\u8bae\u6216\u8005 gRPC\u3001HTTP/2 \u7b49\u534f\u8bae\u4ee3\u66ff HTTP \u534f\u8bae\u3002</p> <p>\u901a\u8fc7\u957f\u8fde\u63a5\u901a\u9053\uff0c\u51cf\u5c11\u5ba2\u6237\u7aef\u548c\u7f51\u5173\u7684\u5efa\u8fde\u6b21\u6570\uff0c\u540c\u65f6\u901a\u8fc7\u538b\u7f29 header \u7b49\u65b9\u5f0f\uff0c\u51cf\u5c11\u901a\u4fe1\u4e2d\u4ea7\u751f\u7684\u6d41\u91cf\uff0c\u4ee5\u8fbe\u5230\u63d0\u9ad8\u5ba2\u6237\u7aef\u54cd\u5e94\u901f\u5ea6\u7684\u76ee\u7684\uff0c\u8ba9\u7528\u6237\u5728 App \u7684\u4f7f\u7528\u4f53\u9a8c\u4e0a\u66f4\u4e0a\u4e00\u4e2a\u53f0\u9636\u3002</p>"},{"location":"chap1/6chap1_apigateway_kong/#2-5-service-mesh","title":"2-5 Service Mesh \u5316","text":"<p>\u5176\u5b9e\u5728 Service Mesh \u65f6\u4ee3\uff0c\u5fae\u670d\u52a1\u7f51\u5173\u4e2d\u7684\u67d0\u4e9b\u529f\u80fd\uff0c\u6bd4\u5982\u9650\u6d41\u3001\u8ba4\u8bc1\u3001\u9274\u6743\u7b49\u901a\u7528\u529f\u80fd\uff0c\u5b8c\u5168\u53ef\u4ee5\u8ba9\u672c\u5730\u7684 Sidecar \u5b8c\u6210\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u51cf\u5c11\u5fae\u670d\u52a1\u94fe\u8def\u4e2d\u7684\u4e00\u73af\uff0c\u63d0\u9ad8\u670d\u52a1\u7684\u541e\u5410\u53ca\u6574\u4f53\u67b6\u6784\u7684\u53ef\u7ef4\u62a4\u6027\u3002</p>"},{"location":"chap1/7chap1_config_center/","title":"\u7b2c\u4e03\u8282 \u5fae\u670d\u52a1\u6cbb\u7406\u7684\u914d\u7f6e\u4e2d\u5fc3","text":"<p>\u53ef\u80fd\u4f1a\u5c06\u6ce8\u518c\u4e2d\u5fc3\u548c\u914d\u7f6e\u4e2d\u5fc3\u6df7\u4e3a\u4e00\u8c08\uff0c\u7279\u522b\u662f\u5f88\u591a\u5206\u5e03\u5f0f\u5b58\u50a8\u7ec4\u4ef6\u4e5f\u7ecf\u5e38\u88ab\u63a8\u8350\u540c\u65f6\u7528\u4f5c\u6ce8\u518c\u4e2d\u5fc3\u548c\u914d\u7f6e\u4e2d\u5fc3\u3002\u8fd9\u91cc\u9762\u5b58\u5728\u4e00\u5b9a\u7684\u8bef\u89e3</p>"},{"location":"chap1/7chap1_config_center/#1","title":"1\u3001\u4e3a\u4ec0\u4e48\u9700\u8981\u914d\u7f6e\u4e2d\u5fc3","text":"<p>\u914d\u7f6e\u4e2d\u5fc3\uff0c\u4ece\u540d\u5b57\u4e0a\u770b\uff0c\u5c31\u662f\u7528\u6765\u7edf\u4e00\u7ba1\u7406\u9879\u76ee\u4e2d\u6240\u6709\u914d\u7f6e\u7684\u7cfb\u7edf\u3002\u800c\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u914d\u7f6e\u4e2d\u5fc3\u662f\u7528\u6765\u52a8\u6001\u66f4\u65b0\u670d\u52a1\u914d\u7f6e\uff0c\u800c\u4e0d\u9700\u8981\u8fdb\u884c\u670d\u52a1\u90e8\u7f72\u7684\u7ec4\u4ef6\u3002</p>"},{"location":"chap1/7chap1_config_center/#1-1","title":"1-1 \u51cf\u5c11\u53d1\u7248\u6b21\u6570","text":"<p>\u51cf\u5c11\u53d1\u7248\u6b21\u6570\u662f\u914d\u7f6e\u4e2d\u5fc3\u5e26\u6765\u7684\u6700\u5927\u4f18\u52bf</p> <p>\u4ee5\u5f80\u914d\u7f6e\u6587\u4ef6\u90fd\u662f\u653e\u5728\u4ee3\u7801\u4e2d\uff0c\u5982\u679c\u60f3\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u53ea\u80fd\u4fee\u6539\u4ee3\u7801\u7136\u540e\u901a\u8fc7\u53d1\u5e03\u7cfb\u7edf\u53d1\u5e03\u65b0\u7684\u4ee3\u7801\u7248\u672c\u3002\u8fd9\u79cd\u65b9\u5f0f\u4f1a\u9020\u6210\u9891\u7e41\u53d1\u7248\uff0c\u6bd4\u5982\u4fee\u6539\u65e5\u5fd7\u7684\u7b49\u7ea7\uff0c\u5c31\u8981\u91cd\u65b0\u53d1\u7248\u3002</p> <p>\u53d1\u7248\u4e0d\u4ec5\u4f1a\u5e26\u6765\u4e00\u5b9a\u7684\u98ce\u9669\uff0c\u800c\u4e14\u53d1\u7248\u7684\u65f6\u95f4\u5468\u671f\u5f80\u5f80\u6bd4\u8f83\u957f\uff0c\u76f8\u5bf9\u6765\u8bf4\uff0c\u901a\u8fc7\u914d\u7f6e\u4e2d\u5fc3\u66f4\u65b0\u914d\u7f6e\uff0c\u65f6\u95f4\u4f1a\u77ed\u5f88\u591a</p> <p>\u4f20\u7edf\u7684\u53d1\u7248</p> <p>\u4fee\u6539\u4ee3\u7801\u2192\u63d0\u4ea4\u4ee3\u7801\u2192\u5408\u5e76\u4ee3\u7801\u2192 CI/CD \u53d1\u5e03\u2192\u89c2\u5bdf\u76d1\u63a7</p> <p>\u914d\u7f6e\u4e2d\u5fc3</p> <p>\u53ef\u4ee5\u8ba9\u5de5\u7a0b\u5e08\u4ece\u70e6\u7410\u7684\u91cd\u590d\u5de5\u4f5c\u4e2d\u89e3\u8131\u51fa\u6765\uff0c\u63d0\u9ad8\u5f00\u53d1\u6548\u7387\u3002</p>"},{"location":"chap1/7chap1_config_center/#1-2","title":"1-2 \u63d0\u5347\u5b89\u5168\u6027","text":"<p>\u5982\u679c\u901a\u8fc7\u4ee3\u7801\u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\u7ef4\u62a4\u914d\u7f6e\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u3001Redis \u7b49\u4e2d\u95f4\u4ef6\u7684\u8ba4\u8bc1\u4fe1\u606f\u90fd\u4f1a\u660e\u6587\u5b58\u50a8\u5728\u4ee3\u7801\u4e2d\uff0c\u8fd9\u6837\u7684\u5b89\u5168\u6027\u5c31\u4f1a\u6bd4\u8f83\u4f4e\u3002</p> <p>\u800c\u901a\u8fc7\u914d\u7f6e\u4e2d\u5fc3\uff0c\u53ef\u4ee5\u5c06\u654f\u611f\u4fe1\u606f\u6536\u655b\u5230\u914d\u7f6e\u4e2d\u5fc3\u7684\u5b58\u50a8\u4e2d\uff0c\u5e76\u901a\u8fc7\u4e00\u5b9a\u7684\u52a0\u89e3\u5bc6\u7b97\u6cd5\u52a0\u5bc6\u4fdd\u62a4\u3002</p>"},{"location":"chap1/7chap1_config_center/#2","title":"2\u3001\u914d\u7f6e\u4e2d\u5fc3\u7279\u6027","text":""},{"location":"chap1/7chap1_config_center/#2-1","title":"2-1 \u5b9e\u65f6\u611f\u77e5\u53d8\u66f4","text":"<p>\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\u6765\u8bf4\uff0c\u5b9e\u65f6\u611f\u77e5\u914d\u7f6e\u7684\u53d8\u5316\u662f\u6700\u57fa\u672c\u7684\u529f\u80fd\uff0c\u8fd9\u70b9\u548c\u6ce8\u518c\u4e2d\u5fc3\u7684\u9700\u6c42\u57fa\u672c\u4e00\u81f4\uff0c\u8fd9\u4e5f\u662f\u4e24\u4e2a\u7ec4\u4ef6\u7ecf\u5e38\u88ab\u6df7\u7528\u7684\u4e3b\u8981\u539f\u56e0\u3002</p> <ul> <li>\u6ce8\u518c\u4e2d\u5fc3\u5bf9\u5b9e\u65f6\u6027\u8981\u6c42\u975e\u5e38\u9ad8\uff0c\u5728\u4fdd\u8bc1\u7a33\u5b9a\u6027\u7684\u524d\u63d0\u4e0b\u5c3d\u53ef\u80fd\u5730\u5feb\u901f\u6536\u5230\u8282\u70b9\u7684\u53d8\u66f4\uff0c\u4ee5\u4fdd\u8bc1\u8d1f\u8f7d\u5747\u8861\u5668\u6570\u636e\u6e90\u7684\u51c6\u786e\u6027\uff1b</li> <li>\u4f46\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\u6765\u8bf4\uff0c\u5b9e\u65f6\u6027\u8981\u6c42\u5e76\u4e0d\u662f\u90a3\u4e48\u9ad8\uff0c\u53ea\u8981\u4fdd\u8bc1\u6700\u7ec8\u4e00\u81f4\u5c31\u53ef\u4ee5\u4e86\uff0c\u81f3\u4e8e\u65f6\u95f4\u662f 1s \u8fd8\u662f 1min\uff0c\u90fd\u53ef\u4ee5\u63a5\u53d7\u3002</li> </ul>"},{"location":"chap1/7chap1_config_center/#2-2","title":"2-2 \u5b89\u5168\u6027\u8981\u6c42\u9ad8","text":"<ul> <li>\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\uff0c\u56e0\u4e3a\u7ecf\u5e38\u8981\u5b58\u50a8\u6570\u636e\u5e93\u5bc6\u7801\u3001\u7b2c\u4e09\u65b9\u4e1a\u52a1\u5bc6\u94a5\u7b49\u4fe1\u606f\uff0c\u6240\u4ee5\u5bf9\u5b89\u5168\u6027\u8981\u6c42\u6bd4\u8f83\u9ad8\uff0c\u5bf9\u7279\u6b8a\u7684\u5b57\u6bb5\u8981\u52a0\u5bc6\u3002</li> <li>\u53e6\u5916\u914d\u7f6e\u4e2d\u5fc3\u5728\u901a\u4fe1\u4e0a\u9700\u8981\u91c7\u7528\u53cc\u5411 TLS \u8ba4\u8bc1\uff0c\u4ee5\u4fdd\u8bc1\u4f20\u8f93\u7684\u5b89\u5168\u6027\u3002</li> <li>\u76f8\u5bf9\u800c\u8a00\uff0c\u6ce8\u518c\u4e2d\u5fc3\u5bf9\u5b89\u5168\u6027\u7684\u8981\u6c42\u6bd4\u8f83\u4f4e</li> </ul>"},{"location":"chap1/7chap1_config_center/#2-3","title":"2-3 \u53d8\u66f4\u5ba1\u8ba1","text":"<p>\u6bcf\u4e00\u9879\u914d\u7f6e\u7684\u53d8\u66f4\u90fd\u8981\u6709\u53ef\u8ffd\u8e2a\u7684\u5ba1\u8ba1\u65e5\u5fd7\uff0c\u4ee5\u65b9\u4fbf\u56de\u6eaf\u95ee\u9898\u53d1\u751f\u7684\u539f\u56e0\u3002\u4e00</p> <p>\u822c\u6ce8\u518c\u4e2d\u5fc3\u7684\u7ec4\u4ef6\u4e0d\u4f1a\u63d0\u4f9b\u8fd9\u6837\u7684\u529f\u80fd\uff0c\u4f46\u662f\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5982\u679c\u662f\u4e3b\u52a8\u7684\u53d1\u7248\u6216\u8005\u4fee\u6539\u6743\u91cd\u7b49\u4fe1\u606f\u4e5f\u9700\u8981\u989d\u5916\u6dfb\u52a0\u53ef\u5ba1\u8ba1\u7684\u65e5\u5fd7\u3002</p>"},{"location":"chap1/7chap1_config_center/#2-4","title":"2-4 \u7070\u5ea6\u53d1\u5e03","text":"<p>\u914d\u7f6e\u4e2d\u5fc3\u548c CD \u53d1\u5e03\u7cfb\u7edf\u4e00\u6837\uff0c\u90fd\u9700\u8981\u652f\u6301\u5b8c\u5907\u7684\u7070\u5ea6\u7cfb\u7edf\u3002\u4e00\u822c\u5728\u5b8c\u6574\u7684\u53d1\u5e03\u914d\u7f6e\u524d\uff0c\u90fd\u9700\u8981\u5148\u7070\u5ea6\u4e00\u53f0\u673a\u5668\uff0c\u7136\u540e\u67e5\u770b\u76d1\u63a7\u7cfb\u7edf\u662f\u5426\u6709\u95ee\u9898\u53d1\u751f\uff0c\u518d\u8fdb\u884c\u5168\u91cf\u53d1\u5e03\u3002</p>"},{"location":"chap1/7chap1_config_center/#2-5","title":"2-5 \u53d8\u66f4\u56de\u6eda","text":"<p>\u8fd9\u70b9\u4e5f\u548c CD \u7cfb\u7edf\u4e00\u6837\uff0c\u8981\u5177\u5907\u53d8\u66f4\u56de\u6eda\u80fd\u529b\u3002\u5982\u679c\u6ca1\u6709\u56de\u6eda\u80fd\u529b\uff0c\u4e00\u65e6\u53d8\u66f4\u51fa\u9519\uff0c\u53c8\u6ca1\u6709\u624b\u52a8\u5907\u4efd\u4e0a\u4e00\u4efd\u914d\u7f6e\uff0c\u5c31\u4f1a\u5f15\u53d1\u751f\u4ea7\u4e8b\u6545\u3002\u800c\u5177\u5907\u4e86\u4e00\u952e\u56de\u6eda\u529f\u80fd\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c\u53ef\u4ee5\u907f\u514d\u8fd9\u79cd\u95ee\u9898\u7684\u53d1\u751f\u3002</p>"},{"location":"chap1/7chap1_config_center/#2-6","title":"2-6 \u5f31\u4f9d\u8d56","text":"<p>\u4e00\u822c\u800c\u8a00\uff0c\u901a\u8fc7\u5065\u58ee\u7684 SDK \u8bbe\u8ba1\uff0c\u90fd\u53ef\u4ee5\u505a\u5230\u914d\u7f6e\u4e2d\u5fc3\u7684\u5f31\u4f9d\u8d56\uff0c\u6bd4\u5982\u901a\u8fc7\u6587\u4ef6\u7f13\u5b58\u914d\u7f6e\uff0c\u5373\u4fbf\u914d\u7f6e\u4e2d\u5fc3\u51fa\u73b0\u6545\u969c\uff0c\u4e5f\u4e0d\u5f71\u54cd\u7a0b\u5e8f\u7684\u6b63\u5e38\u542f\u52a8\u548c\u8fd0\u884c\u3002\u4f46\u662f\u5bf9\u4e8e\u6ce8\u518c\u4e2d\u5fc3\u800c\u8a00\u5c31\u6bd4\u8f83\u56f0\u96be\u4e86\uff0c\u5373\u4fbf\u9632\u707e\u96be\u8bbe\u8ba1\u5f97\u518d\u5145\u5206\uff0c\u4e00\u65e6\u53d1\u751f\u6545\u969c\uff0c\u5bf9\u4e1a\u52a1\u4e5f\u4f1a\u6709\u6bd4\u8f83\u5927\u7684\u5f71\u54cd\u3002</p>"},{"location":"chap1/7chap1_config_center/#2-7","title":"2-7 \u6613\u7528\u7684\u56fe\u5f62\u754c\u9762","text":"<p>\u56e0\u4e3a\u914d\u7f6e\u4e2d\u5fc3\u63d0\u4f9b\u4e86\u7070\u5ea6\u53d1\u5e03\u3001\u53d8\u66f4\u56de\u6eda\u7b49\u591a\u79cd\u529f\u80fd\uff0c\u6240\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u6613\u7528\u7684\u56fe\u5f62\u754c\u9762\u662f\u5fc5\u987b\u7684\uff1b\u800c\u6ce8\u518c\u4e2d\u5fc3\u5bf9\u4e8e\u754c\u9762\u7684\u8981\u6c42\u4e00\u822c\u6ca1\u6709\u8fd9\u4e48\u9ad8\u3002</p>"},{"location":"chap1/7chap1_config_center/#3","title":"3\u3001\u914d\u7f6e\u4e2d\u5fc3\u9009\u578b","text":""},{"location":"chap1/7chap1_config_center/#3-1-etcd","title":"3-1 etcd","text":"<p>etcd \u7ecf\u5e38\u88ab\u63a8\u8350\u4f5c\u4e3a\u914d\u7f6e\u4e2d\u5fc3\uff0c\u4f46\u5b9e\u9645\u4e0a\u5b83\u5e76\u4e0d\u9002\u5408\u3002</p> <ul> <li>\u9996\u5148\uff0cetcd \u9ed8\u8ba4\u6709 2G \u7684\u5b58\u50a8\u4e0a\u9650\uff0c\u6570\u636e\u8fbe\u5230\u4e0a\u9650\u540e\u4f1a\u65e0\u6cd5\u5199\u5165\u6570\u636e\uff1b</li> <li> <p>\u53e6\u5916\uff0cetcd \u8bb0\u5f55\u4e86\u6bcf\u6761\u6570\u636e\u591a\u4e2a\u7248\u672c\u7684\u4fe1\u606f\uff0c\u4e5f\u4f1a\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\u3002</p> </li> <li> <p>\u5b9e\u9645\u4e0a\u968f\u7740\u670d\u52a1\u6570\u91cf\u7684\u589e\u591a\uff0c\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\u8fd9\u4e2a\u573a\u666f\uff0c\u5b58\u50a8\u7684\u914d\u7f6e\u91cf\u662f\u6bd4\u8f83\u5927\u7684\u3002</p> </li> <li>etcd \u9664\u4e86\u80fd\u591f\u505a\u5230\u914d\u7f6e\u5b9e\u65f6\u53d8\u66f4\uff0c\u5e76\u6ca1\u6709\u592a\u5927\u7684\u4f18\u52bf\uff0c\u53cd\u800c\u4f1a\u8ba9\u7ef4\u62a4\u6210\u672c\u589e\u52a0\u3002</li> </ul>"},{"location":"chap1/7chap1_config_center/#3-2-apollo","title":"3-2 Apollo","text":"<p>Apollo \u662f\u643a\u7a0b\u7814\u53d1\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c\u63d0\u4f9b\u4e86\u5305\u62ec Java\u3001.Net\u3001PHP\u3001Go \u7b49\u591a\u79cd\u8bed\u8a00\u7684 SDK\u3002\u800c\u4e14\u63d0\u4f9b\u4e86\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u914d\u7f6e\u4e2d\u5fc3\u6240\u9700\u8981\u7684\u591a\u79cd\u529f\u80fd\uff0c\u6bd4\u5982\u591a\u73af\u5883\u3001\u7070\u5ea6\u53d1\u5e03\u3001\u5b9e\u65f6\u63a8\u9001\u3001\u53d8\u66f4\u56de\u6eda\u7b49\u3002</p> <p>\u76f8\u5bf9\u4e8e etcd\uff0cApollo \u662f\u66f4\u5408\u9002\u7684\u914d\u7f6e\u4e2d\u5fc3\u9009\u578b\uff0cApollo \u7684\u540e\u7aef\u5b58\u50a8\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u76f4\u63a5\u7528 MySQL \u4f5c\u4e3a\u540e\u7aef\u5b58\u50a8\uff0c\u5bf9\u4e8e\u8fd0\u7ef4\u6765\u8bf4\uff0c\u4e5f\u66f4\u7b80\u5355\u53ef\u9760\u3002</p>"},{"location":"chap1/7chap1_config_center/#3-3-confd","title":"3-3 Confd","text":"<p>Golang \u5f00\u53d1\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c\u7279\u522b\u4ee5 Agent \u7684\u65b9\u5f0f\u90e8\u7f72\u5728\u673a\u5668\u4e0a\uff0c\u901a\u8fc7\u670d\u52a1\u8fdb\u7a0b\u76d1\u542c\u6587\u4ef6\u53d8\u5316\u4ee5\u8fbe\u5230\u66f4\u65b0\u914d\u7f6e\u7684\u76ee\u7684\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u6613\u4e8e\u63a8\u5e7f\uff0c\u5982\u679c\u5728\u5fae\u670d\u52a1\u7684\u521d\u671f\u6ca1\u6709\u5f15\u5165\u914d\u7f6e\u4e2d\u5fc3\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u6b64\u79cd\u65b9\u5f0f\uff0c\u65e0\u987b\u670d\u52a1\u66f4\u65b0 SDK\uff0c\u53ea\u8981\u5728\u5bbf\u4e3b\u673a\u4e0a\u90e8\u7f72 Agent \u76d1\u542c\u6587\u4ef6\u53d8\u5316\u5c31\u53ef\u4ee5\u4e86\u3002\u53e6\u5916\u5b83\u4e5f\u5f88\u9002\u5408\u5404\u79cd\u5f00\u6e90\u7ec4\u4ef6\uff0c\u6bd4\u5982 Nginx \u7684\u52a8\u6001\u914d\u7f6e\u66f4\u65b0\uff08Ningx \u53ef\u4ee5\u901a\u8fc7 reload \u6216\u8005 kill -HUP \u7684\u65b9\u5f0f\u52a8\u6001\u66f4\u65b0\u914d\u7f6e\uff09\u3002</p> <p>\u53e6\u5916 Confd \u63d0\u4f9b\u4e86\u591a\u79cd\u914d\u7f6e\u5b58\u50a8\u65b9\u6848\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u573a\u666f\u8fdb\u884c\u9009\u62e9\u3002\u4f46 Confd \u5e76\u6ca1\u6709\u63d0\u4f9b\u56fe\u5f62\u754c\u9762\uff0c\u5982\u679c\u8981\u4f7f\u7528\uff0c\u8fd8\u662f\u9700\u8981\u4e8c\u6b21\u5f00\u53d1\u7684\u3002</p>"},{"location":"chap1/7chap1_config_center/#3-4","title":"3-4 \u81ea\u7814","text":"<p>\u914d\u7f6e\u4e2d\u5fc3\u4f5c\u4e3a\u5fae\u670d\u52a1\u7684\u7ec4\u4ef6\uff0c\u5b9e\u9645\u4e0a\u9700\u6c42\u53d8\u5316\u5e76\u4e0d\u662f\u7279\u522b\u591a\uff0c\u57fa\u672c\u4e0a KV \u7684\u7b80\u5355\u5b58\u50a8\u3001\u5b9e\u65f6\u53d8\u66f4\u5c31\u53ef\u4ee5\u6ee1\u8db3\u9700\u6c42\u4e86\uff0c\u6240\u4ee5\u5efa\u8bae\u9009\u7528\u5f00\u6e90\u7684\u914d\u7f6e\u4e2d\u5fc3\u65b9\u6848\uff0c\u5982\u679c\u6709\u7279\u6b8a\u9700\u6c42\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\u5373\u53ef\u3002</p>"},{"location":"chap1/7chap1_config_center/#4","title":"4\u3001\u914d\u7f6e\u4e2d\u5fc3\u4e2d\u7684\u5b9e\u65f6\u53d8\u66f4","text":"<p>\u914d\u7f6e\u4e2d\u5fc3\u4e2d\u7684\u5b9e\u65f6\u53d8\u66f4\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002</p>"},{"location":"chap1/7chap1_config_center/#4-1-watch","title":"4-1 \u957f\u8fde\u63a5 watch","text":"<p>\u4f7f\u7528\u539f\u751f TCP \u81ea\u5b9a\u4e49\u534f\u8bae\uff0c\u6216\u8005\u76f4\u63a5\u91c7\u7528 gRPC \u534f\u8bae\uff0c\u90fd\u53ef\u4ee5\u5b9e\u73b0 watch \u7684\u529f\u80fd\u3002\u5f53\u914d\u7f6e\u6570\u636e\u53d1\u751f\u53d8\u5316\u7684\u65f6\u5019\uff0c\u4e3b\u52a8\u63a8\u9001\u6d88\u606f\u5230 SDK\u3002\u6bd4\u5982 etcd \u5c31\u662f\u91c7\u7528\u4e86 gRPC watch \u7684\u65b9\u5f0f\u3002</p>"},{"location":"chap1/7chap1_config_center/#4-2-http","title":"4-2 HTTP \u957f\u8f6e\u8be2","text":"<p>\u56e0\u4e3a HTTP \u534f\u8bae\u7684\u901a\u7528\u6027\u8f83\u597d\uff0c\u800c\u4e14\u5927\u5bb6\u5bf9 HTTP \u534f\u8bae\u4e5f\u76f8\u5bf9\u719f\u6089\uff0c\u6240\u4ee5\u5f88\u591a\u5f00\u6e90\u7ec4\u4ef6\u5728\u5b9e\u73b0\u63a8\u9001\u529f\u80fd\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u9009\u62e9\u957f\u8f6e\u8be2\uff0c\u4e5f\u5c31\u662f Long Polling\u3002\u50cf Apollo\u3001Consul \u90fd\u91c7\u7528\u4e86\u957f\u8f6e\u8be2\u7684\u65b9\u6848\u6765\u5b9e\u73b0\u63a8\u9001\u529f\u80fd\u3002</p> <p>\u957f\u8f6e\u8be2\u7684\u5b9e\u73b0\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u5ba2\u6237\u7aef\u901a\u8fc7 KeepAlive \u7684\u65b9\u5f0f\u8fde\u63a5\u670d\u52a1\u5668\u7aef\uff0c\u670d\u52a1\u7aef\u963b\u585e\u8fde\u63a5\u76f4\u5230\u6709\u53d8\u5316\u6216\u8005\u8d85\u65f6(\u9ed8\u8ba4\u4e00\u822c 60s)\u624d\u8fd4\u56de\u6570\u636e\uff0c\u901a\u8fc7\u6b64\u79cd\u65b9\u5f0f\u5b9e\u73b0\u7c7b\u4f3c\u957f\u8fde\u63a5\u7684 watch \u65b9\u5f0f\u3002</p>"},{"location":"chap1/7chap1_config_center/#4-3","title":"4-3 \u5b9a\u65f6\u540c\u6b65","text":"<p>\u5b9a\u65f6\u540c\u6b65\u7684\u65b9\u5f0f\u5219\u66f4\u52a0\u7b80\u5355\uff0c\u901a\u8fc7 HTTP \u65b9\u5f0f\u5b9a\u65f6\u8bf7\u6c42\u540e\u7aef\u63a5\u53e3\uff0c\u5bf9\u6bd4\u4e24\u6b21\u6570\u636e\u662f\u5426\u4ea7\u751f\u53d8\u5316\uff0c\u5982\u679c\u4ea7\u751f\u53d8\u5316\u5219\u66f4\u65b0\u914d\u7f6e\u3002</p>"},{"location":"chap1/7chap1_config_center/#4-4-watch","title":"4-4 watch+\u5b9a\u65f6\u8f6e\u8be2","text":"<p>\u4e3a\u4e86\u9632\u6b62 watch \u6570\u636e\u56e0\u4e3a\u5f02\u5e38\u6f0f\u6389\u4e86\u63a8\u9001\u7684\u6570\u636e\u53d8\u5316\uff0c\u901a\u5e38\u4f1a\u91c7\u7528\u63a8\u62c9\u7ed3\u5408\u7684\u65b9\u5f0f\uff0c\u4e5f\u662fwatch+\u5b9a\u65f6\u8f6e\u8be2\u7684\u65b9\u5f0f\u3002\u5b9e\u73b0\u65b9\u5f0f\u5176\u5b9e\u5c31\u662f\u4e0a\u9762\u8bb2\u5230\u7684\u957f\u8fde\u63a5 watch \u548c\u5b9a\u65f6\u540c\u6b65\u76f8\u7ed3\u5408\u3002</p>"},{"location":"chap1/7chap1_config_center/#5service-mesh","title":"5\u3001Service Mesh \u65f6\u4ee3\u7684\u914d\u7f6e\u4e2d\u5fc3","text":"<p>\u5fae\u670d\u52a1\u67b6\u6784\u7684\u53d1\u5c55\uff0c\u5bf9\u914d\u7f6e\u4e2d\u5fc3\u63d0\u51fa\u4e86\u66f4\u9ad8\u7684\u8981\u6c42\uff0c\u9664\u4e86\u4f20\u7edf\u7684\u63d0\u4f9b\u670d\u52a1\u914d\u7f6e\u7684\u4fee\u6539\uff0c\u4e5f\u5e0c\u671b\u914d\u7f6e\u4e2d\u5fc3\u80fd\u591f\u63d0\u4f9b Service Mesh \u4e2d\u63a7\u5236\u9762\u7684\u6570\u636e\u7ba1\u7406\u529f\u80fd</p>"},{"location":"chap1/7chap1_config_center/#5-1","title":"5-1 \u670d\u52a1\u6cbb\u7406\u96c6\u4e2d\u914d\u7f6e","text":"<p>\u5bf9\u4e8e\u4f20\u7edf\u7684\u914d\u7f6e\u4e2d\u5fc3\u6765\u8bf4\uff0c\u8fd8\u662f\u6bcf\u4e2a\u670d\u52a1\u7ba1\u63a7\u81ea\u5df1\u7684\u914d\u7f6e\uff0c\u8fd9\u4e9b\u914d\u7f6e\u6587\u4ef6\u7684\u5b9a\u4e49\u53ef\u80fd\u5343\u5947\u767e\u602a\uff0c\u6bd4\u5982 a \u670d\u52a1\u7684\u9650\u6d41\u914d\u7f6e\u53ef\u80fd\u53eb\u4f5c Limit\uff0cb \u670d\u52a1\u53eb\u4f5c RateLimit\uff0c\u8fd9\u4e9b\u914d\u7f6e\u5747\u7531\u6bcf\u4e2a\u670d\u52a1\u72ec\u81ea\u8d1f\u8d23\uff0c\u5e76\u4e0d\u5173\u5fc3\u5176\u4ed6\u670d\u52a1\u3002\u4f46\u662f\u5bf9\u4e8e\u670d\u52a1\u6cbb\u7406\u6765\u8bf4\uff0c\u5f88\u591a\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u96c6\u4e2d\u7ba1\u63a7\u8fd9\u4e9b\u6570\u636e\uff0c\u6240\u4ee5\u8981\u628a\u7cfb\u7edf\u5c42\u9762\u7684\u914d\u7f6e\u62bd\u8c61\u51fa\u6765\uff0c\u5f62\u6210\u7edf\u4e00\u7684\u6570\u636e\u7ed3\u6784\u63d0\u4f9b\u63a7\u5236\u9762\u4f7f\u7528\u3002</p> <p>\u914d\u7f6e\u4e2d\u5fc3\u4e0d\u4ec5\u9700\u8981\u611f\u77e5\u81ea\u8eab\u914d\u7f6e\u7684\u53d8\u5316\uff0c\u4e5f\u9700\u8981\u611f\u77e5\u88ab\u8c03\u670d\u52a1\u7684\u53d8\u5316\u3002</p>"},{"location":"chap1/7chap1_config_center/#5-2","title":"5-2 \u5e73\u53f0\u5316","text":"<p>\u968f\u7740\u670d\u52a1\u6570\u91cf\u8d8a\u6765\u8d8a\u591a\uff0c\u670d\u52a1\u6cbb\u7406\u529f\u80fd\u88ab\u62bd\u8c61\u51fa\u6765\uff0c\u56e0\u6b64\u9700\u8981\u4e00\u4e2a\u5fae\u670d\u52a1\u6cbb\u7406\u5e73\u53f0\u7ba1\u7406\u6240\u6709\u670d\u52a1\u7684\u670d\u52a1\u6cbb\u7406\u914d\u7f6e\uff0c\u800c\u4e0d\u662f\u50cf\u4ee5\u524d\u4e00\u6837\u628a\u914d\u7f6e\u6563\u843d\u5728\u5404\u4e2a\u670d\u52a1\u4e2d\u3002</p> <p>\u6709\u4e86\u8fd9\u6837\u4e00\u4e2a\u5e73\u53f0\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba9 SRE \u4ecb\u5165\u670d\u52a1\u7684\u7ef4\u62a4\u4e2d\u5fc3\uff0c\u5728\u670d\u52a1\u51fa\u73b0\u95ee\u9898\u7684\u65f6\u5019\uff0c\u901a\u8fc7\u670d\u52a1\u6cbb\u7406\u624b\u6bb5\uff0c\u6bd4\u5982\u9650\u6d41\u3001\u7194\u65ad\u3001\u964d\u7ea7\uff0cSRE \u53ef\u4ee5\u901a\u8fc7\u5e73\u53f0\u76f4\u63a5\u64cd\u4f5c\uff0c\u4ee5\u964d\u4f4e\u6545\u969c\u7684\u5f71\u54cd\u9762\u548c\u4e8b\u6545\u7b49\u7ea7\u3002</p> <p> </p>"},{"location":"chap1/8chap1_trace/","title":"\u7b2c\u516b\u8282 Trace \u66f4\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898","text":""},{"location":"chap1/8chap1_trace/#1","title":"1\u3001\u53ef\u89c2\u6d4b\u6027","text":"<p>\u63d0\u4f9b\u53ef\u89c2\u6d4b\u6027\u529f\u80fd\u7684\u7ec4\u4ef6 Trace\u3002</p> <p>\u65e9\u671f\u7cfb\u7edf\u67b6\u6784\u57fa\u672c\u662f\u901a\u8fc7\u65e5\u5fd7\u7ec4\u4ef6\u6765\u89c2\u5bdf\u670d\u52a1\u7684\u5f02\u5e38\u60c5\u51b5\uff0c\u800c\u5728\u4e91\u539f\u751f\u6a21\u5f0f\u4e0b\uff0c\u94fe\u8def\u8ffd\u8e2a\u3001Metrics \u548c\u65e5\u5fd7\u4e09\u8005\u7ec4\u6210\u4e86\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u3002</p> <p>\u5728\u5fae\u670d\u52a1\u548c Service Mesh \u67b6\u6784\u4e2d\uff0c\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u7684\u4f4d\u7f6e\u53d8\u5f97\u8d8a\u6765\u8d8a\u91cd\u8981\uff0c\u4e00\u822c\u4f5c\u4e3a\u9ed8\u8ba4\u7ec4\u4ef6\u96c6\u6210\u5728\u65b9\u6848\u4e2d\u3002</p> <p>\u53ef\u89c2\u6d4b\u6027\u662f\u901a\u8fc7\u7cfb\u7edf\u8f93\u51fa\u4fe1\u606f\u5230\u5916\u90e8\uff0c\u4ee5\u68c0\u6d4b\u7cfb\u7edf\u5185\u90e8\u7684\u8fd0\u884c\u72b6\u6001\u3002\u6bd4\u5982\u6211\u4eec\u8fd9\u4e00\u8bb2\u4e2d\u7684Trace\uff0c\u901a\u8fc7\u5185\u90e8\u6253\u70b9\u7684\u65b9\u5f0f\u4e32\u8054\u8d77\u5fae\u670d\u52a1\u7684\u5404\u4e2a\u7ec4\u4ef6\u3002Metrics\uff0c\u901a\u8fc7\u8f93\u51fa\u670d\u52a1\u7684 Metrics \u4fe1\u606f\uff0c\u8fbe\u5230\u5916\u90e8\u76d1\u6d4b\u7684\u76ee\u7684\u3002</p> <p>\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u4e3b\u8981\u6709\u5982\u4e0b\u4e09\u79cd\uff1a\u94fe\u8def\u8ffd\u8e2a\u3001\u76d1\u63a7\u6307\u6807\u3001\u65e5\u5fd7\u3002</p> <p> </p> <ul> <li>\u94fe\u8def\u8ffd\u8e2a\uff1a\u901a\u8fc7\u5728\u7a0b\u5e8f\u5185\u6253\u70b9\u8bb0\u5f55\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u8bb0\u5f55\u6bcf\u6b21\u8bf7\u6c42\u7684\u8c03\u7528\u94fe\u8def\u4fe1\u606f\u3002\u7279\u70b9\u662f\u6570\u636e\u7cbe\u51c6\u3001\u7ec6\u81f4\uff0c\u9002\u5408\u67e5\u770b\u67d0\u4e00\u6b21\u8bf7\u6c42\u7684\u8c03\u7528\u94fe\u8def\uff0c\u4e00\u822c\u7528\u4e8e\u67e5\u770b\u67d0\u4e9b\u54cd\u5e94\u8f83\u6162\u7684\u63a5\u53e3\u74f6\u9888\u3002</li> <li>\u76d1\u63a7\u6307\u6807\uff1a\u4e3b\u8981\u662f\u7528\u65f6\u5e8f\u6027\u6570\u636e\u5e93\u8bb0\u5f55\u6bcf\u4e2a\u65f6\u95f4\u70b9\u7684\u76d1\u63a7\u6570\u636e\uff0c\u4e00\u822c\u901a\u8fc7\u4e3b\u52a8\u62c9\u53d6\u670d\u52a1 Metrics \u6570\u636e\u7684\u65b9\u5f0f\u8bb0\u5f55\uff0c\u7136\u540e\u5b9e\u65f6\u8ba1\u7b97\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e\uff0c\u5e76\u901a\u8fc7\u56fe\u5f62\u754c\u9762\u7684\u65b9\u5f0f\u5c55\u73b0\u51fa\u6765\u3002\u5b83\u7684\u7279\u70b9\u662f\u5b9e\u65f6\u6027\u5f3a\u3001\u53ef\u89c2\u6d4b\u6307\u6807\u4e30\u5bcc\uff0c\u9002\u5408\u67e5\u770b\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6307\u6807\u8d8b\u52bf\u3002</li> <li>\u65e5\u5fd7\uff1a\u65e5\u5fd7\u662f\u6bd4\u8f83\u4f20\u7edf\u7684\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u4e86\u3002 \u65e5\u5fd7\u7684\u7279\u70b9\u662f\u6570\u636e\u6bd4\u8f83\u79bb\u6563\uff0c\u4e4b\u95f4\u6ca1\u6709\u5173\u8054\u3002\u5f53\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u65e5\u5fd7\u4e2d\u6253\u5370 TraceId\u00a0\u548c\u94fe\u8def\u8ffd\u8e2a\u5173\u8054\u8d77\u6765\u3002\u4e00\u822c\u65e5\u5fd7\u8981\u901a\u8fc7\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\u4f7f\u7528\uff0c\u6bd4\u5982\u5e38\u89c1\u7684 ELK \u65e5\u5fd7\u7cfb\u7edf\u3002</li> </ul>"},{"location":"chap1/8chap1_trace/#2","title":"2\u3001\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u7684\u91cd\u8981\u6027","text":"<ul> <li>\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u968f\u7740\u670d\u52a1\u548c\u4e2d\u95f4\u4ef6\u6570\u91cf\u53d8\u591a\uff0c\u5f80\u5f80\u4e00\u4e2a\u63a5\u53e3\u8981\u8bf7\u6c42\u51e0\u5341\u6b21\u670d\u52a1\u548c\u4e0a\u767e\u6b21 DB\u00a0\u624d\u80fd\u8fd4\u56de\u6570\u636e\uff0c\u94fe\u8def\u8fc7\u957f\uff0c\u5f88\u96be\u5b9a\u4f4d\u5230\u5e95\u662f\u54ea\u4e2a\u73af\u8282\u51fa\u4e86\u95ee\u9898\uff1b</li> <li>\u53c8\u6216\u8005\u67d0\u4e2a\u63a5\u53e3\u5ef6\u65f6\u8fc7\u9ad8\uff0c\u4e5f\u5f88\u96be\u6392\u67e5\u5230\u5e95\u662f\u94fe\u8def\u4e2d\u7684\u54ea\u4e2a\u73af\u8282\u51fa\u4e86\u95ee\u9898\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u5e2e\u5fd9\u4e86\u3002</li> </ul>"},{"location":"chap1/8chap1_trace/#3trace","title":"3\u3001Trace \u94fe\u8def\u8ffd\u8e2a\u539f\u7406","text":"<p>\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u57fa\u672c\u6e90\u4e8e\u00a0Google \u7684\u4e00\u7bc7\u00a0Dapper \u8bba\u6587\uff0c\u8fd9\u7bc7\u8bba\u6587\u8be6\u7ec6\u89e3\u91ca\u4e86\u94fe\u8def\u8ffd\u8e2a\u7684\u5b9e\u73b0\u539f\u7406\u3002</p> <p>Dapper \u901a\u8fc7\u4e00\u4e2a\u5168\u5c40\u552f\u4e00\u7684 TraceId \u8868\u793a\u8bf7\u6c42\u8c03\u7528\u94fe\uff0c\u5e76\u5b9a\u4e49\u4e86 span\uff0cspan \u8868\u793a\u4e00\u6b21\u8c03\u7528\uff08\u53ef\u4ee5\u662f\u8fdc\u7a0b\u8c03\u7528\uff0c\u4e5f\u53ef\u4ee5\u7a0b\u5e8f\u5185\u7684\u51fd\u6570\u8c03\u7528\uff09\u3002</p> <p>\u6bcf\u4e2a span \u5305\u542b\u4e86\u4e24\u4e2a\u91cd\u8981\u4fe1\u606f\uff0c\u4e00\u4e2a\u662f\u5f53\u524d\u00a0SpanId\uff0c\u53e6\u5916\u4e00\u4e2a\u5c31\u662f ParentSpanId\u3002</p> <p> </p>"},{"location":"chap1/8chap1_trace/#3-1-trace","title":"3-1 Trace \u6240\u9700\u7684\u4fe1\u606f\u4f20\u9012\u7ed9\u88ab\u8c03\u65b9\u670d\u52a1","text":"<p>\u901a\u8fc7 HTTP\u00a0\u7684 header \u5934\u4f20\u9012\u4e0b\u53bb\uff0c\u5f53\u7136\u5982\u679c\u662f\u5176\u4ed6\u534f\u8bae\uff0c\u6bd4\u5982 Dubbo\uff0c\u5c31\u8981\u60f3\u5176\u4ed6\u529e\u6cd5\u4e86\u3002\u4f46 gRPC\u00a0\u548c HTTP\u00a0\u76f8\u5bf9\u7b80\u5355\uff0c\u53ea\u8981\u901a\u8fc7 header \u4f20\u9012\u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b\u8fd9\u4e9b header \u503c\u7684\u542b\u4e49\u3002</p> <ul> <li><code>X-Request-ID</code>\uff1a\u8bf7\u6c42 ID\uff0c\u4e00\u822c Sidecar \u4f1a\u5728\u5165\u53e3\u5c42\u751f\u6210\u7edf\u4e00\u7684\u8bf7\u6c42 ID\uff0c\u7528\u4e8e\u4e00\u6b21\u8bf7\u6c42\u5728\u5185\u90e8\u670d\u52a1\u4e4b\u95f4\u4f20\u9012\uff0c\u65b9\u4fbf\u901a\u8fc7\u8bf7\u6c42 ID\u00a0\u67e5\u8be2\u4e00\u6b21\u8bf7\u6c42\u7684\u6240\u6709\u65e5\u5fd7\u3002</li> <li><code>X-B3-TraceId</code>\uff1a\u94fe\u8def\u8ffd\u8e2a\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u957f\u5ea6\u4e3a\u00a0\u00a064 \u4f4d\u3002\u7531\u7f51\u5173\u5c42\u751f\u6210\uff0c\u4e00\u6b21\u5916\u90e8\u8bf7\u6c42\u4f7f\u7528\u552f\u4e00\u7684 TraceId \u3002</li> <li><code>X-B3-SpanId</code>\uff1aSpanId \u7684\u957f\u5ea6\u662f 64 \u4f4d\uff0c\u8868\u793a\u5f53\u524d\u64cd\u4f5c\u5728\u8ddf\u8e2a\u6811\u4e2d\u7684\u4f4d\u7f6e\u3002</li> <li><code>X-B3-ParentSpanId</code>\uff1a\u7236 SpanId\uff0c\u5982\u679c\u8be5\u503c\u4e0d\u5b58\u5728\uff0c\u8868\u793a\u662f\u6839\u8282\u70b9\u3002</li> <li><code>X-B3-Sampled</code>\uff1a\u91c7\u6837\u7387\uff0c\u5f53\u8bbe\u7f6e\u4e3a 1 \u65f6\uff0c\u8868\u793a\u91c7\u6837\u3002</li> </ul> <p>\u4e00\u4e2a Trace \u7684\u771f\u5b9e\u6570\u636e</p> <pre><code>{\"duration\":2065,\"operationName\":\"/ping\",\"parentSpanID\":\"0\",\"process.serviceName\":\"negri.sidecarserverlistener.myapp\",\"process.tags.hostname\":\"MacBook-Pro-3.local\",\"process.tags.ip\":\"192.168.1.88\",\"spanID\":\"5f1db306ef459b2f\",\"startTime\":1609241265147010,\"tags.http.method\":\"GET\",\"tags.http.status_code\":\"200\",\"tags.http.url\":\"/ping\",\"tags.peer.address\":\"http://127.0.0.1:8888\",\"tags.span.kind\":\"server\",\"traceID\":\"5f1db306ef459b2f\"}\n</code></pre> <p>\u63a5\u53e3\u7684\u8fd0\u884c\u65f6\u95f4 duration\uff0c\u8bb0\u5f55\u4e86\u670d\u52a1\u540d\u3001TraceId\u3001SpanId\u3001ParentSpanId \u7b49\u4e0a\u9762\u6211\u4eec\u804a\u5230\u7684\u5e38\u7528\u6570\u636e\uff0c\u53e6\u5916\u8fd8\u8bb0\u5f55\u4e86\u6211\u4eec\u6240\u9700\u8981\u7684\u4e00\u4e9b\u81ea\u5b9a\u4e49\u6570\u636e\uff0c\u653e\u5728\u4e86 Tags \u5b57\u6bb5\u4e2d\u3002</p> <p>\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u901a\u8fc7\u6536\u96c6\u7a0b\u5e8f\u4e2d\u7684\u6253\u70b9\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u901a\u5e38\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u529f\u80fd\u3002</p> <ul> <li>\u6392\u67e5\u6839\u56e0\uff1a\u5206\u6790\u5355\u6b21\u8bf7\u6c42\u7684\u8c03\u7528\u94fe\u8def\uff0c\u6392\u67e5\u95ee\u9898\u6839\u56e0\u3002</li> <li>\u8c03\u7528\u5173\u7cfb\u56fe\uff1a\u901a\u8fc7 Trace \u4e2d\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u7ed8\u5236\u670d\u52a1\u8c03\u7528\u5173\u7cfb\u56fe\u3002</li> <li>\u65e5\u5fd7\u8ffd\u8e2a\uff1a\u901a\u8fc7\u5173\u8054\u65e5\u5fd7 RequestId\uff0c\u53ef\u4ee5\u94fe\u63a5\u5230\u65e5\u5fd7\u7cfb\u7edf\uff0c\u67e5\u770b\u66f4\u8be6\u7ec6\u7684\u65e5\u5fd7\u4fe1\u606f\u3002</li> </ul> <p> </p>"},{"location":"chap1/8chap1_trace/#4","title":"4\u3001\u5e38\u89c1\u7684\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf","text":""},{"location":"chap1/8chap1_trace/#4-1-zipkin","title":"4-1 Zipkin","text":"<p>Zipkin\u662f Twitter \u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u5c5e\u4e8e\u6bd4\u8f83\u65e9\u7684 Trace \u7cfb\u7edf\uff0c\u5bf9 PHP\u3001Golang\u3001Java \u90fd\u6709\u4e0d\u9519\u7684\u652f\u6301\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u5957 Web \u56fe\u5f62\u5316\u754c\u9762\uff0c\u4f9b\u7528\u6237\u67e5\u770b\u5355\u6761\u94fe\u8def\u4fe1\u606f\uff0c\u4e5f\u63d0\u4f9b\u4e86\u67e5\u770b\u8c03\u7528\u5173\u7cfb\u56fe\u7684\u529f\u80fd\u3002</p> <p> </p>"},{"location":"chap1/8chap1_trace/#4-2-jaeger","title":"4-2 Jaeger","text":"<p>Jaeger \u662f Uber \u516c\u53f8\u5f00\u6e90\u7684\u3001\u91c7\u7528 Go \u8bed\u8a00\u5f00\u53d1\u7684\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u7531\u4ee5\u4e0b\u51e0\u4e2a\u6a21\u5757\u7ec4\u6210\u3002</p> <ul> <li>jaeger-client\uff1aJaeger \u63d0\u4f9b\u7684\u7b26\u5408 OpenTracing \u6807\u51c6\u7684\u5404\u79cd\u8bed\u8a00\u7684 SDK\uff0c\u5305\u62ec Java\u3001Go\u3001Node.js \u7b49\u3002Client \u8d1f\u8d23\u6536\u96c6 Trace \u6570\u636e\u53d1\u9001\u5230 Agent\u3002</li> <li>jaeger-agent\uff1ajaeger-client \u7684\u4ee3\u7406\u7a0b\u5e8f\uff0c\u90e8\u7f72\u5728\u6240\u6709\u5bbf\u4e3b\u673a\u4e0a\uff0c\u8fd9\u6837\u7684\u76ee\u7684\u548c Sidecar \u7c7b\u4f3c\uff0c\u5c4f\u853d\u4e86\u4e00\u4e9b\u8def\u7531\u548c Collector \u8282\u70b9\u53d1\u73b0\u7684\u7ec6\u8282\uff0c\u8ba9 Client \u66f4\u52a0\u8f7b\u91cf\u5316\u3002Client \u901a\u8fc7 UDP \u534f\u8bae\u548c Agent \u901a\u4fe1\uff0c\u4e5f\u907f\u514d\u4e86\u65e5\u5fd7\u843d\u76d8\u518d\u91c7\u96c6\u5bfc\u81f4\u7684\u4e00\u4e9b\u6027\u80fd\u95ee\u9898\u3002</li> <li>jaeger-collector\uff1a\u8d1f\u8d23\u6536\u96c6 Agent \u4e0a\u62a5\u7684\u94fe\u8def\u8ffd\u8e2a\u6570\u636e\uff0c\u5e76\u505a\u4e00\u4e9b\u6570\u636e\u9a8c\u8bc1\u5de5\u4f5c\uff0c\u4ee5\u53ca\u5bf9\u6570\u636e\u505a\u4e00\u4e9b\u5904\u7406\u7136\u540e\u4e0a\u62a5\u5230\u5b58\u50a8\u7cfb\u7edf\u3002</li> <li>jaeger-db\uff1a\u540e\u7aef\u5b58\u50a8\u7cfb\u7edf\uff0c\u652f\u6301 Cassandra \u548c ElasticSearch\u3002</li> <li>jaeger-query\uff1a\u4e13\u95e8\u8d1f\u8d23\u8c03\u7528\u94fe\u67e5\u8be2\u7684\u4e00\u4e2a\u670d\u52a1\uff0c\u63d0\u4f9b\u4e00\u5957\u72ec\u7acb\u7684 UI \u754c\u9762\uff0c\u7528\u4e8e\u7ed8\u5236\u8c03\u7528\u5173\u7cfb\u548c\u5c55\u793a\u670d\u52a1\u94fe\u8def\u3002</li> <li>spark-job\uff1a\u57fa\u4e8e Spark \u7684\u8fd0\u7b97\u4efb\u52a1\uff0c\u53ef\u4ee5\u8ba1\u7b97\u670d\u52a1\u7684\u4f9d\u8d56\u5173\u7cfb\u3001\u8c03\u7528\u6b21\u6570\u7b49\u3002</li> </ul> <p> </p>"},{"location":"chap1/8chap1_trace/#5trace","title":"5\u3001Trace \u7cfb\u7edf\u4e2d\u7684\u5e38\u89c1\u95ee\u9898","text":""},{"location":"chap1/8chap1_trace/#5-1-traceid","title":"5-1 TraceId \u5982\u4f55\u8bbe\u8ba1","text":"<p>TraceId \u53ea\u8981\u5168\u5c40\u552f\u4e00\u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u53c2\u8003 SOFATrace \u4e2d\u7684\u8bbe\u8ba1\uff0c\u901a\u8fc7 8 \u4f4d\u7684 IP \u5730\u5740\u548c 13 \u4f4d\u7684\u65f6\u95f4\u6233\uff0c\u4ee5\u53ca\u56db\u4f4d\u7684\u81ea\u589e\u5e8f\u5217\uff0c\u52a0\u4e0a\u672c\u8eab\u8fdb\u7a0b\u7684 PID \u53f7\uff0c\u8fd9\u6837\u7ec4\u6210\u7684\u5b57\u7b26\u4e32\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u5168\u5c40\u552f\u4e00\u4e86\u3002</p> <p> </p>"},{"location":"chap1/8chap1_trace/#5-2-trace","title":"5-2 Trace \u65e5\u5fd7\u843d\u76d8","text":"<p>\u963f\u91cc\u4e91\u63d0\u4f9b\u7684 sls \u4f5c\u4e3a\u94fe\u8def\u8ffd\u8e2a\u7684\u5b58\u50a8\u7cfb\u7edf</p> <p>\u7528 SDK \u5c06\u6570\u636e\u76f4\u63a5\u843d\u76d8\uff0c\u4ee5\u65e5\u5fd7\u7684\u65b9\u5f0f\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\uff0c\u7136\u540e\u7531 Logtail \u5c06\u65e5\u5fd7\u6536\u96c6\u5230 sls\uff0c\u4f46\u662f\u8fd9\u6837\u5c31\u4ea7\u751f\u4e86\u65e5\u5fd7\u5199\u76d8\u7684\u6027\u80fd\u95ee\u9898\u3002</p> <p>\u5982\u679c\u6bcf\u6761\u65e5\u5fd7\u90fd\u76f4\u63a5\u843d\u76d8\uff0c\u90a3\u4e48\u7cfb\u7edf\u7684 IO \u6d88\u8017\u4f1a\u975e\u5e38\u5927\uff0c\u6240\u4ee5\u5b9e\u8df5\u4e2d\u6211\u91c7\u7528\u4e86\u5f02\u6b65\u843d\u76d8\u7684\u673a\u5236\uff0c\u51cf\u5c11\u5bf9\u4e1a\u52a1\u8bf7\u6c42\u7684\u5f71\u54cd\uff0c\u4e5f\u540c\u65f6\u51cf\u5c11\u4e86\u7cfb\u7edf\u8c03\u7528\u548c\u7cfb\u7edf IO \u7684\u6d88\u8017\u3002</p>"},{"location":"chap1/8chap1_trace/#5-3-service-mesh-trace","title":"5-3 Service Mesh \u4e2d\u53ef\u4ee5\u65e0\u611f\u77e5\u63a5\u5165 Trace \u5417\uff1f","text":"<p>\u5b9e\u9645\u4e0a\u56e0\u4e3a Service Mesh \u7ecf\u5e38\u5ba3\u4f20\u65e0\u4fb5\u5165\u7684\u63a5\u5165\u65b9\u5f0f\uff0c\u8fd9\u5757\u9020\u6210\u4e86\u4e00\u5b9a\u7684\u8bef\u89e3\uff0c\u65e9\u671f Istio \u6587\u6863\u63cf\u8ff0\u5f97\u4e5f\u4e0d\u662f\u5f88\u6e05\u695a\uff0c\u4f46\u540e\u9762\u7684 Istio \u6587\u6863\u505a\u4e86\u66f4\u6b63\uff0c\u5728 Service Mesh \u4e2d\u53ea\u8981\u5c11\u91cf\u4ee3\u7801\u5c31\u53ef\u4ee5\u63a5\u5165 Trace \u4e86\u3002</p> <p>Sidecar \u4f9d\u7136\u4f9d\u8d56\u5e94\u7528\u7a0b\u5e8f\u4f20\u9012 Trace \u6240\u9700\u8981\u7684 header\uff0c\u4f46\u901a\u8fc7 Sidecar \u53ef\u4ee5\u7b80\u5316 Trace \u7684\u63a5\u5165\uff0cTrace SDK \u53ea\u8981\u4fdd\u8bc1\u80fd\u591f\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684 Trace header \u5728\u6bcf\u6b21\u8bf7\u6c42\u4e2d\u4f20\u9012\u4e0b\u53bb\u5c31\u53ef\u4ee5\u4e86\uff0c\u800c\u4e0d\u7528\u8d1f\u8d23\u7e41\u91cd\u7684\u6570\u636e\u4e0a\u62a5\u5de5\u4f5c\u3002\u4f46\u5982\u679c\u9664\u4e86\u670d\u52a1\u7684\u94fe\u8def\u4fe1\u606f\uff0c\u8fd8\u5e0c\u671b\u6536\u96c6\u4e00\u4e9b DB \u4e2d\u95f4\u4ef6\u7684\u8c03\u7528\u4fe1\u606f\uff0c\u6570\u636e\u4e0a\u62a5\u7684\u5de5\u4f5c\u8fd8\u662f\u65e0\u6cd5\u907f\u514d\u7684\u3002</p>"},{"location":"chap1/8chap1_trace/#5-4-trace","title":"5-4 Trace \u7ec4\u4ef6\u5982\u4f55\u5728\u9879\u76ee\u4e2d\u843d\u5730\uff1f","text":"<p>\u5bf9\u4e00\u4e9b\u8bed\u8a00\u6765\u8bf4\uff0c\u4fb5\u5165\u6027\u6bd4\u8f83\u5f3a\u662f\u6700\u5927\u7684\u75db\u70b9\u3002\u5bf9\u4e8e Java  \u76f8\u5bf9\u6765\u8bf4\u6bd4\u8f83\u5bb9\u6613\uff0c\u53ef\u4ee5\u901a\u8fc7 Java Agent \u65e0\u611f\u77e5\u5730\u63a5\u5165\uff0c\u4f46\u5bf9\u4e8e\u5176\u4ed6\u8bed\u8a00\u5c31\u6ca1\u90a3\u4e48\u5bb9\u6613\u4e86\u3002</p> <p>\u6bd4\u5982 PHP\u3001Go\u3001Node.js \u7b49\u8bed\u8a00\uff0c\u90fd\u9700\u8981\u901a\u8fc7 SDK \u7684\u65b9\u5f0f\u63a5\u5165\u3002\u5982\u679c\u662f\u5728\u5fae\u670d\u52a1\u62c6\u5206\u7684\u4e2d\u540e\u671f\uff0c\u60f3\u8981\u518d\u589e\u52a0 Trace \u7cfb\u7edf\u5c31\u5341\u5206\u56f0\u96be\u4e86\uff0c\u6240\u4ee5\u8fd9\u91cc\u5efa\u8bae\u5728\u51b3\u5b9a\u4f7f\u7528\u5fae\u670d\u52a1\u67b6\u6784\u7684\u521d\u671f\uff0c\u5728\u6846\u67b6\u5185\u96c6\u6210 Trace SDK\uff0c\u5e76\u9ed8\u8ba4\u5f00\u542f\uff0c\u514d\u53bb\u540e\u7eed\u7684\u9ebb\u70e6\u3002</p>"},{"location":"chap1/8chap1_trace/#5-5","title":"5-5 \u91c7\u6837\u7387\u5982\u4f55\u8bbe\u7f6e\uff1f","text":"<p>\u5728 Jaeger \u4e2d\u63d0\u4f9b\u4e86\u52a8\u6001\u91c7\u6837\u7387\u7684\u529f\u80fd\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u540c\u4e00\u4e2a\u670d\u52a1\u4e2d\uff0c\u4f4e QPS \u7684\u63a5\u53e3\u53ef\u4ee5\u88ab\u6709\u6548\u91c7\u96c6\uff0c\u800c\u9ad8 QPS \u7684\u63a5\u53e3\u6709\u8f83\u4f4e\u7684\u91c7\u6837\u7387\u3002</p>"},{"location":"chap1/8chap1_trace/#5-6-trace","title":"5-6 Trace \u94fe\u8def\u7684\u8fde\u7eed\u6027","text":"<p>\u7f51\u5173\u4e2d\u751f\u6210\u521d\u59cb\u7684 TraceId \u548c\u6700\u4e0a\u5c42\u7684 SpanId\uff0c\u540e\u7eed\u7684\u670d\u52a1\u53ea\u8981\u62ff\u5230 downstream \u96c6\u7fa4\uff0c\u901a\u8fc7 header \u4f20\u9012\u4e0b\u6765\u7684 Trace \u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u7ee7\u7eed\u751f\u6210\u672c\u670d\u52a1\u7684 Trace \u6570\u636e\u4e86</p> <p>\u50cf Jaeger \u4e4b\u7c7b\u7684\u7ec4\u4ef6\uff0c\u5728\u6ca1\u6709\u62ff\u5230 Trace \u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u9ed8\u8ba4\u751f\u6210\u65b0\u7684 TraceId \u3002\u5b9e\u9645\u4e0a\uff0c\u6211\u5e76\u4e0d\u5efa\u8bae\u8fd9\u6837\u7684\u505a\u6cd5\uff0c\u4e00\u662f\u589e\u52a0\u4e86 SDK \u7684\u590d\u6742\u5ea6\uff0c\u9020\u6210\u7ef4\u62a4\u56f0\u96be\uff1b\u4e8c\u662f\u94fe\u8def\u4e00\u65e6\u65ad\u6389\uff0c\u5bf9\u4e8e\u6392\u67e5\u95ee\u9898\u7684\u5e2e\u52a9\u5c31\u4e0d\u662f\u5f88\u5927\u4e86\u3002</p>"},{"location":"chap1/8chap1_trace/#6","title":"6\u3001\u5173\u4e8e\u94fe\u8def\u8ffd\u8e2a\u7684\u4e00\u4e9b\u601d\u8003","text":""},{"location":"chap1/8chap1_trace/#6-1","title":"6-1 \u5ba2\u6237\u7aef\u94fe\u8def\u8ffd\u8e2a","text":"<p>\u94fe\u8def\u8ffd\u8e2a\uff0c\u4e3b\u8981\u8fd8\u662f\u7528\u4e8e\u5185\u90e8\u670d\u52a1\uff0c\u4ee5\u5c55\u793a\u5fae\u670d\u52a1\u7684\u8c03\u7528\u5173\u7cfb\u548c\u6392\u67e5\u5fae\u670d\u52a1\u5bfc\u81f4\u7684\u94fe\u8def\u590d\u6742\u6027\u95ee\u9898\u3002\u4f46\u5b9e\u9645\u4e0a\u53ef\u4ee5\u8003\u8651\u5728\u5ba2\u6237\u7aef\u5c31\u751f\u6210 client-traceid\uff0c\u7136\u540e\u5c06 client-traceid \u548c\u5185\u90e8 TraceId \u5173\u8054\u8d77\u6765\uff0c\u8fd9\u6837\u5c31\u80fd\u591f\u5c55\u793a\u6574\u4e2a\u94fe\u8def\u8ffd\u8e2a\u4e2d\u5ba2\u6237\u7aef\u8017\u65f6\u5360\u6bd4\u3002</p>"},{"location":"chap1/8chap1_trace/#6-2-rpc-sdk","title":"6-2 RPC SDK \u7684\u8bbe\u8ba1","text":"<p>\u5b9e\u9645\u4e0a Trace \u7cfb\u7edf\u9700\u8981\u5c06 Trace header \u7684\u4fe1\u606f\u4e00\u5c42\u5c42\u4f20\u9012\u4e0b\u53bb\uff0c\u6240\u4ee5 RPC \u7684 Client SDK \u9700\u8981\u5177\u5907\u201c\u5728\u8bf7\u6c42\u7684\u65f6\u5019\u5e26\u4e0a Trace \u6240\u9700\u4fe1\u606f\u201d\u7684\u80fd\u529b\u3002</p> <p>\u5176\u5b9e\u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u6709\u5f88\u591a\u573a\u666f\u9700\u8981\u6211\u4eec\u5c06\u6700\u9876\u5c42\u7684\u7f51\u5173\u5c42\u7684\u6570\u636e\u4f20\u9012\u4e0b\u53bb\uff0c\u4ee5\u4fdd\u8bc1\u4e0a\u6e38\uff08upstream\uff09\u7684\u5fae\u670d\u52a1\u80fd\u591f\u83b7\u53d6\u8fd9\u4e9b\u4fe1\u606f\u3002\u6bd4\u5982\u5ba2\u6237\u7aef IP\u3001\u7070\u5ea6\u6d41\u91cf\u6807\u7b7e\u7b49\u3002\u6240\u4ee5\u5728\u5fae\u670d\u52a1 SDK \u8bbe\u8ba1\u7684\u65f6\u5019\u6700\u597d\u5b9a\u4e49\u4e00\u7ec4 header\uff0c\u65b9\u4fbf\u6211\u4eec\u89e3\u6790\u5e76\u5411\u4e0a\u6e38\u4f20\u9012\uff0c\u6bd4\u5982  <code>X-Mesh-Xxx</code>\u3002</p> <p> </p>"},{"location":"chap1/9chap1_monitor/","title":"\u7b2c\u4e5d\u8282 \u5229\u7528 Prometheus \u548c Grafana \u6536\u96c6\u76d1\u63a7\u6570\u636e","text":""},{"location":"chap1/9chap1_monitor/#1","title":"1\u3001\u4f20\u7edf\u76d1\u63a7\u7cfb\u7edf","text":"<p>\u76d1\u63a7\u7cfb\u7edf\u901a\u5e38\u7531\u6307\u6807\u91c7\u96c6\u5b50\u7cfb\u7edf\u548c\u6570\u636e\u5904\u7406\u5b50\u7cfb\u7edf\u7ec4\u6210\u3002</p> <p>\u6307\u6807\u91c7\u96c6\u5b50\u7cfb\u7edf\u4e3b\u8981\u8d1f\u8d23\u4fe1\u606f\u91c7\u96c6\u3001\u8fc7\u6ee4\u3001\u6c47\u603b\u548c\u5b58\u50a8\uff1b</p> <p>\u6570\u636e\u5904\u7406\u5b50\u7cfb\u7edf\u4e3b\u8981\u8d1f\u8d23\u6570\u636e\u5206\u6790\u3001\u5c55\u73b0\u3001\u9884\u8b66\u548c\u544a\u8b66\u7b49\u3002\u4f20\u7edf\u7684\u76d1\u63a7\u7cfb\u7edf\u4e00\u822c\u6709ELK \u548c Nagios &amp; Zabbix\u3002</p>"},{"location":"chap1/9chap1_monitor/#1-1-elk","title":"1-1 ELK","text":"<p>ELK \u662f Elastic \u516c\u53f8\u63a8\u51fa\u7684\u76d1\u63a7\u7cfb\u7edf\uff0c\u5305\u542b\u4e86 Elasticsearch\u3001Logstash \u548c Kibana\uff0c\u5206\u522b\u4f5c\u4e3a\u5b58\u50a8\u5f15\u64ce\u3001\u65e5\u5fd7\u6536\u96c6\u548c\u524d\u7aef\u5c55\u793a\u7cfb\u7edf\u3002</p> <p>\u5176\u4e2dElasticsearch \u662f\u6838\u5fc3\uff0c\u5176\u4ed6\u4e24\u4e2a\u90fd\u53ef\u4ee5\u66ff\u6362\uff0c\u8f83\u5e38\u89c1\u7684\u66ff\u6362\u65b9\u6848\u662f Filebeat \u548c Graylog\u3002</p> <ul> <li>Filebeat \u662f\u7531 Go \u8bed\u8a00\u7f16\u5199\u7684\u8f7b\u91cf\u7ea7\u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u3002\u65e5\u5fd7\u53ef\u4ee5\u76f4\u63a5\u4f20\u8f93\u5230 Elasticsearch \u4e2d\uff0c\u53ef\u4ee5\u4f20\u8f93\u5230 Logstash \u8fdb\u884c\u4e00\u4e9b\u6570\u636e\u5904\u7406\u3002</li> <li>\u800cGraylog \u662f\u4e00\u5957\u4ee3\u66ff ELK \u7684\u65e5\u5fd7\u6536\u96c6\u5206\u6790\u7cfb\u7edf\uff0c\u5176\u4e2d\u4fdd\u7559\u4e86 Elasticsearch \u7684\u5b58\u50a8\u90e8\u5206\uff0c\u63d0\u4f9b\u4e86 collector-sidecar \u7528\u4e8e\u65e5\u5fd7\u6536\u96c6\uff0c\u5e76\u7ee7\u627f\u4e86 Web \u56fe\u5f62\u754c\u9762\uff0c\u7528\u4e8e\u641c\u7d22\u548c\u56fe\u5f62\u5316\u5c55\u793a\u3002</li> </ul> <p>\u603b\u4f53\u6765\u8bf4\uff0cELK \u662f\u4e00\u5957\u4f20\u7edf\u7684\u53ef\u89c2\u6d4b\u6027\u7cfb\u7edf\uff0c\u4e3b\u8981\u5229\u7528\u6211\u4eec\u4e4b\u524d\u63d0\u5230\u7684\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u4e4b\u4e00\u2014\u2014\u65e5\u5fd7\u6765\u63d0\u4f9b\u76d1\u63a7\u529f\u80fd\uff0c\u4f18\u70b9\u662f\u6570\u636e\u51c6\u786e\u6027\u9ad8\uff0c\u4f46\u7531\u4e8e\u65e5\u5fd7\u9700\u8981\u5b58\u50a8\u548c\u5efa\u7acb\u7d22\u5f15\uff0c\u6210\u672c\u4f1a\u6bd4\u8f83\u9ad8</p>"},{"location":"chap1/9chap1_monitor/#1-2-nagios-zabbix","title":"1-2 Nagios &amp; Zabbix","text":"<p>Nagios \u548c Zabbix \u90fd\u662f\u4f20\u7edf\u7684\u8fd0\u7ef4\u76d1\u63a7\u5de5\u5177\uff0c\u4e3b\u8981\u76d1\u63a7\u4e3b\u673a\u3001\u7f51\u7edc\uff0c\u4ee5\u53ca\u4e1a\u52a1\u8fdb\u7a0b\u7aef\u53e3\u7684\u4fe1\u606f\u548c\u72b6\u6001\u3002\u4e3b\u8981\u4ee5\u63d2\u4ef6\u7684\u65b9\u5f0f\u8fdb\u884c\u6269\u5c55\uff0c\u901a\u8fc7\u63d2\u4ef6\u6269\u5c55\u53ef\u4ee5\u68c0\u6d4b\u4e3b\u673a\u7684 CPU\u3001\u5185\u5b58\u3001\u786c\u76d8\u7b49\u4fe1\u606f\uff0c\u4e5f\u53ef\u4ee5\u68c0\u6d4b\u5404\u79cd\u4e0d\u540c\u7684\u7f51\u7edc\u534f\u8bae\uff0c\u4f46\u5bf9\u4e8e\u68c0\u6d4b\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u5185\u7684\u4fe1\u606f\u51e0\u4e4e\u662f\u65e0\u80fd\u4e3a\u529b\u7684\u3002</p> <p>\u5e94\u7528\u81ea\u8eab\u7684\u9ec4\u91d1\u6307\u6807\uff08\u5ef6\u65f6\u3001\u901a\u4fe1\u91cf\u3001\u9971\u548c\u5ea6\u3001\u9519\u8bef\u7387\uff09\u548c\u4e00\u4e9b\u4e1a\u52a1\u7ea7\u522b\u7684\u6307\u6807\u90fd\u9700\u8981\u5b9e\u65f6\u7684\u53ef\u89c2\u6d4b\u3002</p>"},{"location":"chap1/9chap1_monitor/#2-metrics","title":"2\u3001\u73b0\u4ee3\u5316\u5e38\u7528\u7684 Metrics \u7cfb\u7edf","text":"<p>Metrics \u4e3b\u8981\u662f\u7528\u65f6\u5e8f\u6027\u6570\u636e\u5e93\u8bb0\u5f55\u6bcf\u4e2a\u65f6\u95f4\u70b9\u7684\u76d1\u63a7\u6570\u636e\uff0c\u901a\u8fc7\u4e3b\u52a8\u62c9\u53d6\u6216\u8005\u7a0b\u5e8f\u4e0a\u62a5\u7684\u65b9\u5f0f\u8bb0\u5f55\uff0c\u7136\u540e\u5b9e\u65f6\u8ba1\u7b97\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e\uff0c\u5e76\u901a\u8fc7\u56fe\u5f62\u754c\u9762\u7684\u65b9\u5f0f\u5c55\u73b0\u51fa\u6765\u3002\u5b83\u7684\u7279\u70b9\u662f\u5b9e\u65f6\u6027\u5f3a\u3001\u53ef\u89c2\u6d4b\u6307\u6807\u4e30\u5bcc\uff0c\u9002\u5408\u67e5\u770b\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6307\u6807\u8d8b\u52bf\u3002</p>"},{"location":"chap1/9chap1_monitor/#2-1-statsdgraphite","title":"2-1 StatsD+Graphite","text":"<p>StatsD \u662f Node.js \u7f16\u5199\u7684\u4e00\u4e2aMetrics \u6307\u6807\u91c7\u96c6\u7cfb\u7edf\uff0c\u901a\u8fc7 UDP \u534f\u8bae\u5c06\u4fe1\u606f\u4f20\u8f93\u5230\u540e\u7aef\u7a0b\u5e8f\uff0c\u805a\u5408\u540e\u5b58\u50a8\u5230 Graphite\u3002</p> <p>StatsD \u5305\u542b\u4e09\u4e2a\u7ec4\u6210\u90e8\u5206\uff0c\u5206\u522b\u662f\uff1a</p> <ul> <li>Client\uff0c\u5404\u79cd\u8bed\u8a00\u4f7f\u7528\u7684 SDK\uff0c\u7528\u4e8e\u5c06 Metrics \u4fe1\u606f\u901a\u8fc7 UDP \u7684\u65b9\u5f0f\u4f20\u9001\u5230 Server\u3002</li> <li>Server\uff0c\u6536\u96c6\u5ba2\u6237\u7aef\u4f20\u8f93\u7684 Metrics \u4fe1\u606f\uff0c\u805a\u5408\u540e\u53d1\u9001\u5230 Backend\uff0c\u4e5f\u5c31\u662f Graphite\u3002</li> <li>Backend\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684 Graphite\uff0cGraphite \u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u8d1f\u8d23\u5b58\u50a8 Metrics \u4fe1\u606f\u3002</li> </ul>"},{"location":"chap1/9chap1_monitor/#2-2-influxdbtelegraf","title":"2-2 InfluxDB+Telegraf","text":"<ul> <li>InfluxDB \u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u8d1f\u8d23 Metrics \u4fe1\u606f\u7684\u5b58\u50a8\uff1b</li> <li>Telegraf \u662f\u4e00\u5957 Metrics \u6536\u96c6\u7cfb\u7edf\uff0c\u9ed8\u8ba4\u81ea\u5e26\u975e\u5e38\u4e30\u5bcc\u7684\u63d2\u4ef6\uff0c\u7528\u4e8e\u91c7\u96c6\u7cfb\u7edf\u7ea7\u522b\u7684\u4fe1\u606f\uff0c\u5982\u679c\u8981\u91c7\u96c6\u5e94\u7528\u7ef4\u5ea6\u7684\u4fe1\u606f\uff0c\u5219\u9700\u8981\u7f16\u5199\u63d2\u4ef6\u3002</li> </ul>"},{"location":"chap1/9chap1_monitor/#2-3-prometheus","title":"2-3 Prometheus","text":"<p>Prometheus \u662f Cloud Native Computing Foundation\uff08\u7b80\u79f0\uff1aCNCF\uff09\u751f\u6001\u5708\u7684\u4e00\u5458\uff0c\u4e5f\u662f\u6574\u4e2a Kubernetes \u751f\u6001\u4e2d\u91cd\u8981\u7684\u4e00\u73af\uff0c\u73b0\u5df2\u7ecf\u5e7f\u6cdb\u7528\u4e8e Kubernetes \u96c6\u7fa4\u76d1\u63a7\u4e2d\u3002</p> <p>Prometheus \u4e0e\u4e0a\u9762\u7684\u4e24\u4e2a Metrics \u7cfb\u7edf\u6700\u5927\u7684\u4e0d\u540c\uff0c\u662f\u63d0\u4f9b\u4e86\u4e00\u6574\u5957\u5b8c\u6574\u7684\u76d1\u63a7\u544a\u8b66\u89e3\u51b3\u65b9\u6848\uff0c\u5305\u542b\u4e86\u6570\u636e\u91c7\u96c6\u3001\u6570\u636e\u5b58\u50a8\u548c\u544a\u8b66\u3002</p> <p>\u53e6\u5916\u8fd8\u6709\u4e24\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u4e5f\u662f\u73b0\u4ee3\u5316\u76d1\u63a7\u7cfb\u7edf\u7684\u5fc5\u8981\u6807\u5fd7\uff1a</p> <ul> <li>\u91c7\u7528\u4e86 pull \u62c9\u53d6\u7684\u6a21\u578b\u91c7\u96c6\u6570\u636e\uff0c\u7b80\u5316\u4e86\u5ba2\u6237\u7aef\u7684\u4ee3\u7801\u7f16\u5199\u6210\u672c\uff0c\u5e76\u4e14 HTTP \u534f\u8bae\u975e\u5e38\u5229\u4e8e\u8c03\u8bd5\u3002</li> <li>\u652f\u6301\u670d\u52a1\u53d1\u73b0\uff0c\u9ed8\u8ba4\u652f\u6301\u4e86 Consul \u548c Kubernetes \u539f\u751f\u53d1\u73b0\u7cfb\u7edf\uff0c\u907f\u514d\u4e86\u7e41\u6742\u7684\u673a\u5668\u4fe1\u606f\u914d\u7f6e\u3002</li> </ul>"},{"location":"chap1/9chap1_monitor/#3prometheus","title":"3\u3001Prometheus \u7ec4\u6210\u548c\u67b6\u6784","text":""},{"location":"chap1/9chap1_monitor/#3-1-prometheus","title":"3-1 Prometheus \u67b6\u6784\u6a21\u5757\u6784\u6210","text":"<ul> <li>Prometheus Server\uff1a\u7528\u4e8e\u6536\u96c6\u548c\u5b58\u50a8 Metrics \u6570\u636e\u3002</li> <li>Service Disvovery\uff1a\u7528\u4e8e\u670d\u52a1\u53d1\u73b0\uff0c\u83b7\u53d6\u670d\u52a1\u5bf9\u5e94\u7684 EndPoint \u7528\u4e8e\u6570\u636e\u91c7\u96c6\uff0c\u9ed8\u8ba4\u652f\u6301 DNS\u3001Consul\u3001Kubernestes \u7b49\u591a\u79cd\u53d1\u73b0\u65b9\u6848\u3002</li> <li>PushGateway\uff1a\u63d0\u4f9b\u63a8\u9001\u7684\u65b9\u5f0f\u91c7\u96c6\u6570\u636e\uff0c\u4e3b\u8981\u7528\u4e8e Job \u7c7b\uff0cJob \u7c7b\u7a0b\u5e8f\u53ef\u80fd\u5b58\u6d3b\u65f6\u95f4\u6bd4\u8f83\u77ed\uff0c\u4e0d\u9002\u5408\u91c7\u7528\u62c9\u53d6\u7684\u65b9\u5f0f\u3002\u53e6\u5916\u4e00\u4e9b\u975e\u5e38\u9a7b\u8fdb\u7a0b\u7684\u811a\u672c\u8bed\u8a00\uff0c\u6bd4\u5982 PHP\uff0c\u4e5f\u9700\u8981\u4f7f\u7528\u6b64\u79cd\u65b9\u5f0f\u3002</li> <li>Exporters\uff1a\u7528\u4e8e\u4e00\u4e9b\u7b2c\u4e09\u65b9\u670d\u52a1\uff0c\u901a\u8fc7\u8f6c\u6362\u63d0\u4f9b\u7b26\u5408 Prometheus \u89c4\u8303\u7684 Metrics \u4fe1\u606f\uff0c\u6bd4\u5982 Node Exporter \u63d0\u4f9b\u8282\u70b9\u76f8\u5173\u7684\u4fe1\u606f\u3002BlackBox \u65b9\u4fbf\u7528\u6237\u4f7f\u7528 HTTP\u3001TCP \u7b49\u65b9\u5f0f\u5bf9\u5e94\u7528\u8fdb\u7a0b\u63a2\u6d3b\uff0c\u4ee5\u76d1\u63a7\u5e94\u7528\u72b6\u6001\u3002</li> <li>Client Library\uff1a\u4e3a\u5404\u79cd\u8bed\u8a00\u63d0\u4f9b\u7684\u5ba2\u6237\u7aef\u5e93\uff0c\u63d0\u4f9b HTTP \u670d\u52a1\u7684 Metrics \u63a5\u53e3\uff0c\u5f53 Prometheus Server \u62c9\u53d6\u65f6\uff0c\u63d0\u4f9b\u5b9e\u65f6\u7684 Metrics \u6570\u636e\u3002</li> <li>Alertmanager\uff1a\u544a\u8b66\u7ba1\u7406\u5668\uff0c\u63a5\u6536 Prometheus Server \u53d1\u6765\u7684\u544a\u8b66\u4fe1\u606f\uff0c\u53bb\u9664\u91cd\u590d\u4fe1\u606f\uff0c\u5206\u7ec4\u540e\u53d1\u9001\u7ed9\u76f8\u5e94\u7684\u4eba\u5458\u3002\u901a\u77e5\u65b9\u5f0f\u652f\u6301 Email \u548c WebHook \u81ea\u5b9a\u4e49\u7b49\uff0c\u4e00\u822c\u4f1a\u901a\u8fc7 WebHook \u63a5\u5165\u9489\u9489\u6216\u8005\u4f01\u4e1a\u5fae\u4fe1\u4ee5\u8fbe\u5230\u5b9e\u65f6\u62a5\u8b66\u7684\u76ee\u7684\u3002</li> </ul>"},{"location":"chap1/9chap1_monitor/#3-2-prometheus","title":"3-2 Prometheus \u6570\u636e\u6a21\u578b","text":"<pre><code>negri_http_request_total{client=\"serviceA\",code=\"200\",exported_service=\"serviceB\",path=\"/ping\"}\n</code></pre> <ul> <li>Metrics \u540d\u5b57\uff1a\u9996\u5148\u662f Metrics \u7684\u540d\u79f0\uff0cMetrics \u7684\u540d\u79f0\u8868\u660e\u4e86\u8fd9\u6761\u6570\u636e\u7684\u7528\u9014\uff0c\u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a\u6570\u636e\u662f Negri Sidecar \u7edf\u8ba1\u7684\u603b\u7684\u8bf7\u6c42\u6570\u91cf\u3002</li> <li>Label \u6807\u7b7e\uff1a\u8fd9\u6761\u6570\u636e\u4e2d\u7684 client\u3001code\u3001<code>exported_service</code> \u548c path \u90fd\u662f\u6807\u7b7e\uff0c\u901a\u8fc7\u6807\u7b7e\u53ef\u4ee5\u7ec4\u6210\u4e0d\u540c\u7684\u67e5\u8be2\u8bed\u53e5\uff0c\u4ece\u4e0d\u540c\u7ef4\u5ea6\u83b7\u53d6\u6570\u636e\u3002</li> </ul>"},{"location":"chap1/9chap1_monitor/#3-3-prometheus-metrics","title":"3-3 Prometheus \u7684 Metrics \u7c7b\u578b","text":""},{"location":"chap1/9chap1_monitor/#counter","title":"Counter","text":"<p>\u7d2f\u52a0\u503c\uff0c\u975e\u5e38\u9002\u5408\u7edf\u8ba1 QPS\u3002</p> <p>\u8fd9\u4e2a\u6570\u636e\u4ece\u670d\u52a1\u5f00\u59cb\u5c31\u4e0d\u505c\u5730\u7d2f\u52a0\uff0c\u6bd4\u5982\u4e0a\u9762\u63d0\u5230\u7684 <code>negri_http_request_total</code> \u5c31\u662f\u4e00\u79cd Counter \u7c7b\u578b\u3002</p> <p>\u5b83\u7edf\u8ba1\u4e86\u670d\u52a1\u542f\u52a8\u81f3\u76ee\u524d\u6240\u6709\u8bf7\u6c42\u7684\u6570\u636e\uff0c\u901a\u8fc7 rate \u6216\u8005 irate \u5c31\u53ef\u4ee5\u8ba1\u7b97\u51fa\u4e00\u6bb5\u65f6\u95f4\u5185\u7684 QPS\u3002Counter \u7c7b\u578b\u662f Prometheus Server \u7aef\u8ba1\u7b97\u7684\uff0c\u76f8\u5bf9\u4e8e\u4e0b\u9762\u8bb2\u5230\u7684 Gauge\uff0c\u5360\u7528\u670d\u52a1\u81ea\u8eab\u66f4\u5c11\uff0c\u5efa\u8bae\u9ad8\u6027\u80fd\u7684\u5fae\u670d\u52a1\u9996\u9009\u6b64\u79cd\u7c7b\u578b\u3002</p>"},{"location":"chap1/9chap1_monitor/#gauge","title":"Gauge","text":"<p>\u9002\u5408\u8bb0\u5f55\u77ac\u65f6\u503c\uff0c\u6bd4\u5982\u7edf\u8ba1\u4e00\u4e9b\u7a81\u53d1\u4e8b\u4ef6\uff0c\u4f8b\u5982\u662f\u5426\u4ea7\u751f\u4e86\u7194\u65ad\u3001\u9650\u6d41\u7b49\u4e8b\u4ef6\u3002</p> <p>\u56e0\u4e3a\u662f\u5ba2\u6237\u7aef SDK \u8ba1\u7b97\u7684\uff0c\u4e0d\u592a\u9002\u5408\u4e00\u4e9b\u7ecf\u5e38\u53d8\u5316\u7684\u6570\u636e\u3002\u5982\u679c\u6570\u636e\u662f\u4e00\u76f4\u589e\u52a0\u7684\uff0c\u5efa\u8bae\u4f7f\u7528 Counter\uff1b\u5f53\u7136\u5982\u679c\u6570\u636e\u6709\u589e\u6709\u51cf\uff0c\u4e5f\u6bd4\u8f83\u9002\u5408\uff0c\u56e0\u4e3a\u76d1\u63a7\u4e2d\u5f88\u5c11\u9047\u5230\u589e\u51cf\u6bd4\u8f83\u9891\u7e41\u7684\u6570\u636e\u3002</p> <pre><code>degrade_events{event=\"eventBreakerOpenStatus\",service=\"serviceB\"}\n</code></pre>"},{"location":"chap1/9chap1_monitor/#histogram","title":"Histogram","text":"<p>\u67f1\u72b6\u56fe\uff0c\u9002\u5408\u7edf\u8ba1\u670d\u52a1\u7684 99 \u5ef6\u65f6\u7b49\u4fe1\u606f\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c31\u662f\u7528\u4e8e\u7edf\u8ba1\u670d\u52a1\u7684\u5ef6\u65f6\u72b6\u51b5\uff1a</p> <pre><code>negri_http_response_time_us_bucket{client=\"serviceA\",exported_service=\"serviceB\",le=\"0.5\",path=\"/ping\"}\n</code></pre> <p>\u5982\u4e0a\u8ff0\u5185\u5bb9\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2\u8bed\u53e5\u7ed8\u5236\u51fa 90 \u5ef6\u65f6\u300195 \u5ef6\u65f6\u300199 \u5ef6\u65f6\u7b49\u6307\u6807\uff0c Histogram \u548c Counter \u7c7b\u578b\u4e00\u6837\uff0c\u90fd\u662f Prometheus Server \u7aef\u8ba1\u7b97\u7684\uff0c\u6240\u4ee5\u975e\u5e38\u9002\u5408\u9ad8\u6027\u80fd\u7684\u573a\u666f\u4f7f\u7528\uff0c\u76f8\u5bf9\u4e8e\u4e0b\u9762\u8bb2\u89e3\u7684 Summary \u6709\u66f4\u5c0f\u7684\u635f\u8017\u3002</p>"},{"location":"chap1/9chap1_monitor/#summary","title":"Summary","text":"<p>\u7c7b\u4f3c\u4e8e Histogram\uff0c\u9002\u5408\u7edf\u8ba1\u670d\u52a1\u7684 99 \u5ef6\u65f6\u4fe1\u606f\u3002</p> <p>Summary \u548c Gauge \u7c7b\u578b\u4e00\u6837\uff0c\u90fd\u662f\u5728\u7a0b\u5e8f\u5185\u8ba1\u7b97\u7684\uff0c\u6240\u4ee5\u5e76\u4e0d\u80fd\u50cf Histogram \u4e00\u6837\uff0c\u5728\u7ed8\u5236\u56fe\u5f62\u7684\u65f6\u5019\u7075\u6d3b\u7684\u8bbe\u7f6e\u767e\u5206\u4f4d\uff0c</p> <p>\u4f46\u76f8\u5bf9\u6765\u8bf4\uff0cSummary \u7684\u6570\u636e\u4e5f\u66f4\u52a0\u7cbe\u51c6\u3002</p>"},{"location":"chap1/9chap1_monitor/#2-4-grafana","title":"2-4 Grafana \u56fe\u5f62\u5316\u5c55\u793a","text":"<p>Grafana \u662f\u4e00\u5957\u53ef\u89c6\u5316\u76d1\u63a7\u6307\u6807\u5de5\u5177\uff0c\u4e3b\u8981\u7528\u4e8e\u65f6\u5e8f\u6570\u636e\u7684\u5c55\u793a\uff0c\u5305\u62ec Graphite\u3001Elasticsearch\u3001InfluxDB\u3001Prometheus\u3001CloudWatch\u3001MySQL \u548c OpenTSDB\u3002\u8fd9\u4e9b\u6570\u636e\u6e90\u5927\u591a\u6570\u6211\u4eec\u5728\u524d\u9762\u505a\u8fc7\u4ecb\u7ecd\u3002\u5176\u4e2d\u6700\u5e38\u89c1\u7684\u5c31\u662f Prometheus+Grafana \u7684\u7ec4\u5408\u3002</p> <p> </p> <p>\u901a\u8fc7 Grafana \u5c55\u793a\u670d\u52a1\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u5305\u62ec\u5e38\u89c1\u7684 QPS\u3001\u5ef6\u65f6\u7b49\u4fe1\u606f\u3002</p> <p> </p>"},{"location":"chap1/9chap1_monitor/#2-5","title":"2-5 \u5e38\u89c1\u95ee\u9898","text":""},{"location":"chap1/9chap1_monitor/#prometheus","title":"Prometheus \u9002\u5408\u4ec0\u4e48\u6837\u7684\u76d1\u63a7\u573a\u666f\uff1f","text":"<p>Metrics \u6570\u636e\u76d1\u63a7\uff0c\u5e76\u4e0d\u9002\u5408\u8981\u6c42\u6570\u636e 100% \u51c6\u786e\u7684\u573a\u666f\uff0c\u66f4\u591a\u7684\u662f\u53cd\u6620\u4e00\u6bb5\u65f6\u95f4\u5185\u67d0\u4e2a\u6570\u636e\u6307\u6807\u7684\u8d8b\u52bf\u548c\u5927\u6982\u503c\u3002\u91c7\u96c6\u6570\u636e\u662f\u5b58\u5728\u95f4\u9694\u7684\uff0c\u8ba1\u7b97\u6570\u636e\u4e5f\u662f\u6709\u65f6\u95f4\u533a\u95f4\u7684\uff0c\u6240\u4ee5\u5f88\u96be\u53cd\u6620\u67d0\u4e00\u65f6\u523b\u7684\u51c6\u786e\u503c\uff0c\u6bd4\u5982 CPU \u7684\u5cf0\u503c\uff0c\u5927\u6982\u7387\u4f1a\u88ab\u5e73\u5747\u6389\u3002\u5982\u679c\u8981\u67e5\u770b\u7cbe\u51c6\u6570\u636e\uff0c\u6700\u597d\u901a\u8fc7\u65e5\u5fd7\u7684\u65b9\u5f0f\u6536\u96c6\u540e\u68c0\u7d22\u67e5\u770b\u3002</p>"},{"location":"chap1/9chap1_monitor/#metrics","title":"\u5355\u4e2a\u670d\u52a1\u8282\u70b9 Metrics \u6570\u91cf\u9650\u5236","text":"<p>Prometheus \u867d\u7136\u6027\u80fd\u5f3a\u5927\uff0c\u4f46\u5982\u679c\u65e0\u89c4\u8303\u7684\u4f7f\u7528\uff0c\u968f\u7740\u91c7\u96c6\u6570\u636e\u8282\u70b9\u589e\u591a\uff0c\u4f9d\u7136\u96be\u4ee5\u4fdd\u8bc1\u5176\u7a33\u5b9a\u6027\u3002\u6bd4\u5982\u4e00\u4e9b RESTful \u89c4\u8303\u7684 path\uff08\u6bd4\u5982 /test/123\uff0c\u5176\u4e2d 123 \u4e3a\u53d8\u91cf\uff09\uff0c\u5982\u679c\u4e0d\u91c7\u53d6\u4e00\u4e9b\u63aa\u65bd\u805a\u5408\uff0c\u4f1a\u9020\u6210 Metrics \u7206\u70b8\u3002Metrics \u7684\u7206\u70b8\u4e0d\u4ec5\u4f1a\u5bfc\u81f4\u670d\u52a1 OOM\uff0c\u4e5f\u4f1a\u5bfc\u81f4 Prometheus \u7684\u5185\u5b58\u4f7f\u7528\u91cf\u589e\u5927\u548c\u68c0\u7d22\u53d8\u6162\u3002</p> <p>\u53e6\u5916\u8fc7\u591a\u7684\u6807\u7b7e\u53d8\u91cf\u3001\u8fc7\u591a\u7684 Histogram bucket\uff0c\u90fd\u4f1a\u5bfc\u81f4 Metrics \u6570\u91cf\u7684\u589e\u52a0\u3002\u6bd4\u5982\u4e0d\u5408\u7406\u5730\u8bb0\u5f55\u4e86\u8c03\u7528\u7aef\u7684\u6765\u6e90 IP\uff0c\u540c\u65f6\u4e5f\u8bb0\u5f55\u4e86\u670d\u52a1\u81ea\u8eab\u7684 IP\uff0c\u4e24\u8005\u7684 Metrics \u6570\u91cf\u5c31\u4f1a\u53d8\u6210\u4e58\u79ef\u5173\u7cfb\u3002\u8fd9\u4e9b\u4e0d\u5408\u7406\u7684\u6307\u6807\u4e0d\u5149\u4f1a\u5f71\u54cd\u670d\u52a1\u81ea\u8eab\uff0c\u4e5f\u4f1a\u5f71\u54cd Prometheus \u7684\u7a33\u5b9a\u6027\uff0c\u6240\u4ee5\u5728\u8f93\u51fa Metrics \u4fe1\u606f\u7684\u65f6\u5019\u4e00\u5b9a\u8981\u6ce8\u610f\uff0c\u5e94\u8be5\u9650\u5236\u7a0b\u5e8f Metrics \u6570\u91cf\uff0c\u52a0\u4e00\u4e2a\u9ed8\u8ba4\u7684\u4e0a\u9650\u6761\u4ef6\u3002</p>"},{"location":"chap1/9chap1_monitor/#restful-path","title":"RESTful path \u5982\u4f55\u5904\u7406\uff1f","text":"<p>\u65e0\u8bba\u662f\u5728 Metrics \u7cfb\u7edf\u4e2d\uff0c\u8fd8\u662f Trace \u7cfb\u7edf\u4e2d\uff0c\u90fd\u4f1a\u9047\u5230\u6b64\u7c7b\u95ee\u9898\u3002RESTful \u683c\u5f0f\u7684 path \u5728\u67d0\u4e00\u9636\u6bb5\u975e\u5e38\u6d41\u884c\uff0c\u7279\u522b\u662f\u5728 PC \u4e92\u8054\u7f51\u65f6\u4ee3\u975e\u5e38\u9002\u5408\u641c\u7d22\u5f15\u64ce\u7684 SEO\uff0c\u800c\u4e14\u770b\u8d77\u6765\u7f8e\u89c2\uff0c\u6240\u4ee5\u88ab\u5e7f\u6cdb\u4f7f\u7528\u3002</p> <p>\u5982\u679c\u8bf4\u5728 Web \u5ba2\u6237\u7aef\u4f7f\u7528\u8fd8\u6709\u56e0\u53ef\u5faa\uff0c\u4f46\u5728\u5fae\u670d\u52a1\u67b6\u6784\u7684\u5185\u7f51\u4f7f\u7528\u5c31\u5b8c\u5168\u4e0d\u53ef\u7406\u89e3\u4e86\uff0c\u6bd5\u7adf\u5185\u7f51\u65e0\u6cd5\u88ab\u641c\u7d22\u5f15\u64ce\u641c\u7d22\u5230\u3002</p> <p>\u6240\u4ee5\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u5982\u679c\u4f7f\u7528 HTTP \u534f\u8bae\u4f5c\u4e3a\u901a\u4fe1\u534f\u8bae\uff0c\u5efa\u8bae\u629b\u5f03 RESTful \u7684\u505a\u6cd5\u3002</p> <p> </p>"},{"location":"chap10/1istio_linked_consul/","title":"1 Istio vs. Linkerd vs. Consul\uff1a\u670d\u52a1\u7f51\u683c\u8be5\u600e\u4e48\u9009\u62e9\uff1f","text":""},{"location":"chap10/1istio_linked_consul/#1","title":"1 \u670d\u52a1\u7f51\u683c\u7b80\u4ecb","text":"<p>\u670d\u52a1\u7f51\u683c\u662f\u5e94\u7528\u7a0b\u5e8f\u7ec4\u4ef6\u548c\u7f51\u7edc\u4e4b\u95f4\u901a\u8fc7\u4ee3\u7406\u8fde\u63a5\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\u3002\u8fd9\u4e9b\u5e94\u7528\u7a0b\u5e8f\u7ec4\u4ef6\u901a\u5e38\u662f\u5fae\u670d\u52a1\uff0c\u4f46\u4ece\u65e0\u670d\u52a1\u5668\u5bb9\u5668\u5230\u865a\u62df\u673a\u6216\u88f8\u673a\u4e0a\u7684\u4f20\u7edf\u5e94\u7528\u7a0b\u5e8f\u7684\u4efb\u4f55\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u53ef\u4ee5\u53c2\u4e0e\u670d\u52a1\u7f51\u683c\u3002\u6bcf\u4e2a\u7ec4\u4ef6\u4e4b\u95f4\u4e0d\u662f\u901a\u8fc7\u7f51\u7edc\u76f4\u63a5\u901a\u4fe1\uff0c\u800c\u662f\u901a\u8fc7\u4ee3\u7406\u6765\u901a\u4fe1\u3002\u8fd9\u4e9b\u4ee3\u7406\u6784\u6210\u4e86\u6570\u636e\u5e73\u9762\uff0c\u63d0\u4f9b\u4e86\u8bb8\u591a\u529f\u80fd\uff0c\u7528\u4e8e\u5b9e\u73b0\u5b89\u5168\u548c\u6d41\u91cf\u7b56\u7565\uff0c\u5e76\u5bf9\u4ee3\u7406\u90e8\u7f72\u7684\u670d\u52a1\u8fdb\u884c\u9065\u6d4b\u3002</p> <p>\u670d\u52a1\u7f51\u683c\u7684\u529f\u80fd\u5305\u62ec\uff1a</p> <ul> <li>\u670d\u52a1\u53d1\u73b0</li> <li>\u5f39\u6027\uff1a\u91cd\u8bd5\u3001\u5f02\u5e38\u68c0\u6d4b\u3001\u65ad\u8def\u3001\u8d85\u65f6\u7b49</li> <li>\u5ba2\u6237\u7aef\u8d1f\u8f7d\u5e73\u8861</li> <li>L7 \u7ec6\u7c92\u5ea6\u6d41\u91cf\u63a7\u5236\uff1a\u6309\u6807\u9898\u3001\u76ee\u7684\u5730\u6216\u6e90\u4ee5\u53ca\u5176\u4ed6\u8fd0\u884c\u65f6\u4fe1\u606f\u8fdb\u884c\u8def\u7531</li> <li>\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u8bbe\u7f6e\u5b89\u5168\u7b56\u7565\uff0c\u800c\u4e0d\u662f\u6bcf\u4e2a\u8fde\u63a5</li> <li>\u57fa\u4e8e L7 \u5143\u6570\u636e\u7684\u8eab\u4efd\u9a8c\u8bc1\u3001\u901f\u7387\u9650\u5236\u3001\u4efb\u610f\u7b56\u7565</li> <li>\u5f3a\uff08L7\uff09\u5de5\u4f5c\u8d1f\u8f7d\u6807\u8bc6</li> <li>\u670d\u52a1\u5230\u670d\u52a1\u6388\u6743</li> <li>\u6307\u6807\u3001\u65e5\u5fd7\u548c\u8ddf\u8e2a</li> </ul> <p>\u901a\u8fc7\u5bf9\u6bd4\u663e\u793a\uff0cIstio \u662f\u6700\u6709\u80fd\u529b\u3001\u6700\u7075\u6d3b\u3001\u5e94\u7528\u6700\u5e7f\u6cdb\u7684\u670d\u52a1\u7f51\u683c\uff0c\u4e5f\u662f\u6700\u53d7\u793e\u533a\u652f\u6301\u7684\u670d\u52a1\u7f51\u683c\u3002</p> <p>\u56e0\u6b64\uff0cIstio \u5728\u5404\u4e2a\u9886\u57df\u90fd\u5728\u7a33\u6b65\u6539\u8fdb\u3002Consul \u548c Linkerd \u5c5e\u4e8e\u8f7b\u91cf\u7ea7\u8bbe\u8ba1\uff0c\u793e\u533a\u5e76\u4e0d\u5e7f\u6cdb\u652f\u6301\u3002\u56e0\u6b64\uff0c\u5b83\u4eec\u5728\u6700\u521d\u53ef\u80fd\u66f4\u5bb9\u6613\u5b9e\u73b0\uff0c\u5e76\u4e14\u5728\u8fc7\u53bb\u5177\u6709\u6027\u80fd\u4f18\u52bf\uff0c\u4f46\u5b83\u4eec\u53ef\u80fd\u4e0d\u592a\u9002\u5408\u8981\u6c42\u82db\u523b\u7684\u7528\u4f8b\u548c\u957f\u671f\u4f7f\u7528\u3002</p>"},{"location":"chap10/1istio_linked_consul/#2","title":"2  \u670d\u52a1\u7f51\u683c\u7684\u5de5\u4f5c\u6a21\u578b","text":"<p>\u670d\u52a1\u7f51\u683c\u9075\u5faa\u201c\u4e2d\u5fc3\u8f90\u5c04\u201d\u6a21\u5f0f\uff0c\u5373\u4f7f\u7528\u4ee3\u7406\u6216\u5de5\u4f5c\u8282\u70b9\u5b9e\u73b0\u7279\u5b9a\u89c4\u5219\uff0c\u5e76\u4f7f\u7528\u4e2d\u592e\u670d\u52a1\u5668\u7ba1\u7406\u4ee3\u7406\u3002</p> <p>Istio \u548c Consul \u4f7f\u7528 Envoy \u4ee3\u7406\uff0c\u800c Linkerd \u4f7f\u7528\u5176\u5b9a\u5236\u7684\u4ee3\u7406\u3002\u8fd9\u4e9b\u4ee3\u7406\u5728\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u6570\u636e\u5e73\u9762\u4e2d\u5de5\u4f5c\u3002</p> <p>\u4ed6\u4eec\u8d1f\u8d23\u7e41\u91cd\u7684\u4efb\u52a1\uff0c\u5982\u5904\u7406\u4f20\u5165\u6d41\u91cf\u3001\u8fde\u63a5\u670d\u52a1\u548c\u7ec6\u7c92\u5ea6\u5b89\u5168\u7b56\u7565\u3002\u7f51\u7edc\u901a\u4fe1\u548c\u5b89\u5168\u7ba1\u7406\u5728\u96c6\u4e2d\u63a7\u5236\u5e73\u9762\u5b8c\u6210</p>"},{"location":"chap10/1istio_linked_consul/#3","title":"3 \u670d\u52a1\u7f51\u683c\u6bd4\u8f83","text":"<p>\u5b9e\u73b0\u670d\u52a1\u7f51\u683c\u6700\u8457\u540d\u7684\u5f00\u6e90\u5de5\u5177\u6709\uff1aIstio\u3001Linkerd \u548c Consul\u3002Istio \u548c Consul \u90fd\u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u4ee3\u7406\u3002Linkerd \u6709\u81ea\u5df1\u7684\u5f00\u6e90\u4ee3\u7406\u3002\u6211\u4eec\u5c06\u5728\u672c\u6587\u4e2d\u6bd4\u8f83\u8fd9\u4e09\u4e2a\u8457\u540d\u7684\u670d\u52a1\u7f51\u683c\u9879\u76ee\u3002</p> <p>\u6211\u4eec\u57fa\u4e8e\u4ee5\u4e0b\u516d\u4e2a\u6807\u51c6\u6bd4\u8f83\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\uff1a\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u7ba1\u7406\u3001\u53ef\u4f38\u7f29\u6027\u3001\u53ef\u89c1\u6027\u548c\u53ef\u89c2\u5bdf\u6027\u3001\u5b89\u88c5\u548c\u5b9e\u73b0\u3001\u53ef\u6269\u5c55\u6027\u3002\u5e76\u5206\u4eab\u4e86\u6211\u4eec\u7684\u89c2\u70b9\u3002</p>"},{"location":"chap10/1istio_linked_consul/#_1","title":"\u6d41\u91cf\u7ba1\u7406","text":"<p>Istio\u3001Consul \u548c Linkerd \u90fd\u63d0\u4f9b\u57fa\u672c\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff0c\u5982\u8d1f\u8f7d\u5e73\u8861\u3001\u8def\u7531\u548c\u670d\u52a1\u53d1\u73b0\uff0c\u5e76\u4e14\u652f\u6301 HTTP\u3001gRPC \u4ee3\u7406\u3001TCP \u4ee3\u7406\u548c\u534f\u8bae\u68c0\u6d4b\u3002</p> <p>Istio \u548c Consul \u4f7f\u7528\u7684 Envoy \u4ee3\u7406\u5b9e\u73b0\u4e86\u6bd4 Linkerd \u66f4\u591a\u7684 HTTP \u7279\u5b9a\u529f\u80fd\u3002</p> <p>Envoy \u7684 HTTP connection manager \u63d0\u4f9b\u4e86\u5bf9 HTTP/1.1\u3001WebSocket\u3001HTTP/2 \u548c HTTP/3 \u7684\u652f\u6301\uff0c\u800c Linkerd \u6682\u4e0d\u652f\u6301HTTP/3\u3002</p> <p>\u76f8\u8f83\u4e8e Linkerd\uff0c\u56e0\u4e3a Istio \u548c Consul \u90fd\u4f7f\u7528\u4e86 Envoy\uff0c\u5b83\u4eec\u8fd8\u5177\u6709\u66f4\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff0c\u5982\u65ad\u8def\u3001\u91cd\u8bd5\u3001\u8d85\u65f6\u3001\u6545\u969c\u6ce8\u5165\u3001\u5ef6\u8fdf\u6ce8\u5165\u7b49\u529f\u80fd\u3002</p> <p>Istio \u662f\u552f\u4e00\u4e00\u6b3e\u652f\u6301 Kubernetes \u7684\u8f6f\u4ef6\u3002\u65e0\u8bba\u662f\u90e8\u7f72\u5728\u516c\u6709\u4e91\uff08\u4f8b\u5982 AWS\u3001GCP\u3001Azure\uff09\u7684 Kubernetes \u8fd8\u662f\u79c1\u6709\u4e91\u7684 Kubernetes\uff0c\u8fd9\u4f7f\u5f97 Istio \u6210\u4e3a\u8bb8\u591a\u5927\u578b\u4f01\u4e1a\u7684\u9996\u9009\u8f6f\u4ef6\uff0c\u56e0\u4e3a\u5927\u578b\u4f01\u4e1a\u65e2\u6709\u652f\u6301\u4e91\u539f\u751f\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e5f\u6709\u8bb8\u591a\u5355\u4f53\u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>\u67b6\u6784\u5e08\u548c\u5de5\u7a0b\u5e08\u559c\u6b22 Istio \u7684\u7406\u7531\uff1a</p> <ul> <li>\u524d\u7aef/\u8fb9\u7f18\u4ee3\u7406\uff1aIstio \u53ef\u4ee5\u6839\u636e\u8fd0\u884c\u65f6\u7684\u503c\u91cd\u5b9a\u5411\u8bf7\u6c42\uff0c\u4f7f\u91d1\u4e1d\u96c0\u548c\u84dd/\u7eff\u7b49\u90e8\u7f72\u7b56\u7565\u7684\u5b9e\u73b0\u53d8\u5f97\u5bb9\u6613\u3002</li> <li>\u652f\u6301\u5165\u53e3\u7f51\u5173\uff1aIstio \u63d0\u4f9b Istio \u5165\u53e3\u7f51\u5173\uff0c\u5e76\u652f\u6301\u7b2c\u4e09\u65b9 ingress controllers \u7ba1\u7406 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u3002</li> <li>\u591a\u96c6\u7fa4\u901a\u4fe1\uff1a\u6613\u4e8e\u4f7f\u7528 Istio \u670d\u52a1\u7f51\u683c\u8fde\u63a5\u8de8\u96c6\u7fa4\u6216\u533a\u57df\u7684 Kubernetes \u670d\u52a1\u3002</li> <li>\u591a\u7ad9\u70b9\u6545\u969c\u5207\u6362\uff1a\u7531\u4e8e\u652f\u6301\u6240\u6709\u516c\u5171\u4e91\uff0cIstio \u53ef\u7528\u4e8e\u81ea\u52a8\u6545\u969c\u5207\u6362\uff0c\u4ee5\u652f\u6301\u57fa\u4e8e\u4e91\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u9ad8\u53ef\u7528\u6027\u548c\u66f4\u5927\u7684\u5f39\u6027\u3002</li> </ul>"},{"location":"chap10/1istio_linked_consul/#_2","title":"\u5b89\u5168\u7ba1\u7406","text":"<p>Istio\u3001Consul \u548c Linkerd \u90fd\u652f\u6301\u8eab\u4efd\u9a8c\u8bc1\u548c\u6388\u6743\u529f\u80fd\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u57fa\u4e8e mTLS \u7684\u8eab\u4efd\u9a8c\u8bc1\uff0c\u786e\u4fdd\u7f51\u7edc\u901a\u4fe1\u7684\u5b89\u5168\u6027</li> <li>\u57fa\u4e8e JWT \u7684\u8eab\u4efd\u9a8c\u8bc1\u53ef\u4fdd\u62a4\u6765\u81ea\u5916\u90e8\u548c\u5185\u90e8\u7528\u6237\u7684\u5e94\u7528\u7a0b\u5e8f</li> <li>\u5b9a\u4e49\u7ec6\u7c92\u5ea6\u7684\u5b89\u5168\u7b56\u7565\uff0c\u4f8b\u5982\u5de5\u4f5c\u8d1f\u8f7d\u5230\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6700\u7ec8\u7528\u6237\u5230\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6388\u6743\u548c\u8bbf\u95ee\u63a7\u5236</li> </ul> <p>\u7136\u800c\uff0c\u7531\u4e8e Istio \u63d0\u4f9b\u4e86\u4e0e\u4e91\u5e73\u53f0\u548c\u865a\u62df\u673a\u7684\u96c6\u6210\uff0c\u53ef\u4ee5\u4f7f\u7528 Istio \u7684 mTLS\u7684\u8eab\u4efd\u9a8c\u8bc1\uff0c\u6784\u5efa\u5e94\u7528\u4e0e\u5916\u90e8\u5ba2\u6237\u673a\u6216\u5176\u4ed6 Kubernetes \u96c6\u7fa4\u6216\u865a\u62df\u673a\u4e4b\u95f4\u7684\u901a\u4fe1\u3002\u4ee5\u4e0b\u662f\u4e3a\u4ec0\u4e48\u5b89\u5168\u7ecf\u7406\u66f4\u559c\u6b22 Istio \u4ee5\u786e\u4fdd\u96f6\u4fe1\u4efb\u5b89\u5168\u6a21\u578b\u7684\u539f\u56e0\uff1a</p> <ul> <li>FIPS \u517c\u5bb9\uff1aIstio \u7684\u8bb8\u591a\u5b9e\u73b0\u90fd\u662f FIPS \u517c\u5bb9\u7684\uff0c\u5c5e\u4e8e FIPS \u9075\u5b88\u7684\u4e2d\u7b49\u6c34\u5e73\uff0c\u800c Tetrate \u7684\u5b9e\u73b0\u4e5f\u662f FIPS \u8ba4\u8bc1\u7684\uff0c\u4e14\u5c5e\u4e8e FIPS \u7684\u6700\u9ad8\u6c34\u5e73\u3002\u8fd9\u4f7f\u5f97 Istio \u6210\u4e3a\u9075\u5b88 2014\u5e74\u300a\u8054\u90a6\u4fe1\u606f\u5b89\u5168\u73b0\u4ee3\u5316\u6cd5\u6848\u300b\u7684\u7ec4\u7ec7\u7684\u6700\u4f73\u9009\u62e9\u3002</li> <li>CVEs \u7684\u900f\u660e\u5ea6\uff1aIstio \u4e0e\u56fd\u5bb6 CVE \u6570\u636e\u5e93\u5171\u4eab\u6f0f\u6d1e\uff0c\u7f51\u7edc\u5b89\u5168\u7ba1\u7406\u4eba\u5458\u53ef\u4ee5\u76f4\u63a5\u53c2\u8003\u56fd\u5bb6 CVE \u6570\u636e\u5e93\u4e2d\u7684\u6700\u65b0\u5b89\u5168\u7f3a\u9677\u548c\u95ee\u9898\uff0c\u5df2\u77e5\u6653 Istio \u5b58\u5728\u7684\u5b89\u5168\u95ee\u9898\u3002\u6b64\u5916\uff0cIstio \u4f1a\u53ca\u65f6\u5b9e\u65bd\u5b89\u5168\u8865\u4e01\uff0c\u5e76\u53ca\u65f6\u901a\u77e5 Istio \u7528\u6237\u3002</li> <li>\u7075\u6d3b\u6027\uff1aIstio \u53ef\u4ee5\u548c\u4efb\u4f55\u7684\u8eab\u4efd\u9a8c\u8bc1\u63d0\u4f9b\u5546\u96c6\u6210\uff0c\u5982 OpenID \u8fde\u63a5\u63d0\u4f9b\u5546\uff0c\u4f8b\u5982 KeyClope\u3001OAuth 2.0\u3001Google Auth\u3001Firebase Auth\u7b49\u3002</li> </ul> <p>\u7f8e\u56fd\u56fd\u5bb6\u6807\u51c6\u4e0e\u6280\u672f\u7814\u7a76\u6240\uff08NIST\uff09\u4f7f\u7528 Istio \u4f5c\u4e3a\u53c2\u8003\u67b6\u6784\uff0c\u4e3a\u8054\u90a6\u673a\u6784\u5b9e\u65bd\u5b89\u5168\u6807\u51c6\uff0c\u5b9e\u73b0\u96f6\u4fe1\u4efb\u3002</p>"},{"location":"chap10/1istio_linked_consul/#_3","title":"\u5b89\u88c5\u548c\u4f7f\u7528","text":"<p>\u65e0\u9700\u66f4\u6539\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\uff0c\u5c31\u53ef\u4ee5\u5b89\u88c5\u548c\u4f7f\u7528\u670d\u52a1\u7f51\u683c\u3002\u4f46\u4e00\u822c\u6765\u8bf4\uff0c\u670d\u52a1\u7f51\u683c\u7684\u8bbe\u7f6e\u548c\u7ef4\u62a4\u662f\u4e00\u4e2a\u96be\u9898\u3002\u5e76\u4e14\u8fd0\u7ef4\u56e2\u961f\u7279\u522b\u5173\u6ce8\u8f6f\u4ef6\u7684\u5b89\u88c5\u3001\u4f7f\u7528\u548c\u6027\u80fd\u95ee\u9898\u3002</p> <p>Istio\u3001Consul \u548c Linkerd \u90fd\u53ef\u4ee5\u4f7f\u7528 Helm charts \u6216 Operators \u5728 Kubernetes \u73af\u5883\u4e2d\u8f7b\u677e\u5b8c\u6210\u5b89\u88c5\u3002\u7531\u4e8e Linkerd \u662f\u8f7b\u91cf\u7ea7\u7684\uff0c\u5177\u6709\u8f83\u5c11\u7684\u529f\u80fd\u548c\u7b80\u5355\u7684\u67b6\u6784\uff0c\u56e0\u6b64\u5b83\u6bd4 Istio \u548c Consul \u66f4\u6613\u4e8e\u7ef4\u62a4\u548c\u6267\u884c\u3002</p> <p>Istio \u901a\u5e38\u88ab\u8ba4\u4e3a\u662f\u201c\u91cd\u91cf\u7ea7\u201d\u7684\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u5b83\u652f\u6301\u66f4\u591a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3001\u516c\u5171\u4e91\u548c\u865a\u62df\u673a\u3002</p> <p>\u4f46\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0cIstio \u5df2\u7ecf\u63d0\u9ad8\u4e86\u6027\u80fd\uff0c\u5e76\u52aa\u529b\u4ee5\u6700\u5c0f\u7684\u8d44\u6e90\u5f00\u9500\u63d0\u4f9b\u66f4\u591a\u7684\u7f51\u7edc\u7ba1\u7406\u548c\u5b89\u5168\u4f18\u52bf\u3002\u8be5\u9879\u76ee\u8fd8\u65e8\u5728\u652f\u6301\u5177\u6709\u9ad8\u8bf7\u6c42\u7387\u7684\u5927\u578b\u670d\u52a1\u7f51\u683c\uff0c\u540c\u65f6\u589e\u52a0\u6700\u5c0f\u5ef6\u8fdf\u3002</p>"},{"location":"chap10/1istio_linked_consul/#_4","title":"\u53ef\u4f38\u7f29\u6027","text":"<p>\u5728\u6309\u9700\u6269\u5c55\u65b9\u9762\uff0c\u6bcf\u79cd\u670d\u52a1\u7f51\u683c\u90fd\u5177\u6709\u72ec\u7279\u7684\u4f18\u52bf\u3002</p> <p>\u5173\u4e8e\u6570\u636e\u5e73\u9762\u7684\u53ef\u6269\u5c55\u6027\uff0cLinkerd \u7684\u6269\u5c55\u901f\u5ea6\u6bd4 Istio \u548c Consul \u5feb\u3002\u4e3b\u8981\u539f\u56e0\u662f Linkerd \u7684\u8f7b\u91cf\u7ea7\u67b6\u6784\uff0c\u5b83\u4e0d\u652f\u6301\u9ad8\u7ea7\u6d41\u91cf\u7ba1\u7406\u548c\u7ec6\u7c92\u5ea6\u5b89\u5168\u7ba1\u7406\u529f\u80fd\u3002</p> <p>\u4ece\u6570\u636e\u5e73\u9762\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5728\u8d44\u6e90\u53d7\u9650\u7684\u73af\u5883\u4e2d\uff0cEnvoy \u53ef\u80fd\u4f1a\u6bd4 Linkerd \u6d88\u8017\u66f4\u591a\u7684 CPU\u3002\u7136\u800c\uff0cEnvoy \u9075\u5faa\u4e00\u79cd\u5b9e\u7528\u7684\u8bbe\u8ba1\uff0c\u9002\u5408\u5728\u771f\u5b9e\u7684 IT \u73af\u5883\u4e2d\u5b9e\u73b0\u66f4\u5feb\u7684\u6027\u80fd\u3002Envoy \u7684\u7ef4\u62a4\u4eba\u5458\u5728\u5173\u952e\u8def\u5f84\u7684\u4ee3\u7406\u6027\u80fd\u8c03\u4f18\u65b9\u9762\u505a\u4e86\u51fa\u8272\u7684\u5de5\u4f5c\u3002\u6027\u80fd\u5c06\u56e0\u6240\u4f7f\u7528\u7684\u529f\u80fd\u3001Envoy \u8fd0\u884c\u7684\u73af\u5883\u548c\u53ef\u7528\u7684\u8ba1\u7b97\u673a\u8d44\u6e90\u800c\u5927\u4e0d\u76f8\u540c\u3002</p> <p>\u6b64\u5916\uff0c\u8bf7\u6ce8\u610f\uff0c\u6027\u80fd\u4ec5\u505a\u4e86\u6a2a\u5411\u5bf9\u6bd4\u3002\u5982\u679c\u6b64\u8f6f\u4ef6\u4e0d\u80fd\u6ee1\u8db3\u4f60\u7684\u6240\u6709\u9700\u6c42\uff0c\u4e5f\u4e0d\u80fd\u8fbe\u5230\u4e0e\u7ade\u4e89\u5bf9\u624b\u76f8\u540c\u7684\u6027\u80fd\u6807\u51c6\uff0c\u90a3\u4e48\u5b83\u5c31\u4e0d\u4f1a\u4ee5\u4e00\u79cd\u6709\u7528\u7684\u65b9\u5f0f\u66f4\u5feb\u6216\u66f4\u8f7b\u3002\u5982\u679c\u4f60\u7684\u7528\u4f8b\uff08\u73b0\u5728\u548c\u5c06\u6765\uff09\u5b8c\u5168\u7531\u5176\u529f\u80fd\u96c6\u6ee1\u8db3\uff0c\u90a3\u4e48\u4f60\u53ea\u80fd\u8003\u8651\u91cd\u91cf\u66f4\u8f7b\u3001\u529f\u80fd\u66f4\u5c11\u7684\u66ff\u4ee3\u65b9\u6848\u3002\u5728\u4f01\u4e1a\u5b9e\u65bd\u6216\u6280\u672f\u8981\u6c42\u82db\u523b\u7684\u73af\u5883\u4e2d\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0d\u592a\u53ef\u80fd\u53d1\u751f\u3002</p> <p>\u540c\u65f6\uff0c\u8bf7\u6ce8\u610f\uff0c\u9700\u5728\u7c7b\u4f3c\u4ea7\u54c1\u7684\u57fa\u7840\u4e0a\u505a\u6027\u80fd\u6bd4\u8f83\u3002\u4e00\u6b3e\u8f6f\u4ef6\u4e0d\u53ef\u80fd\u65e2\u8f7b\u91cf\u7ea7\u3001\u6027\u80fd\u9ad8\u4e14\u529f\u80fd\u5168\u3002</p> <p>Istio \u8d1f\u8f7d\u6d4b\u8bd5\uff0c\u8003\u8651\u4e86\u7531 1000 \u4e2a\u5fae\u670d\u52a1\u548c 2000 \u4e2a sidecars \u7ec4\u6210\u7684\u670d\u52a1\u7f51\u683c\u3002\u6bcf\u79d2\u5411\u7f51\u683c\u53d1\u9001 70000 \u4e2a\u8bf7\u6c42\uff0c\u5e76\u6d4b\u91cf\u54cd\u5e94\u65f6\u95f4\u3002\u4f7f\u7528 Istio 1.14.1 \u8fd0\u884c\u6d4b\u8bd5\u540e\uff0c\u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762\u7684\u89c2\u5bdf\u7ed3\u679c\u5982\u4e0b\uff1a</p> <ul> <li>\u6570\u636e\u5e73\u9762\u6027\u80fd\uff1aEnvoy \u4ee3\u7406\u6bcf\u79d2\u5904\u7406 1000 \u4e2a\u8bf7\u6c42\uff0c\u4f7f\u7528\u4e86 0.35 \u4e2a vCPU \u548c 40 MB \u5185\u5b58\u3002\u8fd8\u89c2\u5bdf\u5230 Envoy \u4ee3\u7406\uff0c\u540e 10% \u7684\u8bf7\u6c42\u5ef6\u8fdf\u589e\u52a0\u4e86 2.65\u6beb\u79d2\u3002</li> <li>\u63a7\u5236\u5e73\u9762\u6027\u80fd\uff1aIstiod \u4f7f\u7528 1 \u4e2a vCPU \u548c 1.5 GB \u5185\u5b58\u3002</li> </ul>"},{"location":"chap10/1istio_linked_consul/#_5","title":"\u53ef\u89c1\u6027\u548c\u53ef\u89c2\u6d4b\u6027","text":"<p>\u5206\u5e03\u5f0f\u670d\u52a1\u7684\u7aef\u5230\u7aef\u53ef\u89c1\u6027\u548c\u53ef\u89c2\u5bdf\u6027\u5bf9\u4e8e\u8fd0\u7ef4\u56e2\u961f\u6765\u8bf4\u81f3\u5173\u91cd\u8981\u3002SRE \u548c Ops \u56e2\u961f\u9700\u8981\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u7ea7\u522b\u53ef\u89c1\u6027\u3001\u8ddf\u8e2a\u548c\u76d1\u63a7\u80fd\u529b\u3002Istio\u3001Consul \u548c Linkerd \u90fd\u63d0\u4f9b\u4e86\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u5065\u5eb7\u72b6\u51b5\u7684\u53ef\u89c1\u6027\uff0c\u6d4b\u91cf\u7f51\u7edc\u884c\u4e3a\u5e76\u5411\u5229\u76ca\u76f8\u5173\u8005\u51fa\u5177\u62a5\u544a\u3002</p> <p>Istio\u3001Consul \u548c Linkerd \u751f\u6210\u76d1\u63a7\u6240\u9700\u7684\u5173\u952e\u6307\u6807\uff0c\u5982 HTTP\u3001HTTP/2 \u548c gRPC \u6d41\u91cf\u7684\u5ef6\u8fdf\u3001\u9519\u8bef\u548c\u9971\u548c\u5ea6\u3002\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\u63d0\u4f9b\u7684\u6307\u6807\u53ef\u4ee5\u76f4\u63a5\u4ece\u547d\u4ee4\u884c\u754c\u9762\uff08CLI\uff09\u6216 Grafana \u4eea\u8868\u677f\u67e5\u770b\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Prometheus \u6765\u67e5\u770b\u3002</p> <p>\u4e0e Linkerd \u76f8\u6bd4\uff0cIstio \u548c Consul \u90fd\u63d0\u4f9b\u4e86\u66f4\u8be6\u7ec6\u7684\u7f51\u7edc\u6307\u6807\u3002Envoy \u4ee3\u7406\u5728 Istio \u548c Consul \u4e2d\u5f62\u6210\u6570\u636e\u5e73\u9762\uff0c\u4e3a Ops \u56e2\u961f\u63d0\u4f9b\u8db3\u591f\u7684\u670d\u52a1\u7ea7\u522b\u6307\u6807\u3001\u4ee3\u7406\u7ea7\u522b\u6307\u6807\u548c\u5206\u5e03\u5f0f\u8ddf\u8e2a\uff0c\u66f4\u5feb\u5730\u8bca\u65ad\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e\u95ee\u9898\u3002\u7531\u4e8e Envoy \u4e5f\u662f\u4e00\u4e2a\u5e7f\u6cdb\u4f7f\u7528\u7684\u6570\u636e\u5e73\u9762\uff0cOps \u56e2\u961f\u66f4\u5bb9\u6613\u4ece\u793e\u533a\u4e2d\u627e\u5230\u914d\u7f6e\u6216\u6027\u80fd\u5f02\u5e38\u7684\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u4eba\u6c14</p> <p>Istio \u662f\u793e\u533a\u5185\u5916\u6700\u6d41\u884c\u7684\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\u3002\u8fd9\u610f\u5473\u7740\u66f4\u591a\u7684\u521b\u65b0\u548c\u66f4\u79ef\u6781\u7684\u529f\u80fd\u5f00\u53d1\u3002\u6709\u8bc1\u636e\u8868\u660e\uff0c\u4e0e\u4efb\u4f55\u5176\u4ed6\u670d\u52a1\u7f51\u683c\u76f8\u6bd4\uff0cIstio \u662f\u5168\u7403\u67b6\u6784\u5e08\u3001DevOps \u56e2\u961f\u548c\u5b89\u5168\u4e13\u4e1a\u4eba\u5458\u6700\u5e7f\u6cdb\u4f7f\u7528\u7684\u3002\u867d\u7136\u4f7f\u7528\u60c5\u51b5\u53ef\u80fd\u56e0\u884c\u4e1a\u6709\u6240\u4e0d\u540c\uff0c\u4f46 Istio \u76ee\u524d\u5df2\u5728\u91d1\u878d\u670d\u52a1\u884c\u4e1a\u548c\u7f8e\u56fd\u653f\u5e9c\u4f7f\u7528\uff0c\u5e76\u5728\u5173\u952e\u9886\u57df\u53d6\u5f97\u6210\u529f\u3002\u56e0\u6b64\uff0cIstio \u53ef\u80fd\u4f1a\u5168\u9762\u4fdd\u6301\u6216\u589e\u52a0\u5176\u9886\u5bfc\u5730\u4f4d</p> <ul> <li>1\u3001\u8c37\u6b4c\u8d8b\u52bf\uff08Google Trending\uff09</li> <li>2\u3001\u8d21\u732e\u8005\u7684\u591a\u6837\u6027</li> <li>4\u3001\u6350\u6b3e\u7ba1\u7406</li> <li>\u53ef\u6269\u5c55\u6027</li> </ul> <p>\u6240\u6709\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\u90fd\u662f\u6a21\u5757\u5316\u548c\u53ef\u6269\u5c55\u7684\u3002\u4f46\u7531\u4e8e Istio \u6bd4\u5176\u4ed6\u670d\u52a1\u7f51\u683c\u66f4\u53d7\u6b22\u8fce\uff0c\u8bb8\u591a\u5f00\u6e90\u9879\u76ee\u90fd\u662f\u901a\u8fc7 Istio \u5b9e\u73b0\u7684\u3002\u4e00\u4e9b\u503c\u5f97\u6ce8\u610f\u7684\u9879\u76ee\u5305\u62ec\uff1a</p> <ul> <li>Slime\uff0c\u4f7f\u7528 Istio \u548c Envoy \u7684\u667a\u80fd\u670d\u52a1\u7ba1\u7406\u5668</li> <li>MOSN\uff0c\u63d0\u4f9b\u4e91\u672c\u5730\u8fb9\u7f18\u7f51\u5173\u548c\u4ee3\u7406</li> <li>Aeraki\uff0c\u4e3a\u9664 HTTPs \u548c gRPC \u4e4b\u5916\u7684\u6240\u6709 L7 \u534f\u8bae\u63d0\u4f9b\u652f\u6301</li> <li>WASM\uff0c\u5f00\u53d1 WebAssembly \u63d2\u4ef6\u5e76\u589e\u5f3a\u670d\u52a1\u7f51\u683c\u529f\u80fd</li> </ul>"},{"location":"chap10/1istio_linked_consul/#_6","title":"\u603b\u7ed3","text":"<p>\u5728\u4ed4\u7ec6\u8bc4\u4f30\u4e86\u4e09\u79cd\u6d41\u884c\u7684\u670d\u52a1\u7f51\u683c\u7684\u5404\u79cd\u529f\u80fd\u540e\uff0c\u6211\u4eec\u8ba4\u4e3a Istio \u63d0\u4f9b\u4e86\u6bd4\u5176\u540c\u7c7b\u4ea7\u54c1\u66f4\u4e30\u5bcc\u7684\u529f\u80fd\u96c6\u3002</p> <p>\u5982\u679c\u4f60\u662f\u4e00\u4e2a\u5c0f\u578b\u7684 IT \u521d\u521b\u516c\u53f8\uff0c\u53ea\u6709\u4e00\u4e2a\u5c0f\u578b\u7684 DevOps \u548c\u5b89\u5168\u56e2\u961f\uff0c\u5e76\u4e14\u6ca1\u6709\u5728\u4e00\u4e2a\u7279\u522b\u5177\u6709\u6311\u6218\u6027\u7684\u5b89\u5168\u73af\u5883\u4e2d\u8fd0\u884c\uff0c\u800c\u4e14\u5728\u53ef\u9884\u89c1\u7684\u672a\u6765\u4f60\u80fd\u591f\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u8fd0\u884c\uff0c\u90a3\u4e48\u8f7b\u91cf\u7ea7\u7684 Linkerd \u6216 Consul \u53ef\u80fd\u662f\u66f4\u4f18\u9009\u62e9\u3002</p> <p>\u4f46\u5982\u679c\u4f60\u6709\u4e00\u4e2a\u5927\u89c4\u6a21\u7684 IT \u7cfb\u7edf\u548c\u4e00\u4e2a\u5e9e\u5927\u7684\u56e2\u961f\uff0c\u6216\u8005\u4f60\u8ba4\u4e3a\u5b89\u5168\u662f\u9996\u8981\u4efb\u52a1\uff0c\u90a3\u4e48 Istio \u662f\u66f4\u5b89\u5168\u7684\u9009\u62e9\u3002</p>"},{"location":"chap10/2istio_ambient/","title":"2 Istio Ambient Mesh \u4ecb\u7ecd","text":""},{"location":"chap10/2istio_ambient/#1-ambient-mesh","title":"1 Ambient Mesh \u4ecb\u7ecd","text":"<p>Istio \u7684\u4f20\u7edf\u6a21\u5f0f\u662f\u5c06 Envoy proxy \u4f5c\u4e3a sidecar \u90e8\u7f72\u5728\u5de5\u4f5c\u8d1f\u8f7d\u7684 pod \u4e2d\uff0c\u867d\u7136\u4e0e\u91cd\u6784\u5e94\u7528\u7a0b\u5e8f\u76f8\u6bd4\uff0csidecar \u5177\u6709\u663e\u8457\u7684\u4f18\u52bf\uff0c\u4f46\u662f\u4ecd\u7136\u4f1a\u4ea7\u751f\u4e00\u4e9b\u9650\u5236\uff1a</p> <ul> <li>\u4fb5\u5165\u6027\uff1asidecar \u5fc5\u987b\u901a\u8fc7\u4fee\u6539 Kubernetes Pod \u7684\u914d\u7f6e\u548c\u91cd\u5b9a\u5411\u6d41\u91cf\u6765\u201c\u6ce8\u5165\u201d\u5e94\u7528\u7a0b\u5e8f\u3002\u56e0\u6b64\uff0c\u5b89\u88c5\u548c\u5347\u7ea7 sidecar \u9700\u8981\u91cd\u65b0\u542f\u52a8 Pod\uff0c\u8fd9\u5c06\u4f1a\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u4ea7\u751f\u5f71\u54cd\u3002</li> <li>\u8d44\u6e90\u5229\u7528\u7387\u4f4e\uff1a\u7531\u4e8e\u5728\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d Pod \u90fd\u6ce8\u5165\u4e86 sidecar \u4ee3\u7406 \uff0c\u56e0\u6b64 Pod \u5fc5\u987b\u4e3a sidecar \u9884\u7559\u8db3\u591f\u7684 CPU \u548c\u5185\u5b58\u8d44\u6e90\uff0c\u4ece\u800c\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u7684\u8d44\u6e90\u5229\u7528\u7387\u4e0d\u8db3\u3002</li> <li>\u6d41\u91cf\u4e2d\u65ad\uff1a\u6d41\u91cf\u6355\u83b7\u548c HTTP \u5904\u7406\u901a\u5e38\u662f\u7531 Istio \u7684 sidecar \u5b8c\u6210\u7684\uff0c\u8ba1\u7b97\u9700\u8981\u6d88\u8017\u5927\u91cf\u7684\u8d44\u6e90\uff0c\u5e76\u4e14\u53ef\u80fd\u4f1a\u7834\u574f\u4e00\u4e9b\u4e0d\u7b26\u5408 HTTP \u5b9e\u73b0\u7684\u5e94\u7528\u7a0b\u5e8f\u3002</li> </ul> <p></p> <p>Istio ambient mesh \u662f Istio \u7684\u4e00\u4e2a\u65e0 sidecar \u7684\u6570\u636e\u5e73\u9762\uff0c\u65e8\u5728\u964d\u4f4e\u57fa\u7840\u8bbe\u65bd\u6210\u672c\u548c\u63d0\u9ad8\u6027\u80fd\u3002\u5b83\u7684\u672c\u8d28\u662f\u5206\u79bb sidecar proxy\uff08Envoy\uff09\u4e2d\u7684 L4 \u548c L7 \u529f\u80fd\uff0c\u8ba9\u4e00\u90e8\u5206\u4ec5\u9700\u8981\u5b89\u5168\u529f\u80fd\u7684\u7528\u6237\u53ef\u4ee5\u6700\u5c0f\u963b\u529b\uff08\u4f4e\u8d44\u6e90\u6d88\u8017\u3001\u8fd0\u7ef4\u6210\u672c\uff09\u5730\u4f7f\u7528 Istio service mesh\u3002</p> <p>ambient mesh \u5c06 Istio \u7684\u529f\u80fd\u62c6\u5206\u4e3a 2 \u4e2a\u4e0d\u540c\u7684\u5c42\u6b21\uff1a</p> <ul> <li>L4 \u5b89\u5168\u8986\u76d6\u5c42\uff1a\u7528\u6237\u53ef\u4ee5\u4f7f\u7528 TCP \u8def\u7531\uff0cmTLS \u548c\u6709\u9650\u7684\u53ef\u89c2\u6d4b\u6027\u7b49\u529f\u80fd\u3002</li> <li>L7 \u5904\u7406\u5c42\uff1a\u7528\u6237\u53ef\u4ee5\u6309\u9700\u542f\u7528 L7 \u529f\u80fd\uff0c\u4ee5\u83b7\u5f97 Istio \u7684\u5168\u90e8\u529f\u80fd\uff0c\u4f8b\u5982\u9650\u901f\uff0c\u6545\u969c\u6ce8\u5165\uff0c\u8d1f\u8f7d\u5747\u8861\uff0c\u7194\u65ad\u7b49\u7b49\u3002</li> </ul> <p></p> <p>ztunnel \u662f ambient mesh \u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u5171\u4eab\u4ee3\u7406\uff0c\u4ee5 DaemonSet \u7684\u65b9\u5f0f\u90e8\u7f72\uff0c\u5904\u4e8e\u7c7b\u4f3c\u4e8e CNI \u7684\u7f51\u683c\u5e95\u5c42\u3002</p> <p>ztunnel \u5728\u8282\u70b9\u95f4\u6784\u5efa\u96f6\u4fe1\u4efb\u7684\u96a7\u9053\uff08zero-trust tunnel, ztunnel\uff09\uff0c\u8d1f\u8d23\u5b89\u5168\u5730\u8fde\u63a5\u548c\u9a8c\u8bc1\u7f51\u683c\u5185\u7684\u5143\u7d20\u3002</p> <p>\u5728 ambient mesh \u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6240\u6709\u6d41\u91cf\u4f1a\u91cd\u5b9a\u5411\u5230\u672c\u5730\u7684 ztunnel \u8fdb\u884c\u5904\u7406\uff0cztunnel \u8bc6\u522b\u6d41\u91cf\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5e76\u4e3a\u5176\u9009\u62e9\u6b63\u786e\u7684\u8bc1\u4e66\u4ee5\u5efa\u7acb mTLS \u8fde\u63a5\u3002</p> <p>ztunnel \u5b9e\u73b0\u4e86\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6838\u5fc3\u529f\u80fd\uff1a\u96f6\u4fe1\u4efb\uff0c\u5b83\u4f1a\u4e3a\u542f\u7528\u4e86 ambient mesh \u7684 Namespace \u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u4e00\u4e2a\u5b89\u5168\u8986\u76d6\u5c42\uff0c\u63d0\u4f9b mTLS\uff0c\u9065\u6d4b\uff0c\u8ba4\u8bc1\u548c L4 \u6388\u6743\u7b49\u529f\u80fd\uff0c\u800c\u65e0\u9700\u7ec8\u6b62\u6216\u89e3\u6790 HTTP\u3002</p> <p></p> <p>\u5728\u542f\u7528 ambient mesh \u548c\u521b\u5efa\u5b89\u5168\u8986\u76d6\u5c42\u4e4b\u540e\uff0c\u53ef\u4ee5\u9009\u62e9\u6027\u5730\u4e3a namespace \u542f\u7528 L7 \u529f\u80fd\uff0c\u8fd9\u5141\u8bb8\u547d\u540d\u7a7a\u95f4\u5b9e\u73b0\u5168\u5957\u7684 Istio \u529f\u80fd\uff0c\u5305\u62ec Virtual Service\u3001L7 \u9065\u6d4b \u548c L7 \u6388\u6743\u7b56\u7565\u3002</p> <p>waypoint proxy \u53ef\u4ee5\u6839\u636e\u6240\u670d\u52a1\u7684 Namespace \u7684\u5b9e\u65f6\u6d41\u91cf\u81ea\u52a8\u6269\u7f29\u5bb9\uff0c\u8fd9\u5c06\u4e3a\u7528\u6237\u8282\u7701\u5927\u91cf\u7684\u8d44\u6e90\u3002</p> <p></p> <p>Istio \u4f1a\u4e3a\u6839\u636e\u670d\u52a1\u7684 service account \u521b\u5efa\u76f8\u5e94\u7684 waypoint proxy\uff0c\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u5728\u51cf\u5c11\u8d44\u6e90\u6d88\u8017\u7684\u60c5\u51b5\u4e0b\u540c\u65f6\u5c3d\u53ef\u80fd\u5730\u7f29\u5c0f\u6545\u969c\u57df\uff0c\u53c2\u89c1\u4e0b\u56fe Model III\u3002 </p> <p></p>"},{"location":"chap10/2istio_ambient/#2-ambient-mesh","title":"2 Ambient Mesh \u652f\u6301\u7684\u73af\u5883\u548c\u9650\u5236","text":"<p>\u76ee\u524d\u5df2\u77e5 ambient mesh \u4ec5\u652f\u6301\u4ee5\u4e0b\u73af\u5883\uff0c\u5176\u4ed6\u73af\u5883\u76ee\u524d\u5c1a\u672a\u7ecf\u8fc7\u6d4b\u8bd5\u3002</p> <ul> <li>GKE (without Calico or Dataplane V2)</li> <li>EKS</li> <li>kind</li> </ul> <p>\u5e76\u4e14 ambient mesh \u8fd8\u6709\u8bb8\u591a\u9650\u5236\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>AuthorizationPolicy \u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u6ca1\u6709\u9884\u671f\u7684\u90a3\u4e48\u4e25\u683c\uff0c\u6216\u8005\u6839\u672c\u65e0\u6548\u3002</li> <li>\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u76f4\u63a5\u8bbf\u95ee Pod IP \u800c\u4e0d\u662f Service \u7684\u8bf7\u6c42\u5c06\u65e0\u6548\u3002</li> <li>ambient mesh \u4e0b\u7684\u670d\u52a1\u65e0\u6cd5\u901a\u8fc7 LoadBalancer \u548c NodePort \u7684\u65b9\u5f0f\u8bbf\u95ee\uff0c\u4e0d\u8fc7\u4f60\u53ef\u4ee5\u90e8\u7f72\u4e00\u4e2a\u5165\u53e3\u7f51\u5173\uff08\u672a\u542f\u7528 ambient mesh\uff09\u4ee5\u4ece\u5916\u90e8\u8bbf\u95ee\u670d\u52a1\uff1b</li> <li>STRICT mTLS \u4e0d\u80fd\u5b8c\u5168\u963b\u6b62\u660e\u6587\u6d41\u91cf\u3002</li> <li>\u4e0d\u652f\u6301 EnvoyFilter\u3002</li> </ul> <p>\u8be6\u7ec6\u8bf4\u660e\u8bf7\u53c2\u89c1 Ambient Mesh\u3002</p>"},{"location":"chap10/2istio_ambient/#3-eksctl-aws-kubernetes","title":"3 \u4f7f\u7528 Eksctl \u5728 AWS \u4e0a\u521b\u5efa Kubernetes \u96c6\u7fa4","text":"<p>\u5728\u672c\u793a\u4f8b\u4e2d\uff0c\u5c06\u4f7f\u7528 eksctl \u5728 AWS \u4e0a\u521b\u5efa EKS \u96c6\u7fa4\u6765\u6d4b\u8bd5 Istio ambient mesh\u3002eksctl  \u662f\u4e00\u4e2a\u7528\u4e8e\u7ba1\u7406 EKS\uff08Amazon \u6258\u7ba1 Kubernetes \u670d\u52a1\uff09\u7684 CLI \u5de5\u5177\u3002\u6709\u5173 eksctl \u7684\u5b89\u88c5\u548c\u4f7f\u7528\u53c2\u89c1 eksctl Getting started</p> <p>\u521b\u5efa\u96c6\u7fa4\u914d\u7f6e\u6587\u4ef6 cluster.yaml\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a 2 \u4e2a Worker \u8282\u70b9\u7684 EKS \u96c6\u7fa4\uff0c\u6bcf\u4e2a\u8282\u70b9\u8d44\u6e90\u4e3a 2C8G\uff0c\u96c6\u7fa4\u7248\u672c\u4e3a 1.23\u3002</p> <pre><code>apiVersion: eksctl.io/v1alpha5\nkind: ClusterConfig\n\nmetadata:\n  name: aws-demo-cluster01\n  region: us-east-1\n  version: '1.23'\n\nnodeGroups:\n  - name: ng-1\n    instanceType: m5.large\n    desiredCapacity: 2\n    volumeSize: 100\n    ssh:\n      allow: true # will use ~/.ssh/id_rsa.pub as the default ssh key\n</code></pre> <p>\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u521b\u5efa EKS \u96c6\u7fa4\u3002</p> <pre><code>eksctl create cluster -f cluster.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b EKS \u96c6\u7fa4\u3002</p> <pre><code>&gt; eksctl get cluster\nNAME   REGION  EKSCTL CREATED\naws-demo-cluster01 us-east-1 True\n</code></pre> <p>\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5c06 aws-demo-cluster01 \u96c6\u7fa4\u7684 kubeconfig \u6587\u4ef6\u66f4\u65b0\u5230 <code>~/.kube/config</code> \u6587\u4ef6\u4e2d\uff0c\u8ba9\u6211\u4eec\u672c\u5730\u7684 kubectl \u5de5\u5177\u53ef\u4ee5\u8bbf\u95ee\u5230 <code>aws-demo-cluster01</code> \u96c6\u7fa4\u3002</p> <pre><code>aws eks update-kubeconfig --region us-east-1 --name aws-demo-cluster01\n</code></pre> <p>\u6709\u5173 aws CLI \u5de5\u5177\u7684\u5b89\u88c5\u53c2\u89c1 Installing or updating the latest version of the AWS CLI \uff0caws CLI \u7684\u8ba4\u8bc1\u53c2\u89c1 Configuration basics\u3002</p>"},{"location":"chap10/2istio_ambient/#4-istio","title":"4 \u4e0b\u8f7d Istio","text":"<p>\u6839\u636e\u5bf9\u5e94\u64cd\u4f5c\u7cfb\u7edf\u4e0b\u8f7d\u652f\u6301 ambient mesh \u7684 istioctl \u4e8c\u8fdb\u5236\u6587\u4ef6\u548c\u793a\u4f8b\u8d44\u6e90\u6587\u4ef6\uff0c\u53c2\u89c1 Istio \u4e0b\u8f7d\u3002\u5176\u4e2d istioctl \u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u53ef\u4ee5\u5728 bin \u76ee\u5f55\u4e2d\u627e\u5230\uff0c\u793a\u4f8b\u8d44\u6e90\u6587\u4ef6\u53ef\u4ee5\u5728 samples \u76ee\u5f55\u4e2d\u627e\u5230\u3002</p>"},{"location":"chap10/2istio_ambient/#5","title":"5 \u90e8\u7f72\u793a\u4f8b\u5e94\u7528","text":"<p>\u90e8\u7f72 Istio \u793a\u4f8b\u7684 Bookinfo \u5e94\u7528\u7a0b\u5e8f\uff0c\u4ee5\u53ca sleep \u548c notsleep \u4e24\u4e2a\u5ba2\u6237\u7aef\u3002sleep \u548c notsleep \u53ef\u4ee5\u6267\u884c curl \u547d\u4ee4\u6765\u53d1\u8d77 HTTP \u8bf7\u6c42\u3002</p> <pre><code>kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml\nkubectl apply -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/sleep.yaml\nkubectl apply -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/notsleep.yaml\n</code></pre> <p>\u5f53\u524d\u6211\u4eec\u90e8\u7f72\u7684 istio \u548c\u5e94\u7528\u7684 Pod \u548c Service \u5982\u4e0b\u6240\u793a\u3002</p> <p></p>"},{"location":"chap10/2istio_ambient/#6-istio","title":"6 \u90e8\u7f72 Istio","text":"<p>\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5b89\u88c5 Istio\uff0c\u5e76\u6307\u5b9a <code>profile=ambient</code> \u53c2\u6570\u90e8\u7f72 <code>ambient mesh</code> \u76f8\u5173\u7684\u7ec4\u4ef6\u3002</p> <pre><code>istioctl install --set profile=ambient\n</code></pre> <p>\u5982\u679c\u5b89\u88c5\u6210\u529f\u5c06\u4f1a\u8f93\u51fa\u4ee5\u4e0b\u7ed3\u679c\u3002</p> <pre><code>\u2714 Istio core installed\n\u2714 Istiod installed\n\u2714 Ingress gateways installed\n\u2714 CNI installed\n\u2714 Installation complete\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u4ee5\u540e\u6211\u4eec\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u5185\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u7ec4\u4ef6\uff1a</p> <ul> <li>istiod\uff1aIstio \u7684\u6838\u5fc3\u7ec4\u4ef6\u3002</li> <li><code>istio-ingressgateway</code>\uff1a\u7ba1\u7406\u8fdb\u51fa\u96c6\u7fa4\u7684\u5357\u5317\u5411\u6d41\u91cf\uff0c\u5728\u672c\u793a\u4f8b\u4e2d\u6211\u4eec\u4e0d\u4f1a\u7528\u5230 <code>istio-ingressgateway</code>\u3002</li> <li><code>istio-cni</code>\uff1a\u4e3a\u52a0\u5165 ambient mesh \u7684 Pod \u914d\u7f6e\u6d41\u91cf\u91cd\u5b9a\u5411\uff0c\u5c06 Pod \u7684\u8fdb\u51fa\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u76f8\u540c\u8282\u70b9\u7684 ztunnel \u4e0a\u3002</li> <li><code>ztunnel</code>\uff1aztunnel \u5728\u8282\u70b9\u95f4\u6784\u5efa\u96f6\u4fe1\u4efb\u7684\u96a7\u9053\uff0c\u63d0\u4f9b mTLS\uff0c\u9065\u6d4b\uff0c\u8ba4\u8bc1\u548c L4 \u6388\u6743\u7b49\u529f\u80fd\u3002</li> </ul> <pre><code>&gt; kubectl get pod -n istio-system\nNAME                                   READY   STATUS    RESTARTS   AGE\nistio-cni-node-gfmqp                   1/1     Running   0          100s\nistio-cni-node-t2flv                   1/1     Running   0          100s\nistio-ingressgateway-f6d95c86b-mfk4t   1/1     Running   0          101s\nistiod-6c99d96db7-4ckbm                1/1     Running   0          2m23s\nztunnel-fnjg2                          1/1     Running   0          2m24s\nztunnel-k4jhb                          1/1     Running   0          2m24s  \n</code></pre>"},{"location":"chap10/2istio_ambient/#7","title":"7 \u6293\u5305\u8bbe\u7f6e","text":"<p>\u4e3a\u4e86\u66f4\u76f4\u89c2\u5730\u89c2\u5bdf\u6d41\u91cf\u7684\u8bbf\u95ee\u60c5\u51b5 \uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9 Pod \u8fdb\u884c\u6293\u5305\uff0c\u4f46\u662f\u5e94\u7528 Pod \u5e76\u6ca1\u6709\u5b89\u88c5\u76f8\u5173\u7684\u6293\u5305\u5de5\u5177\uff0c\u8fd9\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>kubectl debug</code> \u5de5\u5177\u521b\u5efa\u4e00\u4e2a <code>ephemeral</code> \u4e34\u65f6\u5bb9\u5668\u5171\u4eab\u5bb9\u5668\u7684\u547d\u540d\u7a7a\u95f4\u6765\u8fdb\u884c\u8c03\u8bd5\u3002\u6709\u5173 kubectl debug \u8be6\u60c5\u8bf7\u53c2\u89c1\u8c03\u8bd5\u8fd0\u884c\u4e2d\u7684 Pod\u3002</p> <p>\u5728 4 \u4e2a\u7ec8\u7aef\u5206\u522b\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5bf9 sleep \u548c productpage \u4ee5\u53ca\u4e24\u4e2a\u8282\u70b9\u4e0a\u7684 ztunnel Pod \u8fdb\u884c\u6293\u5305\u3002<code>--image</code> \u53c2\u6570\u6307\u5b9a\u4e34\u65f6\u5bb9\u5668\u7684\u955c\u50cf\uff0c\u8fd9\u91cc\u4f7f\u7528\u7684 nicolaka/netshoot \u955c\u50cf\u4e2d\u9884\u88c5\u4e86 <code>tcpdump</code>, <code>tshark</code>, <code>termshark</code>\u7b49\u5e38\u7528\u7684\u7f51\u7edc\u6293\u5305\u5de5\u5177\u3002</p> <pre><code>kubectl debug -it sleep-55697f8897-n2ldz  --image=nicolaka/netshoot \nkubectl debug -it productpage-v1-5586c4d4ff-z8jbb --image=nicolaka/netshoot\nkubectl debug -it -n istio-system ztunnel-fnjg2 --image=nicolaka/netshoot \nkubectl debug -it -n istio-system ztunnel-k4jhb --image=nicolaka/netshoot\n</code></pre> <p>\u5728 4 \u4e2a\u7ec8\u7aef\u5206\u522b\u6267\u884c <code>termshark -i eth0</code> \u547d\u4ee4\uff0c\u5bf9 Pod \u7684 eth0 \u7f51\u5361\u8fdb\u884c\u6293\u5305\u3002</p> <p>\u7531\u4e8e <code>istio-cni</code> \u4f1a\u6301\u7eed\u5bf9 <code>ztunnel</code> \u53d1\u8d77\u8def\u5f84\u4e3a <code>/healthz/ready</code> \u7684HTTP \u5065\u5eb7\u63a2\u6d4b\uff0c\u4e3a\u4e86\u907f\u514d\u8be5\u6d41\u91cf\u5f71\u54cd\u6211\u4eec\u7684\u89c2\u5bdf\uff0c\u5728 2 \u4e2a ztunnel Pod \u4e2d\u7684 termshark Filter \u6846\u4e2d\u8bbe\u7f6e\u4ee5\u4e0b\u8fc7\u6ee4\u6761\u4ef6\u3002</p> <pre><code># ztunnel-fnjg2\uff0csleep \u6240\u5728\u8282\u70b9\u7684 ztunnel\nip.addr==192.168.58.148 || ip.addr==192.168.13.108\n\n# ztunnel-k4jhb\uff0cproductpage \u6240\u5728\u8282\u70b9\u7684 ztunnel\nip.addr==192.168.13.108\n</code></pre> <p></p>"},{"location":"chap10/2istio_ambient/#8-ambient-mesh","title":"8 \u672a\u4f7f\u7528 Ambient Mesh \u7ba1\u7406\u6d41\u91cf","text":"<p>\u7531\u4e8e\u5f53\u524d default Namespace \u8fd8\u6ca1\u6709\u52a0\u5165 ambient mesh\uff0c\u6b64\u65f6\u5e94\u7528\u7684\u6d41\u91cf\u5e76\u4e0d\u4f1a\u7ecf\u8fc7 ztunnel\uff0cPod \u4e4b\u95f4\u901a\u8fc7 kubernetes \u7684 Service \u8fdb\u5236\u8fdb\u884c\u901a\u4fe1\uff0cPod \u4e4b\u95f4\u7684\u6d41\u91cf\u4e5f\u4e0d\u4f1a\u8fdb\u884c mTLS \u52a0\u5bc6\uff0c\u800c\u662f\u4ee5\u660e\u6587\u7684\u65b9\u5f0f\u8fdb\u884c\u4f20\u64ad\u3002</p> <p></p> <p>\u4f7f\u7528 sleep \u5411 productpage \u53d1\u8d77\u4e00\u6b21\u8bf7\u6c42\u3002</p> <pre><code>kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1\n\n# \u8fd4\u56de\u7ed3\u679c\uff0c\u54cd\u5e94\u7ed3\u679c\u7684\u7b2c\u4e00\u884c\u5185\u5bb9\n&lt;!DOCTYPE html&gt;\n</code></pre> <p>\u67e5\u770b sleep \u548c productpage \u7684\u6293\u5305\u7ed3\u679c\u53ef\u4ee5\u770b\u5230\uff0csleep \uff08192.168.58.148\uff09 \u8bbf\u95ee productpage Service \u540d\u79f0 DNS \u89e3\u6790\u540e\u7684 service IP\uff0810.100.171.143\uff09\uff0c\u7ecf\u8fc7 kubernetes Service \u7684\u8f6c\u53d1\u540e\uff0c\u6700\u7ec8\u8bbf\u95ee\u5230 productpage \u7684\u5b9e\u9645 Pod IP \uff08192.168.13.108\uff09\u3002</p> <p></p> <p>\u6b64\u65f6 ambient mesh \u8fd8\u672a\u63a5\u7ba1 default Namespace \u7684\u6d41\u91cf\uff0c\u56e0\u6b64\u5728 ztunnel \u4e0a\u4e0d\u4f1a\u6293\u5230\u76f8\u5173\u7684\u6570\u636e\u5305\u3002</p> <p></p>"},{"location":"chap10/2istio_ambient/#9-default-namespace-ambient-meshl4","title":"9 \u5c06 Default Namespace \u52a0\u5165 Ambient Mesh\uff08L4 \u529f\u80fd\uff09","text":"<p>\u4e3a default Namespace \u6dfb\u52a0 <code>istio.io/dataplane-mode=ambient</code> \u6807\u7b7e\uff0c\u8868\u793a\u5c06\u8be5 Namespace \u52a0\u5165\u5230 ambient mesh \u4e2d\u3002</p> <pre><code>kubectl label namespace default istio.io/dataplane-mode=ambient\n</code></pre> <p>\u4e00\u65e6 Namespace \u52a0\u5165 <code>ambient mesh</code>\uff0c<code>istio-cni DaemonSet</code> \u5c31\u4f1a\u4e3a\u8be5 Namespace \u4e2d\u7684 Pod \u8bbe\u7f6e iptables \u91cd\u5b9a\u5411\u89c4\u5219\uff0c\u5c06 Pod \u7684\u6240\u6709\u51fa\u5165\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u8fd0\u884c\u5728\u76f8\u540c\u8282\u70b9\u7684 <code>ztunnel</code> \u4e0a\u3002</p> <p></p>"},{"location":"chap10/2istio_ambient/#91-mtls","title":"9.1 MTLS \u6d41\u91cf\u52a0\u5bc6","text":"<p>ztunnel \u4f1a\u4e3a\u542f\u7528\u4e86 ambient mesh \u7684 Namespace \u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u4e00\u4e2a\u5b89\u5168\u8986\u76d6\u5c42\uff0c\u63d0\u4f9b mTLS\uff0c\u9065\u6d4b\uff0c\u8ba4\u8bc1\u548c L4 \u6388\u6743\u7b49\u529f\u80fd\u3002</p> <p></p> <p>\u4e3a\u4e86\u65b9\u4fbf\u67e5\u770b\uff0c\u53ef\u4ee5\u5148\u6e05\u9664\u5148\u524d\u5728 sleep \u548c productpage \u4e0a\u6293\u5230\u7684\u62a5\u6587\u3002</p> <p></p> <p>\u7136\u540e\u4f7f\u7528 sleep \u5411 productpage \u53d1\u8d77\u4e00\u6b21\u8bf7\u6c42\u3002</p> <pre><code>kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1\n</code></pre> <p>\u5728 sleep \u548c productpage \u4e0a\u4f9d\u7136\u53ef\u4ee5\u6293\u5230\u660e\u6587\u7684\u6570\u636e\u5305\uff0c\u53ea\u662f\u8fd9\u56de\u5728 productpage \u4e0a\u6293\u5230\u7684\u6570\u636e\u5305\u7684\u6e90 IP \u53d8\u4e3a\u7684 sleep \u6240\u5728\u8282\u70b9\u7684 ztunnel \u7684 IP \u5730\u5740\u3002</p> <p></p> <p>\u5728 sleep \u8282\u70b9\u6240\u5728\u7684 ztunnel \u4e0a\u6211\u4eec\u53ef\u4ee5\u6293\u5230 sleep \u53d1\u8fc7\u6765\u7684\u660e\u6587\u7684\u6570\u636e\u5305\uff0cztunnel \u4f1a\u5bf9\u6570\u636e\u5305\u8fdb\u884c\u52a0\u5bc6\u4ee5\u540e\u53d1\u9001\u7ed9 productpage \u8282\u70b9\u4e0a\u7684 ztunnel\u3002</p> <p>productpage \u8282\u70b9\u4e0a\u7684 ztunnel \u6536\u5230\u52a0\u5bc6\u7684\u6570\u636e\u5305\u540e\uff0c\u8fdb\u884c\u89e3\u5bc6\uff0c\u7136\u540e\u53d1\u9001\u7ed9 productpage\u3002</p> <p></p> <pre><code>kubectl logs -n istio-system ztunnel-fnjg2 -f\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 outbound \u6d41\u91cf\u7684\u65e5\u5fd7\u4e2d\u6709\uff08no waypoint proxy\uff09\u7684\u5b57\u6837\uff0cambient mesh \u9ed8\u8ba4\u53ea\u8fdb\u884c L4 \u5904\u7406\uff0c\u4e0d\u4f1a\u8fdb\u884c L7 \u5904\u7406\u3002\u56e0\u6b64\u6b64\u65f6\u6d41\u91cf\u53ea\u4f1a\u901a\u8fc7 ztunnel \uff0c\u4e0d\u4f1a\u7ecf\u8fc7 waypoint proxy\u3002</p> <p></p> <p>\u67e5\u770b inbound \u65b9\u5411\u7684\u6d41\u91cf\u65e5\u5fd7\uff08productpage \u4e0a\u7684 ztunnel -&gt; productpage\uff09\u3002</p> <pre><code>kubectl logs -n istio-system ztunnel-k4jhb -f\n</code></pre> <p></p>"},{"location":"chap10/2istio_ambient/#92-l4","title":"9.2 L4 \u6388\u6743\u7b56\u7565","text":"<p>\u5b89\u5168\u8986\u76d6\u5c42\u53ef\u4ee5\u5b9e\u73b0\u7b80\u5355\u7684 L4 \u6388\u6743\u7b56\u7565\uff0c\u5982\u4e0b\u6240\u793a\u521b\u5efa\u4e00\u4e2a <code>AuthorizationPolicy</code>\uff0c\u53ea\u5141\u8bb8 Service Account \u662f sleep \u7684\u7528\u6237\u8bbf\u95ee\u6807\u7b7e\u662f <code>app=productpage</code> \u5e94\u7528\u3002</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n name: productpage-viewer\n namespace: default\nspec:\n selector:\n   matchLabels:\n     app: productpage\n action: ALLOW\n rules:\n - from:\n   - source:\n       principals: [\"cluster.local/ns/default/sa/sleep\"]\nEOF\n</code></pre> <p>\u5206\u522b\u5728 sleep \u548c notsleep \u4e0a\u6267\u884c\u4ee5\u4e0b\u8bf7\u6c42\uff0c\u7531\u4e8e\u5f53\u524d\u8fd8\u6ca1\u6709\u542f\u7528 L7 \u5904\u7406\uff0c\u56e0\u6b64\u8fd8\u65e0\u6cd5\u9488\u5bf9 HTTP \u8bf7\u6c42\u65b9\u6cd5\uff0c\u8def\u5f84\u7b49\u6761\u4ef6\u8fdb\u884c\u9650\u5236\u3002</p> <pre><code># \u6210\u529f\nkubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1\n# \u6210\u529f\nkubectl exec deploy/sleep -- curl -XDELETE -s http://productpage:9080/ | head -n1\n# \u5931\u8d25\uff0c\u53ea\u5141\u8bb8 sa \u662f sleep \u7684\u7528\u6237\nkubectl exec deploy/notsleep -- curl -s http://productpage:9080/ | head -n1\n</code></pre>"},{"location":"chap10/2istio_ambient/#10-l7","title":"10 \u542f\u7528 L7 \u529f\u80fd","text":"<p>\u8981\u4e3a\u670d\u52a1\u542f\u7528 L7 \u7f51\u683c\u80fd\u529b\uff0c\u9700\u8981\u663e\u5f0f\u521b\u5efa\u4e00\u4e2a Gateway\uff0c\u6ce8\u610f\u521b\u5efa\u7684 Gateway \u8d44\u6e90\u4e2d\u7684 gatewayClassName \u5fc5\u987b\u8bbe\u7f6e\u4e3a istio-mesh\uff0c\u8fd9\u6837 Istio \u624d\u4f1a\u4e3a productpage \u521b\u5efa\u5bf9\u5e94\u7684 waypoint proxy\u3002</p> <p>\u4efb\u4f55\u53d1\u5f80 productpage \u670d\u52a1\u7684\u6d41\u91cf\u90fd\u5c06\u7ecf\u8fc7 waypoint proxy \u8fd9\u4e2a L7 \u4ee3\u7406\u8fdb\u884c\u5904\u7406\u3002</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: gateway.networking.k8s.io/v1alpha2\nkind: Gateway\nmetadata:\n name: productpage\n annotations:\n   istio.io/service-account: bookinfo-productpage\nspec:\n gatewayClassName: istio-mesh\nEOF\n</code></pre> <p>\u67e5\u770b Istio \u4e3a productpage \u521b\u5efa\u7684 waypoint proxy\u3002</p> <p></p> <p>\u4ece sleep \u8bbf\u95ee productpage\u3002</p> <pre><code>kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1\n</code></pre> <p>\u67e5\u770b outbound \u65b9\u5411\u7684\u6d41\u91cf\u65e5\u5fd7\uff08sleep -&gt; sleep node \u4e0a\u7684 ztunnel -&gt; waypoint proxy\uff09\u3002</p> <p></p> <pre><code>kubectl logs -n istio-system ztunnel-fnjg2 -f\n</code></pre> <p>\u4ece\u4e0b\u9762\u7684\u65e5\u5fd7\u4e2d\u53ef\u4ee5\u770b\u5230\uff08to server waypoint proxy\uff09\u7684\u5b57\u6837\uff0c\u8bf4\u660e\u8bf7\u6c42\u53d1\u5f80 waypoint proxy \u8fdb\u884c\u5904\u7406\u3002</p> <p></p>"},{"location":"chap10/2istio_ambient/#101-l7","title":"10.1 L7 \u6388\u6743\u7b56\u7565","text":"<p>\u63a5\u4e0b\u6765\u66f4\u65b0 AuthorizationPolicy \u53ea\u5141\u8bb8 Service Account \u662f sleep \u7684\u7528\u6237\u901a\u8fc7 GET \u7684\u65b9\u5f0f\u8bbf\u95ee\u6807\u7b7e\u662f <code>app=productpage</code> \u5e94\u7528\u3002</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n name: productpage-viewer\n namespace: default\nspec:\n selector:\n   matchLabels:\n     app: productpage\n action: ALLOW\n rules:\n - from:\n   - source:\n       principals: [\"cluster.local/ns/default/sa/sleep\"]\n   to:\n   - operation:\n       methods: [\"GET\"]\nEOF\n</code></pre> <p>\u5206\u522b\u5728 sleep \u548c notsleep \u4e0a\u6267\u884c\u4ee5\u4e0b\u8bf7\u6c42\uff0c\u8fd9\u6b21\u5728 sleep \u4e0a\u6267\u884c HTTP DELETE \u8bf7\u6c42\u4e5f\u4f1a\u88ab\u62d2\u7edd\u4e86\u3002</p> <pre><code># \u6210\u529f\nkubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1\n# \u5931\u8d25\uff0cRBAC \u9519\u8bef\uff0c\u56e0\u4e3a\u4e0d\u662f GET \u8bf7\u6c42\nkubectl exec deploy/sleep -- curl -X DELETE -s http://productpage:9080/ | head -n1\n# \u5931\u8d25\uff0cRBAC \u9519\u8bef\uff0c\u53ea\u5141\u8bb8 sa \u662f sleep \u7684\u7528\u6237\nkubectl exec deploy/notsleep -- curl -s http://productpage:9080/  | head -n1\n</code></pre>"},{"location":"chap10/2istio_ambient/#102","title":"10.2 \u53ef\u89c2\u6d4b\u6027","text":"<p>\u5728 <code>productpage waypoint proxy</code> \u4e0a\u53ef\u4ee5\u67e5\u770b\u6240\u6709\u5bf9 productpage \u670d\u52a1\u8bf7\u6c42\u7684 L7 \u6307\u6807\u3002</p> <pre><code>kubectl exec deploy/bookinfo-productpage-waypoint-proxy -- curl -s http://localhost:15020/stats/prometheus | grep istio_requests_total\n</code></pre> <p></p>"},{"location":"chap10/2istio_ambient/#103","title":"10.3 \u6d41\u91cf\u63a7\u5236","text":"<p>\u9996\u5148\u4e3a reviews \u670d\u52a1\u521b\u5efa\u4e00\u4e2a gateway\uff0c\u542f\u7528 L7 \u80fd\u529b\u3002</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: gateway.networking.k8s.io/v1alpha2\nkind: Gateway\nmetadata:\n name: reviews\n annotations:\n   istio.io/service-account: bookinfo-reviews\nspec:\n gatewayClassName: istio-mesh\nEOF\n</code></pre> <p>\u7136\u540e\u5206\u522b\u521b\u5efa VirtualService \u548c DestinationRule \u6765\u63a7\u5236\u6d41\u91cf\u4ee5 90/10 \u7684\u6bd4\u4f8b\u53d1\u5f80 v1 \u7248\u672c\u548c v2 \u7248\u672c\u7684 reviews \u670d\u52a1\u3002</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v1\n      weight: 90\n    - destination:\n        host: reviews\n        subset: v2\n      weight: 10\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: reviews\nspec:\n  host: reviews\n  trafficPolicy:\n    loadBalancer:\n      simple: RANDOM\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n  - name: v3\n    labels:\n      version: v3\nEOF\n</code></pre> <p>\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u4ece sleep \u5f80 productpage \u53d1\u9001 10 \u4e2a\u8bf7\u6c42\uff0c\u53ef\u4ee5\u770b\u5230\u5927\u7ea6\u6709 10% \u7684\u6d41\u91cf\u6d41\u5411\u4e86 <code>reviews-v2</code>\u3002</p> <pre><code># \u6ce8\u610f\u8bbf\u95ee\u8def\u5f84\u662f http://productpage:9080/productpage\uff0c\u4f1a\u8c03\u7528 reviews \u670d\u52a1\nkubectl exec -it deploy/sleep -- sh -c 'for i in $(seq 1 10); do curl -s http://productpage:9080/productpage | grep reviews-v.-; done'\n\n# \u8fd4\u56de\u7ed3\u679c\n &lt;u&gt;reviews-v1-7598cc9867-dh7hp&lt;/u&gt;\n &lt;u&gt;reviews-v1-7598cc9867-dh7hp&lt;/u&gt;\n &lt;u&gt;reviews-v1-7598cc9867-dh7hp&lt;/u&gt;\n &lt;u&gt;reviews-v1-7598cc9867-dh7hp&lt;/u&gt;\n &lt;u&gt;reviews-v2-6bdd859457-7lxhc&lt;/u&gt;\n &lt;u&gt;reviews-v1-7598cc9867-dh7hp&lt;/u&gt;\n &lt;u&gt;reviews-v1-7598cc9867-dh7hp&lt;/u&gt;\n &lt;u&gt;reviews-v1-7598cc9867-dh7hp&lt;/u&gt;\n &lt;u&gt;reviews-v1-7598cc9867-dh7hp&lt;/u&gt;\n &lt;u&gt;reviews-v2-6bdd859457-7lxhc&lt;/u&gt;\n</code></pre>"},{"location":"chap10/2istio_ambient/#104","title":"10.4 \u6545\u969c\u6ce8\u5165","text":"<p>\u4e3a productpage \u670d\u52a1\u521b\u5efa\u4e00\u4e2a VirtualService\uff0c\u5728\u8bf7\u6c42\u4e2d\u6ce8\u5165 5s \u7684\u5ef6\u65f6\u3002</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: productpage\nspec:\n  hosts:\n    - productpage\n  http:\n  - route:\n    - destination:\n        host: productpage\n    fault:\n      delay:\n         percentage:\n            value: 100.0\n         fixedDelay: 5s\nEOF\n</code></pre> <p>\u4ece sleep \u8bbf\u95ee productpage\uff0c\u53ef\u4ee5\u770b\u5230\u8bf7\u6c42\u6d88\u8017\u7684\u65f6\u95f4\u5927\u7ea6\u5728 5s \u5de6\u53f3\u3002</p> <pre><code>&gt; kubectl exec deploy/sleep -- time curl -s http://productpage:9080 | head -n 1\n\n# \u8fd4\u56de\u7ed3\u679c\n&lt;!DOCTYPE html&gt;\nreal 0m 5.04s\nuser 0m 0.00s\nsys     0m 0.00s\n</code></pre>"},{"location":"chap10/2istio_ambient/#11","title":"11 \u6e05\u7406\u73af\u5883","text":"<pre><code># \u5378\u8f7d Istio\nistioctl uninstall -y --purge &amp;&amp; istioctl delete ns istio-system\n# \u5220\u9664\u793a\u4f8b\u5e94\u7528\nkubectl delete -f samples/bookinfo/platform/kube/bookinfo.yaml\nkubectl delete -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/sleep.yaml\nkubectl delete -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/notsleep.yaml\n# \u5220\u9664\u96c6\u7fa4\neksctl delete cluster aws-demo-cluster01\n</code></pre>"},{"location":"chap10/2istio_ambient/#12-demo","title":"12 \u4f53\u9a8c Demo","text":"<p>\u60f3\u8981\u5feb\u901f\u4f53\u9a8c ambient mesh \u7684\u670b\u53cb\u4e5f\u53ef\u4ee5\u5728 solo.io \u5b98\u7f51 \u4e0a\u5c1d\u8bd5\u4e0a\u624b\u6559\u7a0b\u3002</p> <p></p> <ul> <li>Istio \u65e0 sidecar \u4ee3\u7406\u6570\u636e\u5e73\u9762 ambient \u6a21\u5f0f\u7b80\u4ecb: https://lib.jimmysong.io/blog/introducing-ambient-mesh/</li> <li>\u8bd1\u6587\uff1aIstio Ambient \u6a21\u5f0f\u5b89\u5168\u67b6\u6784\u6df1\u5ea6\u89e3\u6790: https://www.zhaohuabing.com/post/2022-09-09-ambient-mesh-security-deep-dive/</li> <li>\u5982\u4f55\u8bc4\u4ef7 Istio \u65b0\u63a8\u51fa\u7684 Ambient \u6a21\u5f0f\uff1f: https://mp.weixin.qq.com/s/98wXMdeutx0wHqcJUIFl8A</li> <li>\u521d\u63a2 Istio Ambient \u6a21\u5f0f: https://mp.weixin.qq.com/s/YA2My5PSHXIwovWLRKmsgA</li> <li>Istio Ambient \u6a21\u5f0f HBONE \u96a7\u9053\u539f\u7406\u8be6\u89e3 - \u4e0a: https://mp.weixin.qq.com/s/ksiYJEJKnit65KfIIGoN8Q</li> <li>Create a kubeconfig for Amazon EKS: https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html</li> <li>Beyond Istio OSS \u2014\u2014 Istio \u670d\u52a1\u7f51\u683c\u7684\u73b0\u72b6\u4e0e\u672a\u6765: https://jimmysong.io/blog/beyond-istio-oss/#sidecar-management</li> </ul>"},{"location":"chap10/3aeraki/","title":"3 \u5927\u89c4\u6a21\u573a\u666f\u4e0b\u5bf9Istio\u7684\u6027\u80fd\u4f18\u5316","text":""},{"location":"chap10/3aeraki/#_1","title":"\u7b80\u4ecb","text":"<p>\u5f53\u524distio\u4e0b\u53d1xDS\u4f7f\u7528\u7684\u662f\u5168\u91cf\u4e0b\u53d1\u7b56\u7565\uff0c\u4e5f\u5c31\u662f\u7f51\u683c\u91cc\u7684\u6240\u6709sidecar(envoy)\uff0c\u5185\u5b58\u91cc\u90fd\u4f1a\u6709\u6574\u4e2a\u7f51\u683c\u5185\u6240\u6709\u7684\u670d\u52a1\u53d1\u73b0\u6570\u636e\u3002</p> <p>\u8fd9\u6837\u7684\u7ed3\u679c\u662f\uff0c\u6bcf\u4e2asidecar\u5185\u5b58\u90fd\u4f1a\u968f\u7740\u7f51\u683c\u89c4\u6a21\u589e\u957f\u800c\u589e\u957f\u3002</p>"},{"location":"chap10/3aeraki/#aeraki-mesh","title":"Aeraki-mesh","text":"<ul> <li>egress\uff1a\u5145\u5f53\u7c7b\u4f3c\u7f51\u683c\u6a21\u578b\u4e2d\u9ed8\u8ba4\u7f51\u5173\u89d2\u8272</li> <li>controller\uff1a\u7528\u6765\u5206\u6790\u5e76\u8865\u5168\u670d\u52a1\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb</li> </ul>"},{"location":"chap10/3aeraki/#egress","title":"Egress","text":"<p>\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u4e3a\uff1alazyxds-egress.yaml</p> <p>\u4e0b\u9762\u6765\u4e00\u4e00\u67e5\u770b\u8be5\u7ec4\u4ef6\u7684\u7ec4\u6210\u90e8\u5206</p> <p>\u7ec4\u4ef6\u914d\u7f6e</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: istio-egressgateway-lazyxds\n  namespace: istio-system\n  labels:\n    app: istio-egressgateway-lazyxds\n    istio: egressgateway\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: istio-egressgateway-lazyxds\n      istio: egressgateway\n  template:\n    metadata:\n      annotations:\n        sidecar.istio.io/discoveryAddress: istiod.istio-system.svc:15012\n        sidecar.istio.io/inject: \"false\"\n      labels:\n        app: istio-egressgateway-lazyxds\n        istio: egressgateway\n    spec:\n      containers:\n        - args:\n            ......\n          image: docker.io/istio/proxyv2:1.10.0\n          imagePullPolicy: IfNotPresent\n          name: istio-proxy\n          ports:\n            - containerPort: 8080\n              protocol: TCP\n            - containerPort: 15090\n              name: http-envoy-prom\n              protocol: TCP\n          ......\n          volumeMounts:\n            - mountPath: /etc/istio/custom-bootstrap\n              name: custom-bootstrap-volume\n            ......\n      volumes:\n        - configMap:\n            defaultMode: 420\n            name: lazyxds-als-bootstrap\n          name: custom-bootstrap-volume\n</code></pre> <p>\u7531\u4e8e\u914d\u7f6e\u592a\u591a\uff0c\u8fd9\u91cc\u53ea\u6311\u9009\u4e3b\u8981\u7684\u90e8\u5206\uff0c\u4ece\u4e0a\u9762\u53ef\u4ee5\u770b\u51fa\uff0c\u5176\u5b9e\u662f\u542f\u52a8\u4e00\u4e2a<code>istio proxy</code>\uff0c\u8be5<code>proxy</code>\u7684\u542f\u52a8\u914d\u7f6e\u6587\u4ef6\u662f\u4f7f\u7528\u7684<code>configmap</code>\u6302\u8f7d\u51fa\u6765\u7684\u3002</p>"},{"location":"chap10/3aeraki/#_2","title":"\u542f\u52a8\u914d\u7f6e","text":"<pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: lazyxds-als-bootstrap\n  namespace: istio-system\ndata:\n  custom_bootstrap.json: |\n    {\n      \"static_resources\": {\n        \"clusters\": [{\n          \"name\": \"lazyxds-accesslog-service\",\n          \"type\": \"STRICT_DNS\",\n          \"connect_timeout\": \"1s\",\n          \"http2_protocol_options\": {},\n          \"dns_lookup_family\": \"V4_ONLY\",\n          \"load_assignment\": {\n            \"cluster_name\": \"lazyxds-accesslog-service\",\n            \"endpoints\": [{\n              \"lb_endpoints\": [{\n                \"endpoint\": {\n                  \"address\": {\n                    \"socket_address\": {\n                      \"address\": \"lazyxds.istio-system\",\n                      \"port_value\": 8080\n                    }\n                  }\n                }\n              }]\n            }]\n          },\n          \"respect_dns_ttl\": true\n        }]\n      }\n    }\n</code></pre> <p>\u4ece\u4e0a\u9762\u914d\u7f6e\u53ef\u4ee5\u77e5\u9053\uff1a</p> <ul> <li> <p>\u5b9a\u4e49\u4e86proxy\u7ec4\u4ef6\u4ee3\u7406\u7684\u96c6\u7fa4\uff0c\u8be5\u96c6\u7fa4\u4e3a\"<code>lazyxds-accesslog-service</code>\"</p> </li> <li> <p>\u8be5\u96c6\u7fa4\u5bf9\u5e94\u7684\u540e\u7aef\u670d\u52a1\u5730\u5740\u4e3a\"lazyxds.istio-system\"\uff0c\u7aef\u53e3\u4e3a8080 \u8fd9\u4e2a\u540e\u7aef\u5c31\u662flazyxds controller\uff0c\u540e\u9762\u7ec6\u8bf4</p> </li> </ul>"},{"location":"chap10/3aeraki/#envoyfilter","title":"EnvoyFilter","text":"<p>\u4eceyaml\u6587\u4ef6\u6211\u4eec\u770b\u5230\uff0c\u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a<code>envoyfilter</code>\u6765\u4fee\u6539<code>proxy</code>\u4ee3\u7406\u7684\u6d41\u91cf\u914d\u7f6e</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  name: lazyxds-egress-als\n  namespace: istio-system\nspec:\n  workloadSelector:\n    labels:\n      app: istio-egressgateway-lazyxds\n  configPatches:\n    - applyTo: NETWORK_FILTER\n      match:\n        context: GATEWAY\n        listener:\n          filterChain:\n            filter:\n              name: \"envoy.filters.network.http_connection_manager\"\n      patch:\n        operation: MERGE\n        value:\n          typed_config:\n            \"@type\": \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\"\n            access_log:\n              ......\n              - name: envoy.access_loggers.http_grpc\n                typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.access_loggers.grpc.v3.HttpGrpcAccessLogConfig\n                  common_config:\n                    log_name: http_envoy_accesslog\n                    transport_api_version: \"V3\"\n                    grpc_service:\n                      envoy_grpc:\n                        cluster_name: lazyxds-accesslog-service\n</code></pre> <p>\u4ece\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u770b\u51fa\u5728\u542f\u52a8envoy\u65f6\uff0c\u4f1a\u5411\u5176\u6ce8\u5165\u4e00\u4e2aaccesslog service\uff0c\u4e5f\u5c31\u662fenvoy\u7684\u65e5\u5fd7\u6536\u96c6\u5668\uff0c\u800c\u8fd9\u4e2aservice\u5c31\u662f<code>lazyxds-accesslog-service</code></p>"},{"location":"chap10/3aeraki/#controller","title":"Controller","text":"<p>\u5177\u4f53\u7684lazy xds\u5b9e\u73b0\u5c31\u662f\u901a\u8fc7\u8fd9\u4e2acontroller\u5b9e\u73b0\u7684</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: lazyxds\n  name: lazyxds\n  namespace: istio-system\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: lazyxds\n  template:\n    metadata:\n      labels:\n        app: lazyxds\n    spec:\n      serviceAccountName: lazyxds\n      containers:\n        - image: aeraki/lazyxds:latest\n          imagePullPolicy: Always\n          name: app\n          ports:\n            - containerPort: 8080\n              protocol: TCP\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: lazyxds\n  name: lazyxds\n  namespace: istio-system\nspec:\n  ports:\n    - name: grpc-als\n      port: 8080\n      protocol: TCP\n  selector:\n    app: lazyxds\n  type: ClusterIP\n</code></pre> <p>\u4ece\u914d\u7f6e\u53ef\u4ee5\u770b\u5230\uff0c\u5728egress\u73af\u8282\u6211\u4eec\u77e5\u9053\u4e86proxy\u7684\u4ee3\u7406\u7684\u540e\u7aef\u5730\u5740\u4e3a<code>lazyxds.istio-system</code>\uff0c\u521a\u597d\u5bf9\u5e94\u8fd9\u91cc\u7684<code>controller</code>\u3002</p> <p>\u5e76\u4e14\u6211\u4eec\u8fd8\u77e5\u9053\uff0cenvoy\u7684\u8bbf\u95ee\u65e5\u5fd7\u6700\u7ec8\u4f1a\u53d1\u9001\u7ed9\u8fd9\u4e2acontroller\u6765\u5904\u7406\uff0c\u800c\u8fd9\u5c31\u662f\u5b9e\u73b0\u589e\u91cf\u4e0b\u53d1envoy\u914d\u7f6e\u7684\u5173\u952e\u4e4b\u5904\uff0c\u4e5f\u5c31\u662f\u89e3\u51b3istio\u6027\u80fd\u7684\u89e3\u51b3\u4e4b\u6cd5\u3002</p>"},{"location":"chap10/3aeraki/#_3","title":"\u589e\u91cf\u4e0b\u53d1","text":"<p>Accesslog\u63a5\u53e3</p> <p>\u8981\u63a5\u53d7envoy\u7684\u8bbf\u95ee\u65e5\u5fd7\uff0c\u5fc5\u987b\u5b9e\u73b0envoy\u5b9a\u4e49\u7684\u63a5\u53e3\uff1a</p> <pre><code>type AccessLogServiceServer interface {\n   // Envoy will connect and send StreamAccessLogsMessage messages forever. It does not expect any\n   // response to be sent as nothing would be done in the case of failure. The server should\n   // disconnect if it expects Envoy to reconnect. In the future we may decide to add a different\n   // API for \"critical\" access logs in which Envoy will buffer access logs for some period of time\n   // until it gets an ACK so it could then retry. This API is designed for high throughput with the\n   // expectation that it might be lossy.\n   StreamAccessLogs(AccessLogService_StreamAccessLogsServer) error\n}\n</code></pre>"},{"location":"chap10/3aeraki/#_4","title":"\u65e5\u5fd7\u89e3\u6790","text":"<p>lazyxds\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <pre><code>func (server *Server) StreamAccessLogs(logStream als.AccessLogService_StreamAccessLogsServer) error {\n   for {\n      data, err := logStream.Recv()\n      if err != nil {\n         return err\n      }\n\n      httpLog := data.GetHttpLogs()\n      if httpLog != nil {\n         for _, entry := range httpLog.LogEntry {\n            server.log.V(4).Info(\"http log entry\", \"entry\", entry)\n            fromIP := getDownstreamIP(entry)\n            if fromIP == \"\" {\n               continue\n            }\n\n            upstreamCluster := entry.CommonProperties.UpstreamCluster\n            svcID := utils.UpstreamCluster2ServiceID(upstreamCluster)\n\n            toIP := getUpstreamIP(entry)\n\n            if err := server.handler.HandleAccess(fromIP, svcID, toIP); err != nil {\n               server.log.Error(err, \"handle access error\")\n            }\n         }\n      }\n   }\n}\n</code></pre> <p>\u4e0a\u9762\u4e3b\u8981\u7684\u903b\u8f91\u5c31\u662f\u89e3\u6790envoy\u7684\u8bbf\u95ee\u65e5\u5fd7\uff0c\u7136\u540e\u8fdb\u884c\u5904\u7406\uff1a</p> <ul> <li>lazy xds Controller \u4f1a\u5bf9\u63a5\u6536\u5230\u7684\u65e5\u5fd7\u8fdb\u884c\u8bbf\u95ee\u5173\u7cfb\u5206\u6790\uff0c\u7136\u540e\u628a\u65b0\u7684\u4f9d\u8d56\u5173\u7cfb\u8868\u8fbe\u5230 sidecar CRD \u4e2d\u3002</li> <li>\u540c\u65f6 Controller \u8fd8\u4f1a\u66f4\u65b0 Egress \u7684\u89c4\u5219\uff1a\u5220\u9664\u3001\u66f4\u65b0\u6216\u521b\u5efa\u3002</li> </ul>"},{"location":"chap11/1linkered_sm/","title":"1 Linkerd Service Mesh \u5feb\u901f\u4e0a\u624b","text":"<p>Linkerd \u662f Kubernetes \u7684\u4e00\u4e2a\u5b8c\u5168\u5f00\u6e90\u7684\u670d\u52a1\u7f51\u683c\u5b9e\u73b0\u3002\u5b83\u901a\u8fc7\u4e3a\u4f60\u63d0\u4f9b\u8fd0\u884c\u65f6\u8c03\u8bd5\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u53ef\u9760\u6027\u548c\u5b89\u5168\u6027\uff0c\u4f7f\u8fd0\u884c\u670d\u52a1\u66f4\u8f7b\u677e\u3001\u66f4\u5b89\u5168\uff0c\u6240\u6709\u8fd9\u4e9b\u90fd\u4e0d\u9700\u8981\u5bf9\u4f60\u7684\u4ee3\u7801\u8fdb\u884c\u4efb\u4f55\u66f4\u6539\u3002</p> <p>Linkerd \u901a\u8fc7\u5728\u6bcf\u4e2a\u670d\u52a1\u5b9e\u4f8b\u65c1\u8fb9\u5b89\u88c5\u4e00\u7ec4\u8d85\u8f7b\u3001\u900f\u660e\u7684\u4ee3\u7406\u6765\u5de5\u4f5c\u3002</p> <p>\u8fd9\u4e9b\u4ee3\u7406\u4f1a\u81ea\u52a8\u5904\u7406\u8fdb\u51fa\u670d\u52a1\u7684\u6240\u6709\u6d41\u91cf\u3002\u7531\u4e8e\u5b83\u4eec\u662f\u900f\u660e\u7684\uff0c\u8fd9\u4e9b\u4ee3\u7406\u5145\u5f53\u9ad8\u5ea6\u4eea\u8868\u5316\u7684\u8fdb\u7a0b\u5916\u7f51\u7edc\u5806\u6808\uff0c\u5411\u63a7\u5236\u5e73\u9762\u53d1\u9001\u9065\u6d4b\u6570\u636e\u5e76\u4ece\u63a7\u5236\u5e73\u9762\u63a5\u6536\u63a7\u5236\u4fe1\u53f7\u3002</p> <p>\u8fd9\u79cd\u8bbe\u8ba1\u5141\u8bb8 Linkerd \u6d4b\u91cf\u548c\u64cd\u7eb5\u8fdb\u51fa\u4f60\u7684\u670d\u52a1\u7684\u6d41\u91cf\uff0c\u800c\u4e0d\u4f1a\u5f15\u5165\u8fc7\u591a\u7684\u5ef6\u8fdf\u3002\u4e3a\u4e86\u5c3d\u53ef\u80fd\u5c0f\u3001\u8f7b\u548c\u5b89\u5168\uff0cLinkerd \u7684\u4ee3\u7406\u91c7\u7528 Rust \u7f16\u5199\u3002</p>"},{"location":"chap11/1linkered_sm/#_1","title":"\u529f\u80fd\u6982\u8ff0","text":"<ul> <li>\u81ea\u52a8 mTLS\uff1aLinkerd \u81ea\u52a8\u4e3a\u7f51\u683c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u542f\u7528\u76f8\u4e92\u4f20\u8f93\u5c42\u5b89\u5168\u6027 (TLS)\u3002</li> <li>\u81ea\u52a8\u4ee3\u7406\u6ce8\u5165\uff1aLinkerd \u4f1a\u81ea\u52a8\u5c06\u6570\u636e\u5e73\u9762\u4ee3\u7406\u6ce8\u5165\u5230\u57fa\u4e8e annotations \u7684 pod \u4e2d\u3002</li> <li>\u5bb9\u5668\u7f51\u7edc\u63a5\u53e3\u63d2\u4ef6\uff1aLinkerd \u80fd\u88ab\u914d\u7f6e\u53bb\u8fd0\u884c\u4e00\u4e2a CNI \u63d2\u4ef6\uff0c\u8be5\u63d2\u4ef6\u81ea\u52a8\u91cd\u5199\u6bcf\u4e2a pod \u7684 iptables \u89c4\u5219\u3002</li> <li>\u4eea\u8868\u677f\u548c Grafana\uff1aLinkerd \u63d0\u4f9b\u4e86\u4e00\u4e2a Web \u4eea\u8868\u677f\uff0c\u4ee5\u53ca\u9884\u914d\u7f6e\u7684 Grafana \u4eea\u8868\u677f\u3002</li> <li>\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1a\u60a8\u53ef\u4ee5\u5728 Linkerd \u4e2d\u542f\u7528\u5206\u5e03\u5f0f\u8ddf\u8e2a\u652f\u6301\u3002</li> <li>\u6545\u969c\u6ce8\u5165\uff1aLinkerd \u63d0\u4f9b\u4e86\u4ee5\u7f16\u7a0b\u65b9\u5f0f\u5c06\u6545\u969c\u6ce8\u5165\u670d\u52a1\u7684\u673a\u5236\u3002</li> <li>\u9ad8\u53ef\u7528\u6027\uff1aLinkerd \u63a7\u5236\u5e73\u9762\u53ef\u4ee5\u5728\u9ad8\u53ef\u7528\u6027 (HA) \u6a21\u5f0f\u4e0b\u8fd0\u884c\u3002</li> <li>HTTP\u3001HTTP/2 \u548c gRPC \u4ee3\u7406\uff1aLinkerd \u5c06\u81ea\u52a8\u4e3a HTTP\u3001HTTP/2 \u548c gRPC \u8fde\u63a5\u542f\u7528\u9ad8\u7ea7\u529f\u80fd\uff08\u5305\u62ec\u6307\u6807\u3001\u8d1f\u8f7d\u5e73\u8861\u3001\u91cd\u8bd5\u7b49\uff09\u3002</li> <li>Ingress\uff1aLinkerd \u53ef\u4ee5\u4e0e\u60a8\u9009\u62e9\u7684 ingress controller \u4e00\u8d77\u5de5\u4f5c\u3002</li> <li>\u8d1f\u8f7d\u5747\u8861\uff1aLinkerd \u4f1a\u81ea\u52a8\u5bf9 HTTP\u3001HTTP/2 \u548c gRPC \u8fde\u63a5\u4e0a\u6240\u6709\u76ee\u6807\u7aef\u70b9\u7684\u8bf7\u6c42\u8fdb\u884c\u8d1f\u8f7d\u5e73\u8861\u3002</li> <li>\u591a\u96c6\u7fa4\u901a\u4fe1\uff1aLinkerd \u53ef\u4ee5\u900f\u660e\u4e14\u5b89\u5168\u5730\u8fde\u63a5\u8fd0\u884c\u5728\u4e0d\u540c\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u3002</li> <li>\u91cd\u8bd5\u548c\u8d85\u65f6\uff1aLinkerd \u53ef\u4ee5\u6267\u884c\u7279\u5b9a\u4e8e\u670d\u52a1\u7684\u91cd\u8bd5\u548c\u8d85\u65f6\u3002</li> <li>\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff1aLinkerd \u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u652f\u6301\u6bcf\u6761\u8def\u7531\u6307\u6807\u4ee5\u53ca\u91cd\u8bd5\u548c\u8d85\u65f6\u3002</li> <li>TCP \u4ee3\u7406\u548c\u534f\u8bae\u68c0\u6d4b\uff1aLinkerd \u80fd\u591f\u4ee3\u7406\u6240\u6709 TCP \u6d41\u91cf\uff0c\u5305\u62ec TLS \u8fde\u63a5\u3001WebSockets \u548c HTTP \u96a7\u9053\u3002</li> <li>\u9065\u6d4b\u548c\u76d1\u63a7\uff1aLinkerd \u4f1a\u81ea\u52a8\u4ece\u6240\u6709\u901a\u8fc7\u5b83\u53d1\u9001\u6d41\u91cf\u7684\u670d\u52a1\u6536\u96c6\u6307\u6807\u3002</li> <li>\u6d41\u91cf\u62c6\u5206(\u91d1\u4e1d\u96c0\u3001\u84dd/\u7eff\u90e8\u7f72)\uff1aLinkerd \u53ef\u4ee5\u52a8\u6001\u5730\u5c06\u4e00\u90e8\u5206\u6d41\u91cf\u53d1\u9001\u5230\u4e0d\u540c\u7684\u670d\u52a1\u3002</li> </ul>"},{"location":"chap11/1linkered_sm/#_2","title":"\u5b89\u88c5","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u672c\u5730\u5b89\u88c5\u4e00\u4e2a Linkerd \u7684 CLI \u547d\u4ee4\u884c\u5de5\u5177\uff0c\u901a\u8fc7\u8be5 CLI \u53ef\u4ee5\u5c06 Linkerd \u7684\u63a7\u5236\u5e73\u9762\u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u4e0a\u3002</p> <p>\u6240\u4ee5\u9996\u5148\u9700\u8981\u5728\u672c\u5730\u8fd0\u884c kubectl \u547d\u4ee4\uff0c\u786e\u4fdd\u53ef\u4ee5\u8bbf\u95ee\u4e00\u4e2a\u53ef\u7528\u7684 Kubernetes \u96c6\u7fa4\uff0c\u5982\u679c\u6ca1\u6709\u96c6\u7fa4\uff0c\u53ef\u4ee5\u4f7f\u7528 KinD \u5728\u672c\u5730\u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u3002</p> <pre><code>$ kubectl version --short\nClient Version: v1.23.5\nServer Version: v1.22.8\n</code></pre> <p>\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5728\u672c\u5730\u5b89\u88c5 Linkerd \u7684 CLI \u5de5\u5177\uff1a</p> <pre><code>$ curl --proto '=https' --tlsv1.2 -sSfL https://run.linkerd.io/install | sh\n</code></pre> <p>\u5982\u679c\u662f Mac \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u53ef\u4ee5\u4f7f\u7528 Homebrew \u5de5\u5177\u4e00\u952e\u5b89\u88c5\uff1a</p> <pre><code>$ brew install linkerd\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u524d\u5f80 Linkerd Release \u9875\u9762 https://github.com/linkerd/linkerd2/releases/ \u4e0b\u8f7d\u5b89\u88c5\u5373\u53ef\u3002</p> <p>\u5b89\u88c5\u540e\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u9a8c\u8bc1 CLI \u5de5\u5177\u662f\u5426\u5b89\u88c5\u6210\u529f\uff1a</p> <pre><code>$ linkerd  version\nClient version: stable-2.11.1\nServer version: unavailable\n</code></pre> <p>\u6b63\u5e38\u6211\u4eec\u53ef\u4ee5\u770b\u5230 CLI \u7684\u7248\u672c\u4fe1\u606f\uff0c\u4f46\u662f\u4f1a\u51fa\u73b0 <code>Server version: unavailable</code> \u4fe1\u606f\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88c5\u63a7\u5236\u5e73\u9762\u9020\u6210\u7684\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b89\u88c5 Server \u7aef\u3002</p> <p>Kubernetes \u96c6\u7fa4\u53ef\u4ee5\u901a\u8fc7\u591a\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u8fdb\u884c\u914d\u7f6e\uff0c\u5728\u5b89\u88c5 Linkerd \u63a7\u5236\u5e73\u9762\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u68c0\u67e5\u5e76\u9a8c\u8bc1\u6240\u6709\u914d\u7f6e\u662f\u5426\u6b63\u786e\uff0c\u8981\u68c0\u67e5\u96c6\u7fa4\u662f\u5426\u5df2\u51c6\u5907\u597d\u5b89\u88c5 Linkerd\uff0c\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ linkerd check --pre\nLinkerd core checks\n===================\n\nkubernetes-api\n--------------\n\u221a can initialize the client\n\u221a can query the Kubernetes API\n\nkubernetes-version\n------------------\n\u221a is running the minimum Kubernetes API version\n\u221a is running the minimum kubectl version\n\npre-kubernetes-setup\n--------------------\n\u221a control plane namespace does not already exist\n\u221a can create non-namespaced resources\n\u221a can create ServiceAccounts\n\u221a can create Services\n\u221a can create Deployments\n\u221a can create CronJobs\n\u221a can create ConfigMaps\n\u221a can create Secrets\n\u221a can read Secrets\n\u221a can read extension-apiserver-authentication configmap\n\u221a no clock skew detected\n\nlinkerd-version\n---------------\n\u221a can determine the latest version\n\u221a cli is up-to-date\n\nStatus check results are \u221a\n</code></pre> <p>\u5982\u679c\u4e00\u5207\u68c0\u67e5\u90fd OK \u5219\u53ef\u4ee5\u5f00\u59cb\u5b89\u88c5 Linkerd \u7684\u63a7\u5236\u5e73\u9762\u4e86\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u4e00\u952e\u5b89\u88c5\uff1a</p> <ul> <li>\u5148\u6309\u7167CRD\u6587\u4ef6</li> </ul> <pre><code>$ linkerd install --crds\n</code></pre> <p>\u5728\u6b64\u547d\u4ee4\u4e2d\uff0clinkerd install \u4f1a\u751f\u6210\u4e00\u4e2a Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u6240\u6709\u5fc5\u8981\u7684\u63a7\u5236\u5e73\u9762\u8d44\u6e90\uff0c\u7136\u540e\u4f7f\u7528 kubectl apply \u547d\u4ee4\u5373\u53ef\u5c06\u5176\u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u3002</p> <pre><code>$ linkerd install --set proxyInit.runAsRoot=true | kubectl apply -f -\n\nnamespace/linkerd created\nclusterrole.rbac.authorization.k8s.io/linkerd-linkerd-identity created\nclusterrolebinding.rbac.authorization.k8s.io/linkerd-linkerd-identity created\nserviceaccount/linkerd-identity created\nclusterrole.rbac.authorization.k8s.io/linkerd-linkerd-destination created\n...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4f1a\u5c06 Linkerd \u63a7\u5236\u9762\u5b89\u88c5\u5230\u4e00\u4e2a\u540d\u4e3a linkerd \u7684\u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u6709\u5982\u4e0b\u51e0\u4e2a Pod \u8fd0\u884c\uff1a</p> <pre><code>$ kubectl get pods -n linkerd\nNAME                                      READY   STATUS    RESTARTS       AGE\nlinkerd-destination-5756d47547-hr5jf      4/4     Running   0              14m\nlinkerd-identity-76b6469bc-qhv6b          2/2     Running   0              31m\nlinkerd-proxy-injector-6d97596bd5-r6tgw   2/2     Running   8 (8m5s ago)   31m\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u7b49\u5f85\u63a7\u5236\u5e73\u9762\u51c6\u5907\u5c31\u7eea\uff0c\u5e76\u53ef\u4ee5\u9a8c\u8bc1\u5b89\u88c5\u7ed3\u679c\u662f\u5426\u6b63\u5e38\uff1a</p> <pre><code>$ linkerd check\nLinkerd core checks\n===================\n\nkubernetes-api\n--------------\n\u221a can initialize the client\n\u221a can query the Kubernetes API\n\nkubernetes-version\n------------------\n\u221a is running the minimum Kubernetes API version\n\u221a is running the minimum kubectl version\n\nlinkerd-existence\n-----------------\n\u221a 'linkerd-config' config map exists\n\u221a heartbeat ServiceAccount exist\n\u221a control plane replica sets are ready\n\u221a no unschedulable pods\n\u221a control plane pods are ready\n\u221a cluster networks contains all pods\n\nlinkerd-config\n--------------\n\u221a control plane Namespace exists\n\u221a control plane ClusterRoles exist\n\u221a control plane ClusterRoleBindings exist\n\u221a control plane ServiceAccounts exist\n\u221a control plane CustomResourceDefinitions exist\n\u221a control plane MutatingWebhookConfigurations exist\n\u221a control plane ValidatingWebhookConfigurations exist\n\u221a proxy-init container runs as root user if docker container runtime is used\n\nlinkerd-identity\n----------------\n\u221a certificate config is valid\n\u221a trust anchors are using supported crypto algorithm\n\u221a trust anchors are within their validity period\n\u221a trust anchors are valid for at least 60 days\n\u221a issuer cert is using supported crypto algorithm\n\u221a issuer cert is within its validity period\n\u221a issuer cert is valid for at least 60 days\n\u221a issuer cert is issued by the trust anchor\n\nlinkerd-webhooks-and-apisvc-tls\n-------------------------------\n\u221a proxy-injector webhook has valid cert\n\u221a proxy-injector cert is valid for at least 60 days\n\u221a sp-validator webhook has valid cert\n\u221a sp-validator cert is valid for at least 60 days\n\u221a policy-validator webhook has valid cert\n\u221a policy-validator cert is valid for at least 60 days\n\nlinkerd-version\n---------------\n\u221a can determine the latest version\n\u221a cli is up-to-date\n\ncontrol-plane-version\n---------------------\n\u221a can retrieve the control plane version\n\u221a control plane is up-to-date\n\u221a control plane and cli versions match\n\nlinkerd-control-plane-proxy\n---------------------------\n\u221a control plane proxies are healthy\n\u221a control plane proxies are up-to-date\n\u221a control plane proxies and cli versions match\n\nStatus check results are \u221a\n</code></pre> <p>\u5f53\u51fa\u73b0\u4e0a\u9762\u7684 <code>Status check results are \u221a</code> \u4fe1\u606f\u540e\u8868\u793a Linkerd \u7684\u63a7\u5236\u5e73\u9762\u5b89\u88c5\u6210\u529f\u4e86\u3002</p> <p>\u9664\u4e86\u4f7f\u7528 CLI \u5de5\u5177\u7684\u65b9\u5f0f\u5b89\u88c5\u63a7\u5236\u5e73\u9762\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Helm Chart \u7684\u65b9\u5f0f\u6765\u5b89\u88c5\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ helm repo add linkerd https://helm.linkerd.io/stable\n\n\n# set expiry date one year from now, in Mac:\n$ exp=$(date -v+8760H +\"%Y-%m-%dT%H:%M:%SZ\")\n\n\n# in Linux:\n$ exp=$(date -d '+8760 hour' +\"%Y-%m-%dT%H:%M:%SZ\")\n\n$ helm install linkerd2 \\\n  --set-file identityTrustAnchorsPEM=ca.crt \\\n  --set-file identity.issuer.tls.crtPEM=issuer.crt \\\n  --set-file identity.issuer.tls.keyPEM=issuer.key \\\n  --set identity.issuer.crtExpiry=$exp \\\n  linkerd/linkerd2\n</code></pre> <p>\u6b64\u5916\u8be5 chart \u5305\u542b\u4e00\u4e2a <code>values-ha.yaml</code> \u6587\u4ef6\uff0c \u5b83\u8986\u76d6\u4e86\u4e00\u4e9b\u9ed8\u8ba4\u503c\uff0c\u4ee5\u4fbf\u5728\u9ad8\u53ef\u7528\u6027\u573a\u666f\u4e0b\u8fdb\u884c\u8bbe\u7f6e\uff0c \u7c7b\u4f3c\u4e8e <code>linkerd install</code> \u4e2d\u7684 --ha \u9009\u9879\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6 chart \u6587\u4ef6\u6765\u83b7\u5f97 <code>values-ha.yaml</code>\uff1a</p> <pre><code>$ helm fetch --untar linkerd/linkerd2\n</code></pre> <p>\u7136\u540e\u4f7f\u7528 <code>-f flag</code> \u63d0\u4f9b\u8986\u76d6\u6587\u4ef6\uff0c\u4f8b\u5982\uff1a</p> <pre><code>## see above on how to set $exp\nhelm install linkerd2 \\\n  --set-file identityTrustAnchorsPEM=ca.crt \\\n  --set-file identity.issuer.tls.crtPEM=issuer.crt \\\n  --set-file identity.issuer.tls.keyPEM=issuer.key \\\n  --set identity.issuer.crtExpiry=$exp \\\n  -f linkerd2/values-ha.yaml \\\n  linkerd/linkerd2\n</code></pre> <p>\u91c7\u7528\u54ea\u79cd\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\u5747\u53ef\uff0c\u5230\u8fd9\u91cc\u6211\u4eec\u73b0\u5728\u5c31\u5b8c\u6210\u4e86 Linkerd \u7684\u5b89\u88c5\uff0c\u91cd\u65b0\u6267\u884c linkerd version \u547d\u4ee4\u5c31\u53ef\u4ee5\u770b\u5230 Server \u7aef\u7248\u672c\u4fe1\u606f\u4e86\uff1a</p> <pre><code>linkerd version\nClient version: stable-2.12.0\nServer version: stable-2.12.0\n</code></pre>"},{"location":"chap11/1linkered_sm/#_3","title":"\u793a\u4f8b","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5b89\u88c5\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u5e94\u7528 Emojivoto\uff0c\u8be5\u5e94\u7528\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u72ec\u7acb Kubernetes \u5e94\u7528\u7a0b\u5e8f\uff0c\u5b83\u6df7\u5408\u4f7f\u7528 gRPC \u548c HTTP \u8c03\u7528\uff0c\u5141\u8bb8\u7528\u6237\u5bf9\u4ed6\u4eec\u6700\u559c\u6b22\u7684\u8868\u60c5\u7b26\u53f7\u8fdb\u884c\u6295\u7968\u3002</p> <p>\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u5c06 Emojivoto \u5b89\u88c5\u5230 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\uff1a</p> <pre><code>$ curl -fsL https://run.linkerd.io/emojivoto.yml \n</code></pre> <p>**<code>emojivoto.yml</code> **</p> <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: emojivoto\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: emoji\n  namespace: emojivoto\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: voting\n  namespace: emojivoto\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: web\n  namespace: emojivoto\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: emoji-svc\n  namespace: emojivoto\nspec:\n  ports:\n  - name: grpc\n    port: 8080\n    targetPort: 8080\n  - name: prom\n    port: 8801\n    targetPort: 8801\n  selector:\n    app: emoji-svc\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: voting-svc\n  namespace: emojivoto\nspec:\n  ports:\n  - name: grpc\n    port: 8080\n    targetPort: 8080\n  - name: prom\n    port: 8801\n    targetPort: 8801\n  selector:\n    app: voting-svc\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: web-svc\n  namespace: emojivoto\nspec:\n  ports:\n  - name: http\n    port: 80\n    targetPort: 8080\n  selector:\n    app: web-svc\n  type: ClusterIP\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app.kubernetes.io/name: emoji\n    app.kubernetes.io/part-of: emojivoto\n    app.kubernetes.io/version: v9\n  name: emoji\n  namespace: emojivoto\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: emoji-svc\n      version: v9\n  template:\n    metadata:\n      labels:\n        app: emoji-svc\n        version: v9\n    spec:\n      containers:\n      - env:\n        - name: GRPC_PORT\n          value: \"8080\"\n        - name: PROM_PORT\n          value: \"8801\"\n        image: buoyantio/emojivoto-emoji-svc:v9\n        name: emoji-svc\n        ports:\n        - containerPort: 8080\n          name: grpc\n        - containerPort: 8801\n          name: prom\n        resources:\n          requests:\n            cpu: 100m\n      serviceAccountName: emoji\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app.kubernetes.io/name: vote-bot\n    app.kubernetes.io/part-of: emojivoto\n    app.kubernetes.io/version: v9\n  name: vote-bot\n  namespace: emojivoto\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: vote-bot\n      version: v9\n  template:\n    metadata:\n      labels:\n        app: vote-bot\n        version: v9\n    spec:\n      containers:\n      - command:\n        - emojivoto-vote-bot\n        env:\n        - name: WEB_HOST\n          value: web-svc.emojivoto:80\n        image: buoyantio/emojivoto-web:v9\n        name: vote-bot\n        resources:\n          requests:\n            cpu: 10m\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app.kubernetes.io/name: voting\n    app.kubernetes.io/part-of: emojivoto\n    app.kubernetes.io/version: v9\n  name: voting\n  namespace: emojivoto\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: voting-svc\n      version: v9\n  template:\n    metadata:\n      labels:\n        app: voting-svc\n        version: v9\n    spec:\n      containers:\n      - env:\n        - name: GRPC_PORT\n          value: \"8080\"\n        - name: PROM_PORT\n          value: \"8801\"\n        image: buoyantio/emojivoto-voting-svc:v9\n        name: voting-svc\n        ports:\n        - containerPort: 8080\n          name: grpc\n        - containerPort: 8801\n          name: prom\n        resources:\n          requests:\n            cpu: 100m\n      serviceAccountName: voting\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app.kubernetes.io/name: web\n    app.kubernetes.io/part-of: emojivoto\n    app.kubernetes.io/version: v9\n  name: web\n  namespace: emojivoto\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: web-svc\n      version: v9\n  template:\n    metadata:\n      labels:\n        app: web-svc\n        version: v9\n    spec:\n      containers:\n      - env:\n        - name: WEB_PORT\n          value: \"8080\"\n        - name: EMOJISVC_HOST\n          value: emoji-svc.emojivoto:8080\n        - name: VOTINGSVC_HOST\n          value: voting-svc.emojivoto:8080\n        - name: INDEX_BUNDLE\n          value: dist/index_bundle.js\n        image: buoyantio/emojivoto-web:v9\n        name: web-svc\n        ports:\n        - containerPort: 8080\n          name: http\n        resources:\n          requests:\n            cpu: 100m\n      serviceAccountName: web\n</code></pre> <p>\u8be5\u5e94\u7528\u4e0b\u53ef\u4ee5\u770b\u5230\u4e00\u5171\u5305\u542b 4 \u4e2a Pod \u670d\u52a1\u3002</p> <pre><code>$ kubectl get pod -n emojivoto\nNAME                        READY   STATUS    RESTARTS   AGE\nemoji-79b7665b88-4j96m      1/1     Running   0          8s\nvote-bot-86d4645dc7-mm4ct   1/1     Running   0          8s\nvoting-f86cc8d89-cct2t      1/1     Running   0          8s\nweb-8578749657-hb57h        1/1     Running   0          8s\n\n$ kubectl get svc -n emojivoto\nNAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\nemoji-svc    ClusterIP   10.105.148.26    &lt;none&gt;        8080/TCP,8801/TCP   2m26s\nvoting-svc   ClusterIP   10.100.203.107   &lt;none&gt;        8080/TCP,8801/TCP   2m26s\nweb-svc      ClusterIP   10.106.94.83     &lt;none&gt;        80/TCP              2m26s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>port-forward</code> \u6765\u66b4\u9732 web-svc \u670d\u52a1\uff0c\u7136\u540e\u4fbf\u53ef\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\u8be5\u5e94\u7528\u3002</p> <pre><code>$ kubectl -n emojivoto port-forward svc/web-svc 8080:80\nForwarding from 127.0.0.1:8080 -&gt; 8080\nForwarding from [::1]:8080 -&gt; 8080\nHandling connection for 8080\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u901a\u8fc7 http://localhost:8080 \u8bbf\u95ee Emojivoto \u5e94\u7528\u4e86\u3002</p> <p> </p> <p>\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u9875\u9762\u4e2d\u559c\u6b22\u7684\u8868\u60c5\u8fdb\u884c\u6295\u7968\uff0c\u4f46\u662f\u9009\u62e9\u67d0\u4e9b\u8868\u60c5\u540e\u4f1a\u51fa\u73b0\u4e00\u4e9b\u9519\u8bef\uff0c\u6bd4\u5982\u5f53\u6211\u4eec\u70b9\u51fb\u751c\u751c\u5708\u8868\u60c5\u7b26\u53f7\u7684\u65f6\u5019\u4f1a\u5f97\u5230\u4e00\u4e2a 404 \u9875\u9762\u3002</p> <p> </p> <p> </p> <p>\u4e0d\u8fc7\u4e0d\u7528\u62c5\u5fc3\uff0c\u8fd9\u662f\u5e94\u7528\u4e2d\u6545\u610f\u7559\u4e0b\u7684\u9519\u8bef\uff0c\u4e3a\u7684\u662f\u540e\u9762\u4f7f\u7528 Linkerd \u6765\u8bc6\u522b\u8be5\u95ee\u9898\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684\u793a\u4f8b\u5e94\u7528\u52a0\u5165\u5230 Service Mesh \u4e2d\u6765\uff0c\u5411\u5176\u6dfb\u52a0 Linkerd \u7684\u6570\u636e\u5e73\u9762\u4ee3\u7406\uff0c\u76f4\u63a5\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u5c06 Emojivoto \u5e94\u7528\u7f51\u683c\u5316\uff1a</p> <pre><code>$ kubectl get -n emojivoto deploy -o yaml \\\n&gt;  | linkerd inject - \\\n&gt;  | kubectl apply -f -\n\ndeployment \"emoji\" injected\ndeployment \"vote-bot\" injected\ndeployment \"voting\" injected\ndeployment \"web\" injected\n\ndeployment.apps/emoji configured\ndeployment.apps/vote-bot configured\ndeployment.apps/voting configured\ndeployment.apps/web configured\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u9996\u5148\u83b7\u53d6\u5728 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u7684\u6240\u6709 Deployments\uff0c\u7136\u540e\u901a\u8fc7 linkerd inject \u8fd0\u884c\u5b83\u4eec\u7684\u6e05\u5355\uff0c\u7136\u540e\u5c06\u5176\u91cd\u65b0\u5e94\u7528\u5230\u96c6\u7fa4\u3002</p> <p>\u6ce8\u610f <code>linkerd inject</code> \u547d\u4ee4\u53ea\u662f\u5728 Pod \u89c4\u8303\u4e2d\u6dfb\u52a0\u4e00\u4e2a <code>linkerd.io/inject: enabled</code> \u7684\u6ce8\u89e3\uff0c\u5e76\u4e0d\u4f1a\u76f4\u63a5\u6ce8\u5165\u4e00\u4e2a Sidecar \u5bb9\u5668\uff0c\u8be5\u6ce8\u89e3\u5373\u53ef\u6307\u793a Linkerd \u5728\u521b\u5efa Pod \u65f6\u5c06\u4ee3\u7406\u6ce8\u5165\u5230\u5176\u4e2d\uff0c\u6240\u4ee5\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u540e\u5e94\u7528 Pod \u4e2d\u4f1a\u65b0\u589e\u4e00\u4e2a sidecar \u7684\u4ee3\u7406\u5bb9\u5668\u3002</p> <pre><code>$ kubectl get pods -n emojivoto\nNAME                        READY   STATUS    RESTARTS   AGE\nemoji-6fd4b555c7-pbnck      2/2     Running   0          2m51s\nvote-bot-7bf6bc7c5b-5j66j   2/2     Running   0          2m51s\nvoting-5db96b44c4-wk7bb     2/2     Running   0          2m51s\nweb-5fdb59bc88-76g2t        2/2     Running   0          2m51s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a Pod \u73b0\u5728\u90fd\u6709 2 \u4e2a\u5bb9\u5668\uff0c\u76f8\u8f83\u4e8e\u4e4b\u524d\u591a\u4e86\u4e00\u4e2a Linkerd \u7684 sidecar \u4ee3\u7406\u5bb9\u5668\u3002</p> <p> </p> <p>\u5f53\u5e94\u7528\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u6210\u529f\u5c06\u5e94\u7528\u5f15\u5165\u5230 Linkerd \u7684\u7f51\u683c\u670d\u52a1\u4e2d\u6765\u4e86\uff0c\u65b0\u589e\u7684\u4ee3\u7406\u5bb9\u5668\u7ec4\u6210\u4e86\u6570\u636e\u5e73\u9762\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u68c0\u67e5\u6570\u636e\u5e73\u9762\u72b6\u6001\uff1a</p> <pre><code>$  linkerd -n emojivoto check --proxy\nLinkerd core checks\n===================\n\nkubernetes-api\n--------------\n\u221a can initialize the client\n\u221a can query the Kubernetes API\n\nkubernetes-version\n------------------\n\u221a is running the minimum Kubernetes API version\n\u221a is running the minimum kubectl version\n\nlinkerd-existence\n-----------------\n\u221a 'linkerd-config' config map exists\n\u221a heartbeat ServiceAccount exist\n\u221a control plane replica sets are ready\n\u221a no unschedulable pods\n\u221a control plane pods are ready\n\u221a cluster networks contains all pods\n\nlinkerd-config\n--------------\n\u221a control plane Namespace exists\n\u221a control plane ClusterRoles exist\n\u221a control plane ClusterRoleBindings exist\n\u221a control plane ServiceAccounts exist\n\u221a control plane CustomResourceDefinitions exist\n\u221a control plane MutatingWebhookConfigurations exist\n\u221a control plane ValidatingWebhookConfigurations exist\n\u221a proxy-init container runs as root user if docker container runtime is used\n\nlinkerd-identity\n----------------\n\u221a certificate config is valid\n\u221a trust anchors are using supported crypto algorithm\n\u221a trust anchors are within their validity period\n\u221a trust anchors are valid for at least 60 days\n\u221a issuer cert is using supported crypto algorithm\n\u221a issuer cert is within its validity period\n\u221a issuer cert is valid for at least 60 days\n\u221a issuer cert is issued by the trust anchor\n\nlinkerd-webhooks-and-apisvc-tls\n-------------------------------\n\u221a proxy-injector webhook has valid cert\n\u221a proxy-injector cert is valid for at least 60 days\n\u221a sp-validator webhook has valid cert\n\u221a sp-validator cert is valid for at least 60 days\n\u221a policy-validator webhook has valid cert\n\u221a policy-validator cert is valid for at least 60 days\n\nlinkerd-identity-data-plane\n---------------------------\n\u221a data plane proxies certificate match CA\n\nlinkerd-version\n---------------\n\u221a can determine the latest version\n\u221a cli is up-to-date\n\nlinkerd-control-plane-proxy\n---------------------------\n\u221a control plane proxies are healthy\n\u221a control plane proxies are up-to-date\n\u221a control plane proxies and cli versions match\n\nlinkerd-data-plane\n------------------\n\u221a data plane namespace exists\n\u221a data plane proxies are ready\n\u221a data plane is up-to-date\n\u221a data plane and cli versions match\n\u221a data plane pod labels are configured correctly\n\u221a data plane service labels are configured correctly\n\u221a data plane service annotations are configured correctly\n\u221a opaque ports are properly annotated\n\nStatus check results are \u221a\n</code></pre> <p>\u5f53\u7136\uff0c\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u901a\u8fc7 <code>http://localhost:8080</code> \u8bbf\u95ee\u5e94\u7528\uff0c\u5f53\u7136\u5728\u4f7f\u7528\u4e0a\u548c\u4e4b\u524d\u6ca1\u4ec0\u4e48\u533a\u522b\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Linkerd \u53bb\u67e5\u770b\u5e94\u7528\u5b9e\u9645\u4e0a\u505a\u4e86\u54ea\u4e9b\u4e8b\u60c5\uff0c\u4f46\u662f\u6211\u4eec\u9700\u8981\u53bb\u5355\u72ec\u5b89\u88c5\u4e00\u4e2a\u63d2\u4ef6\uff0c</p> <p>\u7531\u4e8e Linkerd \u7684\u6838\u5fc3\u63a7\u5236\u5e73\u9762\u975e\u5e38\u8f7b\u91cf\u7ea7\uff0c \u6240\u4ee5 Linkerd \u9644\u5e26\u4e86\u4e00\u4e9b\u63d2\u4ef6\uff0c\u8fd9\u4e9b\u63d2\u4ef6\u4e3a Linkerd \u6dfb\u52a0\u4e86\u4e00\u4e9b\u975e\u5173\u952e\u4f46\u901a\u5e38\u6709\u7528\u7684\u529f\u80fd\uff0c\u5305\u62ec\u5404\u79cd\u4eea\u8868\u677f\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e2a viz \u63d2\u4ef6\uff0cLinkerd-Viz \u63d2\u4ef6\u5305\u542b Linkerd \u7684\u53ef\u89c2\u5bdf\u6027\u548c\u53ef\u89c6\u5316\u7ec4\u4ef6\u3002\u5b89\u88c5\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$  linkerd viz install | kubectl apply -f -\n\n....\nnamespace/linkerd-viz created\nclusterrole.rbac.authorization.k8s.io/linkerd-linkerd-viz-metrics-api created\nclusterrolebinding.rbac.authorization.k8s.io/linkerd-\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a linkerd-viz \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u4f1a\u5728\u8be5\u547d\u540d\u7a7a\u95f4\u4e2d\u5b89\u88c5\u76d1\u63a7\u76f8\u5173\u7684\u5e94\u7528\uff0c\u6bd4\u5982 Prometheus\u3001Grafana \u7b49\u3002</p> <pre><code>$ kubectl get pods -n linkerd-viz\nNAME                            READY   STATUS    RESTARTS   AGE\nmetrics-api-568596fbbb-dsgb8    2/2     Running   0          34m\nprometheus-75c46f88b5-lzhxf     2/2     Running   0          34m\ntap-756c88b45f-wtbrf            2/2     Running   0          34m\ntap-injector-69c7d96674-h86w5   2/2     Running   0          34m\nweb-65557589c8-svb9k            2/2     Running   0          34m\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6253\u5f00\u4e00\u4e2a dashboard \u9875\u9762\uff1a</p> <pre><code>$ linkerd viz dashboard &amp;\n[1] 68487\n\n\n$ Linkerd dashboard available at:\nhttp://localhost:50750\nGrafana dashboard available at:\nhttp://localhost:50750/grafana\nOpening Linkerd dashboard in the default browser\n</code></pre> <p>\u5f53 viz \u63d2\u4ef6\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u540e\u4f1a\u81ea\u52a8\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u4e00\u4e2a Linkerd \u7684\u53ef\u89c2\u5bdf\u6027\u7684 Dashboard\u3002</p> <p>\u6b64\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Ingress \u6765\u66b4\u9732 viz \u670d\u52a1\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: web-ingress\n  namespace: linkerd-viz\n  annotations:\n    nginx.ingress.kubernetes.io/upstream-vhost: $service_name.$namespace.svc.cluster.local:8084\n    nginx.ingress.kubernetes.io/configuration-snippet: |\n      proxy_set_header Origin \"\";\n      proxy_hide_header l5d-remote-ip;\n      proxy_hide_header l5d-server-id;\nspec:\n  ingressClassName: nginx\n  rules:\n    - host: linkerd.k8s.local\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: web\n                port:\n                  number: 8084\n</code></pre> <p>\u5e94\u7528\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7 linkerd.k8s.local \u8bbf\u95ee viz \u4e86\u3002</p> <p> </p> <p></p> <p>\u8fd8\u53ef\u4ee5\u663e\u793a\u81ea\u52a8\u751f\u6210\u7684\u62d3\u6251\u56fe\u3002</p> <p></p> <p>\u5728\u9875\u9762\u4e0a\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u6bcf\u4e2a Emojivoto \u7ec4\u4ef6\u7684\u5b9e\u65f6\u6307\u6807\uff0c\u5c31\u53ef\u4ee5\u786e\u5b9a\u54ea\u4e2a\u7ec4\u4ef6\u51fa\u73b0\u4e86\u90e8\u5206\u6545\u969c\u4e86\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u6709\u9488\u5bf9\u6027\u7684\u53bb\u89e3\u51b3\u95ee\u9898\u4e86\u3002</p> <p>\u5728\u5bf9\u5e94\u7684\u8d44\u6e90\u540e\u9762\u5305\u542b\u4e00\u4e2a Grafana \u7684\u56fe\u6807\uff0c\u70b9\u51fb\u53ef\u4ee5\u81ea\u52a8\u8df3\u8f6c\u5230 Grafana \u7684\u76d1\u63a7\u9875\u9762\u3002</p> <p></p>"},{"location":"chap11/2linkered_index/","title":"2 \u5728 Linkerd \u4e2d\u83b7\u53d6\u5e94\u7528\u7684\u9ec4\u91d1\u6307\u6807","text":"<pre><code>kubectl get ns linkerd-viz -o json &gt; linkerd-viz.json\nkubectl proxy\n\n\ncurl -k -H \"Content-Type: application/json\" -X PUT --data-binary @linkerd-viz.json http://127.0.0.1:8001/api/v1/namespaces/linkerd-viz/finalize\n</code></pre> <p>\u6211\u4eec\u5c06\u8be6\u7ec6\u4e86\u89e3\u8fd9\u4e9b\u6307\u6807\uff0c\u5e76\u4f7f\u7528 Emojivoto \u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\u4e86\u89e3\u5b83\u4eec\u7684\u542b\u4e49\u3002</p> <p>\u6211\u4eec\u5148\u7b80\u5355\u4e86\u89e3\u4e0b\u670d\u52a1\u5065\u5eb7\u9ec4\u91d1\u6307\u6807\u7684\u7ecf\u5178\u5b9a\u4e49\uff1a</p> <ul> <li>Latency\uff08\u5ef6\u8fdf\uff09</li> <li>Error rate\uff08\u9519\u8bef\u7387\uff09</li> <li>Traffic volume\uff08\u6d41\u91cf\uff09</li> <li>Saturation\uff08\u9971\u548c\u5ea6\uff09</li> </ul> <p>Linkerd \u7684\u4ef7\u503c\u4e0d\u4ec5\u4ec5\u5728\u4e8e\u5b83\u53ef\u4ee5\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\uff0c\u6bd5\u7adf\uff0c\u6211\u4eec\u53ef\u4ee5\u975e\u5e38\u7b80\u5355\u5730\u76f4\u63a5\u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u3002\u76f8\u53cd\uff0cLinkerd \u7684\u4ef7\u503c\u5728\u4e8e\u5b83\u53ef\u4ee5\u5728\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4ee5\u7edf\u4e00\u7684\u65b9\u5f0f\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\uff0c\u5e76\u4e14\u4e0d\u9700\u8981\u66f4\u6539\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u65e0\u8bba\u662f\u8c01\u7f16\u5199\u7684\uff0c\u5b83\u4f7f\u7528\u4ec0\u4e48\u6846\u67b6\uff0c\u5b83\u662f\u7528\u4ec0\u4e48\u8bed\u8a00\u7f16\u5199\u7684\uff0c\u4ee5\u53ca\u5b83\u505a\u4ec0\u4e48\uff0cLinkerd \u90fd\u53ef\u4ee5\u4e3a\u4f60\u7684\u670d\u52a1\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\u3002</p>"},{"location":"chap11/2linkered_index/#latency","title":"Latency","text":"<p>\u5ef6\u8fdf\u662f\u54cd\u5e94\u8bf7\u6c42\u6240\u9700\u7684\u65f6\u95f4\uff0c\u5bf9\u4e8e Linkerd\uff0c\u662f\u901a\u8fc7 Linkerd \u4ee3\u7406\u5411\u5e94\u7528\u7a0b\u5e8f\u53d1\u9001\u8bf7\u6c42\u548c\u63a5\u6536\u54cd\u5e94\u4e4b\u95f4\u7ecf\u8fc7\u7684\u65f6\u95f4\u6765\u8fdb\u884c\u8861\u91cf\u7684\uff0c\u56e0\u4e3a\u5b83\u5728\u8bf7\u6c42\u4e4b\u95f4\u53ef\u80fd\u4f1a\u6709\u5f88\u5927\u5dee\u5f02\uff0c\u6240\u4ee5\u6307\u5b9a\u65f6\u95f4\u6bb5\u7684\u5ef6\u8fdf\u901a\u5e38\u4f5c\u4e3a\u7edf\u8ba1\u5206\u5e03\u6765\u8861\u91cf\uff0c\u5e76\u62a5\u544a\u4e3a\u6b64\u5206\u5e03\u7684\u767e\u5206\u4f4d\u6570\u3002</p> <p>Linkerd \u80fd\u591f\u62a5\u544a\u5e38\u7528\u7684\u5ef6\u8fdf\u6307\u6807\u4f8b\u5982 p50\u3001p95\u3001p99 \u548c p999\uff0c\u5bf9\u5e94\u4e8e 50\u300195\u300199 \u548c 99.9 \u7684\u767e\u5206\u4f4d\u6570\u3002\u8bf7\u6c42\u7684\u5ef6\u8fdf\u5206\u5e03\uff0c\u8fd9\u4e9b\u88ab\u79f0\u4e3a\u201c\u5c3e\u90e8\u5ef6\u8fdf\u201d\uff0c\u901a\u5e38\u662f\u62a5\u544a\u5927\u89c4\u6a21\u7cfb\u7edf\u884c\u4e3a\u7684\u91cd\u8981\u6307\u6807\u3002</p>"},{"location":"chap11/2linkered_index/#error-rate","title":"Error rate","text":"<p>\u9519\u8bef\u7387\u662f\u88ab\u89c6\u4e3a\u9519\u8bef\u54cd\u5e94\u7684\u767e\u5206\u6bd4\uff0c\u5bf9\u4e8e Linkerd\uff0c\u662f\u901a\u8fc7 HTTP \u72b6\u6001\u7801\u6765\u8861\u91cf\u7684\uff1a2xx \u548c 4xx \u54cd\u5e94\u88ab\u8ba4\u4e3a\u662f\u6210\u529f\u7684\uff0c5xx \u54cd\u5e94\u88ab\u8ba4\u4e3a\u662f\u5931\u8d25\u7684\uff0c\u5f53\u7136\u53cd\u8fc7\u6765\u6211\u4eec\u4e5f\u53ef\u4ee5\u8bf4 Linkerd \u62a5\u544a\u7684\u662f\u6210\u529f\u7387\u800c\u4e0d\u662f\u9519\u8bef\u7387\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u867d\u7136 4xx HTTP \u54cd\u5e94\u7801\u5bf9\u5e94\u4e8e\u5404\u79cd\u5f62\u5f0f\u7684\u201c\u672a\u627e\u5230\u60a8\u8bf7\u6c42\u7684\u8d44\u6e90\u201d\uff0c\u4f46\u8fd9\u4e9b\u662f\u670d\u52a1\u5668\u65b9\u9762\u7684\u6b63\u786e\u54cd\u5e94\uff0c\u800c\u4e0d\u662f\u9519\u8bef\u54cd\u5e94\u3002\u56e0\u6b64\uff0cLinkerd \u8ba4\u4e3a\u8fd9\u4e9b\u8bf7\u6c42\u662f\u6210\u529f\u7684\uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u6309\u7167\u5b83\u7684\u8981\u6c42\u505a\u4e86\u3002</p>"},{"location":"chap11/2linkered_index/#traffic-volume","title":"Traffic volume","text":"<p>\u6d41\u91cf\u662f\u5bf9\u7cfb\u7edf\u7684\u9700\u6c42\u91cf\u5ea6\uff0c\u5728 Linkerd \u7684\u4e0a\u4e0b\u6587\u4e2d\uff0c\u8fd9\u88ab\u6d4b\u91cf\u4e3a\u8bf7\u6c42\u7387\uff0c\u4f8b\u5982\u6bcf\u79d2\u8bf7\u6c42\u6570 (RPS)\u3002Linkerd \u7b80\u5355\u5730\u901a\u8fc7\u8ba1\u7b97\u5b83\u4ee3\u7406\u5230\u5e94\u7528\u7a0b\u5e8f\u7684\u8bf7\u6c42\u6765\u8ba1\u7b97\u8fd9\u4e00\u70b9\u3002</p> <p>\u53e6\u5916\u4e5f\u9700\u8981\u6ce8\u610f\u7531\u4e8e Linkerd \u53ef\u4ee5\u81ea\u52a8\u91cd\u8bd5\u8bf7\u6c42\uff0c\u56e0\u6b64\u5b83\u63d0\u4f9b\u4e86\u4e24\u79cd\u6d41\u91cf\u5ea6\u91cf\uff1a\u5b9e\u9645\uff08\u5bf9\u5e94\u8bf7\u6c42\uff0c\u5305\u62ec\u91cd\u8bd5\uff09\u548c\u6709\u6548\uff08\u5bf9\u5e94\u4e0d\u91cd\u8bd5\u7684\u8bf7\u6c42\uff09\u3002</p> <p>\u5982\u679c\u5ba2\u6237\u7aef\u5411\u4e2d\u95f4\u6709 Linkerd \u7684\u670d\u52a1\u5668\u53d1\u51fa\u8bf7\u6c42\uff0c\u5219\u6709\u6548\u8ba1\u6570\u5c06\u662f\u5ba2\u6237\u7aef\u53d1\u51fa\u7684\u8bf7\u6c42\u6570\uff1b\u5b9e\u9645\u8ba1\u6570\u5c06\u662f\u670d\u52a1\u5668\u6536\u5230\u7684\u8bf7\u6c42\u6570\u3002</p>"},{"location":"chap11/2linkered_index/#saturation","title":"Saturation","text":"<p>\u9971\u548c\u5ea6\u662f\u5bf9\u670d\u52a1\u53ef\u7528\u7684\u603b\u8d44\u6e90\u6d88\u8017\u7684\u5ea6\u91cf\uff0c\u4f8b\u5982 CPU\u3001\u5185\u5b58\u3002\u4e0e\u5176\u4ed6\u670d\u52a1\u7f51\u683c\u4e00\u6837\uff0cLinkerd \u6ca1\u6709\u76f4\u63a5\u7684\u673a\u5236\u6765\u8861\u91cf\u9971\u548c\u5ea6\uff0c\u4f46\u662f\uff0c\u5ef6\u8fdf\u901a\u5e38\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u8fd1\u4f3c\u503c\u3002</p> <p>\u8c37\u6b4c SRE \u4e66\u7c4d\u8bf4\uff1a</p> <p>\u5ef6\u8fdf\u589e\u52a0\u901a\u5e38\u662f\u9971\u548c\u7684\u4e3b\u8981\u6307\u6807\uff0c\u5728\u67d0\u4e2a\u5c0f\u7a97\u53e3\uff08\u4f8b\u5982\u4e00\u5206\u949f\uff09\u5185\u6d4b\u91cf\u4f60\u7684\u7b2c 99 \u4e2a\u767e\u5206\u4f4d\u54cd\u5e94\u65f6\u95f4\u53ef\u4ee5\u7ed9\u51fa\u975e\u5e38\u65e9\u671f\u7684\u9971\u548c\u4fe1\u53f7\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e3b\u8981\u4f7f\u7528\u53e6\u5916\u4e09\u4e2a\u9ec4\u91d1\u6307\u6807\uff1a\u6210\u529f\u7387\u3001\u8bf7\u6c42\u7387\u548c\u5ef6\u8fdf\u3002</p> <p>\u6700\u540e\u4e00\u70b9\u662f\uff0c\u867d\u7136 Linkerd \u53ef\u4ee5\u4ee3\u7406\u4efb\u4f55 TCP \u6d41\u91cf\uff0c\u4f46\u8fd9\u4e9b\u9ec4\u91d1\u6307\u6807\u4ec5\u9002\u7528\u4e8e\u4f7f\u7528 HTTP \u6216 gRPC \u7684\u670d\u52a1\u3002\u8fd9\u662f\u56e0\u4e3a\u8fd9\u4e9b\u6307\u6807\u9700\u8981\u7b2c 7 \u5c42\u6216\u534f\u8bae\u7ea7\u522b\u7684\u7406\u89e3\u624d\u80fd\u8ba1\u7b97\u3002\u4e00\u4e2a HTTP \u8bf7\u6c42\u5177\u6709\u6210\u529f\u548c\u4e0d\u6210\u529f\u8bf7\u6c42\u7684\u6982\u5ff5\uff0c\u4efb\u610f\u7684 TCP \u5b57\u8282\u6d41\u4e0d\u4f1a\u3002</p>"},{"location":"chap11/2linkered_index/#linkerd-dashboard","title":"Linkerd Dashboard \u4e2d\u67e5\u770b\u6307\u6807","text":"<p>\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u8fd9\u4e9b\u6307\u6807\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u770b\u770b\u524d\u9762\u90e8\u7f72\u7684 Emojivoto \u5e94\u7528\u3002</p> <pre><code>$ kubectl get pods -n emojivoto\nNAME                        READY   STATUS    RESTARTS        AGE\nemoji-696d9d8f95-5vn9w      2/2     Running   2 (5h11m ago)   41h\nvote-bot-6d7677bb68-jvxsg   2/2     Running   2 (5h11m ago)   41h\nvoting-ff4c54b8d-jjpkm      2/2     Running   2 (5h11m ago)   41h\nweb-5f86686c4d-58p7k        2/2     Running   2 (5h11m ago)   41h\n</code></pre> <p>Emojivoto \u5e94\u7528\u662f\u4e00\u4e2a gRPC \u670d\u52a1\uff0c\u4e00\u5171\u5305\u542b\u4e09\u4e2a\u5fae\u670d\u52a1\uff1a</p> <ul> <li>web\uff1a\u7528\u6237\u4e0e\u4e4b\u4ea4\u4e92\u7684\u524d\u7aef\u670d\u52a1</li> <li>emoji\uff1a\u63d0\u4f9b\u8868\u60c5\u5217\u8868\u7684 API \u670d\u52a1</li> <li>voting\uff1a\u63d0\u4f9b\u4e3a\u8868\u60c5\u6295\u7968\u7684 API \u670d\u52a1</li> </ul> <p>\u6211\u4eec\u5df2\u7ecf\u5c06\u8be5\u5e94\u7528\u5f15\u5165\u5230\u7f51\u683c\u4e2d\u6765\u4e86\uff0c\u80fd\u591f\u5728 Linkerd \u4eea\u8868\u677f\u4e2d\u67e5\u770b Emojivoto \u5e94\u7528\u7684\u6307\u6807\u4e86\uff0c\u5f53\u6211\u4eec\u6253\u5f00 Viz \u7684\u4eea\u8868\u677f\u7684\u65f6\u5019\uff0c\u9ed8\u8ba4\u4f1a\u663e\u793a\u96c6\u7fa4\u7684\u6240\u6709\u547d\u540d\u7a7a\u95f4\u5217\u8868\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u975e\u5e38\u5927\u7684\u533a\u522b\u662f\u547d\u540d\u7a7a\u95f4\u5217\u8868\u4e2d\u7684 emojivoto \u9879\u76ee\u73b0\u5728\u5728 Meshed \u5217\u4e0b\u663e\u793a\u4e3a 4/4\u3002</p> <p> </p> <p>\u5355\u51fb emojivoto \u94fe\u63a5\u53ef\u67e5\u770b\u547d\u540d\u7a7a\u95f4\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5305\u62ec\u201c\u7ae0\u9c7c\u201d\u56fe\uff0c\u663e\u793a\u670d\u52a1\u5982\u4f55\u901a\u8fc7\u7f51\u7edc\u8fde\u63a5\u76f8\u4e92\u5173\u8054\u7684\u3002\u8bf7\u8bb0\u4f4f\u8fd9\u5f20\u56fe\u7247\uff0c\u56e0\u4e3a\u6211\u4eec\u5c06\u4f7f\u7528 CLI \u5de5\u5177\u67e5\u770b\u76f8\u540c\u7684\u4fe1\u606f\u3002</p> <p> </p> <p>\u6b64\u5916\u8fd8\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4e0a\u9762\u8ba8\u8bba\u8fc7\u7684\u9ec4\u91d1\u6307\u6807\uff1ap50\u3001p95 \u548c p99 \u5ef6\u8fdf\u3001\u670d\u52a1\u7684\u6210\u529f/\u9519\u8bef\u7387\u4ee5\u53ca\u8bf7\u6c42\u91cf\uff0c\u5373\u6bcf\u79d2\u8bf7\u6c42\u6570(RPS)\u3002\u4ece\u6210\u529f\u7387\u4e00\u5217\u53ef\u4ee5\u770b\u51fa\u5176\u4e2d\u4e00\u9879\u670d\u52a1\u6709\u4e00\u4e9b\u9519\u8bef\u3002</p> <p> </p> <p>\u8be5 Deployment \u7ea7\u522b\u4fe1\u606f\u662f\u5904\u7406\u5e94\u7528\u7a0b\u5e8f\u8bf7\u6c42\u7684\u6240\u6709 Pod \u7684\u6307\u6807\u7684\u805a\u5408\uff0c\u6211\u4eec\u5411\u4e0b\u6eda\u52a8\u9875\u9762\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a Pod \u5bf9\u5e94\u7684\u6307\u6807\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0 web \u670d\u52a1\u7684\u526f\u672c\u6570\u6765\u8fdb\u884c\u9a8c\u8bc1\u3002</p> <p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5c06 web \u670d\u52a1\u589e\u52a0\u5230\u4e24\u4e2a\u526f\u672c\uff1a</p> <pre><code>$ kubectl scale deploy/web -n emojivoto --replicas=2\n</code></pre> <p>\u6267\u884c\u6b64\u547d\u4ee4\u540e\uff0c\u4eea\u8868\u677f\u5c06\u81ea\u884c\u66f4\u65b0\uff0cWeb \u5e94\u7528\u5c06\u5728 Meshed \u5217\u4e0b\u663e\u793a\u4e3a 2/2\uff0c\u6b64\u5916\uff0c\u4f60\u5c06\u5728 Pod \u90e8\u5206\u4e0b\u770b\u5230\u53e6\u4e00\u4e2a Web pod\u3002</p> <p> </p> <p> </p> <p>\u901a\u8fc7\u89c2\u5bdf Deployments \u548c Pods \u90e8\u5206\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u770b\u5230 Deployments \u4e2d\u7684\u6307\u6807\u6570\u636e\u7684\u786e\u5c31\u662f Pods \u7684\u6307\u6807\u805a\u5408\u6570\u636e\u3002\u6700\u540e\u6211\u4eec\u518d\u6765\u770b\u770b Linkerd \u63d0\u4f9b\u7684 TCP \u7ea7\u522b\u7684\u6307\u6807\uff0c\u5728 emojivoto \u547d\u540d\u7a7a\u95f4\u7684\u9875\u9762\u5e95\u90e8\uff0c\u4f1a\u663e\u793a TCP \u8fde\u63a5\u6570\u4ee5\u53ca\u6bcf\u4e2a Pod \u8bfb\u53d6\u548c\u5199\u5165\u7684\u5b57\u8282\u6570</p> <p> </p> <p>TCP \u7684\u6307\u6807\u6bd4 7 \u5c42\u7684\u6307\u6807\u4f1a\u66f4\u5c11\uff0c\u4f8b\u5982\u5728\u4efb\u610f TCP \u5b57\u8282\u6d41\u4e2d\u6ca1\u6709\u8bf7\u6c42\u7684\u6982\u5ff5\u3002\u5c3d\u7ba1\u5982\u6b64\uff0c\u8fd9\u4e9b\u6307\u6807\u5728\u8c03\u8bd5\u5e94\u7528\u7a0b\u5e8f\u7684\u8fde\u63a5\u7ea7\u522b\u95ee\u9898\u65f6\u4ecd\u7136\u5f88\u6709\u7528\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u7ee7\u7eed\u63a2\u7d22\u4eea\u8868\u677f\u5e76\u67e5\u770b\u8ba9\u6211\u4eec\u5b9e\u65f6\u67e5\u770b\u6d41\u91cf\u7684 Tap \u529f\u80fd\u3002</p> <p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u4f7f\u7528\u4eea\u8868\u677f\u6765\u83b7\u53d6 Emojivoto \u5e94\u7528\u7a0b\u5e8f\u4e2d\u670d\u52a1\u7684\u805a\u5408\u6027\u80fd\u6307\u6807\u4e86\u3002\u73b0\u5728\u8ba9\u6211\u4eec\u4f7f\u7528\u4eea\u8868\u677f\u901a\u8fc7 Linkerd \u63d0\u4f9b\u7684 tap \u529f\u80fd\u5b9e\u65f6\u67e5\u770b\u6d41\u91cf\u3002</p> <p>\u5728\u4eea\u8868\u677f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 voting \u670d\u52a1\u7684\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u8ba9\u6211\u4eec\u4f7f\u7528 tap \u529f\u80fd\u6765\u67e5\u770b\u5bf9\u670d\u52a1\u7684\u8bf7\u6c42\uff0c\u6765\u5c1d\u8bd5\u5f04\u6e05\u695a\u53d1\u751f\u4e86\u4ec0\u4e48\u3002</p> <p> </p> <p>\u5355\u51fb emojivoto \u5e94\u7528\u7684 voting \u94fe\u63a5\u53ef\u4ee5\u6df1\u5165\u4e86\u89e3\u8be6\u7ec6\u4fe1\u606f\uff0c\u6211\u4eec\u5c06\u770b\u5230\u7684\u7b2c\u4e00\u4ef6\u4e8b\u662f\u663e\u793a voting \u5fae\u670d\u52a1\u4e0e\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5176\u4ed6\u5fae\u670d\u52a1\u4e4b\u95f4\u5173\u7cfb\u7684\u56fe\u8868\u3002</p> <p> </p> <p>\u5728\u56fe\u8868\u4e0b\u65b9\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a LIVE CALLS \u7684\u9009\u9879\u5361\uff0c\u5176\u4e2d\u663e\u793a\u4e86\u5bf9 voting \u670d\u52a1\u7684\u5b9e\u65f6\u8c03\u7528\uff01\u6bcf\u6b21\u8c03\u7528\u65f6\uff0c\u8868\u4e2d\u7684\u884c\u90fd\u4f1a\u66f4\u65b0\u6709\u5173\u8bf7\u6c42\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u5305\u62ec\u54cd\u5e94\u7684 HTTP \u72b6\u6001\u3002</p> <p> </p> <p>\u5728\u6211\u4eec\u8be6\u7ec6\u4e86\u89e3\u8fd9\u4e9b\u5b9e\u65f6\u8c03\u7528\u4e4b\u524d\uff0c\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb Route Metrics \u9009\u9879\u5361\u6765\u67e5\u770b voting \u670d\u52a1\u7684\u8def\u7531\u8868\u4ee5\u53ca\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\uff0c\u5728\u6211\u4eec\u8fd9\u91cc\u53ea\u6709\u4e00\u4e2a\u540d\u4e3a Default \u7684\u8def\u7531\uff0c\u5b83\u662f\u4e3a\u6bcf\u4e2a\u670d\u52a1\u521b\u5efa\u7684\u3002</p> <p> </p> <p>\u73b0\u5728\u6211\u4eec\u77e5\u9053\u4e86\u5982\u4f55\u5728\u4eea\u8868\u677f\u4e2d\u67e5\u627e\u5b9e\u65f6\u8c03\u7528\uff0c\u73b0\u5728\u6211\u4eec\u6765\u5c1d\u8bd5\u4e0b\u770b\u770b\u662f\u5426\u53ef\u4ee5\u627e\u5230\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u7684\u8c03\u7528\u5e76\u4f7f\u7528\u4eea\u8868\u677f\u4e2d\u7684 tap \u529f\u80fd\u3002\u5f53\u6211\u4eec\u770b\u5230\u5bf9\u8def\u5f84 <code>/emojivoto/v1.VotingService/VoteDoughnut</code> \u7684\u8bf7\u6c42\uff0c\u8bf7\u5355\u51fb\u5176\u53f3\u4fa7\u7684\u663e\u5fae\u955c\u56fe\u6807\u8df3\u8f6c\u5230 Tap \u9875\u9762\u3002</p> <p> </p> <p>\u5176\u5b9e\u901a\u8fc7\u67e5\u770b\u6210\u529f\u7387\u8fd9\u4e00\u5217\u7684\u6570\u636e\u5f88\u5bb9\u6613\u53d1\u73b0\u8be5\u8def\u5f84\u8bf7\u6c42\u6709\u9519\u8bef\u3002</p> <p>Tap \u9875\u9762\u5305\u542b\u4e00\u4e2a\u591a\u4e2a\u5b57\u6bb5\u7684\u8868\u5355\uff0c\u8fd9\u4e9b\u5b57\u6bb5\u5df2\u6839\u636e\u6211\u4eec\u70b9\u51fb\u7684\u7279\u5b9a\u8bf7\u6c42\u7684\u94fe\u63a5\u9884\u5148\u586b\u5145\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc Path\u3001Namespace\u3001Resource \u7b49\u5b57\u6bb5\u90fd\u5df2\u7ecf\u88ab\u81ea\u52a8\u586b\u5145\u4e0a\u4e86\uff0c\u4e0b\u9762\u8fd8\u6709\u4e00\u4e2a\u8f93\u51fa\u663e\u793a\u6b63\u5728\u8fd0\u884c\u7684\u5f53\u524d Tap \u67e5\u8be2\u3002</p> <p> </p> <p>\u73b0\u5728\u6211\u4eec\u70b9\u51fb Tap \u9875\u9762\u9876\u90e8\u7684 START \u6309\u94ae\uff0c\u5f00\u59cb\u5bf9\u6295\u7968\u670d\u52a1\u7684 /<code>emojivoto.v1.VotingService/VoteDougNut</code> \u8def\u5f84\u7684\u8bf7\u6c42\uff0c\u51e0\u79d2\u949f\u540e\uff0c\u4e0b\u65b9\u7684\u5217\u8868\u5c06\u5f00\u59cb\u586b\u5145 VoteDougNut \u8def\u5f84\u7684\u4f20\u5165\u8bf7\u6c42\u3002</p> <p> </p> <p>\u6211\u4eec\u53ef\u4ee5\u5355\u51fb\u5de6\u4fa7\u7684\u7bad\u5934\u6765\u67e5\u770b\u5305\u542b\u8bf7\u6c42\u4fe1\u606f\u7684\u5bf9\u8bdd\u6846\u3002</p> <p> </p> <p>\u8fd9\u5c31\u662f\u901a\u8fc7 Linkerd \u4eea\u8868\u677f\u4e2d\u4f7f\u7528 Tap \u7684\u65b9\u5f0f\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u66f4\u6539\u8868\u5355\u5b57\u6bb5\u4e2d\u7684\u503c\u5e76\u4f7f\u7528\u4e0d\u540c\u7684\u67e5\u8be2\u6765\u67e5\u770b\u4e0d\u540c\u7684\u8bf7\u6c42\uff0c\u4f8b\u5982\u6211\u4eec\u53ef\u4ee5\u5c06 <code>Path</code> \u5b57\u6bb5\u4e2d\u7684 <code>/emojivoto.v1.VotingService/VoteDoughnut</code> \u503c\u5220\u6389\uff0c\u5e76\u5c06 <code>To Resource</code> \u8bbe\u7f6e\u4e3a <code>Deployment</code>\uff0c\u5f53\u6211\u4eec\u70b9\u51fb\u5f00\u59cb\u6309\u94ae\u540e\uff0c\u6211\u4eec\u5c06\u53ef\u4ee5\u770b\u5230\u4ece Web \u670d\u52a1\u53d1\u9001\u7684\u6240\u6709\u6d41\u91cf\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u5982\u4f55\u4f7f\u7528 Tap \u67e5\u770b\u670d\u52a1\u7684\u6d41\u91cf\u6307\u6807\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u901a\u8fc7\u67e5\u770b Linkerd \u7684 Grafana \u4eea\u8868\u677f\u6765\u4e86\u89e3\u8fd9\u4e9b\u6307\u6807\u662f\u5982\u4f55\u4f7f\u7528\u7684\u3002</p>"},{"location":"chap11/2linkered_index/#grafana","title":"Grafana \u4e2d\u5c55\u793a\u6307\u6807","text":"<p>Linkerd \u7684 Viz \u63d2\u4ef6\u5185\u7f6e\u4e86 Grafana\uff0cLinkerd \u4f7f\u7528 Grafana \u4e3a\u90e8\u7f72\u5230 Kubernetes \u7684\u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u4e86\u989d\u5916\u7684\u53ef\u89c2\u5bdf\u6027\u6570\u636e\u3002</p> <p>\u5728\u6d4f\u89c8\u4eea\u8868\u677f\u65f6\uff0c\u4f60\u53ef\u80fd\u5df2\u7ecf\u6ce8\u610f\u5230\u4e86 Grafana \u56fe\u6807\uff0c\u8fd9\u91cc\u6211\u4eec\u4ee5 emoji \u5fae\u670d\u52a1\u4e3a\u4f8b\u5bf9 Grafana \u56fe\u8868\u8fdb\u884c\u8bf4\u660e</p> <p>\u5728 Linkerd \u4eea\u8868\u677f\u7684 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u5355\u51fb emoji \u884c\u6700\u53f3\u4fa7\u5217\u4e2d\u7684 Grafana \u56fe\u6807\uff0c\u4f1a\u6253\u5f00 Grafana \u4eea\u8868\u677f\u4ee5\u663e\u793a emoji \u5fae\u670d\u52a1\u7684\u76f8\u5173\u56fe\u8868\uff0c\u8fd9\u4e9b\u9875\u9762\u4e0a\u7684\u56fe\u8868\u663e\u793a\u4e86 Linkerd \u4eea\u8868\u677f\u4e2d\u663e\u793a\u7684\u6307\u6807\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0c\u8fd9\u91cc\u6211\u4eec\u770b\u5230\u7684\u5c31\u662f emoji \u670d\u52a1\u968f\u7740\u65f6\u95f4\u63a8\u79fb\u7684\u670d\u52a1\u6027\u80fd\u53d8\u5316\u3002</p> <p> </p> <p>Grafana \u4eea\u8868\u677f\u4e0a\u7684\u56fe\u8868\u5305\u62ec\u6211\u4eec\u7684\u6807\u51c6\u9ec4\u91d1\u6307\u6807\u96c6\uff1a</p> <ul> <li>Success rate</li> <li>Request rate</li> <li>Latencies</li> </ul> <p>\u968f\u65f6\u95f4\u67e5\u770b\u9ec4\u91d1\u6307\u6807\u56fe\u8868\u7684\u80fd\u529b\u662f\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u7684\u975e\u5e38\u5f3a\u5927\u7684\u5de5\u5177\u3002\u4ee5\u65f6\u95f4\u5e8f\u5217\u7684\u5f62\u5f0f\u67e5\u770b\u8fd9\u4e9b\u6307\u6807\u53ef\u4ee5\u8ba9\u4f60\u4e86\u89e3\uff0c\u4f8b\u5982\uff0c\u5f53\u6d41\u91cf\u8d1f\u8f7d\u589e\u52a0\u65f6\u670d\u52a1\u7684\u6267\u884c\u60c5\u51b5\uff0c\u6216\u8005\u5728\u8fdb\u884c\u66f4\u65b0\u4ee5\u6dfb\u52a0\u529f\u80fd\u6216\u4fee\u590d\u9519\u8bef\u65f6\uff0c\u670d\u52a1\u7684\u4e00\u4e2a\u7248\u672c\u4e0e\u53e6\u4e00\u4e2a\u7248\u672c\u7684\u6bd4\u8f83\u60c5\u51b5\u3002</p> <p>Grafana \u4eea\u8868\u677f\u7684\u4f18\u70b9\u5728\u4e8e\u4f60\u65e0\u9700\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u5373\u53ef\u521b\u5efa\u5b83\u4eec\uff0cLinkerd \u4f7f\u7528\u52a8\u6001\u6a21\u677f\u4e3a\u6bcf\u4e2a\u6ce8\u5165 Linkerd \u4ee3\u7406\u548c\u90e8\u5206\u670d\u52a1\u7f51\u683c\u7684 Kubernetes \u8d44\u6e90\u751f\u6210\u4eea\u8868\u677f\u548c\u56fe\u8868\u3002\u6211\u4eec\u53ef\u4ee5\u5728 Grafana \u4eea\u8868\u677f\u7684\u5de6\u4e0a\u89d2\uff0c\u5355\u51fb Linkerd Deployment \u94fe\u63a5\u4ee5\u6253\u5f00\u53ef\u7528\u4eea\u8868\u677f\u5217\u8868\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb Linkerd Pod \u4eea\u8868\u76d8\uff0c\u67e5\u770b\u4e0e emoji \u670d\u52a1\u76f8\u5173\u7684\u4e00\u4e2a Pod \u7684\u56fe\u8868\uff0c\u4eea\u8868\u677f\u4e2d\u663e\u793a\u4e86\u5355\u4e2a Pod \u7684\u76f8\u540c\u7684\u9ec4\u91d1\u6307\u6807\uff0c\u8fd9\u4e0e Deployment \u4eea\u8868\u677f\u4e0d\u540c\uff0c\u56e0\u4e3a Deployment \u4eea\u8868\u677f\u663e\u793a\u4e86\u4e0e Deployment \u76f8\u5173\u7684\u6240\u6709 Pod \u7684\u6c47\u603b\u6307\u6807\u3002</p> <p> </p>"},{"location":"chap11/2linkered_index/#linkerd-cli","title":"Linkerd CLI \u547d\u4ee4\u67e5\u770b\u6307\u6807","text":"<p>Linkerd \u4eea\u8868\u677f\u529f\u80fd\u5f88\u5f3a\u5927\uff0c\u56e0\u4e3a\u5b83\u5728\u57fa\u4e8e\u6d4f\u89c8\u5668\u7684\u754c\u9762\u4e2d\u663e\u793a\u4e86\u5927\u91cf\u6307\u6807\uff0c\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528\u6d4f\u89c8\u5668\u7684\u8bdd\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Linkerd CLI \u547d\u4ee4\u884c\u5de5\u5177\uff0cCLI \u5728\u7ec8\u7aef\u4e2d\u63d0\u4f9b\u4e86\u4eea\u8868\u677f\u76f8\u540c\u7684\u529f\u80fd\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u663e\u793a <code>emojivoto</code> \u547d\u540d\u7a7a\u95f4\u4e2d\u4ece<code>Web</code> \u670d\u52a1\u901a\u8fc7 <code>/emojivoto.v1.VotingService/VoteDoughnut</code> \u8def\u5f84\u5230\u6295\u7968\u670d\u52a1\u7684\u6240\u6709\u6d41\u91cf\uff1a</p> <pre><code>$ linkerd viz tap deployment/web --namespace emojivoto --to deployment/voting --path /emojivoto.v1.VotingService/VoteDoughnut\n\nreq id=3:0 proxy=out src=10.244.2.71:41226 dst=10.244.1.95:8080 tls=true :method=POST :authority=voting-svc.emojivoto:8080 :path=/emojivoto.v1.VotingService/VoteDoughnut\nrsp id=3:0 proxy=out src=10.244.2.71:41226 dst=10.244.1.95:8080 tls=true :status=200 latency=1128\u00b5s\nend id=3:0 proxy=out src=10.244.2.71:41226 dst=10.244.1.95:8080 tls=true grpc-status=Unknown duration=183\u00b5s response-length=0B\n</code></pre> <p>\u6b64\u5916\u6211\u4eec\u8fd8\u901a\u8fc7\u4f7f\u7528 -o json \u6807\u5fd7\u6307\u5b9a\u8f93\u51fa\u6570\u636e\u4e3a JSON \u683c\u5f0f\uff0c\u4ee5\u83b7\u53d6\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ linkerd viz tap deployment/web --namespace emojivoto --to deployment/voting --path /emojivoto.v1.VotingService/VoteDoughnut -o json\n\n{\n  \"source\": {\n    \"ip\": \"10.244.1.108\",\n    \"port\": 59370,\n    \"metadata\": {\n      \"control_plane_ns\": \"linkerd\",\n      \"deployment\": \"web\",\n      \"namespace\": \"emojivoto\",\n      \"pod\": \"web-5f86686c4d-58p7k\",\n      \"pod_template_hash\": \"5f86686c4d\",\n      \"serviceaccount\": \"web\",\n      \"tls\": \"loopback\"\n    }\n  },\n  \"destination\": {\n    \"ip\": \"10.244.1.95\",\n    \"port\": 8080,\n    \"metadata\": {\n      \"control_plane_ns\": \"linkerd\",\n      \"deployment\": \"voting\",\n      \"namespace\": \"emojivoto\",\n      \"pod\": \"voting-ff4c54b8d-jjpkm\",\n      \"pod_template_hash\": \"ff4c54b8d\",\n      \"server_id\": \"voting.emojivoto.serviceaccount.identity.linkerd.cluster.local\",\n      \"service\": \"voting-svc\",\n      \"serviceaccount\": \"voting\",\n      \"tls\": \"true\"\n    }\n  },\n  \"routeMeta\": null,\n  \"proxyDirection\": \"OUTBOUND\",\n  \"responseInitEvent\": {\n    \"id\": {\n      \"base\": 6,\n      \"stream\": 6\n    },\n    \"sinceRequestInit\": {\n      \"nanos\": 686968\n    },\n    \"httpStatus\": 200,\n    \"headers\": [\n      {\n        \"name\": \":status\",\n        \"valueStr\": \"200\"\n      },\n      {\n        \"name\": \"content-type\",\n        \"valueStr\": \"application/grpc\"\n      },\n      {\n        \"name\": \"grpc-status\",\n        \"valueStr\": \"2\"\n      },\n      {\n        \"name\": \"grpc-message\",\n        \"valueStr\": \"ERROR\"\n      },\n      {\n        \"name\": \"date\",\n        \"valueStr\": \"Thu, 25 Aug 2022 08:52:05 GMT\"\n      }\n    ]\n  }\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 JSON \u8f93\u51fa\u7684\u4fe1\u606f\u8981\u8be6\u7ec6\u5f97\u591a\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u4f1a\u6253\u5370\u6709\u5173\u7684\u591a\u884c\u4fe1\u606f\uff0c\u5305\u62ec\uff1a</p> <ul> <li>HTTP \u65b9\u6cd5</li> <li>\u6d41\u91cf\u7684\u65b9\u5411</li> <li>HTTP Header</li> </ul> <p>\u8ba9\u6211\u4eec\u518d\u8fd0\u884c\u4e00\u4e2a\u66f4\u7c97\u7c92\u5ea6\u7684 Tap \u67e5\u8be2\uff0c\u5c31\u50cf\u6211\u4eec\u5728\u4eea\u8868\u677f\u4e2d\u8fd0\u884c\u7684\u67e5\u8be2\u4e00\u6837\u3002\u6bd4\u5982\u83b7\u53d6 Web \u670d\u52a1\u7684\u6240\u6709\u6d41\u91cf\uff1a</p> <pre><code>$ linkerd viz tap deploy/web -n emojivoto\n\nreq id=7:13 proxy=out src=10.244.1.108:33416 dst=10.244.1.88:8080 tls=true :method=POST :authority=emoji-svc.emojivoto:8080 :path=/emojivoto.v1.EmojiService/FindByShortcode\nrsp id=7:13 proxy=out src=10.244.1.108:33416 dst=10.244.1.88:8080 tls=true :status=200 latency=708\u00b5s\nend id=7:13 proxy=out src=10.244.1.108:33416 dst=10.244.1.88:8080 tls=true grpc-status=OK duration=35\u00b5s response-length=20B\nreq id=7:14 proxy=out src=10.244.1.108:59370 dst=10.244.1.95:8080 tls=true :method=POST :authority=voting-svc.emojivoto:8080 :path=/emojivoto.v1.VotingService/VoteMan\nrsp id=7:14 proxy=out src=10.244.1.108:59370 dst=10.244.1.95:8080 tls=true :status=200 latency=809\u00b5s\nend id=7:14 proxy=out src=10.244.1.108:59370 dst=10.244.1.95:8080 tls=true grpc-status=OK duration=65\u00b5s response-length=5B\n# ......\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u6211\u4eec\u5220\u9664\u4e86 <code>--to</code> \u548c <code>--path</code> \u8fd9\u4e9b\u53c2\u6570\uff0c\u7c92\u5ea6\u66f4\u7c97\u4e86\uff0c\u6574\u4e2a\u8f93\u51fa\u5c06\u663e\u793a\u6240\u6709\u8fdb\u51fa Web \u670d\u52a1\u7684\u6d41\u91cf\uff0c\u5305\u62ec web \u548c emoji \u670d\u52a1\u4ee5\u53ca web \u548c voting \u670d\u52a1\u4e4b\u95f4\u7684\u6d41\u91cf\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u6bcf\u884c\u8f93\u51fa\u4e2d\u7684 src \u548c dst \u5b57\u6bb5\u67e5\u770b\u6d41\u91cf\u7684\u65b9\u5411\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528 <code>-o json</code> \u6807\u5fd7\u518d\u6b21\u8fd0\u884c\u67e5\u8be2\u4ee5\u67e5\u770b JSON \u683c\u5f0f\u7684\u8f93\u51fa\uff0c\u5e76\u67e5\u770b\u662f\u5426\u53ef\u4ee5\u53d1\u73b0\u7ed9\u5b9a\u8bf7\u6c42\u7684\u6d41\u91cf\u65b9\u5411\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u5728\u7ec8\u7aef\u4e2d\u4f7f\u7528 tap \u547d\u4ee4\u5b9e\u65f6\u663e\u793a\u6d41\u91cf\uff0c</p> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u53e6\u5916\u4e00\u4e2a <code>linkerd viz top</code> \u547d\u4ee4\uff0c\u8be5\u547d\u4ee4\u548c tap \u547d\u4ee4\u63d0\u4f9b\u76f8\u540c\u7684\u4fe1\u606f\uff0c\u4f46\u683c\u5f0f\u4e0e\u57fa\u4e8e Unix \u7684 top \u547d\u4ee4\u76f8\u540c\u3002</p> <p>\u6362\u53e5\u8bdd\u8bf4\uff0c<code>linkerd viz top</code> \u663e\u793a\u4e86\u6309\u6700\u53d7\u6b22\u8fce\u7684\u8def\u5f84\u6392\u5e8f\u7684\u6d41\u91cf\u8def\u7ebf\uff0c\u6211\u4eec\u6765\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u8fdb\u884c\u67e5\u770b\uff1a</p> <p> </p> <p>\u540c\u6837\u73b0\u5728\u6211\u4eec\u60f3\u5728\u7ec8\u7aef\u4e2d\u67e5\u770b\u4eea\u8868\u677f\u4e2d\u770b\u5230\u7684\u5ef6\u8fdf\u3001\u6210\u529f/\u9519\u8bef\u7387\u548c\u6bcf\u79d2\u8bf7\u6c42\u6570\u6307\u6807\uff0c\u53c8\u5e94\u8be5\u600e\u4e48\u64cd\u4f5c\u5462\uff1f</p> <p>\u540c\u6837 Linkerd CLI \u63d0\u4f9b\u4e86\u4e00\u4e2a stat \u547d\u4ee4\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u6765\u6267\u884c\u8be5\u64cd\u4f5c\u3002\u8ba9\u6211\u4eec\u901a\u8fc7\u83b7\u53d6 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u6240\u6709\u670d\u52a1\u7684\u6307\u6807\u6765\u5c1d\u8bd5\u4e00\u4e0b\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ linkerd viz stat deploy -n emojivoto\nNAME       MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN\nemoji         1/1   100.00%   2.3rps           1ms           1ms           1ms          4\nvote-bot      1/1   100.00%   0.3rps           1ms           1ms           1ms          1\nvoting        1/1    89.74%   1.3rps           1ms           1ms           1ms          4\nweb           2/2    93.51%   2.6rps           1ms           7ms           9ms          6\n</code></pre> <p><code>linkerd viz stat</code> \u547d\u4ee4\u53ef\u4ee5\u83b7\u53d6\u5230\u5e94\u7528\u670d\u52a1\u6027\u80fd\u7684\u6700\u65b0\u6307\u6807\u6570\u636e\uff0c\u5982\u679c\u4f60\u60f3\u8981\u83b7\u53d6\u66f4\u591a\u6570\u636e\uff0c\u53ef\u4ee5\u6dfb\u52a0 <code>-o wide</code> \u6807\u5fd7\u6765\u83b7\u53d6\u8fd9\u4e9b TCP \u7ea7\u522b\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</p> <p>\u4efb\u4f55\u65f6\u5019\u60a8\u60f3\u8981\u83b7\u5f97\u5e94\u7528\u7a0b\u5e8f\u4e2d\u670d\u52a1\u6027\u80fd\u7684\u6700\u65b0\u5feb\u7167\uff0c\u60a8\u90fd\u53ef\u4ee5\u4f7f\u7528 linkerd viz stat \u6765\u83b7\u53d6\u8fd9\u4e9b\u6307\u6807\u3002\u5982\u679c\u60a8\u60f3\u66f4\u6df1\u5165\u5730\u83b7\u53d6\u5199\u5165\u548c\u8bfb\u53d6\u7684\u5b57\u8282\u6570\uff0c\u53ef\u4ee5\u6dfb\u52a0 <code>-o Wide</code> \u6807\u5fd7\u6765\u83b7\u53d6\u8fd9\u4e9b TCP \u7ea7\u522b\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\u65e0\u8bba\u662f\u5426\u4f7f\u7528 -o wide \u6807\u5fd7\uff0c\u90fd\u5c06\u59cb\u7ec8\u663e\u793a TCP \u8fde\u63a5\u3002</p> <pre><code>$ linkerd viz stat deploy -n emojivoto -o wide\nNAME       MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN   READ_BYTES/SEC   WRITE_BYTES/SEC\nemoji         1/1   100.00%   2.3rps           1ms           1ms           1ms          4         229.0B/s         2680.8B/s\nvote-bot      1/1   100.00%   0.3rps           1ms           3ms           3ms          1          24.3B/s          585.0B/s\nvoting        1/1    89.74%   1.3rps           1ms           1ms           1ms          4         121.4B/s          481.0B/s\nweb           2/2    92.95%   2.6rps           1ms           4ms           4ms          6         205.0B/s         5949.4B/s\n</code></pre> <p>\u540c\u6837 stat \u547d\u4ee4\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>--to</code> \u53c2\u6570\u6765\u7f29\u5c0f\u67e5\u8be2\u8303\u56f4\uff0c\u6bd4\u5982\u6211\u4eec\u60f3\u8981\u67e5\u8be2\u4ece web \u670d\u52a1\u5230 voting \u670d\u52a1\u7684\u6d41\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ linkerd viz stat -n emojivoto deploy/web --to deploy/voting\nNAME   MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN\nweb       2/2    86.67%   1.0rps           1ms           4ms           4ms          2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u7684\u6570\u636e\u548c\u524d\u9762\u4e00\u6837\uff0c\u53ea\u662f\u53ea\u6709\u4e00\u884c\u6570\u636e\u8f93\u51fa\uff0c\u5176\u4e2d\u6700\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u6210\u529f\u7387\u8fd9\u4e00\u5217\u4f4e\u4e8e 100% \u4e86\u3002\u4ece\u8fd9\u4e2a\u8f93\u51fa\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u63a8\u65ad\u51fa\uff0c\u5f53\u6211\u4eec\u67e5\u770b emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u670d\u52a1\u65f6\uff0cweb \u670d\u52a1\u7684\u6210\u529f\u7387\u662f\u6765\u81ea voting \u548c emoji \u670d\u52a1\u54cd\u5e94\u7684\u603b\u548c\u3002</p> <p>\u4e3a\u4e86\u9a8c\u8bc1\u8fd9\u4e2a\u5047\u8bbe\uff0c\u8ba9\u6211\u4eec\u518d\u8fd0\u884c\u4e00  \u4e2a\u67e5\u8be2\uff0c\u4ee5\u4ec5\u67e5\u770b\u4ece web \u670d\u52a1\u5230\u547d\u540d\u7a7a\u95f4\u4e2d\u6240\u6709\u5176\u4ed6\u670d\u52a1\u7684\u6d41\u91cf\u3002</p> <pre><code>$ linkerd viz stat -n emojivoto deploy --from deploy/web\nNAME     MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN\nemoji       1/1   100.00%   1.9rps           1ms           1ms           2ms          2\nvoting      1/1    83.05%   1.0rps           1ms           1ms           2ms          2\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u5b9e\u9645\u4e0a\uff0cvoting \u670d\u52a1\u5b58\u5728\u9519\u8bef\uff0c\u800c emoji \u670d\u52a1\u5219\u6ca1\u6709\u3002</p> <p>stat \u547d\u4ee4\u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u5177\u6709\u8bb8\u591a\u914d\u7f6e\u9009\u9879\u3002\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c <code>linkerd viz stat -h</code> \u4ee5\u67e5\u770b\u53ef\u4ee5\u8fd0\u884c stat \u7684\u6240\u6709\u53ef\u7528\u65b9\u5f0f\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86\u51e0\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u6765\u67e5\u770b\u88ab Linkerd \u7f51\u683c\u5316\u7684\u5e94\u7528\u7684\u9ec4\u91d1\u6307\u6807\u6570\u636e\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u83b7\u53d6\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\uff0c\u901a\u8fc7\u4e3a Kubernetes \u670d\u52a1\u521b\u5efa ServiceProfile \u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u670d\u52a1\u53ef\u7528\u7684\u8def\u7531\u5e76\u4e3a\u6bcf\u4e2a\u8def\u7531\u6536\u96c6\u5355\u72ec\u7684\u6307\u6807\u3002</p> <p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u53ea\u80fd\u770b\u5230 default \u8def\u7531\u4e0a\u5bf9\u670d\u52a1\u7684\u6240\u6709\u8bf7\u6c42\u7684\u6307\u6807\u3002\u4e3a emojivoto \u670d\u52a1\u914d\u7f6e ServiceProfiles \u540e\uff0c\u6211\u4eec\u5c06\u80fd\u591f\u770b\u5230\u6bcf\u6761\u8def\u7531\u7684\u6307\u6807\uff01</p>"},{"location":"chap11/3linkered_ServiceProfile/","title":"3 Linkerd \u901a\u8fc7 ServiceProfile \u5b9e\u73b0\u8d85\u65f6\u548c\u91cd\u8bd5","text":"<p>Linkerd \u670d\u52a1\u7f51\u683c\u89e3\u51b3\u7684\u6700\u91cd\u8981\u95ee\u9898\u4e4b\u4e00\u662f\u53ef\u89c2\u5bdf\u6027\uff1a\u63d0\u4f9b\u670d\u52a1\u884c\u4e3a\u7684\u8be6\u7ec6\u89c6\u56fe\uff0cLinkerd \u5bf9\u53ef\u89c2\u5bdf\u6027\u7684\u4ef7\u503c\u4e3b\u5f20\u662f\uff0c\u5b83\u53ef\u4ee5\u4e3a\u4f60\u7684 HTTP \u548c gRPC \u670d\u52a1\u63d0\u4f9b\u9ec4\u91d1\u6307\u6807\uff0c\u8fd9\u4e9b\u90fd\u662f\u81ea\u52a8\u6267\u884c\uff0c\u65e0\u9700\u66f4\u6539\u4ee3\u7801\u6216\u5f00\u53d1\u4eba\u5458\u53c2\u4e0e\u7684\u3002</p> <p>\u5f00\u7bb1\u5373\u7528\uff0cLinkerd \u5728\u6bcf\u4e2a\u670d\u52a1\u7684\u57fa\u7840\u4e0a\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\uff1a\u8de8\u8d8a\u670d\u52a1\u7684\u6240\u6709\u8bf7\u6c42\uff0c\u65e0\u8bba\u8fd9\u4e9b\u8bf7\u6c42\u662f\u4ec0\u4e48\u3002\u7136\u800c\uff0c\u6709\u65f6\u9700\u8981\u83b7\u5f97\u66f4\u7ec6\u7c92\u5ea6\u7684\u6307\u6807\u3002</p> <p>\u4f8b\u5982\u524d\u9762\u7684 Emojivoto \u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684 Emoji \u5fae\u670d\u52a1\uff0c\u524d\u9762\u7ae0\u8282\u4e2d\u770b\u5230\u7684 Linkerd \u62a5\u544a\u7684\u6307\u6807\u662f\u5728\u8be5\u670d\u52a1\u7684\u6240\u6709\u7aef\u70b9\u4e0a\u805a\u5408\u7684\u3002\u5728\u5b9e\u9645\u573a\u666f\u4e0b\u9762\uff0c\u6211\u4eec\u53ef\u80fd\u8fd8\u5e0c\u671b\u770b\u5230\u7279\u5b9a\u7aef\u70b9\u7684\u6210\u529f\u7387\u6216\u5ef6\u8fdf\uff0c\u4f8b\u5982\uff0c\u4e00\u4e2a\u7aef\u70b9\u53ef\u80fd\u5bf9\u670d\u52a1\u7279\u522b\u5173\u952e\uff0c\u6216\u8005\u7279\u522b\u6162\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cLinkerd \u4f7f\u7528\u4e86\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff08service profile\uff09\u7684\u6982\u5ff5\uff0c\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u662f\u4e00\u4e2a\u53ef\u9009\u7684\u914d\u7f6e\uff0c\u5b83\u901a\u77e5 Linkerd \u5bf9\u670d\u52a1\u7684\u4e0d\u540c\u7c7b\u578b\u7684\u8bf7\u6c42\uff0c\u6309\u5176\u8def\u7531\u8fdb\u884c\u5206\u7c7b\u3002\u8def\u7531\u53ea\u662f\u4e00\u4e2a\u7aef\u70b9\uff08\u5bf9\u4e8e gRPC\uff09\u6216\u4e00\u4e2a HTTP verb \u548c\u7aef\u70b9\uff08\u5bf9\u4e8e HTTP\uff09\u3002</p> <p>\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u5141\u8bb8 Linkerd \u4e3a\u670d\u52a1\u63d0\u4f9b\u6bcf\u4e2a\u8def\u7531\uff08pre-route\uff09\u800c\u4e0d\u662f\u6bcf\u4e2a\u670d\u52a1\u6307\u6807\uff0c\u5728\u540e\u9762\u7684\u7ae0\u8282\u4e2d\uff0c\u6211\u4eec\u8fd8\u5c06\u770b\u5230\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u5141\u8bb8 Linkerd \u5bf9\u670d\u52a1\u6267\u884c\u91cd\u8bd5\u548c\u8d85\u65f6\u7b49\u914d\u7f6e\uff0c\u4f46\u662f\u73b0\u5728\u6211\u4eec\u5148\u53ea\u5173\u6ce8\u6307\u6807\u3002</p> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u5e76\u4e0d\u662f\u7b80\u5355\u7684\u670d\u52a1\u4e0e Linkerd \u4e00\u8d77\u8fd0\u884c\u6240\u5fc5\u9700\u7684\uff0c\u5b83\u4eec\u662f\u53ef\u9009\u7684\u914d\u7f6e\u4f4d\uff0c\u53ef\u4ee5\u5b9e\u73b0 Linkerd \u7684\u66f4\u9ad8\u7ea7\u884c\u4e3a\uff0c\u5b83\u4eec\u4e5f\u662f Linkerd \u4f7f\u7528 Kubernetes CRD \u7684\u5c11\u6570\u793a\u4f8b\u4e4b\u4e00\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u4ecd\u7136\u901a\u8fc7 Emojivoto \u5e94\u7528\u8bf4\u660e\u4e0b\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u7684\u4f7f\u7528\u3002</p>"},{"location":"chap11/3linkered_ServiceProfile/#_1","title":"\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6","text":"<p>Linkerd \u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u662f\u901a\u8fc7\u5b9e\u4f8b\u5316\u4e00\u4e2a\u540d\u4e3a ServiceProfile \u7684 Kubernetes CRD \u6765\u5b9e\u73b0\u7684\u3002</p> <p>ServiceProfile \u4f1a\u679a\u4e3e Linkerd \u4e3a\u8be5\u670d\u52a1\u671f\u671b\u7684\u8def\u7531\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u521b\u5efa ServiceProfile\uff0c\u4f46\u4e5f\u53ef\u4ee5\u81ea\u52a8\u751f\u6210\u5b83\u4eec\u3002</p> <p>Linkerd CLI \u6709\u4e00\u4e2a profile \u547d\u4ee4\uff0c\u53ef\u4ee5\u901a\u8fc7\u51e0\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u6765\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u3002\u6700\u5e38\u89c1\u7684\u65b9\u6cd5\u4e4b\u4e00\u662f\u4ece\u670d\u52a1\u7684\u73b0\u6709\u8d44\u6e90\uff08\u5982 OpenAPI/Swagger \u89c4\u8303\u6216 protobuf \u6587\u4ef6\uff09\u751f\u6210\u5b83\u4eec\u3002</p> <pre><code>$ linkerd profile -h\nOutput service profile config for Kubernetes.\n\nUsage:\n  linkerd profile [flags] (--template | --open-api file | --proto file) (SERVICE)\n\nExamples:\n  # Output a basic template to apply after modification.\n  linkerd profile -n emojivoto --template web-svc\n\n  # Generate a profile from an OpenAPI specification.\n  linkerd profile -n emojivoto --open-api web-svc.swagger web-svc\n\n  # Generate a profile from a protobuf definition.\n  linkerd profile -n emojivoto --proto Voting.proto vote-svc\n\n\nFlags:\n  -h, --help               help for profile\n      --ignore-cluster     Output a service profile through offline generation\n  -n, --namespace string   Namespace of the service\n      --open-api string    Output a service profile based on the given OpenAPI spec file\n      --proto string       Output a service profile based on the given Protobuf spec file\n      --template           Output a service profile template\n\nGlobal Flags:\n      --api-addr string            Override kubeconfig and communicate directly with the control plane at host:port (mostly for testing)\n      --as string                  Username to impersonate for Kubernetes operations\n      --as-group stringArray       Group to impersonate for Kubernetes operations\n      --cni-namespace string       Namespace in which the Linkerd CNI plugin is installed (default \"linkerd-cni\")\n      --context string             Name of the kubeconfig context to use\n      --kubeconfig string          Path to the kubeconfig file to use for CLI requests\n  -L, --linkerd-namespace string   Namespace in which Linkerd is installed ($LINKERD_NAMESPACE) (default \"linkerd\")\n      --verbose                    Turn on debug logging\n</code></pre> <p>\u4e0a\u9762\u7684\u5e2e\u52a9\u547d\u4ee4\u8f93\u51fa\u5217\u51fa\u4e86\u53ef\u7528\u4e8e\u4e3a <code>ServiceProfile</code> \u8d44\u6e90\u751f\u6210 <code>YAML</code> \u7684\u6807\u5fd7\uff0c\u53ef\u4ee5\u770b\u5230</p> <p>\u5176\u4e2d\u5c31\u6709\u4e00\u4e2a <code>--open-api</code> \u6807\u5fd7\uff0c\u7528\u4e8e\u6307\u793a ServiceProfile \u8d44\u6e90\u5c06\u4ece\u6307\u5b9a\u7684 OpenAPI \u6216 Swagger \u6587\u6863\u6765\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c\u901a\u8fc7 <code>--proto</code> \u6807\u5fd7\u53ef\u4ee5\u6307\u793a\u4ece\u6307\u5b9a\u7684<code>Protobuf</code> \u6587\u4ef6\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u3002</p> <p>Emojivoto \u7684 web \u670d\u52a1\u6709\u4e00\u4e2a\u7b80\u5355\u7684 Swagger \u89c4\u8303\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># web.swagger\nopenapi: 3.0.1\nversion: v10\npaths:\n  /api/list:\n    get: {}\n  /api/vote:\n    get: {}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528\u4e0a\u9762\u7684\u89c4\u8303\u6587\u4ef6\u6765\u751f\u6210\u4e00\u4e2a ServiceProfile \u5bf9\u8c61\uff0c\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ linkerd profile -n emojivoto --open-api web.swagger web-svc &gt; web-sp.yaml\n</code></pre> <p>\u4e0a\u8ff0\u547d\u4ee4\u5c06\u8f93\u51fa\u670d\u52a1 <code>web-svc</code> \u7684 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u3002\u8bf7\u6ce8\u610f\uff0c\u5c31\u50cf linkerd install \u547d\u4ee4\u4e00\u6837\uff0c<code>linkerd profile</code> \u547d\u4ee4\u4e5f\u53ea\u751f\u6210 YAML\uff0c\u5b83\u4e0d\u4f1a\u5c06 YAML \u5e94\u7528\u5230\u96c6\u7fa4\uff0c\u6240\u4ee5\u6211\u4eec\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230 <code>web-sp.yaml</code> \u6587\u4ef6\uff0c\u5bf9\u5e94\u751f\u6210\u7684\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: linkerd.io/v1alpha2\nkind: ServiceProfile\nmetadata:\n  creationTimestamp: null\n  name: web-svc.emojivoto.svc.cluster.local\n  namespace: emojivoto\nspec:\n  routes:\n    - condition:\n        method: GET\n        pathRegex: /api/list\n      name: GET /api/list\n    - condition:\n        method: GET\n        pathRegex: /api/vote\n      name: GET /api/vote\n</code></pre> <p>\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684 <code>ServiceProfile</code> \u5bf9\u8c61\u7684\u58f0\u660e\u65b9\u5f0f\uff0c<code>spec.routes</code>\u7528\u6765\u58f0\u660e\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff0c\u6bcf\u6761\u8def\u7531\u4e2d\u5305\u542b\u4e00\u4e2a <code>name</code> \u548c <code>condition</code> \u5c5e\u6027\uff1a</p> <ul> <li>name \u7528\u6765\u8868\u793a\u8def\u7531\u7684\u540d\u79f0\uff0c\u7528\u4e8e\u663e\u793a\u4f7f\u7528\u3002</li> <li>condition \u7528\u6765\u63cf\u8ff0\u8def\u7531\u7684\u89c4\u8303\u3002\u4e0a\u4f8b\u4e2d\u751f\u6210\u7684 condition \u6709\u4e24\u4e2a\u5b57\u6bb5\uff1a<ul> <li>method\uff1a\u4e0e\u8bf7\u6c42\u5339\u914d\u7684 HTTP \u65b9\u6cd5\u3002</li> <li>pathRegex\uff1a\u7528\u4e8e\u5339\u914d\u8def\u5f84\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u3002\u5728\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\uff0c\u8fd9\u4e9b\u662f\u5b8c\u5168\u5339\u914d\u7684\u89c4\u5219\uff0c\u4f46\u901a\u5e38\u8fd9\u4e9b\u662f\u6b63\u5219\u8868\u8fbe\u5f0f\u3002</li> </ul> </li> </ul> <p>\u9664\u4e86\u901a\u8fc7 OpenAPI \u53ef\u4ee5\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e4b\u5916\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 Protobuf \u6765\u751f\u6210\uff0cgRPC \u534f\u8bae\u4f7f\u7528 protobuf \u5bf9\u8bf7\u6c42\u548c\u54cd\u5e94\u8fdb\u884c\u7f16\u7801\u548c\u89e3\u7801\uff0c\u8fd9\u610f\u5473\u7740\u6bcf\u4e2a gRPC \u670d\u52a1\u4e5f\u6709\u4e00\u4e2a protobuf \u5b9a\u4e49\u3002</p> <p>Emojivoto \u5e94\u7528\u7684 Voting \u5fae\u670d\u52a1\u5c31\u5305\u542b\u6709 protobuf \u5b9a\u4e49\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>syntax = \"proto3\";\noption go_package = \"github.com/buoyantio/emojivoto/proto\";\n\npackage emojivoto.v1;\n\nmessage VotingResult {\n    string Shortcode = 1;\n    int32 Votes = 2;\n}\n\nmessage VoteRequest {\n}\n\nmessage VoteResponse {\n}\n\nmessage ResultsRequest {\n}\n\nmessage ResultsResponse {\n    repeated VotingResult results = 1;\n}\n\nservice VotingService {\n    rpc VotePoop (VoteRequest) returns (VoteResponse);\n    rpc VoteJoy (VoteRequest) returns (VoteResponse);\n    rpc VoteSunglasses (VoteRequest) returns (VoteResponse);\n    ......\u7701\u7565\u90e8\u5206\u5185\u5bb9\n}\n</code></pre> <p>\u540c\u6837\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd profile \u547d\u4ee4\u6765\u751f\u6210\u5bf9\u5e94\u7684 ServiceProfile \u5bf9\u8c61\uff1a</p> <pre><code>$ linkerd profile -n emojivoto --proto Voting.proto voting-svc &gt; voting-sp.yaml\n</code></pre> <p>\u6b64\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u5c06\u6bd4\u4e0a\u4e00\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u591a\u5f88\u591a\uff0c\u56e0\u4e3a <code>Voting.proto</code> \u6587\u4ef6\u5b9a\u4e49\u4e86\u66f4\u591a\u8def\u7531\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b <code>voting-sp.yaml</code>\u6587\u4ef6\uff0c\u5e76\u5c06\u5176\u4e0e\u4e0a\u9762\u521b\u5efa\u7684 <code>ServiceProfile</code> \u8d44\u6e90\u8fdb\u884c\u6bd4\u8f83\u3002</p> <p>\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u7528\u53e6\u5916\u4e00\u79cd\u65b9\u6cd5\u6765\u52a8\u6001\u751f\u6210 ServiceProfile\uff0cLinkerd \u53ef\u4ee5\u76d1\u63a7\u5728\u6307\u5b9a\u65f6\u95f4\u6bb5\u5185\u8fdb\u5165\u7684\u5b9e\u65f6\u8bf7\u6c42\uff0c\u5e76\u4ece\u4e2d\u6536\u96c6\u8def\u7531\u6570\u636e\u3002</p> <p>\u5bf9\u4e8e\u4e0d\u4e86\u89e3\u670d\u52a1\u63d0\u4f9b\u7684\u5185\u90e8\u8def\u7531\u7684\u96c6\u7fa4\u7ba1\u7406\u5458\u6765\u8bf4\uff0c\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u529f\u80fd\uff0c\u56e0\u4e3a Linkerd \u4f1a\u8d1f\u8d23\u5904\u7406\u8bf7\u6c42\u5e76\u5c06\u5b83\u4eec\u5199\u5165\u6587\u4ef6\uff0c\u8be5\u7279\u6027\u7684\u5e95\u5c42\u539f\u7406\u662f\u4e0a\u4e00\u8282\u4e2d\u63d0\u5230\u7684\u5b9e\u65f6\u89c2\u5bdf\u8bf7\u6c42\u7684 Tap \u529f\u80fd\u3002</p> <p>\u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u4f7f\u7528 linkerd profile \u547d\u4ee4\u76d1\u63a7 emoji \u670d\u52a1 10 \u79d2\u5e76\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\uff0c\u4e0e\u524d\u9762\u5b66\u4e60\u7684\u6240\u6709\u547d\u4ee4\u4e00\u6837\uff0c\u8f93\u51fa\u4f1a\u6253\u5370\u5230\u7ec8\u7aef\uff0c\u5e76\u4e14\u6b64\u547d\u4ee4\u4f1a\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8fd0\u884c\u8be5\u547d\u4ee4\uff08\u5e76\u7b49\u5f85 10 \u79d2\uff09\u4e00\u6b21\u3002</p> <p>Linkerd Viz \u6269\u5c55\u4e5f\u6709\u81ea\u5df1\u7684\u914d\u7f6e\u6587\u4ef6\u5b50\u547d\u4ee4\uff0c\u53ef\u4ee5\u4e0e Tap \u529f\u80fd\u4e00\u8d77\u4f7f\u7528\uff0c\u4ece\u5b9e\u65f6\u6d41\u91cf\u4e2d\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff01\u5982\u4e0b\u547d\u4ee4\u6240\u793a\uff1a</p> <pre><code>$ linkerd viz profile emoji-svc --tap deploy/emoji --tap-duration 10s -n emojivoto &gt; emoji-sp.yaml\n</code></pre> <p>\u5f53\u8bf7\u6c42\u53d1\u9001\u5230 emoji \u670d\u52a1\u65f6\uff0c\u8fd9\u4e9b\u8def\u7531\u901a\u8fc7 Tap \u529f\u80fd\u6536\u96c6\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 Emoji.proto \u6587\u4ef6\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u540e\u53bb\u6bd4\u8f83\u4f7f\u7528 <code>--proto</code> \u548c <code>--tap</code> \u6807\u5fd7\u521b\u5efa\u7684 ServiceProfile \u8d44\u6e90\u7684\u5b9a\u4e49\u3002</p> <p>\u751f\u6210\u7684 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># emoji-sp.yaml\napiVersion: linkerd.io/v1alpha2\nkind: ServiceProfile\nmetadata:\n  creationTimestamp: null\n  name: emoji-svc.emojivoto.svc.cluster.local\n  namespace: emojivoto\nspec:\n  routes:\n    - condition:\n        method: POST\n        pathRegex: /emojivoto\\.v1\\.EmojiService/FindByShortcode\n      name: POST /emojivoto.v1.EmojiService/FindByShortcode\n    - condition:\n        method: POST\n        pathRegex: /emojivoto\\.v1\\.EmojiService/ListAll\n      name: POST /emojivoto.v1.EmojiService/ListAll\n</code></pre> <p>\u5982\u679c\u4f60\u9700\u8981\u624b\u52a8\u7f16\u5199\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0clinkerd profile \u547d\u4ee4\u6709\u4e00\u4e2a <code>--template</code> \u6807\u5fd7\uff0c\u53ef\u4ee5\u751f\u6210 ServiceProfile \u8d44\u6e90\u7684\u811a\u624b\u67b6\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528\u4f60\u7684\u670d\u52a1\u7684\u8be6\u7ec6\u4fe1\u606f\u5bf9\u5176\u8fdb\u884c\u66f4\u65b0\u3002</p> <pre><code>$ linkerd profile --template -n emojivoto emoji-svc\n### ServiceProfile for emoji-svc.emojivoto ###\napiVersion: linkerd.io/v1alpha2\nkind: ServiceProfile\nmetadata:\n  name: emoji-svc.emojivoto.svc.cluster.local\n  namespace: emojivoto\nspec:\n  # A service profile defines a list of routes.  Linkerd can aggregate metrics\n  # like request volume, latency, and success rate by route.\n  routes:\n  - name: '/authors/{id}'\n\n    # Each route must define a condition.  All requests that match the\n    # condition will be counted as belonging to that route.  If a request\n    # matches more than one route, the first match wins.\n    condition:\n      # The simplest condition is a path regular expression.\n      pathRegex: '/authors/\\d+'\n\n      # This is a condition that checks the request method.\n      method: POST\n\n      # If more than one condition field is set, all of them must be satisfied.\n      # This is equivalent to using the 'all' condition:\n      # all:\n      # - pathRegex: '/authors/\\d+'\n      # - method: POST\n\n      # Conditions can be combined using 'all', 'any', and 'not'.\n      # any:\n      # - all:\n      #   - method: POST\n      #   - pathRegex: '/authors/\\d+'\n      # - all:\n      #   - not:\n      #       method: DELETE\n      #   - pathRegex: /info.txt\n\n    # A route may be marked as retryable.  This indicates that requests to this\n    # route are always safe to retry and will cause the proxy to retry failed\n    # requests on this route whenever possible.\n    # isRetryable: true\n\n    # A route may optionally define a list of response classes which describe\n    # how responses from this route will be classified.\n    responseClasses:\n\n    # Each response class must define a condition.  All responses from this\n    # route that match the condition will be classified as this response class.\n    - condition:\n        # The simplest condition is a HTTP status code range.\n        status:\n          min: 500\n          max: 599\n\n        # Specifying only one of min or max matches just that one status code.\n        # status:\n        #   min: 404 # This matches 404s only.\n\n        # Conditions can be combined using 'all', 'any', and 'not'.\n        # all:\n        # - status:\n        #     min: 500\n        #     max: 599\n        # - not:\n        #     status:\n        #       min: 503\n\n      # The response class defines whether responses should be counted as\n      # successes or failures.\n      isFailure: true\n\n    # A route can define a request timeout.  Any requests to this route that\n    # exceed the timeout will be canceled.  If unspecified, the default timeout\n    # is '10s' (ten seconds).\n    # timeout: 250ms\n\n  # A service profile can also define a retry budget.  This specifies the\n  # maximum total number of retries that should be sent to this service as a\n  # ratio of the original request volume.\n  # retryBudget:\n  #   The retryRatio is the maximum ratio of retries requests to original\n  #   requests.  A retryRatio of 0.2 means that retries may add at most an\n  #   additional 20% to the request load.\n  #   retryRatio: 0.2\n\n  #   This is an allowance of retries per second in addition to those allowed\n  #   by the retryRatio.  This allows retries to be performed, when the request\n  #   rate is very low.\n  #   minRetriesPerSecond: 10\n\n  #   This duration indicates for how long requests should be considered for the\n  #   purposes of calculating the retryRatio.  A higher value considers a larger\n  #   window and therefore allows burstier retries.\n  #   ttl: 10s\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u8f93\u51fa\u5305\u542b ServiceProfile \u8d44\u6e90\u7684\u5b57\u6bb5\u548c\u6bcf\u4e2a\u5b57\u6bb5\u7684\u8be6\u7ec6\u8bf4\u660e\uff0c\u5982\u679c\u4f60\u9700\u8981 ServiceProfile \u5b9a\u4e49\u7684\u5feb\u901f\u53c2\u8003\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>--template</code> \u6807\u5fd7\uff01</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86\u5982\u4f55\u751f\u6210 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u67e5\u770b\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\u6570\u636e\u3002</p>"},{"location":"chap11/3linkered_ServiceProfile/#linkerd-dashboard-per-route-metrics","title":"Linkerd Dashboard \u4e2d\u67e5\u770b Per-Route Metrics","text":"<p>\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u4f7f\u7528 <code>linkerd profile</code> \u547d\u4ee4\u6765\u751f\u6210 <code>ServiceProfile</code> \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u73b0\u5728\u8ba9\u6211\u4eec\u91cd\u65b0\u8fd0\u884c\u751f\u6210\u547d\u4ee4\uff0c\u5e76\u76f4\u63a5\u5c06\u751f\u6210\u7684 ServiceProfile \u5bf9\u8c61\u76f4\u63a5\u5e94\u7528\u5230\u96c6\u7fa4\u4e2d\uff1a</p> <pre><code>$ linkerd profile -n emojivoto --open-api web.swagger web-svc | kubectl apply -f -\nserviceprofile.linkerd.io/web-svc.emojivoto.svc.cluster.local created\n$ linkerd profile -n emojivoto --proto Voting.proto voting-svc | kubectl apply -f -\nserviceprofile.linkerd.io/voting-svc.emojivoto.svc.cluster.local created\n$ linkerd viz profile emoji-svc --tap deploy/emoji --tap-duration 10s -n emojivoto | kubectl apply -f -\nserviceprofile.linkerd.io/emoji-svc.emojivoto.svc.cluster.local created\n</code></pre> <p>\u5f53\u4e0a\u9762\u7684\u547d\u4ee4\u8fd0\u884c\u6210\u529f\u540e\uff0c\u8ba9\u6211\u4eec\u6253\u5f00 Linkerd \u4eea\u8868\u76d8\u6765\u67e5\u770b\u4e0b\u76f8\u5173\u6307\u6807\uff0c\u6211\u4eec\u5148\u5bfc\u822a\u5230 Web Deployment \u4e0b\u67e5\u770b\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\u3002</p> <p></p> <p>\u4ece\u4e0a\u56fe\u53ef\u4ee5\u770b\u51fa\u6765\u5728 <code>ROUTE METRICS</code> \u9009\u9879\u5361\u4e0b\u9762\u76f8\u6bd4\u9ed8\u8ba4\u7684 <code>[DEFAULT]</code> \u8def\u7531\u591a\u4e86\u4e24\u4e2a\u8def\u7531\uff0c\u8fd9\u4e24\u4e2a\u8def\u7531\u5c31\u662f\u6211\u4eec\u901a\u8fc7 <code>linkerd profile --open-api</code> \u547d\u4ee4\u4ece<code>web.swagger</code> \u6587\u4ef6\u4e2d\u751f\u6210\u7684\u4e24\u6761\u8def\u7531\uff0c\u6bcf\u884c\u5217\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e24\u6761\u8def\u7531\u7684\u6bcf\u6761\u6307\u6807\u6570\u636e\u3002</p> <p>\u5728\u90e8\u7f72 ServiceProfile \u5bf9\u8c61\u4e4b\u524d\uff0c\u6211\u4eec\u53ea\u80fd\u770b\u5230 web \u670d\u52a1\u7684\u805a\u5408\u6307\u6807\uff0c\u90e8\u7f72\u540e\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u770b\u5230 <code>/api/list</code> \u8fd9\u6761\u8def\u7531\u662f 100% \u6210\u529f\u7684\uff0c<code>/api/vote</code> \u8def\u7531\u6709\u4e00\u4e9b\u9519\u8bef\u3002 </p> <p>\u540c\u6837\u5728\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e4b\u524d\uff0c\u6211\u4eec\u53ea\u77e5\u9053 web \u670d\u52a1\u6b63\u5728\u8fd4\u56de\u9519\u8bef\uff0c\u73b0\u5728\u6211\u4eec\u9519\u8bef\u662f\u6765\u81ea\u4e0e <code>/api/vote</code> \u8def\u7531\uff0c\u53e6\u5916\u7684 <code>[DEFAULT]</code> \u9ed8\u8ba4\u8def\u7531\u8868\u793a\u5f53\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u8def\u7531\u5339\u914d\u8bf7\u6c42\u65f6 Linkerd \u4f7f\u7528\u7684\u8def\u7531\uff0c\u5176\u4f1a\u6355\u83b7\u5728 <code>ServiceProfile</code> \u4e4b\u524d\u89c2\u5bdf\u5230\u7684\u4efb\u4f55\u6d41\u91cf</p> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u770b\u770b\u53e6\u5916\u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c\u5176\u4e2d\u7684 Voting \u670d\u52a1\u6bd4\u8f83\u5177\u6709\u4ee3\u8868\u6027\uff0c\u56e0\u4e3a\u5b83\u5305\u542b\u5f88\u591a\u8def\u7531\u3002</p> <p>\u5728 <code>Linkerd Dashboard</code> \u9875\u9762\u4e0a\u5728 <code>emojivoto</code> \u547d\u540d\u7a7a\u95f4\u4e0a\u8fdb\u5165 <code>Voting Deployment</code>\uff0c\u5207\u6362\u5230 <code>ROUTE METRICS</code> \u9009\u9879\u5361\u3002</p> <p>\u6211\u4eec\u4f1a\u8be5\u670d\u52a1\u4e0b\u6709\u975e\u5e38\u591a\u7684\u8def\u7531\uff0c\u4e0a\u9762\u7684 web \u670d\u52a1\u6211\u4eec\u77e5\u9053 <code>/api/vote</code> \u8def\u7531\u7684\u8bf7\u6c42\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u6240\u6709 <code>voting</code> \u670d\u52a1\u4e2d\u7684\u6bcf\u6761\u8def\u7531\u4fe1\u606f\u90fd\u6709\u53ef\u80fd\u4f1a\u63d0\u4f9b\u76f8\u5173\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u7531\u4e8e\u8def\u7531\u975e\u5e38\u591a\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u6309\u7167 <code>Success Rate</code> \u8fd9\u4e00\u5217\u8fdb\u884c\u5347\u5e8f\u6392\u5e8f\uff0c\u6b63\u5e38\u5c31\u53ef\u4ee5\u770b\u5230 <code>VoteDoughnut</code> \u8def\u7531\u6210\u529f\u7387\u4e3a 0\u3002</p> <p></p>"},{"location":"chap11/3linkered_ServiceProfile/#linkerd-cli-per-route-metrics","title":"\u901a\u8fc7 Linkerd CLI \u67e5\u770b Per-Route Metrics","text":"<p>\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86\u5982\u4f55\u901a\u8fc7 Dashboard \u6765\u67e5\u770b <code>Emojivoto</code> \u5e94\u7528\u4e2d\u670d\u52a1\u7684\u6bcf\u4e2a\u8def\u7531\u6307\u6807\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u5c1d\u8bd5\u4f7f\u7528 <code>CLI</code>\u5de5\u5177\u67e5\u770b\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\u3002</p> <p><code>linkerd viz routes</code> \u547d\u4ee4\u4f7f\u7528\u4e0e\u4eea\u8868\u76d8\u4f7f\u7528\u7684\u76f8\u540c\u6307\u6807\uff0c\u8ba9\u6211\u4eec\u770b\u770b\u4f7f\u7528 Linkerd CLI \u6765\u67e5\u770b emoji \u670d\u52a1\u7684\u8def\u7531\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ linkerd viz routes deploy/emoji -n emojivoto\nROUTE                                               SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nPOST /emojivoto.v1.EmojiService/FindByShortcode   emoji-svc   100.00%   1.0rps           1ms           1ms           1ms\nPOST /emojivoto.v1.EmojiService/ListAll           emoji-svc   100.00%   1.0rps           1ms           1ms           1ms\n[DEFAULT]                                         emoji-svc         -        -             -             -             -\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u4e3a emoji \u670d\u52a1\u5b9a\u4e49\u7684\u4e24\u6761\u8def\u7531\u90fd\u662f\u6210\u529f\u7684\uff0c\u5e76\u4e14\u5728 1ms \u7684\u65f6\u95f4\u5185\u5904\u7406\u4e86\u8bf7\u6c42\uff0c\u53ef\u4ee5\u770b\u51fa\u8fd9\u4e9b\u8def\u7531\u662f\u5065\u5eb7\u7684\u3002\u8fd8\u8981\u6ce8\u610f\u6211\u4eec\u7684\u9ed8\u8ba4\u8def\u7531\uff0c\u6807\u8bb0\u4e3a [DEFAULT]\uff0c\u540c\u6837\u8fd9\u662f Linkerd \u5728\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u4e0e\u8bf7\u6c42\u5339\u914d\u7684\u8def\u7531\u65f6\u4f7f\u7528\u7684\u8def\u7531\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u7528\u540c\u6837\u7684\u65b9\u5f0f\u901a\u8fc7 <code>linkerd viz routes</code> \u547d\u4ee4\u6765\u67e5\u770b voting \u548c web \u670d\u52a1\u7684\u8def\u7531\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ linkerd viz routes deploy/web -n emojivoto\nROUTE           SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nGET /api/list   web-svc   100.00%   1.0rps           1ms           1ms           1ms\nGET /api/vote   web-svc    88.33%   1.0rps           2ms           7ms           9ms\n[DEFAULT]       web-svc         -        -             -             -             -\n\n$ linkerd viz routes deploy/voting -n emojivoto\nROUTE                             SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nResults                        voting-svc         -        -             -             -             -\nVote100                        voting-svc   100.00%   0.0rps           1ms           1ms           1ms\nVoteBacon                      voting-svc         -        -             -             -             -\nVoteBalloon                    voting-svc         -        -             -             -             -\n# ......\n</code></pre> <p>voting \u670d\u52a1\u7684\u8f93\u51fa\u5f88\u957f\uff0c\u56e0\u4e3a\u5b83\u6709\u5f88\u591a\u8def\u7531\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7 <code>grep</code> \u547d\u4ee4\u6765\u67e5\u627e <code>VoteDoughnut</code> \u8def\u7531\uff1a<code>linkerd viz routes deploy/voting -n emojivoto | grep VoteDoughnut</code>\uff08\u6216\u8005\u53ef\u4ee5\u4f7f\u7528 -o json \u6807\u5fd7\u4ee5\u53ca jq \u4e4b\u7c7b\u7684\u5de5\u5177\u6765\u89e3\u6790\u8f93\u51fa\uff09\u3002</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u529f\u80fd\uff0c\u76ee\u524d\u6211\u4eec\u6682\u65f6\u4e13\u6ce8\u4e8e\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u7684\u53ef\u89c2\u6d4b\u6027\u529f\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e4b\u524d\u4e86\u89e3\u7684\u6bcf\u4e2a\u8def\u7531\u7684\u9ec4\u91d1\u6307\u6807\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u8fdb\u4e00\u6b65\u6df1\u5165\u4e86\u89e3 ServiceProfile \u5e76\u63a2\u7d22 Linkerd \u7684\u91cd\u8bd5\u548c\u8d85\u65f6\u529f\u80fd\u3002</p>"},{"location":"chap11/3linkered_ServiceProfile/#_2","title":"\u91cd\u8bd5\u4e0e\u8d85\u65f6","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u6765\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 ServiceProfile \u914d\u7f6e\u8d85\u65f6\u3001\u91cd\u8bd5\u3002Linkerd \u53ef\u4ee5\u901a\u8fc7\u6d41\u91cf\u62c6\u5206\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u91cd\u8bd5\u548c\u8d85\u65f6\u7b49\u529f\u80fd\u6765\u786e\u4fdd\u53ef\u9760\u6027\uff0c\u8fd9\u4e9b\u4e2d\u7684\u6bcf\u4e00\u4e2a\u90fd\u5728\u63d0\u9ad8\u7cfb\u7edf\u7684\u6574\u4f53\u53ef\u9760\u6027\u65b9\u9762\u53d1\u6325\u7740\u91cd\u8981\u4f5c\u7528\u3002</p> <p>\u4f46\u662f\u8fd9\u4e9b\u7279\u6027\u7a76\u7adf\u80fd\u589e\u52a0\u4ec0\u4e48\u6837\u7684\u53ef\u9760\u6027\u5462\uff1f\u5f52\u6839\u7ed3\u5e95\u662f Linkerd \u53ef\u4ee5\u5e2e\u52a9\u9632\u6b62\u77ac\u65f6\u6545\u969c\u3002\u5982\u679c\u670d\u52a1\u5b8c\u5168\u5173\u95ed\uff0c\u6216\u59cb\u7ec8\u8fd4\u56de\u5931\u8d25\uff0c\u6216\u59cb\u7ec8\u6302\u8d77\uff0c\u90a3\u4e48\u518d\u591a\u7684\u91cd\u8bd5\u6216\u8d1f\u8f7d\u5747\u8861\u90fd\u65e0\u6d4e\u4e8e\u4e8b\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u670d\u52a1\u7684\u4e00\u4e2a\u5b9e\u4f8b\u51fa\u73b0\u95ee\u9898\uff0c\u6216\u8005\u6f5c\u5728\u95ee\u9898\u53ea\u662f\u6682\u65f6\u7684\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019 Linkerd \u5c31\u53ef\u4ee5\u6d3e\u4e0a\u7528\u573a\u4e86\uff0c\u800c\u4e14\u8fd9\u4e9b\u90e8\u5206\u7684\u3001\u6682\u65f6\u7684\u6545\u969c\u662f\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u6700\u5e38\u51fa\u73b0\u7684\u95ee\u9898\uff01</p> <p>\u5f53\u6d89\u53ca\u5230 Linkerd \u7684\u8d1f\u8f7d\u5747\u8861\u3001\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u6838\u5fc3\u53ef\u9760\u6027\u7279\u6027\u65f6\uff0c\u8fd9\u91cc\u6709\u4e24\u4ef6\u91cd\u8981\u7684\u4e8b\u60c5\u9700\u8981\u7406\u89e3\uff08\u6d41\u91cf\u5206\u5272\uff0c\u4e5f\u662f\u4e00\u4e2a\u53ef\u9760\u6027\u7279\u6027\uff0c\u4f46\u6709\u70b9\u4e0d\u592a\u4e00\u6837\uff0c\u6211\u4eec\u5c06\u5728\u540e\u9762\u7684\u7ae0\u8282\u4e2d\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff09\uff1a</p> <ul> <li>\u6240\u6709\u8fd9\u4e9b\u6280\u672f\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\uff1a\u8fdb\u884c\u8c03\u7528\u7684\u4ee3\u7406\u662f\u6267\u884c\u8fd9\u4e9b\u529f\u80fd\u7684\u4ee3\u7406\uff0c\u800c\u4e0d\u662f\u670d\u52a1\u5668\u7aef\u7684\u4ee3\u7406\u3002\u5982\u679c\u4f60\u7684\u670d\u52a1\u5668\u662f\u7f51\u683c\u7684\uff0c\u4f46\u4f60\u7684\u5ba2\u6237\u7aef\u4e0d\u662f\u7684\uff0c\u90a3\u4e48\u5c06\u4e0d\u4f1a\u5728\u4e24\u8005\u4e4b\u95f4\u7684\u8c03\u7528\u4e2d\u542f\u7528\u8fd9\u4e9b\u529f\u80fd\uff01</li> <li>\u8fd9\u4e09\u4e2a\u7279\u6027\u4e00\u8d77\u4f7f\u7528\u6548\u679c\u6700\u597d\u3002\u6ca1\u6709\u91cd\u8bd5\uff0c\u8d85\u65f6\u6ca1\u6709\u4ec0\u4e48\u4ef7\u503c\uff1b\u5982\u679c\u6ca1\u6709\u8d1f\u8f7d\u5747\u8861\uff0c\u91cd\u8bd5\u51e0\u4e4e\u4e5f\u6ca1\u6709\u4ec0\u4e48\u4ef7\u503c\u3002</li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u5148\u4e86\u89e3\u4e0b\u8d1f\u8f7d\u5747\u8861\uff0cLinkerd \u4f1a\u81ea\u52a8\u5728\u53ef\u80fd\u7684\u76ee\u7684\u5730\u4e4b\u95f4\u5bf9\u8bf7\u6c42\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u8bf7\u6ce8\u610f\u8bf7\u6c42\u8fd9\u4e2a\u8bcd - \u4e0e\u56db\u5c42\u6216 TCP \u8d1f\u8f7d\u5747\u8861\u4e0d\u540c\uff0c\u5b83\u4f1a\u5747\u8861\u8fde\u63a5\uff0cLinkerd \u5c06\u5efa\u7acb\u5230\u53ef\u80fd\u7684\u7aef\u70b9\u96c6\u7684\u8fde\u63a5\uff0c\u5e76\u5728\u6240\u6709\u8fd9\u4e9b\u8fde\u63a5\u4e4b\u95f4\u5747\u8861\u8bf7\u6c42\u3002\u8fd9\u5141\u8bb8\u5bf9\u6d41\u91cf\u8fdb\u884c\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u5e76\u4e14\u5728\u540e\u53f0\uff0cLinkerd \u7684\u65b9\u6cd5\u975e\u5e38\u590d\u6742\uff0c\u4f7f\u7528\u8bf8\u5982\u670d\u52a1\u5668\u5ef6\u8fdf\u7684\u6307\u6570\u52a0\u6743\u79fb\u52a8\u5e73\u5747\uff08EWMA\uff09 \u4e4b\u7c7b\u7684\u6280\u672f\u6765\u4f18\u5316\u8bf7\u6c42\u7684\u53bb\u5411\uff1b\u5c3d\u53ef\u80fd\u8de8\u7aef\u70b9\u6c47\u96c6\u8fde\u63a5\uff1b\u5e76\u81ea\u52a8\u5c06 HTTP/1.1 \u6d41\u91cf\u5347\u7ea7\u5230\u4ee3\u7406\u4e4b\u95f4\u7684 HTTP/2 \u8fde\u63a5\u3002\u7136\u800c\uff0c\u4ece\u6211\u4eec\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5e76\u6ca1\u6709\u8fdb\u884c\u4efb\u4f55\u914d\u7f6e\uff0c\u53ea\u9700\u8981\u77e5\u9053\uff1aLinkerd \u4f1a\u81ea\u52a8\u5728\u5176\u7aef\u70b9\u4e4b\u95f4\u5e73\u8861\u8bf7\u6c42\u3002</p> <p>\u63a5\u7740\u770b\u770b\u8d85\u65f6\uff0c\u8d85\u65f6\u662f\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u6700\u957f\u65f6\u95f4\u7684\u4e00\u79cd\u65b9\u5f0f\u3002\u6bd4\u5982\u4f60\u7684\u670d\u52a1\u4e0a\u6709\u4e00\u4e2a\u540d\u4e3a <code>getValue()</code> \u7684\u8def\u7531\uff0c\u800c <code>getValue()</code> \u7684\u6027\u80fd\u662f\u4e0d\u53ef\u9884\u6d4b\u7684\uff1a\u5927\u591a\u6570\u65f6\u5019 <code>getValue()</code> \u4f1a\u5728 10 \u6beb\u79d2\u5185\u8fd4\u56de\uff0c\u4f46\u6709\u65f6\u9700\u8981 10 \u5206\u949f\u624d\u80fd\u8fd4\u56de\uff0c\u4e5f\u8bb8\u662f\u5728\u67d0\u4e9b\u6709\u4e89\u8bae\u7684\u8d44\u6e90\u4e0a\u5b58\u5728\u9501\u7ade\u4e89\u3002\u5982\u679c\u6ca1\u6709\u8d85\u65f6\uff0c\u8c03\u7528 <code>getValue()</code>\u5c06\u9700\u8981 10 \u6beb\u79d2\u5230 10 \u5206\u949f\u4e4b\u95f4\u7684\u4efb\u4f55\u65f6\u95f4\uff0c\u4f46\u662f\u5982\u679c\u8bbe\u7f6e\u4e86 500 \u6beb\u79d2\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u90a3\u4e48 <code>getValue()</code> \u5219\u6700\u591a\u9700\u8981 500 \u6beb\u79d2\u3002</p> <p>\u6dfb\u52a0\u8d85\u65f6\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u79cd\u673a\u5236\u6765\u9650\u5236\u7cfb\u7edf\u7684\u6700\u574f\u60c5\u51b5\u5ef6\u8fdf\uff0c\u5b83\u5141\u8bb8 <code>getValue()</code> \u7684\u8c03\u7528\u8005\u5177\u6709\u66f4\u53ef\u9884\u6d4b\u7684\u6027\u80fd\uff0c\u5e76\u4e14\u4e0d\u4f1a\u5360\u7528\u7b49\u5f85 10 \u5206\u949f\u957f\u7684\u8c03\u7528\u8fd4\u56de\u7684\u8d44\u6e90\u3002\u5176\u6b21\uff0c\u66f4\u91cd\u8981\u7684\u662f\uff0c\u8d85\u65f6\u53ef\u4ee5\u4e0e\u91cd\u8bd5\u548c\u8d1f\u8f7d\u5747\u8861\u76f8\u7ed3\u5408\uff0c\u4ee5\u81ea\u52a8\u5c06\u8bf7\u6c42\u91cd\u65b0\u53d1\u9001\u5230\u670d\u52a1\u7684\u4e0d\u540c\u5b9e\u4f8b\u3002</p> <p>\u5982\u679c <code>getValue()</code> \u5728\u5b9e\u4f8b A \u4e0a\u5f88\u6162\uff0c\u5728\u5b9e\u4f8b B \u6216 C \u4e0a\u53ef\u80fd\u4f1a\u5f88\u5feb\uff0c\u751a\u81f3\u591a\u6b21\u91cd\u8bd5\u4e5f\u5c06\u8fdc\u8fdc\u5c11\u4e8e\u7b49\u5f85 10 \u5206\u949f\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u518d\u6765\u770b\u770b\u91cd\u8bd5\uff0c\u91cd\u8bd5\u662f\u6307 Linkerd \u81ea\u52a8\u91cd\u8bd5\u8bf7\u6c42\u3002\u8fd9\u4f1a\u5728\u4ec0\u4e48\u573a\u666f\u4e0b\u6709\u7528\u5462\uff1f\u540c\u6837\u7531\u4e8e\u67d0\u4e9b\u4e34\u65f6\u9519\u8bef\uff1a\u5982\u679c\u7279\u5b9a\u5b9e\u4f8b\u4e0a\u7684\u7279\u5b9a\u8def\u7531\u8fd4\u56de\u9519\u8bef\uff0c\u5e76\u4e14\u7b80\u5355\u5730\u91cd\u8bd5\u8be5\u8bf7\u6c42\u53ef\u80fd\u4f1a\u5bfc\u81f4\u54cd\u5e94\u6210\u529f\uff0c\u5f53\u7136\u91cd\u8981\u7684\u662f\u8981\u610f\u8bc6\u5230\u7b80\u5355\u5730\u91cd\u8bd5\u8bf7\u6c42\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u6210\u529f\u54cd\u5e94\u3002\u5982\u679c\u5e95\u5c42\u9519\u8bef\u4e0d\u662f\u6682\u65f6\u7684\uff0c\u6216\u8005\u5982\u679c Linkerd \u65e0\u6cd5\u91cd\u8bd5\uff0c\u90a3\u4e48\u5e94\u7528\u7a0b\u5e8f\u4ecd\u7136\u9700\u8981\u5904\u7406\u8fd9\u4e9b\u9519\u8bef\u3002</p> <p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u5b9e\u73b0\u91cd\u8bd5\u53ef\u80fd\u4f1a\u5f88\u9ebb\u70e6\u3002\u5982\u679c\u60f3\u5f53\u7136\u7684\u505a\u4e5f\u662f\u4f1a\u6709\u4e00\u5b9a\u98ce\u9669\u7684\uff0c\u53ef\u80fd\u4f1a\u7ed9\u7cfb\u7edf\u589e\u52a0\u989d\u5916\u7684\u8d1f\u8f7d\uff0c\u8fd9\u4e2a\u8d1f\u8f7d\u53ef\u80fd\u4f1a\u8ba9\u4e8b\u60c5\u53d8\u5f97\u66f4\u7cdf\u7cd5\u3002</p> <p>\u4e00\u79cd\u5e38\u89c1\u7684\u6545\u969c\u573a\u666f\u5c31\u662f\u91cd\u8bd5\u98ce\u66b4\uff1a</p> <ul> <li>\u670d\u52a1 A \u4e2d\u7684\u77ac\u65f6\u6545\u969c\u89e6\u53d1 B \u5bf9\u5b83\u8bf7\u6c42\u7684\u91cd\u8bd5\uff1b</li> <li>\u8fd9\u4e9b\u91cd\u8bd5\u5bfc\u81f4 A \u8fc7\u8f7d\uff0c\u8fd9\u610f\u5473\u7740 B \u5f00\u59cb\u5931\u8d25\u7684\u8bf7\u6c42\uff1b</li> <li>\u8fd9\u4f1a\u89e6\u53d1\u5176\u8c03\u7528\u8005 C \u5bf9 B \u7684\u91cd\u8bd5\uff0c\u7136\u540e\u5bfc\u81f4 B \u8fc7\u8f7d\uff0c\u4f9d\u6b64\u7c7b\u63a8\u3002\u5bf9\u4e8e\u5141\u8bb8\u4f60\u914d\u7f6e\u6bcf\u4e2a\u8bf7\u6c42\u7684\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u7684\u7cfb\u7edf\u5c24\u5176\u5982\u6b64\uff1a</li> <li>\u6bcf\u4e2a\u8bf7\u6c42\u6700\u591a\u91cd\u8bd5 3 \u6b21\u542c\u8d77\u6765\u53ef\u80fd\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46\u5728\u6700\u574f\u7684\u60c5\u51b5\u4e0b\u4f1a\u589e\u52a0 300% \u7684\u8d1f\u8f7d\u3002</li> </ul> <p>Linkerd \u901a\u8fc7\u4f7f\u7528\u91cd\u8bd5\u9884\u7b97\u800c\u4e0d\u662f\u6bcf\u4e2a\u8bf7\u6c42\u7684\u9650\u5236\u6765\u8bbe\u7f6e\u91cd\u8bd5\u7684\u53c2\u6570\uff0c\u5c06\u91cd\u8bd5\u98ce\u66b4\u7684\u53ef\u80fd\u6027\u964d\u5230\u6700\u4f4e\u3002</p> <p>\u91cd\u8bd5\u9884\u7b97\u662f\u53ef\u4ee5\u91cd\u8bd5\u7684\u8bf7\u6c42\u603b\u6570\u7684\u767e\u5206\u6bd4\uff0cLinkerd \u7684\u9ed8\u8ba4\u884c\u4e3a\u662f\u5141\u8bb8\u5bf9\u5931\u8d25\u7684\u8bf7\u6c42\u8fdb\u884c 20% (200) \u6b21\u91cd\u8bd5\uff0c\u518d\u52a0\u4e0a\u6bcf\u79d2\u989d\u5916\u7684 10 \u4e2a\u8bf7\u6c42\u3002\u4f8b\u5982\uff0c\u5982\u679c\u539f\u59cb\u8bf7\u6c42\u8d1f\u8f7d\u662f\u6bcf\u79d2 1000 \u4e2a\u8bf7\u6c42\uff0c\u90a3\u4e48 Linkerd \u5c06\u5141\u8bb8\u6bcf\u79d2\u91cd\u8bd5 210 \u4e2a\u8bf7\u6c42\u3002\u5f53\u9884\u7b97\u7528\u5c3d\u65f6\uff0cLinkerd \u4e0d\u4f1a\u91cd\u8bd5\u8bf7\u6c42\uff0c\u800c\u662f\u4f1a\u5411\u5ba2\u6237\u7aef\u8fd4\u56de 504 \u9519\u8bef\u3002</p> <p>\u7efc\u4e0a\u6240\u8ff0\uff1a\u8d1f\u8f7d\u5747\u8861\u3001\u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u662f\u4e3a\u4e86\u5728\u51fa\u73b0\u90e8\u5206\u3001\u6682\u65f6\u6027\u6545\u969c\u7684\u60c5\u51b5\u4e0b\u4fdd\u969c\u5e94\u7528\u7a0b\u5e8f\u7684\u53ef\u9760\u6027\uff0c\u5e76\u9632\u6b62\u8fd9\u4e9b\u6545\u969c\u5347\u7ea7\u4e3a\u5168\u5c40\u4e2d\u65ad\u3002\u4f46\u5b83\u4eec\u5e76\u4e0d\u662f\u7075\u4e39\u5999\u836f\uff0c\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5fc5\u987b\u4ecd\u7136\u80fd\u591f\u5904\u7406\u9519\u8bef\u3002</p>"},{"location":"chap11/3linkered_ServiceProfile/#per-route-metrics","title":"\u4f7f\u7528 Per-Route Metrics \u6765\u786e\u5b9a\u4f55\u65f6\u91cd\u8bd5\u548c\u8d85\u65f6","text":"<p>\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u5728 Linkerd \u4e2d\u4f7f\u7528\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u539f\u56e0\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u5728\u524d\u9762\u4e86\u89e3\u7684\u53ef\u89c2\u6d4b\u6027\u529f\u80fd\u7684\u57fa\u7840\u4e0a\uff0c\u4f7f\u7528\u6307\u6807\u6765\u505a\u6709\u5173\u5e94\u7528\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u51b3\u7b56\u3002</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u5c06\u67e5\u770b emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u6240\u6709 Deployments \u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u7136\u540e\u6211\u4eec\u518d\u6df1\u5165\u7814\u7a76\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u3002</p> <p>\u76f4\u63a5\u4f7f\u7528 <code>linkerd viz stat</code> \u547d\u4ee4\u5373\u53ef\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ linkerd viz stat deploy -n emojivoto\nNAME       MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN\nemoji         1/1   100.00%   2.3rps           1ms           1ms           4ms          3\nvote-bot      1/1   100.00%   0.3rps           1ms           2ms           2ms          1\nvoting        1/1    87.01%   1.3rps           1ms           7ms           9ms          3\nweb           1/1    91.91%   2.3rps           1ms          10ms          28ms          3\n</code></pre> <p><code>stat</code>\u547d\u4ee4\u5411\u6211\u4eec\u5c55\u793a\u4e86\u9ec4\u91d1\u6307\u6807\uff0c\u5305\u62ec\u6210\u529f\u7387\u548c\u5ef6\u8fdf\uff0c\u6211\u4eec\u53ef\u4ee5\u6ce8\u610f\u5230 voting \u548c web \u670d\u52a1\u7684\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>linkerd viz edges</code> \u547d\u4ee4\u6765\u4e86\u89e3\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb\u3002</p> <pre><code>$ linkerd viz edges deploy -n emojivoto\nSRC          DST        SRC_NS        DST_NS      SECURED\nvote-bot     web        emojivoto     emojivoto   \u221a\nweb          emoji      emojivoto     emojivoto   \u221a\nweb          voting     emojivoto     emojivoto   \u221a\nprometheus   emoji      linkerd-viz   emojivoto   \u221a\nprometheus   vote-bot   linkerd-viz   emojivoto   \u221a\nprometheus   voting     linkerd-viz   emojivoto   \u221a\nprometheus   web        linkerd-viz   emojivoto   \u221a\n</code></pre> <p>\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>Linkerd Dashboard</code> \u6765\u67e5\u770b\u7ae0\u9c7c\u56fe\u53bb\u4e86\u89e3\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb\u3002</p> <p></p> <p>\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa web \u670d\u52a1\u4e2d\u7684 Pods \u5bf9 voting \u670d\u52a1\u7684 Pods \u8fdb\u884c\u4e86\u8c03\u7528\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u731c\u6d4b\u662f voting \u670d\u52a1\u5bfc\u81f4\u4e86 web \u670d\u52a1\u7684\u9519\u8bef\uff0c\u5f53\u7136\u8fd9\u8fd8\u6ca1\u7ed3\u675f\uff0c\u8fd8\u8bb0\u5f97\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u7684 ServiceProfile \u6587\u4ef6\u5417\uff1f</p> <p>\u6211\u4eec\u6709\u6bcf\u6761\u8def\u7531\u7684\u6307\u6807\uff0c\u5e94\u8be5\u80fd\u591f\u51c6\u786e\u5730\u770b\u5230\u54ea\u4e9b\u8def\u7531\u7684\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>linkerd viz routes</code> \u547d\u4ee4\u53bb\u4e86\u89e3 <code>voting</code> \u670d\u52a1\u7684\u8def\u7531\u6307\u6807\u60c5\u51b5\uff0c\u5982\u4e0b\u547d\u4ee4\u6240\u793a\uff1a</p> <pre><code>$ linkerd viz routes deploy/voting -n emojivoto\n# ......\nVoteDog                        voting-svc         -        -             -             -             -\nVoteDoughnut                   voting-svc     0.00%   0.1rps           1ms           1ms           1ms\nVoteFax                        voting-svc         -        -             -             -             -\nVoteFire                       voting-svc   100.00%   0.0rps           1ms           1ms           1ms\nVoteFlightDeparture            voting-svc         -        -             -             -             -\n# ......\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>Linkerd Dashboard</code> \u53bb\u67e5\u770b <code>voting</code> \u670d\u52a1\u7684 <code>ROUTE METRICS</code> \u4fe1\u606f\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u6700\u7ec8\u6211\u4eec\u53ef\u4ee5\u5b9a\u4f4d\u5230\u662f VoteDoughnut \u8fd9\u6761\u662f\u8bf7\u6c42\u5931\u8d25\u7684\u8def\u7531\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u4e0d\u4ec5\u77e5\u9053 web \u670d\u52a1\u548c voting \u670d\u52a1\u4e4b\u95f4\u53d1\u751f\u4e86\u9519\u8bef\uff0c\u800c\u4e14\u4e5f\u77e5\u9053\u4e86 VoteDoughnut \u8def\u7531\u53d1\u751f\u4e86\u9519\u8bef\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u91cd\u8bd5\u6765\u5c1d\u8bd5\u89e3\u51b3\u9519\u8bef\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u8981\u6c42\u5f00\u53d1\u4eba\u5458\u8fdb\u884c\u4ee3\u7801\u8c03\u8bd5\u3002</p>"},{"location":"chap11/3linkered_ServiceProfile/#_3","title":"\u914d\u7f6e\u91cd\u8bd5","text":"<p>\u5728\u6211\u4eec\u5f00\u59cb\u4e3a <code>VotingDoughnut</code>\u8def\u7531\u914d\u7f6e\u91cd\u8bd5\u4e4b\u524d\uff0c\u6211\u4eec\u5fc5\u987b\u9996\u5148\u4ed4\u7ec6\u67e5\u770b web \u548c voting \u670d\u52a1\u7684\u6307\u6807\uff0c\u56e0\u4e3a\u8fd9\u5c06\u5e2e\u52a9\u6211\u4eec\u771f\u6b63\u4e86\u89e3\u5e94\u7528\u91cd\u8bd5\u662f\u5426\u53ef\u4ee5\u89e3\u51b3\u95ee\u9898\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5c06\u53ea\u4f7f\u7528 <code>Linkerd CLI</code>\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u7528\u901a\u8fc7\u4f7f\u7528 <code>-o wide</code> \u6807\u5fd7\u5411\u6211\u4eec\u663e\u793a\u5b9e\u9645\u548c\u6709\u6548\u7684\u8bf7\u6c42\u91cf\u548c\u6210\u529f\u7387\uff0cLinkerd \u4eea\u8868\u76d8\u4f1a\u663e\u793a\u6574\u4f53\u6210\u529f\u7387\u548c RPS\uff0c\u4f46\u4e0d\u663e\u793a\u5b9e\u9645\u548c\u6709\u6548\u7684\u6307\u6807\u3002\u5b9e\u9645\u6307\u6807\u548c\u6709\u6548\u6307\u6807\u4e4b\u95f4\u7684\u533a\u522b\u662f\uff1a</p> <ul> <li>\u5b9e\u9645\u503c\u6765\u81ea\u63a5\u6536\u8bf7\u6c42\u7684\u670d\u52a1\u5668\u7684\u89d2\u5ea6</li> <li>\u6709\u6548\u503c\u662f\u4ece\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef\u7684\u89d2\u5ea6\u6765\u770b\u7684</li> </ul> <p>\u5728\u6ca1\u6709\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u60c5\u51b5\u4e0b\uff0c\u663e\u7136\u8fd9\u4e24\u4e2a\u6570\u636e\u662f\u76f8\u540c\u7684\u3002\u4f46\u662f\uff0c\u4e00\u65e6\u914d\u7f6e\u4e86\u91cd\u8bd5\u6216\u8d85\u65f6\uff0c\u5b83\u4eec\u5c31\u53ef\u80fd\u4f1a\u4e0d\u4e00\u6837\u4e86\u3002\u4f8b\u5982\uff0c\u91cd\u8bd5\u4f1a\u4f7f\u5b9e\u9645\u7684 RPS \u9ad8\u4e8e\u6709\u6548\u7684 RPS\uff0c\u56e0\u4e3a\u4ece\u670d\u52a1\u5668\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u91cd\u8bd5\u662f\u53e6\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f46\u4ece\u5ba2\u6237\u7aef\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5b83\u662f\u540c\u4e00\u4e2a\u8bf7\u6c42\u3002\u91cd\u8bd5\u53ef\u4ee5\u4f7f\u5b9e\u9645\u6210\u529f\u7387\u4f4e\u4e8e\u6709\u6548\u6210\u529f\u7387\uff0c\u56e0\u4e3a\u5931\u8d25\u7684\u91cd\u8bd5\u8c03\u7528\u4e5f\u53d1\u751f\u5728\u670d\u52a1\u5668\u4e0a\uff0c\u4f46\u4e0d\u4f1a\u66b4\u9732\u7ed9\u5ba2\u6237\u7aef\u3002\u800c\u8d85\u65f6\u53ef\u80fd\u4f1a\u4ea7\u751f\u76f8\u53cd\u7684\u6548\u679c\uff1a\u8fd9\u53d6\u51b3\u4e8e\u5177\u4f53\u7684\u8fd4\u56de\u65f6\u95f4\uff0c\u4e00\u4e2a\u6700\u7ec8\u6210\u529f\u8fd4\u56de\u7684\u8d85\u65f6\u8bf7\u6c42\u53ef\u80fd\u4f1a\u4f7f\u5b9e\u9645\u6210\u529f\u7387\u9ad8\u4e8e\u6709\u6548\u6210\u529f\u7387\uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u5c06\u5176\u89c6\u4e3a\u6210\u529f\uff0c\u800c\u5ba2\u6237\u7aef\u53ea\u770b\u5230\u5931\u8d25\u3002</p> <p>\u603b\u7684\u6765\u8bf4\u5c31\u662f Linkerd \u7684\u5b9e\u9645\u548c\u6709\u6548\u6307\u6807\u5728\u91cd\u8bd5\u6216\u8d85\u65f6\u7684\u60c5\u51b5\u4e0b\u53ef\u80fd\u4f1a\u6709\u6240\u4e0d\u540c\uff0c\u4f46\u5b9e\u9645\u6570\u5b57\u4ee3\u8868\u5b9e\u9645\u547d\u4e2d\u670d\u52a1\u5668\u7684\u60c5\u51b5\uff0c\u800c\u6709\u6548\u6570\u5b57\u4ee3\u8868\u4e86\u5728 Linkerd \u7684\u53ef\u9760\u6027\u903b\u8f91\u5b8c\u6210\u5176\u804c\u8d23\u540e\uff0c\u5ba2\u6237\u7aef\u6709\u6548\u5730\u5f97\u5230\u4e86\u5bf9\u5176\u8bf7\u6c42\u7684\u54cd\u5e94\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b vote-bot \u670d\u52a1\u7684\u8def\u7531\u6307\u6807\u60c5\u51b5</p> <pre><code>$ linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -owide\nROUTE           SERVICE   EFFECTIVE_SUCCESS   EFFECTIVE_RPS   ACTUAL_SUCCESS   ACTUAL_RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nGET /api/list   web-svc             100.00%          1.0rps          100.00%       1.0rps           1ms           2ms           2ms\nGET /api/vote   web-svc              86.21%          1.0rps           86.21%       1.0rps           2ms           7ms          10ms\n[DEFAULT]       web-svc                   -               -                -            -             -             -             -\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>-o wide</code> \u7684\u6807\u5fd7\uff0c\u8fd9\u6837\u8f93\u51fa\u7ed3\u679c\u4f1a\u5305\u542b\u5b9e\u9645\u548c\u6709\u6548\u7684\u6210\u529f\u548c RPS \u6307\u6807\u3002</p> <p>\u4ece vote-bot \u670d\u52a1\u6765\u770b\uff0cweb \u670d\u52a1\u7684 <code>/api/vote</code> \u8def\u7531\u7684\u6709\u6548\u6210\u529f\u7387\u548c\u5b9e\u9645\u6210\u529f\u7387\u90fd\u4f4e\u4e8e 100%\uff0c\u8fd9\u662f\u56e0\u4e3a\u73b0\u5728\u6211\u4eec\u8fd8\u6ca1\u6709\u914d\u7f6e\u91cd\u8bd5\u3002</p> <p>\u800c\u4e14\u6211\u4eec\u4e0d\u80fd\u5047\u8bbe\u6240\u6709\u8bf7\u6c42\u90fd\u662f\u53ef\u91cd\u8bd5\u7684\uff0c\u91cd\u8bd5\u8bf7\u6c42\u5bf9\u4e8e Linkerd \u6765\u8bf4\uff0c\u662f\u6709\u975e\u5e38\u5177\u4f53\u7684\u6761\u4ef6\u7684\uff1a</p> <ul> <li>\u73b0\u5728\uff0c\u4f7f\u7528 HTTP POST \u65b9\u6cd5\u7684\u8bf7\u6c42\u5728 Linkerd \u4e2d\u4e0d\u53ef\u91cd\u8bd5\u3002\u56e0\u4e3a POST \u8bf7\u6c42\u51e0\u4e4e\u603b\u662f\u5728\u8bf7\u6c42 body \u4e2d\u5305\u542b\u6570\u636e\uff0c\u91cd\u8bd5\u8bf7\u6c42\u610f\u5473\u7740\u4ee3\u7406\u5fc5\u987b\u5c06\u8be5\u6570\u636e\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u4fdd\u6301\u6700\u5c0f\u7684\u5185\u5b58\u4f7f\u7528\uff0c\u4ee3\u7406\u4e0d\u5b58\u50a8 POST \u8bf7\u6c42 body\uff0c\u5e76\u4e14\u5b83\u4eec\u4e0d\u80fd\u88ab\u91cd\u8bd5\u3002</li> <li>\u6b63\u5982\u6211\u4eec\u524d\u9762\u63d0\u5230\u8fc7\u7684\uff0cLinkerd \u4ec5\u5c06\u54cd\u5e94\u4e2d\u7684 5XX \u72b6\u6001\u7801\u89c6\u4e3a\u9519\u8bef\uff0c\u800c 2XX \u548c 4XX \u90fd\u88ab\u8bc6\u522b\u4e3a\u6210\u529f\u72b6\u6001\u7801\u30024XX \u72b6\u6001\u7801\u8868\u793a\u670d\u52a1\u5668\u67e5\u770b\u4f46\u627e\u4e0d\u5230\u8d44\u6e90\uff0c\u8fd9\u5c5e\u4e8e\u670d\u52a1\u5668\u7684\u6b63\u786e\u884c\u4e3a\uff0c\u800c 5XX \u72b6\u6001\u7801\u8868\u793a\u670d\u52a1\u5668\u5728\u5904\u7406\u8bf7\u6c42\u65f6\u9047\u5230\u4e86\u9519\u8bef\uff0c\u8fd9\u662f\u4e0d\u6b63\u786e\u7684\u884c\u4e3a\u3002</li> </ul> <p>\u73b0\u5728\u6211\u4eec\u901a\u8fc7\u5728 web \u670d\u52a1\u7684 <code>/api/vote</code> \u8def\u7531\u4e2d\u6dfb\u52a0\u91cd\u8bd5\u529f\u80fd\u6765\u9a8c\u8bc1\u4e0b\u524d\u9762\u7684\u77e5\u8bc6\u3002\u6211\u4eec\u518d\u6b21\u67e5\u770b\u4e0b web \u670d\u52a1\u7684 ServiceProfile \u5bf9\u8c61\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># web-sp.yaml\napiVersion: linkerd.io/v1alpha2\nkind: ServiceProfile\nmetadata:\n  name: web-svc.emojivoto.svc.cluster.local\n  namespace: emojivoto\nspec:\n  routes:\n    - condition:\n        method: GET\n        pathRegex: /api/list\n      name: GET /api/list\n    - condition:\n        method: GET\n        pathRegex: /api/vote\n      name: GET /api/vote\n</code></pre> <p>\u63a5\u7740\u6211\u4eec\u4e3a\u8def\u7531 <code>/api/vote</code>\u589e\u52a0\u4e00\u4e2a <code>isRetryable: true</code> \u7684\u5c5e\u6027\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code> # web-sp-with-retry.yaml\n# ......\n- condition:\n    method: GET\n    pathRegex: /api/vote\n  name: GET /api/vote\n  isRetryable: true\n</code></pre> <p>\u66f4\u65b0\u540e\u91cd\u65b0\u5e94\u7528\u8be5 ServiceProfile \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f web-sp-with-retry.yaml\n</code></pre> <p>\u5e94\u7528\u540e\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf vote-bot \u670d\u52a1\u7684\u8def\u7531\u6307\u6807\u53d8\u5316\u60c5\u51b5\uff1a</p> <pre><code>$ watch linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide\nEvery 2.0s: linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide                   MBP2022.local: Sun Aug 28 17:41:37 2022\n\nROUTE           SERVICE   EFFECTIVE_SUCCESS   EFFECTIVE_RPS   ACTUAL_SUCCESS   ACTUAL_RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nGET /api/list   web-svc             100.00%          1.0rps          100.00%       1.0rps           2ms           8ms          10ms\nGET /api/vote   web-svc              85.00%          1.0rps           16.50%       5.0rps           4ms         255ms         290ms\n[DEFAULT]       web-svc                   -               -                -            -             -             -             -\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5b9e\u9645\u6210\u529f\u7387\u53d8\u5f97\u975e\u5e38\u5e95\u4e86\uff0c\u56e0\u4e3a\u91cd\u8bd5\u7684\u7ed3\u679c\u53ef\u80fd\u8fd8\u662f\u9519\u8bef\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u4e86 Linkerd \u7684\u91cd\u8bd5\u884c\u4e3a\u662f\u7531\u91cd\u8bd5\u9884\u7b97\u914d\u7f6e\u7684\uff0c\u5f53\u914d\u7f6e isRetryable: true \u7684\u65f6\u5019\uff0c\u4f1a\u5e94\u7528\u9ed8\u8ba4\u7684\u91cd\u8bd5\u9884\u7b97\u89c4\u5219\uff0c\u4ee5\u4e0b ServiceProfile \u8d44\u6e90\u7684 YAML \u7247\u6bb5\uff0c\u663e\u793a\u4e86\u5177\u6709\u9ed8\u8ba4\u503c\u7684 retryBudget \u5bf9\u8c61\u914d\u7f6e\uff1a</p> <pre><code>spec:\n  retryBudget:\n    retryRatio: 0.2\n    minRetriesPerSecond: 10\n    ttl: 10s\n</code></pre> <p>\u5176\u4e2d retryBudget \u53c2\u6570\u662f\u5177\u6709\u4e09\u4e2a\u4e3b\u8981\u7684\u5b57\u6bb5\uff1a</p> <ul> <li>retryRatio\uff1a\u91cd\u8bd5\u7387\uff0c\u8868\u793a\u91cd\u8bd5\u8bf7\u6c42\u4e0e\u539f\u59cb\u8bf7\u6c42\u7684\u6700\u5927\u6bd4\u7387\uff0cretryRatio \u4e3a 0.2 \u8868\u793a\u91cd\u8bd5\u6700\u591a\u4f1a\u589e\u52a0 20% \u7684\u8bf7\u6c42\u8d1f\u8f7d\u3002</li> <li>minRetriesPerSecond\uff1a\u8fd9\u662f\u5728 retryRatio \u5141\u8bb8\u7684\u91cd\u8bd5\u4e4b\u5916\uff0c\u6bcf\u79d2\u5141\u8bb8\u7684\u91cd\u8bd5\u6b21\u6570\uff08\u8fd9\u5141\u8bb8\u5728\u8bf7\u6c42\u7387\u5f88\u4f4e\u65f6\u8fdb\u884c\u91cd\u8bd5\uff09\uff0c\u9ed8\u8ba4\u4e3a 10 RPS\u3002</li> <li>ttl\uff1a\u8868\u793a\u5728\u8ba1\u7b97\u91cd\u8bd5\u7387\u65f6\u5e94\u8003\u8651\u591a\u957f\u65f6\u95f4\u7684\u8bf7\u6c42\uff0c\u4e00\u4e2a\u8f83\u5927\u7684\u503c\u4f1a\u8003\u8651\u4e00\u4e2a\u8f83\u5927\u7684\u7a97\u53e3\uff0c\u56e0\u6b64\u5141\u8bb8\u66f4\u591a\u7684\u91cd\u8bd5\u3002\u9ed8\u8ba4\u4e3a 10 \u79d2\u3002</li> </ul>"},{"location":"chap11/3linkered_ServiceProfile/#_4","title":"\u914d\u7f6e\u8d85\u65f6","text":"<p>\u9664\u4e86\u91cd\u8bd5\u548c\u91cd\u8bd5\u9884\u7b97\u5916\uff0cLinkerd \u8fd8\u63d0\u4f9b\u8d85\u65f6\u529f\u80fd\uff0c\u5141\u8bb8\u4f60\u786e\u4fdd\u5bf9\u6307\u5b9a\u8def\u7531\u7684\u8bf7\u6c42\u6c38\u8fdc\u4e0d\u4f1a\u8d85\u8fc7\u6307\u5b9a\u7684\u65f6\u95f4\u3002</p> <p>\u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e00\u70b9\uff0c\u8ba9\u6211\u4eec\u91cd\u65b0\u6765\u770b\u4e00\u770b web \u548c voting \u670d\u52a1\u7684\u6bcf\u4e2a\u8def\u7531\u6307\u6807\u3002</p> <pre><code>$ linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide\n\n$ linkerd viz routes deploy/web -n emojivoto --to deploy/voting -o wide\n</code></pre> <p>\u5728\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u5230 web \u548c voting \u4e4b\u95f4\u7684\u5ef6\u8fdf\u63a5\u8fd1 1ms\uff0c\u4e3a\u4e86\u6f14\u793a\u8d85\u65f6\uff0c\u6211\u4eec\u5c06 <code>/api/vote</code>\u8def\u7531\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a 0.5ms\uff0c\u8fd9\u6837\u57fa\u672c\u4e0a\u90fd\u65e0\u6cd5\u6ee1\u8db3\u8981\u6c42\u5c31\u8d85\u65f6\u4e86\uff0cLinkerd \u4f1a\u5c06\u9519\u8bef\u53d1\u9001\u4f1a\u5ba2\u6237\u7aef\uff0c\u6210\u529f\u7387\u53d8\u4e3a 0 \u4e86\u3002</p> <p>\u4fee\u6539 web \u670d\u52a1\u7684 ServiceProfile \u5bf9\u8c61\uff0c\u6dfb\u52a0 timeout \u5c5e\u6027\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># web-sp-with-timeout.yaml\napiVersion: linkerd.io/v1alpha2\nkind: ServiceProfile\nmetadata:\n  name: web-svc.emojivoto.svc.cluster.local\n  namespace: emojivoto\nspec:\n  routes:\n    - condition:\n        method: GET\n        pathRegex: /api/list\n      name: GET /api/list\n    - condition:\n        method: GET\n        pathRegex: /api/vote\n      name: GET /api/vote\n      timeout: 0.5ms\n      isRetryable: true\n</code></pre> <p>\u5e94\u7528\u4e0a\u9762\u7684\u5bf9\u8c61\u540e\uff0c\u670d\u52a1\u7684\u6709\u6548\u548c\u5b9e\u9645\u6210\u529f\u7387\u5c31\u4f1a\u90fd\u4e0b\u964d\u5230 0\uff0c\u56e0\u4e3a /api/vote \u5728 0.5ms \u5185\u90fd\u4f1a\u8d85\u65f6\uff0c\u6240\u4ee5\u6210\u529f\u7387\u53d8\u4e3a 0\u3002</p> <pre><code>$ watch linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide\nEvery 2.0s: linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide                   MBP2022.local: Sun Aug 28 19:12:15 2022\n\nROUTE           SERVICE   EFFECTIVE_SUCCESS   EFFECTIVE_RPS   ACTUAL_SUCCESS   ACTUAL_RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nGET /api/list   web-svc             100.00%          1.0rps          100.00%       1.0rps           2ms           2ms           2ms\nGET /api/vote   web-svc               0.00%          1.0rps            0.00%       0.0rps           0ms           0ms           0ms\n[DEFAULT]       web-svc   \n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u4e2d\u91cd\u8bd5\u548c\u8d85\u65f6\u4f7f\u7528\uff0c\u91cd\u8bd5\u548c\u8d85\u65f6\u662f Linkerd \u6574\u4f53\u7b56\u7565\u7684\u4e00\u90e8\u5206\uff0c\u7528\u4e8e\u5728\u51fa\u73b0\u77ac\u65f6\u6545\u969c\u65f6\u589e\u52a0\u53ef\u9760\u6027\u3002</p> <p>\u6211\u4eec\u901a\u8fc7\u4f7f\u7528\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u6bcf\u6761\u8def\u7531\u6307\u6807\u6765\u51b3\u5b9a\u4f55\u65f6\u4ee5\u53ca\u5982\u4f55\u914d\u7f6e\u91cd\u8bd5\u548c\u8d85\u65f6\u3002Linkerd \u7528\u91cd\u8bd5\u9884\u7b97\u4e3a\u5176\u91cd\u8bd5\u63d0\u4f9b\u53c2\u6570\uff0c\u53ef\u4ee5\u907f\u514d\u51fa\u73b0\"\u91cd\u8bd5\u98ce\u66b4\"\u7684\u60c5\u51b5\uff0c\u5f53\u91cd\u8bd5\u9884\u7b97\u7528\u5b8c\u65f6\uff0c\u4ee3\u7406\u5c06\u505c\u6b62\u5411\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\uff0c\u4ee5\u907f\u514d\u670d\u52a1\u8fc7\u8f7d\uff0c\u5e76\u53ef\u80fd\u5f71\u54cd\u5230\u5e94\u7528\u7a0b\u5e8f\u7684\u5176\u4ed6\u90e8\u5206\u3002</p>"},{"location":"chap11/4linkered_mtls/","title":"4 \u5728 Linkerd \u4e2d\u4f7f\u7528 mTLS \u4fdd\u62a4\u5e94\u7528\u7a0b\u5e8f\u901a\u4fe1","text":"<p>\u5b89\u5168\u6027\u662f\u4e91\u539f\u751f\u5e94\u7528\u7a0b\u5e8f\u7684\u91cd\u4e2d\u4e4b\u91cd\uff0c\u867d\u7136\u5b89\u5168\u6027\u662f\u4e00\u4e2a\u975e\u5e38\u5e7f\u6cdb\u7684\u8bdd\u9898\uff0c\u4f46 Linkerd \u4f9d\u7136\u53ef\u4ee5\u53d1\u6325\u91cd\u8981\u4f5c\u7528\uff1a\u5176\u53cc\u5411 TLS\uff08mTLS\uff09\u529f\u80fd\u662f\u4e3a\u4e86\u5728 Kubernetes \u4e2d\u5b9e\u73b0\u96f6\u4fe1\u4efb\u7684\u5b89\u5168\u65b9\u6cd5\u3002\u96f6\u4fe1\u4efb\u5b89\u5168\u662f\u4e00\u79cd IT \u5b89\u5168\u6a21\u578b\uff0c\u8981\u6c42\u8bd5\u56fe\u8bbf\u95ee\u4e13\u7528\u7f51\u7edc\u4e0a\u8d44\u6e90\u7684\u6bcf\u4e00\u4e2a\u4eba\u548c\u6bcf\u4e00\u53f0\u8bbe\u5907\uff08\u65e0\u8bba\u4f4d\u4e8e\u7f51\u7edc\u8fb9\u754c\u4e4b\u5185\u8fd8\u662f\u4e4b\u5916\uff09\u90fd\u5fc5\u987b\u8fdb\u884c\u4e25\u683c\u7684\u8eab\u4efd\u9a8c\u8bc1\u3002</p>"},{"location":"chap11/4linkered_mtls/#mtls","title":"\u4ec0\u4e48\u662f mTLS","text":"<p>\u5728\u4e91\u73af\u5883\u4e2d\u8d8a\u6765\u8d8a\u666e\u904d\u7684\u901a\u4fe1\u5b89\u5168\u65b9\u6cd5\u662f<code>\u96f6\u4fe1\u4efb</code>\u65b9\u6cd5\uff0c\u867d\u7136\u5bf9\u96f6\u4fe1\u4efb\u5b89\u5168\u7684\u5168\u9762\u5904\u7406\u8d85\u51fa\u4e86\u672c\u8282\u7684\u8303\u56f4\uff0c\u4f46\u6838\u5fc3\u76ee\u6807\u662f\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u5b89\u5168\u8fb9\u754c\u7f29\u5c0f\u5230\u5c3d\u53ef\u80fd\u5c0f\u7684\u7ea7\u522b\u3002</p> <p>\u4f8b\u5982\uff0c\u4e0e\u5176\u5728\u6570\u636e\u4e2d\u5fc3\u5468\u56f4\u8bbe\u7f6e\u9632\u706b\u5899\uff0c\u5bf9\u8fdb\u5165\u7684\u6d41\u91cf\u5b9e\u65bd\u5b89\u5168\u4fdd\u62a4\uff0c\u7559\u4e0b\"\u8f6f\u5185\u90e8\"\u800c\u4e0d\u8fdb\u4e00\u6b65\u9a8c\u8bc1\uff0c\u4e0d\u5982\u8ba9\u6570\u636e\u4e2d\u5fc3\u7684\u6bcf\u4e2a\u5e94\u7528\u5728\u81ea\u5df1\u7684\u8fb9\u754c\u5b9e\u65bd\u5b89\u5168\u3002</p> <p>\u8fd9\u79cd\u96f6\u4fe1\u4efb\u7684\u65b9\u6cd5\u81ea\u7136\u9002\u5408\u4e91\u73af\u5883\uff0c\u56e0\u4e3a\u4e91\u73af\u5883\u4e2d\u7684\u5e95\u5c42\u786c\u4ef6\u548c\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u4e0d\u5728\u4f60\u7684\u63a7\u5236\u4e4b\u4e0b\u3002</p> <p>Linkerd \u5b89\u5168\u6a21\u578b\u901a\u8fc7\u5728\u670d\u52a1\u4e4b\u95f4\u63d0\u4f9b\u900f\u660e\u7684\u53cc\u5411 TLS \u901a\u4fe1\u6765\u5b9e\u73b0\u96f6\u4fe1\u4efb\u5b89\u5168\uff0c\u53cc\u5411 TLS (mTLS) \u662f\u4e00\u79cd\u4f20\u8f93\u5b89\u5168\u5f62\u5f0f\uff0c\u53ef\u63d0\u4f9b\u901a\u4fe1\u7684\u673a\u5bc6\u6027\u548c\u8eab\u4efd\u9a8c\u8bc1\u3002</p> <p>\u6362\u53e5\u8bdd\u8bf4\uff0c\u4e0d\u4ec5\u901a\u4fe1\u88ab\u52a0\u5bc6\uff0c\u800c\u4e14\u8eab\u4efd\u4e5f\u5728\u8fde\u63a5\u7684\u4e24\u7aef\u8fdb\u884c\u9a8c\u8bc1\uff08mTLS \u7684\u53cc\u5411\u7ec4\u4ef6\u4e0e\u6d4f\u89c8\u5668\u4f7f\u7528\u7684 TLS \u4e0d\u540c\uff0c\u5b83\u53ea\u9a8c\u8bc1\u8fde\u63a5\u7684\u670d\u52a1\u5668\u7aef\uff0cmTLS \u9a8c\u8bc1\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7684\u8eab\u4efd\uff09\u3002</p> <p>Linkerd \u7684\u76ee\u6807\u662f\u901a\u8fc7\u4f7f\u7528 mTLS \u5bf9 Kubernetes Pod \u4e4b\u95f4\u7684\u901a\u4fe1\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u548c\u52a0\u5bc6\uff0c\u5141\u8bb8\u4f60\u5bf9 Kubernetes \u96c6\u7fa4\u91c7\u7528\u96f6\u4fe1\u4efb\u65b9\u6cd5\u3002</p> <p>\u9a8c\u8bc1\u662f\u7279\u522b\u91cd\u8981\u7684\uff0c\u867d\u7136\u5927\u591a\u6570\u4eba\u8ba4\u4e3a TLS \u7684\u4ef7\u503c\u5728\u4e8e\u52a0\u5bc6\uff0c\u4f46\u9a8c\u8bc1\u8fde\u63a5\u4e24\u8fb9\u5b9e\u4f53\u7684\u8eab\u4efd\u4e5f\u540c\u6837\u91cd\u8981\u3002\u6bd5\u7adf\u53ea\u6709\u5728\u4f60\u80fd\u76f8\u4fe1\u4e0e\u4f60\u901a\u4fe1\u7684\u53e6\u4e00\u65b9\u7684\u5b9e\u4f53\u662f\u4ed6\u4eec\u6240\u8bf4\u7684\u4eba\u7684\u60c5\u51b5\u4e0b\uff0c\u52a0\u5bc6\u624d\u662f\u6709\u7528\u7684--\u6765\u81ea\u4e0d\u826f\u884c\u4e3a\u8005\u7684\u52a0\u5bc6\u4fe1\u606f\u4ecd\u7136\u662f\u6765\u81ea\u4e0d\u826f\u884c\u4e3a\u8005\u7684\u4fe1\u606f\u3002</p> <p>\u5728 Linkerd \u4e2d\uff0c\u901a\u8fc7 mTLS \u9a8c\u8bc1\u7684\u8eab\u4efd\u4e0e Kubernetes ServiceAccounts \u76f8\u5173\u8054\u3002\u8fd9\u610f\u5473\u7740 Linkerd \u7684 mTLS \u8eab\u4efd\u7cfb\u7edf\u4f7f\u7528\u4e0e Kubernetes \u7528\u4e8e\u4e3a\u96c6\u7fa4\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5efa\u7acb\u8eab\u4efd\u548c\u8bbf\u95ee\u63a7\u5236\u7684\u5b8c\u5168\u76f8\u540c\u7684\u6a21\u5f0f\uff0c\u800c\u4e0d\u662f\u53d1\u660e\u4e00\u4e2a\u65b0\u6846\u67b6\u3002</p>"},{"location":"chap11/4linkered_mtls/#linkerd-mtls","title":"\u4f7f\u7528 Linkerd \u7684 mTLS","text":"<p>Linkerd \u7684\u8bbe\u8ba1\u539f\u5219\u4e4b\u4e00\u662f\uff0c\u590d\u6742\u6027\u662f\u5b89\u5168\u7684\u654c\u4eba\u3002\u914d\u7f6e\u4e1c\u897f\u8d8a\u96be\uff0c\u4f7f\u7528\u5b83\u7684\u53ef\u80fd\u6027\u5c31\u8d8a\u5c0f; \u9009\u9879\u548c\u8bbe\u7f6e\u8d8a\u591a\uff0c\u5c31\u8d8a\u6709\u53ef\u80fd\u4e0d\u5c0f\u5fc3\u4ee5\u4e0d\u5b89\u5168\u7684\u65b9\u5f0f\u8fdb\u884c\u914d\u7f6e\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cLinkerd \u4e3a\u6240\u6709\u7f51\u683c\u4e2d\u7684 pod-to-pod \u901a\u4fe1\u542f\u7528\u4e86 mTLS\uff0c\u53ea\u8981\u53cc\u65b9\u90fd\u6ce8\u5165\u4e86\u6570\u636e\u5e73\u9762\u4ee3\u7406\uff0c\u90a3\u4e48\u606d\u559c\u4f60\uff1a\u4f60\u5df2\u7ecf\u5728\u670d\u52a1\u4e4b\u95f4\u9a8c\u8bc1\u4e86\u52a0\u5bc6\u7684 mTLS\u3002\u4e8b\u5b9e\u4e0a\uff0c\u524d\u9762\u6211\u4eec\u4f7f\u7528\u7684 Emojivoto \u5e94\u7528\u7a0b\u5e8f\u4e2d\u5c31\u5df2\u7ecf\u5728\u4f7f\u7528 mTLS \u4e86\uff0c\u53ea\u662f\u6211\u4eec\u6ca1\u6709\u610f\u8bc6\u5230\u800c\u5df2\u3002</p> <p>\u5bf9\u5bf9\u4e8e Linkerd \u81ea\u52a8\u6dfb\u52a0 mTLS \u7684\u529f\u80fd\uff0c\u6709\u51e0\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u3002</p> <ul> <li>\u4e24\u4e2a\u7aef\u70b9\u90fd\u5fc5\u987b\u5728\u7f51\u683c\u4e2d\u3002Linkerd \u9700\u8981\u540c\u65f6\u5904\u7406\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7aef\u7684\u8fde\u63a5\u624d\u80fd\u53d1\u6325\u5176 mTLS \u7684\u9b54\u529b\u3002</li> <li>\u5728 Linkerd 2.8.1 \u548c\u66f4\u65e9\u7684\u7248\u672c\u4e2d\uff0cLinkerd \u53ea\u80fd\u4e3a HTTP \u548c gRPC \u6d41\u91cf\u6dfb\u52a0 mTLS\uff0c\u5373\u4f7f\u5982\u6b64\uff0c\u4e5f\u65e0\u6cd5\u9488\u5bf9\u67d0\u4e9b\u7c7b\u578b\u7684\u6743\u9650\u3001\u4e3b\u673a\u6216 Header \u6267\u884c\u8be5\u64cd\u4f5c\uff0c\u8fd9\u4e9b\u9650\u5236\u5728 Linkerd 2.9 \u4e2d\u5df2\u7ecf\u88ab\u79fb\u9664\uff0c\u5b83\u5c06 mTLS \u6dfb\u52a0\u5230\u6240\u6709\u7684 TCP \u6d41\u91cf\u4e2d\uff0c\u4e0d\u7ba1\u662f\u4ec0\u4e48\u534f\u8bae\u3002</li> <li>\u5ba2\u6237\u7aef\u53d1\u8d77 TLS \u7684\u8fde\u63a5\u4e0d\u80fd\u7531 Linkerd \u8fdb\u884c mTLS\u3002\u76f8\u53cd\uff0cLinkerd \u4f1a\u5c06\u628a\u8fd9\u4e9b\u8fde\u63a5\u89c6\u4e3a TCP \u6d41\u91cf\u3002\u8bf7\u6ce8\u610f\uff0c\u8fd9\u4e5f\u610f\u5473\u7740 Linkerd \u53ea\u80fd\u4e3a\u8fd9\u4e9b\u8fde\u63a5\u63d0\u4f9b TCP \u7ea7\u522b\u7684\u6307\u6807\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u6765\u4e86\u89e3\u4e0b mTLS \u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u4ee5\u53ca\u5982\u4f55\u9a8c\u8bc1\u6211\u4eec\u7684\u8fde\u63a5\u662f\u5426\u786e\u5b9e\u5177\u6709 mTLS\u3002</p>"},{"location":"chap11/4linkered_mtls/#linkerd-identity","title":"Linkerd Identity \u7ec4\u4ef6","text":"<p>\u5728\u524d\u9762\u8bb2\u89e3 Linkerd \u67b6\u6784\u7684\u65f6\u5019\u6211\u4eec\u5c31\u8ba8\u8bba\u8fc7 Linkerd \u63a7\u5236\u5e73\u9762\u7684 Identity \u7ec4\u4ef6\uff0c\u5b83\u4f5c\u4e3a CA \u6216\u8bc1\u4e66\u9881\u53d1\u673a\u6784\u6240\u626e\u6f14\u7684\u89d2\u8272\u3002\u8bc1\u4e66\u9881\u53d1\u673a\u6784\u662f\u9881\u53d1\u6570\u5b57\u8bc1\u4e66\u5e76\u4f7f\u8eab\u4efd\u7ec4\u4ef6\u6210\u4e3a\u6570\u5b57\u8bc1\u4e66\u9881\u53d1\u8005\u7684\u5b9e\u4f53\u3002</p> <p>Linkerd \u4f7f\u7528\u7684\u8bc1\u4e66\u4e0e\u7f51\u7ad9\u7528\u6765\u9a8c\u8bc1\u5176\u8eab\u4efd\u7684 TLS \u8bc1\u4e66\u201c\u7c7b\u578b\u201d\u76f8\u540c\u3002\u4e0e\u7f51\u7ad9\u4e0d\u540c\uff0c\u8fd9\u4e9b\u8bc1\u4e66\u4e0d\u7ecf\u8fc7 Verisign \u7b49\u7b2c\u4e09\u65b9\u5b9e\u4f53\u7684\u9a8c\u8bc1\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0d\u9700\u8981\u9a8c\u8bc1\uff0c\u5b83\u4eec\u4ec5\u4f9b Linkerd \u4ee3\u7406\u5728\u96c6\u7fa4\u5185\u4f7f\u7528\u3002</p> <p>Linkerd \u7684 CA\uff08Identity \u670d\u52a1\uff09\u4f5c\u4e3a Linkerd \u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u3002</p> <p>\u5728\u8be5\u90e8\u7f72\u8fc7\u7a0b\u4e2d\uff0cLinkerd CLI \u5c06\u751f\u6210\u4e00\u4e2a\u8bc1\u4e66\u5e76\u5c06\u5176\u5b58\u50a8\u5728 Linkerd \u547d\u540d\u7a7a\u95f4\u4e2d\u540d\u4e3a <code>linkerd-identity-token-XXXXX</code> \u7684 Kubernetes Secret \u4e2d\u3002</p> <pre><code>$ kubectl get secret -n linkerd\nNAME                                 TYPE                                  DATA   AGE\nlinkerd-identity-issuer              Opaque                                2      11d\nlinkerd-identity-token-nqhbk         kubernetes.io/service-account-token   3      11d\n# ......\n</code></pre> <p>\u901a\u8fc7\u67e5\u770b Secret \u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u524d\u7f00\u4e3a <code>linkerd-identity-token-</code> \u7684<code>Secret</code> \u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u5bfc\u51fa\u6765\u8fdb\u884c\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get secret -n linkerd linkerd-identity-token-nqhbk -o yaml\napiVersion: v1\ndata:\n  ca.crt: &lt;ca.crt&gt;\n  namespace: bGlua2VyZA==\n  token: &lt;token&gt;\nkind: Secret\nmetadata:\n  annotations:\n    kubernetes.io/service-account.name: linkerd-identity\n    kubernetes.io/service-account.uid: cdc3d8fd-0e02-4b17-88ce-d2cc0a9e4907\n  name: linkerd-identity-token-nqhbk\n  namespace: linkerd\ntype: kubernetes.io/service-account-token\n</code></pre> <p>\u8f93\u51fa\u7684\u6570\u636e\u90e8\u5206\u4e2d\u540d\u4e3a ca.crt \u7684\u5b57\u6bb5\u5c31\u662f\u5728 Linkerd \u5b89\u88c5\u671f\u95f4\u751f\u6210\u7684 UTF-8 \u7f16\u7801\u7684\u6839\u8bc1\u4e66\u3002\u6b64\u8bc1\u4e66\u79f0\u4e3a\u201c\u4fe1\u4efb\u4e4b\u951a\u201d\uff0c\u56e0\u4e3a\u5b83\u662f\u7528\u4f5c\u9881\u53d1\u7ed9\u4ee3\u7406\u7684\u6240\u6709\u8bc1\u4e66\u7684\u57fa\u7840\u3002</p> <p>\u4fe1\u4efb\u951a\u8fd8\u7528\u4e8e\u5728\u5b89\u88c5\u65f6\u521b\u5efa\u53e6\u4e00\u4e2a\u8bc1\u4e66\u548c\u5bc6\u94a5\u5bf9\uff1a</p> <p>\u9881\u53d1\u8005\u51ed\u636e\uff0c\u8fd9\u4e9b\u5b58\u50a8\u5728\u540d\u4e3a <code>linkerd-identity-issuer</code> \u7684\u5355\u72ec Kubernetes Secret \u4e2d\u3002\u9881\u53d1\u8005\u51ed\u636e\u7528\u4e8e\u5411 <code>Linkerd proxy</code> \u9881\u53d1\u8bc1\u4e66\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u6765\u67e5\u770b\u8be5 Secret \u7684\u6570\u636e\u3002</p> <pre><code>$ kubectl get secret -n linkerd linkerd-identity-issuer -o yaml\napiVersion: v1\ndata:\n  crt.pem: &lt;crt.pem&gt;\n  key.pem: &lt;key.pem&gt;\nkind: Secret\nmetadata:\n  labels:\n    linkerd.io/control-plane-component: identity\n    linkerd.io/control-plane-ns: linkerd\n  name: linkerd-identity-issuer\n  namespace: linkerd\ntype: Opaque\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8fd9\u4e9b\u5bc6\u94a5\u5411\u4ee3\u7406\u9881\u53d1\u8bc1\u4e66\u4ee5\u542f\u7528 mTLS\u3002</p>"},{"location":"chap11/4linkered_mtls/#linkerd","title":"Linkerd \u4ee3\u7406\u5982\u4f55\u83b7\u53d6\u8bc1\u4e66","text":"<p>\u9996\u5148\uff0c\u5f53 Pod \u88ab\u6ce8\u5165 Linkerd \u4ee3\u7406\u65f6\uff0c\u8be5\u4ee3\u7406\u4f1a\u5411 Linkerd \u7684\u8eab\u4efd\u670d\u52a1\u53d1\u9001\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42 (CSR)\u3002</p> <p>\u8eab\u4efd\u670d\u52a1\u4f7f\u7528\u9881\u53d1\u8005\u51ed\u636e\u5411\u8be5\u4ee3\u7406\u9881\u53d1\u7b7e\u540d\u8bc1\u4e66\uff08CSR \u7684\u4f5c\u7528\u57df\u662f\u8fd0\u884c Pod \u7684 Kubernetes ServiceAccount\uff0c\u56e0\u6b64\u751f\u6210\u7684\u8bc1\u4e66\u4e0e\u8be5 ServiceAccount \u76f8\u5173\u8054\uff09\uff0c\u8bc1\u4e66\u5c06\u5728 24 \u5c0f\u65f6\u540e\u8fc7\u671f\u3002</p> <p>\u5728\u8bc1\u4e66\u8fc7\u671f\u524d\uff0c\u4ee3\u7406\u5411\u8eab\u4efd\u670d\u52a1\u53d1\u9001\u65b0\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff0c\u83b7\u53d6\u65b0\u8bc1\u4e66\uff1b</p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u5728 Linkerd \u4ee3\u7406\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u5185\u90fd\u4f1a\u6301\u7eed\uff0c\u8fd9\u79f0\u4e3a\u8bc1\u4e66\u8f6e\u6362\uff0c\u662f\u4e00\u79cd\u5c06\u8bc1\u4e66\u6cc4\u9732\u9020\u6210\u7684\u635f\u5931\u964d\u81f3\u6700\u4f4e\u7684\u81ea\u52a8\u5316\u65b9\u5f0f\uff1a\u5728\u6700\u574f\u7684\u60c5\u51b5\u4e0b\uff0c\u4efb\u4f55\u6cc4\u9732\u7684\u8bc1\u4e66\u53ea\u80fd\u4f7f\u7528 24 \u5c0f\u65f6\u3002</p> <p><code>linkerd check</code> \u547d\u4ee4\u6709\u4e00\u79cd\u7b80\u5355\u7684\u65b9\u6cd5\u6765\u786e\u4fdd\u4ee3\u7406\u90fd\u5177\u6709\u7531\u8eab\u4efd\u670d\u52a1\u9881\u53d1\u7684\u8bc1\u4e66\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u901a\u8fc7\u4f20\u9012 <code>--proxy</code> \u6807\u5fd7\u6765\u68c0\u67e5\u4ee3\u7406\u7684\u72b6\u6001\u3002</p> <pre><code># \u4f7f\u7528 --proxy \u6807\u5fd7\u5728\u6570\u636e\u5e73\u9762\u68c0\u67e5\u4ee3\u7406\n$ linkerd check --proxy\n# ......\nlinkerd-identity\n----------------\n\u221a certificate config is valid\n\u221a trust anchors are using supported crypto algorithm\n\u221a trust anchors are within their validity period\n\u221a trust anchors are valid for at least 60 days\n\u221a issuer cert is using supported crypto algorithm\n\u221a issuer cert is within its validity period\n\u221a issuer cert is valid for at least 60 days\n\u221a issuer cert is issued by the trust anchor\n\nlinkerd-identity-data-plane\n---------------------------\n\u221a data plane proxies certificate match CA\n\n# ......\n\nStatus check results are \u221a\n</code></pre> <p>\u4e0a\u9762\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\u5305\u62ec\u4e00\u4e2a <code>linkerd-identity-data-plane</code> \u90e8\u5206\uff0c\u7528\u6765\u6307\u793a\u4ee3\u7406\u662f\u5426\u6b63\u5728\u4f7f\u7528\u7531\u4fe1\u4efb\u951a\u9881\u53d1\u7684\u8bc1\u4e66\u3002</p> <pre><code>linkerd-identity-data-plane\n---------------------------\n\u221a data plane proxies certificate match CA\n</code></pre> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 Linkerd \u4ee3\u7406\u548c\u8eab\u4efd\u670d\u52a1\u4e2d\u5f00\u542f debug \u6a21\u5f0f\uff0c\u4ee5\u67e5\u770b\u4ee3\u7406\u5c06 CSR \u53d1\u9001\u5230\u8eab\u4efd\u670d\u52a1\u5e76\u53d6\u56de\u8bc1\u4e66\u3002</p> <pre><code>$ kubectl get deploy -n linkerd\nNAME                     READY   UP-TO-DATE   AVAILABLE   AGE\nlinkerd-destination      1/1     1            1           11d\nlinkerd-identity         1/1     1            1           11d\nlinkerd-proxy-injector   1/1     1            1           11d\n$ kubectl edit deploy linkerd-identity -n linkerd\n# ......\n  spec:\n    containers:\n    - args:\n      - identity\n      - -log-level=debug  # \u8bbe\u7f6e\u4e3a debug \u6a21\u5f0f\n      - -log-format=plain\n      - -controller-namespace=linkerd\n      - -identity-trust-domain=cluster.local\n      - -identity-issuance-lifetime=24h0m0s\n      - -identity-clock-skew-allowance=20s\n      - -identity-scheme=linkerd.io/tls\n# ......\n</code></pre> <p>\u5f53\u8eab\u4efd\u670d\u52a1\u91cd\u65b0\u66f4\u65b0\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf\u5bf9\u5e94 Pod \u7684\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs -f -n linkerd deploy/linkerd-identity -c identity\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u8f93\u51fa\u5f88\u591a\u65e5\u5fd7\u5230\u63a7\u5236\u53f0\uff0c\u5728 Linkerd \u8eab\u4efd\u65e5\u5fd7\u8f93\u51fa\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>Request Body</code> \u548c <code>Response Body</code> \u76f8\u5173\u7684\u8f93\u51fa\uff0c\u5176\u4e2d\u5305\u62ec\u4e00\u4e2a\u5f88\u957f\u7684 UTF-8 \u7f16\u7801\u6570\u636e\uff0c\u5373 CSR \u548c\u9881\u53d1\u7ed9\u4ee3\u7406\u7684\u8bc1\u4e66\uff1a</p> <pre><code># ......\ntime=\"2022-08-30T07:39:17Z\" level=debug msg=\"Issuer has been updated\"\ntime=\"2022-08-30T07:39:17Z\" level=info msg=\"starting admin server on :9990\"\ntime=\"2022-08-30T07:39:17Z\" level=info msg=\"starting gRPC server on :8080\"\ntime=\"2022-08-30T07:39:17Z\" level=debug msg=\"Validating token for linkerd-identity.linkerd.serviceaccount.identity.linkerd.cluster.local\"\nI0830 07:39:17.291787       1 request.go:1123] Request Body: {\"kind\":\"TokenReview\",\"apiVersion\":\"authentication.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"token\":\"&lt;......&gt;\"},\"status\":{\"user\":{}}}\n# ......\nI0830 07:39:17.291969       1 round_trippers.go:435] curl -k -v -XPOST  -H \"Accept: application/json, */*\" -H \"Content-Type: application/json\" -H \"User-Agent: controller/v0.0.0 (linux/amd64) kubernetes/$Format\" -H \"Authorization: Bearer &lt;masked&gt;\" 'https://10.96.0.1:443/apis/authentication.k8s.io/v1/tokenreviews'\nI0830 07:39:17.293883       1 round_trippers.go:454] POST https://10.96.0.1:443/apis/authentication.k8s.io/v1/tokenreviews 201 Created in 1 milliseconds\n# ......\nI0830 07:39:17.294241       1 request.go:1123] Response Body: {\"kind\":\"TokenReview\",\"apiVersion\":\"authentication.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null,\"managedFields\":[{\"manager\":\"controller\",\"operation\":\"Update\",\"apiVersion\":\"authentication.k8s.io/v1\",\"time\":\"2022-08-30T07:39:17Z\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:token\":{}}}}]},\"spec\":{\"token\":\"&lt;token&gt;\"},\"status\":{\"authenticated\":true,\"user\":{\"username\":\"system:serviceaccount:linkerd:linkerd-identity\",\"uid\":\"cdc3d8fd-0e02-4b17-88ce-d2cc0a9e4907\",\"groups\":[\"system:serviceaccounts\",\"system:serviceaccounts:linkerd\",\"system:authenticated\"],\"extra\":{\"authentication.kubernetes.io/pod-name\":[\"linkerd-identity-5d9b874d66-m77ps\"],\"authentication.kubernetes.io/pod-uid\":[\"2f147d37-1616-487a-b7aa-1805b84c026a\"]}},\"audiences\":[\"https://kubernetes.default.svc.cluster.local\"]}}\n# ......\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u67e5\u770b\u4e0b Emojivoto \u5e94\u7528\u670d\u52a1\u4e4b\u95f4\u7684\u5b89\u5168\u6027\u3002\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd viz edges \u547d\u4ee4\u6765\u67e5\u770b\u4e0b Pod \u4e4b\u95f4\u662f\u5982\u4f55\u8fde\u63a5\u7684\u3002</p> <pre><code>$ linkerd viz edges po -n emojivoto\nSRC                           DST                         SRC_NS        DST_NS      SECURED\nvote-bot-6d7677bb68-jvxsg     web-5f86686c4d-58p7k        emojivoto     emojivoto   \u221a\nweb-5f86686c4d-58p7k          emoji-696d9d8f95-5vn9w      emojivoto     emojivoto   \u221a\nweb-5f86686c4d-58p7k          voting-ff4c54b8d-xhjv7      emojivoto     emojivoto   \u221a\nprometheus-7bbc4d8c5b-5rc8r   emoji-696d9d8f95-5vn9w      linkerd-viz   emojivoto   \u221a\nprometheus-7bbc4d8c5b-5rc8r   vote-bot-6d7677bb68-jvxsg   linkerd-viz   emojivoto   \u221a\nprometheus-7bbc4d8c5b-5rc8r   voting-ff4c54b8d-xhjv7      linkerd-viz   emojivoto   \u221a\nprometheus-7bbc4d8c5b-5rc8r   web-5f86686c4d-58p7k        linkerd-viz   emojivoto   \u221a\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\u6700\u540e\u5305\u542b\u4e00\u5217 <code>SECURED</code>\uff0c\u8868\u793a\u662f\u5426\u662f\u5b89\u5168\u7684\u8fde\u63a5\uff0c\u4e0b\u9762\u7684\u503c\u5747\u4e3a <code>\u221a</code>\uff0c\u8868\u793a\u662f\u5b89\u5168\u7684\u8fde\u63a5\u3002</p> <p>\u7136\u540e\u6211\u4eec\u518d\u6b21\u4f7f\u7528 <code>linkerd viz tap</code> \u547d\u4ee4\u6765\u6355\u83b7\u5b9e\u65f6\u6d41\u91cf\uff0c\u5728\u8f93\u51fa\u7684\u4fe1\u606f\u4e2d\u4e5f\u5305\u542b\u4e00\u4e2a <code>tls=true</code> \u7684\u6807\u7b7e\u503c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ linkerd viz tap deploy web -n emojivoto\nreq id=0:0 proxy=in  src=10.244.1.165:47130 dst=10.244.1.176:8080 tls=true :method=GET :authority=web-svc.emojivoto:80 :path=/api/list\nreq id=0:1 proxy=out src=10.244.1.176:42096 dst=10.244.1.188:8080 tls=true :method=POST :authority=emoji-svc.emojivoto:8080 :path=/emojivoto.v1.EmojiService/ListAll\nrsp id=0:1 proxy=out src=10.244.1.176:42096 dst=10.244.1.188:8080 tls=true :status=200 latency=2731\u00b5s\n# ......\n</code></pre> <p>\u5230\u8fd9\u91cc\u9762\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u7684 Identity \u7ec4\u4ef6\u5982\u4f55\u5411\u6570\u636e\u5e73\u9762\u4e2d\u7684 Linkerd \u4ee3\u7406\u9881\u53d1\u8bc1\u4e66\uff0c\u4ee5\u53ca Linkerd \u5728\u4ee3\u7406\u4e2d\u7684 mTLS \u5b9e\u73b0\u5982\u4f55\u4f7f\u7528\u8fd9\u4e9b\u8bc1\u4e66\u6765\u52a0\u5bc6\u901a\u4fe1\u5e76\u9a8c\u8bc1\u53cc\u65b9\u7684\u8eab\u4efd\u3002</p>"},{"location":"chap11/4linkered_mtls/#tls","title":"\u81ea\u52a8\u8f6e\u6362\u63a7\u5236\u5668\u5e73\u9762 TLS \u51ed\u8bc1","text":"<p>Linkerd \u7684\u81ea\u52a8 mTLS \u529f\u80fd\u4f7f\u7528\u4e00\u7ec4 TLS \u51ed\u636e\u4e3a\u4ee3\u7406\u751f\u6210 TLS \u8bc1\u4e66\uff1a\u4fe1\u4efb\u951a(trust anchor)\u3001\u9881\u53d1\u8005\u8bc1\u4e66(issuer certificate)\u548c\u79c1\u94a5(private key)\u3002</p> <p>\u867d\u7136 Linkerd \u6bcf 24 \u5c0f\u65f6\u81ea\u52a8\u8f6e\u6362\u6570\u636e\u5e73\u9762\u4ee3\u7406\u7684 TLS \u8bc1\u4e66\uff0c\u4f46\u5b83\u4e0d\u4f1a\u8f6e\u6362\u7528\u4e8e\u9881\u53d1\u8fd9\u4e9b\u8bc1\u4e66\u7684 TLS \u51ed\u636e\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u4e0b\u5982\u4f55\u4f7f\u7528 Cert-manager \u8fdb\u884c\u81ea\u52a8\u8f6e\u6362\u9881\u53d1\u8005\u8bc1\u4e66\u548c\u79c1\u94a5\u3002</p>"},{"location":"chap11/4linkered_mtls/#cert-manager","title":"<code>Cert-manager</code>","text":"<p><code>Cert-manager</code> \u662f\u4e00\u4e2a\u975e\u5e38\u6d41\u884c\u7684\u4e91\u539f\u751f\u8bc1\u4e66\u7ba1\u7406\u5de5\u5177\u3002</p> <p><code>Cert-manager</code> \u5c06\u8bc1\u4e66\u548c\u8bc1\u4e66\u9881\u53d1\u8005\u4f5c\u4e3a CRD \u8d44\u6e90\u7c7b\u578b\u6dfb\u52a0\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u7b80\u5316\u4e86\u83b7\u53d6\u3001\u66f4\u65b0\u548c\u4f7f\u7528\u8fd9\u4e9b\u8bc1\u4e66\u7684\u8fc7\u7a0b\u3002\u5b83\u53ef\u4ee5\u4ece\u5404\u79cd\u53d7\u652f\u6301\u7684\u6765\u6e90\u53d1\u5e03\u8bc1\u4e66\uff0c\u5305\u62ec Let's Encrypt\u3001 HashiCorp Vault \u548c Venafi \u4ee5\u53ca\u79c1\u6709 PKI\u3002\u5b83\u5c06\u786e\u4fdd\u8bc1\u4e66\u6709\u6548\u5e76\u4e14\u662f\u6700\u65b0\u7684\uff0c\u5e76\u5c1d\u8bd5\u5728\u8bc1\u4e66\u5230\u671f\u524d\u7684\u914d\u7f6e\u65f6\u95f4\u66f4\u65b0\u8bc1\u4e66\u3002</p> <p></p> <p><code>Cert-manager</code> \u7684\u5b89\u88c5\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e00\u952e\u5b89\u88c5\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.9.1/cert-manager.yaml\n</code></pre> <p>\u9ed8\u8ba4\u4f1a\u5c06\u76f8\u5173\u8d44\u6e90\u5b89\u88c5\u5230\u4e00\u4e2a\u540d\u4e3a <code>cert-manager</code> \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff1a</p> <pre><code>$ kubectl get pods -n cert-manager\nNAME                                      READY   STATUS    RESTARTS   AGE\ncert-manager-55649d64b4-kdcfk             1/1     Running   0          43s\ncert-manager-cainjector-666db4777-cp2dn   1/1     Running   0          43s\ncert-manager-webhook-6466bc8f4-5lvw5      1/1     Running   0          43s\n</code></pre>"},{"location":"chap11/4linkered_mtls/#_1","title":"\u9881\u53d1\u8bc1\u4e66","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u4f7f\u7528 step \u5de5\u5177\u521b\u5efa\u4e00\u4e2a\u7b7e\u540d\u5bc6\u94a5\u5bf9\uff0c\u5e76\u5c06\u5176\u5b58\u50a8\u5728 Kubernetes \u7684\u4e00\u4e2a Secret \u5bf9\u8c61\u4e2d\u3002</p> <pre><code>$ step certificate create root.linkerd.cluster.local ca.crt ca.key \\\n  --profile root-ca --no-password --insecure\nYour certificate has been saved in ca.crt.\nYour private key has been saved in ca.key.\n</code></pre> <p>\u7136\u540e\u5c06\u751f\u6210\u7684 <code>ca.crt</code> \u548c <code>ca.key</code> \u4fdd\u5b58\u5230 Secret \u5bf9\u8c61\u4e2d\uff1a</p> <pre><code>$ kubectl create secret tls linkerd-trust-anchor --cert=ca.crt --key=ca.key -n\nsecret/linkerd-trust-anchor created\n</code></pre> <p>\u6709\u4e86 Secret\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u5f15\u7528\u5bc6\u94a5\u7684\u8bc1\u4e66\u9881\u53d1\u8005 Issuer \u8d44\u6e90\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: cert-manager.io/v1\nkind: Issuer\nmetadata:\n  name: linkerd-trust-anchor\n  namespace: linkerd\nspec:\n  ca:\n    secretName: linkerd-trust-anchor\nEOF\n$ kubectl get issuer -n linkerd\nNAME                   READY   AGE\nlinkerd-trust-anchor   True    84s\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u9881\u53d1\u8bc1\u4e66\u4e86\uff0c\u5e76\u5c06\u5b83\u4eec\u5199\u5165\u5230\u4e00\u4e2a Secret \u5bf9\u8c61\u4e2d\uff0c\u6700\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a <code>cert-manager \"Certificate\"</code> \u8d44\u6e90\uff0c \u5b83\u4f7f\u7528\u8fd9\u4e2a Issuer \u6765\u751f\u6210\u6240\u9700\u7684\u8bc1\u4e66\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: linkerd-identity-issuer\n  namespace: linkerd\nspec:\n  secretName: linkerd-identity-issuer\n  duration: 48h\n  renewBefore: 25h\n  issuerRef:\n    name: linkerd-trust-anchor\n    kind: Issuer\n  commonName: identity.linkerd.cluster.local\n  dnsNames:\n  - identity.linkerd.cluster.local\n  isCA: true\n  privateKey:\n    algorithm: ECDSA\n  usages:\n  - cert sign\n  - crl sign\n  - server auth\n  - client auth\nEOF\n$ kubectl get certificate -n linkerd\nNAME                      READY   SECRET                    AGE\nlinkerd-identity-issuer   True    linkerd-identity-issuer   17s\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\uff0cduration \u6307\u793a <code>cert-manager</code> \u5c06\u8bc1\u4e66\u89c6\u4e3a\u6709\u6548\u671f 48 \u5c0f\u65f6\uff0c\u800c <code>renewBefore</code>\u6307\u793a <code>cert-manager</code> \u5c06\u5c1d\u8bd5\u5728\u5f53\u524d\u8bc1\u4e66\u5230\u671f\u524d 25 \u5c0f\u65f6\u9881\u53d1\u65b0\u8bc1\u4e66\u3002</p> <p>\u6b64\u65f6\uff0ccert-manager \u73b0\u5728\u53ef\u4ee5\u4f7f\u7528\u6b64\u8bc1\u4e66\u8d44\u6e90\u83b7\u53d6 TLS \u51ed\u636e\uff0c\u8be5\u51ed\u636e\u5c06\u5b58\u50a8\u5728\u540d\u4e3a <code>linkerd-identity-issuer</code> \u7684 Secret \u4e2d\uff0c\u8981\u9a8c\u8bc1\u60a8\u65b0\u9881\u53d1\u7684\u8bc1\u4e66\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl get secret linkerd-identity-issuer -o yaml -n linkerd\napiVersion: v1\ndata:\n  ca.crt: &lt;ca.crt&gt;\n  crt.pem: &lt;crt.pem&gt;\n  key.pem: &lt;key.pem&gt;\n  tls.crt: &lt;tls.crt&gt;\n  tls.key: &lt;tls.key&gt;\nkind: Secret\nmetadata:\n  name: linkerd-identity-issuer\n  namespace: linkerd\ntype: Opaque\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ea\u9700\u8981\u901a\u77e5 Linkerd \u4f7f\u7528\u8fd9\u4e9b\u51ed\u636e\u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u662f\u901a\u8fc7 linkerd \u547d\u4ee4\u884c\u5de5\u5177\u8fdb\u884c\u5b89\u88c5\u7684\uff0cLinkerd \u63a7\u5236\u5e73\u9762\u9ed8\u8ba4\u4f1a\u901a\u8fc7 <code>--identity-external-issuer</code>\u6807\u5fd7\u8fdb\u884c\u5b89\u88c5\uff0c\u8be5\u6807\u5fd7\u6307\u793a <code>Linkerd</code> \u4ece <code>linkerd-identity-issuer</code>\u7684 <code>Secret</code> \u8bfb\u53d6\u8bc1\u4e66\u3002</p> <p>\u6bcf\u5f53\u66f4\u65b0\u5b58\u50a8\u5728 Secret \u4e2d\u7684 certificate \u548c key \u65f6\uff0c identity \u670d\u52a1\u5c06\u81ea\u52a8\u68c0\u6d4b\u6b64\u66f4\u6539\u5e76\u91cd\u65b0\u52a0\u8f7d\u65b0\u51ed\u636e\u3002</p> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8bbe\u7f6e\u4e86 Linkerd \u63a7\u5236\u5e73\u9762 TLS \u51ed\u636e\u7684\u81ea\u52a8\u8f6e\u6362\uff0c\u5982\u679c\u4f60\u60f3\u76d1\u63a7\u66f4\u65b0\u8fc7\u7a0b\uff0c\u4f60\u53ef\u4ee5\u68c0\u67e5\u670d\u52a1\u53d1\u51fa\u7684 <code>IssuerUpdated</code> \u4e8b\u4ef6\uff1a</p> <pre><code>$ kubectl get events --field-selector reason=IssuerUpdated -n linkerd\n\nLAST SEEN   TYPE     REASON          OBJECT                        MESSAGE\n2m37s       Normal   IssuerUpdated   deployment/linkerd-identity   Updated identity issuer\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6267\u884c\u4e86 <code>Updated identity issuer</code>\u3002</p>"},{"location":"chap11/5linkerd_flow_split/","title":"5 \u5728 Linkerd \u4e2d\u5b9e\u73b0\u6d41\u91cf\u62c6\u5206\u529f\u80fd","text":"<p>\u5728 Linkerd \u4e2d\uff0c\u91d1\u4e1d\u96c0\u53d1\u5e03\u662f\u901a\u8fc7\u6d41\u91cf\u62c6\u5206\u6765\u7ba1\u7406\u7684\uff0c\u8fd9\u9879\u529f\u80fd\u5141\u8bb8\u4f60\u6839\u636e\u53ef\u52a8\u6001\u914d\u7f6e\u7684\u6743\u91cd\uff0c\u5c06\u8bf7\u6c42\u5206\u914d\u7ed9\u4e0d\u540c\u7684 Kubernetes \u670d\u52a1\u5bf9\u8c61\u3002</p> <p>\u867d\u7136\u6d41\u91cf\u5206\u5272\u53ef\u4ee5\u9002\u7528\u4e8e\u4efb\u610f\u7684 Service \u5bf9\u8c61\uff0c\u4f46\u4e00\u822c\u60c5\u51b5\u4e0b\u662f\u5c06\u4e00\u4e2a Service \u7684\u4f20\u5165\u6d41\u91cf\u5206\u7ed9\u4e0d\u540c\u7248\u672c\u7684 Service\u3002</p> <p>\u6d41\u91cf\u5206\u5272\u529f\u80fd\u662f\u901a\u8fc7 Linkerd \u7684 <code>TrafficSplit CRD</code> \u6765\u63a7\u5236\u7684\uff08TrafficSplit CRD \u9075\u5faa\u670d\u52a1\u7f51\u63a5\u53e3\uff08SMI\uff09\u4e2d\u5b9a\u4e49\u7684\u89c4\u8303\uff0c\u8fd9\u662f Linkerd \u5b9e\u73b0\u7684\u51e0\u4e2a SMI API \u4e2d\u7684\u4e00\u4e2a\uff09\u3002</p> <p>\u521b\u5efa TrafficSplit CRD \u5141\u8bb8\u6211\u4eec\u63a7\u5236 Linkerd \u5982\u4f55\u5c06\u6d41\u91cf\u4ee3\u7406\u7ed9 TrafficSplit \u5f15\u7528\u7684\u670d\u52a1\u3002</p> <p>TrafficSplit CRD \u662f\u6839\u636e Kubernetes Service \u5bf9\u8c61\u7f16\u5199\u7684\uff0cTrafficSplit \u63cf\u8ff0\u4e86\u4e00\u4e2a\u4e2d\u5fc3\u6839\u6216 apex \u670d\u52a1\uff0c\u6d41\u91cf\u88ab\u53d1\u9001\u5230\u8be5\u670d\u52a1\uff0c\u4ee5\u53ca\u4e00\u4e2a\u6216\u591a\u4e2a\u5b9e\u9645\u63a5\u6536\u5b83\u7684\u540e\u7aef\u670d\u52a1\uff0c\u4e0e TrafficSplit \u4e2d\u8fd8\u6307\u5b9a\u7684\u6743\u91cd\u6210\u6bd4\u4f8b\u3002</p> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\uff0cKubernetes \u7684 Service \u5bf9\u8c61\u4e0d\u4e00\u5b9a\u6709\u540e\u53f0\u5de5\u4f5c\u8d1f\u8f7d\u3002\u867d\u7136\u8fd9\u5bf9\u4e8e\u666e\u901a\u670d\u52a1\u6765\u8bf4\u5f88\u5c11\u89c1\uff0c\u4f46\u662f\u6211\u4eec\u4f1a\u5728 TrafficSplits \u7684 apex \u670d\u52a1\u4e2d\u5927\u91cf\u4f7f\u7528\u8be5\u529f\u80fd\uff0c\u56e0\u4e3a TrafficSplit \u4f1a\u5bfc\u81f4\u53d1\u5f80 apex \u7684\u6d41\u91cf\u5b9e\u9645\u53d1\u9001\u5230\u540e\u7aef\u670d\u52a1\uff0c\u6240\u4ee5 apex \u5b9e\u9645\u4e0a\u4e0d\u9700\u8981\u62e5\u6709\u81ea\u5df1\u7684 Deployment\u3002</p>"},{"location":"chap11/5linkerd_flow_split/#_1","title":"\u66f4\u65b0\u670d\u52a1","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u8fd8\u662f\u4ee5 Emojivoto \u5e94\u7528\u4e3a\u4f8b\u6765\u521b\u5efa\u4e24\u4e2a\u65b0\u7684 Service \u5bf9\u8c61\uff0capex \u670d\u52a1\u5c06\u6ca1\u6709\u5173\u8054\u7684 Deployment \u8d44\u6e90\uff0c\u7b2c\u4e8c\u9879\u670d\u52a1\u5c06\u662f Emojivoto \u7684 web \u670d\u52a1\u7684\u4e00\u4e2a\u66f4\u65b0\u7248\u672c\uff0c\u4f1a\u5728\u9875\u9762\u9876\u90e8\u6dfb\u52a0\u4e00\u4e9b\u6587\u672c\u4fe1\u606f\u3002</p> <p>\u521b\u5efa\u8fd9\u4e24\u4e2a\u670d\u52a1\u540e\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a TrafficSplit \u8d44\u6e90\uff0c\u8be5\u8d44\u6e90\u4f1a\u5c06\u53d1\u9001\u5230 apex \u670d\u52a1\u7684\u6d41\u91cf\u5728 web \u670d\u52a1\u7684\u539f\u59cb\u7248\u672c\u548c\u66f4\u65b0\u7248\u672c\u4e4b\u95f4\u8fdb\u884c\u62c6\u5206\u3002</p> <p></p> <p>\u66f4\u65b0\u7248\u672c\u7684 web \u670d\u52a1\u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># web-svc-2.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: web-2\n  namespace: emojivoto\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: web-svc-2\n  namespace: emojivoto\nspec:\n  ports:\n    - name: http\n      port: 80\n      targetPort: 8080\n  selector:\n    app: web-svc-2\n  type: ClusterIP\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app.kubernetes.io/name: web-svc-2\n    app.kubernetes.io/part-of: emojivoto\n    app.kubernetes.io/version: linux-training-v2\n  name: web-svc-2\n  namespace: emojivoto\nspec:\n  selector:\n    matchLabels:\n      app: web-svc-2\n      version: linux-training-v2\n  template:\n    metadata:\n      annotations:\n        linkerd.io/inject: enabled # \u8bbe\u7f6e\u81ea\u52a8\u6ce8\u5165\u7684\u6ce8\u89e3\n      labels:\n        app: web-svc-2\n        version: linux-training-v2\n    spec:\n      containers:\n        - env:\n            - name: WEB_PORT\n              value: \"8080\"\n            - name: EMOJISVC_HOST\n              value: emoji-svc.emojivoto:8080\n            - name: VOTINGSVC_HOST\n              value: voting-svc.emojivoto:8080\n            - name: INDEX_BUNDLE\n              value: dist/index_bundle.js\n            - name: MESSAGE_OF_THE_DAY\n              value: \"Welcome to version 2! Now with more words!\"\n          image: buoyantio/emojivoto-web:lf-training\n          name: web-svc-2\n          ports:\n            - containerPort: 8080\n              name: http\n          resources:\n            requests:\n              cpu: 100m\n      serviceAccountName: web-2\n</code></pre> <p>\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f web-svc-2.yaml\nserviceaccount/web-2 created\nservice/web-svc-2 created\ndeployment.apps/web-svc-2 created\n</code></pre> <p>\u90e8\u7f72\u540e\u5148\u9a8c\u8bc1\u66f4\u65b0\u7248\u672c\u7684\u670d\u52a1\u662f\u5426\u5df2\u7ecf\u6b63\u786e\u90e8\u7f72\u4e86\u3002</p> <pre><code>$ kubectl get po --selector app=web-svc-2 -n emojivoto\nNAME                         READY   STATUS    RESTARTS   AGE\nweb-svc-2-f9d77474f-hgsg4    2/2     Running       0      10s\n\n$ kubectl get svc web-svc-2 -n emojivoto\nNAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nweb-svc-2   ClusterIP   10.102.99.153   &lt;none&gt;        80/TCP    3m45s\n</code></pre> <p>\u90e8\u7f72\u6210\u529f\u540e\u540c\u6837\u53ef\u4ee5\u4f7f\u7528 kubectl port-forward \u547d\u4ee4\u6765\u66b4\u9732\u670d\u52a1\uff1a</p> <pre><code>$ kubectl port-forward svc/web-svc-2 8080:80 -n emojivoto\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u901a\u8fc7 <code>localhost:8080</code> \u8bbf\u95ee\u65b0\u7248\u672c\u7684\u5e94\u7528\u3002</p> <p></p> <p>\u5728\u9875\u9762\u9876\u90e8\u53ef\u4ee5\u770b\u5230\u65b0\u7248\u672c\u7684\u5e94\u7528\u591a\u4e86\u4e00\u884c\u5b57\u7b26\u4fe1\u606f\u3002</p>"},{"location":"chap11/5linkerd_flow_split/#trafficsplit","title":"\u521b\u5efa TrafficSplit","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a apex \u670d\u52a1\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06\u5176\u79f0\u4e3a web-apex\uff0c\u4e0d\u8fc7\u8fd9\u6b21\u6ca1\u6709 Pod \u8fd0\u884c\uff0c\u6240\u4ee5\u65e0\u6cd5\u5411\u670d\u52a1\u53d1\u9001\u4efb\u4f55\u8bf7\u6c42\uff0c\u56e0\u4e3a\u6ca1\u6709\u7aef\u70b9\u3002</p> <pre><code># web-apex.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: web-apex\n  namespace: emojivoto\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: web-apex\n  namespace: emojivoto\nspec:\n  ports:\n    - name: http\n      port: 80\n  selector:\n    app: web-apex\n  type: ClusterIP\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f web-apex.yaml\nserviceaccount/web-apex created\nservice/web-apex created\n\n$ kubectl get svc -n emojivoto -o wide\nNAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE   SELECTOR\nemoji-svc    ClusterIP   10.103.235.14    &lt;none&gt;        8080/TCP,8801/TCP   8d    app=emoji-svc\nvoting-svc   ClusterIP   10.102.32.81     &lt;none&gt;        8080/TCP,8801/TCP   8d    app=voting-svc\nweb-apex     ClusterIP   10.104.12.249    &lt;none&gt;        80/TCP              84s   app=web-apex\nweb-svc      ClusterIP   10.106.220.250   &lt;none&gt;        80/TCP              8d    app=web-svc\nweb-svc-2    ClusterIP   10.102.99.153    &lt;none&gt;        80/TCP              27m   app=web-svc-2\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u53ef\u4ee5\u770b\u5230 web-apex \u670d\u52a1\u548c\u5176\u4ed6\u666e\u901a\u670d\u52a1\u4e00\u6837\uff0c\u4f46\u662f\u4ed6\u5e76\u6ca1\u6709\u7aef\u70b9\u3002</p> <pre><code>$ kubectl get ep -n emojivoto\nNAME         ENDPOINTS                             AGE\nemoji-svc    10.244.1.228:8801,10.244.1.228:8080   8d\nvoting-svc   10.244.1.202:8801,10.244.1.202:8080   8d\nweb-apex     &lt;none&gt;                                2m55s\nweb-svc      10.244.1.227:8080                     8d\nweb-svc-2    10.244.1.233:8080                     28m\n</code></pre> <p>\u5728\u7ee7\u7eed\u4e4b\u524d\u6211\u4eec\u53ef\u4ee5\u5148\u770b\u770b\u5f53\u524d\u5e94\u7528\u7684\u6d41\u91cf\u72b6\u6001\uff1a</p> <pre><code>$ linkerd viz stat po -n emojivoto\nNAME                         STATUS   MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN\nemoji-696d9d8f95-5vn9w      Running      1/1   100.00%   2.3rps           1ms           1ms           1ms          4\nvote-bot-6d7677bb68-jvxsg   Running      1/1   100.00%   0.3rps           1ms           1ms           1ms          1\nvoting-ff4c54b8d-xhjv7      Running      1/1    98.04%   0.8rps           1ms           8ms          10ms          4\nweb-5f86686c4d-58p7k        Running      1/1   100.00%   1.4rps           1ms           6ms           9ms          2\n</code></pre> <p>\u53ef\u4ee5\u6e05\u695a\u770b\u5230\u867d\u7136\u6211\u4eec\u5c06 web \u670d\u52a1\u7684\u66f4\u65b0\u7248\u672c\u5df2\u7ecf\u90e8\u7f72\u4e86\uff0c\u4f46\u662f\u73b0\u5728\u6ca1\u6709\u4ea7\u751f\u4efb\u4f55\u7684\u6d41\u91cf\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u53bb\u521b\u5efa\u4e00\u4e2a TrafficSplit \u5bf9\u8c61\uff0c\u7136\u540e\u53bb\u62c6\u5206\u4e00\u90e8\u5206\u6d41\u91cf\u5230\u6211\u4eec\u7684\u65b0\u670d\u52a1\u4e2d\u53bb\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 TrafficSplit \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code># web-svc-ts.yml\napiVersion: split.smi-spec.io/v1alpha2\nkind: TrafficSplit\nmetadata:\n  name: web-svc-ts\n  namespace: emojivoto\nspec:\n  # \u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1\n  service: web-apex\n  # \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service \u4ee5\u53ca\u5b83\u4eec\u81ea\u5df1\u7684 selectors\u3001\u7aef\u70b9\u548c\u914d\u7f6e\u3002\n  backends: # \u62c6\u5206\u7684\u540e\u7aef\u670d\u52a1\n    - service: web-svc\n      weight: 500 # \u6743\u91cd\n    - service: web-svc-2\n      weight: 500\n</code></pre> <p>\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u4e2d\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u5c5e\u6027\uff1a</p> <ul> <li>service\uff1a\u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1</li> <li>backends\uff1a\u547d\u540d\u7a7a\u95f4\u5185\u7684\u670d\u52a1\uff0c\u5177\u6709\u81ea\u5df1\u7684\u9009\u62e9\u5668\u3001\u7aef\u70b9\u548c\u914d\u7f6e\uff08\u6211\u4eec\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u670d\u52a1\u770b\u6210\u53f6\u670d\u52a1\uff09\u3002<ul> <li>service\uff1a\u4e0e\u53ef\u4ee5\u5904\u7406\u8bf7\u6c42\u7684 Pod \u5173\u8054\u5730\u5177\u4f53\u670d\u52a1\u7684\u540d\u79f0\u3002</li> <li>weight\uff1a\u5b83\u4e0e\u5206\u914d\u7ed9\u670d\u52a1\u7684\u603b\u6d41\u91cf\u7684\u767e\u5206\u6bd4\u76f8\u5173\u3002</li> </ul> </li> </ul> <p>\u73b0\u5728\u6211\u4eec\u6765\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f web-svc-ts.yaml\ntrafficsplit.split.smi-spec.io/web-svc-ts created\n\n\n$ kubectl get trafficsplit -n emojivoto\nNAME         SERVICE\nweb-svc-ts   web-apex\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 linkerd viz stat \u547d\u4ee4\u7684\u4e00\u4e2a trafficsplit \u5b50\u547d\u4ee4\uff08\u53ef\u4ee5\u7f29\u5199\u4e3a ts\uff09\uff0c\u6765\u663e\u793a\u6240\u6709\u7684\u6d41\u91cf\u62c6\u5206\u7edf\u8ba1\u4fe1\u606f\u3002</p> <pre><code>$ linkerd viz stat ts -n emojivoto\nStarting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi\n\nNAME         APEX       LEAF        WEIGHT   SUCCESS   RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nweb-svc-ts   web-apex   web-svc        500         -     -             -             -             -\nweb-svc-ts   web-apex   web-svc-2      500         -     -             -             -             -\n</code></pre> <p>\u7531\u4e8e\u6295\u7968\u673a\u5668\u4eba\u914d\u7f6e\u4e3a\u5c06\u6d41\u91cf\u53d1\u9001\u5230 <code>web-svc.emojivoto:80</code>\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u770b\u4e0d\u5230\u4efb\u4f55\u6d41\u91cf\u62c6\u5206\u7684\u6307\u6807\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u5148\u66f4\u65b0\u4e0b <code>vote-bot</code> \u670d\u52a1\u5c06\u6d41\u91cf\u53d1\u9001\u5230 <code>web-apex \u670d\u52a1\uff0c\u800c\u4e0d\u662f</code>web-svc`\u3002</p> <p>\u4ee5\u4e0b kubectl \u547d\u4ee4\u4e2d\u4f7f\u7528\u7684\u6587\u4ef6\u66f4\u6539\u4e86<code>vote-bot</code> \u90e8\u7f72\u4e2d\u7684 <code>WEB_HOST</code> \u73af\u5883\u53d8\u91cf\uff0c\u4ee5\u5c06\u6d41\u91cf\u53d1\u9001\u5230 <code>web-apex</code> \u670d\u52a1\uff0c\u4ece\u800c\u4f7f TrafficSplit \u914d\u7f6e\u751f\u6548\u3002</p> <pre><code>$ kubectl edit deploy vote-bot -n emojivoto\n# ......\n    spec:\n      containers:\n      - command:\n        - emojivoto-vote-bot\n        env:\n        - name: WEB_HOST\n          value: web-apex.emojivoto:80\n        image: docker.l5d.io/buoyantio/emojivoto-web:v11\n        imagePullPolicy: IfNotPresent\n        name: vote-bot\n# ......\n</code></pre> <p>\u66f4\u65b0\u540e\u65b0\u7684 vote-bot \u670d\u52a1\u5c06\u5411 web-apex \u670d\u52a1\u53d1\u51fa\u8bf7\u6c42\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684 trafficsplit \u5b50\u547d\u4ee4\u518d\u6b21\u6765\u9a8c\u8bc1\uff1a</p> <pre><code>$ linkerd viz stat ts -n emojivoto\nStarting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi\n\nNAME         APEX       LEAF        WEIGHT   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nweb-svc-ts   web-apex   web-svc        500    90.32%   1.0rps           3ms           9ms          10ms\nweb-svc-ts   web-apex   web-svc-2      500    96.49%   0.9rps           1ms           5ms           5ms\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u53ef\u4ee5\u770b\u5230 web-apex \u670d\u52a1\u662f web-svc \u548c web-svc-2 \u670d\u52a1\u7684 APEX \u670d\u52a1\uff0c\u5b83\u4eec\u81ea\u5df1\u5219\u662f LEAF \u670d\u52a1\uff0c\u8f93\u51fa\u7ed3\u679c\u8fd8\u663e\u793a\u4e86\u6bcf\u4e2a\u670d\u52a1\u7684\u6743\u91cd\u5206\u5e03\u3002</p>"},{"location":"chap11/5linkerd_flow_split/#_2","title":"\u8c03\u6574\u6743\u91cd","text":"<p>\u63a5\u7740\u6211\u4eec\u518d\u7528 linkerd viz stat \u547d\u4ee4\u6765\u67e5\u770b\u4e0b\u5e94\u7528\u7684\u6d41\u91cf\u60c5\u51b5\uff0c\u4e0a\u4e00\u6b21\u6211\u4eec\u67e5\u770b\u7684\u65f6\u5019 web-svc-2 \u670d\u52a1\u5173\u8054\u7684 Pod \u6ca1\u6709\u6536\u5230\u4efb\u4f55\u6d41\u91cf\u3002</p> <pre><code>$ linkerd viz stat pod -n emojivoto\nNAME                         STATUS   MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN\nemoji-696d9d8f95-5vn9w      Running      1/1   100.00%   2.3rps           1ms           2ms           3ms          5\nvote-bot-646b9fd6fd-js526   Running      1/1   100.00%   0.3rps           1ms           1ms           1ms          1\nvoting-ff4c54b8d-xhjv7      Running      1/1    89.74%   1.3rps           1ms           7ms           9ms          5\nweb-5f86686c4d-58p7k        Running      1/1    97.33%   1.2rps           2ms           9ms          10ms          3\nweb-svc-2-f9d77474f-hgsg4   Running      1/1    92.31%   1.3rps           1ms           6ms           9ms          3\n</code></pre> <p>\u8fd9\u6b21\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0e web-svc \u548c web-svc-2 \u76f8\u5173\u7684\u4e24\u4e2a Pod \u90fd\u5728\u5904\u7406\u8bf7\u6c42\u4e86\u3002\u8bc1\u660e\u6211\u4eec\u7684\u6d41\u91cf\u62c6\u5206\u914d\u7f6e\u662f\u6b63\u786e\u7684\u3002</p> <p>TrafficSplit \u5b9a\u4e49\u4e2d\u5c06\u6bcf\u4e2a\u670d\u52a1\u7684\u6743\u91cd\u8bbe\u7f6e\u4e3a 500\uff0c\u4ee5\u5e73\u5747\u5206\u914d\u6d41\u91cf\u3002\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u5c06 web-svc-2 \u7684\u6743\u91cd\u8bbe\u7f6e\u4e3a 1%\u7684\u6216\u8005\u5f88\u4f4e\u7684\u6743\u91cd\u5f00\u59cb\uff0c\u4ee5\u786e\u4fdd\u6ca1\u6709\u9519\u8bef\uff0c\u7136\u540e\u5f53\u6211\u4eec\u786e\u5b9a\u65b0\u7248\u672c\u6ca1\u6709\u95ee\u9898\u540e\uff0c\u53ef\u4ee5\u8c03\u6574\u6162\u6162\u8c03\u6574\u6bcf\u4e2a\u670d\u52a1\u7684\u6743\u91cd\uff0c\u5230\u6700\u7ec8\u6240\u6709\u6d41\u91cf\u90fd\u5207\u6362\u5230\u65b0\u7248\u672c\u4e0a\u9762\u53bb\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u624b\u52a8\u7f16\u8f91 TrafficSplit \u5bf9\u8c61\u6765\u624b\u52a8\u8c03\u6574\u8fd9\u4e24\u4e2a\u670d\u52a1\u7684\u6743\u91cd\u3002\u5c06 75% \u7684\u6d41\u91cf\u53d1\u9001\u5230 web-svc-2\uff0c\u5c06 25% \u7684\u6d41\u91cf\u53d1\u9001\u5230 web-svc\u3002</p> <pre><code># web-svc-ts-2.yml\napiVersion: split.smi-spec.io/v1alpha2\nkind: TrafficSplit\nmetadata:\n  name: web-svc-ts\n  namespace: emojivoto\nspec:\n  # \u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1\n  service: web-apex\n  # \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service \u4ee5\u53ca\u5b83\u4eec\u81ea\u5df1\u7684 selectors\u3001\u7aef\u70b9\u548c\u914d\u7f6e\u3002\n  backends: # \u62c6\u5206\u7684\u540e\u7aef\u670d\u52a1\n    - service: web-svc\n      weight: 250 # \u6743\u91cd\n    - service: web-svc-2\n      weight: 750\n</code></pre> <p>\u66f4\u65b0\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u540e\uff0c\u518d\u6b21\u67e5\u770b\u6d41\u91cf\u62c6\u5206\u7684\u60c5\u51b5\u3002</p> <pre><code>$ linkerd viz stat ts -n emojivoto\nStarting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi\n\nNAME         APEX       LEAF        WEIGHT   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nweb-svc-ts   web-apex   web-svc        250    87.88%   0.6rps           6ms          17ms          20ms\nweb-svc-ts   web-apex   web-svc-2      750    94.12%   1.4rps           2ms           8ms          10ms\n</code></pre> <p>\u5728\u8f93\u51fa\u4e2d\uff0c\u4f60\u5c06\u770b\u5230 WEIGHT \u5217\u4e0e\u4e0a\u9762\u7684\u53d8\u66f4\u76f8\u5339\u914d\uff0cweb-svc-2 \u4e3a 750\u3001web-svc \u4e3a 250\u3002\u63a5\u7740\u6211\u4eec\u518d\u66f4\u6539 TrafficSplit \u5bf9\u8c61\uff0c\u5c06\u6240\u6709\u6d41\u91cf\u53d1\u9001\u5230 web-svc-2 \u670d\u52a1\u53bb\u3002</p> <pre><code># web-svc-ts-3.yml\napiVersion: split.smi-spec.io/v1alpha2\nkind: TrafficSplit\nmetadata:\n  name: web-svc-ts\n  namespace: emojivoto\nspec:\n  # \u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1\n  service: web-apex\n  # \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service \u4ee5\u53ca\u5b83\u4eec\u81ea\u5df1\u7684 selectors\u3001\u7aef\u70b9\u548c\u914d\u7f6e\u3002\n  backends: # \u62c6\u5206\u7684\u540e\u7aef\u670d\u52a1\n    - service: web-svc\n      weight: 0 # \u6743\u91cd\n    - service: web-svc-2\n      weight: 1\n</code></pre> <p>\u66f4\u65b0\u540e\u6211\u4eec\u518d\u6b21\u67e5\u770b\u6d41\u91cf\u62c6\u5206\u60c5\u51b5\uff1a</p> <pre><code>$ linkerd viz stat ts -n emojivoto\nStarting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi\n\nNAME         APEX       LEAF        WEIGHT   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99\nweb-svc-ts   web-apex   web-svc          0         -        -             -             -             -\nweb-svc-ts   web-apex   web-svc-2        1    99.15%   1.9rps           2ms           3ms           3ms\n</code></pre> <p>\u6b63\u5e38\u6211\u4eec\u53ef\u4ee5\u770b\u5230 web-svc-2 \u670d\u52a1\u5bf9\u5e94\u7684 WEIGHT \u4e3a 1\uff0c\u800c web-svc \u4e3a 0\u3002</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u4e2d\u7684\u6d41\u91cf\u62c6\u5206\u7684\u4f7f\u7528\uff0c\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u4e00\u4e2a\u5355\u72ec\u7684 web-apex \u670d\u52a1\uff0c\u5f53\u7136 apex \u670d\u52a1\u4e5f\u53ef\u4ee5\u662f\u540e\u7aef\u4e4b\u4e00\u7684\u670d\u52a1\uff0capex \u548c\u540e\u7aef\u4e4b\u4e00\u5177\u6709\u76f8\u540c\u670d\u52a1\u7684 TrafficSplit \u4f1a\u5c06\u53d1\u5f80\u8be5\u670d\u52a1\u7684\u6d41\u91cf\u53d1\u9001\u5230\u8be5\u670d\u52a1\uff0c\u4f46\u4f1a\u4e0e\u5176\u4f59\u540e\u7aef\u670d\u52a1\u6210\u6bd4\u4f8b\uff0c\u8fd9\u662f\u53ef\u4ee5\u52a8\u6001\u5b8c\u6210\u7684\uff0c\u5141\u8bb8\u4f60\u5728\u73b0\u6709\u670d\u52a1\u4e4b\u4e0a\u63d2\u5165\u4e00\u4e2a TrafficSplit\u3002</p> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u5730\u4f7f\u7528 web-svc \u4f5c\u4e3a apex\uff08\u5e76\u7ee7\u7eed\u4f7f\u7528\u5b83\u4ee5\u53ca web-svc-2 \u4f5c\u4e3a\u540e\u7aef\uff09\uff0c\u800c\u4e0d\u662f\u4f7f\u7528 web-apex\u3002\u5728\u521b\u5efa TrafficSplit \u7684\u90a3\u4e00\u523b\uff0c\u5230 web-svc \u7684\u73b0\u6709\u6d41\u91cf\u5c06\u9075\u5faa TrafficSplit \u7684\u89c4\u5219\uff1b\u5e76\u4e14\u5728\u5b83\u88ab\u5220\u9664\u7684\u90a3\u4e00\u523b\uff0c\u5230 web-svc \u7684\u6d41\u91cf\u5c06\u6062\u590d\u6b63\u5e38\u3002</p> <p>\u5728\u5b9e\u8df5\u4e2d\u6211\u4eec\u5f80\u5f80\u8fd8\u4f1a\u5c06 Linkerd \u7684\u6d41\u91cf\u62c6\u5206\u529f\u80fd\u4e0e CI/CD \u7cfb\u7edf\u8fdb\u884c\u96c6\u6210\uff0c\u4ee5\u81ea\u52a8\u5316\u53d1\u5e03\u8fc7\u7a0b\uff0cLinkerd \u672c\u8eab\u5c31\u63d0\u4f9b\u4e86\u76f8\u5173\u6307\u6807\uff0c\u8fd9\u7ed3\u5408\u8d77\u6765\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u5b9e\u73b0\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u4e86\uff1a\u901a\u8fc7\u5c06\u6307\u6807\u548c\u6d41\u91cf\u62c6\u5206\u6346\u7ed1\u5728\u4e00\u8d77\uff0c\u53ef\u4ee5\u4ee5\u589e\u91cf\u3001\u5b89\u5168\u548c\u5b8c\u5168\u81ea\u52a8\u5316\u7684\u65b9\u5f0f\u53d1\u5e03\u65b0\u4ee3\u7801\uff0c\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u8fc7 Argo Rollouts\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528\u50cf https://flagger.app/ \u8fd9\u6837\u7684\u9879\u76ee\uff0c\u56e0\u4e3a\u5b83\u662f\u5efa\u7acb\u5728 Linkerd \u7684\u6307\u6807\u548c\u6d41\u91cf\u62c6\u5206\u529f\u80fd\u4e4b\u4e0a\u6765\u6267\u884c\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u7684\u3002</p>"},{"location":"chap11/6linkered_prod/","title":"6 \u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528 Linkerd","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u4e00\u76f4\u5728\u4ee5\u6700\u57fa\u672c\u7684\u5f62\u5f0f\u4f7f\u7528 Linkerd\uff0c\u800c\u6ca1\u6709\u5173\u6ce8\u751f\u4ea7\u7ea7\u522b\u7684\u76f8\u5173\u95ee\u9898\u3002\u672c\u8282\u6211\u4eec\u5c06\u4e86\u89e3\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u7684\u4e00\u4e9b\u4e3b\u8981\u6ce8\u610f\u4e8b\u9879\uff0c\u5305\u62ec\u9ad8\u53ef\u7528 (HA) \u6a21\u5f0f\u3001Helm Chart\u3001\u8de8\u96c6\u7fa4\u901a\u4fe1\u548c\u5916\u90e8 Prometheus\u3002</p>"},{"location":"chap11/6linkered_prod/#_1","title":"\u9ad8\u53ef\u7528","text":"<p>\u9ad8\u53ef\u7528\u63cf\u8ff0\u4e86\u5177\u6709\u5197\u4f59\u67b6\u6784\u7684\u7cfb\u7edf\uff0c\u5982\u679c\u7cfb\u7edf\u7684\u67d0\u4e9b\u90e8\u5206\u51fa\u73b0\u6545\u969c\uff0c\u8be5\u7cfb\u7edf\u5c06\u7ee7\u7eed\u8fd0\u884c\u3002Linkerd \u7684\u9ad8\u53ef\u7528\u6a21\u5f0f\u65e8\u5728\u6d88\u9664\u63a7\u5236\u5e73\u9762\u7684\u5355\u70b9\u6545\u969c\u3002</p> <p>\u542f\u7528 HA \u6a21\u5f0f\u7684\u4e00\u79cd\u65b9\u6cd5\u662f\u4e3a <code>linkerd install</code> \u6307\u5b9a <code>--ha</code> \u6807\u5fd7\uff0c\u6b64\u6807\u5fd7\u542f\u7528\u51e0\u79cd\u4e0d\u540c\u7684\u884c\u4e3a\u3002\u5b83\u53ef\u4ee5\u90e8\u7f72\u67d0\u4e9b Linkerd \u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u7684\u591a\u4e2a\u526f\u672c\uff1a</p> <ul> <li>Controller</li> <li>Destination</li> <li>Identity</li> <li>Proxy Injector</li> <li>Service Profile Validator</li> </ul> <p>\u8bf7\u6ce8\u610f\uff0c\u5176\u4ed6\u7ec4\u4ef6\uff0c\u4f8b\u5982 Grafana\u3001Prometheus\uff0c\u4e0d\u88ab\u770b\u6210\u6838\u5fc3\u7684\u5173\u952e\u7ec4\u4ef6\uff0c\u56e0\u6b64\u4e0d\u4f1a\u914d\u7f6e\u591a\u526f\u672c\uff08\u5982\u679c\u6ca1\u6709\u8fd9\u4e9b\u7ec4\u4ef6\uff0c\u6570\u636e\u5e73\u9762\u4ecd\u7136\u53ef\u4ee5\u7ee7\u7eed\u6b63\u5e38\u8fd0\u884c\uff09\u3002</p> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f HA \u6a21\u5f0f\u6709\u4e00\u4e9b\u7ec6\u5fae\u7684\u533a\u522b\uff0c\u9996\u5148 HA \u6a21\u5f0f\u6539\u53d8\u4e86 proxy injector \u7684\u65b9\u5f0f\uff0c\u5f3a\u5236\u8981\u6c42\u5728\u6709\u9002\u5f53\u6ce8\u89e3\u7684\u60c5\u51b5\u4e0b\u6ce8\u5165\u4ee3\u7406\u3002</p> <p>\u8fd9\u662f\u4e3a\u4e86\u786e\u4fdd\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u4f7f\u7528 Linkerd \u8fdb\u884c mTLS \u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4f9d\u8d56\u8be5\u4ee3\u7406\uff0c\u5f53\u7136\u5982\u679c Linkerd \u7684 proxy injector \u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u4e0d\u53ef\u7528\u4e86\uff0c\u5219\u5c31\u65e0\u6cd5\u521b\u5efa Pod \u4e86\u3002</p> <p>\u6bd4\u5982 kube-system \u547d\u540d\u7a7a\u95f4\u5c31\u4f1a\u51fa\u73b0\u95ee\u9898\uff0c\u56e0\u6b64\u4f7f\u7528 HA \u6a21\u5f0f\u9700\u8981\u5c06\u6807\u7b7e <code>config.linkerd.io/admission-webhooks: disabled</code>\u6dfb\u52a0\u5230 <code>kube-system</code> \u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u4ee5\u5141\u8bb8\u521b\u5efa Kubernetes \u7ec4\u4ef6\uff0c\u5373\u4f7f Linkerd \u51fa\u73b0\u67d0\u79cd\u95ee\u9898\uff0c\u4f46\u4e5f\u4e0d\u7528\u592a\u62c5\u5fc3\uff0c\u5f53\u5728 HA \u6a21\u5f0f\u4e0b\u8fd0\u884c\u65f6\uff0c\u5f53\u6807\u7b7e\u4e0d\u5728 <code>kube-system</code> \u547d\u540d\u7a7a\u95f4\u4e0a\u65f6\uff0c<code>linkerd check</code>\u547d\u4ee4\u4e5f\u4f1a\u6253\u5370\u51fa\u4e00\u6761\u544a\u8b66\u4fe1\u606f\u3002</p>"},{"location":"chap11/6linkered_prod/#helm-chart","title":"Helm Chart","text":"<p>\u4e00\u822c\u6765\u8bf4\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4e0d\u63a8\u8350\u4f7f\u7528 Linkerd CLI \u5de5\u5177\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u800c\u66f4\u63a8\u8350\u4f7f\u7528 Helm \u4e4b\u7c7b\u7684\u5de5\u5177\u8fdb\u884c\u5b89\u88c5\u3002Linkerd \u4e3a\u666e\u901a\u6a21\u5f0f\u548c HA \u6a21\u5f0f\u63d0\u4f9b\u4e86 Helm Chart\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e2a\u540d\u4e3a values-ha.yaml \u7684\u6a21\u677f\uff0c\u53ef\u4ee5\u5c06\u5176\u7528\u4f5c\u5411\u96c6\u7fa4\u90e8\u7f72\u9ad8\u53ef\u7528\u6027\u7684\u57fa\u7840\uff0cHelm \u5bf9\u4e8e\u5728\u65b0\u521b\u5efa\u7684\u96c6\u7fa4\u4e0a\u81ea\u52a8\u914d\u7f6e Linkerd \u7279\u522b\u6709\u7528\u3002</p> <p></p> <p>\u9700\u8981\u6ce8\u610f\u7684\u4e00\u70b9\u662f\uff0cHelm \u7684\u5b89\u88c5\u8fc7\u7a0b\u4e0d\u4f1a\u50cf linkerd install \u547d\u4ee4\u90a3\u6837\u4e3a\u4f60\u751f\u6210\u8bc1\u4e66\uff0c\u6240\u4ee5\u9700\u8981\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u81ea\u5df1\u7684\u8bc1\u4e66\uff0c\u524d\u9762 mTLS \u7ae0\u8282\u5df2\u7ecf\u4ecb\u7ecd\u8fc7\u3002</p> <p>\u65e0\u8bba\u4f60\u662f\u5426\u4f7f\u7528 Helm \u5b89\u88c5\uff0c\u662f\u5426\u5728 HA \u6a21\u5f0f\u4e0b\u5b89\u88c5\uff0c\u5bf9\u4e8e\u751f\u4ea7\u7cfb\u7edf\u6765\u8bf4\uff0c\u4f60\u90fd\u5e94\u8be5\u81ea\u5df1\u751f\u6210\u6839\u8bc1\u4e66\u548c\u7b7e\u53d1\u8005\u8bc1\u4e66\u3002\u521b\u5efa\u4f60\u81ea\u5df1\u7684\u4fe1\u4efb\u951a\uff0c\u53ef\u4ee5\u8ba9\u4f60\u907f\u514d\u624b\u52a8\u8f6e\u8f6c\u7684\u9ebb\u70e6\uff08\u6211\u4eec\u5efa\u8bae\u5c06\u8fc7\u671f\u65f6\u95f4\u8bbe\u7f6e\u4e3a 10 \u5e74\uff0c\u800c\u4e0d\u662f\u9ed8\u8ba4\u7684 1 \u5e74\uff09\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u672a\u6765\u7684\u96c6\u7fa4\u751f\u6210\u7b7e\u53d1\u8005\u8bc1\u4e66\uff0c\u8bf7\u786e\u4fdd\u5c06\u79c1\u94a5\u5b58\u653e\u5728\u4e00\u4e2a\u5b89\u5168\u7684\u5730\u65b9!</p>"},{"location":"chap11/6linkered_prod/#prometheus","title":"Prometheus \u6307\u6807","text":"<p>Linkerd \u63a7\u5236\u5e73\u9762\u5305\u542b\u4e00\u4e2a Prometheus \u7684\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u4e2d\u7684\u6570\u636e\u88ab\u7528\u6765\u4e3a Linkerd \u4eea\u8868\u677f\u4ee5\u53ca linkerd viz stat \u7b49\u547d\u4ee4\u7684\u8f93\u51fa\u63d0\u4f9b\u652f\u6301\u3002</p> <p>Linkerd \u63a7\u5236\u5e73\u9762\u5305\u542b\u4e00\u4e2a Prometheus \u7684\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u4e2d\u7684\u6570\u636e\u88ab\u7528\u6765\u4e3a Linkerd \u4eea\u8868\u677f\u4ee5\u53ca linkerd viz stat \u7b49\u547d\u4ee4\u7684\u8f93\u51fa\u63d0\u4f9b\u652f\u6301\u3002</p> <p>\u8be5\u5b9e\u4f8b\u9ed8\u8ba4\u53ea\u4fdd\u7559\u6700\u8fd1 6 \u5c0f\u65f6\u7684\u6307\u6807\u6570\u636e\uff0c\u751f\u4ea7\u73af\u5883\u5f80\u5f80\u9700\u8981\u5728\u66f4\u957f\u7684\u65f6\u95f4\u5185\u8bbf\u95ee\u6307\u6807\uff0c\u6bd4\u5982 1 \u5468\u30011 \u4e2a\u6708\u751a\u81f3 1 \u5e74\u3002\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u91cd\u65b0\u914d\u7f6e\u4e0b\u8be5 Prometheus \u5b9e\u4f8b\uff0c\u63d0\u9ad8\u4e0b\u6570\u636e\u4fdd\u7559\u65f6\u957f\uff0c\u4f46\u662f\u663e\u7136\u8fd9\u662f\u4e0d\u88ab\u63a8\u8350\u7684\u4e00\u79cd\u65b9\u6cd5\uff0c\u6700\u4f73\u7684\u505a\u6cd5\u662f\u5c06\u6307\u6807\u4ece Linkerd \u7684\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\u7684 Prometheus \u8f93\u51fa\u5230\u4e00\u4e2a\u4e13\u95e8\u7684\u8fdc\u7a0b\u5b58\u50a8\u4e2d\u53bb\uff0c\u6bd4\u5982 Cortex\u3001Thanos \u6216\u8005 Victoriametrics\uff0c\u6839\u636e\u524d\u9762\u6211\u4eec\u7684\u5bf9 Prometheus \u7684\u5b66\u4e60\u66f4\u52a0\u63a8\u8350\u4f7f\u7528 Victoriametrics\u3002</p> <p>\u5982\u679c\u4f60\u73b0\u5728\u5df2\u7ecf\u6709\u4e00\u4e2a\u53ef\u7528\u7684 Prometheus \u96c6\u7fa4\u4e86\uff0c\u90a3\u4e48\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u914d\u7f6e\u8ba9 Linkerd \u6765\u4f7f\u7528\u5916\u90e8\u7684 Prometheus \u5b9e\u4f8b\uff0c\u540c\u6837\u53ef\u4ee5\u83b7\u53d6 Linkerd \u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u548c\u4ee3\u7406\u7684\u76f8\u5173\u6307\u6807\u3002</p>"},{"location":"chap11/6linkered_prod/#prometheus_1","title":"\u914d\u7f6e\u5916\u90e8 Prometheus","text":"<p>\u5982\u679c\u8981\u4f7f\u7528\u5916\u90e8\u7684 Prometheus \u5219\u9700\u8981\u5728\u5916\u90e8 Prometheus \u4e2d\u6dfb\u52a0\u5982\u4e0b\u6293\u53d6\u914d\u7f6e\uff1a</p> <pre><code>- job_name: \"grafana\"\n  kubernetes_sd_configs:\n    - role: pod\n      namespaces:\n        names: [\"linkerd-viz\"]\n  relabel_configs:\n    - source_labels:\n        - __meta_kubernetes_pod_container_name\n      action: keep\n      regex: ^grafana$\n- job_name: \"linkerd-controller\"\n  relabel_configs:\n    - source_labels:\n        - __meta_kubernetes_pod_container_port_name\n      action: keep\n      regex: admin-http\n    - source_labels: [__meta_kubernetes_pod_container_name]\n      action: replace\n      target_label: component\n  kubernetes_sd_configs:\n    - role: pod\n      namespaces:\n        names:\n          - \"linkerd\"\n          - \"linkerd-viz\"\n- job_name: \"linkerd-service-mirror\"\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - source_labels:\n        - __meta_kubernetes_pod_label_linkerd_io_control_plane_component\n        - __meta_kubernetes_pod_container_port_name\n      action: keep\n      regex: linkerd-service-mirror;admin-http$\n    - source_labels: [__meta_kubernetes_pod_container_name]\n      action: replace\n      target_label: component\n- job_name: \"linkerd-proxy\"\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - source_labels:\n        - __meta_kubernetes_pod_container_name\n        - __meta_kubernetes_pod_container_port_name\n        - __meta_kubernetes_pod_label_linkerd_io_control_plane_ns\n      action: keep\n      regex: ^linkerd-proxy;linkerd-admin;linkerd$\n    - source_labels: [__meta_kubernetes_namespace]\n      action: replace\n      target_label: namespace\n    - source_labels: [__meta_kubernetes_pod_name]\n      action: replace\n      target_label:\n        pod\n        # special case k8s' \"job\" label, to not interfere with prometheus' \"job\"\n        # label\n        # __meta_kubernetes_pod_label_linkerd_io_proxy_job=foo =&gt;\n        # k8s_job=foo\n    - source_labels: [__meta_kubernetes_pod_label_linkerd_io_proxy_job]\n      action: replace\n      target_label:\n        k8s_job\n        # drop __meta_kubernetes_pod_label_linkerd_io_proxy_job\n    - action: labeldrop\n      regex:\n        __meta_kubernetes_pod_label_linkerd_io_proxy_job\n        # __meta_kubernetes_pod_label_linkerd_io_proxy_deployment=foo =&gt;\n        # deployment=foo\n    - action: labelmap\n      regex:\n        __meta_kubernetes_pod_label_linkerd_io_proxy_(.+)\n        # drop all labels that we just made copies of in the previous labelmap\n    - action: labeldrop\n      regex:\n        __meta_kubernetes_pod_label_linkerd_io_proxy_(.+)\n        # __meta_kubernetes_pod_label_linkerd_io_foo=bar =&gt;\n        # foo=bar\n    - action: labelmap\n      regex:\n        __meta_kubernetes_pod_label_linkerd_io_(.+)\n        # Copy all pod labels to tmp labels\n    - action: labelmap\n      regex: __meta_kubernetes_pod_label_(.+)\n      replacement:\n        __tmp_pod_label_$1\n        # Take `linkerd_io_` prefixed labels and copy them without the prefix\n    - action: labelmap\n      regex: __tmp_pod_label_linkerd_io_(.+)\n      replacement:\n        __tmp_pod_label_$1\n        # Drop the `linkerd_io_` originals\n    - action: labeldrop\n      regex:\n        __tmp_pod_label_linkerd_io_(.+)\n        # Copy tmp labels into real labels\n    - action: labelmap\n      regex: __tmp_pod_label_(.+)\n</code></pre> <p>\u4e0a\u9762\u7684\u6293\u53d6\u914d\u7f6e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>kubectl get cm -n linkerd-viz prometheus-config -o yaml</code> \u83b7\u53d6\u5b8c\u6574\u7684\u914d\u7f6e\uff0c\u6293\u53d6\u914d\u7f6e\u66f4\u65b0\u5b8c\u6210\u540e\u786e\u4fdd Prometheus \u53ef\u4ee5\u6293\u53d6\u5230\u76f8\u5173\u6307\u6807\u6570\u636e\u3002</p> <p></p> <p>Linkerd \u7684 viz \u6269\u5c55\u7ec4\u4ef6\u4f9d\u8d56\u4e8e Prometheus \u5b9e\u4f8b\u6765\u4e3a\u4eea\u8868\u677f\u548c CLI \u63d0\u4f9b\u6570\u636e\u3002</p> <p>\u5b89\u88c5\u7684\u65f6\u5019\u6709\u4e00\u4e2a prometheusUrl \u5b57\u6bb5\u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u5916\u90e8 Prometheus \u7684\u5730\u5740\uff0c\u6240\u6709\u8fd9\u4e9b\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u901a\u8fc7\u8be5\u53c2\u6570\u914d\u7f6e\u5230\u5916\u90e8 Prometheus URL\u3002</p> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u4f7f\u7528\u5916\u90e8 Prometheus \u5e76\u914d\u7f6e prometheusUrl \u5b57\u6bb5\u65f6\uff0cLinkerd \u7684 Prometheus \u4ecd\u7136\u4f1a\u5305\u542b\u5728\u5b89\u88c5\u4e2d\u3002\u5982\u679c\u60a8\u60f3\u7981\u7528\u5b83\uff0c\u8bf7\u52a1\u5fc5\u540c\u65f6\u5305\u542b\u4ee5\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>prometheus:\n  enabled: false\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5728 kube-mon \u547d\u540d\u7a7a\u95f4\u4e2d\u6709\u4e00\u4e2a\u53ef\u7528\u7684 Prometheus \u5b9e\u4f8b\uff0c\u5219\u53ef\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u8fdb\u884c\u66ff\u6362\uff1a</p> <pre><code>$ kubectl get svc prometheus -n kube-mon\nNAME         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nprometheus   NodePort   10.100.236.253   &lt;none&gt;        9090:31561/TCP   60d\n$ linkerd viz install --set prometheusUrl=http://prometheus.kube-mon.svc.cluster.local:9090,prometheus.enabled=false | kubectl apply -f -\n</code></pre> <p>\u5982\u679c\u4f7f\u7528\u7684\u662f Helm \u8fdb\u884c\u5b89\u88c5\u7684\u5219\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 values \u6587\u4ef6\u6765\u8fdb\u884c\u914d\u7f6e\u3002\u66f4\u65b0\u540e\u91cd\u65b0\u67e5\u770b Linkerd \u7684 Dashboard \u4f9d\u65e7\u53ef\u4ee5\u770b\u5230\u5e94\u7528\u7684\u76f8\u5173\u6307\u6807\u6570\u636e\u3002</p> <p></p> <p>\u5305\u62ec Grafana \u7684\u56fe\u8868\u4e5f\u662f\u6b63\u5e38\u663e\u793a\u7684\u3002</p> <p></p> <p>\u8fd9\u6837\u5bf9\u4e8e Prometheus \u6307\u6807\u6570\u636e\u4fdd\u5b58\u591a\u957f\u65f6\u95f4\u6216\u8005\u5982\u4f55\u4fdd\u5b58\u5c31\u662f\u4f9d\u9760\u6211\u4eec\u7684\u5916\u90e8 Prometheus \u81ea\u8eab\u53bb\u5b9e\u73b0\u4e86\uff0c\u8fd9\u5f53\u7136\u964d\u4f4e\u4e86 Linkerd \u81ea\u8eab\u7684\u590d\u6742\u6027\u3002</p>"},{"location":"chap11/6linkered_prod/#_2","title":"\u591a\u96c6\u7fa4\u901a\u4fe1","text":"<p>inkerd \u652f\u6301\u591a\u96c6\u7fa4\u901a\u4fe1\uff0c\u8fd9\u4e00\u529f\u80fd\u5141\u8bb8\u670d\u52a1\u5728 Kubernetes \u96c6\u7fa4\u95f4\u900f\u660e\u5730\u8fdb\u884c\u901a\u4fe1\u3002\u542f\u7528\u8be5\u529f\u80fd\u540e\uff0c\u5982\u679c\u670d\u52a1 A \u4e0e\u670d\u52a1 B \u901a\u4fe1\uff0c\u5b83\u4e0d\u9700\u8981\u77e5\u9053 B \u662f\u5728\u540c\u4e00\u4e2a\u96c6\u7fa4\u8fd8\u662f\u4e0d\u540c\u7684\u96c6\u7fa4\u4e0a\u8fd0\u884c\uff0c\u662f\u5728\u540c\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3\u8fd8\u662f\u5728\u4e92\u8054\u7f51\u4e0a\u3002\u540c\u6837\u7684 mTLS\u3001\u6307\u6807\u548c\u53ef\u9760\u6027\u529f\u80fd\u5728\u96c6\u7fa4\u5185\u548c\u8de8\u96c6\u7fa4\u7684\u901a\u4fe1\u4e2d\u90fd\u662f\u7edf\u4e00\u5e94\u7528\u7684\u3002\u4e8b\u5b9e\u4e0a\uff0c\u5f53\u4e0e\u6d41\u91cf\u5206\u5272\u76f8\u7ed3\u5408\u65f6\uff0c\u670d\u52a1 B \u53ef\u4ee5\u4ece\u672c\u5730\u96c6\u7fa4\u8fc1\u79fb\u6216\u6545\u969c\u8f6c\u79fb\u5230\u8fdc\u7a0b\u96c6\u7fa4\uff0c\u6216\u8de8\u8d8a\u72ec\u7acb\u7684\u8fdc\u7a0b\u96c6\u7fa4\u3002</p> <p>Linkerd \u591a\u96c6\u7fa4\u7ec4\u4ef6\u4f7f\u7528 <code>linkerd multi-cluster install</code> \u547d\u4ee4\u4e0e\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u5206\u5f00\u5b89\u88c5\uff0c</p> <p>\u6b64\u547d\u4ee4\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>linkerd-multi-cluster</code>\u7684\u547d\u540d\u7a7a\u95f4\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u4e2a\u7ec4\u4ef6\uff1a<code>service-mirror</code>\u548c <code>linkerd-gateway</code>\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u7528\u4e8e\u786e\u4fdd\u4e24\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u8fde\u63a5\u7684\u5065\u5eb7\uff0c\u5e76\u4e3a\u8fdc\u7a0b\u6216\u76ee\u6807\u96c6\u7fa4\u4e0a\u5b58\u5728\u7684\u670d\u52a1\u8def\u7531\u6d41\u91cf\u3002</p> <p>\u6bcf\u4e2a\u53c2\u4e0e\u7684\u96c6\u7fa4\u90fd\u5fc5\u987b\u5728\u5b89\u88c5\u4e86\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u60c5\u51b5\u4e0b\u8fd0\u884c Linkerd \u63a7\u5236\u5e73\u9762\u3002\u8fd9\u5c31\u6d88\u9664\u4e86\u4efb\u4f55\u4e00\u4e2a\u96c6\u7fa4\u7684\u5355\u70b9\u6545\u969c\uff1a\u5982\u679c\u4e00\u4e2a\u96c6\u7fa4\u88ab\u79fb\u9664\u3001\u5d29\u6e83\u6216\u53d8\u5f97\u4e0d\u53ef\u7528\uff0c\u5176\u4f59\u7684\u96c6\u7fa4\u548c\u63a7\u5236\u5e73\u9762\u5c06\u7ee7\u7eed\u8fd0\u4f5c\u3002</p> <p>\u591a\u96c6\u7fa4\u8bbe\u7f6e\u4e2d\u6700\u56f0\u96be\u7684\u90e8\u5206\u662f mTLS \u57fa\u7840\u8bbe\u65bd\uff1a\u6bcf\u4e2a\u96c6\u7fa4\u4e0a\u7684\u9881\u53d1\u8005\u8bc1\u4e66\u5fc5\u987b\u7531\u540c\u4e00\u4e2a\u4fe1\u4efb\u6839\u7b7e\u7f72\u3002\u8fd9\u610f\u5473\u7740\u7b80\u5355\u5730\u8fd0\u884c linkerd install \u8fdb\u884c\u5b89\u88c5\u4f1a\u6709\u95ee\u9898\uff0c\u9700\u8981\u6307\u5b9a\u540c\u4e00\u4e2a\u6839\u8bc1\u4e66\u3002</p>"},{"location":"chap11/6linkered_prod/#_3","title":"\u5176\u4ed6","text":"<p>\u4e0a\u9762\u662f\u5c06 Linkerd \u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e4b\u524d\u9700\u8981\u8003\u8651\u7684\u4e00\u4e9b\u91cd\u8981\u4e8b\u9879\uff0c\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u4e8b\u9879\u4e5f\u662f\u503c\u5f97\u6211\u4eec\u5173\u6ce8\u7684\uff1a</p> <ul> <li>\u914d\u7f6e\u8d44\u6e90\uff1a\u5f53\u4f60\u5728 HA \u6a21\u5f0f\u4e0b\u90e8\u7f72 Linkerd \u65f6\uff0cLinkerd \u4e3a\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u8bbe\u7f6e CPU \u548c\u5185\u5b58\u8d44\u6e90\u8bf7\u6c42\u548c\u9650\u5236\u3002\u8fd9\u4e9b\u9650\u5236\u662f\u4e00\u4e2a\u76f8\u5bf9\u5408\u7406\u7684\u503c\uff0c\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u5e94\u7528\u90fd\u662f\u4e00\u6837\u7684\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u8c03\u6574\u8fd9\u4e9b\u8d44\u6e90\u914d\u7f6e\u4ee5\u9002\u5e94\u4f60\u7684\u9700\u6c42\u3002\u5bf9\u4e8e\u9ad8\u6d41\u91cf\u7684\u670d\u52a1\uff08\u6bcf\u4e2a\u5b9e\u4f8b\u6bcf\u79d2&gt;1000\u4e2a\u8bf7\u6c42\uff09\uff0c\u6211\u4eec\u53ef\u80fd\u8fd8\u9700\u8981\u8c03\u6574\u4ee3\u7406\u8d44\u6e90\uff0c\u4e5f\u53ef\u4ee5\u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\u6307\u5b9a <code>config.linkerd.io/proxy-cpu-limit</code>\u6ce8\u89e3\u6765\u914d\u7f6e\u4ee3\u7406\u7684\u5e76\u53d1\u3002</li> <li>\u68c0\u67e5\u65f6\u949f\u504f\u5dee\uff1a\u786e\u4fdd\u96c6\u7fa4\u4e2d\u7684\u8282\u70b9\u4fdd\u6301\u540c\u6b65\u5f88\u91cd\u8981\uff0c\u4f8b\u5982\u901a\u8fc7\u4f7f\u7528 NTP\uff0c\u8282\u70b9\u4e4b\u95f4\u7684\u5927\u65f6\u949f\u504f\u5dee\u53ef\u80fd\u4f1a\u7834\u574f Linkerd \u4ee3\u7406\u9a8c\u8bc1\u5b83\u4eec\u7528\u4e8e mTLS \u7684\u8bc1\u4e66\u7684\u80fd\u529b\uff08\u5728\u89e3\u51b3\u96c6\u7fa4\u4e2d\u7684\u95ee\u9898\u65f6\uff0c\u5927\u7684\u65f6\u949f\u504f\u5dee\u53ef\u80fd\u4f1a\u4f7f\u8de8\u8282\u70b9\u8bfb\u53d6\u65e5\u5fd7\u6587\u4ef6\u53d8\u5f97\u56f0\u96be\uff01\uff09\u3002</li> <li>\u5904\u7406 <code>NET_ADMIN</code>\uff1aLinkerd \u7684 proxy-init \u5bb9\u5668\u5728\u6ce8\u5165 Pod \u65f6\u8fd0\u884c\uff0c\u5e76\u8d1f\u8d23\u914d\u7f6e iptables \u89c4\u5219\uff0c\u4ee5\u4fbf\u6240\u6709\u8fdb\u51fa\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684 TCP \u6d41\u91cf\u90fd\u81ea\u52a8\u901a\u8fc7\u4ee3\u7406\u5bb9\u5668\u8def\u7531\u3002\u8fd9\u9700\u8981 Kubernetes \u7684 <code>NET_ADMIN</code> \u8fd9\u4e2a Linux Capability\uff0c\u8fd9\u610f\u5473\u7740\u4efb\u4f55\u5411\u96c6\u7fa4\u6dfb\u52a0\u652f\u6301 Linkerd \u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7cfb\u7edf\u90fd\u5fc5\u987b\u88ab\u6388\u4e88\u8be5\u80fd\u529b\u3002\u5982\u679c\u51fa\u4e8e\u5b89\u5168\u539f\u56e0\u4e0d\u5e0c\u671b\u8fd9\u6837\u505a\uff0c\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528 <code>Linkerd CNI</code> \u63d2\u4ef6\u5728\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u8005\u6743\u9650\u8303\u56f4\u4e4b\u5916\u6267\u884c\u6b64\u64cd\u4f5c\u3002</li> <li>linkerd viz tap \u6743\u9650\uff1a\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u8fc7 tap \u8fd9\u4e2a\u5f3a\u5927\u7684\u547d\u4ee4\uff0c\u4f46\u662f\u8fd9\u4e2a\u529f\u80fd\u4e5f\u4f1a\u9644\u5e26\u5f88\u591a\u98ce\u9669\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u547d\u4ee4\u53ef\u80fd\u4f1a\u5c06\u6f5c\u5728\u7684\u654f\u611f\u4fe1\u606f\u66b4\u9732\u7ed9\u7528\u6237\uff0c\u4e0d\u8fc7 Linkerd \u5141\u8bb8\u6211\u4eec\u4f7f\u7528 Kubernetes RBAC \u9650\u5236\u6765\u63a7\u5236\u8c01\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8f93\u51fa\u3002</li> <li>\u4f7f\u7528 Ingress\uff1a\u4e0e\u5176\u4ed6\u4e00\u4e9b\u670d\u52a1\u7f51\u683c\u4e0d\u540c\uff0cLinkerd \u4e0d\u63d0\u4f9b\u81ea\u5df1\u7684 Ingress \u63a7\u5236\u5668\u3002\u76f8\u53cd\uff0c\u4f60\u53ef\u4ee5\u5c06 Linkerd \u4e0e\u5176\u4ed6\u53ef\u7528\u7684 Kubernetes Ingress \u63a7\u5236\u5668\u914d\u5408\u4f7f\u7528\uff0c\u5f53\u8fd9\u6837\u505a\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5efa\u8bae\u5c06 Ingress \u63a7\u5236\u5668\u4e0e Linkerd \u4ee3\u7406\u6ce8\u5165\uff0c\u8fd9\u5c06\u5141\u8bb8 Linkerd \u7684 mTLS \u548c\u53ef\u89c2\u5bdf\u6027\u4ece\u8bf7\u6c42\u8fdb\u5165\u96c6\u7fa4\u7684\u90a3\u4e00\u523b\u8d77\u5c31\u5df2\u7ecf\u53ef\u7528\u4e86\u3002</li> </ul> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u57fa\u672c\u4e0a\u4e86\u89e3\u4e86\u5982\u4f55\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528 Linkerd \u4e86\u3002\u4f46\u4e5f\u8981\u6ce8\u610f\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u7684\u8fd9\u4e9b\u4e8b\u9879\u5e76\u4e0d\u662f\u6240\u6709\u7684\uff0c\u5f3a\u70c8\u5efa\u8bae\u5728\u5c06 Linkerd \u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e4b\u524d\u5b8c\u5168\u7406\u89e3\u8fd9\u4e9b\u6982\u5ff5\u5e76\u901a\u8bfb Linkerd \u6587\u6863\u3002</p>"},{"location":"chap11/7linkered_ingress/","title":"7 Linkerd \u4e0e ingress-nginx \u7ed3\u5408\u4f7f\u7528\u4ee5\u53ca\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\u9650\u5236","text":"<p>\u51fa\u4e8e\u7b80\u5355\uff0cLinkerd \u672c\u8eab\u5e76\u6ca1\u6709\u63d0\u4f9b\u5185\u7f6e\u7684 Ingress \u63a7\u5236\u5668\uff0cLinkerd \u65e8\u5728\u4e0e\u73b0\u6709\u7684 Kubernetes Ingress \u89e3\u51b3\u65b9\u6848\u4e00\u8d77\u4f7f\u7528\u3002</p> <p>\u8981\u7ed3\u5408 Linkerd \u548c\u4f60\u7684 Ingress \u89e3\u51b3\u65b9\u6848\u9700\u8981\u4e24\u4ef6\u4e8b\uff1a</p> <ul> <li>\u914d\u7f6e\u4f60\u7684 Ingress \u4ee5\u652f\u6301 Linkerd\u3002</li> <li>\u7f51\u683c\u5316\u4f60\u7684 Ingress \u63a7\u5236\u5668\uff0c\u4ee5\u4fbf\u5b83\u4eec\u5b89\u88c5 Linkerd \u4ee3\u7406\u3002</li> </ul> <p>\u5bf9 Ingress \u63a7\u5236\u5668\u8fdb\u884c\u7f51\u683c\u5316\u5c06\u5141\u8bb8 Linkerd \u5728\u6d41\u91cf\u8fdb\u5165\u96c6\u7fa4\u65f6\u63d0\u4f9b L7 \u6307\u6807\u548c mTLS \u7b49\u529f\u80fd\uff0cLinkerd \u652f\u6301\u4e0e\u5927\u90e8\u5206 Ingress \u63a7\u5236\u5668\u8fdb\u884c\u96c6\u6210\uff0c\u5305\u62ec\uff1a</p> <ul> <li>Ambassador</li> <li>Nginx</li> <li>Traefik<ul> <li>Traefik 1.x</li> <li>Traefik 2.x</li> </ul> </li> <li>GCE</li> <li>Gloo</li> <li>Contour<ul> <li>Kong</li> <li>Haproxy</li> </ul> </li> </ul>"},{"location":"chap11/7linkered_ingress/#ingress-nginx","title":"ingress-nginx","text":"<p>\u6211\u4eec\u8fd9\u91cc\u4ee5\u96c6\u7fa4\u4e2d\u4f7f\u7528\u7684 ingress-nginx \u4e3a\u4f8b\u6765\u8bf4\u660e\u5982\u4f55\u5c06\u5176\u4e0e Linkerd \u8fdb\u884c\u96c6\u6210\u4f7f\u7528\u3002</p> <pre><code>$ kubectl get deploy -n ingress-nginx\nNAME                           READY   UP-TO-DATE   AVAILABLE   AGE\ningress-nginx-controller       1/1     1            1           57d\ningress-nginx-defaultbackend   1/1     1            1           57d\n$ kubectl get pods -n ingress-nginx\nNAME                                            READY   STATUS     RESTARTS       AGE\ningress-nginx-controller-7647c44fb9-sss9m       1/1     Running    26 (59m ago)   57d\ningress-nginx-defaultbackend-84854cd6cb-rvgd2   1/1     Running    27 (59m ago)   57d\n</code></pre> <p>\u9996\u5148\u6211\u4eec\u9700\u8981\u66f4\u65b0 <code>ingress-nginx-controller</code> \u63a7\u5236\u5668\uff0c\u4e3a <code>Pod</code> \u6dfb\u52a0\u4e00\u4e2a <code>linkerd.io/inject: enabled</code> \u6ce8\u89e3\uff0c \u53ef\u4ee5\u76f4\u63a5 <code>kubectl edit</code> \u8fd9\u4e2a <code>Deployment</code>\uff0c\u7531\u4e8e\u6211\u4eec\u96c6\u7fa4\u4e2d\u7684 <code>ingress-nginx</code> \u4f7f\u7528\u7684 <code>Helm Chart</code> \u5b89\u88c5\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u5728 values \u4e2d\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u914d\u7f6e\uff1a</p> <pre><code>controller:\n  podAnnotations:\n    linkerd.io/inject: enabled\n# ......\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u8be5 values \u91cd\u65b0\u66f4\u65b0\u5373\u53ef\uff1a</p> <pre><code># Update your helm repos with the ingress-nginx repo\n$ helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx\n$ helm repo update\n\n# Install the ingress-nginx chart\n$ helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx --namespace=ingress-nginx --values=values.yaml\n</code></pre> <p>\u66f4\u65b0\u540e ingress-nginx \u7684\u63a7\u5236\u5668 Pod \u5c31\u4f1a\u88ab\u81ea\u52a8\u6ce8\u5165\u4e00\u4e2a <code>linkerd proxy</code>\u7684 sidecar \u5bb9\u5668\uff1a</p> <pre><code>$ kubectl get pods -n ingress-nginx\nNAME                                            READY   STATUS    RESTARTS       AGE\ningress-nginx-controller-f56c7f6fd-rxhrs        2/2     Running   0              4m21s\ningress-nginx-defaultbackend-84854cd6cb-rvgd2   1/1     Running   27 (62m ago)   57d\n</code></pre> <p>\u8fd9\u6837 ingress \u63a7\u5236\u5668\u4e5f\u88ab\u52a0\u5165\u5230\u7f51\u683c\u4e2d\u53bb\u4e86\uff0c\u6240\u4ee5\u4e5f\u5177\u6709\u4e86 Linkerd \u7f51\u683c\u7684\u76f8\u5173\u529f\u80fd\uff1a</p> <ul> <li>\u4e3a Ingress \u63a7\u5236\u5668\u63d0\u4f9b\u9ec4\u91d1\u6307\u6807\uff08\u6bcf\u79d2\u8bf7\u6c42\u6570\u7b49\uff09\u3002</li> <li>Ingress \u63a7\u5236\u5668 Pod \u548c\u7f51\u683c\u5e94\u7528 Pod \u4e4b\u95f4\u7684\u6d41\u91cf\u662f\u52a0\u5bc6\u7684\uff08\u5e76\u76f8\u4e92\u9a8c\u8bc1\uff09\u3002</li> <li>\u53ef\u4ee5\u770b\u5230 HTTP \u6d41\u91cf</li> <li>\u5f53\u5e94\u7528\u7a0b\u5e8f\u8fd4\u56de\u9519\u8bef\uff08\u5982 5xx HTTP \u72b6\u6001\u4ee3\u7801\uff09\u65f6\uff0c\u8fd9\u5c06\u5728 Linkerd UI \u4e2d\u770b\u5230\uff0c\u4e0d\u4ec5\u662f\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd8\u6709 nginx ingress \u63a7\u5236\u5668\uff0c\u56e0\u4e3a\u5b83\u5411\u5ba2\u6237\u7aef\u8fd4\u56de\u9519\u8bef\u4ee3\u7801\u3002</li> </ul> <p>\u5728 Linkerd Dashboard \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u6307\u6807\u6570\u636e\u4e86\u3002</p> <p></p> <p>\u5bf9\u5e94\u5728 Grafana \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u56fe\u8868\u4fe1\u606f\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u4e3a Emojivoto \u5e94\u7528\u6dfb\u52a0\u4e00\u4e2a\u5bf9\u5e94\u7684 Ingress \u8d44\u6e90\u5bf9\u8c61\u6765\u5bf9\u5916\u66b4\u9732\u670d\u52a1\u3002</p> <pre><code>\n# emojivoto-ingress.yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: emojivoto-ingress\n  labels:\n    name: emojivoto-ingress\n  namespace: emojivoto\n  annotations:\n    # add below line of nginx is meshed\n    nginx.ingress.kubernetes.io/service-upstream: \"true\"\n    # nginx.ingress.kubernetes.io/affinity: \"cookie\"\n    # nginx.ingress.kubernetes.io/affinity-mode: \"persistent\"\nspec:\n  ingressClassName: nginx\n  rules:\n    # update IP with your own IP used by Ingress Controller\n    - host: emoji.192.168.0.52.nip.io\n      http:\n        paths:\n          - pathType: Prefix\n            path: /\n            backend:\n              service:\n                name: web-svc-2\n                port:\n                  number: 80\n</code></pre> <p>\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f emojivoto-ingress.yaml\n$ kubectl get ingress -n emojivoto\nNAME                CLASS   HOSTS                       ADDRESS        PORTS   AGE\nemojivoto-ingress   nginx   emoji.192.168.0.52.nip.io   192.168.0.52   80      61s\n</code></pre> <p>\u5176\u4e2d <code>nip.io</code> \u662f\u4efb\u4f55 <code>IP</code> \u5730\u5740\u7684\u7b80\u5355\u901a\u914d\u7b26 <code>DNS</code>\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u4e0d\u7528\u4f7f\u7528\u81ea\u5b9a\u4e49\u4e3b\u673a\u540d\u548c IP \u5730\u5740\u6620\u5c04\u6765\u7f16\u8f91\u4f60\u7684 <code>etc/hosts</code> \u6587\u4ef6\u4e86\uff0c<code>nip.io</code> \u5141\u8bb8\u4f60\u901a\u8fc7\u4f7f\u7528\u4ee5\u4e0b\u683c\u5f0f\u5c06\u4efb\u4f55 IP \u5730\u5740\u6620\u5c04\u5230\u4e00\u4e2a\u4e3b\u673a\u540d\u3002</p>"},{"location":"chap11/7linkered_ingress/#_1","title":"\u4e0d\u5e26\u540d\u79f0","text":"<ul> <li>10.0.0.1.nip.io \u6620\u5c04\u5230 10.0.0.1</li> <li><code>192-168-1-250.nip.io</code> \u6620\u5c04\u5230 <code>192.168.1.250</code></li> <li><code>0a000803.nip.io</code> \u6620\u5c04\u5230 <code>10.0.8.3</code></li> </ul>"},{"location":"chap11/7linkered_ingress/#_2","title":"\u5e26\u540d\u79f0","text":"<ul> <li>app.10.8.0.1.nip.io \u6620\u5c04\u5230 10.8.0.1</li> <li>app-116-203-255-68.nip.io \u6620\u5c04\u5230 116.203.255.68</li> <li>app-c0a801fc.nip.io \u6620\u5c04\u5230 192.168.1.252</li> <li>customer1.app.10.0.0.1.nip.io \u6620\u5c04\u5230 10.0.0.1</li> <li>customer2-app-127-0-0-1.nip.io \u6620\u5c04\u5230 127.0.0.1</li> <li>customer3-app-7f000101.nip.io \u6620\u5c04\u5230 127.0.1.1</li> </ul> <p>nip.io \u5c06 <code>&lt;anything&gt;[.-]&lt;IP Address&gt;.nip.io</code>\u4ee5\"\u70b9\"\u3001\"\u7834\u6298\u53f7\"\u6216\"\u5341\u516d\u8fdb\u5236\"\u7b26\u53f7\u6620\u5c04\u5230\u76f8\u5e94\u7684 <code>&lt;IP Address&gt;</code>\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u57df\u540d <code>emoji.192.168.0.52.nip.io</code> \u76f8\u5f53\u4e8e\u76f4\u63a5\u6620\u5c04\u5230 <code>192.168.0.52</code>\u8fd9\u4e2a IP \u5730\u5740\u4e0a\uff0c\u8be5\u5730\u5740\u662f\u6211\u4eec <code>ingress-nginx</code> \u7684\u5165\u53e3\u5730\u5740\uff0c\u8fd9\u6837\u6211\u4eec\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u6620\u5c04\u5373\u53ef\u8bbf\u95ee\u670d\u52a1\u4e86\u3002</p> <p></p> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u5728\u4e0a\u9762\u7684 Ingress \u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>nginx.ingress.kubernetes.io/service-upstream: true</code> \u7684\u6ce8\u89e3\uff0c\u8fd9\u662f\u7528\u6765\u544a\u8bc9 <code>Nginx Ingress Controller</code> \u5c06\u6d41\u91cf\u8def\u7531\u5230\u7f51\u683c\u5e94\u7528\u7684\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u8def\u7531\u5230 Pod\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIngress \u63a7\u5236\u5668\u53ea\u662f\u67e5\u8be2\u5176\u76ee\u6807\u670d\u52a1\u7684\u7aef\u70b9\uff0c\u4ee5\u68c0\u7d22\u8be5\u670d\u52a1\u80cc\u540e\u7684 Pod \u7684 IP \u5730\u5740\u3002\u800c\u901a\u8fc7\u5411\u7f51\u683c\u670d\u52a1\u53d1\u9001\u6d41\u91cf\uff0cLinkerd \u7684\u76f8\u5173\u529f\u80fd\u5982\u8d1f\u8f7d\u5747\u8861\u548c\u6d41\u91cf\u62c6\u5206\u5219\u4f1a\u88ab\u542f\u7528\u3002</p> <p></p>"},{"location":"chap11/7linkered_ingress/#_3","title":"\u9650\u5236\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee","text":"<p>Linkerd policy \u8d44\u6e90\u53ef\u7528\u4e8e\u9650\u5236\u54ea\u4e9b\u5ba2\u6237\u7aef\u53ef\u4ee5\u8bbf\u95ee\u670d\u52a1\u3002\u540c\u6837\u6211\u4eec\u8fd8\u662f\u4f7f\u7528 Emojivoto \u5e94\u7528\u6765\u5c55\u793a\u5982\u4f55\u9650\u5236\u5bf9 Voting \u5fae\u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4f7f\u5176\u53ea\u80fd\u4ece Web \u670d\u52a1\u4e2d\u8c03\u7528\u3002</p> <p>\u6211\u4eec\u9996\u5148\u4e3a Voting \u670d\u52a1\u521b\u5efa\u4e00\u4e2a Server \u8d44\u6e90\uff0cServer \u662f Linkerd \u7684\u53e6\u5916\u4e00\u4e2a CRD \u81ea\u5b9a\u4e49\u8d44\u6e90\uff0c\u5b83\u7528\u4e8e\u63cf\u8ff0\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7279\u5b9a\u7aef\u53e3\u3002\u4e00\u65e6 Server \u8d44\u6e90\u88ab\u521b\u5efa\uff0c\u53ea\u6709\u88ab\u6388\u6743\u7684\u5ba2\u6237\u7aef\u624d\u80fd\u8bbf\u95ee\u5b83\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code># voting-server.yaml\napiVersion: policy.linkerd.io/v1beta1\nkind: Server\nmetadata:\n  name: voting-grpc\n  namespace: emojivoto\n  labels:\n    app: voting-svc\nspec:\n  podSelector:\n    matchLabels:\n      app: voting-svc\n  port: grpc\n  proxyProtocol: gRPC\n</code></pre> <p>\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f voting-server.yaml\nserver.policy.linkerd.io/voting-grpc created\n$ kubectl get server -n emojivoto\nNAME          PORT   PROTOCOL\nvoting-grpc   grpc   gRPC\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8be5 <code>Server</code> \u4f7f\u7528\u4e86\u4e00\u4e2a <code>podSelector</code> \u5c5e\u6027\u6765\u9009\u62e9\u5b83\u6240\u63cf\u8ff0\u7684 Voting \u670d\u52a1\u7684 Pod\uff0c\u5b83\u8fd8\u6307\u5b9a\u4e86\u5b83\u9002\u7528\u7684\u547d\u540d\u7aef\u53e3 (grpc)\uff0c\u6700\u540e\u6307\u5b9a\u5728\u6b64\u7aef\u53e3\u4e0a\u63d0\u4f9b\u670d\u52a1\u7684\u534f\u8bae\u4e3a gRPC\uff0c \u8fd9\u53ef\u786e\u4fdd\u4ee3\u7406\u6b63\u786e\u5904\u7406\u6d41\u91cf\u5e76\u5141\u8bb8\u5b83\u8df3\u8fc7\u534f\u8bae\u68c0\u6d4b\u3002</p> <p>\u73b0\u5728\u6ca1\u6709\u5ba2\u6237\u7aef\u88ab\u6388\u6743\u8bbf\u95ee\u6b64\u670d\u52a1\uff0c\u6b63\u5e38\u4f1a\u770b\u5230\u6210\u529f\u7387\u6709\u6240\u4e0b\u964d\uff0c \u56e0\u4e3a\u4ece Web \u670d\u52a1\u5230 Voting \u7684\u8bf7\u6c42\u5f00\u59cb\u88ab\u62d2\u7edd\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b Web \u670d\u52a1\u7684 Pod \u65e5\u5fd7\u6765\u9a8c\u8bc1\uff1a</p> <pre><code>$ kubectl logs -f web-svc-2-f9d77474f-vxlrh -n emojivoto -c web-svc-2\n2022/09/06 09:31:27 Error serving request [&amp;{GET /api/vote?choice=:trophy: HTTP/1.1 1 1 map[Accept-Encoding:[gzip] L5d-Client-Id:[default.emojivoto.serviceaccount.identity.linkerd.cluster.local] L5d-Dst-Canonical:[web-apex.emojivoto.svc.cluster.local:80] User-Agent:[Go-http-client/1.1] X-B3-Sampled:[1] X-B3-Spanid:[f9e1dc6e24803ea8] X-B3-Traceid:[5ae662deee8fdbf2f3b9eaa40eb673d5]] {} &lt;nil&gt; 0 [] false web-apex.emojivoto:80 map[choice:[:trophy:]] map[] &lt;nil&gt; map[] 10.244.1.87:51244 /api/vote?choice=:trophy: &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0xc00045e4b0}]: rpc error: code = PermissionDenied desc = unauthorized connection on server voting-grpc\n# ......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd viz authz \u547d\u4ee4\u67e5\u770b\u8fdb\u5165 Voting \u670d\u52a1\u7684\u8bf7\u6c42\u7684\u6388\u6743\u72b6\u6001\uff1a</p> <pre><code>$ linkerd viz authz -n emojivoto deploy/voting\nSERVER       AUTHZ           SUCCESS     RPS  LATENCY_P50  LATENCY_P95  LATENCY_P99\nvoting-grpc  [UNAUTHORIZED]        -  0.9rps\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6240\u6709\u4f20\u5165\u7684\u8bf7\u6c42\u5f53\u524d\u90fd\u5904\u4e8e\u672a\u7ecf\u6388\u6743\u72b6\u6001\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u4e3a\u5ba2\u6237\u7aef\u6765\u6388\u4e88\u8bbf\u95ee\u8be5 Server \u7684\u6743\u9650\uff0c\u8fd9\u91cc\u9700\u8981\u4f7f\u7528\u5230\u53e6\u5916\u4e00\u4e2a CRD \u5bf9\u8c61 ServerAuthorization\uff0c\u521b\u5efa\u8be5\u5bf9\u8c61\u6765\u6388\u4e88 Web \u670d\u52a1\u8bbf\u95ee\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u7684 Voting Server \u7684\u6743\u9650\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># voting-server-auth.yaml\napiVersion: policy.linkerd.io/v1beta1\nkind: ServerAuthorization\nmetadata:\n  name: voting-grpc\n  namespace: emojivoto\nspec:\n  server:\n    name: voting-grpc # \u5173\u8054 Server \u5bf9\u8c61\n  # The voting service only allows requests from the web service.\n  client:\n    meshTLS:\n      serviceAccounts:\n        - name: web\n        - name: web-2\n</code></pre> <p>\u4e0a\u9762\u5bf9\u8c61\u4e2d\u901a\u8fc7 <code>spec.server.name</code> \u6765\u5173\u8054\u4e0a\u9762\u7684 Server \u5bf9\u8c61\uff0c\u7531\u4e8e <code>meshTLS</code> \u4f7f\u7528 <code>ServiceAccounts</code>\u4f5c\u4e3a\u8eab\u4efd\u57fa\u7840\uff0c\u56e0\u6b64\u6211\u4eec\u7684\u6388\u6743\u4e5f\u5c06\u57fa\u4e8e <code>ServiceAccounts</code>\uff0c\u6240\u4ee5\u901a\u8fc7 <code>spec.client.meshTLS.serviceAccounts</code> \u6765\u6307\u5b9a\u5141\u8bb8\u4ece\u54ea\u4e9b\u670d\u52a1\u6765\u8bbf\u95ee <code>Voting</code> \u670d\u52a1\u3002</p> <p>\u540c\u6837\u76f4\u63a5\u5e94\u7528\u8be5\u8d44\u6e90\u6e05\u5355\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f voting-server-auth.yaml\nserverauthorization.policy.linkerd.io/voting-grpc created\n$ kubectl get serverauthorization -n emojivoto\nNAME          SERVER\nvoting-grpc   voting-grpc\n</code></pre> <p>\u6709\u4e86\u8fd9\u4e2a\u5bf9\u8c61\u540e\uff0c\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u770b\u5230\u6240\u6709\u5bf9 Voting \u670d\u52a1\u7684\u8bf7\u6c42\u90fd\u662f\u7531 <code>voting-grpc</code>\u8fd9\u4e2a <code>ServerAuthorization</code> \u6388\u6743\u7684\u3002\u8bf7\u6ce8\u610f\uff0c\u7531\u4e8e <code>linkerd viz auth</code> \u547d\u4ee4\u5728\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\u5185\u67e5\u8be2\uff0c\u6240\u4ee5\u53ef\u80fd\u4f1a\u770b\u5230\u4e00\u4e9b\u672a\u6388\u6743(UNAUTHORIZED)\u7684\u8bf7\u6c42\u5728\u77ed\u65f6\u95f4\u5185\u663e\u793a\u3002</p> <pre><code>$ linkerd viz authz -n emojivoto deploy/voting\nSERVER       AUTHZ        SUCCESS     RPS  LATENCY_P50  LATENCY_P95  LATENCY_P99\nvoting-grpc  voting-grpc   84.48%  1.0rps          1ms          1ms          1ms\n</code></pre> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a gRPC \u5ba2\u6237\u7aef Pod \u6765\u5c1d\u8bd5\u4ece\u4e2d\u8bbf\u95ee Voting \u670d\u52a1\u6d4b\u8bd5\u6765\u81ea\u5176\u4ed6 Pod \u7684\u8bf7\u6c42\u662f\u5426\u4f1a\u88ab\u62d2\u7edd\uff1a</p> <pre><code>$ kubectl run grpcurl --rm -it --image=networld/grpcurl --restart=Never --command -- ./grpcurl -plaintext voting-svc.emojivoto:8080 emojivoto.v1.VotingService/VoteDog\nIf you don't see a command prompt, try pressing enter.\nError attaching, falling back to logs: unable to upgrade connection: container grpcurl not found in pod grpcurl_default\nError invoking method \"emojivoto.v1.VotingService/VoteDog\": failed to query for service descriptor \"emojivoto.v1.VotingService\": rpc error: code = PermissionDenied desc =\npod \"grpcurl\" deleted\npod default/grpcurl terminated (Error)`\n</code></pre> <p>\u7531\u4e8e\u8be5 client \u672a\u7ecf\u6388\u6743\uff0c\u6240\u4ee5\u8be5\u8bf7\u6c42\u5c06\u88ab\u62d2\u7edd\u5e76\u663e\u793a PermissionDenied \u9519\u8bef\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u9700\u8981\u521b\u5efa\u4efb\u610f\u6570\u91cf\u7684 ServerAuthorization \u8d44\u6e90\u6765\u6388\u6743\u8bb8\u591a\u4e0d\u540c\u7684\u5ba2\u6237\u7aef\uff0c\u8fd8\u53ef\u4ee5\u6307\u5b9a\u662f\u6388\u6743\u672a\u7ecf\u8eab\u4efd\u9a8c\u8bc1\uff08\u5373 unmeshed\uff09\u7684\u5ba2\u6237\u7aef\u3001\u4efb\u4f55\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u5ba2\u6237\u7aef\uff0c\u8fd8\u662f\u4ec5\u6388\u6743\u5177\u6709\u7279\u5b9a\u8eab\u4efd\u7684\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u5ba2\u6237\u7aef\u3002</p> <p>\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u4e3a\u6574\u4e2a\u96c6\u7fa4\u8bbe\u7f6e\u4e00\u4e2a\u9ed8\u8ba4\u7b56\u7565\uff0c\u8be5\u7b56\u7565\u5c06\u5e94\u7528\u4e8e\u6240\u6709\u672a\u5b9a\u4e49 Server \u8d44\u6e90\u7684\u3002Linkerd \u5728\u51b3\u5b9a\u662f\u5426\u5141\u8bb8\u8bf7\u6c42\u65f6\u4f1a\u4f7f\u7528\u4ee5\u4e0b\u903b\u8f91\uff1a</p> <ul> <li>\u5982\u679c\u6709\u4e00\u4e2a Server \u8d44\u6e90\u5e76\u4e14\u5ba2\u6237\u7aef\u4e3a\u5176\u5339\u914d\u4e00\u4e2a ServerAuthorization \u8d44\u6e90\uff0c\u5219\u4e3a ALLOW</li> <li>\u5982\u679c\u6709\u4e00\u4e2a Server \u8d44\u6e90\uff0c\u4f46\u5ba2\u6237\u7aef\u4e0d\u5339\u914d\u5b83\u7684\u4efb\u4f55 ServerAuthorizations\uff0c\u5219\u4e3a DENY</li> <li>\u5982\u679c\u7aef\u53e3\u6ca1\u6709 Server \u8d44\u6e90\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7b56\u7565</li> </ul> <p>\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd upgrade \u547d\u4ee4\u5c06\u9ed8\u8ba4\u7b56\u7565\u8bbe\u7f6e\u4e3a deny\uff1a</p> <pre><code>$ linkerd upgrade --set policyController.defaultAllowPolicy=deny | kubectl apply -f -\n</code></pre> <p>\u53e6\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>config.linkerd.io/default-inbound-policy</code> \u6ce8\u89e3\uff0c\u53ef\u4ee5\u5728\u5355\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6216\u547d\u540d\u7a7a\u95f4\u4e0a\u8bbe\u7f6e\u9ed8\u8ba4\u7b56\u7565\u3002</p> <p>\u610f\u601d\u5c31\u662f\u9664\u975e\u901a\u8fc7\u521b\u5efa <code>Server</code> \u548c <code>ServerAuthorization</code>\u5bf9\u8c61\u660e\u786e\u6388\u6743\uff0c\u5426\u5219\u6240\u6709\u8bf7\u6c42\u90fd\u5c06\u88ab\u62d2\u7edd\uff0c\u8fd9\u6837\u7684\u8bdd\u5bf9\u4e8e liveness \u548c readiness \u63a2\u9488\u9700\u8981\u660e\u786e\u6388\u6743\uff0c\u5426\u5219 Kubernetes \u5c06\u65e0\u6cd5\u5c06 Pod \u8bc6\u522b\u4e3a live \u6216 ready \u72b6\u6001\uff0c\u5e76\u5c06\u91cd\u65b0\u542f\u52a8\u5b83\u4eec\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u7b56\u7565\u5bf9\u8c61\uff0c\u6765\u5141\u8bb8\u6240\u6709\u5ba2\u6237\u7aef\u8bbf\u95ee Linkerd admin \u7aef\u53e3\uff0c\u4ee5\u4fbf Kubernetes \u53ef\u4ee5\u6267\u884c liveness \u548c readiness \u68c0\u67e5\uff1a</p> <pre><code>$ cat &lt;&lt; EOF | kubectl apply -f -\n---\n# Server \"admin\": matches the admin port for every pod in this namespace\napiVersion: policy.linkerd.io/v1beta1\nkind: Server\nmetadata:\n  namespace: emojivoto\n  name: admin\nspec:\n  port: linkerd-admin\n  podSelector:\n    matchLabels: {} # every pod\n  proxyProtocol: HTTP/1\n---\n# ServerAuthorization \"admin-everyone\": allows unauthenticated access to the\n# \"admin\" Server, so that Kubernetes health checks can get through.\napiVersion: policy.linkerd.io/v1beta1\nkind: ServerAuthorization\nmetadata:\n  namespace: emojivoto\n  name: admin-everyone\nspec:\n  server:\n    name: admin\n  client:\n    unauthenticated: true\n</code></pre> <p>ization \u9650\u5236\u4e3a\u8fd9\u4e9b IP \u5730\u5740\u6216\u8303\u56f4\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u77e5\u9053 Kubelet \u5728 10.244.0.1 \u4e0a\u8fd0\u884c\uff0c\u90a3\u4e48\u4f60\u7684 ServerAuthorization \u53ef\u4ee5\u6539\u4e3a\uff1a</p> <pre><code>\n# ServerAuthorization \"admin-kublet\": allows unauthenticated access to the\n# \"admin\" Server from the kubelet, so that Kubernetes health checks can get through.\napiVersion: policy.linkerd.io/v1beta1\nkind: ServerAuthorization\nmetadata:\n  namespace: emojivoto\n  name: admin-kubelet\nspec:\n  server:\n    name: admin\n  client:\n    networks:\n      - cidr: 10.244.0.1/32\n    unauthenticated: true\n</code></pre> <p>\u53e6\u5916\u6709\u4e00\u4e2a\u503c\u5f97\u6ce8\u610f\u7684\u662f\u5728\u6211\u4eec\u521b\u5efa Server \u8d44\u6e90\u4e4b\u540e\uff0c\u4f46\u5728\u521b\u5efa ServerAuthorization \u4e4b\u524d\u6709\u4e00\u6bb5\u65f6\u95f4\uff0c\u6240\u6709\u8bf7\u6c42\u90fd\u88ab\u62d2\u7edd\u3002\u4e3a\u4e86\u907f\u514d\u5728\u5b9e\u65f6\u7cfb\u7edf\u4e2d\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u5efa\u8bae\u4f60\u5728\u90e8\u7f72\u670d\u52a1\u4e4b\u524d\u521b\u5efa policy \u8d44\u6e90\uff0c\u6216\u8005\u5728\u521b\u5efa Server \u4e4b\u524d\u521b\u5efa ServiceAuthorizations\uff0c\u4ee5\u4fbf\u7acb\u5373\u6388\u6743\u5ba2\u6237\u7aef\u3002</p> <p>\u5173\u4e8e\u6388\u6743\u7b56\u7565\u7684\u66f4\u591a\u4f7f\u7528\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 https://linkerd.io/2.11/reference/authorization-policy/ \u4ee5\u4e86\u89e3\u66f4\u591a\u76f8\u5173\u4fe1\u606f\u3002</p>"},{"location":"chap11/8linkerd_212/","title":"8 Linkerd \u5347\u7ea7\u5230\u5168\u65b0\u7684 2.12 \u7248\u672c","text":"<p>Linkerd \u6700\u65b0\u7684 2.12 \u7248\u672c\u5df2\u7ecf\u53d1\u5e03\u4e86\uff0c\u8fd9\u4e2a\u5e9e\u5927\u7684\u7248\u672c\u4e3a Linkerd \u5f15\u5165\u4e86\u57fa\u4e8e\u8def\u7531\u7684\u7b56\u7565\uff0c\u5141\u8bb8\u7528\u6237\u4ee5\u5b8c\u5168\u96f6\u4fe1\u4efb\u7684\u65b9\u5f0f\u5b9a\u4e49\u548c\u6267\u884c\u57fa\u4e8e <code>HTTP</code> \u8def\u7531\u7684\u6388\u6743\u7b56\u7565\u3002</p> <p>\u8fd9\u4e9b\u7b56\u7565\u5efa\u7acb\u5728 Linkerd \u5f3a\u5927\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u4e4b\u4e0a\uff0c\u7531\u53cc\u5411 <code>TLS</code> \u4fdd\u62a4\uff0c\u5e76\u4f7f\u7528 <code>Kubernetes</code> \u65b0\u63a8\u51fa\u7684 <code>Gateway API</code> \u7684\u7c7b\u578b\u8fdb\u884c\u914d\u7f6e\u3002</p>"},{"location":"chap11/8linkerd_212/#_1","title":"\u66f4\u65b0\u65e5\u5fd7","text":"<p>Linkerd 2.12 \u662f\u91c7\u7528 <code>Gateway API</code> \u4f5c\u4e3a\u6838\u5fc3\u914d\u7f6e\u673a\u5236\u7684\u7b2c\u4e00\u6b65\u3002</p> <p>\u867d\u7136\u8fd9\u4e2a API \u5bf9\u4e8e\u670d\u52a1\u7f51\u683c\u7528\u4f8b\u6765\u8bf4\u8fd8\u4e0d\u662f\u5b8c\u7f8e\u7684\uff0c\u4f46\u5b83\u4e3a\u8fd9\u4e2a\u7248\u672c\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f3a\u5927\u7684\u8d77\u70b9\uff0c\u66f4\u91cd\u8981\u7684\u662f\uff0c\u5728 Gateway API \u7684\u57fa\u7840\u4e0a\u6784\u5efa\u5c06\u4f7f\u6211\u4eec\u80fd\u591f\u5c06\u7279\u5b9a\u4e8e Linkerd \u7684\u914d\u7f6e\u5bf9\u8c61\u7684\u6570\u91cf\u4fdd\u6301\u5728\u6700\u4f4e\u9650\u5ea6\uff0c\u5373\u4f7f\u6211\u4eec\u5f15\u5165\u4e86\u65b0\u529f\u80fd\u3002</p> <p>\u8fd9\u662f\u6211\u4eec\u4e3a Kubernetes \u6210\u4e3a\u6700\u7b80\u5355\u548c\u6700\u8f7b\u91cf\u7684\u670d\u52a1\u7f51\u683c\u7684\u76ee\u6807\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002</p> <p>\u6b64\u5916 2.12 \u7248\u672c\u8fd8\u5f15\u5165\u4e86\u8bbf\u95ee\u65e5\u5fd7\u8bb0\u5f55\uff0c\u8fd9\u662f\u4e00\u4e2a\u671f\u5f85\u5df2\u4e45\u7684\u529f\u80fd\uff0c\u5141\u8bb8 Linkerd \u751f\u6210 Apache \u6837\u5f0f\u7684\u8bf7\u6c42\u65e5\u5fd7\u3002\u5b83\u589e\u52a0\u4e86\u5bf9 <code>iptables-nft</code> \u7684\u652f\u6301\uff0c\u5e76\u5f15\u5165\u4e86\u8bb8\u591a\u5176\u4ed6\u6539\u8fdb\u548c\u6027\u80fd\u589e\u5f3a\u3002</p>"},{"location":"chap11/8linkerd_212/#per-route","title":"Per-route \u7b56\u7565","text":"<p>Linkerd \u7684\u65b0\u7684 <code>per-route</code> \u7b56\u7565\u6269\u5c55\u4e86\u73b0\u6709\u7684\u57fa\u4e8e\u7aef\u53e3\u7684\u7b56\u7565\uff0c\u5bf9\u670d\u52a1\u5982\u4f55\u88ab\u5141\u8bb8\u76f8\u4e92\u901a\u4fe1\u8fdb\u884c\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\u3002</p> <p>\u8fd9\u4e9b\u7b56\u7565\u662f\u4e3a\u91c7\u53d6\u96f6\u4fe1\u4efb\u5b89\u5168\u65b9\u6cd5\u7684\u7ec4\u7ec7\u8bbe\u8ba1\u7684\uff0c\u8fd9\u79cd\u65b9\u6cd5\u4e0d\u4ec5\u9700\u8981\u52a0\u5bc6\uff0c\u8fd8\u9700\u8981\u5f3a\u5927\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u548c\u660e\u786e\u7684\u6388\u6743\u3002</p> <ul> <li>\u5c06\u7f51\u7edc\u89c6\u4e3a\u5bf9\u6297\u6027\u7684\uff1a\u5b83\u4eec\u4e0d\u4f9d\u8d56 IP \u5730\u5740\uff0c\u4e5f\u4e0d\u8981\u6c42 CNI \u5c42\u6216\u5e95\u5c42\u7f51\u7edc\u7684\u4efb\u4f55\u5176\u4ed6\u65b9\u9762\u662f\u5b89\u5168\u7684\u3002</li> <li>\u4f7f\u7528\u5b89\u5168\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\uff1aLinkerd \u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u662f\u7531 ServiceAccounts \u81ea\u52a8\u751f\u6210\u7684\uff0c\u5e76\u5728\u8fde\u63a5\u65f6\u901a\u8fc7\u53cc\u5411 TLS \u8fdb\u884c\u52a0\u5bc6\u9a8c\u8bc1\u3002</li> <li>\u5728 Pod \u7ea7\u522b\u4e0a\u5f3a\u5236\u6267\u884c\uff1a\u6bcf\u4e2a\u8fde\u63a5\u548c\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u7ecf\u8fc7\u9a8c\u8bc1\u3002</li> <li>\u5f88\u5bb9\u6613\u7684\u5141\u8bb8\u6a21\u5f0f\uff1a\u6709\u5b89\u5168\u610f\u8bc6\u7684\u91c7\u7528\u8005\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u9ed8\u8ba4\u62d2\u7edd\u5bf9\u654f\u611f\u8d44\u6e90\u7684\u8bbf\u95ee\uff0c\u9664\u975e\u660e\u786e\u5141\u8bb8\uff08\"\u6700\u5c0f\u7279\u6743\u539f\u5219\"\uff09\u3002</li> </ul> <p>\u9ed8\u8ba4\u62d2\u7edd\u914d\u7f6e\u5728 Kubernetes \u4e2d\u53ef\u80fd\u4f1a\u6709\u4e00\u4e9b\u95ee\u9898\uff0c\u56e0\u4e3a health \u548c readiness \u63a2\u9488\u72b6\u6001\u9700\u8981\u5728\u6ca1\u6709\u6388\u6743\u7684\u60c5\u51b5\u4e0b\u901a\u8fc7\u3002</p> <p>\u5728 Linkerd 2.12 \u4e2d\uff0chealth \u548c readiness \u72b6\u6001\u63a2\u6d4b\u73b0\u5728\u662f\u9ed8\u8ba4\u6388\u6743\u7684\uff0c\u4f46\u4e5f\u53ef\u4ee5\u660e\u786e\u6388\u6743\uff0c\u540c\u65f6\u4ecd\u7136\u9501\u5b9a\u5176\u4ed6\u5e94\u7528\u7aef\u70b9\u3002</p>"},{"location":"chap11/8linkerd_212/#gateway-api","title":"Gateway API","text":"<p>Linkerd 2.12 \u63d0\u4f9b\u4e86\u652f\u6301 Kubernetes Gateway API \u7684\u7b2c\u4e00\u6b65\u3002\u867d\u7136 Gateway API \u6700\u521d\u662f\u4f5c\u4e3a Kubernetes \u4e2d\u957f\u671f\u5b58\u5728\u7684 Ingress \u8d44\u6e90\u7684\u4e00\u4e2a\u66f4\u4e30\u5bcc\u3001\u66f4\u7075\u6d3b\u7684\u66ff\u4ee3\u54c1\u800c\u8bbe\u8ba1\u7684\uff0c\u4f46\u5b83\u4e3a\u63cf\u8ff0\u670d\u52a1\u7f51\u72b6\u6d41\u91cf\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f88\u597d\u7684\u57fa\u7840\uff0c\u5e76\u5141\u8bb8 Linkerd \u5c06\u5176\u589e\u52a0\u7684\u914d\u7f6e\u4fdd\u6301\u5728\u6700\u4f4e\u6c34\u5e73\u3002</p> <p>\u5728 Linkerd 2.12 \u4e2d\uff0cLinkerd \u63d0\u4f9b\u4e86 Gateway API \u7684\u90e8\u5206\u5b9e\u73b0\u6765\u914d\u7f6e Linkerd \u7684\u57fa\u4e8e\u8def\u7531\u7684\u7b56\u7565\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5f00\u59cb\u4f7f\u7528 Gateway API\uff0c\u800c\u4e0d\u7528\u5b9e\u73b0\u89c4\u8303\u4e2d\u5bf9 Linkerd \u6ca1\u6709\u610f\u4e49\u7684\u90e8\u5206\u3002\u968f\u7740 Gateway API \u7684\u53d1\u5c55\uff0c\u4e5f\u4f1a\u6162\u6162\u5730\u66f4\u597d\u6ee1\u8db3 Linkerd \u7684\u9700\u6c42\u3002</p>"},{"location":"chap11/8linkerd_212/#_2","title":"\u8bbf\u95ee\u65e5\u5fd7","text":"<p>Linkerd 2.12 \u8fd8\u5f15\u5165\u4e86\u8bbf\u95ee\u65e5\u5fd7\u8bb0\u5f55\uff0c\u5b83\u5141\u8bb8\u4ee3\u7406\u53d1\u51fa Apache \u6837\u5f0f\u7684\u8bf7\u6c42\u65e5\u5fd7\u3002\u51fa\u4e8e\u6027\u80fd\u548c\u8d44\u6e90\u5229\u7528\u7387\u7684\u539f\u56e0\uff0c\u6b64\u529f\u80fd\u9ed8\u8ba4\u5173\u95ed\uff08\u5c24\u5176\u662f\u5bf9\u4e8e\u9ad8\u6d41\u91cf\u5de5\u4f5c\u8d1f\u8f7d\uff09\uff0c\u4f46\u4e5f\u53ef\u4ee5\u5728\u9700\u8981\u5b83\u7684\u60c5\u51b5\u4e0b\u8f7b\u677e\u542f\u7528\u3002</p>"},{"location":"chap11/8linkerd_212/#_3","title":"\u5176\u4ed6\u66f4\u65b0","text":"<p>Linkerd 2.12 \u8fd8\u6709\u5927\u91cf\u7684\u5176\u4ed6\u6539\u8fdb\u3001\u6027\u80fd\u63d0\u5347\u548c\u9519\u8bef\u4fee\u590d\uff0c\u5305\u62ec\uff1a</p> <ul> <li>\u4e00\u4e2a\u65b0\u7684 <code>config.linkerd.io/shutdown-grace-period</code> \u6ce8\u89e3\uff0c\u7528\u4e8e\u914d\u7f6e\u4ee3\u7406\u7684\u6700\u5927\u5bbd\u9650\u671f\uff0c\u4ee5\u4fbf\u4f18\u96c5\u5730\u5173\u95ed\u3002</li> <li>\u4e00\u4e2a\u65b0\u7684 <code>iptables-nft</code> \u6a21\u5f0f\uff0c\u7528\u4e8e <code>Linkerd</code> \u7684 <code>init</code> \u5bb9\u5668\u4e2d\u7684 <code>iptables-nft</code> \u652f\u6301\u3002</li> <li>\u4fee\u590d\u4e86\u67d0\u4e9b\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u5728\u4fe1\u4efb\u6839\u8f6e\u6362\u540e\u672a\u6309\u8981\u6c42\u91cd\u542f\u7684\u95ee\u9898\u3002</li> <li>\u4fee\u6b63\u4e86\u5f53\u5728 Linkerd \u547d\u540d\u7a7a\u95f4\u4e2d\u53d1\u73b0\u610f\u5916\u7684 Pod \u65f6\uff0c<code>linkerd check</code> \u547d\u4ee4\u5d29\u6e83\u7684\u95ee\u9898\u3002</li> <li>\u4fee\u6539\u4e86 <code>proxy.await</code> \u7684 Helm \u503c\uff0c\u8fd9\u6837\u7528\u6237\u5c31\u53ef\u4ee5\u5728\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u4e0a\u7981\u7528 linkerd-await\u3002</li> <li>\u6ce8\u91ca\uff0c\u5141\u8bb8 Linkerd \u6269\u5c55\u90e8\u7f72\u5728\u5fc5\u8981\u65f6\u88ab\u81ea\u52a8\u7f29\u653e\u5668\u9a71\u9010\u3002</li> <li>\u80fd\u591f\u5728\u72ec\u7acb\u6a21\u5f0f\u4e0b\u8fd0\u884c Linkerd CNI \u63d2\u4ef6\u3002</li> <li>\u591a\u96c6\u7fa4\u6269\u5c55\u4e2d\u7684 <code>ServiceAccount token Secret</code>\uff0c\u652f\u6301 Kubernetes \u7248\u672c<code>&gt;= v1.24</code>\u3002</li> </ul>"},{"location":"chap11/8linkerd_212/#_4","title":"\u5347\u7ea7","text":"<p>\u73b0\u5728\u6211\u4eec\u5c06\u96c6\u7fa4\u4e2d\u7684 Linkerd \u5347\u7ea7\u5230\u6700\u65b0\u7684 2.12 \u7248\u672c\u3002</p> <p>\u9996\u5148\u9700\u8981\u66f4\u65b0 Linkerd CLI \u5de5\u5177\uff0c\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ curl --proto '=https' --tlsv1.2 -sSfL https://run.linkerd.io/install | sh\n</code></pre> <p>\u8fd9\u4f1a\u5c06\u4f60\u7684\u672c\u5730 CLI \u5347\u7ea7\u5230\u6700\u65b0\u7248\u672c\u3002\u5f53\u7136\u6211\u4eec\u6709\u53ef\u4ee5\u901a\u8fc7 Linkerd \u7684 Release \u9875\u9762\u76f4\u63a5\u4e0b\u8f7d\u5bf9\u5e94\u5e73\u53f0\u7684 CLI \u5b89\u88c5\u5305\u3002</p> <pre><code>$ wget https://github.91chi.fun/https://github.com//linkerd/linkerd2/releases/download/stable-2.12.0/linkerd2-cli-stable-2.12.0-darwin-arm64\n$ sudo mv linkerd2-cli-stable-2.12.0-darwin-arm64 /usr/local/bin/linkerd\n$ chmod +x /usr/local/bin/linkerd\n</code></pre> <p>\u9a8c\u8bc1 CLI \u5df2\u5b89\u88c5\u5e76\u6b63\u786e\u8fd0\u884c\uff1a</p> <pre><code>$ linkerd version\nClient version: stable-2.12.0\nServer version: stable-2.11.1\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 CLI \u5347\u7ea7\u6210\u529f\u4e86\uff0c\u7531\u4e8e\u63a7\u5236\u5e73\u9762\u8fd8\u6ca1\u5347\u7ea7\uff0c\u6240\u4ee5\u770b\u5230\u7684\u8fd8\u662f\u73b0\u5728\u7684 2.11.1 \u7248\u672c\u3002</p> <p>\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u5347\u7ea7 Kubernetes \u96c6\u7fa4\u4e0a\u7684 Linkerd \u63a7\u5236\u5e73\u9762\u4e86\uff0c\u4e0d\u7528\u62c5\u5fc3\uff0c\u73b0\u6709\u7684\u6570\u636e\u5e73\u9762\u5c06\u7ee7\u7eed\u4f7f\u7528\u66f4\u65b0\u7248\u672c\u7684\u63a7\u5236\u5e73\u9762\u8fd0\u884c\uff0c\u5e76\u4e14\u4f60\u7684\u7f51\u683c\u670d\u52a1\u4e0d\u4f1a\u51fa\u73b0\u6545\u969c\u3002</p> <p>\u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f viz \u63d2\u4ef6\u81ea\u5e26\u7684 Prometheus \u7ec4\u4ef6\uff0c\u90a3\u4e48\u5347\u7ea7\u540e\u6570\u636e\u4f1a\u4e22\u5931\uff0c\u5982\u679c\u4f60\u914d\u7f6e\u7684\u5916\u7f6e\u7684 Prometheus \u5219\u4e0d\u7528\u62c5\u5fc3\u8be5\u95ee\u9898\u3002</p>"},{"location":"chap11/8linkerd_212/#linkerd-smi","title":"Linkerd SMI \u6269\u5c55","text":"<p>\u5982\u679c\u4f60\u4f7f\u7528 CLI \u5b89\u88c5\u4e86 Linkerd 2.11.x\uff0c\u5e76\u4e14\u6b63\u5728\u4f7f\u7528 TrafficSplit CRD\uff0c\u5219\u9700\u8981\u6ce8\u610f\u4e22\u5931 TS \u7684 CR\uff0c\u5982\u679c\u4f60\u4e0d\u4f7f\u7528\u6b64 CRD\uff0c\u5219\u53ef\u4ee5\u5ffd\u7565\u8be5\u6ce8\u610f\u4e8b\u9879\u3002</p> <p><code>TrafficSplit CRD</code> \u4e0d\u518d\u968f <code>Linkerd 2.12.0</code> \u63d0\u4f9b\uff0c\u800c\u662f\u7531<code>Linkerd SMI</code>\u6269\u5c55\u63d0\u4f9b\u3002</p> <p>\u540c\u6837\u9996\u5148\u4ece Release \u9875\u9762\u4e0b\u8f7d\u5bf9\u5e94\u7684\u53ef\u6267\u884c\u5305\uff1a</p> <pre><code>$ wget https://github.91chi.fun/https://github.com//linkerd/linkerd-smi/releases/download/v0.2.0/linkerd-smi-0.2.0-darwin-arm64\n$ chmod +x linkerd-smi-0.2.0-darwin-arm64\n$ sudo mv linkerd-smi-0.2.0-darwin-arm64 /usr/local/bin/linkerd-smi\n$ linkerd-smi version\nv0.2.0\n</code></pre> <p>\u540c\u6837 Linkerd SMI \u4e5f\u53ef\u4ee5\u901a\u8fc7 CLI \u5de5\u5177\u8fdb\u884c\u5b89\u88c5\uff0c\u6b64\u6269\u5c55\u5305\u542b\u4e00\u4e2a SMI-Adaptor\uff0c\u5b83\u5c06 SMI \u8d44\u6e90\u8f6c\u6362\u4e3a\u672c\u5730 Linkerd \u8d44\u6e90\u3002</p> <pre><code>$ linkerd smi install | kubectl apply -f -\n\n$ linkerd smi check\n</code></pre> <p>\u6b64\u5916\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684 Helm \u65b9\u5f0f\u6765\u5b89\u88c5 Linkerd SMI \u6269\u5c55\u3002\u4f46\u5728\u5b89\u88c5\u8be5\u6269\u5c55\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u5728 CRD \u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u6ce8\u91ca\u548c\u6807\u7b7e\uff0c\u4ee5\u4fbf linkerd-smi chart \u53ef\u4ee5\u91c7\u7528\u5b83\uff1a</p> <pre><code>$ kubectl annotate --overwrite crd/trafficsplits.split.smi-spec.io \\\n  meta.helm.sh/release-name=linkerd-smi \\\n  meta.helm.sh/release-namespace=linkerd-smi\n# \u6dfb\u52a0smi repo\u4ed3\u5e93\n\n$ helm repo add l5d-smi https://linkerd.github.io/linkerd-smi\n\n$ helm upgrade --install linkerd-smi -n linkerd-smi --create-namespace l5d-smi/linkerd-smi\nRelease \"linkerd-smi\" has been upgraded. Happy Helming!\nNAME: linkerd-smi\nLAST DEPLOYED: Sun Sep 11 14:54:02 2022\nNAMESPACE: linkerd-smi\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nThe Linkerd SMI extension was successfully installed \ud83c\udf89\n\n$ kubectl get pods -n linkerd-smi\nNAME                           READY   STATUS      RESTARTS        AGE\nnamespace-metadata--1-jnttx    0/1     Completed   0               17m\nsmi-adaptor-5788b875d4-r4b7w   2/2     Running     6 (5m53s ago)   17m\n</code></pre> <p>\u6700\u540e\uff0c\u4f60\u53ef\u4ee5\u7ee7\u7eed\u4f7f\u7528\u901a\u5e38\u7684 CLI \u5347\u7ea7\u8bf4\u660e\uff0c\u4f46\u5728\u5e94\u7528 <code>linkerd upgrade --crds</code> \u7684\u8f93\u51fa\u65f6\u907f\u514d\u4f7f\u7528 <code>--prune</code> \u6807\u5fd7\u4ee5\u907f\u514d\u5220\u9664 <code>TrafficSplit CRD</code>\uff01</p>"},{"location":"chap11/8linkerd_212/#_5","title":"\u5347\u7ea7","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>linkerd upgrade</code> \u547d\u4ee4\u6765\u5347\u7ea7\u63a7\u5236\u5e73\u9762\uff0c\u8be5\u547d\u4ee4\u786e\u4fdd\u63a7\u5236\u5e73\u9762\u7684\u6240\u6709\u73b0\u6709\u914d\u7f6e\u548c mTLS \u88ab\u4fdd\u7559\u4e0b\u6765\u3002</p> <pre><code>$ kubectl get crd |grep linkerd\nserverauthorizations.policy.linkerd.io                     2022-08-19T04:06:33Z\nservers.policy.linkerd.io                                  2022-08-19T04:06:33Z\nserviceprofiles.linkerd.io                                 2022-08-19T04:06:33Z\n\n\n$ linkerd upgrade --crds | \\\n  kubectl apply --prune -l linkerd.io/control-plane-ns=linkerd \\\n  --prune-whitelist=apiextensions.k8s.io/v1/customresourcedefinition \\\n  --prune-whitelist=split.smi-spec.io/v1alpha2/trafficsplit \\\n  -f -\ncustomresourcedefinition.apiextensions.k8s.io/authorizationpolicies.policy.linkerd.io created\ncustomresourcedefinition.apiextensions.k8s.io/httproutes.policy.linkerd.io created\ncustomresourcedefinition.apiextensions.k8s.io/meshtlsauthentications.policy.linkerd.io created\ncustomresourcedefinition.apiextensions.k8s.io/networkauthentications.policy.linkerd.io created\ncustomresourcedefinition.apiextensions.k8s.io/serverauthorizations.policy.linkerd.io configured\ncustomresourcedefinition.apiextensions.k8s.io/servers.policy.linkerd.io configured\ncustomresourcedefinition.apiextensions.k8s.io/serviceprofiles.linkerd.io configured\ncustomresourcedefinition.apiextensions.k8s.io/trafficsplits.split.smi-spec.io configured\n</code></pre> <p>\u6ce8\u610f\uff0c\u4e0a\u9762\u66f4\u65b0\u547d\u4ee4\u4e2d\u6211\u4eec\u4f7f\u7528\u4e86 <code>--prune</code> \u6807\u5fd7\uff0c\u8be5\u6807\u5fd7\u53ef\u4ee5\u5220\u9664\u5728\u65b0\u7248\u672c\u4e2d\u4e0d\u518d\u5b58\u5728\u7684\u524d\u4e00\u7248\u672c\u7684 <code>Linkerd</code> \u8d44\u6e90\uff0c\u4e0a\u9762\u6211\u4eec\u662f\u66f4\u65b0\u65b0\u7248\u672c\u7684 CRD \u8d44\u6e90\uff0c\u53ef\u4ee5\u770b\u5230\u65b0\u589e\u4e86 <code>4</code> \u4e2a <code>CRD</code>\uff0c\u56e0\u4e3a\u73b0\u5728\u5f15\u5165\u4e86 <code>Gateway API</code>\u3002</p> <pre><code>$ kubectl get crd |grep linkerd\nauthorizationpolicies.policy.linkerd.io                    2022-09-11T02:56:13Z\nhttproutes.policy.linkerd.io                               2022-09-11T02:56:13Z\nmeshtlsauthentications.policy.linkerd.io                   2022-09-11T02:56:14Z\nnetworkauthentications.policy.linkerd.io                   2022-09-11T02:56:14Z\nserverauthorizations.policy.linkerd.io                     2022-08-19T04:06:33Z\nservers.policy.linkerd.io                                  2022-08-19T04:06:33Z\nserviceprofiles.linkerd.io                                 2022-08-19T04:06:33Z\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u65b0\u589e\u7684 Gateway API \u76f8\u5173\u7684 CRD \u5e76\u4e0d\u662f\u539f\u59cb Kubernetes \u4e0b\u9762\u5b9a\u4e49\u7684\uff0c\u800c\u662f\u4e5f\u662f\u5728 <code>policy.linkerd.io</code> \u7684\u7ec4\u4e0b\u9762\uff0c\u8fd9\u662f\u56e0\u4e3a Linkerd \u5bf9\u8fd9\u4e9b CRD \u4e5f\u505a\u4e86\u4e00\u4e9b\u9002\u914d\u3002</p> <p>\u63a5\u4e0b\u6765\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u66f4\u65b0\u63a7\u5236\u5e73\u9762\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ linkerd upgrade | \\\n kubectl apply --prune -l linkerd.io/control-plane-ns=linkerd -f -\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u518d\u6b21\u8fd0\u884c\u6b64\u547d\u4ee4\u5e76\u6dfb\u52a0\u4e00\u4e9b <code>--prune-whitelist</code> \u6807\u5fd7\uff0c\u8fd9\u53ef\u4ee5\u786e\u4fdd\u6b63\u786e\u4fee\u526a\u67d0\u4e9b\u96c6\u7fa4\u8303\u56f4\u7684\u8d44\u6e90\u6240\u5fc5\u9700\u7684\u3002</p> <pre><code>$ linkerd upgrade | kubectl apply --prune -l linkerd.io/control-plane-ns=linkerd \\\n  --prune-whitelist=rbac.authorization.k8s.io/v1/clusterrole \\\n  --prune-whitelist=rbac.authorization.k8s.io/v1/clusterrolebinding \\\n  --prune-whitelist=apiregistration.k8s.io/v1/apiservice -f -\n</code></pre> <p>\u5347\u7ea7\u8fc7\u7a0b\u5b8c\u6210\u540e\uff0c\u540c\u6837\u53ef\u4ee5\u8fd0\u884c\u68c0\u67e5\u547d\u4ee4\u6765\u786e\u4fdd\u4e00\u5207\u6b63\u5e38\uff1a</p> <pre><code>$ linkerd check\n</code></pre> <p>\u8be5\u547d\u4ee4\u5c06\u9488\u5bf9\u63a7\u5236\u5e73\u9762\u8fdb\u884c\u4e00\u7cfb\u5217\u68c0\u67e5\uff0c\u5e76\u786e\u4fdd\u5176\u6b63\u5e38\u8fd0\u884c\u3002</p> <p>\u73b0\u5728\u518d\u6b21\u67e5\u770b Linkerd \u7248\u672c\uff0c\u6b63\u5e38 Server \u7aef\u7684\u7248\u672c\u4e5f\u66f4\u65b0\u4e86\u3002</p> <pre><code>$ linkerd version\nClient version: stable-2.12.0\nServer version: stable-2.12.0\n</code></pre> <p>\u63a5\u7740\u6211\u4eec\u5c31\u53ef\u4ee5\u5347\u7ea7\u6570\u636e\u5e73\u9762\u4e86\uff0c\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u5728\u4f60\u7684\u670d\u52a1\u4e0a\u8fd0\u884c\u6eda\u52a8\u90e8\u7f72\uff0c\u5141\u8bb8\u4ee3\u7406\u6ce8\u5165\u5668\u5728\u5b83\u4eec\u51fa\u73b0\u65f6\u6ce8\u5165\u6700\u65b0\u7248\u672c\u7684\u4ee3\u7406\u3002</p> <pre><code>$ kubectl -n &lt;namespace&gt; rollout restart deploy\n</code></pre> <p>\u4e00\u822c\u6765\u8bf4\u7a33\u5b9a\u7248\u7684\u63a7\u5236\u5e73\u9762\u4e0e\u4e0a\u4e00\u4e2a\u7a33\u5b9a\u7248\u7684\u6570\u636e\u5e73\u9762\u662f\u517c\u5bb9\u7684\uff0c\u6240\u4ee5\u6570\u636e\u5e73\u9762\u7684\u5347\u7ea7\u53ef\u4ee5\u5728\u63a7\u5236\u5e73\u9762\u5347\u7ea7\u540e\u7684\u4efb\u4f55\u65f6\u5019\u8fdb\u884c\uff0c\u4f46\u662f\u4e0d\u5efa\u8bae\u8d85\u8fc7\u4e00\u4e2a\u7a33\u5b9a\u7248\u672c\u7684\u5dee\u8ddd\u3002</p> <p>\u540c\u6837\u66f4\u65b0\u5b8c\u6210\u540e\u53ef\u4ee5\u4f7f\u7528 check \u547d\u4ee4\u6765\u6821\u9a8c\u6570\u636e\u5e73\u9762\u72b6\u6001\u3002</p> <pre><code>$ linkerd check --proxy\n# ......\nlinkerd-data-plane\n------------------\n\u221a data plane namespace exists\n\u221a data plane proxies are ready\n\u203c data plane is up-to-date\n    some proxies are not running the current version:\n        * emoji-696d9d8f95-5vn9w (stable-2.11.1)\n        * vote-bot-646b9fd6fd-8xj2j (stable-2.11.1)\n        * voting-ff4c54b8d-xhjv7 (stable-2.11.1)\n        * web-5f86686c4d-58p7k (stable-2.11.1)\n        * web-svc-2-f9d77474f-vxlrh (stable-2.11.1)\n        * ingress-nginx-controller-f56c7f6fd-rxhrs (stable-2.11.1)\n    see https://linkerd.io/2.12/checks/#l5d-data-plane-version for hints\n\u203c data plane and cli versions match\n    emoji-696d9d8f95-5vn9w running stable-2.11.1 but cli running stable-2.12.0\n    see https://linkerd.io/2.12/checks/#l5d-data-plane-cli-version for hints\n\u221a data plane pod labels are configured correctly\n\u221a data plane service labels are configured correctly\n\u221a data plane service annotations are configured correctly\n\u221a opaque ports are properly annotated\n\nLinkerd extensions checks\n=========================\n\n- Running smi extension check\n</code></pre> <p>\u8be5\u547d\u4ee4\u901a\u8fc7\u4e00\u7ec4\u68c0\u67e5\u6765\u9a8c\u8bc1\u6570\u636e\u5e73\u9762\u662f\u5426\u6b63\u5e38\u8fd0\u884c\uff0c\u5e76\u5c06\u5217\u51fa\u4ecd\u5728\u8fd0\u884c\u65e7\u7248\u672c\u4ee3\u7406\u7684 pod\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u53bb\u5347\u7ea7\u5bf9\u5e94\u7684 pod \u5373\u53ef\u3002</p>"},{"location":"chap11/8linkerd_212/#linkerd-viz","title":"Linkerd Viz \u6269\u5c55","text":"<p>\u53e6\u5916\u8fd8\u6709\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u662f viz \u63d2\u4ef6\uff0c\u5728\u6700\u65b0\u7248\u672c\u4e2d\u5df2\u7ecf\u6ca1\u6709\u5185\u7f6e grafana \u4e86\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u5148\u76f4\u63a5\u5c06\u8be5\u63d2\u4ef6\u5378\u8f7d\u5e72\u51c0\uff08\u8be5\u63d2\u4ef6\u4e0d\u4f1a\u5f71\u54cd\u7f51\u683c\u7684\u6838\u5fc3\u529f\u80fd\uff09\uff0c\u7136\u540e\u91cd\u65b0\u5b89\u88c5\u6700\u65b0\u7248\u672c\u3002</p> <pre><code>$ linkerd viz install | kubectl delete -f -\n</code></pre> <p>\u5378\u8f7d\u5b8c\u6210\u540e\u91cd\u65b0\u5b89\u88c5\uff0c\u7531\u4e8e\u65b0\u7248\u672c\u5df2\u7ecf\u6ca1\u6709\u5185\u7f6e Grafana \u4e86\uff0c\u6211\u4eec\u91cd\u65b0\u5b89\u88c5\u7684\u4f7f\u7528\u53ef\u4ee5\u901a\u8fc7 <code>--set grafana.url</code> \u6765\u6307\u5b9a\u5916\u90e8\u7684 <code>Grafana</code> \u5730\u5740\uff08\u5982\u679c\u662f\u96c6\u7fa4\u5916\u7684\u5730\u5740\u53ef\u4ee5\u901a\u8fc7 <code>grafana.externalUrl</code> \u53c2\u6570\u6307\u5b9a\uff09\uff0c\u540c\u6837\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5916\u90e8\u7684 Prometheus\uff1a</p> <pre><code>$ linkerd viz install --set grafana.url=grafana:3000,prometheusUrl=http://prometheus.kube-mon.svc.cluster.local:9090,prometheus.enabled=false | kubectl apply -f -\n</code></pre> <p>\u91cd\u65b0\u5b89\u88c5\u540e\u67e5\u770b viz \u7684 pod \u5217\u8868\uff1a</p> <pre><code>$ kubectl get pods -n linkerd-viz\nNAME                           READY   STATUS    RESTARTS   AGE\nmetrics-api-674bf48d7f-kzr5b   2/2     Running   0          17m\ntap-67d6d8ff4d-q7nqn           2/2     Running   0          5m21s\ntap-injector-7c565f754-jgvc5   2/2     Running   0          5m20s\nweb-87b958bcf-d5pfp            2/2     Running   0          5m20s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u6ca1\u6709\u4e86 Grafana \u548c Prometheus \u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u5bf9\u63a5\u7684\u5916\u90e8 Prometheus\uff0c\u800c Grafana \u5219\u662f\u65b0\u7248\u672c\u4e2d\u6ca1\u6709\u5185\u7f6e\u4f7f\u7528\u4e86\uff0c\u4e0a\u9762\u6211\u4eec\u6307\u5b9a\u7684 Grafana \u5730\u5740\u5728 viz \u540c\u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u624b\u52a8\u5b89\u88c5\u4e00\u4e2a\u5373\u53ef\u3002</p> <p>\u5982\u679c\u5355\u4e2a Grafana \u5b9e\u4f8b\u6307\u5411\u591a\u4e2a Linkerd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u5176 UID \u4e2d\u7684\u4e0d\u540c\u524d\u7f00\u5206\u9694\u4eea\u8868\u677f\uff0c\u53ef\u4ee5\u5728\u6bcf\u4e2a Linkerd \u5b9e\u4f8b\u7684 grafana.uidPrefix \u8bbe\u7f6e\u4e2d\u914d\u7f6e\u8fd9\u4e9b\u524d\u7f00\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 Helm Chart \u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u5b9a\u5236\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a</p> <pre><code>podAnnotations:\n  linkerd.io/inject: enabled\n\ngrafana.ini:\n  server:\n    root_url: \"%(protocol)s://%(domain)s:/grafana/\"\n  auth:\n    disable_login_form: true\n  auth.anonymous:\n    enabled: true\n    org_role: Editor\n  auth.basic:\n    enabled: false\n  analytics:\n    check_for_updates: false\n  panels:\n    disable_sanitize_html: true\n  log:\n    mode: console\n  log.console:\n    format: text\n    level: info\n\ndatasources:\n  datasources.yaml:\n    apiVersion: 1\n    datasources:\n      - name: prometheus\n        type: prometheus\n        access: proxy\n        orgId: 1\n        url: http://prometheus.kube-mon.svc.cluster.local:9090\n        isDefault: true\n        jsonData:\n          timeInterval: \"5s\"\n        editable: true\n\ndashboardProviders:\n  dashboardproviders.yaml:\n    apiVersion: 1\n    providers:\n      - name: \"default\"\n        orgId: 1\n        folder: \"\"\n        type: file\n        disableDeletion: false\n        editable: true\n        options:\n          path: /var/lib/grafana/dashboards/default\n\ndashboards:\n  default:\n    # all these charts are hosted at https://grafana.com/grafana/dashboards/{id}\n    top-line:\n      gnetId: 15474\n      revision: 3\n      datasource: prometheus\n    health:\n      gnetId: 15486\n      revision: 2\n      datasource: prometheus\n    kubernetes:\n      gnetId: 15479\n      revision: 2\n      datasource: prometheus\n    namespace:\n      gnetId: 15478\n      revision: 2\n      datasource: prometheus\n    deployment:\n      gnetId: 15475\n      revision: 5\n      datasource: prometheus\n    pod:\n      gnetId: 15477\n      revision: 2\n      datasource: prometheus\n    service:\n      gnetId: 15480\n      revision: 2\n      datasource: prometheus\n    route:\n      gnetId: 15481\n      revision: 2\n      datasource: prometheus\n    authority:\n      gnetId: 15482\n      revision: 2\n      datasource: prometheus\n    cronjob:\n      gnetId: 15483\n      revision: 2\n      datasource: prometheus\n    job:\n      gnetId: 15487\n      revision: 2\n      datasource: prometheus\n    daemonset:\n      gnetId: 15484\n      revision: 2\n      datasource: prometheus\n    replicaset:\n      gnetId: 15491\n      revision: 2\n      datasource: prometheus\n    statefulset:\n      gnetId: 15493\n      revision: 2\n      datasource: prometheus\n    replicationcontroller:\n      gnetId: 15492\n      revision: 2\n      datasource: prometheus\n    prometheus:\n      gnetId: 15489\n      revision: 2\n      datasource: prometheus\n    prometheus-benchmark:\n      gnetId: 15490\n      revision: 2\n      datasource: prometheus\n    multicluster:\n      gnetId: 15488\n      revision: 2\n      datasource: prometheus\n</code></pre> <p>\u4e0a\u9762\u7684 values \u6587\u4ef6\u4e2d\u6211\u4eec\u6ce8\u5165\u4e86 <code>linkerd.io/inject: enabled</code>\u8fd9\u4e2a\u6ce8\u89e3\uff0c\u4e3a\u5176\u6ce8\u5165 Linkerd \u7684 proxy\uff0c\u7136\u540e\u8fd8\u8981\u6ce8\u610f\u914d\u7f6e Prometheus \u6570\u636e\u6e90\u5730\u5740\u3002</p> <pre><code>$ helm repo add grafana https://grafana.github.io/helm-charts\n$ helm upgrade --install grafana -n linkerd-viz grafana/grafana -f values.yaml\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5df2\u7ecf\u6709\u4e00\u4e2a\u5916\u90e8\u7684 Grafana\uff0c\u90a3\u4e48\u5728\u5b89\u88c5\u7684\u65f6\u5019\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>grafana.externalUrl</code> \u6765\u6307\u5b9a\uff1a</p> <pre><code>$ linkerd viz install --set grafana.externalUrl=http://192.168.0.106:30403,prometheusUrl=http://prometheus.kube-mon.svc.cluster.local:9090,prometheus.enabled=false | kubectl apply -f -\n</code></pre> <p>\u8fd9\u6837\u66f4\u65b0\u540e\u8bb0\u5f97\u8981\u5728\u5916\u90e8 Grafana \u4e2d\u5bfc\u5165 Linkerd \u76f8\u5173\u7684 Dashboard\uff0c\u53ef\u4ee5\u4ece Grafana \u5b98\u7f51 https://grafana.com/orgs/linkerd \u83b7\u53d6\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5bfc\u5165 Deployments \u7684 dashboard\uff0c\u53ef\u4ee5\u5bfc\u5165 15475 \u8fd9\u4e2a ID\uff0c\u6216\u8005\u4e0b\u8f7d JSON \u6587\u4ef6\u4e0a\u4f20\u5bfc\u5165\u3002</p> <p></p> <p>\u5bfc\u5165\u540e\u91cd\u65b0\u8bbf\u95ee Viz \u7684 Dashboard\uff1a</p> <p></p> <p>\u540c\u6837\u70b9\u51fb\u9875\u9762\u4e0a\u7684 Grafana \u56fe\u6807\u5c31\u53ef\u4ee5\u76f4\u63a5\u8df3\u8f6c\u5230 Grafana Dashboard \u9875\u9762\uff1a</p> <p></p>"},{"location":"chap12/0apigatway_intro/","title":"0 \u5fae\u670d\u52a1\u4e3a\u4ec0\u4e48\u8981\u7528\u5230 API \u7f51\u5173\uff1f","text":""},{"location":"chap12/0apigatway_intro/#_1","title":"\u4ec0\u4e48\u662f\u5fae\u670d\u52a1","text":"<p>\u5fae\u670d\u52a1\u67b6\u6784\uff08\u901a\u5e38\u7b80\u79f0\u4e3a\u5fae\u670d\u52a1\uff09\u662f\u6307\u5f00\u53d1\u5e94\u7528\u6240\u7528\u7684\u4e00\u79cd\u67b6\u6784\u5f62\u5f0f\u3002</p> <p>\u901a\u8fc7\u5fae\u670d\u52a1\uff0c\u53ef\u5c06\u5927\u578b\u5e94\u7528\u5206\u89e3\u6210\u591a\u4e2a\u72ec\u7acb\u7684\u7ec4\u4ef6\uff0c\u5176\u4e2d\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u6709\u5404\u81ea\u7684\u8d23\u4efb\u9886\u57df\u3002\u5728\u5904\u7406\u4e00\u4e2a\u7528\u6237\u8bf7\u6c42\u65f6\uff0c\u57fa\u4e8e\u5fae\u670d\u52a1\u7684\u5e94\u7528\u53ef\u80fd\u4f1a\u8c03\u7528\u8bb8\u591a\u5185\u90e8\u5fae\u670d\u52a1\u6765\u5171\u540c\u751f\u6210\u5176\u54cd\u5e94\u3002</p> <p>\u5fae\u670d\u52a1\u662f\u4e92\u8054\u7f51\u4e1a\u52a1\u53d1\u5c55\u7684\u7ed3\u679c\uff0c\u4e92\u8054\u7f51\u4e1a\u52a1\u7684\u98de\u901f\u53d1\u5c55\u5bfc\u81f4\u7cfb\u7edf\u7684\u67b6\u6784\u4e5f\u5728\u4e0d\u65ad\u5730\u53d1\u751f\u53d8\u5316\uff0c\u603b\u4f53\u6765\u8bf4\uff0c\u7cfb\u7edf\u7684\u67b6\u6784\u5927\u81f4\u7ecf\u5386\u4e86\uff1a\u5355\u4f53\u5e94\u7528\u67b6\u6784\u2014&gt; SOA \u67b6\u6784\u2014&gt;\u5fae\u670d\u52a1\u67b6\u6784\u7684\u6f14\u53d8\uff0c\u5177\u4f53\u53d1\u5c55\u5386\u7a0b\u548c\u5404\u81ea\u7684\u4f18\u7f3a\u70b9\u5982\u4e0b\u8868\u6240\u793a\u3002</p>"},{"location":"chap12/0apigatway_intro/#_2","title":"\u5355\u4f53\u5e94\u7528\u67b6\u6784","text":"<p>\u6240\u6709\u6a21\u5757\u8026\u5408\u5728\u4e00\u8d77\uff0c\u6bd4\u8f83\u6709\u5229\u4e8e\u5c0f\u578b\u9879\u76ee\u7684\u5f00\u53d1\u548c\u7ef4\u62a4\uff1b\u4f46\u662f\uff0c\u5bf9\u4e8e\u5927\u578b\u9879\u76ee\u6765\u8bf4\u5374\u5b58\u5728\u95ee\u9898\uff0c\u6bd4\u5982\uff1a</p> <ol> <li>\u9879\u76ee\u5404\u6a21\u5757\u4e4b\u95f4\u8fc7\u4e8e\u8026\u5408\uff0c\u4e00\u4e2a\u6a21\u5757\u7684\u6027\u80fd\u95ee\u9898\u53ef\u80fd\u5bfc\u81f4\u6574\u4e2a\u9879\u76ee\u7684\u4e0d\u53ef\u7528\uff1b</li> <li>\u9879\u76ee\u7684\u6269\u5c55\u6027\u5dee\u3002</li> </ol>"},{"location":"chap12/0apigatway_intro/#soa","title":"SOA \u67b6\u6784","text":"<p>\u4e00\u4e2a\u670d\u52a1\u901a\u5e38\u4ee5\u72ec\u7acb\u7684\u5f62\u5f0f\u5b58\u5728\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u8fdb\u7a0b\u4e2d\uff0c\u670d\u52a1\u4e4b\u95f4\u901a\u8fc7\u76f8\u4e92\u4f9d\u8d56\u6216\u8005\u901a\u8fc7\u901a\u4fe1\u673a\u5236\u6765\u5b8c\u6210\u901a\u4fe1\u7684\uff0c</p> <p>\u4f18\u70b9</p> <ol> <li>\u7cfb\u7edf\u96c6\u6210\uff1a\u7ad9\u5728\u7cfb\u7edf\u7684\u89d2\u5ea6\uff0c\u89e3\u51b3\u4f01\u4e1a\u7cfb\u7edf\u95f4\u7684\u901a\u4fe1\u95ee\u9898\uff0c\u628a\u539f\u5148\u6563\u4e71\u3001\u65e0\u89c4\u5212\u7684\u7cfb\u7edf\u95f4\u7684\u7f51\u72b6\u7ed3\u6784\uff0c\u68b3\u7406\u6210\u89c4\u6574\u3001\u53ef\u6cbb\u7406\u7684\u7cfb\u7edf\u95f4\u661f\u5f62\u7ed3\u6784\uff1b</li> <li>\u7cfb\u7edf\u7684\u670d\u52a1\u5316\uff1a\u7ad9\u5728\u529f\u80fd\u7684\u89d2\u5ea6\uff0c\u628a\u4e1a\u52a1\u903b\u8f91\u62bd\u8c61\u6210\u53ef\u590d\u7528\u3001\u53ef\u7ec4\u88c5\u7684\u670d\u52a1\uff0c\u901a\u8fc7\u670d\u52a1\u7684\u7f16\u6392\u5b9e\u73b0\u4e1a\u52a1\u7684\u5feb\u901f\u518d </li> <li>\u4e1a\u52a1\u7684\u670d\u52a1\u5316\uff1a\u7ad9\u5728\u4f01\u4e1a\u7684\u89d2\u5ea6\uff0c\u628a\u4f01\u4e1a\u804c\u80fd\u62bd\u8c61\u6210\u53ef\u590d\u7528\u3001\u53ef\u7ec4\u88c5\u7684\u670d\u52a1\u3002</li> </ol> <p>\u7f3a\u70b9</p> <ol> <li>\u670d\u52a1\u7684\u4e2d\u5fc3\u5316\uff0c\u5404\u670d\u52a1\u4e4b\u95f4\u5b58\u5728\u4f9d\u8d56\u5173\u7cfb\uff0c\u5982\u679c\u67d0\u4e2a\u670d\u52a1\u51fa\u73b0\u6545\u969c\u53ef\u80fd\u4f1a\u9020\u6210\u670d\u52a1\u7684\u96ea\u5d29\uff1b</li> <li>\u670d\u52a1\u4e4b\u95f4\u7684\u4f9d\u8d56\u4e0e\u8c03\u7528\u5173\u7cfb\u590d\u6742\uff0c\u6d4b\u8bd5\u90e8\u7f72\u7684\u56f0\u96be\u6bd4\u8f83\u5927\u3002</li> </ol>"},{"location":"chap12/0apigatway_intro/#_3","title":"\u5fae\u670d\u52a1\u67b6\u6784","text":"<p>\u5fae\u670d\u52a1\u662f\u5728 SOA \u4e0a\u505a\u7684\u5347\u534e\u3002\u5fae\u670d\u52a1\u67b6\u6784\u91cd\u70b9\u5f3a\u8c03\u7684\u4e00\u4e2a\u662f\"\u4e1a\u52a1\u9700\u8981\u5f7b\u5e95\u7684\u7ec4\u4ef6\u5316\u548c\u670d\u52a1\u5316\"\uff0c \u539f\u6709\u7684\u5355\u4e2a\u4e1a\u52a1\u7cfb\u7edf\u4f1a\u62c6\u5206\u4e3a\u591a\u4e2a\u53ef\u4ee5\u72ec\u7acb\u5f00\u53d1\u3001\u8bbe\u8ba1\u3001 \u8fd0\u884c\u7684\u5c0f\u5e94\u7528\u3002</p> <p>\u5404\u4e2a\u5c0f\u5e94\u7528\u4e4b\u95f4\uff0c\u76f8\u4e92\u53bb\u534f\u4f5c\u901a\u4fe1\uff0c\u6765\u5b8c\u6210\u4e00\u4e2a\u4ea4\u4e92\u548c\u96c6\u6210\uff0c\u8fd9\u5c31\u662f\u5fae\u670d\u52a1\u67b6\u6784\u3002</p> <p>\u4f18\u70b9</p> <ol> <li>\u53bb\u4e2d\u5fc3\u5316\uff1b</li> <li>\u901a\u8fc7\u670d\u52a1\u5b9e\u73b0\u7ec4\u4ef6\u5316\uff1b</li> <li>\u6309\u4e1a\u52a1\u80fd\u529b\u6765\u5212\u5206\u670d\u52a1\u548c\u5f00\u53d1\u56e2\u961f\uff1b</li> <li>\u57fa\u7840\u8bbe\u65bd\u81ea\u52a8\u5316\uff08 Devops\u3001\u81ea\u52a8\u5316\u90e8\u7f72\uff09\u3002</li> </ol> <p>\u7f3a\u70b9</p> <ol> <li>\u5f00\u53d1\u7684\u6210\u672c\u6bd4\u8f83\u9ad8\uff1b</li> <li>\u4f1a\u5f15\u53d1\u670d\u52a1\u7684\u5bb9\u9519\u6027\u95ee\u9898\uff1b</li> <li>\u4f1a\u5f15\u53d1\u6570\u636e\u7684\u4e00\u81f4\u6027\u95ee\u9898\uff1b</li> <li>\u4f1a\u6d89\u53ca\u5206\u5e03\u5f0f\u4e8b\u52a1\u3002</li> </ol> <p>\u56e0\u6b64\uff0c\u5fae\u670d\u52a1\u662f\u4e92\u8054\u7f51\u53d1\u5c55\u7684\u5fc5\u7136\u7ed3\u679c\uff0c\u5f88\u591a\u4f20\u7edf\u516c\u53f8\u7684\u7cfb\u7edf\u67b6\u6784\u4e5f\u5728\u9010\u6b65\u5fae\u670d\u52a1\u5316\u3002\u4f46\u662f\uff0c\u968f\u7740\u4e92\u8054\u7f51\u4e1a\u52a1\u7684\u53d1\u5c55\uff0cAPI \u7684\u6570\u91cf\u4e5f\u5728\u5267\u589e\uff0c\u4f7f\u7528\u7f51\u5173\u5bf9API\u7edf\u4e00\u7ba1\u7406\u4e5f\u5c06\u9762\u4e34\u6311\u6218\uff0c\u9009\u62e9\u4e00\u4e2a\u66f4\u5f3a\u5927\u7684 API \u7f51\u5173\uff0c\u53ef\u4ee5\u6709\u6548\u5730\u589e\u5f3a\u7cfb\u7edf\u7684\u76d1\u63a7\u3001\u5bb9\u707e\u3001\u9274\u6743\u548c\u9650\u6d41\u7b49\u80fd\u529b\u3002</p>"},{"location":"chap12/0apigatway_intro/#api","title":"\u4ec0\u4e48\u662f API \u7f51\u5173","text":"<p>API \u7f51\u5173\u4e3a\u5ba2\u6237\u4e0e\u670d\u52a1\u7cfb\u7edf\u4e4b\u95f4\u7684\u4ea4\u4e92\u63d0\u4f9b\u4e86\u7edf\u4e00\u7684\u63a5\u53e3\uff0c\u4e5f\u662f\u7ba1\u7406\u8bf7\u6c42\u548c\u54cd\u5e94\u7684\u4e2d\u5fc3\u70b9\uff0c\u9009\u62e9\u4e00\u4e2a\u9002\u5408\u7684 API \u7f51\u5173\uff0c\u53ef\u4ee5\u6709\u6548\u5730\u7b80\u5316\u5f00\u53d1\u5e76\u63d0\u9ad8\u7cfb\u7edf\u7684\u8fd0\u7ef4\u4e0e\u7ba1\u7406\u6548\u7387\u3002</p> <p>API \u7f51\u5173\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u662f\u7cfb\u7edf\u8bbe\u8ba1\u7684\u4e00\u4e2a\u89e3\u51b3\u65b9\u6848\uff0c\u7528\u6765\u6574\u5408\u5404\u4e2a\u4e0d\u540c\u6a21\u5757\u7684\u5fae\u670d\u52a1\uff0c\u7edf\u4e00\u534f\u8c03\u670d\u52a1\u3002API \u7f51\u5173\u4f5c\u4e3a\u4e00\u4e2a\u7cfb\u7edf\u8bbf\u95ee\u7684\u5207\u9762\uff0c\u5bf9\u5916\u63d0\u4f9b\u7edf\u4e00\u7684\u5165\u53e3\u4f9b\u5ba2\u6237\u7aef\u8bbf\u95ee\uff0c\u9690\u85cf\u7cfb\u7edf\u67b6\u6784\u5b9e\u73b0\u7684\u7ec6\u8282\uff0c\u8ba9\u5fae\u670d\u52a1\u4f7f\u7528\u66f4\u4e3a\u53cb\u597d\uff1b</p> <p>\u5e76\u96c6\u6210\u4e86\u4e00\u4e9b\u901a\u7528\u7279\u6027\uff08\u5982\u9274\u6743\u3001\u9650\u6d41\u3001\u7194\u65ad\uff09\uff0c\u907f\u514d\u6bcf\u4e2a\u5fae\u670d\u52a1\u5355\u72ec\u5f00\u53d1\uff0c\u63d0\u5347\u6548\u7387\uff0c\u4f7f\u7cfb\u7edf\u66f4\u52a0\u6807\u51c6\u5316\uff0c\u6bd4\u5982\u8eab\u4efd\u9a8c\u8bc1\u3001\u76d1\u63a7\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u9650\u6d41\u3001\u964d\u7ea7\u4e0e\u5e94\u7528\u68c0\u6d4b\u7b49\u529f\u80fd\u3002</p>"},{"location":"chap12/0apigatway_intro/#api_1","title":"\u4e3a\u4ec0\u4e48\u5fae\u670d\u52a1\u9700\u8981 API \u7f51\u5173","text":"<p>\u5982\u4e0a\u56fe\u6240\u793a\uff0cAPI \u7f51\u5173\u4f5c\u4e3a\u5ba2\u6237\u7aef\u548c\u5fae\u670d\u52a1\u7684\u4e2d\u95f4\u5c42\uff0c\u5b83\u53ef\u4ee5\u5c06\u5fae\u670d\u52a1\u4ee5\u7edf\u4e00\u7684\u5730\u5740\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u5c06\u5916\u90e8\u8bbf\u95ee\u8fd9\u4e2a\u5730\u5740\u7684\u6d41\u91cf\uff0c\u6839\u636e\u9002\u5f53\u7684\u89c4\u5219\u8def\u7531\u5230\u5185\u90e8\u96c6\u7fa4\u4e2d\u6b63\u786e\u7684\u670d\u52a1\u8282\u70b9\u4e4b\u4e0a\uff0c\u5982\u679c\u6ca1\u6709 API \u7f51\u5173\uff0c\u6d41\u91cf\u7684\u51fa\u5165\u53e3\u5219\u4e0d\u7edf\u4e00\uff0c\u5ba2\u6237\u7aef\u5c31\u9700\u8981\u77e5\u9053\u6240\u6709\u670d\u52a1\u7684\u8bbf\u95ee\u4fe1\u606f\uff0c\u5fae\u670d\u52a1\u7684\u610f\u4e49\u5c06\u4e0d\u590d\u5b58\u5728\uff0c\u6240\u4ee5\uff0c\u5fae\u670d\u52a1\u7f51\u5173\u5728\u5fae\u670d\u52a1\u7cfb\u7edf\u67b6\u6784\u4e2d\u7684\u5b58\u5728\u662f\u5fc5\u8981\u7684\u3002</p> <p>\u6b64\u5916\uff0cAPI \u7f51\u5173\u5728\u7cfb\u7edf\u7684\u53ef\u89c2\u6d4b\u6027\u3001\u8eab\u4efd\u9274\u6743\u8ba4\u8bc1\u3001\u7a33\u5b9a\u6027\u548c\u670d\u52a1\u53d1\u73b0\u7b49\u65b9\u9762\u4e5f\u4f1a\u53d1\u6325\u91cd\u8981\u4f5c\u7528\u3002</p>"},{"location":"chap12/0apigatway_intro/#_4","title":"\u5fae\u670d\u52a1\u9047\u5230\u7684\u6311\u6218","text":"<p>\u5fae\u670d\u52a1\u7f51\u5173\u5e94\u8be5\u9996\u5148\u8981\u5177\u5907 API \u8def\u7531\u80fd\u529b\uff0c\u5fae\u670d\u52a1\u6570\u91cf\u53d8\u591a\uff0cAPI \u6570\u91cf\u6025\u5267\u589e\u52a0\uff0c\u7f51\u5173\u8fd8\u53ef\u4ee5\u6839\u636e\u5177\u4f53\u7684\u573a\u666f\u4f5c\u4e3a\u6d41\u91cf\u8fc7\u6ee4\u5668\u6765\u4f7f\u7528\uff0c\u4ee5\u63d0\u4f9b\u67d0\u4e9b\u989d\u5916\u53ef\u9009\u529f\u80fd\uff0c\u56e0\u6b64\u5bf9\u5fae\u670d\u52a1 API Gateway \u63d0\u51fa\u4e86\u66f4\u9ad8\u8981\u6c42\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u53ef\u89c2\u6d4b\u6027\uff1a\u5728\u4ee5\u5f80\u7684\u5355\u4f53\u5e94\u7528\u4e2d\uff0c\u6392\u67e5\u95ee\u9898\u5f80\u5f80\u901a\u8fc7\u67e5\u770b\u65e5\u5fd7\u5b9a\u4f4d\u9519\u8bef\u4fe1\u606f\u548c\u5f02\u5e38\u5806\u6808\uff1b\u4f46\u662f\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u670d\u52a1\u7e41\u591a\uff0c\u51fa\u73b0\u95ee\u9898\u65f6\u7684\u95ee\u9898\u5b9a\u4f4d\u53d8\u5f97\u975e\u5e38\u56f0\u96be\uff1b\u56e0\u6b64\uff0c\u5982\u4f55\u76d1\u63a7\u5fae\u670d\u52a1\u7684\u8fd0\u884c\u72b6\u51b5\u3001\u5f53\u51fa\u73b0\u5f02\u5e38\u65f6\u80fd\u5feb\u901f\u7ed9\u51fa\u62a5\u8b66\uff0c\u8fd9\u7ed9\u5f00\u53d1\u4eba\u5458\u5e26\u6765\u5f88\u5927\u6311\u6218\u3002</li> <li>\u9274\u6743\u8ba4\u8bc1\uff1a\u800c\u5fae\u670d\u52a1\u67b6\u6784\u4e0b\uff0c\u4e00\u4e2a\u5e94\u7528\u4f1a\u88ab\u62c6\u5206\u6210\u82e5\u5e72\u4e2a\u5fae\u5e94\u7528\uff0c\u6bcf\u4e2a\u5fae\u5e94\u7528\u90fd\u9700\u8981\u5bf9\u8bbf\u95ee\u8fdb\u884c\u9274\u6743\uff0c\u6bcf\u4e2a\u5fae\u5e94\u7528\u90fd\u9700\u8981\u660e\u786e\u5f53\u524d\u8bbf\u95ee\u7528\u6237\u4ee5\u53ca\u5176\u6743\u9650\u3002\u5c24\u5176\u5f53\u8bbf\u95ee\u6765\u6e90\u4e0d\u53ea\u662f\u6d4f\u89c8\u5668\uff0c\u8fd8\u5305\u62ec\u5176\u5b83\u670d\u52a1\u7684\u8c03\u7528\u65f6\uff0c\u5355\u4f53\u5e94\u7528\u67b6\u6784\u4e0b\u7684\u9274\u6743\u65b9\u5f0f\u5c31\u4e0d\u662f\u7279\u522b\u5408\u9002\u4e86\u3002\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e0b\uff0c\u8981\u8003\u8651\u5916\u90e8\u5e94\u7528\u63a5\u5165\u7684\u573a\u666f\u3001\u7528\u6237 - \u670d\u52a1\u7684\u9274\u6743\u3001\u670d\u52a1 - \u670d\u52a1\u7684\u9274\u6743\u7b49\u591a\u79cd\u9274\u6743\u573a\u666f\u3002</li> <li>\u7cfb\u7edf\u7a33\u5b9a\u6027\uff1a\u82e5\u5927\u91cf\u8bf7\u6c42\u8d85\u8fc7\u5fae\u670d\u52a1\u7684\u5904\u7406\u80fd\u529b\u65f6\uff0c\u53ef\u80fd\u4f1a\u5c06\u670d\u52a1\u6253\u57ae\uff0c\u751a\u81f3\u4ea7\u751f\u96ea\u5d29\u6548\u5e94\u3001\u5f71\u54cd\u7cfb\u7edf\u7684\u6574\u4f53\u7a33\u5b9a\u6027\u3002</li> <li>\u670d\u52a1\u53d1\u73b0\uff1a\u5fae\u670d\u52a1\u7684\u5206\u6563\u7ba1\u7406\uff0c\u8ba9\u5fae\u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\u7684\u5b9e\u73b0\u4e5f\u66f4\u5177\u6709\u6311\u6218\u6027\u3002</li> </ul>"},{"location":"chap12/0apigatway_intro/#_5","title":"\u89e3\u51b3\u65b9\u6848","text":"<p>API \u7f51\u5173\u4f5c\u4e3a\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u7684\u4e2d\u95f4\u6865\u6881\uff0c\u4e3a\u5fae\u670d\u52a1\u7cfb\u7edf\u63d0\u4f9b\u7edf\u4e00\u7684\u7ba1\u7406\u673a\u5236\uff1a\u9664\u4e86\u57fa\u7840\u7684\u8bf7\u6c42\u5206\u53d1\u3001API \u7ba1\u7406\u548c\u6761\u4ef6\u8def\u7531\u7b49\u529f\u80fd\uff0c\u8fd8\u5305\u62ec\u8eab\u4efd\u9a8c\u8bc1\u3001\u76d1\u63a7\u62a5\u8b66\u3001\u8c03\u7528\u94fe\u8ffd\u8e2a\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u9650\u6d41\u9694\u79bb\u548c\u7194\u65ad\u964d\u7ea7\u3002</p> <p>\u8eab\u4efd\u8ba4\u8bc1\uff1a\u4e0b\u56fe\u8868\u793a\u7684\u662f\u5fae\u670d\u52a1\u8054\u5408 API \u7f51\u5173\u5982\u4f55\u8fdb\u884c\u8eab\u4efd\u8ba4\u8bc1\u7684\uff0c\u7531\u56fe\u53ef\u89c1\u6240\u6709\u8bf7\u6c42\u90fd\u901a\u8fc7\u7f51\u5173\uff0c\u4ece\u800c\u6709\u6548\u5730\u9690\u85cf\u4e86\u5fae\u670d\u52a1\u3002</p> <p></p> <p>\u76d1\u63a7\u62a5\u8b66/\u8c03\u7528\u94fe\u8ffd\u8e2a\uff1aAPI \u4f5c\u4e3a\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u7684\u4e2d\u95f4\u6865\u6881\uff0c\u662f\u5fae\u670d\u52a1\u76d1\u63a7\u7684\u6700\u597d\u8f7d\u4f53\uff0cAPI \u7f51\u5173\u76d1\u63a7\u529f\u80fd\u7684\u4e3b\u8981\u804c\u8d23\u662f\u53ca\u65f6\u53d1\u73b0\u7f51\u5173\u4ee5\u53ca\u540e\u7aef\u670d\u52a1\u5668\u7684\u8fde\u63a5\u5f02\u5e38\uff0c\u5728 API \u7684\u76d1\u63a7\u5e73\u53f0\u4e0a\u9762\u7528\u6237\u53ef\u4ee5\u968f\u65f6\u67e5\u770b\u65e5\u5fd7\u4fe1\u606f\uff0c\u76d1\u63a7\u4fe1\u606f\uff0c\u8c03\u7528\u94fe\u7b49\u7b49\uff0c\u5e76\u4e14\u4e3b\u673a\u53d1\u751f\u7684\u4efb\u4f55\u5f02\u5e38\u90fd\u4f1a\u81ea\u52a8\u62a5\u8b66\u5230\u63a7\u5236\u53f0\u3002</p> <p>\u6709\u4e9b\u7f51\u5173\u751a\u81f3\u53ef\u4ee5\u505a\u5230\u7ed9\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u53cc\u5411\u62a5\u8b66\u3002</p> <p></p> <p>\u9650\u6d41\u9694\u79bb/\u7194\u65ad\u964d\u7ea7\uff1a\u968f\u7740\u4e92\u8054\u7f51\u4e1a\u52a1\u89c4\u6a21\u7684\u589e\u52a0\uff0c\u7cfb\u7edf\u7684\u5e76\u53d1\u5ea6\u589e\u9ad8\uff0c\u591a\u4e2a\u670d\u52a1\u4e4b\u95f4\u76f8\u4e92\u8c03\u7528\u94fe\u8def\uff0c\u4e00\u6761\u6838\u5fc3\u94fe\u8def\u5f80\u5f80\u53ef\u80fd\u8c03\u7528\u5341\u4e2a\u670d\u52a1\u3002</p> <p>\u5982\u679c\u5728\u94fe\u8def\u4e2d\uff0c\u67d0\u4e2a\u670d\u52a1\u7684 rt\uff08\u54cd\u5e94\u65f6\u95f4\uff09\u6025\u5267\u4e0a\u5347\uff0c\u4e0a\u6e38\u670d\u52a1\u4e0d\u65ad\u8bf7\u6c42\uff0c\u9020\u6210\u6076\u6027\u5faa\u73af\uff0c\u4e0a\u6e38\u7b49\u5f85\u7ed3\u679c\u7ebf\u7a0b\u6570\u8d8a\u591a\uff0c\u4f7f\u5f97\u66f4\u4e0a\u6e38\u670d\u52a1\u963b\u585e\u6700\u7ec8\u6574\u6761\u94fe\u8def\u65e0\u6cd5\u4f7f\u7528\uff0c\u4ece\u800c\u5bfc\u81f4\u670d\u52a1\u96ea\u5d29\uff0c\u6240\u4ee5\u5bf9\u5165\u53e3\u6d41\u91cf\u8fdb\u884c\u6574\u6cbb\u7ba1\u7406\u662f\u5f88\u6709\u5fc5\u8981\u7684\uff0c</p> <p>\u4e0b\u56fe\u8868\u793a\u5fae\u670d\u52a1\u7cfb\u7edf\u662f\u5982\u4f55\u7ed3\u5408 API \u7f51\u5173\u8fdb\u884c\u9650\u6d41\u9694\u79bb\u548c\u7194\u65ad\u964d\u7ea7\u7684\u3002</p>"},{"location":"chap12/0apigatway_intro/#_6","title":"\u4e3b\u6d41\u7f51\u5173\u9009\u62e9","text":"<p>\u5728\u5fae\u670d\u52a1\u9886\u57df\uff0c\u6709\u8bb8\u591a\u5f00\u6e90\u7f51\u5173\u5b9e\u73b0\uff0c\u6709 NGINX\u3001Kong\u3001Apache APISIX \u548c Envoy \u7b49\uff0cJava \u6280\u672f\u6808\u7684\u6709 Netfilx Zuul\u3001Spring Cloud Gateway\u3001Soul \u7b49\u3002\u6216\u8bb8\u4f60\u4f1a\u95ee\u201c\u6709\u4e86 NGINX \u548c Kong\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 Apache APISIX \uff1f\u201d \uff0c\u4e0b\u9762\u505a\u4e2a\u7b80\u5355\u5bf9\u6bd4\u3002</p> <ul> <li>NGINX<ul> <li>\u75db\u70b9:  \u4fee\u6539\u914d\u7f6e\u9700\u8981 Reload \u624d\u80fd\u751f\u6548\uff0c\u8ddf\u4e0d\u4e0a\u4e91\u539f\u751f\u7684\u53d1\u5c55\u3002</li> </ul> </li> <li>Apache APISIX <ul> <li>\u4f18\u52bf<ul> <li>Apache \u57fa\u91d1\u4f1a\u9876\u7ea7\u9879\u76ee\uff1b</li> <li>\u6280\u672f\u67b6\u6784\u66f4\u8d34\u5408\u4e91\u539f\u751f\uff1b </li> <li>\u6027\u80fd\u8868\u73b0\u4f18\u79c0\uff1b</li> </ul> </li> </ul> </li> <li>Kong  </li> <li>\u75db\u70b9:<ul> <li>\u9ed8\u8ba4\u4f7f\u7528 PostgreSQL \u6216 Cassandra \u6570\u636e\u5e93\uff0c\u4f7f\u5f97\u6574\u4e2a\u67b6\u6784\u975e\u5e38\u81c3\u80bf\uff0c\u5e76\u4e14\u4f1a\u5e26\u6765\u9ad8\u53ef\u7528\u7684\u95ee\u9898\uff1b</li> <li>\u8def\u7531\u4f7f\u7528\u7684\u662f\u904d\u5386\u67e5\u627e\uff0c\u5f53\u7f51\u5173\u5185\u6709\u8d85\u8fc7\u4e0a\u5343\u4e2a\u8def\u7531\u65f6\uff0c\u5b83\u7684\u6027\u80fd\u5c31\u4f1a\u51fa\u73b0\u6bd4\u8f83\u6025\u5267\u7684\u4e0b\u964d\uff1b</li> <li>\u4e00\u4e9b\u91cd\u8981\u529f\u80fd\u662f\u9700\u8981\u4ed8\u8d39\u7684\u3002  </li> </ul> </li> <li> <p>\u4f18\u52bf</p> <ol> <li>\u5f00\u6e90 API \u7f51\u5173\u7684\u9f3b\u7956\uff0c\u7528\u6237\u6570\u4f17\u591a\uff1b</li> <li>\u6027\u80fd\u6ee1\u8db3\u5927\u90e8\u5206\u7528\u6237\u7684\u9700\u6c42\uff1b</li> <li>\u751f\u6001\u4e30\u5bcc\uff1b</li> <li>\u652f\u6301 Lua \u548c Go \u5f00\u53d1\u63d2\u4ef6\u3002</li> </ol> </li> <li> <p>Envoy </p> <ul> <li>\u75db\u70b9<ul> <li>\u7528 C++\uff0c\u4e8c\u6b21\u5f00\u53d1\u96be\u5ea6\u5927\uff1b</li> <li>\u9664\u4e86 C++ \u5f00\u53d1 filter \u5916\uff0c\u8fd8\u652f\u6301 WASM \u548c Lua\u3002</li> </ul> </li> <li>\u4f18\u52bf<ul> <li>CNCF \u6bd5\u4e1a\u9879\u76ee \u66f4\u9002\u5408\u670d\u52a1\u7f51\u683c\u573a\u666f\u591a\u8bed\u8a00\u67b6\u6784\u90e8\u7f72\u3002</li> </ul> </li> </ul> </li> <li> <p>Spring Cloud Gateway</p> <ul> <li>\u75db\u70b9\uff1a \u867d\u7136 Spring \u793e\u533a\u6210\u719f\uff0c\u4f46\u662f Gateway \u8d44\u6e90\u7f3a\u4e4f\u3002</li> <li>\u4f18\u52bf<ol> <li>\u5185\u7f6e\u4e86\u975e\u5e38\u591a\u7684\u5f00\u7bb1\u5373\u7528\u529f\u80fd\uff0c\u5e76\u4e14\u90fd\u53ef\u4ee5\u901a\u8fc7 SpringBoot \u914d\u7f6e\u6216\u8005\u624b\u5de5\u7f16\u7801\u94fe\u5f0f\u8c03\u7528\u6765\u4f7f\u7528\uff1b  </li> <li>Spring \u7cfb\u5217\u53ef\u6269\u5c55\u6027\u5f3a\uff0c\u6613\u914d\u7f6e\uff0c\u53ef\u7ef4\u62a4\u6027\u597d\uff1b     </li> <li>Spring \u793e\u533a\u6210\u719f\uff1b  </li> <li>\u7b80\u5355\u6613\u7528\uff1b </li> <li>\u5bf9\u4e8e Java \u6280\u672f\u6808\u6765\u8bf4\u65b9\u4fbf</li> </ol> </li> </ul> </li> </ul> <p>\u603b\u7ed3</p> <p>\u968f\u7740\u4e92\u8054\u7f51\u7684\u53d1\u5c55\uff0c\u4e92\u8054\u7f51\u4f01\u4e1a\u7684\u4e1a\u52a1\u4e5f\u5728\u4e0d\u65ad\u7684\u98de\u901f\u53d1\u5c55\uff0c\u8fdb\u800c\u5bfc\u81f4\u7cfb\u7edf\u7684\u67b6\u6784\u4e5f\u5728\u4e0d\u65ad\u7684\u53d1\u751f\u7740\u53d8\u5316\uff0c\u5fae\u670d\u52a1\u67b6\u6784\u5df2\u7ecf\u5728\u4f17\u591a\u516c\u53f8\u5f97\u5230\u5e7f\u6cdb\u5e94\u7528\u3002\u968f\u7740\u5fae\u670d\u52a1\u7684\u6570\u636e\u8d8a\u6765\u8d8a\u591a\uff0cAPI \u7684\u6570\u91cf\u4e5f\u8d8a\u6765\u8d8a\u591a\uff0c\u5bf9\u4e8e\u5927\u6d41\u91cf\u7684\u6cbb\u7406\uff0c\u9009\u62e9\u4e00\u4e2a\u4f18\u79c0\u7684 API \u7f51\u5173\u662f\u81f3\u5173\u91cd\u8981\u7684\u3002</p>"},{"location":"chap12/1api_vs_lb/","title":"API Gateway vs Load Balancer\uff1a\u9009\u62e9\u9002\u5408\u4f60\u7684\u7f51\u7edc\u6d41\u91cf\u7ba1\u7406\u7ec4\u4ef6","text":"<p>\u7531\u4e8e\u4e92\u8054\u7f51\u6280\u672f\u7684\u53d1\u5c55\uff0c\u7f51\u7edc\u6570\u636e\u7684\u8bf7\u6c42\u6570\u8282\u8282\u6500\u5347\uff0c\u8fd9\u4f7f\u5f97\u670d\u52a1\u5668\u627f\u53d7\u7684\u538b\u529b\u8d8a\u6765\u8d8a\u5927\u3002\u5728\u65e9\u671f\u7684\u7cfb\u7edf\u67b6\u6784\u4e2d\uff0c\u901a\u5e38\u4f7f\u7528 Load Balancer \u6765\u5c06\u7f51\u7edc\u6d41\u91cf\u5e73\u644a\u5230\u591a\u4e2a\u670d\u52a1\u5668\u4e2d\uff0c\u4ee5\u6b64\u51cf\u8f7b\u5355\u53f0\u670d\u52a1\u5668\u7684\u538b\u529b\u3002</p> <p>\u4f46\u662f\u73b0\u5982\u4eca\uff0c\u540e\u7aef\u670d\u52a1\u7684\u79cd\u7c7b\u5728\u4e0d\u65ad\u5730\u53d8\u591a\uff0c\u6bcf\u4e2a\u79cd\u7c7b\u7684\u540e\u7aef\u90fd\u4ee5 API \u7684\u5f62\u5f0f\u5bf9\u5916\u66b4\u9732\uff0c\u8fd9\u4f7f\u5f97 API \u7684\u6570\u91cf\u4e5f\u5728\u4e0d\u65ad\u53d8\u591a\u3002</p> <p>\u4ee5\u4f20\u7edf\u7684 Load Balancer \u4e3a\u4e3b\u7684\u7cfb\u7edf\u67b6\u6784\u7684\u5c40\u9650\u6027\u5c31\u53d8\u5f97\u660e\u663e\u8d77\u6765\uff0c\u56e0\u4e3a\u5b83\u4e3b\u8981\u5de5\u4f5c\u5728\u56db\u5c42\uff0c\u5728\u4e03\u5c42\u4e0a\u529f\u80fd\u8f83\u5f31\uff0c\u4e8e\u662f\u4e00\u6b3e\u4e3b\u8981\u5de5\u4f5c\u5728\u4e03\u5c42\u4e14\u5177\u6709\u4e30\u5bcc\u6269\u5c55\u80fd\u529b\u7684\u57fa\u7840\u8bbe\u65bd\u4fbf\u5e94\u8fd0\u800c\u751f\uff0c\u5b83\u5c31\u662f API Gateway\u3002</p> <p>\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecd Load Balancer \u548c API Gateway \u7684\u529f\u80fd\u7279\u70b9\uff0c\u5e76\u63a2\u8ba8\u5b83\u4eec\u4e4b\u95f4\u7684\u533a\u522b\uff0c\u5e2e\u52a9\u8bfb\u8005\u66f4\u597d\u5730\u4e86\u89e3\u8fd9\u4e24\u8005\u4e4b\u95f4\u7684\u5173\u7cfb\u3002</p>"},{"location":"chap12/1api_vs_lb/#1-load-balancer","title":"1\u3001\u4ec0\u4e48\u662f Load Balancer","text":"<p>Load Balancer \u7684\u4e3b\u8981\u4f5c\u7528\u662f\u4e3a\u591a\u4e2a\u540e\u7aef\u670d\u52a1\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u529f\u80fd\uff0c\u4f9d\u636e\u4e0d\u540c\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u8ba9\u8fd9\u4e9b\u670d\u52a1\u53ef\u4ee5\u5206\u644a\u6d41\u91cf\u3002Load Balancer \u7684\u5386\u53f2\u975e\u5e38\u60a0\u4e45\uff0c\u4ece\u6f14\u8fdb\u8def\u5f84\u4e0a\u770b\u5927\u81f4\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u8fd9\u51e0\u4e2a\u9636\u6bb5\uff1a</p> <ul> <li>\u7b2c\u4e00\u9636\u6bb5\uff1a\u8fd9\u4e00\u9636\u6bb5\u7684 Load Balancer \u901a\u5e38\u7531\u786c\u4ef6\u8bbe\u5907\u7ec4\u6210\uff0c\u5177\u6709\u9ad8\u6027\u80fd\u3001\u9ad8\u53ef\u9760\u6027\u7684\u7279\u70b9\uff0c\u4f46\u7075\u6d3b\u6027\u8f83\u5dee\uff0c\u4ef7\u683c\u6602\u8d35\u3002\u6bd4\u8f83\u5178\u578b\u7684\u662f F5 \u8fd9\u79cd\u57fa\u4e8e\u786c\u4ef6\u7684 Load Balancer \u3002</li> <li>\u7b2c\u4e8c\u9636\u6bb5\uff1aLoad Balancer \u5f00\u59cb\u4ee5\u8f6f\u4ef6\u5f62\u5f0f\u5b9e\u73b0\uff0c\u4f7f\u5176\u66f4\u52a0\u7075\u6d3b\u548c\u53ef\u6269\u5c55\uff0c\u901a\u5e38\u4ee5\u8f6f\u4ef6\u5206\u53d1\u7684\u5f62\u5f0f\u51fa\u73b0\uff0c\u56e0\u6b64\u4ef7\u683c\u4e5f\u6bd4\u8f83\u4f4e\u5ec9\uff0c\u6bd4\u5982 LVS, Haproxy \u5c31\u5c5e\u4e8e\u8fd9\u4e00\u7c7b\u3002</li> <li>\u7b2c\u4e09\u9636\u6bb5\uff1a\u968f\u7740\u4e91\u8ba1\u7b97\u6280\u672f\u7684\u5174\u8d77\uff0cLoad Balancer \u4e5f\u5f00\u59cb\u6709\u4e86\u4e91\u7248\u672c\uff0c\u8fd9\u4e2a\u7248\u672c\u7684 Load Balancer \u5176\u4e2d\u4e00\u4e2a\u597d\u5904\u662f\u53ef\u4ee5\u5e2e\u52a9\u4f01\u4e1a\u4ee5\u66f4\u4f4e\u7684\u6210\u672c\u83b7\u5f97\u9ad8\u6027\u80fd\u7684\u8d1f\u8f7d\u5747\u8861\u670d\u52a1\uff0c\u53e6\u4e00\u4e2a\u597d\u5904\u662f\u5b83\u80fd\u591f\u5229\u7528\u4e91\u8ba1\u7b97\u7684\u53ef\u6269\u5c55\u6027\u548c\u5f39\u6027\u7684\u7279\u70b9\u6765\u63d0\u9ad8\u6574\u4f53\u53ef\u7528\u6027\u3002\u4f8b\u5982 AWS \u7684 Classic Load Balancer\u3001Application Load Balancer\u3001Network Load Balancer \u7b49\u3002</li> </ul> <p>Load Balancer \u9664\u4e86\u7528\u4e8e\u5206\u644a\u6d41\u91cf\u3001\u63d0\u9ad8\u7f51\u7edc\u7684\u4f38\u7f29\u6027\u5916\uff0c\u8fd8\u53ef\u4ee5\u7528\u4e8e\u63d0\u5347\u7f51\u7edc\u5b89\u5168\u3002\u6bd4\u5982\u53ef\u4ee5\u5c06\u5185\u7f51\u670d\u52a1\u5668\u4e0e\u5916\u7f51\u8fdb\u884c\u9694\u79bb\uff0c\u9632\u6b62\u4e92\u8054\u7f51\u7684\u6076\u610f\u653b\u51fb\u548c\u8bbf\u95ee\u3002\u4e00\u4e2a\u7b80\u5355\u7684\u4f7f\u7528\u573a\u666f\u5c31\u662f\uff0c\u4e00\u4e2a\u5305\u542b\u654f\u611f\u4fe1\u606f\u7684\u5185\u90e8\u670d\u52a1\u5668\uff0cLoad Balancer \u53ef\u4ee5\u628a\u5185\u90e8\u670d\u52a1\u5668\u9694\u79bb\u5728\u5185\u7f51\u4e2d\uff0c\u8fd9\u6837\u5c31\u80fd\u6709\u6548\u4fdd\u62a4\u5185\u90e8\u670d\u52a1\u5668\u7684\u5b89\u5168\u3002</p>"},{"location":"chap12/1api_vs_lb/#2-api-gateway","title":"2\u3001\u4ec0\u4e48\u662f API Gateway","text":"<p>API Gateway \u7b80\u5355\u6765\u8bf4\u662f\u4e00\u79cd\u4e3b\u8981\u5de5\u4f5c\u5728\u4e03\u5c42\uff0c\u4e13\u95e8\u7528\u4e8e API \u7684\u7ba1\u7406\u548c\u6d41\u91cf\u8f6c\u53d1\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u5e76\u5728\u6b64\u57fa\u7840\u4e0a\u62e5\u6709 Load Balancer \u6240\u4e0d\u5177\u5907\u7684\u5f3a\u5927\u7684\u6269\u5c55\u6027\uff0c\u6bd4\u5982\uff1a\u8ba4\u8bc1\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u81ea\u5b9a\u4e49\u63d2\u4ef6\u7b49\u7b49\u3002</p> <p>\u7b80\u5355\u6765\u8bf4\uff0c\u5305\u62ec\u4f46\u4e0d\u9650\u4e8e\u4ee5\u4e0b\u8fd9\u4e9b\u7279\u70b9\uff1a</p> <ul> <li>\u4e30\u5bcc\u7684\u8def\u7531\u7b56\u7565\uff1aAPI Gateway \u5de5\u4f5c\u5728\u4e03\u5c42\uff0c\u6240\u4ee5\u5b83\u53ef\u4ee5\u89e3\u6790\u5230 HTTP/HTTPS \u5c42\u7684\u6570\u636e\u3002\u56e0\u6b64\u5b83\u53ef\u4ee5\u6839\u636e\u8bf7\u6c42\u7684 Path \u6216 Domain \u751a\u81f3\u662f Header \u4f5c\u4e3a\u6761\u4ef6\uff0c\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u4e0d\u540c\u7684\u4e0a\u6e38\u670d\u52a1\u5668\u3002</li> <li>\u8ba4\u8bc1\uff1a\u53ef\u4ee5\u5728API\u5c42\u9762\u652f\u6301\u591a\u79cd\u591a\u6837\u7684\u8ba4\u8bc1\u65b9\u5f0f\u6765\u907f\u514d\u975e\u6cd5\u8bf7\u6c42\uff0c\u6bd4\u5982 OAuth2\u3001JWT \u7b49\u7b49\uff0c\u76f4\u63a5\u5c06\u8ba4\u8bc1\u8fd9\u90e8\u5206\u670d\u52a1\u72ec\u7acb\u51fa\u6765\uff0c\u4e0d\u4fb5\u5165\u6216\u8005\u5c11\u4fb5\u5165\u4e1a\u52a1\u4ee3\u7801\u3002</li> <li>\u9650\u6d41\uff1a\u652f\u6301\u5bf9\u4e0d\u540c\u7a0b\u5ea6\u7684\u8def\u7531\u8fdb\u884c\u7ec6\u7c92\u5ea6\u7684\u9650\u6d41\uff0c\u9632\u6b62\u6076\u610f\u653b\u51fb\uff0c\u9632\u6b62\u540e\u7aef\u670d\u52a1\u96ea\u5d29\u3002</li> <li>\u53ef\u89c2\u6d4b\u6027\uff1a\u53ef\u89c2\u5bdf\u6027\u662f\u6307\u4ece\u7cfb\u7edf\u5916\u90e8\u89c2\u5bdf\u7cfb\u7edf\u5185\u90e8\u7a0b\u5e8f\u7684\u8fd0\u884c\u72b6\u6001\u548c\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u7684\u80fd\u529b\u3002 <ul> <li>API Gateway \u652f\u6301\u5c06\u65e5\u5fd7\u5bf9\u63a5\u5230 Kafka\u3001 Google Cloud Logging Service\u3001Elasticsearch \u7b49\uff0c\u652f\u6301\u5c06\u76f8\u5173 metrics \u63a5\u5165\u5230 prometheus\u3001datadog \u7b49</li> </ul> </li> <li>\u6269\u5c55\uff1a\u56e0\u4e3a API Gateway \u81ea\u8eab\u662f\u7f51\u5173\u8eab\u4efd\uff0c\u8fd9\u5c31\u6ce8\u5b9a\u5bf9\u5b83\u8981\u6c42\u662f\u80fd\u9002\u914d\u5404\u5bb6\u516c\u53f8\u4e0d\u540c\u5e94\u7528\u573a\u666f\uff0c\u6bd4\u5982\u4e0d\u540c\u7684\u9274\u6743\u3001\u7070\u5ea6\u3001\u5b89\u5168\u7b56\u7565\u3001\u65e5\u5fd7\u6536\u96c6\u7b49\uff0c\u5fc5\u987b\u5141\u8bb8\u7528\u6237\u81ea\u7531\u9009\u62e9\u6240\u9700\u6269\u5c55\u6216\u8005\u81ea\u5b9a\u4e49\u5f00\u53d1\uff0c\u56e0\u6b64\u6269\u5c55\u6027\u5f88\u5f3a\uff0c\u5141\u8bb8\u9009\u62e9\u7684\u6269\u5c55\u79cd\u7c7b\u4e5f\u5341\u5206\u4e30\u5bcc<ul> <li>\u4ee5 Apache APISIX \u4e3e\u4f8b\uff0c\u5149\u662f\u8ba4\u8bc1\u7684\u6269\u5c55\u5c31\u6709 13 \u6b3e\uff0c\u51e0\u4e4e\u6db5\u76d6\u4e86\u5e02\u9762\u4e0a\u5e38\u89c1\u7684\u8ba4\u8bc1\u9700\u6c42</li> </ul> </li> </ul> <p>\u76ee\u524d\u5e02\u9762\u4e0a\u6709\u8bb8\u591a API Gateway\uff0c\u6bd4\u5982 Apache APISIX\u3001Kong\u3001Tyk\u3001Zuul \u7b49\uff0c\u5f00\u53d1\u8005\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u9009\u62e9\u5408\u9002\u7684 API Gateway\u3002</p>"},{"location":"chap12/1api_vs_lb/#3api-gateway-load-balancer","title":"3\u3001API Gateway \u4e0e Load Balancer \u4e3b\u8981\u533a\u522b","text":"<p>\u9996\u5148\uff0c\u4ed6\u4eec\u4e3b\u8981\u5de5\u4f5c\u7684\u4fa7\u91cd\u70b9\u4e0d\u540c\u3002\u867d\u7136\u8bf4 API Gateway \u548c Load Balancer \u90fd\u652f\u6301\u56db\u5c42\u548c\u4e03\u5c42\u7684\u4ee3\u7406\u3002\u4f46\u662f\uff0cAPI Gateway \u4e3b\u8981\u4fa7\u91cd\u4e8e\u4e03\u5c42\uff0c\u800c Load Balancer \u4e3b\u8981\u4fa7\u91cd\u4e8e\u56db\u5c42\u3002</p> <p>\u5de5\u4f5c\u5728\u56db\u5c42\u7684 Load Balancer \u62e5\u6709\u8bb8\u591a\u6709\u5229\u7684\u7279\u70b9\uff0c\u9996\u5148\u662f\u5b83\u76f8\u6bd4\u4e8e API Gateway \u51cf\u5c11\u4e86\u534f\u8bae\u89e3\u6790\u7684\u635f\u8017\uff0c\u5177\u6709\u66f4\u5f3a\u7684\u541e\u5410\u80fd\u529b\u3002\u5176\u6b21\u5c31\u662f\u5b83\u652f\u6301\u900f\u4f20\u5ba2\u6237\u7aef IP \u5730\u5740\uff0c\u800c API Gateway\uff0c\u4e00\u822c\u662f\u901a\u8fc7 HTTP \u5934\u65b9\u5f0f\u4f20\u9012\u5ba2\u6237\u7aef IP \u5730\u5740\u3002</p> <p></p> <p>\u5176\u6b21\u5c31\u662f\u529f\u80fd\u7684\u4e30\u5bcc\u7a0b\u5ea6\u4e0d\u540c\u3002Load Balancer \u7684 HTTP \u4e03\u5c42\u5904\u7406\u80fd\u529b\u6bd4\u8f83\u5f31\uff0c\u5f80\u5f80\u4e0d\u5305\u542b\u8ba4\u8bc1\u3001\u6388\u6743\u3001\u9274\u6743\u3001\u590d\u6742\u8def\u7531\u903b\u8f91\u3001\u65e5\u5fd7\u6536\u96c6\u7b49\u529f\u80fd\u3002</p> <p>API Gateway \u5219\u5177\u6709\u76f8\u5f53\u5f3a\u5927\u7684\u4e03\u5c42\u534f\u8bae\u5904\u7406\u80fd\u529b\uff0c\u53ef\u4ee5\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u9644\u52a0\u5404\u79cd\u5404\u6837\u7684\u529f\u80fd\u6269\u5c55\uff0c\u6bd4\u5982\u6743\u9650\u63a7\u5236\u3001\u65e5\u5fd7\u3001API \u7ba1\u7406\u3001Serverless \u7b49\u7b49\u3002</p> <p>\u73b0\u5982\u4eca\uff0c\u79d1\u6280\u516c\u53f8\u7684\u4ea7\u54c1\u9700\u6c42\u53d8\u5e7b\u83ab\u6d4b\uff0c\u5bf9\u4e8e\u5f88\u591a\u516c\u53f8\u6765\u8bf4\u652f\u6301\u81ea\u5b9a\u4e49\u5f00\u53d1\u662f\u521a\u9700\u3002API Gateway \u652f\u6301\u5404\u5f0f\u7684\u81ea\u5b9a\u4e49\u5f00\u53d1\uff0c\u6bd4\u5982\u652f\u6301\u4e30\u5bcc\u7684\u7f16\u7a0b\u8bed\u8a00\uff0c\u652f\u6301\u5728\u6d41\u91cf\u8f6c\u53d1\u7684\u4e0d\u540c\u9636\u6bb5\u6ce8\u5165\u81ea\u5b9a\u4e49\u7684\u5904\u7406\u903b\u8f91\uff0c\u800c Load Balancer \u57fa\u672c\u4e0d\u652f\u6301\u4efb\u4f55\u81ea\u5b9a\u4e49\u529f\u80fd\u5f00\u53d1\u3002</p> <p>\u8fd8\u6709\u4e00\u70b9\u5c31\u662f Load Balancer \u901a\u5e38\u91c7\u7528\u6d41\u91cf\u76f4\u63a5\u5206\u53d1\u7684\u5f62\u5f0f\u505a\u8d1f\u8f7d\u5747\u8861\uff0c\u5b83\u901a\u8fc7\u7b97\u6cd5\u5c06\u6d41\u91cf\u6570\u636e\u76f4\u63a5\u53d1\u5411\u67d0\u4e2a\u540e\u7aef\u670d\u52a1\u5668\u8282\u70b9\u3002\u8fd9\u610f\u5473\u7740\u540e\u7aef\u7b49\u5f85\u63a5\u6536\u6d41\u91cf\u7684\u6bcf\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u884c\u4e3a\u90fd\u5fc5\u987b\u662f\u4e00\u81f4\u7684\uff0c\u8fd9\u51cf\u5c11\u4e86\u4e00\u5b9a\u7684\u7075\u6d3b\u6027\u3002</p> <p>\u800c API Gateway \u5219\u662f\u4ee5 URL Path \u3001Domain\u3001Header \u7b49\u7ef4\u5ea6\u8fdb\u884c\u6d41\u91cf\u5206\u53d1\uff0c\u540e\u7aef\u7b49\u5f85\u63a5\u6536\u6d41\u91cf\u7684\u670d\u52a1\u5b9e\u4f8b\u53ef\u4ee5\u591a\u79cd\u591a\u6837\uff0c\u53ef\u4ee5\u662f\u67d0\u4e2a Private API\uff0c\u4e5f\u53ef\u4ee5\u662f\u67d0\u4e2a gRPC \u7684 API\u3002\u8fd9\u5c31\u4f7f\u6d41\u91cf\u5206\u53d1\u53d8\u5f97\u5341\u5206\u5730\u7075\u6d3b\u3002</p>"},{"location":"chap12/1api_vs_lb/#4","title":"4\u3001\u4f7f\u7528\u573a\u666f","text":""},{"location":"chap12/1api_vs_lb/#_1","title":"\u5fae\u670d\u52a1\u573a\u666f","text":"<p>API Gateway \u5bf9\u4e8e\u5fae\u670d\u52a1\u67b6\u6784\u7684\u7cfb\u7edf\u662f\u521a\u9700\u3002</p> <p>\u9996\u5148\u5b83\u53ef\u4ee5\u65b9\u4fbf\u5730\u7ba1\u7406\u548c\u8def\u7531\u591a\u79cd\u4e0d\u540c\u7684\u540e\u7aef\u670d\u52a1\uff0c\u5176\u6b21\u53ef\u4ee5\u63d0\u4f9b\u8bb8\u591a\u9ad8\u7ea7\u529f\u80fd\uff0c\u6bd4\u5982\u8eab\u4efd\u9a8c\u8bc1\u3001\u6388\u6743\u3001\u9650\u6d41\u3001\u8f6c\u53d1\u3001\u65e5\u5fd7\u8bb0\u5f55\u7b49\u529f\u80fd\u3002\u8fd9\u6837\u4e0d\u540c\u7684\u5fae\u670d\u52a1\u4e4b\u95f4\u65e0\u9700\u91cd\u590d\u5b9e\u73b0\u9650\u6d41\u3001\u8ba4\u8bc1\u7b49\u529f\u80fd\uff0c\u8ba9\u5fae\u670d\u52a1\u7684\u6bcf\u4e2a\u670d\u52a1\u7684\u529f\u80fd\u5b9e\u73b0\u66f4\u52a0\u7eaf\u7cb9\uff0c\u51cf\u5c11\u7814\u53d1\u6210\u672c\u3002</p> <p>\u7531\u4e8e\u5fae\u670d\u52a1\u7684\u7279\u70b9\u662f\u670d\u52a1\u79cd\u7c7b\u591a\uff0c\u5de5\u4f5c\u5728\u56db\u5c42\u7684 Load Balancer \u4e0d\u592a\u9002\u5408\u5bf9\u79cd\u7c7b\u7e41\u591a\u540e\u7aef\u670d\u52a1\u505a\u8d1f\u8f7d\u5747\u8861\uff0c\u5b83\u66f4\u9002\u5408\u7528\u4e8e\u5355\u4f53\u540e\u7aef\u670d\u52a1\u3002\u5373\u4f7f\u662f\u5de5\u4f5c\u5728\u4e03\u5c42\u7684 Load Balancer\uff0c\u56e0\u4e3a\u4e00\u822c\u4e0d\u80fd\u63d0\u4f9b\u8f83\u4e3a\u4e30\u5bcc\u7684\u9ad8\u7ea7\u529f\u80fd\uff0c\u76f8\u6bd4\u4e8e API Gateway \u5728\u5fae\u670d\u52a1\u4e0a\u4f18\u52bf\u4e5f\u4e0d\u660e\u663e\u3002</p>"},{"location":"chap12/1api_vs_lb/#api","title":"API \u7ba1\u7406\u4e0e\u53d1\u5e03","text":"<p>\u5728\u9700\u8981\u5bf9\u5927\u91cf\u7684 API \u8fdb\u884c\u7ba1\u7406\u548c\u53d1\u5e03\u7684\u573a\u666f\uff0cAPI Gateway \u4e5f\u975e\u5e38\u9002\u7528\uff0c\u56e0\u4e3a\u5b83\u5177\u6709\u5f3a\u5927\u7684 API \u7ba1\u7406\u529f\u80fd\uff0c\u53ef\u4ee5\u8ba9\u4f60\u968f\u65f6\u968f\u5730\u8ba9\u67d0\u4e2a API \u4e0a\u7ebf\u6216\u8005\u4e0b\u7ebf\uff0c\u5feb\u901f\u5730\u4fee\u6539 API \u8f6c\u53d1\u7684\u914d\u7f6e\uff0c\u5feb\u901f\u5730\u4e3a\u67d0\u4e2a API \u6dfb\u52a0\u9650\u6d41\u3001\u8ba4\u8bc1\u3001\u65e5\u5fd7\u7b49\u7b49\u529f\u80fd\u800c\u65e0\u9700\u91cd\u65b0\u542f\u52a8 API Gateway\u3002</p> <p>\u4ee5 Apache APISIX \u4e3a\u4f8b\uff0cApache APISIX \u662f Apache \u57fa\u91d1\u4f1a\u65d7\u4e0b\u7684\u9876\u7ea7\u5f00\u6e90\u9879\u76ee\uff0c\u4e5f\u662f\u5f53\u524d\u6700\u6d3b\u8dc3\u7684\u5f00\u6e90\u7f51\u5173\u9879\u76ee\u3002\u4f5c\u4e3a\u4e00\u4e2a\u52a8\u6001\u3001\u5b9e\u65f6\u3001\u9ad8\u6027\u80fd\u7684\u5f00\u6e90 API \u7f51\u5173\uff0cApache APISIX \u63d0\u4f9b\u4e86\u8d1f\u8f7d\u5747\u8861\u3001\u52a8\u6001\u4e0a\u6e38\u3001\u7070\u5ea6\u53d1\u5e03\u3001\u670d\u52a1\u7194\u65ad\u3001\u8eab\u4efd\u8ba4\u8bc1\u3001\u53ef\u89c2\u6d4b\u6027\u7b49\u4e30\u5bcc\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\u3002</p> <p></p> <p></p> <p>\u800c\u4f20\u7edf\u7684 Load Balancer \u5219\u5728 API \u7ba1\u7406\u4e0a\u8f83\u4e3a\u5f31\u52bf\uff0c\u4e0d\u5177\u5907\u5982\u6b64\u4e30\u5bcc\u7684\u9ad8\u7ea7\u529f\u80fd\u3002</p>"},{"location":"chap12/1api_vs_lb/#_2","title":"\u9ad8\u6027\u80fd\u7684\u7f51\u7edc\u51fa\u5165\u53e3","text":"<p>\u5bf9\u4e8e\u9700\u8981\u5927\u6d41\u91cf\u3001\u6781\u9ad8\u7a33\u5b9a\u6027\u7684\u7f51\u7edc\u51fa\u5165\u53e3\u7684\u573a\u666f\uff0c\u5de5\u4f5c\u5728\u56db\u5c42\u7684 Load Balancer \u663e\u7136\u66f4\u4e3a\u9002\u7528\u3002\u5b83\u53ef\u4ee5\u628a\u7f51\u7edc\u539f\u59cb\u56db\u5c42\u6d41\u91cf\u76f4\u63a5\u5206\u53d1\u5230\u5404\u4e2a\u540e\u7aef\u670d\u52a1\u4e2d\uff0c\u4e0d\u5b58\u5728\u4e2d\u95f4\u5c42\u591a\u6b21\u89e3\u6790\u5e94\u7528\u5c42\u534f\u8bae\u7684\u5f71\u54cd\uff0c\u5177\u6709\u66f4\u5f3a\u7684\u541e\u5410\u80fd\u529b\u3002</p> <p>\u800c\u5de5\u4f5c\u5728\u4e03\u5c42\u7684 API Gateway \u4f5c\u4e3a\u7edf\u4e00\u7684\u5165\u53e3\uff0c\u4f1a\u7531\u4e8e\u9700\u8981\u89e3\u6790\u534f\u8bae\uff0c\u5b58\u5728\u4e00\u5b9a\u7684\u541e\u5410\u91cf\u9650\u5236\u3002</p> <p>\u5373\u4f7f\u662f\u4f7f\u7528\u56db\u5c42\u7684 API Gateway \u6765\u505a\u7f51\u7edc\u51fa\u5165\u53e3\u4e5f\u4e0d\u592a\u6709\u4f18\u52bf\uff0c\u56e0\u4e3a\u8fd9\u4e00\u5c42\u4e0d\u662f API Gateway \u7684\u4fa7\u91cd\u70b9\uff0c\u76f8\u6bd4\u4e8e Load Balancer \u591a\u5e74\u5728\u8fd9\u4e00\u5c42\u7684\u6280\u672f\u7d2f\u8ba1\uff0cAPI Gateway \u4f18\u52bf\u4e5f\u4e0d\u660e\u663e\u3002</p>"},{"location":"chap12/1api_vs_lb/#_3","title":"\u56db\u3001\u603b\u7ed3","text":"<p>\u603b\u7684\u6765\u8bf4\uff0cAPI Gateway \u548c Load Balancer \u662f\u5206\u522b\u7528\u4e8e\u89e3\u51b3\u4e0d\u540c\u5c42\u9762\u95ee\u9898\u7684\u57fa\u7840\u8bbe\u65bd\u3002</p> <p>API Gateway \u4e3b\u8981\u7528\u4e8e\u4f5c\u4e3a\u540e\u7aef\u7684 API \u63a5\u53e3\u4ee3\u7406\uff0c\u63d0\u4f9b\u5bf9\u5916\u8bbf\u95ee\u4e0d\u540c\u79cd\u7c7b API \u7684\u4e00\u4e2a\u5355\u72ec\u5165\u53e3\uff0c\u5e76\u4e14\u53ef\u4ee5\u63d0\u4f9b\u72ec\u7acb\u4e8e\u540e\u7aef\u670d\u52a1\u7684\u9650\u6d41\u3001\u8ba4\u8bc1\u3001\u76d1\u63a7\u7b49\u529f\u80fd\uff1b</p> <p>\u800c Load Balancer \u5219\u4e3b\u8981\u7528\u4e8e\u56db\u5c42\u6d41\u91cf\u5206\u53d1\uff0c\u5b83\u53ef\u4ee5\u5c06\u8bf7\u6c42\u5206\u644a\u5230\u591a\u53f0\u540e\u7aef\u670d\u52a1\u5668\u4e0a\uff0c\u5e73\u8861\u540e\u7aef\u7684\u8bf7\u6c42\u8d1f\u8f7d\uff0c\u4ee5\u63d0\u9ad8\u7cfb\u7edf\u7684\u6574\u4f53\u53ef\u7528\u6027\u548c\u5bb9\u9519\u6027\u3002</p> <p>\u5728\u5408\u7406\u7684\u67b6\u6784\u8bbe\u8ba1\u4e0b\uff0c\u4e00\u822c\u90fd\u5c06 API Gateway \u548c Load Balancer \u914d\u5408\u4f7f\u7528\uff0c\u4f7f\u7528 Load Balancer \u4f5c\u4e3a\u6574\u4e2a\u7cfb\u7edf\u7684\u7f51\u7edc\u51fa\u5165\u53e3\uff0c\u5c06\u6d41\u91cf\u5206\u53d1\u5230\u591a\u4e2a API Gateway \u5b9e\u4f8b\uff0c\u7136\u540e\u6bcf\u4e2a API Gateway \u5b9e\u4f8b\u5206\u522b\u5bf9\u8bf7\u6c42\u8fdb\u884c\u8def\u7531\u3001\u8ba4\u8bc1\u3001\u9274\u6743\u7b49\u64cd\u4f5c\uff0c\u8fd9\u6837\u53ef\u4ee5\u4f7f\u5f97\u6574\u4e2a\u7f51\u7edc\u66f4\u52a0\u7a33\u5065\u3001\u53ef\u9760\u3001\u53ef\u6269\u5c55\u3002</p>"},{"location":"chap12/2apigatway_sm/","title":"2 Service Mesh \u548c API Gateway \u5173\u7cfb\u6df1\u5ea6","text":""},{"location":"chap12/2apigatway_sm/#1","title":"1 \u539f\u672c\u6e05\u6670\u7684\u754c\u9650\uff1a\u5b9a\u4f4d\u548c\u804c\u8d23","text":"<p>\u9996\u5148\uff0cService Mesh \u548c API Gateway \u5728\u529f\u80fd\u5b9a\u4f4d\u548c\u627f\u62c5\u7684\u804c\u8d23\u4e0a\u6709\u975e\u5e38\u6e05\u6670\u7684\u754c\u9650\uff1a</p> <ul> <li>Service Mesh\uff1a\u5fae\u670d\u52a1\u7684\u7f51\u7edc\u901a\u4fe1\u57fa\u7840\u8bbe\u65bd\uff0c\u8d1f\u8d23\uff08\u7cfb\u7edf\u5185\u90e8\u7684\uff09\u670d\u52a1\u95f4\u7684\u901a\u8baf\uff1b</li> <li>API Gateway\uff1a \u8d1f\u8d23\u5c06\u670d\u52a1\u4ee5 API \u7684\u5f62\u5f0f\u66b4\u9732\uff08\u7ed9\u7cfb\u7edf\u5916\u90e8\uff09\uff0c\u4ee5\u5b9e\u73b0\u4e1a\u52a1\u529f\u80fd\uff1b</li> </ul> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u4ece\u529f\u80fd\u548c\u804c\u8d23\u4e0a\u8bf4\uff1a</p> <ul> <li>\u4f4d\u4e8e\u6700\u5e95\u5c42\u7684\u662f\u62c6\u5206\u597d\u7684\u539f\u5b50\u5fae\u670d\u52a1\uff0c\u4ee5\u670d\u52a1\u7684\u5f62\u5f0f\u63d0\u4f9b\u5404\u79cd\u80fd\u529b\uff1b</li> <li>\u5728\u539f\u5b50\u5fae\u670d\u52a1\u4e0a\u662f\uff08\u53ef\u9009\u7684\uff09\u7ec4\u5408\u670d\u52a1\uff0c\u67d0\u4e9b\u573a\u666f\u4e0b\u9700\u8981\u5c06\u82e5\u5e72\u5fae\u670d\u52a1\u7684\u80fd\u529b\u7ec4\u5408\u8d77\u6765\u5f62\u6210\u65b0\u7684\u670d\u52a1\uff1b</li> <li>\u539f\u5b50\u5fae\u670d\u52a1\u548c\u7ec4\u5408\u670d\u52a1\u90e8\u7f72\u4e8e\u7cfb\u7edf\u5185\u90e8\uff0c\u5728\u91c7\u7528 Service Mesh \u7684\u60c5\u51b5\u4e0b\uff0c\u7531 Service Mesh \u63d0\u4f9b\u670d\u52a1\u95f4\u901a\u8baf\u7684\u80fd\u529b\uff1b</li> <li>API Gateway \u7528\u4e8e\u5c06\u7cfb\u7edf\u5185\u90e8\u7684\u8fd9\u4e9b\u670d\u52a1\u66b4\u9732\u7ed9\u7cfb\u7edf\u5916\u90e8\uff0c\u4ee5 API \u7684\u5f62\u5f0f\u63a5\u53d7\u5916\u90e8\u8bf7\u6c42\uff1b</li> </ul> <p>\u4ece\u90e8\u7f72\u4e0a\u8bf4\uff1a</p> <ul> <li>Service Mesh \u90e8\u7f72\u5728\u7cfb\u7edf\u5185\u90e8\uff1a\u56e0\u4e3a\u539f\u5b50\u5fae\u670d\u52a1\u548c\u7ec4\u5408\u670d\u52a1\u901a\u5e38\u4e0d\u4f1a\u76f4\u63a5\u66b4\u9732\u7ed9\u5916\u90e8\u7cfb\u7edf\uff1b</li> <li>API Gateway \u90e8\u7f72\u5728\u7cfb\u7edf\u7684\u8fb9\u7f18\uff1a\u4e00\u65b9\u9762\u66b4\u9732\u5728\u7cfb\u7edf\u4e4b\u5916\uff0c\u5bf9\u5916\u63d0\u4f9b API \u4f9b\u5916\u90e8\u7cfb\u7edf\u8bbf\u95ee\uff1b\u4e00\u65b9\u9762\u90e8\u7f72\u5728\u7cfb\u7edf\u5185\u90e8\uff0c\u4ee5\u8bbf\u95ee\u5185\u90e8\u7684\u5404\u79cd\u670d\u52a1</li> </ul> <p>\u5728\u8fd9\u91cc\u5f15\u5165\u4e24\u4e2a\u4f7f\u7528\u975e\u5e38\u5e7f\u6cdb\u7684\u672f\u8bed\uff1a</p> <p></p> <ul> <li>\u4e1c\u897f\u5411\u901a\u8baf\uff1a\u6307\u670d\u52a1\u95f4\u7684\u76f8\u4e92\u8bbf\u95ee\uff0c\u5176\u901a\u8baf\u6d41\u91cf\u5728\u670d\u52a1\u95f4\u6d41\u8f6c\uff0c\u6d41\u91cf\u90fd\u4f4d\u4e8e\u7cfb\u7edf\u5185\u90e8\uff1b</li> <li>\u5357\u5317\u5411\u901a\u8baf\uff1a\u6307\u670d\u52a1\u5bf9\u5916\u90e8\u63d0\u4f9b\u8bbf\u95ee\uff0c\u901a\u5e38\u662f\u901a\u8fc7 API Gateway \u63d0\u4f9b\u7684 API \u5bf9\u5916\u90e8\u4fdd\u7f57\uff0c\u5176\u901a\u8baf\u6d41\u91cf\u662f\u4ece\u7cfb\u7edf\u5916\u90e8\u8fdb\u5165\u7cfb\u7edf\u5185\u90e8\uff1b</li> </ul> <p>\u603b\u7ed3\uff1aService Mesh \u548c API Gateway \u5728\u529f\u80fd\u548c\u804c\u8d23\u4e0a\u5206\u5de5\u660e\u786e\uff0c\u754c\u9650\u6e05\u6670\u3002\u4f46\u5982\u679c\u4e8b\u60c5\u5c31\u8fd9\u4e48\u7ed3\u675f\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u51fa\u73b0 Service Mesh \u548c API Gateway \u5173\u7cfb\u7684\u8ba8\u8bba\u4e86\uff0c\u81ea\u7136\u4e5f\u4e0d\u4f1a\u6709\u672c\u6587\u3002</p>"},{"location":"chap12/2apigatway_sm/#_1","title":"\u7f51\u5173\u8bbf\u95ee\u5185\u90e8\u670d\u52a1\uff0c\u7b97\u4e1c\u897f\u5411\u8fd8\u662f\u5357\u5317\u5411\uff1f","text":"<p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u56fe\u4e2d\u9ec4\u8272\u7684\u7ebf\u6761\u8868\u793a\u7684\u662f API Gateway \u8bbf\u95ee\u5185\u90e8\u670d\u52a1\uff1a</p> <p></p> <p>\u4ece\u6d41\u91cf\u8d70\u5411\u770b\uff1a\u8fd9\u662f\u5916\u90e8\u6d41\u91cf\u8fdb\u5165\u7cfb\u7edf\u540e\uff0c\u5f00\u59cb\u8bbf\u95ee\u5bf9\u5916\u66b4\u9732\u7684\u670d\u52a1\uff0c\u5e94\u8be5\u5c5e\u4e8e\u201c\u5357\u5317\u5411\u201d\u901a\u8baf\uff0c\u5178\u578b\u5982\u4e0a\u56fe\u7684\u753b\u6cd5\u3002\u4f46\u4ece\u53e6\u5916\u4e00\u4e2a\u89d2\u5ea6\uff0c\u5982\u679c\u6211\u4eec\u5c06 API Gateway \u903b\u8f91\u4e0a\u62c6\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206\uff0c\u5148\u5ffd\u7565\u5bf9\u5916\u66b4\u9732\u7684\u90e8\u5206\uff0c\u5355\u72ec\u53ea\u770b API Gateway \u8bbf\u95ee\u5185\u90e8\u670d\u52a1\u7684\u90e8\u5206\uff0c\u8fd9\u65f6\u53ef\u4ee5\u89c6 API Gateway \u4e3a\u4e00\u4e2a\u666e\u901a\u7684\u5ba2\u6237\u7aef\u670d\u52a1\uff0c\u5b83\u548c\u5185\u90e8\u670d\u52a1\u7684\u901a\u8baf\u66f4\u50cf\u662f\u201c\u4e1c\u897f\u5411\u201d\u901a\u8baf\uff1a</p> <p></p> <p>\u6240\u4ee5\uff0cAPI Gateway \u4f5c\u4e3a\u4e00\u4e2a\u5ba2\u6237\u7aef\u8bbf\u95ee\u5185\u90e8\u670d\u52a1\u65f6\uff0c\u5230\u5e95\u7b97\u5357\u5317\u5411\u8fd8\u662f\u4e1c\u897f\u5411\uff0c\u5c31\u6210\u4e3a\u4e00\u4e2a\u54f2\u5b66\u95ee\u9898\uff1a\u5b8c\u5168\u53d6\u51b3\u4e8e\u6211\u4eec\u5982\u4f55\u770b\u5f85 API Gateway \uff0c\u662f\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\uff0c\u8fd8\u662f\u903b\u8f91\u4e0a\u5206\u62c6\u4e3a\u5bf9\u5185\u5bf9\u5916\u4e24\u4e2a\u90e8\u5206\u3002</p> <p>\u5728 API Gateway \u7684\u5404\u79cd\u4ea7\u54c1\u4e2d\uff0c\u5173\u4e8e\u5982\u4f55\u5b9e\u73b0 \u201cAPI Gateway \u4f5c\u4e3a\u4e00\u4e2a\u5ba2\u6237\u7aef\u8bbf\u95ee\u5185\u90e8\u670d\u52a1\u201d \uff0c\u5c31\u901a\u5e38\u5206\u6210\u4e24\u4e2a\u6d41\u6d3e\uff1a</p> <ol> <li>\u6cfe\u6e2d\u5206\u660e\uff1a\u89c6 API Gateway \u548c\u5185\u90e8\u670d\u52a1\u4e3a\u4e24\u4e2a\u72ec\u7acb\u4e8b\u7269\uff0cAPI Gateway \u8bbf\u95ee\u5185\u90e8\u670d\u52a1\u7684\u901a\u8baf\u673a\u5236\u81ea\u884c\u5b9e\u73b0\uff0c\u72ec\u7acb\u4e8e\u670d\u52a1\u95f4\u901a\u8baf\u7684\u673a\u5236\uff1b</li> <li>\u517c\u5bb9\u5e76\u6d4e\uff1a\u89c6 API Gateway \u4e3a\u4e00\u4e2a\u666e\u901a\u7684\u5185\u90e8\u670d\u52a1\u7684\u5ba2\u6237\u7aef\uff0c\u91cd\u7528\u5176\u5185\u90e8\u670d\u52a1\u95f4\u901a\u8baf\u7684\u673a\u5236\uff1b</li> </ol> <p>\u800c\u6700\u7ec8\u51b3\u7b56\u901a\u5e38\u4e5f\u548c\u4ea7\u54c1\u7684\u5b9a\u4f4d\u6709\u5173\uff1a\u5982\u679c\u5e0c\u671b\u7ef4\u6301 API Gateway \u7684\u72ec\u7acb\u4ea7\u54c1\u5b9a\u4f4d\uff0c\u5e0c\u671b\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u670d\u52a1\u95f4\u901a\u8baf\u65b9\u6848\u4e0b\u90fd\u53ef\u4ee5\u4f7f\u7528\uff0c\u5219\u901a\u5e38\u9009\u62e9\u524d\u8005\uff0c\u5178\u578b\u5982 Kong\uff1b</p> <p>\u5982\u679c\u548c\u670d\u52a1\u95f4\u901a\u8baf\u65b9\u6848\u6709\u975e\u5e38\u6df1\u7684\u6e0a\u6e90\uff0c\u5219\u901a\u5e38\u9009\u62e9\u540e\u8005\uff0c\u5178\u578b\u5982 Spring Cloud \u751f\u6001\u4e0b\u7684 Zuul \u548c SpringCloud Gateway\u3002</p> <p>\u5f53 \u201cAPI Gateway \u4f5c\u4e3a\u4e00\u4e2a\u5ba2\u6237\u7aef\u8bbf\u95ee\u5185\u90e8\u670d\u52a1\u201d \u65f6\uff0c\u5b83\u7684\u786e\u548c\u4e00\u4e2a\u666e\u901a\u5185\u90e8\u670d\u52a1\u4f5c\u4e3a\u5ba2\u6237\u7aef\u53bb\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u6ca1\u6709\u672c\u8d28\u5dee\u5f02\uff1a\u670d\u52a1\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u6d41\u91cf\u8def\u7531\u3001\u7194\u65ad\u3001\u9650\u6d41\u3001\u670d\u52a1\u964d\u7ea7\u3001\u6545\u969c\u6ce8\u5165\u3001\u65e5\u5fd7\u3001\u76d1\u63a7\u3001\u94fe\u8def\u8ffd\u8e2a\u3001\u8bbf\u95ee\u63a7\u5236\u3001\u52a0\u5bc6\u3001\u8eab\u4efd\u8ba4\u8bc1...... \u5f53\u6211\u4eec\u628a\u7f51\u5173\u8bbf\u95ee\u5185\u90e8\u670d\u52a1\u7684\u529f\u80fd\u4e00\u4e00\u5217\u51fa\u6765\u65f6\uff0c\u53d1\u73b0\u51e0\u4e4e\u6240\u6709\u7684\u8fd9\u4e9b\u529f\u80fd\u90fd\u662f\u548c\u670d\u52a1\u95f4\u8c03\u7528\u91cd\u590d\u3002</p> <p>\u8fd9\u4e5f\u5c31\u9020\u6210\u4e86\u4e00\u4e2a\u666e\u904d\u73b0\u8c61\uff1a\u5982\u679c\u5df2\u6709\u4e00\u4e2a\u6210\u719f\u7684\u670d\u52a1\u95f4\u901a\u8baf\u6846\u67b6\uff0c\u518d\u53bb\u8003\u8651\u5b9e\u73b0 API Gateway\uff0c\u91cd\u7528\u8fd9\u4e9b\u91cd\u590d\u7684\u80fd\u529b\u5c31\u6210\u4e3a\u81ea\u7136\u800c\u7136\u7684\u9009\u62e9\u3002\u5178\u578b\u5982\u524d\u9762\u63d0\u5230\u7684 Spring Cloud \u751f\u6001\u4e0b\u7684 Zuul \u4ee5\u53ca\u540e\u9762\u5f00\u53d1\u7684 Spring Cloud Gateway\uff0c\u5c31\u662f\u4ee5\u91cd\u7528\u7c7b\u5e93\u7684\u65b9\u5f0f\u5b9e\u73b0\u4e86\u8fd9\u4e9b\u80fd\u529b\u7684\u91cd\u7528\u3002</p>"},{"location":"chap12/2apigatway_sm/#sidecar","title":"Sidecar\uff1a\u771f\u6b63\u7684\u91cd\u5408\u70b9","text":"<p>\u5728\u8fdb\u5165 Service Mesh \u65f6\u4ee3\u4e4b\u540e\uff0cService Mesh \u548c API Gateway \u7684\u5173\u7cfb\u5f00\u59cb\u662f\u8fd9\u6837\uff1a</p> <ol> <li>\u529f\u80fd\u548c\u804c\u8d23\u6e05\u6670\u5212\u5206\uff1b</li> <li>\u5ba2\u6237\u7aef\u8bbf\u95ee\u670d\u52a1\u7684\u529f\u80fd\u9ad8\u5ea6\u91cd\u53e0</li> </ol> <p>\u6b64\u65f6\u4e24\u8005\u7684\u5173\u7cfb\u5f88\u6e05\u6670\uff0c\u800c\u4e14\u7531\u4e8e\u5f53\u65f6 Service Mesh \u548c API Gateway \u662f\u4e0d\u540c\u7684\u4ea7\u54c1\uff0c\u4e24\u8005\u7684\u91cd\u5408\u70b9\u53ea\u662f\u5728\u529f\u80fd\u4e0a\u3002</p> <p>\u800c\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0c\u5f53 Service Mesh \u4ea7\u54c1\u548c API Gateway \u4ea7\u54c1\u5f00\u59cb\u51fa\u73b0\u76f8\u4e92\u6e17\u900f\u65f6\uff0c\u4e24\u8005\u7684\u5173\u7cfb\u5c31\u5f00\u59cb\u53d8\u5f97\u66a7\u6627\u3002</p>"},{"location":"chap12/2apigatway_sm/#_2","title":"\u5982\u4f55\u878d\u5408\u4e1c\u897f\u5411\u548c\u5357\u5317\u5411\u7684\u901a\u8baf\u65b9\u6848\uff1f","text":"<p>\u5176\u4e2d\u7684\u4e00\u4e2a\u505a\u6cd5\u5c31\u662f\u57fa\u4e8e Service Mesh \u7684 Sidecar \u6765\u5b9e\u73b0 API Gateway\uff0c\u4ece\u800c\u5728\u5357\u5317\u5411\u901a\u8baf\u4e2d\u5f15\u5165 Service Mesh \u8fd9\u79cd\u4e1c\u897f\u5411\u901a\u8baf\u7684\u65b9\u6848</p> <p></p> <p>\u8fd9\u4e2a\u65f6\u5019 Service Mesh \u548c API Gateway \u7684\u5173\u7cfb\u5c31\u53d8\u5f97\u6709\u610f\u601d\u4e86\uff0c\u56e0\u4e3a Service Mesh \u4e2d Sidecar \u7684\u5f15\u5165\uff0c\u6240\u4ee5\u524d\u9762\u7684\u201c\u54f2\u5b66\u95ee\u9898\u201d\u53c8\u6709\u4e86\u4e00\u4e2a\u65b0\u7684\u89e3\u6cd5\uff1aAPI Gateway \u8fd9\u6b21\u771f\u7684\u53ef\u4ee5\u5206\u62c6\u4e3a\u4e24\u4e2a\u72ec\u7acb\u90e8\u7f72\u7684\u7269\u7406\u5b9e\u4f53\uff0c\u800c\u4e0d\u662f\u903b\u8f91\u4e0a\u7684\u4e24\u4e2a\u90e8\u5206\uff1a</p> <ol> <li>API Gateway \u672c\u4f53\uff1a\u5b9e\u73b0 API Gateway \u9664\u4e86\u8bbf\u95ee\u5185\u90e8\u670d\u52a1\u4e4b\u5916\u7684\u529f\u80fd\uff1b</li> <li>Sidecar\uff1a\u6309\u7167 Service Mesh \u7684\u6807\u51c6\u505a\u6cd5\uff0c \u6211\u4eec\u89c6 API Gateway \u4e3a\u4e00\u4e2a\u90e8\u7f72\u4e8e Service Mesh \u4e2d\u7684\u666e\u901a\u670d\u52a1\uff0c\u4e3a\u8fd9\u4e2a\u670d\u52a1 1:1 \u7684\u90e8\u7f72 Sidecar\uff1b</li> </ol> <p></p> <p>\u5728\u8fd9\u4e2a\u65b9\u6848\u4e2d\uff0c\u539f\u6765\u7528\u4e8e Service Mesh \u7684 Sidecar\uff0c\u88ab\u7528\u5728\u4e86 API Gateway \u4e2d\uff0c\u66ff\u4ee3\u4e86 API Gateway \u4e2d\u539f\u6709\u7684\u5ba2\u6237\u7aef\u8bbf\u95ee\u7684\u5404\u79cd\u529f\u80fd\u3002</p> <p>\u8fd9\u4e2a\u65b9\u6848\u8ba9 API Gateway \u7684\u5b9e\u73b0\u7b80\u5316\u4e86\u5f88\u591a\uff0c\u4e5f\u5b9e\u73b0\u4e86\u4e1c\u897f\u5411\u548c\u5357\u5317\u5411\u901a\u8baf\u80fd\u529b\u7684\u91cd\u7528\u548c\u878d\u5408\uff0c\u800c API Gateway \u53ef\u4ee5\u66f4\u4e13\u6ce8\u4e8e \u201cAPI Management\u201d \u7684\u6838\u5fc3\u529f\u80fd\u3002</p> <p>\u800c\u91c7\u7528\u8fd9\u4e2a\u65b9\u6848\u7684\u516c\u53f8\uff0c\u901a\u5e38\u90fd\u662f\u5148\u6709 Service Mesh \u4ea7\u54c1\uff0c\u518d\u57fa\u4e8e Service Mesh \u4ea7\u54c1\u89c4\u5212\uff08\u6216\u8005\u91cd\u65b0\u89c4\u5212\uff09 API Gateway \u65b9\u6848\uff0c\u5178\u578b\u5982\u8682\u8681\u91d1\u670d\u7684 SOFA Gateway \u4ea7\u54c1\u662f\u57fa\u4e8e MOSN\uff0c\u800c\u793e\u533a\u5f00\u6e90\u4ea7\u54c1 Ambassador \u548c Gloo \u90fd\u662f\u57fa\u4e8e Envoy\u3002</p> <p>\u8fd9\u6837 API Gateway \u672c\u4f53\u548c Sidecar \u518d\u6b21\u5408\u4e8c\u4e3a\u4e00</p> <p></p>"},{"location":"chap12/2apigatway_sm/#bff","title":"BFF\uff1a\u628a\u878d\u5408\u8fdb\u884c\u5230\u5e95","text":"<p>BFF(Backend For Frontend) \u7684\u5f15\u5165\u4f1a\u8ba9 Service Mesh \u548c API Gateway \u8d70\u5230\u4e00\u4e2a\u66f4\u52a0\u4eb2\u5bc6\u7684\u5730\u6b65\u3002</p> <p>\u5148\u6765\u770b\u770b\u5e38\u89c4\u7684 BFF \u7684\u73a9\u6cd5\uff1a</p> <p></p> <p>\u5728\u8fd9\u91cc\uff0c\u591a\u589e\u52a0\u4e86\u4e00\u4e2a BFF \u5c42\uff0c\u4ecb\u4e8e API Gateway \u548c\u5185\u90e8\u670d\u52a1\uff08\u5305\u62ec\u7ec4\u5408\u670d\u52a1\u548c\u539f\u5b50\u5fae\u670d\u52a1\uff09\u4e4b\u95f4\u3002\u6ce8\u610f BFF \u7684\u5de5\u4f5c\u6a21\u5f0f\u548c\u7ec4\u5408\u670d\u52a1\u5f88\u7c7b\u4f3c\uff0c\u90fd\u662f\u7ec4\u5408\u591a\u4e2a\u670d\u52a1\u3002\u4f46\u5dee\u522b\u5728\u4e8e\uff1a</p> <ol> <li>\u7ec4\u5408\u670d\u52a1\u8fd8\u5c5e\u4e8e\u670d\u52a1\u7684\u8303\u7574\uff0c\u53ea\u662f\u5b9e\u73b0\u673a\u5236\u4e0a\u7ec4\u5408\u4e86\u591a\u4e2a\u670d\u52a1\uff0c\u5bf9\u5916\u66b4\u9732\u7684\u4f9d\u7136\u662f\u4e00\u4e2a\u5b8c\u6574\u548c\u89c4\u8303\u7684\u670d\u52a1\uff1b</li> <li>BFF \u4e0d\u540c\uff0cBFF \u5982\u540d\u5b57\u6240\u793a\uff0cBackend For Frontend\uff0c\u5b8c\u5168\u662f\u4e3a\u4e86\u524d\u7aef\u800c\u5b58\u5728\uff0c\u6838\u5fc3\u76ee\u6807\u4e4b\u4e00\u662f\u7b80\u5316\u524d\u7aef\u7684\u8bbf\u95ee\uff1b</li> <li>BFF \u5b8c\u5168\u6536\u53e3\u4e86\u4ece\u5916\u90e8\u8fdb\u5165\u7684\u6d41\u91cf\uff0c\u800c\u7ec4\u5408\u670d\u52a1\u6ca1\u6709\uff0cAPI Gateway \u662f\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u539f\u5b50\u5fae\u670d\u52a1\u7684\uff1b</li> </ol> <p>\u201cBFF \u5b8c\u5168\u6536\u53e3\u5916\u90e8\u6d41\u91cf\u201d\uff0c\u8fd9\u4e00\u70b9\u5728 API Gateway \u548c Sidecar \u878d\u5408\u4e4b\u540e\uff0c\u4f1a\u53d8\u5f97\u5f88\u6709\u60f3\u8c61\u7a7a\u95f4\uff0c\u6211\u4eec\u5148\u770b\u6309\u7167\u524d\u9762\u7684\u878d\u5408\u65b9\u5f0f\uff0c\u5728\u6709 BFF \u7684\u60c5\u51b5\u4e0b\uff0cAPI Gateway \u548c Sidecar \u878d\u5408\u540e\u7684\u60c5\u666f\uff1a</p> <p></p> <p></p> <p>\u6ce8\u610f\u5230\uff0c\u6d41\u91cf\u4ece\u88ab API Gateway \u63a5\u6536\uff0c\u5230\u8fdb\u5165 BFF \u5728\u8fd9\u4e2a\u6d41\u7a0b\u4e2d\uff0c\u8fd9\u4e2a\u8bf7\u6c42\u8def\u5f84\u4e2d\u6709\u4e24\u4e2a Sidecar\uff1a</p> <ol> <li>\u548c BFF \u90e8\u7f72\u5728\u4e00\u8d77\u7684\uff0c\u662f\u6ca1\u6709 API Gateway \u529f\u80fd\u7684\u666e\u901a Sidecar\uff1b</li> <li>API Gateway \u548c Sidecar \u878d\u5408\u4e4b\u540e\uff0c\u8fd9\u5c31\u662f\u4e00\u4e2a\u201c\u6709 API Gateway \u529f\u80fd\u7684\u5927 Sidecar\u201d\uff08\u6216\u8005\u662f\u201c\u6709 Sidecar \u529f\u80fd\u7684\u7279\u6b8a API Gateway\u201d\uff09\uff1a\u867d\u7136\u626e\u6f14\u4e86 API Gateway \u7684\u89d2\u8272\uff0c\u4f46\u672c\u8d28\u4e0a\u4f9d\u7136\u5305\u542b\u4e00\u4e2a\u5b8c\u6574\u529f\u80fd\u7684 Sidecar\uff0c\u548c BFF \u81ea\u5e26\u7684 Sidecar \u662f\u7b49\u540c\u7684\uff1b</li> </ol> <p>\u6211\u4eec\u5c1d\u8bd5\u5c06\u4e24\u4e2a Sidecar \u5408\u4e8c\u4e3a\u4e00\uff0c\u53bb\u6389 BFF \u81ea\u5e26\u7684 Sidecar\uff0c\u76f4\u63a5\u628a\u626e\u6f14 API Gateway \u7684 Sidecar \u7ed9 BFF \u7528\uff1a</p> <p></p> <p>\u6b64\u65f6\u7684\u573a\u666f\u662f\u8fd9\u6837\uff1a</p> <ul> <li>\u6d41\u91cf\u76f4\u63a5\u6253\u5230 BFF \u4e0a\uff08BFF \u524d\u9762\u53ef\u80fd\u4f1a\u6302\u5176\u4ed6\u7684\u7f51\u7edc\u7ec4\u4ef6\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u7b49\u529f\u80fd\uff09\uff1b</li> <li>BFF \u7684 Sidecar \u63a5\u6536\u6d41\u91cf\uff0c\u5b8c\u6210 API Gateway \u7684\u529f\u80fd\uff0c\u7136\u540e\u5c06\u6d41\u91cf\u8f6c\u7ed9 BFF\uff1b</li> <li>BFF \u901a\u8fc7 Sidecar \u8c03\u7528\u5185\u90e8\u670d\u52a1\uff08\u548c\u6ca1\u6709\u5408\u5e76\u65f6\u4e00\u81f4\uff09\uff1b</li> </ul> <p></p> <p>\u201cBFF \u5b8c\u5168\u6536\u53e3\u5916\u90e8\u6d41\u91cf\u201d\u3002\u8fd9\u662f\u524d\u63d0\u6761\u4ef6\uff0c\u56e0\u4e3a\u539f\u6709\u7684 API Gateway \u96c6\u7fa4\u5df2\u7ecf\u4e0d\u518d\u5b58\u5728\uff0c\u5982\u679c BFF \u6ca1\u80fd\u6536\u53e3\u5168\u90e8\u6d41\u91cf\uff0c\u5219\u8fd9\u4e9b\u672a\u80fd\u6536\u53e3\u7684\u6d41\u91cf\u4f1a\u627e\u4e0d\u5230 API Gateway\u3002\u5f53\u7136\uff0c\u5982\u679c\u613f\u610f\u7a0d\u5fae\u9ebb\u70e6\u4e00\u70b9\uff0c\u5728\u90e8\u7f72\u65f6\u6e05\u6670\u7684\u5212\u5b9a\u9700\u8981\u66b4\u9732\u7ed9\u5916\u754c\u7684\u670d\u52a1\uff0c\u76f4\u63a5\u5728\u8fd9\u4e9b\u670d\u52a1\u4e0a\u90e8\u7f72\u5e26 API Gateway \u529f\u80fd\u7684 Sidecar\uff0c\u4e5f\u662f\u53ef\u884c\u7684\uff0c\u53ea\u662f\u7ba1\u7406\u4e0a\u4f1a\u6bd4 BFF \u6a21\u5f0f\u8981\u590d\u6742\u4e00\u4e9b\u3002</p> <p>API Gateway\u201c\u6d88\u5931\u201d\u4e86 \u2014\u2014 \u4e0d\u518d\u6709\u4e00\u4e2a\u660e\u786e\u7269\u7406\u90e8\u7f72\u7684 API Gateway \u7684\u96c6\u7fa4\uff0c\u5e38\u89c4\u7684\u4e2d\u5fc3\u5316\u7684\u7f51\u5173\u5728\u8fd9\u4e2a\u65b9\u6848\u4e2d\u88ab\u878d\u5408\u5230\u6bcf\u4e00\u4e2a BFF \u7684\u5b9e\u4f8b\u4e2d\uff0c\u4ece\u800c\u5b9e\u73b0\u53e6\u5916\u4e00\u4e2a\u91cd\u8981\u7279\u6027\uff1a\u53bb\u4e2d\u5fc3\u5316\u3002</p> <p></p> <p>MOSN \u662f MOSN \u662f Modular Open Smart Network \u7684\u7b80\u79f0\uff0c \u662f\u4e00\u6b3e\u4f7f\u7528 Go \u8bed\u8a00\u5f00\u53d1\u7684\u7f51\u7edc\u4ee3\u7406\u8f6f\u4ef6\uff0c\u7531\u8682\u8681\u91d1\u670d\u5f00\u6e90\u5e76\u7ecf\u8fc7\u51e0\u5341\u4e07\u5bb9\u5668\u7684\u751f\u4ea7\u7ea7\u9a8c\u8bc1\u3002 MOSN \u4f5c\u4e3a\u4e91\u539f\u751f\u7684\u7f51\u7edc\u6570\u636e\u5e73\u9762\uff0c\u65e8\u5728\u4e3a\u670d\u52a1\u63d0\u4f9b\u591a\u534f\u8bae\u3001\u6a21\u5757\u5316\u3001\u667a\u80fd\u5316\u3001\u5b89\u5168\u7684\u4ee3\u7406\u80fd\u529b\u3002 MOSN \u53ef\u4ee5\u4e0e\u4efb\u4f55\u652f\u6301 xDS API \u7684 Service Mesh \u96c6\u6210\uff0c\u4ea6\u53ef\u4ee5\u4f5c\u4e3a\u72ec\u7acb\u7684\u56db\u3001\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\uff0cAPI Gateway\u3001\u4e91\u539f\u751f Ingress \u7b49\u4f7f\u7528</p>"},{"location":"chap12/3apsix_fincloud/","title":"3 Apache APISIX \u5728\u91d1\u878d\u4e91\u539f\u751f\u7684\u751f\u4ea7\u5b9e\u8df5","text":""},{"location":"chap12/3apsix_fincloud/#_1","title":"\u4e1a\u52a1\u80cc\u666f","text":"<p>\u4f17\u591a\u4e1a\u52a1\u90fd\u9700\u8981\u6d41\u91cf\u7f51\u5173\u4f5c\u4e3a\u91cd\u8981\u652f\u6491\uff0c\u7136\u800c\u5728\u91c7\u7528 APISIX \u4e4b\u524d\uff0c\u9047\u5230\u4e86\u4e0d\u5c11\u95ee\u9898\uff1a</p>"},{"location":"chap12/3apsix_fincloud/#1","title":"\u95ee\u9898 1\uff1a\u7f51\u5173\u4e0d\u7edf\u4e00\uff0c\u7ef4\u62a4\u6210\u672c\u9ad8","text":"<p>\u7cfb\u7edf\u5728\u67b6\u6784\u4e0a\u7684\u6f14\u8fdb\uff0c\u5206\u4e3a 3 \u5927\u9636\u6bb5 1. \u5355\u4f53\u670d\u52a1\u65b9\u5f0f\u3002\u670d\u52a1\u5e94\u7528\u90e8\u7f72\u5728\u7269\u7406\u673a\u4e0a\uff0c\u4f46\u662f\u968f\u7740\u670d\u52a1\u5e94\u7528\u548c\u4e1a\u52a1\u7684\u4e0d\u65ad\u589e\u957f\uff0c\u8fd0\u7ef4\u548c\u5f00\u53d1\u6210\u672c\u5f00\u59cb\u6fc0\u589e\uff1b 2. \u865a\u62df\u673a\u65b9\u5f0f\u3002\u5728\u865a\u62df\u673a\u9636\u6bb5\uff0c\u5404\u4e1a\u52a1\u7cfb\u7edf\u4f7f\u7528\u7684\u7f51\u5173\u4e0d\u7edf\u4e00\uff0c\u4e1a\u52a1\u5404\u81ea\u4e3a\u653f\uff0c\u7f51\u5173\u76f8\u5173\u7684\u673a\u5668\u670d\u52a1\u4e5f\u5f88\u591a\uff0c\u7ef4\u62a4\u6210\u672c\u4e00\u76f4\u5f88\u9ad8\u3002     * \u5728\u57fa\u91d1\u8bc1\u5238\u884c\u4e1a\uff0c\u7f51\u7edc\u5206\u533a\u65b9\u9762\u5b58\u5728\u4e00\u5b9a\u7684\u76d1\u7ba1\u8981\u6c42\uff0c\u6bcf\u4e2a\u7f51\u7edc\u5206\u533a\u90fd\u9700\u8981\u6309\u7167\u4fe1\u606f\u5b89\u5168\u7ea7\u522b\u5212\u5206\u4e3a\u4e0d\u540c\u7684\u903b\u8f91\u5b89\u5168\u533a\u57df\uff0c\u6216\u8005\u662f\u7269\u7406\u9694\u79bb\u5b89\u5168\u7684\u533a\u57df\uff0c\u5404\u4e2a\u533a\u57df\u4f7f\u7528\u9632\u706b\u5899\u8fbe\u5230\u7f51\u7edc\u9694\u79bb\u7684\u76ee\u7684\u3002 3. \u7ed3\u5408\u5728\u91d1\u878d\u79d1\u6280\u4e91\u6218\u7565\u4ee5\u53ca\u6570\u5b57\u5316\u8f6c\u578b\u7684\u9700\u6c42\uff0c\u542f\u52a8\u4e86\u4e0a\u4e91\u5de5\u7a0b</p> <p>\u5f53\u524d\u4e1a\u52a1\u7cfb\u7edf\u5927\u81f4\u5206\u4e3a\u4e86\u4e09\u4e2a\u5206\u533a\uff1a\u4ea4\u6613\u533a\u3001\u751f\u4ea7\u533a\u3001\u7ba1\u7406\u533a\uff0c\u6bcf\u4e2a\u5206\u533a\u90e8\u7f72\u7684\u7f51\u5173\u90fd\u4e0d\u4e00\u6837\u3002</p> <p>\u539f\u672c\u4f7f\u7528 NGINX \u4f5c\u4e3a Web \u670d\u52a1\u5668\u548c\u53cd\u5411\u4ee3\u7406\uff0c\u5728\u540c\u7f51\u7edc\u5206\u533a\u4e2d\u7684\u4e1a\u52a1\uff0c\u90fd\u662f\u4f7f\u7528\u4e86\u540c\u4e00\u4e2a NGINX\uff0c\u5bfc\u81f4\u4e86\u6bcf\u6b21\u670d\u52a1\u53d8\u66f4\u6216\u8def\u7531\u66f4\u65b0\uff0c\u90fd\u9700\u8981\u5728\u8fd9\u4e2a NGINX \u4e0a\u9762\u624b\u52a8\u66f4\u65b0\u548c\u91cd\u8f7d\u3002</p> <p></p> <p>\u4e0a\u56fe\u5c31\u662f\u5f53\u524d\u7684\u7cfb\u7edf\u67b6\u6784\uff0c\u4ece\u4e0a\u5f80\u4e0b\u5206\u522b\u662f\u7528\u6237\u63a5\u5165\u5c42\u3001\u8d1f\u8f7d\u5747\u8861\u5c42\u3001\u7f51\u5173\u96c6\u7fa4\u5c42\u4ee5\u53ca\u4e1a\u52a1\u7cfb\u7edf\u5c42\uff0c\u5176\u4e2d\u7f51\u5173\u5b89\u5168\u96c6\u7fa4\u5c42\u4f7f\u7528\u4e86 Zuul\u3001Spring Cloud Gateway\u3001Kong \u8fd8\u6709 NGINX \u7b49\u591a\u4e2a\u6846\u67b6\uff0c\u67b6\u6784\u7ba1\u7406\u4e0d\u7edf\u4e00\uff0c\u7ba1\u7406\u8d77\u6765\u6bd4\u8f83\u7e41\u7410\u3002</p>"},{"location":"chap12/3apsix_fincloud/#2","title":"\u95ee\u9898 2\uff1a\u7f51\u5173\u627f\u8f7d\u80fd\u529b\u5f31","text":"<p>\u73b0\u5b58\u7684\u7f51\u5173\u53ea\u4f7f\u7528\u4e86\u5f88\u57fa\u672c\u7684\u80fd\u529b\uff0c\u6bd4\u5982\u8d1f\u8f7d\u5747\u8861\u3001\u8def\u7531\u8f6c\u53d1\uff0c\u9274\u6743\u3001\u7070\u5ea6\u53d1\u5e03\u3001\u7194\u65ad\u80fd\u529b\u90fd\u6ca1\u6709\u3002</p> <p>\u524d\u9762\u63d0\u5230\u7684\u5355\u4e00\u7684 NGINX \u670d\u52a1\uff0c\u6bcf\u6b21\u670d\u52a1\u53d8\u66f4\u548c\u8def\u7531\u66f4\u65b0\u90fd\u9700\u8981\u5728 NGINX \u4e0a\u9762\u8fdb\u884c\u914d\u7f6e\u3002\u7531\u4e8e\u4e1a\u52a1\u524d\u7aef\u7684\u670d\u52a1\u90fd\u96c6\u6210\u5728 NGINX \u4e0a\u9762\uff0c\u6ca1\u6709\u5bf9\u63a5 DevOps \u5e73\u53f0\u751f\u4ea7\u73af\u5883\uff0cNGINX \u7684\u914d\u7f6e\u9879\u6570\u91cf\u5982\u4eca\u5df2\u7ecf\u76f8\u5f53\u5e9e\u5927\u4e86\uff0c\u5355\u4e2a Server \u6a21\u5757\u8d85\u8fc7 700 \u884c\uff0c\u7ef4\u62a4\u6210\u672c\u76f8\u5f53\u9ad8\u3002</p>"},{"location":"chap12/3apsix_fincloud/#3","title":"\u95ee\u9898 3\uff1a\u9650\u6d41\u7194\u65ad\u3001\u7070\u5ea6\u53d1\u5e03\u914d\u7f6e\u7e41\u7410","text":"<ul> <li>\u9650\u6d41\u7194\u65ad\u80fd\u529b\u7f3a\u5931</li> <li>\u7070\u5ea6\u80fd\u529b\u914d\u7f6e\u7e41\u7410\uff1a\u9700\u540c\u6b65\u6539\u52a8\u591a\u4e2a\u5e94\u7528\u4ee3\u7801\u548c\u6570\u636e\u5e93\u53d8\u66f4\u3002\u73b0\u5728\u4f7f\u7528\u7684\u7f51\u5173\u9700\u8981\u5355\u72ec\u505a\u5bf9\u5e94\u7684\u5f00\u53d1\uff0c\u5e76\u4e14\u4e1a\u52a1\u4fa7\u4e5f\u8981\u505a\u5bf9\u5e94\u7684\u4ee3\u7801\u4fee\u6539\uff0c\u624d\u80fd\u5b9e\u73b0\u4e0d\u540c\u670d\u52a1\u7684\u7070\u5ea6\u80fd\u529b\uff08\u5168\u94fe\u8def\u7070\u5ea6\uff09\u3002</li> </ul>"},{"location":"chap12/3apsix_fincloud/#4","title":"\u95ee\u9898 4\uff1a\u65b0\u589e\u670d\u52a1\u6d89\u53ca\u6b65\u9aa4\u7e41\u591a","text":""},{"location":"chap12/3apsix_fincloud/#5","title":"\u95ee\u9898 5\uff1a\u63a5\u53e3\u8c03\u7528\u5b58\u5728\u5b89\u5168\u9690\u60a3","text":"<p>\u6b64\u5916\uff0c\u5f53\u524d\u4f7f\u7528\u7684\u7f51\u5173\u672a\u6d89\u53ca\u9274\u6743\u80fd\u529b\uff0c\u5404\u63a5\u53e3\u53ef\u76f4\u63a5\u8c03\u7528\uff0c\u4e1a\u52a1\u7cfb\u7edf\u5b58\u5728\u5f88\u9ad8\u7684\u5b89\u5168\u98ce\u9669\u3002</p>"},{"location":"chap12/3apsix_fincloud/#apisix","title":"\u53d1\u73b0\u5e76\u9009\u62e9 APISIX","text":"<p>\u7531\u4e8e\u91d1\u878d\u9886\u57df\u5bf9\u670d\u52a1\u7684\u7a33\u5b9a\u6027\u76f8\u8f83\u5176\u4ed6\u884c\u4e1a\u66f4\u52a0\u91cd\u89c6\uff0c\u56e0\u6b64\u7a33\u5b9a\u6027\u653e\u5728\u7b2c\u4e00\u4f4d\uff0c\u53e6\u5916\u4e5f\u770b\u91cd\u7f51\u5173\u7684\u6269\u5c55\u6027\uff0c\u5bf9\u4e8e\u5728\u865a\u62df\u673a\u65f6\u671f\u91ce\u86ee\u751f\u957f\u7684\u7f51\u5173\u670d\u52a1\uff0c\u90fd\u9700\u8981\u4e00\u4e00\u6ee1\u8db3\u5176\u4e2d\u7684\u4e1a\u52a1\u9700\u6c42\uff0c\u8fd9\u91cc\u5c31\u662f\u6bd4\u8f83\u8003\u9a8c\u6240\u9009\u7f51\u5173\u7684\u6269\u5c55\u6027\uff1b\u518d\u6709\u5c31\u662f\u53ef\u89c2\u6d4b\u6027\uff0c\u5bf9\u4e1a\u52a1\u7cfb\u7edf\u7684\u65e5\u5fd7\u3001\u94fe\u8def\u8ffd\u8e2a\u3001\u76d1\u63a7\u90fd\u6709\u5f88\u5f3a\u70c8\u8981\u6c42\uff1b\u6700\u540e\u5c31\u662f\u70ed\u66f4\u65b0\u7684\u80fd\u529b\u3002</p> <p></p> <p>\u7531\u4e8e NGINX \u65e0\u6cd5\u52a8\u6001\u53d8\u66f4\u914d\u7f6e\uff0c\u56e0\u6b64\u5f53\u9762\u4e34\u914d\u7f6e\u53d8\u66f4\u573a\u666f\u65f6\u9700\u8981\u91cd\u8f7d NGINX \u4ee5\u8f7d\u5165\u65b0\u7684\u914d\u7f6e\uff0c\u7531\u4e8e NGINX \u5b9e\u73b0\u7279\u6027\u7684\u539f\u56e0\uff0c\u8be5\u8fc7\u7a0b\u5c06\u5bfc\u81f4\u4e1a\u52a1\u7cfb\u7edf\u51fa\u73b0\u6d41\u91cf\u6ce2\u52a8\uff0c\u8fdb\u800c\u5f71\u54cd\u7528\u6237\u4f53\u9a8c\u3002</p> <p>\u6240\u4ee5\u57fa\u4e8e\u8fd9 4 \u4e2a\u5173\u6ce8\u70b9\uff0c\u5bf9 APISIX \u548c Kong \u8fdb\u884c\u4e86\u6a2a\u5411\u5bf9\u6bd4\uff1a</p> <p></p> <ul> <li>\u6280\u672f\u6846\u67b6\u65b9\u9762\uff0cAPISIX \u548c Kong \u90fd\u662f\u57fa\u4e8e OpenResty \u7684\u57fa\u7840\u4e4b\u4e0a\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\uff0c\u914d\u7f6e\u4e2d\u5fc3\u65b9\u9762 APISIX \u9009\u578b\u4e86 etcd\uff0cKong \u9009\u578b\u4e86 PostgreSQL\uff0c<ul> <li>\u7531\u4e8e etcd \u7684\u4e91\u539f\u751f\u7279\u6027\u4e0e APISIX \u7684\u72b6\u6001\u7279\u6027\u4f7f\u5f97 APISIX \u662f\u4e91\u539f\u751f\u5206\u5e03\u5f0f\u7f51\u5173\uff1b</li> <li>\u800c Kong \u7684\u914d\u7f6e\u4e2d\u5fc3\u9009\u578b\u4f1a\u6709\u53ef\u80fd\u51fa\u73b0\u5355\u70b9\u6545\u969c\u7684\u95ee\u9898\uff0c\u9700\u8981\u989d\u5916\u7684\u57fa\u7840\u8bbe\u65bd\u4fdd\u969c\u505a\u9ad8\u53ef\u7528\u3002</li> </ul> </li> <li>\u793e\u533a\u6d3b\u8dc3\u5ea6\u65b9\u9762\uff0c APISIX \u548c Kong \u90fd\u662f\u5c5e\u4e8e\u6bd4\u8f83\u9ad8\u70ed\u5ea6\u7684\uff0c\u6bcf\u5929\u7684\u5e73\u5747 commit \u91cf\u662f\u5728 20 \u6b21\u5de6\u53f3\u3002</li> <li>\u6269\u5c55\u6027\u65b9\u9762\uff0c APISIX \u652f\u6301\u7684\u8bed\u8a00\u975e\u5e38\u591a\uff0c\u5e76\u4e14\u8fd8\u652f\u6301 WebAssembly\uff0cKong \u53ea\u652f\u6301\u4f7f\u7528 Lua \u8bed\u8a00\u8fdb\u884c\u63d2\u4ef6\u7684\u7f16\u5199\u3002 \u70ed\u66f4\u65b0\u65b9\u9762\uff0c\u8fd9\u662f\u56e2\u961f\u91cd\u70b9\u5173\u6ce8\u7684\uff1aAPISIX \u652f\u6301\u70ed\u66f4\u65b0\uff0c\u5e76\u4e14\u5b9e\u73b0\u4e86\u6beb\u79d2\u7ea7\u522b\u7684\u70ed\u66f4\u65b0\u54cd\u5e94\uff1b\u800c Kong \u4e0d\u652f\u6301\u70ed\u66f4\u65b0\u3002</li> <li>\u53ef\u89c2\u6d4b\u6027\u65b9\u9762\uff0c\u9009\u578b\u7684\u65f6\u5019 Kong \u8fd8\u672a\u80fd\u63d0\u4f9b SkyWalking \u7684\u652f\u6301\u3002</li> </ul>"},{"location":"chap12/3apsix_fincloud/#apisix_1","title":"\u57fa\u4e8e APISIX \u7684\u89e3\u51b3\u65b9\u6848","text":"<p>\u5982\u56fe\u6240\u793a\uff0c\u666f\u987a\u957f\u57ce\u7684\u7cfb\u7edf\u67b6\u6784\u6539\u9769\u91cd\u70b9\u662f\u5c06\u7f51\u5173\u96c6\u7fa4\u90fd\u8f6c\u6362\u4e3a APISIX\u3002</p> <p>\u7531\u4e8e APISIX \u90e8\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e0a\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7 YAML \u4ee5\u58f0\u660e\u5f0f\u914d\u7f6e\u7684\u65b9\u5f0f\u7edf\u4e00\u7ba1\u7406 API\uff0c\u5e76\u901a\u8fc7 APISIX Ingress Controller \u81ea\u52a8\u76d1\u542c Kubernetes \u8d44\u6e90\u53d8\u66f4\u4e8b\u4ef6\uff0c\u5b9e\u73b0 APISIX \u914d\u7f6e\u7684\u5b9e\u65f6\u540c\u6b65\uff0c\u5305\u62ec AR\uff08ApisixRoute\uff09\u3001SSL\u7b49\u3002</p> <p>\u8def\u7531\u540c\u6b65\u65f6\u5e8f\u56fe\uff1a</p> <p></p> <p>\u4e0b\u9762\u8be6\u7ec6\u4ecb\u7ecd\u6bd4\u8f83\u5173\u5fc3\u7684 4 \u4e2a\u573a\u666f\uff0c\u5305\u62ec\u667a\u80fd\u8def\u7531\u3001\u5b89\u5168\u8ba4\u8bc1\u3001\u53ef\u89c2\u6d4b\u6027\u548c\u6d41\u91cf\u63a7\u5236\u3002</p>"},{"location":"chap12/3apsix_fincloud/#_2","title":"\u573a\u666f\u4e00\uff1a\u667a\u80fd\u8def\u7531","text":"<p>\u4e3b\u8981\u4f53\u73b0\u5728 APISIX \u652f\u6301\u7684 7 \u5c42\u548c 4 \u5c42\u8d1f\u8f7d\u5747\u8861\u30027 \u5c42\u8d1f\u8f7d\u5747\u8861\u4e0a\u7684\u65b9\u6848\u5982\u4e0b\uff1a</p> <p></p> <p>\u7136\u540e\u662f\u751f\u4ea7\u73af\u5883\u4e0a\u7684\u8def\u7531\u914d\u7f6e\u60c5\u51b5\uff1a</p> <p></p> <p>\u6b64\u5916\uff0c\u8def\u7531\u66f4\u65b0\u5728 APISIX \u4e0a\u9762\u4e5f\u8fbe\u5230\u6beb\u79d2\u7ea7\u522b\u54cd\u5e94\uff0c\u914d\u7f6e\u540c\u6b65\u5ef6\u8fdf\u51e0\u4e4e\u65e0\u611f\uff0c\u4f53\u9a8c\u975e\u5e38\u597d\u3002</p> <p>\u4f7f\u7528 Consul \u4f5c\u4e3a\u670d\u52a1\u53d1\u73b0\u7684\u4e2d\u95f4\u4ef6\uff0c\u5728\u8c03\u7814\u8fc7\u7a0b\u4e2d\u53d1\u73b0 APISIX 2.15 \u7248\u672c\u867d\u7136\u652f\u6301\u4e86 Consul \u7684\u670d\u52a1\u53d1\u73b0\u63d2\u4ef6\uff0c\u4f46\u4ec5\u4f5c\u4e3a\u914d\u7f6e\u4e2d\u5fc3\u7684\u65b9\u5f0f\u652f\u6301\uff0c\u800c\u5728\u670d\u52a1\u53d1\u73b0\u90e8\u5206\u7684\u6b63\u5e38\u6a21\u5f0f\u4e0a\u5c1a\u672a\u652f\u6301\u3002\u968f\u540e\uff0c\u57fa\u4e8e\u8be5\u573a\u666f\u5f00\u53d1\u4e86\u652f\u6301 Consul \u7684\u670d\u52a1\u53d1\u73b0\u63d2\u4ef6\uff0c\u5e76\u5df2\u5c06\u5176\u8d21\u732e\u7ed9\u793e\u533a\u3002</p> <p>\u8fd9\u91cc\u8865\u5145\u4ecb\u7ecd\u4e00\u4e0b Consul \u63d2\u4ef6\u7684\u5185\u90e8\u7ec6\u8282\uff0c\u5148\u770b\u4e0b\u56fe\uff1a</p> <p></p> <p>\u4ece\u4e0a\u5f80\u4e0b\u770b\uff0cConsul \u63d2\u4ef6\u662f\u901a\u8fc7 HTTP \u65b9\u5f0f\u53bb\u83b7\u53d6\u4e0d\u540c Consul \u96c6\u7fa4\u7684 Service \u4fe1\u606f\u7684\uff0c\u8fd9\u91cc\u4f1a\u83b7\u53d6\u670d\u52a1\u4fe1\u606f\u4f1a\u505a\u6821\u9a8c\uff0c\u5c31\u662f <code>last consul index(X-Consul-Index)</code>\uff0c\u8fd9\u4e2a index \u5b57\u6bb5\u662f\u5728 header \u91cc\u9762\u7684\uff0c\u53ea\u6709\u5728\u670d\u52a1\u4fe1\u606f\u53d8\u5316\u7684\u65f6\u5019\u624d\u4f1a\u8fd4\u56de\u7ed3\u679c\uff0c\u6240\u4ee5\u8fd9\u4e5f\u5f88\u597d\u5730\u4fdd\u8bc1\u4e86 APISIX \u548c Consul \u4e4b\u95f4\u7684\u8bf7\u6c42\u6570\u91cf\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u5728 APISIX \u4e2d\u4f1a\u6709\u591a\u4e2a worker \u540c\u6b65\u66f4\u65b0 <code>all_services</code> \u8868\u4e2d\u7684\u4fe1\u606f\uff0c\u8be5\u8868\u5305\u542b\u4e86\u5404\u4e2a\u670d\u52a1\u540d\u79f0\u5bf9\u5e94\u7684 IP \u548c\u7aef\u53e3\u53f7\u3002</p> <p>\u8fd9\u4e9b worker \u901a\u8fc7\u4e8b\u4ef6\u673a\u5236\u8fdb\u884c\u901a\u4fe1\uff0c\u5e76\u63d0\u4f9b\u4e86 debugging API \u4ee5\u65b9\u4fbf\u7528\u6237\u83b7\u53d6\u5f53\u524d\u7684\u670d\u52a1\u4fe1\u606f\u3002\u4e0b\u9762\u662f\u6d41\u7a0b\u7684\u8be6\u7ec6\u4ecb\u7ecd\uff1a</p> <p>Consul \u63d0\u4f9b\u4e86 Catalog \u7684 API \u65b9\u5f0f\u83b7\u53d6 services \u4fe1\u606f\uff0c\u5176\u4e2d\u8fd9\u91cc\u53ef\u4ee5\u5206\u6210\u4e24\u6b65\uff1a</p> <p>\u83b7\u53d6\u6240\u6709\u670d\u52a1\u540d\u79f0</p> <p>\u83b7\u53d6\u6240\u6709\u670d\u52a1\u4fe1\u606f\u4e2d\u7684 API\uff1a<code>List Services</code>\uff0c\u8be5 API \u662f\u652f\u6301 [<code>Blocking Queries</code>]https://developer.hashicorp.com/consul/api-docs/features/blocking)\uff0c\u5c31\u662f\u6839\u636e\u8bf7\u6c42\u5934\u7684 <code>X-Consul-Index</code> \u5b57\u6bb5\u503c\u4e0d\u540c\u53bb\u62c9\u53d6\u670d\u52a1\u5217\u8868\uff0c\u53ea\u6709\u670d\u52a1\u5217\u8868\u51fa\u73b0\u53d8\u5316\u7684\u65f6\u5019\u624d\u4f1a\u6539\u53d8 <code>X-Consul-Index</code> \u5b57\u6bb5\u7684\u503c\uff1b</p> <p>\u83b7\u53d6\u6bcf\u4e2a\u670d\u52a1\u8282\u70b9\u4fe1\u606f</p> <p>\u6839\u636e\u7b2c\u4e00\u6b65\u83b7\u53d6\u7684\u670d\u52a1\u5217\u8868\u8fdb\u884c\u904d\u5386\uff0c\u628a\u6bcf\u4e2a\u670d\u52a1\u7684 node \u4fe1\u606f\u83b7\u53d6\u5e76\u8bb0\u5f55\u5230 table \u4e2d\uff0c\u5bf9\u5e94 Consul API\uff1aList Nodes for Service\uff0c\u540c\u65f6\u901a\u8fc7\u4e8b\u4ef6\u7684\u65b9\u5f0f\u5b9e\u65f6\u66f4\u65b0\uff0c\u4e0b\u9762\u662f\u7b80\u5355\u7684\u6d41\u7a0b\u56fe\uff1a</p> <p></p> <p>\u8fd9\u5c31\u662f\u6574\u4e2a Consul \u670d\u52a1\u53d1\u73b0\u63d2\u4ef6\u7684\u5185\u90e8\u5b9e\u8df5\u7ec6\u8282\u3002</p>"},{"location":"chap12/3apsix_fincloud/#_3","title":"\u573a\u666f\u4e8c\uff1a\u5b89\u5168\u8ba4\u8bc1","text":"<p>\u5728\u5b89\u5168\u9a8c\u8bc1\u65b9\u9762\uff0c\u6211\u4eec\u4f7f\u7528\u4e86\u7edf\u4e00\u8ba4\u8bc1\u548c HTTPS \u91cd\u5b9a\u5411\u63d2\u4ef6\u3002\u5728\u5f15\u5165\u7edf\u4e00\u7f51\u5173\u4e4b\u524d\uff0c\u6bcf\u4e2a\u4e1a\u52a1\u90fd\u9700\u8981\u5355\u72ec\u5f00\u53d1 Auth \u76f8\u5173\u5185\u5bb9\uff0c\u4ee5\u4fdd\u62a4\u5176\u6570\u636e\u63a5\u53e3\u7684\u5b89\u5168\u6027</p> <p></p> <p>\u5728\u4e1a\u52a1\u4fa7\uff0c\u6bcf\u4e2a\u4e1a\u52a1\u7cfb\u7edf\u5f00\u53d1\u76f8\u540c\u7684\u9274\u6743\u529f\u80fd\uff0c\u4e00\u65b9\u9762\u662f\u5f00\u53d1\u6210\u672c\u76f8\u5bf9\u6bd4\u8f83\u9ad8\uff0c\u53e6\u4e00\u65b9\u9762\u5404\u81ea\u4e1a\u52a1\u7cfb\u7edf\u5f00\u53d1\u51fa\u6765\u7684\u529f\u80fd\u8d28\u91cf\u4e0d\u4e00\uff0c\u91cd\u590d\u9020\u8f6e\u5b50\u3002</p> <p>\u6240\u4ee5\u8ba1\u5212\u628a\u7edf\u4e00\u8ba4\u8bc1\u529f\u80fd\u653e\u5728\u7f51\u5173\u4e0a\uff0c\u540c\u65f6\u89e3\u51b3\u524d\u9762\u63d0\u5230\u7684\u95ee\u9898\uff0c\u6781\u5927\u63d0\u9ad8\u4e86\u4e1a\u52a1\u7cfb\u7edf\u7684\u7814\u53d1\u6548\u7387\uff0c\u8ba9\u5f00\u53d1\u8005\u66f4\u4e13\u6ce8\u4e1a\u52a1\u5f00\u53d1</p> <p></p> <p>\u4e0a\u56fe\u662f APISIX \u52a8\u6001\u7ba1\u7406 SSL \u8bc1\u4e66\u8be6\u60c5\uff0c\u901a\u8fc7 Kubernetes \u7684 cert-manager \u7edf\u4e00\u8fdb\u884c\u8bc1\u4e66\u7684\u9881\u53d1\u548c\u7ba1\u7406\u3002</p> <p>\u5728\u7edf\u4e00\u7f51\u5173\u4e4b\u524d\uff0c\u670d\u52a1\u7684 HTTPS \u8bc1\u4e66\u90fd\u662f\u5728 HA \u7aef\u8fdb\u884c\u89e3\u6790\uff0c\u73b0\u5728\u7edf\u4e00\u653e\u5728 APISIX \u4e2d\uff0c\u5e76\u4e14 APISIX \u652f\u6301\u52a8\u6001\u52a0\u8f7d SSL \u8bc1\u4e66\u3002</p>"},{"location":"chap12/3apsix_fincloud/#_4","title":"\u573a\u666f\u4e09\uff1a\u53ef\u89c2\u6d4b\u6027","text":"<p>\u539f\u4e1a\u52a1\u7cfb\u7edf\u5728\u53ef\u89c2\u6d4b\u6027\u65b9\u9762\u652f\u6301\u76f8\u5bf9\u8f83\u5f31\uff0c\u56e0\u6b64\u56e2\u961f\u5e0c\u671b\u80fd\u591f\u5feb\u901f\u63a5\u5165 APISIX \u63d0\u4f9b\u7684\u65e5\u5fd7\u76d1\u63a7\u3001Tracing \u7b49\u591a\u4e2a\u63d2\u4ef6\u3002</p> <p>\u6b64\u5916\uff0c\u56e2\u961f\u8fd8\u5728\u8c03\u7814\u5e76\u4f7f\u7528 Apache SkyWalking \u8fdb\u884c\u94fe\u8def\u8ffd\u8e2a\u3001Prometheus \u8fdb\u884c\u76d1\u63a7\u3001ELK \u8fdb\u884c\u65e5\u5fd7\u6536\u96c6\u3002\u5bf9\u4e8e\u7f51\u5173\u5c42\uff0c\u53ea\u9700\u8fdb\u884c\u7b80\u5355\u7684\u914d\u7f6e\u5373\u53ef\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e9b\u5de5\u5177\u3002</p> <p>\u751f\u4ea7\u4e0a\u63a5\u5165 SkyWalking \u540e\u7684\u670d\u52a1\u62d3\u6251\u56fe\uff0c\u8be5\u56fe\u6e05\u6670\u5730\u5c55\u793a\u4e86\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\uff0c\u5305\u62ec\u7ecf\u8fc7\u7f51\u5173\u7684\u6d41\u91cf\u65b9\u5411\u548c\u6210\u529f\u7387\u7b49\u5173\u952e\u4fe1\u606f\u3002\u901a\u8fc7\u8be5\u62d3\u6251\u56fe\uff0c\u56e2\u961f\u53ef\u4ee5\u5feb\u901f\u5b9a\u4f4d\u94fe\u8def\u9519\u8bef\u70b9\u7684\u4f4d\u7f6e</p>"},{"location":"chap12/3apsix_fincloud/#_5","title":"\u573a\u666f\u56db\uff1a\u6d41\u91cf\u63a7\u5236","text":"<p>\u5728\u6d41\u91cf\u63a7\u5236\u7684\u573a\u666f\u4e0b\uff0c\u6709\u57fa\u4e8e\u7070\u5ea6\u548c\u57fa\u4e8e\u6743\u91cd\u8fd9\u4e24\u79cd\u7b56\u7565\u3002</p> <ul> <li>\u57fa\u4e8e\u7070\u5ea6\u7b56\u7565\u7684\u573a\u666f\u4e2d\uff0c\u7f51\u5173\u9700\u8981\u901a\u8fc7 HTTP \u8bf7\u6c42\u8c03\u7528\u4e0b\u6e38\u67d0\u4e2a\u63a5\u53e3\u4ee5\u83b7\u53d6\u7279\u5b9a\u7684\u6570\u636e\uff0c\u5e76\u6839\u636e\u8fd4\u56de\u7ed3\u679c\u8fdb\u884c\u5224\u65ad\uff0c\u4ee5\u786e\u5b9a\u662f\u5426\u9700\u8981\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u7070\u5ea6\u73af\u5883\u3002</li> <li>\u57fa\u4e8e\u6743\u91cd\u7b56\u7565\u7684\u573a\u666f\uff0c\u865a\u62df\u673a\u548c\u5bb9\u5668\u7684\u670d\u52a1\u5e76\u884c\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u4f8b\u5982\u5c06 90% \u7684\u6d41\u91cf\u547d\u4e2d\u865a\u62df\u673a\u670d\u52a1\uff0c10% \u7684\u6d41\u91cf\u547d\u4e2d\u4e91\u670d\u52a1\uff0c\u4ee5\u9a8c\u8bc1\u4e91\u670d\u52a1\u7684\u7a33\u5b9a\u6027\u3002\u76ee\u524d\uff0c\u666f\u987a\u957f\u57ce\u7684\u751f\u4ea7\u73af\u5883\u5df2\u7ecf\u914d\u7f6e\u4e86\u57fa\u4e8e\u6743\u91cd\u7684\u7070\u5ea6\u53d1\u5e03\u3002</li> </ul>"},{"location":"chap12/3apsix_fincloud/#_6","title":"\u6536\u76ca\u4e0e\u5c55\u671b","text":"<ol> <li>\u7edf\u4e00\u4e86 API \u7f51\u5173\u6846\u67b6\uff0c\u964d\u4f4e\u4e86\u4e1a\u52a1\u7cfb\u7edf\u5f00\u53d1\u7684\u8fd0\u7ef4\u6210\u672c\uff0c\u76ee\u524d\u751f\u4ea7\u73af\u5883\u5df2\u7ecf\u63a5\u5165\u4e86\u5927\u7ea6 10% \u7684\u4e1a\u52a1\uff1b</li> <li>\u5728 DevOps \u548c\u6d41\u6c34\u7ebf\u7684\u7ed3\u5408\u65b9\u9762\uff0c\u6781\u5927\u5730\u63d0\u9ad8\u4e86\u8def\u7531\u53d1\u5e03\u548c\u670d\u52a1\u53d1\u5e03\u7684\u7a33\u5b9a\u6027\uff1b</li> <li>APISIX \u7684\u70ed\u66f4\u65b0\u80fd\u529b\u5927\u5927\u964d\u4f4e\u4e86\u670d\u52a1\u91cd\u542f\u7684\u538b\u529b\u3002</li> </ol> <p>\u6700\u540e\uff0c\u5bf9\u4e8e APISIX \u7684\u672a\u6765\u9ad8\u6548\u7a33\u5b9a\u8fd0\u884c\uff0c\u63d0\u51fa\u4e86\u4ee5\u4e0b\u4e09\u70b9\u671f\u671b\uff1a</p> <ol> <li>\u76d1\u63a7\u544a\u8b66\u65b9\u9762\uff0c\u5e0c\u671b APISIX \u80fd\u591f\u4e0d\u65ad\u5b8c\u5584\u8def\u7531\u53ef\u7528\u6027\u7684\u9ad8\u7ea7\u914d\u7f6e\uff0c\u4f8b\u5982\u90ae\u4ef6\u544a\u8b66\u3001\u5fae\u4fe1\u6307\u6807\u544a\u8b66\u7b49\u3002</li> <li>APISIX \u548c etcd \u7684\u7a33\u5b9a\u8fde\u63a5\u65b9\u9762\uff0c\u76ee\u524d APISIX \u548c etcd \u901a\u8fc7 HTTP \u8fdb\u884c\u901a\u4fe1\uff0c\u4f46\u5728 etcd v3 \u7248\u672c\u4e4b\u540e\uff0cAPI \u534f\u8bae\u5df2\u7ecf\u5207\u6362\u5230\u4e86 gRPC \u534f\u8bae\uff0c\u56e0\u6b64\u5e0c\u671b APISIX \u548c etcd \u901a\u8fc7 gRPC \u8fdb\u884c\u901a\u4fe1\uff0c\u4ee5\u63d0\u9ad8\u6548\u7387\u548c\u7a33\u5b9a\u6027\uff0c\u5e76\u907f\u514d\u901a\u8fc7 gRPC Gateway \u8fdb\u884c\u8f6c\u6362\u3002</li> <li>\u94fe\u8def\u8ffd\u8e2a\u65b9\u9762\uff0c\u5e0c\u671b\u901a\u8fc7 APISIX \u7f51\u5173\u63a5\u5165\u5b9e\u73b0\u670d\u52a1\u7684\u5168\u94fe\u8def\u8ffd\u8e2a\u3002</li> </ol>"},{"location":"chap12/4lambda_apisix/","title":"4 Amazon Lambda \u9047\u4e0a Apache APISIX","text":""},{"location":"chap12/4lambda_apisix/#amazon-lambda-apache-apisix","title":"\u4f7f\u7528 Amazon Lambda \u65f6\u4e3a\u4ec0\u4e48\u9700\u8981 Apache APISIX?","text":""},{"location":"chap12/4lambda_apisix/#serverless-amazon-lambda","title":"Serverless \u548c Amazon Lambda","text":"<p>\u4ec0\u4e48\u662f Serverless\uff1f</p> <p>Serverless \u7684\u57fa\u7840\u6982\u5ff5\u662f\u5c06\u8fd0\u884c\u670d\u52a1\u6240\u9700\u7684\u57fa\u7840\u8bbe\u65bd\u4ea4\u7531\u4e91\u670d\u52a1\u63d0\u4f9b\u5546\u7ba1\u7406\uff0c\u4ee5\u53ca\u4e00\u4e9b\u81ea\u90e8\u7f72\u7684 Serverless \u5e73\u53f0\uff0c\u4ece\u800c\u8ba9\u4f7f\u7528 Serverless \u7684\u5de5\u7a0b\u5e08\u53ef\u4ee5\u4e13\u6ce8\u4e8e\u9762\u5411\u5ba2\u6237\u4e1a\u52a1\u5e94\u7528\u5c42\u7684\u5f00\u53d1\uff0c\u800c\u4e0d\u9700\u8981\u5728\u57fa\u7840\u8bbe\u65bd\u7684\u6784\u5efa\u3001\u7ba1\u7406\u3001\u6269\u5bb9\u7b49\u4efb\u52a1\u4e0a\u6295\u5165\u8fc7\u591a\u7cbe\u529b\u3002</p> <p>\u5f88\u591a\u4e91\u670d\u52a1\u63d0\u4f9b\u5546\u4e5f\u5728\u63a8\u51fa Serverless \u76f8\u5173\u7684\u4ea7\u54c1\uff0cAmazon Serverless \u7684\u6838\u5fc3\u662f\u540d\u4e3a Amazon Lambda \u7684\u8ba1\u7b97\u670d\u52a1\u3002</p> <p>\u5982\u56fe 1 \u6240\u793a\uff0c\u548c\u4f20\u7edf\u7684\u5f00\u53d1\u3001\u7f16\u8bd1\u3001\u90e8\u7f72\u8fd0\u884c\u65b9\u5f0f\u4e0d\u540c\uff0c\u4f7f\u7528 Amazon Serverless \u8ba1\u7b97\u670d\u52a1 Lambda\uff0c\u4ec5\u9700\u8981\u4e0a\u4f20\u6e90\u6587\u4ef6\uff0c\u9009\u62e9\u6267\u884c\u73af\u5883\u5e76\u6267\u884c\uff0c\u4fbf\u80fd\u5f97\u5230\u8fd0\u884c\u7ed3\u679c\u3002</p> <p>\u5728\u8be5\u8fc7\u7a0b\u4e2d\uff0c\u670d\u52a1\u5668\u90e8\u7f72\uff0c runtime \u5b89\u88c5\u3001\u7f16\u8bd1\u3001\u90fd\u7531 Amazon Serverless \u8ba1\u7b97\u5e73\u53f0\u7ba1\u7406\u6267\u884c\u3002\u5bf9\u5de5\u7a0b\u5e08\u6765\u8bf4\uff0c\u53ea\u9700\u8981\u7ef4\u62a4\u6e90\u4ee3\u7801\u548c Amazon Serverless \u6267\u884c\u73af\u5883\u7684\u76f8\u5173\u914d\u7f6e\u5373\u53ef\u3002\u4e8e\u6b64\u76f8\u5173\u7684\u6280\u672f\u6709BaaS\uff08Backend as a Service\uff0c\u540e\u7aef\u5373\u670d\u52a1\uff09\uff0c\u662f\u6307\u6211\u4eec\u4e0d\u518d\u7f16\u5199\u548c/\u6216\u7ba1\u7406\u6240\u6709\u670d\u52a1\u7aef\u7ec4\u4ef6\uff0c\u628a\u5e94\u7528\u4e2d\u7684\u5404\u4e2a\u90e8\u5206\u5b8c\u5168\u5916\u5305\u51fa\u53bb\uff0c\u800c Serverless \u662f\u4e00\u79cd\u65b0\u7684\u8fd0\u884c\u4ee3\u7801\u7684\u6258\u7ba1\u73af\u5883\u3002</p> <p></p> <p>\u4e3a\u4ec0\u4e48\u9700\u8981 Serverless\uff1f</p> <p>\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458\u800c\u8a00\uff0cServerless \u53ef\u4ee5\u5bf9\u7a0b\u5e8f\u6267\u884c\u7ec6\u8282\u8fdb\u884c\u62bd\u8c61\uff0c\u8ba9\u4e1a\u52a1\u5f00\u53d1\u5de5\u7a0b\u5e08\u4e13\u6ce8\u4e8e\u4ee3\u7801\u672c\u8eab\uff1b</p> <ul> <li>\u5bf9\u4e8e\u6210\u672c\u800c\u8a00\uff0c\u53ea\u9700\u6309\u7167\u4f7f\u7528\u91cf\u4ed8\u8d39\uff1b</li> <li>\u5bf9\u4e8e\u670d\u52a1\u6027\u80fd\u800c\u8a00\uff0c\u53ef\u4ee5\u81ea\u52a8\u54cd\u5e94\u4efb\u4f55\u89c4\u6a21\u7684\u4ee3\u7801\u6267\u884c\u8bf7\u6c42\uff0c\u53ef\u4ee5\u901a\u8fc7\u8c03\u6574\u51fd\u6570\u5185\u5b58\u5927\u5c0f\u4f18\u5316\u4ee3\u7801\u6267\u884c\u65f6\u95f4\u548c\u54cd\u5e94\u65f6\u95f4\u3002</li> </ul> <p>\u4ece\u5982\u56fe 1 \u4e2d\u7684\u5bf9\u6bd4\u4e5f\u53ef\u4ee5\u770b\u51fa\uff0c\u57fa\u4e8e Serverless \u7684\u5f00\u53d1\uff0c\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458\u6765\u8bf4\u66f4\u53cb\u597d\u3002</p> <p>\u4f7f\u7528 Serverless \u65f6\u4e3a\u4ec0\u4e48\u9700\u8981\u4e00\u4e2a\u7f51\u5173\uff1f</p> <p>Serverless \u670d\u52a1\u7684\u4f7f\u7528\u4e5f\u5b58\u5728\u4e00\u4e9b\u95ee\u9898\uff1a</p> <ol> <li>\u6bd4\u5982\u5c06\u51fd\u6570 URL \u786c\u7f16\u7801\u5230\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff1b</li> <li>\u5176\u6b21\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u7684\u6388\u6743\u548c\u8eab\u4efd\u9a8c\u8bc1\u95ee\u9898\u4e5f\u6bd4\u8f83\u7e41\u7410\uff1b</li> <li>\u518d\u8005\u66f4\u65b0\u4e91\u670d\u52a1\u63d0\u4f9b\u5546\u7684\u8fc7\u7a0b\u4e5f\u662f\u4e00\u4e2a\u6bd4\u8f83\u8270\u5de8\u7684\u5de5\u7a0b\u3002</li> </ol> <p>\u7f51\u5173\u53ef\u4ee5\u5929\u7136\u7684\u89e3\u51b3\u4e0a\u8ff0\u7684\u95ee\u9898\uff0c\u901a\u8fc7\u7ec4\u5408\u7684\u65b9\u5f0f\uff0cServerless\u53ef\u4ee5\u66f4\u597d\u7684\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u3002\u56fe 2 \u63cf\u8ff0\u7684\u662f\u5982\u4f55\u7528 Amazon Serverless \u7684\u76f8\u5173\u670d\u52a1\u8fc5\u901f\u7ec4\u88c5\u4e00\u4e2a\u7b80\u5355\u7684 Web Service\uff0c\u7f51\u5173\u5728\u6388\u6743\u7b49\u95ee\u9898\u4e2d\u53d1\u6325\u91cd\u8981\u4f5c\u7528\u3002</p> <p>\u4ee5 Apache APISIX \u4e3a\u4f8b\uff0c\u5b83\u4e3a\u6d41\u884c\u7684\u4e91\u670d\u52a1\u63d0\u4f9b\u5546\uff08AWS\u3001Azure\uff09\u63d0\u4f9b Serverless \u6846\u67b6\u652f\u6301\uff1b\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u8def\u7531\u53bb\u542f\u7528 Serverless \u63d2\u4ef6\uff0c\u800c\u4e0d\u662f\u5c06\u51fd\u6570 URL \u786c\u7f16\u7801\u5230\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff1b</p> <p>\u4e3a\u5f00\u53d1\u4eba\u5458\u63d0\u4f9b\u4e86\u70ed\u66f4\u65b0\u51fd\u6570 URI \u7684\u7075\u6d3b\u6027\uff0c\u66f4\u65b0\u4e0d\u540c\u7684 FaaS \u4e91\u670d\u52a1\u63d0\u4f9b\u5546\u4e5f\u6ca1\u6709\u4ec0\u4e48\u989d\u5916\u7684\u9ebb\u70e6\uff1b\u6b64\u5916\uff0c\u8fd9\u79cd\u65b9\u6cd5\u51cf\u8f7b\u4e86\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u7684\u6388\u6743\u548c\u8eab\u4efd\u9a8c\u8bc1\u95ee\u9898\u3002</p> <p></p>"},{"location":"chap12/4lambda_apisix/#apache-apisix","title":"Apache APISIX","text":"<p>Apache APISIX \u662f Apache \u8f6f\u4ef6\u57fa\u91d1\u4f1a\u4e0b\u7684\u4e91\u539f\u751f API \u7f51\u5173\uff0c\u5b83\u517c\u5177\u52a8\u6001\u3001\u5b9e\u65f6\u3001\u9ad8\u6027\u80fd\u7b49\u7279\u70b9\uff0c\u63d0\u4f9b\u4e86\u8d1f\u8f7d\u5747\u8861\u3001\u52a8\u6001\u4e0a\u6e38\u3001\u7070\u5ea6\u53d1\u5e03\uff08\u91d1\u4e1d\u96c0\u53d1\u5e03\uff09\u3001\u670d\u52a1\u7194\u65ad\u3001\u8eab\u4efd\u8ba4\u8bc1\u3001\u53ef\u89c2\u6d4b\u6027\u7b49\u4e30\u5bcc\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Apache APISIX \u6765\u5904\u7406\u4f20\u7edf\u7684\u5357\u5317\u5411\u6d41\u91cf\uff0c\u4e5f\u53ef\u4ee5\u5904\u7406\u670d\u52a1\u95f4\u7684\u4e1c\u897f\u5411\u6d41\u91cf\u3002\u540c\u65f6\uff0c\u5b83\u4e5f\u652f\u6301\u4f5c\u4e3a K8s Ingress Controller \u6765\u4f7f\u7528\u3002APISIX \u901a\u8fc7\u63d2\u4ef6\u6765\u6269\u5145\u751f\u6001\uff0c\u76ee\u524d\u4e5f\u5185\u7f6e\u4e86\u5404\u7c7b\u63d2\u4ef6\uff0c\u8986\u76d6\u4e86 API \u7f51\u5173\u7684\u5404\u79cd\u9886\u57df\uff0c\u5982\u8ba4\u8bc1\u9274\u6743\u3001\u5b89\u5168\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u6d41\u91cf\u7ba1\u7406\u3001\u591a\u534f\u8bae\u63a5\u5165\u7b49\uff0c\u5f53\u7136\uff0c\u4e5f\u5305\u542b\u5f88\u591a Serverless \u76f8\u5173\u63d2\u4ef6\u3002</p>"},{"location":"chap12/4lambda_apisix/#aws-lambda","title":"AWS Lambda \u63d2\u4ef6","text":"<p><code>aws-lambda</code> \u63d2\u4ef6\u7528\u4e8e\u5c06 AWS Lambda \u4f5c\u4e3a\u52a8\u6001\u4e0a\u6e38\u96c6\u6210\u81f3 APISIX\uff0c\u4ece\u800c\u5b9e\u73b0\u5c06\u8bbf\u95ee\u6307\u5b9a URI \u7684\u8bf7\u6c42\u4ee3\u7406\u5230 AWS \u4e91\u3002\u7528\u6237\u4f7f\u7528\u8be5\u63d2\u4ef6\u7ec8\u6b62\u5bf9\u5df2\u914d\u7f6e URI \u7684\u8bf7\u6c42\uff0c\u5e76\u4ee3\u8868\u5ba2\u6237\u7aef\u5411 AWS Lambda Gateway URI \u53d1\u8d77\u4e00\u4e2a\u65b0\u7684\u8bf7\u6c42\u3002</p> <p>\u8fd9\u4e2a\u65b0\u8bf7\u6c42\u4e2d\u643a\u5e26\u4e86\u4e4b\u524d\u914d\u7f6e\u7684\u6388\u6743\u8be6\u7ec6\u4fe1\u606f\uff0c\u5305\u62ec\u8bf7\u6c42\u5934\u3001\u8bf7\u6c42\u4f53\u548c\u53c2\u6570\uff08\u4ee5\u4e0a\u53c2\u6570\u90fd\u662f\u4ece\u539f\u59cb\u8bf7\u6c42\u4e2d\u4f20\u9012\u7684\uff09\uff0c\u7136\u540e <code>aws-lambda</code> \u63d2\u4ef6\u4f1a\u5c06\u5e26\u6709\u54cd\u5e94\u5934\u3001\u72b6\u6001\u7801\u548c\u54cd\u5e94\u4f53\u7684\u54cd\u5e94\u4fe1\u606f\u8fd4\u56de\u7ed9\u4f7f\u7528 APISIX \u53d1\u8d77\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef\u3002\u8be5\u63d2\u4ef6\u652f\u6301\u901a\u8fc7 <code>AWS API key</code> \u548c <code>AWS IAM secrets</code> \u8fdb\u884c\u6388\u6743\u3002</p>"},{"location":"chap12/4lambda_apisix/#apache-apisix-serverless","title":"Apache APISIX \u4e0e Serverless \u76f8\u5173\u63d2\u4ef6\u603b\u7ed3","text":"<p>\u9664\u4e86 Amazon Lambda\uff0cApache APISIX \u8fd8\u652f\u6301\u4e0e Azure Function\u3001Lua \u51fd\u6570\u548c Apache OpenWhisk \u7b49 Serverless \u76f8\u5173\u751f\u6001\u7684\u96c6\u6210\uff0c\u4ece\u800c\u63d0\u4f9b\u76f8\u5e94\u7684 Serverless \u63d2\u4ef6\uff0c\u5177\u4f53\u5982\u4e0b\u3002</p> <p>\u8868 1 Apache APISIX Serverless \u76f8\u5173\u63d2\u4ef6\u5177\u4f53\u4fe1\u606f</p> <ul> <li> <p>serverless :\u3000\u7528\u6237\u53ef\u4ee5\u901a\u8fc7 Serverless \u63d2\u4ef6\u4e0a\u4f20\u81ea\u5b9a\u4e49\u7684 Lua \u811a\u672c\uff0c\u5e76\u6839\u636e\u914d\u7f6e\u4e2d\u7684 phase \u6765\u6307\u5b9a\u4ee3\u7801\u8fd0\u884c\u9636\u6bb5\u3002\u3000\u3000</p> <ul> <li>\u4f8b\u5982\u5728 access \u9636\u6bb5\u5bf9\u8bf7\u6c42\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\uff0c\u5728 header filter\uff0cbody filter \u9636\u6bb5\uff0c\u5bf9\u54cd\u5e94\u5934\u6216\u54cd\u5e94\u4f53\u8fdb\u884c\u4fee\u6539\uff0c\u6216\u8005\u5728 log \u9636\u6bb5\u6253\u5370\u4e2a\u6027\u5316\u65e5\u5fd7\u7b49\u3002\u53e6\u5916\uff0c\u7531\u4e8e Serverless \u63d2\u4ef6\u662f\u70ed\u52a0\u8f7d\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u4e0d\u9700\u8981\u91cd\u65b0\u542f\u52a8 Apache APISIX \u4fbf\u53ef\u7acb\u5373\u751f\u6548\u3002</li> </ul> </li> <li> <p>azure-functions</p> <ul> <li>\u7528\u4e8e\u5c06 Azure Serverless Function \u4f5c\u4e3a\u52a8\u6001\u4e0a\u6e38\u96c6\u6210\u81f3 APISIX\uff0c\u4ece\u800c\u5b9e\u73b0\u5c06\u8bbf\u95ee\u6307\u5b9a URI \u7684\u8bf7\u6c42\u4ee3\u7406\u5230 Microsoft Azure \u4e91\u670d\u52a1\u3002</li> <li>\u542f\u7528 azure-functions \u63d2\u4ef6\u540e\uff0c\u8be5\u63d2\u4ef6\u4f1a\u7ec8\u6b62\u5bf9\u5df2\u914d\u7f6e URI \u7684\u8bf7\u6c42\uff0c\u5e76\u4ee3\u8868\u5ba2\u6237\u7aef\u5411 Azure Functions \u53d1\u8d77\u4e00\u4e2a\u65b0\u7684\u8bf7\u6c42\u3002</li> <li>\u8be5\u65b0\u8bf7\u6c42\u4e2d\u643a\u5e26\u4e86\u4e4b\u524d\u914d\u7f6e\u7684\u6388\u6743\u8be6\u7ec6\u4fe1\u606f\uff0c\u5305\u62ec\u8bf7\u6c42\u5934\u3001\u8bf7\u6c42\u4f53\u548c\u53c2\u6570\uff08\u4ee5\u4e0a\u53c2\u6570\u90fd\u662f\u4ece\u539f\u59cb\u8bf7\u6c42\u4e2d\u4f20\u9012\u7684\uff09\u3002\u4e4b\u540e\u4fbf\u4f1a\u901a\u8fc7 azure-functions \u63d2\u4ef6\uff0c\u5c06\u5e26\u6709\u54cd\u5e94\u5934\u3001\u72b6\u6001\u7801\u548c\u54cd\u5e94\u4f53\u7684\u4fe1\u606f\u8fd4\u56de\u7ed9\u4f7f\u7528 APISIX \u53d1\u8d77\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef\u3002</li> </ul> </li> <li> <p>openwhisk</p> <ul> <li>\u7528\u4e8e\u5c06\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u65e0\u670d\u52a1\u5668\u5e73\u53f0 Apache OpenWhisk \u4f5c\u4e3a\u52a8\u6001\u4e0a\u6e38\u96c6\u6210\u81f3 APISIX\u3002\u542f\u7528 openwhisk \u63d2\u4ef6\u540e\uff0c\u8be5\u63d2\u4ef6\u4f1a\u7ec8\u6b62\u5bf9\u5df2\u914d\u7f6e URI \u7684\u8bf7\u6c42\uff0c\u5e76\u4ee3\u8868\u5ba2\u6237\u7aef\u5411 OpenWhisk \u7684 API Host \u7aef\u70b9\u53d1\u8d77\u4e00\u4e2a\u65b0\u7684\u8bf7\u6c42\uff0c\u7136\u540e openwhisk \u63d2\u4ef6\u4f1a\u5c06\u54cd\u5e94\u4fe1\u606f\u8fd4\u56de\u81f3\u5ba2\u6237\u7aef\u3002</li> </ul> </li> <li> <p>openfunction</p> <ul> <li>\u7528\u4e8e\u5c06\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u65e0\u670d\u52a1\u5668\u5e73\u53f0 CNCF OpenFunction \u4f5c\u4e3a\u52a8\u6001\u4e0a\u6e38\u96c6\u6210\u81f3 APISIX\u3002</li> <li>\u542f\u7528 openfunction \u63d2\u4ef6\u540e\uff0c\u8be5\u63d2\u4ef6\u4f1a\u7ec8\u6b62\u5bf9\u5df2\u914d\u7f6e URI \u7684\u8bf7\u6c42\uff0c\u5e76\u4ee3\u8868\u5ba2\u6237\u7aef\u5411 OpenFunction \u7684 function \u53d1\u8d77\u4e00\u4e2a\u65b0\u7684\u8bf7\u6c42\uff0c\u7136\u540e openfunction \u63d2\u4ef6\u4f1a\u5c06\u54cd\u5e94\u4fe1\u606f\u8fd4\u56de\u81f3\u5ba2\u6237\u7aef\u3002</li> </ul> </li> </ul> <p></p>"},{"location":"chap12/4lambda_apisix/#_1","title":"\u603b\u7ed3","text":"<p>\u8fd1\u5e74\u6765\uff0c\u968f\u7740\u5fae\u670d\u52a1\u67b6\u6784\u7684\u51fa\u73b0\uff0c\u4e00\u5207\u90fd\u5728\u8fc1\u79fb\u5230\u4e91\u7aef\uff0c\u4e0d\u5c11\u4e91\u670d\u52a1\u63d0\u4f9b\u5546\u4e5f\u5728\u63a8\u51fa Serverless \u76f8\u5173\u7684\u4ea7\u54c1\uff0c\u57fa\u4e8e Serverless \u7684\u5f00\u53d1\u5df2\u7ecf\u6210\u4e3a\u4e00\u79cd\u5341\u5206\u4fbf\u5229\u7684\u5f00\u53d1\u6a21\u5f0f\u3002</p> <p>\u672c\u6587\u9996\u5148\u4ecb\u7ecd\u4e86 Serverless \u662f\u4ec0\u4e48\uff0c\u4ee5\u53ca\u4e3a\u4ec0\u4e48\u9700\u8981 Serverless\uff1b\u5176\u6b21\uff0c\u8bb2\u8ff0\u4e86\u4e00\u4e2a\u597d\u7684\u7f51\u5173\u5728 Serverless \u67b6\u6784\u4e0b\u7684\u91cd\u8981\u6027\uff0c\u800c APISIX \u5c31\u662f\u8fd9\u6837\u7684\u4e00\u4e2a\u7f51\u5173\uff1b\u6700\u540e\uff0c\u672c\u6587\u91cd\u70b9\u4ecb\u7ecd\u4e86 APISIX \u4e2d\u7684 Serverless \u7c7b\u578b\u7684\u63d2\u4ef6 aws-lambda\uff0c\u540c\u65f6\u5217\u4e3e\u4e86 Apache APISIX \u5176\u5b83 Serverless \u76f8\u5173\u63d2\u4ef6\u3002</p>"},{"location":"chap12/6k8s_gateway/","title":"6 Gateway Services under Kubernetes - APISIX","text":""},{"location":"chap12/6k8s_gateway/#1-a-comparison-of-several-common-gateways","title":"1. A comparison of several common gateways","text":"<ul> <li>Nginx\uff0c\u6a21\u5757\u5316\u53cd\u5411\u4ee3\u7406\u8f6f\u4ef6\uff0cC\u8bed\u8a00\u5f00\u53d1</li> <li>OpenResty\uff0c\u4e00\u4e2a\u57fa\u4e8e Nginx \u7684 web \u5f00\u53d1\u5e73\u53f0\uff0c\u89e3\u6790\u548c\u6267\u884c Lua \u811a\u672c</li> <li>Kong\uff0cOpenResty\u7684\u4e00\u4e2a\u5e94\u7528\uff0c\u662f\u4e00\u4e2a\u5177\u6709API\u7ba1\u7406\u548c\u8bf7\u6c42\u4ee3\u7406\u529f\u80fd\u7684API\u7f51\u5173\uff0c\u4f7f\u7528PostgreSQL\u5b58\u50a8</li> <li>APISIX\uff0c\u66ff\u4ee3Kong\u7684PostgreSQL for Etcd\uff0c\u57fa\u4e8eNginx\u7684\u6838\u5fc3\u5e93\u5b9e\u73b0</li> </ul> <p>APISIX\u7684\u4f18\u52bf\u5728\u4e8e\u63d0\u4f9b\u4e86API\u7ba1\u7406\u548c\u6269\u5c55\u80fd\u529b\uff0c\u5141\u8bb8\u5bf9\u7f51\u5173\u8fdb\u884c\u914d\u7f6e\u548c\u5b9a\u5236\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662f\u8f6c\u53d1\u670d\u52a1\u3002</p> <p>\u76f8\u6bd4Nginx\uff0cAPISIX\u4f7f\u7528\u52a8\u6001\u8def\u7531\uff0c\u907f\u514d\u4e86\u914d\u7f6e\u540e\u91cd\u65b0\u52a0\u8f7d\u7684\u98ce\u9669\u3002</p> <p>\u540c\u65f6\uff0cAPISIX\u652f\u6301HTTP(S)\u3001HTTP2\u3001Dubbo\u3001QUIC\u3001MQTT\u3001TCP/UDP\u7b49\u66f4\u591a\u534f\u8bae\uff0c\u63d0\u4f9b\u66f4\u597d\u7684\u4f7f\u7528\u751f\u6001</p> <p></p> <p>Above is the architecture of APISIX, where the data plane handles the client requests and the control plane manages the routes.</p>"},{"location":"chap12/6k8s_gateway/#2-what-problems-apisix-can-solve","title":"2. What problems APISIX can solve","text":"<p>Edge routing</p> <p>\u673a\u623f\u5bf9\u200b\u200b\u5916\u66b4\u9732\u7684\u8bbf\u95ee\u5165\u53e3IP\u6570\u91cf\u901a\u5e38\u5f88\u5c11\uff0c\u4f46\u652f\u6301\u7684\u670d\u52a1\u5f88\u591a\u3002\u4f8b\u5982\u8bbf\u95eeIP\u4e3a1.2.3.4\uff0c\u4f46\u540c\u65f6\u63d0\u4f9ba.domain.com\u3001b.domain.com\u7684\u8bbf\u95ee\u3002\u8fd9\u9700\u8981\u4f7f\u7528\u8fb9\u7f18\u8def\u7531\uff0c\u5b83\u5c06\u8bbf\u95ee\u4e0d\u540c\u7684\u57df\u5e76\u5c06\u5b83\u4eec\u8f6c\u53d1\u5230\u4e0d\u540c\u7684 Intranet \u5730\u5740\u3002</p> <p>APISIX\u4e2d\u6ce8\u518c\u8fb9\u7f18\u8def\u7531\u7684\u65b9\u5f0f\u67093\u79cd\uff0cdashboard\u3001ingress-controller\u3001admin api\u3002</p> <ul> <li>Basic gateway capability</li> </ul> <p>\u7f51\u5173\u7684\u4f5c\u7528\u4e0d\u4ec5\u9650\u4e8e\u8f6c\u53d1\u6d41\u91cf\uff0c\u66f4\u91cd\u8981\u7684\u662f\u9650\u5236\u6d41\u91cf\u3001\u7194\u65ad\u7b49\u3002</p> <p>APISIX\u5185\u7f6e\u4e86\u5f88\u591a\u63d2\u4ef6\uff0c\u63d0\u4f9bAPM\u3001\u65e5\u5fd7\u3001\u878d\u5408\u3001\u8ba4\u8bc1\u3001\u8bc1\u4e66\u7ba1\u7406\u3001\u6545\u969c\u6ce8\u5165\u7b49\u529f\u80fd\u3002\u8fd8\u652f\u6301\u65b0\u63d2\u4ef6\u7684\u62d6\u62fd\u7ec4\u5408\uff0c\u652f\u6301\u65b0\u63d2\u4ef6\u7684\u5f00\u53d1\uff0c\u6ee1\u8db3\u4e1a\u52a1\u9700\u6c42\u3002</p> <ul> <li>Serverless</li> </ul> <p>APISIX\u901a\u8fc7\u63d2\u4ef6\u7684\u65b9\u5f0f\u63d0\u4f9bServerless\uff0c\u76ee\u524d\u53ea\u652f\u6301Lua\uff0c\u4f46\u662fAPIGateway + Serverless\u7684\u7ec4\u5408\u975e\u5e38\u6709\u60f3\u8c61\u529b\u3002</p> <p>\u901a\u8fc7Serverless\uff0c\u53ef\u4ee5\u5feb\u901f\u5bf9\u5916\u63d0\u4f9b\u514d\u670d\u52a1\u7684API\uff0c\u7ed1\u5b9a\u5404\u79cd\u670d\u52a1\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5bf9\u5916\u63d0\u4f9b\u529f\u80fd\u670d\u52a1\u3002</p> <ul> <li>Grayscale release</li> </ul> <p>\u5f97\u76ca\u4e8e\u7f51\u5173\u5c42\u7684\u63a7\u5236\uff0cAPISIX\u5141\u8bb8\u7528\u6237\u901a\u8fc7\u914d\u7f6e\u6743\u91cd\u6765\u63a7\u5236\u6d41\u91cf\u7684\u8f6c\u53d1\u884c\u4e3a\uff0c\u53ef\u7528\u4e8e\u7070\u5ea6\u5206\u5e03\u3002</p>"},{"location":"chap12/6k8s_gateway/#3-installing-apisix-on-kubernetes","title":"3. Installing APISIX on Kubernetes","text":""},{"location":"chap12/6k8s_gateway/#31-adding-the-helm-source","title":"3.1 Adding the Helm source","text":"<ul> <li>Add the Helm source</li> </ul> <pre><code>helm repo add apisix https://charts.apiseven.com\nhelm repo update\n</code></pre> <ul> <li>Find a Chart package</li> </ul> <pre><code>helm search repo apisix\n\nNAME                                CHART VERSION   APP VERSION DESCRIPTION\napisix/apisix                       0.3.5           2.7.0       A Helm chart for Apache APISIX\napisix/apisix-dashboard             0.1.5           2.7.0       A Helm chart for Apache APISIX Dashboard\napisix/apisix-ingress-controller    0.5.0           1.0.0       Apache APISIX Ingress Controller for Kubernetes\n</code></pre>"},{"location":"chap12/6k8s_gateway/#32-installing-apisix","title":"3.2 Installing APISIX","text":"<ul> <li>Installing APISIX</li> </ul> <pre><code>helm install apisix apisix/apisix  --set gateway.type=NodePort --set admin.allow.ipList=\"{0.0.0.0/0}\"  -n apisix --create-namespace\n</code></pre> <ul> <li>View the entrance address</li> </ul> <pre><code>export NODE_PORT=$(kubectl get --namespace apisix -o jsonpath=\"{.spec.ports[0].nodePort}\" services apisix-gateway)\nexport NODE_IP=$(kubectl get nodes --namespace apisix -o jsonpath=\"{.items[0].status.addresses[0].address}\")\necho http://$NODE_IP:$NODE_PORT\n\nhttp://1.1.1.1:32462\n</code></pre> <p>\u8fd9\u91cc\u7684\u5165\u53e3\u5730\u5740\u662f\u540e\u7aef\u670d\u52a1\u7684\u5165\u53e3\u5730\u5740\u3002\u5982\u679c\u8981\u751f\u6210\u73af\u5883\uff0c\u5219\u5e94\u4f7f\u7528 LoadBalancer \u63d0\u4f9b\u7684\u5730\u5740\u3002</p> <ul> <li>View apisix-admin interface key</li> </ul> <pre><code>export POD_NAME=$(kubectl get pods --namespace apisix -l \"app.kubernetes.io/instance=apisix,app.kubernetes.io/name=apisix\" -o jsonpath=\"{.items[0].metadata.name}\")\n\nkubectl -n apisix exec -it $POD_NAME cat conf/config.yaml |grep key \n\n  admin_key:\n      key: edd1c9f034335f136f87ad84b625c8f1\n      key: 4054f7cf07e344346cd3f287985e76a2\n</code></pre> <p>\u7b2c\u4e00\u4e2a\u952e\u662f admin\uff0c\u7b2c\u4e8c\u4e2a\u952e\u662f viewer\u3002\u8be5\u5bc6\u94a5\u53ef\u7528\u4e8e\u901a\u8fc7\u7ba1\u7406 api \u914d\u7f6e APISIX\uff0c\u4e3a\u5176\u4ed6\u7cfb\u7edf\u4e0e APISIX \u96c6\u6210\u63d0\u4f9b\u5165\u53e3\u70b9\u3002</p>"},{"location":"chap12/6k8s_gateway/#33-installing-dashboard","title":"3.3 Installing Dashboard","text":"<ul> <li>Installing Dashboard</li> </ul> <pre><code>helm install apisix-dashboard apisix/apisix-dashboard -n apisix --create-namespace\n</code></pre> <p>The default account is: admin The default password is: admin</p> <ul> <li>View Dashboard Access Portal</li> </ul> <pre><code>export NODE_PORT=$(kubectl get --namespace apisix -o jsonpath=\"{.spec.ports[0].nodePort}\" services apisix-gateway)\nexport NODE_IP=$(kubectl get nodes --namespace apisix -o jsonpath=\"{.items[0].status.addresses[0].address}\")\necho http://$NODE_IP:$NODE_PORT\n\nhttp://1.1.1.1:31501\n</code></pre>"},{"location":"chap12/6k8s_gateway/#34-installing-ingress-controller","title":"3.4 Installing ingress-controller","text":"<ul> <li>Installing ingress-controller</li> </ul> <pre><code>helm install apisix-ingress-controller apisix/apisix-ingress-controller   --set config.apisix.baseURL=http://apisix-admin:9180/apisix/admin  --set config.apisix.adminKey=edd1c9f034335f136f87ad84b625c8f1  -n apisix\n</code></pre> <p>\u8fd9\u91cc\u9700\u8981\u8bbe\u7f6e\u4e0a\u9762\u83b7\u53d6\u5230\u7684admin key\uff0c\u5176\u5b9eingress-controller\u4e5f\u662f\u901a\u8fc7\u8c03\u7528admin api\u6765\u914d\u7f6e\u8def\u7531\u7684\u3002</p>"},{"location":"chap12/6k8s_gateway/#4-create-service-tests","title":"4. Create service tests","text":"<p>\u5982\u524d\u6240\u8ff0\uff0cAPISIX \u6709\u4e09\u79cd\u65b9\u6cd5\u53ef\u4ee5\u901a\u8fc7\u7ba1\u7406 api \u914d\u7f6e\u8def\u7531\u3002\u8fd9\u91cc\u6211\u4eec\u5c06\u9a8c\u8bc1Dashboard\u548cIngress\u7684\u4f7f\u7528\u3002</p> <ul> <li>Create a service</li> </ul> <pre><code>kubectl create deployment web --image=gcr.io/google-samples/hello-app:1.0\n</code></pre> <ul> <li>Exposure Services</li> </ul> <pre><code>kubectl expose deployment web --type=NodePort --port=8080\n</code></pre> <ul> <li>View Services</li> </ul> <pre><code>kubectl get service web\n\nNAME   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\nweb    NodePort   10.233.58.113   &lt;none&gt;        8080:30572/TCP   28d\n</code></pre>"},{"location":"chap12/6k8s_gateway/#41-dashboard-configuration-routing","title":"4.1 Dashboard Configuration Routing","text":"<ul> <li>Create a new upstream service</li> </ul> <p>\u8fd9\u91cc\u9700\u8981\u586b\u5199\u4e0a\u9762\u521b\u5efa\u7684\u96c6\u7fa4\u8bbf\u95ee\u5730\u5740\uff1a web.default.svc.cluster.local</p> <p></p> <ul> <li>Create a new route</li> </ul> <p></p> <p>\u70b9\u51fbNext\u540e\uff0c\u9009\u62e9\u4e0a\u9762\u521b\u5efa\u7684service web\uff0c\u76f8\u5173\u53c2\u6570\u4f1a\u81ea\u52a8\u586b\u5145\u3002</p> <p></p> <p>Access test</p> <p></p>"},{"location":"chap12/6k8s_gateway/#42-ingress-configuration-routing","title":"4.2 Ingress Configuration Routing","text":"<ul> <li>Create an ApisixRoute route</li> </ul> <p>\u8fd9\u91cc\u867d\u7136\u90e8\u7f72\u4e86ingress-controller\u7ec4\u4ef6\uff0c\u4f46\u662f\u4f7f\u7528\u7684\u65f6\u5019\u521b\u5efa\u7684\u662fApisixRoute\u5bf9\u8c61\u3002</p> <pre><code>apiVersion: apisix.apache.org/v1 \nkind: ApisixRoute \nmetadata: \n  name: web-route \nspec:\n  http:\n  - name: web\n    match:\n      hosts:\n      - dev4.fooboo.com\n      paths:\n      - \"/router-web/*\"\n    backend:\n     serviceName: web\n     servicePort: 8080\n</code></pre> <ul> <li>Access test</li> </ul> <p></p> <ul> <li>View the created routes</li> </ul> <p></p> <p>\u53ef\u4ee5\u53d1\u73b0\u8def\u7531\u662f\u7531ingress-controller\u7ba1\u7406\u7684\uff0c\u4e0d\u5e94\u8be5\u624b\u52a8\u7f16\u8f91\u3002</p> <ul> <li>View Services</li> </ul> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u670d\u52a1\u4e3b\u8981\u7531\u56db\u4e2a\u540e\u7aef\u63d0\u4f9b\u3002</p> <ul> <li>View the IP of the Service Pod</li> </ul> <pre><code>kubectl get pod  -o wide\n\nNAME                   READY   STATUS    RESTARTS   AGE   IP              NODE    NOMINATED NODE   READINESS GATES\nweb-79d88c97d6-2sdlj   1/1     Running   0          27d   10.233.105.34   node4   &lt;none&gt;           &lt;none&gt;\nweb-79d88c97d6-7bfbb   1/1     Running   0          27d   10.233.105.32   node4   &lt;none&gt;           &lt;none&gt;\nweb-79d88c97d6-hccqk   1/1     Running   0          27d   10.233.105.33   node4   &lt;none&gt;           &lt;none&gt;\nweb-79d88c97d6-mh9gz   1/1     Running   0          28d   10.233.105.22   node4   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>APISIX \u4f1a\u76f4\u63a5\u4f7f\u7528 Pod \u7684 IP \u5730\u5740\u4f5c\u4e3a\u6d41\u91cf\u540e\u7aef\uff0c\u4e0d\u7ecf\u8fc7 Service \u8f6c\u53d1\uff0c\u8fd9\u4e0e Kubernetes \u7684\u670d\u52a1\u8f6c\u53d1\u548c\u8d1f\u8f7d\u5747\u8861\u673a\u5236\u4e0d\u540c\u3002</p>"},{"location":"chap12/6k8s_gateway/#5-summary","title":"5. Summary","text":"<p>\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u7b80\u5355\u63cf\u8ff0\u4e86\u51e0\u79cd\u7f51\u5173\u7684\u533a\u522b\uff0c\u601d\u8003\u4e86APISIX\u80fd\u505a\u4ec0\u4e48\u6765\u5e2e\u52a9\u6211\u4eec\u89e3\u51b3\u95ee\u9898\uff0c\u5e76\u6700\u7ec8\u5728Kubernetes\u4e0a\u8fdb\u884c\u4e86\u5b9e\u8df5\u3002\u5185\u5bb9\u5982\u4e0b\u3002</p> <ul> <li>APISIX\u662f\u57fa\u4e8eNginx\u7f51\u7edc\u5e93\u5b9e\u73b0\u7684API\u7f51\u5173\u5e94\u7528\uff0c\u4f7f\u7528Etcd\u4f5c\u4e3a\u5b58\u50a8\u540e\u7aef</li> <li>APISIX \u53ef\u4ee5\u4f5c\u4e3a\u8fb9\u7f18\u8def\u7531\uff0c\u5176\u52a8\u6001\u7279\u6027\u907f\u514d\u4e86 Nginx \u91cd\u8f7d\u5bfc\u81f4\u7684\u6296\u52a8\u3002</li> <li>APISIX \u63d0\u4f9b\u4e86\u7ba1\u7406\u8def\u7531\u7684admin api\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e09\u79cd\u65b9\u5f0f\u914d\u7f6e</li> <li>Kubernetes \u4e0b\u7684 APISIX \u8df3\u8fc7 Kubernetes Service\uff0c\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 Pod IP</li> </ul>"},{"location":"chap12/7gateway_apisix/","title":"7 \u4e91\u539f\u751f API \u7f51\u5173 APISIX \u5165\u95e8\u6559\u7a0b","text":"<p>Apache APISIX \u662f Apache \u8f6f\u4ef6\u57fa\u91d1\u4f1a\u4e0b\u7684\u4e91\u539f\u751f API \u7f51\u5173\uff0c\u5b83\u5177\u6709\u52a8\u6001\u3001\u5b9e\u65f6\u3001\u9ad8\u6027\u80fd\u7b49\u7279\u70b9\uff0c\u63d0\u4f9b\u4e86\u8d1f\u8f7d\u5747\u8861\u3001\u52a8\u6001\u4e0a\u6e38\u3001\u7070\u5ea6\u53d1\u5e03\uff08\u91d1\u4e1d\u96c0\u53d1\u5e03\uff09\u3001\u670d\u52a1\u7194\u65ad\u3001\u9650\u901f\u3001\u9632\u5fa1\u6076\u610f\u653b\u51fb\u3001\u8eab\u4efd\u8ba4\u8bc1\u3001\u53ef\u89c2\u6d4b\u6027\u7b49\u4e30\u5bcc\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Apache APISIX \u6765\u5904\u7406\u4f20\u7edf\u7684\u5357\u5317\u5411\u6d41\u91cf\uff0c\u4e5f\u53ef\u4ee5\u5904\u7406\u670d\u52a1\u95f4\u7684\u4e1c\u897f\u5411\u6d41\u91cf\u3002\u540c\u65f6\uff0c\u5b83\u4e5f\u652f\u6301\u4f5c\u4e3a Kubernetes Ingress Controller \u6765\u4f7f\u7528\u3002</p> <p>APISIX \u57fa\u4e8e Nginx \u548c etcd\uff0c\u4e0e\u4f20\u7edf API \u7f51\u5173\u76f8\u6bd4\uff0cAPISIX \u5177\u6709\u52a8\u6001\u8def\u7531\u548c\u70ed\u52a0\u8f7d\u63d2\u4ef6\u529f\u80fd\uff0c\u907f\u514d\u4e86\u914d\u7f6e\u4e4b\u540e\u7684 reload \u64cd\u4f5c\uff0c\u540c\u65f6 APISIX \u652f\u6301 HTTP(S)\u3001HTTP2\u3001Dubbo\u3001QUIC\u3001MQTT\u3001TCP/UDP \u7b49\u66f4\u591a\u7684\u534f\u8bae\u3002</p> <p>\u800c\u4e14\u8fd8\u5185\u7f6e\u4e86 Dashboard\uff0c\u63d0\u4f9b\u5f3a\u5927\u800c\u7075\u6d3b\u7684\u754c\u9762\u3002\u540c\u6837\u4e5f\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u63d2\u4ef6\u652f\u6301\u529f\u80fd\uff0c\u800c\u4e14\u8fd8\u53ef\u4ee5\u8ba9\u7528\u6237\u81ea\u5b9a\u4e49\u63d2\u4ef6\u3002</p> <p>\u4e3b\u8981\u5177\u6709\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a</p> <ul> <li>\u591a\u5e73\u53f0\u652f\u6301\uff1aAPISIX \u63d0\u4f9b\u4e86\u591a\u5e73\u53f0\u89e3\u51b3\u65b9\u6848\uff0c\u5b83\u4e0d\u4f46\u652f\u6301\u88f8\u673a\u8fd0\u884c\uff0c\u4e5f\u652f\u6301\u5728 Kubernetes \u4e2d\u4f7f\u7528\uff0c\u8fd8\u652f\u6301\u4e0e AWS Lambda\u3001Azure Function\u3001Lua \u51fd\u6570\u548c Apache OpenWhisk \u7b49\u4e91\u670d\u52a1\u96c6\u6210\u3002</li> <li>\u5168\u52a8\u6001\u80fd\u529b\uff1aAPISIX \u652f\u6301\u70ed\u52a0\u8f7d\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u4e0d\u9700\u8981\u91cd\u542f\u670d\u52a1\u5c31\u53ef\u4ee5\u66f4\u65b0 APISIX \u7684\u914d\u7f6e\u3002\u8bf7\u8bbf\u95ee\u4e3a\u4ec0\u4e48 Apache APISIX \u9009\u62e9 Nginx + Lua \u8fd9\u4e2a\u6280\u672f\u6808\uff1f\u4ee5\u4e86\u89e3\u5b9e\u73b0\u539f\u7406\u3002</li> <li>\u7cbe\u7ec6\u5316\u8def\u7531\uff1aAPISIX \u652f\u6301\u4f7f\u7528 NGINX \u5185\u7f6e\u53d8\u91cf\u505a\u4e3a\u8def\u7531\u7684\u5339\u914d\u6761\u4ef6\uff0c\u4f60\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5339\u914d\u51fd\u6570\u6765\u8fc7\u6ee4\u8bf7\u6c42\uff0c\u5339\u914d\u8def\u7531\u3002</li> <li>\u8fd0\u7ef4\u53cb\u597d\uff1aAPISIX \u652f\u6301\u4e0e\u4ee5\u4e0b\u5de5\u5177\u548c\u5e73\u53f0\u96c6\u6210\uff1aHashiCorp Vault\u3001Zipkin\u3001Apache SkyWalking\u3001Consul\u3001Nacos\u3001Eureka\u3002\u901a\u8fc7 APISIX Dashboard\uff0c\u8fd0\u7ef4\u4eba\u5458\u53ef\u4ee5\u901a\u8fc7\u53cb\u597d\u4e14\u76f4\u89c2\u7684 UI \u914d\u7f6e APISIX\u3002</li> <li>\u591a\u8bed\u8a00\u63d2\u4ef6\u652f\u6301\uff1aAPISIX \u652f\u6301\u591a\u79cd\u5f00\u53d1\u8bed\u8a00\u8fdb\u884c\u63d2\u4ef6\u5f00\u53d1\uff0c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u9009\u62e9\u64c5\u957f\u8bed\u8a00\u7684 SDK \u5f00\u53d1\u81ea\u5b9a\u4e49\u63d2\u4ef6\u3002</li> </ul>"},{"location":"chap12/7gateway_apisix/#apisix","title":"\u5b89\u88c5 APISIX","text":"<p>\u4e3a\u4e86\u7b80\u5355\uff0c\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u5728\u672c\u5730\u4f7f\u7528 docker \u65b9\u5f0f\u6765\u542f\u52a8 APISIX\uff0c\u9996\u5148 Clone \u5b98\u65b9\u63d0\u4f9b\u7684 apisix-docker \u4ed3\u5e93\uff1a</p> <pre><code>\u279c git clone https://github.com/apache/apisix-docker.git\n\u279c cd apisix-docker\n</code></pre> <p>\u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u9762\u7684 example \u76ee\u5f55\u4e2d\u6709\u542f\u52a8 APISIX \u7684 <code>docker-compose</code> \u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>version: \"3\"\n\nservices:\n  apisix-dashboard:\n    image: apache/apisix-dashboard:3.0.0-alpine\n    restart: always\n    volumes:\n      - ./dashboard_conf/conf.yaml:/usr/local/apisix-dashboard/conf/conf.yaml\n    ports:\n      - \"9000:9000\"\n    networks:\n      apisix:\n\n  apisix:\n    image: apache/apisix:3.2.0-debian\n    restart: always\n    volumes:\n      - ./apisix_conf/config.yaml:/usr/local/apisix/conf/config.yaml:ro\n    depends_on:\n      - etcd\n    ports:\n      - \"9180:9180/tcp\"\n      - \"9080:9080/tcp\"\n      - \"9091:9091/tcp\"\n      - \"9443:9443/tcp\"\n      - \"9092:9092/tcp\"\n    networks:\n      apisix:\n\n  etcd:\n    image: rancher/coreos-etcd:v3.4.15-arm64\n    user: root\n    restart: always\n    volumes:\n      - ./etcd_data:/etcd-data\n    environment:\n      ETCD_UNSUPPORTED_ARCH: \"arm64\"\n      ETCD_ENABLE_V2: \"true\"\n      ALLOW_NONE_AUTHENTICATION: \"yes\"\n      ETCD_ADVERTISE_CLIENT_URLS: \"http://0.0.0.0:2379\"\n      ETCD_LISTEN_CLIENT_URLS: \"http://0.0.0.0:2379\"\n      ETCD_DATA_DIR: \"/etcd-data\"\n    ports:\n      - \"2379:2379/tcp\"\n    networks:\n      apisix:\n\n  web1:\n    image: nginx:1.19.10-alpine\n    restart: always\n    volumes:\n      - ./upstream/web1.conf:/etc/nginx/nginx.conf\n    ports:\n      - \"9081:80/tcp\"\n    environment:\n      - NGINX_PORT=80\n    networks:\n      apisix:\n\n  web2:\n    image: nginx:1.19.10-alpine\n    restart: always\n    volumes:\n      - ./upstream/web2.conf:/etc/nginx/nginx.conf\n    ports:\n      - \"9082:80/tcp\"\n    environment:\n      - NGINX_PORT=80\n    networks:\n      apisix:\n\nnetworks:\n  apisix:\n    driver: bridge\n</code></pre> <p>\u8be5 compose \u91cc\u9762\u4e3b\u8981\u5305\u542b\u4e86 APISIX \u7684\u4e09\u4e2a\u5bb9\u5668\uff1aapisix\u3001etcd \u4ee5\u53ca apisix-dashboard\u3002\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 docker-compose \u6765\u8fdb\u884c\u4e00\u952e\u542f\u52a8\uff1a</p> <pre><code>\u279c docker-compose -f docker-compose.yml up -d\n</code></pre> <p>\u53e6\u5916\u4e24\u4e2a nginx \u5bb9\u5668\u662f\u7528\u4e8e\u6d4b\u8bd5\u7684\uff1a</p> <p></p> <p>docker-compose</p> <p>\u8bf7\u786e\u4fdd\u5176\u4ed6\u7cfb\u7edf\u8fdb\u7a0b\u6ca1\u6709\u5360\u7528 9000\u30019080\u30019091\u30019092\u30019180\u30019443 \u548c 2379 \u7aef\u53e3\u3002\u5982\u679c\u542f\u52a8\u6709\u9519\u8bef\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u4e3a examples \u76ee\u5f55\u8bbe\u7f6e\u6210 777 \u6743\u9650\uff0c\u4fdd\u8bc1 etcd \u6570\u636e\u6709\u6743\u9650\u5199\u5165\u3002</p> <p>\u5f53 APISIX \u542f\u52a8\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 curl \u6765\u8bbf\u95ee\u6b63\u5728\u8fd0\u884c\u7684 APISIX \u5b9e\u4f8b\u3002\u6bd4\u5982\uff0c\u53ef\u4ee5\u53d1\u9001\u4e00\u4e2a\u7b80\u5355\u7684 HTTP \u8bf7\u6c42\u6765\u9a8c\u8bc1 APISIX \u8fd0\u884c\u72b6\u6001\u662f\u5426\u6b63\u5e38\u3002</p> <pre><code>\u279c curl \"http://127.0.0.1:9080\" --head\nHTTP/1.1 404 Not Found\nDate: Tue, 21 Mar 2023 07:38:45 GMT\nContent-Type: text/plain; charset=utf-8\nConnection: keep-alive\nServer: APISIX/3.2.0\n</code></pre> <p>\u73b0\u5728\uff0c\u4f60\u5df2\u7ecf\u6210\u529f\u5b89\u88c5\u5e76\u8fd0\u884c\u4e86 APISIX \uff01</p>"},{"location":"chap12/7gateway_apisix/#_1","title":"\u529f\u80fd\u6d4b\u8bd5","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u4e0b APISIX \u7684\u4e00\u4e9b\u529f\u80fd\u3002\u5728\u4e86\u89e3\u4e4b\u524d\u6211\u4eec\u9700\u8981\u5bf9 APISIX \u7684\u51e0\u4e2a\u4e3b\u8981\u6982\u5ff5\u548c\u7ec4\u4ef6\u7b80\u5355\u4e86\u89e3\u4e0b\uff1a</p>"},{"location":"chap12/7gateway_apisix/#_2","title":"\u4e0a\u6e38","text":"<p>Upstream \u4e5f\u79f0\u4e3a\u4e0a\u6e38\uff0c\u4e0a\u6e38\u662f\u5bf9\u865a\u62df\u4e3b\u673a\u7684\u62bd\u8c61\uff0c\u5373\u5e94\u7528\u5c42\u670d\u52a1\u6216\u8282\u70b9\u7684\u62bd\u8c61\u3002</p> <p>\u4e0a\u6e38\u7684\u4f5c\u7528\u662f\u6309\u7167\u914d\u7f6e\u89c4\u5219\u5bf9\u670d\u52a1\u8282\u70b9\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u5b83\u7684\u5730\u5740\u4fe1\u606f\u53ef\u4ee5\u76f4\u63a5\u914d\u7f6e\u5230\u8def\u7531\u6216\u670d\u52a1\u4e0a\u3002\u5f53\u591a\u4e2a\u8def\u7531\u6216\u670d\u52a1\u5f15\u7528\u540c\u4e00\u4e2a\u4e0a\u6e38\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e0a\u6e38\u5bf9\u8c61\uff0c\u5728\u8def\u7531\u6216\u670d\u52a1\u4e2d\u4f7f\u7528\u4e0a\u6e38\u7684 ID \u65b9\u5f0f\u5f15\u7528\u4e0a\u6e38\uff0c\u51cf\u8f7b\u7ef4\u62a4\u538b\u529b\u3002</p>"},{"location":"chap12/7gateway_apisix/#_3","title":"\u8def\u7531","text":"<p>Route \u4e5f\u79f0\u4e3a\u8def\u7531\uff0c\u662f APISIX \u4e2d\u6700\u57fa\u7840\u548c\u6700\u6838\u5fc3\u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p> <p>APISIX \u53ef\u4ee5\u901a\u8fc7\u8def\u7531\u5b9a\u4e49\u89c4\u5219\u6765\u5339\u914d\u5ba2\u6237\u7aef\u8bf7\u6c42\uff0c\u6839\u636e\u5339\u914d\u7ed3\u679c\u52a0\u8f7d\u5e76\u6267\u884c\u76f8\u5e94\u7684\u63d2\u4ef6\uff0c\u6700\u540e\u628a\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u5230\u6307\u5b9a\u7684\u4e0a\u6e38\u670d\u52a1\u3002\u8def\u7531\u4e2d\u4e3b\u8981\u5305\u542b\u4e09\u90e8\u5206\u5185\u5bb9\uff1a\u5339\u914d\u89c4\u5219\u3001\u63d2\u4ef6\u914d\u7f6e\u548c\u4e0a\u6e38\u4fe1\u606f\u3002</p>"},{"location":"chap12/7gateway_apisix/#_4","title":"\u670d\u52a1","text":"<p>Service \u4e5f\u79f0\u4e3a\u670d\u52a1\uff0c\u662f\u67d0\u7c7b API \u7684\u62bd\u8c61\uff08\u4e5f\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e00\u7ec4 Route \u7684\u62bd\u8c61\uff09\u3002</p> <p>\u5b83\u901a\u5e38\u4e0e\u4e0a\u6e38\u670d\u52a1\u62bd\u8c61\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\uff0cRoute \u4e0e Service \u4e4b\u95f4\uff0c\u901a\u5e38\u662f N:1 \u7684\u5173\u7cfb\u3002</p>"},{"location":"chap12/7gateway_apisix/#_5","title":"\u6d88\u8d39\u8005","text":"<p>Consumer \u662f\u67d0\u7c7b\u670d\u52a1\u7684\u6d88\u8d39\u8005\uff0c\u9700\u8981\u4e0e\u7528\u6237\u8ba4\u8bc1\u914d\u5408\u624d\u53ef\u4ee5\u4f7f\u7528\u3002</p> <p>\u5f53\u4e0d\u540c\u7684\u6d88\u8d39\u8005\u8bf7\u6c42\u540c\u4e00\u4e2a API \u65f6\uff0cAPISIX \u4f1a\u6839\u636e\u5f53\u524d\u8bf7\u6c42\u7684\u7528\u6237\u4fe1\u606f\uff0c\u5bf9\u5e94\u4e0d\u540c\u7684 Plugin \u6216 Upstream \u914d\u7f6e\u3002</p> <p>\u5982\u679c Route\u3001Service\u3001Consumer \u548c Plugin Config \u90fd\u7ed1\u5b9a\u4e86\u76f8\u540c\u7684\u63d2\u4ef6\uff0c\u53ea\u6709\u6d88\u8d39\u8005\u7684\u63d2\u4ef6\u914d\u7f6e\u4f1a\u751f\u6548\u3002</p> <p>\u63d2\u4ef6\u914d\u7f6e\u7684\u4f18\u5148\u7ea7\u7531\u9ad8\u5230\u4f4e\u7684\u987a\u5e8f\u662f\uff1a</p> <p><code>Consumer &gt; Route &gt; Plugin Config &gt; Service</code></p> <p>\u5bf9\u4e8e API \u7f51\u5173\u800c\u8a00\uff0c\u4e00\u822c\u60c5\u51b5\u53ef\u4ee5\u901a\u8fc7\u8bf7\u6c42\u57df\u540d\u3001\u5ba2\u6237\u7aef IP \u5730\u5740\u7b49\u5b57\u6bb5\u8bc6\u522b\u5230\u67d0\u7c7b\u8bf7\u6c42\u65b9\uff0c\u7136\u540e\u8fdb\u884c\u63d2\u4ef6\u8fc7\u6ee4\u5e76\u8f6c\u53d1\u8bf7\u6c42\u5230\u6307\u5b9a\u4e0a\u6e38\u3002\u4f46\u6709\u65f6\u5019\u8be5\u65b9\u5f0f\u8fbe\u4e0d\u5230\u7528\u6237\u9700\u6c42\uff0c\u56e0\u6b64 APISIX \u652f\u6301\u4e86 Consumer \u5bf9\u8c61\u3002</p>"},{"location":"chap12/7gateway_apisix/#_6","title":"\u63d2\u4ef6","text":"<p>Plugin \u4e5f\u79f0\u4e4b\u4e3a\u63d2\u4ef6\uff0c\u5b83\u662f\u6269\u5c55 APISIX \u5e94\u7528\u5c42\u80fd\u529b\u7684\u5173\u952e\u673a\u5236\uff0c\u4e5f\u662f\u5728\u4f7f\u7528 APISIX \u65f6\u6700\u5e38\u7528\u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p> <p>\u63d2\u4ef6\u4e3b\u8981\u662f\u5728 HTTP \u8bf7\u6c42\u6216\u54cd\u5e94\u751f\u547d\u5468\u671f\u671f\u95f4\u6267\u884c\u7684\u3001\u9488\u5bf9\u8bf7\u6c42\u7684\u4e2a\u6027\u5316\u7b56\u7565\u3002\u63d2\u4ef6\u53ef\u4ee5\u4e0e\u8def\u7531\u3001\u670d\u52a1\u6216\u6d88\u8d39\u8005\u7ed1\u5b9a\u3002</p> <p>\u5982\u679c\u8def\u7531\u3001\u670d\u52a1\u3001\u63d2\u4ef6\u914d\u7f6e\u6216\u6d88\u8d39\u8005\u90fd\u7ed1\u5b9a\u4e86\u76f8\u540c\u7684\u63d2\u4ef6\uff0c\u5219\u53ea\u6709\u4e00\u4efd\u63d2\u4ef6\u914d\u7f6e\u4f1a\u751f\u6548\uff0c\u63d2\u4ef6\u914d\u7f6e\u7684\u4f18\u5148\u7ea7\u7531\u9ad8\u5230\u4f4e\u987a\u5e8f\u662f\uff1a</p> <p>\u6d88\u8d39\u8005 &gt; \u8def\u7531 &gt; \u63d2\u4ef6\u914d\u7f6e &gt; \u670d\u52a1\u3002</p> <p>\u540c\u65f6\u5728\u63d2\u4ef6\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e5f\u4f1a\u6d89\u53ca 6 \u4e2a\u9636\u6bb5\uff0c\u5206\u522b\u662f rewrite\u3001access\u3001<code>before_proxy</code>\u3001<code>header_filter</code>\u3001<code>body_filter</code> \u548c log\u3002</p>"},{"location":"chap12/7gateway_apisix/#admin-api","title":"Admin API","text":"<p>APISIX \u63d0\u4f9b\u4e86\u5f3a\u5927\u7684 Admin API \u548c Dashboard \u4f9b\u7528\u6237\u4f7f\u7528\uff0cAdmin API \u662f\u4e00\u7ec4\u7528\u4e8e\u914d\u7f6e Apache APISIX \u8def\u7531\u3001\u4e0a\u6e38\u3001\u670d\u52a1\u3001SSL \u8bc1\u4e66\u7b49\u529f\u80fd\u7684 RESTful API\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Admin API \u6765\u83b7\u53d6\u3001\u521b\u5efa\u3001\u66f4\u65b0\u4ee5\u53ca\u5220\u9664\u8d44\u6e90\u3002\u540c\u65f6\u5f97\u76ca\u4e8e APISIX \u7684\u70ed\u52a0\u8f7d\u80fd\u529b\uff0c\u8d44\u6e90\u914d\u7f6e\u5b8c\u6210\u540e APISIX \u5c06\u4f1a\u81ea\u52a8\u66f4\u65b0\u914d\u7f6e\uff0c\u65e0\u9700\u91cd\u542f\u670d\u52a1\uff0c\u5177\u4f53\u7684\u67b6\u6784\u539f\u7406\u53ef\u4ee5\u67e5\u770b\u4e0b\u9762\u7684\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>\u4e3b\u8981\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206\uff1a</p> <ul> <li>APISIX \u6838\u5fc3\uff1a\u5305\u62ec Lua \u63d2\u4ef6\u3001\u591a\u8bed\u8a00\u63d2\u4ef6\u8fd0\u884c\u65f6\uff08Plugin Runner\uff09\u3001Wasm \u63d2\u4ef6\u8fd0\u884c\u65f6\u7b49\uff1b</li> <li>\u529f\u80fd\u4e30\u5bcc\u7684\u5404\u79cd\u5185\u7f6e\u63d2\u4ef6\uff1a\u5305\u62ec\u53ef\u89c2\u6d4b\u6027\u3001\u5b89\u5168\u3001\u6d41\u91cf\u63a7\u5236\u7b49\u3002</li> </ul> <p>APISIX \u5728\u5176\u6838\u5fc3\u4e2d\uff0c\u63d0\u4f9b\u4e86\u8def\u7531\u5339\u914d\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u53d1\u73b0\u3001API \u7ba1\u7406\u7b49\u91cd\u8981\u529f\u80fd\uff0c\u4ee5\u53ca\u914d\u7f6e\u7ba1\u7406\u7b49\u57fa\u7840\u6027\u6a21\u5757\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0cAPISIX \u63d2\u4ef6\u8fd0\u884c\u65f6\u4e5f\u5305\u542b\u5176\u4e2d\uff0c\u63d0\u4f9b\u539f\u751f Lua \u63d2\u4ef6\u7684\u8fd0\u884c\u6846\u67b6\u548c\u591a\u8bed\u8a00\u63d2\u4ef6\u7684\u8fd0\u884c\u6846\u67b6\uff0c\u4ee5\u53ca\u5b9e\u9a8c\u6027\u7684 Wasm \u63d2\u4ef6\u8fd0\u884c\u65f6\u7b49\u3002APISIX \u591a\u8bed\u8a00\u63d2\u4ef6\u8fd0\u884c\u65f6\u63d0\u4f9b\u591a\u79cd\u5f00\u53d1\u8bed\u8a00\u7684\u652f\u6301\uff0c\u6bd4\u5982 Golang\u3001Java\u3001Python\u3001JS \u7b49\u3002</p> <p>APISIX \u76ee\u524d\u4e5f\u5185\u7f6e\u4e86\u5404\u7c7b\u63d2\u4ef6\uff0c\u8986\u76d6\u4e86 API \u7f51\u5173\u7684\u5404\u79cd\u9886\u57df\uff0c\u5982\u8ba4\u8bc1\u9274\u6743\u3001\u5b89\u5168\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u6d41\u91cf\u7ba1\u7406\u3001\u591a\u534f\u8bae\u63a5\u5165\u7b49\u3002\u5f53\u524d APISIX \u5185\u7f6e\u7684\u63d2\u4ef6\u4f7f\u7528\u539f\u751f Lua \u5b9e\u73b0\uff0c\u5173\u4e8e\u5404\u4e2a\u63d2\u4ef6\u7684\u4ecb\u7ecd\u4e0e\u4f7f\u7528\u65b9\u5f0f\uff0c\u540e\u7eed\u6211\u4eec\u518d\u4ecb\u7ecd\u3002</p>"},{"location":"chap12/7gateway_apisix/#_7","title":"\u521b\u5efa\u8def\u7531","text":"<p>\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\u6211\u4eec\u5148\u4f7f\u7528 Admin API \u6765\u521b\u5efa\u4e00\u4e2a Route \u5e76\u4e0e Upstream \u7ed1\u5b9a\uff0c\u5f53\u4e00\u4e2a\u8bf7\u6c42\u5230\u8fbe APISIX \u65f6\uff0cAPISIX \u4f1a\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u6307\u5b9a\u7684\u4e0a\u6e38\u670d\u52a1\u4e2d\u3002</p> <p>\u4ee5\u4e0b\u793a\u4f8b\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u5c06\u4e3a\u8def\u7531\u914d\u7f6e\u5339\u914d\u89c4\u5219\uff0c\u4ee5\u4fbf APISIX \u53ef\u4ee5\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u5bf9\u5e94\u7684\u4e0a\u6e38\u670d\u52a1\uff1a</p> <pre><code>\u279c curl \"http://127.0.0.1:9180/apisix/admin/routes/1\" -X PUT -d '\n{\n  \"methods\": [\"GET\"],\n  \"host\": \"foobar.com\",\n  \"uri\": \"/anything/*\",\n  \"upstream\": {\n    \"type\": \"roundrobin\",\n    \"nodes\": {\n      \"httpbin.org:80\": 1\n    }\n  }\n}' -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'\n# \u6b63\u5e38\u4f1a\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\n{\"value\":{\"create_time\":1679392758,\"methods\":[\"GET\"],\"host\":\"foobar.com\",\"status\":1,\"priority\":0,\"update_time\":1679392758,\"upstream\":{\"pass_host\":\"pass\",\"hash_on\":\"vars\",\"type\":\"roundrobin\",\"nodes\":{\"httpbin.org:80\":1},\"scheme\":\"http\"},\"id\":\"1\",\"uri\":\"/anything/*\"},\"key\":\"/apisix/routes/1\"}\n</code></pre> <p>\u5176\u4e2d\u7684 X-API-KEY \u7684\u503c\u5728 APISIX \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d <code>apisix_config.yaml</code> \u4e2d\u6709\u914d\u7f6e\uff0c\u4f4d\u4e8e <code>deployment.admin.admin_key</code> \u4e0b\u9762\u3002</p> <p>\u8be5\u914d\u7f6e\u610f\u5473\u7740\uff0c\u5f53\u8bf7\u6c42\u6ee1\u8db3\u4e0b\u8ff0\u7684\u6240\u6709\u89c4\u5219\u65f6\uff0c\u8bf7\u6c42\u5c06\u88ab\u8f6c\u53d1\u5230\u4e0a\u6e38\u670d\u52a1\uff08httpbin.org:80\uff09\uff1a</p> <ul> <li>\u8bf7\u6c42\u7684 HTTP \u65b9\u6cd5\u4e3a GET\u3002</li> <li>\u8bf7\u6c42\u5934\u5305\u542b host \u5b57\u6bb5\uff0c\u4e14\u5b83\u7684\u503c\u4e3a <code>foobar.com</code>\u3002</li> <li>\u8bf7\u6c42\u8def\u5f84\u5339\u914d <code>/anything/*</code>\uff0c<code>*</code> \u610f\u5473\u7740\u4efb\u610f\u7684\u5b50\u8def\u5f84\uff0c\u4f8b\u5982 <code>/anything/foo?arg=10</code>\u3002</li> </ul> <p>\u5f53\u8def\u7531\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u8bbf\u95ee\u4e0a\u6e38\u670d\u52a1\u4e86\uff1a</p> <pre><code>\u279c curl -i -X GET \"http://127.0.0.1:9080/anything/foo?arg=10\" -H \"Host: foobar.com\"\nHTTP/1.1 200 OK\nContent-Type: application/json\nContent-Length: 443\nConnection: keep-alive\nDate: Tue, 21 Mar 2023 08:25:49 GMT\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Credentials: true\nServer: APISIX/3.2.0\n\n{\n  \"args\": {\n    \"arg\": \"10\"\n  },\n  \"data\": \"\",\n  \"files\": {},\n  \"form\": {},\n  \"headers\": {\n    \"Accept\": \"*/*\",\n    \"Host\": \"foobar.com\",\n    \"User-Agent\": \"curl/7.85.0\",\n    \"X-Amzn-Trace-Id\": \"Root=1-64196a0d-1d2b654b29cbed3f7a9302c7\",\n    \"X-Forwarded-Host\": \"foobar.com\"\n  },\n  \"json\": null,\n  \"method\": \"GET\",\n  \"origin\": \"172.22.0.1, 221.11.206.200\",\n  \"url\": \"http://foobar.com/anything/foo?arg=10\"\n}\n</code></pre> <p>\u8be5\u8bf7\u6c42\u5c06\u88ab APISIX \u8f6c\u53d1\u5230 <code>http://httpbin.org:80/anything/foo?arg=10</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u548c\u76f4\u63a5\u8bbf\u95ee\u4e0a\u6e38\u6570\u636e\u8fdb\u884c\u5bf9\u6bd4\u3002</p> <p></p> <p>httpbin\u6570\u636e</p>"},{"location":"chap12/7gateway_apisix/#_8","title":"\u4f7f\u7528\u4e0a\u6e38\u670d\u52a1\u521b\u5efa\u8def\u7531","text":"<p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u4e0a\u6e38\uff0c\u5e76\u5728\u8def\u7531\u4e2d\u4f7f\u7528\u5b83\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u5c06\u5176\u914d\u7f6e\u5728\u8def\u7531\u4e2d\uff1a</p> <pre><code>\u279c curl \"http://127.0.0.1:9180/apisix/admin/upstreams/1\" -X PUT -d '\n{\n  \"type\": \"roundrobin\",\n  \"nodes\": {\n    \"httpbin.org:80\": 1\n  }\n}' -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'\n# \u6b63\u5e38\u4f1a\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u8f93\u51fa\n{\"value\":{\"type\":\"roundrobin\",\"create_time\":1679392818,\"pass_host\":\"pass\",\"hash_on\":\"vars\",\"update_time\":1679392818,\"nodes\":{\"httpbin.org:80\":1},\"id\":\"1\",\"scheme\":\"http\"},\"key\":\"/apisix/upstreams/1\"}\n</code></pre> <p>\u8be5\u4e0a\u6e38\u914d\u7f6e\u4e0e\u4e0a\u4e00\u8282\u914d\u7f6e\u5728\u8def\u7531\u4e2d\u7684\u4e0a\u6e38\u76f8\u540c\u3002\u540c\u6837\u4f7f\u7528\u4e86 <code>roundrobin</code> \u4f5c\u4e3a\u8d1f\u8f7d\u5747\u8861\u673a\u5236\uff0c\u5e76\u8bbe\u7f6e\u4e86 <code>httpbin.org:80</code> \u4e3a\u4e0a\u6e38\u670d\u52a1\u3002\u4e3a\u4e86\u5c06\u8be5\u4e0a\u6e38\u7ed1\u5b9a\u5230\u8def\u7531\uff0c\u6b64\u5904\u9700\u8981\u628a <code>upstream_id</code> \u8bbe\u7f6e\u4e3a \"1\"\u3002</p> <p>\u4e0a\u6e38\u670d\u52a1\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u5c06\u5176\u7ed1\u5b9a\u5230\u6307\u5b9a\u7684 <code>/get</code> \u8def\u7531\uff1a</p> <pre><code>\u279c curl \"http://127.0.0.1:9180/apisix/admin/routes/1\" -X PUT -d '\n{\n  \"uri\": \"/get\",\n  \"host\": \"httpbin.org\",\n  \"upstream_id\": \"1\"\n}' -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'\n# \u6b63\u5e38\u4f1a\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u8f93\u51fa\n{\"value\":{\"upstream_id\":\"1\",\"status\":1,\"create_time\":1679392758,\"host\":\"httpbin.org\",\"update_time\":1679392834,\"priority\":0,\"id\":\"1\",\"uri\":\"/get\"},\"key\":\"/apisix/routes/1\"}\n</code></pre> <p>\u6211\u4eec\u5df2\u7ecf\u521b\u5efa\u4e86\u8def\u7531\u4e0e\u4e0a\u6e38\u670d\u52a1\uff0c\u73b0\u5728\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u8bbf\u95ee\u4e0a\u6e38\u670d\u52a1\uff1a</p> <pre><code>\u279c curl -i -X GET \"http://127.0.0.1:9080/get?foo1=bar1&amp;foo2=bar2\" -H \"Host: httpbin.org\"\nHTTP/1.1 200 OK\nContent-Type: application/json\nContent-Length: 370\nConnection: keep-alive\nDate: Tue, 21 Mar 2023 08:40:19 GMT\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Credentials: true\nServer: APISIX/3.2.0\n\n{\n  \"args\": {\n    \"foo1\": \"bar1\",\n    \"foo2\": \"bar2\"\n  },\n  \"headers\": {\n    \"Accept\": \"*/*\",\n    \"Host\": \"httpbin.org\",\n    \"User-Agent\": \"curl/7.85.0\",\n    \"X-Amzn-Trace-Id\": \"Root=1-64196d73-165daa124c362e5d4c6bb79d\",\n    \"X-Forwarded-Host\": \"httpbin.org\"\n  },\n  \"origin\": \"172.22.0.1, 221.11.206.200\",\n  \"url\": \"http://httpbin.org/get?foo1=bar1&amp;foo2=bar2\"\n}\n</code></pre> <p>\u540c\u6837\u8be5\u8bf7\u6c42\u4e5f\u4f1a\u88ab APISIX \u8f6c\u53d1\u5230 <code>http://httpbin.org:80/anything/foo?arg=10</code>\u3002</p>"},{"location":"chap12/7gateway_apisix/#dashboard","title":"\u4f7f\u7528 Dashboard","text":"<p>\u540c\u6837\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 APISIX Dashboard \u521b\u5efa\u548c\u914d\u7f6e\u7c7b\u4f3c\u4e8e\u4e0a\u8ff0\u6b65\u9aa4\u4e2d\u6240\u521b\u5efa\u7684\u8def\u7531\u3002</p> <p>\u5982\u679c\u4f60\u5df2\u7ecf\u5b8c\u6210\u4e0a\u8ff0\u64cd\u4f5c\u6b65\u9aa4\uff0c\u6b63\u5e38\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u901a\u8fc7 <code>localhost:9000</code> \u6765\u8bbf\u95ee APISIX Dashboard \u4e86\u3002</p> <p></p> <p>\u9ed8\u8ba4\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u5747\u4e3a admin\uff0c\u5728 examples \u76ee\u5f55\u4e2d <code>dashboard_conf</code>\u4e0b\u9762\u7684 <code>conf.yaml</code>\u8fdb\u884c\u914d\u7f6e\uff1a</p> <pre><code>authentication:\n  secret: secret\n  expire_time: 3600\n  users:\n    - username: admin\n      password: admin\n    - username: user\n      password: user\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u7684 docker-compose \u4e2d\u4e5f\u5df2\u7ecf\u542f\u52a8\u4e86 Grafana\uff0c\u6240\u4ee5\u767b\u5f55\u540e\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728\u9996\u9875\u4eea\u8868\u76d8\u4e0a\u914d\u7f6e Grafana\uff0c\u5730\u5740\u4e3a <code>http://localhost:3000</code>\u3002</p> <p></p> <p>\u767b\u5f55\u540e\u5355\u51fb\u4fa7\u8fb9\u680f\u4e2d\u7684\u8def\u7531\uff0c\u53ef\u4ee5\u67e5\u770b\u5df2\u7ecf\u914d\u7f6e\u7684\u8def\u7531\u5217\u8868\uff0c\u53ef\u4ee5\u770b\u5230\u5728\u4e0a\u8ff0\u6b65\u9aa4\u4e2d\u4f7f\u7528 Admin API \u521b\u5efa\u7684\u8def\u7531\u3002</p> <p></p> <p>\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5355\u51fb\u521b\u5efa\u6309\u94ae\u5e76\u6309\u7167\u63d0\u793a\u521b\u5efa\u65b0\u8def\u7531\uff1a</p> <p></p> <p></p> <p>\u5982\u679c\u60f3\u5229\u7528 APISIX \u5b9e\u73b0\u8eab\u4efd\u9a8c\u8bc1\u3001\u5b89\u5168\u6027\u3001\u9650\u6d41\u9650\u901f\u548c\u53ef\u89c2\u6d4b\u6027\u7b49\u529f\u80fd\uff0c\u53ef\u901a\u8fc7\u6dfb\u52a0\u63d2\u4ef6\u5b9e\u73b0\u3002</p>"},{"location":"chap12/7gateway_apisix/#_9","title":"\u9650\u6d41\u9650\u901f\u548c\u5b89\u5168\u63d2\u4ef6","text":"<p>\u5728\u5f88\u591a\u65f6\u5019\uff0c\u6211\u4eec\u7684 API \u5e76\u4e0d\u662f\u5904\u4e8e\u4e00\u4e2a\u975e\u5e38\u5b89\u5168\u7684\u72b6\u6001\uff0c\u5b83\u968f\u65f6\u4f1a\u6536\u5230\u4e0d\u6b63\u5e38\u7684\u8bbf\u95ee\uff0c\u4e00\u65e6\u8bbf\u95ee\u6d41\u91cf\u7a81\u589e\uff0c\u53ef\u80fd\u5c31\u4f1a\u5bfc\u81f4\u4f60\u7684 API \u53d1\u751f\u6545\u969c\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u901f\u7387\u9650\u5236\u6765\u4fdd\u62a4 API \u670d\u52a1\uff0c\u9650\u5236\u975e\u6b63\u5e38\u7684\u8bbf\u95ee\u8bf7\u6c42\u3002</p> <p>\u5bf9\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u8fdb\u884c\uff1a</p> <ul> <li>\u9650\u5236\u8bf7\u6c42\u901f\u7387\uff1b</li> <li>\u9650\u5236\u5355\u4f4d\u65f6\u95f4\u5185\u7684\u8bf7\u6c42\u6570\uff1b</li> <li>\u5ef6\u8fdf\u8bf7\u6c42\uff1b</li> <li>\u62d2\u7edd\u5ba2\u6237\u7aef\u8bf7\u6c42\uff1b</li> <li>\u9650\u5236\u54cd\u5e94\u6570\u636e\u7684\u901f\u7387\u3002</li> </ul> <p>APISIX \u63d0\u4f9b\u4e86\u591a\u4e2a\u5185\u7f6e\u7684\u9650\u6d41\u9650\u901f\u7684\u63d2\u4ef6\uff0c\u5305\u62ec <code>limit-conn</code>\u3001<code>limit-count</code> \u548c <code>limit-req</code>\u3002</p> <ul> <li>limit-conn \u63d2\u4ef6\u4e3b\u8981\u7528\u4e8e\u9650\u5236\u5ba2\u6237\u7aef\u5bf9\u670d\u52a1\u7684\u5e76\u53d1\u8bf7\u6c42\u6570\u3002</li> <li>limit-req \u63d2\u4ef6\u4f7f\u7528\u6f0f\u6876\u7b97\u6cd5\u9650\u5236\u5bf9\u7528\u6237\u670d\u52a1\u7684\u8bf7\u6c42\u901f\u7387\u3002</li> <li>limit-count \u63d2\u4ef6\u4e3b\u8981\u7528\u4e8e\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u8303\u56f4\u5185\uff0c\u9650\u5236\u6bcf\u4e2a\u5ba2\u6237\u7aef\u603b\u8bf7\u6c42\u4e2a\u6570\u3002</li> </ul> <p>\u8fd9\u91cc\u6211\u4eec\u5c31\u4ee5 <code>limit-count</code> \u63d2\u4ef6\u4e3a\u4f8b\uff0c\u6765\u8bf4\u660e\u5982\u4f55\u901a\u8fc7\u9650\u6d41\u9650\u901f\u63d2\u4ef6\u4fdd\u62a4\u6211\u4eec\u7684 API \u670d\u52a1\u3002\u5982\u4e0b\u6240\u793a\u3002</p> <p>\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u9996\u5148\u521b\u5efa\u4e00\u6761\u8def\u7531\uff1a</p> <pre><code>\u279c curl -i http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d '\n{\n    \"uri\": \"/index.html\",\n    \"plugins\": {\n        \"limit-count\": {\n            \"count\": 2,\n            \"time_window\": 60,\n            \"rejected_code\": 503,\n            \"key_type\": \"var\",\n            \"key\": \"remote_addr\"\n        }\n    },\n  \"upstream_id\": \"1\"\n}' -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u4f7f\u7528\u524d\u9762\u5df2\u7ecf\u521b\u5efa\u7684\u4e0a\u6e38\uff08ID \u4e3a 1\uff09\u6765\u521b\u5efa/\u66f4\u65b0\u4e00\u6761\u8def\u7531\uff0c\u5e76\u4e14\u5728 plugins \u4e2d\u542f\u7528\u4e86 <code>limit-count</code> \u63d2\u4ef6\uff0c\u8be5\u63d2\u4ef6\u4ec5\u5141\u8bb8\u5ba2\u6237\u7aef\u5728 60 \u79d2\u5185\uff0c\u8bbf\u95ee\u4e0a\u6e38\u670d\u52a1 2 \u6b21\uff0c\u8d85\u8fc7\u4e24\u6b21\uff0c\u5c31\u4f1a\u8fd4\u56de 503 \u9519\u8bef\u7801\u3002</p> <p>\u4e0a\u9762\u7684\u6307\u4ee4\u6267\u884c\u6210\u529f\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u8fde\u7eed\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8bbf\u95ee\u4e09\u6b21\u540e\uff0c\u5219\u4f1a\u51fa\u73b0\u5982\u4e0b\u9519\u8bef\u3002</p> <pre><code>\u279c curl http://127.0.0.1:9080/index.html\n\u279c curl http://127.0.0.1:9080/index.html\n\u279c curl http://127.0.0.1:9080/index.html\n</code></pre> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\u5c31\u4f1a\u51fa\u73b0\u5982\u4e0b\u6240\u793a\u7684 503 \u9519\u8bef\uff0c\u5219\u8868\u793a limit-count \u63d2\u4ef6\u5df2\u7ecf\u914d\u7f6e\u6210\u529f\u3002</p> <pre><code>&lt;html&gt;\n  &lt;head&gt;\n    &lt;title&gt;503 Service Temporarily Unavailable&lt;/title&gt;\n  &lt;/head&gt;\n  &lt;body&gt;\n    &lt;center&gt;&lt;h1&gt;503 Service Temporarily Unavailable&lt;/h1&gt;&lt;/center&gt;\n    &lt;hr /&gt;\n    &lt;center&gt;openresty&lt;/center&gt;\n    &lt;p&gt;\n      &lt;em&gt;Powered by &lt;a href=\"https://apisix.apache.org/\"&gt;APISIX&lt;/a&gt;.&lt;/em&gt;\n    &lt;/p&gt;\n  &lt;/body&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"chap12/7gateway_apisix/#_10","title":"\u7f13\u5b58\u54cd\u5e94","text":"<p>\u5f53\u6211\u4eec\u5728\u6784\u5efa\u4e00\u4e2a API \u65f6\uff0c\u80af\u5b9a\u5e0c\u671b\u4ed6\u80fd\u591f\u5c3d\u91cf\u4fdd\u6301\u7b80\u5355\u548c\u5feb\u901f\uff0c\u4e00\u65e6\u8bfb\u53d6\u76f8\u540c\u6570\u636e\u7684\u5e76\u53d1\u9700\u6c42\u589e\u52a0\uff0c\u53ef\u80fd\u4f1a\u9762\u4e34\u4e00\u4e9b\u95ee\u9898\uff0c\u4e00\u822c\u6211\u4eec\u76f4\u63a5\u7684\u529e\u6cd5\u5c31\u662f\u5f15\u5165\u7f13\u5b58\uff0c\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u5728\u4e0d\u540c\u5c42\u9762\u53bb\u8fdb\u884c\u7f13\u5b58\u7684\u3002</p> <ul> <li>\u8fb9\u7f18\u7f13\u5b58\u6216 CDN</li> <li>\u6570\u636e\u5e93\u7f13\u5b58</li> <li>\u670d\u52a1\u5668\u7f13\u5b58\uff08API \u7f13\u5b58\uff09</li> <li>\u6d4f\u89c8\u5668\u7f13\u5b58</li> </ul> <p>\u53cd\u5411\u4ee3\u7406\u7f13\u5b58\u662f\u53e6\u4e00\u79cd\u7f13\u5b58\u673a\u5236\uff0c\u901a\u5e38\u5728 API \u7f51\u5173\u5185\u5b9e\u73b0\u3002\u5b83\u53ef\u4ee5\u51cf\u5c11\u5bf9\u4f60\u7684\u7aef\u70b9\u7684\u8c03\u7528\u6b21\u6570\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u7f13\u5b58\u4e0a\u6e38\u7684\u54cd\u5e94\u6765\u6539\u5584\u5bf9\u4f60\u7684 API \u8bf7\u6c42\u7684\u5ef6\u8fdf\u3002</p> <p>\u5982\u679c API Gateway \u7684\u7f13\u5b58\u4e2d\u6709\u6240\u8bf7\u6c42\u8d44\u6e90\u7684\u65b0\u9c9c\u526f\u672c\uff0c\u5b83\u5c31\u4f1a\u4f7f\u7528\u8be5\u526f\u672c\u76f4\u63a5\u6ee1\u8db3\u8bf7\u6c42\uff0c\u800c\u4e0d\u662f\u5411\u7aef\u70b9\u53d1\u51fa\u8bf7\u6c42\u3002\u5982\u679c\u6ca1\u6709\u627e\u5230\u7f13\u5b58\u7684\u6570\u636e\uff0c\u8bf7\u6c42\u5c31\u4f1a\u8f6c\u5230\u9884\u5b9a\u7684\u4e0a\u6e38\u670d\u52a1\uff08\u540e\u7aef\u670d\u52a1\uff09\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u4e3b\u8981\u4e86\u89e3\u7684\u662f API \u7f51\u5173\u5c42\u7684\u7f13\u5b58\uff0c\u4e5f\u5c31\u662f APISIX \u63d0\u4f9b\u7684 API \u7f13\u5b58\uff0c\u5b83\u4e5f\u53ef\u4ee5\u548c\u5176\u4ed6\u63d2\u4ef6\u4e00\u8d77\u4f7f\u7528\uff0c\u76ee\u524d\u652f\u6301\u57fa\u4e8e\u78c1\u76d8\u7684\u7f13\u5b58\uff0c\u4e5f\u53ef\u4ee5\u5728\u63d2\u4ef6\u914d\u7f6e\u4e2d\u6307\u5b9a\u7f13\u5b58\u8fc7\u671f\u65f6\u95f4\u6216\u5185\u5b58\u5bb9\u91cf\u7b49\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u6709\u4e00\u4e2a <code>/products</code> \u7684 API \u63a5\u53e3\uff0c\u901a\u5e38\u6bcf\u5929\u53ea\u66f4\u65b0\u4e00\u6b21\uff0c\u800c\u8be5\u7aef\u70b9\u6bcf\u5929\u90fd\u4f1a\u6536\u5230\u91cd\u590d\u7684\u6570\u5341\u4ebf\u6b21\u8bf7\u6c42\uff0c\u4ee5\u83b7\u53d6\u4ea7\u54c1\u5217\u8868\u6570\u636e\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 APISIX \u63d0\u4f9b\u7684\u4e00\u4e2a\u540d\u4e3a <code>proxy-cache</code> \u7684\u63d2\u4ef6\u6765\u7f13\u5b58\u8be5\u63a5\u53e3\u7684\u54cd\u5e94\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u8fd8\u662f\u4f7f\u7528\u524d\u9762 ID \u4e3a 1 \u7684\u4e0a\u6e38\u5bf9\u8c61\uff0c\u4f7f\u7528 <code>/anything/products</code> \u6765\u6a21\u62df\u4ea7\u54c1\u63a5\u53e3\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u66f4\u65b0\u8def\u7531\u7684\u63d2\u4ef6\uff1a</p> <pre><code>\u279c curl \"http://127.0.0.1:9180/apisix/admin/routes/1\" -H \"X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\" -X PUT -d '{\n  \"name\": \"Route for API Caching\",\n  \"methods\": [\n    \"GET\"\n  ],\n  \"uri\": \"/anything/*\",\n  \"plugins\": {\n    \"proxy-cache\": {\n      \"cache_key\": [\n        \"$uri\",\n        \"-cache-id\"\n      ],\n      \"cache_bypass\": [\n        \"$arg_bypass\"\n      ],\n      \"cache_method\": [\n        \"GET\"\n      ],\n      \"cache_http_status\": [\n        200\n      ],\n      \"hide_cache_headers\": true,\n      \"no_cache\": [\n        \"$arg_test\"\n      ]\n    }\n  },\n  \"upstream_id\": \"1\"\n}'\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\u73b0\u5728\u6211\u4eec\u6765\u5bf9\u8be5\u63a5\u53e3\u53d1\u8d77\u51e0\u6b21\u8bf7\u6c42\uff1a</p> <pre><code>\u279c curl http://localhost:9080/anything/products -i\n\nHTTP/1.1 200 OK\nContent-Type: application/json\nContent-Length: 398\nConnection: keep-alive\nDate: Tue, 21 Mar 2023 10:48:42 GMT\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Credentials: true\nServer: APISIX/3.2.0\nApisix-Cache-Status: MISS\n\n\u279c curl http://localhost:9080/anything/products -i\n\nHTTP/1.1 200 OK\nContent-Type: application/json\nContent-Length: 398\nConnection: keep-alive\nDate: Tue, 21 Mar 2023 10:48:42 GMT\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Credentials: true\nServer: APISIX/3.2.0\nApisix-Cache-Status: HIT\n</code></pre> <p>\u6b63\u5e38\u6bcf\u6b21\u90fd\u5e94\u8be5\u6536\u5230 HTTP 200 OK \u54cd\u5e94\uff0c\u4f46\u662f\u7b2c\u4e00\u6b21\u54cd\u5e94\u4e2d\u7684 <code>Apisix-Cache-Status</code> \u663e\u793a\u4e3a MISS\uff0c\u8fd9\u610f\u5473\u7740\u5f53\u8bf7\u6c42\u7b2c\u4e00\u6b21\u8fdb\u5165\u8def\u7531\u65f6\uff0c\u54cd\u5e94\u8fd8\u6ca1\u6709\u88ab\u7f13\u5b58\u3002\u800c</p> <p>\u540e\u9762\u7684\u51e0\u6b21\u8bf7\u6c42\u4f1a\u5f97\u5230\u4e00\u4e2a\u7f13\u5b58\u7684\u54cd\u5e94\uff0c\u7f13\u5b58\u6307\u6807\u53d8\u4e3a\u4e86 HIT\uff0c\u8868\u793a\u6211\u4eec\u7684\u54cd\u5e94\u7f13\u5b58\u6210\u529f\u4e86\u3002</p>"},{"location":"chap12/8apixsix_plugin/","title":"8 APISIX\u8ba4\u8bc1\u4e0e\u81ea\u5b9a\u4e49\u63d2\u4ef6","text":"<p>\u8eab\u4efd\u8ba4\u8bc1\u5728\u65e5\u5e38\u751f\u6d3b\u5f53\u4e2d\u662f\u975e\u5e38\u5e38\u89c1\u7684\u4e00\u9879\u529f\u80fd\uff0c\u5927\u5bb6\u5e73\u65f6\u57fa\u672c\u90fd\u4f1a\u63a5\u89e6\u5230\u3002\u6bd4\u5982\u7528\u652f\u4ed8\u5b9d\u6d88\u8d39\u65f6\u7684\u4eba\u8138\u8bc6\u522b\u786e\u8ba4\u3001\u516c\u53f8\u4e0a\u73ed\u4e0b\u73ed\u65f6\u7684\u6307\u7eb9/\u9762\u90e8\u6253\u5361\u4ee5\u53ca\u7f51\u7ad9\u4e0a\u8fdb\u884c\u8d26\u53f7\u5bc6\u7801\u767b\u5f55\u64cd\u4f5c\u7b49\uff0c\u5176\u5b9e\u90fd\u662f\u8eab\u4efd\u8ba4\u8bc1\u7684\u573a\u666f\u4f53\u73b0\u3002</p> <p></p> <p>\u5982\u4e0a\u56fe\uff0cJack \u901a\u8fc7\u8d26\u53f7\u5bc6\u7801\u8bf7\u6c42\u670d\u52a1\u7aef\u5e94\u7528\uff0c\u670d\u52a1\u7aef\u5e94\u7528\u4e2d\u9700\u8981\u6709\u4e00\u4e2a\u4e13\u95e8\u7528\u505a\u8eab\u4efd\u8ba4\u8bc1\u7684\u6a21\u5757\u6765\u5904\u7406\u8fd9\u90e8\u5206\u7684\u903b\u8f91\u3002</p> <p>\u8bf7\u6c42\u5904\u7406\u5b8c\u6bd5\u5b50\u540e\uff0c\u5982\u679c\u4f7f\u7528 JWT Token \u8ba4\u8bc1\u65b9\u5f0f\uff0c\u670d\u52a1\u5668\u4f1a\u53cd\u9988\u4e00\u4e2a Token \u53bb\u6807\u8bc6\u8fd9\u4e2a\u7528\u6237\u4e3a Jack\u3002\u5982\u679c\u767b\u5f55\u8fc7\u7a0b\u4e2d\u8d26\u53f7\u5bc6\u7801\u8f93\u5165\u9519\u8bef\uff0c\u5c31\u4f1a\u5bfc\u81f4\u8eab\u4efd\u8ba4\u8bc1\u5931\u8d25\u3002</p> <p>\u4f46\u662f\u6bcf\u4e2a\u5e94\u7528\u670d\u52a1\u6a21\u5757\u53bb\u5f00\u53d1\u4e00\u4e2a\u5355\u72ec\u7684\u8eab\u4efd\u8ba4\u8bc1\u6a21\u5757\uff0c\u7528\u6765\u652f\u6301\u8eab\u4efd\u8ba4\u8bc1\u7684\u4e00\u5957\u6d41\u7a0b\u5904\u7406\uff0c\u5f53\u670d\u52a1\u91cf\u591a\u4e86\u4e4b\u540e\uff0c\u5c31\u4f1a\u53d1\u73b0\u8fd9\u4e9b\u6a21\u5757\u7684\u5f00\u53d1\u5de5\u4f5c\u91cf\u90fd\u662f\u975e\u5e38\u5de8\u5927\u4e14\u91cd\u590d\u7684\u3002\u8fd9\u4e2a\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u628a\u8fd9\u90e8\u5206\u7684\u5f00\u53d1\u903b\u8f91\u653e\u7f6e\u5230 Apache APISIX \u7684\u7f51\u5173\u5c42\u6765\u5b9e\u73b0\u7edf\u4e00\uff0c\u51cf\u5c11\u5f00\u53d1\u91cf\u3002</p> <p></p> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u7528\u6237\u6216\u5e94\u7528\u65b9\u76f4\u63a5\u53bb\u8bf7\u6c42 Apache APISIX\uff0c\u7136\u540e Apache APISIX \u901a\u8fc7\u8bc6\u522b\u5e76\u8ba4\u8bc1\u901a\u8fc7\u540e\uff0c\u4f1a\u5c06\u9274\u522b\u7684\u8eab\u4efd\u4fe1\u606f\u4f20\u9012\u5230\u4e0a\u6e38\u5e94\u7528\u670d\u52a1\uff0c\u4e4b\u540e\u4e0a\u6e38\u5e94\u7528\u670d\u52a1\u5c31\u53ef\u4ee5\u4ece\u8bf7\u6c42\u5934\u4e2d\u8bfb\u5230\u8fd9\u90e8\u5206\u4fe1\u606f\uff0c\u7136\u540e\u8fdb\u884c\u540e\u7eed\u7684\u903b\u8f91\u5904\u7406\u3002</p> <p>Apache APISIX \u4f5c\u4e3a\u4e00\u4e2a API \u7f51\u5173\uff0c\u76ee\u524d\u5df2\u5f00\u542f\u4e0e\u5404\u79cd\u63d2\u4ef6\u529f\u80fd\u7684\u9002\u914d\u5408\u4f5c\uff0c\u63d2\u4ef6\u5e93\u4e5f\u6bd4\u8f83\u4e30\u5bcc\u3002\u76ee\u524d\u5df2\u7ecf\u53ef\u4e0e\u5927\u91cf\u8eab\u4efd\u8ba4\u8bc1\u76f8\u5173\u7684\u63d2\u4ef6\u8fdb\u884c\u642d\u914d\u5904\u7406\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p></p> <p>\u57fa\u7840\u8ba4\u8bc1\u63d2\u4ef6\u6bd4\u5982 Key-Auth\u3001Basic-Auth\uff0c\u4ed6\u4eec\u662f\u901a\u8fc7\u8d26\u53f7\u5bc6\u7801\u7684\u65b9\u5f0f\u8fdb\u884c\u8ba4\u8bc1\u3002</p> <p>\u590d\u6742\u4e00\u4e9b\u7684\u8ba4\u8bc1\u63d2\u4ef6\u5982 Hmac-Auth\u3001JWT-Auth\uff0c\u5982 Hmac-Auth \u901a\u8fc7\u5bf9\u8bf7\u6c42\u4fe1\u606f\u505a\u4e00\u4e9b\u52a0\u5bc6\uff0c\u751f\u6210\u4e00\u4e2a\u7b7e\u540d\uff0c\u5f53 API \u8c03\u7528\u65b9\u5c06\u8fd9\u4e2a\u7b7e\u540d\u643a\u5e26\u5230 Apache APISIX\uff0cApache APISIX \u4f1a\u4ee5\u76f8\u540c\u7684\u7b97\u6cd5\u8ba1\u7b97\u7b7e\u540d\uff0c\u53ea\u6709\u5f53\u7b7e\u540d\u65b9\u548c\u5e94\u7528\u8c03\u7528\u65b9\u8ba4\u8bc1\u76f8\u540c\u65f6\u624d\u4e88\u4ee5\u901a\u8fc7\u3002</p> <p>\u5176\u4ed6\u5219\u662f\u4e00\u4e9b\u901a\u7528\u8ba4\u8bc1\u534f\u8bae\u548c\u8054\u5408\u7b2c\u4e09\u65b9\u7ec4\u4ef6\u8fdb\u884c\u5408\u4f5c\u7684\u8ba4\u8bc1\u534f\u8bae\uff0c\u4f8b\u5982 OpenID-Connect \u8eab\u4efd\u8ba4\u8bc1\u673a\u5236\uff0c\u4ee5\u53ca LDAP \u8ba4\u8bc1\u7b49\u3002</p> <p>Apache APISIX \u8fd8\u53ef\u4ee5\u9488\u5bf9\u6bcf\u4e00\u4e2a Consumer \uff08\u5373\u8c03\u7528\u65b9\u5e94\u7528\uff09\u53bb\u505a\u4e0d\u540c\u7ea7\u522b\u7684\u63d2\u4ef6\u914d\u7f6e\u3002</p> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u6211\u4eec\u521b\u5efa\u4e86\u4e24\u4e2a\u6d88\u8d39\u8005 Consumer A\u3001Consumer B\uff0c\u6211\u4eec\u5c06 Consumer A \u5e94\u7528\u5230\u5e94\u7528 1\uff0c\u5219\u540e\u7eed\u5e94\u7528 1 \u7684\u8bbf\u95ee\u5c06\u4f1a\u5f00\u542f Consumer A \u7684\u8fd9\u90e8\u5206\u63d2\u4ef6\uff0c\u4f8b\u5982 IP \u9ed1\u767d\u540d\u5355\uff0c\u9650\u5236\u5e76\u53d1\u6570\u91cf\u7b49\u3002</p> <p>\u5c06 Consumer B \u5e94\u7528\u5230\u5e94\u7528 2 \uff0c\u7531\u4e8e\u5f00\u542f\u4e86 http-log \u63d2\u4ef6\uff0c\u5219\u5e94\u7528 2 \u7684\u8bbf\u95ee\u65e5\u5fd7\u5c06\u4f1a\u901a\u8fc7 HTTP \u7684\u65b9\u5f0f\u53d1\u9001\u5230\u65e5\u5fd7\u7cfb\u7edf\u8fdb\u884c\u6536\u96c6\u3002</p> <p></p> <p>\u914d\u7f6e\u7075\u6d3b</p> <p>\u603b\u4f53\u8bf4\u6765 APISIX \u7684\u8ba4\u8bc1\u7cfb\u7edf\u529f\u80fd\u975e\u5e38\u5f3a\u5927\uff0c\u6211\u4eec\u975e\u5e38\u6709\u5fc5\u8981\u638c\u63e1\u3002</p>"},{"location":"chap12/8apixsix_plugin/#basic-auth","title":"basic-auth","text":"<p>\u9996\u5148\u6211\u4eec\u6765\u4e86\u89e3\u4e0b\u6700\u7b80\u5355\u7684\u57fa\u672c\u8ba4\u8bc1\u5728 APISIX \u4e2d\u662f\u5982\u4f55\u4f7f\u7528\u7684\u3002</p> <p>basic-auth \u662f\u4e00\u4e2a\u8ba4\u8bc1\u63d2\u4ef6\uff0c\u5b83\u9700\u8981\u4e0e Consumer \u4e00\u8d77\u914d\u5408\u624d\u80fd\u5de5\u4f5c\u3002\u6dfb\u52a0 Basic Auth \u5230\u4e00\u4e2a Service \u6216 Route\uff0c\u7136\u540e Consumer \u5c06\u5176\u7528\u6237\u540d\u548c\u5bc6\u7801\u6dfb\u52a0\u5230\u8bf7\u6c42\u5934\u4e2d\u4ee5\u9a8c\u8bc1\u5176\u8bf7\u6c42\u3002</p> <p>\u9996\u5148\u6211\u4eec\u9700\u8981\u5728 APISIX Consumer \u6d88\u8d39\u8005\u4e2d\u589e\u52a0 basic auth \u8ba4\u8bc1\u914d\u7f6e\uff0c\u4e3a\u5176\u6307\u5b9a\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u6211\u4eec\u8fd9\u91cc\u5728 APISIX Ingress \u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 ApisixConsumer \u8d44\u6e90\u5bf9\u8c61\u8fdb\u884c\u914d\u7f6e\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u4e3a\u524d\u9762\u7684 nexus \u5b9e\u4f8b\u5e94\u7528\u6dfb\u52a0\u4e00\u4e2a\u57fa\u672c\u8ba4\u8bc1\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># apisix-basic-auth.yaml\napiVersion: apisix.apache.org/v2\nkind: ApisixConsumer\nmetadata:\n  name: nexus-bauth\nspec:\n  authParameter:\n    basicAuth:\n      value:\n        username: admin\n        password: admin321\n</code></pre> <p>ApisixConsumer \u8d44\u6e90\u5bf9\u8c61\u4e2d\u53ea\u9700\u8981\u914d\u7f6e authParameter \u8ba4\u8bc1\u53c2\u6570\u5373\u53ef\uff0c\u76ee\u524d\u652f\u6301 basicAuth\u3001hmacAuth\u3001jwtAuth\u3001 keyAuth\u3001wolfRBAC \u7b49\u591a\u79cd\u8ba4\u8bc1\u7c7b\u578b\uff0c\u5728 basicAuth \u4e0b\u9762\u53ef\u4ee5\u901a\u8fc7 value \u53ef\u76f4\u63a5\u53bb\u914d\u7f6e\u76f8\u5173\u7684 username \u548c password\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Secret \u8d44\u6e90\u5bf9\u8c61\u8fdb\u884c\u914d\u7f6e\uff0c\u6bd4\u8d77\u660e\u6587\u914d\u7f6e\u4f1a\u66f4\u5b89\u5168\u4e00\u4e9b\u3002</p> <p>\u7136\u540e\u5728 <code>ApisixRoute</code> \u4e2d\u6dfb\u52a0 <code>authentication</code>\uff0c\u5c06\u5176\u5f00\u542f\u5e76\u6307\u5b9a\u8ba4\u8bc1\u7c7b\u578b\u5373\u53ef\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4f7f\u7528 Consumer \u53bb\u5b8c\u6210\u76f8\u5173\u914d\u7f6e\u8ba4\u8bc1\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apisix.apache.org/v2\nkind: ApisixRoute\nmetadata:\n  name: nexus\n  namespace: default\nspec:\n  http:\n    - name: root\n      match:\n        hosts:\n          - ops.foobar.com\n        paths:\n          - \"/nexus*\"\n          - \"/static/*\"\n          - \"/service/*\"\n      plugins:\n        - name: proxy-rewrite\n          enable: true\n          config:\n            regex_uri: [\"^/nexus(/|$)(.*)\", \"/$2\"]\n        - name: redirect\n          enable: true\n          config:\n            regex_uri: [\"^(/nexus)$\", \"$1/\"]\n        - name: redirect\n          enable: true\n          config:\n            http_to_https: true\n      backends:\n        - serviceName: nexus\n          servicePort: 8081\n      authentication: # \u5f00\u542f basic auth \u8ba4\u8bc1\n        enable: true\n        type: basicAuth\n</code></pre> <p>\u76f4\u63a5\u66f4\u65b0\u4e0a\u9762\u7684\u8d44\u6e90\u5373\u53ef\u5f00\u542f basic auth \u8ba4\u8bc1\u4e86\uff0c\u5728 Dashboard \u4e0a\u4e5f\u53ef\u4ee5\u770b\u5230\u521b\u5efa\u4e86\u4e00\u4e2a Consumer\uff1a</p> <p></p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u8fdb\u884c\u5982\u4e0b\u7684\u6d4b\u8bd5\u6765\u8fdb\u884c\u9a8c\u8bc1\uff1a</p> <pre><code># \u7f3a\u5c11 Authorization header\n\u279c curl -i http://test.foobar.com/nexus/\nHTTP/1.1 401 Unauthorized\nDate: Tue, 28 Mar 2023 08:12:01 GMT\nContent-Type: text/plain; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nWWW-Authenticate: Basic realm='.'\nServer: APISIX/3.2.0\n\n{\"message\":\"Missing authorization in request\"}\n# \u7528\u6237\u540d\u4e0d\u5b58\u5728\n\u279c curl -i -ubar:bar http://test.foobar.com/nexus/\nHTTP/1.1 401 Unauthorized\nDate: Tue, 28 Mar 2023 08:12:19 GMT\nContent-Type: text/plain; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX/3.2.0\n\n{\"message\":\"Invalid user authorization\"}\n# \u6210\u529f\u8bf7\u6c42\n\u279c curl -i -uadmin:admin321 http://test.foobar.com/nexus/\nHTTP/1.1 200 OK\nContent-Type: text/html; charset=utf-8\nContent-Length: 9024\nConnection: keep-alive\nDate: Tue, 28 Mar 2023 08:12:28 GMT\nX-Content-Type-Options: nosniff\nX-Frame-Options: DENY\nX-XSS-Protection: 1; mode=block\nLast-Modified: Tue, 28 Mar 2023 08:12:28 GMT\nPragma: no-cache\nCache-Control: no-cache, no-store, max-age=0, must-revalidate, post-check=0, pre-check=0\nExpires: 0\nServer: APISIX/3.2.0\n\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;\n# ......\n&lt;/html&gt;\n</code></pre>"},{"location":"chap12/8apixsix_plugin/#consumer-restriction","title":"consumer-restriction","text":"<p>\u4e0d\u8fc7\u8fd9\u91cc\u5927\u5bb6\u53ef\u80fd\u4f1a\u6709\u4e00\u4e2a\u7591\u95ee\uff0c\u5728 Route \u4e0a\u9762\u6211\u4eec\u5e76\u6ca1\u6709\u53bb\u6307\u5b9a\u5177\u4f53\u7684\u4e00\u4e2a Consumer\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u8fdb\u884c Basic Auth \u8ba4\u8bc1\u4e86\uff0c\u90a3\u5982\u679c\u6211\u4eec\u6709\u591a\u4e2a Consumer \u90fd\u5b9a\u4e49\u4e86 Basic Auth \u5c82\u4e0d\u662f\u90fd\u4f1a\u751f\u6548\u7684\uff1f</p> <p>\u786e\u5b9e\u662f\u8fd9\u6837\u7684\uff0c\u8fd9\u5c31\u662f APISIX \u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u6240\u6709\u7684 Consumer \u5bf9\u542f\u7528\u5bf9\u5e94\u63d2\u4ef6\u7684 Route \u90fd\u4f1a\u751f\u6548\u7684\uff0c\u5982\u679c\u6211\u4eec\u53ea\u60f3 Consumer A \u5e94\u7528\u5728 Route A\u3001Consumer B \u5e94\u7528\u5728 Route B \u4e0a\u9762\u7684\u8bdd\u5462\uff1f</p> <p>\u8981\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\u5c31\u9700\u8981\u7528\u5230\u53e6\u5916\u4e00\u4e2a\u63d2\u4ef6\uff1aconsumer-restriction\u3002</p> <p><code>consumer-restriction</code> \u63d2\u4ef6\u53ef\u4ee5\u6839\u636e\u9009\u62e9\u7684\u4e0d\u540c\u5bf9\u8c61\u505a\u76f8\u5e94\u7684\u8bbf\u95ee\u9650\u5236\uff0c\u8be5\u63d2\u4ef6\u53ef\u914d\u7f6e\u7684\u5c5e\u6027\u5982\u4e0b\u8868\u6240\u793a\uff1a</p> <p></p> <p>consumer restriction</p> <p>\u5176\u4e2d\u7684 type \u5b57\u6bb5\u662f\u4e2a\u679a\u4e3e\u7c7b\u578b\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u4ee5\u4e0b\u503c\uff1a</p> <ul> <li><code>consumer_name</code>\uff1a\u628a Consumer \u7684 username \u5217\u5165\u767d\u540d\u5355\u6216\u9ed1\u540d\u5355\u6765\u9650\u5236 Consumer \u5bf9 Route \u6216 Service \u7684\u8bbf\u95ee\u3002</li> <li><code>consumer_group_id</code>: \u628a Consumer Group \u7684 id \u5217\u5165\u767d\u540d\u5355\u6216\u9ed1\u540d\u5355\u6765\u9650\u5236 Consumer \u5bf9 Route \u6216 Service \u7684\u8bbf\u95ee\u3002</li> <li><code>service_id</code>\uff1a\u628a Service \u7684 id \u5217\u5165\u767d\u540d\u5355\u6216\u9ed1\u540d\u5355\u6765\u9650\u5236 Consumer \u5bf9 Service \u7684\u8bbf\u95ee\uff0c\u9700\u8981\u7ed3\u5408\u6388\u6743\u63d2\u4ef6\u4e00\u8d77\u4f7f\u7528\u3002</li> <li><code>route_id</code>\uff1a\u628a Route \u7684 id \u5217\u5165\u767d\u540d\u5355\u6216\u9ed1\u540d\u5355\u6765\u9650\u5236 Consumer \u5bf9 Route \u7684\u8bbf\u95ee\u3002</li> </ul> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e24\u4e2a Consumer\uff1ajack1 \u548c jack2\uff0c\u8fd9\u4e24\u4e2a Consumer \u90fd\u914d\u7f6e\u4e86 Basic Auth \u8ba4\u8bc1\uff0c\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <p>\u6267\u884c\u547d\u4ee4 <code>kubectl port-forward --address 0.0.0.0 svc/apisix-admin 9180:9180 -n apisix</code> \u66b4\u9732 admin \u7aef\u70b9\u3002</p> <p>Conumer jack1 \u7684\u8ba4\u8bc1\u914d\u7f6e\uff1a</p> <pre><code>\u279c curl http://127.0.0.1:9180/apisix/admin/consumers -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -i -d '\n{\n    \"username\": \"jack1\",\n    \"plugins\": {\n        \"basic-auth\": {\n            \"username\":\"jack2019\",\n            \"password\": \"123456\"\n        }\n    }\n}'\n</code></pre> <p>Conumer jack2 \u7684\u8ba4\u8bc1\u914d\u7f6e\uff1a</p> <pre><code>\u279c curl http://127.0.0.1:9180/apisix/admin/consumers -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -i -d '\n{\n    \"username\": \"jack2\",\n    \"plugins\": {\n        \"basic-auth\": {\n            \"username\":\"jack2020\",\n            \"password\": \"123456\"\n        }\n    }\n}'\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ea\u60f3\u7ed9\u4e00\u4e2a Route \u8def\u7531\u5bf9\u8c61\u542f\u7528 jack1 \u8fd9\u4e2a Consumer \u7684\u8ba4\u8bc1\u914d\u7f6e\uff0c\u5219\u9664\u4e86\u542f\u7528 basic-auth \u63d2\u4ef6\u4e4b\u5916\uff0c\u8fd8\u9700\u8981\u5728 <code>consumer-restriction</code> \u63d2\u4ef6\u4e2d\u914d\u7f6e\u4e00\u4e2a whitelist \u767d\u540d\u5355\uff08\u5f53\u7136\u914d\u7f6e\u9ed1\u540d\u5355\u4e5f\u662f\u53ef\u4ee5\u7684\uff09\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>\u279c curl http://127.0.0.1:9180/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '\n{\n    \"uri\": \"/index.html\",\n    \"upstream\": {\n        \"type\": \"roundrobin\",\n        \"nodes\": {\n            \"10.244.1.125:8081\": 1\n        }\n    },\n    \"plugins\": {\n        \"basic-auth\": {},\n        \"consumer-restriction\": {\n            \"whitelist\": [\n                \"jack1\"\n            ]\n        }\n    }\n}'\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u4f7f\u7528 jack1 \u53bb\u8bbf\u95ee\u6211\u4eec\u7684\u8def\u7531\u8fdb\u884c\u9a8c\u8bc1\uff1a</p> <pre><code>\u279c curl -u jack2019:123456 http://127.0.0.1/index.html -i\nHTTP/1.1 302 Found\n...\n</code></pre> <p>\u6b63\u5e38\u4f7f\u7528 jack2 \u8bbf\u95ee\u5c31\u4f1a\u8ba4\u8bc1\u5931\u8d25\u4e86\uff1a</p> <pre><code>\u279c curl -u jack2020:123456 http://127.0.0.1/index.html -i\nHTTP/1.1 403 Forbidden\nDate: Tue, 28 Mar 2023 08:22:38 GMT\nContent-Type: text/html; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX/3.2.0\n\n{\"message\":\"The consumer_name is forbidden.\"}\n</code></pre> <p>\u6240\u4ee5\u5f53\u4f60\u53ea\u60f3\u8ba9\u4e00\u4e2a Route \u5bf9\u8c61\u5173\u8054\u6307\u5b9a\u7684 Consumer \u7684\u65f6\u5019\uff0c\u8bb0\u5f97\u4f7f\u7528 <code>consumer-restriction</code> \u63d2\u4ef6\u3002</p>"},{"location":"chap12/8apixsix_plugin/#jwt-auth","title":"jwt-auth","text":"<p>\u5728\u5e73\u65f6\u7684\u5e94\u7528\u4e2d\u53ef\u80fd\u4f7f\u7528 jwt \u8ba4\u8bc1\u7684\u573a\u666f\u662f\u6700\u591a\u7684\uff0c\u540c\u6837\u5728 APISIX \u4e2d\u4e5f\u6709\u63d0\u4f9b jwt-auth \u7684\u63d2\u4ef6\uff0c\u5b83\u540c\u6837\u9700\u8981\u4e0e Consumer \u4e00\u8d77\u914d\u5408\u624d\u80fd\u5de5\u4f5c\uff0c\u6211\u4eec\u53ea\u9700\u8981\u6dfb\u52a0 JWT Auth \u5230\u4e00\u4e2a Service \u6216 Route\uff0c\u7136\u540e Consumer \u5c06\u5176\u5bc6\u94a5\u6dfb\u52a0\u5230\u67e5\u8be2\u5b57\u7b26\u4e32\u53c2\u6570\u3001\u8bf7\u6c42\u5934\u6216 cookie \u4e2d\u4ee5\u9a8c\u8bc1\u5176\u8bf7\u6c42\u5373\u53ef\u3002</p> <p>\u5f53\u7136\u9664\u4e86\u901a\u8fc7 ApisixConsumer \u8fd9\u4e2a CRD \u53bb\u914d\u7f6e\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 Dashboard \u9875\u9762\u64cd\u4f5c\u3002\u5728 Dashboard \u6d88\u8d39\u8005\u9875\u9762\u70b9\u51fb\u521b\u5efa\u6d88\u8d39\u8005\uff1a</p> <p></p> <p>\u70b9\u51fb\u4e0b\u4e00\u6b65\u8fdb\u5165\u63d2\u4ef6\u914d\u7f6e\u9875\u9762\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u542f\u7528 jwt-auth \u8fd9\u4e2a\u63d2\u4ef6\uff1a</p> <p></p> <p>\u5728\u63d2\u4ef6\u914d\u7f6e\u9875\u9762\u914d\u7f6e jwt-auth \u76f8\u5173\u5c5e\u6027\uff0c\u53ef\u53c2\u8003\u63d2\u4ef6\u6587\u6863 https://apisix.apache.org/zh/docs/apisix/plugins/jwt-auth/:</p> <p></p> <p>\u53ef\u914d\u7f6e\u7684\u5c5e\u6027\u5982\u4e0b\u8868\u6240\u793a\uff1a</p> <p></p> <p>\u7136\u540e\u63d0\u4ea4\u5373\u53ef\u521b\u5efa\u5b8c\u6210 Consumer\uff0c\u7136\u540e\u6211\u4eec\u53ea\u9700\u8981\u5728\u9700\u8981\u7684 Service \u6216\u8005 Route \u4e0a\u5f00\u542f <code>jwt-auth</code> \u5373\u53ef\uff0c\u6bd4\u5982\u540c\u6837\u8fd8\u662f\u9488\u5bf9\u4e0a\u9762\u7684 <code>nexus</code> \u5e94\u7528\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728 <code>ApisixRoute</code> \u5bf9\u8c61\u4e2d\u542f\u7528\u4e00\u4e2a <code>jwt-auth</code> \u63d2\u4ef6\u5373\u53ef\uff1a</p> <pre><code>apiVersion: apisix.apache.org/v2\nkind: ApisixRoute\nmetadata:\n  name: nexus\n  namespace: default\nspec:\n  http:\n    - name: root\n      match:\n        hosts:\n          - ops.foobar.com\n        paths:\n          - \"/nexus*\"\n          - \"/static/*\"\n          - \"/service/*\"\n      plugins:\n        - name: redirect\n          enable: true\n          config:\n            http_to_https: true\n        - name: redirect\n          enable: true\n          config:\n            regex_uri: [\"^(/nexus)$\", \"$1/\"]\n        - name: proxy-rewrite\n          enable: true\n          config:\n            regex_uri: [\"^/nexus(/|$)(.*)\", \"/$2\"]\n      backends:\n        - serviceName: nexus\n          servicePort: 8081\n      authentication: # \u5f00\u542f jwt auth \u8ba4\u8bc1\n        enable: true\n        type: jwtAuth\n</code></pre> <p>\u91cd\u65b0\u66f4\u65b0\u4e0a\u9762\u7684\u5bf9\u8c61\u540e\u6211\u4eec\u540c\u6837\u6765\u6d4b\u8bd5\u9a8c\u8bc1\u4e0b\uff1a</p> <pre><code>\u279c curl -i http://test.foobar.com/nexus/\nHTTP/1.1 401 Unauthorized\nDate: Tue, 28 Mar 2023 08:30:02 GMT\nContent-Type: text/plain; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX/3.2.0\n\n{\"message\":\"Missing JWT token in request\"}\n</code></pre> <p>\u8981\u6b63\u5e38\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u5c31\u9700\u8981\u5148\u8fdb\u884c\u767b\u5f55\u83b7\u53d6 jwt-auth \u7684 token\uff0c\u9996\u5148\uff0c\u4f60\u9700\u8981\u4e3a\u7b7e\u53d1 token \u7684 API \u914d\u7f6e\u4e00\u4e2a Route\uff0c\u8be5\u8def\u7531\u5c06\u4f7f\u7528 public-api \u63d2\u4ef6\u3002</p> <pre><code>\u279c curl http://127.0.0.1:9180/apisix/admin/routes/jas \\\n-H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '\n{\n    \"uri\": \"/apisix/plugin/jwt/sign\",\n    \"plugins\": {\n        \"public-api\": {}\n    }\n}'\n{\"error_msg\":\"unknown plugin [public-api]\"}\n</code></pre> <p>\u6267\u884c\u4e0a\u9762\u547d\u4ee4\u540e\u4f1a\u51fa\u73b0\u4e0d\u8bc6\u522b <code>public-api</code> \u63d2\u4ef6\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Helm Chart \u65b9\u5f0f\u5b89\u88c5\u7684 APISIX \u9ed8\u8ba4\u6ca1\u6709\u5b89\u88c5\u8be5\u63d2\u4ef6\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5230 Helm Chart \u7684 values.yaml \u6587\u4ef6\u4e2d\u5728 plugins \u5c5e\u6027\u4e0b\u9762\u6dfb\u52a0\u4e0a\u8be5\u63d2\u4ef6\uff0c\u7136\u540e\u91cd\u65b0\u66f4\u65b0 APISIX \u5373\u53ef\uff1a</p> <pre><code>\u279c helm upgrade --install apisix ./apisix -f ./apisix-values.yaml -n apisix --create-namespace\n</code></pre> <p>\u66f4\u65b0\u540e\u91cd\u65b0\u6267\u884c\u547d\u4ee4\uff1a</p> <pre><code>\n\u279c curl http://127.0.0.1:9180/apisix/admin/routes/jas -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '\n{\n    \"uri\": \"/apisix/plugin/jwt/sign\",\n    \"plugins\": {\n        \"public-api\": {}\n    }\n}'\n</code></pre> <p>\u4e4b\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7\u8c03\u7528\u5b83\u6765\u83b7\u53d6 token \u4e86\u3002</p> <pre><code>\u279c curl http://127.0.0.1/apisix/plugin/jwt/sign?key=user-key -i\nHTTP/1.1 200 OK\nDate: Tue, 28 Mar 2023 08:44:45 GMT\nContent-Type: text/plain; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX/3.2.0\n\neyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2ODAwNzk0ODUsImtleSI6InVzZXIta2V5In0.n4o_w3AgNC6C1pujEUScSBe0Mzw5vbjIzKpQpbrBhO8\n</code></pre> <p>\u8981\u6ce8\u610f\u4e0a\u9762\u6211\u4eec\u5728\u83b7\u53d6 token \u7684\u65f6\u5019\u9700\u8981\u4f20\u9012\u521b\u5efa\u6d88\u8d39\u8005\u7684\u6807\u8bc6 key\uff0c\u56e0\u4e3a\u53ef\u80fd\u6709\u591a\u4e2a\u4e0d\u540c\u7684 Consumer \u6d88\u8d39\u8005\uff0c\u7136\u540e\u6211\u4eec\u5c06\u4e0a\u9762\u83b7\u5f97\u7684 token \u653e\u5165\u5230 Header \u5934\u4e2d\u8fdb\u884c\u8bbf\u95ee\uff1a</p> <pre><code>\u279c curl -i http://test.foobar.com/nexus/ -H 'Authorization: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2ODAwNzk0ODUsImtleSI6InVzZXIta2V5In0.n4o_w3AgNC6C1pujEUScSBe0Mzw5vbjIzKpQpbrBhO8'\nHTTP/1.1 200 OK\nContent-Type: text/html; charset=utf-8\nContent-Length: 9024\nConnection: keep-alive\nDate: Tue, 28 Mar 2023 08:45:24 GMT\nX-Content-Type-Options: nosniff\nX-Frame-Options: DENY\nX-XSS-Protection: 1; mode=block\nLast-Modified: Tue, 28 Mar 2023 08:45:24 GMT\nPragma: no-cache\nCache-Control: no-cache, no-store, max-age=0, must-revalidate, post-check=0, pre-check=0\nExpires: 0\nServer: APISIX/3.2.0\n\n\n&lt;!DOCTYPE html&gt;\n&lt;html lang=\"en\"&gt;\n......\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u3002\u540c\u6837\u4e5f\u53ef\u4ee5\u653e\u5230\u8bf7\u6c42\u53c2\u6570\u4e2d\u9a8c\u8bc1\uff1a</p> <pre><code>\u279c curl -i http://test.foobar.com/nexus/?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2ODAwNzk0ODUsImtleSI6InVzZXIta2V5In0.n4o_w3AgNC6C1pujEUScSBe0Mzw5vbjIzKpQpbrBhO8\nHTTP/1.1 200 OK\n......\n</code></pre> <p>\u6b64\u5916\u8fd8\u53ef\u4ee5\u653e\u5230 cookie \u4e2d\u8fdb\u884c\u9a8c\u8bc1\uff1a</p> <pre><code>\u279c curl -i http://test.foobar.com/nexus/ --cookie jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2ODAwNzk0ODUsImtleSI6InVzZXIta2V5In0.n4o_w3AgNC6C1pujEUScSBe0Mzw5vbjIzKpQpbrBhO8\nHTTP/1.1 200 OK\n......\n</code></pre>"},{"location":"chap12/8apixsix_plugin/#_1","title":"\u81ea\u5b9a\u4e49\u63d2\u4ef6","text":"<p>\u9664\u4e86 APISIX \u5b98\u65b9\u5185\u7f6e\u7684\u63d2\u4ef6\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u53bb\u81ea\u5b9a\u4e49\u63d2\u4ef6\uff0c\u8981\u81ea\u5b9a\u4e49\u63d2\u4ef6\u9700\u8981\u4f7f\u7528\u5230 APISIX \u63d0\u4f9b\u7684 Runner\uff0c\u76ee\u524d\u5df2\u7ecf\u652f\u6301 Java\u3001Go\u3001Node \u548c Python \u8bed\u8a00\u7684 Runner\uff0c\u8fd9\u4e2a Runner \u76f8\u5f53\u4e8e\u662f APISIX \u548c\u81ea\u5b9a\u4e49\u63d2\u4ef6\u4e4b\u95f4\u7684\u6865\u6881\uff0c\u6bd4\u5982 <code>apache-apisix-python-runner</code> \u8fd9\u4e2a\u9879\u76ee\u901a\u8fc7 Python Runner \u53ef\u4ee5\u628a Python \u76f4\u63a5\u5e94\u7528\u5230 APISIX \u7684\u63d2\u4ef6\u5f00\u53d1\u4e2d\uff0c\u6574\u4f53\u67b6\u6784\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u5de6\u8fb9\u662f APISIX \u7684\u5de5\u4f5c\u6d41\u7a0b\uff0c\u53f3\u8fb9\u7684 Plugin Runner \u662f\u5404\u8bed\u8a00\u7684\u63d2\u4ef6\u8fd0\u884c\u5668\uff0c\u5f53\u5728 APISIX \u4e2d\u914d\u7f6e\u4e00\u4e2a Plugin Runner \u65f6\uff0cAPISIX \u4f1a\u542f\u52a8\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u8fd0\u884c Plugin Runner\uff0c\u8be5\u5b50\u8fdb\u7a0b\u4e0e APISIX \u8fdb\u7a0b\u5c5e\u4e8e\u540c\u4e00\u4e2a\u7528\u6237\uff0c\u5f53\u6211\u4eec\u91cd\u542f\u6216\u91cd\u65b0\u52a0\u8f7d APISIX \u65f6\uff0cPlugin Runner \u4e5f\u5c06\u88ab\u91cd\u542f\u3002</p> <p>\u5982\u679c\u4f60\u4e3a\u4e00\u4e2a\u7ed9\u5b9a\u7684\u8def\u7531\u914d\u7f6e\u4e86 <code>ext-plugin-*</code> \u63d2\u4ef6\uff0c\u8bf7\u6c42\u547d\u4e2d\u8be5\u8def\u7531\u65f6\u5c06\u89e6\u53d1 APISIX \u901a\u8fc7 <code>Unix Socket</code> \u5411 <code>Plugin Runner</code> \u53d1\u8d77 <code>RPC</code> \u8c03\u7528\u3002\u8c03\u7528\u5206\u4e3a\u4e24\u4e2a\u9636\u6bb5\uff1a</p> <ul> <li>ext-plugin-pre-req\uff1a\u5728\u6267\u884c APISIX \u5185\u7f6e\u63d2\u4ef6\u4e4b\u524d</li> <li>ext-plugin-post-req\uff1a\u5728\u6267\u884c APISIX \u5185\u7f6e\u63d2\u4ef6\u4e4b\u540e</li> <li>ext-plugin-post-resp\uff1a\u5c06\u5728\u8bf7\u6c42\u83b7\u53d6\u5230\u4e0a\u6e38\u7684\u54cd\u5e94\u4e4b\u540e\u6267\u884c\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u4ee5 Python \u4e3a\u4f8b\u6765\u8bf4\u660e\u5982\u4f55\u81ea\u5b9a\u4e49\u63d2\u4ef6\uff0c\u9996\u5148\u83b7\u53d6 apache-apisix-python-runner \u9879\u76ee</p> <pre><code>\u279c git clone https://github.com/apache/apisix-python-plugin-runner.git\n\u279c cd apisix-python-plugin-runner\n\u279c git checkout 0.2.0  # \u5207\u6362\u52300.2.0\u7248\u672c\n</code></pre> <p>\u5982\u679c\u662f\u5f00\u53d1\u6a21\u5f0f\uff0c\u5219\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u542f\u52a8 Python Runner\uff1a</p> <pre><code>\u279c APISIX_LISTEN_ADDRESS=unix:/tmp/runner.sock python3 bin/py-runner start\n</code></pre> <p>\u542f\u52a8\u540e\u9700\u8981\u5728 APISIX \u914d\u7f6e\u6587\u4ef6\u4e2d\u65b0\u589e\u5916\u90e8\u63d2\u4ef6\u914d\u7f6e\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>\u279c vim /path/to/apisix/conf/config.yaml\napisix:\n  admin_key:\n    - name: \"admin\"\n      key: edd1c9f034335f136f87ad84b625c8f1\n      role: admin\n\next-plugin:\n  path_for_test: /tmp/runner.sock\n</code></pre> <p>\u901a\u8fc7 <code>ext-plugin.path_for_test</code> \u6307\u5b9a Python Runner \u7684 unix socket \u6587\u4ef6\u8def\u5f84\u5373\u53ef\uff0c\u5982\u679c\u662f\u751f\u4ea7\u73af\u5883\u5219\u53ef\u4ee5\u901a\u8fc7 <code>ext-plugin.cmd</code> \u6765\u6307\u5b9a Runner \u7684\u542f\u52a8\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>ext-plugin:\n  cmd: [ \"python3\", \"/path/to/apisix-python-plugin-runner/apisix/bin/py-runner\", \"start\" ]\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u7684 APISIX \u662f\u8fd0\u884c Kubernetes \u96c6\u7fa4\u4e2d\u7684\uff0c\u6240\u4ee5\u8981\u5728 APISIX \u7684 Pod \u4e2d\u53bb\u6267\u884c Python Runner \u7684\u4ee3\u7801\uff0c\u6211\u4eec\u81ea\u7136\u9700\u8981\u5c06\u6211\u4eec\u7684 Python \u4ee3\u7801\u653e\u5230 APISIX \u7684\u5bb9\u5668\u4e2d\u53bb\uff0c\u7136\u540e\u5b89\u88c5\u81ea\u5b9a\u4e49\u63d2\u4ef6\u7684\u76f8\u5173\u4f9d\u8d56\uff0c\u76f4\u63a5\u5728 APISIX \u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e0a\u9762\u7684\u914d\u7f6e\u5373\u53ef\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u57fa\u4e8e APISIX \u7684\u955c\u50cf\u6765\u91cd\u65b0\u5b9a\u5236\u5305\u542b\u63d2\u4ef6\u7684\u955c\u50cf\uff0c\u5728 apisix-python-plugin-runner \u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u65b0\u589e\u5982\u4e0b\u6240\u793a\u7684 Dockerfile \u6587\u4ef6\uff1a</p> <pre><code>ROM apache/apisix:3.2.0-debian\n\nWORKDIR /apisix-python\nADD . /apisix-python\nUSER root\n\nRUN apt-get update &amp;&amp; \\\n    apt-get install -y python3 python3-pip make &amp;&amp; \\\n    rm -rf /var/lib/apt/lists/* &amp;&amp; apt-get clean &amp;&amp; \\\n    make setup &amp;&amp; make install\n</code></pre> <p>\u57fa\u4e8e\u4e0a\u9762 Dockerfile \u6784\u5efa\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u63a8\u9001\u5230 Docker Hub\uff1a</p> <pre><code>\u279c docker build -t cnych/apisix:py3-plugin-3.2.0-debian .\n# \u63a8\u9001\u5230DockerHub\n\u279c docker push cnych/apisix:py3-plugin-3.2.0-debian\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u4f7f\u7528\u4e0a\u9762\u6784\u5efa\u7684\u955c\u50cf\u6765\u5b89\u88c5 APISIX\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f Helm Chart \u8fdb\u884c\u5b89\u88c5\u7684\uff0c\u6240\u4ee5\u9700\u8981\u901a\u8fc7 Values \u6587\u4ef6\u8fdb\u884c\u8986\u76d6\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># ci/prod.yaml\napisix:\n  enabled: true\n\n  image:\n    repository: cnych/apisix\n    tag: py3-plugin-3.2.0-debian\n......\n\nextPlugin:\n  # -- Enable External Plugins. See [external plugin](https://apisix.apache.org/docs/apisix/next/external-plugin/)\n  enabled: true\n  # -- the command and its arguements to run as a subprocess\n  cmd: [\"python3\", \"/apisix-python/bin/py-runner\", \"start\"]\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u9700\u8981\u5c06\u81ea\u5b9a\u4e49\u63d2\u4ef6\u5f00\u542f\uff0c\u5e76\u4e14\u5c06 <code>extPlugin.cmd</code> \u914d\u7f6e\u4e3a <code>[\"/apisix-python/bin/py-runner\", \"start\"]</code>\uff0c\u56e0\u4e3a\u6211\u4eec\u662f\u5728 APISIX \u7684\u955c\u50cf\u4e2d\u5b89\u88c5\u4e86 Python Runner\uff0c\u6240\u4ee5\u9700\u8981\u6307\u5b9a Python Runner \u7684\u542f\u52a8\u547d\u4ee4\u3002</p> <p>\u63a5\u7740\u5c31\u53ef\u4ee5\u91cd\u65b0\u90e8\u7f72 APISIX \u4e86\uff1a</p> <pre><code>\u279c helm upgrade --install apisix ./apisix -f ./apisix-values.yaml -n apisix --create-namespace\n</code></pre> <p></p> <p>\u5728\u63d2\u4ef6\u76ee\u5f55 <code>/apisix-python/apisix/plugins</code> \u4e2d\u7684 <code>.py</code> \u6587\u4ef6\u90fd\u4f1a\u88ab\u81ea\u52a8\u52a0\u8f7d\uff0c\u4e0a\u9762\u793a\u4f8b\u4e2d\u6709\u4e24\u4e2a\u63d2\u4ef6 <code>stop.py</code> \u548c <code>rewrite.py</code>\uff0c\u6211\u4eec\u4ee5 <code>stop.py</code> \u4e3a\u4f8b\u8fdb\u884c\u8bf4\u660e\uff0c\u8be5\u63d2\u4ef6\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>from typing import Any\nfrom apisix.runner.http.request import Request\nfrom apisix.runner.http.response import Response\nfrom apisix.runner.plugin.core import PluginBase\n\n\nclass Stop(PluginBase):\n\n    def name(self) -&gt; str:\n        \"\"\"\u5728runner\u4e2d\u6ce8\u518c\u7684\u63d2\u4ef6\u7684\u540d\u79f0\"\"\"\n        return \"stop\"\n\n    def config(self, conf: Any) -&gt; Any:\n        \"\"\"\u89e3\u6790\u63d2\u4ef6\u914d\u7f6e\"\"\"\n        return conf\n\n    def filter(self, conf: Any, request: Request, response: Response):\n        \"\"\"\u63d2\u4ef6\u6267\u884c\u7684\u4e3b\u51fd\u6570\n        :param conf:\n            \u89e3\u6790\u540e\u7684\u63d2\u4ef6\u914d\u7f6e\n        :param request:\n            \u8bf7\u6c42\u53c2\u6570\u548c\u4fe1\u606f\n        :param response:\n            \u54cd\u5e94\u53c2\u6570\u548c\u4fe1\u606f\n        :return:\n        \"\"\"\n\n        # \u6253\u5370\u63d2\u4ef6\u914d\u7f6e\n        print(conf)\n\n        # \u83b7\u53d6\u8bf7\u6c42 nginx \u53d8\u91cf `host`\n        host = request.get_var(\"host\")\n        print(host)\n\n        # \u83b7\u53d6\u8bf7\u6c42\u4f53\n        body = request.get_body()\n        print(body)\n\n        # \u8bbe\u7f6e\u54cd\u5e94\u5934\n        response.set_header(\"X-Resp-A6-Runner\", \"Python\")\n\n        # \u8bbe\u7f6e\u54cd\u5e94\u4f53\n        response.set_body(\"Hello, Python Runner of APISIX\")\n\n        # \u8bbe\u7f6e\u54cd\u5e94\u72b6\u6001\u7801\n        response.set_status_code(201)\n</code></pre> <p>\u5b9e\u73b0\u63d2\u4ef6\u9996\u5148\u5fc5\u987b\u8981\u7ee7\u627f PluginBase \u7c7b\uff0c\u5fc5\u987b\u5b9e\u73b0 filter \u51fd\u6570\uff0c\u63d2\u4ef6\u6267\u884c\u6838\u5fc3\u4e1a\u52a1\u903b\u8f91\u5c31\u662f\u5728 filter \u51fd\u6570\u4e2d\uff0c\u8be5\u51fd\u6570\u53ea\u5305\u542b Request \u548c Response \u7c7b\u5bf9\u8c61\u4f5c\u4e3a\u53c2\u6570\uff0cRequest \u5bf9\u8c61\u53c2\u6570\u53ef\u4ee5\u83b7\u53d6\u8bf7\u6c42\u4fe1\u606f\uff0cResponse \u5bf9\u8c61\u53c2\u6570\u53ef\u4ee5\u8bbe\u7f6e\u54cd\u5e94\u4fe1\u606f\uff0cconf \u53ef\u4ee5\u83b7\u53d6\u63d2\u4ef6\u914d\u7f6e\u4fe1\u606f\u3002</p> <p>\u7136\u540e\u6211\u4eec\u5728\u524d\u9762\u7684 Nexus \u5e94\u7528\u4e2d\u65b0\u589e\u4e00\u4e2a\u8def\u7531\u6765\u6d4b\u8bd5\u6211\u4eec\u4e0a\u9762\u7684 stop \u63d2\u4ef6\uff0c\u5728 ApisixRoute \u5bf9\u8c61\u4e2d\u65b0\u589e\u4e00\u4e2a\u8def\u7531\u89c4\u5219\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apisix.apache.org/v2\nkind: ApisixRoute\nmetadata:\n  name: nexus\n  namespace: default\nspec:\n  http:\n    - name: ext\n      match:\n        hosts:\n          - test.foobar.com\n        paths:\n          - \"/extPlugin\"\n      plugins:\n        - name: ext-plugin-pre-req # \u542f\u7528ext-plugin-pre-req\u63d2\u4ef6\n          enable: true\n          config:\n            conf:\n              - name: \"stop\" # \u4f7f\u7528 stop \u8fd9\u4e2a\u81ea\u5b9a\u4e49\u63d2\u4ef6\n                value: '{\"body\":\"hello\"}'\n      backends:\n        - serviceName: nexus\n          servicePort: 8081\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8def\u7531\u5373\u53ef\uff0c\u6838\u5fc3\u914d\u7f6e\u662f\u542f\u7528 <code>ext-plugin-pre-req</code> \u63d2\u4ef6\uff08\u524d\u63d0\u662f\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u5df2\u7ecf\u542f\u7528\u8be5\u63d2\u4ef6\uff0c\u5728 Helm Chart \u7684 Values \u4e2d\u6dfb\u52a0\u4e0a\uff09\uff0c\u7136\u540e\u5728 config \u4e0b\u9762\u4f7f\u7528 conf \u5c5e\u6027\u8fdb\u884c\u914d\u7f6e\uff0cconf \u4e3a\u6570\u7ec4\u683c\u5f0f\u53ef\u4ee5\u540c\u65f6\u8bbe\u7f6e\u591a\u4e2a\u63d2\u4ef6\uff0c\u63d2\u4ef6\u914d\u7f6e\u5bf9\u8c61\u4e2d name \u4e3a\u63d2\u4ef6\u540d\u79f0\uff0c\u8be5\u540d\u79f0\u9700\u8981\u4e0e\u63d2\u4ef6\u4ee3\u7801\u6587\u4ef6\u548c\u5bf9\u8c61\u540d\u79f0\u4e00\u81f4\uff0cvalue \u4e3a\u63d2\u4ef6\u914d\u7f6e\uff0c\u53ef\u4ee5\u4e3a JSON \u5b57\u7b26\u4e32\u3002</p> <p>\u521b\u5efa\u540e\u540c\u6837\u5728 Dashboard \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230 APISIX \u4e2d\u7684\u8def\u7531\u914d\u7f6e\u683c\u5f0f\uff1a</p> <p></p> <p>\u63a5\u7740\u6211\u4eec\u53ef\u4ee5\u6765\u8bbf\u95ee http://ops.youdianzhishi.com/extPlugin \u8fd9\u4e2a\u8def\u5f84\u6765\u9a8c\u8bc1\u6211\u4eec\u7684\u81ea\u5b9a\u4e49\u63d2\u4ef6\uff1a</p> <pre><code>\u279c curl -i http://test.foobar.com/extPlugin\nHTTP/1.1 201 Created\nDate: Tue, 28 Mar 2023 13:10:34 GMT\nContent-Type: text/plain; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nx-resp-a6-runner: Python\nServer: APISIX/3.2.0\n\nHello, Python Runner of APISIX\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5f97\u5230\u7684\u7ed3\u679c\u548c\u54cd\u5e94\u7801\u548c\u6211\u4eec\u5728\u63d2\u4ef6\u4e2d\u7684\u5b9a\u4e49\u662f\u7b26\u5408\u7684\u3002\u5230\u8fd9\u91cc\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Python \u8fdb\u884c APISIX \u81ea\u5b9a\u4e49\u63d2\u4ef6\uff0c\u6211\u4eec\u6709\u4efb\u4f55\u7684\u4e1a\u52a1\u903b\u8f91\u9700\u8981\u5904\u7406\u76f4\u63a5\u53bb\u5b9a\u4e49\u4e00\u4e2a\u5bf9\u5e94\u7684\u63d2\u4ef6\u5373\u53ef\u3002</p>"},{"location":"chap12/9apigateway2024/","title":"API Gateway \u6280\u672f\u6f2b\u8c08 2024","text":""},{"location":"chap12/9apigateway2024/#api-gateway","title":"\u4ec0\u4e48\u662f API Gateway?","text":"<p>\u6240\u8c13\u7684 API Gateway \u5c31\u662f\u5728\u6570\u636e\u9762\u5f00\u53d1\u4e00\u4e9b\u9274\u6743\u9650\u6d41\u529f\u80fd\u3002</p> <p>\u9488\u5bf9 api gateway \u6765\u8bf4\uff0c\u9650\u6d41\u63d2\u4ef6\u66f4\u5173\u5fc3 consumer \u8fd9\u6837\u7684\u6982\u5ff5\uff0c\u9488\u5bf9\u4e0d\u540c\u7684 consumer \u8fdb\u884c\u4e0d\u540c\u7684\u9650\u6d41\u914d\u7f6e\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u5f88\u591a\u4e1a\u52a1\u670d\u52a1\u90fd\u4f1a\u6709\u901a\u7528\u7684\u903b\u8f91\uff0c\u6bd4\u5982\u5bf9\u4e1a\u52a1\u8bf7\u6c42\u8fdb\u884c metric \u7edf\u8ba1\uff0c\u5bf9\u5f02\u5e38\u8bf7\u6c42\u8fdb\u884c\u91cd\u8bd5\uff0c\u5bf9\u5916\u63d0\u4f9b\u7edf\u4e00\u7684 API \u534f\u8bae\u7b49\u7b49\uff0c\u8fd9\u4e9b\u901a\u7528\u903b\u8f91\u90fd\u53ef\u4ee5\u653e\u5230 api gateway \u4e2d\u6765\u5b9e\u73b0\u3002\u66f4\u8fd1\u4e00\u6b65\uff0capi gateway \u5e94\u8be5\u662f\u4e00\u4e2a\u5bf9 api \u8fdb\u884c\u6258\u7ba1\u7684\u670d\u52a1\uff0c\u63d0\u4f9b\u5bf9 API \u7684\u5b8c\u6574\u751f\u547d\u5468\u671f\u7ba1\u7406\uff0c\u5305\u62ec\u521b\u5efa\u3001\u7ef4\u62a4\u3001\u53d1\u5e03\u3001\u8fd0\u884c\u4ee5\u53ca\u4e0b\u7ebf\u3002</p>"},{"location":"chap12/9apigateway2024/#apisix","title":"APISIX","text":"<p>\u7b14\u8005\u6240\u5728\u516c\u53f8\u5185\u90e8\u4f7f\u7528\u7684 api gateway \u4ea7\u54c1\u5c31\u662f\u57fa\u4e8e apisix\u4e3a\u5e95\u5ea7\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\uff0c\u4e3b\u8981\u8003\u8651\u5230 apisix \u7684\u4ee5\u4e0b\u4f18\u70b9\uff1a</p> <ol> <li>\u4e30\u5bcc\u7684\u5f00\u7bb1\u5373\u7528\u7684\u63d2\u4ef6\uff0c\u57fa\u672c\u4e0a\u5e38\u89c1\u7684\u9700\u6c42\u90fd\u80fd\u627e\u5230\u5bf9\u5e94\u7684\u63d2\u4ef6\uff0c\u5e76\u4e14\u4e2a\u6027\u5316\u7684\u9700\u6c42\u81ea\u5df1\u5199\u6269\u5c55\u7684\u63d2\u4ef6\u4e5f\u65b9\u4fbf\u3002</li> <li>apisix \u6240\u62bd\u8c61\u7684 route/service/upstream/consumer/plugin \u8fd9\u4e9b\u6982\u5ff5\u90fd\u5f88\u4f18\u96c5\uff0c\u4f5c\u4e3a\u7f51\u5173\u6765\u8bf4\uff0c\u51e0\u4e4e\u80fd\u591f\u6ee1\u8db3\u6240\u6709\u7684\u573a\u666f\uff0c\u6bd4 k8s \u91cc\u9762\u7684 ingress/service \u8fd9\u4e24\u4e2a\u6982\u5ff5\u597d\u5f88\u591a\uff0c\u6bd4\u5982\u4f60\u60f3\u8868\u8fbe\u6309\u767e\u5206\u6bd4\u8f6c\u53d1\u6d41\u91cf\uff0c\u8fd9\u4e2a\u7528 ingress/service \u5c31\u65e0\u6cd5\u8868\u8fbe\u51fa\u6765\u3002\uff08\u76ee\u524d k8s \u4e5f\u8ba4\u8bc6\u5230 ingress/service \u5bf9\u6d41\u91cf\u7ba1\u63a7\u8868\u8fbe\u80fd\u529b\u5f31\u7684\u95ee\u9898\uff0c\u63a8\u51fa\u4e86\u65b0\u7684 gatewayapi\uff0c\u4f46\u662f\u5b9e\u9645\u4f53\u9a8c\u4e0b\u6765\uff0c\u5bf9\u6bd4 apisixroute \u4ecd\u6709\u4e00\u5b9a\u7684\u5dee\u8ddd\uff09</li> <li>\u652f\u6301\u591a\u96c6\u7fa4\u7ba1\u7406\uff1a\u4e00\u5957 apisix \u53ef\u4ee5\u4ee3\u7406\u591a\u5957\u96c6\u7fa4\uff0c\u67d0\u4e9b\u573a\u666f\u4e0b\u786e\u5b9e\u5b58\u5728\u8fd9\u79cd\u9700\u6c42\u3002\uff08\u5f00\u6e90\u7684 nginx-ingress-controller \u5c31\u4e0d\u80fd\u4e00\u5957\u7f51\u5173\u4ee3\u7406\u591a\u5957 k8s \u96c6\u7fa4\uff09</li> <li>\u652f\u6301\u5bf9\u63a5\u591a\u79cd\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\uff1aZooKeeper\u3001Consul\u3001Nacos\u3001kubernetes\u7b49</li> <li>\u9ad8\u6027\u80fd\u7684\u8def\u7531\u5339\u914d\u7b97\u6cd5\uff08\u7528 radixtree \u5b9e\u73b0\u4e86\u4e00\u4e2a\u8def\u7531\u5339\u914d\u7b97\u6cd5\uff09</li> </ol> <p>apisix \u5b98\u65b9\u5ba3\u79f0\u662f\u4e00\u4e2a\u52a8\u6001\u3001\u5b9e\u65f6\u3001\u9ad8\u6027\u80fd api gateway\uff0c\u524d\u4e09\u4e2a\u8bcd \u52a8\u6001\u3001\u5b9e\u65f6\u3001\u9ad8\u6027\u80fd\u5176\u5b9e\u4e0d\u662f apisix \u81ea\u8eab\u7684\u529f\u80fd\uff0c\u800c\u662f openresty(nginx) \u7684\u529f\u80fd\u3002</p> <ul> <li>\u9ad8\u6027\u80fd: apisix \u5e95\u5c42\u4f9d\u6258\u4e8e\u9ad8\u6027\u80fd\u7684 nginx+luajit(openresty)\uff0c\u5f53\u7136\u8fd9\u4e2a\u9ad8\u6027\u80fd\u662f\u8ddf java \u4e4b\u7c7b\u7684\u7f51\u5173\u76f8\u6bd4\uff0c\u5982\u679c\u8ddf envoy \u6216\u8005\u4e00\u4e9b\u4f7f\u7528 rust \u5199\u7684\u7f51\u5173\u6bd4\u7684\u8bdd\uff0c\u6027\u80fd\u5e73\u5206\u79cb\u8272\uff0c\u6ca1\u6709\u7edd\u5bf9\u7684\u4f18\u52a3\u3002</li> <li>\u9ad8\u7a33\u5b9a\u6027\uff1a\u7a33\u5b9a\u662f\u4f5c\u4e3a\u7f51\u5173\u6700\u6838\u5fc3\u7684\u8981\u7d20\uff0c\u800c\u5e95\u5c42\u7684 nginx \u4f5c\u4e3a\u4e00\u4e2a\u5165\u53e3\u7f51\u5173\uff0c\u7ecf\u8fc7\u4e86\u51e0\u5341\u5e74\u7684\u53d1\u5c55\uff0c\u4f7f\u7528\u57fa\u6570\u4e5f\u5f88\u5e9e\u5927\uff0c\u5f88\u591a\u7279\u6b8a\u9700\u6c42\u573a\u666f\u90fd\u8003\u8651\u5230\uff0c\u8fd9\u4e2a\u4ece  nginx \u5927\u91cf\u53ef\u914d\u7f6e\u7684\u53c2\u6570\u5c31\u80fd\u591f\u611f\u53d7\u5230\u3002\u800c\u5982\u679c\u4f7f\u7528\u4e00\u4e2a\u5168\u65b0\u7684\u7f51\u5173\u5e95\u5ea7\uff0c\u8bf4\u4e0d\u5b9a\u54ea\u5929\u5c31\u4f1a\u9047\u5230\u4e00\u4e2a\u5751\u3002</li> <li>\u52a8\u6001\uff1a\u4e0d\u4ec5\u4fee\u6539\u914d\u7f6e\u65e0\u9700\u91cd\u542f\u670d\u52a1\uff0c\u751a\u81f3\u4fee\u6539 luajit \u7684\u4ee3\u7801\u4e5f\u65e0\u9700\u91cd\u542f\u670d\u52a1\u3002\u8fd9\u5bf9\u4e8e\u7f51\u5173\u8fd9\u79cd\u96f6\u505c\u670d\u8981\u6c42\u7684\u57fa\u7840\u8bbe\u65bd\u6765\u8bf4\uff0c\u662f\u975e\u5e38\u91cd\u8981\u7684\u529f\u80fd\u3002\u6bd4\u5982\u5bf9\u4e8e\u957f\u8fde\u63a5\u7684\u8bf7\u6c42\uff0c\u8fd9\u4e2a\u8fde\u63a5\u53ef\u80fd\u5b58\u5728\u51e0\u4e2a\u5c0f\u65f6\u751a\u81f3\u51e0\u5929\uff0c\u5982\u679c\u76f4\u63a5\u91cd\u542f\u7f51\u5173\u670d\u52a1\uff0c\u5c31\u4f1a\u9020\u6210\u5f71\u54cd\u3002\u7b14\u8005\u8ba4\u4e3a\u8fd9\u662f openresty \u65f6\u81f3\u4eca\u65e5\u4f9d\u7136\u65e0\u53ef\u66ff\u4ee3\u7684\u4f18\u70b9\uff0c\u76ee\u524d\u51e0\u4e4e\u6ca1\u6709\u5176\u4ed6\u8bed\u8a00\u6216\u8005\u6846\u67b6\u5b9e\u73b0\u8fd9\u4e00\u7279\u6027\u3002\u56e0\u4e3a\u5bf9\u4e8e\u9759\u6001\u7f16\u8bd1\u8bed\u8a00\u6765\u8bf4\uff0c\u7b26\u53f7\u4e4b\u95f4\u7684\u5f15\u7528\u5173\u8054\u975e\u5e38\u590d\u6742\uff0c\u5f88\u96be\u5b9e\u73b0\u89e3\u8026\u3002\u7b14\u8005\u81ea\u5df1\u5728\u505a\u4e00\u4e9b\u8f6f\u4ef6\u7684\u65f6\u5019\uff0c\u66fe\u7ecf\u4e5f\u5b9e\u73b0\u8fc7\u4e00\u4e9b reload \u7684\u529f\u80fd\uff0c\u53d1\u73b0\u8fd9\u5e76\u975e\u662f\u4e00\u4ef6\u6613\u4e8b\u3002\u800c nginx \u7684\u5185\u90e8\u7ec4\u4ef6\u4f9d\u8d56\u5173\u7cfb\u8981\u66f4\u52a0\u590d\u6742\u7684\u591a\uff0c\u53ef\u4ee5\u60f3\u8c61\u8fd9\u662f\u4e00\u4ef6\u96be\u5ea6\u5f88\u5927\u7684\u4e8b\u60c5\u3002</li> </ul>"},{"location":"chap12/9apigateway2024/#apisix_1","title":"\u5f53\u7136 apisix \u4e5f\u5b58\u5728\u4e00\u4e9b\u7f3a\u70b9\uff1a","text":"<ul> <li>\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u63d2\u4ef6\u8d28\u91cf\u4e0d\u9ad8\uff0c\u6ca1\u6709\u7ecf\u8fc7\u8f83\u5927\u89c4\u6a21\u7684\u751f\u4ea7\u73af\u5883\u7684\u9a8c\u8bc1\u3002\u7b14\u8005\u66fe\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u8fc7\u51e0\u6b3e apisix \u5b98\u65b9\u7684\u63d2\u4ef6\uff0c\u5747\u51fa\u73b0\u8fc7\u4e00\u4e9b\u5c0f\u95ee\u9898\u3002</li> <li>apisix \u4f7f\u7528 etcd \u4f5c\u4e3a\u5b83\u7684\u6570\u636e\u5b58\u50a8\uff0cetcd v3 \u4f7f\u7528\u7684\u662f grpc \u534f\u8bae(\u5e95\u5c42 http2 \u534f\u8bae)\uff0c\u4f46\u662f\u7531\u4e8e openresty \u751f\u6001\u4e00\u76f4\u90fd\u7f3a\u4e4f\u4e00\u4e2a http 2.0 \u5ba2\u6237\u7aef\uff08\u4e00\u662f http2.0 \u672c\u8eab\u8f83\u590d\u6742\uff0c\u4e8c\u662f cosocket \u4e5f\u5f88\u96be\u5b9e\u73b0 http2.0\uff09\uff0capisix \u5b98\u65b9\u53ea\u80fd\u5728 http1.1 \u57fa\u7840\u4e0a\uff0c\u901a\u8fc7 long poll \u7684\u65b9\u5f0f\u4e0e etcd \u8fdb\u884c\u901a\u8baf\uff0c\u8fd9\u5c31\u5bfc\u81f4\u6bcf\u4e2a nginx worker \u8981\u4e0e etcd \u5efa\u7acb\u591a\u4e2a\u8fde\u63a5\uff0c\u800c\u5982\u679c\u4f7f\u7528 http2.0 \uff0c\u90a3\u4e48\u6bcf\u4e2a worker \u53ea\u8981\u5efa\u7acb\u4e00\u4e2a\u8fde\u63a5\u5373\u53ef\u3002\u9664\u6b64\u4e4b\u5916 apisix \u5b98\u65b9\u5b9e\u73b0\u7684 lua-resty-etcd\uff0c\u5b58\u5728\u67d0\u4e9b\u95ee\u9898\uff0c\u6bd4\u5982\u5f53\u4f60 watch \u7684\u7248\u672c\u53f7\u88ab etcd \u538b\u7f29\u540e\uff0cetcd \u5c31\u4f1a\u53d6\u6d88\u8fd9\u4e2a watcher\uff0c\u4f60\u9700\u8981\u91cd\u5efa watcher\uff0c\u800c\u4e4b\u524d apisix \u5374\u6ca1\u6709\u5904\u7406\u8fd9\u4e2a\u9519\u8bef\uff0c\u5bfc\u81f4\u95ee\u9898\uff08\u76ee\u524d\u8be5\u95ee\u9898\u5df2\u7ecf\u4fee\u590d\uff09\u3002\u8fd9\u91cc\u5bf9\u6bd4\u5176\u4ed6\u57fa\u4e8e openresty \u5f00\u53d1\u7684\u7f51\u5173\uff0ckong \u5c31\u662f\u4f7f\u7528 pg \u4f5c\u4e3a\u5b83\u7684\u6570\u636e\u5e93\uff0c\u800c PG \u6709\u6210\u719f\u7a33\u5b9a\u7684\u5f00\u6e90\u5e93\uff0c\u5b83\u5c31\u4e0d\u4f1a\u9047\u5230 apisix \u7684\u8fd9\u4e9b\u95ee\u9898\u3002</li> <li>apisix \u652f\u6301 webassemby\uff0c\u4f46\u662f\u5b83\u5b9e\u73b0\u7684 runtime \u8fd8\u662f\u8fc7\u4e8e\u7b80\u964b\uff0c\u66b4\u9732\u51fa\u6765\u7684\u63a5\u53e3\u592a\u5c11\uff0c\u8fbe\u4e0d\u5230\u751f\u4ea7\u53ef\u7528\u7684\u72b6\u6001\u3002\u53e6\u5916\u867d\u7136\u4e5f\u652f\u6301 java/go/php \u7b49 \u5176\u4ed6\u8bed\u8a00\u5199\u63d2\u4ef6\uff0c\u4f46\u662f\u4e00\u65e6\u7528\u4e86\u8fd9\u4e9b\u8bed\u8a00\u5199\u7684\u63d2\u4ef6\uff0c\u6027\u80fd\u5c31\u4f1a\u6307\u6570\u7ea7\u4e0b\u964d\u3002\u76ee\u524d\u53ea\u6709\u7528 luajit \u5199\u7684\u63d2\u4ef6\u624d\u4f1a\u6709\u9ad8\u6027\u80fd\u3002</li> </ul>"},{"location":"chap12/9apigateway2024/#openresty","title":"OpenResty","text":"<p>\u5f00\u6e90\u793e\u533a\u4e2d\u57fa\u4e8e openresty \u63a8\u51fa\u7684 apigateway \u4ea7\u54c1\u6709 apisix \u548c kong\uff0c\u7b14\u8005\u4e4b\u524d\u4e00\u76f4\u6709\u4e2a\u7591\u95ee\uff0c\u4e3a\u4ec0\u4e48 openresty \u4e0d\u63a8\u51fa\u81ea\u5df1\u7684 ingress \u7f51\u5173\u548c apigateway \u4ea7\u54c1\uff0c\u540e\u6765\u4e86\u89e3\u5230\uff0copenresty \u5b98\u65b9\u5176\u5b9e\u6709\u5bf9\u5e94\u7684\u5546\u4e1a\u4ea7\u54c1 openresty edge\uff0c\u53ea\u662f\u6ca1\u6709\u5f00\u6e90\u3002</p> <p>\u6beb\u65e0\u7591\u95ee\uff0c\u8fc7\u53bb 10 \u5e74\u7531 Kubernetes \u4ee3\u8868\u7684\u4e91\u539f\u751f\u65b9\u5411\u662f IT \u57fa\u7840\u8bbe\u65bd\u9886\u57df\u6700\u706b\u7684\u4e00\u4e2a\u6280\u672f\u65b9\u5411\u3002\u5176\u4e2d kubernetes \u7684\u4e00\u4e2a\u6838\u5fc3\u7406\u5ff5\u5c31\u662f pod \u7684\u52a8\u6001\u53d8\u5316\uff0c\u800c\u8fd9\u4e2a\u7406\u5ff5\u4e0e openresty \u7684\u52a8\u6001\u4e0d\u8c0b\u800c\u5408\uff08\u5148\u6709 openresty\uff0c\u540e\u6709 kubernetes\uff09\uff0c\u6240\u4ee5 kubernetes \u5b98\u65b9\u6240\u63a8\u51fa\u7684 nginx-ingress-controller \u7684\u5e95\u5c42\u5c31\u662f\u4f7f\u7528 nginx-lua-module \uff08openresty \u7684\u6838\u5fc3\u6a21\u5757\uff09\u6240\u5b9e\u73b0</p> <p>\u53e6\u5916\u4f9d\u6258\u4e8e kubernetes \u6240\u8bde\u751f\u7684 service mesh \u6280\u672f\uff0c\u5b83\u7684\u6570\u636e\u9762\u76ee\u524d\u4f7f\u7528\u7684\u662f envoy\uff0c\u5176\u5b9e\u5728\u65e9\u671f\u7684\u65f6\u5019\uff0c\u8c37\u6b4c\u6700\u5f00\u59cb\u7684\u8ba1\u5212\u662f\u4f7f\u7528 nginx\uff0c\u4f46\u662f\u7531\u4e8e\u4e00\u4e9b\u95ee\u9898\u6700\u7ec8\u653e\u5f03\u4e86 nginx\u3002</p> <p>luajit\uff1a</p> <ul> <li>\u751f\u6001\u8f83\u5dee\uff0c\u6bd4\u5982\u4f60\u8981\u628a\u6570\u636e\u53d1\u9001\u5230 kafka\uff0c\u6216\u8005\u4ece zookeeper \u62ff\u70b9\u6570\u636e\uff0c\u5c31\u4f1a\u7f3a\u5c11\u7a33\u5b9a\u7684\u5f00\u6e90\u5e93\uff08\u6709\u4e9b\u573a\u666f\u867d\u7136\u5b58\u5728\u5f00\u6e90\u5e93\uff0c\u4f46\u662f\u7a33\u5b9a\u6027\u53c8\u4e0d\u591f\uff09\u3002\u552f\u4e00\u7684\u89e3\u51b3\u529e\u6cd5\u5c31\u662f\u4ee3\u7406\u5230\u522b\u7684\u670d\u52a1\u53bb\u505a\uff0c\u5982\u679c\u8fd9\u6837\u4e3a\u4f55\u8981\u7528\uff1f</li> <li>luajit \u7684\u9ad8\u6027\u80fd\u662f\u5efa\u7acb\u5728\u80fd\u591f jit \u7684\u60c5\u51b5\u4e0b\uff0c\u4f46\u662f\u5b9e\u9645\u5f88\u96be 100% \u4fdd\u8bc1 jit\uff0c\u7ecf\u5e38\u9047\u5230\u4e0d\u80fd jit \u7684\u60c5\u51b5\u3002</li> </ul>"},{"location":"chap12/9apigateway2024/#nginx","title":"nginx \u591a\u8fdb\u7a0b\u67b6\u6784\uff1a","text":"<ul> <li>\u8bbf\u95ee nginx \u7684\u8bf7\u6c42\u88ab\u8c03\u5ea6\u5230\u54ea\u4e2a\u8fdb\u7a0b\u5176\u5b9e\u662f\u968f\u673a\uff0c\u5982\u679c\u4e00\u4e2a\u8fdb\u7a0b\u6240\u5904\u7406\u7684\u8fde\u63a5\u91cc\u9762\u7684http\u8bf7\u6c42\u5f88\u591a\u5f88\u7e41\u5fd9\uff0c\u90a3\u4e48\u5b83\u4e5f\u65e0\u6cd5\u59d4\u6258\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6765\u4ee3\u52b3\uff0c\u5373\u4fbf\u5176\u4ed6\u8fdb\u7a0b\u662f\u7a7a\u95f2\u7684\u3002\u8fd9\u70b9\u5bf9\u4e8e\u6700\u65b0\u7684 http2 \u800c\u8a00\u975e\u5e38\u660e\u663e\uff0c\u56e0\u4e3a http2.0 \u4e00\u65e6\u5efa\u7acb\u4e86\u4e00\u4e2a\u8fde\u63a5\uff0c\u5b83\u5c31\u53ea\u80fd\u56fa\u5b9a\u5728\u4e00\u4e2a\u8fdb\u7a0b\u91cc\u9762\uff0c\u8fd9\u5e26\u6765\u7684\u95ee\u9898\u5c31\u662f\u524d\u7aef\u5e94\u7528\u5728\u8fc1\u79fb\u5230 http2.0 \u4e4b\u540e\uff0c\u5982\u679c\u9047\u5230 nginx worker \u7e41\u5fd9\uff0c\u5b83\u7684 TTFB\uff08\u9996\u5b57\u8282\u65f6\u95f4\uff09\u6027\u80fd\u4e0b\u964d\u3002</li> <li>\u591a\u8fdb\u7a0b\u4e4b\u95f4\u65e0\u6cd5\u5b89\u5168\u5730\u5171\u4eab\u8d44\u6e90\u3002nginx\u7684\u65b9\u6848\u662f\u653e\u6570\u636e\u5728\u5171\u4eab\u5185\u5b58\u91cc\u9762\uff0c\u5e76\u4e14\u53ea\u80fd\u5c06\u5b57\u7b26\u4e32\u548c\u6570\u5b57\u653e\u5165\u5171\u4eab\u5185\u5b58\uff0c\u6bcf\u6b21\u8bbf\u95ee\u5171\u4eab\u5185\u5b58\u90fd\u5fc5\u987b\u4f7f\u7528\u4e92\u65a5\u9501\u3002openresty \u7684 share_dict \u5c31\u662f\u653e\u5728\u5171\u4eab\u5185\u5b58\u4e2d\u7684\u7ea2\u9ed1\u6811\uff0c\u6bcf\u6b21\u5bf9\u5b83\u8fdb\u884c\u4fee\u6539\uff0c\u5c31\u8981\u6d89\u53ca\u591a\u4e2a\u5730\u65b9\u7684\u6539\u52a8\uff08\u7ea2\u9ed1\u6811\u7684\u64cd\u4f5c\u6bd4\u8f83\u590d\u6742\uff0c\u6d89\u53ca\u8f83\u591a\u7684\u4ee3\u7801\uff09\uff0c\u800c\u5982\u679c\u5728\u6539\u52a8\u671f\u95f4\uff0c\u6070\u597d worker \u8fdb\u7a0b\u5d29\u6e83\u4e86\uff0c\u867d\u7136 nginx \u4f1a\u6355\u83b7 SIGCHILD \u4fe1\u53f7\uff0c\u8fdb\u884c\u91ca\u653e\u9501\uff0c\u4f46\u662f\u7236\u8fdb\u7a0b\u5e76\u4e0d\u4f1a\u5bf9\u8fd9\u4e9b\u64cd\u4f5c\u5230\u4e00\u534a\u7684\u8fc7\u7a0b\u8fdb\u884c\u64a4\u9500\u6062\u590d\uff0c\u5bfc\u81f4\u6570\u636e\u5904\u4e8e\u4e00\u4e2a\u8be1\u5f02\u7684\u72b6\u6001\u3002</li> </ul>"},{"location":"chap12/9apigateway2024/#ingress-controller","title":"ingress-controller","text":"<p>\u7531\u4e8e kubernetes \u8d8a\u6765\u8d8a\u6d41\u884c\uff0c\u65b0\u65f6\u4ee3\u7684 api gateway \u5fc5\u987b\u8981\u652f\u6301 kuberentes/ingress\u3002\u76ee\u524d\u8c37\u6b4c\u5b98\u65b9\u4e3a kubernetes  ingress \u63a8\u51fa\u7684\u4ea7\u54c1\u662f nginx-ingress-controller \uff0c\u4f46\u662f\u5b83\u7684\u95ee\u9898\u5728\u4e8e\uff0c\u6570\u636e\u9762\u4e0e\u63a7\u5236\u9762\u7ed1\u5b9a\u5728\u4e00\u8d77\uff08\u4e00\u4e2a pod \u4e2d\u542b\u6709\u4e24\u4e2a\u5bb9\u5668\uff09\uff0c\u8fd9\u5c31\u5bfc\u81f4\u5b83\u7684\u6a2a\u5411\u6269\u5c55\u80fd\u529b\u53d7\u9650\u3002\u5bf9\u4e8e\u4e00\u5bb6\u5927\u578b\u516c\u53f8\u6765\u8bf4\uff0c\u5b83\u7684\u6d41\u91cf\u53ef\u80fd\u4f1a\u975e\u5e38\u7684\u5e9e\u5927\uff0c\u90a3\u4e48\u5b83\u7684\u6570\u636e\u9762\u9700\u8981\u7684\u8282\u70b9\u6570\u91cf\u53ef\u80fd\u4f1a\u6709\u51e0\u5341\u4e0a\u767e\u4e2a\uff0c\u8fd9\u5c31\u5bfc\u81f4\u63a7\u5236\u9762\u4e5f\u76f8\u5e94\u7684\u589e\u52a0\uff0c\u4ece\u800c\u5bf9 k8s \u4ea7\u751f\u4e00\u5b9a\u7684\u538b\u529b\u3002</p> <p>\u53e6\u5916\u9488\u5bf9\u5927\u89c4\u6a21 k8s \u96c6\u7fa4\uff0c\u63a7\u5236\u9762\u7684\u5185\u5b58\u6d88\u8017\u4e5f\u4f1a\u6bd4\u8f83\u591a\uff08\u9700\u8981\u5728\u672c\u5730\u5185\u5b58\u4e2d\u7f13\u5b58\u6240\u6709\u7684 pod/service/endpoint/ingress \u7684\u8d44\u6e90\uff09\u3002</p> <p>apisix \u5b98\u65b9\u63a8\u51fa\u7684 apisix-ingress-controller \u8ba9 apisix \u652f\u6301 kubernetes \u4f5c\u4e3a\u670d\u52a1\u53d1\u73b0\uff0c\u5e76\u4e14\u662f\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u5206\u79bb\u7684\u67b6\u6784\u3002\u5176\u539f\u7406\u662f apisix-ingress-controller watch kubernetes resource \u7684\u53d8\u5316\uff0c\u5c06\u6570\u636e\u540c\u6b65\u5199\u5165\u5230 apisix \u7684 etcd \u4e2d\uff0c\u4f46\u76ee\u524d\u5b98\u65b9 apisix-ingress-controller \u5b58\u5728\u4e00\u4e9b\u95ee\u9898\uff1a</p> <ol> <li>\u76ee\u524d\u5b98\u65b9 apisix-ingress-controller  \u5bf9 ingress/service \u7684\u652f\u6301\u4e0d\u591f\u5b8c\u5584\uff0c\u90e8\u5206\u7279\u6027\u4f9d\u7136\u4e0d\u652f\u6301\uff08\u90e8\u5206 ingress \u7684 annotation \u4e0d\u652f\u6301\uff09\u3002\u5176\u5b9e apisix-ingress-controller \u63a8\u8350\u4f7f\u7528 apisix \u81ea\u5df1\u7684 apisixroute/apisixupstream \u7b49 CRD</li> <li>apisix-ingress-controller \u7684\u4ee3\u7801\u8d28\u91cf\u4e0d\u9ad8\u7684\uff0c\u5f88\u591a\u6a21\u5757\u8026\u5408\u4e25\u91cd\uff0c\u5e76\u4e14\u6709\u4e00\u4e9b bug</li> </ol> <p>apisix \u9700\u8981\u4e00\u4e2aetcd \u6765\u5b58\u50a8\u6570\u636e\uff0c\u800c apisix-ingress-controller \u7684\u672c\u8d28\u5374\u662f\u4f7f\u7528 k8s \u7684 etcd \uff0c\u4f60\u4f1a\u53d1\u73b0\u8fd9\u91cc\u6709\u4e24\u4e2a etcd\u3002\u5982\u679c apisix \u9700\u8981\u540c\u65f6\u4ee3\u7406 kuberentes \u7684\u6d41\u91cf\u548c\u975e kubernetes \u7684\u6d41\u91cf\uff0c\u4e24\u5957 etcd \u6ca1\u6709\u95ee\u9898\uff0c\u4f46\u5982\u679c apisix \u53ea\u4ee3\u7406 kubernetes \u7684\u6d41\u91cf\u7684\u8bdd\uff0c\u4e25\u683c\u6765\u8bf4\u53ea\u9700\u8981\u4e00\u5957\u5b58\u50a8\uff0c\u5e76\u4e14\u59cb\u7ec8\u5e94\u8be5\u4ee5 kubernetes \u7684\u6570\u636e\u4e3a\u51c6\u3002\u4e24\u5957\u5b58\u50a8\u4e0d\u4ec5\u589e\u52a0\u7ef4\u62a4\u7684\u6210\u672c\uff0c\u8fd8\u4f1a\u5e26\u6765\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\u3002</p> <p>\u6240\u4ee5\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u5f0a\u7aef\uff0c\u5728\u65b0\u7248\u672c\u7684 apisix-ingress-controller \u4e2d\u5b9e\u73b0\u4e86 etcd server \u7684\u529f\u80fd\uff0c\u8ba9 apisix \u76f4\u63a5\u4ece apisix-ingress-controller \u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u5927\u5e45\u4f18\u5316\u4e86\u7cfb\u7edf\u67b6\u6784\u3002</p>"},{"location":"chap2/10chap3_mesh/","title":"\u7b2c\u5341\u8282 Mesh\u7684\u672a\u6765\u53d1\u5c55\u4e0e\u53ef\u884c\u6027\u65b9\u5411","text":""},{"location":"chap2/10chap3_mesh/#1-mesh","title":"1\u3001\u4e2d\u95f4\u4ef6 Mesh \u5316\u7684\u53ef\u884c\u6027","text":"<p>Service Mesh \u4e3b\u8981\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5305\u62ec\u8fb9\u7f18\u7f51\u5173\u7684\u5357\u5317\u5411\u6d41\u91cf\u548c\u5185\u90e8\u901a\u4fe1\u7684\u4e1c\u897f\u5411\u6d41\u91cf\u3002</p> <ul> <li>Service Mesh \u4e3b\u8981\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf</li> <li>\u670d\u52a1\u548c\u4e2d\u95f4\u4ef6\u901a\u4fe1\u7684\u6d41\u91cf\u4e5f\u975e\u5e38\u91cd\u8981\uff0c\u662f\u672a\u6765\u6574\u4e2a\u5fae\u670d\u52a1 Mesh \u5316\u4e2d\u91cd\u8981\u7684\u4e00\u73af\u3002</li> </ul> <p>FaaS\uff08Function as a Service\uff09\u4e5f\u662f\u672a\u6765\u5fae\u670d\u52a1\u67b6\u6784\u91cd\u8981\u7684\u6f14\u8fdb\u65b9\u5411\u4e4b\u4e00\uff0c\u5728 FaaS \u67b6\u6784\u4e2d\uff0cService Mesh \u540c\u6837\u53ef\u4ee5\u4f5c\u4e3a\u5e95\u5c42\u57fa\u7840\u8bbe\u65bd\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\u3002</p>"},{"location":"chap2/10chap3_mesh/#1-1-mesh","title":"1-1 \u4e2d\u95f4\u4ef6 Mesh \u5316","text":"<p>\u8457\u540d\u7684\u6570\u636e\u9762\u5df2\u7ecf\u652f\u6301\u4e86\u8bf8\u591a\u6570\u636e\u5e93\u548c\u961f\u5217\u4e2d\u95f4\u4ef6</p> <p> </p>"},{"location":"chap2/10chap3_mesh/#1-2-redis","title":"1-2 Redis \u4ee3\u7406","text":"<p>Envoy \u53ef\u4ee5\u4f5c\u4e3a Redis \u7684\u4ee3\u7406\uff0c\u90e8\u7f72\u5728\u6bcf\u4e2a\u670d\u52a1\u7684\u8282\u70b9\u4e0a\uff0c\u8fd9\u6837\u5c31\u65e0\u987b\u4f20\u7edf\u7684 Redis \u4e2d\u95f4\u4ef6\u8d1f\u8d23 Redis \u96c6\u7fa4\u7684\u4ee3\u7406\u5de5\u4f5c\uff0c\u4e5f\u4e0d\u9700\u8981\u4f20\u7edf Redis \u5b98\u65b9\u63d0\u4f9b\u7684 Smart Client\u3002</p> <p>Envoy \u53ef\u4ee5\u66ff\u4ee3\u8fd9\u90e8\u5206\u529f\u80fd\uff0c\u63a7\u5236 Redis \u96c6\u7fa4\uff0c\u8def\u7531\u5230\u6b63\u786e\u7684 hash \u5206\u7247\u8282\u70b9\u4e0a\u3002</p> <p>\u4f7f\u7528 Envoy \u505a Redis \u4ee3\u7406\uff0c\u65e2\u907f\u514d\u4e86\u4f20\u7edf\u7684 Smart Client \u7684\u5347\u7ea7\u7ef4\u62a4\u95ee\u9898\uff0c\u4e5f\u907f\u514d\u4e86\u4f20\u7edf\u7684 Redis \u4e2d\u95f4\u4ef6\u4e2d\u5fc3\u5316\u7684\u95ee\u9898\u3002</p> <p>\u901a\u8fc7 Mesh \u7684\u67b6\u6784\u3001Metrics \u6ce8\u5165\u7b49\u65b9\u5f0f\uff0c\u53ef\u4ee5\u770b\u5230\u5230\u5e95\u662f\u54ea\u4e2a\u670d\u52a1\u8c03\u7528\u7684 Redis\uff0c\u518d\u914d\u5408\u670d\u52a1\u95f4\u7684\u94fe\u8def\u8c03\u7528\u56fe\uff0c\u8fd9\u6837\u6574\u4e2a\u5185\u7f51\u95f4\u6240\u6709\u6d41\u91cf\u7684\u94fe\u8def\u8c03\u7528\u56fe\u5c31\u53ef\u4ee5\u7ed8\u5236\u51fa\u6765\u4e86\u3002</p> <p>\u76ee\u524d Envoy \u7684 Redis \u4ee3\u7406\u652f\u6301\u4ee5\u4e0b\u529f\u80fd\uff1a</p> <ul> <li>Redis \u534f\u8bae\u7684\u7f16\u89e3\u7801\uff1b</li> <li>\u57fa\u4e8e\u54c8\u5e0c\u7684\u5206\u7247\uff1b</li> <li>Ketama \u4e00\u81f4\u6027\u54c8\u5e0c\u7b97\u6cd5\uff1b</li> <li>\u8be6\u7ec6\u7684\u6570\u636e\u7edf\u8ba1\u4fe1\u606f\uff1b</li> <li>\u5bf9\u4e8e Redis \u8282\u70b9\u7684\u4e3b\u52a8\u548c\u88ab\u52a8\u5065\u5eb7\u68c0\u67e5\uff1b</li> <li>\u4e0a\u6e38\u4ee3\u7406\u548c\u4e0b\u6e38\u4ee3\u7406\u5206\u522b\u8fdb\u884c\u8eab\u4efd\u8ba4\u8bc1\u3002</li> </ul> <p> </p> <p>Envoy \u5bf9\u4e8e Redis \u7684\u652f\u6301\u76f8\u5bf9\u6bd4\u8f83\u7b80\u5355\uff0c\u5f53\u7136\u672a\u6765\u793e\u533a\u4e5f\u5728\u89c4\u5212\u652f\u6301\u66f4\u591a\u7684\u529f\u80fd\uff0c\u5305\u62ec\u7194\u65ad\u3001\u94fe\u8def\u8ffd\u8e2a\u3001\u91cd\u8bd5\u7b49</p> <p>\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u4ea7\u54c1\uff08\u6bd4\u5982 Redis \u96c6\u7fa4\u4e2d\u95f4\u4ef6\u3001MySQL \u96c6\u7fa4\u4e2d\u95f4\u4ef6\uff09\u7684\u529f\u80fd\u4e3b\u8981\u662f\u5bf9\u6570\u636e\u505a\u5206\u7247\u5904\u7406\uff0c\u4ee5\u89e3\u51b3\u5355\u4e2a Redis \u6216\u8005 MySQL \u8282\u70b9\u65e0\u6cd5\u5904\u7406\u7684\u8d1f\u8f7d\u3002</p> <p>\u8fd9\u4e9b\u529f\u80fd\u6700\u65e9\u4e5f\u5728 SDK \u4e2d\uff0c\u56e0\u4e3a\u7ef4\u62a4\u5347\u7ea7\u4e0d\u65b9\u4fbf\uff0c\u6240\u4ee5\u6f14\u8fdb\u6210\u4e86\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u3002\u968f\u7740 Mesh \u5316\u67b6\u6784\u7684\u6d41\u884c\uff0c\u5728\u670d\u52a1\u672c\u5730\u90e8\u7f72\u4e00\u4e2a Sidecar\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u4ea7\u54c1\u4e2d\u5fc3\u5316\u7684\u95ee\u9898\u3002</p> <p>\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u7684 Mesh \u5316\u548c\u4f20\u7edf\u7684\u670d\u52a1 Mesh \u5316\uff0c\u5173\u6ce8\u7684\u70b9\u7565\u6709\u4e0d\u540c\uff1a</p> <p>\u6570\u636e\u5e93\u7684\u4e2d\u95f4\u4ef6\u4ea7\u54c1\u66f4\u5173\u6ce8\u7684\u662f\u5bf9\u4e8e\u6570\u636e\u7684\u5206\u7247\u5904\u7406\uff0c\u6bd4\u5982 MySQL \u7684\u5206\u5e93\u5206\u8868\u7b49\u7b97\u6cd5\u3001Redis \u96c6\u7fa4\u7684\u5206\u7247\u7b97\u6cd5\u7b49\u3002\u4f46\u4e5f\u6709\u5f88\u591a\u529f\u80fd\u662f\u901a\u7528\u7684\uff0c\u6bd4\u5982\u9650\u6d41\u7194\u65ad\u7b49\u6cbb\u7406\u529f\u80fd\u3001\u94fe\u8def\u8ffd\u8e2a\u3001Metrics \u76d1\u63a7\uff0c\u751a\u81f3\u670d\u52a1\u53d1\u73b0\u7b49\u529f\u80fd\u3002</p>"},{"location":"chap2/10chap3_mesh/#1-3-faas","title":"1-3 FaaS","text":"<p>FaaS\uff08Function as a Service\uff09\u662f\u4e00\u79cd\u5728\u65e0\u72b6\u6001\u5bb9\u5668\u4e2d\u8fd0\u884c\u7684\u4e8b\u4ef6\u9a71\u52a8\u6a21\u578b\u3002</p> <p>\u7b80\u5355\u6765\u8bf4\uff0cFunction \u662f\u6bd4 Service \u66f4\u5c0f\u7684\u7a0b\u5e8f\u5355\u5143\uff0c\u5982\u679c\u8981\u8fdb\u884c\u6807\u51c6\u5316\u7684 FaaS \u5316\u6539\u9020\uff0c\u5c31\u9700\u8981\u8fdb\u4e00\u6b65\u62c6\u5206\uff0c\u5c06\u5fae\u670d\u52a1\u4e2d\u7684\u6bcf\u4e2a\u65b9\u6cd5\u90fd\u62c6\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u670d\u52a1\u3002</p> <p>FaaS \u4f9d\u7136\u662f\u4e00\u79cd\u975e\u5e38\u7406\u60f3\u5316\u7684\u67b6\u6784\uff0c\u6bd4\u5982\u5728\u670d\u52a1 0 \u8282\u70b9\u7684\u60c5\u51b5\u4e0b\u8981\u6d88\u8017\u5927\u91cf\u7684\u65f6\u95f4\u7b49\u5f85\u670d\u52a1\u542f\u52a8\uff0c\u4f46 FaaS \u4e2d\u7684\u4e00\u4e9b\u6838\u5fc3\u601d\u60f3\uff0c\u4f9d\u7136\u662f\u5fae\u670d\u52a1\u67b6\u6784\u7684\u53d1\u5c55\u8d8b\u52bf\uff0c\u6216\u8005\u8bf4\u5b83\u4eec\u53ef\u4ee5\u76f4\u63a5\u843d\u5730\uff0c\u6bd4\u5982\u5f3a\u5927\u7684\u81ea\u52a8\u6269\u7f29\u5bb9\u80fd\u529b\u3001\u57fa\u4e8e\u5f02\u6b65\u7684\u4e8b\u4ef6\u9a71\u52a8\u6a21\u578b\u7b49</p> <p>FaaS \u7684\u5f00\u6e90\u65b9\u6848\u6709 Knative\u3001OpenFaaS\u3001Fission\u3001Kubeless \u7b49\uff0c\u4e0b\u9762\u6211\u4eec\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u51e0\u79cd\u5e38\u89c1\u7684\u5f00\u6e90\u65b9\u6848\u3002</p> <p> </p> <ul> <li>Knative</li> </ul> <p>Knative \u662f\u8c37\u6b4c\u7275\u5934\u53d1\u8d77\u7684 Serverless \u9879\u76ee\uff0c\u662f\u57fa\u4e8e Kubernetes \u548c Istio \u7684 Serverless \u89e3\u51b3\u65b9\u6848\u3002</p> <ul> <li>OpenFaaS</li> </ul> <p>OpenFaaS \u662f\u4e00\u4e2a\u4f7f\u7528 Docker \u6784\u5efa\u65e0\u670d\u52a1\u5668\uff08Serverless\uff09\u529f\u80fd\u7684\u6846\u67b6\uff0c\u53ef\u4ee5\u90e8\u7f72\u5728 Kubernetes \u6216\u8005 Swarm \u5e73\u53f0\u3002\u901a\u8fc7 Watchdog \u542f\u52a8\u8fdb\u7a0b\u7684\u65b9\u5f0f\u8fdb\u884c\u51fd\u6570\u5f0f\u8c03\u7528\u3002</p> <ul> <li>Fission</li> </ul> <p>Fission \u662f\u4e00\u6b3e\u57fa\u4e8e Kubernetes \u7684 FaaS \u6846\u67b6\uff0c\u901a\u8fc7 Fission \u53ef\u4ee5\u8f7b\u800c\u6613\u4e3e\u5730\u5c06\u51fd\u6570\u53d1\u5e03\u6210 HTTP \u670d\u52a1\u3002\u5b83\u7684\u4e3b\u8981\u7279\u70b9\u662f Fission \u7ef4\u62a4\u4e00\u4e2a\u5bb9\u5668\u6c60\uff0c\u53ef\u4ee5\u505a\u5230\u51fd\u6570 100ms \u51b7\u542f\u52a8\u3002</p> <ul> <li>Kubeless</li> </ul> <p>Kubeless \u662f\u57fa\u4e8e Kubernetes \u7684 Serverless \u6846\u67b6\uff0c\u501f\u52a9 Kubernetes \u63d0\u4f9b\u81ea\u52a8\u6269\u7f29\u5bb9\u3001API \u8def\u7531\u3001\u76d1\u63a7\u7684\u529f\u80fd\u3002</p>"},{"location":"chap2/10chap3_mesh/#1-4-knative","title":"1-4 Knative","text":"<p>Knative \u5305\u542b\u4e09\u4e2a\u6838\u5fc3\u7ec4\u4ef6\uff0c\u5206\u522b\u662f\u8d1f\u8d23\u670d\u52a1\u5904\u7406\u7684 Serving\u3001\u4e8b\u4ef6\u5904\u7406\u7684 Eventing\uff0c\u4ee5\u53ca\u8d1f\u8d23\u4e91\u539f\u751f CI/CD \u6784\u5efa\u7684 Tekton\u3002</p> <ul> <li>Serving</li> </ul> <p>Knative Serving \u7ec4\u4ef6\u4f9d\u6258\u4e8e Kubernetes \u5e73\u53f0\u548c Istio\uff0c\u63d0\u4f9b\u670d\u52a1\u81ea\u52a8\u6269\u7f29\u5bb9\u3001\u670d\u52a1\u8def\u7531\u3001\u6d41\u91cf\u4ee3\u7406\u3001\u5bb9\u5668\u90e8\u7f72\u7b49\u529f\u80fd\u3002</p> <ul> <li>Eventing</li> </ul> <p>Eventing \u4e3b\u8981\u7531\u4e8b\u4ef6\u6e90\uff08EventSource\uff09\u3001\u4e8b\u4ef6\u5904\u7406\uff08Flow\uff09\u4ee5\u53ca\u4e8b\u4ef6\u6d88\u8d39\u8005\uff08EventConsumer\uff09\u4e09\u90e8\u5206\u6784\u6210\uff0c\u5b9a\u4e49\u4e86 CloudEvent \u7684\u901a\u7528\u4e8b\u4ef6\u6807\u51c6\u3002</p> <ul> <li>Tekton</li> </ul> <p>Tekton \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u4e14\u7075\u6d3b\u7684 Kubernetes \u4e91\u539f\u751f CI/CD \u5f00\u6e90\u6846\u67b6\u3002</p> <p> </p> <p>\u4e0b\u56fe\u4e2d\u7684 Route \u53ef\u4ee5\u7406\u89e3\u4e3a Istio Gateway \u7684\u89d2\u8272\u3002\u5b9e\u9645\u4e0a\uff0c\u5927\u591a\u6570 FaaS \u67b6\u6784\uff0c\u90fd\u6709\u4e00\u4e2a\u7c7b\u4f3c API Gateway \u7684\u89d2\u8272\uff0c\u4e3b\u8981\u7528\u6765\u5904\u7406\u6d41\u91cf\u7684\u8f6c\u53d1\uff0c\u5728 Pod \u6570\u91cf\u4e3a 0 \u65f6\uff0c\u4e5f\u4f1a\u505a\u4e00\u4e9b\u7279\u6b8a\u5904\u7406\uff0c\u6bd4\u5982\u6b64\u65f6\u8981 hold \u4f4f\u6d41\u91cf\uff0c\u7b49\u5f85 Pod \u542f\u52a8\u3002</p> <p> </p> <p>\u6d41\u91cf\u7ecf\u8fc7 Gateway\uff08Route\uff09\u540e\uff0c\u4f1a\u6709\u4e24\u4e2a\u5206\u652f\uff0c</p> <ul> <li>\u4e00\u4e2a\u662f\u670d\u52a1\u7684 Pod \u5b58\u5728\u7684\u65f6\u5019\uff0c\u6d41\u91cf\u4f1a\u76f4\u63a5\u8def\u7531\u5230 Pod \u4e0a\u9762\uff1b</li> <li>\u53e6\u5916\u4e00\u4e2a\u5728 Pod \u7f29\u5bb9\u5230 0 \u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u8f6c\u53d1\u5230\u4e00\u4e2a Activator \u7684\u7ec4\u4ef6\u4e2d\uff0c\u8fd9\u4e2a\u7ec4\u4ef6\u7684\u4e3b\u8981\u529f\u80fd\u662f\u5bf9\u5bb9\u5668\u8d44\u6e90\u7684\u8c03\u5ea6\u3002</li> </ul> <p>\u5f53\u6709\u6d41\u91cf\u88ab\u8f6c\u53d1\u5230 Activator \u7ec4\u4ef6\u65f6\uff0c\u5b83\u4f1a\u4e3b\u52a8\u901a\u77e5 Autoscaler \u7ec4\u4ef6\u8fdb\u884c\u6269\u5bb9\u64cd\u4f5c\uff0c\u8fd9\u65f6 Autoscaler \u4f1a\u521b\u5efa\u65b0\u7684 Pod\uff0c\u63d0\u4f9b\u670d\u52a1\u3002</p> <p>\u6b64\u65f6 Activator \u5bf9\u542f\u52a8\u7684 Pod \u8fdb\u884c\u5065\u5eb7\u68c0\u67e5\uff0c\u68c0\u67e5\u901a\u8fc7\u540e\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u76f8\u5e94\u7684 Pod \u4e0a\u9762\u3002</p> <p>Activator \u7ec4\u4ef6\u5904\u7406\u5b8c\u6d41\u91cf\u540e\uff0c\u4f1a\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9 Gateway</p> <p>\u5728\u6d41\u91cf\u88ab\u8f6c\u53d1\u5230 Activator \u7ec4\u4ef6\u8fd9\u4e2a\u5206\u652f\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c Pod \u6570\u91cf\u4e3a 0\uff0c\u672c\u6b21\u6d41\u91cf\u5904\u7406\u7684\u65f6\u95f4\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u5c31\u53d6\u51b3\u4e8e Pod \u542f\u52a8\u7684\u65f6\u95f4\uff0c\u800c\u8fd9\u4e2a\u65f6\u95f4\u5927\u6982\u7387\u662f\u79d2\u7ea7\u522b\u7684\u3002</p> <p>\u4f46\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u4e00\u822c\u7684\u8bf7\u6c42\u9700\u8981\u6beb\u79d2\u7ea7\u522b\u8fd4\u56de\u7ed3\u679c\uff0c\u79d2\u7ea7\u522b\u7684\u54cd\u5e94\u901f\u5ea6\u5f88\u96be\u63a5\u53d7\uff0c\u8fd9\u4e5f\u662f FaaS \u67b6\u6784\u76ee\u524d\u5728\u843d\u5730\u4e2d\u9762\u4e34\u7684\u6700\u5927\u95ee\u9898\uff0c\u5927\u90e8\u5206\u5bf9\u54cd\u5e94\u901f\u5ea6\u8981\u6c42\u6bd4\u8f83\u9ad8\u7684\u573a\u666f\uff0cPod \u7f29\u5bb9\u4e3a 0 \u90fd\u662f\u96be\u4ee5\u63a5\u53d7\u7684\u3002</p> <p>\u6240\u4ee5 Knative \u4e5f\u63d0\u4f9b\u4e86 Pod \u662f\u5426\u7f29\u5bb9\u5230 0 \u7684\u9009\u9879\uff0c\u8fd9\u6837\u66f4\u6709\u5229\u4e8e FaaS \u67b6\u6784\u7684\u843d\u5730\u3002\u5c3d\u7ba1\u6ca1\u6709\u505a\u5230\u5b8c\u5168\u7684 Serverless\uff0c\u4f46\u80fd\u591f\u62e5\u6709\u5f3a\u5927\u7684\u6269\u7f29\u5bb9\u80fd\u529b\u5df2\u7ecf\u975e\u5e38\u6709\u8bf1\u60d1\u529b\u4e86\u3002</p>"},{"location":"chap2/10chap3_mesh/#1-5-openfaas","title":"1-5 OpenFaaS","text":"<p>\u7edf\u7684\u5fae\u670d\u52a1\u8c03\u7528\u3002\u5728\u8fd9\u5f20\u56fe\u7247\u4e2d\uff0c\u6211\u4eec\u7684\u9700\u6c42\u662f\u4ece\u6570\u636e\u5e93\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u5e76\u6839\u636e\u83b7\u53d6\u7684\u6570\u636e\u751f\u6210\u4e00\u4e2a PDF \u6587\u4ef6\u4e0a\u4f20\u5230 S3 \u670d\u52a1\u5668\u4e2d\u3002\u4f46\u662f\u8fd9\u4e2a\u573a\u666f\u6d88\u8017\u7684\u65f6\u95f4\u4f1a\u6bd4\u8f83\u957f\uff0c\u5927\u6982\u662f 2 \u5206\u949f\u5de6\u53f3\uff0c\u800c\u4e14\u4e0b\u56fe\u7684\u540c\u6b65\u67b6\u6784\uff0c\u4f1a\u963b\u585e\u7a0b\u5e8f\u8fdb\u7a0b\uff0c\u524d\u7aef\u7684\u54cd\u5e94\u4e5f\u4f1a\u7b49\u5f85\u5f88\u957f\u65f6\u95f4\u3002</p> <p>\u5728\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u4e00\u822c\u6211\u4eec\u4e5f\u4e0d\u4f1a\u91c7\u7528\u4e0b\u56fe\u7684\u540c\u6b65\u7cfb\u7edf\uff0c\u800c\u662f\u91c7\u7528\u5f02\u6b65\u961f\u5217\u7cfb\u7edf\u89e3\u51b3\uff1a\u5c06\u751f\u6210 PDF \u4f5c\u4e3a\u4e8b\u4ef6\u5b58\u5165\u961f\u5217\u4e2d\uff0c\u901a\u8fc7\u961f\u5217\u6d88\u8d39\u751f\u6210 PDF \u5e76\u4e0a\u4f20\u5230 S3 \u670d\u52a1\u5668\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5927\u5927\u63d0\u9ad8\u5fae\u670d\u52a1\u7684\u540c\u6b65\u54cd\u5e94\u901f\u5ea6\u4e86\u3002</p> <p> </p> <p>\u5728 FaaS \u4e2d\u6709\u6ca1\u6709\u66f4\u597d\u7684\u89e3\u51b3\u65b9\u6848\u5462\uff1f\u6211\u4eec\u6765\u770b OpenFaaS \u4e2d\u7684\u5f02\u6b65\u65b9\u6848\u3002</p>"},{"location":"chap2/10chap3_mesh/#1-6","title":"1-6 \u5f02\u6b65","text":"<p>\u5728 OpenFaaS \u4e2d\uff0c OpenFaaS \u5c06\u8bf7\u6c42\u4f5c\u4e3a\u4e8b\u4ef6\u76f4\u63a5\u653e\u5165 NATS \u8fd9\u4e2a\u961f\u5217\u7cfb\u7edf\u4e2d\uff0c\u5bf9\u4e8e\u4f7f\u7528\u8005\u6765\u8bf4\uff0c\u4ed6\u5e76\u4e0d\u9700\u8981\u5173\u5fc3\u8fd9\u662f\u5426\u662f\u4e00\u4e2a\u5f02\u6b65\u8c03\u7528\u3002</p> <p>\u8fd9\u4e2a\u8c03\u7528\u7684\u7f16\u7a0b\u65b9\u5f0f\uff0c\u4f9d\u7136\u662f HTTP \u7684\u65b9\u5f0f\uff0c\u53ea\u662f OpenFaaS Gateway \u81ea\u52a8\u5c06\u6b64\u6b21 HTTP \u8c03\u7528\u653e\u5165\u4e86 NATS \u961f\u5217\u4e2d\uff0c\u901a\u8fc7 queue-worker\u8fd9\u4e2a\u8fdb\u7a0b\u8fdb\u884c\u961f\u5217\u6d88\u8d39\uff0c\u518d\u901a\u8fc7 HTTP \u8bf7\u6c42 Generate Statement \u670d\u52a1\u7684\u65b9\u5f0f\u89e6\u53d1\u6b64\u6b21\u670d\u52a1\u8c03\u7528\uff0c\u7528\u770b\u8d77\u6765\u540c\u6b65\u7684\u65b9\u5f0f\u5b8c\u6210\u4e86\u6574\u4e2a\u5f02\u6b65\u8c03\u7528\u3002</p> <p> </p> <p>\u6574\u4e2a\u8fd0\u884c\u8fc7\u7a0b</p> <p> </p> <ul> <li>\u5728\u8fd9\u4e2a\u67b6\u6784\u4e2d\uff0c\u4f7f\u7528\u8005\u65e0\u987b\u5173\u5fc3\u751a\u81f3\u65e0\u987b\u611f\u77e5 NATS \u961f\u5217\u7cfb\u7edf\uff0c\u5bf9\u4e8e\u4f7f\u7528\u8005\u6765\u8bf4\uff0c\u8fd9\u770b\u8d77\u6765\u5c31\u662f\u4e00\u6b21\u666e\u901a\u7684 HTTP \u670d\u52a1\u8c03\u7528\u3002</li> <li>\u800c PDF \u751f\u6210\u670d\u52a1\u7684\u7f16\u5199\u8005\uff0c\u4e5f\u4e0d\u9700\u8981\u5904\u7406\u590d\u6742\u7684\u961f\u5217\u6d88\u8d39\uff0c\u5bf9\u4e8e\u4ed6\u6765\u8bf4\uff0c\u4e5f\u548c\u5176\u4ed6\u540c\u6b65\u670d\u52a1\u4e00\u6837\uff0c\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u7684 HTTP \u670d\u52a1\u63a5\u53e3\u5c31\u53ef\u4ee5\u4e86\u3002</li> <li>FaaS \u67b6\u6784\u8ba9\u961f\u5217\u7cfb\u7edf\u548c\u4e1a\u52a1\u89e3\u8026\uff0c</li> </ul> <p> </p>"},{"location":"chap2/1chap2_sm_prods/","title":"\u7b2c\u4e00\u8282 Service Mesh \u5f00\u6e90\u4ea7\u54c1\u4e2d\u7684\u6280\u672f\u9009\u578b","text":"<p>Service Mesh\uff0c\u8bd1\u4e3a\u670d\u52a1\u7f51\u683c\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5c06\u53ef\u4ee5\u914d\u7f6e\u7684\u4ee3\u7406\u5c42\u548c\u670d\u52a1\u90e8\u7f72\u5728\u4e00\u8d77\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u57fa\u7840\u8bbe\u65bd\u5c42\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5e76\u63d0\u4f9b\u901a\u7528\u7684\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u8eab\u4efd\u9a8c\u8bc1\u3001\u7cbe\u51c6\u8def\u7531\u3001\u670d\u52a1\u9274\u6743\u7b49\u57fa\u7840\u529f\u80fd\u3002</p>"},{"location":"chap2/1chap2_sm_prods/#1-service-mesh","title":"1\u3001\u4e3a\u4ec0\u4e48\u8981\u5f15\u5165 Service Mesh","text":""},{"location":"chap2/1chap2_sm_prods/#1-1-sdk","title":"1-1 \u6846\u67b6/SDK \u5347\u7ea7\u7ef4\u62a4\u56f0\u96be","text":""},{"location":"chap2/1chap2_sm_prods/#1-2-sdk","title":"1-2 \u65e0\u6cd5\u7ef4\u62a4\u591a\u8bed\u8a00 SDK","text":""},{"location":"chap2/1chap2_sm_prods/#1-3","title":"1-3 \u8001\u9879\u76ee\u8fc1\u79fb\u56f0\u96be","text":""},{"location":"chap2/1chap2_sm_prods/#1-4","title":"1-4 \u7f3a\u4e4f\u7edf\u4e00\u63a7\u5236\u9762","text":"<p>\u65e9\u671f\u7684\u6846\u67b6\u57fa\u672c\u4e0a\u90fd\u662f Web \u6846\u67b6\uff0c\u6ca1\u6709\u8003\u8651\u8fdc\u7a0b\u4e0b\u53d1\u914d\u7f6e\u7684\u95ee\u9898\uff0c\u5bf9\u5fae\u670d\u52a1\u7684\u4e00\u4e9b\u914d\u7f6e\u5e76\u4e0d\u80fd\u52a8\u6001\u7684\u66f4\u65b0\uff0c\u4e5f\u6ca1\u6709\u60f3 Service Mesh \u8fd9\u6837\u7684\u7edf\u4e00\u63a7\u5236\u9762\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u53d1\u914d\u7f6e\u4fee\u6539\u670d\u52a1\u95f4\u7684\u8c03\u7528\u884c\u4e3a\uff0c\u6bd4\u5982\u8def\u7531\u914d\u7f6e\u7b49\u3002</p>"},{"location":"chap2/1chap2_sm_prods/#2-service-mesh","title":"2\u3001\u5e38\u89c1\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848","text":""},{"location":"chap2/1chap2_sm_prods/#2-1-istio-envoy","title":"2-1 Istio + Envoy","text":"<p>\u73b0\u5982\u4eca\uff0cIstio \u51e0\u4e4e\u662f Service Mesh \u7684\u4ee3\u540d\u8bcd\u4e86\uff0cIstio \u5305\u542b\u63a7\u5236\u9762 Istiod \u548c\u6570\u636e\u9762 Envoy \u4e24\u4e2a\u7ec4\u4ef6\u3002</p> <ul> <li>\u5176\u4e2d Istiod \u662f Istio \u7684\u63a7\u5236\u9762\uff0c\u8d1f\u8d23\u914d\u7f6e\u6821\u9a8c\u548c\u4e0b\u53d1\u3001\u8bc1\u4e66\u8f6e\u8f6c\u7b49\u5de5\u4f5c\uff1b</li> <li>Envoy \u5219\u8d1f\u8d23\u6570\u636e\u4ee3\u7406\u548c\u6d41\u91cf\u8def\u7531\u7b49\u5de5\u4f5c\u3002</li> </ul> <p>\u51c6\u786e\u6765\u8bf4 Istio \u5b9e\u9645\u4e0a\u53ea\u662f Service Mesh \u7684\u63a7\u5236\u9762\uff0c\u800c Istio + Envoy \u624d\u7ec4\u6210\u6574\u4e2a Service Mesh \u4f53\u7cfb\uff0c\u8fd9\u6709\u70b9\u50cf GNU/Linux\uff0c\u901a\u5e38\u88ab\u7b80\u5355\u5730\u79f0\u4e3a Linux\u3002</p> <ul> <li>Istio \u5305\u542b\u8d1f\u8d23\u914d\u7f6e\u4e0b\u53d1\u7684 Pilot\u3001</li> <li>\u8d1f\u8d23\u8bc1\u4e66\u8f6e\u8f6c\u7684 Citadel </li> <li>\u8d1f\u8d23\u914d\u7f6e\u6821\u9a8c\u7684 Galley\u3002</li> </ul> <p>\u5728 1.5 \u7248\u672c\u53bb\u9664 mixer \u540e\uff0c Istio \u5df2\u7ecf\u53d8\u5f97\u76f8\u5bf9\u7b80\u5355\u4e86\uff0c\u5b83\u7684\u4e3b\u8981\u5de5\u4f5c\u5c31\u662f\u914d\u7f6e\u4e0b\u53d1\u3002</p> <p>Envoy \u662f C++ \u7f16\u5199\u7684\u9ad8\u6027\u80fd\u8fb9\u7f18\u7f51\u5173\u548c\u4ee3\u7406\u7a0b\u5e8f\uff0c\u652f\u6301 HTTP\u3001gRPC\u3001Thrift\u3001Redis\u3001MongoDB \u7b49\u591a\u79cd\u534f\u8bae\u4ee3\u7406\u3002\u5f53\u7136\u8fd9\u91cc\u9762\u652f\u6301\u6700\u597d\u7684\u8fd8\u662f HTTP\uff0c\u5b83\u51e0\u4e4e\u5177\u5907\u4e86 Service Mesh \u6570\u636e\u9762\u9700\u8981\u7684\u6240\u6709\u529f\u80fd\uff0c\u6bd4\u5982\u670d\u52a1\u53d1\u73b0\u3001\u9650\u6d41\u7194\u65ad\u3001\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3001\u7cbe\u51c6\u6d41\u91cf\u8def\u7531\u7b49\u3002</p>"},{"location":"chap2/1chap2_sm_prods/#2-2-linkerd","title":"2-2 Linkerd","text":"<p>Linkerd \u662f\u4e91\u539f\u751f\u8f6f\u4ef6\u516c\u53f8 Buoyant \u5f00\u6e90\u7684 Service Mesh \u65b9\u6848\uff0c\u800c Service Mesh \u7684\u6982\u5ff5\u4e5f\u662f Linkerd \u9996\u5148\u63d0\u51fa\u7684</p> <p>Linkerd \u5f00\u53d1\u4e86 2.0 \u7248\u672c\uff0c\u6570\u636e\u9762\u4f7f\u7528 Rust \u7f16\u5199\uff0c\u63a7\u5236\u9762\u57fa\u4e8e Go \u8bed\u8a00\u5b9e\u73b0\u3002</p> <ul> <li>mTLS\uff1aLinkerd \u4e3a\u6240\u6709\u7f51\u683c\u5185\u7684\u670d\u52a1\u63d0\u4f9b\u53cc\u5411 TLS \u52a0\u5bc6\u8ba4\u8bc1\u7684\u529f\u80fd\uff0c\u4fdd\u8bc1\u6d41\u91cf\u4f20\u8f93\u5b89\u5168\u3002</li> <li>\u53ef\u89c2\u6d4b\u6027\uff1a\u63d0\u4f9b\u4e86 Grafana \u7684\u56fe\u5f62\u754c\u9762\u4ee5\u53ca\u94fe\u8def\u8ffd\u8e2a\u529f\u80fd\u3002</li> <li>\u534f\u8bae\u652f\u6301\uff1a\u63d0\u4f9b\u4e86 gRPC\u3001HTTP\u3001HTTP/2 \u7b49\u591a\u79cd\u534f\u8bae\u652f\u6301\u3002</li> <li>\u8d1f\u8f7d\u5747\u8861\uff1a\u63d0\u4f9b\u4e86\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u529f\u80fd\uff0c\u5305\u62ec\u57fa\u4e8e\u5f53\u524d\u8bf7\u6c42\u6570\u7684 P2C \u7b97\u6cd5\u3001\u57fa\u4e8e EWMA \u7684\u591a\u79cd\u7b56\u7565\u7684 P2C \u7b97\u6cd5\uff0c\u4ee5\u53ca\u5e38\u89c4\u7684 WRR \u548c RR \u7b97\u6cd5\u3002</li> <li>\u52a8\u6001\u8def\u7531\u529f\u80fd\uff1a\u652f\u6301\u6839\u636e header \u8bbe\u7f6e\u4e0d\u540c\u7684\u8def\u7531\u89c4\u5219\uff0c\u652f\u6301\u6d41\u91cf\u8f6c\u79fb\u529f\u80fd\uff0c\u53ef\u4ee5\u5728\u4e0d\u540c\u670d\u52a1\u4e4b\u95f4\u3001\u76f8\u540c\u670d\u52a1\u4e0d\u540c\u7248\u672c\u4e4b\u95f4\u505a\u6d41\u91cf\u8f6c\u79fb\u3002</li> </ul>"},{"location":"chap2/1chap2_sm_prods/#2-3-sofamesh","title":"2-3 SOFAMesh","text":"<ul> <li>SOFAMesh \u662f\u8682\u8681\u91d1\u670d\u5f00\u6e90\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0c\u5305\u542b\u6570\u636e\u9762 MOSN \u548c\u4fee\u6539\u540e\u7684 Istio Pilot \u63a7\u5236\u9762\u3002\u4e0d\u8fc7\u5728\u6700\u65b0\u7248\u672c\uff0c\u63a7\u5236\u9762\u5df2\u7ecf\u505c\u6b62\u7ef4\u62a4\uff0c\u8f6c\u800c\u548c\u793e\u533a\u5408\u4f5c\uff0c\u4f7f\u7528 Istio \u4f5c\u4e3a\u63a7\u5236\u9762\u3002</li> <li>\u591a\u534f\u8bae\u8f6c\u53d1\uff1aMOSN \u652f\u6301\u6700\u597d\u7684\u662f\u8682\u8681\u7684 SOFARPC\uff0c\u6700\u8fd1\u4e5f\u589e\u5f3a\u4e86\u5bf9 Dubbo \u7684\u652f\u6301\uff0c\u5bf9\u4e8e HTTP \u548c HTTP/2 \u7684\u652f\u6301\u8f83\u5f31\u3002\u5982\u679c\u4f60\u7684\u516c\u53f8\u591a\u662f\u57fa\u4e8e HTTP \u548c gRPC \u534f\u8bae\u6784\u5efa\u7684\u5fae\u670d\u52a1\uff0c\u4e0d\u592a\u9002\u5408\u4f7f\u7528\u3002</li> <li>\u8def\u7531\uff1a\u652f\u6301 VirtualHost \u548c\u57fa\u4e8e header\u3001URL\u3001Prefix \u7b49\u591a\u79cd\u8def\u7531\u65b9\u5f0f\u3002</li> <li>\u8d1f\u8f7d\u5747\u8861\uff1a\u652f\u6301\u57fa\u672c\u7684 RoundRobin \u548c Random \u7b97\u6cd5\u3001\u57fa\u4e8e\u5f53\u524d\u8bf7\u6c42\u6570\u7684 P2C \u7b97\u6cd5\uff0c\u4e5f\u652f\u6301\u57fa\u4e8e host subset \u5206\u7ec4\u8def\u7531\u7b97\u6cd5\uff0c\u4ee5\u5b9e\u73b0\u91d1\u4e1d\u96c0\u53d1\u5e03\u548c\u67d3\u8272\u7b49\u529f\u80fd\u3002</li> <li>TLS\uff1a\u5bf9\u4e8e HTTP\u3001HTTP/2\u3001SOFARPC \u90fd\u652f\u6301 TLS \u53cc\u5411\u52a0\u5bc6\u3002</li> <li>\u5e73\u6ed1\u91cd\u542f\uff1a\u9488\u5bf9 Dubbo\u3001SOFARPC \u7b49\u79c1\u6709 RPC \u534f\u8bae\uff0c\u652f\u6301\u5728\u4e0d\u65ad\u5f00\u8fde\u63a5\u7684\u60c5\u51b5\u4e0b\u5e73\u6ed1\u91cd\u542f\uff0c\u4ee5\u4fdd\u8bc1 Sidecar \u5728\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u4e0d\u5f71\u54cd\u4e1a\u52a1\u3002</li> </ul>"},{"location":"chap2/1chap2_sm_prods/#2-4-kong-mesh-kuma","title":"2-4 Kong Mesh-Kuma","text":"<p>\u73b0\u5728 Kong \u63a8\u51fa\u4e86\u57fa\u4e8e Envoy \u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\u2014\u2014Kuma</p> <p>Kuma \u6700\u5927\u7684\u7279\u70b9\u662f\u540c\u65f6\u652f\u6301 Kubernetes \u548c VM \u865a\u62df\u673a\uff0c\u8fd9\u6837\u5373\u4fbf\u516c\u53f8\u5b58\u5728\u591a\u79cd\u8fd0\u884c\u73af\u5883\uff0c\u4e5f\u53ef\u4ee5\u652f\u6301\u3002</p> <p>\u53e6\u5916\u5b83\u4e5f\u652f\u6301\u5355\u4e00\u63a7\u5236\u9762\u540c\u65f6\u63a7\u5236\u591a\u5957\u96c6\u7fa4\uff0c\u7531\u4e8e\u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u6240\u4ee5\u5728\u6838\u5fc3\u529f\u80fd\u652f\u6301\u4e0a\u548c Istio \u76f8\u5dee\u4e0d\u5927\uff0c\u6bd4\u8f83\u7279\u522b\u7684\u662f\u652f\u6301 Kong \u4f5c\u4e3a\u5165\u53e3\u7f51\u5173\u5c42\u3002\u6b64\u5916\uff0cKuma \u91c7\u7528 Go \u8bed\u8a00\u7f16\u5199\uff0c\u65b9\u4fbf\u4e8c\u6b21\u5f00\u53d1\u6269\u5c55</p>"},{"location":"chap2/1chap2_sm_prods/#2-5-nginx-service-mesh","title":"2-5 NGINX Service Mesh","text":"<p>Nginx \u5305\u542b\u4e00\u4e2a\u5904\u7406\u4e1c\u897f\u6d41\u91cf\u7684 NGINX Plus \u6570\u636e\u9762\u548c\u4e00\u4e2a\u7528\u4f5c\u5165\u53e3\u7f51\u5173\uff08\u5357\u5317\u5411\u6d41\u91cf\uff09\u7684NGINX Plus\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u63a7\u5236\u9762\u8fdb\u884c\u63a7\u5236\u3002</p> <p>\u63a7\u5236\u9762\u4e13\u95e8\u4e3a NGINX Plus \u5f00\u53d1\uff0c\u4e0b\u53d1\u914d\u7f6e\u7528\u4e8e\u63a7\u5236 NGINX Plus \u7684\u6570\u636e\u9762\uff0c\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b\u90e8\u5206\u3002</p> <ul> <li>Grafana\uff1a\u7528\u4e8e\u6536\u96c6 Metrics \u6307\u6807\u7684\u53ef\u89c6\u5316\u5c55\u793a\u3002</li> <li>Kubernetes Ingress Controllers\uff1a\u7ba1\u7406\u5165\u53e3\u548c\u51fa\u53e3\u6d41\u91cf\u3002</li> <li>SPIRE\uff1a\u590d\u6742\u8bc1\u4e66\u8f6e\u8f6c\u3002</li> <li>NATS\uff1a\u8d1f\u8d23\u4e0b\u53d1\u914d\u7f6e\uff0c\u6bd4\u5982\u8def\u7531\u4fe1\u606f\u66f4\u65b0\u7b49\u3002</li> <li>Open Tracing\uff1a\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\uff0c\u540c\u65f6\u652f\u6301 Zipkin \u548c Jaeger\u3002</li> <li>Prometheus\uff1a\u6536\u96c6 Metrics \u4fe1\u606f\uff0c\u5305\u62ec\u8bf7\u6c42\u6570\uff0c\u8fde\u63a5\u6570\uff0cSSL \u63e1\u624b\u6b21\u6570\u7b49\u3002</li> </ul> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cNGINX Plus \u662f Nginx \u6536\u8d39\u7248\u672c\uff0c\u5e76\u4e0d\u662f\u5f00\u6e90\u8f6f\u4ef6\uff0c\u65e0\u6cd5\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\u3002</p> <p> </p>"},{"location":"chap2/1chap2_sm_prods/#2-6-traefik-mesh","title":"2-6 Traefik Mesh","text":"<p>Traefik Mesh \u7531 Go \u8bed\u8a00\u7f16\u5199\u7684\u5f00\u6e90\u7f51\u5173\u7cfb\u7edf Traefik \u6f14\u8fdb\u800c\u6765\uff0c\u4e0e\u5176\u4ed6\u63d0\u5230\u7684 Mesh \u89e3\u51b3\u65b9\u6848\u4e0d\u540c\uff0cTaeafik Mesh \u5c06 Sidecar \u90e8\u7f72\u5728\u4e86 Kubernetes Node \u8282\u70b9\u4e0a\u3002</p> <p>\u8fd9\u6837\u7684\u597d\u5904\u662f\u5728\u540c\u4e00\u4e2a Node \u8282\u70b9\u4e0a\u7684 Pod\uff0c\u53ef\u4ee5\u5171\u4eab\u4e00\u4e2a Sidecar\uff0c\u4e0d\u7528\u4e3a\u6bcf\u4e2a Pod \u5355\u72ec\u5206\u914d Sidecar \u8d44\u6e90\uff0c\u4ece\u800c\u8fbe\u5230\u8282\u7701\u8d44\u6e90\u7684\u76ee\u7684\uff0c\u540c\u65f6\u76f8\u5bf9\u4e8e\u5728 Pod \u7684 Container \u91cc\u90e8\u7f72 Sidecar\uff0c\u8fd9\u6837\u4e5f\u65b9\u4fbf\u5347\u7ea7\u7ef4\u62a4\u3002</p> <p>\u4f46\u8fd9\u79cd\u505a\u6cd5\u4e5f\u6709\u7f3a\u70b9\uff0c\u8d44\u6e90\u9694\u79bb\u6027\u4e0d\u597d\uff0c\u5bb9\u6613\u76f8\u4e92\u5f71\u54cd\uff0c\u6bd4\u5982\u540c\u4e00\u4e2a Node \u8282\u70b9\u4e0a\u67d0\u4e2a\u670d\u52a1\u51fa\u73b0\u4e86\u95ee\u9898\uff0c\u4ece\u800c\u5360\u7528\u4e86\u66f4\u591a\u7684\u8d44\u6e90\uff0c\u5176\u4ed6\u7684 Pod \u53ef\u80fd\u5c31\u6ca1\u6709\u8d44\u6e90\u53ef\u7528\u4e86\u3002</p> <p> </p>"},{"location":"chap2/1chap2_sm_prods/#2-7-consul-connect","title":"2-7 Consul Connect","text":"<p>Consul Connect \u662f HashiCorp \u516c\u53f8\u5f00\u6e90\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0c\u9700\u8981\u548c Consul \u7ed1\u5b9a\u4f7f\u7528\uff0c\u540c\u6837\u91c7\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0cConsul Connect \u5145\u5f53\u63a7\u5236\u9762\u7684\u89d2\u8272\u3002</p> <p> </p> <p>Traffic Director \u662fGoogle Cloud Platform\uff08\u8c37\u6b4c\u4e91\u5e73\u53f0\uff09\u63d0\u4f9b\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0c\u540c\u65f6\u652f\u6301\u865a\u62df\u673a\u548c\u5bb9\u5668\u73af\u5883\u3002\u5b83\u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u901a\u8fc7 xDS API \u4e0e\u6570\u636e\u9762\u8fdb\u884c\u901a\u4fe1\u3002</p> <p>Traffic Director \u901a\u8fc7\u96c6\u4e2d\u5316\u7684\u5065\u5eb7\u68c0\u67e5\u4ee3\u66ff\u4e86 Envoy \u5185\u7f6e\u7f51\u683c\u7684\u5065\u5eb7\u68c0\u67e5\u65b9\u5f0f\uff0c\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\u51cf\u5c11\u4e86\u7f51\u683c\u5065\u5eb7\u68c0\u67e5\u5e26\u6765\u7684\u670d\u52a1\u538b\u529b\uff0c\u4f46\u9700\u8981\u6ce8\u610f\u7684\u662f\u96c6\u4e2d\u5f0f\u7684\u5065\u5eb7\u68c0\u67e5\u65e0\u6cd5\u5904\u7406\u7f51\u7edc\u5206\u533a\u6545\u969c\u7684\u95ee\u9898\u3002</p> <p> </p> <p>\u5728\u8bf8\u591a\u5f00\u6e90\u89e3\u51b3\u65b9\u6848\u4e2d\uff0c\u90fd\u4f7f\u7528\u4e86 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u6bd4\u5982 Consul\u3001Connnet\u3001Kuma \u7b49\u3002</p> <p> </p>"},{"location":"chap2/2chap2_sm_envoy/","title":"\u7b2c\u4e8c\u8282 \u6700\u5e38\u7528\u7684\u6570\u636e\u9762 Envoy\u4ecb\u7ecd","text":"<p>Envoy \u662f\u4e13\u4e3a\u5927\u578b\u73b0\u4ee3 SOA\uff08\u9762\u5411\u670d\u52a1\u67b6\u6784\uff09\u67b6\u6784\u8bbe\u8ba1\u7684 L7 \u4ee3\u7406\u548c\u901a\u4fe1\u603b\u7ebf\uff0c\u5b83\u65e2\u53ef\u4ee5\u4f5c\u4e3a Service Mesh \u4e2d\u7684\u6570\u636e\u9762\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u5165\u53e3\u7f51\u5173\u5c42\u4f7f\u7528\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>xDS API</code> \u63a7\u5236 Envoy \u7684\u76d1\u542c\u3001\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u7b49\u884c\u4e3a\u3002</p>"},{"location":"chap2/2chap2_sm_envoy/#1","title":"1\u3001\u6838\u5fc3\u529f\u80fd","text":"<ul> <li>\u9ad8\u6027\u80fd\u8bbe\u8ba1\uff1a\u91c7\u7528 C++ \u7f16\u5199\uff0c\u62e5\u6709\u826f\u597d\u7684\u56db\u5c42\u3001\u4e03\u5c42\u4ee3\u7406\u6027\u80fd\uff0c\u5728 8 \u6838\u7684\u673a\u5668\u4e0a\uff0cHTTP \u4ee3\u7406\u53ef\u4ee5\u8fbe\u5230 10w \u7684 QPS\uff0cgRPC \u53ef\u4ee5\u8fbe\u5230 15w QPS\uff0c\u5b8c\u5168\u6ee1\u8db3\u4e86 Service Mesh \u4e2d Sidecar \u7684\u5e94\u7528\u573a\u666f\u3002</li> <li>Filter \u67b6\u6784\uff1a\u53ef\u4ee5\u5728\u56db\u3001\u4e03\u5c42\u7f16\u5199 Filter \u4ee5\u6269\u5c55 Envoy \u7684\u529f\u80fd\uff0c\u6bd4\u5982\u76d1\u542c\u8fc7\u6ee4\u5668\u3001\u56db\u5c42\u7f51\u7edc\u8fc7\u6ee4\u5668\uff0c\u4ee5\u53ca\u4e03\u5c42\u8fc7\u6ee4\u5668\u3002\u4e0d\u8fc7 Envoy \u652f\u6301\u6700\u5b8c\u5584\u7684\u8fd8\u662fHTTP \u8fc7\u6ee4\u5668\uff0c\u652f\u6301\u4e86\u9650\u6d41\u3001\u8def\u7531\u8f6c\u53d1\u3001\u6545\u969c\u6ce8\u5165\u7b49\u591a\u79cd\u670d\u52a1\u6cbb\u7406\u529f\u80fd\uff0c</li> <li>\u826f\u597d\u7684 HTTP/2 \u652f\u6301\uff1a\u968f\u7740 gRPC \u6846\u67b6\u7684\u6d41\u884c\u4ee5\u53ca\u8fb9\u7f18\u5c42\u7f51\u7edc\u6027\u80fd\u7684\u8981\u6c42\u63d0\u5347\uff0cHTTP/2 \u8d8a\u6765\u8d8a\u88ab\u91cd\u89c6\u3002Envoy \u539f\u751f\u652f\u6301 HTTP/2\uff0c\u53ef\u4ee5\u5728 HTTP \u548c HTTP/2 \u4e4b\u95f4\u505a\u8f6c\u6362\u3002\u6bd4\u5982\u5728 Sidecar \u6a21\u5f0f\u4e2d\uff0c\u65e0\u8bba\u5e94\u7528\u534f\u8bae\u662f HTTP \u8fd8\u662f HTTP/2\uff0cEnvoy \u4e4b\u95f4\u9ed8\u8ba4\u4f7f\u7528 HTTP/2 \u901a\u4fe1\uff0c\u8fd9\u6837\u6781\u5927\u63d0\u5347\u4e86\u670d\u52a1\u6027\u80fd\u548c\u7a33\u5b9a\u6027\uff0c\u907f\u514d\u4e86 HTTP \u9891\u7e41\u5efa\u7acb\u8fde\u63a5\u5e26\u6765\u7684\u6d88\u8017\u548c\u4e0d\u7a33\u5b9a\u6027\u3002</li> <li>\u591a\u79cd\u534f\u8bae\u652f\u6301\uff1a\u4e0d\u4ec5\u652f\u6301 HTTP \u548c HTTP/2\uff0c\u968f\u7740\u793e\u533a\u7684\u53d1\u5c55\uff0cThrift\u3001gRPC\u3001MongoDB\u3001Redis\u3001MySQL \u7b49\u591a\u79cd\u7f51\u7edc\u534f\u8bae\u90fd\u88ab\u652f\u6301\uff0c\u751a\u81f3\u53ef\u4ee5\u4f7f\u7528 Envoy \u505a Redis \u7684 Mesh \u65b9\u6848\uff0c\u7528\u6765\u4ee3\u66ff\u6d41\u884c\u7684 Redis \u4e2d\u95f4\u4ef6\u3002</li> <li>\u53ef\u89c2\u6d4b\u6027\uff1a\u652f\u6301\u5f3a\u5927\u7684\u7edf\u8ba1\u7cfb\u7edf\u3002\u65e5\u5fd7\u3001Metrics\u3001\u94fe\u8def\u8ffd\u8e2a\u90fd\u6709\u826f\u597d\u7684\u652f\u6301\u3002</li> <li>\u8fb9\u7f18\u7f51\u5173\uff1aEnvoy \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u7f51\u7edc\u4ee3\u7406\u7ec4\u4ef6\uff0c\u5b8c\u5168\u53ef\u4ee5\u4f5c\u4e3a\u5165\u53e3\u7f51\u5173\u5c42\u4f7f\u7528\uff0c\u5728 Kubernetes \u4e2d\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a Egress \u548c Ingress \u4f7f\u7528\u3002</li> <li>\u670d\u52a1\u53d1\u73b0\uff1a\u548c\u5176\u4ed6\u5e38\u89c1\u7684\u7f51\u7edc\u4ee3\u7406\u8f6f\u4ef6\u4e0d\u540c\uff0cEnvoy \u9ed8\u8ba4\u652f\u6301\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u3002Envoy \u4f7f\u7528\u4e86\u4e00\u5957xDS \u7684\u52a8\u6001 API\uff0c\u83b7\u53d6\u670d\u52a1\u7684\u540e\u7aef\u8282\u70b9\u5e76\u5b9e\u65f6\u66f4\u65b0\uff0c\u7ed3\u5408 Envoy \u5f3a\u5927\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u53ef\u4ee5\u505a\u5230\u6700\u7ec8\u4e00\u81f4\u6027\u3002</li> <li>Wasm \u6269\u5c55\uff1aEnvoy \u5728\u6700\u8fd1\u7684 1.17 \u7248\u672c\u589e\u52a0\u4e86\u5bf9 Wasm \u7684\u652f\u6301\u3002Wasm \u5168\u79f0\u4e3a WebAssembly\uff0c\u6700\u65e9\u7528\u5728\u6d4f\u89c8\u5668\u7aef\u7528\u6765\u89e3\u51b3 JavaScript \u6027\u80fd\u95ee\u9898\u548c\u5927\u578b\u9879\u76ee\u56e2\u961f\u534f\u4f5c\u95ee\u9898\u3002\u8fd1\u4e9b\u5e74\uff0c\u5b83\u5f00\u59cb\u5728\u4e00\u4e9b\u540e\u7aef\u6280\u672f\u4e0a\u4f7f\u7528\uff0c\u7528\u6765\u4ee3\u66ff Lua\uff0c\u4f5c\u4e3a\u6838\u5fc3\u7cfb\u7edf\u7684\u6269\u5c55\u65b9\u5f0f\u3002\u56e0\u4e3a Wasm \u53ef\u4ee5\u4f7f\u7528\u591a\u79cd\u8bed\u8a00\u8fdb\u884c\u5f00\u53d1\uff0c\u6240\u4ee5\u65b9\u4fbf\u5bf9\u6838\u5fc3\u7cfb\u7edf\u8fdb\u884c\u6269\u5c55\uff0c\u4e0d\u7528\u62c5\u5fc3\u8bed\u8a00\u95ee\u9898\u3002\u5f53\u7136\u76f8\u5bf9\u4e8e\u539f\u751f\u7684 C++ \u6269\u5c55\u65b9\u5f0f\uff0c\u5b83\u5927\u6982\u6709 3 \u6210\u7684\u6027\u80fd\u635f\u8017\u3002</li> </ul>"},{"location":"chap2/2chap2_sm_envoy/#2","title":"2\u3001\u67b6\u6784\u8bbe\u8ba1","text":"<p>\u4e0b\u56fe\u662f Envoy \u67b6\u6784\u7684\u8bbe\u8ba1\u56fe\uff0c\u4ece\u56fe\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5165\u6d41\u91cf\u7ecf\u8fc7 Iptables \u52ab\u6301\u88ab\u8f6c\u53d1\u5230\u4e86 Envoy \u7684\u7aef\u53e3\uff0cEnvoy \u901a\u8fc7\u76d1\u542c\u7aef\u53e3\u521b\u5efa\u8fde\u63a5\uff0c\u63d0\u4f9b\u4e03\u5c42\u4ee3\u7406\u670d\u52a1</p> <p> </p> <ul> <li>Iptable\uff1a\u901a\u8fc7 Iptable \u52ab\u6301\uff0c\u5c06\u5165\u53e3\u548c\u51fa\u53e3\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230 Envoy \u4e0a\uff0c\u8fbe\u5230\u52ab\u6301\u6d41\u91cf\u7684\u76ee\u7684\u3002</li> <li>Listener\uff1aEnvoy \u901a\u8fc7\u5efa\u7acb\u591a\u4e2a\u76d1\u542c\u5668\u63d0\u4f9b\u4e0d\u540c\u7684\u670d\u52a1\u3002<ul> <li>\u6bd4\u5982\u901a\u8fc7\u76d1\u542c\u7684\u4e24\u4e2a\u7aef\u53e3\u5206\u522b\u8d1f\u8d23 Sidecar \u6a21\u5f0f\u7684\u51fa\u6d41\u91cf\u548c\u5165\u6d41\u91cf\uff0cSidecar \u591a\u4f7f\u7528\u8fd9\u79cd\u8bbe\u8ba1\uff0c\u8fd9\u6837\u53ef\u4ee5\u7b80\u5316\u7f16\u7a0b\u903b\u8f91\uff0c\u4e5f\u53ef\u4ee5\u589e\u5f3a Filter \u7684\u901a\u7528\u6027\u3002\u5982\u679c\u63d0\u4f9b\u4e0d\u540c\u534f\u8bae\uff0cEnvoy \u4e5f\u4f1a\u5efa\u7acb\u4e0d\u540c\u7684\u7aef\u53e3\u6765\u63d0\u4f9b\u670d\u52a1\u3002</li> </ul> </li> <li>Worker\uff1a\u6bcf\u4e2a Listener \u7ef4\u62a4\u4e00\u4e2a\u5bf9\u5e94\u7684 Worker Pool\uff0cEnvoy \u4e3a\u6bcf\u4e2a\u903b\u8f91\u5904\u7406\u5668\u521b\u5efa\u4e00\u4e2a Worker \u7ebf\u7a0b\uff0c\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u65b0\u7684\u7aef\u53e3\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 server \u65f6\uff0cEnvoy \u4e5f\u4f1a\u6839\u636e <code>-concurrency</code> \u521b\u5efa\u5bf9\u5e94\u7684 Worker \u7ebf\u7a0b\uff0c\u8981\u6ce8\u610f\u542f\u52a8\u592a\u591a\u7684 worker \u7ebf\u7a0b\u5e76\u4e0d\u4e00\u5b9a\u662f\u597d\u4e8b\uff0c\u7279\u522b\u662f\u5728 Sidecar \u6a21\u5f0f\uff0c\u6211\u4eec\u5e76\u4e0d\u4f1a\u5206\u914d\u8fc7\u591a\u7684\u903b\u8f91\u6838\u5fc3\u7ed9\u5230 Sidecar\uff0c\u521b\u5efa\u8fc7\u591a\u7684 Worker \u7ebf\u7a0b\u53ef\u80fd\u5bfc\u81f4\u6bcf\u4e2a Worker \u7ebf\u7a0b\u7ef4\u62a4\u7684\u8fde\u63a5\u53d8\u591a\uff0cUpstream \u538b\u529b\u8fc7\u5927\u3002</li> <li>Filters\uff1a\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e2d\u95f4\u4ef6\uff0c\u901a\u8fc7 Filter\uff0c\u53ef\u4ee5\u505a\u5230\u56db\u5c42\u548c\u4e03\u5c42\u7684\u6d41\u91cf\u8fc7\u6ee4\uff0c\u652f\u6301\u670d\u52a1\u6cbb\u7406\u9700\u8981\u7684\u9650\u6d41\u3001\u7194\u65ad\u7b49\u529f\u80fd\u3002</li> <li>Cluster Manager\uff1a\u6d41\u91cf\u7ecf\u8fc7 Router\uff0c\u8bc6\u522b\u51fa\u9700\u8981\u8f6c\u53d1\u7684 Cluster\uff0c\u901a\u8fc7 Cluster Manager \u8fdb\u884c\u670d\u52a1\u53d1\u73b0\u548c\u8d1f\u8f7d\u5747\u8861\u7b49\u529f\u80fd\u3002</li> <li>Upstream\uff1aUpstream \u7ef4\u62a4\u4e86 EndPoint \u7684\u8fde\u63a5\u6c60\uff0c\u901a\u8fc7\u8d1f\u8f7d\u5177\u8861\u5668\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u5408\u9002\u7684 EndPoint \u4e0a\u9762\u3002</li> </ul> <p> </p> <p>Envoy \u4f5c\u4e3a Sidecar \u4f7f\u7528\u65f6\uff0c\u9700\u8981\u548c\u670d\u52a1\u90e8\u7f72\u5728\u540c\u4e00\u53f0\u673a\u5668\u6216\u8005 Pod \u4e2d\uff0c\u7528\u6237\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u65f6\uff0c\u6d41\u91cf\u4f1a\u88ab\u81ea\u52a8\u52ab\u6301\u5230 Envoy \u4e2d\u3002</p> <p>\u4e0b\u56fe\u662f Productpage \u670d\u52a1\u901a\u8fc7 HTTP \u534f\u8bae\uff0c\u8c03\u7528 review \u670d\u52a1\u7684\u8fc7\u7a0b\u3002</p> <p> </p> <ul> <li>\u901a\u8fc7 Iptables \u5bf9\u6d41\u91cf\u8fdb\u884c\u52ab\u6301\uff0c\u5c06 Productpage \u8bbf\u95ee Reviews \u7684\u6d41\u91cf\u8f6c\u53d1\u5230 Envoy \u7684\u51fa\u6d41\u91cf 15001 \u7aef\u53e3\u4e0a\u3002</li> <li>Envoy \u5148\u6839\u636e <code>virtual_hosts</code> \u8fdb\u884c\u5339\u914d\uff0c\u518d\u901a\u8fc7\u8def\u7531\u5339\u914d\uff0c\u53d1\u73b0\u8def\u7531\u5bf9\u5e94\u7684 Cluster\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u627e\u5230 Cluster \u5bf9\u5e94\u7684 EndPoint\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 <code>10.40.0.15:9080</code> \u7684 Pod \u4e0a\u3002</li> <li>Reviews \u7684 Pod \u901a\u8fc7 Iptables \u5bf9\u6d41\u91cf\u8fdb\u884c\u52ab\u6301\uff0c\u5c06\u6d41\u91cf\u52ab\u6301\u5230 Envoy \u7684\u5165\u6d41\u91cf\u7aef\u53e3 15006 \u4e0a\u3002</li> <li>Envoy \u5c06\u672c\u5730\u6d41\u91cf\u8f6c\u53d1\u5230\u5bf9\u5e94\u7684\u672c\u5730\u5730\u5740<code>127.0.0.1:9080</code>\uff0c\u8fd9\u91cc\u4e0d\u9700\u8981\u5bf9\u6d41\u91cf\u8fdb\u884c\u8bc6\u522b\uff0c\u56e0\u4e3a\u6d41\u91cf\u88ab\u8f6c\u53d1\u5230\u5165\u6d41\u91cf\u7aef\u53e3 15006 \u4e0a\uff0c\u8fd9\u4e2a\u7aef\u53e3\u7684\u914d\u7f6e\u7528\u4e8e\u672c\u5730\u6d41\u91cf\u7684\u8f6c\u53d1\u3002</li> <li>\u5230\u8fd9\u91cc\u6574\u4e2a Sidecar \u7684\u6d41\u91cf\u51fa\u5165\u8fc7\u7a0b\u5c31\u7ed3\u675f\u4e86\u3002\u51fa\u5165\u6d41\u91cf\u90fd\u7ecf\u7531 Envoy\uff0c\u6700\u7ec8\u88ab\u6b63\u786e\u7684\u8f6c\u53d1\u5230\u4e86 Reviews \u7684 Pod \u4e0a\u9762\u3002</li> </ul>"},{"location":"chap2/2chap2_sm_envoy/#2_1","title":"2\u3001\u9759\u6001\u914d\u7f6e","text":"<p>Envoy \u7684\u914d\u7f6e\u5206\u4e3a\u9759\u6001\u914d\u7f6e\u548c\u52a8\u6001\u914d\u7f6e\uff0c\u9759\u6001\u914d\u7f6e\u5c31\u662f\u624b\u52a8\u586b\u5199\u7684\u914d\u7f6e\uff0c\u52a8\u6001\u914d\u7f6e\u662f\u6307\u7531 xDS API \u83b7\u53d6\u7684\u914d\u7f6e</p> <p>\u5982\u4e0b\u4ee3\u7801\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86 Listener \u76d1\u542c\u5668\uff0c\u76d1\u542c\u7aef\u53e3\u4e3a 10000\u3002</p> <p><code>virtual_hosts</code> \u5339\u914d\u6240\u6709\u57df\u540d\uff0cRoutes \u7684\u5339\u914d\u89c4\u5219\u4e3a\u6240\u6709 Path\uff0c\u4e5f\u5c31\u662f\u6240\u6709\u8bbf\u95ee 10000 \u7aef\u53e3\u7684\u8bf7\u6c42\u90fd\u4f1a\u88ab\u8f6c\u53d1\u5230 <code>service_google</code> \u670d\u52a1\u3002</p> <pre><code>listeners:\n- name: listener_0\n  address:\n    socket_address: { address: 0.0.0.0, port_value: 10000 }\n  filter_chains:\n  - filters:\n    - name: envoy.http_connection_manager\n      config:\n        stat_prefix: ingress_http\n        codec_type: AUTO\n        route_config:\n          name: local_route\n          virtual_hosts:\n          - name: local_service\n            domains: [\"*\"] // \u5339\u914d\u6240\u6709\u57df\u540d\n            routes:\n            - match: { prefix: \"/\" }// \u5339\u914d\u6240\u6709 path\n              route: { host_rewrite: www.google.com, cluster: service_google } // \u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 service_google \u670d\u52a1\n        http_filters:\n        - name: envoy.router\n</code></pre> <p>\u4e0b\u9762\u7684\u914d\u7f6e\u662f <code>service_google</code> \u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4\uff0c\u4ee5\u53ca\u8981\u8f6c\u53d1\u7684\u5730\u5740\u3002</p> <pre><code>clusters:\n- name: service_google\n  connect_timeout: 0.25s\n  type: LOGICAL_DNS\n  # Comment out the following line to test on v6 networks\n  dns_lookup_family: V4_ONLY\n  lb_policy: ROUND_ROBIN\n  hosts: [{ socket_address: { address: google.com, port_value: 443 }}]\n  tls_context: { sni: www.google.com }\n</code></pre>"},{"location":"chap2/2chap2_sm_envoy/#3","title":"3\u3001\u8fb9\u7f18\u4ee3\u7406\u6a21\u5f0f","text":"<p>Envoy \u4e0d\u4ec5\u53ef\u4ee5\u7528\u4e8e Sidecar \u6a21\u5f0f\uff0c\u4e5f\u53ef\u4ee5\u7528\u4f5c\u8fb9\u7f18\u7f51\u5173\uff0c\u4f46\u662f\u7528\u4f5c\u8fb9\u7f18\u7f51\u5173\u5c42\u6211\u4eec\u6709\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c</p>"},{"location":"chap2/2chap2_sm_envoy/#3-1-http","title":"3-1 HTTP \u6807\u5934\u6e05\u7406","text":"<p>\u4e00\u4e9b\u5916\u90e8\u4f20\u5165\u7684 header \u53ef\u80fd\u4f1a\u5f71\u54cd\u5185\u90e8\u884c\u4e3a\uff0c\u5e94\u8be5\u7edf\u4e00\u505a\u51fa\u6e05\u7406\u64cd\u4f5c\uff0c\u6bd4\u5982\u6211\u4eec\u7ecf\u5e38\u4f1a\u7528\u5230\u7684 <code>x-forward-for</code>\uff0c\u5728\u53cd\u5411\u4ee3\u7406\u4e2d\uff0c\u672a\u7ecf\u8fc7\u4e00\u5c42\u4ee3\u7406\uff0c\u90fd\u5e94\u8be5\u5c06\u4ee3\u7406\u7684 IP \u8ffd\u52a0\u5728 <code>x-forward-for</code>\u4e2d\uff0c\u4ee5\u4fdd\u8bc1\u901a\u8fc7 <code>x-forward-for</code> \u53ef\u4ee5\u83b7\u53d6\u6700\u539f\u59cb\u7684 IP\uff0c\u5982\u679c\u6709\u5ba2\u6237\u7aef\u6076\u610f\u4f20\u8f93 <code>x-forward-for</code>\uff0c\u4e0d\u505a\u6e05\u9664\u64cd\u4f5c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u62ff\u5230\u9519\u8bef\u7684\u5ba2\u6237\u7aef IP\u3002</p> <p>\u5728 Envoy \u4e2d\u53ef\u4ee5\u901a\u8fc7 <code>use_remote_address</code> \u8bbe\u7f6e\u4e3a true \u6765\u6e05\u7406 HTTP \u6807\u5934\u3002</p>"},{"location":"chap2/2chap2_sm_envoy/#3-2","title":"3-2 \u8d85\u65f6\u63a7\u5236","text":"<p>\u8d85\u65f6\u63a7\u5236\u5206\u4e3a\u8fde\u63a5\u8d85\u65f6\u3001\u6d41\u8d85\u65f6\u548c\u8def\u7531\u8d85\u65f6\u3002</p> <p>\u8fd9\u4e9b\u8d85\u65f6\u63a7\u5236\u4e0d\u4ec5\u5728\u8fb9\u7f18\u7f51\u5173\u6a21\u5f0f\u4e2d\u9700\u8981\u6ce8\u610f\uff0c\u5728 Sidecar \u6a21\u5f0f\u4e5f\u9700\u8981\u6ce8\u610f\uff0c\u4e00\u4e9b\u4e0d\u5408\u7406\u7684\u8d85\u65f6\u53ef\u80fd\u4f1a\u5f15\u8d77\u670d\u52a1\u7684\u96ea\u5d29\u3002\u867d\u7136\u5728\u5185\u7f51\u670d\u52a1\u8c03\u7528\u65f6\u4e00\u822c\u90fd\u4f1a\u8bbe\u7f6e\u9ed8\u8ba4\u8d85\u65f6\uff0c\u4f46 Sidecar \u5e94\u8be5\u8bbe\u7f6e\u4e00\u4e2a\u9ed8\u8ba4\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u907f\u514d\u670d\u52a1\u6ca1\u6709\u8bbe\u7f6e\u6709\u6548\u8d85\u65f6\u7684\u60c5\u51b5\u5f15\u8d77\u7684\u95ee\u9898\u3002</p>"},{"location":"chap2/2chap2_sm_envoy/#3-4","title":"3-4 \u8fde\u63a5\u8d85\u65f6","text":"<p>Envoy \u4e3a HTTP \u670d\u52a1\u63d0\u4f9b\u4e86\u7a7a\u95f2\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4\u7684\u8bbe\u7f6e\uff0c\u7a7a\u95f2\u8d85\u65f6\u662f\u6307\u4e00\u4e2a\u8fde\u63a5\u5728\u63a5\u6536\u5230\u8bf7\u6c42\u540e\uff0c\u4f1a\u8bbe\u7f6e TCP \u7684 idle Timeout \u7684\u53c2\u6570\uff0c\u4e00\u6bb5\u65f6\u95f4\u5185\u6ca1\u6709\u6536\u5230\u4ee3\u7406\u670d\u52a1\u7684\u54cd\u5e94\u8bf7\u6c42\uff0c\u5219\u4f1a\u65ad\u5f00\u8fde\u63a5\u3002Envoy \u9ed8\u8ba4\u7684\u7a7a\u95f2\u8d85\u65f6\u662f 1 \u5c0f\u65f6\u3002\u8fde\u63a5\u8d85\u65f6\u5bf9\u6240\u6709\u6d41\u751f\u6548\uff0c\u8fde\u63a5\u4e00\u65e6\u65ad\u5f00\uff0c\u6240\u6709\u6d41\u5904\u7406\u4e5f\u4f1a\u4e2d\u65ad\u3002</p>"},{"location":"chap2/2chap2_sm_envoy/#3-5","title":"3-5 \u6d41\u8d85\u65f6","text":"<p>\u6d41\u662f HTTP/2 \u4e2d\u7684\u6982\u5ff5\uff0c\u5728 HTTP/1 \u4e2d\u6ca1\u6709\u6d41\u7684\u6982\u5ff5\uff0cEnvoy \u901a\u8fc7\u5c06 HTTP \u8fde\u63a5\u5bf9\u5e94\u5230\u6d41\u6a21\u5f0f\uff0c\u7edf\u4e00\u8fdb\u884c\u5904\u7406\u3002</p> <p>HTTP \u8fde\u63a5\u7ba1\u7406\u5668 <code>stream_idle_timeout</code> \u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\u4e3a 5 \u5206\u949f\uff0c\u63a8\u8350\u5bf9\u6240\u6709\u6d41\u8bbe\u7f6e\u5408\u7406\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u8fd9\u4e2a\u65f6\u95f4\u5c31\u662f\u63a5\u6536\u8bf7\u6c42\u5230\u8fd4\u56de\u6570\u636e\u7684\u5904\u7406\u65f6\u95f4\uff0c\u5982\u679c\u6ca1\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u5efa\u8bae\u8bbe\u7f6e\u4e3a 10s\uff0c\u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\u504f\u957f\u3002\u5982\u679c\u89e6\u53d1\u6b64\u8d85\u65f6\u65f6\u95f4\uff0c\u5219\u4f1a\u51fa\u53d1 504 Gateway Timeout \u7684\u9519\u8bef\u7801\u3002</p>"},{"location":"chap2/2chap2_sm_envoy/#3-6","title":"3-6 \u8def\u7531\u8d85\u65f6","text":"<p>\u9664\u4e86\u8bbe\u7f6e\u5168\u5c40\u7684\u6d41\u8d85\u65f6\u5916\uff0c\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u8def\u7531\u5c42\u9762\u7684\u8d85\u65f6\uff0c\u4e3a\u67d0\u4e9b\u8bf7\u6c42\u8bbe\u7f6e\u7279\u6b8a\u7684\u914d\u7f6e\uff0c\u4e00\u4e9b\u8bf7\u6c42\u53ef\u80fd\u9700\u8981\u66f4\u5feb\u7684\u54cd\u5e94\u901f\u5ea6\uff0c\u6240\u4ee5\u8981\u8bbe\u7f6e\u8f83\u77ed\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ea\u8981\u5728\u8def\u7531\u5c42\u9762\u8bbe\u7f6e\u5373\u53ef\uff0c\u6bd4\u5982\u9488\u5bf9\u67d0\u4e9b Path \u8bbe\u7f6e\u66f4\u77ed\u7684\u8d85\u65f6\u65f6\u95f4\u3002</p>"},{"location":"chap2/2chap2_sm_envoy/#3-7","title":"3-7 \u8fde\u63a5\u9650\u5236","text":"<p>Envoy \u53ef\u4ee5\u9488\u5bf9\u5168\u5c40\u6216\u8005\u76d1\u542c\u5668\u8bbe\u7f6e\u8fde\u63a5\u9650\u5236\u3002\u4e00\u822c\u5355\u4e00\u670d\u52a1\u5668\u53ef\u627f\u8f7d\u7684\u5e76\u53d1\u8fde\u63a5\u6570\u6709\u9650\uff0c\u6839\u636e\u7ebf\u4e0a\u7684\u5cf0\u503c\u8fde\u63a5\u8fd0\u884c\u60c5\u51b5\uff0c\u8bbe\u7f6e\u5408\u7406\u7684\u8fde\u63a5\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u907f\u514d\u56e0\u670d\u52a1\u51fa\u95ee\u9898\u65f6\u54cd\u5e94\u8fc7\u6162\uff0c\u5927\u91cf\u65b0\u5efa HTTP \u8fde\u63a5\u51fb\u57ae Envoy \u7684\u60c5\u51b5\u3002</p> <p>Envoy \u4e0d\u4ec5\u53ef\u4ee5\u4f5c\u4e3a Service Mesh \u4e2d\u7684 Sidecar \u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u8fb9\u7f18\u7f51\u5173\u4f7f\u7528\uff0c\u5b83\u7684\u672c\u8d28\u5c31\u662f\u4e00\u4e2a\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\uff0cNginx\u3001HAProxy \u80fd\u505a\u7684\u4e8b\u60c5 Envoy \u4e5f\u53ef\u4ee5\u505a\u5f97\u5f88\u597d\u3002</p>"},{"location":"chap2/3chap3_isitio_17/","title":"\u7b2c\u4e09\u8282 Istio \u5165\u95e8\uff1a\u57fa\u4e8e\u6700\u65b0 1.7 \u7248\u672c\u7684\u73af\u5883\u642d\u5efa\u548c\u4ecb\u7ecd","text":"<p>\u8c08\u5230 Service Mesh\uff0c\u4e0d\u5f97\u4e0d\u63d0\u53ca Istio\uff0c\u4f5c\u4e3a Google\u3001IBM\u3001lynx \u8054\u5408\u63a8\u51fa\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0cIstio \u51e0\u4e4e\u6210\u4e86 Service Mesh \u7684\u4ee3\u540d\u8bcd\uff0c\u4f46\u5b9e\u9645\u4e0a Istio \u4ec5\u4ec5\u662f Service Mesh \u4e2d\u7684\u63a7\u5236\u9762\uff0c\u5b83\u7684\u4e3b\u8981\u529f\u80fd\u662f\u4e3a\u6570\u636e\u9762\u4e0b\u53d1\u670d\u52a1\u6cbb\u7406\u7b56\u7565\u3002</p> <p>Istio \u6700\u8fd1\u5728 1.5 \u7248\u672c\u8fdb\u884c\u4e86\u4e00\u6b21\u5927\u7684\u53d8\u66f4\uff0c\u7531\u65e9\u671f\u7684\u5fae\u670d\u52a1\u67b6\u6784\u53d8\u6210\u4e86\u5355\u4f53\u67b6\u6784\u3002\u4e4b\u524d\u7248\u672c\u7684Istio \u7531 Pilot\u3001Citadel\u3001Galley\u3001Sidecar \u6ce8\u5165\u5668\u7b49\u591a\u4e2a\u5fae\u670d\u52a1\u7ec4\u6210\uff0c\u4f46\u73b0\u5728\u53ea\u9700\u8981\u4e00\u4e2a Istiod \u7684\u5355\u4f53\u670d\u52a1\u3002</p> <p>\u6700\u65b0\u7248\u672c\u7684 Istio \u63a7\u5236\u9762\u7531\u4ee5\u4e0b\u51e0\u4e2a\u7ec4\u4ef6\u7ec4\u6210\u3002</p> <ul> <li>Pilot\uff1aIstio \u63a7\u5236\u9762\u4e2d\u6700\u6838\u5fc3\u7684\u6a21\u5757\uff0c\u8d1f\u8d23\u8fd0\u884c\u65f6\u914d\u7f6e\u4e0b\u53d1\uff0c\u5177\u4f53\u6765\u8bf4\uff0c\u5c31\u662f\u548c Envoy \u4e4b\u95f4\u57fa\u4e8e xDS \u534f\u8bae\u8fdb\u884c\u7684\u5404\u79cd Envoy \u914d\u7f6e\u4fe1\u606f\u7684\u63a8\u9001\uff0c\u5305\u62ec\u670d\u52a1\u53d1\u73b0\u3001\u8def\u7531\u53d1\u73b0\u3001\u96c6\u7fa4\u53d1\u73b0\u3001\u76d1\u542c\u5668\u53d1\u73b0\u7b49\u3002</li> <li>Citadel\uff1a\u8d1f\u8d23\u8bc1\u4e66\u7684\u5206\u53d1\u548c\u8f6e\u6362\uff0c\u4f7f Sidecar \u4ee3\u7406\u4e24\u7aef\u5b9e\u73b0\u53cc\u5411 TLS \u8ba4\u8bc1\u3001\u8bbf\u95ee\u6388\u6743\u7b49\u3002</li> <li>Galley\uff1a\u914d\u7f6e\u4fe1\u606f\u7684\u683c\u5f0f\u548c\u6b63\u786e\u6027\u6821\u9a8c\uff0c\u5c06\u914d\u7f6e\u4fe1\u606f\u63d0\u4f9b\u7ed9 Pilot \u4f7f\u7528\u3002</li> </ul>"},{"location":"chap2/3chap3_isitio_17/#1istio","title":"1\u3001Istio \u73af\u5883\u642d\u5efa","text":"<p>\u56e0\u4e3a Istio \u5f3a\u4f9d\u8d56\u4e8e Kubernetes \u73af\u5883\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5148\u8fdb\u884c Kubernetes \u73af\u5883\u7684\u642d\u5efa\uff0c\u4e3a\u4e86\u66f4\u52a0\u65b9\u4fbf\uff0c\u6211\u4eec\u4f7f\u7528 Minikube \u5728\u672c\u5730\u642d\u5efa\u3002</p> <p>\u5728 macOS \u73af\u5883\u4e0b\uff0c\u53ea\u8981\u7b80\u5355\u8fd0\u884c\u5982\u4e0b\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ brew install minikube\n$ minikube start --kubernetes-version=v1.19.2 --driver=docker\n</code></pre> <p>\u53e6\u5916\u542f\u52a8\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u9047\u5230\u95ee\u9898\uff0c\u53ef\u4ee5\u52a0\u4e0a <code>--alsologtostderr</code> \u8f93\u51fa\u8be6\u7ec6\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u5efa\u8bae\u5c06 Docker \u7248\u672c\u4e5f\u5347\u7ea7\u81f3\u6700\u65b0\u3002</p> <p>\u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684 Istio\uff1a</p> <pre><code>$ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.7.3 sh -\n</code></pre> <p>\u4e3a\u4e86\u4fdd\u8bc1\u540e\u7eed\u547d\u4ee4\u7684\u51c6\u786e\u6027\uff0c\u8fd9\u91cc\u6307\u5b9a\u4e86\u7248\u672c\u53f7\u3002</p> <p>\u8fdb\u5165\u4e0b\u8f7d\u76ee\u5f55\uff1a</p> <pre><code>$ cd istio-1.7.3\n</code></pre> <p>\u5c06 Istioctl \u5ba2\u6237\u7aef\u6dfb\u52a0\u5230\u53ef\u6267\u884c\u8def\u5f84\uff1a</p> <pre><code>$ export PATH=$PWD/bin:$PATH\n</code></pre> <p>\u4f7f\u7528 Istioctl \u5ba2\u6237\u7aef\u5b89\u88c5 Istio\uff1a</p> <pre><code>$ istioctl install --set profile=demo\n</code></pre> <p>\u5728\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u5f00\u542f\u81ea\u52a8\u6ce8\u5165 Envoy Sidecar\uff1a</p> <pre><code>$ kubectl label namespace default istio-injection=enabled\n\n</code></pre> <p>\u901a\u8fc7\u4e0a\u8ff0\u64cd\u4f5c\uff0cIstio \u7684\u73af\u5883\u5c31\u5b89\u88c5\u597d\u4e86\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b Istio \u7ec4\u4ef6\uff1a</p> <pre><code>$ kubectl get svc -n istio-system\n\nNAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0TYPE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0CLUSTER-IP\u00a0 \u00a0 \u00a0 \u00a0EXTERNAL-IP\u00a0 \u00a0PORT(S)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AGE\n\nistio-egressgateway\u00a0 \u00a0 ClusterIP\u00a0 \u00a0 \u00a0 10.104.140.107\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 80/TCP,443/TCP,15443/TCP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a02d5h\nistio-ingressgateway\u00a0 \u00a0LoadBalancer\u00a0 \u00a010.103.123.96\u00a0 \u00a0 &lt;pending&gt;\u00a0 \u00a0 \u00a015021:32148/TCP,80:32124/TCP,443:31370/TCP,31400:31690/TCP,15443:32721/TCP\u00a0 \u00a02d5h\nistiod\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0ClusterIP\u00a0 \u00a0 \u00a0 10.106.54.115\u00a0 \u00a0 &lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 15010/TCP,15012/TCP,443/TCP,15014/TCP,853/TCP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2d5h\n</code></pre> <p>Istio \u4ee5\u4e00\u4e2a\u670d\u52a1\u7684\u5f62\u5f0f\u90e8\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u3002\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u90e8\u7f72\u597d\u7684 Pods \u4e2d\uff0c\u9664\u4e86\u6709 Istiod \u8fd9\u4e2a\u6838\u5fc3\u7ec4\u4ef6\u5916\uff0c\u8fd8\u6709 Istio Egressgate Way \u548c Istio Ingressgate Way \u4e24\u4e2a\u7ec4\u4ef6\uff0c\u5206\u522b\u662f\u51fa\u53e3\u7f51\u5173\u548c\u5165\u53e3\u7f51\u5173\u3002</p>"},{"location":"chap2/3chap3_isitio_17/#2-bookinfo","title":"2\u3001\u90e8\u7f72 Bookinfo \u793a\u4f8b\u7a0b\u5e8f","text":"<p>\u90e8\u7f72\u793a\u4f8b\u7a0b\u5e8f\uff1a</p> <pre><code>$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml\n</code></pre> <p>\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b Pod \u7684\u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods\n</code></pre> <p>\u5f53 Pod ready \u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5185\u90e8\u670d\u52a1\u8bbf\u95ee\u7684\u65b9\u5f0f\uff0c\u67e5\u770b\u670d\u52a1\u7684\u8fd0\u884c\u60c5\u51b5\uff1a</p> <pre><code>$ kubectl exec \"$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')\" -c ratings -- curl -s productpage:9080/productpage | grep -o \"&lt;title&gt;.*&lt;/title&gt;\"\n&lt;title&gt;Simple Bookstore App&lt;/title&gt;\n</code></pre> <p>\u73b0\u5728\uff0c\u670d\u52a1\u5df2\u7ecf\u6b63\u5e38\u542f\u52a8\u4e86\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7 Ingress \u7684\u65b9\u5f0f\uff0c\u8ba9\u6d4f\u89c8\u5668\u53ef\u4ee5\u6253\u5f00\u8fd9\u4e2a\u9875\u9762\u3002</p> <p>\u901a\u8fc7 Ingress \u6253\u901a\u5185\u5916\u7f51\u670d\u52a1\uff1a</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml\ngateway.networking.istio.io/bookinfo-gateway created\nvirtualservice.networking.istio.io/bookinfo created\n</code></pre> <p>\u67e5\u770b Minikube \u7684 IP\uff1a</p> <pre><code>$ minikube ip\n127.0.0.1\n</code></pre> <p>\u7136\u540e\uff0c\u6253\u5f00\u65b0\u7684\u7ec8\u7aef\u7a97\u53e3\uff0c\u4e3a LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\u6253\u901a\u5916\u7f51\uff1a</p> <pre><code>$ minikube tunnel\nThe service Istio -ingressgateway requires privileged ports to be exposed: [80 443]\nsudo permission will be asked for it.\nStarting tunnel for service Istio -ingressgateway.\nPassword:\n</code></pre> <p>\u6253\u5f00\u6d4f\u89c8\u5668\u8bbf\u95ee<code>http://127.0.0.1/productpage</code>\uff08IP \u66ff\u6362\u4e3a\u4e0a\u9762\u8fd0\u884c\u7684 Minikube IP\uff09\uff0c \u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u9875\u9762\u4e86\u3002</p> <p> </p>"},{"location":"chap2/3chap3_isitio_17/#3","title":"3\u3001\u53ef\u89c2\u6d4b\u6027\u90e8\u7f72","text":"<p>Kiali \u662f\u4e00\u4e2a\u57fa\u4e8e\u670d\u52a1\u7f51\u683c\u7684 Istio \u7ba1\u7406\u63a7\u5236\u53f0\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u4e9b\u6570\u636e\u7684\u4eea\u8868\u76d8\u548c\u53ef\u89c2\u6d4b\u80fd\u529b\uff0c\u540c\u65f6\u53ef\u4ee5\u8ba9\u4f60\u53bb\u64cd\u4f5c\u7f51\u683c\u7684\u914d\u7f6e\u3002</p> <p>\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u5feb\u901f\u90e8\u7f72\u4e00\u4e2a\u7528\u4e8e\u6f14\u793a\u7684 Kiali\uff1a</p> <pre><code>$ kubectl apply -f samples/addons\n</code></pre> <pre><code>$ kubectl get pod -n istio-system -o wide\nNAME                                    READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES\ngrafana-57bb676c4c-4nfcd                1/1     Running   3          13d   172.18.0.11   minikube   &lt;none&gt;           &lt;none&gt;\nistio-egressgateway-8556f8c8dc-pnlbl    1/1     Running   4          16d   172.18.0.4    minikube   &lt;none&gt;           &lt;none&gt;\nistio-ingressgateway-589d868684-xcx42   1/1     Running   4          16d   172.18.0.6    minikube   &lt;none&gt;           &lt;none&gt;\nistiod-86d65b6959-jl8fs                 1/1     Running   4          16d   172.18.0.3    minikube   &lt;none&gt;           &lt;none&gt;\njaeger-75948789b4-9bc4f                 1/1     Running   15         13d   172.18.0.13   minikube   &lt;none&gt;           &lt;none&gt;\nkiali-7d5cb68b45-cz75l                  1/1     Running   13         13d   172.18.0.5    minikube   &lt;none&gt;           &lt;none&gt;\nprometheus-7c8bf6df84-8jp99             2/2     Running   12         13d   172.18.0.9    minikube   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u5982\u679c\u6709\u542f\u52a8\u6bd4\u8f83\u6162\u7684 Pod\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u4e00\u4e0b Pod \u7684\u4e8b\u4ef6\uff0c\u4e86\u89e3\u4e00\u4e0b\u5177\u4f53\u539f\u56e0\u3002</p> <pre><code>$ kubectl describe pod kiali-7d5cb68b45-cz75l -n istio-system\n</code></pre> <p>Pod \u5168\u90e8\u542f\u52a8\u6210\u529f\u540e\uff0c\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u6574\u4e2a\u8c03\u7528\u5173\u7cfb\u60c5\u51b5\uff1a</p> <pre><code>$ istioctl dashboard kiali\n</code></pre> <p> </p>"},{"location":"chap2/3chap3_isitio_17/#4","title":"4\u3001\u5b9e\u4f8b\u670d\u52a1\u539f\u7406\u89e3\u6790","text":"<pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: productpage\n  labels:\n    app: productpage\n    service: productpage\nspec:\n  ports:\n  - port: 9080\n    name: http\n  selector:\n    app: productpage\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7 Deployment \u63a7\u5236 Pod \u7684\u751f\u547d\u5468\u671f\uff0c\u5b9a\u4e49\u4e86 Pod \u7684\u526f\u672c\u6570\u91cf\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u5b9a\u4e49\u4e00\u4e2a replicas \u4e3a 1\uff0c\u4e5f\u5c31\u662f Pod \u7684\u526f\u672c\u6570\u91cf\u4e3a 1\uff0c\u56e0\u4e3a\u662f\u6d4b\u8bd5\u73af\u5883\uff0c\u6240\u4ee5\u6ca1\u6709\u8bbe\u7f6e\u66f4\u591a\u7684\u526f\u672c\u6570\u91cf\u4fdd\u969c\u670d\u52a1\u7684 SLA \u3002</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: productpage-v1\n  labels:\n    app: productpage\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: productpage\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: productpage\n        version: v1\n    spec:\n      serviceAccountName: bookinfo-productpage\n      containers:\n      - name: productpage\n        image: docker.io/istio/examples-bookinfo-productpage-v1:1.16.2\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 9080\n        volumeMounts:\n        - name: tmp\n          mountPath: /tmp\n      volumes:\n      - name: tmp\n        emptyDir: {}\n</code></pre> <p>\u53e6\u5916\u5728 Kubernetes \u7684 Service \u91cc\u9762\u5e76\u6ca1\u6709\u7248\u672c\u7684\u6982\u5ff5\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8fdb\u884c\u67d3\u8272\u6216\u8005\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u5c31\u9700\u8981\u501f\u52a9 Istio \u7684\u80fd\u529b\u3002</p> <p>\u901a\u8fc7\u4e0a\u8ff0\u547d\u4ee4\u53ef\u4ee5\u770b\u5230\uff0c\u5728 Deployment \u7c7b\u578b\u4e2d\u5b9a\u4e49\u4e86 Version V1 \u7684 lable\uff0c\u8fd9\u4e2a lable \u6700\u7ec8\u4f1a\u8f6c\u5316\u6210\u4e0d\u540c\u7684\u670d\u52a1\u540d\uff0c\u6bd4\u5982 productpage-v1 \u7684\u65b9\u5f0f\uff0c\u4e0b\u53d1\u5230 Sidecar \u4e2d\uff0c Sidecar \u6839\u636e\u8fd9\u4e2a\u670d\u52a1\u540d\u79f0\u8fdb\u884c\u670d\u52a1\u53d1\u73b0\uff0c\u4ee5\u5b9e\u73b0\u4e0d\u540c\u7248\u672c\u53f7\u8bbf\u95ee\u7684\u65b9\u6cd5\u3002</p> <p>\u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u7528\u5230\u4e86 Ingress \u6a21\u5f0f\u3002\u6211\u4eec\u5b9a\u4e49\u4e00\u7ec4\u7f51\u5173\u7c7b\u578b\u7684\u8d44\u6e90\uff0c Istio \u901a\u8fc7 Gateway \u5c06\u670d\u52a1\u53d1\u5e03\u6210\u5916\u90e8\u53ef\u8bbf\u95ee\u7684\u670d\u52a1\uff0c\u901a\u8fc7 80 \u7aef\u53e3\u5c06\u670d\u52a1\u901a\u8fc7 Ingress \u7f51\u5173\u8f6c\u53d1\u5230\u7279\u5b9a\u7684\u670d\u52a1\u4e0a\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: bookinfo-gateway\nspec:\n  selector:\n    istio: ingressgateway # use istio default controller\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    hosts:\n    - \"*\"\n</code></pre> <p>\u5728\u8fd9\u91cc\uff0cGateway \u8d44\u6e90\u7c7b\u578b\uff0c\u9700\u8981\u914d\u5408 VirtualService \u7c7b\u578b\u7684\u8d44\u6e90\u4e00\u8d77\u4f7f\u7528\u3002</p> <p>\u5728\u8fd9\u4e2a\u7a0b\u5e8f\u4e2d\u4f60\u53ef\u4ee5\u770b\u5230\u5339\u914d\u5230 <code>/productpage</code> \u8def\u5f84\u7684\u670d\u52a1\uff0c\u800c\u5728 route \u4e2d\u5b9a\u4e49\u4e86 destination \u7684 host \u5c06\u4f1a\u662f\u8def\u7531\u7684\u670d\u52a1\u540d\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: bookinfo\nspec:\n  hosts:\n  - \"*\"\n  gateways:\n  - bookinfo-gateway\n  http:\n  - match:\n    - uri:\n        exact: /productpage\n    - uri:\n        prefix: /static\n    - uri:\n        exact: /login\n    - uri:\n        exact: /logout\n    - uri:\n        prefix: /api/v1/products\n    route:\n    - destination:\n        host: productpage\n        port:\n          number: 9080\n</code></pre> <ul> <li>Istio \u901a\u8fc7 Galley \u6a21\u5757\u7ba1\u7406\u914d\u7f6e\uff0c</li> <li>Pilot \u6a21\u5757\u89e3\u6790\u914d\u7f6e\u4e3a xDS \u534f\u8bae\u683c\u5f0f\uff0c\u901a\u8fc7 gRPC \u548c Envoy \u8fdb\u884c\u901a\u4fe1\uff0c\u4ee5\u4fbf\u5b8c\u6210\u914d\u7f6e\u548c\u8282\u70b9\u4fe1\u606f\u66f4\u65b0\uff0c </li> <li>pilot-agent \u4f5c\u4e3a Envoy \u5b88\u62a4\u6a21\u5757\uff0c\u4fdd\u8bc1 Envoy \u7684\u6b63\u5e38\u8fd0\u884c\u548c\u5e73\u6ed1\u91cd\u542f\u3002</li> </ul> <p> </p> <p>\u672c\u5730\u4e1a\u52a1\u670d\u52a1 productpage \u901a\u8fc7 iptables \u52ab\u6301\u7684\u65b9\u5f0f\u548c\u672c\u5730 Envoy \u8fdb\u884c\u901a\u4fe1\uff0cEnvoy \u5b8c\u6210\u670d\u52a1\u53d1\u73b0\u540e\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230 ProductDetail \u670d\u52a1\u7684\u6240\u5728 Pod\uff0c\u540c\u6837\u901a\u8fc7 iptables \u52ab\u6301\u7684\u65b9\u5f0f\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u672c\u5730\u7684\u4e1a\u52a1\u670d\u52a1 ProductDetail\u3002</p> <p> </p>"},{"location":"chap2/4chap3_xds/","title":"\u7b2c\u56db\u8282 xDS\uff1a\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u901a\u4fe1\u6865\u6881","text":"<p>\u901a\u8fc7\u67e5\u8be2\u4e00\u4e2a\u6216\u591a\u4e2a\u7ba1\u7406\u670d\u52a1\u5668\u83b7\u53d6\u6570\u636e\u4ee5\u53d1\u73b0\u52a8\u6001\u8d44\u6e90\u53d8\u66f4\uff0c\u6bd4\u5982 Router\u3001Cluster\u3001EndPoint \u7b49\uff0c\u6211\u4eec\u628a\u8fd9\u4e9b\u53d1\u73b0\u670d\u52a1\u53ca\u5176\u5bf9\u5e94\u7684 API \u79f0\u4e3a xDS \u3002</p> <p>xDS \u6700\u5927\u7684\u4ef7\u503c\u5c31\u662f\u5b9a\u4e49\u4e86\u4e00\u5957\u53ef\u6269\u5c55\u7684\u901a\u7528\u5fae\u670d\u52a1\u63a7\u5236 API\uff0c\u8fd9\u4e9bAPI\u4e0d\u4ec5\u53ef\u4ee5\u505a\u5230\u670d\u52a1\u53d1\u73b0\uff0c\u4e5f\u53ef\u4ee5\u505a\u5230\u8def\u7531\u53d1\u73b0\u3001\u96c6\u7fa4\u53d1\u73b0\uff0c\u53ef\u4ee5\u8bf4\u6240\u6709\u914d\u7f6e\u90fd\u80fd\u901a\u8fc7\u53d1\u73b0\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u8fd9\u662f\u4e00\u79cd\u5168\u65b0\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u6240\u4ee5 xDS API \u4e0d\u4ec5\u88ab\u7528\u5728\u4e86 Service Mesh \u4e2d\uff0c\u4e5f\u7528\u5728\u4e86\u4e00\u4e9b RPC \u6846\u67b6\u4e2d\uff0c\u6bd4\u5982 gRPC \u5c31\u662f\u7528 xDS \u534f\u8bae\u505a\u670d\u52a1\u53d1\u73b0\u7684\u3002</p>"},{"location":"chap2/4chap3_xds/#1xds","title":"1\u3001xDS \u6982\u5ff5\u4ecb\u7ecd","text":"<p>xDS \u5305\u542b </p> <ul> <li>LDS\uff08\u76d1\u542c\u5668\u53d1\u73b0\u670d\u52a1\uff09\u3001</li> <li>CDS\uff08\u96c6\u7fa4\u53d1\u73b0\u670d\u52a1\uff09\u3001</li> <li>EDS\uff08\u8282\u70b9\u53d1\u73b0\u670d\u52a1\uff09\u3001</li> <li>SDS\uff08\u5bc6\u94a5\u53d1\u73b0\u670d\u52a1\uff09</li> <li>RDS\uff08\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff09\u3002</li> </ul> <p>xDS \u4e2d\u6bcf\u79cd\u7c7b\u578b\u5bf9\u5e94\u4e00\u4e2a\u53d1\u73b0\u7684\u8d44\u6e90\uff0c\u8fd9\u4e9b\u7c7b\u578b\u6570\u636e\u5b58\u50a8\u5728 xDS \u534f\u8bae\u7684 Discovery Request \u548c Discovery Response \u7684 TypeUrl \u5b57\u6bb5\u4e2d, \u8fd9\u4e2a\u5b57\u6bb5\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u5b58\u50a8\uff1a</p> <p> </p> <pre><code>type.googleapis.com/&lt;resource type&gt;\n</code></pre> <p>\u6bd4\u5982 <code>type.googleapis.com/envoy.api.v2.Cluster</code> \u5c31\u8868\u660e\u662f <code>Cluster</code> \u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u9700\u8981\u6309\u7167 <code>Cluster</code> \u7c7b\u578b\u5904\u7406\u6570\u636e\u3002</p> <p><code>envoy.api.v2.Listener\uff08LDS\uff09</code>\uff1a\u5bf9\u5e94 Listener \u6570\u636e\u7c7b\u578b\uff0c\u5305\u542b\u4e86\u76d1\u542c\u5668\u7684\u540d\u79f0\u3001\u76d1\u542c\u7aef\u53e3\u3001\u76d1\u542c\u5730\u5740\u7b49\u4fe1\u606f\uff0c\u901a\u8fc7\u52a8\u6001\u66f4\u65b0\u6b64\u7c7b\u578b\uff0c\u53ef\u4ee5\u52a8\u6001\u65b0\u589e\u76d1\u542c\u5668\u6216\u8005\u66f4\u65b0\u76d1\u542c\u5668\u7684\u5730\u5740\u7aef\u53e3\u7b49\u4fe1\u606f\u3002</p> <p> </p> <p>LDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"name\": \"...\",\n  \"address\": \"{...}\",\n  \"filter_chains\": [],\n  \"use_original_dst\": \"{...}\",\n  \"per_connection_buffer_limit_bytes\": \"{...}\",\n  \"metadata\": \"{...}\",\n  \"drain_type\": \"...\",\n  \"listener_filters\": [],\n  \"listener_filters_timeout\": \"{...}\",\n  \"continue_on_listener_filters_timeout\": \"...\",\n  \"transparent\": \"{...}\",\n  \"freebind\": \"{...}\",\n  \"socket_options\": [],\n  \"tcp_fast_open_queue_length\": \"{...}\",\n  \"traffic_direction\": \"...\",\n  \"udp_listener_config\": \"{...}\",\n  \"api_listener\": \"{...}\",\n  \"connection_balance_config\": \"{...}\",\n  \"reuse_port\": \"...\",\n  \"access_log\": []\n}\n</code></pre> <p><code>envoy.api.v2.RouteConfiguration\uff08RDS\uff09</code>\uff1a\u5bf9\u5e94 Envoy \u4e2d\u7684 Route \u7c7b\u578b\uff0c\u7528\u4e8e\u66f4\u65b0 <code>virtual_hosts</code>\uff0c\u4ee5\u53ca <code>virtual_hosts</code> \u5305\u542b\u7684\u8def\u7531\u8868\u4fe1\u606f\u3001\u8def\u7531\u89c4\u5219\u3001\u9488\u5bf9\u8def\u7531\u7684\u9650\u6d41\u3001\u8def\u7531\u7ea7\u522b\u7684\u63d2\u4ef6\u7b49\uff0c\u5305\u62ec\u8def\u7531\u5339\u914d\u5230\u7684 Cluster\u3002</p> <p> </p> <p>RDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"name\": \"...\",\n  \"virtual_hosts\": [],\n  \"vhds\": \"{...}\",\n  \"internal_only_headers\": [],\n  \"response_headers_to_add\": [],\n  \"response_headers_to_remove\": [],\n  \"request_headers_to_add\": [],\n  \"request_headers_to_remove\": [],\n  \"most_specific_header_mutations_wins\": \"...\",\n  \"validate_clusters\": \"{...}\"\n}\n</code></pre> <p><code>envoy.api.v2.Cluster\uff08CDS\uff09</code>\uff1a\u5bf9\u5e94 Envoy \u4e2d\u7684 Cluster \u7c7b\u578b\uff0c\u5305\u542b\u4e86 Cluster \u662f\u91c7\u7528\u9759\u6001\u914d\u7f6e\u6570\u636e\uff0c\u8fd8\u662f\u91c7\u7528\u52a8\u6001 EDS \u53d1\u73b0\u7684\u65b9\u5f0f\uff0c\u5305\u62ec Cluster \u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3001\u5065\u5eb7\u68c0\u67e5\u914d\u7f6e\u7b49\uff0c\u4ee5\u53ca\u670d\u52a1\u7ea7\u522b\u7684\u63d2\u4ef6\u8bbe\u7f6e\u3002</p> <p> </p> <p>CDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"transport_socket_matches\": [],\n  \"name\": \"...\",\n  \"alt_stat_name\": \"...\",\n  \"type\": \"...\",\n  \"cluster_type\": \"{...}\",\n  \"eds_cluster_config\": \"{...}\",\n  \"connect_timeout\": \"{...}\",\n  \"per_connection_buffer_limit_bytes\": \"{...}\",\n  \"lb_policy\": \"...\",\n  \"hosts\": [],\n  \"load_assignment\": \"{...}\",\n  \"health_checks\": [],\n  \"max_requests_per_connection\": \"{...}\",\n  \"circuit_breakers\": \"{...}\",\n  \"tls_context\": \"{...}\",\n  \"upstream_http_protocol_options\": \"{...}\",\n  \"common_http_protocol_options\": \"{...}\",\n  \"http_protocol_options\": \"{...}\",\n  \"http2_protocol_options\": \"{...}\",\n  \"extension_protocol_options\": \"{...}\",\n  \"typed_extension_protocol_options\": \"{...}\",\n  \"dns_refresh_rate\": \"{...}\",\n  \"dns_failure_refresh_rate\": \"{...}\",\n  \"respect_dns_ttl\": \"...\",\n  \"dns_lookup_family\": \"...\",\n  \"dns_resolvers\": [],\n  \"use_tcp_for_dns_lookups\": \"...\",\n  \"outlier_detection\": \"{...}\",\n  \"cleanup_interval\": \"{...}\",\n  \"upstream_bind_config\": \"{...}\",\n  \"lb_subset_config\": \"{...}\",\n  \"ring_hash_lb_config\": \"{...}\",\n  \"original_dst_lb_config\": \"{...}\",\n  \"least_request_lb_config\": \"{...}\",\n  \"common_lb_config\": \"{...}\",\n  \"transport_socket\": \"{...}\",\n  \"metadata\": \"{...}\",\n  \"protocol_selection\": \"...\",\n  \"upstream_connection_options\": \"{...}\",\n  \"close_connections_on_host_health_failure\": \"...\",\n  \"drain_connections_on_host_removal\": \"...\",\n  \"filters\": [],\n  \"track_timeout_budgets\": \"...\"\n}\n</code></pre> <p><code>envoy.api.v2.ClusterLoadAssignment\uff08EDS\uff09</code>\uff1aEDS\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u670d\u52a1\u53d1\u73b0\u3002\u5305\u542b\u670d\u52a1\u540d\u3001\u8282\u70b9\u4fe1\u606f\u548c LB \u7b56\u7565\u7b49\u6570\u636e\u3002</p> <p> </p> <p>EDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"cluster_name\": \"...\",\n  \"endpoints\": [],\n  \"policy\": \"{...}\"\n}\n</code></pre> <p><code>envoy.api.v2.Auth.Secret\uff08SDS\uff09</code>\uff1a\u7528\u4e8e\u53d1\u73b0\u8bc1\u4e66\u4fe1\u606f\uff0c\u4ee5\u52a8\u6001\u66f4\u65b0\u8bc1\u4e66\u3002</p> <p>\u65e9\u671f Istio \u4f7f\u7528\u53d8\u66f4 TLS \u8bc1\u4e66\u6587\u4ef6\uff0c\u7136\u540e\u70ed\u91cd\u542f Envoy \u7684\u65b9\u5f0f\u66f4\u65b0\u8bc1\u4e66\uff0c\u73b0\u5728\u901a\u8fc7 SDS \u5373\u53ef\u52a8\u6001\u66f4\u65b0\u8bc1\u4e66\u3002</p> <p> </p> <p>SDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"name\": \"...\",\n  \"tls_certificate\": \"{...}\",\n  \"session_ticket_keys\": \"{...}\",\n  \"validation_context\": \"{...}\",\n  \"generic_secret\": \"{...}\"\n}\n</code></pre> <p><code>Envoy xDS</code> \u534f\u8bae\u6700\u65e9\u5e76\u6ca1\u6709\u91c7\u7528 gRPC \u6d41\u5f0f\u8ba2\u9605\uff0c\u800c\u662f\u91c7\u7528 <code>rest-json</code> \u8f6e\u8be2\u7684\u6a21\u5f0f\u5b9e\u73b0\uff0c\u540e\u6765\u56e0\u4e3a <code>gRPC</code> \u6d41\u5f0f\u8ba2\u9605\u6570\u636e\u66f4\u65b0\u66f4\u52a0\u53ca\u65f6\uff0c\u6027\u80fd\u4e5f\u76f8\u5bf9\u9ad8\u6548\uff0c\u6240\u4ee5\u5728 <code>v2</code> \u7248\u672c\u8f6c\u5411\u4e86 gRPC \u7684\u65b9\u5f0f\u66f4\u65b0\u6570\u636e\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u4e3b\u8981\u770b\u4e00\u4e0b gRPC \u6d41\u5f0f\u8ba2\u9605\u6a21\u5f0f\u3002</p>"},{"location":"chap2/4chap3_xds/#3grpc","title":"3\u3001gRPC \u6d41\u5f0f\u8ba2\u9605","text":""},{"location":"chap2/4chap3_xds/#3-1-api","title":"3-1 API \u8bf7\u6c42\u987a\u5e8f","text":"<p>\u5178\u578b\u7684 HTTP \u8def\u7531\u573a\u666f\uff0c\u5ba2\u6237\u7aef\u9700\u8981\u5148\u83b7\u53d6 Listener \u8d44\u6e90\uff0c\u901a\u8fc7 Listener \u8d44\u6e90\u62ff\u5230 Route \u7684\u914d\u7f6e\u3002</p> <p>Route \u4e2d\u5305\u542b\u4e00\u4e2a\u6216\u8005\u591a\u4e2a Cluster \u96c6\u7fa4\u8d44\u6e90\uff0c\u901a\u8fc7 Cluster \u96c6\u7fa4\u7684\u4fe1\u606f\u518d\u83b7\u53d6\u96c6\u7fa4\u8282\u70b9\u7684\u4fe1\u606f\uff0c\u8fd9\u6837\u6574\u4e2a\u8bf7\u6c42\u94fe\u8def\u5c31\u5b8c\u6210\u4e86\u3002</p>"},{"location":"chap2/4chap3_xds/#3-2","title":"3-2 \u5168\u91cf\u8bf7\u6c42\u548c\u589e\u91cf\u8bf7\u6c42","text":"<p>\u4f20\u7edf\u7684 xDS \u534f\u8bae\u4f1a\u5168\u91cf\u54cd\u5e94\u8ba2\u9605\u6570\u636e\uff0c\u5bf9\u4e8e\u4e2d\u9014\u65b0\u589e\u7684\u8d44\u6e90\u8ba2\u9605\u6765\u8bf4\uff0c\u8fd9\u65e0\u7591\u662f\u8d44\u6e90\u6d6a\u8d39\uff0c\u6240\u4ee5 xDS \u65b0\u589e\u4e86\u589e\u91cf\u8ba2\u9605\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u51fa\u73b0\u65b0\u7684\u8d44\u6e90\u65f6\uff0c\u53ea\u9700\u5411 Management Server \u53d1\u9001\u65b0\u589e\u7684\u8d44\u6e90\uff0cManagement Server \u4e5f\u53ea\u4f1a\u8fd4\u56de\u65b0\u589e\u8d44\u6e90\u7684\u6570\u636e\u3002</p>"},{"location":"chap2/4chap3_xds/#3-3","title":"3-3 \u591a\u6761\u8bf7\u6c42\u6d41\u548c\u5355\u6761\u8bf7\u6c42\u6d41","text":"<p>xDS \u534f\u8bae\u5e76\u4e0d\u7ea6\u675f\u5728\u8bf7\u6c42\u591a\u4e2a\u8d44\u6e90\u65f6\uff0c\u591a\u4e2a\u8d44\u6e90\u4f7f\u7528\u540c\u4e00\u4e2a\u8bf7\u6c42\u6d41\uff0c\u8fd8\u662f\u6bcf\u4e2a\u8d44\u6e90\u5404\u4f7f\u7528\u4e00\u4e2a\u8bf7\u6c42\u6d41\uff0cManagement Server \u5e94\u8be5\u540c\u65f6\u652f\u6301\u8fd9\u4e24\u79cd\u6a21\u5f0f\u3002</p>"},{"location":"chap2/4chap3_xds/#3-4","title":"3-4 \u5728\u4e00\u4e2a\u8fde\u63a5\u8bf7\u6c42\u591a\u4e2a\u8d44\u6e90","text":"<p>\u5728\u65e9\u671f\u7684\u8bbe\u8ba1\u4e2d\uff0cxDS \u88ab\u8bbe\u8ba1\u4e3a\u591a\u4e2a\u8fde\u63a5\uff0c\u6bd4\u5982 CDS\u3001EDS \u5206\u522b\u548c Management Server \u5efa\u7acb\u8fde\u63a5\u3002\u5728\u540e\u7eed\u7684\u6539\u8fdb\u4e2d\uff0c\u652f\u6301\u5728\u4e00\u6761\u8fde\u63a5\u4e2d\u6309\u7167\u987a\u5e8f\u83b7\u53d6 xDS \u4e2d\u7684\u5404\u79cd API\uff0c\u6bd4\u5982\u5148\u8bf7\u6c42 CDS\uff0c\u7136\u540e\u8bf7\u6c42 EDS\u3002</p> <p> </p>"},{"location":"chap2/4chap3_xds/#4xds","title":"4\u3001xDS \u534f\u8bae\u8be6\u89e3","text":""},{"location":"chap2/4chap3_xds/#4-1-xds","title":"4-1 xDS \u534f\u8bae\u8be6\u89e3","text":"<p>xDS API \u7684\u57fa\u7840\u77e5\u8bc6</p> <p>\u4e00\u4e2a\u8bf7\u6c42\u4fe1\u606f\u793a\u4f8b\uff1a</p> <pre><code>version_info:\nnode: { id: envoy }\nresource_names:\n- foo\n- bar\ntype_url: type.googleapis.com/envoy.api.v2.ClusterLoadAssignment\nresponse_nonce:\n</code></pre> <p>\u5982\u4e0a\u8ff0\u5185\u5bb9\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u6d41\u90fd\u5e26\u6709\u4e00\u4e2a <code>version_info</code> \u8868\u660e\u7248\u672c\u4fe1\u606f\u3002\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u7684 <code>version_info</code> \u4e3a\u7a7a\uff0c\u8868\u793a\u8fd9\u662f\u8fde\u63a5\u4e2d\u7684\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u6d41\uff0c\u540e\u7eed\u4f1a\u6839\u636e <code>Management Server</code> \u63a8\u9001\u7684 <code>version_info</code>\u4f20\u9012\u3002</p> <p>Node \u4e2d\u7684 ID \u5219\u8868\u660e\u673a\u5668\u4fe1\u606f\uff0c\u9700\u8981\u4f20\u9012\u673a\u5668\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u53ef\u4ee5\u7528\u673a\u5668\u7684 hostname\u3002</p> <p>\u53ea\u6709\u6d41\u4e0a\u7684\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u9700\u8981\u643a\u5e26\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u540e\u7eed\u5982\u679c\u63a8\u9001\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u4e5f\u4ee5\u7b2c\u4e00\u4e2a\u4e3a\u51c6\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u503c\u5728 Management Server \u4f1a\u88ab\u7ed1\u5b9a\u5728\u8fde\u63a5\u5bf9\u5e94\u7684 stream \u4e0a\u3002</p> <p><code>resource_names</code> \u662f\u4e00\u4e2a\u591a\u6001\u4fe1\u606f\uff0c\u5728\u4e0d\u540c\u7684 xDS \u7c7b\u578b\u4e2d\u8868\u793a\u4e0d\u540c\u7684\u610f\u601d\uff0c\u8fd9\u91cc\u662f Cluster \u96c6\u7fa4\u7684\u540d\u79f0\u3002</p> <p><code>type_url</code> \u8868\u793a xDS \u7684\u7c7b\u578b\uff0c\u8fd9\u91cc\u662f CDS\uff0c\u5373\u96c6\u7fa4\u53d1\u73b0\u670d\u52a1\u3002</p> <p><code>response_nonce</code> \u662f Management Server \u63a8\u9001\u7684\u54cd\u5e94\u552f\u4e00\u6807\u8bc6\uff0c\u54cd\u5e94\u4fe1\u606f\u4e2d\u7684 <code>Nonce</code> \u4f1a\u4f5c\u4e3a\u8bf7\u6c42\u4fe1\u606f\u4e2d\u7684 <code>response_nonce</code> \u53d1\u9001\uff0c\u5c31\u50cf\u4e00\u4f1a\u6211\u4eec\u5c06\u5728\u8d44\u6e90\u66f4\u65b0\u90e8\u5206\u8bb2\u89e3\u7684\u4e00\u6837\uff0c<code>Nonce</code> \u4e3b\u8981\u662f\u7528\u6765\u6d88\u9664 ACK \u548c NACK \u4e4b\u95f4\u7684\u6b67\u4e49\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u56e0\u4e3a\u662f\u9996\u6b21\u8bf7\u6c42\uff0c<code>response_nonce</code> \u4e3a\u7a7a\u3002</p> <pre><code>version_info: X\nresources:\n- foo ClusterLoadAssignment proto encoding\n- bar ClusterLoadAssignment proto encoding\ntype_url: type.googleapis.com/envoy.api.v2.ClusterLoadAssignment\nnonce: A\n</code></pre> <ul> <li><code>version_info</code>\uff1aManagement Server \u54cd\u5e94\u6216\u8005\u63a8\u9001\u7ed9\u5ba2\u6237\u7aef Envoy \u7684\u6d88\u606f\u4e2d\uff0c\u90fd\u4f1a\u643a\u5e26\u4e00\u4e2a\u6700\u65b0\u7684\u7248\u672c\u53f7\u3002</li> <li>resources\uff1a\u8fd9\u4e2a\u662f\u8fd4\u56de\u8bf7\u6c42\u4fe1\u606f\u4e2d <code>resource_names</code> \u5bf9\u5e94\u7684 Protobuf \u534f\u8bae\u7684\u7ed3\u6784\u4f53\u3002</li> <li><code>type_url</code>\uff1a\u548c\u8bf7\u6c42\u4fe1\u606f\u4e2d\u7684\u610f\u601d\u76f8\u540c\u3002</li> <li>Nonce\uff1a\u6bcf\u6b21\u54cd\u5e94\u4f1a\u643a\u5e26\u4e00\u4e2a Nonce \u4f5c\u4e3a\u552f\u4e00\u6807\u8bc6\uff0c\u7528\u4e8e\u5ba2\u6237\u7aef\u7684 ACK/NACK \u6216\u8005\u533a\u5206\u8d44\u6e90\u66f4\u65b0\u5230\u5e95\u662f\u54cd\u5e94\u54ea\u4e2a\u63a8\u9001\u6570\u636e\u3002</li> </ul> <p> </p>"},{"location":"chap2/4chap3_xds/#4-2-ack-nack","title":"4-2 ACK \u548c NACK&amp;","text":"<ul> <li>\u5728\u6536\u5230 Management Server \u63a8\u9001\u7684\u65b0\u7248\u672c\u6570\u636e\u540e\uff0cEnvoy \u4f1a\u54cd\u5e94 ACK \u6216\u8005 NACK \u544a\u77e5 Management Server \u662f\u5426\u66f4\u65b0\u7248\u672c\u6210\u529f\u3002</li> <li>ACK \u4ee3\u8868\u66f4\u65b0\u7248\u672c\u6210\u529f\uff0c\u8fd9\u65f6\u4f1a\u643a\u5e26 Management Server \u63a8\u9001\u7684\u6700\u65b0\u7248\u672c\u53f7\u53d1\u9001 ACK \u4fe1\u606f\uff1b</li> <li>NACK \u4ee3\u8868\u66f4\u65b0\u7248\u672c\u5931\u8d25\uff0c\u8fd9\u65f6\u4f1a\u643a\u5e26\u65e7\u7684\u7248\u672c\u53f7\u53d1\u9001 NACK \u4fe1\u606f\u3002</li> </ul>"},{"location":"chap2/4chap3_xds/#4-3","title":"4-3 \u8d44\u6e90\u66f4\u65b0","text":"<p>\u5982\u679c\u53d1\u73b0\u7684\u6570\u636e\u51fa\u73b0\u53d8\u5316\uff0c\u4f9d\u8d56\u53d1\u73b0\u6570\u636e\u7684\u5176\u4ed6\u914d\u7f6e\u5c31\u8981\u53ca\u65f6\u66f4\u65b0\u3002</p> <p>\u4e3e\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u6bd4\u5982 CDS \u7684 Cluster \u96c6\u7fa4\u4fe1\u606f\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u90a3\u5c31\u610f\u5473\u7740\u7528\u6237\u8981\u8ba2\u9605\u7684\u670d\u52a1\u5217\u8868\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u56e0\u6b64\u9700\u8981\u901a\u8fc7 EDS \u7684\u670d\u52a1\u53d1\u73b0\u4fe1\u606f\uff0c\u4f20\u9012\u65b0\u8ba2\u9605\u7684\u96c6\u7fa4\u4fe1\u606f\u5230 EDS\u3002</p> <p>\u5982\u4e0b\u56fe\u6240\u793a \uff0c\u6bd4\u5982\u6700\u65e9\u7528\u6237\u53ea\u8ba2\u9605\u4e86 foo \u8fd9\u4e2a\u670d\u52a1\uff0c\u4f46\u662f\u8fd9\u65f6 CDS \u4f20\u9012\u4e86\u65b0\u7684 bar \u670d\u52a1\u7ed9\u5230\u4e86 Envoy\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5f80 EDS \u53d1\u9001 foo \u548c bar \u4e24\u4e2a\u670d\u52a1\u7684\u8ba2\u9605\u4fe1\u606f\u3002</p> <p> </p> <ul> <li>\u670d\u52a1 A \u539f\u672c\u4f9d\u8d56\u670d\u52a1 foo\uff0c\u4f46\u7ecf\u8fc7\u4e86\u4e00\u6b21\u7248\u672c\u66f4\u65b0\uff0c\u670d\u52a1 A \u540c\u65f6\u4f9d\u8d56\u670d\u52a1 foo \u548c\u670d\u52a1 bar\uff0c\u8fd9\u4e2a\u65f6\u5019 CDS \u5c31\u4f1a\u63a8\u9001 foo \u548c bar \u7684\u4fe1\u606f\u7ed9\u5230 Envoy\uff0cEnvoy \u5c31\u4f1a\u8ba9 EDS \u8fdb\u884c\u8d44\u6e90\u66f4\u65b0\u3002</li> </ul> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cDiscovery Request \u9664\u4e86\u9996\u6b21\u7528\u6765\u8fdb\u884c\u8d44\u6e90\u8ba2\u9605\uff0c\u540e\u9762\u57fa\u672c\u4e0a\u90fd\u662f\u7528\u6765\u505a ACK \u6216\u8005 NACK \u786e\u8ba4\u7684</p> <ul> <li>Discovery Request \u4f1a\u5728 ACK \u4e4b\u540e\u7528\u76f8\u540c\u7684 version_info \u53d1\u9001\u989d\u5916\u7684 Discovery Request \u4fe1\u606f\uff0c\u8ba9 Management Server \u66f4\u65b0\u8d44\u6e90\u4fe1\u606f\u3002\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5b83\u4f1a\u4e3a\u7248\u672c X \u989d\u5916\u53d1\u9001\u4e00\u4e2a <code>resource_names</code>\uff0c\u4f5c\u4e3a<code>{foo, bar}</code> \u6570\u636e\u7684 Discovery Request \u3002</li> </ul> <p>\u4f46\u662f\uff0c\u4f60\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u91cc\u53ef\u80fd\u4f1a\u53d1\u751f\u51b2\u7a81\u3002\u6bd4\u5982 <code>Management Server</code>\u5728\u6536\u5230 <code>V=X</code>\u7684\u786e\u8ba4\u6d88\u606f\u540e\uff0cfoo \u670d\u52a1\u7684 EndPoints \u4fe1\u606f\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u8fd9\u65f6 <code>Management Server</code>\u4f1a\u63a8\u9001\u4e00\u4e2a\u65b0\u7248\u672c V=Y \u7684\u6d88\u606f\u7ed9 Envoy\uff0c\u5982\u679c Envoy \u53d1\u9001 <code>V=X</code> \u7684\u65b0\u8d44\u6e90\u8ba2\u9605\u6d88\u606f\u7ed9 <code>Management Server</code>\uff0cManagement Server \u53ef\u80fd\u4f1a\u8bef\u8ba4\u4e3a Envoy \u62d2\u7edd\u4e86 <code>V=Y</code> \u7684\u65b0\u7248\u672c\u63a8\u9001\u3002</p> <p>\u90a3\u4e48\u5982\u4f55\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f Envoy \u5f15\u5165\u4e86 Nonce\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u548c\u54cd\u5e94\u90fd\u5bf9\u5e94\u552f\u4e00\u7684 Nonce\uff0c\u56e0\u4e3a Envoy \u7684\u65b0\u8ba2\u9605\u6d88\u606f\u643a\u5e26\u7684 Nonce \u662f A\uff0c\u800c Management Server \u8fd4\u56de\u7684 <code>V=Y</code>\u7684 <code>Nonce</code> \u662f B\uff0c\u6240\u4ee5\u5e76\u4e0d\u4f1a\u8bef\u8ba4\u4e3a\u662f Envoy \u62d2\u7edd\u4e86\u65b0\u6570\u636e\u7684\u66f4\u65b0\u3002</p> <p>Envoy \u7684\u8fd9\u4e2a\u8bbe\u8ba1\u6211\u89c9\u5f97\u6709\u70b9\u7ed5\uff0c\u5b9e\u9645\u4e0a\u5728 Istio \u7684\u63a7\u5236\u9762\u4e2d\uff0c\u4e5f\u5c31\u662f\u8fd9\u91cc\u7684 Management Server\uff0c\u5e76\u6ca1\u6709\u5b8c\u5168\u9075\u5b88\u4e0a\u9762\u63d0\u5230\u7684 <code>Nonce</code>\u548c <code>version_info</code> \u7684\u7ea6\u5b9a\uff0c\u800c\u662f\u91c7\u7528\u4e86\u4e00\u79cd\u66f4\u7b80\u5355\u3001\u76f4\u767d\u7684\u65b9\u5f0f\u89e3\u51b3\u4e0a\u9762\u63d0\u5230\u7684\u51b2\u7a81\u95ee\u9898\u3002</p> <p>Istio \u5224\u65ad\u4e86\u4f20\u9012\u7684 <code>resource_names</code> \u7684 Clusters \u4fe1\u606f\u662f\u5426\u53d1\u751f\u53d8\u5316\uff0c\u5982\u679c\u53d1\u751f\u53d8\u5316\uff0c\u5219\u4e0d\u8ba4\u4e3a\u662f ACK \u6216\u8005 NACK\uff0c\u76f4\u63a5\u5f53\u4f5c\u8d44\u6e90\u66f4\u65b0\u5904\u7406\u3002\u663e\u7136\u8fd9\u6837\u7684\u903b\u8f91\u66f4\u6613\u4e8e\u7406\u89e3\u3002</p> <p> </p>"},{"location":"chap2/4chap3_xds/#5","title":"5\u3001\u603b\u7ed3","text":"<p>Service Mesh \u4e2d\u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u7684\u901a\u4fe1\u6865\u6881\u2014\u2014xDS \u534f\u8bae\uff0c\u901a\u8fc7 xDS \u534f\u8bae\u6211\u4eec\u53ef\u4ee5\u505a\u5230 discovery everything\uff0c\u6240\u6709\u914d\u7f6e\u90fd\u53ef\u4ee5\u901a\u8fc7\u53d1\u73b0\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u8fd9\u662f Envoy xDS \u67b6\u6784\u4e3a\u5fae\u670d\u52a1\u4e16\u754c\u5e26\u6765\u7684\u91cd\u5927\u53d8\u9769\u3002</p> <p> </p>"},{"location":"chap2/5chap3_ingress_egress/","title":"\u7b2c\u4e94\u8282 Ingress \u548c Egress\uff1a\u5165\u53e3\u6d41\u91cf\u548c\u51fa\u53e3\u6d41\u91cf\u63a7\u5236","text":"<p>Ingress \u662f Kubernetes \u96c6\u7fa4\u4e3a\u4e86\u8ba9\u5916\u90e8\u53ef\u4ee5\u8bbf\u95ee\uff0c\u5f15\u5165\u7684\u4e00\u79cd\u8d44\u6e90\u7c7b\u578b\u3002</p> <p>\u4e00\u822c Ingress \u4e3a\u5e38\u89c1\u7684 Nginx \u8fd9\u6837\u7684\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\u63d0\u4f9b\u5177\u4f53\u529f\u80fd\uff0c\u8bf8\u5982\u8d1f\u8f7d\u5747\u8861\u3001SSL \u8bc1\u4e66\u5378\u8f7d\uff0c\u4ee5\u53ca\u57fa\u4e8e\u540d\u79f0\u7684\u865a\u62df\u4e3b\u673a\u529f\u80fd\u3002\u8fd9\u4e9b\u529f\u80fd\u662f\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\u7684\u57fa\u672c\u529f\u80fd\uff0c</p> <p>Ingress \u53ef\u4ee5\u7406\u89e3\u4e3a\u5165\u53e3\u7f51\u5173\uff0c\u800c Egress \u548c Ingress \u7684\u529f\u80fd\u76f8\u4eff\uff0c\u53ea\u662f\u6d41\u91cf\u7684\u4ee3\u7406\u6d41\u5411\u4e0d\u540c\uff0cEgress \u8d1f\u8d23\u51fa\u53e3\u6d41\u91cf\u7684\u4ee3\u7406\u3002</p>"},{"location":"chap2/5chap3_ingress_egress/#1-ingress","title":"1\u3001\u4e3a\u4ec0\u4e48\u9700\u8981 Ingress","text":"<p>\u4e00\u822c\u6765\u8bf4\u6709\u4e24\u79cd\u5e38\u7528\u7684\u65b9\u5f0f\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u5185\u90e8\u7684\u7f51\u7edc\uff0c\u5206\u522b\u662fNodePort \u6a21\u5f0f\u548c Ingress \u6a21\u5f0f\u3002</p> <p> </p>"},{"location":"chap2/5chap3_ingress_egress/#1-1-nodeport","title":"1-1 NodePort \u6a21\u5f0f","text":"<p>\u5728 Kubernetes \u96c6\u7fa4\u5185\u90e8\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Service \u7684\u57df\u540d\u8bbf\u95ee\u670d\u52a1\u7684 Pod\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684 YAML \u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u53ef\u4ee5\u8ba9\u96c6\u7fa4\u5916\u90e8\u901a\u8fc7 NodePort \u7684\u65b9\u5f0f\u8bbf\u95ee\u96c6\u7fa4\u5185\u90e8\u7684\u8d44\u6e90\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: my-service\nspec:\n  type: NodePort\n  selector:\n    app: MyApp\n  ports:\n      # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c`targetPort` \u88ab\u8bbe\u7f6e\u4e3a\u4e0e `port` \u5b57\u6bb5\u76f8\u540c\u7684\u503c\n    - port: 80\n      targetPort: 80\n      # \u53ef\u9009\u5b57\u6bb5\n      # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0cKubernetes \u63a7\u5236\u5e73\u9762\u4f1a\u4ece\u67d0\u4e2a\u8303\u56f4\u5185\u5206\u914d\u4e00\u4e2a\u7aef\u53e3\u53f7\uff08\u9ed8\u8ba4\uff1a30000-32767\uff09\n      nodePort: 30007\n</code></pre> <p>NodePort \u7684\u9ed8\u8ba4\u7aef\u53e3\u8303\u56f4\u662f 30000-32767\uff0c\u4f46\u662f\u4e00\u822c\u4e0d\u5efa\u8bae\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u8fd9\u4e2a\u7aef\u53e3\u8303\u56f4\uff0c\u4ee5\u514d\u5f15\u53d1\u51b2\u7a81\u3002</p> <p>\u5982\u4e0a\u793a\u4f8b\uff0c\u96c6\u7fa4\u5916\u90e8\u9996\u5148\u8bbf\u95ee NodePort \u7684\u7aef\u53e3\uff0c\u793a\u4f8b\u4e2d\u7aef\u53e3\u4e3a 30007\uff0c\u901a\u8fc7 IPVS \u4e00\u7cfb\u5217\u7684\u52ab\u6301\u8def\u7531\u64cd\u4f5c\uff0c\u5c06\u6d41\u91cf\u8def\u7531\u5230\u96c6\u7fa4\u5185\u90e8\u7684 my-service \u670d\u52a1\u7684\u7aef\u53e3 80\uff0c\u8fd9\u4e2a\u7aef\u53e3\u662f ClusterIP \u66b4\u9732\u51fa\u6765\u7684\u7aef\u53e3\uff0c\u5728 Kubernetes \u96c6\u7fa4\u5185\u90e8\u53ef\u4ee5\u901a\u8fc7 <code>ClusterIP:Port</code>\u7684\u65b9\u5f0f\u8bbf\u95ee <code>my-service</code> \u670d\u52a1\u3002</p> <p>Kubernetes \u96c6\u7fa4\u5185\u90e8\u4f1a\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u670d\u52a1\u5bf9\u5e94\u7684 Pod IP \u7684 TargetPort \u4e0a\u9762\u3002</p> <p>\u901a\u8fc7\u51e0\u53f0\u7279\u5b9a\u7684 Node \u673a\u5668\u505a\u6570\u636e\u8f6c\u53d1\uff0c\u4e00\u65e6\u6d41\u91cf\u589e\u52a0\uff0c\u53ef\u80fd\u4f1a\u5f71\u54cd\u8be5\u673a\u5668\u5bbf\u4e3b\u673a\u7684\u7a33\u5b9a\u6027\u3002\u5982\u679c\u96c6\u7fa4\u5bf9\u5916\u66b4\u9732\u591a\u4e2a\u670d\u52a1\uff0c\u7ef4\u62a4\u7684\u96be\u5ea6\u4e5f\u968f\u4e4b\u589e\u52a0\uff0c\u4e0a\u9762\u63d0\u5230\u7684\u6269\u7f29\u5bb9\u95ee\u9898\uff0c\u4f1a\u88ab\u6570\u500d\u653e\u5927\uff1a</p> <p>\u4e00\u53f0 Node \u673a\u5668\u7684\u53d8\u52a8\uff0c\u9700\u8981\u4fee\u6539\u5927\u91cf\u7684\u5165\u53e3\u670d\u52a1\u914d\u7f6e\u3002</p>"},{"location":"chap2/5chap3_ingress_egress/#1-2-ingress","title":"1-2 Ingress \u6a21\u5f0f","text":"<p>\u5ba2\u6237\u7aef\u901a\u8fc7 Ingress \u4e0a\u5b9a\u4e49\u7684\u8def\u7531\u89c4\u5219\uff0c\u8f6c\u53d1\u5230\u7279\u5b9a\u7684 Service \u4e0a\u9762\uff0c\u6bd4\u5982\u901a\u8fc7\u8bbe\u7f6e path\u3001header\u3001host \u7b49\u8def\u7531\u89c4\u5219\u6765\u51b3\u5b9a\u5177\u4f53\u8f6c\u53d1\u5230\u54ea\u4e2a Service\u3002</p> <p> </p> <p>\u901a\u8fc7\u4e0b\u9762\u7684\u914d\u7f6e\u4f60\u53ef\u4ee5\u770b\u5230\uff0cIngress \u662f\u4e00\u79cd\u5168\u65b0\u7684\u8d44\u6e90\u7c7b\u578b\uff0c\u4e0e\u6240\u6709\u5176\u4ed6 Kubernetes \u8d44\u6e90\u4e00\u6837\uff0cIngress \u9700\u8981\u4f7f\u7528 apiVersion\u3001kind \u548c metadata \u5b57\u6bb5\u3002</p> <pre><code>apiVersion: networking.Kubernetes.io/v1\nkind: Ingress\nmetadata:\n  name: minimal-ingress\n  annotations:\n    nginx.ingress.kubernetes.io/rewrite-target: /\nspec:\n  rules:\n  - http:\n      paths:\n      - path: /testpath\n        pathType: Prefix\n        backend:\n          service:\n            name: test\n            port:\n              number: 80\n</code></pre> <p>\u6211\u4eec\u6765\u770b\u4e00\u4e0b\uff0c Ingress \u8d44\u6e90\u7c7b\u578b\u7279\u6709\u7684\u51e0\u4e2a\u5b57\u6bb5\u7684\u542b\u4e49\u3002</p> <ul> <li><code>host</code>\uff1a\u53ef\u9009\u62e9\u548c\u57df\u540d\u5339\u914d\u7684 host\uff0c\u6bd4\u5982\u5982\u679c\u8bbe\u7f6e host \u5b57\u6bb5 <code>foo.bar.com</code>\uff0c\u5219\u9700\u8981\u901a\u8fc7 foo.bar.com \u7684\u57df\u540d\u8bbf\u95ee\u3002\u5982\u679c\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u6ca1\u6709\u8bbe\u7f6e host \u5b57\u6bb5\uff0c\u5219\u8868\u660e\u4efb\u4f55\u57df\u540d\u8fc7\u6765\u7684\u8bf7\u6c42\u90fd\u53ef\u4ee5\u5339\u914d\u3002</li> <li><code>http.paths.path</code>\uff1a\u7528\u4e8e\u8bf7\u6c42 path \u7684\u5339\u914d\uff0c\u6bd4\u5982\u8fd9\u4e2a\u4f8b\u5b50\u901a\u8fc7 pathType:Prefix \u524d\u7f00\u5339\u914d\u7684\u65b9\u5f0f\uff0c\u6240\u6709 path \u4e2d\u524d\u7f00\u4e3a <code>/testpath</code> \u7684\u8def\u5f84\uff0c\u90fd\u4f1a\u88ab\u5339\u914d\u5230\uff1b\u800c\u5176\u4ed6\u6ca1\u6709\u5339\u914d\u5230\u7684 path \u5c31\u4f1a\u8fd4\u56de 404\u3002</li> <li><code>http.paths.backend</code>\uff1a\u5176\u4e2d name \u5b57\u6bb5\u8868\u793a\u670d\u52a1\u540d\uff0c\u8fd9\u4e2a\u670d\u52a1\u540d\u548c Kubernetes \u4e2d\u7684Service \u540d\u79f0\u76f8\u5339\u914d\uff1bport \u5219\u662f Service \u7684\u7aef\u53e3\u53f7\uff0c\u6d41\u91cf\u4f1a\u901a\u8fc7 clusterIP:port \u7684\u65b9\u5f0f\u88ab\u8f6c\u53d1\u5230\u7279\u5b9a\u670d\u52a1\u3002</li> </ul>"},{"location":"chap2/5chap3_ingress_egress/#2ingressclass","title":"2\u3001IngressClass \u8d44\u6e90\u7c7b\u578b","text":"<p>\u5728 Kubernetes1.18 \u7248\u672c\u4e4b\u524d\uff0cIngressClass \u662f\u901a\u8fc7 Ingress \u4e2d\u7684\u4e00\u4e2a <code>kubernetes.io/ingress.class</code>\u6ce8\u89e3\u6765\u6307\u5b9a\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4ece 1.18 \u5f00\u59cb\u5982\u4f55\u914d\u7f6e Ingress Class\u3002</p> <p>\u901a\u8fc7\u5728 Ingress \u8d44\u6e90\u7c7b\u578b\u4e2d\u8bbe\u7f6e <code>IngressClassName</code> \u6765\u6307\u5b9a\u7279\u5b9a\u7684 <code>IngressClass</code> \u914d\u7f6e\uff0c<code>IngressClass</code> \u7684\u914d\u7f6e\u5982\u4e0b\uff0c\u5176\u4e2d\u5305\u542b\u4e86 <code>ingress-controller</code> \u7684\u540d\u79f0\uff0c</p> <p>\u5728\u8fd9\u91cc <code>ingress-controller</code> \u540d\u79f0\u4e3a<code>example.com/ingress-controller</code>\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: IngressClass\nmetadata:\n  name: external-lb\nspec:\n  controller: example.com/ingress-controller\n  parameters:\n    apiGroup: k8s.example.com\n    kind: IngressParameters\n    name: external-lb\n</code></pre>"},{"location":"chap2/5chap3_ingress_egress/#2-1-ingress-controller","title":"2-1 ingress-controller","text":"<p>ingress-controller \u5e76\u4e0d\u662f\u968f\u7740 Kubernetes \u96c6\u7fa4\u4e00\u8d77\u542f\u52a8\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u5982\u4f55\u5728 Minukube \u73af\u5883\u4e2d\u4f7f\u7528 Nginx ingress-controller\u3002</p> <p>\u542f\u52a8 Minukube \u96c6\u7fa4\uff0c\u9700\u8981\u5148\u5220\u9664\u5df2\u6709\u7684 Minukube \u96c6\u7fa4\uff1a</p> <pre><code>minikube delete\n</code></pre> <p>\u7136\u540e\u901a\u8fc7\u865a\u62df\u673a\u65b9\u5f0f\u542f\u52a8\uff0c\u56e0\u4e3a Ingress \u7684 Addon \u65e0\u6cd5\u5728 Docker \u6a21\u5f0f\u4f7f\u7528\uff1a</p> <pre><code>minikube start --kubernetes-version=v1.19.2 --vm=true\n</code></pre> <p>\u542f\u52a8 ingress-controller \uff1a</p> <pre><code>minikube addons enable ingress\n</code></pre> <p>\u90e8\u7f72 helloapp\uff1a</p> <pre><code>kubectl create deployment web --image=gcr.io/google-samples/hello-app:1.0\n</code></pre> <p>\u521b\u5efa Ingress \u8d44\u6e90\uff1a</p> <pre><code>kubectl apply -f https://k8s.io/examples/service/networking/example-ingress.yaml\n</code></pre> <p>\u901a\u8fc7 minikube iP \u547d\u4ee4\u83b7\u53d6 Ip \u5730\u5740\uff0c\u5e76\u4fee\u6539 <code>/etc/hosts</code>\uff0c\u5c06\u5176\u6dfb\u52a0\u5728\u6587\u4ef6\u7ed3\u5c3e\uff0c\u4ee3\u7801\u4e2d <code>127.0.0.1</code> \u5c31\u662f minikube ip \u83b7\u53d6\u7684 IP\uff1a</p> <pre><code>127.0.0.1 hello-world.info\n</code></pre> <p>\u901a\u8fc7 cURL \u6216\u8005\u6d4f\u89c8\u5668\u8bbf\u95ee hello-world.info\uff1a</p> <pre><code>curl hello-world.info\n</code></pre> <p>\u81f3\u6b64\uff0cKubernetes \u539f\u751f\u7684 Ingress \u5c31\u8bb2\u5b8c\u4e86\u3002</p> <p>Ingress \u89e3\u51b3\u4e86 NodePod \u914d\u7f6e\u4e0d\u65b9\u4fbf\u7684\u95ee\u9898\uff0c\u4f46\u901a\u8fc7 YAML \u7684\u65b9\u5f0f\u63a7\u5236 Ingress \u4f9d\u7136\u662f\u4e00\u4ef6\u9ebb\u70e6\u4e8b\uff0c\u53e6\u5916 Ingress \u5185\u90e8\u4f9d\u7136\u662f\u4f7f\u7528 ClusterIP \u7684\u65b9\u5f0f\u6765\u8bbf\u95ee Service\uff0c\u800c\u8fd9\u6837\u7684\u65b9\u5f0f\u662f\u901a\u8fc7 IPVS \u56db\u5c42\u8f6c\u53d1\u505a\u5230\u7684\u3002</p>"},{"location":"chap2/5chap3_ingress_egress/#3istio-gateway","title":"3\u3001Istio Gateway","text":"<p>Istio \u91c7\u7528\u4e86\u4e00\u79cd\u65b0\u7684\u6a21\u578b\u2014\u2014Istio Gateway \u6765\u4ee3\u66ff Kubernetes \u4e2d\u7684 Ingress \u8d44\u6e90\u7c7b\u578b\u3002</p> <p>Gateway \u5141\u8bb8\u5916\u90e8\u6d41\u91cf\u8bbf\u95ee\u5185\u90e8\u670d\u52a1\uff0c\u5f97\u76ca\u4e8e Istio \u5f3a\u5927\u7684\u63a7\u5236\u9762\u914d\u7f6e\uff0cGateway \u8d44\u6e90\u7c7b\u578b\u7684\u914d\u7f6e\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u6d41\u91cf\u8f6c\u53d1\u5373\u53ef\u3002</p> <pre><code>minikube delete\n\nminikube start --kubernetes-version=v1.19.2 --driver=docker\nminikube tunnel\n</code></pre> <p>\u8fd9\u6837\u5916\u90e8\u5c31\u53ef\u4ee5\u901a\u8fc7 Minikube IP \u8bbf\u95ee\u96c6\u7fa4\u5185\u90e8\u7684\u8d44\u6e90\u4e86\u3002</p> <p>\u4e0b\u9762\u8fdb\u5165 Istio \u76ee\u5f55\uff0c\u90e8\u7f72\u4e00\u4e2a\u6d4b\u8bd5\u670d\u52a1\uff1a</p> <pre><code>kubectl apply -f samples/httpbin/httpbin.yaml\n</code></pre> <p>\u901a\u8fc7\u547d\u4ee4\u67e5\u770b Pod \u662f\u5426\u6210\u529f\u542f\u52a8\uff0c\u6839\u636e\u673a\u5668\u914d\u7f6e\u4e0d\u540c\uff0c\u8fd9\u91cc\u7684 Pod \u542f\u52a8\u53ef\u80fd\u9700\u8981\u4e00\u5b9a\u7684\u65f6\u95f4\uff0c\u8bf7\u8010\u5fc3\u7b49\u5f85 pod \u542f\u52a8\u6210\u529f\uff1a</p> <pre><code>$ kubectl get pods\nNAME                              READY   STATUS     RESTARTS   AGE\ndetails-v1-79c697d759-gt9th       2/2     Running    7          95d\nhttpbin-74fb669cc6-jzs87          0/2     Init:0/1   0          7s\nproductpage-v1-65576bb7bf-wjkjm   2/2     Running    7          95d\nratings-v1-7d99676f7f-h9blt       2/2     Running    6          95d\nreviews-v1-987d495c-pmnb9         2/2     Running    7          95d\nreviews-v2-6c5bf657cf-qd2kr       2/2     Running    7          95d\nreviews-v3-5f7b9f4f77-gnv4c       2/2     Running    7          95d\n</code></pre> <p>\u521b\u5efa Istio Gateway\uff0c\u6ce8\u610f\uff1a\u8fd9\u91cc\u8bbe\u7f6e\u4e86 hosts \u4e3a <code>httpbin.example.com</code>\uff0c\u4e5f\u5c31\u662f\u53ea\u6709 host \u4e3a<code>httpbin.example.com</code> \u624d\u80fd\u6b63\u786e\u8bbf\u95ee httpbin \u7684\u670d\u52a1\uff1a</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: httpbin-gateway\nspec:\n  selector:\n    istio: ingressgateway # use Istio default gateway implementation\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    hosts:\n    - \"httpbin.example.com\"\nEOF\n</code></pre> <p>\u5c06 httpbin \u670d\u52a1\u66b4\u9732\u7ed9 <code>Istio Gateway</code>\uff0c\u5176\u4e2d <code>destination</code> \u4e2d\u7684 host \u5b57\u6bb5\u4e3a <code>Istio Service</code> \u914d\u7f6e\u4e2d\u7684\u670d\u52a1\u540d\uff0cEnvoy \u4f1a\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u5c06\u6d41\u91cf\u8def\u7531\u5230 <code>httpbin</code> \u5bf9\u5e94\u7684 Pod IP\uff1a</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: httpbin\nspec:\n  hosts:\n  - \"httpbin.example.com\"\n  gateways:\n  - httpbin-gateway\n  http:\n  - match:\n    - uri:\n        prefix: /status\n    - uri:\n        prefix: /delay\n    route:\n    - destination:\n        port:\n          number: 8000\n        host: httpbin\nEOF\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7 cURL \u8bbf\u95ee\u7279\u5b9a\u7684 URL Path \u5c31\u53ef\u4ee5\u8bbf\u95ee\u8be5\u670d\u52a1\u4e86\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff1a</p> <p>\u9700\u8981\u8bbe\u7f6e host \u4e3a<code>httpbin.example.com</code>\u3002\u56e0\u4e3a\u5728\u524d\u9762\u7684 Gateway \u914d\u7f6e\u4e2d\uff0c\u6211\u4eec\u7ed1\u5b9a\u4e86 host\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 <code>/etc/hosts</code> \u6765\u7ed1\u5b9a\u57df\u540d\u4e3a\u672c\u5730\u5730\u5740\uff1a</p> <pre><code>curl -I -HHost:httpbin.example.com http://127.0.0.1/status/200\nHTTP/1.1 200 OK\nserver: istio-envoy\ndate: Mon, 08 Feb 2021 04:42:54 GMT\ncontent-type: text/html; charset=utf-8\naccess-control-allow-origin: *\naccess-control-allow-credentials: true\ncontent-length: 0\nx-envoy-upstream-service-time: 327\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u5339\u914d\u5230\u8def\u7531\u89c4\u5219\uff0c\u5219\u4f1a\u8fd4\u56de404\uff1a</p> <pre><code>$ curl -I -HHost:httpbin.example.com http://127.0.0.1/1status/200\nHTTP/1.1 404 Not Found\ndate: Mon, 08 Feb 2021 04:45:50 GMT\nserver: istio-envoy\ntransfer-encoding: chunked\n</code></pre> <p>\u901a\u8fc7\u547d\u4ee4\u67e5\u770b Envoy \u65e5\u5fd7\uff0c\u8fd9\u91cc\u7684 <code>httpbin-74fb669cc6-jzs87</code> \u662f\u901a\u8fc7\u4e0a\u9762 kubectl get pods \u547d\u4ee4\u83b7\u53d6\u5230\u7684 Pod \u540d\u79f0\uff0c\u9700\u8981\u52a0\u4e0a -c container \u7684\u540d\u79f0\u6765\u67e5\u770b Envoy \u7684\u65e5\u5fd7\uff1a</p> <pre><code> kubectl logs  httpbin-74fb669cc6-jzs87 -c istio-proxy\n</code></pre> <p>\u8fd9\u91cc\u6211\u5217\u4e86\u51e0\u6761\u521a\u624d\u8bbf\u95ee\u4ea7\u751f\u7684 Envoy \u65e5\u5fd7\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u6709\u6b63\u786e\u7684 200 \u65e5\u5fd7\u548c\u9519\u8bef\u7684 404 \u65e5\u5fd7\uff1a</p> <pre><code>2021-02-08T04:29:17.701261Z info    Envoy proxy is ready\n[2021-02-08T04:42:54.644Z] \"HEAD /status/200 HTTP/1.1\" 200 - \"-\" \"-\" 0 0 225 199 \"172.17.0.2\" \"curl/7.54.0\" \"be1d93ab-32b3-9882-8c34-87dd39ddf6ab\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:34580 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default\n[2021-02-08T04:45:14.862Z] \"HEAD /status2/200 HTTP/1.1\" 404 - \"-\" \"-\" 0 0 351 337 \"172.17.0.2\" \"curl/7.54.0\" \"b433ee7d-6f89-9854-bee7-eeed33884003\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:36896 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default\n[2021-02-08T04:45:57.688Z] \"HEAD /status/500 HTTP/1.1\" 500 - \"-\" \"-\" 0 0 14 11 \"172.17.0.2\" \"curl/7.54.0\" \"5ca2dbf4-473f-9dd0-97a0-397a98f2805c\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:37604 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default\n[2021-02-08T04:46:04.233Z] \"HEAD /status/400 HTTP/1.1\" 400 - \"-\" \"-\" 0 0 3 2 \"172.17.0.2\" \"curl/7.54.0\" \"4c6e9a80-74f4-98bb-ba3e-8140a4a16099\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:37722 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default\n[2021-02-08T04:53:33.695Z] \"HEAD /status/500 HTTP/1.1\" 500 - \"-\" \"-\" 0 0 4 2 \"172.17.0.2\" \"curl/7.54.0\" \"6865f4bf-c407-9fa2-a6e2-f14668a9ba63\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:45104 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default\n</code></pre> <p>\u6700\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\uff0c\u6e05\u9664 httpbin \u670d\u52a1\u548c\u76f8\u5173\u7684 Istio Gateway \u914d\u7f6e\uff1a</p> <pre><code>$ kubectl delete gateway httpbin-gateway\n$ kubectl delete virtualservice httpbin\n$ kubectl delete --ignore-not-found=true -f samples/httpbin/httpbin.yaml\n</code></pre> <p>Gateway \u7c7b\u578b\u5229\u7528 Envoy \u7684\u5f3a\u5927\u529f\u80fd\uff0c\u53ef\u4ee5\u5b9e\u73b0\u8def\u7531\u5c42\u4e30\u5bcc\u7684\u914d\u7f6e\u3002\u8fd9\u4e9b\u529f\u80fd\u548c\u7f51\u683c\u5185\u90e8\u63d0\u4f9b\u7684\u529f\u80fd\u3001\u914d\u7f6e\u65b9\u5f0f\u4e00\u6837\uff0c\u5305\u62ec\u7194\u65ad\u3001\u4e30\u5bcc\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3001\u670d\u52a1\u53d1\u73b0\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u4f60\u4e5f\u53ef\u4ee5\u89e3\u51b3 Kubernetes Ingress \u56db\u5c42\u8def\u7531\u7684\u7f3a\u9677\u3002</p>"},{"location":"chap2/5chap3_ingress_egress/#4egress","title":"4\u3001Egress \u51fa\u53e3\u6d41\u91cf","text":"<p>Egress \u51fa\u53e3\u6d41\u91cf\u662f\u4e91\u539f\u751f\u5f15\u5165\u7684\u65b0\u7684\u8bbe\u8ba1\u6a21\u5f0f\u548c\u67b6\u6784\uff0c\u5728\u4f20\u7edf\u7684 Web \u67b6\u6784\u4e2d\uff0c\u5f88\u5c11\u6709\u51fa\u53e3\u7f51\u5173\u7684\u6982\u5ff5\u3002</p>"},{"location":"chap2/5chap3_ingress_egress/#4-1-kubernetes-egress","title":"4-1 Kubernetes \u4e2d\u7684 Egress","text":"<p>\u76f8\u8f83\u4e8e Kubernetes \u4e2d Ingress \u7684\u5f3a\u5927\u529f\u80fd\uff0cKubernetes \u4e2d\u7684 Egress \u5c31\u663e\u5f97\u6bd4\u8f83\u5f31\u4e86\uff0cKubernetes \u7684 Egress \u5e76\u6ca1\u6709\u5f15\u5165\u50cf Nginx \u8fd9\u6837\u7684\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u53ea\u662f\u5728 IP \u5730\u5740\u6216\u7aef\u53e3\u5c42\u9762\uff08OSI \u7b2c 3 \u5c42\u6216\u7b2c 4 \u5c42\uff09\u63a7\u5236\u7f51\u7edc\u6d41\u91cf\u3002</p> <p>\u901a\u8fc7 Network Policy \u7684\u8d44\u6e90\uff0c\u53ef\u4ee5\u914d\u7f6e\u5728\u4e09\u5c42\u6216\u8005\u56db\u5c42\u7f51\u7edc\u7684 Ingress \u6216\u8005 Egress \u7b56\u7565\u3002\u8fd9\u91cc\u7684\u914d\u7f6e\u8bbe\u7f6e\u4e86\u4e00\u4e9b IP \u548c\u7aef\u53e3\u7684\u9ed1\u767d\u540d\u5355\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: test-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      role: db\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    - ipBlock:\n        cidr: 172.17.0.0/16\n        except:\n        - 172.17.1.0/24\n    - namespaceSelector:\n        matchLabels:\n          project: myproject\n    - podSelector:\n        matchLabels:\n          role: frontend\n    ports:\n    - protocol: TCP\n      port: 6379\n  egress:\n  - to:\n    - ipBlock:\n        cidr: 10.0.0.0/24\n    ports:\n    - protocol: TCP\n      port: 5978\n</code></pre>"},{"location":"chap2/5chap3_ingress_egress/#4-2-istio-egress","title":"4-2 Istio Egress","text":"<p>Istio Egress \u548c Kubernetes \u4e2d\u7684 Egress \u4e0d\u540c\uff0cIstio\u7684 Egress \u672c\u8d28\u4e0a\u662f\u4e00\u4e2a Envoy Proxy\uff0c\u901a\u8fc7 Envoy \u5f3a\u5927\u7684\u4e03\u5c42\u4ee3\u7406\u529f\u80fd\uff0c\u63d0\u4f9b\u4e30\u5bcc\u7684\u8def\u7531\u7b56\u7565\uff0c</p> <p>\u800c\u4e0d\u5c40\u9650\u4e8e\u7b80\u5355\u7684\u56db\u5c42\u7f51\u7edc IP \u7aef\u53e3\u9ed1\u767d\u540d\u5355\u7684\u914d\u7f6e\u3002</p> <p>\u901a\u8fc7\u4e0b\u9762\u7684\u67b6\u6784\u56fe\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a\u670d\u52a1\u7684\u672c\u5730 Proxy \u53ef\u4ee5\u901a\u8fc7\u8fde\u63a5\u5230 Egress Gateway \u8bbf\u95ee\u5916\u90e8\u670d\u52a1\uff0c\u8fbe\u5230\u7cbe\u51c6\u7684\u5b89\u5168\u7b56\u7565\u63a7\u5236\u3002</p> <p> </p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1 Sleep\uff1a</p> <pre><code>$ kubectl apply -f samples/sleep/sleep.yaml\n</code></pre> <pre><code>$ kubectl get all | grep sleep\npod/sleep-557747455f-w95vv            2/2     Running   0          58s\nservice/sleep         ClusterIP   10.100.21.83     &lt;none&gt;        80/TCP     58s\ndeployment.apps/sleep            1/1     1            1           58s\nreplicaset.apps/sleep-557747455f            1         1         1       58s\n</code></pre> <p>\u8bbe\u7f6e Pod \u7684\u73af\u5883\u53d8\u91cf\uff1a</p> <pre><code>export SOURCE_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})\n</code></pre> <pre><code>$ kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name}\nsleep-557747455f-w95vv\n\nexport SOURCE_POD=sleep-557747455f-w95vv\n</code></pre> <p>\u5728\u8bbe\u7f6e\u7b56\u7565\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u5c1d\u8bd5\u4ece Pod \u5185\u90e8\u8bbf\u95ee\u5916\u90e8\u670d\u52a1\uff1a</p> <pre><code>kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://www.douban.com | grep  \"HTTP/\"; \nkubectl exec -it $SOURCE_POD -c sleep -- curl -I https://edition.cnn.com | grep \"HTTP/\"\n</code></pre> <p>\u53ef\u4ee5\u5f97\u5230\u4ee5\u4e0b\u7ed3\u679c\uff0c\u8868\u660e\u8bbf\u95ee\u5916\u90e8\u6b63\u5e38\uff1a</p> <pre><code>HTTP/1.1 200 OK\nHTTP/2 200\n</code></pre> <pre><code>$ kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://www.douban.com | grep  \"HTTP/\"; \nHTTP/1.1 200 OK\n</code></pre> <p>\u901a\u8fc7\u4e0b\u8ff0\u547d\u4ee4\uff0c\u67e5\u770b Istio Egress Gateway \u662f\u5426\u90e8\u7f72\uff1a</p> <pre><code>$  kubectl get pod -l istio=egressgateway -n istio-system\nNAME                                   READY   STATUS    RESTARTS   AGE\nistio-egressgateway-5547fcc8fc-flqkt   1/1     Running   2          13d\n</code></pre> <p>\u521b\u5efa\u4e00\u4e2a ServiceEntry\uff0c\u5141\u8bb8\u6d41\u91cf\u76f4\u63a5\u8bbf\u95ee\u4e00\u4e2a\u5916\u90e8\u670d\u52a1</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: cnn\nspec:\n  hosts:\n  - edition.cnn.com\n  ports:\n  - number: 80\n    name: http-port\n    protocol: HTTP\n  - number: 443\n    name: https\n    protocol: HTTPS\n  resolution: DNS\nEOF\n</code></pre> <p>\u4e3a <code>edition.cnn.com</code> \u7aef\u53e3<code>80</code> \u521b\u5efa <code>Egress Gateway</code>\uff0c\u5e76\u4e3a\u6307\u5411 <code>Egress Gateway</code> \u7684\u6d41\u91cf\u521b\u5efa\u4e00\u4e2a <code>Destination Rule</code>\uff1a</p> <pre><code>$ kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-egressgateway\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    hosts:\n    - edition.cnn.com\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: egressgateway-for-cnn\nspec:\n  host: istio-egressgateway.istio-system.svc.cluster.local\n  subsets:\n  - name: cnn\nEOF\n</code></pre> <p>\u5b9a\u4e49\u4e00\u4e2a VirtualService\uff0c\u5c06\u6d41\u91cf\u4ece Sidecar \u5f15\u5bfc\u81f3 Egress Gateway\uff0c\u518d\u4ece Egress Gateway \u5f15\u5bfc\u81f3\u5916\u90e8\u670d\u52a1\uff1a</p> <pre><code>$ kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: direct-cnn-through-egress-gateway\nspec:\n  hosts:\n  - edition.cnn.com\n  gateways:\n  - istio-egressgateway\n  - mesh\n  http:\n  - match:\n    - gateways:\n      - mesh\n      port: 80\n    route:\n    - destination:\n        host: istio-egressgateway.istio-system.svc.cluster.local\n        subset: cnn\n        port:\n          number: 80\n      weight: 100\n  - match:\n    - gateways:\n      - istio-egressgateway\n      port: 80\n    route:\n    - destination:\n        host: edition.cnn.com\n        port:\n          number: 80\n      weight: 100\nEOF\n</code></pre> <p>\u67e5\u770b istio-egressgateway \u65e5\u5fd7\uff1a</p> <pre><code>kubectl logs -l istio=egressgateway -c istio-proxy -n istio-system | tail\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u65e5\u5fd7\uff0c\u8868\u660e\u6d41\u91cf\u7ecf\u8fc7\u4e86 Egress Gateway\uff1a</p> <pre><code>[2021-02-08T06:02:46.098Z] \"GET /politics HTTP/2\" 301 - \"-\" \"-\" 0 0 162 147 \"172.18.0.17\" \"curl/7.69.1\" \"57d13492-b521-961b-bd93-90ab3f0e295e\" \"edition.cnn.com\" \"151.101.129.67:80\" outbound|80||edition.cnn.com 172.18.0.4:41758 172.18.0.4:8080 172.18.0.17:32816 - -\n</code></pre> <p>\u6e05\u9664\u670d\u52a1\u76f8\u5173\u914d\u7f6e\uff1a</p> <pre><code>$ kubectl delete gateway istio-egressgateway\n$ kubectl delete serviceentry cnn\n$ kubectl delete virtualservice direct-cnn-through-egress-gateway\n$ kubectl delete destinationrule egressgateway-for-cnn\n</code></pre> <p>\u81f3\u6b64\uff0cIstio Egress Gateway \u5c31\u914d\u7f6e\u5b8c\u6210\u4e86\uff0c\u901a\u8fc7\u8fd9\u90e8\u5206\u7684\u5b66\u4e60\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Istio Egress Gateway \u7684\u5f3a\u5927\u914d\u7f6e\uff0c\u901a\u8fc7 Egress Gateway \u6211\u4eec\u53ef\u4ee5\u5bf9\u5916\u90e8\u6d41\u91cf\u8fdb\u884c\u6743\u9650\u63a7\u5236\u548c\u7cbe\u51c6\u7684\u8def\u7531\u5339\u914d\u8bbf\u95ee\u3002</p> <p>\u5728\u5b9e\u9645\u5de5\u4f5c\u7684\u9879\u76ee\u4e2d\uff0c\u6211\u501f\u9274\u4e86 Istio Egress Gateway \u7684\u601d\u60f3\uff0c\u5c06\u6240\u6709\u5916\u90e8\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u8bbf\u95ee\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230 Egress Gateway\uff0c\u7ecf\u7531 Egress Gateway \u8bbf\u95ee\u51fa\u53bb\uff0c\u901a\u8fc7\u8fd9\u6837\u7684\u65b9\u5f0f\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u7684\u5ef6\u65f6\uff0c\u7ef4\u6301 HTTP \u7684 KeepAlive \u957f\u8fde\u63a5\u3002</p> <p>\u56e0\u4e3a\u5982\u679c\u670d\u52a1\u7684\u673a\u5668\u6570\u91cf\u8fc7\u591a\uff0c\u8bbf\u95ee\u5916\u90e8\u9891\u7387\u53c8\u4e0d\u662f\u5f88\u9ad8\uff0c\u4e0e\u5916\u90e8\u670d\u52a1\u7684\u8fde\u63a5\u5c31\u5f88\u5bb9\u6613\u65ad\u6389\uff0c\u4e0d\u5f97\u4e0d\u91cd\u65b0\u5efa\u8fde\uff0c\u800c\u73b0\u5728\u5927\u591a\u6570\u5916\u90e8\u670d\u52a1\u90fd\u662f HTTPS \u7684\uff0c\u9700\u8981\u6d88\u8017\u8fc7\u591a\u7684 SSL \u63e1\u624b\u65f6\u95f4\u3002</p> <p> </p>"},{"location":"chap2/6chap3_canary/","title":"\u7b2c\u516d\u8282 \u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u7248\u672c\u63a7\u5236","text":""},{"location":"chap2/6chap3_canary/#1kubernetes","title":"1\u3001Kubernetes \u4e2d\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03","text":"<p>\u5982\u4f55\u5728 Kubernetes \u4e2d\u8fdb\u884c\u7248\u672c\u66f4\u65b0</p> <p>\u9996\u5148\u542f\u52a8 Minikube \u73af\u5883\uff1a</p> <pre><code>minikube start --kubernetes-version=v1.19.2 --driver=docker\n</code></pre> <p>\u521b\u5efa <code>controllers/nginx-deployment.yaml</code> \u7684\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n\u00a0 name: nginx-deployment\n\u00a0 labels:\n\u00a0 \u00a0 app: nginx\nspec:\n\u00a0 replicas: 3\n\u00a0 selector:\n\u00a0 \u00a0 matchLabels:\n\u00a0 \u00a0 \u00a0 app: nginx\n\u00a0 template:\n\u00a0 \u00a0 metadata:\n\u00a0 \u00a0 \u00a0 labels:\n\u00a0 \u00a0 \u00a0 \u00a0 app: nginx\n\u00a0 \u00a0 spec:\n\u00a0 \u00a0 \u00a0 containers:\n\u00a0 \u00a0 \u00a0 - name: nginx\n\u00a0 \u00a0 \u00a0 \u00a0 image: nginx:1.14.2\n\u00a0 \u00a0 \u00a0 \u00a0 ports:\n\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 80\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff1a\u6211\u4eec\u521b\u5efa\u4e86 3 \u4e2a\u526f\u672c\u6570\u91cf\u7684 Nginx\uff0c\u7248\u672c\u53f7\u4e3a 1.14.2\u3002</p> <p>\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u521b\u5efa Deployment\uff1a</p> <pre><code>kubectl apply -f https://k8s.io/examples/controllers/nginx-deployment.yaml\n</code></pre> <p>\u901a\u8fc7\u547d\u4ee4\u67e5\u770b Pod \u7684\u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>kubectl get pods --show-labels \u00a0-o wide\n</code></pre> <p>\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p> <pre><code>NAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 READY\u00a0 \u00a0STATUS\u00a0 \u00a0 RESTARTS\u00a0 \u00a0AGE\u00a0 \u00a0 IP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0NODE\u00a0 \u00a0 \u00a0 \u00a0NOMINATED NODE\u00a0 \u00a0READINESS GATES\u00a0 \u00a0LABELS\nnginx-deployment-66b6c48dd5-b92bv\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2m5s\u00a0 \u00a0172.18.0.3\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=66b6c48dd5\nnginx-deployment-66b6c48dd5-hshnm\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2m5s\u00a0 \u00a0172.18.0.4\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=66b6c48dd5\nnginx-deployment-66b6c48dd5-tfwfc\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2m5s\u00a0 \u00a0172.18.0.5\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=66b6c48dd5\n</code></pre> <p>\u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u4f7f\u7528\u547d\u4ee4\u67e5\u770b Deployment\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>kubectl describe deployments\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 Nginx \u7684\u7248\u672c\u4e3a 1.14.2\uff1a</p> <pre><code>Pod Template:\n\u00a0 Labels:\u00a0 app=nginx\n\u00a0 Containers:\n\u00a0 \u00a0nginx:\n\u00a0 \u00a0 Image:\u00a0 \u00a0 \u00a0 \u00a0 nginx:1.14.2\n\u00a0 \u00a0 Port:\u00a0 \u00a0 \u00a0 \u00a0 \u00a080/TCP\n\u00a0 \u00a0 Host Port:\u00a0 \u00a0 0/TCP\n\u00a0 \u00a0 Environment:\u00a0 &lt;none&gt;\n\u00a0 \u00a0 Mounts:\u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\n\u00a0 Volumes:\u00a0 \u00a0 \u00a0 \u00a0 &lt;none&gt;\n</code></pre> <p>\u4e0b\u9762\u6211\u4eec\u5c1d\u8bd5\u4fee\u6539 Deployment\uff0c\u6765\u66f4\u65b0 Nginx \u7684\u7248\u672c\uff1a</p> <pre><code>kubectl edit deployment.v1.apps/nginx-deployment\n</code></pre> <p>\u4fee\u6539<code>.spec.template.spec.containers[0].image</code>\u5b57\u6bb5\uff0c\u4ece <code>nginx:1.14.2</code> \u6539\u6210 <code>nginx:1.16.1</code>\uff0c\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>deployment.apps/nginx-deployment edited\n</code></pre> <p>\u67e5\u770b\u6eda\u52a8\u5347\u7ea7\u72b6\u6001\uff1a</p> <pre><code>kubectl rollout status deployment/nginx-deployment\nWaiting for deployment \"nginx-deployment\" rollout to finish: 1 out of 3 new replicas have been updated..\n</code></pre> <p>\u67e5\u770b Pod \u7684\u72b6\u6001\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u65b0\u7684\u526f\u672c\u5df2\u7ecf\u542f\u52a8\u6210\u529f\uff0c\u65e7\u7248\u672c\u7684\u526f\u672c\u5df2\u7ecf\u505c\u6b62\uff1a</p> <pre><code>\u00a0kubectl get pods --show-labels -o wide\nNAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 READY\u00a0 \u00a0STATUS\u00a0 \u00a0 \u00a0 \u00a0 RESTARTS\u00a0 \u00a0AGE\u00a0 \u00a0IP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0NODE\u00a0 \u00a0 \u00a0 \u00a0NOMINATED NODE\u00a0 \u00a0READINESS GATES\u00a0 \u00a0LABELS\nnginx-deployment-559d658b74-8w29d\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a0 \u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2s\u00a0 \u00a0 172.18.0.3\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=559d658b74\nnginx-deployment-559d658b74-df9rv\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a0 \u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 77s\u00a0 \u00a0172.18.0.6\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=559d658b74\nnginx-deployment-559d658b74-ktzsh\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a0 \u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 4s\u00a0 \u00a0 172.18.0.5\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=559d658b74\nnginx-deployment-66b6c48dd5-b92bv\u00a0 \u00a00/1\u00a0 \u00a0 \u00a0Terminating\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 27m\u00a0 \u00a0172.18.0.3\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=66b6c48dd5\nnginx-deployment-66b6c48dd5-hshnm\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Terminating\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 27m\u00a0 \u00a0172.18.0.4\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=66b6c48dd5\nnginx-deployment-66b6c48dd5-tfwfc\u00a0 \u00a00/1\u00a0 \u00a0 \u00a0Terminating\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 27m\u00a0 \u00a0172.18.0.5\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=66b6c48dd5\n</code></pre> <p>\u6211\u4eec\u518d\u6765\u770b\u4e00\u4e0b Nginx \u7684\u7248\u672c\u4fe1\u606f\uff0c\u67e5\u770b\u662f\u5426\u66f4\u65b0\u6210\u529f\uff1a</p> <pre><code>Pod Template:\n\u00a0 Labels:\u00a0 app=nginx\n\u00a0 Containers:\n\u00a0 \u00a0nginx:\n\u00a0 \u00a0 Image:\u00a0 \u00a0 \u00a0 \u00a0 nginx:1.16.1\n\u00a0 \u00a0 Port:\u00a0 \u00a0 \u00a0 \u00a0 \u00a080/TCP\n\u00a0 \u00a0 Host Port:\u00a0 \u00a0 0/TCP\n\u00a0 \u00a0 Environment:\u00a0 &lt;none&gt;\n\u00a0 \u00a0 Mounts:\u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\n\u00a0 Volumes:\u00a0 \u00a0 \u00a0 \u00a0 &lt;none&gt;\n</code></pre> <p>\u6700\u540e\u5220\u9664 Deployment \u8d44\u6e90\uff0c\u786e\u4fdd\u4e0b\u9762\u7684\u793a\u4f8b\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff1a</p> <pre><code>kubectl delete deployment.v1.apps/nginx-deployment\n</code></pre> <p>Kubernetes \u4e2d\u7684\u7248\u672c\u66f4\u65b0\u5df2\u7ecf\u5b8c\u6210\u4e86\uff0c\u901a\u8fc7\u6eda\u52a8\u5347\u7ea7\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u5730\u8fdb\u884c\u7248\u672c\u66f4\u65b0\u3002</p> <p>\u4f46\u662f\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u5e76\u6ca1\u6709\u7070\u5ea6\u529f\u80fd\uff0c\u8fd9\u5c31\u76f8\u5f53\u4e8e\u76f4\u63a5\u8fdb\u884c\u65b0\u7248\u672c\u5168\u91cf\u53d1\u5e03\u4e86\uff0c\u5f88\u663e\u7136\u4e0d\u7b26\u5408\u751f\u4ea7\u73af\u5883\u7684\u8981\u6c42\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u5b66\u4e60\u5982\u4f55\u5728 Kubernetes \u4e2d\u7ed3\u5408\u7248\u672c\u66f4\u65b0\u505a\u5230\u91d1\u4e1d\u96c0\u53d1\u5e03</p> <p>\u9996\u5148\u521b\u5efa Nginx \u7684\u5e94\u7528\uff0c\u5e76\u90e8\u7f72\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n\u00a0 name: my-nginx-svc\n\u00a0 labels:\n\u00a0 \u00a0 app: nginx\nspec:\n\u00a0 type: LoadBalancer\n\u00a0 ports:\n\u00a0 - port: 80\n\u00a0 selector:\n\u00a0 \u00a0 app: nginx\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n\u00a0 name: my-nginx\n\u00a0 labels:\n\u00a0 \u00a0 app: nginx\nspec:\n\u00a0 replicas: 3\n\u00a0 selector:\n\u00a0 \u00a0 matchLabels:\n\u00a0 \u00a0 \u00a0 app: nginx\n\u00a0 template:\n\u00a0 \u00a0 metadata:\n\u00a0 \u00a0 \u00a0 labels:\n\u00a0 \u00a0 \u00a0 \u00a0 app: nginx\n\u00a0 \u00a0 spec:\n\u00a0 \u00a0 \u00a0 containers:\n\u00a0 \u00a0 \u00a0 - name: nginx\n\u00a0 \u00a0 \u00a0 \u00a0 image: nginx:1.14.2\n\u00a0 \u00a0 \u00a0 \u00a0 ports:\n\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 80\n</code></pre> <pre><code>kubectl apply -f https://k8s.io/examples/application/nginx-app.yaml\n</code></pre> <p>\u542f\u52a8 Minikube \u96a7\u9053\uff0c\u6253\u901a\u7f51\u7edc\uff1a</p> <pre><code>minikube tunnel\n</code></pre> <p>\u901a\u8fc7\u6d4f\u89c8\u5668\u6216\u8005 curl \u547d\u4ee4\u8bbf\u95ee minikube ip \u83b7\u53d6 IP\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a</p> <pre><code>curl -i http://127.0.0.1\nHTTP/1.1 200 OK\nServer: nginx/1.14.2\nDate: Fri, 12 Feb 2021 07:28:56 GMT\nContent-Type: text/html\nContent-Length: 612\nLast-Modified: Tue, 04 Dec 2018 14:44:49 GMT\nConnection: keep-alive\nETag: \"5c0692e1-264\"\nAccept-Ranges: bytes\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cNginx\u662f\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u7684\uff0c\u4ece\u8fd4\u56de\u7684 header \u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230 Nginx \u7248\u672c\u53f7\u3002</p> <p>\u91cd\u590d\u4e0a\u9762\u7684 Kubernetes \u7248\u672c\u66f4\u65b0\u65f6\u7684\u6b65\u9aa4\uff0c\u90e8\u7f72\u4e00\u4e2a\u65b0\u7684\u7248\u672c\uff1a</p> <pre><code>kubectl apply -f https://k8s.io/examples/controllers/nginx-deployment.yaml\n</code></pre> <p>\u4fee\u6539 <code>nginx-deployment</code> \u4e2d Nginx \u7684\u7248\u672c\u53f7\uff0c\u5e76\u4e3a\u5176\u589e\u52a0\u65b0\u7684\u6807\u7b7e <code>track:canary</code>\uff0c\u5177\u4f53\u8def\u5f84\u4e3a <code>.spec.template.metadata.lables.track:canary</code>\uff1a</p> <pre><code>kubectl edit deployment.v1.apps/nginx-deployment\n</code></pre> <p>\u7ee7\u7eed\u67e5\u770b Pod\uff0c\u53ef\u4ee5\u53d1\u73b0\u6b64\u65f6\u540c\u65f6\u542f\u52a8\u4e86\u4e24\u4e2a\u7248\u672c\uff0c\u65b0\u542f\u52a8\u7684\u7248\u672c\u5e26\u6709 track=canary \u7684\u6807\u7b7e\uff1a</p> <pre><code>kubectl get pods --show-labels -o wide\nNAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0READY\u00a0 \u00a0STATUS\u00a0 \u00a0 RESTARTS\u00a0 \u00a0AGE\u00a0 \u00a0 IP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0NODE\u00a0 \u00a0 \u00a0 \u00a0NOMINATED NODE\u00a0 \u00a0READINESS GATES\u00a0 \u00a0LABELS\nmy-nginx-66b6c48dd5-82v69\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 1/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 38m\u00a0 \u00a0 172.18.0.8\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=66b6c48dd5\nmy-nginx-66b6c48dd5-clzgn\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 1/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 38m\u00a0 \u00a0 172.18.0.7\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=66b6c48dd5\nmy-nginx-66b6c48dd5-ngbql\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 1/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 38m\u00a0 \u00a0 172.18.0.4\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=66b6c48dd5\nnginx-deployment-975fd467c-7ghzx\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 100s\u00a0 \u00a0172.18.0.6\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=975fd467c,track=canary\nnginx-deployment-975fd467c-lx5sz\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 104s\u00a0 \u00a0172.18.0.5\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=975fd467c,track=canary\nnginx-deployment-975fd467c-vqm4m\u00a0 \u00a01/1\u00a0 \u00a0 \u00a0Running\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 102s\u00a0 \u00a0172.18.0.3\u00a0 \u00a0minikube\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 app=nginx,pod-template-hash=975fd467c,track=canary\n</code></pre> <pre><code>\u00a0app=nginx,pod-template-hash=975fd467c,track=canary\n</code></pre> <p>\u5b9e\u9645\u4e0a\uff0c\u6b64\u65f6 Nginx \u540c\u65f6\u8fd0\u884c\u4e86\u4e24\u4e2a\u7248\u672c\uff0c\u6211\u4eec\u65b0\u53d1\u5e03\u7684\u7248\u672c\u662f Nginx1.16.1\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>curl -i</code>\u7684\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code>curl -i http://127.0.0.1\nHTTP/1.1 200 OK\nServer: nginx/1.16.1\nDate: Fri, 12 Feb 2021 07:57:30 GMT\nContent-Type: text/html\nContent-Length: 612\nLast-Modified: Tue, 13 Aug 2019 10:05:00 GMT\nConnection: keep-alive\nETag: \"5d528b4c-264\"\nAccept-Ranges: bytes\n</code></pre> <p>\u591a\u6b21\u8fd0\u884c curl -i \u547d\u4ee4\u67e5\u770b\u7ed3\u679c\uff0c\u4f60\u53ef\u4ee5\u53d1\u73b0\uff0c\u8fd4\u56de\u7684 header \u4e2d\u540c\u65f6\u5b58\u5728 1.16.1 \u548c 1.14.2 \u4e24\u4e2a Nginx \u7248\u672c\u3002</p> <p>\u901a\u8fc7\u8fd9\u6837\u6eda\u52a8\u5347\u7ea7\u7684\u65b9\u5f0f\uff0cKubernetes \u53ef\u4ee5\u505a\u5230\u7b80\u5355\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u8fd9\u6837\u7684\u65b9\u5f0f\u5df2\u7ecf\u53ef\u4ee5\u6ee1\u8db3\u4e00\u4e9b\u7b80\u5355\u7684\u573a\u666f\uff0c\u4f46\u662f\u6d41\u91cf\u6bd4\u4f8b\u53ea\u80fd\u901a\u8fc7\u7070\u5ea6\u5355\u4e2a Pod \u7684\u65b9\u5f0f\u63a7\u5236\u3002</p>"},{"location":"chap2/6chap3_canary/#2istio","title":"2\u3001Istio \u4e2d\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03","text":"<p>Istio\u548c Kubernetes \u5b9e\u73b0\u91d1\u4e1d\u96c0\u53d1\u5e03\u7684\u65b9\u5f0f\u4e0d\u592a\u4e00\u6837\uff0cIstio \u901a\u8fc7 Envoy \u5f3a\u5927\u7684\u8def\u7531\u89c4\u5219\u7ba1\u7406\u80fd\u529b\uff0c\u53ef\u4ee5\u7075\u6d3b\u5730\u63a7\u5236\u5bf9\u5e94\u7248\u672c\u7684\u6d41\u91cf\u767e\u5206\u6bd4</p> <p>\u793a\u610f\u56fe\u5982\u4e0b\uff0c\u7528\u6237\u8bbf\u95ee productpage \u7684\u8bf7\u6c42\uff0c\u5185\u90e8\u6d41\u91cf\u4f1a\u5206\u522b\u8def\u7531\u5230 <code>reviews-v1</code>\u548c<code>v2</code> \u4e24\u4e2a\u7248\u672c\u3002</p> <p> </p> <pre><code>kubectl get pods\nNAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0READY\u00a0 \u00a0STATUS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 RESTARTS\u00a0 \u00a0AGE\ndetails-v1-b87bfc85d-nd8v7\u00a0 \u00a0 \u00a0 \u00a0 \u00a02/2\u00a0 \u00a0 \u00a0Running\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2m12s\nproductpage-v1-65576bb7bf-hj6mw\u00a0 \u00a0 1/2\u00a0 \u00a0 \u00a0Running\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2m11s\nratings-v1-645b477958-gtrqd\u00a0 \u00a0 \u00a0 \u00a0 0/2\u00a0 \u00a0 \u00a0PodInitializing\u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2m12s\nreviews-v1-987d495c-2x5rh\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2/2\u00a0 \u00a0 \u00a0Running\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2m12s\nreviews-v2-6c5bf657cf-t66hz\u00a0 \u00a0 \u00a0 \u00a0 2/2\u00a0 \u00a0 \u00a0Running\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2m12s\nreviews-v3-5f7b9f4f77-gcrsj\u00a0 \u00a0 \u00a0 \u00a0 2/2\u00a0 \u00a0 \u00a0Running\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a00\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2m12s\n</code></pre> <p>\u901a\u8fc7\u67e5\u770b <code>samples/bookinfo/platform/kube/bookinfo.yaml</code> \u7684\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u770b\u5230\uff1a\u6709\u4e09\u4e2a reviews \u670d\u52a1\u7684\u90e8\u7f72\u7c7b\u578b\u8d44\u6e90\u3002\u901a\u8fc7\u524d\u9762 Kubernetes \u7070\u5ea6\u53d1\u5e03\u7684\u5185\u5bb9\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff0c\u901a\u8fc7\u914d\u7f6e\u4e0d\u540c\u7684 labels\uff0c\u53ef\u4ee5\u8ba9\u540c\u4e00\u4e2a\u670d\u52a1\u7684\u4e09\u4e2a\u90e8\u7f72\u8d44\u6e90\u540c\u65f6\u5b58\u5728\u3002</p> <p>\u8fd9\u4e09\u4e2a\u90e8\u7f72\u8d44\u6e90\u7684\u670d\u52a1\u955c\u50cf\u6307\u5411\u4e86\u4e09\u4e2a\u4e0d\u540c\u7684\u5730\u5740\uff0c\u5206\u522b\u662f\u00a0<code>examples-bookinfo-reviews-v1:1.16.2</code>\u3001<code>examples-bookinfo-reviews-v2:1.16.2</code> \u548c <code>examples-bookinfo-reviews-v3:1.16.2</code>\uff1a</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n\u00a0 name: reviews-v1\n\u00a0 labels:\n\u00a0 \u00a0 app: reviews\n\u00a0 \u00a0 version: v1\nspec:\n\u00a0 replicas: 1\n\u00a0 selector:\n\u00a0 \u00a0 matchLabels:\n\u00a0 \u00a0 \u00a0 app: reviews\n\u00a0 \u00a0 \u00a0 version: v1\n\u00a0 template:\n\u00a0 \u00a0 metadata:\n\u00a0 \u00a0 \u00a0 labels:\n\u00a0 \u00a0 \u00a0 \u00a0 app: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 version: v1\n\u00a0 \u00a0 spec:\n\u00a0 \u00a0 \u00a0 serviceAccountName: bookinfo-reviews\n\u00a0 \u00a0 \u00a0 containers:\n\u00a0 \u00a0 \u00a0 - name: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2\n\u00a0 \u00a0 \u00a0 \u00a0 imagePullPolicy: IfNotPresent\n\u00a0 \u00a0 \u00a0 \u00a0 env:\n\u00a0 \u00a0 \u00a0 \u00a0 - name: LOG_DIR\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 value: \"/tmp/logs\"\n\u00a0 \u00a0 \u00a0 \u00a0 ports:\n\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 9080\n\u00a0 \u00a0 \u00a0 \u00a0 volumeMounts:\n\u00a0 \u00a0 \u00a0 \u00a0 - name: tmp\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 mountPath: /tmp\n\u00a0 \u00a0 \u00a0 \u00a0 - name: wlp-output\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 mountPath: /opt/ibm/wlp/output\n\u00a0 \u00a0 \u00a0 volumes:\n\u00a0 \u00a0 \u00a0 - name: wlp-output\n\u00a0 \u00a0 \u00a0 \u00a0 emptyDir: {}\n\u00a0 \u00a0 \u00a0 - name: tmp\n\u00a0 \u00a0 \u00a0 \u00a0 emptyDir: {}\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n\u00a0 name: reviews-v2\n\u00a0 labels:\n\u00a0 \u00a0 app: reviews\n\u00a0 \u00a0 version: v2\nspec:\n\u00a0 replicas: 1\n\u00a0 selector:\n\u00a0 \u00a0 matchLabels:\n\u00a0 \u00a0 \u00a0 app: reviews\n\u00a0 \u00a0 \u00a0 version: v2\n\u00a0 template:\n\u00a0 \u00a0 metadata:\n\u00a0 \u00a0 \u00a0 labels:\n\u00a0 \u00a0 \u00a0 \u00a0 app: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 version: v2\n\u00a0 \u00a0 spec:\n\u00a0 \u00a0 \u00a0 serviceAccountName: bookinfo-reviews\n\u00a0 \u00a0 \u00a0 containers:\n\u00a0 \u00a0 \u00a0 - name: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2\n\u00a0 \u00a0 \u00a0 \u00a0 imagePullPolicy: IfNotPresent\n\u00a0 \u00a0 \u00a0 \u00a0 env:\n\u00a0 \u00a0 \u00a0 \u00a0 - name: LOG_DIR\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 value: \"/tmp/logs\"\n\u00a0 \u00a0 \u00a0 \u00a0 ports:\n\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 9080\n\u00a0 \u00a0 \u00a0 \u00a0 volumeMounts:\n\u00a0 \u00a0 \u00a0 \u00a0 - name: tmp\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 mountPath: /tmp\n\u00a0 \u00a0 \u00a0 \u00a0 - name: wlp-output\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 mountPath: /opt/ibm/wlp/output\n\u00a0 \u00a0 \u00a0 volumes:\n\u00a0 \u00a0 \u00a0 - name: wlp-output\n\u00a0 \u00a0 \u00a0 \u00a0 emptyDir: {}\n\u00a0 \u00a0 \u00a0 - name: tmp\n\u00a0 \u00a0 \u00a0 \u00a0 emptyDir: {}\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n\u00a0 name: reviews-v3\n\u00a0 labels:\n\u00a0 \u00a0 app: reviews\n\u00a0 \u00a0 version: v3\nspec:\n\u00a0 replicas: 1\n\u00a0 selector:\n\u00a0 \u00a0 matchLabels:\n\u00a0 \u00a0 \u00a0 app: reviews\n\u00a0 \u00a0 \u00a0 version: v3\n\u00a0 template:\n\u00a0 \u00a0 metadata:\n\u00a0 \u00a0 \u00a0 labels:\n\u00a0 \u00a0 \u00a0 \u00a0 app: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 version: v3\n\u00a0 \u00a0 spec:\n\u00a0 \u00a0 \u00a0 serviceAccountName: bookinfo-reviews\n\u00a0 \u00a0 \u00a0 containers:\n\u00a0 \u00a0 \u00a0 - name: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2\n\u00a0 \u00a0 \u00a0 \u00a0 imagePullPolicy: IfNotPresent\n\u00a0 \u00a0 \u00a0 \u00a0 env:\n\u00a0 \u00a0 \u00a0 \u00a0 - name: LOG_DIR\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 value: \"/tmp/logs\"\n\u00a0 \u00a0 \u00a0 \u00a0 ports:\n\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 9080\n\u00a0 \u00a0 \u00a0 \u00a0 volumeMounts:\n\u00a0 \u00a0 \u00a0 \u00a0 - name: tmp\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 mountPath: /tmp\n\u00a0 \u00a0 \u00a0 \u00a0 - name: wlp-output\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 mountPath: /opt/ibm/wlp/output\n\u00a0 \u00a0 \u00a0 volumes:\n\u00a0 \u00a0 \u00a0 - name: wlp-output\n\u00a0 \u00a0 \u00a0 \u00a0 emptyDir: {}\n\u00a0 \u00a0 \u00a0 - name: tmp\n\u00a0 \u00a0 \u00a0 \u00a0 emptyDir: {}\n</code></pre> <p>\u6211\u4eec\u5728\u9875\u9762\u4e2d\uff0c\u53cd\u590d\u5237\u65b0<code>http://127.0.0.1/productpage</code>\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u540c\u7684\u4e09\u79cd reviews \u7684\u663e\u793a\u3002</p> <p> </p> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u8bf7\u6c42\u7ed3\u679c\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0cIstio \u786e\u5b9e\u5c06\u6d41\u91cf\u8def\u7531\u5230\u4e86\u4e0d\u540c\u7684 reviews \u7248\u672c\u4e0a\uff0c\u4f46\u662f\u8fd9\u91cc\u6211\u4eec\u8fd8\u6ca1\u6709\u5bf9 Istio \u7684\u8def\u7531\u89c4\u5219\u505a\u7279\u6b8a\u914d\u7f6e\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684\u6d41\u91cf\u662f\u5747\u5206\u7684\uff0c\u4f60\u4e5f\u53ef\u4ee5\u7406\u89e3\u4e3a\u548c Kubernetes \u7684\u7248\u672c\u7070\u5ea6\u7b56\u7565\u662f\u4e00\u81f4\u7684\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u521b\u5efa\u4e00\u4e2a reviews \u7684\u8def\u7531\u89c4\u5219\uff0c\u4e3a\u4e86\u65b9\u4fbf\u9a8c\u8bc1\uff0c\u8fd9\u4e2a\u914d\u7f6e\u5c06\u6240\u6709\u6d41\u91cf\u6307\u5411 reviews \u7684 v1 \u7248\u672c\uff1a</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n\u00a0 name: reivews\nspec:\n\u00a0 hosts:\n\u00a0 \u00a0 - reviews\n\u00a0 http:\n\u00a0 - route:\n\u00a0 \u00a0 - destination:\n\u00a0 \u00a0 \u00a0 \u00a0 host: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 subset: v1\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n\u00a0 name: reviews\nspec:\n\u00a0 host: reviews\n\u00a0 subsets:\n\u00a0 - name: v1\n\u00a0 \u00a0 labels:\n\u00a0 \u00a0 \u00a0 version: v1\n\u00a0 - name: v2\n\u00a0 \u00a0 labels:\n\u00a0 \u00a0 \u00a0 version: v2\n\u00a0 - name: v3\n\u00a0 \u00a0 labels:\n\u00a0 \u00a0 \u00a0 version: v3\nEOF\n</code></pre> <p>\u6b64\u65f6\uff0c\u6211\u4eec\u65e0\u8bba\u5982\u4f55\u5237\u65b0\u9875\u9762\uff0c\u90fd\u4f1a\u53d1\u73b0\u9875\u9762\u7684\u663e\u793a\u5185\u5bb9\uff0c\u603b\u662f\u505c\u7559\u5728 reviews \u7684 v1 \u7248\u672c\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u518d\u505a\u51fa\u4e00\u4e9b\u6539\u52a8\uff0c\u4fee\u6539 Istio \u8def\u7531\u914d\u7f6e\uff0c\u5c06 90% \u7684\u6d41\u91cf\u6307\u5411 v1 \u7248\u672c\uff0c10% \u7684\u6d41\u91cf\u6307\u5411 v2 \u7248\u672c\uff0c\u4ee5\u8fbe\u5230\u6211\u4eec\u6700\u5f00\u59cb\u7684\u9700\u6c42\u2014\u2014\u7cbe\u51c6\u6d41\u91cf\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a</p> <p> </p> <pre><code>$ kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n\u00a0 name: reivews\nspec:\n\u00a0 hosts:\n\u00a0 \u00a0 - reviews\n\u00a0 http:\n\u00a0 - route:\n\u00a0 \u00a0 - destination:\n\u00a0 \u00a0 \u00a0 \u00a0 host: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 subset: v1\n\u00a0 \u00a0 \u00a0 weight: 90\n\u00a0 \u00a0 - destination:\n\u00a0 \u00a0 \u00a0 \u00a0 host: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 subset: v2\n\u00a0 \u00a0 \u00a0 weight: 10\nEOF\n</code></pre> <p>\u6210\u529f\u6267\u884c\u4e0a\u8ff0\u547d\u4ee4\uff0c\u6211\u4eec\u53cd\u590d\u5237\u65b0 productpage \u9875\u9762\uff0c\u53ef\u4ee5\u53d1\u73b0\u5927\u6982\u6709 10% \u7684\u6d41\u91cf\u88ab\u8def\u7531\u5230\u4e86\u65b0\u7684 reviews v2 \u7248\u672c\u3002</p> <p> </p> <p>\u73b0\u5b9e\u573a\u666f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u7075\u6d3b\u5730\u8bbe\u7f6e reviews v1 \u7248\u672c\u548c v2 \u7248\u672c\u7684\u6d41\u91cf\u6bd4\u4f8b\uff0c\u6bd4\u5982\u8bbe\u7f6e v2 \u7248\u672c\u6d41\u91cf\u6bd4\u4f8b\u4e3a 1%\uff0c\u7528\u4e8e\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u8fd9\u6837\u7684\u65b9\u5f0f\u76f8\u8f83\u4e8e Kubernetes \u542f\u52a8 100 \u4e2a pod \u8fdb\u884c\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u8981\u7075\u6d3b\u5f97\u591a\u3002</p> <p>\u5728\u91d1\u4e1d\u96c0\u53d1\u5e03\u7684\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7\u4e0d\u65ad\u589e\u52a0 v2 \u7684\u6d41\u91cf\u6bd4\u4f8b\u8fbe\u5230\u7cbe\u51c6\u6d41\u91cf\u7070\u5ea6\u53d1\u5e03\u7684\u76ee\u7684\uff0c\u914d\u5408 Metrics \u76d1\u63a7\u6307\u6807\uff0c\u53ef\u4ee5\u968f\u65f6\u81ea\u52a8\u8c03\u6574 v2 \u7684\u6bd4\u4f8b\uff0c\u4ee5\u51cf\u5c11\u65b0\u7248\u672c\u51fa\u95ee\u9898\u65f6\u5bf9\u751f\u4ea7\u73af\u5883\u7684\u5f71\u54cd\u3002\u968f\u7740 v2 \u7248\u672c\u7684\u6d41\u91cf\u4e0d\u65ad\u589e\u5927\uff0c\u6700\u7ec8\u5f7b\u5e95\u66ff\u4ee3 v1 \u7248\u672c\u6210\u4e3a\u7ebf\u4e0a\u6b63\u5f0f\u7248\u672c\uff0c\u6574\u4e2a\u91d1\u4e1d\u96c0\u53d1\u5e03\u4e5f\u5c31\u7ed3\u675f\u4e86\u3002</p> <p>\u5f53\u7136\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u4f60\u5e94\u8be5\u7075\u6d3b\u8c03\u6574 v1 \u548c v2 \u7248\u672c\u7684 Kubernetes \u526f\u672c\u6570\u91cf\uff0c\u6216\u8005\u914d\u5408 Kubernetes \u7684 HPA\uff0c\u4ee5\u8fbe\u5230\u81ea\u52a8\u6269\u7f29\u5bb9\u7684\u76ee\u7684\uff1a</p> <pre><code>$ kubectl autoscale deployment reviews-v1 --cpu-percent=50 --min=1 --max=10\n$ kubectl autoscale deployment reviews-v2 --cpu-percent=50 --min=1 --max=10\n</code></pre> <p>Istio \u4e2d\u53e6\u4e00\u4e2a\u5f3a\u5927\u7684\u529f\u80fd\uff1a\u9488\u5bf9 header \u8bbe\u7f6e\u8def\u7531\u7b56\u7565\uff0c\u4ee5\u8fbe\u5230\u91d1\u4e1d\u96c0\u6d4b\u8bd5\u7684\u76ee\u7684\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u9488\u5bf9\u4e0d\u540c\u7528\u6237\u6216\u4e0d\u540c\u7684\u5ba2\u6237\u7aef\u7248\u672c\uff08\u9488\u5bf9\u6d4b\u8bd5\u4eba\u5458\u5355\u72ec\u53d1\u5e03\u7684\u6d4b\u8bd5\u7248\u672c\uff09\uff0c\u8fdb\u884c\u7cbe\u51c6\u7684\u6d41\u91cf\u8def\u7531\u3002</p>"},{"location":"chap2/6chap3_canary/#3istio","title":"3\u3001Istio \u91d1\u4e1d\u96c0\u6d4b\u8bd5","text":"<p>\u9996\u5148\u6211\u4eec\u521b\u5efa\u4e00\u4e2a VirtualService \u914d\u7f6e\uff0c\u5c06\u767b\u5f55\u7528\u6237\u540d\u4e3a testuser \u7684\u7528\u6237\u6307\u5411\u6d4b\u8bd5\u7248\u672c v2 \u548c v3\uff0c\u5176\u4e2d v3 \u6d41\u91cf\u5360\u6bd4 90%\uff0cv2 \u6d41\u91cf\u5360\u6bd4 10%\u3002</p> <p>\u8fd9\u4e2a\u7248\u672c\u4e13\u95e8\u7528\u4e8e testuser \u7684\u6d4b\u8bd5\u4eba\u5458\u8fdb\u884c\u65b0\u7248\u672c\u7684\u6d4b\u8bd5\uff0c\u5176\u4ed6\u767b\u5f55\u7528\u6237\u5168\u90e8\u8def\u7531\u5230 v1 \u7248\u672c\uff1a</p> <pre><code>kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n\u00a0 name: reviews\nspec:\n\u00a0 hosts:\n\u00a0 \u00a0 - reviews\n\u00a0 http:\n\u00a0 - match:\n\u00a0 \u00a0 - headers:\n\u00a0 \u00a0 \u00a0 \u00a0 end-user:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 exact: testuser\n\u00a0 \u00a0 route:\n\u00a0 \u00a0 - destination:\n\u00a0 \u00a0 \u00a0 \u00a0 host: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 subset: v2\n\u00a0 \u00a0 \u00a0 weight: 10\n\u00a0 \u00a0 - destination:\n\u00a0 \u00a0 \u00a0 \u00a0 host: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 subset: v3\n\u00a0 \u00a0 \u00a0 weight: 90\n\u00a0 - route:\n\u00a0 \u00a0 - destination:\n\u00a0 \u00a0 \u00a0 \u00a0 host: reviews\n\u00a0 \u00a0 \u00a0 \u00a0 subset: v1\nEOF\n</code></pre> <p>\u6267\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53cd\u590d\u8bbf\u95ee productpage \u9875\u9762\uff0c\u53d1\u73b0\u6d41\u91cf\u5927\u90e8\u5206\u90fd\u8def\u7531\u5230\u4e86 v3 \u7248\u672c\uff0c\u5c11\u91cf\u6d41\u91cf\u8def\u7531\u5230\u4e86 v2 \u7248\u672c\u3002</p> <p> </p> <p>\u81f3\u6b64\uff0c\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Istio \u7684\u91d1\u4e1d\u96c0\u6d4b\u8bd5\u3002</p> <p> </p>"},{"location":"chap2/7chap3_monitor/","title":"\u7b2c\u4e03\u8282 \u5982\u4f55\u5229\u7528\u7ec4\u4ef6\u505a\u5230\u670d\u52a1\u7684\u53ef\u89c2\u6d4b\u6027","text":""},{"location":"chap2/7chap3_monitor/#1metrics","title":"1\u3001Metrics \u6307\u6807","text":"<p>\u5728\u5f00\u59cb\u8fd9\u90e8\u5206\u5185\u5bb9\u4e4b\u524d\uff0c\u5148\u901a\u8fc7\u547d\u4ee4\u786e\u8ba4\u4f60\u662f\u5426\u5b89\u88c5\u4e86 Prometheus \u548c Grafana\uff1a</p> <pre><code>$ kubectl -n istio-system get svc\nNAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0TYPE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0CLUSTER-IP\u00a0 \u00a0 \u00a0 \u00a0EXTERNAL-IP\u00a0 \u00a0PORT(S)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AGE\ngrafana\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ClusterIP\u00a0 \u00a0 \u00a0 10.108.76.68\u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 3000/TCP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a092m\nistio-egressgateway\u00a0 \u00a0 ClusterIP\u00a0 \u00a0 \u00a0 10.103.64.246\u00a0 \u00a0 &lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 80/TCP,443/TCP,15443/TCP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a026h\nistio-ingressgateway\u00a0 \u00a0LoadBalancer\u00a0 \u00a010.108.98.172\u00a0 \u00a0 127.0.0.1\u00a0 \u00a0 \u00a015021:31530/TCP,80:31636/TCP,443:31905/TCP,31400:31942/TCP,15443:32337/TCP\u00a0 \u00a026h\nistiod\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0ClusterIP\u00a0 \u00a0 \u00a0 10.109.14.171\u00a0 \u00a0 &lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 15010/TCP,15012/TCP,443/TCP,15014/TCP,853/TCP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 26h\nkiali\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ClusterIP\u00a0 \u00a0 \u00a0 10.110.51.251\u00a0 \u00a0 &lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 20001/TCP,9090/TCP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a092m\nprometheus\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0ClusterIP\u00a0 \u00a0 \u00a0 10.106.46.62\u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 9090/TCP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a092m\ntracing\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ClusterIP\u00a0 \u00a0 \u00a0 10.100.200.122\u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 80/TCP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a092m\nzipkin\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0ClusterIP\u00a0 \u00a0 \u00a0 10.100.85.63\u00a0 \u00a0 \u00a0&lt;none&gt;\u00a0 \u00a0 \u00a0 \u00a0 9411/TCP\n</code></pre>"},{"location":"chap2/7chap3_monitor/#1-1-prometheus","title":"1-1 Prometheus","text":"<p>\u6211\u4eec\u5148\u6765\u542f\u52a8 Prometheus \u7684\u56fe\u5f62\u754c\u9762\uff1a</p> <pre><code>istioctl dashboard prometheus\n</code></pre> <p>\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u5e2e\u6211\u4eec\u6253\u5f00 Prometheus \u7684 Web \u754c\u9762\uff0c\u5982\u4e0b\u56fe\uff1a</p> <p> </p> <p>Envoy \u7a81\u51fa\u7684 Metrics\uff0c\u5728 Prometheus \u4e2d\u67e5\u8be2</p> <pre><code>istio_requests_total{connection_security_policy!=\"mutual_tls\", destination_service=~\"reviews.default.svc.cluster.local\", reporter=\"source\"}[5m]\n</code></pre> <p>\u5207\u6362\u5230 Console \u754c\u9762\uff0c\u53ef\u4ee5\u67e5\u770b\u4e00\u4e9b\u8f93\u51fa\u4fe1\u606f\uff0c\u8bf4\u660e\u4fe1\u606f\u88ab\u6b63\u786e\u91c7\u96c6\uff1a</p> <p> </p>"},{"location":"chap2/7chap3_monitor/#1-2-grafana","title":"1-2 Grafana","text":"<p>Grafna \u7684\u542f\u52a8\u65b9\u5f0f\u4e5f\u5f88\u7b80\u5355\uff0c\u548c Prometheus \u7c7b\u4f3c\uff1a</p> <pre><code>$ istioctl dashboard grafana\n</code></pre> <p>Istio \u4e5f\u4e3a\u6211\u4eec\u81ea\u52a8\u5730\u5728\u672c\u5730\u6253\u5f00\u4e86 Grafana \u7684\u754c\u9762</p> <p>\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u624b\u52a8\u5728\u6d4f\u89c8\u5668\u8f93\u5165http://localhost:3000/dashboard/db/Istio-mesh-dashboard \u5e76\u8bbf\u95ee\uff0c\u53ef\u4ee5\u76f4\u63a5\u770b\u5230 Istio \u7ba1\u7406\u7684\u670d\u52a1\u5217\u8868\u4fe1\u606f\u3002</p> <p>\u53ef\u4ee5\u70b9\u51fb\u5230\u4efb\u610f\u94fe\u63a5\u8fdb\u5165\u5b50\u9875\u9762\uff0c\u4e0b\u9762\u6211\u4eec\u8fdb\u5165 Service \u9875\u9762\uff0c\u67e5\u770b\u67d0\u4e2a Service \u7684\u5177\u4f53\u4fe1\u606f\uff08</p> <p>http://localhost:3000/d/LJ_uJAvmk/istio-service-dashboard?orgId=1&amp;refresh=10s\uff09\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u754c\u9762\uff1a</p> <p> </p> <p>\u5728\u9875\u9762\u7684\u6700\u4e0a\u65b9\uff0c\u6709\u51e0\u4e2a\u9009\u9879\uff0c\u53ef\u4ee5\u9009\u62e9\u6211\u4eec\u9700\u8981\u7684\u53c2\u6570\u3002</p> <ul> <li>Service\uff1a\u670d\u52a1\u540d\uff0c\u8fd9\u91cc\u7684\u670d\u52a1\u540d\u5c31\u662f\u6211\u4eec\u5728 Kubernetes \u4e2d\u8981\u8bbf\u95ee\u7684\u670d\u52a1\u540d\uff0c\u6bd4\u5982 <code>details.default.svc.cluster.local</code>\u3002Bookinfo \u8fd9\u4e2a\u9879\u76ee\u6240\u5305\u542b\u7684\u51e0\u4e2a\u5fae\u670d\u52a1\uff0c\u90fd\u53ef\u4ee5\u5728\u8fd9\u91cc\u9009\u62e9\u3002</li> <li>Client Workload Namespace\uff08Or Service Workload Namespace\uff09\uff1a\u8fd9\u91cc\u6307\u7684\u662f Kubernetes \u7684 namespace \u547d\u540d\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f\u670d\u52a1\u521b\u5efa\u5728\u4e86\u54ea\u4e2a\u547d\u540d\u7a7a\u95f4\u3002\u8fd9\u91cc\u5e94\u7528\u7c7b\u578b\u7684\u670d\u52a1\u90fd\u521b\u5efa\u5728\u4e86 default \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u53ea\u6709 <code>istio-ingressgateway</code> \u521b\u5efa\u4e86 <code>istio-system</code> \u7684\u547d\u540d\u7a7a\u95f4\u3002</li> <li>Client Workload\uff1a\u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d Service \u7684 upstream\uff0c\u4e5f\u5c31\u662f Client \u8c03\u7528\u7aef\u3002<ul> <li>\u6211\u4eec\u9ed8\u8ba4\u9009\u4e2d\u4e86 <code>details.default.svc.cluster.local</code>\u8fd9\u4e2a\u670d\u52a1\uff0c\u67e5\u770b Client Workload \u7684\u4e0b\u62c9\u6846\u53ef\u4ee5\u770b\u5230 <code>productpage-v1</code>\u7684\u9009\u9879\uff0c\u8fd9\u8bf4\u660e <code>details.default.svc.cluster.local</code>\u8fd9\u4e2a\u670d\u52a1\u7684\u6d41\u91cf\u6765\u6e90\u662f <code>productpage</code> \u7684 v1 \u7248\u672c\u3002\u5982\u679c\u8fd9\u91cc\u6709\u591a\u4e2a\u9009\u9879\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u9009\u4e2d\u5176\u4e2d\u4e00\u4e2a\u8fdb\u884c\u67e5\u770b\uff0c\u901a\u8fc7\u89c2\u5bdf\u4e0d\u540c\u7684\u6d41\u91cf\u6765\u6e90\uff0c\u5728\u51fa\u73b0\u95ee\u9898\u7684\u65f6\u5019\u53ef\u4ee5\u5f88\u597d\u5730\u533a\u5206\u5230\u5e95\u662f\u54ea\u4e2a\u6d41\u91cf\u6765\u6e90\u7684\u95ee\u9898\uff0c\u4fbf\u4e8e\u6392\u67e5\u95ee\u9898\u7684\u6839\u56e0\u3002</li> </ul> </li> </ul> <p> </p> <p>Istio \u8fd9\u6837\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\u5219\u6ca1\u6709\u8fd9\u6837\u7684\u56f0\u6270\uff0c\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u63a7\u5236\u9762\u4e0b\u53d1\u5f53\u524d\u670d\u52a1\u7684\u670d\u52a1\u540d\uff0c\u8ba9 Sidecar \u5728 Metrics \u4e2d\u81ea\u52a8\u6ce8\u5165\uff0c\u4e0d\u5141\u8bb8\u4e1a\u52a1\u4ee3\u7801\u7f16\u5199\u4eba\u5458\u4fee\u6539\u8fd9\u4e2a\u670d\u52a1\u540d\uff0c\u4ece\u800c\u5728\u6839\u672c\u4e0a\u675c\u7edd\u4e86\u8c03\u7528\u65b9\u670d\u52a1\u540d\u51fa\u9519\u7684\u95ee\u9898\u3002</p> <ul> <li>Service Workload\uff1a\u8fd9\u91cc\u6211\u4eec\u9009\u4e2d <code>reviews.default.svc.cluster.local</code>\uff0c\u7136\u540e\u67e5\u770b Service Workload \u7684\u4e0b\u62c9\u6846\uff0c\u53ef\u4ee5\u770b\u5230\u4e09\u4e2a\u9009\u9879 review-v1\u3001reviews-v2\u3001reviews-v3\u3002\u8fd9\u91cc\u5176\u5b9e\u5c31\u662f reviews \u8fd9\u4e2a\u670d\u52a1\u7684\u4e09\u4e2a\u4e0d\u540c\u7248\u672c\uff0c\u53ef\u4ee5\u5206\u522b\u9009\u62e9\u8fd9\u4e09\u4e2a\u7248\u672c\u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u67e5\u770b\u76f8\u5e94\u7684\u76d1\u63a7\u4fe1\u606f\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\u5c55\u793a\u4e86 <code>SERVICE: reviews.default.svc.cluster.local</code> \u7684\u4e00\u4e9b\u5e38\u89c1\u4fe1\u606f\uff0c\u6bd4\u5982\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef\u8bf7\u6c42\u7684 QPS\u3001\u6210\u529f\u7387\u3001\u5ef6\u65f6\u7b49\u3002</p> <p>\u8fd9\u91cc\u6240\u6709\u7684\u6307\u6807\u90fd\u6709\u4e24\u4e2a\u7ef4\u5ea6\uff0c\u4e00\u4e2a\u662f\u670d\u52a1\u7aef\u81ea\u8eab\u7684\uff0c\u4e00\u4e2a\u662fClient \u7aef\u7684\uff0c\u76f8\u5bf9\u6765\u8bf4 Client \u7aef\u7684\u7edf\u8ba1\u66f4\u63a5\u8fd1\u670d\u52a1\u672c\u8eab\u7684\u8017\u65f6\uff0c\u56e0\u4e3a\u670d\u52a1\u81ea\u8eab\u7684\u7edf\u8ba1\u65e0\u6cd5\u628a\u7f51\u7edc\u6d88\u8017\u7edf\u8ba1\u5728\u5185\u3002\u5f88\u591a\u65f6\u5019\u6211\u4eec\u7ecf\u5e38\u8fc7\u5ea6\u5173\u6ce8\u670d\u52a1\u81ea\u8eab\u7684\u5404\u79cd\u6307\u6807\uff0c\u53cd\u800c\u5ffd\u7565\u4e86\u7f51\u7edc\u5c42\u9762\u7684\u4e00\u4e9b\u6d88\u8017\u3002</p> <p>\u518d\u4e0b\u9762\u7684\u9762\u677f\u662f Client Workloads\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u540c\u7248\u672c\u7684\u8c03\u7528\u7aef\u670d\u52a1\u3001\u8bf7\u6c42\u7684\u9ec4\u91d1\u6307\u6807\uff0c\u5305\u62ec QPS\u3001\u5ef6\u65f6\u3001\u54cd\u5e94\u5927\u5c0f\u7b49\u3002</p> <p>\u6700\u540e\u7684\u9762\u677f\u662f Service Workloads\uff0c\u4e5f\u5c31\u662f\u5f53\u524d\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u540c\u6837\u5305\u542b\u4e86 QPS\u3001\u5ef6\u65f6\u3001\u54cd\u5e94\u5927\u5c0f\uff0c\u4ee5\u53ca TCP \u8fde\u63a5\u7b49\u4fe1\u606f\u3002</p> <p>\u76f4\u63a5\u8bbf\u95ee http://localhost:3000/dashboard/db/istio-workload-dashboard\uff0c\u4e5f\u53ef\u4ee5\u70b9\u51fb <code>istio-mesh-dashboard</code>\u4e0a\u7684\u94fe\u63a5\u8bbf\u95ee\u3002</p> <p> </p> <p>\u76f8\u5bf9\u4e8e istio-services-dashboard\uff0c\u8fd9\u4e2a\u9875\u9762\u6700\u5927\u7684\u4f18\u52bf\uff0c\u662f\u53ef\u4ee5\u770b\u5230 inbound\uff08\u5165\u6d41\u91cf\uff09\u548c outbound\uff08\u51fa\u6d41\u91cf\uff09\u4e24\u4e2a\u6d41\u91cf\u65b9\u5411\u7684\u76d1\u63a7\u4fe1\u606f\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u9009\u4e2d reviews-v3 \u8fd9\u4e2a Workload\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u7684 inbound \u7684\u4fe1\u606f\uff0c\u4e5f\u5c31\u662f productpage-v1 \u8fd9\u4e2a\u8c03\u7528\u7aef\u8bbf\u95ee\u8fc7\u6765\u7684\u6d41\u91cf\uff1b</p> <p>\u4e5f\u53ef\u4ee5\u770b\u5230 review-v3 \u8bbf\u95ee\u51fa\u53bb\u7684\u6d41\u91cf\uff0c\u6d41\u91cf\u8def\u7531\u5230\u7684\u670d\u52a1\u662f <code>ratings.default.svc.cluster.local</code>\u3002</p> <p>\u4ee5\u5ba2\u6237\u7aef\u7684\u89c6\u89d2\uff0c\u67e5\u770b\u670d\u52a1\u7684\u51fa\u6d41\u91cf\u5728\u5f88\u591a\u573a\u666f\u4e0b\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u5f88\u591a\u65f6\u5019\u6211\u4eec\u4e0d\u4ec5\u8981\u5173\u6ce8\u5176\u4ed6\u670d\u52a1\u8c03\u7528\u6211\u4eec\u670d\u52a1\u7684\u5065\u5eb7\u60c5\u51b5\uff0c\u4e5f\u8981\u5173\u6ce8\u6211\u4eec\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u7684\u5065\u5eb7\u72b6\u51b5\uff0c\u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\u4e8c\u8005\u662f\u606f\u606f\u76f8\u5173\u7684\u3002</p> <ul> <li>Namespace\uff1a\u8fd9\u91cc\u548c\u4e0a\u9762 Services dashboard \u63d0\u5230\u7684 namespace \u662f\u540c\u4e00\u4e2a\u6982\u5ff5\u3002</li> <li>Workload\uff1a\u6307\u7684\u662f\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u3002\u6bd4\u5982 reviews \u8fd9\u4e2a\u670d\u52a1\u5c31\u53ef\u4ee5\u9009\u62e9 v1\u3001v2\u3001v3 \u4e09\u4e2a\u7248\u672c\u3002</li> <li>Inbound Workload\uff1a\u6307\u7684\u662f\u4e0d\u540c\u7248\u672c\u7684\u8c03\u7528\u65b9\u670d\u52a1\uff0c\u6bd4\u5982 review-v3 \u8fd9\u4e2a\u670d\u52a1\uff0c\u5c31\u53ef\u4ee5\u770b\u5230 productpage-v1 \u8fd9\u4e2a\u8c03\u7528\u65b9\u3002</li> <li>Destination Service\uff1a\u6307\u7684\u662f\u5f53\u524d\u7248\u672c\u7684\u670d\u52a1\u8c03\u7528\u4e86\u54ea\u4e9b\u670d\u52a1\uff0c\u6bd4\u5982 review-v3 \u8fd9\u4e2a\u670d\u52a1\uff0c\u5c31\u53ef\u4ee5\u770b\u5230 <code>ratings.default.svc.cluster.local</code> \u8fd9\u4e2a\u88ab\u8c03\u65b9\u670d\u52a1\u3002</li> <li>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u770b\u51e0\u4e2a\u9762\u677f\u5c55\u793a\u7684\u4fe1\u606f\u3002</li> <li>WORKLOAD: reviews-v3.default\uff1a\u8fd9\u91cc\u5305\u542b\u4e86 review-v3 \u8fd9\u4e2a workload \u7684\u4e00\u4e9b\u57fa\u7840\u4fe1\u606f\uff0c\u5305\u542bQPS\u3001\u9519\u8bef\u7edf\u8ba1\u3001\u5ef6\u65f6\u7b49\u4fe1\u606f\u3002</li> <li>INBOUND WORKLOAD\uff1a\u5c55\u793a\u4e86\u4e0d\u540c\u7684\u8c03\u7528\u65b9\u7684 workload \u7ef4\u5ea6\u7684\u57fa\u7840\u4fe1\u606f\u3002</li> <li>OUTBOUND SERVICES\uff1a\u5c55\u793a\u4e86\u5f53\u524d\u670d\u52a1\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u7684\u76d1\u63a7\u4fe1\u606f\u3002</li> </ul>"},{"location":"chap2/7chap3_monitor/#2log","title":"2\u3001Log \u65e5\u5fd7","text":"<p>\u65e5\u5fd7\u7684\u89c2\u6d4b\u76f8\u5bf9\u7b80\u5355\uff0c\u6211\u4eec\u8fd8\u662f\u8bbf\u95ee\u51e0\u6b21 productpage \u9875\u9762\uff0c\u901a\u8fc7\u547d\u4ee4\u67e5\u770b\uff1a</p> <p>\u00b7\u00b7\u00b7 $ kubectl logs productpage-v1-65576bb7bf-hj6mw -c Istio-proxy \u00b7\u00b7\u00b7</p> <p>\u5728\u7ec8\u7aef\u4f1a\u770b\u5230\u5982\u4e0b\u8f93\u51fa\uff1a</p> <pre><code>[2021-02-14T02:36:34.480Z] \"GET /details/0 HTTP/1.1\" 200 - \"-\" \"-\" 0 178 7 7 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36\" \"8b9abfac-215b-93d6-98b6-6c56b8eb14da\" \"details:9080\" \"172.18.0.15:9080\" outbound|9080||details.default.svc.cluster.local 172.18.0.20:45544 10.110.238.95:9080 172.18.0.20:48928 - default\n\n[2021-02-14T02:36:34.493Z] \"GET /reviews/0 HTTP/1.1\" 200 - \"-\" \"-\" 0 379 318 316 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36\" \"8b9abfac-215b-93d6-98b6-6c56b8eb14da\" \"reviews:9080\" \"172.18.0.14:9080\" outbound|9080|v2|reviews.default.svc.cluster.local 172.18.0.20:57886 10.107.87.91:9080 172.18.0.20:43118 - -\n\n[2021-02-14T02:36:34.473Z] \"GET /productpage HTTP/1.1\" 200 - \"-\" \"-\" 0 5292 344 343 \"172.17.0.2\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36\" \"8b9abfac-215b-93d6-98b6-6c56b8eb14da\" \"127.0.0.1\" \"127.0.0.1:9080\" inbound|9080|http|productpage.default.svc.cluster.local 127.0.0.1:52130 172.18.0.20:9080 172.17.0.2:0 outbound_.9080_._.productpage.default.svc.cluster.local default\n</code></pre> <p>\u4f60\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u9762\u5305\u542b\u4e86 Envoy \u6536\u96c6\u7684\u8bbf\u95ee\u65e5\u5fd7\uff0c\u5305\u62ec\u8bbf\u95ee IP\u3001\u670d\u52a1\u540d\u3001user-agent \u7b49\u57fa\u672c\u4fe1\u606f\u3002\u5f53\u7136\u5982\u679c\u8981\u5206\u6790\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u4ec5\u4ec5\u901a\u8fc7\u547d\u4ee4\u67e5\u770b\u662f\u8fdc\u8fdc\u4e0d\u591f\u7684\uff0c\u6b64\u65f6\u6211\u4eec\u9700\u8981\u501f\u52a9 ELK \u8fd9\u6837\u7684\u5de5\u5177\u8fdb\u884c\u6536\u96c6\u548c\u5206\u6790\u3002</p>"},{"location":"chap2/7chap3_monitor/#3trace","title":"3\u3001Trace \u94fe\u8def\u8ffd\u8e2a","text":"<p>\u4ece\u4ee3\u7801\u5c42\u9762\u770b\u770b Istio \u662f\u5982\u4f55\u63a5\u5165 Trace \u7cfb\u7edf\u7684\u3002</p> <p>\u867d\u7136\u7f51\u683c\u4ee3\u7406 Envoy \u80fd\u591f\u81ea\u52a8\u8bc6\u522b Trace \u4e2d\u7684 header\uff0c\u5728\u8bf7\u6c42 upstream \u7684\u65f6\u5019\u81ea\u52a8\u751f\u6210 span \u5e76\u643a\u5e26\u53d1\u9001\uff0c\u4f46\u662f\u5982\u679c\u8981\u5c06\u6574\u4e2a\u94fe\u8def\u8ffd\u8e2a\u4fe1\u606f\u4e32\u5728\u4e00\u8d77\uff0c\u8fd8\u9700\u8981\u4ee3\u7801\u4e2d\u989d\u5916\u643a\u5e26\u4e00\u4e9b\u94fe\u8def\u8ffd\u8e2a\u4fe1\u606f\u624d\u80fd\u5b8c\u6210\u3002</p> <pre><code>x-request-id\nx-b3-traceid\nx-b3-spanid\nx-b3-parentspanid\nx-b3-sampled\nx-b3-flags\nx-ot-span-context\n</code></pre> <p>\u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b Bookinfo \u4e2d\u7684 productpage \u8fd9\u4e2a\u9879\u76ee\u4ee3\u7801\uff0c\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002\u6e90\u7801\u7684\u5730\u5740\u4e3ahttps://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/productpage.py\u3002</p> <p>\u9996\u5148\u6211\u4eec\u770b\u4e00\u4e0b\u5165\u53e3\u65b9\u6cd5\uff1a</p> <pre><code>@app.route('/productpage')\n    @trace()\n    def front():\n        product_id = 0  # TODO: replace default value\n        headers = getForwardHeaders(request)\n        user = session.get('user', '')\n        product = getProduct(product_id)\n        detailsStatus, details = getProductDetails(product_id, headers)\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u901a\u8fc7 <code>getForwardHeaders</code>\u65b9\u6cd5\uff0c\u6211\u4eec\u83b7\u53d6\u4e86\u5728\u8bf7\u6c42\u5176\u4ed6\u670d\u52a1\u65f6\u9700\u8981\u4f20\u9012\u7684 header \u53c2\u6570\uff0c\u5728 <code>getProductDetails</code> \u8c03\u7528\u7684\u65f6\u5019\uff0c\u4f20\u9012\u4e86\u6211\u4eec\u901a\u8fc7 <code>getForwardHeaders</code>\u65b9\u6cd5\u83b7\u5f97\u7684 header \u53c2\u6570\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b\u4e0a\u8ff0\u5185\u5bb9\u5982\u4f55\u5728\u4ee3\u7801\u4e2d\u5f97\u4ee5\u4f53\u73b0\uff1a</p> <pre><code>def getForwardHeaders(request):\n        headers = {}\n\n        # x-b3-*** \u901a\u8fc7 opentracing \u7684\u5e93\u76f4\u63a5\u83b7\u53d6\n        span = get_current_span() # \u83b7\u53d6 downstream header \u4e2d\u4f20\u9012\u7684 span\n        carrier = {}\n        tracer.inject(\n            span_context=span.context,\n            format=Format.HTTP_HEADERS,\n            carrier=carrier) # \u5c06 trace header \u6ce8\u5165 carrier\n\n        headers.update(carrier) # \u66f4\u65b0 headers\n\n        # \u624b\u52a8\u83b7\u53d6\u5176\u4ed6\u975e x-b3-*** \u7684 header\n        if 'user' in session:\n            headers['end-user'] = session['user']\n\n        # Keep this in sync with the headers in details and reviews.\n        incoming_headers = [\n            # All applications should propagate x-request-id. This header is\n            # included in access log statements and is used for consistent trace\n            # sampling and log sampling decisions in Istio.\n            'x-request-id',\n\n            # Lightstep tracing header. Propagate this if you use lightstep tracing\n            # in Istio (see\n            # https://istio.io/latest/docs/tasks/observability/distributed-tracing/lightstep/)\n            # Note: this should probably be changed to use B3 or W3C TRACE_CONTEXT.\n            # Lightstep recommends using B3 or TRACE_CONTEXT and most application\n            # libraries from lightstep do not support x-ot-span-context.\n            'x-ot-span-context',\n\n            # Datadog tracing header. Propagate these headers if you use Datadog\n            # tracing.\n            'x-datadog-trace-id',\n            'x-datadog-parent-id',\n            'x-datadog-sampling-priority',\n\n            # W3C Trace Context. Compatible with OpenCensusAgent and Stackdriver Istio\n            # configurations.\n            'traceparent',\n            'tracestate',\n\n            # Cloud trace context. Compatible with OpenCensusAgent and Stackdriver Istio\n            # configurations.\n            'x-cloud-trace-context',\n\n            # Grpc binary trace context. Compatible with OpenCensusAgent nad\n            # Stackdriver Istio configurations.\n            'grpc-trace-bin',\n\n            # b3 trace headers. Compatible with Zipkin, OpenCensusAgent, and\n            # Stackdriver Istio configurations. Commented out since they are\n            # propagated by the OpenTracing tracer above.\n            # 'x-b3-traceid',\n            # 'x-b3-spanid',\n            # 'x-b3-parentspanid',\n            # 'x-b3-sampled',\n            # 'x-b3-flags',\n\n            # Application-specific headers to forward.\n            'user-agent',\n        ]\n        # For Zipkin, always propagate b3 headers.\n        # For Lightstep, always propagate the x-ot-span-context header.\n        # For Datadog, propagate the corresponding datadog headers.\n        # For OpenCensusAgent and Stackdriver configurations, you can choose any\n        # set of compatible headers to propagate within your application. For\n        # example, you can propagate b3 headers or W3C trace context headers with\n        # the same result. This can also allow you to translate between context\n        # propagation mechanisms between different applications.\n        # \u4f20\u9012\u5176\u4ed6\u975e b3 header \u7684\u5934\u4fe1\u606f\n        for ihdr in incoming_headers:\n            val = request.headers.get(ihdr)\n            if val is not None:\n                headers[ihdr] = val\n\n        return headers\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u901a\u8fc7 Jaeger \u7684\u7c7b\u5e93\uff0c\u81ea\u52a8\u5c06\u5e26\u6709 b3 header \u7684\u6570\u636e\u5b58\u50a8\u5230\u4e86 headers \u4e2d\uff0c\u5176\u4ed6\u7684\u4e00\u4e9b Trace \u89c4\u8303\uff0c\u5219\u9700\u8981\u901a\u8fc7<code>incoming_headers</code> \u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u81ea\u52a8\u4f20\u9012\u3002</p> <p>\u81f3\u6b64\uff0c\u4ee3\u7801\u65b9\u9762\u7684\u539f\u7406\u544a\u4e00\u6bb5\u843d\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u542f\u52a8 Jaeger \u770b\u770b\u5177\u4f53\u7684\u6548\u679c\u3002</p> <p>\u542f\u52a8 Jaeger\uff0c\u901a\u8fc7 URL \u6216\u8005 cURL \u7684\u65b9\u5f0f\u591a\u6b21\u8bbf\u95ee productpage\uff1a</p> <pre><code>istioctl dashboard jaeger\n</code></pre> <p>\u70b9\u51fb\u4e00\u6761\u5177\u4f53\u7684\u94fe\u8def\uff0c\u8fdb\u5165\u8be6\u60c5\u9875\u9762\uff0c\u53ef\u4ee5\u8be6\u7ec6\u5c55\u793a\u6574\u4e2a\u5fae\u670d\u52a1\u8c03\u7528\u7684\u94fe\u8def\uff0c\u5305\u542b\u6bcf\u4e2a\u9636\u6bb5\u8017\u65f6\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u65b9\u4fbf\u6211\u4eec\u6392\u67e5\u5177\u4f53\u54ea\u4e2a\u73af\u8282\u51fa\u73b0\u4e86\u95ee\u9898\uff1a</p> <p> </p> <p>\u70b9\u51fb\u4e00\u6761\u5177\u4f53\u7684\u94fe\u8def\uff0c\u8fdb\u5165\u8be6\u60c5\u9875\u9762\uff0c\u53ef\u4ee5\u8be6\u7ec6\u5c55\u793a\u6574\u4e2a\u5fae\u670d\u52a1\u8c03\u7528\u7684\u94fe\u8def\uff0c\u5305\u542b\u6bcf\u4e2a\u9636\u6bb5\u8017\u65f6\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u65b9\u4fbf\u6211\u4eec\u6392\u67e5\u5177\u4f53\u54ea\u4e2a\u73af\u8282\u51fa\u73b0\u4e86\u95ee\u9898\uff1a</p> <p> </p> <p>\u70b9\u51fb System Architecture \u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u6574\u4e2a\u5fae\u670d\u52a1\u7684\u8c03\u7528\u5173\u7cfb\u5c55\u793a\uff1a</p> <p> </p> <p> </p>"},{"location":"chap2/8chap3_SM_GO_PROJ/","title":"\u7b2c\u516b\u8282 Proj\u9879\u76ee\u843d\u5730: Go \u5b9e\u73b0 Service Mesh","text":""},{"location":"chap2/8chap3_SM_GO_PROJ/#1","title":"1\u3001\u9879\u76ee\u80cc\u666f\uff1a\u5224\u65ad\u9009\u62e9\u5f00\u6e90\u4ea7\u54c1\u8fd8\u662f\u81ea\u7814","text":""},{"location":"chap2/8chap3_SM_GO_PROJ/#1-1","title":"1-1 \u9879\u76ee\u80cc\u666f","text":"<ul> <li>\u5165\u53e3\u5c42\u7f3a\u4e4f\u7edf\u4e00\u7684\u7cfb\u7edf\u7f51\u5173\uff1a\u591a\u4e2a\u670d\u52a1\u540c\u65f6\u5bf9\u5916\u66b4\u9732\uff0c\u65e0\u6cd5\u8fdb\u884c\u7edf\u4e00\u7684\u767b\u5f55\u9a8c\u8bc1\u3001\u52a0/\u89e3\u5bc6\u7b49\u529f\u80fd\uff0c\u53ea\u80fd\u5728\u5404\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u670d\u52a1\u4e2d\u5355\u72ec\u5b9e\u73b0\uff0c\u65e0\u6cd5\u8fdb\u884c\u7edf\u4e00\u7684\u7ef4\u62a4\u3002</li> <li>\u5b58\u5728\u96ea\u5d29\u73b0\u8c61\uff1a\u67d0\u4e00\u4e2a\u6838\u5fc3\u5fae\u670d\u52a1\u51fa\u73b0\u6545\u969c\u540e\uff0c\u5bfc\u81f4\u7ea7\u8054\u6545\u969c\uff0c\u4f9d\u8d56\u7684\u670d\u52a1\u56e0\u4e3a\u54cd\u5e94\u5ef6\u65f6\u53d8\u9ad8\uff0c\u90fd\u5c06\u51fa\u73b0\u6545\u969c\uff0c\u6700\u7ec8\u5bfc\u81f4\u6574\u7ad9\u6545\u969c\u3002</li> <li>\u65e0\u6cd5\u5904\u7406\u7a81\u53d1\u6d41\u91cf\uff1a\u5f88\u591a\u65f6\u5019\u56e0\u4e3a\u8fd0\u8425\u6d3b\u52a8\uff0c\u524d\u671f\u6ca1\u6709\u914d\u5408\u63d0\u524d\u6269\u5bb9\u8d44\u6e90, \u5bfc\u81f4\u670d\u52a1\u88ab\u7a81\u53d1\u6d41\u91cf\u6253\u6302\u3002</li> <li>\u5185\u90e8\u901a\u8fc7\u5185\u7f51\u96c6\u4e2d\u7f51\u5173\u8c03\u7528\uff1a\u5185\u90e8\u901a\u8fc7\u7edf\u4e00\u7684\u7f51\u5173\u8c03\u7528\uff0c\u4e00\u65e6\u5185\u90e8\u96c6\u4e2d\u7f51\u5173\u51fa\u73b0\u95ee\u9898\uff0c\u5bfc\u81f4\u6240\u6709\u670d\u52a1\u51fa\u73b0\u6545\u969c\uff0c\u7ee7\u800c\u5f15\u8d77\u6574\u7ad9\u6545\u969c\u3002</li> <li>\u9879\u76ee\u53ef\u89c2\u6d4b\u6027\u4e0d\u8db3\uff0c\u95ee\u9898\u6392\u67e5\u56f0\u96be\uff1a\u5404\u4e2a\u670d\u52a1\u81ea\u5df1\u5b9e\u73b0\u76d1\u63a7\u6307\u6807\uff0c\u6ca1\u6709\u7edf\u4e00\u7684\u76d1\u63a7\uff0c\u968f\u7740\u670d\u52a1\u6570\u91cf\u589e\u591a\uff0c\u95ee\u9898\u8d8a\u6765\u8d8a\u96be\u4ee5\u6392\u67e5\u3002</li> </ul> <p>\u8c03\u7814\u4ee5\u4e0b\u51e0\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u5305\u62ec\u5fae\u670d\u52a1\u6846\u67b6\u3001\u5f00\u6e90 Service Mesh \u65b9\u6848\u3001\u81ea\u7814 Service Mesh \u65b9\u6848</p> <p>\u5176\u4e2d\u5fae\u670d\u52a1\u6846\u67b6\u9700\u8981\u518d\u5f15\u5165\u4e00\u4e2a\u5f00\u6e90\u7cfb\u7edf\u7f51\u5173\u6216\u8005\u7528\u6846\u67b6\u5b9e\u73b0\u805a\u5408\u5c42\u3002</p> <p> </p>"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-2","title":"1-2 \u6280\u672f\u9009\u578b","text":"<p>\u5fae\u670d\u52a1\u6846\u67b6</p> <p>\u5fae\u670d\u52a1\u6846\u67b6\u5728 Web \u6846\u67b6\u7684\u57fa\u7840\u4e0a\uff0c\u589e\u52a0\u4e86\u670d\u52a1\u6cbb\u7406\u3001\u6ce8\u518c\u53d1\u73b0\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u8d1f\u8f7d\u5747\u8861\u3001RPC \u7b49\u591a\u79cd\u529f\u80fd\uff0c\u76ee\u7684\u662f\u63d0\u9ad8\u5fae\u670d\u52a1\u67b6\u6784\u7684\u7a33\u5b9a\u6027</p> <p> </p> <p>\u4f18\u70b9</p> <ul> <li>\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u76f4\u63a5\u8c03\u7528 upstream \u670d\u52a1\uff0c\u65e0\u987b\u7ecf\u8fc7\u4e2d\u95f4\u4ee3\u7406\u5c42\uff0c\u6027\u80fd\u9ad8\uff1b</li> <li>\u5fae\u670d\u52a1\u6846\u67b6\u76f8\u5bf9\u6bd4\u8f83\u6210\u719f\u3002</li> </ul> <p>\u7f3a\u70b9\uff1a</p> <ul> <li>\u6846\u67b6\u7ef4\u62a4\u5347\u7ea7\u6210\u672c\u9ad8\uff0c\u5fae\u670d\u52a1\u7684\u62c6\u5206\u4f1a\u5bfc\u81f4\u670d\u52a1\u6570\u91cf\u975e\u5e38\u591a\uff0c\u4e00\u65e6\u6846\u67b6\u53d1\u5e03\uff0c\u540e\u7eed\u5347\u7ea7\u51e0\u4e4e\u4e0d\u53ef\u80fd\u5b8c\u6210\uff1b</li> <li>\u65e7\u670d\u52a1\u63a5\u5165\u56f0\u96be\uff0c\u4fee\u6539\u4ee3\u7801\u6210\u672c\u9ad8\uff1b</li> <li>\u8bed\u8a00\u76f8\u5173\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u53ea\u80fd\u7ef4\u62a4\u4e00\u79cd\u8bed\u8a00\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u5bf9\u4e8e\u5c0f\u4f17\u8bed\u8a00\u65e0\u6cd5\u652f\u6301\u3002</li> </ul> <p>\u603b\u7ed3\uff1a\u76f8\u5bf9\u6765\u8bf4 Go \u8bed\u8a00\u7684\u5fae\u670d\u52a1\u6846\u67b6\u5e76\u4e0d\u7b97\u4e30\u5bcc\uff0c\u66f4\u591a\u6846\u67b6\u8fd8\u505c\u7559\u5728 Web \u65b9\u9762\uff0c\u6bd4\u5982 Gin\u3001Echo \u90fd\u662f\u51fa\u8272\u7684 Web \u6846\u67b6\u3002\u5982\u679c\u662f\u65b0\u9879\u76ee\uff0c\u5fae\u670d\u52a1\u6846\u67b6 go-zero \u662f\u76f8\u5bf9\u4e0d\u9519\u7684\u9009\u62e9\u3002</p> <p> </p>"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-2-service-mesh","title":"1-2 \u5f00\u6e90 Service Mesh \u65b9\u6848","text":"<p>\u4f18\u70b9\uff1a</p> <ul> <li>\u76f8\u5bf9\u4e8e\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u901a\u8fc7\u548c\u4e1a\u52a1\u67b6\u6784\u89e3\u8026\u7684\u65b9\u5f0f\uff0c\u964d\u4f4e\u4e86\u5347\u7ea7\u7ef4\u62a4\u7684\u6210\u672c\uff1b</li> <li>\u65b0\u65e7\u670d\u52a1\u63a5\u5165\u540c\u6837\u7b80\u5355\uff0c\u53ef\u4ee5\u901a\u8fc7 iptables \u7f51\u7edc\u52ab\u6301\u65e0\u611f\u77e5\u65b9\u5f0f\u63a5\u5165\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u5c11\u91cf\u4ee3\u7801\u652f\u6301\uff1b</li> <li>\u8bed\u8a00\u65e0\u5173\u6027\uff0c\u516c\u53f8\u7684\u5c0f\u4f17\u8bed\u8a00\u4e5f\u53ef\u4ee5\u5f88\u597d\u5730\u652f\u6301\uff1b</li> <li>\u53ef\u4ee5\u6301\u7eed\u8ddf\u8fdb\u793e\u533a\u65b9\u6848\uff0c\u83b7\u5f97\u793e\u533a\u7684\u6700\u65b0\u6210\u679c\uff1b</li> <li>\u9879\u76ee\u542f\u52a8\u5feb\uff0c\u4e0d\u9700\u8981\u7814\u53d1\uff0c\u53ea\u9700\u8981\u505a\u597d\u6d4b\u8bd5\u3002</li> </ul> <p>\u7f3a\u70b9\uff1a</p> <ul> <li>\u4ee3\u7801\u4e8c\u6b21\u6269\u5c55\u96be\u5ea6\u6bd4\u8f83\u5927\uff0c\u9700\u8981\u7279\u5b9a\u7684\u8bed\u8a00\u5f00\u53d1\u7ecf\u9a8c\uff0c\u516c\u53f8\u4e2a\u6027\u5316\u7684\u9700\u6c42\u65e0\u6cd5\u6ee1\u8db3\uff1b</li> <li>\u5f00\u6e90\u8f6f\u4ef6\u5f80\u5f80\u7248\u672c\u53d8\u5316\u6bd4\u8f83\u5927\uff0c\u5411\u524d\u517c\u5bb9\u6027\u6bd4\u8f83\u5dee\uff0c\u5982\u679c\u60f3\u8981\u7ef4\u62a4\u5347\u7ea7\uff0c\u4e5f\u9700\u8981\u5bf9\u6e90\u7801\u6709\u4e00\u5b9a\u7684\u638c\u63e1\uff0c\u5426\u5219\u5347\u7ea7\u98ce\u9669\u6bd4\u8f83\u5927\u3002</li> </ul>"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-3-service-mesh","title":"1-3 \u81ea\u7814 Service Mesh \u65b9\u6848","text":"<p>\u81ea\u7814 Service Mesh \u65b9\u6848\u5206\u4e3a\u4e24\u79cd\uff0c\u4e00\u79cd\u662f\u6570\u636e\u9762 Sidecar \u548c\u63a7\u5236\u9762\u5168\u90e8\u81ea\u7814\uff0c\u53e6\u5916\u4e00\u79cd\u662f\u4f7f\u7528\u5f00\u6e90\u6570\u636e\u9762\uff0c\u4f46\u662f\u81ea\u7814\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\u63a7\u5236\u9762\u3002</p>"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-4","title":"1-4 \u5b8c\u5168\u81ea\u7814","text":"<p>\u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u5b8c\u5168\u81ea\u7814\u7684\u65b9\u6848\u3002</p> <p>\u4f18\u70b9\uff1a</p> <ul> <li>\u5177\u5907\u5f00\u6e90 Service Mesh \u65b9\u6848\u76f8\u5bf9\u4e8e\u5fae\u670d\u52a1\u6846\u67b6\u7684\u4f18\u52bf\uff1b</li> <li>\u53ef\u6269\u5c55\u6027\u5f3a\uff0c\u53ef\u4ee5\u517c\u5bb9\u516c\u53f8\u8fd0\u7ef4\u73af\u5883\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u5b9a\u5236\u578b\u9700\u6c42\uff0c\u6bd4\u5982\u65b0\u7684 RPC \u534f\u8bae\u652f\u6301\u3001\u591a\u534f\u8bae\u670d\u52a1\u6cbb\u7406\u3001\u65b0\u7684\u8d1f\u8f7d\u5747\u8861\u652f\u6301\u7b49\uff1b</li> <li>\u9879\u76ee\u628a\u63a7\u529b\u5f3a\uff0c\u51fa\u73b0\u95ee\u9898\u53ef\u4ee5\u5feb\u901f\u89e3\u51b3</li> </ul> <p>\u7f3a\u70b9\uff1a</p> <ul> <li>\u7814\u53d1\u6210\u672c\u9ad8\uff0c\u9700\u8981\u4e00\u5b9a\u7684\u7814\u53d1\u65f6\u95f4\uff0c\u4e0a\u7ebf\u7070\u5ea6\u5230\u7a33\u5b9a\u7248\u672c\u4e5f\u9700\u8981\u65f6\u95f4\uff0c\u5728\u7070\u5ea6\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u4f1a\u6709 Bug \u51fa\u73b0\uff1b</li> <li>\u548c\u793e\u533a\u6709\u4e00\u5b9a\u7684\u5272\u88c2\u3002</li> </ul>"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-5","title":"1-5 \u5f00\u6e90\u6570\u636e\u9762+\u81ea\u7814\u63a7\u5236\u9762","text":"<p>\u76f4\u63a5\u4f7f\u7528\u5f00\u6e90\u63a7\u5236\u9762\u65b9\u6848\u57fa\u672c\u4e0a\u65e0\u6cd5\u6ee1\u8db3\u63a7\u5236\u9762\u4e2a\u6027\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u7b2c\u4e09\u65b9\u6ce8\u518c\u4e2d\u5fc3\u7684\u652f\u6301\u3001\u865a\u62df\u673a\u73af\u5883\u7684\u652f\u6301\u7b49</p> <p>\u4f18\u70b9\uff1a</p> <ul> <li>\u53ef\u4ee5\u6ee1\u8db3\u516c\u53f8\u591a\u6837\u7684\u8fd0\u7ef4\u73af\u5883\uff1b</li> <li>\u63a7\u5236\u9762\u81ea\u7814\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\uff0c\u6709\u4e00\u5b9a\u7684\u5b9a\u5236\u6027\u3002</li> </ul> <p>\u7f3a\u70b9\uff1a</p> <ul> <li>\u6570\u636e\u9762 Sidecar \u4f9d\u7136\u6709\u5f00\u6e90\u65b9\u6848\u7684\u5f0a\u7aef\u3002</li> <li>\u9996\u5148\u4e8e\u6570\u636e\u9762\u65e0\u6cd5\u5b9a\u5236\uff0c\u5176\u6b21\u5bf9\u4e8e\u63a7\u5236\u9762\u80fd\u505a\u7684\u8054\u52a8\u6709\u4e00\u5b9a\u7684\u5c40\u9650\u6027\u3002</li> </ul>"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-6","title":"1-6 \u6280\u672f\u5b9e\u73b0","text":"<p>\u529f\u80fd\u70b9</p> <p>\u6570\u636e\u9762 Sidecar\uff1a</p> <ul> <li>\u5b9e\u73b0\u57fa\u7840\u6846\u67b6\uff0c\u80fd\u591f\u4ee3\u7406 HTTP \u534f\u8bae\uff0c\u5e76\u5177\u5907\u6269\u5c55\u6027\uff1b</li> <li>\u652f\u6301\u9650\u6d41\u3001\u7194\u65ad\u7b49\u670d\u52a1\u6cbb\u7406\u4e2d\u95f4\u4ef6\uff1b</li> <li>\u652f\u6301\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\uff0c\u5305\u62ec Log\u3001Trace \u548c Metrics\uff1b</li> <li>\u652f\u6301\u670d\u52a1\u6ce8\u518c\u548c\u53d1\u73b0\uff0c\u80fd\u591f\u4ee3\u7406\u4e1a\u52a1\u670d\u52a1\u8fdb\u884c\u6ce8\u518c\uff1b</li> <li>\u901a\u8fc7 xDS \u548c\u63a7\u5236\u9762\u901a\u4fe1\u3002</li> </ul> <p>\u63a7\u5236\u9762\uff1a</p> <p>\u540c\u65f6\u517c\u5bb9\u865a\u62df\u673a\u548c Kubernetes\uff0c\u548c\u516c\u53f8\u73b0\u6709\u7684 CMDB \u7cfb\u7edf\u6253\u901a\uff0c\u540c\u6b65\u673a\u5668\u5143\u6570\u636e\u3002 \u652f\u6301 xDS \u534f\u8bae\uff0c\u517c\u5bb9\u73b0\u6709\u7684\u3001\u91c7\u7528 xDS \u534f\u8bae\u7684\u6570\u636e\u9762\u3002</p> <p>\u6280\u672f\u9009\u578b</p> <ul> <li> <p>Go-Micro \u6846\u67b6\u5b8c\u5168\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u6570\u636e\u9762 Sidecar \u7684\u9700\u6c42\uff0c\u5176\u672c\u8eab\u4e5f\u652f\u6301\u4e86\u591a\u79cd\u534f\u8bae\u3002\uff08Go-Micro \u9879\u76ee\u5730\u5740https://github.com/asim/go-micro\uff09</p> </li> <li> <p>\u63a7\u5236\u9762 Envoy \u4e5f\u63d0\u4f9b\u4e86\u57fa\u7840\u6846\u67b6\uff0c\u4e3a\u4e86\u964d\u4f4e\u590d\u6742\u5ea6\uff0c\u6211\u4eec\u4e0d\u4f7f\u7528 Istio \u4e8c\u6b21\u5f00\u53d1\uff0c\u76f4\u63a5\u7528 Envoy \u63d0\u4f9b\u7684\u63a7\u5236\u9762\u57fa\u7840\u6846\u67b6\u6765\u5f00\u53d1\u3002\uff08\u5730\u5740\u4e3ahttps://github.com/envoyproxy/go-control-plane\uff09</p> </li> </ul> <p> </p>"},{"location":"chap2/8chap3_SM_GO_PROJ/#2-go-micro","title":"2\u3001\u6570\u636e\u9762\uff1a\u57fa\u4e8e Go-Micro \u5feb\u901f\u5b9e\u73b0\u4ee3\u7406\u6a21\u5757","text":"<p>\u5728\u5e38\u89c1\u7684\u5f00\u6e90\u6570\u636e\u9762\u4e2d\uff0cEnvoy \u4f7f\u7528 C++ \u5b9e\u73b0\uff0cLinkerd \u65e9\u671f\u7248\u672c\u4f7f\u7528 Java\uff0c\u65b0\u7248\u672c\u4f7f\u7528 Rust \u5b9e\u73b0\uff0c\u800c MOSN \u548c Maesh \u90fd\u4f7f\u7528 Go \u8bed\u8a00\u5b9e\u73b0\u3002\u4ece\u8fd9\u4e9b\u6280\u672f\u9009\u578b\u53ef\u4ee5\u770b\u51fa\uff0cGo \u8bed\u8a00\u5728\u6570\u636e\u9762\u7684\u5b9e\u73b0\u4e2d\u5360\u6709\u4e00\u5e2d\u4e4b\u5730\uff0c\u4e3b\u8981\u662f\u8f83\u9ad8\u7684\u6027\u80fd\u548c\u8f83\u5c11\u7684\u5185\u5b58\u5360\u7528\uff0c\u6bd4\u8f83\u9002\u5408 Sidecar \u7684\u5e94\u7528\u573a\u666f\u3002</p> <p>\u4e3a\u4e86\u5feb\u901f\u5b9e\u73b0\uff0c\u6211\u4eec\u4f7f\u7528\u4e86 Go-micro \u6846\u67b6\uff0c\u8fd9\u4e2a\u6846\u67b6\u6709\u975e\u5e38\u597d\u7684\u62bd\u8c61\u5c42\uff0c\u652f\u6301 MUCP\u3001gRPC\u3001HTTP \u7b49\u534f\u8bae\u7684\u539f\u751f\u4ee3\u7406\uff0c\u540e\u671f\u4e5f\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u6269\u5c55\u534f\u8bae\u5c42\u3002</p> <p>https://github.com/beck917/easymesh</p>"},{"location":"chap2/8chap3_SM_GO_PROJ/#2-1","title":"2-1 \u73af\u5883\u5b89\u88c5&amp;\u6846\u67b6\u642d\u5efa","text":"<p>\u9996\u5148\u8fdb\u5165 Go \u8bed\u8a00\u5b98\u7f51\uff0c\u6839\u636e\u73af\u5883\u4e0b\u8f7d\u5408\u9002\u7684\u7248\u672chttps://golang.google.cn/dl/\uff0c\u56e0\u4e3a Go-Micro \u7684\u65e7\u7248\u672c\u4f9d\u8d56\u95ee\u9898\uff0c\u8fd9\u91cc\u6211\u4eec\u9009\u62e9 Go 1.14 \u7248\u672c\u3002</p> <p> </p>"},{"location":"chap2/8chap3_SM_GO_PROJ/#2-2","title":"2-2 \u4ee3\u7801\u89e3\u6790","text":"<p>\u9996\u5148\u6211\u4eec\u770b\u4e00\u4e0b main \u65b9\u6cd5\uff0c\u8fd9\u91cc\u521b\u5efa\u4e86\u4e24\u4e2a\u4ee3\u7406\u670d\u52a1\u5668\uff0c\u5206\u522b\u662f\u76d1\u542c 8082 \u7aef\u53e3\u7684\u51fa\u6d41\u91cf\u4ee3\u7406\u548c\u76d1\u542c 8083 \u7aef\u53e3\u7684 8083 \u670d\u52a1\uff1a</p> <pre><code>func main() {\n    http.HandleFunc(\"/\", indexHandler)\n    go http.ListenAndServe(\":6060\", nil)\n    // start the client proxy\n    go proxy.Run(&amp;proxy.ServerOptions{\n        Name:     \"Client Listener Proxy\",\n        Address:  \":8082\",\n        Endpoint: \"http://127.0.0.1:8083\",\n        Protocol: \"http\",\n    })\n    time.Sleep(1 * time.Second)\n    // start the server proxy\n    proxy.Run(&amp;proxy.ServerOptions{\n        Name:     \"Server Listener Proxy\",\n        Address:  \":8083\",\n        Endpoint: \"http://127.0.0.1:6060\",\n        Protocol: \"http\",\n    })\n}\n</code></pre> <p>\u4e0b\u9762\u89e3\u91ca\u4e0b <code>proxy.Run</code> \u65b9\u6cd5\u7684\u51e0\u4e2a\u53c2\u6570\u3002</p> <ul> <li>Name\uff1a\u4ee3\u7406\u670d\u52a1\u5668\u552f\u4e00\u6807\u8bc6\u3002</li> <li>Address\uff1a\u4ee3\u7406\u670d\u52a1\u5668\u76d1\u542c\u5730\u5740\u3002</li> <li>Endpoint\uff1a\u4ee3\u7406\u670d\u52a1\u5668\u6d41\u91cf\u8f6c\u53d1\u7684\u5730\u5740\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc Client Proxy \u5c06 Endpoint \u8bbe\u7f6e\u4e3a <code>http://127.0.0.1:8083</code>\uff0c\u610f\u601d\u662f\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 <code>Server Proxy</code>\uff0c\u800c <code>Server Proxy</code>\u5c06\u6d41\u91cf\u8f6c\u5411\u4e86\u672c\u5730\u7684 <code>6060</code> \u7aef\u53e3\uff0c\u4e5f\u5c31\u662f\u670d\u52a1\u7aef\u53e3\uff0c\u8fd9\u6837\u5c31\u5f62\u6210\u4e86\u4e00\u4e2a\u5b8c\u6210\u7684 Mesh \u94fe\u8def\u3002</li> <li>Protocol\uff1a\u4ee3\u7406\u7684\u534f\u8bae\uff0c\u8fd9\u91cc\u662f HTTP\u3002</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u8fdb\u5165 Run \u65b9\u6cd5\u770b\u4e00\u4e0b\u6838\u5fc3\u4ee3\u7801\uff1a</p> <pre><code>    // new proxy\n    var p proxy.Proxy\n    var s server.Server\n    // set endpoint\n    if len(Endpoint) &gt; 0 {\n        switch {\n        case strings.HasPrefix(Endpoint, \"grpc://\"):\n            ep := strings.TrimPrefix(Endpoint, \"grpc://\")\n            popts = append(popts, proxy.WithEndpoint(ep))\n            p = grpc.NewProxy(popts...)\n        case strings.HasPrefix(Endpoint, \"http://\"):\n            // TODO: strip prefix?\n            popts = append(popts, proxy.WithEndpoint(Endpoint))\n            p = http.NewProxy(popts...)\n            s = smucp.NewServer(\n                server.WrapHandler(ratelimiter.NewHandlerWrapper(10)),\n            )\n        default:\n            // TODO: strip prefix?\n            popts = append(popts, proxy.WithEndpoint(Endpoint))\n            p = mucp.NewProxy(popts...)\n        }\n    }\n</code></pre> <p><code>Run()</code> \u65b9\u6cd5\u6839\u636e\u4f20\u5165\u7684\u53c2\u6570 <code>Endpoint</code> \u4f1a\u9009\u62e9\u5bf9\u5e94\u7684\u534f\u8bae\uff0c\u8fd9\u91cc\u6211\u4f20\u5165\u7684\u662f <code>HTTP</code>\u534f\u8bae\u7684Endpoint\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2a HTTP \u7684 Proxy\u3002</p> <p>\u8fd9\u4e2a HTTP \u7684 Proxy \u8ddf\u8e2a\u4f60\u53ef\u4ee5\u53c2\u7167 Go-Micro \u7684\u4ee3\u7801\uff0c\u4e5f\u5f88\u7b80\u5355\uff0c\u5176\u5b9e\u6240\u6709\u7684 Proxy \u90fd\u4f1a\u901a\u8fc7 <code>ServeRequest(ctx context.Context, req server.Request, rsp server.Response)</code>\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u5bf9 Server \u5904\u7406\u8fc7\u540e\u7684 HTTP \u8fdb\u884c\u8f6c\u53d1\u64cd\u4f5c\u3002</p> <pre><code>// get data\n        body, err := req.Read()\n        if err == io.EOF {\n            return nil\n        }\n        if err != nil {\n            return err\n        }\n        // get the header\n        hdr := req.Header()\n        // get method\n        method := getMethod(hdr)\n        // get endpoint\n        endpoint := getEndpoint(hdr)\n        // send to backend\n        hreq, err := http.NewRequest(method, endpoint, bytes.NewReader(body))\n        if err != nil {\n            return errors.InternalServerError(req.Service(), err.Error())\n        }\n        // set the headers\n        for k, v := range hdr {\n            hreq.Header.Set(k, v)\n        }\n        // make the call\n        hrsp, err := http.DefaultClient.Do(hreq)\n        if err != nil {\n            return errors.InternalServerError(req.Service(), err.Error())\n        }\n</code></pre> <p>\u8fd9\u91cc\u5148\u8bfb\u53d6\u4e86 Server \u83b7\u53d6\u5230\u7684\u8bf7\u6c42 header \u548c body\uff0c\u7136\u540e\u5efa\u7acb\u4e86 HTTP \u5ba2\u6237\u7aef\u8fdb\u884c\u6d41\u91cf\u8f6c\u53d1\u3002</p> <p>\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u7684\u8f6c\u53d1\u76f8\u5bf9\u7b80\u5355\uff0c\u56e0\u4e3a\u76f8\u5bf9\u4e8e\u81ea\u5b9a\u4e49\u534f\u8bae\uff0cHTTP Golang \u63d0\u4f9b\u4e86\u73b0\u6210\u7684\u5ba2\u6237\u7aef\uff0c\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528\u5373\u53ef\u3002</p> <p>Go-Micro \u7684 HTTP \u7684\u4ee3\u7406\u5b9e\u73b0\u76f8\u5bf9\u7b80\u5355\uff0c\u4f46\u662f\u4f60\u8981\u6ce8\u610f\uff1a\u8fd9\u91cc\u7684\u4ee3\u7801\u5e76\u6ca1\u6709\u8fdb\u884c\u4f18\u5316\u548c\u5ba2\u6237\u7aef\u7684\u8d85\u65f6\u5904\u7406\uff0c\u65e0\u6cd5\u76f4\u63a5\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u3002\u5982\u679c\u60f3\u7528\u4e8e\u751f\u4ea7\u73af\u5883\uff0c\u8fd8\u9700\u8981\u4e00\u4e9b\u6539\u9020\uff0c\u6bd4\u5982\u81ea\u5df1\u5efa\u7acb HTTP Client\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u7528 http.DefaultClient\u3002</p> <p>\u53e6\u5916\uff0chreq \u5bf9\u8c61\u4e5f\u8981\u643a\u5e26 context\uff0c\u4ee5\u786e\u4fdd\u53ef\u4ee5\u63a7\u5236\u8d85\u65f6\uff0c\u8fd4\u56de 504 Gateway Timetout \u7684\u9519\u8bef\u3002</p> <p>\u521b\u5efa\u5b8c Proxy \u540e\uff0c\u4e0b\u9762\u7684\u4ee3\u7801\u57fa\u672c\u4e0a\u548c Go-Micro \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Server \u6ca1\u6709\u4ec0\u4e48\u533a\u522b\u4e86\u3002</p> <p>\u53ea\u662f\u8fd9\u91cc\u7684 Muxer \u8fd9\u4e2a router \u5c06\u4f1a\u76f4\u63a5\u7ed5\u8fc7 Server \u7684 router \u5c42\uff0c\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u5411 Proxy \u5c42\uff0c\u56e0\u4e3a Server \u7684 router \u5176\u5b9e\u5df2\u7ecf\u6ca1\u6709\u7528\u4e86\uff0c\u76f8\u5f53\u4e8e\u88ab Proxy \u52ab\u6301\u4e86\uff0c\u6bd5\u7adf\u8fd9\u91cc\u6211\u4eec\u4e0d\u9700\u8981\u8def\u7531\u5230 Server \u7684\u5177\u4f53\u65b9\u6cd5\u3002</p> <pre><code>    // new service\n    service := micro.NewService(srvOpts...)\n    // create a new proxy muxer which includes the debug handler\n    muxer := mux.New(Name, p)\n    // set the router\n    service.Server().Init(\n        server.WithRouter(muxer),\n    )\n    // Run internal service\n    if err := service.Run(); err != nil {\n        log.Fatal(err)\n    }\n</code></pre> <p>\u8fdb\u5165 mux \u7684\u4ee3\u7801\u4e5f\u53ef\u4ee5\u4e86\u89e3\u5230\uff0c\u8fd9\u91cc\u76f4\u63a5\u8c03\u7528\u4e86<code>proxy.ServeRequest()</code>\uff1a</p> <pre><code>func (s *Server) ServeRequest(ctx context.Context, req server.Request, rsp server.Response) error {\n    if req.Service() == s.Name {\n        return server.DefaultRouter.ServeRequest(ctx, req, rsp)\n    }\n    return s.Proxy.ServeRequest(ctx, req, rsp)\n}\n</code></pre> <p>\u63a7\u5236\u9762\uff1a\u5b9e\u73b0 xDS \u914d\u7f6e\u7ba1\u7406</p> <p>\u6211\u4eec\u5148\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u9650\u6d41\u4e2d\u95f4\u4ef6\u5b66\u4e60\u4e00\u4e0b\u8fd9\u90e8\u5206\u5185\u5bb9\uff1a</p> <pre><code>s = smucp.NewServer(\n                server.WrapHandler(ratelimiter.NewHandlerWrapper(10)),\n            )\n</code></pre> <p>RateLimit \u4e2d\u95f4\u4ef6\u4f7f\u7528\u4e86 Uber \u7684\u5e93\u5b9e\u73b0\uff0c\u8fbe\u5230\u9650\u6d41\u503c\u4f1a\u4ea7\u751f\u963b\u585e\uff0c\u800c\u4e0d\u662f\u8fd4\u56de\u9519\u8bef\u3002\u5728\u751f\u4ea7\u4e2d\uff0c\u8fd8\u662f\u5efa\u8bae\u4f7f\u7528\u8fd4\u56de\u9519\u8bef\u7684\u65b9\u5f0f\u5b9e\u73b0\u9650\u6d41\u5668\uff0c\u56e0\u4e3a\u4ea7\u751f\u963b\u585e\u53ef\u80fd\u4f1a\u8fdb\u4e00\u6b65\u6076\u5316\u5e76\u53d1\u60c5\u51b5\u3002\u5177\u4f53\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>// NewHandlerWrapper creates a blocking server side rate limiter\nfunc NewHandlerWrapper(rate int) server.HandlerWrapper {\n    r := ratelimit.New(rate)\n    return func(h server.HandlerFunc) server.HandlerFunc {\n        return func(ctx context.Context, req server.Request, rsp interface{}) error {\n            r.Take()\n            return h(ctx, req, rsp)\n        }\n    }\n}\n</code></pre> <p>\u81f3\u6b64\uff0c\u4e00\u4e2a\u7b80\u5355\u7684 Sidecar Proxy \u7684\u4ee3\u7801\u5b9e\u73b0\u90e8\u5206\u5c31\u8bb2\u89e3\u5b8c\u4e86\u3002\u4e0b\u9762\u6211\u4eec\u7f16\u8bd1\u5e76\u542f\u52a8\u8fd9\u4e2a\u7b80\u5355\u7684 Sidecar \uff0c\u6765\u770b\u4e00\u4e0b\u5b9e\u9645\u7684\u8fd0\u884c\u6548\u679c\u3002</p> <p>\u5bf9\u4ee3\u7801\u8fdb\u884c\u7f16\u8bd1\u5e76\u542f\u52a8\uff1a</p> <pre><code>go run -mod=vendor .\\main.go\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4e0b\u9762\u7684\u542f\u52a8\u4fe1\u606f\uff1a</p> <pre><code>2021-02-20 23:49:44.486504 I | [proxy] Proxy [http] serving endpoint: http://127.0.0.1:8083\n2021-02-20 23:49:44.490502 I | [proxy] Transport [http] Listening on [::]:8082\n2021-02-20 23:49:44.502494 I | [proxy] Broker [http] Connected to [::]:14393\n2021-02-20 23:49:44.695376 I | [proxy] Registry [mdns] Registering node: Client Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d\n2021-02-20 23:49:45.497904 I | [proxy] Proxy [http] serving endpoint: http://127.0.0.1:6060\n2021-02-20 23:49:45.498903 I | [proxy] Transport [http] Listening on [::]:8083\n2021-02-20 23:49:45.585850 I | [proxy] Broker [http] Connected to [::]:14393\n2021-02-20 23:49:45.758753 I | [proxy] Registry [mdns] Registering node: Server Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d\n2021-02-20 23:49:46.606504 I | [proxy] Registry [mdns] Deregistering node: Client Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d\n2021-02-20 23:49:46.609502 I | [proxy] Registry [mdns] Deregistering node: Server Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u540c\u65f6\u542f\u52a8\u4e86\u4e24\u4e2a\u7aef\u53e3 8082 \u548c 8083\uff0c\u5206\u522b\u662f Sidecar \u5904\u7406\u51fa\u6d41\u91cf\u548c\u5165\u6d41\u91cf\u7684\u7aef\u53e3\uff0c\u540c\u65f6\u6709\u8f93\u51fa\u4e86\u4e24\u4e2a Server \u4ee3\u7406\u7684\u76ee\u7684\u5730\u3002</p> <p>\u6211\u4eec\u5148\u6765\u8bf7\u6c42 8083 \u7aef\u53e3\uff0c\u8fd9\u4e2a\u7aef\u53e3\u4f1a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u672c\u5730\u7684 6060 \u7aef\u53e3\u3002\u4e3a\u4e86\u8c03\u8bd5\uff0c\u6211\u4eec\u7684 Sidecar \u4ee3\u7801\u5728 6060 \u7aef\u53e3\u542f\u52a8\u4e86\u4e00\u4e2a HTTP \u670d\u52a1\u5668\uff0c\u8bf7\u6c42\u8fd9\u4e2a Server \u4f1a\u8fd4\u56de Hello World \u7684\u8f93\u51fa\uff1a</p> <pre><code>curl 127.0.0.1:6060/ -i\n\nStatusCode        : 200\nStatusDescription : OK\nContent           : hello world\nRawContent        : HTTP/1.1 200 OK\n                    Content-Length: 11\n                    Content-Type: text/plain; charset=utf-8\n                    Date: Sun, 21 Feb 2021 18:27:35 GMT\n                    hello world\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u4e86\u76f8\u540c\u7684\u4fe1\u606f\uff0c\u8868\u793a Sidecar \u786e\u5b9e\u8fdb\u884c\u4e86\u6b63\u786e\u7684\u8f6c\u53d1\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u518d\u8bf7\u6c42 8082 \u7aef\u53e3\uff0c\u6a21\u62df\u4e00\u4e0b\u5b8c\u6574\u7684 Mesh \u8fc7\u7a0b\u3002\u6574\u4e2a\u8fc7\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p>\u8bf7\u6c428082\u7aef\u53e3\uff1a</p> <pre><code>curl 127.0.0.1:8082/\n\nStatusCode        : 200\nStatusDescription : OK\nContent           : hello world\nRawContent        : HTTP/1.1 200 OK\n                    Accept-Encoding: gzip\n                    Connection: Keep-Alive\n                    User-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; zh-CN) WindowsPowerShell/5.1.18362.1171\n                    Content-Length: 11\n                    Content-Type: text/pl...\n</code></pre> <p>\u89e3\u6790\u53ef\u4ee5\u53d1\u73b0\uff0c\u8fd9\u91cc\u7684\u6d41\u91cf\u7ecf\u7531 8082\uff0c\u88ab\u8f6c\u53d1\u5230\u4e86 8083 \u7aef\u53e3\uff0c\u7ecf\u5386\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684 Mesh \u4ee3\u7406\u8fc7\u7a0b\u3002</p> <p>\u4ece\u5ba2\u6237\u7aef\u7684\u6b63\u5411\u4ee3\u7406\uff0c\u5230\u670d\u52a1\u7aef\u7684\u53cd\u5411\u4ee3\u7406\uff0c\u901a\u8fc7\u5bf9\u51fa\u6d41\u91cf\u548c\u5165\u6d41\u91cf\u8fdb\u884c\u4ee3\u7406\uff0c\u5b8c\u6574\u638c\u63a7\u4e86\u6574\u4e2a\u5fae\u670d\u52a1\u94fe\u8def\u7684\u6d41\u91cf\u3002\u6700\u540e\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u4e86\u771f\u5b9e\u7684 Service\uff0c\u4e5f\u5c31\u662f 6060 \u7aef\u53e3\u542f\u52a8\u7684\u670d\u52a1\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u5229\u7528 Go-Micro \u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684 Sidecar \u5c31\u5b8c\u6210\u4e86\u3002\u4f60\u53ef\u4ee5\u770b\u5230\uff0cSidecar \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u4ee3\u7406\u7a0b\u5e8f\uff0c\u800c\u5229\u7528 Go-Micro \u5b9e\u73b0\u4e00\u4e2a Sidecar \u539f\u578b\u4e5f\u5e76\u4e0d\u590d\u6742\uff0c\u4f46\u8981\u505a\u4e00\u4e2a\u751f\u4ea7\u73af\u5883\u53ef\u7528\u7684 Sidecar \u8fd8\u6709\u5f88\u591a\u5de5\u4f5c\u8981\u5b8c\u5584\uff0c\u6bd4\u5982\u4e00\u4e9b\u9519\u8bef\u7684\u5904\u7406\u3001\u591a\u79cd\u534f\u8bae\u7684\u652f\u6301\u3001\u652f\u6301\u590d\u6742\u7684\u8def\u7531\u548c\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u4ee5\u53ca\u9650\u6d41\u7194\u65ad\u7b49\u57fa\u672c\u7684\u670d\u52a1\u6cbb\u7406\u529f\u80fd\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u5728 Go \u8bed\u8a00\u4e2d\u8fd8\u6709\u53e6\u5916\u4e00\u79cd\u5b9e\u73b0 HTTP \u4ee3\u7406\u66f4\u7b80\u5355\u3001\u66f4\u7a33\u5b9a\u7684\u65b9\u6cd5\uff0c\u8fd9\u91cc\u6211\u4eec\u4e5f\u7b80\u5355\u505a\u4e00\u4e0b\u4ecb\u7ecd\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u6ca1\u6709\u7740\u91cd\u4ecb\u7ecd\u8fd9\u79cd\u65b9\u6cd5\uff0c\u800c\u9009\u62e9\u91c7\u7528 Go-Micro \u6765\u5b9e\u73b0\uff0c\u662f\u56e0\u4e3a Go-Micro \u65b9\u4fbf\u6269\u5c55\u591a\u79cd\u534f\u8bae\uff0c\u4ee5\u53ca\u7edf\u4e00\u7684\u4e2d\u95f4\u4ef6\u5c42\u3002</p> <pre><code>package main\nimport (\n        \"log\"\n        \"math/rand\"\n        \"net/http\"\n        \"net/http/httputil\"\n        \"net/url\"\n)\nfunc NewMultipleHostsReverseProxy(targets []*url.URL) *httputil.ReverseProxy {\n        director := func(req *http.Request) {\n                target := targets[rand.Int()%len(targets)]\n                req.URL.Scheme = target.Scheme\n                req.URL.Host = target.Host\n                req.URL.Path = target.Path\n        }\n        return &amp;httputil.ReverseProxy{Director: director}\n}\nfunc main() {\n        proxy := NewMultipleHostsReverseProxy([]*url.URL{\n                {\n                        Scheme: \"http\",\n                        Host:   \"localhost:6060\",\n                },\n        })\n        log.Fatal(http.ListenAndServe(\":9090\", proxy))\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cGolang \u672c\u8eab\u63d0\u4f9b\u4e86 ReverseProxy \u7684\u5bf9\u8c61\u3002</p> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u5bf9\u8c61\uff0c\u5e76\u4f20\u5165 HTTP Server\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684 HTTP Proxy \u529f\u80fd\u3002\u5bf9\u4e8e HTTP \u670d\u52a1\u6765\u8bf4\uff0c\u8fd9\u4e2a Proxy \u5b9e\u73b0\u6bd4 Go-Micro \u7684\u5b9e\u73b0\u76f8\u5bf9\u9ad8\u6548\uff0c\u5b83\u5e76\u6ca1\u6709\u521b\u5efa HTTP Client\uff0c\u800c\u662f\u76f4\u63a5\u5229\u7528\u4e86\u66f4\u5e95\u5c42\u7684 HTTP Transport \u8fdb\u884c\u6d41\u91cf\u7684\u8f6c\u53d1\uff0c</p> <p>Golang \u7684\u6e90\u7801: https://github.com/golang/go/blob/master/src/net/http/httputil/reverseproxy.go</p> <p> </p>"},{"location":"chap2/8chap3_SM_GO_PROJ/#3-xds","title":"3\u3001 \u63a7\u5236\u9762\uff1a\u5b9e\u73b0 xDS \u914d\u7f6e\u7ba1\u7406","text":"<p>\u4ee3\u7801\u5b9e\u73b0 Service Mesh \u63a7\u5236\u9762\uff0c\u5b9e\u73b0 xDS \u914d\u7f6e\u7ba1\u7406\uff0c\u4ee5\u53ca\u6570\u636e\u9762 Sidecar \u5982\u4f55\u4e0e\u63a7\u5236\u9762\u8fdb\u884c\u901a\u4fe1\u3002</p> <p>\u4ee3\u7801\u5b9e\u73b0\u5728https://github.com/beck917/easypilot\u548chttps://github.com/beck917/easymesh\u4e2d</p> <p>Envoy \u5b98\u65b9\u7684\u5b9e\u4f8b\u548c\u8457\u540d\u7684\u63a7\u5236\u9762 Istio\uff0c\u90fd\u9009\u62e9\u4f7f\u7528 Go \u8bed\u8a00\u6765\u5b9e\u73b0\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u4e5f\u91c7\u7528 Go \u8bed\u8a00\u5b9e\u73b0\u63a7\u5236\u9762\u4ee3\u7801</p>"},{"location":"chap2/8chap3_SM_GO_PROJ/#3-1","title":"3-1 \u4ee3\u7801\u89e3\u6790","text":"<p>\u9996\u5148\u770b\u4e00\u4e0b main.go \u7684\u5165\u53e3\u4ee3\u7801\uff0c\u8fd9\u90e8\u5206\u4ee3\u7801\u521b\u5efa\u4e86\u4e00\u4e2a gRPC Server\uff0c\u6765\u63d0\u4f9b xDS \u670d\u52a1\u3002</p> <p><code>go-control-plane</code> \u7c7b\u5e93\u4f7f\u7528 Snapshot \u7684\u65b9\u5f0f\u5b58\u50a8\u6570\u636e\uff0c\u6bd4\u5982 EDS \u4e2d\u7684 Endpoint \u6570\u636e\uff0c\u5982\u679c\u8fdb\u884c\u6570\u636e\u66f4\u65b0\uff0c\u53ea\u9700\u5237\u65b0 Snapshot \u6570\u636e\u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u8fd9\u91cc\u9996\u5148\u521b\u5efa\u4e86 SnapshotCache\uff0c\u7136\u540e\u7528 Mock \u7684\u6570\u636e\u751f\u6210\u4e86\u4e00\u4efd Snapshot\uff0c\u6700\u540e\u5c06 Snapshop \u5b58\u50a8\u5230 Cache \u4e2d\uff0c\u4e3a\u5bf9\u5e94\u7684 NodeID \u751f\u6210\u4e00\u4efd Cache \u6570\u636e\uff0c\u8fd9\u6837 xDS Server \u5728\u63d0\u4f9b\u670d\u52a1\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u5c06\u5bf9\u5e94\u7684\u6570\u636e\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u4e86\uff1a</p> <pre><code>    // \u521b\u5efa\u7f13\u5b58\n    cache := cachev3.NewSnapshotCache(false, cachev3.IDHash{}, l)\n    // \u521b\u5efa snapshot \u6570\u636e\uff0c\u7528\u4e8e\u7ed9\u6570\u636e\u9762\u63d0\u4f9b xds \u6570\u636e\n    snapshot := example.GenerateSnapshot()\n    if err := snapshot.Consistent(); err != nil {\n        l.Errorf(\"snapshot inconsistency: %+v\\n%+v\", snapshot, err)\n        os.Exit(1)\n    }\n    l.Debugf(\"will serve snapshot %+v\", snapshot)\n    // \u5c06 snapshot \u5199\u5165\u7f13\u5b58\n    if err := cache.SetSnapshot(nodeID, snapshot); err != nil {\n        l.Errorf(\"snapshot error %q for %+v\", err, snapshot)\n        os.Exit(1)\n    }\n    // \u8fd0\u884c xds \u670d\u52a1\u5668\n    ctx := context.Background()\n    cb := &amp;testv3.Callbacks{Debug: l.Debug}\n    srv := serverv3.NewServer(ctx, cache, cb)\n    example.RunServer(ctx, srv, port)\n</code></pre> <p>\u5148\u6765\u770b <code>example.GenerateSnapshot()</code>\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u6a21\u62df\u4e86\u4e00\u4e9b\u6d4b\u8bd5\u6570\u636e\u3002</p> <p>\u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\u521b\u5efa\u4e86 CDS\u3001EDS\u3001RDS\u3001LDS \u5bf9\u5e94\u7684\u6570\u636e\uff0c\u5176\u4e2d\u5305\u62ec\u96c6\u7fa4\u3001\u8282\u70b9\u3001\u8def\u7531\u3001\u76d1\u542c\u5668\u7b49\u6570\u636e\uff1a</p> <pre><code>func GenerateSnapshot() cache.Snapshot {\n        return cache.NewSnapshot(\n            \"1\",\n            []types.Resource{}, // endpoints\n            []types.Resource{makeCluster(ClusterName)},\n            []types.Resource{makeRoute(RouteName, ClusterName)},\n            []types.Resource{makeHTTPListener(ListenerName, RouteName)},\n            []types.Resource{}, // runtimes\n            []types.Resource{}, // secrets\n        )\n    }\n</code></pre> <p>\u6211\u4eec\u518d\u6765\u770b CDS \u548c EDS \u7684\u6570\u636e\u521b\u5efa\u3002</p> <p>\u6211\u4eec\u5148\u6765\u770b Cluster \u7684\u6570\u636e\u7c7b\u578b\u7684\u53c2\u6570\uff1a</p> <pre><code>func makeCluster(clusterName string) *cluster.Cluster {\n        return &amp;cluster.Cluster{\n            Name:                 clusterName,\n            ConnectTimeout:       ptypes.DurationProto(5 * time.Second),\n            ClusterDiscoveryType: &amp;cluster.Cluster_Type{Type: cluster.Cluster_LOGICAL_DNS},\n            LbPolicy:             cluster.Cluster_ROUND_ROBIN,\n            LoadAssignment:       makeEndpoint(clusterName),\n            DnsLookupFamily:      cluster.Cluster_V4_ONLY,\n        }\n    }\n\n    func makeEndpoint(clusterName string) *endpoint.ClusterLoadAssignment {\n        return &amp;endpoint.ClusterLoadAssignment{\n            ClusterName: clusterName,\n            Endpoints: []*endpoint.LocalityLbEndpoints{{\n                LbEndpoints: []*endpoint.LbEndpoint{{\n                    HostIdentifier: &amp;endpoint.LbEndpoint_Endpoint{\n                        Endpoint: &amp;endpoint.Endpoint{\n                            Address: &amp;core.Address{\n                                Address: &amp;core.Address_SocketAddress{\n                                    SocketAddress: &amp;core.SocketAddress{\n                                        Protocol: core.SocketAddress_TCP,\n                                        Address:  UpstreamHost,\n                                        PortSpecifier: &amp;core.SocketAddress_PortValue{\n                                            PortValue: UpstreamPort,\n                                        },\n                                    },\n                                },\n                            },\n                        },\n                    },\n                }},\n            }},\n        }\n    }\n</code></pre> <p>\u63a5\u4e0b\u6765\u770b\u4e00\u4e0b <code>example.RunServer(ctx, srv, port)</code>\u8fd9\u4e2a\u65b9\u6cd5\u3002\u8be5\u65b9\u6cd5\u9996\u5148\u521b\u5efa\u4e86\u4e00\u4e2a gRPC Server\uff0c\u5e76\u8bbe\u7f6e\u4e86<code>grpcMaxConcurrentStreams</code>\uff1a</p> <pre><code>// \u542f\u52a8 xds server\n    func RunServer(ctx context.Context, srv3 serverv3.Server, port uint) {\n        // \u8bbe\u7f6e grpcMaxConcurrentStreams \u53c2\u6570\uff0c\u7528\u4e8e\u589e\u52a0\u9ed8\u8ba4\u7684\u5355\u8fde\u63a5\u5e76\u53d1\u6570\u91cf\n        var grpcOptions []grpc.ServerOption\n        grpcOptions = append(grpcOptions, grpc.MaxConcurrentStreams(grpcMaxConcurrentStreams))\n        grpcServer := grpc.NewServer(grpcOptions...)\n\n        lis, err := net.Listen(\"tcp\", fmt.Sprintf(\":%d\", port))\n        if err != nil {\n            log.Fatal(err)\n        }\n\n        registerServer(grpcServer, srv3)\n\n        log.Printf(\"management server listening on %d\\n\", port)\n        if err = grpcServer.Serve(lis); err != nil {\n            log.Println(err)\n        }\n    }\n</code></pre> <p>\u63a5\u6765\u4e0b\u901a\u8fc7 registerServer \u65b9\u6cd5\uff0c\u5c06\u63d0\u4f9b xDS \u670d\u52a1\u7684 Service \u6ce8\u518c\u5230\u5df2\u7ecf\u521b\u5efa\u597d\u7684 <code>gRPC Server</code>\u4e0a\u9762\uff0c\u7528\u4e8e\u63d0\u4f9b\u5bf9\u5e94\u7684 xDS Server\u670d\u52a1\u3002\u4f60\u8981\u6ce8\u610f\uff0c\u8fd9\u91cc\u6709\u4e00\u4e2a <code>RegisterAggregatedDiscoveryServiceServer</code> \u7684 Server \u63d0\u4f9b\u805a\u5408\u67e5\u8be2\u670d\u52a1\uff0c\u901a\u8fc7\u8fd9\u4e2a Server \u53ef\u4ee5\u4e3a\u6240\u6709\u7684 xDS \u534f\u8bae\u63d0\u4f9b\u670d\u52a1\uff1a</p> <pre><code>func registerServer(grpcServer *grpc.Server, server serverv3.Server) {\n        // \u6ce8\u518c\u670d\u52a1\n        discoverygrpc.RegisterAggregatedDiscoveryServiceServer(grpcServer, server)\n        endpointservice.RegisterEndpointDiscoveryServiceServer(grpcServer, server)\n        clusterservice.RegisterClusterDiscoveryServiceServer(grpcServer, server)\n        routeservice.RegisterRouteDiscoveryServiceServer(grpcServer, server)\n        listenerservice.RegisterListenerDiscoveryServiceServer(grpcServer, server)\n        secretservice.RegisterSecretDiscoveryServiceServer(grpcServer, server)\n        runtimeservice.RegisterRuntimeDiscoveryServiceServer(grpcServer, server)\n    }\n</code></pre> <p>\u4e00\u4e2a\u7b80\u5355\u7684 xDS Server \u5c31\u8bb2\u5b8c\u4e86\u3002\u8fd9\u91cc\u7684 xDS Server \u586b\u5145\u4e86\u4e00\u4e9b\u6d4b\u8bd5\u6570\u636e\u6765\u6a21\u62df\u7ed3\u679c\uff0c\u5982\u679c\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\uff0c\u9700\u8981\u63a5\u5165\u76f8\u5e94\u7684\u5e73\u53f0\u624d\u80fd\u63d0\u4f9b\u6570\u636e\u3002</p> <p>\u6bd4\u5982\u5728 Istio \u4e2d\u901a\u8fc7 Kubernetes \u7684 API \u4e3a xDS Server \u63d0\u4f9b\u6570\u636e\uff1b\u901a\u8fc7\u5728 YAML \u4e2d\u58f0\u660e VirtualService \u7c7b\u578b\u6765\u4e3a RDS \u670d\u52a1\u63d0\u4f9b\u6570\u636e\u3002\u53c8\u6216\u8005\u4f7f\u7528\u4e86\u7b2c\u4e09\u65b9\u7684\u6ce8\u518c\u4e2d\u5fc3\uff0c\u6bd4\u5982 Consul\uff0c\u5219\u9700\u8981\u901a\u8fc7 Consul API \u4e3a EDS \u670d\u52a1\u63d0\u4f9b\u6570\u636e\u3002</p> <p>\u6211\u4eec\u901a\u8fc7\u4e00\u4e2a EDS Client\uff0c\u6765\u770b\u4e00\u4e0b\u5982\u4f55\u5728\u6570\u636e\u9762 Sidecar \u4e2d\u901a\u8fc7 xDS \u548c\u63a7\u5236\u9762\u534f\u8bae\u901a\u4fe1\u3002\u8fd9\u90e8\u5206\u4ee3\u7801\u8fd8\u662f\u5728https://github.com/beck917/easymesh\u4ee3\u7801\u4ed3\u5e93\u4e2d\u3002</p> <p>\u5148\u6765\u770b utils/eds \u6587\u4ef6\u5939\u4e0b\u7684\u4ee3\u7801\u3002</p> <p>\u9996\u5148\u901a\u8fc7 NewWithInterval \u521b\u5efa\u4e00\u4e2a EDS \u5bf9\u8c61\uff0c\u7136\u540e\u8fde\u63a5 EDS \u670d\u52a1\u5668\uff0c\u5e76\u4e14\u521b\u5efa\u4e00\u4e2a Goroutine\uff0c\u901a\u8fc7 Loop \u7684\u65b9\u6cd5\u5b9a\u65f6\u53d1\u9001\u8bf7\u6c42\u6570\u636e\u5230 EDS \u670d\u52a1\u5668\u3002\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u4e86\u63a8\u62c9\u7ed3\u5408\u7684\u65b9\u5f0f\u6765\u83b7\u53d6 EDS \u6570\u636e\uff1a</p> <pre><code>func NewWithInterval(addr string, interval time.Duration) (*adapter, error) {\n    if interval &lt;= 0 {\n        interval = time.Minute\n    }\n    urlobj, err := url.Parse(addr)\n    if err == nil &amp;&amp; len(urlobj.Host) &gt; 0 {\n        addr = urlobj.Host\n    }\n    eds := &amp;adapter{\n        addr: addr,\n        node: &amp;core.Node{\n            Id: generateNodeID(),\n        },\n        single:        new(singleflight.Group),\n        cache:         registry.NewServiceCache(nil, 0),\n        streams:       sync.Map{},\n        fetchInterval: interval,\n    }\n    err = eds.connect()\n    if err != nil {\n        return nil, errors.Wrap(err)\n    }\n    // \u5b9a\u65f6\u62c9\u53d6\u6570\u636e\n    go eds.loop()\n    return eds, nil\n}\n</code></pre> <p>\u540c\u65f6\u5728\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\uff0c\u6211\u4eec\u91c7\u7528 getService \u6765\u83b7\u53d6\u670d\u52a1\u8282\u70b9\u6570\u636e\u3002</p> <p>\u8fd9\u4e2a\u65b9\u6cd5\u9996\u5148\u4f1a\u8bfb\u53d6\u7f13\u5b58\u4e2d\u7684\u6570\u636e\uff0c\u5982\u679c\u7f13\u5b58\u4e2d\u6ca1\u6709\u6570\u636e\u5219\u4f1a\u901a\u8fc7\u521b\u5efa\u548c EDS \u670d\u52a1\u5668\u5efa\u7acb Watch \u673a\u5236\uff0c\u52a8\u6001\u66f4\u65b0 Cache \u4e2d\u7684\u6570\u636e\uff1a</p> <pre><code>func (eds *adapter) GetServices(name string, opts ...registry.DiscoveryOption) (services []*registry.Service, err error) {\n    if eds.ccErr != nil {\n        err = errors.Wrap(eds.ccErr)\n        return\n    }\n    options := registry.NewCommonDiscoveryOption(opts...)\n    key := registry.NewServiceKey(name, options.Tags, options.DC)\n    // \u7b2c\u4e00\u6b65\uff0c\u4ece\u7f13\u5b58\u8bfb\u53d6\n    services, err = eds.cache.GetServices(key)\n    if err == nil &amp;&amp; len(services) &gt; 0 {\n        return\n    }\n    // \u4ece eds \u670d\u52a1\u83b7\u53d6\n    return eds.fetchServices(key, options.Tags)\n}\n</code></pre> <p>startWatch \u65b9\u6cd5\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 Goroutine \u7528\u4e8e\u76d1\u542c EDS \u6570\u636e\u7684\u53d8\u5316\uff0c\u901a\u8fc7 parseStream \u963b\u585e\u83b7\u53d6 EDS Server \u7684\u63a8\u9001\u83b7\u53d6\u6570\u636e\uff0c\u83b7\u53d6\u6570\u636e\u540e\uff0c\u5c06\u6570\u636e\u5b58\u5165 Cache \u4e2d\uff1a</p> <pre><code>func (eds *adapter) startWatch(client discovery.AggregatedDiscoveryService_StreamAggregatedResourcesClient, key registry.ServiceKey, tags []string) {\n    logger.Infof(\"eds.Watch(%+v) ...\", key)\n    go func(streamClient discovery.AggregatedDiscoveryService_StreamAggregatedResourcesClient, serviceKey registry.ServiceKey) {\n        defer func() {\n            if panicErr := recover(); panicErr != nil {\n                logger.Errorf(\"eds.startWatch() panic: %+v\", panicErr)\n            } else {\n                //eds.streams.Delete(key)\n            }\n        }()\n        for {\n            services, err := eds.parseStream(eds.getStreamClient(key), tags)\n            if err != nil {\n                logger.Errorf(\"eds.Watch(%+v): %+v\", key, err)\n                time.Sleep(1 * time.Second)\n                continue\n            }\n            if len(services) &lt;= 0 {\n                logger.Warnf(\"eds.Watch(%+v): empty services, ignored!\", key)\n                continue\n            }\n            ipv4s := make([]string, len(services))\n            for i, svc := range services {\n                ipv4s[i] = svc.ServiceIP()\n            }\n            logger.Infof(\"eds.Watch(%+v): total=%d, services=%+v\", key, len(services), ipv4s)\n            eds.cache.Set(key, services)\n            if eds.watcher != nil {\n                eds.watcher.Handle(key, services)\n            }\n        }\n    }(client, key)\n}\n</code></pre> <p>\u5f53\u53d1\u9001\u6570\u636e\uff0c\u6216\u8005\u83b7\u53d6\u6570\u636e\u9519\u8bef\u7684\u65f6\u5019\uff0c\u9700\u8981\u91cd\u65b0\u8fde\u63a5 EDS \u670d\u52a1\u5668\uff0c\u5426\u5219\u4e00\u65e6\u7f51\u7edc\u5f02\u5e38\u6216\u8005 EDS \u670d\u52a1\u5668\u91cd\u542f\uff0c\u5bfc\u81f4 EDS \u8fde\u63a5\u65ad\u5f00\uff0c\u5c31\u65e0\u6cd5\u6b63\u786e\u5730\u66f4\u65b0\u6570\u636e\u4e86\u3002</p> <p>\u548c\u4f20\u7edf\u7684\u5728 Client SDK \u4e2d\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u5668\u6709\u6240\u4e0d\u540c\uff0cSDK \u4e2d\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u4e00\u822c\u662f\u521b\u5efa\u597d\u540e\u4f20\u5165 Client \u5bf9\u8c61\u3002</p> <p>Client \u5bf9\u8c61\u5728\u53d1\u51fa\u8bf7\u6c42\u524d\uff0c\u5148\u8c03\u7528\u8d1f\u8f7d\u5747\u8861\u5668\u7684 Next \u65b9\u6cd5\uff0c\u83b7\u53d6\u5230\u88ab\u8c03\u670d\u52a1\u7684 IP\uff0c\u7136\u540e\u8fdb\u884c\u670d\u52a1\u8bf7\u6c42\u3002\u6bd4\u5982\u4e0b\u9762\u7684\u4ee3\u7801\uff1a</p> <pre><code>var srv *registry.Service\nsrv, err = tp.rr.Next(ireq.Context(), host)\nif err != nil {\n    logger.Errorf(\"get host:%v err:%v\", host, err)\n    continue\n}\nireq.URL.Host = srv.Addr()\nresp, err = tp.rt.RoundTrip(ireq)\u3001\n</code></pre> <p>\u4f46\u5728 Sidecar \u4e2d\uff0c\u8d1f\u8f7d\u5747\u8861\u5668\u7ec4\u4ef6\u4e5f\u88ab\u62bd\u8c61\u6210\u4e86\u4e2d\u95f4\u4ef6\u7684\u65b9\u5f0f\uff0c\u5177\u4f53\u5728 Go-Micro \u4e2d\uff0c\u5c31\u662f\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Wrapper\u3002\u800c\u4e14\u8fd9\u4e9b\u4e2d\u95f4\u4ef6\u90fd\u88ab\u7edf\u4e00\u5199\u5728\u4e86 Server \u7684\u4e2d\u95f4\u4ef6\u4e2d\uff0c\u5e76\u4e0d\u9700\u8981\u5199\u5728 Client \u7684\u4e2d\u95f4\u4ef6\u4e2d\uff0c\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u7684\u62bd\u8c61\u7a0b\u5ea6\u66f4\u597d\uff0c\u6a21\u578b\u4e5f\u66f4\u52a0\u7edf\u4e00\uff0c\u5bf9\u4e8e\u7406\u89e3\u548c\u7f16\u5199\u3001\u7ef4\u62a4\u4ee3\u7801\u90fd\u6709\u5e2e\u52a9\u3002</p> <p>\u8def\u7531\u5668\u4e2d\u95f4\u4ef6\u7684\u4f5c\u7528\u662f\u6839\u636e\u6211\u4eec\u7684\u8bf7\u6c42\u53c2\u6570\uff0c\u6bd4\u5982 header\u3001path \u7b49\uff0c\u627e\u5230\u5bf9\u5e94\u7684\u670d\u52a1\u3002\u53ea\u6709\u901a\u8fc7\u8def\u7531\u5668\u4e2d\u95f4\u4ef6\u627e\u5230\u4e86\u5bf9\u5e94\u7684\u670d\u52a1\u540d\uff0c\u6211\u4eec\u624d\u80fd\u8ba9\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u95f4\u4ef6\u901a\u8fc7\u670d\u52a1\u540d\u627e\u5230\u5bf9\u5e94\u7684 Endpoint\u3002</p> <p>\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u901a\u8fc7 match \u65b9\u6cd5\u83b7\u53d6\u5230\u4e86\u5bf9\u5e94\u7684 router \u5bf9\u8c61\u548c router \u5bf9\u8c61\u5185\u5305\u542b\u7684 handlers\uff0c\u8fd9\u4e2a handler \u5b9e\u9645\u4e0a\u662f\u7ed1\u5b9a\u5728 router \u4e0a\u7684\u53e6\u5916\u4e00\u5957\u4e2d\u95f4\u4ef6\u4f53\u7cfb\uff0c\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u8ba9\u4e2d\u95f4\u4ef6\u66f4\u5bb9\u6613\u83b7\u53d6 router \u7684\u4e00\u4e9b\u4fe1\u606f\uff0c\u5426\u5219\u8fd8\u9700\u8981\u901a\u8fc7 routername \u67e5\u8be2\u624d\u80fd\u83b7\u53d6\u5230\u76f8\u5173\u4fe1\u606f\u3002</p> <pre><code>// HandlerWrapper \u670d\u52a1\u7aef\u4e2d\u95f4\u4ef6\nfunc (wrap *Wrappers) HandlerWrapper() server.HandlerWrapper {\n    return func(next server.HandlerFunc) server.HandlerFunc {\n        return func(ctx context.Context, req server.Request, rsp interface{}) error {\n            route, handlers := wrap.match(req.Service(), req.Method())\n            if route == nil {\n                return errors.NotFound(\"mesh.wrap.router\", \"route mismatch\")\n            }\n            ctx = context.WithValue(ctx, defs.CtxRouter{}, route)\n            handler := func(ctx context.Context, req server.Request, rsp interface{}) error {\n                return next(ctx, req, rsp)\n            }\n            // \u5d4c\u5957\u81ea\u5b9a\u4e49 wraps\n            for i := len(handlers); i &gt; 0; i-- {\n                handler = handlers[i-1](handler)\n            }\n            return handler(ctx, req, rsp)\n        }\n    }\n}\n</code></pre> <p>\u6bcf\u4e2a\u4e2d\u95f4\u4ef6\uff0c\u90fd\u6709\u4e00\u4e2a Reload \u7684\u65b9\u6cd5\uff0c\u8fd9\u4e2a Reload \u65b9\u6cd5\u7528\u6765\u66f4\u65b0 xDS \u83b7\u53d6\u7684\u914d\u7f6e\u5230\u5177\u4f53\u7684\u4e2d\u95f4\u4ef6\u5bf9\u8c61\u4e2d\u3002</p> <p>\u6bd4\u5982 router \u4e2d\u95f4\u4ef6\u7684 Reload \u65b9\u6cd5\uff0c\u5c31\u5c06\u6240\u6709\u7684\u8def\u7531\u4fe1\u606f\u89e3\u6790\u51fa\u6765\uff0c\u5b58\u50a8\u5728 ServiceRoutes \u5bf9\u8c61\u4e2d\uff0c\u7528\u4e8e match \u65b9\u6cd5\u7684\u5339\u914d\uff0c\u8fd9\u6837\u624d\u80fd\u627e\u5230\u8bf7\u6c42\u5177\u4f53\u5bf9\u5e94\u7684\u670d\u52a1\u540d\u3002</p> <p>\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u4e2d\u95f4\u4ef6\uff0c\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u4e5f\u7ed1\u5b9a\u5728\u8def\u7531\u5bf9\u8c61\u4e2d\uff0c\u5f53\u5339\u914d\u5230\u5bf9\u5e94\u7684\u8def\u7531\u540e\uff0c\u4f1a\u81ea\u52a8\u901a\u8fc7 Next \u65b9\u6cd5\u8c03\u7528\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u3002</p> <pre><code>// \u6ce8\u5165\u4e2d\u95f4\u4ef6\nrouteHandlers := handlers\nlbWrap, err := loadbalance.HandlerWrapper(srv, config, dis)\nif err != nil {\n    return fmt.Errorf(\"service key:%s empty route:%+v build lb wrap err:%v\", srvKey, route, err)\n}\n</code></pre> <p>\u8d1f\u8f7d\u5747\u8861\u5668\u4f1a\u901a\u8fc7 nextNode \u7684\u65b9\u6cd5\u83b7\u53d6\u8bf7\u6c42\u7684\u8282\u70b9\uff0cnextNode \u65b9\u6cd5\u76f4\u63a5\u4ece LB \u5bf9\u8c61\u4e2d\u83b7\u53d6\u76f8\u5e94\u7684 Endpoint \u6570\u636e\u3002</p> <p>\u8fd9\u91cc\u548c EDS \u7684\u7c7b\u5e93\u6709\u4e00\u4e2a\u4ea4\u4e92\uff0cEDS \u7c7b\u5e93\u5728\u83b7\u53d6\u5230\u65b0\u7684\u6570\u636e\u65f6\u4f1a\u4e3b\u52a8\u66f4\u65b0 LB \u5bf9\u8c61\u4e2d\u7684\u6570\u636e\uff0c\u4ee5\u786e\u4fdd LB \u4e2d\u7684 Next \u65b9\u6cd5\u53ef\u4ee5\u4e00\u76f4\u83b7\u53d6\u5230\u6700\u65b0\u7684\u8282\u70b9\u6570\u636e\u3002</p> <pre><code>// HandlerWrapper \u8d1f\u8f7d\u5747\u8861\u548c\u670d\u52a1\u53d1\u73b0\nfunc HandlerWrapper(cluster *qdx.Cluster, config *types.Config, dis qudiscovery.Discovery) (server.HandlerWrapper, error) {\n    nextNode, err := newNext(cluster, config.Upstreams, dis)\n    if err != nil {\n        return nil, err\n    }\n    return func(next server.HandlerFunc) server.HandlerFunc {\n        return func(ctx context.Context, req server.Request, rsp interface{}) error {\n            node, err := nextNode()\n            if err != nil {\n                return errors.BadRequest(\"mesh.wrap.lb\", \"lb.next err:%v\", err)\n            }\n            ctx = context.WithValue(ctx, defs.CtxAddress{}, node.Address)\n            return next(ctx, req, rsp)\n        }\n    }, nil\n}\n</code></pre>"},{"location":"chap2/9chap3_pratice/","title":"\u7b2c\u4e5d\u8282 Service Mesh \u843d\u5730\u548c\u5c55\u671b","text":""},{"location":"chap2/9chap3_pratice/#1","title":"1\u3001\u5728\u5b9e\u8df5\u843d\u5730\u4e2d\u53ef\u80fd\u9047\u5230\u7684\u95ee\u9898\u548c\u56f0\u96be","text":""},{"location":"chap2/9chap3_pratice/#1-1","title":"1-1 \u5fae\u670d\u52a1\u6846\u67b6\u529f\u80fd\u53ca\u4f9d\u8d56\u7684\u5916\u90e8\u57fa\u7840\u8bbe\u65bd","text":"<p>\u5fae\u670d\u52a1\u6846\u67b6\u529f\u80fd\u53ca\u4f9d\u8d56\u7684\u5916\u90e8\u57fa\u7840\u8bbe\u65bd</p> <ul> <li>\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\uff1a\u5fae\u670d\u52a1\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u8d1f\u8d23\u670d\u52a1\u7684\u6ce8\u518c\uff0c\u4ee5\u53ca upstream \u670d\u52a1\u7684 Endpoint \u7684\u53d1\u73b0\u3002</li> <li>\u8def\u7531\uff1a\u8d1f\u8d23\u6d41\u91cf\u8f6c\u53d1\u7684\u914d\u7f6e\u3002</li> <li>\u8d1f\u8f7d\u5747\u8861\uff1a\u5177\u5907\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u9488\u5bf9 upstream Endpoint \u8fdb\u884c\u6d41\u91cf\u5206\u53d1\u3002</li> <li>\u670d\u52a1\u6cbb\u7406\uff1a\u901a\u5e38\u6307\u7684\u662f\u9650\u6d41\u3001\u7194\u65ad\u3001\u964d\u7ea7\u7b49\u53ef\u4ee5\u63d0\u9ad8\u5fae\u670d\u52a1\u67b6\u6784\u7a33\u5b9a\u6027\u7684\u63aa\u65bd\u3002</li> <li>\u53ef\u89c2\u6d4b\u6027\uff1aMetrics\u3001\u65e5\u5fd7\u3001\u94fe\u8def\u8ffd\u8e2a\u7b49\u7ec4\u4ef6\u3002</li> <li>\u811a\u624b\u67b6\uff1a\u5fae\u670d\u52a1\u6846\u67b6\u4e3a\u4e86\u8ba9\u4e1a\u52a1\u5feb\u901f\u4e0a\u624b\uff0c\u901a\u5e38\u9700\u8981\u4e00\u4e2a\u811a\u624b\u67b6\uff0c\u8ba9\u4e1a\u52a1\u65b9\u5feb\u901f\u751f\u6210\u9879\u76ee\u4ee3\u7801\u3002</li> <li>RPC\uff1a\u8fd9\u91cc\u6307\u7684\u662f\u5e7f\u4e49\u7684 RPC\uff0c\u53ef\u4ee5\u662f gRPC \u6216\u8005 Dubbo \u7b49 RPC \u534f\u8bae\uff0c\u4e5f\u53ef\u4ee5\u662f HTTP \u534f\u8bae\u3002</li> </ul> <p> </p> <p>\u5f53\u7136\uff0c\u6574\u4e2a\u5fae\u670d\u52a1\u7684\u751f\u6001\u5728\u4e0d\u65ad\u6f14\u8fdb\uff0c\u7ed3\u5408\u516c\u53f8\u7684\u9700\u6c42\uff0c\u9002\u5f53\u589e\u52a0\u4e00\u4e9b\u65b0\u7684\u529f\u80fd\u4e5f\u662f\u6709\u5fc5\u8981\u7684\uff0c\u6bd4\u5982\u67d3\u8272\u3001\u901a\u7528 header \u4f20\u9012\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\u3002</p> <p>\u5fae\u670d\u52a1\u6846\u67b6\u843d\u5730\u4f9d\u8d56\u4e8e\u5916\u90e8\u54ea\u4e9b\u57fa\u7840\u8bbe\u65bd\u3002</p> <ul> <li>\u8fb9\u7f18\u7f51\u5173\u5c42\uff1a\u7edf\u4e00\u7684\u5165\u53e3\u7f51\u5173\u5c42\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u7684\u5165\u53e3\u5c42\uff0c\u8d1f\u8d23\u5357\u5317\u6d41\u91cf\u7684\u6cbb\u7406\u3002</li> <li>\u76d1\u63a7\u544a\u8b66\uff1a\u6536\u96c6\u4e1a\u52a1\u7684 Metrics\u3001Trace\u3001Log \u7b49\u4fe1\u606f\uff0c\u5e76\u914d\u7f6e\u76d1\u63a7\u544a\u8b66\u3002</li> <li>\u914d\u7f6e\u4e2d\u5fc3\uff1a\u8d1f\u8d23\u5fae\u670d\u52a1\u7684\u7cfb\u7edf\u914d\u7f6e\u7684\u7ba1\u7406\uff0c\u6bd4\u5982 MySQL\u3001Redis\uff0c\u4ee5\u53ca\u4e0a\u4e0b\u6e38\u670d\u52a1\u7684\u8c03\u7528\u914d\u7f6e\u7b49\u3002</li> <li>CI/CD\uff1a\u5305\u542b CI \u6301\u7eed\u96c6\u6210\uff08Continuous Integration\uff09\u548c CD \u6301\u7eed\u90e8\u7f72\uff08Continuous Deployment\uff09\u3002\u6301\u7eed\u96c6\u6210\u4e3b\u8981\u662f\u6307\u4ee3\u7801\u90e8\u7f72\u524d\u7684\u81ea\u52a8\u5316\u6d4b\u8bd5\u548c\u81ea\u52a8\u5316\u7f16\u8bd1\u6253\u5305\u7684\u8fc7\u7a0b\uff0c\u6301\u7eed\u90e8\u7f72\u662f\u6307\u7f16\u8bd1\u6253\u5305\u540e\u7684\u4ee3\u7801\u90e8\u7f72\u53d1\u5e03\u7684\u8fc7\u7a0b\u3002\u4ee3\u7801\u53d1\u5e03\u548c\u90e8\u7f72\u5206\u5f00\uff0c\u6709\u5229\u4e8e\u7248\u672c\u63a7\u5236\u548c\u56de\u6eda\uff0c\u65b9\u4fbf\u7ebf\u4e0a\u968f\u65f6\u6062\u590d\u5230\u4efb\u610f\u7248\u672c\u3002\u5f00\u6e90\u65b9\u6848\u4e3b\u8981\u6709 GitLab \u548c Jenkins\u3002</li> <li>PAAS \u5e73\u53f0\uff1a\u8fd9\u91cc\u4e3b\u8981\u662f\u6307\u8fd0\u7ef4\u7ba1\u7406\u5e73\u53f0\uff0c\u4e3b\u8981\u5305\u542b\u673a\u5668\u7684\u8d44\u6e90\u7ba1\u7406\u7684 CMDB\u3001\u5fae\u670d\u52a1\u6d41\u7a0b\u7ba1\u7406\u3001\u670d\u52a1\u6cbb\u7406\u5e73\u53f0\u7b49\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5728\u8fd9\u4e2a\u5e73\u53f0\u4e2d\uff0c\u6211\u4eec\u7533\u8bf7\u673a\u5668\u8d44\u6e90\u3001\u5404\u7c7b\u4e2d\u95f4\u4ef6\u8d44\u6e90\u3001\u6570\u636e\u5e93\u8d44\u6e90\u3001\u7f13\u5b58\u5c42\u8d44\u6e90\uff0c\u4ee5\u53ca\u5404\u79cd\u673a\u5668\u7684\u6743\u9650\u7b49\uff1b\u53e6\u5916\u5305\u62ec\u6574\u4e2a\u5fae\u670d\u52a1\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u3001\u670d\u52a1\u6cbb\u7406\u7684\u9650\u6d41\u7194\u65ad\u7b49\u914d\u7f6e\uff0c\u90fd\u53ef\u4ee5\u5728\u8fd9\u4e2a\u4e00\u7ad9\u5f0f\u7684\u670d\u52a1\u5e73\u53f0\u89e3\u51b3\u3002PAAS \u5e73\u53f0\u5728\u5fae\u670d\u52a1\u67b6\u6784\u7684\u843d\u5730\u4e2d\u81f3\u5173\u91cd\u8981\uff0c\u5bf9\u4e8e\u63d0\u9ad8\u4ea7\u7814\u6548\u7387\u8d77\u7740\u5173\u952e\u4f5c\u7528\u3002</li> </ul>"},{"location":"chap2/9chap3_pratice/#1-3","title":"1-3  \u5fae\u670d\u52a1\u6846\u67b6\u843d\u5730\u4e2d\u7684\u95ee\u9898","text":"<ul> <li>\u63a8\u5e7f\u56f0\u96be\uff1a \u5728\u6846\u67b6\u7684\u843d\u5730\u4e2d\uff0c\u4e9f\u987b\u89e3\u51b3\u7684\u662f\u6846\u67b6\u8986\u76d6\u5ea6\u7684\u95ee\u9898\uff0c\u4f46\u5404\u4e2a\u4e1a\u52a1\u65b9\u5f80\u5f80\u90fd\u6709\u81ea\u5df1\u7684\u6846\u67b6\u9009\u578b</li> <li>\u8fed\u4ee3\u5347\u7ea7\u56f0\u96be</li> <li>\u6392\u67e5\u95ee\u9898\uff1a \u6846\u67b6\u4ee3\u7801\u548c\u4e1a\u52a1\u4ee3\u7801\u6df7\u6dc6\u5728\u4e00\u8d77\uff0c\u65e5\u5fd7\u76d1\u63a7\u7b49\u6392\u67e5\u4fe1\u606f\u4e5f\u6df7\u5408\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\uff0c\u53d1\u751f\u95ee\u9898\u65f6\u5c31\u9700\u8981\u6846\u67b6\u65b9\u548c\u4e1a\u52a1\u65b9\u8054\u5408\u6392\u67e5\uff0c\u800c\u6846\u67b6\u63d0\u4f9b\u65b9\u9700\u8981\u5728\u65e5\u5fd7\u4e2d\u627e\u51fa\u548c\u6846\u67b6\u6709\u5173\u4fe1\u606f\uff0c\u65e0\u7591\u589e\u5927\u4e86\u6392\u67e5\u95ee\u9898\u7684\u96be\u5ea6\u3002</li> <li>\u591a\u8bed\u8a00</li> </ul>"},{"location":"chap2/9chap3_pratice/#1-4-service-mesh","title":"1-4 Service Mesh \u67b6\u6784\u5982\u4f55\u843d\u5730","text":"<p>\u6839\u636e\u516c\u53f8\u7684\u8fd0\u7ef4\u73af\u5883\u4e0d\u540c\uff0cService Mesh \u843d\u5730\u8def\u5f84\uff0c\u5927\u81f4\u5206\u4e3a\u4ee5\u4e0b\u51e0\u79cd\u3002</p> <p>\u865a\u62df\u673a\u73af\u5883\uff1a\u4e5f\u5c31\u662f\u4f20\u7edf\u7684 VM \u73af\u5883\uff0c\u8fd9\u79cd\u73af\u5883\u9700\u8981\u63a7\u5236\u9762\u548c\u516c\u53f8\u7684\u8fd0\u7ef4\u5e73\u53f0\u6216\u8005 CMDB \u6253\u901a\uff0c\u9700\u8981\u505a\u7684\u4e8b\u60c5\u8f83\u591a\uff0c\u56e0\u4e3a\u548c CMDB \u8026\u5408\u6bd4\u8f83\u4e25\u91cd\uff0c\u6240\u4ee5\u7ef4\u62a4\u6210\u672c\u8f83\u9ad8\u3002</p> <p>Kubernetes \u73af\u5883\uff1a\u7eaf Kubernetes \u73af\u5883\u76f8\u5bf9\u6bd4\u8f83\u5bb9\u6613\uff0c\u56e0\u4e3a\u4e0d\u518d\u9700\u8981\u7ef4\u62a4\u673a\u5668\u8d44\u6e90\uff0c\u53ea\u5728 Kubernetes \u7684 Pod \u4e2d\u6ce8\u5165\u76f8\u5e94\u7684\u73af\u5883\u53d8\u91cf\uff0c\u6bd4\u5982\u670d\u52a1\u540d\u3001\u8282\u70b9\u540d\u79f0\u3001\u73af\u5883\u7b49\u4fe1\u606f\u5373\u53ef\u3002</p> <p>Kubernetes +\u865a\u62df\u673a\u6df7\u5408\u73af\u5883\uff1a\u5982\u679c\u516c\u53f8\u9762\u4e34\u865a\u62df\u673a\u73af\u5883\u5411 Kubernetes \u73af\u5883\u7684\u8fc1\u79fb\uff0c\u8fd9\u79cd\u6df7\u5408\u73af\u5883\u662f\u4e0d\u53ef\u907f\u514d\u7684\uff0c\u4f46\u662f\u6b64\u65f6\u6d89\u53ca\u7684\u95ee\u9898\u5c31\u6bd4\u8f83\u591a\uff0c\u4e0a\u9762\u63d0\u5230\u7684\u4e24\u79cd\u73af\u5883\u90fd\u8981\u652f\u6301\uff0c\u800c\u4e14\u670d\u52a1\u7684\u5207\u6d41\uff08\u6307\u7684\u662f\u6d41\u91cf\u4ece\u865a\u62df\u673a\u5207\u6362\u5230 Kubernetes \u4e0a\uff09\u4e5f\u9700\u8981\u5728\u63a7\u5236\u9762\u652f\u6301\u3002</p> <p> </p>"},{"location":"chap2/9chap3_pratice/#1-5-service-mesh","title":"1-5 Service Mesh \u67b6\u6784\u843d\u5730\u4e2d\u7684\u4f18\u52bf","text":"<ul> <li>\u8fed\u4ee3\u5347\u7ea7\uff1a\u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u8fed\u4ee3\u5347\u7ea7\u65e0\u987b\u4e1a\u52a1\u65b9\u611f\u77e5\uff0c\u53ef\u4ee5\u72ec\u7acb\u6f14\u8fdb\u3002</li> <li>\u591a\u8bed\u8a00\uff1a\u65e0\u987b\u5173\u6ce8\u516c\u53f8\u4e3b\u529b\u8bed\u8a00\uff0c\u5bf9\u4e8e\u975e\u4e3b\u529b\u8bed\u8a00\uff0c\u4e5f\u4f5c\u4e3a\u201c\u4e00\u7b49\u516c\u6c11\u201d\u540c\u7b49\u5bf9\u5f85\u3002</li> <li>\u7075\u6d3b\u90e8\u7f72\uff1a\u4e3a\u4e86\u5feb\u901f\u843d\u5730\uff0cService Mesh \u67b6\u6784\u5e76\u4e0d\u4e00\u5b9a\u975e\u5f97\u5168\u90e8\u63a5\u7ba1\u5165\u6d41\u91cf\u548c\u51fa\u6d41\u91cf\u3002\u5728\u65e9\u671f\uff0c\u53ea\u63a5\u7ba1\u5165\u6d41\u91cf\uff08\u4e5f\u5c31\u662f\u670d\u52a1\u7aef\u6d41\u91cf\uff09\uff0c\u4f1a\u66f4\u5bb9\u6613\u4e00\u4e9b\uff0c\u56e0\u4e3a\u63a5\u7ba1\u51fa\u6d41\u91cf\u5f80\u5f80\u9700\u8981\u6539\u52a8\u5ba2\u6237\u7aef\u4ee3\u7801\uff0c\u800c\u63a5\u7ba1\u5165\u6d41\u91cf\u53ea\u9700\u4fee\u6539 LB \u4ee3\u7406\u7684\u7aef\u53e3\uff0c\u6216\u8005\u7531 Sidecar \u4ee3\u7406\u6ce8\u518c\u5373\u53ef\u3002</li> </ul>"},{"location":"chap2/9chap3_pratice/#1-6-service-mesh","title":"1-6 Service Mesh \u67b6\u6784\u843d\u5730\u4e2d\u7684\u56f0\u96be","text":"<p>\u6392\u67e5\u95ee\u9898</p> <p>\u4e00\u6b21\u670d\u52a1\u8c03\u7528\uff0c\u5728\u94fe\u8def\u4e0a\u4f1a\u589e\u52a0\u4e24\u6b21\u8c03\u7528\uff0c\u8fd9\u786e\u5b9e\u7ed9\u6392\u67e5\u95ee\u9898\u5e26\u6765\u4e86\u4e0d\u4fbf\u3002\u672c\u6765\u53ea\u9700\u6392\u67e5\u670d\u52a1\u81ea\u8eab\u7684\u95ee\u9898\uff0c\u73b0\u5728\u5374\u8981\u7ecf\u5e38\u8003\u8651\u662f\u4e0d\u662f Sidecar \u51fa\u73b0\u4e86\u95ee\u9898\u3002\u89e3\u51b3\u6392\u67e5\u56f0\u96be\u7684\u95ee\u9898\uff0c\u53ea\u80fd\u4ece\u53ef\u89c2\u6d4b\u6027\u5165\u624b\uff0c\u6bd4\u5982\u589e\u52a0\u4e30\u5bcc\u7684 Metrics \u6307\u6807\u3001\u6253\u5370\u5173\u952e\u65e5\u5fd7\u3001\u8bb0\u5f55 Trace \u94fe\u8def\u3002</p> <p>\u6027\u80fd</p> <p>\u4e0a\u9762\u4e5f\u63d0\u5230\u4e86\uff0c\u6bcf\u6b21\u8c03\u7528\u4f1a\u591a\u51fa\u4e24\u6b21\u8bf7\u6c42\uff0c\u8fd9\u5c31\u5bfc\u81f4\u589e\u52a0\u5ef6\u65f6\u548c\u670d\u52a1\u5668\u8d44\u6e90\u6d88\u8017\u7684\u95ee\u9898\u65e0\u6cd5\u907f\u514d\u3002\u5728\u843d\u5730\u8fc7\u7a0b\u4e2d\uff0c\u6027\u80fd\u8fd9\u4e2a\u70b9\u662f\u88ab\u4e1a\u52a1\u65b9\u6311\u6218\u6700\u591a\u7684\uff0c\u6bd5\u7adf\u8fd9\u662f\u5b9e\u6253\u5b9e\u53ef\u4ee5\u770b\u5230\u7684\u635f\u8017\u3002\u8fd9\u5c31\u9700\u8981\u6211\u4eec\u5c3d\u53ef\u80fd\u63d0\u5347 Sidecar \u7684\u4ee3\u7406\u6027\u80fd\u3001\u5ef6\u65f6\u548c CPU \u6d88\u8017\u3002</p> <p>\u6bd4\u5982\u5ef6\u65f6\uff0cHTTP \u7684\u5355\u6b21\u4ee3\u7406\u5ef6\u65f6\u6d88\u8017\u5927\u6982\u589e\u52a0 0.3ms\uff0c\u800c\u79c1\u6709\u7684 RPC \u534f\u8bae\u53ef\u4ee5\u505a\u5230\u5c0f\u4e8e 0.1ms\u3002\u8fd9\u6837\u7684\u5ef6\u65f6\uff0c\u5927\u90e8\u5206\u7684\u4e1a\u52a1\u573a\u666f\u90fd\u53ef\u4ee5\u63a5\u53d7\u3002</p> <p>\u4fe1\u4efb\u95ee\u9898</p> <p>Sidecar \u5bfc\u81f4\u4e86\u670d\u52a1\u4e0d\u7a33\u5b9a</p> <p>\u670d\u52a1\u4f7f\u7528 Sidecar \u53ef\u80fd\u4f1a\u6709\u4e00\u4e9b\u5f02\u5e38\u7684\u6296\u52a8\u3002</p> <p>\u8fd9\u4e9b\u95ee\u9898\u53ef\u80fd\u662f\u4e0a Sidecar \u5bfc\u81f4\u7684\uff0c\u4e5f\u53ef\u80fd\u662f\u56e0\u4e3a\u670d\u52a1\u672c\u8eab\u7684\u529f\u80fd\u8fed\u4ee3\uff0c\u4f46\u662f\u8fd9\u79cd\u4e0d\u7a33\u5b9a\u9700\u8981\u6839\u636e\u5177\u4f53\u95ee\u9898\u6392\u67e5\u3002</p> <p>\u6bd4\u5982\u5728\u843d\u5730\u4e2d\uff0c\u6211\u5c31\u9047\u5230\u8fc7\u56e0\u4e3a Http Client \u53c2\u6570\u914d\u7f6e\u4e0d\u5408\u7406\u5bfc\u81f4\u4e0a Sidecar \u4e4b\u540e\u51fa\u73b0\u670d\u52a1\u6296\u52a8\uff1b</p> <p>\u4e5f\u9047\u5230\u8fc7\u670d\u52a1\u81ea\u8eab\u7684\u4e1a\u52a1\u8fed\u4ee3\u6216\u8005\u673a\u5668\u8d44\u6e90\u4e0d\u8db3\u5bfc\u81f4\u7684\u95ee\u9898\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u4e00\u5b9a\u8981\u8fde\u540c\u4e1a\u52a1\u65b9\u4e00\u8d77\u6392\u67e5\u95ee\u9898\uff0c\u627e\u51fa\u6839\u56e0\u3002</p> <p>\u670d\u52a1\u8c03\u8bd5\u4e0d\u65b9\u4fbf</p> <p>Sidecar \u589e\u52a0\u4e86\u5ef6\u65f6</p> <ul> <li>\u4ed6\u4eec\u901a\u8fc7 Trace \u65e5\u5fd7\u4e2d\u7684\u8868\u8c61\uff0c\u548c\u6211\u4eec\u53cd\u6620 Sidecar \u5927\u5927\u589e\u52a0\u4e86\u5ef6\u65f6\u3002</li> <li>\u8fd9\u79cd\u60c5\u51b5\u5f80\u5f80\u51fa\u73b0\u5728\u670d\u52a1\u5f02\u5e38\u7684\u65f6\u5019\uff0c\u4ece Trace \u94fe\u8def\u770b\uff0cSidecar \u7684\u73af\u8282\u786e\u5b9e\u76f8\u5bf9\u670d\u52a1\u5ef6\u65f6\u8f83\u9ad8\u3002</li> <li>\u4f46\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u90fd\u662f\u673a\u5668\u8d44\u6e90\u95ee\u9898\u5bfc\u81f4\uff0c\u56e0\u4e3a\u670d\u52a1\u7684 Trace \u94fe\u8def\u5b9e\u9645\u4e0a\u662f\u65e0\u6cd5\u8ddf\u8e2a\u7f51\u7edc\u548c\u7cfb\u7edf\u5c42\u9762\u7684\u6d88\u8017\u7684\uff0c\u6b64\u65f6\u8fd9\u90e8\u5206\u6d88\u8017\u4f1a\u88ab\u8bb0\u5f55\u5728 Sidecar \u7684 Trace \u94fe\u8def\u4e2d\u3002</li> </ul>"},{"location":"chap2/9chap3_pratice/#2-sdk-service-mesh","title":"2\u3001\u4e3a\u4ec0\u4e48\u8981\u4ece SDK \u6f14\u8fdb\u5230 Service Mesh\uff1f","text":""},{"location":"chap2/9chap3_pratice/#2-1","title":"2-1 \u7ebf\u4e0a\u6545\u969c\u68b3\u7406","text":"<p>2-1-1 \u670d\u52a1\u53d8\u66f4\u6545\u969c</p> <p>\u7ebf\u4e0a\u6545\u969c\u4e2d\uff0c\u51fa\u73b0\u6982\u7387\u6700\u5927\u7684\u5c31\u662f\u670d\u52a1\u53d8\u66f4\u6545\u969c\uff0c\u4e00\u822c\u6307\u7684\u662f\u4e1a\u52a1\u8fed\u4ee3\u8fdb\u884c\u7248\u672c\u66f4\u65b0\uff0c\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u9047\u5230\u7684\u6545\u969c\uff0c\u4e5f\u5305\u62ec\u9879\u76ee\u914d\u7f6e\u53d8\u66f4\uff0c\u6570\u636e\u53d8\u66f4\u7b49\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u8fd9\u79cd\u95ee\u9898\u53ea\u8981\u53ca\u65f6\u56de\u6eda\u5c31\u53ef\u4ee5\u89e3\u51b3\uff0c\u6240\u4ee5\u6700\u5927\u7684\u96be\u70b9\u5728\u4e8e\u5982\u4f55\u7528\u6700\u5feb\u7684\u901f\u5ea6\u53d1\u73b0\u6545\u969c\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u901a\u8fc7 Metrics \u8fdb\u884c\u6545\u969c\u62a5\u8b66\uff0c\u5728 Service Mesh \u67b6\u6784\u4e2d\uff0c\u53ef\u4ee5\u4e0d\u4f9d\u8d56\u4e8e\u6846\u67b6\u6216\u8005\u4e1a\u52a1\u6ce8\u5165 Metrics\uff0c\u901a\u8fc7\u6536\u96c6 Sidecar \u4e2d\u7684 Metrics \uff0c\u8fbe\u5230\u76d1\u63a7\u62a5\u8b66\u7684\u76ee\u7684\u3002</p> <p>2-1-2 \u7a81\u53d1\u6d41\u91cf\u5bfc\u81f4\u7684\u6545\u969c</p> <p>\u9664\u53bb\u670d\u52a1\u53d8\u66f4\u6545\u969c\uff0c\u7a81\u53d1\u6d41\u91cf\u662f\u53e6\u5916\u4e00\u4e2a\u9ad8\u9891\u53d1\u751f\u7684\u6545\u969c\u7c7b\u578b\u3002\u6bd4\u5982\u7a81\u53d1\u70ed\u70b9\uff0c\u6216\u8005\u8fd0\u8425\u6d3b\u52a8\uff0c\u90fd\u53ef\u80fd\u5bfc\u81f4\u8fd9\u79cd\u6545\u969c\u3002</p> <p>2-1-3 \u4f9d\u8d56\u6545\u969c</p> <p>\u4f9d\u8d56\u6545\u969c\uff0c\u4e3b\u8981\u6307\u7684\u662f upstream \u4e0a\u6e38\u670d\u52a1\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u5bfc\u81f4\u7684\u7ea7\u8054\u6545\u969c\uff0c\u5982\u679c\u6ca1\u6709\u76f8\u5e94\u7684\u670d\u52a1\u6cbb\u7406\u624b\u6bb5\uff0c\u5c06\u4f1a\u5bfc\u81f4\u6574\u6761\u5fae\u670d\u52a1\u94fe\u8def\u88ab\u62d6\u6162\uff0c\u6700\u7ec8\u5bfc\u81f4\u96c6\u7fa4\u96ea\u5d29\u3002</p> <p>\u5e94\u5bf9\u8fd9\u79cd\u95ee\u9898\u7684\u529e\u6cd5\uff0c\u5c31\u662f\u901a\u8fc7 Service Mesh \u670d\u52a1\u6cbb\u7406\u7684\u624b\u6bb5\u4e4b\u4e00\u2014\u2014\u7194\u65ad\uff0c\u5728\u4e0a\u6e38\u670d\u52a1\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u7194\u65ad\uff0c\u5bf9\u4e0a\u6e38\u670d\u52a1\u7684\u8bf7\u6c42\u76f4\u63a5\u8fd4\u56de\u9519\u8bef\uff0c\u8fd9\u6837\u5c31\u51cf\u5c11\u4e86\u670d\u52a1\u94fe\u8def\u7684\u8017\u65f6\uff0c\u4ece\u800c\u907f\u514d\u5fae\u670d\u52a1\u96c6\u7fa4\u96ea\u5d29\u3002</p> <p>\u53e6\u5916\u7194\u65ad\u4e5f\u53ef\u4ee5\u914d\u5408\u964d\u7ea7\u4f7f\u7528\uff0c\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0c\u6bd4\u5982 Feed \u6d41\uff0c\u5982\u679c\u4e0a\u6e38\u670d\u52a1\u6545\u969c\u89e6\u53d1\u7194\u65ad\u65f6</p> <p>2-1-4 \u7f51\u7edc\u5f15\u8d77\u7684\u6545\u969c</p> <p>\u8fd9\u79cd\u6545\u969c\u5f80\u5f80\u53d1\u751f\u5728\u670d\u52a1\u65b0\u52a0\u8282\u70b9\u7684\u60c5\u51b5\uff0c\u56e0\u4e3a\u7f51\u7edc\u914d\u7f6e\u95ee\u9898\uff0c\u8fd9\u4e9b\u8282\u70b9\u53ef\u80fd\u5728\u67d0\u4e9b\u7f51\u6bb5\u4e0d\u901a\uff0c\u4f46\u662f\u548c\u6ce8\u518c\u4e2d\u5fc3\u662f\u76f8\u901a\u7684\uff0c\u8fd9\u5c31\u5bfc\u81f4\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u5eb7\u68c0\u67e5\u53ef\u4ee5\u901a\u8fc7\uff0c\u4f46\u662f\u670d\u52a1\u8c03\u7528\u7684\u65f6\u5019\u5374\u65e0\u6cd5\u8054\u901a\u3002</p> <p>\u6b64\u65f6\u5c31\u9700\u8981 Service Mesh \u4e2d\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u6709\u8282\u70b9\u6458\u9664\u7684\u529f\u80fd\uff0c\u5728\u53d1\u751f\u7f51\u7edc\u6545\u969c\u7684\u65f6\u5019\u5c06\u5931\u8d25\u7684\u8282\u70b9\u6458\u9664\u6389\u3002\u5f53\u7136\uff0c\u6211\u4eec\u5e73\u65f6\u4e5f\u9700\u8981\u505a\u597d\u7f51\u7edc\u5206\u533a\u7684\u89c4\u5212\uff0c\u786e\u4fdd\u670d\u52a1\u90e8\u7f72\u5728\u591a\u4e2a\u5206\u533a\uff0c\u4ee5\u907f\u514d\u67d0\u4e2a\u7f51\u7edc\u5206\u533a\u6545\u969c\u5f15\u8d77\u6574\u4e2a\u7f51\u7edc\u762b\u75ea\u3002</p> <p>2-1-5 \u673a\u5668\u5f15\u8d77\u7684\u6545\u969c</p> <p>\u673a\u5668\u5f15\u8d77\u7684\u6545\u969c\u4e3b\u8981\u662f\u6307\u673a\u5668 hang \u4f4f\uff0c\u6216\u8005\u673a\u5668 down \u673a\u91cd\u542f\u7684\u60c5\u51b5\u3002\u673a\u5668\u6545\u969c\u95ee\u9898\u53ef\u4ee5\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u5eb7\u68c0\u67e5\u89e3\u51b3\u3002\u5982\u679c\u662f\u5728 Kubernetes \u73af\u5883\u4e2d\uff0c\u5219\u9700\u8981\u6ce8\u610f\uff0c\u4e0d\u8981\u5c06\u4e00\u4e2a\u670d\u52a1\u7684 Pod \u90fd\u8c03\u5ea6\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u5426\u5219\u673a\u5668\u6545\u969c\u4f1a\u5bfc\u81f4\u6574\u4e2a\u670d\u52a1\u4e0d\u53ef\u7528\u3002</p>"},{"location":"chap2/9chap3_pratice/#2-2","title":"2-2 \u5982\u4f55\u63d0\u5347\u7814\u53d1\u6548\u7387","text":"<p>\u901a\u8fc7\u63a7\u5236\u9762\u4e0b\u53d1\u6ce8\u518c\u4fe1\u606f\uff0c\u907f\u514d\u4e86\u4e1a\u52a1\u65b9\u624b\u52a8\u8bbe\u7f6e\u6ce8\u518c\u53c2\u6570\u7684\u8fc7\u7a0b\uff0c\u51cf\u5c11\u6545\u969c\u53d1\u751f\u7684\u6982\u7387\u3002</p> <p>2-2-1 \u4ee3\u7406\u6ce8\u518c</p> <ul> <li>\u5982\u679c\u6ca1\u6709\u4f7f\u7528 Kubernetes \u5185\u7f6e\u7684\u6ce8\u518c\u53d1\u73b0\u4f53\u7cfb\uff0c\u5c31\u9700\u8981\u901a\u8fc7\u6846\u67b6\u6765\u6ce8\u518c\u3002\u4f46\u662f\u6846\u67b6\u6ce8\u518c\u514d\u4e0d\u4e86\u4e1a\u52a1\u914d\u7f6e\u4e00\u4e9b\u53c2\u6570\uff0c\u6bd4\u5982\u670d\u52a1\u540d\u3001\u8fd0\u884c\u73af\u5883\u7b49\u3002</li> <li>\u4e00\u65e6\u8fd9\u4e9b\u53c2\u6570\u914d\u7f6e\u9519\u8bef\u4f1a\u5f15\u53d1\u7ebf\u4e0a\u6545\u969c\uff0c\u6240\u4ee5\u901a\u8fc7 Sidecar \u4ee3\u7406\u6ce8\u518c\u662f\u6700\u597d\u7684\u89e3\u51b3\u65b9\u6848\u3002</li> <li>\u901a\u8fc7\u63a7\u5236\u9762\u4e0b\u53d1\u6ce8\u518c\u4fe1\u606f\uff0c\u907f\u514d\u4e86\u4e1a\u52a1\u65b9\u624b\u52a8\u8bbe\u7f6e\u6ce8\u518c\u53c2\u6570\u7684\u8fc7\u7a0b\uff0c\u51cf\u5c11\u6545\u969c\u53d1\u751f\u7684\u6982\u7387\u3002</li> </ul> <p>2-2-2 \u5b89\u5168\u901a\u4fe1</p> <ul> <li>\u5728\u5185\u7f51\u73af\u5883\u4e2d\uff0c\u5185\u7f51\u5b89\u5168\u5f80\u5f80\u6ca1\u6709\u5916\u7f51\u5b89\u5168\u90a3\u4e48\u53d7\u91cd\u89c6\u3002</li> <li>\u4e91\u539f\u751f\u7684\u73af\u5883\uff0c\u63d0\u51fa\u4e86\u96f6\u4fe1\u4efb\u7684\u6982\u5ff5\uff0c\u8fd9\u4e2a\u65f6\u5019\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\u52a0\u5165 TLS \u8ba4\u8bc1\u6216\u8005 Token \u8ba4\u8bc1\uff0c\u90fd\u5b58\u5728\u4e0d\u597d\u63a7\u5236\u548c\u7ef4\u62a4\u7684\u95ee\u9898\u3002</li> <li>\u76f4\u63a5\u5728 Service Mesh \u4e2d\uff0c\u96c6\u6210\u5b89\u5168\u76f8\u5173\u7684\u529f\u80fd\uff0c\u5c06\u662f\u6700\u5408\u9002\u7684\u9009\u62e9\uff0c\u670d\u52a1\u95f4\u901a\u8fc7\u53cc\u5411 TLS \u8ba4\u8bc1\u7684\u65b9\u5f0f\u8fdb\u884c\u5b89\u5168\u901a\u4fe1\u3002</li> </ul> <p>2-2-3 \u5e73\u6ed1\u91cd\u542f</p> <p>\u5728\u4f20\u7edf\u7684\u865a\u62df\u673a\u73af\u5883\u4e0b\uff0c\u670d\u52a1\u60f3\u8981\u505a\u5230\u5e73\u6ed1\u91cd\u542f\uff0c\u9664\u4e86\u81ea\u8eab\u7528\u4ee3\u7801\u5b9e\u73b0\u76f8\u5bf9\u590d\u6742\u7684\u5e73\u6ed1\u91cd\u542f\u5916\uff0c\u8fd8\u6709\u4e00\u79cd\u65b9\u5f0f\u5c31\u662f\u901a\u8fc7\u5173\u95ed\u524d\u53cd\u6ce8\u518c\u6458\u9664\u6d41\u91cf\uff0c\u542f\u52a8\u540e\u518d\u6ce8\u518c\u7684\u65b9\u5f0f\u5b9e\u73b0\u5e73\u6ed1\u91cd\u542f\u3002</p> <p>\u501f\u52a9 Sidecar \u7684\u80fd\u529b\uff0c\u901a\u8fc7\u548c Sidecar \u7684\u63a7\u5236\u63a5\u53e3\u901a\u4fe1\uff0c\u8c03\u7528\u63a5\u53e3\u63a7\u5236\u6ce8\u518c/\u53cd\u6ce8\u518c\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0\u5e73\u6ed1\u91cd\u542f\u3002\u8fd9\u4e2a\u529f\u80fd\u53ef\u4ee5\u96c6\u6210\u5728 CD \u5e73\u53f0\u4e2d\uff0c\u4ece\u800c\u5b9e\u73b0\u548c\u4e1a\u52a1\u4ee3\u7801\u7684\u89e3\u8026\uff0c\u4e1a\u52a1\u65e0\u987b\u5173\u5fc3\u6ce8\u518c/\u53cd\u6ce8\u518c\u7684\u8fc7\u7a0b\u3002</p> <p>2-2-4 \u5e73\u6ed1\u653e\u91cf</p> <p>\u5728\u4e00\u4e9b\u573a\u666f\u4e2d\uff0c\u6bd4\u5982 Java \u8bed\u8a00\uff0c\u542f\u52a8\u76f8\u5bf9\u6bd4\u8f83\u6162\u3002\u5982\u679c\u8282\u70b9\u521a\u542f\u52a8\u5c31\u653e\u5927\u91cf\u6d41\u91cf\u8fdb\u5165\uff0c\u4e00\u4e9b\u7ebf\u7a0b\u6c60\u8fd8\u6ca1\u6765\u5f97\u53ca\u9884\u70ed\uff0c\u5c31\u63a5\u7ba1\u6d41\u91cf\uff0c\u4f1a\u5bfc\u81f4\u5927\u91cf\u7684\u9519\u8bef\u3002</p> <p>\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u5229\u7528 Sidecar \u5b9e\u73b0\u5e73\u6ed1\u653e\u91cf\u7684\u529f\u80fd\uff0c\u65b0\u52a0\u5165\u7684\u8282\u70b9\u5148\u5c06\u6743\u91cd\u8bbe\u7f6e\u4e3a 1\uff0c\u7136\u540e\u7f13\u6162\u589e\u52a0\u5230 100\uff0c\u53ef\u4ee5\u9884\u70ed Java \u7684\u7ebf\u7a0b\u6c60\uff0c\u8fbe\u5230\u5e73\u6ed1\u653e\u91cf\u7684\u76ee\u7684\u3002</p> <p>2-2-5 \u67d3\u8272</p> <p>\u901a\u8fc7\u67d3\u8272\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u5f88\u597d\u5730\u8fdb\u884c\u6d41\u91cf\u533a\u5206\uff0c\u8fbe\u5230\u7ebf\u4e0a\u771f\u5b9e\u6d41\u91cf\u6d4b\u8bd5\u7684\u76ee\u7684\uff0c\u751a\u81f3\u53ef\u4ee5\u914d\u5408\u6545\u969c\u6f14\u7ec3\u4f7f\u7528\u3002\u5c06\u67d0\u4e9b\u7b26\u5408\u6761\u4ef6\u7684\u6d41\u91cf\u6253\u4e0a\u7279\u5b9a\u7684\u6807\u8bb0\uff0c\u901a\u8fc7 header \u5728\u5fae\u670d\u52a1\u4e4b\u95f4\u4f20\u9012\uff0c\u8fdb\u800c\u8fbe\u5230\u6d41\u91cf\u67d3\u8272\u7684\u76ee\u7684\u3002</p>"},{"location":"chap2/9chap3_pratice/#2-3-kubernetes","title":"2-3 \u5982\u4f55\u4ece\u865a\u62df\u673a\u73af\u5883\u8fc1\u79fb\u5230 Kubernetes \u73af\u5883","text":"<p>2-3-1 \u670d\u52a1\u53d1\u73b0\u95ee\u9898</p> <p>\u5efa\u8bae\u6cbf\u7528\u72ec\u7acb\u6ce8\u518c\u4e2d\u5fc3\u7684\u65b9\u6848\u3002</p> <p>\u901a\u8fc7\u63a7\u5236\u9762\u805a\u5408\u591a\u4e2a\u6ce8\u518c\u4e2d\u5fc3\u6570\u636e\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u53d1\u73b0\u65b9\u5f0f\u5219\u7edf\u4e00\u5230 Envoy EDS \u534f\u8bae\uff08\u8282\u70b9\u53d1\u73b0\u670d\u52a1\uff09\u3002</p> <p>2-3-2 \u8d1f\u8f7d\u5747\u8861\u95ee\u9898</p> <p>\u865a\u62df\u673a\u8fc1\u79fb\u5230\u5bb9\u5668\u73af\u5883\u540e\uff0c\u4f20\u7edf\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u4f1a\u56e0\u4e3a Pod \u5bbf\u4e3b\u673a\u673a\u5668\u914d\u7f6e\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u6d41\u91cf\u5747\u8861\uff0c\u800c CPU \u8d1f\u8f7d\u4e0d\u5747\u8861\u7684\u95ee\u9898\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 P2C\uff08Pick of 2 choices\uff09\u7684\u7b97\u6cd5\u89e3\u51b3\u3002</p> <p>2-3-3 \u9650\u6d41\u8bbe\u7f6e\u95ee\u9898</p> <p>\u865a\u62df\u673a\u8fc1\u79fb\u5bb9\u5668\u73af\u5883\u540e\uff0c\u56e0\u4e3a\u5bb9\u5668\u73af\u5883\u5e38\u5e38\u4f1a\u914d\u7f6e HPA\uff08\u81ea\u52a8\u6269\u7f29\u5bb9\uff09\uff0cHPA \u4f1a\u6839\u636e CPU \u7684\u6c34\u4f4d\u5bf9 Pod \u7684\u6570\u91cf\u8fdb\u884c\u8c03\u6574\uff0c\u5728\u6d41\u91cf\u4e0a\u6da8\u7684\u60c5\u51b5\uff0c\u4f1a\u8fdb\u884c\u6269\u5bb9\u64cd\u4f5c\u3002\u6b64\u65f6\u5982\u679c\u9650\u6d41\u503c\u914d\u7f6e\u4e0d\u5408\u7406\uff0c\u4f1a\u5f71\u54cd\u6269\u5bb9\u64cd\u4f5c\uff0c\u5bfc\u81f4\u4e0d\u5fc5\u8981\u7684\u6d41\u91cf\u635f\u5931\u3002\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u5f15\u5165\u81ea\u9002\u5e94\u9650\u6d41\u7684\u7b97\u6cd5\uff0c\u6839\u636e\u5ef6\u65f6\u3001CPU \u6c34\u4f4d\u7b49\u4fe1\u606f\uff0c\u81ea\u52a8\u8c03\u6574\u9650\u6d41\u503c\uff0c\u907f\u514d\u624b\u52a8\u914d\u7f6e\u5f15\u8d77\u7684\u6545\u969c\u3002</p> <p>2-3-4 \u7070\u5ea6\u6d41\u91cf\u95ee\u9898</p> <p>\u5728\u865a\u62df\u673a\u5411\u5bb9\u5668\u8fc1\u79fb\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u53ef\u907f\u514d\u4f1a\u6d89\u53ca\u5982\u4f55\u7070\u5ea6\u6d41\u91cf\u7684\u95ee\u9898\u3002\u5728\u4f20\u7edf\u7684 SDK \u6a21\u5f0f\u4e2d\uff0c\u9700\u8981\u4e1a\u52a1\u53cd\u590d\u53d1\u7248\u6216\u8005\u914d\u7f6e\u4e2d\u5fc3\u4fee\u6539\u624d\u80fd\u8c03\u6574\u670d\u52a1\u8282\u70b9\u7684\u6743\u91cd\u3002\u4f46\u662f\u5728\u4e24\u79cd\u73af\u5883\u4e0b\uff0c\u914d\u7f6e\u4e2d\u5fc3\u9488\u5bf9\u4e24\u79cd\u73af\u5883\u8bbe\u7f6e\u4e0d\u540c\u7684\u914d\u7f6e\u624d\u53ef\u4ee5\u505a\u5230\uff0c\u670d\u52a1\u4ee3\u7801\u53d1\u7248\u4e5f\u9700\u8981\u5728\u4e24\u4e2a\u73af\u5883\u53d1\u7248\uff0c\u56e0\u4e3a\u540c\u4e00\u4e2a\u670d\u52a1\u4ee3\u7801\u914d\u7f6e\u4e0d\u540c\uff0c\u5f88\u5bb9\u6613\u5728\u751f\u4ea7\u73af\u5883\u4ea7\u751f\u4eba\u4e3a\u6545\u969c\u3002</p> <p>\u4e0a\u8ff0\u95ee\u9898\u90fd\u53ef\u4ee5\u901a\u8fc7 Service Mesh \u63a7\u5236\u9762\u89e3\u51b3\uff0c\u63a7\u5236\u9762\u652f\u6301\u4e24\u79cd\u73af\u5883\u4e0d\u540c\u7684\u6743\u91cd\u914d\u7f6e\uff0c\u7ed3\u5408\u670d\u52a1\u6cbb\u7406\u5e73\u53f0\u63d0\u4f9b\u7684 Web UI\uff0c\u53ef\u4ee5\u8ba9\u8fd0\u7ef4\u975e\u5e38\u65b9\u4fbf\u5730\u64cd\u4f5c\uff0c\u800c\u4e0d\u9700\u8981\u4e1a\u52a1\u65b9\u4fee\u6539\u4ee3\u7801\u6216\u8005\u914d\u7f6e\u4e2d\u5fc3\u3002</p> <p> </p>"},{"location":"chap3/0Service_Mesh/","title":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c(Service Mesh)\u662f\u4ec0\u4e48?","text":"<p>\u73b0\u5728\u6700\u706b\u7684\u540e\u7aef\u67b6\u6784\u65e0\u7591\u662f\u5fae\u670d\u52a1\u4e86\uff0c\u5fae\u670d\u52a1\u5c06\u4e4b\u524d\u7684\u5355\u4f53\u5e94\u7528\u62c6\u5206\u6210\u4e86\u8bb8\u591a\u72ec\u7acb\u7684\u670d\u52a1\u5e94\u7528\uff0c\u6bcf\u4e2a\u5fae\u670d\u52a1\u90fd\u662f\u72ec\u7acb\u7684\uff0c\u597d\u5904\u81ea\u7136\u5f88\u591a\uff0c\u4f46\u662f\u968f\u7740\u5e94\u7528\u7684\u8d8a\u6765\u8d8a\u5927\uff0c\u5fae\u670d\u52a1\u66b4\u9732\u51fa\u6765\u7684\u95ee\u9898\u4e5f\u5c31\u968f\u4e4b\u800c\u6765\u4e86\uff0c\u5fae\u670d\u52a1\u8d8a\u6765\u8d8a\u591a\uff0c\u7ba1\u7406\u8d8a\u6765\u8d8a\u9ebb\u70e6\uff0c\u7279\u522b\u662f\u8981\u4f60\u90e8\u7f72\u4e00\u5957\u65b0\u73af\u5883\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u80fd\u4f53\u4f1a\u5230\u8fd9\u79cd\u75db\u82e6\u4e86\uff0c\u968f\u4e4b\u800c\u6765\u7684\u670d\u52a1\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001Trace\u8ddf\u8e2a\u3001\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u8ba4\u8bc1\u7b49\u7b49\u95ee\u9898\u3002</p> <p>\u5982\u679c\u4ece\u5934\u5230\u5c3e\u5b8c\u6210\u8fc7\u4e00\u5957\u5fae\u670d\u52a1\u6846\u67b6\u7684\u8bdd\uff0c\u4f60\u5c31\u4f1a\u77e5\u9053\u8fd9\u91cc\u9762\u6d89\u53ca\u5230\u7684\u4e1c\u897f\u771f\u7684\u975e\u5e38\u591a\u3002\u5f53\u7136\u968f\u7740\u5fae\u670d\u52a1\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u5fae\u670d\u52a1\u7684\u751f\u6001\u4e5f\u4e0d\u65ad\u5b8c\u5584\uff0c\u6700\u8fd1\u5c31\u53d1\u73b0\u65b0\u4e00\u4ee3\u7684\u5fae\u670d\u52a1\u5f00\u53d1\u5c31\u6084\u7136\u5174\u8d77\u4e86\uff0c\u90a3\u5c31\u662f\u670d\u52a1\u7f51\u683c/Service Mesh\u3002</p>"},{"location":"chap3/0Service_Mesh/#1service-mesh","title":"1\u3001\u4ec0\u4e48\u662fService Mesh\uff1f","text":"<p><code>Service Mesh</code>\u662f\u4e00\u4e2a\u975e\u5e38\u65b0\u7684\u540d\u8bcd\uff0c\u6700\u65e9\u662f2016\u5e74\u7531\u5f00\u53d1Linkerd\u7684 Buoyant \u516c\u53f8\u63d0\u51fa\u7684\uff0c\u642c\u968f\u7740Linkerd\u7684\u4f20\u5165\uff0c<code>Service Mesh</code>\u7684\u6982\u5ff5\u4e5f\u6162\u6162\u8fdb\u5165\u56fd\u5185\u6280\u672f\u793e\u533a\u3002\u4e4b\u524d infoQ \u7684\u4e00\u7bc7\u4ecb\u7ecd<code>istio</code>\u7684\u6587\u7ae0\u5c06<code>Service Mesh</code>\u7ffb\u8bd1\u6210\u7684\u670d\u52a1\u556e\u5408\u5c42\uff0c</p> <p><code>\u556e\u5408</code>\u7684\u5b57\u9762\u610f\u601d\u662f\uff1a\u4e24\u4e2a\u9f7f\u8f6e\u95f4\u7684\u54ac\u5408\uff0c\u548c<code>Service Mesh</code>\u8868\u8fbe\u7684\u610f\u601d\u57fa\u672c\u4e0a\u8fd8\u662f\u543b\u5408\u7684\uff0c\u4f46\u662f\u8fd9\u4e2a\u8bcd\u6bd4\u8f83\u62d7\u53e3\u3002\u5230\u73b0\u5728\u4e3b\u6d41\u7684\u53eb\u6cd5\u90fd\u53eb\uff1a\u670d\u52a1\u7f51\u683c\u3002</p> <p>Willian Morgan\uff08Linker \u7684CEO\uff09\u7ed9\u51fa\u7684<code>Service Mesh</code>\u5b9a\u4e49\uff1a</p> <p>A service mesh is a dedicated infrastructure layer for handling service-to-service communication. It\u2019s responsible for the reliable delivery of requests through the complex topology of services that comprise a modern, cloud native application. In practice, the service mesh is typically implemented as an array of lightweight network proxies that are deployed alongside application code, without the application needing to be aware.</p> <p>\u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u7528\u4e8e\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5b83\u8d1f\u8d23\u4e3a\u6784\u5efa\u590d\u6742\u7684\u4e91\u539f\u751f\u5e94\u7528\u4f20\u9012\u53ef\u9760\u7684\u7f51\u7edc\u8bf7\u6c42\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u901a\u5e38\u5b9e\u73b0\u4e3a\u4e00\u7ec4\u548c\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5728\u4e00\u8d77\u7684\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\uff0c\u4f46\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u662f\u900f\u660e\u7684\u3002</p>"},{"location":"chap3/0Service_Mesh/#2","title":"2\u3001\u600e\u4e48\u7406\u89e3\u7f51\u683c","text":"<p>\u8981\u7406\u89e3\u7f51\u683c\u7684\u6982\u5ff5\uff0c\u5c31\u5f97\u4ece\u670d\u52a1\u7684\u90e8\u7f72\u6a21\u578b\u8bf4\u8d77\uff1a</p>"},{"location":"chap3/0Service_Mesh/#2-1-sidecar","title":"2-1 \u5355\u4e2a\u670d\u52a1\u8c03\u7528\uff0c\u8868\u73b0\u4e3a<code>sidecar</code>","text":"<p><code>Service Mesh</code>\u7684\u90e8\u7f72\u6a21\u578b\uff0c\u5148\u770b\u5355\u4e2a\u7684\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7b80\u5355\u8bf7\u6c42\uff0c\u4f5c\u4e3a\u8bf7\u6c42\u53d1\u8d77\u8005\u7684\u5ba2\u6237\u7aef\u5e94\u7528\u5b9e\u4f8b\uff0c\u4f1a\u9996\u5148\u7528\u7b80\u5355\u65b9\u5f0f\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u672c\u5730\u7684<code>Service Mesh</code>\u5b9e\u4f8b\u3002</p> <p>\u8fd9\u662f\u4e24\u4e2a\u72ec\u7acb\u8fdb\u7a0b\uff0c\u4ed6\u4eec\u4e4b\u95f4\u662f\u8fdc\u7a0b\u8c03\u7528\u3002</p> <p><code>Service Mesh</code>\u4f1a\u5b8c\u6210\u5b8c\u6574\u7684\u670d\u52a1\u95f4\u8c03\u7528\u6d41\u7a0b\uff0c\u5982\u670d\u52a1\u53d1\u73b0\u8d1f\u8f7d\u5747\u8861\uff0c\u6700\u540e\u5c06\u8bf7\u6c42\u53d1\u9001\u7ed9\u76ee\u6807\u670d\u52a1\u3002\u8fd9\u8868\u73b0\u4e3a<code>Sidecar</code>\u3002</p> <p>\u63d0\u5230<code>Sidecar</code>\uff0c\u5728Kubernetes\u4e2d\u90e8\u7f72\u7684<code>POD</code>\u4e2d\u4e5f\u4f1a\u6709\u4e00\u4e2a\u9644\u52a0\u7684<code>Sidecar</code>\u5bb9\u5668\u3002\u5fae\u670d\u52a1\u4e2d\u7684Sidecar\u8bbe\u8ba1\u6a21\u5f0f\u89e3\u6790</p>"},{"location":"chap3/0Service_Mesh/#2-2","title":"2-2 \u90e8\u7f72\u591a\u4e2a\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u901a\u8baf\u5c42","text":"<p>\u591a\u4e2a\u670d\u52a1\u8c03\u7528\u7684\u60c5\u51b5\uff0c\u5728\u8fd9\u4e2a\u56fe\u4e0a\u6211\u4eec\u53ef\u4ee5\u770b\u5230<code>Service Mesh</code>\u5728\u6240\u6709\u7684\u670d\u52a1\u7684\u4e0b\u9762\uff0c\u8fd9\u4e00\u5c42\u88ab\u79f0\u4e4b\u4e3a\u670d\u52a1\u95f4\u901a\u8baf\u4e13\u7528\u57fa\u7840\u8bbe\u65bd\u5c42\u3002</p> <p><code>Service Mesh</code>\u4f1a\u63a5\u7ba1\u6574\u4e2a\u7f51\u7edc\uff0c\u628a\u6240\u6709\u7684\u8bf7\u6c42\u5728\u670d\u52a1\u4e4b\u95f4\u505a\u8f6c\u53d1\u3002</p> <p>\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4e0a\u9762\u7684\u670d\u52a1\u4e0d\u518d\u8d1f\u8d23\u4f20\u9012\u8bf7\u6c42\u7684\u5177\u4f53\u903b\u8f91\uff0c\u53ea\u8d1f\u8d23\u5b8c\u6210\u4e1a\u52a1\u5904\u7406\u3002</p> <p>\u670d\u52a1\u95f4\u901a\u8baf\u7684\u73af\u8282\u5c31\u4ece\u5e94\u7528\u91cc\u9762\u5265\u79bb\u51fa\u6765\uff0c\u5448\u73b0\u51fa\u4e00\u4e2a\u62bd\u8c61\u5c42\u3002</p> <p></p>"},{"location":"chap3/0Service_Mesh/#2-3","title":"2-3 \u6709\u5927\u91cf\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u7f51\u7edc","text":"<p>\u5982\u679c\u6709\u5927\u91cf\u7684\u670d\u52a1\uff0c\u5c31\u4f1a\u8868\u73b0\u51fa\u6765\u7f51\u683c\u3002</p> <p>\u56fe\u4e2d\u5de6\u8fb9\u7eff\u8272\u65b9\u683c\u662f\u5e94\u7528\uff0c\u53f3\u8fb9\u84dd\u8272\u7684\u65b9\u6846\u662f<code>Service Mesh</code>\uff0c\u84dd\u8272\u4e4b\u95f4\u7684\u7ebf\u6761\u662f\u8868\u793a\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u3002</p> <p><code>Sidecar</code>\u4e4b\u95f4\u7684\u8fde\u63a5\u5c31\u4f1a\u5f62\u6210\u4e00\u4e2a\u7f51\u7edc\uff0c\u8fd9\u4e2a\u5c31\u662f\u670d\u52a1\u7f51\u683c\u540d\u5b57\u7684\u7531\u6765\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u4ee3\u7406\u4f53\u73b0\u51fa\u6765\u7684\u5c31\u548c\u524d\u9762\u7684<code>Sidecar</code>\u4e0d\u4e00\u6837\u4e86\uff0c\u5f62\u6210\u7f51\u72b6\u3002</p>"},{"location":"chap3/0Service_Mesh/#3","title":"3\u3001\u670d\u52a1\u7f51\u683c","text":"<p>\u9996\u5148\u7b2c\u4e00\u4e2a\uff0c\u670d\u52a1\u7f51\u683c\u662f\u62bd\u8c61\u7684\uff0c\u5b9e\u9645\u4e0a\u662f\u62bd\u8c61\u51fa\u4e86\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5728\u5e94\u7528\u4e4b\u5916\u3002\u5176\u6b21\uff0c\u529f\u80fd\u662f\u5b9e\u73b0\u8bf7\u6c42\u7684\u53ef\u9760\u4f20\u9012\u3002\u90e8\u7f72\u4e0a\u4f53\u73b0\u4e3a\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\u3002\u6700\u540e\u4e00\u4e2a\u5173\u952e\u8bcd\u662f\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u900f\u660e\u3002</p> <p></p> <p>\u5927\u5bb6\u6ce8\u610f\u770b\uff0c\u4e0a\u9762\u7684\u56fe\u4e2d\uff0c\u7f51\u7edc\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u4e0d\u662f\u7279\u522b\u660e\u663e\u3002</p> <p>\u4f46\u662f\u5982\u679c\u628a\u5de6\u8fb9\u7684\u5e94\u7528\u7a0b\u5e8f\u53bb\u6389\uff0c\u73b0\u5728\u53ea\u5448\u73b0\u51fa\u6765<code>Service Mesh</code>\u548c\u4ed6\u4eec\u4e4b\u95f4\u7684\u8c03\u7528\uff0c\u8fd9\u4e2a\u65f6\u5019\u5173\u7cfb\u5c31\u4f1a\u7279\u522b\u6e05\u6670\uff0c\u5c31\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u7f51\u7edc\u3002</p> <p>\u8fd9\u662f<code>Service Mesh</code>\u5b9a\u4e49\u5f53\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5173\u952e\u70b9\uff0c\u548c<code>Sidecar</code>\u4e0d\u76f8\u540c\u7684\u5730\u65b9\uff1a\u4e0d\u518d\u5c06\u4ee3\u7406\u89c6\u4e3a\u5355\u72ec\u7684\u7ec4\u4ef6\uff0c\u800c\u662f\u5f3a\u8c03\u7531\u8fd9\u4e9b\u4ee3\u7406\u8fde\u63a5\u800c\u5f62\u6210\u7684\u7f51\u7edc\u3002\u5728<code>Service Mesh</code>\u91cc\u9762\u975e\u5e38\u5f3a\u8c03\u4ee3\u7406\u8fde\u63a5\u7ec4\u6210\u7684\u7f51\u7edc\uff0c\u800c\u4e0d\u50cf<code>Sidecar</code>\u90a3\u6837\u770b\u5f85\u4e2a\u4f53\u3002</p> <p>What's a service mesh? And why do I need one?</p>"},{"location":"chap3/1isba_Frame_Tech/","title":"\u7b2c\u4e8c\u8282 Istio \u67b6\u6784\u4e0e\u6280\u672f","text":""},{"location":"chap3/1isba_Frame_Tech/#_1","title":"\u5927\u7eb2","text":"<ul> <li>Service Mesh</li> <li>Istio \u67b6\u6784\u57fa\u7840</li> <li>Istio \u57fa\u672c\u6982\u5ff5</li> <li>Istio &amp; Kubernetes:\u67b6\u6784\u7ed3\u5408</li> <li>\u8fd0\u884c\u7b2c\u4e00\u4e2aIstio\u96c6\u7fa4</li> </ul>"},{"location":"chap3/1isba_Frame_Tech/#1kubernetes","title":"1\u3001Kubernetes","text":"<p>Kubernetes \u63d0\u4f9b\u5e73\u53f0\u57fa\u7840\u8bbe\u65bd\u5c42\u5f3a\u5927\u7684\u5bb9\u5668\u7f16\u6392\u4e0e\u8c03\u5ea6\u80fd\u529b</p> <ul> <li>\u670d\u52a1\u90e8\u7f72\u4e0e\u5f39\u6027\u4f38\u7f29:<code>Deployment</code></li> <li>\u670d\u52a1\u62c6\u5206\u4e0e\u670d\u52a1\u53d1\u73b0:<code>Service</code></li> </ul> <p>Kubernetes \u63d0\u4f9b\u7b80\u5355\u7684\u8d1f\u8f7d\u5747\u8861</p> <ul> <li>\u8d1f\u8f7d\u5747\u8861:\u57fa\u4e8e<code>IPVS</code>\u6216<code>Iptables</code>\u7684\u7b80\u5355\u5747\u8861\u673a\u5236</li> </ul>"},{"location":"chap3/1isba_Frame_Tech/#2service-mesh","title":"2\u3001Service Mesh","text":"<ul> <li>\u6cbb\u7406\u80fd\u529b\u72ec\u7acb(Sidecar) </li> <li>\u5e94\u7528\u7a0b\u5e8f\u65e0\u611f\u77e5</li> <li>\u670d\u52a1\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42</li> </ul>"},{"location":"chap3/1isba_Frame_Tech/#3istio","title":"3\u3001Istio\u95ee\u4e16","text":"<ul> <li>\u8fde\u63a5(Connect) </li> <li>\u5b89\u5168(Secure)</li> <li>\u63a7\u5236(Control) </li> <li>\u89c2\u5bdf(Observe)</li> </ul>"},{"location":"chap3/1isba_Frame_Tech/#3-1-istio","title":"3-1 Istio\u5173\u952e\u80fd\u529b","text":""},{"location":"chap3/1isba_Frame_Tech/#_2","title":"\u529f\u80fd","text":""},{"location":"chap3/1isba_Frame_Tech/#_3","title":"\u6269\u5c55","text":""},{"location":"chap3/1isba_Frame_Tech/#4istio-kubernetes","title":"4\u3001Istio + Kubernetes:\u4e91\u539f\u751f\u5e94\u7528\u6cbb\u7406 + \u4e91\u539f\u751f\u5e94\u7528\u8bbe\u65bd","text":""},{"location":"chap3/1isba_Frame_Tech/#4-1-istio","title":"4-1 Istio\u67b6\u6784\u4e0e\u5176\u5173\u952e\u7ec4\u4ef6","text":""},{"location":"chap3/1isba_Frame_Tech/#4-2-pilot-service-discovery-and-traffic-rule","title":"4-2 Pilot, Service discovery and traffic rule","text":""},{"location":"chap3/1isba_Frame_Tech/#4-3-mixer-check-report","title":"4-3 Mixer, Check &amp; Report","text":""},{"location":"chap3/1isba_Frame_Tech/#4-4-citadel","title":"4-4 Citadel","text":""},{"location":"chap3/1isba_Frame_Tech/#5istio-kubernetes","title":"5\u3001Istio &amp; Kubernetes:\u67b6\u6784\u7ed3\u5408","text":""},{"location":"chap3/1isba_Frame_Tech/#5-1-envoy","title":"5-1 Envoy","text":"<ul> <li>\u57fa\u4e8eC++\u7684 L4/L7 Proxy\u8f6c\u53d1\u5668 </li> <li>CNCF\u7b2c\u4e09\u4e2a\u6bd5\u4e1a\u7684\u9879\u76ee</li> </ul> <ul> <li>Listeners (LDS) </li> <li>Routes (RDS) </li> <li>Clusters (CDS) </li> <li>Endpoints (EDS)</li> </ul>"},{"location":"chap3/1isba_Frame_Tech/#5-2-envoy","title":"5-2 Envoy \u914d\u7f6e\u6587\u4ef6","text":""},{"location":"chap3/1isba_Frame_Tech/#6istio","title":"6\u3001Istio \u57fa\u7840\u6982\u5ff5","text":""},{"location":"chap3/1isba_Frame_Tech/#6-1-virtualservice","title":"6-1 VirtualService","text":"<p>\u6700\u6838\u5fc3\u7684\u914d\u7f6e\u63a5\u53e3\uff0c\u5b9a\u4e49\u6307\u5b9a\u670d\u52a1\u7684\u6240\u6709\u8def\u7531\u89c4\u5219</p> <ul> <li>Hosts</li> <li>Gateways</li> <li>Http</li> <li>Tcp</li> <li>Tls</li> </ul> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: VirtualService\nmetadata:\n  name: reviews-route\n  namespace: foo\nspec:\n  hosts:\n  - reviews\n  http:\n  - match:\n    - uri:\n        prefix: \"/wpcatalog\"\n     - uri:\n        prefix: \"/consumercatalog\"\n    rewrite:\n      uri: \"/newcatalog\"\n    route:\n    - destination:\n        host: reviews\n        subset: v2\n  - route:\n    - destination:\n        host: reviews\nsubset: v1\n</code></pre>"},{"location":"chap3/1isba_Frame_Tech/#6-2-destinationrule","title":"6-2 DestinationRule","text":"<p>\u5176\u5b9a\u4e49\u7684\u7b56\u7565\uff0c\u51b3\u5b9a\u4e86\u8def\u7531\u5904\u7406\u4e4b\u540e\u7684\u6d41 \u91cf\u8bbf\u95ee\u7b56\u7565\u3002\u8d1f\u8f7d\u5747\u8861\u8bbe\u7f6e\uff0c\u65ad\u8def\u5668\uff0c TLS\u8bbe\u7f6e\u7b49</p> <ul> <li>Host</li> <li>Subset</li> <li>TrafficPolicy</li> </ul> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: DestinationRule\nmetadata:\n  name: bookinfo-ratings\nspec:\n  host: ratings\n  trafficPolicy:\n    loadBalancer:\n      simple: LEAST_CONN\n  subsets:\n  - name: v1\n     labels: \n        version: v1\n  - name: v2\n    labels:\n        version: v2\n  - name: v3\n     labels: \n        version: v3\n    trafficPolicy:\n      loadBalancer:\n        simple: ROUND_ROBIN\n</code></pre>"},{"location":"chap3/1isba_Frame_Tech/#6-3-gateway","title":"6-3 Gateway","text":"<p>\u63d0\u4f9b\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u63a5\u5165\uff0c\u53ef\u53d1\u5e03\u4efb\u610f\u5185\u90e8\u7aef \u53e3\u7684\u670d\u52a1\uff0c\u4f9b\u5916\u90e8\u8bbf\u95ee\u3002 \u914d\u5408<code>VirtualService</code> \u4f7f\u7528\uff0c\u4f7f\u7528\u6807\u51c6Istio\u89c4\u5219\u6cbb\u7406</p> <ul> <li>Servers</li> <li>Selector</li> </ul> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: bookinfo-gateway \nspec:\n  selector:\n    istio: ingressgateway # use istio default controller\n  servers:\n  - port:\n      number: 80 \n      name: http \n      protocol: HTTP\n    hosts:\n    - \"*\" \n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\nname: bookinfo \nspec:\n  hosts:\n  - \"*\"\n  gateways:\n  - bookinfo-gateway \n  http:\n  - match:\n    - uri:\n        exact: /productpage\n  route:\n    - destination:\n        ...\n\n</code></pre>"},{"location":"chap3/1isba_Frame_Tech/#6-4-serviceentry","title":"6-4 ServiceEntry","text":"<p>\u5c06\u5916\u90e8\u670d\u52a1\u63a5\u5165\u5230\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\uff0c\u8ba9Istio\u4e2d\u81ea\u52a8\u53d1\u73b0\u7684\u670d\u52a1\u80fd\u591f\u8bbf\u95ee\u548c\u8def\u7531\u5230\u8fd9\u4e9b\u624b\u5de5\u52a0\u5165\u7684\u670d\u52a1\u3002</p> <p>\u4e0e<code>VirtualService</code>\u6216<code>DestinationRule</code>\u914d\u5408\u4f7f\u7528</p> <ul> <li>Hosts</li> <li>Addresss</li> <li>Ports</li> <li>Location</li> <li>Resolution</li> <li>Endpoints</li> </ul> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: external-svc-mongocluster \nspec:\n  hosts:\n  - mymongodb.somedomain\n  addresses:\n  - 192.192.192.192/24 # VIPs\n  ports:\n  - number: 27018\n    name: mongodb\n    protocol: MONGO\n  location: MESH_INTERNAL\n  resolution: STATIC\n  endpoints:\n  - address: 2.2.2.2\n  - address: 3.3.3.3\n----\napiVersion: networking.istio.io/v1alpha3 \nkind: DestinationRule\nmetadata:\n  name: mtls-mongocluster\nspec:\n  host: mymongodb.somedomain \n  trafficPolicy:\n    tls:\n      mode: MUTUAL\n      clientCertificate: /etc/certs/myclientcert.pem \n      privateKey: /etc/certs/client_private_key.pem \n      caCertificates: /etc/certs/rootcacerts.pem\n</code></pre>"},{"location":"chap3/1isba_Frame_Tech/#7k8sistio","title":"7\u3001\u57fa\u4e8eK8s\u8fd0\u884cIstio\u96c6\u7fa4","text":"<ul> <li><code>kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml</code></li> <li><code>helm template install/kubernetes/helm/istio --name istio --namespace istio-system &gt; $HOME/istio.yaml</code></li> <li><code>kubectl create namespace istio-system</code></li> <li><code>kubectl apply -f $HOME/istio.yaml</code></li> </ul>"},{"location":"chap3/1isba_Frame_Tech/#7-1-istioctl","title":"7-1 Istioctl","text":"<ul> <li><code>proxy-status</code>:\u72b6\u6001\u540c\u6b65\u60c5\u51b5</li> <li><code>proxy-config:envoy</code> \u4e2d\u5177\u4f53\u89c4\u5219\u67e5\u8be2</li> <li>listener</li> <li>route</li> <li>cluster</li> <li>endpoint</li> <li>kube-inject</li> <li>......</li> </ul>"},{"location":"chap3/1isba_Frame_Tech/#8demo","title":"8\u3001Demo","text":"<pre><code>$ kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml\n$ helm template install/kubernetes/helm/istio --name istio --namespace istio-system &gt; $HOME/istio.yaml\n$ kubectl create namespace istio-system\n$ kubectl apply -f $HOME/istio.yaml\n</code></pre>"},{"location":"chap3/1isba_Frame_Tech/#8-1-every-pod-inside-default-namespace-will-inject-istio-sidecar","title":"8-1 Every pod inside default namespace will inject istio sidecar","text":"<pre><code>$ kubectl label namespace default istio-injection=enabled\n</code></pre>"},{"location":"chap3/1isba_Frame_Tech/#8-2-check-ingress-gateway-svc","title":"8-2 check ingress gateway svc","text":"<pre><code>$ kubectl get svc istio-ingressgateway -n istio-system\n</code></pre> <pre><code>$ kubectl get svc istio-ingressgateway -n istio-system -o yaml\n</code></pre>"},{"location":"chap3/1isba_Frame_Tech/#8-3-the-bookinfo-experiments-please-check-i-did-before","title":"8-3 The bookinfo experiments please check I did before","text":"<ol> <li>\u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e1</li> <li>\u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e2</li> </ol>"},{"location":"chap3/2isba_Service_Find/","title":"\u7b2c\u4e09\u8282 Istio \u670d\u52a1\u53d1\u73b0\u548c Pilot\u7684\u67b6\u6784\u673a\u5236","text":"<ul> <li>Istio\u67b6\u6784\u56de\u987e&amp;Pilot\u4ecb\u7ecd</li> <li>Istio\u670d\u52a1\u53d1\u73b0</li> <li>Istio\u670d\u52a1\u914d\u7f6e</li> <li>Istio\u670d\u52a1\u53d1\u73b0&amp;\u89c4\u5219\u7ba1\u7406\u4e0eKubernetes\u7ed3\u5408 </li> <li>ShowCase</li> </ul>"},{"location":"chap3/2isba_Service_Find/#1istiopilot","title":"1\u3001Istio\u67b6\u6784\u56de\u987e&amp;Pilot\u4ecb\u7ecd","text":""},{"location":"chap3/2isba_Service_Find/#1-1-istio","title":"1-1 \u4e0a\u671f\u56de\u987e:Istio\u67b6\u6784","text":""},{"location":"chap3/2isba_Service_Find/#1-2-pilot","title":"1-2 Pilot\u529f\u80fd","text":"<ul> <li>\u670d\u52a1\u53d1\u73b0</li> <li>\u670d\u52a1\u914d\u7f6e</li> </ul>"},{"location":"chap3/2isba_Service_Find/#2istio","title":"2\u3001Istio\u670d\u52a1\u53d1\u73b0","text":""},{"location":"chap3/2isba_Service_Find/#2-1","title":"2-1 \u670d\u52a1\u53d1\u73b0\u57fa\u672c\u539f\u7406","text":"<ol> <li>Service register</li> <li>Service discover</li> <li>Service provide</li> </ol>"},{"location":"chap3/2isba_Service_Find/#2-2-springcloud","title":"2-2 SpringCloud\u7684\u670d\u52a1(\u5916\u90e8\uff09\u6ce8\u518c\u4e0e\u53d1\u73b0\u6d41\u7a0b","text":"<ul> <li>\u670d\u52a1\u6ce8\u518c\u8868: \u5982<code>Springcloud</code>\u4e2d\u4e00\u822c<code>Eureka</code>\u670d\u52a1;</li> <li>\u670d\u52a1\u6ce8\u518c: \u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u914d\u7f6e\u670d\u52a1\u540d\u548c\u672c\u5b9e\u4f8b\u5730\u5740\uff0c\u5b9e\u4f8b\u542f\u52a8\u65f6\u81ea\u52a8\u6ce8\u518c\u5230\u670d\u52a1\u6ce8\u518c\u8868;</li> <li>\u670d\u52a1\u53d1\u73b0: \u8bbf\u95ee\u76ee\u6807\u670d\u52a1\u65f6\u8fde\u670d\u52a1\u6ce8\u518c\u8868\uff0c\u83b7\u53d6\u670d\u52a1\u5b9e\u4f8b\u5217\u8868\u3002\u6839\u636e<code>LB</code>\u6839\u636e\u7b56\u7565\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\uff0c\u5efa\u7acb\u8fde\u63a5\u53bb\u8bbf\u95ee\u3002</li> </ul> <ol> <li>Eureka Server -  Register Service list</li> <li>Load Balancer - Find Service</li> <li>Eureka Client - Service return</li> </ol>"},{"location":"chap3/2isba_Service_Find/#2-3-istio","title":"2-3 Istio\u670d\u52a1\u53d1\u73b0\u6d41\u7a0b\uff08\u5185\u90e8\uff09","text":"<ul> <li>\u670d\u52a1\u6ce8\u518c\u8868:<code>Pilot</code> \u4ece\u5e73\u53f0\u83b7\u53d6\u670d\u52a1\u53d1\u73b0\u6570\u636e\uff0c\u5e76\u63d0\u4f9b\u7edf\u4e00\u7684\u670d\u52a1\u53d1\u73b0\u63a5\u53e3\u3002</li> <li>\u670d\u52a1\u6ce8\u518c: \u65e0</li> <li>\u670d\u52a1\u53d1\u73b0:<code>Envoy \u5b9e\u73b0\u670d\u52a1\u53d1\u73b0</code>\uff0c\u52a8\u6001\u66f4\u65b0\u8d1f\u8f7d\u5747\u8861\u6c60\u3002 \u5728\u670d\u52a1\u8bf7\u6c42\u65f6\u4f7f\u7528\u5bf9\u5e94\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u5bf9\u5e94\u7684\u540e\u7aef\u3002</li> </ul> <ul> <li>Pilot -&gt; Service registration by the platform</li> <li>Enovy -&gt; Service discovery by Envoys</li> </ul>"},{"location":"chap3/2isba_Service_Find/#2-4-pilotadapter","title":"2-4 Pilot\u670d\u52a1\u53d1\u73b0\u673a\u5236\u7684Adapter\u673a\u5236","text":""},{"location":"chap3/2isba_Service_Find/#abstract-model","title":"Abstract Model","text":"<ul> <li>Services</li> <li>Services Instances</li> <li>Services Versions</li> </ul>"},{"location":"chap3/2isba_Service_Find/#2-5-istio-eureka","title":"2-5 Istio\u670d\u52a1\u53d1\u73b0\u5b9e\u73b0: \u57fa\u4e8e Eureka","text":"<ol> <li><code>Pilot</code> \u5b9e\u73b0\u82e5\u5e72\u670d\u52a1\u53d1\u73b0\u7684\u63a5\u53e3\u5b9a\u4e49</li> <li><code>Controller</code>\u4f7f\u7528<code>EurekaClient</code>\u6765\u83b7\u53d6\u670d\u52a1\u5217\u8868\uff0c\u63d0\u4f9b\u8f6c\u6362\u540e\u7684\u6807\u51c6\u7684\u670d\u52a1\u53d1\u73b0\u63a5\u53e3\u548c\u6570\u636e\u7ed3\u6784;</li> <li><code>Discoveryserver</code> \u57fa\u4e8e <code>Controller</code> \u4e0a\u7ef4\u62a4\u7684\u670d\u52a1\u53d1\u73b0\u6570\u636e\uff0c\u53d1\u5e03\u6210<code>gRPC</code>\u534f\u8bae\u7684\u670d\u52a1\u4f9b<code>Envoy</code>\u4f7f\u7528\u3002</li> <li>\u5f53\u6709\u670d\u52a1\u8bbf\u95ee\u65f6\uff0c<code>Envoy</code>\u5728\u5904\u7406<code>Outbound</code>\u8bf7\u6c42\u65f6\uff0c\u6839\u636e\u914d\u7f6e\u7684<code>LB</code>\u7b56\u7565\uff0c\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u53d1\u8d77\u8bbf\u95ee</li> </ol> <pre><code>public interface ServiceInstance { \n    String getServiceId();\n    String getHost();\n    int getPort();\n    boolean isSecure();\n    URI getUri();\n    Map&lt;String, String&gt; getMetadata();\n}\n</code></pre>"},{"location":"chap3/2isba_Service_Find/#2-6-istio-kubernetes","title":"2-6 Istio \u670d\u52a1\u53d1\u73b0\u5b9e\u73b0:\u57fa\u4e8eKubernetes","text":"<ol> <li>Pilot \u5b9e\u73b0\u82e5\u5e72\u670d\u52a1\u53d1\u73b0\u7684\u63a5\u53e3\u5b9a\u4e49</li> <li>Pilot \u7684<code>Controller List/Watch KubeAPIserver</code>\u4e0a<code>service</code>\u3001 <code>endpoint</code>\u7b49\u8d44\u6e90\u5bf9\u8c61\u5e76\u8f6c\u6362\u6210\u6807\u51c6\u683c\u5f0f\u3002</li> <li><code>Envoy</code>\u4ece<code>Pilot</code>\u83b7\u53d6<code>xDS</code>\uff0c\u52a8\u6001\u66f4\u65b0</li> <li>\u5f53\u6709\u670d\u52a1\u8bbf\u95ee\u65f6\uff0c<code>Envoy</code>\u5728\u5904\u7406 <code>Outbound</code>\u8bf7\u6c42\u65f6\uff0c\u6839\u636e\u914d\u7f6e\u7684<code>LB</code> \u7b56\u7565\uff0c\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u53d1\u8d77\u8bbf\u95ee\u3002</li> </ol> <pre><code>type Service struct {\n    // Hostname of the service, e.g. \"catalog.mystore.com\"\n    Hostname Hostname `json:\"hostname\"`\n    Address string `json:\"address,omitempty\"`\n    Addresses map[string]string `json:\"addresses,omitempty\"`\n    // Ports is the set of network ports where the service is listening for\n    connections\n    Ports PortList `json:\"ports,omitempty\"` ExternalName Hostname `json:\"external\"` \n    ...\n}\n</code></pre>"},{"location":"chap3/2isba_Service_Find/#2-7-kubernetes-istio","title":"2-7 Kubernetes &amp; Istio \u670d\u52a1\u6a21\u578b","text":""},{"location":"chap3/2isba_Service_Find/#2-8-kuberntes","title":"2-8 Kuberntes\u7684\u670d\u52a1\u53d1\u73b0","text":""},{"location":"chap3/2isba_Service_Find/#2-9-istio-upon-kubernetes","title":"2-9 Istio Upon Kubernetes\u573a\u666f","text":"<p>Istiio  =&gt; \u670d\u52a1\u6cbb\u7406</p> <p>\u2022 \u8c03\u7528\u94fe\u8ffd\u8e2a \u2022 \u52a8\u6001\u8def\u7531 \u2022 \u7194\u65ad\u9650\u6d41   </p> <p>kubernetes  =&gt; \u670d\u52a1\u7684\u90e8\u7f72\u8fd0\u7ef4</p> <p>\u2022 \u8d1f\u8f7d\u5747\u8861 \u2022 \u670d\u52a1\u53d1\u73b0 \u2022 \u6269\u7f29\u5bb9 \u2022 \u8fd0\u7ef4 \u2022 \u90e8\u7f72</p>"},{"location":"chap3/2isba_Service_Find/#2-10-istio-upon-kubernetes","title":"2-10 Istio (upon Kubernetes)\u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e","text":"<ul> <li>POD to POD =&gt; Enovy to Enovy</li> <li><code>Envoy</code>\u4ece<code>Pilot</code>\u83b7\u53d6<code>xDS</code>\uff0c\u52a8\u6001\u66f4\u65b0</li> <li>Pilot \u7684<code>Controller List/Watch KubeAPIserver</code>\u4e0a<code>service</code>\u3001 <code>endpoint</code>\u7b49\u8d44\u6e90\u5bf9\u8c61\u5e76\u8f6c\u6362\u6210\u6807\u51c6\u683c\u5f0f</li> </ul>"},{"location":"chap3/2isba_Service_Find/#3istio","title":"3\u3001Istio\u670d\u52a1\u914d\u7f6e\u7ba1\u7406","text":""},{"location":"chap3/2isba_Service_Find/#3-1-istio","title":"3-1 Istio \u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7ef4\u62a4\u548c\u5de5\u4f5c\u673a\u5236","text":"<ol> <li>\u914d\u7f6e: \u7ba1\u7406\u5458\u901a\u8fc7Pilot\u914d\u7f6e\u6cbb\u7597\u89c4\u5219</li> <li>\u4e0b\u53d1: Envoy\u4ecePilot\u83b7\u53d6\u6cbb\u7406\u89c4\u5219</li> <li>\u6267\u884c: \u5728\u6d41\u91cf\u8bbf\u95ee\u7684\u65f6\u5019\u6267\u884c\u6cbb\u7406\u89c4\u5219</li> </ol>"},{"location":"chap3/2isba_Service_Find/#3-2-istio","title":"3-2 Istio\u6cbb\u7406\u89c4\u5219","text":"<ul> <li>VirtualService: Configuration affecting label/content routing, sni routing, etc.</li> <li>DestinationRule: Configuration affecting load balancing, outlier detection, etc.</li> <li>Gateway: Configuration affecting edge load balancer.</li> <li>ServiceEntry: Configuration affecting service registry. </li> <li>Sidecar: Configuration affecting network reachability of a sidecar.</li> <li>Envoy Filter: Configuration affecting insertion of custom Envoy filters.</li> </ul> <p>https://istio.io/docs/reference/config/istio.networking.v1alpha3/</p>"},{"location":"chap3/2isba_Service_Find/#3-3-istio-virtualservice","title":"3-3 Istio\u6d41\u91cf\u89c4\u5219: VirtualService","text":"<p>\u670d\u52a1\u8bbf\u95ee\u8def\u7531\u63a7\u5236\u3002</p> <p>\u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6\u7684\u8bf7\u6c42\u6d41\u5230\u54ea\u91cc\uff0c\u8fc7\u7a0b\u4e2d\u6cbb\u7406\u3002\u5305\u62ec\u8bf7\u6c42\u91cd\u5199\u3001\u91cd\u8bd5\u3001\u6545\u969c\u6ce8\u5165\u7b49\u3002</p> <pre><code>kind: VirtualService \nmetadata:\n  name: reviews \nspec:\n  hosts:\n  - reviews \n  http:\n  - match:\n   - headers: \n      Foo:\n       exact: bar \n  fault:\n   delay: \n    fixedDelay: 5s\n   abort:\n    percent: 10 \n    httpStatus: 400\n  route:\n  - destination:\n     host: reviews\n     subset: v2 \n  - route:\n    - destination: \n        host: reviews \n        subset: v1\n</code></pre> <p>\u534f\u8bae\u652f\u6301:</p> <pre><code>http      HTTPRoute[] \ntls       TLSRoute[] \ntcp       TCPRoute[]\n</code></pre> <p>HTTP\u534f\u8bae\u6d41\u91cf\u89c4\u5219:</p> <pre><code>Field            Type \nmatch            HTTPMatchRequest[]\nroute            HTTPRouteDestination[]\nredirect         HTTPRedirect\nrewrite          HTTPRewrite\ntimeout          google.protobuf.Duration \nretries          HTTPRetry\nfault            HTTPFaultInjection\nmirror           Destination\n</code></pre>"},{"location":"chap3/2isba_Service_Find/#3-4-istio-destinationrule","title":"3-4 Istio\u6d41\u91cf\u89c4\u5219: DestinationRule","text":"<p>\u76ee\u6807\u670d\u52a1\u7684\u7b56\u7565\uff0c\u5305\u62ec\u76ee\u6807\u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u8fde\u63a5\u6c60\u7ba1\u7406\u7b49</p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: DestinationRule\nmetadata:\n  name: reviews \nspec:\n host: reviews \n trafficPolicy:\n  loadBalancer:\n    simple: RANDOM\n subsets:\n - name: v1\n   labels: \n    version: v1\n - name: v2\n   labels: \n    version: v2\n   trafficPolicy: \n    loadBalancer:\n     simple: ROUND_ROBIN\n - name: v3\n   labels: \n     version: v3\n</code></pre> <pre><code>host            string\ntrafficPolicy   TrafficPolicy\nsubsets         Subset[]\n</code></pre> <pre><code>loadBalancer           LoadBalancerSettings\nconnectionPool         ConnectionPoolSettings\noutlierDetection       OutlierDetection \ntls                    TLSSettings\nportLevelSettings      TrafficPolicy.PortTrafficPolicy[]\n</code></pre> <pre><code>name             string\nlabels           map&lt;string, string&gt;\ntrafficPolicy    TrafficPolicy\n</code></pre>"},{"location":"chap3/2isba_Service_Find/#3-5-istio-serviceentry-gateway","title":"3-5 Istio\u6d41\u91cf\u89c4\u5219: ServiceEntry &amp; Gateway","text":""},{"location":"chap3/2isba_Service_Find/#serviceentry","title":"ServiceEntry:","text":"<ul> <li>\u529f\u80fd: <code>Mesh</code>\u5916\u7684\u670d\u52a1\u52a0\u5165\u5230\u670d\u52a1\u53d1\u73b0\u4e2d\uff0c\u5411<code>Mesh</code>\u91cc\u9762\u7684\u670d\u52a1\u4e00\u6837\u7684\u88ab\u6cbb\u7406</li> <li>\u673a\u5236: \u5c06<code>ServiceEntry</code>\u63cf\u8ff0\u7684\u670d\u52a1\u52a0\u5165\u5230\u670d\u52a1\u53d1\u73b0\u4e2d;\u5bf9\u8fd9\u4e9b\u670d\u52a1\u7684<code>outbound</code>\u6d41\u91cf\u8fdb\u884c\u62e6\u622a\uff0c\u8fdb\u800c\u8fdb\u884c\u6cbb\u7406</li> </ul>"},{"location":"chap3/2isba_Service_Find/#gateway","title":"Gateway:","text":"<ul> <li>\u529f\u80fd: \u5c06<code>mesh</code>\u5185\u7684\u4e00\u4e2a\u670d\u52a1\u53d1\u5e03\u6210\u53ef\u4f9b\u5916\u90e8\u8bbf\u95ee\u3002</li> <li>\u673a\u5236: \u5728\u5165\u53e3\u5904\u90e8\u7f72\u4e00\u4e2a<code>ingress</code>\u7684<code>Envoy</code>\uff0c\u5728\u5176\u4e0a\u6267\u884c\u670d\u52a1\u6cbb\u7406\u3002</li> </ul>"},{"location":"chap3/2isba_Service_Find/#3-6-istio","title":"3-6 Istio\u914d\u7f6e\u89c4\u5219\u7ef4\u62a4\u548c\u4e0b\u53d1\u6d41\u7a0b","text":""},{"location":"chap3/2isba_Service_Find/#3-7-istio-vs-envoy","title":"3-7 \u6cbb\u7406\u89c4\u5219\u5b9a\u4e49 Istio VS Envoy","text":""},{"location":"chap3/2isba_Service_Find/#istio","title":"Istio \u89c4\u5219","text":""},{"location":"chap3/2isba_Service_Find/#3-8-envoy","title":"3-8 Envoy\u89c4\u5219","text":""},{"location":"chap3/2isba_Service_Find/#3-9-istio","title":"3-9 Istio\u6cbb\u7406\u80fd\u529b\u6267\u884c\u4f4d\u7f6e","text":""},{"location":"chap3/2isba_Service_Find/#4istiokubernetes","title":"4\u3001Istio\u670d\u52a1\u53d1\u73b0&amp;\u89c4\u5219\u7ba1\u7406\u4e0eKubernetes\u7ed3\u5408","text":""},{"location":"chap3/2isba_Service_Find/#4-1-kubernetes-istio","title":"4-1 Kubernetes &amp; Istio \u7ed3\u5408","text":"<p>\u5bf9\u4e8e\u4e91\u539f\u751f\u5e94\u7528\uff0c\u91c7\u7528kubernetes\u6784\u5efa\u5fae\u670d\u52a1\u90e8\u7f72\u548c\u96c6\u7fa4\u7ba1\u7406\u80fd\u529b\uff0c\u91c7\u7528Istio\u6784\u5efa\u670d\u52a1\u6cbb\u7406\u80fd\u529b\uff0c\u5c06\u9010\u6e10\u6210\u4e3a\u5e94\u7528\u5fae\u670d\u52a1\u8f6c\u578b\u7684\u6807\u51c6\u914d\u7f6e\u3002</p> <p></p>"},{"location":"chap3/2isba_Service_Find/#4-2-istiok8s-internal","title":"4-2 \u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e\u7ba1\u7406: Istio+K8S (Internal)","text":"<p>Envoy</p> <ul> <li>1.\u6cbb\u7406\u548c\u4e1a\u52a1: Sidecar \u81ea\u52a8\u6ce8\u5165\uff0c\u81ea\u52a8\u63a5\u7ba1\u6d41\u91cf \uff0c\u5b9e\u73b0\u6cbb\u7406\u903b\u8f91\uff0c\u4e14\u4e0e\u4e1a\u52a1\u8fdb\u7a0b\u5206\u79bb\u3002</li> <li>2.\u6cbb\u7406\u5347\u7ea7: \u6cbb\u7406\u80fd\u529b\u5347\u7ea7\u4e0d\u5f71\u54cd\u4e1a\u52a1\u3002\u53ea\u9700\u5347\u7ea7<code>Istio</code>\u7ba1\u7406\u9762\u548c<code>Envoy</code>\u3002 \u4e1a\u52a1\u4ee3\u7801\u65e0\u611f\u77e5</li> </ul> <p>Istio</p> <ul> <li> <ol> <li>\u4e00\u81f4\u670d\u52a1\u53d1\u73b0: \u7edf \u4e00\u670d\u52a1\u53d1\u73b0 \u57fa\u4e8eK8S \u6570\u636e\u505a\u670d\u52a1\u53d1\u73b0</li> </ol> </li> </ul> <p>Kube-APIServer</p> <ul> <li> <ol> <li>\u6cbb\u7406\u89c4\u5219: \u6cbb\u7406\u89c4\u5219\u57fa\u4e8e<code>K8S CRD</code>\u5b9a\u4e49\uff0c \u65e0\u9700\u4e13\u95e8\u914d\u7f6e\u7ba1\u7406\u670d\u52a1</li> </ol> </li> <li> <ol> <li>\u670d\u52a1\u53d1\u73b0\u65b9\u5f0f:\u65e0\u9700\u4e13\u95e8\u670d\u52a1\u6ce8\u518c \u90e8\u7f72\u6210 <code>K8S Service</code>\u5373\u53ef</li> </ol> </li> </ul> <p></p>"},{"location":"chap3/2isba_Service_Find/#4-3-spring-cloudk8s","title":"4-3 \u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e\u7ba1\u7406: Spring Cloud+K8S","text":"<p>Pod+Java+SDK</p> <ol> <li>\u6cbb\u7406\u548c\u4e1a\u52a1:\u6cbb\u7406\u903b\u8f91\u548c\u4e1a\u52a1\u4ee3\u7801\u5171\u5b58</li> <li>\u6cbb\u7406\u5347\u7ea7:\u6cbb\u7406\u903b \u8f91\u5347\u7ea7\u7528\u6237\u4e1a\u52a1\u4e5f\u9700\u968f\u4e4b\u5347\u7ea7</li> </ol> <p>Service Registry (Eureka)</p> <ol> <li>\u670d\u52a1\u6ce8\u518c:\u4e1a\u52a1\u4ee3\u7801\u4e2d\u9700\u8981\u914d\u7f6e\u6ce8\u518c\u4e2d\u5fc3\u5730\u5740\uff0c\u672c\u670d\u52a1\u7684\u63cf\u8ff0\uff0c\u542f\u52a8\u65f6\u5019\u6ce8\u518c</li> <li>\u6cbb\u7406\u89c4\u5219:\u6cbb\u7406\u89c4\u5219\u548c\u670d\u52a1\u6ce8\u518c\u4e00\u8d77\uff0c\u83b7\u53d6\u5355\u72ec\u7684\u914d\u7f6e\u670d\u52a1</li> <li>\u670d\u52a1\u53d1\u73b0\u65b9\u5f0f:\u4e1a\u52a1\u4ee3\u7801\u4e2d\u9700\u8981\u914d\u7f6e\u6ce8 \u518c\u4e2d\u5fc3\u5730\u5740\uff0c\u83b7\u53d6\u76ee\u6807\u670d\u52a1\u5b9e\u4f8b\u4fe1\u606f</li> </ol> <p></p>"},{"location":"chap3/3isba_Gateway/","title":"\u7b2c\u56db\u8282 Gateway \u8bbe\u8ba1\u4e0e\u5b9e\u73b0","text":""},{"location":"chap3/3isba_Gateway/#_1","title":"\u76ee\u5f55","text":"<ul> <li>Gateway\u7b80\u4ecb</li> <li>Gateway vs Kubernetes Ingress </li> <li>Gateway\u539f\u7406\u53ca\u5b9e\u73b0</li> <li>Gateway demo\u6f14\u793a</li> </ul>"},{"location":"chap3/3isba_Gateway/#1gateway","title":"1\u3001Gateway\u7b80\u4ecb","text":"<p>\u5728Istio\u4e2d\uff0cGateway\u63a7\u5236\u7740\u7f51\u683c\u8fb9\u7f18\u7684\u670d\u52a1\u66b4\u9732\u3002</p> <p></p> <p>Ingress Gateway  +  Egress Gateway</p> <p>Gateway\u4e5f\u53ef\u4ee5\u770b\u4f5c\u7f51\u683c\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c \u63d0\u4f9b\u4ee5\u4e0b\u529f\u80fd:</p> <ul> <li>1) L4-L6\u7684\u8d1f\u8f7d\u5747\u8861</li> <li>2) \u5bf9\u5916\u7684<code>mTLS</code></li> </ul> <p><code>Istio</code>\u670d\u52a1\u7f51\u683c\u4e2d\uff0c<code>Gateway</code>\u53ef\u4ee5\u90e8\u7f72\u4efb\u610f\u591a\u4e2a\uff0c\u53ef\u4ee5\u5171\u7528\u4e00\u4e2a\uff0c \u4e5f\u53ef\u4ee5\u6bcf\u4e2a\u79df\u6237\u3001<code>namespace</code>\u5355\u72ec\u9694\u79bb\u3002</p> <p></p> <ul> <li>Port: number: 443  =&gt; Gateway \u76d1\u542c\u7684\u7aef\u53e3\u53ca\u534f\u8bae</li> <li>hosts: bookinfo.com =&gt; <code>Gateway</code>\u5141\u8bb8\u5916\u90e8\u8bbf\u95ee<code>host:bookinfo.com</code>\u7684 <code>https</code>\u6d41\u91cf\u8fdb\u53bb\u7f51\u683c\u5185</li> <li>tls  =&gt; TLS \u8bbe\u7f6e</li> </ul> <p></p> <p><code>VirtualService</code>\u5b9a\u4e49<code>Gateway L7</code>\u8def\u7531\uff0c \u4e3a\u8bbf\u95ee <code>bookinfo.com</code>\u7684<code>https</code>\u6d41\u91cf\uff0c\u63d0\u4f9b\u8def\u7531\u5339\u914d\u8f6c\u53d1\u7b56\u7565</p>"},{"location":"chap3/3isba_Gateway/#gatewayingress-gatewayegress-gateway","title":"Gateway\u6839\u636e\u6d41\u5165\u6d41\u51fa\u65b9\u5411\u5206\u4e3a<code>ingress gateway</code>\u548c<code>egress gateway</code>","text":"<p>Ingress gateway:</p> <p>\u63a7\u5236\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5185\u670d\u52a1\uff0c\u914d\u5408<code>VirtualService</code></p> <p>Egress gateway:</p> <p>\u63a7\u5236\u7f51\u683c\u5185\u670d\u52a1\u8bbf\u95ee\u5916\u90e8\u670d\u52a1, \u914d\u5408<code>DestinationRule</code> <code>ServiceEntry</code>\u4f7f\u7528</p>"},{"location":"chap3/3isba_Gateway/#2gateway-vs-kubernetes-ingress","title":"2\u3001Gateway vs Kubernetes Ingress","text":"<p><code>Kubernetes Ingress</code>\u96c6\u7fa4\u8fb9\u7f18\u8d1f\u8f7d\u5747\u8861\uff0c \u63d0\u4f9b\u96c6\u7fa4\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u5165\u53e3\uff0c\u4ec5\u652f\u6301L7\u8d1f\u8f7d\u5747\u8861\uff0c\u529f\u80fd\u5355\u4e00</p>"},{"location":"chap3/3isba_Gateway/#istio-10","title":"<code>Istio 1.0</code>\u4ee5\u524d","text":"<p>\u5229\u7528<code>Kubernetes Ingress</code>\u5b9e\u73b0\u7f51\u683c\u5185\u670d\u52a1\u66b4\u9732\u3002 \u4f46\u662f<code>Ingress</code>\u65e0\u6cd5\u5b9e\u73b0\u5f88\u591a\u529f\u80fd:</p> <ul> <li><code>L4-L6</code>\u8d1f\u8f7d\u5747\u8861 </li> <li>\u5bf9\u5916<code>mTLS</code></li> <li><code>SNI</code>\u7684\u652f\u6301</li> <li>\u5176\u4ed6<code>istio</code>\u4e2d\u5df2\u7ecf\u5b9e\u73b0\u7684\u5185\u90e8\u7f51\u7edc\u529f\u80fd: <code>Fault Injection</code>\uff0c <code>Traffic Shifting</code>\uff0c<code>Circuit Breaking</code>\uff0c <code>Mirroring</code></li> </ul>"},{"location":"chap3/3isba_Gateway/#istio10v1alpha3-api","title":"**\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u8fd9\u4e9b\u95ee\u9898\uff0cIstio\u57281.0\u7248\u672c\u8bbe\u8ba1\u4e86\u65b0\u7684<code>v1alpha3 API</code>\u3002","text":"<p>** * <code>Gateway</code>\u5141\u8bb8\u7ba1\u7406\u5458\u6307\u5b9a<code>L4-L6</code>\u7684\u8bbe\u7f6e:\u7aef\u53e3\u53caTLS\u8bbe\u7f6e\u3002 * \u5bf9\u4e8e<code>ingress</code> \u7684<code>L7</code>\u8bbe\u7f6e\uff0c<code>Istio</code>\u5141\u8bb8\u5c06<code>VirtualService</code>\u4e0e<code>Gateway</code>\u7ed1\u5b9a\u8d77\u6765\u3002 * \u5206\u79bb\u7684\u597d\u5904:\u7528\u6237\u53ef\u4ee5\u50cf\u4f7f\u7528\u4f20\u7edf\u7684\u8d1f\u8f7d\u5747\u8861\u8bbe\u5907\u4e00\u6837\u7ba1\u7406\u8fdb\u5165\u7f51\u683c\u5185\u90e8\u7684\u6d41\u91cf\uff0c\u7ed1\u5b9a\u865a\u62df<code>IP</code>\u5230\u865a\u62df\u670d\u52a1\u5668\u4e0a \u3002\u4fbf\u4e8e\u4f20\u7edf\u6280\u672f\u7528\u6237\u65e0\u7f1d\u8fc1\u79fb\u5230\u5fae\u670d\u52a1\u3002</p>"},{"location":"chap3/3isba_Gateway/#3gateway","title":"3\u3001Gateway\u539f\u7406\u53ca\u5b9e\u73b0","text":"<p><code>Gateway</code> \u4e0e \u666e\u901a<code>sidecar</code>\u5747\u662f\u4f7f\u7528<code>Envoy</code>\u4f5c\u4e3a<code>proxy</code>\u5b9e\u884c\u6d41\u91cf\u63a7\u5236\u3002</p> <ul> <li><code>Pilot</code>\u4e3a\u4e0d\u540c\u7c7b\u578b\u7684<code>proxy</code>\u751f\u6210\u76f8\u5e94\u7684\u914d\u7f6e</li> <li><code>Gateway</code>\u7684\u7c7b\u578b\u4e3a<code>router</code></li> <li><code>sidecar</code>\u7684\u7c7b\u578b\u4e3a<code>sidecar</code></li> </ul>"},{"location":"chap3/3isba_Gateway/#3-1-ingress-gateway","title":"3-1 Ingress Gateway \u542f\u52a8\u53c2\u6570:","text":"<pre><code>$ kubectl -n istio-system exec -ti istio-ingrssgateway-*** sh\n</code></pre>"},{"location":"chap3/3isba_Gateway/#3-2-sidecar","title":"3-2 Sidecar\u542f\u52a8\u53c2\u6570:","text":"<pre><code>$ kubectl -n istio-system exec -ti istio-proxy-*** sh\n</code></pre> <pre><code>$ ps -efww\n</code></pre>"},{"location":"chap3/3isba_Gateway/#3-3-pilotproxy","title":"3-3 Pilot\u5982\u4f55\u5f97\u77e5proxy\u7c7b\u578b?","text":"<p><code>Envoy</code>\u53d1\u73b0\u670d\u52a1\u4f7f\u7528\u7684\u662f<code>xDS</code>\u534f\u8bae\uff0c<code>Envoy</code>\u5411<code>server</code>\u7aef<code>pilot</code>\u53d1\u8d77\u8bf7\u6c42 <code>DiscoveryRequest</code> \u65f6\u4f1a\u643a\u5e26\u81ea\u8eab\u4fe1\u606f<code>node</code>\uff0c<code>node</code>\u6709\u4e00\u4e2a<code>ID</code>\u6807\u8bc6\uff0c <code>pilot</code>\u4f1a\u89e3\u6790<code>node</code>\u6807\u8bc6\u83b7\u53d6<code>proxy</code>\u7c7b\u578b\u3002</p> <p> <code>ANd</code> </p> <p><code>Envoy</code>\u7684\u8282\u70b9\u6807\u8bc6\u53ef\u4ee5\u901a\u8fc7\u9759\u6001\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u542f\u52a8\u53c2\u6570 <code>--service-node</code>\u6307\u5b9a</p> <p><code>Gateway</code>\u5bf9\u8c61\u5728<code>Istio</code>\u4e2d\u662f\u7528<code>CRD(CustomResourceDefinition)</code>\u58f0\u660e\u7684\uff0c\u53ef\u901a\u8fc7</p> <pre><code>$ kubectl get crd gateways.networking.istio.io \u9a8c\u8bc1\n</code></pre> <pre><code>$ kubectl get crd gateways.networking.istio.io -oyaml\n</code></pre> <p></p> <p><code>Istio networking</code>\u6240\u6709\u914d\u7f6e<code>API</code>\u5b9a\u4e49:</p> <p>https://github.com/istio/api/tree/master/networking/v1alpha3</p> <pre><code>type Gateway struct {\n    // REQUIRED: A list of server specifications.\n    Servers []*Server `protobuf:\"bytes,1,rep,name=servers\" json:\"servers,omitempty\"` // REQUIRED: One or more labels that indicate a specific set of pods/VMs\n    // on which this gateway configuration should be applied.\n    // The scope of label search is platform dependent.\n    // On Kubernetes, for example, the scope includes pods running in\n    // all reachable namespaces.\n    Selector map[string]string `protobuf:\"bytes,2,rep,name=selector\"\njson:\"selector,omitempty\" protobuf_key:\"bytes,1,opt,name=key,proto3\"\nprotobuf_val:\"bytes,2,opt,name=value,proto3\"`\n}\n</code></pre> <ul> <li><code>Servers []...</code>: \u5b9a\u4e49\u865a\u62df\u670d\u52a1\u5668\u7aef\u53e3\u534f\u8bae\uff0c<code>TLS</code>\u8bbe\u7f6e\u7b49</li> <li><code>Selector map[string]</code>: \u6807\u7b7e\u5339\u914d,<code>k8s</code>\u4e2d\u6240\u6709 <code>namespace</code>\u7684<code>pod</code>\u90fd\u4f1a\u8fdb\u884c\u5339\u914d</li> </ul> <pre><code>type Server struct {\n    // REQUIRED: The Port on which the proxy should listen for incoming\n    // connections\n    Port *Port `protobuf:\"bytes,1,opt,name=port\" json:\"port,omitempty\"`\n    // REQUIRED. A list of hosts exposed by this gateway. At least one\n    // host is required. While typically applicable to\n    // HTTP services, it can also be used for TCP services using TLS with\n    // SNI. May contain a wildcard prefix for the bottom-level component of\n    // a domain name. For example `*.foo.com` matches `bar.foo.com`\n    // and `*.com` matches `bar.foo.com`, `example.com`, and so on.\n    //\n    // **Note**: A `VirtualService` that is bound to a gateway must have one\n    // or more hosts that match the hosts specified in a server. The match\n    // could be an exact match or a suffix match with the server's hosts. For\n    // example, if the server's hosts specifies \"*.example.com\",\n    // VirtualServices with hosts dev.example.com, prod.example.com will\n    // match. However, VirtualServices with hosts example.com or\n    // newexample.com will not match.\n    Hosts []string `protobuf:\"bytes,2,rep,name=hosts\" json:\"hosts,omitempty\"`\n    // Set of TLS related options that govern the server's behavior. Use\n    // these options to control if all http requests should be redirected to\n    // https, and the TLS modes to use.\n    Tls *Server_TLSOptions `protobuf:\"bytes,3,opt,name=tls\" json:\"tls,omitempty\"`\n}\n</code></pre> <pre><code>type VirtualService struct {\n   Hosts []string `protobuf:\"bytes,1,rep,name=hosts\" json:\"hosts,omitempty\"`\n    Gateways []string `protobuf:\"bytes,2,rep,name=gateways\" json:\"gateways,omitempty\"`  // An ordered list of route rules for HTTP traffic. HTTP routes will be\n    // applied to platform service ports named 'http-*'/'http2-*'/'grpc-*', gateway // ports with protocol HTTP/HTTP2/GRPC/ TLS-terminated-HTTPS and service\n    // entry ports using HTTP/HTTP2/GRPC protocols. The first rule matching\n    // an incoming request is used.\n    Http []*HTTPRoute `protobuf:\"bytes,3,rep,name=http\" json:\"http,omitempty\"`\n    Tls []*TLSRoute `protobuf:\"bytes,5,rep,name=tls\"json:\"tls,omitempty\"`\n    Tcp []*TCPRoute `protobuf:\"bytes,4,rep,name=tcp\" json:\"tcp,omitempty\"` \n   ConfigScope ConfigScope\n}\n</code></pre> <ul> <li><code>Hosts []</code>: \u57df\u540d\uff0c\u6839\u636e\u5e73\u53f0\u7684\u4e0d\u901a\u53ef\u4ee5\u4e0d\u662f<code>FQDN</code></li> <li><code>Gateways</code>: Gateway\u9009\u62e9</li> <li><code>Http []</code>: HTTP\u8def\u7531</li> <li><code>Tcp []</code>: TCP\u8def\u7531</li> <li><code>ConfigScope</code>: \u89c4\u5219\u4f5c\u7528\u57df\uff0c <code>namespaced/meshscoped</code></li> </ul> <pre><code>// Describes match conditions and actions for routing HTTP/1.1, HTTP2, and \n// gRPC traffic. See VirtualService for usage examples.\ntype HTTPRoute struct {\n    Match []*HTTPMatchRequest `protobuf:\"bytes,1,rep,name=match\" json:\"match,omitempty\"` \n    Route []*HTTPRouteDestination `protobuf:\"bytes,2,rep,name=route\" json:\"route,omitempty\"` Redirect *HTTPRedirect `protobuf:\"bytes,3,opt,name=redirect\" json:\"redirect,omitempty\"` Rewrite *HTTPRewrite `protobuf:\"bytes,4,opt,name=rewrite\" json:\"rewrite,omitempty\"`\n       // Timeout for HTTP requests.\n    Timeout *google_protobuf.Duration `protobuf:\"bytes,6,opt,name=timeout\" json:\"timeout,omitempty\"` // Retry policy for HTTP requests.\n    Retries *HTTPRetry `protobuf:\"bytes,7,opt,name=retries\" json:\"retries,omitempty\"`\n       Fault *HTTPFaultInjection `protobuf:\"bytes,8,opt,name=fault\" json:\"fault,omitempty\"`\n    Mirror *Destination `protobuf:\"bytes,9,opt,name=mirror\" json:\"mirror,omitempty\"`\n    ...\n}\n</code></pre> <p><code>Redirect</code>: \u8def\u7531\u89c4\u5219</p>"},{"location":"chap3/3isba_Gateway/#3-4-gateway","title":"3-4 Gateway\u914d\u7f6e\u4e0b\u53d1:","text":"<p>\u9075\u5faa <code>make-before-break</code> \u539f\u5219\uff0c\u675c\u7edd\u89c4\u5219\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u51fa\u73b0<code>503</code></p> <p></p> <p><code>router</code>\u7c7b\u578b\u4e0e<code>sidecar</code>\u7c7b\u578b\u7684<code>proxy</code>\u6700\u672c\u8d28\u7684\u533a\u522b\u662f\u6ca1\u6709 <code>inbound cluster</code>\uff0c<code>endpoint</code>\uff0c <code>listener</code></p>"},{"location":"chap3/3isba_Gateway/#gateway_1","title":"\u8fd9\u4e5f\u4ece\u4fa7\u9762\u8bc1\u660e<code>Gateway</code>\u4e0d\u662f\u6d41\u91cf\u7684\u7ec8\u70b9\u53ea\u662f\u5145\u5f53\u4e00\u4e2a\u4ee3\u7406\u8f6c\u53d1\u3002","text":""},{"location":"chap3/3isba_Gateway/#3-5-gateway-demo","title":"3-5 Gateway demo\u6f14\u793a","text":"<ul> <li>\u63a7\u5236<code>Ingress HTTP</code>\u6d41\u91cf</li> <li>\u5229\u7528<code>HTTPS</code>\u4fdd\u62a4\u540e\u7aef\u670d\u52a1 </li> <li><code>mTLS</code></li> <li>\u63a7\u5236<code>egress</code>\u6d41\u91cf</li> </ul>"},{"location":"chap3/3isba_Gateway/#3-6","title":"3-6 \u7406\u89e3\u5916\u90e8\u8bf7\u6c42\u5982\u4f55\u5230\u8fbe\u5e94\u7528","text":"<ul> <li><code>Client</code>\u53d1\u8d77\u8bf7\u6c42\u5230\u7279\u5b9a\u7aef\u53e3</li> <li><code>Load Balancer</code> \u76d1\u542c\u5728\u8fd9\u4e2a\u7aef\u53e3\uff0c\u5e76\u8f6c\u53d1\u5230\u540e\u7aef</li> <li>\u5728<code>Istio</code>\u4e2d\uff0cLB\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230<code>IngressGateway</code> \u670d\u52a1</li> <li><code>Service</code>\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230<code>IngressGateway pod</code></li> <li><code>Pod</code> \u83b7\u53d6<code>Gateway</code> \u548c <code>VirtualService</code>\u914d\u7f6e\uff0c\u83b7\u53d6\u7aef\u53e3\u3001\u534f\u8bae\u3001\u8bc1\u4e66\uff0c\u521b\u5efa\u76d1\u542c\u5668</li> <li><code>Gateway pod</code> \u6839\u636e\u8def\u7531\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u5e94\u7528<code>pod</code>(\u4e0d\u662f <code>service</code>)</li> </ul>"},{"location":"chap3/3isba_Gateway/#3-7-ingress-http","title":"3-7 \u63a7\u5236<code>Ingress HTTP</code>\u6d41\u91cf","text":""},{"location":"chap3/3isba_Gateway/#_2","title":"\u521b\u5efa\u5e94\u7528","text":"<pre><code>$ kubectl apply -f samples/httpbin/httpbin.yaml\n</code></pre>"},{"location":"chap3/3isba_Gateway/#_3","title":"\u521b\u5efa\u89c4\u5219","text":"<pre><code>$ kubectl apply -f samples/httpbin/httpbin-gateway.yaml\n</code></pre> <p>\u8bbf\u95ee <code>http://139.159.236.125:31380/headers</code></p> <p></p>"},{"location":"chap3/3isba_Gateway/#cleanup","title":"Cleanup:","text":"<pre><code>$ kubectl delete gateway httpbin-gateway\n$ kubectl delete virtualservice httpbin\n$ kubectl delete -f samples/httpbin/httpbin.yaml\n</code></pre>"},{"location":"chap3/3isba_Gateway/#3-8-https-termination","title":"3-8 HTTPS termination","text":""},{"location":"chap3/3isba_Gateway/#_4","title":"\u751f\u6210\u8bc1\u4e66","text":"<pre><code>https://istio.io/docs/tasks/traffic-management/secure-ingress/#generate-client-and-server-certificates-and-keys\n</code></pre>"},{"location":"chap3/3isba_Gateway/#secretistio-ingressgateway-certsmount","title":"\u521b\u5efasecret:\u540d\u79f0\u4e00\u5b9a\u662f<code>istio-ingressgateway-certs</code>\uff0c\u5426\u5219<code>mount</code>\u4e0d\u4e0a","text":"<pre><code>$ kubectl create -n istio-system secret tls istio-ingressgateway-certs --key httpbin.example.com/3_application/private/httpbin.example.com.key.pem --cert httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem\n</code></pre>"},{"location":"chap3/3isba_Gateway/#_5","title":"\u521b\u5efa\u5e94\u7528","text":"<pre><code>$ kubectl apply -f samples/httpbin/httpbin.yaml\n</code></pre>"},{"location":"chap3/3isba_Gateway/#_6","title":"\u521b\u5efa\u8def\u7531\u89c4\u5219","text":"<pre><code>$ kubectl apply -f samples/httpbin/httpbin-gateway-https.yaml\n</code></pre>"},{"location":"chap3/3isba_Gateway/#https","title":"\u901a\u8fc7HTTPS\u8bbf\u95ee","text":"<pre><code>$ curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:31390:100.109.176.196 -- cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem https://httpbin.example.com:31390/status/418\n</code></pre>"},{"location":"chap3/3isba_Gateway/#3-9-mtls","title":"3-9 mTLS","text":""},{"location":"chap3/3isba_Gateway/#casecret","title":"\u521b\u5efa\u5305\u542b<code>CA</code>\u8bc1\u4e66\u7684<code>secret</code>","text":"<pre><code>kubectl create -n istio-system secret generic istio-ingressgateway-ca-certs --from-file=httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem\n</code></pre>"},{"location":"chap3/3isba_Gateway/#gateway-tls-setting","title":"\u66f4\u65b0<code>Gateway TLS setting</code>","text":""},{"location":"chap3/3isba_Gateway/#https_1","title":"\u901a\u8fc7HTTPS\u8bbf\u95ee","text":"<pre><code>$ curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:31390:139.159.236.125 -- cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem https://httpbin.example.com:31390/status/418\n</code></pre> <pre><code>curl: (35) error:14094410:SSL routines:SSL3_READ_BYTES:sslv3 alert handshake failure\n</code></pre> <pre><code>$ curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:31390:139.159.236.125 --cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem --cert httpbin.example.com/4_client/certs/httpbin.example.com.cert.pem --key httpbin.example.com/4_client/private/httpbin.example.com.key.pem https://httpbin.example.com:31390/status/418\n</code></pre> <p>Gateway\u8981\u9a8c\u8bc1\u5ba2\u6237\u7aef\u7684\u8bc1\u4e66\uff0c\u6240\u4ee5\u5fc5\u987b\u643a\u5e26\u8bc1\u4e66\u624d\u80fd\u8bbf\u95ee</p> <p></p>"},{"location":"chap3/3isba_Gateway/#3-10-istio","title":"3-10 Istio\u8bbf\u95ee\u5916\u90e8\u670d\u52a1","text":"<p>Istio\u7f51\u683c\u5185\u9ed8\u8ba4\u4e0d\u80fd\u8bbf\u95ee\u5916\u90e8\u670d\u52a1\uff0c\u5982\u679c\u9700\u8981\u8bbf\u95ee\u5916\u90e8\u670d\u52a1\u6709\u4e09\u79cd\u65b9\u5f0f:</p>"},{"location":"chap3/3isba_Gateway/#istio","title":"Istio\u5b89\u88c5\u65f6\u8bbe\u7f6e:","text":"<pre><code>--set global.proxy.includeIPRanges=\"10.0.0.1/24\"\n</code></pre>"},{"location":"chap3/3isba_Gateway/#pod-annotation","title":"\u521b\u5efa\u5e94\u7528\u65f6\u6307\u5b9apod annotation","text":"<pre><code>traffic.sidecar.istio.io/includeOutboundIPRanges: \"127.0.0.1/24,10.96.0.1/24\u201c\n</code></pre>"},{"location":"chap3/3isba_Gateway/#serviceentry","title":"\u521b\u5efa<code>ServiceEntry</code>","text":"<p>\u5141\u8bb8\u96c6\u7fa4\u5185\u8bbf\u95ee\u5916\u90e8\u670d\u52a1 <code>http://httpbin.org:80</code></p>"},{"location":"chap3/3isba_Gateway/#3-11-egress-gateway","title":"3-11 \u901a\u8fc7<code>egress gateway</code>\u63a7\u5236\u8bbf\u95ee\u5916\u90e8\u670d\u52a1","text":"<p>\u8bbf\u95ee: <code>https://edition.cnn.com/politics</code></p> <p></p> <ul> <li>1) \u521b\u5efa<code>ServiceEntry</code>\uff0c\u5141\u8bb8\u8bbf\u95ee<code>edtion.cnn.com</code> </li> <li>2) \u521b\u5efa <code>Gateway</code>\uff0c\u6307\u5b9a<code>egress gateway</code>\u76d1\u542c\u7aef\u53e3</li> <li>3) \u521b\u5efa<code>VirtualService</code>\uff0c\u6307\u5b9a\u8def\u7531\u89c4\u5219\uff0c</li> <li>\u7f51\u683c\u5185\u666e\u901a\u5e94\u7528\u8bbf\u95ee<code>edtion.cnn.com:443</code>\uff0c\u5168\u90e8 \u8f6c\u53d1\u5230<code>egress-gateway</code>\uff0c <code>egress-gateway</code>\u900f\u660e\u8f6c\u53d1</li> <li>4) \u521b\u5efa<code>DestinationRule</code>\uff0c\u6307\u5b9a<code>subset</code></li> </ul> <p> </p> <p> </p>"},{"location":"chap3/4isba_Gray_release/","title":"\u7b2c\u4e94\u8282 Istio \u7070\u5ea6\u53d1\u5e03\u4e0e\u6280\u672f\u5b9e\u73b0","text":""},{"location":"chap3/4isba_Gray_release/#_1","title":"\u5927\u7eb2","text":"<ul> <li>\u5178\u578b\u53d1\u5e03\u7c7b\u578b\u5bf9\u6bd4</li> <li>Istio\u6d41\u91cf\u6cbb\u7406\u6280\u672f\u89e3\u6790</li> <li>\u667a\u80fd\u7070\u5ea6\u53d1\u5e03\u4ecb\u7ecd</li> <li>\u7070\u5ea6\u53d1\u5e03\u529f\u80fd\u5c55\u793aDemo</li> </ul>"},{"location":"chap3/4isba_Gray_release/#1","title":"1\u3001\u53d1\u5e03\u7c7b\u578b","text":"<ul> <li>\u84dd\u7eff\u53d1\u5e03</li> <li>\u7070\u5ea6\u53d1\u5e03(\u91d1\u4e1d\u96c0\u53d1\u5e03) </li> <li>A/B Test</li> </ul>"},{"location":"chap3/4isba_Gray_release/#1-1","title":"1-1 \u84dd\u7eff\u53d1\u5e03","text":"<ol> <li>Green * 3 =&gt; ELB</li> <li>Blue * 3 CREATED</li> <li>Blue * 3 =&gt; ELB</li> <li>Green * 3 Deleted</li> </ol>"},{"location":"chap3/4isba_Gray_release/#1-2","title":"1-2 \u91d1\u4e1d\u96c0\u53d1\u5e03","text":"<ol> <li>Green * 3 * 100% =&gt; ELB</li> <li>Blue * 3 CREATED</li> <li>Green * 3 * 90% +  Blue * 3 * 10% =&gt; ELB</li> <li>Blue * 3 * 100% =&gt; ELB</li> </ol>"},{"location":"chap3/4isba_Gray_release/#1-3-ab-test","title":"1-3 A/B Test","text":"<ol> <li> <p>V1 * 3 + V2 * 3 =&gt; ELB</p> </li> <li> <p>\u914d\u7f6e\u7b56\u7565</p> </li> <li>\u76d1\u63a7\u6307\u6807</li> <li>\u5206\u6790\u6570\u636e</li> <li>\u4f5c\u51fa\u51b3\u7b56</li> <li>\u6267\u884c\u51b3\u7b56</li> </ol> <p><code>A/B Test</code>\u4e3b\u8981\u5bf9\u7279\u5b9a\u7528\u6237\u91c7\u6837\u540e\uff0c\u5bf9\u6536\u96c6\u5230\u7684\u53cd\u9988\u6570\u636e\u505a\u76f8\u5173\u5bf9\u6bd4\uff0c\u7136\u540e\u6839\u636e\u6bd4\u5bf9\u7ed3\u679c\u4f5c\u51fa\u51b3\u7b56\u3002</p> <p>\u7528\u6765\u6d4b\u8bd5\u5e94\u7528\u529f\u80fd\u8868\u73b0\u7684\u65b9\u6cd5\uff0c\u4fa7\u91cd\u5e94\u7528\u7684\u53ef\u7528\u6027\uff0c\u53d7\u6b22\u8fce\u7a0b\u5ea6\u7b49\u3002</p>"},{"location":"chap3/4isba_Gray_release/#2istio","title":"2\u3001Istio \u6d41\u91cf\u7ba1\u7406","text":""},{"location":"chap3/4isba_Gray_release/#2-1","title":"2-1 \u914d\u7f6e\u89c4\u5219 \ud83d\udc4d","text":"<ul> <li><code>VirtualService</code> \u5728 Istio \u670d\u52a1\u7f51\u683c\u4e2d\u5b9a\u4e49\u8def\u7531\u89c4\u5219\uff0c\u63a7\u5236\u8def\u7531\u5982\u4f55\u8def\u7531\u5230\u670d\u52a1\u4e0a\u3002</li> <li><code>DestinationRule</code> \u662f <code>VirtualService</code> \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6\u3002</li> <li><code>ServiceEntry</code> \u662f\u901a\u5e38\u7528\u4e8e\u5728 Istio \u670d\u52a1\u7f51\u683c\u4e4b\u5916\u542f\u7528\u5bf9\u670d\u52a1\u7684\u8bf7\u6c42\u3002</li> <li><code>Gateway</code> \u4e3a <code>HTTP/TCP</code> \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u6700\u5e38\u89c1\u7684\u662f\u5728\u7f51\u683c\u7684\u8fb9\u7f18\u7684\u64cd\u4f5c\uff0c\u4ee5\u542f\u7528\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\u6d41\u91cf\u3002</li> </ul>"},{"location":"chap3/4isba_Gray_release/#2-2-destinationrule","title":"2-2 DestinationRule","text":"<pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: DestinationRule\nmetadata:\n name: bookinfo-ratings \nspec:\n host: ratings.prod.svc.cluster.local \n trafficPolicy:\n  loadBalancer: \n   simple: RANDOM\n subsets:\n - name: v3\n labels: \n  version: v3\n trafficPolicy: \n  loadBalancer:\n   simple: ROUND_ROBIN\n</code></pre> <p>DestinationRule \u6240\u5b9a\u4e49\u7684\u7b56\u7565\uff0c\u51b3\u5b9a\u4e86\u7ecf\u8fc7\u8def\u7531\u5904\u7406\u4e4b\u540e\u7684\u6d41\u91cf\u7684\u8bbf\u95ee\u7b56\u7565\u3002</p> <ul> <li>host \u2014\u2014 \u76ee\u6807\u670d\u52a1\u7684\u540d\u79f0</li> <li>trafficPolicy \u2014\u2014 \u6d41\u91cf\u7b56\u7565(\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u3001\u8fde\u63a5\u6c60\u914d\u7f6e\u548c\u7194\u65ad\u914d\u7f6e)\u3002 </li> <li>subsets \u2014\u2014 \u4e00\u4e2a\u6216\u591a\u4e2a\u670d\u52a1\u7248\u672c</li> </ul>"},{"location":"chap3/4isba_Gray_release/#2-3-virtualservice","title":"2-3 Virtualservice","text":"<pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: VirtualService\nmetadata:\n name: myapp-route \n spec:\n  gateways: \n  - mesh \n  hosts:\n  - myapp \n  http:\n  - match:\n   - port: 3711 \n   route:\n   - destination:\n      host: myapp \n      port:\n       number: 8080 \n      subset: v1\ntcp:\n- match:\n - port: 3721 \n route:\n - destination:\n    host: myapp \n    port:\n     number: 8009\n</code></pre> <p><code>VirtualService</code> \u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217\u9488\u5bf9\u6307\u5b9a\u670d\u52a1\u7684\u6d41\u91cf\u8def\u7531\u89c4\u5219\u3002</p> <ul> <li><code>hosts</code> \u2014\u2014 \u6d41\u91cf\u7684\u76ee\u6807\u4e3b\u673a</li> <li><code>gateways</code> \u2014\u2014 Gateway\u540d\u79f0\u5217\u8868</li> <li><code>http</code> \u2014\u2014 <code>HTTP</code> \u6d41\u91cf\u89c4\u5219(<code>HTTPRoute</code>)\u7684\u5217\u8868</li> <li><code>tcp</code> \u2014\u2014 <code>tcp</code>\u6d41\u91cf\u89c4\u5219(<code>TCPRoute</code>)\u7684\u5217\u8868</li> <li><code>tls</code> \u2014\u2014 <code>tls</code>\u548c<code>https</code>(TLSRoute)\u6d41\u91cf\u89c4\u5219\u7684\u5217\u8868</li> </ul> <pre><code>HTTPRoute \nHttpMatchRequest(uri,headers,port,method......) \nDestinationWeight(destination\uff0cweight) \nRedirect\nRewrite\nTimeout\nRetries\n......\n</code></pre> <pre><code>TCPRoute \nL4MatchAttributes(destinationSubnets,port......) \nDestinationWeight(destination\uff0cweight)\n</code></pre>"},{"location":"chap3/4isba_Gray_release/#2-4","title":"2-4 \u57fa\u4e8e\u6743\u91cd\u7684\u8def\u7531","text":"<pre><code>apiVersion: ...\nkind: VirtualService \nmetadata:\n name: vs-svcb \nspec:\n hosts: \n - svcb \n http:\n  route:\n  - destination:\n     name: v1 \n    weight: 20\n  - destination: \n     name: v2 \n    weight: 80\n</code></pre>"},{"location":"chap3/4isba_Gray_release/#2-5","title":"2-5 \u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u8def\u7531","text":"<pre><code>apiVersion: ...\nkind: VirtualService \nmetadata:\n name: ratings-route \nspec:\n hosts:\n - svcb \n http:\n - match:\n  - headers: cookie:\n     exact: \u201cgroup=dev\u201d \n  route:\n  - destination: \n     name: v1\n - route:\n  - destination:\n     name: v2\n</code></pre>"},{"location":"chap3/4isba_Gray_release/#2-6-virtualservice","title":"2-6 \u590d\u6742\u7070\u5ea6\u573a\u666f\u4e0b\u7684VirtualService","text":"<pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: VirtualService\nmetadata:\n name: helloworld \nspec:\n hosts:\n  - helloworld\n http:\n  - match:\n  - headers: \n     cookie:\n      regex: \"^(.*?;)?(email=[^;]*@some-company-name.com)(;.*)?$\"\n  route:\n   - destination:\n      host: helloworld\n      subset: v1 \n     weight: 50\n   - destination: \n      host: helloworld \n       subset: v2\n     weight: 50\n  - route:\n   - destination:\n      host: helloworld \n      subset: v1\n</code></pre>"},{"location":"chap3/4isba_Gray_release/#2-7","title":"2-7 \u7070\u5ea6\u7248\u672c\u5b58\u5728\u5f62\u5f0f","text":"<pre><code>kind: Deployment \nmetadata:\n name: rating-v1 \nspec:\n replicas: 2 \n template:\n  metadata: \n   labels:\n    app: rating\n    version: v1\n   spec:\n    containers:\n    - image: rating-v1\n    ...\n</code></pre> <pre><code>kind: Deployment \nmetadata:\n name: rating-v2 \nspec:\n replicas: 3 \ntemplate:\n metadata: \n  labels:\n   app: rating\n   version: v2\n spec:\n  containers:\n  - image: rating-v2\n...\n</code></pre>"},{"location":"chap3/4isba_Gray_release/#2-8","title":"2-8 \u7070\u5ea6\u53d1\u5e03\u6d41\u7a0b","text":""},{"location":"chap3/4isba_Gray_release/#3","title":"3\u3001\u667a\u80fd\u7070\u5ea6\u53d1\u5e03","text":"<p>\u76ee\u6807:\u7ec6\u7c92\u5ea6\u63a7\u5236\u7684\u81ea\u52a8\u5316\u7684\u6301\u7eed\u4ea4\u4ed8</p>"},{"location":"chap3/4isba_Gray_release/#3-1","title":"3-1 \u7279\u70b9:","text":"<ul> <li>\u7528\u6237\u7ec6\u5206</li> <li>\u6d41\u91cf\u7ba1\u7406</li> <li>\u5173\u952e\u6307\u6807\u53ef\u89c2\u6d4b</li> <li>\u53d1\u5e03\u6d41\u7a0b\u81ea\u52a8\u5316</li> </ul>"},{"location":"chap3/4isba_Gray_release/#3-2","title":"3-2 \u667a\u80fd\u7070\u5ea6\u53d1\u5e03","text":""},{"location":"chap3/4isba_Gray_release/#3-3","title":"3-3 \u81ea\u9002\u5e94\u7070\u5ea6\u53d1\u5e03\u53c2\u6570","text":"<ul> <li>\u8d1f\u8f7d\u5065\u5eb7\u72b6\u6001</li> <li>\u8bf7\u6c42\u6210\u529f\u7387</li> <li>\u5e73\u5747\u8bf7\u6c42\u65f6\u5ef6</li> <li>\u6d41\u91cf\u6743\u91cd\u6b65\u957f</li> <li>\u56de\u6eda\u95e8\u9650\u503c</li> </ul>"},{"location":"chap3/4isba_Gray_release/#3-4","title":"3-4 \u76d1\u63a7\u6307\u6807","text":""},{"location":"chap3/4isba_Gray_release/#red","title":"RED","text":"<ul> <li>(Request) Rate - the number of requests, per second, your services are serving.</li> <li>(Request) Errors - the number of failed requests per second.</li> <li>(Request) Duration - The amount of time each request takes expressed as a time interval</li> </ul>"},{"location":"chap3/4isba_Gray_release/#useutilizationsaturationerrors","title":"USE(utilization\uff0csaturation\uff0cerrors)","text":"<ul> <li>CPUs: sockets, cores, hardware threads (virtual CPUs)</li> <li>Memory: capacity</li> <li>Network interfaces</li> <li>Storage devices: I/O, capacity</li> <li>Controllers: storage, network cards</li> <li>Interconnects: CPUs, memory, I/O</li> </ul>"},{"location":"chap3/4isba_Gray_release/#3-5-flagger","title":"3-5 flagger","text":"<p>Flagger is a Kubernetes operator that automates the promotion of canary deployments using Istio routing for traffic shifting and Prometheus metrics for canary analysis.</p> <p>Details about flagger</p> <p></p> <p></p>"},{"location":"chap3/4isba_Gray_release/#3-6","title":"3-6 \u76f8\u5173\u94fe\u63a5","text":"<ul> <li>https://github.com/stefanprodan/flagger</li> <li>https://github.com/magneticio/vamp2setup/blob/master/BASIC_TUTORIAL.md </li> <li>https://github.com/intuit/wasabi</li> </ul>"},{"location":"chap3/5isba_Xds/","title":"\u7b2c\u516d\u8282 xDS\u534f\u8bae\u89e3\u6790","text":""},{"location":"chap3/5isba_Xds/#_1","title":"\u76ee\u5f55","text":"<ul> <li>xDS\u57fa\u672c\u6982\u5ff5 </li> <li>xDS\u534f\u8bae\u5206\u6790 </li> <li>ADS\u7406\u89e3</li> <li>xDS\u7684\u672a\u6765</li> </ul>"},{"location":"chap3/5isba_Xds/#istio","title":"Istio \u53d1\u73b0\u6a21\u578b","text":""},{"location":"chap3/5isba_Xds/#1xds","title":"1\u3001xDS\u662f\u4ec0\u4e48","text":"<p><code>xDS</code>\u662f\u4e00\u7c7b\u53d1\u73b0\u670d\u52a1\u7684\u603b\u79f0\uff0c\u5305\u542b<code>LDS</code>\uff0c<code>RDS</code>\uff0c<code>CDS</code>\uff0c<code>EDS</code>\u4ee5\u53ca <code>SDS</code>\u3002</p> <p><code>Envoy</code>\u901a\u8fc7<code>xDS API</code>\u53ef\u4ee5\u52a8\u6001\u83b7\u53d6<code>Listener(\u76d1\u542c\u5668)</code>\uff0c <code>Route(\u8def\u7531)</code>\uff0c<code>Cluster(\u96c6\u7fa4)</code>\uff0c<code>Endpoint(\u96c6\u7fa4\u6210\u5458)</code>\u4ee5\u53ca<code>Secret(\u8bc1\u4e66)</code>\u914d\u7f6e\u3002</p>"},{"location":"chap3/5isba_Xds/#1-1-lds-listener","title":"1-1 LDS (listener)","text":"<p><code>Listener</code> \u53d1\u73b0\u670d\u52a1\u3002</p> <p><code>Listener</code>\u76d1\u542c\u5668\u63a7\u5236<code>Envoy</code>\u542f\u52a8\u7aef\u53e3\u76d1\u542c (\u76ee\u524d\u53ea\u652f\u6301TCP\u534f\u8bae)\uff0c\u5e76\u914d\u7f6e<code>L3/L4</code>\u5c42\u8fc7\u6ee4\u5668\uff0c\u5f53\u7f51\u7edc\u8fde\u63a5\u8fbe\u5230\u540e\uff0c\u914d\u7f6e\u597d\u7684\u7f51\u7edc\u8fc7\u6ee4\u5668\u5806\u6808\u5f00\u59cb\u5904\u7406\u540e\u7eed\u4e8b\u4ef6\u3002</p> <p>\u8fd9\u79cd\u901a\u7528\u7684\u76d1\u542c\u5668\u4f53\u7cfb\u7ed3\u6784\u7528\u4e8e\u6267\u884c\u5927\u591a\u6570\u4e0d\u540c\u7684\u4ee3\u7406\u4efb\u52a1(\u9650\u6d41\uff0c\u5ba2\u6237\u7aef\u8ba4\u8bc1\uff0cHTTP\u8fde\u63a5\u7ba1\u7406\uff0cTCP\u4ee3\u7406\u7b49)\u3002</p>"},{"location":"chap3/5isba_Xds/#1-2-rds-route","title":"1-2 RDS (Route)","text":"<p><code>Route</code>\u53d1\u73b0\u670d\u52a1\uff0c\u7528\u4e8e<code>HTTP</code>\u8fde\u63a5\u7ba1\u7406\u8fc7\u6ee4\u5668\u52a8\u6001\u83b7\u53d6\u8def\u7531\u914d\u7f6e\u3002</p> <p>\u8def\u7531\u914d\u7f6e\u5305\u542b<code>HTTP</code>\u5934\u90e8\u4fee\u6539(\u589e\u52a0\u3001\u5220\u9664HTTP\u5934\u90e8\u952e\u503c)\uff0c <code>virtual hosts\u00b7 (\u865a\u62df\u4e3b\u673a)\uff0c\u4ee5\u53ca</code>virtual hosts` \u5b9a\u4e49\u7684\u5404\u4e2a\u8def\u7531\u6761\u76ee\u3002</p>"},{"location":"chap3/5isba_Xds/#1-3-cds-cluster","title":"1-3 CDS (cluster)","text":"<p><code>Cluster</code>\u53d1\u73b0\u670d\u52a1\uff0c\u7528\u4e8e\u52a8\u6001\u83b7\u53d6<code>Cluster</code>\u4fe1\u606f\u3002</p> <p><code>Envoy cluster</code> \u7ba1\u7406\u5668\u7ba1\u7406\u7740\u6240\u6709\u7684\u4e0a\u6e38<code>cluster</code>\u3002</p> <p>\u9274\u4e8e\u4e0a\u6e38<code>cluster</code>\u6216\u8005\u4e3b\u673a\u53ef\u7528\u4e8e\u4efb\u4f55\u4ee3\u7406\u8f6c\u53d1\u4efb\u52a1\uff0c\u6240\u4ee5\u4e0a\u6e38<code>cluster</code>\u4e00\u822c\u4ece<code>Listener</code>\u6216<code>Route</code>\u4e2d\u62bd\u8c61\u51fa\u6765\u3002</p>"},{"location":"chap3/5isba_Xds/#1-4-eds-endpoint","title":"1-4 EDS (Endpoint)","text":"<p><code>Endpoint</code>\u53d1\u73b0\u670d\u52a1\u3002</p> <p>\u5728<code>Envoy</code>\u672f\u8bed\u4e2d\uff0c<code>Cluster</code>\u6210\u5458\u5c31\u53eb <code>Endpoint</code>\uff0c\u5bf9\u4e8e\u6bcf\u4e2a<code>Cluster</code>\uff0c<code>Envoy</code>\u901a\u8fc7<code>EDS API</code>\u52a8\u6001\u83b7\u53d6 <code>Endpoint</code>\u3002</p> <p><code>EDS</code>\u4f5c\u4e3a\u9996\u9009\u7684\u670d\u52a1\u53d1\u73b0\u7684\u539f\u56e0\u6709\u4e24\u70b9:</p> <ul> <li>\u4e0e\u901a\u8fc7<code>DNS</code>\u89e3\u6790\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u8def\u7531\u76f8\u6bd4\uff0c<code>Envoy</code>\u80fd\u660e\u786e\u7684\u77e5\u9053\u6bcf\u4e2a\u4e0a\u6e38\u4e3b\u673a\u7684\u4fe1\u606f\uff0c\u56e0\u800c\u53ef\u4ee5\u505a\u51fa\u66f4\u52a0\u667a\u80fd\u7684\u8d1f\u8f7d \u5747\u8861\u51b3\u7b56\u3002</li> <li>** <code>Endpoint</code>\u914d\u7f6e\u5305\u542b\u8d1f\u8f7d\u5747\u8861\u6743\u91cd\u3001\u53ef\u7528\u57df\u7b49\u9644\u52a0\u4e3b\u673a\u5c5e\u6027\uff0c \u8fd9\u4e9b\u5c5e\u6027\u53ef\u7528\u57df\u670d\u52a1\u7f51\u683c\u8d1f\u8f7d\u5747\u8861\uff0c\u7edf\u8ba1\u6536\u96c6\u7b49\u8fc7\u7a0b\u4e2d**</li> </ul>"},{"location":"chap3/5isba_Xds/#1-5-sds-secret","title":"1-5 SDS (Secret)","text":"<p><code>Secret</code>\u53d1\u73b0\u670d\u52a1\uff0c\u7528\u4e8e\u8fd0\u884c\u65f6\u52a8\u6001\u83b7\u53d6<code>TLS</code>\u8bc1\u4e66\u3002</p> <p>\u82e5\u6ca1\u6709<code>SDS</code>\u7279\u6027\uff0c\u5728<code>k8s</code>\u73af\u5883\u4e2d\uff0c\u5fc5\u987b\u521b\u5efa\u5305\u542b\u8bc1\u4e66\u7684<code>Secret</code>\uff0c\u4ee3\u7406\u542f\u52a8\u524d <code>Secret</code>\u5fc5\u987b\u6302\u8f7d\u5230<code>sidecar</code>\u5bb9\u5668\u4e2d\uff0c\u5982\u679c\u8bc1\u4e66\u8fc7\u671f\uff0c\u5219\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u3002</p> <p>\u4f7f\u7528<code>SDS</code>\uff0c\u96c6\u4e2d\u5f0f\u7684<code>SDS</code> \u670d\u52a1\u5668\u5c06\u8bc1\u4e66\u5206\u53d1\u7ed9\u6240\u6709\u7684 <code>Envoy</code>\u5b9e\u4f8b\uff0c\u5982\u679c\u8bc1\u4e66\u8fc7\u671f\uff0c\u670d\u52a1\u5668\u4f1a\u5c06\u65b0\u7684\u8bc1\u4e66\u5206\u53d1\uff0c<code>Envoy</code>\u63a5\u6536\u5230\u65b0\u7684\u8bc1\u4e66\u540e\u91cd\u65b0\u52a0\u8f7d\u513f\u4e0d\u7528\u91cd\u65b0\u90e8\u7f72\u3002</p>"},{"location":"chap3/5isba_Xds/#1-6-xds","title":"1-6 \u6807\u51c6xDS\u6d41\u7a0b","text":""},{"location":"chap3/5isba_Xds/#2xds","title":"2\u3001xDS\u534f\u8bae","text":"<p><code>xDS</code>\u534f\u8bae\u662f<code>Envoy</code>\u83b7\u53d6\u914d\u7f6e\u4fe1\u606f\u7684\u4f20\u8f93\u534f\u8bae\uff0c\u4e5f\u662f<code>Istio</code>\u4e0e<code>Envoy</code> \u8fde\u63a5\u7684\u6865\u6881\u3002</p> <p><code>Envoy</code>\u52a8\u6001\u7684\u53d1\u73b0\u670d\u52a1\u4ee5\u53ca\u76f8\u5173\u8d44\u6e90\u7684<code>API</code>\u5c31\u662f\u6307<code>xDS</code>\u3002</p> <p><code>xDS</code>\u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u627f\u8f7d:<code>gRPC</code>(new)\u3001<code>REST</code>\uff0c\u8fd9\u4e24\u79cd\u65b9\u5f0f\u90fd\u662f\u901a\u8fc7 <code>xDS-API</code>\u53d1\u9001<code>DiscoveryRequest</code>\u8bf7\u6c42\uff0c\u7136\u540e\u8d44\u6e90\u901a\u8fc7 <code>DiscoveryResponse</code>\u4e0b\u53d1\u3002</p>"},{"location":"chap3/5isba_Xds/#2-1-discoveryrequest","title":"2-1 DiscoveryRequest","text":""},{"location":"chap3/5isba_Xds/#2-2-discoveryresponse","title":"2-2 DiscoveryResponse","text":""},{"location":"chap3/5isba_Xds/#3what-is-ads","title":"3\u3001What is ADS","text":"<p><code>ADS</code>\u662f\u4e00\u79cd<code>xDS</code>\u7684\u5b9e\u73b0, \u5b83\u57fa\u4e8e<code>gRPC</code>\u957f\u8fde\u63a5\u3002<code>gRPC</code>\u7684\u5b9e\u73b0\u662f\u627f\u8f7d\u5728<code>HTTP/2</code>\u4e4b\u4e0a\u3002</p> <p></p>"},{"location":"chap3/5isba_Xds/#3-1-why-ads","title":"3-1 Why ADS","text":"<p>Istio 0.8\u4ee5\u524d\uff0cPilot\u63d0\u4f9b\u7684\u7684\u5355\u4e00\u8d44\u6e90\u7684DS</p> <p></p> <ul> <li>\u6bcf\u79cd\u8d44\u6e90\u9700\u8981\u4e00\u6761\u5355\u72ec\u7684\u8fde\u63a5</li> <li>Istio\u9ad8\u53ef\u7528\u73af\u5883\u4e0b\uff0c\u53ef\u80fd\u90e8\u7f72\u591a\u4e2a<code>Pilot</code></li> </ul>"},{"location":"chap3/5isba_Xds/#_2","title":"\u5e26\u6765\u7684\u6311\u6218:","text":"<ul> <li>\u6ca1\u529e\u6cd5\u4fdd\u8bc1\u914d\u7f6e\u8d44\u6e90\u66f4\u65b0\u7684\u987a\u5e8f</li> <li>\u591a<code>Pilot</code>\u914d\u7f6e\u8d44\u6e90\u7684\u4e00\u81f4\u6027\u6ca1\u6cd5\u4fdd\u8bc1</li> </ul> <p>\u7efc\u5408\u4ee5\u4e0a\u4e24\u4e2a\u95ee\u9898\uff0c\u5f88\u5bb9\u6613\u51fa\u73b0\u914d\u7f6e\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u7f51\u7edc\u6d41\u91cf\u4e22\u5931\u5e26\u6765\u7f51\u7edc\u9519\u8bef(\u865a\u5047\u7684\uff09</p>"},{"location":"chap3/5isba_Xds/#adsgrpcstream","title":"ADS\u5141\u8bb8\u901a\u8fc7\u4e00\u6761\u8fde\u63a5(<code>gRPC</code>\u7684\u540c\u4e00stream)\uff0c\u53d1\u9001\u591a\u79cd\u8d44\u6e90\u7684\u8bf7\u6c42\u548c\u54cd\u5e94\u3002","text":"<ul> <li>\u80fd\u591f\u4fdd\u8bc1\u8bf7\u6c42\u4e00\u5b9a\u843d\u5728\u540c\u4e00<code>Pilot</code>\u4e0a\uff0c\u89e3\u51b3\u591a\u4e2a\u7ba1\u7406\u670d\u52a1\u5668\u914d\u7f6e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898</li> <li>\u901a\u8fc7\u987a\u5e8f\u7684\u914d\u7f6e\u5206\u53d1\uff0c\u8f7b\u677e\u89e3\u51b3\u8d44\u6e90\u66f4\u65b0\u987a\u5e8f\u7684\u95ee\u9898</li> </ul>"},{"location":"chap3/5isba_Xds/#3-2-ads","title":"3-2 ADS\u6700\u7ec8\u4e00\u81f4\u6027\u7684\u8003\u91cf","text":"<p><code>xDS</code> \u662f\u4e00\u79cd\u6700\u7ec8\u4e00\u81f4\u7684\u534f\u8bae\uff0c\u6240\u4ee5\u5728\u914d\u7f6e\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u6d41\u91cf\u4f1a\u4e22\u5931\u3002</p> <p>\u4f8b\u5982,<code>EDS</code>\u8fd8\u6ca1\u6709\u6765\uff0c\u5982\u679c\u901a\u8fc7<code>CDS/EDS</code>\u83b7\u5f97<code>Cluster X</code>\uff0c \u4e00\u6761\u6307\u5411<code>Cluster X</code>\u7684<code>RouteConfiguration</code> \u521a\u597d\u8c03\u6574\u4e3a\u6307\u5411 <code>Cluster Y</code>\uff0c \u4f46\u662f\u5728<code>CDS/</code>\u53ca\u4e0b\u53d1<code>Cluster Y</code>\u7684\u914d\u7f6e\u7684\u6761\u4ef6\u4e0b\uff0c\u5230 <code>Y</code>\u7684\u6d41\u91cf\u4f1a\u5168\u90e8\u88ab\u4e22\u5f03\uff0c\u5e76\u4e14\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u72b6\u6001\u7801<code>503</code>\u3002</p> <p>\u5728\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u6d41\u91cf\u4e22\u5f03\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\u3002<code>Istio</code>\u901a\u8fc7\u9075\u5faa<code>make before break</code>\u6a21\u578b\uff0c\u8c03\u6574\u914d\u7f6e\u66f4\u65b0\u987a\u5e8f\u53ef\u4ee5\u5b8c\u5168\u907f\u514d\u6d41\u91cf\u4e22\u5931\u3002</p> <p></p>"},{"location":"chap3/5isba_Xds/#4xds","title":"4\u3001xDS\u672a\u6765\u53d1\u5c55","text":""},{"location":"chap3/5isba_Xds/#4-1-istiosidecar","title":"4-1 Istio\u76ee\u524d\u662f\u5168\u91cf\u7684\u5411sidecar\u5206\u53d1\u914d\u7f6e\uff0c\u7531\u6b64\u5e26\u6765\u51e0\u4e2a\u95ee\u9898","text":"<ul> <li>\u914d\u7f6e\u66f4\u65b0\u9891\u7387\u9ad8\uff0c\u5927\u96c6\u7fa4\u7684\u670d\u52a1\uff0c\u5b9e\u4f8b\u6570\u76ee\u591a\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u66f4\u65b0\u540e\u4fbf\u4f1a\u89e6\u53d1\u5168\u91cf\u7684\u914d\u7f6e\u63a8\u9001\u5230\u6240\u6709\u7684<code>sidecar</code>\u3002\u5e26\u5bbd\u5360\u7528\u5927\uff0cPilot\u7aefcpu\u5229\u7528\u7387\u9ad8</li> <li><code>Sidecar</code>\u5360\u7528\u5185\u5b58\u591a\uff0c\u968f\u7740\u96c6\u7fa4\u89c4\u6a21\u589e\u5927\uff0c\u914d\u7f6e\u8d44\u6e90\u5448\u6307\u6570\u7ea7\u589e\u957f\uff0c\u6781\u5927\u7684\u9650\u5236\u4e86\u670d\u52a1\u7f51\u683c\u7684\u89c4\u6a21</li> <li>\u9891\u7e41\u7684\u914d\u7f6e\u52a0\u8f7d\u5f71\u54cd<code>sidecar</code>\u6027\u80fd\u7a33\u5b9a\u6027</li> </ul>"},{"location":"chap3/5isba_Xds/#4-2-xds","title":"4-2 xDS\u672a\u6765\u53d1\u5c55","text":"<ol> <li><code>sidecar</code>\u6309\u9700\u8bf7\u6c42\u8d44\u6e90\uff0c\u61d2\u52a0\u8f7d\u7684\u65b9\u5f0f\uff0c\u5f53\u771f\u6b63\u7684\u9700\u8981\u6d41\u91cf\u8f6c\u53d1\u7684\u65f6\u5019\uff0c \u518d\u53bb\u83b7\u53d6\u8def\u7531\u7b49\u914d\u7f6e</li> <li>\u5b9a\u4e49<code>workload</code>\u7684\u670d\u52a1\u4f9d\u8d56\uff0c\u4f8b\u5982\u5de5\u4f5c\u8d1f\u8f7dA\u53ef\u4ee5\u8bbf\u95ee<code>ns1/serviceB</code></li> <li>\u5b9a\u4e49\u914d\u7f6e\u89c4\u5219\u3001<code>Service</code>\u7684<code>NetworkScope</code>\uff0c\u4f8b\u5982\u670d\u52a1A\u53ea\u80fd\u88ab\u540c\u4e00 <code>Namesapce</code>\u7684<code>workload</code>\u8bbf\u95ee\u3002</li> </ol>"},{"location":"chap3/5isba_Xds/#4-3-xds","title":"4-3 \u589e\u91cfxDS","text":"<p><code>Incremental xDS</code>\u662f\u4e00\u4e2a\u72ec\u7acb\u7684<code>xDS endpoint</code>\uff0c\u662f\u4e00\u79cd <code>runtime</code>\u7684\u52a8\u6001\u914d\u7f6e\u83b7\u53d6\u65b9\u6848\uff0c\u7528\u4e8e\u589e\u91cf\u7684\u66f4\u65b0xDS\u5ba2\u6237\u7aef\u8ba2\u9605\u7684\u8d44\u6e90\uff0c\u9002\u7528\u4e8e<code>ADS</code>\uff0c<code>CDS</code>\u548c<code>RDS</code>:</p> <ul> <li>\u4fdd\u8bc1<code>Envoy</code>\u6309\u9700/\u61d2\u8bf7\u6c42\u6240\u9700\u8981\u7684\u8d44\u6e90\u3002\u4f8b\u5982\u5f53\u6d41\u91cf\u8def\u7531\u5230\u672a\u77e5\u7684<code>cluster</code>\u65f6\uff0cEnvoy\u5c31\u4f1a\u8bf7\u6c42\u83b7\u53d6\u672a\u77e5\u7684cluster\u4fe1\u606f\u3002</li> <li>\u652f\u6301\u5927\u89c4\u6a21\u53ef\u6269\u5c55\u7684\u76ee\u6807\u3002\u4f8b\u5982\u5728\u4e00\u4e2a\u6709<code>100K</code>\u4e2a\u670d\u52a1\u5b9e\u4f8b \u96c6\u7fa4\u4e2d\uff0c\u5982\u679c\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u6709\u66f4\u65b0\uff0c\u7ba1\u7406\u670d\u52a1\u5668\u53ea\u9700\u8981\u4e0b\u53d1\u4e00\u4e2a<code>Cluster</code>\u7684\u4fe1\u606f\u3002</li> </ul>"},{"location":"chap3/5isba_Xds/#5demo","title":"5\u3001Demo","text":"<pre><code>$ kubectl get svc\n</code></pre> <pre><code>$ istioctl pc listener ***\n</code></pre> <pre><code>$ istioctl pc listener *** --port=9080\n</code></pre> <pre><code>$ istioctl pc endpoint ***\n</code></pre>"},{"location":"chap3/6isba_Mixer/","title":"\u7b2c\u4e03\u8282 Mixer\u57fa\u7840\u4e0e\u5b9e\u73b0","text":""},{"location":"chap3/6isba_Mixer/#agenda","title":"Agenda","text":"<ul> <li>Istio\u67b6\u6784\u56de\u987e&amp;Mixer\u4ecb\u7ecd </li> <li>Mixer\u7684\u529f\u80fd\u548c\u8bbe\u8ba1</li> <li>Mixer\u7684\u914d\u7f6e\u6a21\u578b</li> <li>Mixer\u7684\u5178\u578b\u5e94\u7528</li> <li>Mixer\u5b9e\u8df51\u548c2</li> </ul>"},{"location":"chap3/6isba_Mixer/#1istio","title":"1\u3001\u56de\u987e:Istio\u67b6\u6784","text":"<p>Istio Control plane API</p> <ul> <li>Pilot: Config data to proxies</li> <li>Mixer: Policy checks, telemetry</li> <li>Citadel: TLS certs to proxies</li> </ul> <p></p>"},{"location":"chap3/6isba_Mixer/#1-1-istio-mixer-control-observer","title":"1-1 Istio \u5b98\u65b9\u56db\u5927\u529f\u80fd\u4e2d\u4e24\u4e2a\u57fa\u4e8e<code>Mixer</code>\u5b9e\u73b0 Control &amp; Observer","text":""},{"location":"chap3/6isba_Mixer/#1-2-mixeristio","title":"1-2 Mixer\u5728Istio\u4e2d\u89d2\u8272","text":"<ul> <li>\u529f\u80fd\u4e0a:\u8d1f\u8d23\u7b56\u7565\u63a7\u5236\u548c\u9065\u6d4b\u6536\u96c6</li> <li>\u67b6\u6784\u4e0a:\u63d0\u4f9b\u63d2\u4ef6\u6a21\u578b\uff0c\u53ef\u4ee5\u6269\u5c55\u548c\u5b9a\u5236</li> </ul>"},{"location":"chap3/6isba_Mixer/#2mixer","title":"2\u3001Mixer\u7684\u529f\u80fd\u548c\u8bbe\u8ba1","text":""},{"location":"chap3/6isba_Mixer/#2-1-mixer-total-chaos","title":"2-1 \u6ca1\u6709Mixer\u7684\u65f6\u5019 Total Chaos","text":""},{"location":"chap3/6isba_Mixer/#2-2-mixeradapter","title":"2-2 Mixer\u7684Adapter\u673a\u5236","text":"<p>https://istio.io/docs/concepts/policies-and-telemetry/</p> <p>Mixer \u5904\u7406\u4e0d\u540c\u57fa\u7840\u8bbe\u65bd\u540e\u7aef\u7684\u7075\u6d3b\u6027\u662f\u901a\u8fc7\u4f7f\u7528\u901a\u7528\u63d2\u4ef6\u6a21\u578b\u5b9e\u73b0\u7684\uff0c\u8fd9\u79cd\u63d2\u4ef6\u79f0\u4e3a<code>Adapter</code>\u3002</p> <p>Mixer \u901a\u8fc7\u5b83\u4eec\u4e0e\u4e0d\u540c\u7684\u57fa\u7840\u8bbe\u65bd\u540e\u7aef\u8fde\u63a5\uff0c\u8fd9\u4e9b\u540e\u7aef\u53ef\u63d0\u4f9b\u6838\u5fc3\u529f\u80fd\uff0c\u63d0\u4f9b\u65e5\u5fd7\u3001\u76d1\u63a7\u3001\u914d\u989d\u3001ACL \u68c0\u67e5\u7b49</p> <p></p>"},{"location":"chap3/6isba_Mixer/#2-3-mixer","title":"2-3 Mixer\u5b8c\u6574\u89c6\u56fe","text":"<p>\u89e3\u8026\u3001\u4e2d\u4ecb\u3001\u8fd0\u7ef4\u65f6\u914d\u7f6e</p> <p>Mixer:</p> <ul> <li>Route to backend services</li> <li>Route to backend metric</li> </ul> <p>Custom Metrics</p> <p></p>"},{"location":"chap3/6isba_Mixer/#2-4-mixer","title":"2-4 Mixer\u7684\u5904\u7406\u6d41\u7a0b","text":"<ol> <li><code>Envoy</code>\u751f\u6210\u5c5e\u6027\u4e0a\u62a5<code>Mixer</code></li> <li><code>Mixer</code> \u8c03\u7528\u5bf9\u5e94\u540e\u7aef\u5904\u7406\u5c5e\u6027</li> </ol> <p>https://istio.io/docs/reference/config/policy-and-telemetry/attribute-vocabulary/</p>"},{"location":"chap3/6isba_Mixer/#2-5-mixer","title":"2-5 Mixer \u914d\u7f6e\u6a21\u578b\u6982\u8ff0","text":"<ul> <li><code>Handler</code>: \u521b\u5efa <code>Handler</code>,\u5373\u914d\u7f6e<code>Mixer</code>\u9002\u914d\u5668\u3002</li> <li><code>Instance</code>: \u4ece <code>Istio</code> \u5c5e\u6027\u4e2d\u751f\u6210 <code>instance</code>\u3002</li> <li><code>Rule</code>: \u914d\u7f6e\u4e00\u7ec4\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u63cf\u8ff0\u4e86\u4f55\u65f6\u8c03\u7528\u7279\u5b9a\u9002\u914d\u5668\u53ca\u54ea\u4e9b\u5b9e\u4f8b\u3002</li> </ul>"},{"location":"chap3/6isba_Mixer/#3mixer","title":"3\u3001Mixer\u7684\u914d\u7f6e\u6a21\u578b","text":""},{"location":"chap3/6isba_Mixer/#3-1-mixer-1-handler","title":"3-1 Mixer \u914d\u7f6e\u6a21\u578b1: <code>Handler</code>","text":"<p>\u5b9e\u4f8b\u5316\u4e00\u4e2a<code>Adapter</code>\uff0c\u5305\u62ec\u4e86<code>Mixer</code>\u548c\u540e\u7aef\u4ea4\u4e92\u7684\u63a5\u53e3\u3002</p> <pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: stdio\nmetadata:\n  name: handler\nspec:\n  outputAsJson: true\n</code></pre> <p><code>Stdio Adapter</code> \u5b9a\u4e49\u53c2\u7167: <code>mixer/adapter/stdio/config/config.proto:94</code></p>"},{"location":"chap3/6isba_Mixer/#3-2-mixer-2instance","title":"3-2 Mixer \u914d\u7f6e\u6a21\u578b2:\u5b9e\u4f8b(<code>Instance</code>)","text":"<pre><code>apiVersion: \"config.istio.io/v1alpha2\"\nkind: logentry\nmetadata:\nname: accesslog\n  namespace: {{ .Release.Namespace }}\nspec:\n  severity: '\"Info\"'\n  timestamp: request.time\n  variables:\n    sourceIp: source.ip | ip(\"0.0.0.0\")\n    sourceApp: source.labels[\"app\"] | \"\"\n    sourcePrincipal: source.principal | \"\"\n    sourceName: source.name | \"\"\n    destinationApp: destination.labels[\"app\"] | \"\" \n    destinationIp: destination.ip | ip(\"0.0.0.0\") \n    destinationServiceHost: destination.service.host | \"\" \n    destinationWorkload: destination.workload.name | \"\" \n    destinationName: destination.name | \"\" \n    destinationNamespace: destination.namespace | \"\" \n    protocol: request.scheme | context.protocol | \"http\" \n    method: request.method | \"\"\n    url: request.path | \"\"\n    responseCode: response.code | 0\n    responseSize: response.size | 0\n    requestSize: request.size | 0\n    requestId: request.headers[\"x-request-id\"] | \"\" userAgent: request.useragent | \"\" responseTimestamp: response.time\n    ...\n</code></pre> <p>\u5b9e\u4f8b\u5c06\u8bf7\u6c42\u4e2d\u7684\u5c5e\u6027\u6620\u5c04\u6210\u4e3a\u9002\u914d\u5668\u7684\u8f93\u5165\uff0c\u6bcf\u6b21\u8bf7\u6c42\u9002\u914d\u5668\u6d88\u8d39\u7684\u6570\u636e\u3002</p>"},{"location":"chap3/6isba_Mixer/#3-3-mixer-3rule","title":"3-3 Mixer \u914d\u7f6e\u6a21\u578b3:\u89c4\u5219(Rule)","text":"<pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: rule\nmetadata:\n    name: stdio\n    namespace: {{ .Release.Namespace }} \nspec:\n    match: context.protocol == \"http\" || context.protocol == \"grpc\" \n    actions:\n    - handler: handler.stdio\n    instances:\n    - accesslog.logentry\n</code></pre> <p>\u544a\u8bc9 <code>Mixer</code> \u54ea\u4e2a <code>instance</code> \u5728\u4ec0\u4e48\u65f6\u5019\u53d1\u9001\u7ed9\u54ea\u4e2a <code>handler</code>\u6765\u5904\u7406</p>"},{"location":"chap3/6isba_Mixer/#3-4-request","title":"3-4 <code>Request</code>\u7684\u5c5e\u6027\u5904\u7406\u6d41\u7a0b","text":"<ul> <li>\u63a5\u6536\u5c5e\u6027</li> <li>\u8865\u5145\u5c5e\u6027</li> <li>\u5904\u7406\u5c5e\u6027</li> </ul>"},{"location":"chap3/6isba_Mixer/#3-5-mixer-adapters","title":"3-5 Mixer Adapters","text":"<p>https://istio.io/docs/reference/config/policy-and-telemetry/adapters/</p> <p></p>"},{"location":"chap3/6isba_Mixer/#3-6-mixer-check-adapter","title":"3-6 Mixer \u7684 Check Adapter","text":"<p><code>mixer/adapter/list/list.go</code></p> <p>Adapter\u5b9e\u73b0</p> <pre><code>func (h *handler) HandleListEntry(_ context.Context, entry *listentry.Instance) (adapter.CheckResult, error) {\n    h.lock.Lock()\n    l := h.list\n    err := h.lastFetchError\n    h.lock.Unlock()\n\n    if l == nil {\n        // no valid list\n        return adapter.CheckResult{}, err\n    }\n\n    var value string\n    ...\n    return getCheckResult(h.config, code, msg), nil\n}\n\n</code></pre> <p><code>https://github.com/istio/istio/blob/master/mixer/adapter/list/config/config.proto</code></p> <p>Adapter\u914d\u7f6e\u5b9a\u4e49</p> <pre><code>// Configuration format for the `list` adapter.\nmessage Params {\n    // Where to find the list to check against. This may be omitted for a completely local list.\n    string provider_url = 1;\n    ...\n\n    // Determines the type of list that the adapter is consulting.\n    enum ListEntryType {\n        // List entries are treated as plain strings.\n        STRINGS = 0;\n\n        // List entries are treated as case-insensitive strings.\n        CASE_INSENSITIVE_STRINGS = 1;\n\n        // List entries are treated as IP addresses and ranges.\n        IP_ADDRESSES = 2;\n\n        // List entries are treated as re2 regexp. See [here](https://github.com/google/re2/wiki/Syntax) for the supported syntax.\n        REGEX = 3;\n    }\n\n    // Determines the kind of list entry and overrides.\n    ListEntryType entry_type = 7;\n\n    // Whether the list operates as a blacklist or a whitelist.\n    bool blacklist = 8;\n}\n</code></pre>"},{"location":"chap3/6isba_Mixer/#3-7-mixer-report-adapter","title":"3-7 Mixer \u7684 <code>Report Adapter</code>","text":"<p><code>https://github.com/istio/istio/tree/master/mixer/adapter/stdio</code></p> <p>Adapter\u5b9e\u73b0</p> <pre><code>func (h *handler) HandleLogEntry(_ context.Context, instances []*logentry.Instance) error {\n    var errors *multierror.Error\n\n    fields := make([]zapcore.Field, 0, 6)\n    for _, instance := range instances {\n        entry := zapcore.Entry{\n            LoggerName: instance.Name,\n            Level:      h.mapSeverityLevel(instance.Severity),\n            Time:       instance.Timestamp,\n        }\n\n        var logEntryTypes map[string]istio_policy_v1beta1.ValueType\n        if typeInfo, found := h.logEntryTypes[instance.Name]; found {\n            logEntryTypes = typeInfo.Variables\n        }\n        for _, varName := range h.logEntryVars[instance.Name] {\n            if value, ok := instance.Variables[varName]; ok {\n                fields = append(fields, zap.Any(varName, convertValueTypes(value, varName, logEntryTypes)))\n            }\n        }\n\n        if err := h.write(entry, fields); err != nil {\n            errors = multierror.Append(errors, err)\n        }\n        fields = fields[:0]\n    }\n\n    return errors.ErrorOrNil()\n}\n\n\n</code></pre> <p>Adapter\u914d\u7f6e\u5b9a\u4e49</p> <p><code>https://github.com/istio/istio/blob/master/mixer/adapter/stdio/config/config.proto</code></p> <pre><code>// Configuration format for the `stdio` adapter\nmessage Params {\n    // Stream is used to select between different log output sinks.\n    enum Stream {\n        // Output to the Mixer process' standard output stream. This is the default value.\n        STDOUT = 0;\n\n     ...\n\n    // The maximum number of days to retain old rotated log files based on the\n    // timestamp encoded in their filename. Note that a day is defined as 24\n    // hours and may not exactly correspond to calendar days due to daylight\n    // savings, leap seconds, etc. The default is to remove log files\n    // older than 30 days. 0 indicates no limit.\n    int32 max_days_before_rotation = 8;\n\n    // The maximum number of old rotated log files to retain.  The default\n    // is to retain at most 1000 logs. 0 indicates no limit.\n    int32 max_rotated_files = 9;\n}\n</code></pre>"},{"location":"chap3/6isba_Mixer/#3-8-mixer","title":"3-8 Mixer\u7684\u9ad8\u53ef\u7528\u8bbe\u8ba1","text":"<ul> <li>\u65e0\u72b6\u6001</li> <li>\u9ad8\u53ef\u4ee5\u7528</li> <li>\u7f13\u5b58\u548c\u7f13\u51b2</li> </ul>"},{"location":"chap3/6isba_Mixer/#envoy","title":"Envoy","text":"<ul> <li>First Level: Per-sidecar cache</li> </ul>"},{"location":"chap3/6isba_Mixer/#mixer_1","title":"Mixer","text":"<ul> <li>Second Level: Shared Cache</li> </ul>"},{"location":"chap3/6isba_Mixer/#3-9-mixer-batch-report","title":"3-9 Mixer \u7684 Batch Report","text":""},{"location":"chap3/6isba_Mixer/#4mixer","title":"4\u3001Mixer\u7684\u5178\u578b\u5e94\u7528","text":""},{"location":"chap3/6isba_Mixer/#4-1-mixer1","title":"4-1 Mixer\u5178\u578b\u5e94\u75281: \u534e\u4e3a\u4e91\u5e94\u7528\u670d\u52a1\u7f51\u683c","text":""},{"location":"chap3/6isba_Mixer/#4-2-mixer2-google-apigee","title":"4-2 Mixer\u5178\u578b\u5e94\u75282: Google Apigee","text":"<p>https://docs.apigee.com/api-platform/istio-adapter/concepts</p> <p></p>"},{"location":"chap3/6isba_Mixer/#5mixer12","title":"5\u3001Mixer\u5b9e\u8df51\u548c2","text":""},{"location":"chap3/6isba_Mixer/#5-1-1-0mixer-adapter","title":"5-1 \u5b9e\u8df51 \u4ece0\u5f00\u53d1\u5e76\u8fd0\u884c\u4e00\u4e2a<code>Mixer Adapter</code>:\u539f\u7406","text":""},{"location":"chap3/6isba_Mixer/#5-2","title":"5-2 \u4e24\u4e2a\u89d2\u8272","text":"<pre><code>\u914d\u7f6e\u6a21\u677f\u4f7f\u7528\u4e00\u4e2a Adapter   =&gt;   \u5f00\u53d1\u4ee3\u7801\u5b9a\u4e49\u6a21\u677f\u5f00\u53d1\u4e00\u4e2aAdapter\n</code></pre>"},{"location":"chap3/6isba_Mixer/#5-3-1-0mixer-adapter","title":"5-3 \u5b9e\u8df51 \u4ece0\u5f00\u53d1\u5e76\u8fd0\u884c\u4e00\u4e2aMixer Adapter:\u6b65\u9aa4","text":"<p>1.\u521b\u5efa\u72ec\u7acb\u7684Adapter\u76ee\u5f55\uff0c\u5e76\u5f00\u53d1Adapter\u7684\u4ee3\u7801\u5f00\u53d1Adapter\u4ee3\u7801</p> <pre><code>cd $MIXER_REPO/adapter &amp;&amp; mkdir mysampleadapter &amp;&amp; cd mysampleadapter \n#\u521b\u5efamysampleadapter .go\u6587\u4ef6\u5b9a\u4e49\u5904\u7406\u903b\u8f91\n</code></pre> <p>2.\u914d\u7f6e<code>config.proto</code>\uff0c\u63cf\u8ff0\u914d\u7f6e\u7684\u5b9a\u4e49\u3002</p> <pre><code>#\u521b\u5efaconfig.proto\u6587\u4ef6\uff0c\u63cf\u8ff0adapter\u7684\u914d\u7f6e\u53c2\u6570 \n$ mkdir config\n</code></pre> <p>3.\u6839\u636e<code>proto</code>\u751f\u6210go\u7684\u914d\u7f6e\uff0c\u5e76\u5728adapter\u4ee3\u7801\u4e2d\u4f7f\u7528 </p> <pre><code>go generate ./...\ngo build ./...\n</code></pre> <p>4.\u5728<code>Mixer</code>\u4e2d\u6ce8\u518c\u8fd9\u4e2a\u65b0\u7684<code>Adapter</code>\u3002</p> <pre><code># \u5728inventory.yaml \u4e2d\u6ce8\u518cadapter\uff0c mysampleadapter: \"istio.io/istio/mixer/adapter/mysampleadapter\"\ngo generate $MIXER_REPO/adapter/doc.go\n</code></pre> <p>5.\u914d\u7f6e\u5e76\u4f7f\u7528\u65b0\u521b\u5efa\u7684<code>adapter</code>\u3002 </p> <pre><code>#\u5728testdata\u76ee\u5f55\u4e0b\u521b\u5efa\u4f7f\u7528\u8be5adapter\u7684\u914d\u7f6e\uff0c\u5373handler\uff0cinstance\uff0crule\u3002 \n$mkdir $MIXER_REPO/adapter/mysampleadapter/testdata \n#\u786e\u8ba4\u4e24\u4e2a\u6587\u4ef6attributes.yaml\u548cmysampleadapter.yaml\n</code></pre> <p>6.\u542f\u52a8<code>mixer</code> \u670d\u52a1\u7aef</p> <pre><code>pushd $ISTIO/istio &amp;&amp; make mixs\n$GOPATH/out/linux_amd64/release/mixs server --configStoreURL=fs://$(pwd)/mixer/adapter/mysampleadapter/testdata\n</code></pre> <p>7.\u542f\u52a8\u4e00\u4e2a\u5ba2\u6237\u7aef\uff0c\u6a21\u62df\u4e0a\u62a5\u6570\u636e</p> <pre><code>pushd $ISTIO/istio &amp;&amp; make mixc\n$GOPATH/out/linux_amd64/release/mixc report -s destination.service=\"svc.cluster.local\" -t request.time=\"2019-01-10T20:00:00Z\"\n</code></pre> <p>8.\u67e5\u770b\u7ed3\u679c\u8f93\u51fa</p> <pre><code>tail $ISTIO/istio/out.txt\n</code></pre>"},{"location":"chap3/6isba_Mixer/#5-4","title":"5-4 \u6548\u679c","text":""},{"location":"chap3/6isba_Mixer/#62-mixer","title":"6\u3001\u5b9e\u8df52 \u901a\u8fc7Mixer\u6536\u96c6\u81ea\u5b9a\u4e49\u7684\u9065\u6d4b\u6570\u636e:\u76ee\u6807","text":"<ul> <li>\u7f16\u5199\u81ea\u5b9a\u4e49\u7684<code>Metric</code>\u6a21\u677f</li> <li>\u5728<code>Istio</code>\u4e2d\u521b\u5efa\u81ea\u5b9a\u4e49<code>Metric</code>\u3001<code>Prometheus Handler</code>\u548c<code>Rule</code> </li> <li>\u8ba4\u8bc6<code>Prometheus Adapter</code></li> <li>\u5b9e\u8df5<code>Prometheus</code>\u7684\u4e3b\u8981\u80fd\u529b</li> </ul>"},{"location":"chap3/6isba_Mixer/#6-1-2-mixer","title":"6-1 \u5b9e\u8df52 \u901a\u8fc7Mixer\u6536\u96c6\u81ea\u5b9a\u4e49\u7684\u9065\u6d4b\u6570\u636e:\u6b65\u9aa4","text":"<p>1.\u521b\u5efa\u914d\u7f6e\uff0c\u5305\u62ecprometheus\u7684handler\u3001metric\u548crule </p> <pre><code>kubectl apply -f double-request.yaml\n</code></pre> <p>2.\u67e5\u770b\u521b\u5efa\u7684\u5bf9\u8c61</p> <pre><code>kubectl get metrics.config.istio.io -nistio-system \nkubectl get rules.config.istio.io -nistio-system \nkubectl get prometheus.config.istio.io -nistio-system\n</code></pre> <p>3.\u53d1\u8d77\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u751f\u6210\u8bbf\u95ee<code>metric</code>\u6570\u636e</p> <p>4.\u901a\u8fc7<code>Prometheus</code>\u67e5\u770b<code>metric</code>\u6570\u636e</p> <ul> <li>4.1 \u67e5\u770b<code>doublereques</code>\u7684metric <code>http://49.4.84.29:9090/graph?g0.range_input=1h&amp;g0.expr=istio_double_request_count&amp;g0.tab=1</code></li> <li>4.2 \u901a\u8fc7<code>prometheus</code>\u68c0\u7d22\u7279\u5b9a\u76ee\u6807\u7684 metric <code>istio_double_request_count{destination=\"details-v1\"}</code></li> </ul> <p></p> <p></p>"},{"location":"chap3/6isba_Mixer/#6-2","title":"6-2 \u6548\u679c","text":""},{"location":"chap4/1Istio_Intro/","title":"\u7b2c\u4e00\u8282 2021 Service Mesh &amp; Istio \u4ecb\u7ecd/\u5b89\u88c5(1.10.3)","text":"<p>\u73b0\u5728\u6700\u706b\u7684\u540e\u7aef\u67b6\u6784\u65e0\u7591\u662f\u5fae\u670d\u52a1\u4e86\uff0c\u5fae\u670d\u52a1\u5c06\u4e4b\u524d\u7684\u5355\u4f53\u5e94\u7528\u62c6\u5206\u6210\u4e86\u8bb8\u591a\u72ec\u7acb\u7684\u670d\u52a1\u5e94\u7528\uff0c\u6bcf\u4e2a\u5fae\u670d\u52a1\u90fd\u662f\u72ec\u7acb\u7684\uff0c\u597d\u5904\u81ea\u7136\u5f88\u591a\uff0c\u4f46\u662f\u968f\u7740\u5e94\u7528\u7684\u8d8a\u6765\u8d8a\u5927\uff0c\u5fae\u670d\u52a1\u66b4\u9732\u51fa\u6765\u7684\u95ee\u9898\u4e5f\u5c31\u968f\u4e4b\u800c\u6765\u4e86\uff0c\u5fae\u670d\u52a1\u8d8a\u6765\u8d8a\u591a\uff0c\u7ba1\u7406\u8d8a\u6765\u8d8a\u9ebb\u70e6\uff0c\u7279\u522b\u662f\u8981\u4f60\u90e8\u7f72\u4e00\u5957\u65b0\u73af\u5883\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u80fd\u4f53\u4f1a\u5230\u8fd9\u79cd\u75db\u82e6\u4e86\uff0c\u968f\u4e4b\u800c\u6765\u7684\u670d\u52a1\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001Trace\u8ddf\u8e2a\u3001\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u8ba4\u8bc1\u7b49\u7b49\u95ee\u9898\u3002</p> <p>\u5982\u679c\u4ece\u5934\u5230\u5c3e\u5b8c\u6210\u8fc7\u4e00\u5957\u5fae\u670d\u52a1\u6846\u67b6\u7684\u8bdd\uff0c\u4f60\u5c31\u4f1a\u77e5\u9053\u8fd9\u91cc\u9762\u6d89\u53ca\u5230\u7684\u4e1c\u897f\u771f\u7684\u975e\u5e38\u591a\u3002\u5f53\u7136\u968f\u7740\u5fae\u670d\u52a1\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u5fae\u670d\u52a1\u7684\u751f\u6001\u4e5f\u4e0d\u65ad\u5b8c\u5584\uff0c\u6700\u8fd1\u65b0\u4e00\u4ee3\u7684\u5fae\u670d\u52a1\u5f00\u53d1\u5c31\u6084\u7136\u5174\u8d77\u4e86\uff0c\u90a3\u5c31\u662f\u670d\u52a1\u7f51\u683c/Service Mesh\u3002</p>"},{"location":"chap4/1Istio_Intro/#1service-mesh","title":"1\u3001\u4ec0\u4e48\u662fService Mesh\uff1f","text":"<p>Service Mesh \u662f\u4e00\u4e2a\u975e\u5e38\u65b0\u7684\u540d\u8bcd\uff0c\u6700\u65e9\u662f2016\u5e74\u7531\u5f00\u53d1 Linkerd \u7684 Buoyant \u516c\u53f8\u63d0\u51fa\u7684\uff0c\u4f34\u968f\u7740 Linkerd \u7684\u4f20\u5165\uff0c Service Mesh \u7684\u6982\u5ff5\u4e5f\u6162\u6162\u8fdb\u5165\u56fd\u5185\u6280\u672f\u793e\u533a\uff0c\u73b0\u5728\u4e3b\u6d41\u7684\u53eb\u6cd5\u90fd\u53eb\uff1a\u670d\u52a1\u7f51\u683c\u3002</p> <p>\u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u7528\u4e8e\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5b83\u8d1f\u8d23\u4e3a\u6784\u5efa\u590d\u6742\u7684\u4e91\u539f\u751f\u5e94\u7528\u4f20\u9012\u53ef\u9760\u7684\u7f51\u7edc\u8bf7\u6c42\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u901a\u5e38\u5b9e\u73b0\u4e3a\u4e00\u7ec4\u548c\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5728\u4e00\u8d77\u7684\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\uff0c\u4f46\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u662f\u900f\u660e\u7684\u3002</p> <p>\u8981\u7406\u89e3\u7f51\u683c\u7684\u6982\u5ff5\uff0c\u5c31\u5f97\u4ece\u670d\u52a1\u7684\u90e8\u7f72\u6a21\u578b\u8bf4\u8d77\uff1a</p>"},{"location":"chap4/1Istio_Intro/#1-1-sidecar","title":"1-1 \u5355\u4e2a\u670d\u52a1\u8c03\u7528\uff0c\u8868\u73b0\u4e3asidecar","text":"<p>\u5355\u4e2a\u670d\u52a1\u8c03\u7528</p> <p>Service Mesh \u7684\u90e8\u7f72\u6a21\u578b\uff0c\u5148\u770b\u5355\u4e2a\u7684\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7b80\u5355\u8bf7\u6c42\uff0c\u4f5c\u4e3a\u8bf7\u6c42\u53d1\u8d77\u8005\u7684\u5ba2\u6237\u7aef\u5e94\u7528\u5b9e\u4f8b\uff0c\u4f1a\u9996\u5148\u7528\u7b80\u5355\u65b9\u5f0f\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u672c\u5730\u7684 Service Mesh \u5b9e\u4f8b\u3002\u8fd9\u662f\u4e24\u4e2a\u72ec\u7acb\u8fdb\u7a0b\uff0c\u4ed6\u4eec\u4e4b\u95f4\u662f\u8fdc\u7a0b\u8c03\u7528\u3002</p> <p>Service Mesh \u4f1a\u5b8c\u6210\u5b8c\u6574\u7684\u670d\u52a1\u95f4\u8c03\u7528\u6d41\u7a0b\uff0c\u5982\u670d\u52a1\u53d1\u73b0\u8d1f\u8f7d\u5747\u8861\uff0c\u6700\u540e\u5c06\u8bf7\u6c42\u53d1\u9001\u7ed9\u76ee\u6807\u670d\u52a1\uff0c\u8fd9\u8868\u73b0\u4e3a Sidecar \u65b9\u5f0f\u3002</p>"},{"location":"chap4/1Istio_Intro/#1-2","title":"1-2 \u90e8\u7f72\u591a\u4e2a\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u901a\u8baf\u5c42","text":"<p>\u591a\u4e2a\u670d\u52a1\u8c03\u7528\u7684\u60c5\u51b5\uff0c\u5728\u8fd9\u4e2a\u56fe\u4e0a\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Service Mesh \u5728\u6240\u6709\u7684\u670d\u52a1\u7684\u4e0b\u9762\uff0c\u8fd9\u4e00\u5c42\u88ab\u79f0\u4e4b\u4e3a\u670d\u52a1\u95f4\u901a\u8baf\u4e13\u7528\u57fa\u7840\u8bbe\u65bd\u5c42\u3002</p> <p>Service Mesh \u4f1a\u63a5\u7ba1\u6574\u4e2a\u7f51\u7edc\uff0c\u628a\u6240\u6709\u7684\u8bf7\u6c42\u5728\u670d\u52a1\u4e4b\u95f4\u505a\u8f6c\u53d1\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4e0a\u9762\u7684\u670d\u52a1\u4e0d\u518d\u8d1f\u8d23\u4f20\u9012\u8bf7\u6c42\u7684\u5177\u4f53\u903b\u8f91\uff0c\u53ea\u8d1f\u8d23\u5b8c\u6210\u4e1a\u52a1\u5904\u7406\u3002\u670d\u52a1\u95f4\u901a\u8baf\u7684\u73af\u8282\u5c31\u4ece\u5e94\u7528\u91cc\u9762\u5265\u79bb\u51fa\u6765\uff0c\u5448\u73b0\u51fa\u4e00\u4e2a\u62bd\u8c61\u5c42\u3002</p>"},{"location":"chap4/1Istio_Intro/#1-3","title":"1-3 \u6709\u5927\u91cf\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u7f51\u7edc","text":"<p>\u5982\u679c\u6709\u5927\u91cf\u7684\u670d\u52a1\uff0c\u5c31\u4f1a\u8868\u73b0\u51fa\u6765\u7f51\u683c\uff0c\u56fe\u4e2d\u5de6\u8fb9\u7eff\u8272\u65b9\u683c\u662f\u5e94\u7528\uff0c\u53f3\u8fb9\u84dd\u8272\u7684\u65b9\u6846\u662f Service Mesh\uff0c\u84dd\u8272\u4e4b\u95f4\u7684\u7ebf\u6761\u662f\u8868\u793a\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u3002Sidecar \u4e4b\u95f4\u7684\u8fde\u63a5\u5c31\u4f1a\u5f62\u6210\u4e00\u4e2a\u7f51\u7edc\uff0c\u8fd9\u4e2a\u5c31\u662f\u670d\u52a1\u7f51\u683c\u540d\u5b57\u7684\u7531\u6765\uff0c\u8fd9\u4e2a\u65f6\u5019\u4ee3\u7406\u4f53\u73b0\u51fa\u6765\u7684\u5c31\u548c\u524d\u9762\u7684 Sidecar \u4e0d\u4e00\u6837\u4e86\uff0c\u5f62\u6210\u7f51\u72b6\u3002</p> <p>\u9996\u5148\u7b2c\u4e00\u4e2a\uff0c\u670d\u52a1\u7f51\u683c\u662f\u62bd\u8c61\u7684\uff0c\u5b9e\u9645\u4e0a\u662f\u62bd\u8c61\u51fa\u4e86\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5728\u5e94\u7528\u4e4b\u5916\u3002\u5176\u6b21\uff0c\u529f\u80fd\u662f\u5b9e\u73b0\u8bf7\u6c42\u7684\u53ef\u9760\u4f20\u9012\u3002\u90e8\u7f72\u4e0a\u4f53\u73b0\u4e3a\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\u3002\u6700\u540e\u4e00\u4e2a\u5173\u952e\u8bcd\u662f\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u900f\u660e\u3002</p> <p> </p> <p>\u5927\u5bb6\u6ce8\u610f\u770b\uff0c\u4e0a\u9762\u7684\u56fe\u4e2d\uff0c\u7f51\u7edc\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u4e0d\u662f\u7279\u522b\u660e\u663e\u3002\u4f46\u662f\u5982\u679c\u628a\u5de6\u8fb9\u7684\u5e94\u7528\u7a0b\u5e8f\u53bb\u6389\uff0c\u73b0\u5728\u53ea\u5448\u73b0\u51fa\u6765 Service Mesh \u548c\u4ed6\u4eec\u4e4b\u95f4\u7684\u8c03\u7528\uff0c\u8fd9\u4e2a\u65f6\u5019\u5173\u7cfb\u5c31\u4f1a\u7279\u522b\u6e05\u6670\uff0c\u5c31\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u7f51\u7edc\u3002</p> <p>\u8fd9\u662f Service Mesh \u5b9a\u4e49\u5f53\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5173\u952e\u70b9\uff0c\u548c Sidecar \u4e0d\u76f8\u540c\u7684\u5730\u65b9\uff1a\u4e0d\u518d\u5c06\u4ee3\u7406\u89c6\u4e3a\u5355\u72ec\u7684\u7ec4\u4ef6\uff0c\u800c\u662f\u5f3a\u8c03\u7531\u8fd9\u4e9b\u4ee3\u7406\u8fde\u63a5\u800c\u5f62\u6210\u7684\u7f51\u7edc\u3002\u5728 Service Mesh \u91cc\u9762\u975e\u5e38\u5f3a\u8c03\u4ee3\u7406\u8fde\u63a5\u7ec4\u6210\u7684\u7f51\u7edc\uff0c\u800c\u4e0d\u50cf Sidecar \u90a3\u6837\u770b\u5f85\u4e2a\u4f53\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u57fa\u672c\u4e0a\u628a Service Mesh \u7684\u5b9a\u4e49\u4ecb\u7ecd\u6e05\u695a\u4e86\uff0c\u5927\u5bb6\u5e94\u8be5\u53ef\u4ee5\u5927\u6982\u4e86\u89e3\u4ec0\u4e48\u662f Service Mesh \u4e86\u3002\u73b0\u5728\u5b9e\u73b0 Service Mesh \u7684\u5f00\u6e90\u65b9\u6848\u6709\u5f88\u591a\uff0c\u6bd4\u5982 Linkerd\u3001Istio \u7b49\uff0c\u5f53\u7136\u76ee\u524d\u6700\u6d41\u884c\u6700\u706b\u70ed\u7684\u8fd8\u662f\u8981\u6570 Istio \u4e86\uff0c\u8bb0\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5f00\u59cb\u8bb2\u89e3 Istio \u7684\u4f7f\u7528\u3002</p>"},{"location":"chap4/1Istio_Intro/#2istio","title":"2\u3001\u4ec0\u4e48\u662fIstio\uff1f","text":"<p>Istio \u89e3\u51b3\u4e86\u5f00\u53d1\u4eba\u5458\u548c\u8fd0\u7ef4\u5728\u5206\u5e03\u5f0f\u6216\u5fae\u670d\u52a1\u67b6\u6784\u65b9\u9762\u9762\u4e34\u7684\u6311\u6218\uff0c\u65e0\u8bba\u662f\u4ece\u5934\u5f00\u59cb\u6784\u5efa\u8fd8\u662f\u5c06\u73b0\u6709\u5e94\u7528\u7a0b\u5e8f\u8fc1\u79fb\u5230\u4e91\u539f\u751f\u73af\u5883\u4e0b\uff0cIstio \u90fd\u53ef\u4ee5\u63d0\u4f9b\u5e2e\u52a9\u3002</p> <p>\u901a\u8fc7\u5728\u90e8\u7f72\u7684\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u6dfb\u52a0\u4ee3\u7406 sidecar\uff0cIstio \u5141\u8bb8\u60a8\u5c06\u5e94\u7528\u7a0b\u5e8f\u611f\u77e5\u6d41\u91cf\u7ba1\u7406\u3001\u4ee4\u4eba\u96be\u4ee5\u7f6e\u4fe1\u7684\u53ef\u89c2\u5bdf\u6027\u548c\u5f3a\u5927\u7684\u5b89\u5168\u529f\u80fd\u7f16\u7a0b\u5230\u60a8\u7684\u7f51\u7edc\u4e2d\u3002</p> <p> </p> <p>Istio \u662f\u4e00\u4e2a\u5f00\u6e90\u670d\u52a1\u7f51\u683c\uff0c\u5b83\u900f\u660e\u5730\u5206\u5c42\u5230\u73b0\u6709\u7684\u5206\u5e03\u5f0f\u5e94\u7528\u7a0b\u5e8f\u4e0a\u3002Istio \u5f3a\u5927\u7684\u7279\u6027\u63d0\u4f9b\u4e86\u4e00\u79cd\u7edf\u4e00\u548c\u66f4\u6709\u6548\u7684\u65b9\u5f0f\u6765\u4fdd\u62a4\u3001\u8fde\u63a5\u548c\u76d1\u89c6\u670d\u52a1\u3002</p> <p>Istio \u662f\u5b9e\u73b0\u8d1f\u8f7d\u5e73\u8861\u3001\u670d\u52a1\u5230\u670d\u52a1\u8eab\u4efd\u9a8c\u8bc1\u548c\u76d1\u89c6\u7684\u8def\u5f84\u2014\u2014\u53ea\u9700\u8981\u5f88\u5c11\u6216\u4e0d\u9700\u8981\u66f4\u6539\u670d\u52a1\u4ee3\u7801\u3002\u5b83\u5f3a\u5927\u7684\u63a7\u5236\u5e73\u9762\u5e26\u6765\u4e86\u91cd\u8981\u7684\u7279\u70b9\uff0c\u5305\u62ec\uff1a</p> <ul> <li>\u4f7f\u7528 TLS \u52a0\u5bc6\u3001\u5f3a\u8eab\u4efd\u8ba4\u8bc1\u548c\u6388\u6743\u7684\u96c6\u7fa4\u5185\u670d\u52a1\u5230\u670d\u52a1\u7684\u5b89\u5168\u901a\u4fe1</li> <li>\u81ea\u52a8\u8d1f\u8f7d\u5747\u8861\u7684 HTTP, gRPC, WebSocket\uff0c\u548c TCP \u6d41\u91cf</li> <li>\u901a\u8fc7\u4e30\u5bcc\u7684\u8def\u7531\u89c4\u5219\u3001\u91cd\u8bd5\u3001\u6545\u969c\u8f6c\u79fb\u548c\u6545\u969c\u6ce8\u5165\u5bf9\u6d41\u91cf\u884c\u4e3a\u8fdb\u884c\u7ec6\u7c92\u5ea6\u63a7\u5236</li> <li>\u4e00\u4e2a\u53ef\u63d2\u5165\u7684\u7b56\u7565\u5c42\u548c\u914d\u7f6e API\uff0c\u652f\u6301\u8bbf\u95ee\u63a7\u5236\u3001\u901f\u7387\u9650\u5236\u548c\u914d\u989d</li> <li>\u5bf9\u96c6\u7fa4\u5185\u7684\u6240\u6709\u6d41\u91cf(\u5305\u62ec\u96c6\u7fa4\u5165\u53e3\u548c\u51fa\u53e3)\u8fdb\u884c\u81ea\u52a8\u5ea6\u91cf\u3001\u65e5\u5fd7\u548c\u8ddf\u8e2a</li> </ul> <p>Istio \u662f\u4e3a\u53ef\u6269\u5c55\u6027\u800c\u8bbe\u8ba1\u7684\uff0c\u53ef\u4ee5\u5904\u7406\u4e0d\u540c\u8303\u56f4\u7684\u90e8\u7f72\u9700\u6c42\u3002</p> <p>Istio \u7684\u63a7\u5236\u5e73\u9762\u8fd0\u884c\u5728 Kubernetes \u4e0a\uff0c\u60a8\u53ef\u4ee5\u5c06\u90e8\u7f72\u5728\u8be5\u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u5230\u60a8\u7684\u7f51\u683c\u4e2d\uff0c\u5c06\u7f51\u683c\u6269\u5c55\u5230\u5176\u4ed6\u96c6\u7fa4\uff0c\u751a\u81f3\u8fde\u63a5 VM \u6216\u8fd0\u884c\u5728 Kubernetes \u4e4b\u5916\u7684\u5176\u4ed6\u7aef\u70b9\u3002</p>"},{"location":"chap4/1Istio_Intro/#3","title":"3\u3001\u67b6\u6784","text":"<p>Istio \u6709\u4e24\u4e2a\u7ec4\u6210\u90e8\u5206\uff1a\u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762\u3002</p> <p>\u6570\u636e\u5e73\u9762\u7531\u4e00\u7ec4\u667a\u80fd\u4ee3\u7406\uff08Envoy\uff09\u7ec4\u6210\uff0c\u88ab\u90e8\u7f72\u4e3a Sidecar\u3002\u8fd9\u4e9b\u4ee3\u7406\u8d1f\u8d23\u534f\u8c03\u548c\u63a7\u5236\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1\u3002\u5b83\u4eec\u8fd8\u6536\u96c6\u548c\u62a5\u544a\u6240\u6709\u7f51\u683c\u6d41\u91cf\u7684\u9065\u6d4b\u6570\u636e\u3002</p> <p>\u670d\u52a1\u7f51\u683c\u4f7f\u7528\u4ee3\u7406\u62e6\u622a\u6240\u6709\u7684\u7f51\u7edc\u6d41\u91cf\uff0c\u5141\u8bb8\u6839\u636e\u60a8\u8bbe\u7f6e\u7684\u914d\u7f6e\u63d0\u4f9b\u5e7f\u6cdb\u7684\u5e94\u7528\u7a0b\u5e8f\u611f\u77e5\u529f\u80fd\u3002</p> <p>\u4ee3\u7406\u4e0e\u60a8\u5728\u96c6\u7fa4\u4e2d\u542f\u52a8\u7684\u6bcf\u4e2a\u670d\u52a1\u4e00\u8d77\u90e8\u7f72\uff0c\u6216\u8005\u4e0e\u8fd0\u884c\u5728\u865a\u62df\u673a\u4e0a\u7684\u670d\u52a1\u4e00\u8d77\u8fd0\u884c\u3002</p> <p>\u63a7\u5236\u5e73\u9762\u7ba1\u7406\u5e76\u914d\u7f6e\u4ee3\u7406\u6765\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002</p> <p>\u5728\u4f7f\u7528 Istio \u4e4b\u524d\u670d\u52a1\u4e0e\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p> </p> <p>\u4f7f\u7528 Istio \u4e4b\u540e\u670d\u52a1\u4e0e\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u5219\u901a\u8fc7 Envoy \u4ee3\u7406\u8fdb\u884c\uff1a</p> <p> </p> <p>\u4e0b\u56fe\u5219\u662f Istio \u6bcf\u4e2a\u5e73\u9762\u7684\u4e0d\u540c\u7ec4\u4ef6\u7684\u67b6\u6784\uff1a</p> <p> </p>"},{"location":"chap4/1Istio_Intro/#3-1-envoy","title":"3-1 Envoy","text":"<p>Istio \u9ed8\u8ba4\u4f7f\u7528 Envoy \u4ee3\u7406\u7684\u6269\u5c55\u7248\u672c\uff0cEnvoy \u662f\u7528 C++ \u5f00\u53d1\u7684\u9ad8\u6027\u80fd\u4ee3\u7406\uff0c\u7528\u4e8e\u534f\u8c03\u670d\u52a1\u7f51\u683c\u4e2d\u6240\u6709\u670d\u52a1\u7684\u5165\u7ad9\u548c\u51fa\u7ad9\u6d41\u91cf\u3002Envoy \u4ee3\u7406\u662f\u552f\u4e00\u4e0e\u6570\u636e\u5e73\u9762\u6d41\u91cf\u4ea4\u4e92\u7684 Istio \u7ec4\u4ef6\u3002</p> <p>Envoy \u4ee3\u7406\u88ab\u90e8\u7f72\u4e3a\u670d\u52a1\u7684 Sidecar\uff0c\u5728\u903b\u8f91\u4e0a\u4e3a\u670d\u52a1\u589e\u52a0\u4e86 Envoy \u7684\u8bb8\u591a\u5185\u7f6e\u7279\u6027\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u52a8\u6001\u670d\u52a1\u53d1\u73b0</li> <li>\u8d1f\u8f7d\u5747\u8861</li> <li>TLS \u6821\u9a8c</li> <li>HTTP/2 \u4e0e gRPC \u4ee3\u7406</li> <li>\u7194\u65ad\u5668</li> <li>\u5065\u5eb7\u68c0\u67e5</li> <li>\u57fa\u4e8e\u767e\u5206\u6bd4\u6d41\u91cf\u5206\u5272\u7684\u5206\u9636\u6bb5\u53d1\u5e03</li> <li>\u6545\u969c\u6ce8\u5165</li> <li>\u4e30\u5bcc\u7684\u6307\u6807</li> </ul> <p>\u8fd9\u79cd Sidecar \u90e8\u7f72\u5141\u8bb8 Istio \u53ef\u4ee5\u6267\u884c\u7b56\u7565\u51b3\u7b56\uff0c\u5e76\u63d0\u53d6\u4e30\u5bcc\u7684\u9065\u6d4b\u6570\u636e\uff0c\u63a5\u7740\u5c06\u8fd9\u4e9b\u6570\u636e\u53d1\u9001\u5230\u76d1\u89c6\u7cfb\u7edf\u4ee5\u63d0\u4f9b\u6709\u5173\u6574\u4e2a\u7f51\u683c\u884c\u4e3a\u7684\u4fe1\u606f\u3002</p> <p>Sidecar \u4ee3\u7406\u6a21\u578b\u8fd8\u5141\u8bb8\u4f60\u5411\u73b0\u6709\u7684\u5e94\u7528\u6dfb\u52a0 Istio \u529f\u80fd\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u8bbe\u8ba1\u67b6\u6784\u6216\u91cd\u5199\u4ee3\u7801\u3002</p> <p>\u7531 Envoy \u4ee3\u7406\u542f\u7528\u7684\u4e00\u4e9b Istio \u7684\u529f\u80fd\u548c\u4efb\u52a1\u5305\u62ec\uff1a</p> <ul> <li>\u6d41\u91cf\u63a7\u5236\u529f\u80fd\uff1a\u901a\u8fc7\u4e30\u5bcc\u7684 HTTP\u3001gRPC\u3001WebSocket \u548c TCP \u6d41\u91cf\u8def\u7531\u89c4\u5219\u6765\u6267\u884c\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u63a7\u5236\u3002</li> <li>\u7f51\u7edc\u5f39\u6027\u7279\u6027\uff1a\u91cd\u8bd5\u8bbe\u7f6e\u3001\u6545\u969c\u8f6c\u79fb\u3001\u7194\u65ad\u5668\u548c\u6545\u969c\u6ce8\u5165\u3002</li> <li>\u5b89\u5168\u6027\u548c\u8eab\u4efd\u8ba4\u8bc1\u7279\u6027\uff1a\u6267\u884c\u5b89\u5168\u6027\u7b56\u7565\uff0c\u5e76\u5f3a\u5236\u5b9e\u884c\u901a\u8fc7\u914d\u7f6e API \u5b9a\u4e49\u7684\u8bbf\u95ee\u63a7\u5236\u548c\u901f\u7387\u9650\u5236\u3002</li> <li>\u57fa\u4e8e WebAssembly \u7684\u53ef\u63d2\u62d4\u6269\u5c55\u6a21\u578b\uff0c\u5141\u8bb8\u901a\u8fc7\u81ea\u5b9a\u4e49\u7b56\u7565\u6267\u884c\u548c\u751f\u6210\u7f51\u683c\u6d41\u91cf\u7684\u9065\u6d4b\u3002</li> </ul>"},{"location":"chap4/1Istio_Intro/#3-2-istiod","title":"3-2 Istiod","text":"<p>\u7ec4\u4ef6 Istiod \u63d0\u4f9b\u670d\u52a1\u53d1\u73b0\u3001\u914d\u7f6e\u548c\u8bc1\u4e66\u7ba1\u7406\u3002</p> <p>Istiod \u5c06\u63a7\u5236\u6d41\u91cf\u884c\u4e3a\u7684\u9ad8\u7ea7\u8def\u7531\u89c4\u5219\u8f6c\u6362\u4e3a Envoy \u7279\u5b9a\u7684\u914d\u7f6e\uff0c\u5e76\u5728\u8fd0\u884c\u65f6\u5c06\u5176\u4f20\u64ad\u7ed9 Sidecar\u3002</p> <p>Pilot \u63d0\u53d6\u4e86\u7279\u5b9a\u5e73\u53f0\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\uff0c\u5e76\u5c06\u5176\u914d\u7f6e\u4e3a\u4e00\u79cd\u6807\u51c6\u683c\u5f0f\uff0c\u4efb\u4f55\u7b26\u5408 Envoy API \u7684 Sidecar \u90fd\u53ef\u4ee5\u4f7f\u7528\u3002</p> <p>Istio \u53ef\u4ee5\u652f\u6301\u53d1\u73b0\u591a\u79cd\u73af\u5883\uff0c\u5982 Kubernetes \u6216 VM\u3002</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528 Istio \u6d41\u91cf\u7ba1\u7406 API \u8ba9 Istiod \u91cd\u65b0\u6784\u9020 Envoy \u7684\u914d\u7f6e\uff0c\u4ee5\u4fbf\u5bf9\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\u8fdb\u884c\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\u3002</p> <p>Istiod \u901a\u8fc7\u5185\u7f6e\u7684\u8eab\u4efd\u548c\u51ed\u8bc1\u7ba1\u7406\u8fdb\u884c\u5b89\u5168\u7ba1\u7406\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Istio \u6765\u5347\u7ea7\u670d\u52a1\u7f51\u683c\u4e2d\u672a\u52a0\u5bc6\u7684\u6d41\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528 Istio \u7684\u6388\u6743\u529f\u80fd\u63a7\u5236\u8c01\u53ef\u4ee5\u8bbf\u95ee\u4f60\u7684\u670d\u52a1\u3002</p> <p>Istiod \u5145\u5f53\u8bc1\u4e66\u6388\u6743\uff08CA\uff09\uff0c\u5e76\u751f\u6210\u8bc1\u4e66\u4ee5\u5141\u8bb8\u5728\u6570\u636e\u5e73\u9762\u4e2d\u8fdb\u884c\u5b89\u5168\u7684 mTLS \u901a\u4fe1\u3002</p>"},{"location":"chap4/1Istio_Intro/#4","title":"4\u3001\u5b89\u88c5","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4ecb\u7ecd\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5 Istio\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u662f\u6700\u65b0\u7684 1.10.3 \u7248\u672c\u3002</p> <p>\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u4e0b\u8f7d\u6307\u5b9a\u7684 1.10.3 \u7248\u672c\u7684 Istio\uff1a</p> <pre><code> ~ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh -\n</code></pre> <pre><code>$ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh -\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   102  100   102    0     0     41      0  0:00:02  0:00:02 --:--:--    41\n100  4573  100  4573    0     0    994      0  0:00:04  0:00:04 --:--:--  4191\n\nDownloading istio-1.10.3 from https://github.com/istio/istio/releases/download/1.10.3/istio-1.10.3-osx.tar.gz ...\nIstio 1.10.3 Download Complete!\n\nIstio has been successfully downloaded into the istio-1.10.3 folder on your system.\n\nNext Steps:\nSee https://istio.io/latest/docs/setup/install/ to add Istio to your Kubernetes cluster.\n\nTo configure the istioctl client tool for your workstation,\nadd the /Users/i515190/k8s_test/istio/istio-1.10.3/bin directory to your environment path variable with:\n         export PATH=\"$PATH:/Users/i515190/k8s_test/istio/istio-1.10.3/bin\"\n\nBegin the Istio pre-installation check by running:\n         istioctl x precheck \n\nNeed more information? Visit https://istio.io/latest/docs/setup/install/\n</code></pre> <p>\u5982\u679c\u5b89\u88c5\u5931\u8d25\uff0c\u53ef\u4ee5\u7528\u624b\u52a8\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\uff0c\u5728 GitHub Release \u9875\u9762\u83b7\u53d6\u5bf9\u5e94\u7cfb\u7edf\u7684\u4e0b\u8f7d\u5730\u5740\uff1a</p> <pre><code># \u6ce8\u610f\u9009\u62e9\u548c\u81ea\u5df1\u64cd\u4f5c\u7cfb\u7edf\u5339\u914d\u7684\u6587\u4ef6\n\u279c  ~ wget https://github.com/istio/istio/releases/download/1.10.3/istio-1.10.3-linux-amd64.tar.gz\n\u279c  ~ tar -xzf istioctl-1.10.3-linux-amd64.tar.gz\n# \u8fdb\u5165\u5230 istio \u89e3\u538b\u7684\u76ee\u5f55\n\u279c  ~ cd istio-1.10.3 &amp;&amp; ls -la\ntotal 48\ndrwxr-x---@   9 ych  staff    288 Jul 15 13:32 .\ndrwx---r-x@ 482 ych  staff  15424 Jul 20 14:17 ..\n-rw-r--r--@   1 ych  staff  11348 Jul 15 13:32 LICENSE\n-rw-r--r--@   1 ych  staff   5866 Jul 15 13:32 README.md\ndrwxr-x---@   3 ych  staff     96 Jul 15 13:32 bin\n-rw-r-----@   1 ych  staff    854 Jul 15 13:32 manifest.yaml\ndrwxr-xr-x@   5 ych  staff    160 Jul 15 13:32 manifests\ndrwxr-xr-x@  21 ych  staff    672 Jul 15 13:32 samples\ndrwxr-xr-x@   5 ych  staff    160 Jul 15 13:32 tools\n</code></pre> <p>\u5176\u4e2d <code>samples/</code> \u76ee\u5f55\u4e0b\u9762\u662f\u4e00\u4e9b\u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\uff0c<code>bin/</code> \u76ee\u5f55\u4e0b\u9762\u7684 <code>istioctl</code>\u662f Istio \u7684 CLI \u5de5\u5177\uff0c\u53ef\u4ee5\u5c06\u8be5 <code>bin/</code> \u76ee\u5f55\u52a0\u5165\u5230 <code>PATH</code> \u8def\u5f84\u4e4b\u4e0b\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u62f7\u8d1d\u5230\u67d0\u4e2a <code>PATH</code> \u76ee\u5f55\u4e0b\u53bb\uff1a</p> <pre><code>$ cd istio-1.10.3\n$ sudo cp bin/istioctl /usr/local/bin/istioctl\n\n\n$ istioctl version\nno running Istio pods in \"istio-system\"\n1.10.3\n</code></pre> <p>\u5b89\u88c5 istio \u7684\u5de5\u5177\u548c\u6587\u4ef6\u51c6\u5907\u597d\u8fc7\u540e\uff0c\u76f4\u63a5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u5b89\u88c5\u547d\u4ee4\u5373\u53ef\uff0c\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u7684\u662f <code>demo</code>\u914d\u7f6e\u7ec4\u5408\u7684\u5f62\u5f0f\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u5305\u542b\u4e86\u4e00\u7ec4\u4e13\u4e3a\u6d4b\u8bd5\u51c6\u5907\u7684\u529f\u80fd\u96c6\u5408\uff0c\u53e6\u5916\u8fd8\u6709\u7528\u4e8e\u751f\u4ea7\u6216\u6027\u80fd\u6d4b\u8bd5\u7684\u914d\u7f6e\u7ec4\u5408\u3002</p> <pre><code>$  istioctl install --set profile=demo -y\n\u2714 Istio core installed                                                                                                              \n\u2714 Istiod installed                                                                                                                  \n\u2714 Ingress gateways installed                                                                                                        \n\u2714 Egress gateways installed                                                                                                         \n\u2714 Installation complete                                                                                                             \nThank you for installing Istio 1.10.  Please take a few minutes to tell us about your install/upgrade experience!  https://forms.gle\n/KjkrDnMPByq7akrYA\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 Pod \u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -n istio-system\nNAME                                   READY   STATUS    RESTARTS   AGE\nistio-egressgateway-5547fcc8fc-flqkt   1/1     Running   0          3m6s\nistio-ingressgateway-8f568d595-hsm6l   1/1     Running   0          3m6s\nistiod-568d797f55-56vg9                1/1     Running   0          4m48s\n</code></pre> <p>\u5982\u679c\u90fd\u662f Running \u72b6\u6001\u8bc1\u660e istio \u5c31\u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002\u7136\u540e\u6211\u4eec\u8fd8\u53ef\u4ee5\u7ed9 namespace \u6dfb\u52a0\u4e00\u4e2a <code>isito-injection=enabled</code> \u7684 label \u6807\u7b7e\uff0c\u6307\u793a Istio \u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u81ea\u52a8\u6ce8\u5165 <code>Envoy Sidecar</code> \u4ee3\u7406\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u7ed9 default \u547d\u540d\u7a7a\u95f4\u6ce8\u5165\u81ea\u52a8\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl label namespace default istio-injection=enabled\nnamespace/default labeled\n</code></pre>"},{"location":"chap4/1Istio_Intro/#4_1","title":"4\u3001\u90e8\u7f72\u793a\u4f8b\u5e94\u7528","text":"<p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6765\u5b89\u88c5\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u975e\u5e38\u7ecf\u5178\u7684 Bookinfo \u5e94\u7528\u793a\u4f8b\uff0c\u8fd9\u4e2a\u793a\u4f8b\u90e8\u7f72\u4e86\u4e00\u4e2a\u7528\u4e8e\u6f14\u793a\u591a\u79cd Istio \u7279\u6027\u7684\u5e94\u7528\uff0c\u8be5\u5e94\u7528\u7531\u56db\u4e2a\u5355\u72ec\u7684\u5fae\u670d\u52a1\u6784\u6210\uff0c\u8fd9\u4e2a\u5e94\u7528\u6a21\u4eff\u5728\u7ebf\u4e66\u5e97\u7684\u4e00\u4e2a\u5206\u7c7b\uff0c\u663e\u793a\u4e00\u672c\u4e66\u7684\u4fe1\u606f\u3002\u9875\u9762\u4e0a\u4f1a\u663e\u793a\u4e00\u672c\u4e66\u7684\u63cf\u8ff0\u3001\u4e66\u7c4d\u7684 ISBN\u3001\u9875\u6570\u7b49\u4fe1\u606f\uff0c\u4ee5\u53ca\u5173\u4e8e\u8fd9\u672c\u4e66\u7684\u4e00\u4e9b\u8bc4\u8bba\u3002</p> <p>Bookinfo \u5e94\u7528\u5206\u4e3a\u56db\u4e2a\u5355\u72ec\u7684\u5fae\u670d\u52a1\uff1a</p> <ul> <li>productpage\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4f1a\u8c03\u7528 <code>details</code> \u548c <code>reviews</code> \u4e24\u4e2a\u5fae\u670d\u52a1\uff0c\u7528\u6765\u751f\u6210\u9875\u9762\u3002</li> <li>details\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u4e66\u7c4d\u7684\u4fe1\u606f\u3002</li> <li>reviews\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u4e66\u7c4d\u76f8\u5173\u7684\u8bc4\u8bba\uff0c\u5b83\u8fd8\u4f1a\u8c03\u7528 ratings \u5fae\u670d\u52a1\u3002</li> <li>ratings\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u7531\u4e66\u7c4d\u8bc4\u4ef7\u7ec4\u6210\u7684\u8bc4\u7ea7\u4fe1\u606f\u3002</li> </ul> <p>reviews \u5fae\u670d\u52a1\u6709 3 \u4e2a\u7248\u672c\uff1a</p> <ul> <li>v1 \u7248\u672c\u4e0d\u4f1a\u8c03\u7528 ratings \u670d\u52a1\u3002</li> <li>v2 \u7248\u672c\u4f1a\u8c03\u7528 ratings \u670d\u52a1\uff0c\u5e76\u4f7f\u7528 1 \u5230 5 \u4e2a\u9ed1\u8272\u661f\u5f62\u56fe\u6807\u6765\u663e\u793a\u8bc4\u5206\u4fe1\u606f\u3002</li> <li>v3 \u7248\u672c\u4f1a\u8c03\u7528 ratings \u670d\u52a1\uff0c\u5e76\u4f7f\u7528 1 \u5230 5 \u4e2a\u7ea2\u8272\u661f\u5f62\u56fe\u6807\u6765\u663e\u793a\u8bc4\u5206\u4fe1\u606f\u3002</li> </ul> <p>\u4e0b\u56fe\u53ef\u4ee5\u7528\u6765\u8bf4\u660e\u6211\u4eec\u8fd9\u4e2a\u793a\u4f8b\u5e94\u7528\u7684\u6574\u4f53\u67b6\u6784\uff1a</p> <p> </p> <p>Bookinfo \u5e94\u7528\u4e2d\u7684\u51e0\u4e2a\u5fae\u670d\u52a1\u662f\u7531\u4e0d\u540c\u7684\u8bed\u8a00\u7f16\u5199\u800c\u6210\u7684\uff0c\u8fd9\u4e9b\u670d\u52a1\u5bf9 Istio \u5e76\u65e0\u4f9d\u8d56\uff0c\u4f46\u662f\u6784\u6210\u4e86\u4e00\u4e2a\u6709\u4ee3\u8868\u6027\u7684\u670d\u52a1\u7f51\u683c\u7684\u4f8b\u5b50\uff1a\u5b83\u7531\u591a\u4e2a\u670d\u52a1\u3001\u591a\u4e2a\u8bed\u8a00\u6784\u6210\uff0c\u5e76\u4e14 reviews \u670d\u52a1\u5177\u6709\u591a\u4e2a\u7248\u672c\u3002</p> <p>\u6211\u4eec\u8981\u5728 Istio \u4e2d\u8fd0\u884c\u8fd9\u4e2a\u5e94\u7528\uff0c\u4e0d\u9700\u8981\u5bf9\u5e94\u7528\u672c\u8eab\u505a\u4efb\u4f55\u6539\u53d8\uff0c\u53ea\u8981\u7b80\u5355\u7684\u5728 Istio \u73af\u5883\u4e2d\u5bf9\u670d\u52a1\u8fdb\u884c\u914d\u7f6e\u548c\u8fd0\u884c\uff0c\u4e5f\u5c31\u662f\u628a Envoy sidecar \u6ce8\u5165\u5230\u6bcf\u4e2a\u670d\u52a1\u4e4b\u4e2d\u3002\u6700\u7ec8\u7684\u90e8\u7f72\u7ed3\u679c\u5c06\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p> </p> <p>\u6240\u6709\u7684\u5fae\u670d\u52a1\u90fd\u548c Envoy sidecar \u96c6\u6210\u5728\u4e00\u8d77\uff0c\u88ab\u96c6\u6210\u670d\u52a1\u6240\u6709\u7684\u51fa\u5165\u6d41\u91cf\u90fd\u88ab sidecar \u6240\u52ab\u6301\uff0c\u8fd9\u6837\u5c31\u4e3a\u5916\u90e8\u63a7\u5236\u51c6\u5907\u4e86\u6240\u9700\u7684 Hook\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u5229\u7528 Istio \u63a7\u5236\u5e73\u9762\u4e3a\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\u8def\u7531\u3001\u9065\u6d4b\u6570\u636e\u6536\u96c6\u4ee5\u53ca\u7b56\u7565\u5b9e\u65bd\u7b49\u529f\u80fd\u3002</p> <p>\u8fdb\u5165\u4e0a\u9762\u7684 Istio \u5b89\u88c5\u76ee\u5f55\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$  kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml\nservice/details created\nserviceaccount/bookinfo-details created\ndeployment.apps/details-v1 created\nservice/ratings created\nserviceaccount/bookinfo-ratings created\ndeployment.apps/ratings-v1 created\nservice/reviews created\nserviceaccount/bookinfo-reviews created\ndeployment.apps/reviews-v1 created\ndeployment.apps/reviews-v2 created\ndeployment.apps/reviews-v3 created\nservice/productpage created\nserviceaccount/bookinfo-productpage created\ndeployment.apps/productpage-v1 created\n</code></pre> <p>\u5982\u679c\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u7981\u7528\u4e86 Sidecar \u81ea\u52a8\u6ce8\u5165\u529f\u80fd\u800c\u9009\u62e9\u624b\u52a8\u6ce8\u5165 Sidecar\uff0c\u8bf7\u5728\u90e8\u7f72\u5e94\u7528\u4e4b\u524d\u53ef\u4ee5\u4f7f\u7528 <code>istioctl kube-inject</code> \u547d\u4ee4\u6765\u6ce8\u5165 sidecar \u5bb9\u5668\u3002</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u90e8\u7f72\u7684 bookinfo.yaml \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5c31\u662f\u666e\u901a\u7684 Kubernetes \u7684 Deployment \u548c Service \u7684 yaml \u6587\u4ef6\uff0c\u4f7f\u7528 <code>istioctl kube-inject</code> \u6216\u8005\u914d\u7f6e\u81ea\u52a8\u6ce8\u5165\u540e\u4f1a\u5728\u8fd9\u4e2a\u6587\u4ef6\u7684\u57fa\u7840\u4e0a\u5411\u5176\u4e2d\u7684 Deployment \u8ffd\u52a0\u4e00\u4e2a\u955c\u50cf\u4e3a <code>docker.io/istio/proxyv2:1.10.3</code> \u7684 sidecar \u5bb9\u5668\uff0c\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u542f\u52a8\u5168\u90e8\u7684\u56db\u4e2a\u670d\u52a1\uff0c\u5176\u4e2d\u4e5f\u5305\u62ec\u4e86 <code>reviews</code> \u670d\u52a1\u7684\u4e09\u4e2a\u7248\u672c\uff08v1\u3001v2 \u4ee5\u53ca v3\uff09\u3002</p> <pre><code>$ kubectl get pods\nNAME                              READY   STATUS    RESTARTS   AGE\ndetails-v1-79f774bdb9-bxgnv       2/2     Running   0          7m3s\nproductpage-v1-6b746f74dc-drxqj   2/2     Running   0          7m3s\nratings-v1-b6994bb9-62nrz         2/2     Running   0          7m3s\nreviews-v1-545db77b95-lgcjt       2/2     Running   0          7m3s\nreviews-v2-7bf8c9648f-mlfb7       2/2     Running   0          7m3s\nreviews-v3-84779c7bbc-fnqbg       2/2     Running   0          7m3s\n\n$ kubectl get svc\nNAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\ndetails       ClusterIP   10.110.179.156   &lt;none&gt;        9080/TCP   7m7s\nkubernetes    ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    20h\nproductpage   ClusterIP   10.96.138.142    &lt;none&gt;        9080/TCP   7m7s\nratings       ClusterIP   10.102.119.192   &lt;none&gt;        9080/TCP   7m7s\nreviews       ClusterIP   10.102.66.198    &lt;none&gt;        9080/TCP   7m7s\n</code></pre> <p>\u73b0\u5728\u5e94\u7528\u7684\u670d\u52a1\u90fd\u90e8\u7f72\u6210\u529f\u5e76\u542f\u52a8\u4e86\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\uff0c\u5c31\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a istio gateway\uff0cgateway \u76f8\u5f53\u4e8e k8s \u7684 ingress controller \u548c ingress\uff0c\u5b83\u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\uff0c\u901a\u5e38\u5728\u670d\u52a1\u7f51\u683c\u8fb9\u7f18\u4f5c\u4e3a\u5e94\u7528\u7684 ingress \u6d41\u91cf\u7ba1\u7406\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a Ingress gateway:</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml\ngateway.networking.istio.io/bookinfo-gateway created\nvirtualservice.networking.istio.io/bookinfo created\n</code></pre> <p>\u9a8c\u8bc1 gateway \u662f\u5426\u521b\u5efa\u6210\u529f:</p> <pre><code>$  kubectl get gateway\nNAME               AGE\nbookinfo-gateway   72s\n</code></pre> <p>\u8981\u60f3\u8bbf\u95ee\u8fd9\u4e2a\u5e94\u7528\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u66f4\u6539\u4e0b istio \u63d0\u4f9b\u7684 istio-ingressgateway \u8fd9\u4e2a Service \u5bf9\u8c61\uff0c\u9ed8\u8ba4\u662f LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff1a</p> <pre><code>$  kubectl get svc -n istio-system\nNAME                   TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                         \n             AGE\nistio-egressgateway    ClusterIP      10.101.179.89   &lt;none&gt;        80/TCP,443/TCP                                                  \n             3h16m\nistio-ingressgateway   LoadBalancer   10.99.72.32     localhost     15021:32556/TCP,80:31102/TCP,443:30657/TCP,31400:32719/TCP,15443\n:31978/TCP   3h16m\nistiod                 ClusterIP      10.107.4.189    &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP  3h18m\n</code></pre> <p>LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u5b9e\u9645\u4e0a\u662f\u7528\u6765\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\uff0c\u5982\u679c\u6211\u4eec\u6ca1\u6709\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\u8bdd\uff0c\u53ef\u4ee5\u5c06\u8fd9\u91cc\u7c7b\u578b\u6539\u6210 NodePort\uff0c\u4f46\u662f\u8fd9\u6837\u5f53\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u7684\u65f6\u5019\u5c31\u9700\u8981\u52a0\u4e0a nodePort \u7aef\u53e3\u4e86\uff1a</p> <pre><code>$ kubectl edit svc istio-ingressgateway -n istio-system\nservice/istio-ingressgateway edited\n</code></pre> <pre><code>......\ntype: NodePort  # \u4fee\u6539\u6210 NodePort \u7c7b\u578b\nstatus:\n  loadBalancer: {}\n</code></pre> <pre><code>$  kubectl get svc -n istio-system\nNAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                            \n          AGE\nistio-egressgateway    ClusterIP   10.101.179.89   &lt;none&gt;        80/TCP,443/TCP                                                     \n          3h20m\nistio-ingressgateway   NodePort    10.99.72.32     &lt;none&gt;        15021:32556/TCP,80:31102/TCP,443:30657/TCP,31400:32719/TCP,15443:31\n978/TCP   3h20m\nistiod                 ClusterIP   10.107.4.189    &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                              \n          3h22m\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>http://&lt;NodeIP&gt;:&lt;nodePort&gt;/productpage</code> \u4ece\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee Bookinfo \u5e94\u7528\u4e86\uff1a</p> <pre><code>http://127.0.0.1:31102/productpage\n</code></pre> <p> </p> <p>\u5237\u65b0\u9875\u9762\u53ef\u4ee5\u770b\u5230 Book Reviews \u53d1\u751f\u4e86\u6539\u53d8\uff08\u7ea2\u8272\u3001\u9ed1\u8272\u7684\u661f\u5f62\u6216\u8005\u6ca1\u6709\u663e\u793a\uff09\uff0c\u56e0\u4e3a\u6bcf\u6b21\u8bf7\u6c42\u4f1a\u88ab\u8def\u7531\u5230\u5230\u4e86\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\u53bb\u3002</p>"},{"location":"chap4/1Istio_Intro/#5","title":"5\u3001\u4eea\u8868\u76d8","text":"<p>\u4e0a\u9762\u6211\u4eec\u662f\u5b89\u88c5\u7684 Istio \u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u6b64\u5916 Istio \u8fd8\u548c\u4e00\u4e9b\u9065\u6d4b\u5e94\u7528\u505a\u4e86\u96c6\u6210\uff0c\u9065\u6d4b\u80fd\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u670d\u52a1\u7f51\u683c\u7684\u7ed3\u6784\u3001\u5c55\u793a\u7f51\u7edc\u7684\u62d3\u6251\u7ed3\u6784\u3001\u5206\u6790\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u6001\u7b49\uff0c\u5bf9\u4e8e\u5206\u5e03\u5f0f\u5fae\u670d\u52a1\u5e94\u7528\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u90e8\u7f72 Kiali\u3001Prometheus\u3001Grafana \u4ee5\u53ca Jaeger\uff1a</p> <pre><code>kubectl apply -f samples/addons\n# \u5982\u679c\u51fa\u73b0\u4e86\u9519\u8bef\uff0c\u5219\u53ef\u4ee5\u91cd\u65b0\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\n\n\n$ kubectl get pods -n istio-system\nNAME                                    READY   STATUS    RESTARTS   AGE\ngrafana-f766d6c97-4888w                 1/1     Running   0          3m57s\nistio-egressgateway-5c8d96c9b5-6d5g9    1/1     Running   0          60m\nistio-ingressgateway-6bcfd457f9-wpj7w   1/1     Running   0          60m\nistiod-775bcf58f7-v6jl2                 1/1     Running   0          61m\njaeger-7f78b6fb65-bj8pm                 1/1     Running   0          3m56s\nkiali-85c8cdd5b5-b5zv4                  1/1     Running   0          3m55s\nprometheus-54b5dcf6bf-wjkpl             3/3     Running   0          3m48s\n</code></pre> <p>\u4e0a\u9762\u51e0\u4e2a\u7ec4\u4ef6\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u524d\u9762 Bookinfo \u793a\u4f8b\u5e94\u7528\u7684\u9065\u6d4b\u4fe1\u606f\u4e86\uff0c\u6bd4\u5982\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8bbf\u95ee Kiali\uff1a</p> <pre><code>istioctl dashboard kiali\n</code></pre> <p>\u5728\u5de6\u4fa7\u7684\u5bfc\u822a\u83dc\u5355\uff0c\u9009\u62e9 Graph \uff0c\u7136\u540e\u5728 Namespace \u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9009\u62e9 default \u3002Kiali \u4eea\u8868\u677f\u5c55\u793a\u4e86\u7f51\u683c\u7684\u6982\u89c8\u3001\u4ee5\u53ca Bookinfo \u793a\u4f8b\u5e94\u7528\u7684\u5404\u4e2a\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u5b83\u8fd8\u63d0\u4f9b\u8fc7\u6ee4\u5668\u6765\u53ef\u89c6\u5316\u6d41\u91cf\u7684\u6d41\u52a8\u3002</p> <p> </p> <p>\u81f3\u6b64\uff0c\u6574\u4e2a Istio \u548c Bookinfo \u793a\u4f8b\u5e94\u7528\u5c31\u5b89\u88c5\u5e76\u9a8c\u8bc1\u6210\u529f\u4e86\uff0c\u73b0\u5728\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e00\u5e94\u7528\u6765\u4f53\u9a8c Istio \u7684\u7279\u6027\u4e86\uff0c\u5176\u4e2d\u5305\u62ec\u4e86\u6d41\u91cf\u7684\u8def\u7531\u3001\u9519\u8bef\u6ce8\u5165\u3001\u901f\u7387\u9650\u5236\u7b49\u7279\u6027\u3002</p> <p>\u76ee\u524d\u642d\u5efa Bookinfo \u5e94\u7528\u6211\u4eec\u53ea\u7528\u5230\u4e86\u4e0b\u9762\u4e24\u4e2a\u8d44\u6e90\u6587\u4ef6\uff1a</p> <pre><code>samples/bookinfo/platform/kube/bookinfo.yaml\nsamples/bookinfo/networking/bookinfo-gateway.yaml\n</code></pre> <p>\u524d\u8005\u5c31\u662f\u901a\u5e38\u7684 Kubernetes \u5b9a\u4e49\u7684 Deployment \u548c Service \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u53ea\u662f\u5728\u90e8\u7f72\u65f6\u4f7f\u7528 <code>istioctl kube-inject</code>\uff08\u6216\u8005\u901a\u8fc7\u5bf9\u547d\u540d\u7a7a\u95f4\u6253\u4e0a\u81ea\u52a8\u6ce8\u5165\u7684\u6807\u7b7e\uff09\u5bf9\u8fd9\u4e2a\u6587\u4ef6\u5b9a\u4e49\u7684 Pod \u6ce8\u5165\u4e86 <code>sidecar</code> \u4ee3\u7406\uff0c\u540e\u8005\u5b9a\u4e49\u4e86\u8fd9\u4e2a\u5e94\u7528\u7684\u5916\u90e8\u8bbf\u95ee\u5165\u53e3 gateway\uff0c\u4ee5\u53ca\u5e94\u7528\u5185\u90e8 productpage \u670d\u52a1\u7684 VirtualService \u89c4\u5219\uff0c\u800c\u5176\u4ed6\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fd8\u6ca1\u6709\u88ab\u5b9a\u4e49\u3002</p> <p>\u73b0\u5728\u8bbf\u95ee\u5e94\u7528\u754c\u9762\u5e76\u5237\u65b0\uff0c\u4f1a\u770b\u5230 Reviews \u6709\u65f6\u4e0d\u4f1a\u663e\u793a\u8bc4\u5206\uff0c\u6709\u65f6\u5019\u4f1a\u663e\u793a\u4e0d\u540c\u6837\u5f0f\u7684\u8bc4\u5206\uff0c\u8fd9\u662f\u56e0\u4e3a\u540e\u9762\u67093\u4e2a\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\uff0c\u800c\u6ca1\u6709\u914d\u7f6e\u8be5\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\u7684\u60c5\u51b5\u4e0b\uff0c\u8be5\u670d\u52a1\u7684\u51e0\u4e2a\u5b9e\u4f8b\u4f1a\u88ab\u968f\u673a\u8bbf\u95ee\u5230\uff0c\u6709\u7684\u7248\u672c\u670d\u52a1\u4f1a\u8fdb\u4e00\u6b65\u8c03\u7528 Ratings \u670d\u52a1\uff0c\u6709\u7684\u4e0d\u4f1a\u3002</p>"},{"location":"chap4/2Istio_flow_control/","title":"\u7b2c\u4e8c\u8282 \u4f7f\u7528 Istio \u5b9e\u73b0\u975e\u4fb5\u5165\u6d41\u91cf\u6cbb\u7406","text":"<p>Istio \u4e2d\u4e24\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6d41\u91cf\u7ba1\u7406\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <ul> <li><code>VirtualService</code>\uff08\u865a\u62df\u670d\u52a1\uff09\uff1a\u7528\u6765\u5728 Istio \u4e2d\u5b9a\u4e49\u8def\u7531\u89c4\u5219\uff0c\u63a7\u5236\u6d41\u91cf\u8def\u7531\u5230\u670d\u52a1\u4e0a\u7684\u5404\u79cd\u884c\u4e3a\u3002</li> <li><code>DestinationRule</code>\uff08\u76ee\u6807\u89c4\u5219\uff09\uff1a\u865a\u62df\u670d\u52a1\u89c6\u5b9a\u4e49\u5c06\u6d41\u91cf\u5982\u4f55\u8def\u7531\u5230\u6307\u5b9a\u76ee\u6807\u5730\u5740\uff0c\u7136\u540e\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6765\u914d\u7f6e\u8be5\u76ee\u6807\u7684\u6d41\u91cf\uff0c\u5728\u8bc4\u4f30\u865a\u62df\u670d\u52a1\u8def\u7531\u89c4\u5219\u4e4b\u540e\uff0c\u76ee\u6807\u89c4\u5219\u5c06\u5e94\u7528\u4e8e\u6d41\u91cf\u7684\u771f\u5b9e\u76ee\u6807\u5730\u5740\u3002</li> </ul>"},{"location":"chap4/2Istio_flow_control/#1virtualservice","title":"1\u3001VirtualService","text":"<p>\u865a\u62df\u670d\u52a1\uff08VirtualService\uff09\u548c\u76ee\u6807\u89c4\u5219\uff08Destination Rule\uff09\u662f Istio \u6d41\u91cf\u8def\u7531\u529f\u80fd\u7684\u5173\u952e\u5bf9\u8c61\uff0c\u865a\u62df\u670d\u52a1\u914d\u7f6e\u5982\u4f55\u5728 Istio \u5185\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u670d\u52a1\uff0c\u6bcf\u4e2a\u865a\u62df\u670d\u52a1\u5305\u542b\u4e00\u7ec4\u8def\u7531\u89c4\u5219\uff0cIstio \u4f1a\u6309\u5b9a\u4e49\u7684\u987a\u5e8f\u6765\u8bc4\u4f30\u5b83\u4eec\uff0cIstio \u5c06\u6bcf\u4e2a\u6307\u5b9a\u7684\u8bf7\u6c42\u5339\u914d\u5230\u865a\u62df\u670d\u52a1\u6307\u5b9a\u7684\u5b9e\u9645\u76ee\u6807\u5730\u5740\u3002\u5728\u7f51\u683c\u4e2d\u53ef\u4ee5\u6709\u591a\u4e2a\u865a\u62df\u670d\u52a1\uff0c\u4e5f\u53ef\u4ee5\u6ca1\u6709\u3002</p> <p>\u4f7f\u7528\u865a\u62df\u670d\u52a1\uff0c\u4f60\u53ef\u4ee5\u4e3a\u4e00\u4e2a\u6216\u591a\u4e2a\u4e3b\u673a\u540d\u6307\u5b9a\u6d41\u91cf\u884c\u4e3a\uff0c\u5728\u865a\u62df\u670d\u52a1\u4e2d\u4f7f\u7528\u8def\u7531\u89c4\u5219\uff0c\u544a\u8bc9 Envoy \u5982\u4f55\u53d1\u9001\u865a\u62df\u670d\u52a1\u7684\u6d41\u91cf\u5230\u5408\u9002\u7684\u76ee\u6807\uff0c\u8def\u7531\u76ee\u6807\u5730\u5740\u53ef\u4ee5\u662f\u540c\u4e00\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\uff0c\u4e5f\u53ef\u4ee5\u662f\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\u3002</p> <p>\u4e00\u4e2a\u5178\u578b\u7684\u4f7f\u7528\u573a\u666f\u662f\u5c06\u6d41\u91cf\u53d1\u9001\u5230\u6307\u5b9a\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u3002</p> <p>\u5ba2\u6237\u7aef\u4f1a\u5c06\u865a\u62df\u670d\u52a1\u89c6\u4e3a\u4e00\u4e2a\u5355\u4e00\u5b9e\u4f53\uff0c\u5c06\u8bf7\u6c42\u53d1\u9001\u81f3\u865a\u62df\u670d\u52a1\u4e3b\u673a\uff0c\u7136\u540e Envoy \u6839\u636e\u865a\u62df\u670d\u52a1\u89c4\u5219\u628a\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684\u7248\u672c\u3002</p> <p>\u6bd4\u5982\u628a 20% \u7684\u6d41\u91cf\u8def\u7531\u5230\u65b0\u7248\u672c \u6216 \u5c06\u8fd9\u4e9b\u7528\u6237\u7684\u8bf7\u6c42\u8def\u7531\u5230\u7248\u672c 2\uff0c\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u7136\u540e\u9010\u6b65\u589e\u52a0\u53d1\u9001\u5230\u65b0\u7248\u672c\u670d\u52a1\u7684\u6d41\u91cf\u767e\u5206\u6bd4\u3002</p> <p>\u6d41\u91cf\u8def\u7531\u5b8c\u5168\u72ec\u7acb\u4e8e\u5b9e\u4f8b\u90e8\u7f72\uff0c\u6240\u4ee5\u5b9e\u73b0\u65b0\u7248\u672c\u670d\u52a1\u7684\u5b9e\u4f8b\u53ef\u4ee5\u6839\u636e\u6d41\u91cf\u7684\u8d1f\u8f7d\u6765\u4f38\u7f29\uff0c\u5b8c\u5168\u4e0d\u5f71\u54cd\u6d41\u91cf\u8def\u7531\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0cKubernetes \u5219\u53ea\u652f\u6301\u57fa\u4e8e\u5b9e\u4f8b\u7f29\u653e\u7684\u6d41\u91cf\u5206\u53d1\uff0c\u8fd9\u4f1a\u66f4\u590d\u6742\u3002</p> <p>\u5982\u4e0b\u6240\u793a\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u865a\u62df\u670d\u52a1\uff0c\u6839\u636e\u8bf7\u6c42\u662f\u5426\u6765\u81ea\u67d0\u4e2a\u7279\u5b9a\u7528\u6237\uff0c\u628a\u5b83\u4eec\u8def\u7531\u5230\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u53bb\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts: # \u5217\u51faVirtualService\u7684hosts\uff0c\u53ef\u4ee5\u662fIP\u3001DNS\u540d\u79f0\u3001FQDN\u6216*\n  - reviews\n  http: # \u5728\u4e0b\u9762\u914d\u7f6eVirtualService\u7684\u8def\u7531\u89c4\u5219\uff0c\u6307\u5b9a\u7b26\u5408\u54ea\u4e9b\u89c4\u5219\u7684\u6d41\u91cf\u6253\u5230\u54ea\u4e9bDestination\uff0c\u652f\u6301HTTP/1.1\uff0cHTTP2\uff0c\u53cagRPC\u7b49\u534f\u8bae\n  - match: # \u6307\u5b9a\u5177\u4f53\u7684\u5339\u914d\u89c4\u5219\n    - headers:\n        end-user:\n          exact: jason\n    route:\n    - destination: # \u6307\u5b9a\u6ee1\u8db3\u89c4\u5219\u540e\u5c06\u6d41\u91cf\u6253\u5230\u54ea\u4e2a\u5177\u4f53\u7684Destination\n        host: reviews\n        subset: v2\n  - route:  # \u6d41\u91cf\u89c4\u5219\u6309\u4ece\u4e0a\u5230\u4e0b\u7684\u4f18\u5148\u7ea7\u53bb\u5339\u914d\uff0c\u82e5\u4e0d\u6ee1\u8db3\u4e0a\u8ff0\u89c4\u5219\u65f6\uff0c\u8fdb\u5165\u8be5\u9ed8\u8ba4\u89c4\u5219\n    - destination:\n        host: reviews\n        subset: v3\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528 hosts \u5b57\u6bb5\u5217\u4e3e\u865a\u62df\u670d\u52a1\u7684\u4e3b\u673a\u2014\u2014\u5373\u7528\u6237\u6307\u5b9a\u7684\u76ee\u6807\u6216\u662f\u8def\u7531\u89c4\u5219\u8bbe\u5b9a\u7684\u76ee\u6807\uff0c\u8fd9\u662f\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\u65f6\u4f7f\u7528\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u5730\u5740\u3002</p> <pre><code>hosts:\n- reviews\n</code></pre> <p>\u865a\u62df\u670d\u52a1\u4e3b\u673a\u540d\u53ef\u4ee5\u662f IP \u5730\u5740\u3001DNS \u540d\u79f0\uff0c\u6bd4\u5982 Kubernetes Service \u7684\u77ed\u540d\u79f0\uff0c\u9690\u5f0f\u6216\u663e\u5f0f\u5730\u6307\u5411\u4e00\u4e2a\u5b8c\u5168\u9650\u5b9a\u57df\u540d\uff08FQDN\uff09\u3002</p> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26\uff08\u201c*\u201d\uff09\u524d\u7f00\uff0c\u521b\u5efa\u4e00\u7ec4\u5339\u914d\u6240\u6709\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\u3002\u865a\u62df\u670d\u52a1\u7684 hosts \u5b57\u6bb5\u5b9e\u9645\u4e0a\u4e0d\u5fc5\u662f Istio \u670d\u52a1\u6ce8\u518c\u7684\u4e00\u90e8\u5206\uff0c\u5b83\u53ea\u662f\u865a\u62df\u7684\u76ee\u6807\u5730\u5740\uff0c\u8fd9\u6837\u53ef\u4ee5\u4e3a\u6ca1\u6709\u8def\u7531\u5230\u7f51\u683c\u5185\u90e8\u7684\u865a\u62df\u4e3b\u673a\u5efa\u6a21\u3002</p> <p>\u7136\u540e\u63a5\u7740\u5c31\u662f\u8def\u7531\u89c4\u5219\u7684\u5b9a\u4e49\uff0c\u8fd9\u91cc\u901a\u8fc7 http \u5b57\u6bb5\u6765\u5b9a\u4e49\u865a\u62df\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\uff0c\u7528\u6765\u63cf\u8ff0\u5339\u914d\u6761\u4ef6\u548c\u8def\u7531\u884c\u4e3a\uff0c\u5b83\u4eec\u628a HTTP/1.1\u3001HTTP2 \u548c gRPC \u7b49\u6d41\u91cf\u53d1\u9001\u5230 hosts \u5b57\u6bb5\u6307\u5b9a\u7684\u76ee\u6807\uff0c\u4e00\u6761\u8def\u7531\u89c4\u5219\u5305\u542b\u4e86\u6307\u5b9a\u7684\u8bf7\u6c42\u8981\u6d41\u5411\u54ea\u4e2a\u76ee\u6807\u5730\u5740\uff0c\u53ef\u4ee5\u67090\u4e2a\u6216\u591a\u4e2a\u5339\u914d\u6761\u4ef6\u3002</p> <p>\u6bd4\u5982\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684\u7b2c\u4e00\u4e2a\u8def\u7531\u89c4\u5219\u6709\u4e00\u4e2a\u6761\u4ef6\uff0c\u6240\u4ee5\u4f7f\u7528 match \u5b57\u6bb5\u5f00\u59cb\u5b9a\u4e49\uff0c\u6211\u4eec\u5e0c\u671b\u8be5\u8def\u7531\u5e94\u7528\u4e8e\u6765\u81ea jason \u7528\u6237\u7684\u6240\u6709\u8bf7\u6c42\uff0c\u6240\u4ee5\u4f7f\u7528 headers\u3001end-user \u548c exact \u5b57\u6bb5\u6765\u5339\u914d\u5408\u9002\u7684\u8bf7\u6c42\u3002</p> <pre><code>- match:\n  - headers:\n    end-user:\n      exact: jason\n</code></pre> <p>\u7136\u540e\u540e\u9762\u7684 route \u90e8\u5206\u7684 destination \u5b57\u6bb5\u6307\u5b9a\u4e86\u7b26\u5408\u8be5\u6761\u4ef6\u7684\u6d41\u91cf\u7684\u5b9e\u9645\u76ee\u6807\u5730\u5740\uff0c\u4e0e\u865a\u62df\u670d\u52a1\u7684 hosts \u4e0d\u540c\uff0cdestination \u7684 host \u5fc5\u987b\u662f\u5b58\u5728\u4e8e Istio \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\u7684\u5b9e\u9645\u76ee\u6807\u5730\u5740\uff0c\u5426\u5219 Envoy \u4e0d\u77e5\u9053\u8be5\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u54ea\u91cc\u3002</p> <p>\u53ef\u4ee5\u662f\u4e00\u4e2a\u6709\u4ee3\u7406\u7684\u670d\u52a1\u7f51\u683c\uff0c\u6216\u8005\u662f\u4e00\u4e2a\u901a\u8fc7\u670d\u52a1\u5165\u53e3\u88ab\u6dfb\u52a0\u8fdb\u6765\u7684\u975e\u7f51\u683c\u670d\u52a1\u3002\u672c\u793a\u4f8b\u8fd0\u884c\u5728 Kubernetes \u73af\u5883\u4e2d\uff0chost \u540d\u4e3a\u4e00\u4e2a Kubernetes \u670d\u52a1\u540d\uff1a</p> <pre><code>route:\n- destination:\n    host: reviews  # Kubernetes Service \u77ed\u540d\u79f0\n    subset: v2\n</code></pre> <p>\u6b64\u5916 destination \u4e0b\u9762\u8fd8\u6307\u5b9a\u4e86 Kubernetes \u670d\u52a1\u7684\u5b50\u96c6\uff0c\u5c06\u7b26\u5408\u6b64\u89c4\u5219\u6761\u4ef6\u7684\u8bf7\u6c42\u8f6c\u5165\u5176\u4e2d\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u5b50\u96c6\u540d\u79f0\u662f v2\uff0c\u6211\u4eec\u4f1a\u5728\u76ee\u6807\u89c4\u5219\u4e2d\u770b\u5230\u5982\u4f55\u5b9a\u4e49\u670d\u52a1\u5b50\u96c6\u3002</p> <p>\u8def\u7531\u89c4\u5219\u662f\u6309\u4ece\u4e0a\u5230\u4e0b\u7684\u987a\u5e8f\u9009\u62e9\u7684\uff0c\u865a\u62df\u670d\u52a1\u4e2d\u5b9a\u4e49\u7684\u7b2c\u4e00\u6761\u89c4\u5219\u6709\u6700\u9ad8\u4f18\u5148\u7ea7\u3002\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684\u865a\u62df\u670d\u52a1\u4e2d\uff0c\u4e0d\u6ee1\u8db3\u7b2c\u4e00\u4e2a\u8def\u7531\u89c4\u5219\u7684\u6d41\u91cf\u5747\u4f1a\u6d41\u5411\u4e00\u4e2a\u9ed8\u8ba4\u7684\u76ee\u6807\uff0c\u7b2c\u4e8c\u6761\u89c4\u5219\u6ca1\u6709\u914d\u7f6e match \u6761\u4ef6\uff0c\u76f4\u63a5\u5c06\u6d41\u91cf\u5bfc\u5411 v3 \u5b50\u96c6\u3002</p> <pre><code>- route:\n  - destination:\n      host: reviews\n      subset: v3\n</code></pre> <p>\u4e00\u822c\u5efa\u8bae\u63d0\u4f9b\u4e00\u4e2a\u9ed8\u8ba4\u7684\u65e0\u6761\u4ef6\u6216\u57fa\u4e8e\u6743\u91cd\u7684\u89c4\u5219\u4f5c\u4e3a\u6bcf\u4e00\u4e2a\u865a\u62df\u670d\u52a1\u7684\u6700\u540e\u4e00\u6761\u89c4\u5219\uff0c\u4ece\u800c\u786e\u4fdd\u6d41\u7ecf\u865a\u62df\u670d\u52a1\u7684\u6d41\u91cf\u81f3\u5c11\u80fd\u591f\u5339\u914d\u5230\u4e00\u6761\u8def\u7531\u89c4\u5219\u3002</p>"},{"location":"chap4/2Istio_flow_control/#2destinationrule","title":"2\u3001DestinationRule","text":"<p>\u4e0e\u865a\u62df\u670d\u52a1\u4e00\u6837\uff0cDestinationRule\uff08\u76ee\u6807\u89c4\u5219\uff09\u4e5f\u662f Istio \u6d41\u91cf\u8def\u7531\u529f\u80fd\u7684\u5173\u952e\u90e8\u5206\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u865a\u62df\u670d\u52a1\u770b\u6210\u5c06\u6d41\u91cf\u5982\u4f55\u8def\u7531\u5230\u6307\u5b9a\u76ee\u6807\u5730\u5740\uff0c\u7136\u540e\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6765\u914d\u7f6e\u8be5\u76ee\u6807\u7684\u6d41\u91cf\u3002</p> <p>\u5728\u8bc4\u4f30\u865a\u62df\u670d\u52a1\u8def\u7531\u89c4\u5219\u4e4b\u540e\uff0c\u76ee\u6807\u89c4\u5219\u5c06\u5e94\u7528\u4e8e\u6d41\u91cf\u7684\u201c\u771f\u5b9e\u201d\u76ee\u6807\u5730\u5740\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6765\u6307\u5b9a\u547d\u540d\u7684\u670d\u52a1\u5b50\u96c6\uff0c\u4f8b\u5982\u6309\u7248\u672c\u4e3a\u6240\u6709\u6307\u5b9a\u670d\u52a1\u7684\u5b9e\u4f8b\u5206\u7ec4\uff0c\u7136\u540e\u53ef\u4ee5\u5728\u865a\u62df\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u670d\u52a1\u5b50\u96c6\u6765\u63a7\u5236\u5230\u670d\u52a1\u4e0d\u540c\u5b9e\u4f8b\u7684\u6d41\u91cf\u3002</p> <p>\u76ee\u6807\u89c4\u5219\u8fd8\u5141\u8bb8\u4f60\u5728\u8c03\u7528\u6574\u4e2a\u76ee\u7684\u670d\u52a1\u6216\u7279\u5b9a\u670d\u52a1\u5b50\u96c6\u65f6\u5b9a\u5236 Envoy \u7684\u6d41\u91cf\u7b56\u7565\uff0c\u6bd4\u5982\u8d1f\u8f7d\u5747\u8861\u6a21\u578b\u3001TLS \u5b89\u5168\u6a21\u5f0f\u6216\u7194\u65ad\u5668\u8bbe\u7f6e</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio \u4f7f\u7528\u8f6e\u8be2\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u5b9e\u4f8b\u6c60\u4e2d\u7684\u6bcf\u4e2a\u5b9e\u4f8b\u4f9d\u6b21\u83b7\u53d6\u8bf7\u6c42\u3002</p> <p>Istio \u540c\u65f6\u652f\u6301\u5982\u4e0b\u7684\u8d1f\u8f7d\u5747\u8861\u6a21\u578b\uff0c\u53ef\u4ee5\u5728 <code>DestinationRule</code> \u4e2d\u4e3a\u6d41\u5411\u67d0\u4e2a\u7279\u5b9a\u670d\u52a1\u6216\u670d\u52a1\u5b50\u96c6\u7684\u6d41\u91cf\u6307\u5b9a\u8fd9\u4e9b\u6a21\u578b\u3002</p> <ul> <li>\u968f\u673a\uff1a\u8bf7\u6c42\u4ee5\u968f\u673a\u7684\u65b9\u5f0f\u8f6c\u5230\u6c60\u4e2d\u7684\u5b9e\u4f8b\u3002</li> <li>\u6743\u91cd\uff1a\u8bf7\u6c42\u6839\u636e\u6307\u5b9a\u7684\u767e\u5206\u6bd4\u8f6c\u5230\u5b9e\u4f8b\u3002</li> <li>\u6700\u5c11\u8bf7\u6c42\uff1a\u8bf7\u6c42\u88ab\u8f6c\u5230\u6700\u5c11\u88ab\u8bbf\u95ee\u7684\u5b9e\u4f8b\u3002</li> </ul> <p>\u6bd4\u5982\u5728\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u76ee\u6807\u89c4\u5219\u4e3a my-svc \u76ee\u6807\u670d\u52a1\u914d\u7f6e\u4e86 3 \u4e2a\u5177\u6709\u4e0d\u540c\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u7684\u5b50\u96c6\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: my-destination-rule\nspec:\n  host: my-svc\n  trafficPolicy:\n    loadBalancer:\n      simple: RANDOM  # \u968f\u673a\u7684\u7b56\u7565\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n    trafficPolicy:\n      loadBalancer:\n        simple: ROUND_ROBIN  # \u8f6e\u8be2\n  - name: v3\n    labels:\n      version: v3\n</code></pre> <p>\u6bcf\u4e2a\u5b50\u96c6\u90fd\u662f\u57fa\u4e8e\u4e00\u4e2a\u6216\u591a\u4e2a labels \u5b9a\u4e49\u7684\uff0c\u5728 Kubernetes \u4e2d\u5b83\u662f\u9644\u52a0\u5230 Pod \u8fd9\u79cd\u5bf9\u8c61\u4e0a\u7684\u952e/\u503c\u5bf9\u3002</p> <p>\u9664\u4e86\u5b9a\u4e49\u5b50\u96c6\u4e4b\u5916\uff0c\u76ee\u6807\u89c4\u5219\u5bf9\u4e8e\u6240\u6709\u5b50\u96c6\u90fd\u6709\u9ed8\u8ba4\u7684\u6d41\u91cf\u7b56\u7565\uff0c\u800c\u5bf9\u4e8e\u5177\u4f53\u7684\u5b50\u96c6\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u7279\u5b9a\u4e8e\u5b50\u96c6\u7684\u7b56\u7565\u6765\u8986\u76d6\u5b83\u3002</p> <p>\u4e0a\u9762\u7684\u793a\u4f8b\u5b9a\u4e49\u5728 subsets \u4e0a\u7684\u9ed8\u8ba4\u7b56\u7565\uff0c\u4e3a v1 \u548c v3 \u5b50\u96c6\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u968f\u673a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u5728 v2 \u7b56\u7565\u4e2d\uff0c\u6307\u5b9a\u4e86\u4e00\u4e2a\u8f6e\u8be2\u8d1f\u8f7d\u5747\u8861\u5668\u3002</p> <p>\u5728\u5bf9\u865a\u62df\u670d\u52a1\u548c\u76ee\u6807\u89c4\u5219\u6709\u4e86\u521d\u6b65\u4e86\u89e3\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5bf9 Bookinfo \u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fdb\u884c\u4fee\u6539\u3002</p>"},{"location":"chap4/2Istio_flow_control/#3","title":"3\u3001\u4e0d\u540c\u670d\u52a1\u7248\u672c\u8bbf\u95ee\u89c4\u5219","text":"<p>\u5bf9 Reviews \u670d\u52a1\u6dfb\u52a0\u4e00\u6761\u8def\u7531\u89c4\u5219\uff0c\u542f\u7528 <code>samples/bookinfo/networking/virtual-service-reviews-v3.yaml</code> \u5b9a\u4e49\u7684 VirtualService \u89c4\u5219\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v3\n</code></pre> <p>\u8fd9\u6837\uff0c\u6240\u6709\u8bbf\u95ee reviews \u670d\u52a1\u7684\u6d41\u91cf\u5c31\u4f1a\u88ab\u5f15\u5bfc\u5230 reviews \u670d\u52a1\u5bf9\u5e94\u7684 subset \u4e3a v3 \u7684 Pod \u4e2d\u3002\u542f\u7528\u8fd9\u6761\u89c4\u5219\uff1a</p> <pre><code>$ kubectl apply -f  samples/bookinfo/networking/virtual-service-reviews-v3.yaml\nvirtualservice.networking.istio.io/reviews created\n</code></pre> <p>\u7136\u540e\u67e5\u770b\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff1a</p> <pre><code>$  kubectl get virtualservices\nNAME       GATEWAYS               HOSTS         AGE\nbookinfo   [\"bookinfo-gateway\"]   [\"*\"]         17h\nreviews                           [\"reviews\"]   35s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 reviews \u7684 VirtualService \u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u6b64\u65f6\u6211\u4eec\u53bb\u5237\u65b0\u5e94\u7528\u7684\u9875\u9762\uff0c\u53d1\u73b0\u8bbf\u95ee Reviews \u5931\u8d25\u4e86\uff1a</p> <p> </p> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u521b\u5efa <code>DestinationRule</code> \u5bf9\u8c61\uff0c<code>DestinationRule</code> \u5bf9\u8c61\u662f <code>VirtualService</code> \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6\uff0c\u7528\u6765\u5c06 <code>VirtualService</code> \u4e2d\u6307\u5b9a\u7684 <code>subset</code> \u4e0e\u5bf9\u5e94\u7684 <code>Pod</code> \u5173\u8054\u8d77\u6765\u3002</p> <p>\u5728 <code>samples/bookinfo/networking/destination-rule-all.yaml</code>\u6587\u4ef6\u4e2d\u6709\u5b9a\u4e49\u6240\u6709\u8be5\u5e94\u7528\u4e2d\u8981\u7528\u5230\u7684\u6240\u6709 <code>DestinationRule</code> \u8d44\u6e90\u5bf9\u8c61\uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5c31\u662f\u5bf9 <code>Reviews</code> \u76f8\u5173\u7684 <code>DestinationRule</code> \u7684\u5b9a\u4e49:</p> <pre><code>---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: reviews\nspec:\n  host: reviews\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n  - name: v3\n    labels:\n      version: v3  # \u5339\u914dversion=v3\u6807\u7b7e\u7684Pod\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>DestinationRule</code>\u4e2d\u5b9a\u4e49\u4e86 <code>subsets</code>\u96c6\u5408\uff0c\u5176\u4e2d <code>labels</code> \u5c31\u548c\u6211\u4eec\u4e4b\u524d <code>Service</code> \u7684 <code>labelselector</code> \u4e00\u6837\u662f\u53bb\u5339\u914d Pod \u7684 labels \u6807\u7b7e\u7684\uff0c</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc <code>subsets</code> \u4e2d\u5c31\u5305\u542b\u4e00\u4e2a\u540d\u4e3a <code>v3</code> \u7684 <code>subset</code>\uff0c\u800c\u8fd9\u4e2a <code>subset</code> \u5339\u914d\u7684\u5c31\u662f\u5177\u6709 <code>version=v3</code> \u8fd9\u4e2a <code>label</code> \u6807\u7b7e\u7684<code>Pod</code>\u96c6\u5408\uff0c\u524d\u9762\u6211\u4eec\u521b\u5efa\u7684 Bookinfo \u4e2d\u4e5f\u6709\u8fd9\u4e2a\u6807\u7b7e\u7684 Pod:</p> <pre><code>$  kubectl get pods -l version=v3\nNAME                          READY   STATUS    RESTARTS   AGE\nreviews-v3-84779c7bbc-fnqbg   2/2     Running   2          20h\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u901a\u8fc7 DestinationRule \u5c06 VirtualService \u4e0e Service \u4e0d\u540c\u7684\u7248\u672c\u5173\u8054\u8d77\u6765\u4e86\u3002\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa DestinationRule \u8d44\u6e90\uff1a</p> <pre><code>$  kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml\ndestinationrule.networking.istio.io/productpage created\ndestinationrule.networking.istio.io/reviews created\ndestinationrule.networking.istio.io/ratings created\ndestinationrule.networking.istio.io/details created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u76ee\u524d\u6211\u4eec\u7f51\u683c\u4e2d\u7684 DestinationRules:</p> <pre><code> $ kubectl get destinationrule\nNAME          HOST          AGE\ndetails       details       30s\nproductpage   productpage   30s\nratings       ratings       30s\nreviews       reviews       30s\n</code></pre> <p>\u6b64\u65f6\u518d\u8bbf\u95ee\u5e94\u7528\u5c31\u6210\u529f\u4e86\uff0c\u591a\u6b21\u5237\u65b0\u9875\u9762\u53d1\u73b0 Reviews \u59cb\u7ec8\u90fd\u5c55\u793a\u7684\u662f v3 \u7248\u672c\uff08\u5e26\u7ea2\u8272\u661f\u7684\uff09\u7684 Ratings \u4e86\uff0c\u8bf4\u660e\u6211\u4eec<code>VirtualService</code> \u7684\u914d\u7f6e\u6210\u529f\u4e86\u3002</p> <p> </p>"},{"location":"chap4/2Istio_flow_control/#4","title":"4\u3001\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219","text":"<p>\u521a\u521a\u6211\u4eec\u6f14\u793a\u7684\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u7684\u670d\u52a1\u7f51\u683c\u7684\u63a7\u5236\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u6f14\u793a\u4e0b\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u3002</p> <p>\u9996\u5148\u79fb\u9664\u521a\u521a\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\uff0c\u6392\u9664\u5bf9\u73af\u5883\u7684\u5f71\u54cd\uff1a</p> <pre><code>$  kubectl delete virtualservice reviews\nvirtualservice.networking.istio.io \"reviews\" deleted\n\n$ kubectl get virtualservice\nNAME       GATEWAYS               HOSTS   AGE\nbookinfo   [\"bookinfo-gateway\"]   [\"*\"]   18h\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u8bbf\u95ee Bookinfo \u5e94\u7528\u53c8\u56de\u5230\u6700\u521d\u968f\u673a\u8bbf\u95ee Reviews \u7684\u60c5\u51b5\u4e86\u3002\u73b0\u5728\u6211\u4eec\u67e5\u770b\u6587\u4ef6 <code>samples/bookinfo/networking/virtual-service-reviews-80-20.yaml</code>\u7684\u5b9a\u4e49\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v1\n      weight: 80\n    - destination:\n        host: reviews\n        subset: v2\n      weight: 20\n</code></pre> <p>\u8fd9\u4e2a\u89c4\u5219\u5b9a\u4e49\u4e86 80% \u7684\u5bf9 Reviews \u7684\u6d41\u91cf\u4f1a\u843d\u5165\u5230 v1\uff08\u6ca1\u6709 Ratings\uff09\u8fd9\u4e2a subset\uff0c20% \u4f1a\u843d\u5165 v2\uff08\u5e26\u9ed1\u8272 Ratings\uff09\u5b50\u96c6\uff0c\u7136\u540e\u6211\u4eec\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$  kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml\nvirtualservice.networking.istio.io/reviews created\n\n$ kubectl get virtualservice\nNAME       GATEWAYS               HOSTS         AGE\nbookinfo   [\"bookinfo-gateway\"]   [\"*\"]         18h\nreviews                           [\"reviews\"]   6s\n</code></pre> <p>\u6211\u4eec\u67e5\u770b\u5f53\u524d\u7f51\u683c\u4e2d\u7684 VirtualService \u5bf9\u8c61\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6709 reviews \u4e86\uff0c\u8bc1\u660e\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u5e94\u7528\u4e2d\u6240\u6709\u7684 DestinationRules \u90fd\u5df2\u7ecf\u521b\u5efa\u8fc7\u4e86\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u8bbf\u95ee\u5e94\u7528\u5c31\u53ef\u4ee5\u4e86\uff0c\u6211\u4eec\u591a\u6b21\u5237\u65b0\uff0c\u53ef\u4ee5\u53d1\u73b0\u6ca1\u6709\u51fa\u73b0 Ratings \u7684\u6b21\u6570\u4e0e\u51fa\u73b0\u9ed1\u8272\u661f Ratings \u7684\u6bd4\u4f8b\u5927\u6982\u57284:1\u5de6\u53f3\uff0c\u5e76\u4e14\u6ca1\u6709\u7ea2\u8272\u661f\u7684 Ratings \u7684\u60c5\u51b5\u51fa\u73b0\uff0c\u8bf4\u660e\u6211\u4eec\u914d\u7f6e\u7684\u57fa\u4e8e\u6743\u91cd\u7684 VirtualService \u8bbf\u95ee\u89c4\u5219\u914d\u7f6e\u751f\u6548\u4e86\u3002</p> <p> </p> <p>80%</p> <p> </p> <p>20%</p>"},{"location":"chap4/2Istio_flow_control/#5","title":"5\u3001\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219","text":"<p>\u9664\u4e86\u4e0a\u9762\u57fa\u4e8e\u670d\u52a1\u7248\u672c\u548c\u670d\u52a1\u6743\u91cd\u7684\u65b9\u5f0f\u63a7\u5236\u670d\u52a1\u8bbf\u95ee\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u6765\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\u3002</p> <p>\u540c\u6837\uff0c\u5c06\u4e0a\u9762\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\u5220\u9664\uff1a</p> <pre><code>$  kubectl delete virtualservice reviews\nvirtualservice.networking.istio.io \"reviews\" deleted\n\n$ kubectl get virtualservice\nNAME       GATEWAYS               HOSTS   AGE\nbookinfo   [\"bookinfo-gateway\"]   [\"*\"]   18h\n</code></pre> <p>\u67e5\u770b\u6587\u4ef6 <code>samples/bookinfo/networking/virtual-service-reviews-jason-v2-v3.yaml</code> \u7684\u5b9a\u4e49\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    route:\n    - destination:\n        host: reviews\n        subset: v2\n  - route:\n    - destination:\n        host: reviews\n        subset: v3\n</code></pre> <p>\u8fd9\u4e2a VirtualService \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 reviews \u670d\u52a1\u8bbf\u95ee\u7684 match \u89c4\u5219\uff0c\u610f\u601d\u662f\u5982\u679c\u5f53\u524d\u8bf7\u6c42\u7684 header \u4e2d\u5305\u542b jason \u8fd9\u4e2a\u7528\u6237\u4fe1\u606f\uff0c\u5219\u53ea\u4f1a\u8bbf\u95ee\u5230 v2 \u7684 reviews \u8fd9\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u5373\u90fd\u5e26\u9ed1\u661f\u7684\u6837\u5f0f\uff0c\u5982\u679c\u4e0d\u5305\u542b\u8be5\u7528\u6237\u4fe1\u606f\uff0c\u5219\u90fd\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u53d1\u7ed9 v3 \u8fd9\u4e2a reviews \u7684\u670d\u52a1\u3002</p> <p>\u6211\u4eec\u5148\u4e0d\u542f\u7528\u8fd9\u4e2a VirtualService\uff0c\u5148\u53bb\u8bbf\u95ee\u4e0b Bookinfo \u8fd9\u4e2a\u5e94\u7528\u3002</p> <p>\u53f3\u4e0a\u89d2\u6709\u767b\u5f55\u6309\u94ae\uff0c\u5728\u6ca1\u6709\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u5237\u65b0\u9875\u9762\uff0creviews \u670d\u52a1\u662f\u88ab\u968f\u673a\u8bbf\u95ee\u7684\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u5e26\u661f\u4e0d\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u70b9\u51fb\u767b\u5f55\uff0c\u5728\u5f39\u7a97\u4e2d User Name \u8f93\u5165 jason\uff0cPassword \u4e3a\u7a7a\uff0c\u767b\u5f55\uff1a</p> <p> </p> <p> </p> <p>\u518d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u8ddf\u672a\u767b\u5f55\u524d\u7684\u8bbf\u95ee\u89c4\u5219\u4e00\u6837\uff0c\u4e5f\u662f\u968f\u673a\u7684\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8fd9\u4e2a\u5bf9\u8c61:</p> <pre><code>$  kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml\nvirtualservice.networking.istio.io/reviews created\n\n$ kubectl get virtualservice\nNAME       GATEWAYS               HOSTS         AGE\nbookinfo   [\"bookinfo-gateway\"]   [\"*\"]         18h\nreviews                           [\"reviews\"]   3s\n</code></pre> <p>\u6b64\u65f6\u518d\u56de\u53bb\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u4e00\u76f4\u90fd\u662f\u9ed1\u661f\u7684 Reviews \u7248\u672c(v2)\u88ab\u8bbf\u95ee\u5230\u4e86\uff0c\u6ce8\u9500\u9000\u51fa\u540e\u518d\u8bbf\u95ee\uff0c\u6b64\u65f6\u53c8\u4e00\u76f4\u662f\u7ea2\u661f\u7684\u7248\u672c(v3)\u88ab\u8bbf\u95ee\u4e86\u3002</p> <p>\u8bf4\u660e\u6211\u4eec\u57fa\u4e8e <code>headers-&gt;end-user-&gt;exact:jason</code> \u7684\u63a7\u5236\u89c4\u5219\u751f\u6548\u4e86\u3002</p> <p>\u5728 productpage \u670d\u52a1\u8c03\u7528 reviews \u670d\u52a1\u65f6\uff0c\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u4f1a\u5728 header \u4e2d\u5e26\u4e0a\u7528\u6237\u4fe1\u606f\uff0c\u901a\u8fc7 exact \u89c4\u5219\u5339\u914d\u5230\u76f8\u5173\u4fe1\u606f\u540e\uff0c\u6d41\u91cf\u88ab\u5f15\u5411\u4e86\u4e0a\u9762\u914d\u7f6e\u7684 v2 \u7248\u672c\u4e2d\u3002</p> <p>\u8fd9\u91cc\u8981\u8bf4\u660e\u4e00\u4e0b match \u7684\u5339\u914d\u89c4\u5219\uff1a</p> <pre><code>All conditions inside a single match block have AND semantics, while the list of match blocks have OR semantics. The rule is matched if any one of the match blocks succeed.\n</code></pre> <p>\u610f\u601d\u662f\u4e00\u4e2a <code>match</code> \u5757\u91cc\u7684\u6761\u4ef6\u662f\u9700\u8981\u540c\u65f6\u6ee1\u8db3\u624d\u7b97\u5339\u914d\u6210\u529f\u7684\uff0c\u5982\u4e0b\u9762\u662f url \u524d\u7f00\u548c\u7aef\u53e3\u90fd\u5fc5\u987b\u90fd\u6ee1\u8db3\u624d\u7b97\u6210\u529f\uff1a</p> <pre><code>- match:\n    - uri:\n        prefix: \"/wpcatalog\"\n      port: 443\n</code></pre> <p>\u591a\u4e2a match \u5757\u4e4b\u95f4\u662f\u53ea\u8981\u6709\u4e00\u4e2a match \u5339\u914d\u6210\u529f\u4e86\uff0c\u5c31\u4f1a\u88ab\u8def\u7531\u5230\u5b83\u6307\u5b9a\u7684\u670d\u52a1\u7248\u672c\u53bb\uff0c\u800c\u5ffd\u7565\u5176\u4ed6\u7684\u3002\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\u5728\u767b\u5f55\u7684\u6761\u4ef6\u4e0b\uff0c\u6ee1\u8db3\u7b2c\u4e00\u4e2a match\uff0c\u6240\u4ee5\u670d\u52a1\u4e00\u76f4\u4f1a\u8bbf\u95ee\u5230 v2 \u7248\u672c\u3002\u9000\u51fa\u767b\u5f55\u540e\uff0c\u6ca1\u6709 match \u89c4\u5219\u6ee1\u8db3\u5339\u914d\uff0c\u6240\u4ee5\u5c31\u8d70\u6700\u540e\u4e00\u4e2a route \u89c4\u5219\uff0c\u5373 v3 \u7248\u672c\u3002</p>"},{"location":"chap4/3Istio_fault_inject/","title":"\u7b2c\u4e09\u8282 Istio \u6d41\u91cf\u7ba1\u7406\u4e4b\u6545\u969c\u6ce8\u5165","text":"<p>\u5bf9\u4e8e\u4e00\u4e2a\u7cfb\u7edf\uff0c\u5c24\u5176\u662f\u4e00\u4e2a\u590d\u6742\u7684\u7cfb\u7edf\uff0c\u91cd\u8981\u7684\u4e0d\u662f\u6545\u969c\u4f1a\u4e0d\u4f1a\u53d1\u751f\uff0c\u800c\u662f\u4ec0\u4e48\u65f6\u5019\u53d1\u751f\u3002</p> <p>\u6545\u969c\u5904\u7406\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458\u548c\u6d4b\u8bd5\u4eba\u5458\u6765\u8bf4\u90fd\u7279\u522b\u8017\u8d39\u65f6\u95f4\u548c\u7cbe\u529b\uff1a\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458\u6765\u8bf4\uff0c\u4ed6\u4eec\u5728\u5f00\u53d1\u4ee3\u7801\u65f6\u9700\u8981\u752820%\u7684\u65f6\u95f4\u519980%\u7684\u4e3b\u8981\u903b\u8f91\uff0c\u7136\u540e\u7559\u51fa80%\u7684\u65f6\u95f4\u5904\u7406\u5404\u79cd\u975e\u6b63\u5e38\u573a\u666f\uff1b\u5bf9\u4e8e\u6d4b\u8bd5\u4eba\u5458\u6765\u8bf4\uff0c\u9664\u4e86\u9700\u8981\u752880%\u7684\u65f6\u95f4\u519920%\u7684\u5f02\u5e38\u6d4b\u8bd5\u9879\uff0c\u66f4\u8981\u7528\u8d85\u8fc780%\u7684\u65f6\u95f4\u6267\u884c\u8fd9\u4e9b\u5f02\u5e38\u6d4b\u8bd5\u9879\uff0c\u5e76\u6784\u9020\u5404\u79cd\u6545\u969c\u573a\u666f\uff0c\u5c24\u5176\u662f\u90a3\u79cd\u7406\u8bba\u4e0a\u624d\u51fa\u73b0\u7684\u6545\u969c\uff0c\u8ba9\u4eba\u82e6\u4e0d\u582a\u8a00\u3002</p> <p>\u6545\u969c\u6ce8\u5165\u662f\u4e00\u79cd\u8bc4\u4f30\u7cfb\u7edf\u53ef\u9760\u6027\u7684\u6709\u6548\u65b9\u6cd5\uff0c\u4f8b\u5982\u5f02\u5e38\u5904\u7406\u3001\u6545\u969c\u6062\u590d\u7b49\u3002</p> <p>\u53ea\u6709\u5f53\u7cfb\u7edf\u7684\u6240\u6709\u670d\u52a1\u90fd\u7ecf\u8fc7\u6545\u969c\u6d4b\u8bd5\u4e14\u5177\u5907\u5bb9\u9519\u80fd\u529b\u65f6\uff0c\u6574\u4e2a\u5e94\u7528\u624d\u5065\u58ee\u53ef\u9760\u3002</p> <p>\u6545\u969c\u6ce8\u5165\u4ece\u65b9\u6cd5\u4e0a\u6765\u8bf4\u6709\u7f16\u8bd1\u671f\u6545\u969c\u6ce8\u5165\u548c\u8fd0\u884c\u671f\u6545\u969c\u6ce8\u5165\uff0c\u524d\u8005\u8981\u901a\u8fc7\u4fee\u6539\u4ee3\u7801\u6765\u6a21\u62df\u6545\u969c\uff0c\u540e\u8005\u5728\u8fd0\u884c\u9636\u6bb5\u89e6\u53d1\u6545\u969c\u3002</p> <p>Istio \u7684\u6545\u969c\u6ce8\u5165\u5c31\u662f\u5728\u7f51\u683c\u4e2d\u5bf9\u7279\u5b9a\u7684\u5e94\u7528\u5c42\u534f\u8bae\u8fdb\u884c\u6545\u969c\u6ce8\u5165\uff0c\u8fd9\u6837\uff0c\u57fa\u4e8e Istio \u7684\u6545\u969c\u6ce8\u5165\u5c31\u53ef\u4ee5\u6a21\u62df\u51fa\u5e94\u7528\u7684\u6545\u969c\u573a\u666f\u4e86\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u8bf4\u660e\u5982\u4f55\u6ce8\u5165\u6545\u969c\u5e76\u6d4b\u8bd5\u5e94\u7528\u7a0b\u5e8f\u7684\u5f39\u6027\u3002</p>"},{"location":"chap4/3Istio_fault_inject/#1","title":"1\u3001\u5ef6\u8fdf\u6545\u969c\u6ce8\u5165","text":"<p>\u4e3a\u4e86\u6d4b\u8bd5\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f Bookinfo \u7684\u5f39\u6027\uff0c\u6211\u4eec\u5c06\u4e3a\u7528\u6237 jason \u5728 <code>reviews:v2</code> \u548c <code>ratings</code> \u670d\u52a1\u4e4b\u95f4\u6ce8\u5165\u4e00\u4e2a 7 \u79d2\u7684\u5ef6\u8fdf\uff0c\u8fd9\u4e2a\u6d4b\u8bd5\u5c06\u4f1a\u53d1\u73b0\u4e00\u4e2a\u6545\u610f\u5f15\u5165 Bookinfo \u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684 bug\u3002</p> <p>\u9996\u5148\u79fb\u9664\u4e4b\u524d\u521b\u5efa\u7684 VirtualService:</p> <pre><code>$  kubectl delete virtualservice reviews\nvirtualservice.networking.istio.io \"reviews\" deleted\n\n$ kubectl get virtualservice\nNAME       GATEWAYS               HOSTS   AGE\nbookinfo   [\"bookinfo-gateway\"]   [\"*\"]   19h\n</code></pre> <p>\u4e3a\u4e86\u80fd\u591f\u8ba9\u8bf7\u6c42\u7a33\u5b9a\uff0c\u8fd9\u91cc\u6211\u4eec\u5bf9 Reviews \u670d\u52a1\u914d\u7f6e\u8bf7\u6c42\u8def\u7531\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6 <code>samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml</code>\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    route:\n    - destination:\n        host: reviews\n        subset: v2\n  - route:\n    - destination:\n        host: reviews\n        subset: v1\n</code></pre> <p>\u4e0a\u9762\u7684\u914d\u7f6e\u5e94\u7528\u8fc7\u540e jason \u7528\u6237\u4f1a\u88ab\u8def\u7531\u5230 <code>reviews:v2</code> \u7248\u672c\u670d\u52a1\uff0c\u5176\u4ed6\u7528\u6237\u8def\u7531\u5230 reviews:v1 \u7248\u672c\u670d\u52a1\u3002\u521b\u5efa\u6545\u969c\u6ce8\u5165\u89c4\u5219\u4ee5\u5ef6\u8fdf\u6765\u81ea\u6d4b\u8bd5\u7528\u6237 jason \u7684\u6d41\u91cf\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u4e3a <code>samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml</code>\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n  - ratings\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    fault:\n      delay:\n        percentage:\n          value: 100.0\n        fixedDelay: 7s\n    route:\n    - destination:\n        host: ratings\n        subset: v1\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n</code></pre> <p>\u8fd9\u4e2a VirtualService \u5b9a\u4e49\u4e86\u4e00\u4e2a\u5728 jason \u767b\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u8bbf\u95ee <code>ratings</code> \u670d\u52a1\u7684 <code>100%</code> \u7684 <code>7s</code> \u8bbf\u95ee\u5ef6\u8fdf\u3002</p> <p>\u524d\u9762\u6211\u4eec\u77e5\u9053\uff0cBookinfo \u8fd9\u4e2a\u793a\u4f8b productpage \u670d\u52a1\u8c03\u7528 reviews\uff0creviews \u7684\u4e0d\u540c\u7248\u672c\u4f1a\u5bf9 ratings \u8fdb\u884c\u4e0d\u540c\u7684\u8c03\u7528\uff0c\u5176\u4e2d reviews-v1 \u4e0d\u8c03\u7528 ratings\uff0creviews-v2 \u548c reviews-v3 \u4f1a\u8c03\u7528 ratings\uff0c\u5e76\u505a\u4e0d\u540c\u6837\u5f0f\u7684\u6e32\u67d3\u3002</p> <p>\u6ce8\u610f reviews:v2 \u670d\u52a1\u5bf9 ratings \u670d\u52a1\u7684\u8c03\u7528\u5177\u6709 10 \u79d2\u7684\u786c\u7f16\u7801\u8fde\u63a5\u8d85\u65f6\u3002\u56e0\u6b64\uff0c\u5c3d\u7ba1\u5f15\u5165\u4e86 7 \u79d2\u7684\u5ef6\u8fdf\uff0c\u6211\u4eec\u4ecd\u7136\u671f\u671b\u7aef\u5230\u7aef\u7684\u6d41\u7a0b\u662f\u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u7684\u3002</p> <p>\u4e86\u89e3\u8fd9\u4e00\u70b9\u540e\uff0c\u6211\u4eec\u73b0\u5728\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml\nvirtualservice.networking.istio.io/reviews created\n\n$ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml\nvirtualservice.networking.istio.io/ratings created\n\n$  kubectl get virtualservice\nNAME       GATEWAYS               HOSTS         AGE\nbookinfo   [\"bookinfo-gateway\"]   [\"*\"]         19h\nratings                           [\"ratings\"]   21s\nreviews                           [\"reviews\"]   66s\n</code></pre> <p>\u901a\u8fc7\u6d4f\u89c8\u5668\u6253\u5f00 Bookinfo \u5e94\u7528\uff0c\u4f7f\u7528\u7528\u6237 jason \u767b\u5f55\u5230 <code>/productpage</code> \u9875\u9762\u3002</p> <p>\u6211\u4eec\u671f\u671b\u7684\u662f Bookinfo \u4e3b\u9875\u5728\u5927\u7ea6 7 \u79d2\u949f\u52a0\u8f7d\u5b8c\u6210\u5e76\u4e14\u6ca1\u6709\u9519\u8bef\uff0c\u4f46\u662f Reviews \u90e8\u5206\u663e\u793a\u4e86\u4e00\u4e2a\u9519\u8bef\u6d88\u606f\uff1aSorry, product reviews are currently unavailable for this book.</p> <p> </p> <p> </p> <p>\u800c\u4e14\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u9875\u9762\u52a0\u8f7d\u5b9e\u9645\u4e0a\u7528\u4e86\u5927\u7ea66s\uff0c\u6309\u7167\u9884\u671f\uff0c\u6211\u4eec\u5f15\u5165\u7684 7s \u5ef6\u8fdf\u4e0d\u4f1a\u5f71\u54cd\u5230 reviews \u670d\u52a1\uff0c\u56e0\u4e3a reviews \u548c ratings \u670d\u52a1\u95f4\u7684\u8d85\u65f6\u88ab\u786c\u7f16\u7801\u4e3a 10 \u79d2\uff0c\u4f46\u5b9e\u9645\u4e0a\u5728 productpage \u548c reviews \u670d\u52a1\u4e4b\u95f4\u4e5f\u6709\u4e00\u4e2a 3s \u7684\u786c\u7f16\u7801\u7684\u8d85\u65f6\uff0c\u518d\u52a0 1 \u6b21\u91cd\u8bd5\uff0c\u4e00\u5171 6s\uff0c\u6240\u4ee5 productpage \u5bf9 reviews \u7684\u8c03\u7528\u5728 6s \u540e\u63d0\u524d\u8d85\u65f6\u5e76\u629b\u51fa\u9519\u8bef\u4e86\u3002</p> <p>\u8fd9\u79cd\u7c7b\u578b\u7684\u9519\u8bef\u5728\u4e0d\u540c\u7684\u56e2\u961f\u72ec\u7acb\u5f00\u53d1\u4e0d\u540c\u7684\u5fae\u670d\u52a1\u7684\u4f01\u4e1a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u662f\u53ef\u80fd\u4f1a\u51fa\u73b0\u7684\uff0cIstio \u7684\u6545\u969c\u6ce8\u5165\u89c4\u5219\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u8bc6\u522b\u6b64\u7c7b\u5f02\u5e38\uff0c\u800c\u4e0d\u4f1a\u5f71\u54cd\u6700\u7ec8\u7528\u6237\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u6b64\u6b21\u6545\u969c\u6ce8\u5165\u9650\u5236\u4e3a\u4ec5\u5f71\u54cd\u7528\u6237 jason\uff0c\u5982\u679c\u4f60\u4ee5\u4efb\u4f55\u5176\u4ed6\u7528\u6237\u8eab\u4efd\u767b\u5f55\uff0c\u5219\u4e0d\u4f1a\u9047\u5230\u4efb\u4f55\u5ef6\u8fdf\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u589e\u52a0 productpage \u4e0e reviews \u670d\u52a1\u4e4b\u95f4\u7684\u8d85\u65f6\u6216\u964d\u4f4e reviews \u4e0e ratings \u7684\u8d85\u65f6\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728 reviews \u670d\u52a1\u7684 v3 \u7248\u672c\u4e2d\u5df2\u7ecf\u4fee\u590d\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c<code>reviews:v3</code> \u670d\u52a1\u5df2\u5c06 <code>reviews</code> \u4e0e <code>ratings</code> \u7684\u8d85\u65f6\u65f6\u95f4\u4ece 10s \u964d\u4f4e\u4e3a 2.5s\uff0c\u56e0\u6b64\u5b83\u53ef\u4ee5\u517c\u5bb9\uff08\u5c0f\u4e8e\uff09\u4e0b\u6e38\u7684 productpage \u7684\u8bf7\u6c42\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5c06\u4e0a\u9762 Reviews \u7684\u6d41\u91cf\u8f6c\u79fb\u5230 <code>reviews:v3</code> \u670d\u52a1\uff0c\u7136\u540e\u53ef\u4ee5\u5c1d\u8bd5\u4fee\u6539\u5ef6\u8fdf\u89c4\u5219\u4e3a\u4efb\u4f55\u4f4e\u4e8e 2.5s \u7684\u6570\u503c\uff0c\u4f8b\u5982 2s\uff0c\u7136\u540e\u53ef\u4ee5\u786e\u8ba4\u7aef\u5230\u7aef\u7684\u6d41\u7a0b\u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u3002</p> <p>\u901a\u8fc7\u8fd9\u79cd\u8d85\u65f6\u6545\u969c\u6ce8\u5165\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u65b9\u4fbf\u5730\u53d1\u73b0\u670d\u52a1\u95f4\u76f8\u4e92\u8bbf\u95ee\u4e2d\u5b58\u5728\u7684\u6f5c\u5728\u95ee\u9898\u3002</p>"},{"location":"chap4/3Istio_fault_inject/#2","title":"2\u3001\u4e2d\u65ad\u8bbf\u95ee\u6545\u969c\u6ce8\u5165","text":"<p>\u6d4b\u8bd5\u5fae\u670d\u52a1\u5f39\u6027\u7684\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u5f15\u5165 HTTP abort \u6545\u969c\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u7ed9 ratings \u5fae\u670d\u52a1\u4e3a\u6d4b\u8bd5\u7528\u6237 jason \u5f15\u5165\u4e00\u4e2a HTTP abort\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5e0c\u671b\u9875\u9762\u80fd\u591f\u7acb\u5373\u52a0\u8f7d\uff0c\u540c\u65f6\u663e\u793a <code>Ratings service is currently unavailable</code>\u8fd9\u6837\u7684\u6d88\u606f\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5230\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e3a <code>samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml</code>\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n  - ratings\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    fault:\n      abort:\n        percentage:\n          value: 100.0\n        httpStatus: 500\n    route:\n    - destination:\n        host: ratings\n        subset: v1\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\u914d\u7f6e\u4e86\u5728 jason \u767b\u5f55\u65f6\uff0creviews \u5bf9 ratings \u8bbf\u95ee\u65f6 100% \u7684\u8fd4\u56de\u4e00\u4e2a500\u9519\u8bef\u54cd\u5e94\u3002\u7136\u540e\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml\nvirtualservice.networking.istio.io/ratings configured\n\n$ kubectl get virtualservice\nNAME       GATEWAYS               HOSTS         AGE\nbookinfo   [\"bookinfo-gateway\"]   [\"*\"]         19h\nratings                           [\"ratings\"]   10m\nreviews                           [\"reviews\"]   11m\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u56de\u5230 BookInfo \u5e94\u7528\uff0c\u767b\u5f55 jason\uff0c\u5237\u65b0\u9875\u9762\uff0c\u6709\u65f6\u5019\u53ef\u4ee5\u5f88\u5feb\u5c31\u770b\u5230 Rating \u670d\u52a1\u4e0d\u53ef\u7528\u7684\u63d0\u793a\u4fe1\u606f\uff1a</p> <p> </p> <p>\u5982\u679c\u6ce8\u9500\u7528\u6237 jason\uff0c\u6211\u4eec\u5c06\u770b\u5230 <code>/productpage</code> \u4e3a\u9664 <code>jason</code> \u4ee5\u5916\u7684\u5176\u4ed6\u7528\u6237\u8c03\u7528\u4e86 <code>reviews:v1</code>\uff08\u5b8c\u5168\u4e0d\u8c03\u7528 ratings\uff09\uff0c\u56e0\u6b64\uff0c\u4e0d\u4f1a\u770b\u5230\u4efb\u4f55\u9519\u8bef\u6d88\u606f\uff0c\u4e0d\u4f1a\u663e\u793a\u661f\u6807\u7684\u56fe\u5f62\u3002</p> <p> </p>"},{"location":"chap4/4Istio_ServiceEntry_issue/","title":"\u7b2c\u56db\u8282 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def","text":"<p>\u6700\u8fd1\u5728\u5f00\u59cb\u7814\u7a76 istio \u4f7f\u7528\uff0c\u5df2\u7ecf\u5728\u4e00\u4e2a\u672a\u5b89\u88c5 istio \u96c6\u7fa4\u7684\u73af\u5883\u4e2d\u6210\u529f\u641e\u5b9a istio \u5b89\u88c5\u914d\u7f6e\u4e14\u80fd\u6b63\u5e38\u4f7f\u7528\u3002</p> <p>\u4f46\u662f\u6700\u8fd1\u5728\u4e00\u4e2a\u65b0\u5347\u7ea7\u7684 istio \u7248\u672c(1.11.0)\u7684\u96c6\u7fa4\u4e2d\uff0c\u6240\u6709\u88ab\u6ce8\u5165 istio sidecar \u7684 pod \u5747\u65e0\u6cd5\u5bf9\u5916\u8bbf\u95ee https\u3002\u5bfc\u81f4\u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u3002\u5177\u4f53\u8868\u73b0\u4e3a IP \u80fd\u901a\uff0c\u4f46\u662f\u65e0\u6cd5 tls \u63e1\u624b\u6210\u529f\u3002</p> <ul> <li>\u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u7684\u521d\u671f\u8868\u73b0\u4e3a\u83b7\u53d6\u914d\u7f6e\u65f6\u63d0\u793a 404\u3002</li> <li>\u5728\u4e00\u6bb5\u65f6\u95f4\u540e\u7a81\u7136\u8868\u73b0\u4e3a\u65e0\u6cd5\u5efa\u7acb tls \uff0c\u8fd4\u56de 000\u3002</li> <li>\u6240\u6709\u5bf9\u5916\u7684 https \u670d\u52a1\u5747\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u3002</li> </ul> <p>\u5728\u521d\u671f debug \u540e\uff0c\u8868\u73b0\u66f4\u4e3a\u8be1\u5f02\uff0c\u5728\u4e0d\u540c\u7684 pod \u4e2d\u6709\u4e0d\u540c\u7684\u8868\u73b0\uff1a</p> <ul> <li>\u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u7a81\u7136\u62d2\u7edd\u8fde\u63a5\u3002</li> <li>\u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u8fd4\u56de\u4e0e\u670d\u52a1\u7aef\u672c\u8eab\u4e0d\u7b26\u5408\u7684\u8bc1\u4e66\u3002\u4f8b\u5982\uff1a<code>curl https://baidu.com</code>\u63d0\u793a\u670d\u52a1\u7aef\u8bc1\u4e66\u4e3a <code>*.example.com</code>\u3002</li> <li>\u5728\u8df3\u8fc7\u8bc1\u4e66\u9a8c\u8bc1\u540e\uff0c\u670d\u52a1\u7aef\u54cd\u5e94\u4e86\u975e\u9884\u671f\u7684\u5185\u5bb9\u3002</li> </ul>"},{"location":"chap4/4Istio_ServiceEntry_issue/#1","title":"1\u3001\u521d\u6b65\u5206\u6790","text":"<p>\u7531\u4e8e\u65e0\u6cd5\u8bbf\u95ee\u5916\u90e8 https \uff0c\u521d\u671f\u731c\u60f3\u53ef\u80fd\u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u8bbf\u95ee\u7b56\u7565\u6216\u8005\u5176\u4ed6\u5b89\u5168\u76f8\u5173\u914d\u7f6e\uff0c\u6216\u8005\u5728 https \u4ee3\u7406\u4e0a\u51fa\u73b0\u4e86\u67d0\u4e9b\u914d\u7f6e\u9519\u8bef\u3002</p> <p>\u5728\u95ee\u9898\u51fa\u73b0\u540e\u7684\u4e00\u6bb5\u65f6\u95f4\u4e2d\uff0c\u6211\u4eec\u5bf9\u6bd4\u4e86\u6b63\u5e38\u4f7f\u7528 istio \u96c6\u7fa4\u548c\u95ee\u9898\u96c6\u7fa4\u7684 istio \u914d\u7f6e\uff0c\u6240\u6709 crd\u3002\u5747\u672a\u53d1\u73b0\u7279\u6b8a\u914d\u7f6e\u3002</p> <p>\u4f46\u662f\u989d\u5916\u7684\uff0c\u8be5\u96c6\u7fa4\u6709\u51e0\u4e2a\u6bd4\u8f83\u7279\u6b8a\u7684\u5730\u65b9\uff1a</p> <p>1\u3001 \u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u5bf9\u5916\uff08\u516c\u7f51\u670d\u52a1\uff09\u8bbf\u95ee\u7684 serviceentry\uff0c\u5982\u4e0b\uff1a</p> <p> </p> <p>\u90e8\u5206\u9690\u79c1\u57df\u540d\u5df2\u7ecf\u5220\u9664\uff0c\u8fd9\u6761\u914d\u7f6e\u91cc\u9762\u7684\u57df\u540d\u603b\u6570\u591a\u8fbe\u51e0\u5341\u6761\u3002</p> <p>\u7ecf\u8fc7\u8be2\u95ee\uff0c\u5f97\u5230\u7684\u7b54\u590d\u4e3a\uff1a\u9700\u8981\u5728 serviceentry \u4e2d\u52a0\u4e0a\u8fd9\u4e9b\u57df\u540d\u624d\u80fd\u4f7f mesh \u4e2d\u7684\u670d\u52a1\u6b63\u5e38\u5bf9\u5916\u8bbf\u95ee\u3002</p> <p>2\u3001\u96c6\u7fa4\u4e2d\u8fd8\u8fd0\u884c\u4e86\u4e00\u4e2a <code>dns-controller</code>,\u662f\u4e00\u4e2a\u548c istio \u6709\u5173\u7684\u63a7\u5236\u5668\u3002\u7528\u4e8e\u8de8\u96c6\u7fa4\u7684 dns \u53d1\u73b0\u7b49\u3002\u5728\u8fd9\u91cc\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u5bf9 mesh \u7684\u57df\u540d\u505a\u4e86 CNAME \u7c7b\u4f3c\u7684\u64cd\u4f5c\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5728\u547d\u540d\u7a7a\u95f4 abc \u4e2d\u8fd0\u884c\u7740\u670d\u52a1 <code>service-api</code>\u9ed8\u8ba4\u8bbf\u95ee\u57df\u540d\u4e3a <code>service-api.abc</code>,\u5728 istio \u4e2d\u9700\u8981\u5b9e\u73b0\u80fd\u591f\u901a\u8fc7 <code>service-api.hello</code> \u8bbf\u95ee\u3002\u4e8e\u662f\u8be5 <code>controller</code> \u5728\u7a7a\u95f4\u5185\u751f\u6210\u4e86\u670d\u52a1\u5bf9\u5e94\u7684 <code>serviceentry</code>\u7528\u4e8e <code>\u201cCNAME\u201d</code>\u3002</p> <p>\u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f</p> <p>\u56e0\u4e3a istio \u9ed8\u8ba4\u4e0d\u9650\u5236 mesh \u5bf9\u516c\u7f51\u7684\u8bbf\u95ee\uff0c\u800c\u4e14\u5728\u6b63\u5e38\u7684\u96c6\u7fa4\u4e2d\u4e5f\u65e0\u9700\u8fd9\u4e2a\u914d\u7f6e\u3002</p> <p>\u5728\u8fd9\u4e4b\u524d\uff0c\u7531\u4e8e\u9ed8\u8ba4 sidecar \u83b7\u53d6\u5168\u5c40\u7684 mesh \u914d\u7f6e\u5bfc\u81f4 sidecar \u5185\u5b58\u5360\u7528\u8d85 1GB\u3002\u6211\u4eec\u8fd8\u4f7f\u7528\u4e86 sidecar \u5c06\u914d\u7f6e\u9650\u5236\u5728\u5f53\u524d\u4e00\u4e2a\u7a7a\u95f4\u5185\u4ee5\u51cf\u5c11 sidecar \u5360\u7528\u3002</p> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: Sidecar\nspec:\n  egress:\n    - hosts:\n        - ./*\n</code></pre> <p>\u5728\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u51e0\u4e2a\u65b9\u5411\uff1a</p>"},{"location":"chap4/4Istio_ServiceEntry_issue/#2","title":"2\u3001\u5c1d\u8bd5\u89e3\u51b3","text":"<p>\u5728\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u51e0\u4e2a\u65b9\u5411\uff1a</p> <ol> <li>\u6709\u53cd\u9988\u8bf4 serviceentry \u6ca1\u6709\u52a0\u4e0a\u3002\u4e5f\u5c31\u662f\u4e0a\u9762\u8bf4\u7684\u5bf9\u516c\u7f51\u8bbf\u95ee\u7684 serviceentry\u3002\u4e5f\u5c1d\u8bd5\u589e\u52a0\u4e86\u5bf9\u5e94\u57df\u540d\u7684 serviceentry\uff0c\u95ee\u9898\u4f9d\u7136\u5b58\u5728\u3002\u4f46\u8fd9\u6bd4\u4e4b\u524d\u597d\u4e00\u70b9\uff0c\u88ab\u6dfb\u52a0\u7684\u57df\u540d\u80fd\u591f\u6210\u529f\u8bbf\u95ee\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761\u8def\u6709\u6548\uff0c\u4f46\u53c8\u4e0d\u5b8c\u5168\u6709\u6548\u3002\u7b2c\u4e00\u4e2a\u95ee\u9898\u4f9d\u65e7\u6ca1\u6709\u88ab\u89e3\u7b54\u3002</li> <li>\u65b0\u5f00\u4e86\u4e00\u4e2a\u7a7a\u95f4 istio-demo \u5e76\u90e8\u7f72\u4e86 book-info \u793a\u4f8b\u7a0b\u5e8f\u3002\u5728\u90e8\u7f72\u6210\u529f\u7684\u793a\u4f8b\u7a0b\u5e8f\u4e2d\uff0c\u4e5f\u5b58\u5728\u4e0a\u8ff0\u95ee\u9898\u3002</li> </ol> <p>\u5728\u540e\u6765\u7684 debug \u4e2d\uff0c\u6211\u4eec\u5728 pod \u4e2d\u5c1d\u8bd5\u5efa\u7acb tls \u8fde\u63a5\uff1a</p> <p>\u9664\u4e86\u76f4\u63a5\u5728\u63e1\u624b\u9636\u6bb5\u5c31\u88ab\u670d\u52a1\u7aef\u5173\u95ed\u8fde\u63a5\u7684\u60c5\u51b5\u5916\uff0c\u8fd8\u9047\u5230\u4e86\uff1a</p> <pre><code>$ curl https://baidu.com\nSSL: certificate subject name '*.example.com' does not match target host name 'baidu.com'\n</code></pre> <p>\u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff1a<code>'*.example.com'</code> \u662f\u54ea\u91cc\u6765\u7684\uff1f\u6709\u4e2d\u95f4\u4eba\u5417\uff1f\u4e2d\u95f4\u4eba\u662f\u8c01\uff0c\u8bc1\u4e66\u5728\u54ea\u91cc\u914d\u7f6e\u7684\uff1f</p>"},{"location":"chap4/4Istio_ServiceEntry_issue/#3","title":"3\u3001\u8f6c\u6298\u70b9","text":"<p>\u56e0\u4e3a\u95ee\u9898\u51fa\u73b0\u4e8e https \u65e0\u6cd5\u5efa\u7acb\u8fde\u63a5\uff0c\u6240\u4ee5\u65b9\u5411\u4e00\u76f4\u88ab\u5f15\u5411\u4e86 tls \u4ee3\u7406\u4e4b\u7c7b\u7684\u95ee\u9898\u3002</p> <p>\u76f4\u5230\uff1a</p> <pre><code>\n$ curl -k  https://baidu.com\n404 page not found\n</code></pre> <p>\u8fd9\u91cc\u662f\u8bbf\u95ee\u7684\u4f17\u6240\u5468\u77e5\u7684\u57df\u540d\uff0c\u4e3a\u4ec0\u4e48\u8fd4\u56de\u4e86 \"404 page not found\"\uff1f\u8fd9\u4e2a\u54cd\u5e94\u8bf4\u660e\u4e86\u8be5\u54cd\u5e94\u5e94\u8be5\u6765\u81ea\u4e8e\u67d0\u4e2a\u5185\u90e8 golang \u8bed\u8a00\u7f16\u5199\u7684\u670d\u52a1\u3002</p> <p>\u5728\u8bbf\u95ee\u5176\u4ed6 https \u57df\u540d\u4e5f\u6709\u540c\u6837\u7684\u6548\u679c\uff0c\u4f3c\u4e4e\u6240\u6709 https \u8bbf\u95ee\u90fd\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u5185\u90e8\u7684\u670d\u52a1\u3002</p> <p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u90fd\u662f\u4f7f\u7528\u5230\u7684 <code>istio proxy-status</code> \u547d\u4ee4\u6765\u67e5\u770b sidecar \u914d\u7f6e\u6ce8\u5165\u72b6\u6001\uff0c\u4e5f\u672a\u89c1\u660e\u663e\u5f02\u5e38\u3002</p> <p>\u65e0\u5948\u4e4b\u4e0b\uff0c\u6211\u5c1d\u8bd5\u4f7f\u7528\u4e86 <code>istioctl proxy-config</code> \u67e5\u770b sidecar \u914d\u7f6e\uff0c\u4e5f\u5c31\u662f envoy \u7684\u914d\u7f6e\u3002</p> <pre><code>$ istioctl proxy-config all sample-c59f744df-8kq7m.istio-demo\n...\n0.0.0.0        443   SNI: music.baidu.com             Cluster: outbound|443||music.baidu.com\n0.0.0.0        443   SNI: i.xiaoi.com                 Cluster: outbound|443||i.xiaoi.com\n0.0.0.0        443   ALL                              Cluster: outbound|443||traefik.cutom-name\n0.0.0.0        443   SNI: dict.baidu.com              Cluster: outbound|443||dict.baidu.com\n0.0.0.0        443   SNI: datarobotapi.bdia.com.cn    Cluster: outbound|443||datarobotapi.bdia.com.cn\n...\n</code></pre> <p>Server Name Indication: SNI</p> <p>\u5728\u8fd9\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u4e2d\uff0c\u5728\u4e0a\u5343\u4e2a\u89c4\u5219\u4e2d\u53d1\u73b0\u4e86\u8fd9\u4e48\u4e00\u6761 <code>0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name</code></p> <p>\u76f4\u89c9\u5c31\u662f\u8fd9\u4e2a\u89c4\u5219\u6709\u95ee\u9898\u3002\u731c\u6d4b\u8fd9\u4e2a\u89c4\u5219\u7684\u5b58\u5728\u5c06\u5176\u5339\u914d\u7684 443 \u7aef\u53e3 ALL \u7684\u6d41\u91cf\u8f6c\u53d1\u81f3\u4e86 <code>traefik.cutom-name</code> ,\u8fd9\u4e2a <code>traefik.cutom-name</code> \u662f \u4e0a\u9762\u8bf4\u5230\u7684 <code>dns-controller</code> \u751f\u6210\u7684\u7528\u4e8e CNAME \u7684 <code>serviceentry</code>\u3002</p> <p>\u56e0\u4e3a\u8fd8\u4e0d\u662f\u5f88\u4e86\u89e3 istio envoy \u7684\u89c4\u5219\uff0c\u6240\u4ee5\u4ec5\u731c\u6d4b\u3002\u5982\u679c\u662f\u719f\u6089\u7684\u8bdd\uff0c\u80fd\u591f\u4e00\u773c\u770b\u51fa\u95ee\u9898\u3002</p> <pre><code>$ curl -k -vvv https://baidu.com\n...\n* Server certificate:\n*   subject: ...=traefik...\n...\n404 page not found\n</code></pre> <p>\u5728 curl \u7ed9\u51fa\u7684 debug \u4fe1\u606f\u4e2d\u53d1\u73b0\u4e86\u670d\u52a1\u7aef\u4f7f\u7528\u7684 tls \u8bc1\u4e66\uff0csubject \u4e2d\u5305\u542b\u4e86 traefik \u7b49\u5b57\u6bb5\u3002\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e2a\u8bc1\u4e66\u662f traefik \u81ea\u7b7e\u53d1\u7684\u3002\u5b9e\u9524\u4e86\u8fd9\u4e2a\u540e\u7aef\u670d\u52a1\u5c31\u662f traefik\u3002</p> <p>\u53ef\u4ee5\u65ad\u5b9a\uff0c\u67d0\u4e2a\u9519\u8bef\u7684\u914d\u7f6e\u5bfc\u81f4\u751f\u6210\u4e86 <code>0.0.0.0:433 -&gt; traefik.cutom-name</code> \u7684\u6620\u5c04\u3002</p> <p>\u540e\u6765\u5728\u9605\u8bfb\u4e86 envoy \u7684\u6587\u6863LDS\u540e\uff0c\u89e3\u91ca\u4e86\u8fd9\u4e9b\u89c4\u5219\u7684\u7528\u9014\u3002<code>0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name</code>\u8868\u793a\u5339\u914d\u6240\u6709 IP \u5730\u5740 &amp; 443 \u7aef\u53e3 &amp; \u6240\u6709 SNI \u7684\u6d41\u91cf\u5747 mesh \u5230\u76ee\u7684\u670d\u52a1 <code>traefik.cutom-name</code></p>"},{"location":"chap4/4Istio_ServiceEntry_issue/#4","title":"4\u3001\u9010\u6e10\u6e05\u6670","text":"<p>\u65e2\u7136\u548c <code>traefik.cutom-name</code> \u6709\u5173\uff0c\u4e5f\u5c31\u662f\u548c\u4e0a\u9762\u8bf4\u5230\u7684 <code>dns-controller</code> \u6709\u5173\uff0c\u548c\u5176\u751f\u6210\u7684 <code>serviceentry</code> \u6709\u5173\u3002\u4ee5\u5176\u4e2d\u4e00\u6761\u4e3e\u4f8b\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: ServiceEntry\nmetadata:\n  namespace: abc\n  name: traefik-cutom-name\nspec:\n  hosts:\n    - traefik.cutom-name\n  location: MESH_INTERNAL\n  ports:\n    - name: https-443\n      number: 443\n      protocol: TLS\n  resolution: DNS\n</code></pre> <p>dns-controller \u751f\u6210\u4e86\u4e0a\u8ff0\u7684 serviceentry\u3002\u4e4d\u770b\u8fd8\u672a\u5bdf\u89c9\u5230\u95ee\u9898\uff0c\u4f46\u80af\u5b9a\u6709\u95ee\u9898\u3002</p> <p>\u5728\u7ffb\u9605 ServiceEntry \u6587\u6863 \u540e\u3002\u6700\u7ec8\u53d1\u73b0\u95ee\u9898\uff1a</p> <p>\u6ca1\u6709\u8bbe\u7f6e <code>spec.addresses</code>\u3002</p> <p>\u5176\u8bbe\u7f6e\u4e3a <code>MESH_INTERNAL</code> \u4f46\u662f\u6ca1\u6709\u6307\u5b9a\u8be5 service \u7684\u540e\u7aef\u3002\u65e2\u6ca1\u6709\u6307\u5b9a\u5230\u671f\u671b\u670d\u52a1 DNS \u4e5f\u6ca1\u6709\u6307\u5b9a IP\u3002\u90a3\u4e48\u6b64\u65f6\u9ed8\u8ba4\u884c\u4e3a\u662f\uff0c\u5c06 dns <code>traefik.cutom-name</code> \u4f5c\u4e3a\u4e0a\u6e38\uff0c\u901a\u8fc7\u8be5 dns \u53bb\u53d1\u73b0\u670d\u52a1\u7684 endpoint\u3002\u7531\u4e8e\u66f4\u6539\u4e86 coredns \u7684\u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u6682\u65f6\u6ca1\u6709\u95ee\u9898\u3002envoy \u6839\u636e\u8fd9\u90e8\u5206\u751f\u6210 cluster \u5e76\u914d\u7f6e\u4f7f\u7528 DNS \u4f5c\u4e3a EDS\u3002</p> <p>\u4f46\u5728\u6ca1\u6709\u8bbe\u7f6e <code>spec.addresses</code> \u65f6,\u8fd9\u4e2a addresses \u53ef\u4ee5\u586b\u5199 IP \u4e5f\u53ef\u586b\u5199 endpoint \u6240\u5728\u7684 CIDR\u3002envoy \u6839\u636e\u6b64\u90e8\u5206\u751f\u6210\u7684 listener \u5219\u4f1a\u4f7f\u7528 <code>0.0.0.0</code> \u4f5c\u4e3a IP \u5730\u5740\u3002\u90a3\u8fd9\u4f1a\u4ea7\u751f\u4ec0\u4e48\u95ee\u9898\u5462\uff1f</p> <p>\u4e3e\u4e2a \ud83c\udf30 \u6817\u5b50\uff1a</p> <p>\u5982\u679c serviceentry A \u672a\u8bbe\u7f6e addresses \u5e76\u914d\u7f6e 443 \u7aef\u53e3\u670d\u52a1\uff0c\u90a3\u4e48\u5728 envoy \u751f\u6210 listener \u4e3a\uff1a<code>0.0.0.0:443 -&gt; service A</code>\u3002</p> <p>\u6b64\u65f6\u8bbf\u95ee <code>https://baidu.com</code> \u65f6\u5219\u4f1a\u5339\u914d\u5230\u8be5 listener\uff0cenvoy \u5219\u5c06\u6570\u636e\u5305\u53d1\u5f80\u8be5\u670d\u52a1\u3002</p> <p>\u4e5f\u5c31\u4f1a\u6536\u5230 tls \u8bc1\u4e66\u4e0e\u9884\u671f\u4e0d\u4e00\u81f4\u7684\u7ed3\u679c\u3002\u540c\u7406\u6240\u6709\u4f7f\u7528 443 \u7aef\u53e3\u7684\u670d\u52a1\u4e5f\u4f1a\u5982\u6b64\u3002\u5982\u679c\u6709\u591a\u4e2a serviceentry \u90fd\u4f7f\u7528 443 \u7aef\u53e3\uff0c\u5219\u5728\u751f\u6210 listener \u65f6\u4f1a\u968f\u673a\u9009\u62e9\u4e86\u4e00\u4e2a\u670d\u52a1(\u8be5\u903b\u8f91\u7531 listio \u63a7\u5236)\u3002</p> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <ol> <li>\u6307\u5b9a address \u5230 k8s service clusterIP</li> <li>\u6307\u5b9a address \u5230 k8s service CIDR</li> </ol> <p>\u7531\u4e8e\u53ef\u4ee5\u76f4\u63a5\u62ff\u5230 service IP \u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u586b\u5199 service IP\u3002</p>"},{"location":"chap4/4Istio_ServiceEntry_issue/#5","title":"5\u3001\u89e3\u51b3","text":"<p>\u5728\u66f4\u6539\u63a7\u5236\u5668\u903b\u8f91\u540e\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: ServiceEntry\nmetadata:\n  name: traefik-cutom-name\n  namespace: abc\nspec:\n  addresses:\n    - &lt;service cluster IP&gt; # \u6307\u5b9a\u4e86 addresses,\u8be6\u60c5\u53c2\u770bistio\u6587\u6863\u3002\n  endpoints:\n    - address: traefik.abc\n  hosts:\n    - traefik.cutom-name\n  location: MESH_INTERNAL\n  ports:\n    - name: https-443\n      number: 443\n      protocol: TLS\n  resolution: DNS\n</code></pre> <p>\u518d\u6b21\u67e5\u770b config-dump</p> <pre><code>$istioctl proxy-config all sample-55c7969547-z92zk.istio-demo\n0.0.0.0        80    ALL                       PassthroughCluster\n0.0.0.0        443   ALL                       PassthroughCluster\n0.0.0.0        443   SNI: traefik.custom-name  Cluster: outbound|443||traefik.custom-name\n</code></pre> <p>\u89c4\u5219\u4e00\u5207\u6b63\u5e38\u3002<code>PassthroughCluster</code> \u662f\u4e00\u6761\u7279\u6b8a\u89c4\u5219\uff0c\u8868\u793a\u6d41\u91cf\u4e0d\u7ecf\u8fc7\u4fee\u6539\u76f4\u63a5\u51fa istio\u3002</p>"},{"location":"chap4/4Istio_ServiceEntry_issue/#6","title":"6\u3001\u590d\u76d8","text":"<p>\u597d\u7684\uff0c\u73b0\u5728 debug \u7684\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u51e0\u4e2a\u95ee\u9898\u4e5f\u5f97\u5230\u89e3\u51b3\u3002</p> <ul> <li>\u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f</li> </ul> <p>\u5728\u4e4b\u524d\u7684\u4f7f\u7528\u4e2d\uff0c\u7531\u4e8e\u8be5 bug \u7684\u5b58\u5728\uff0c\u4f7f\u5f97\u8bbf\u95ee\u5411\u516c\u7f51\u7684 https \u670d\u52a1\u5747\u88ab\u8f6c\u53d1\u5230\u4e86\u5185\u90e8\u67d0\u4e2a\u670d\u52a1\u3002\u6240\u4ee5\u65e0\u6cd5\u8bbf\u95ee\uff0c\u5728\u8fd9\u6837\u7684\u60c5\u51b5\u4e0b\u589e\u52a0 <code>MESH_EXTERNAL serviceentry</code> \u76f8\u5f53\u4e8e\u5728\u89c4\u5219\u4e2d\u589e\u52a0\u4e86\u7279\u6b8a\u5339\u914d\u7684\u89c4\u5219,\u4f7f\u5f97\u80fd\u591f\u5339\u914d\u6210\u529f\uff0c\u6d41\u91cf\u5f97\u4ee5\u51fa istio\u3002\u4e3e\u4f8b: <code>0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com</code></p> <p>\u5728\u8be5 bug \u4fee\u590d\u540e\uff0c\u4e0d\u518d\u9700\u8981\u5bf9\u516c\u7f51\u7684\u670d\u52a1\u505a\u914d\u7f6e\u4e86\u3002</p> <ul> <li><code>*.example.com'</code> \u662f\u54ea\u91cc\u6765\u7684\uff1f</li> </ul> <p><code>*.example.com</code> \u5b9e\u9645\u662f\u540e\u7aef\u67d0\u4e2a\u670d\u52a1\u4e0a\u4f7f\u7528\u7684\u8bc1\u4e66\uff0c\u7531\u4e8e\u9519\u8bef\u7684\u914d\u7f6e,\u6570\u636e\u5305\u9519\u8bef\u5206\u53d1\u3002\u5b9e\u9645\u6240\u6709\u7684 https \u5747\u8fde\u5230\u4e86\u8fd9\u4e2a\u9519\u8bef\u7684\u540e\u7aef\u3002</p> <ul> <li>\u4e3a\u4ec0\u4e48\u4e0d\u540c\u7684 pod \u4e0b\u8868\u73b0\u4e0d\u4e00\u81f4\uff0c\u6709\u7684\u63e1\u624b\u5931\u8d25\uff0c\u6709\u7684\u63d0\u793a\u8bc1\u4e66\u9519\u8bef\uff1f</li> </ul> <p>\u5728 sidecar \u914d\u7f6e\u7684\u8fc7\u7a0b\u4e2d\uff0c<code>0.0.0.0 443 AL</code>L\u8fd9\u6837\u7684\u89c4\u5219(serviceentry)\u4f1a\u6709\u591a\u4e2a\uff0c\u5728\u751f\u6210\u89c4\u5219\u7684\u65f6\u5019\uff0c\u4f1a\u5e76\u53d1\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u540e\u7aef\u4f5c\u4e3a\u8be5\u5730\u5740\u4e0a\u7684\u670d\u52a1\u3002\u5982\u679c\u8fde\u63a5\u5230\u4e86 mysql \u8fd9\u7c7b\u7684\u670d\u52a1\uff0c\u5219\u65e0\u6cd5\u63e1\u624b\u6210\u529f\u3002</p> <ul> <li>\u4e3a\u4ec0\u4e48\u672a\u6307\u5b9a address \u7684 serviceentry \u4f1a\u88ab\u5339\u914d\u5230 0.0.0.0 \uff1f</li> </ul> <p>\u8fd9\u662f istio \u7684\u8003\u8651\uff0c\u5728\u7ffb\u770b\u6e90\u7801<code>conversion.go#L57</code>\u540e\u53d1\u73b0 0.0.0.0 \u662f\u5176\u9ed8\u8ba4\u503c\u3002</p> <ul> <li>\u4e3a\u4ec0\u4e48\u5728\u6b64\u6b21\u5347\u7ea7\u540e\u624d\u53d1\u73b0\u95ee\u9898\uff1f</li> </ul> <p>\u56e0\u4e3a sidecar \u914d\u7f6e\u7684\u5b58\u5728\u3002\u5728\u4e4b\u524d\u7684 istio \u4e5f\u5b58\u5728\u8be5\u95ee\u9898\uff0c\u53ea\u662f\u901a\u8fc7\u4e3a\u5916\u90e8 https \u8bbe\u7f6e serviceentry \u5f97\u4ee5\u89c4\u907f\u3002\u800c\u4e14\u8be5\u89c4\u5219\u5b58\u5728 default \u547d\u540d\u7a7a\u95f4\u5185\u3002</p> <p>\u5728\u5347\u7ea7\u540e\uff0c\u6211\u4eec\u5bf9\u7a7a\u95f4\u8bbe\u7f6e\u4e86 sidecar \u3002\u4f7f\u5f97 default \u7a7a\u95f4\u7684 <code>serviceentry</code> \u65e0\u6cd5\u4f20\u64ad\u5230\u5176\u4ed6\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5176\u4ed6\u7a7a\u95f4\u7684 https \u5747\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u540e\u7aef\u670d\u52a1\u3002</p>"},{"location":"chap5/10Istio_http2/","title":"\u7b2c\u5341\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u91d1\u4e1d\u96c0\u90e8\u7f72/\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531/URI\u8fdb\u884c\u91cd\u5b9a\u5411)","text":"<ul> <li>1 \u91d1\u4e1d\u96c0\u90e8\u7f72</li> <li>2 \u6839\u636e\u6765\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531</li> <li>3 \u5bf9<code>URI</code>\u8fdb\u884c\u91cd\u5b9a\u5411</li> </ul>"},{"location":"chap5/10Istio_http2/#1","title":"1\u3001\u91d1\u4e1d\u96c0\u90e8\u7f72","text":"<p>\u7b80\u5355\u8bf4\u6765\uff0c\u91d1\u4e1d\u96c0\u90e8\u7f72\u5c31\u662f\u5728\u53d1\u5e03\u65b0\u7248\u672c\u65f6\uff0c\u90e8\u7f72\u7684\u65b0\u7248\u672c\u5e76\u4e0d\u5bf9\u5916\u5f00\u653e\uff0c\u800c\u662f\u9009\u62e9\u4e00\u5c0f\u90e8\u5206\u7528\u6237\u4e3a\u6d4b\u8bd5\u76ee\u6807\uff0c\u8fd9\u90e8\u5206\u7528\u6237\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\u4f1a\u6307\u5411\u7279\u5b9a\u7684\u7248\u672c\uff0c\u901a\u8fc7\u5bf9\u8fd9\u4e9b\u91d1\u4e1d\u96c0\u7528\u6237\u7684\u4f7f\u7528\u60c5\u51b5\u7684\u89c2\u5bdf\uff0c\u6765\u786e\u5b9a\u65b0\u7248\u672c\u670d\u52a1\u7684\u53d1\u5e03\u6548\u679c\uff0c\u5728\u786e\u5b9a\u7ed3\u679c\u4e4b\u524d, \u6240\u6709\u5176\u4ed6\u7528\u6237\u90fd\u7ee7\u7eed\u4f7f\u7528\u539f\u6709\u7248\u672c\u3002</p> <p>\u8fd9\u91cc\u8fd8\u662f\u4ee5<code>flaskapp</code>\u4e3a\u4f8b\uff0c\u6309\u7167\u6848\u4f8b\u9700\u6c42\uff0c\u6211\u4eec\u5047\u5b9a<code>v1</code>\u662f\u65e7\u7248\u672c\uff0c<code>v2</code>\u662f\u65b0\u7248\u672c\u3002\u5728\u53d1\u5e03\u65b0\u7248\u672c\u65f6 , \u9009\u62e9\u4e00\u90e8\u5206\u7528\u6237\u4f5c\u4e3a\u91d1\u4e1d\u96c0\u7528\u6237\uff0c\u5728\u91d1\u4e1d\u96c0\u7528\u6237\u8bbf\u95ee <code>flaskapp</code> \u65f6\u4ea7\u751f\u6d41\u91cf\u7684<code>HTTP header</code>\u4e2d\u4f1a\u6709\u4e00\u884c<code>lab:canary</code>, \u6211\u4eec\u4f1a\u7528\u8be5\u5185\u5bb9\u533a\u522b\u7528\u6237\uff0c \u5176\u4ed6\u767b\u5f55\u7528\u6237\u548c\u533f\u540d\u7528\u6237\u5168\u90e8\u8bbf\u95ee\u5c31\u7248\u672c<code>flaskapp</code>,\u91d1\u4e1d\u96c0\u7528\u6237\u5728\u8bbf\u95ee<code>flaskapp</code>\u65f6\u4f1a\u8bbf\u95ee\u65b0\u7248\u672c\u7684<code>flaskapp</code>\uff0c\u6574\u4f53\u573a\u666f\u5982\u4e0b</p> <p> </p> <p>\u6839\u636e<code>HTTP</code>\u5185\u5bb9\u8fdb\u884c\u8def\u7531\u7684\u80fd\u529b, \u8fd9\u91cc\u53ef\u4ee5\u9488\u5bf9\u91d1\u4e1d\u96c0\u7528\u6237\u7684\u9700\u6c42\uff0c\u518d\u6b21\u4fee\u6539\u6211\u4eec\u7684<code>VirtualService</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp \nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  http: \n  - match:\n    - headers:\n        lab:\n          exact: canary\n    route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v2\n  - route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v1   \n</code></pre> <p>\u5c06<code>YAML</code>\u5185\u5bb9\u4fdd\u5b58\u4e3a<code>canary.virtualservice.yaml</code>\u4f7f\u7528<code>kubectl apply</code>\u547d\u4ee4\u5c06\u5176\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\u3001\u8fdb\u4eba<code>sleep Pod</code>\u5f00\u59cb\u6d4b\u8bd5\uff1a </p> <pre><code>$ kubectl apply -f canary-virtualservice.yaml \nvirtualservice.networking.istio.io/flaskapp created\n</code></pre> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash\n\nbash-4.4# http --body http://flaskapp/env/version\nv1\n</code></pre> <p>\u91cd\u590d\u6267\u884c\u51e0\u904d\uff0c\u4f1a\u770b\u5230\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8bbf\u95ee\u7684\u90fd\u662f<code>v1</code>\u7248\u672c\u7684<code>flaskapp</code>\u3002 </p> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u8bf7\u6c42\u4e2d\u52a0\u5165<code>lab:canary Header</code>\uff0c\u518d\u6b21\u8c03\u7528<code>flaskapp</code></p> <pre><code>http --body http://flaskapp/env/version lab:canary\nv2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u6b21\u5f97\u5230\u7684\u662f<code>v2</code>\u7248\u672c\u7684\u8fd4\u56de\u503c\u3002 </p> <p>\u628a<code>canary</code>\u6362\u6210<code>phoenix</code>\u518d\u8bd5\u9a8c\u4e00\u4e0b </p> <pre><code>bash-4.4# http --body http://flaskapp/env/version lab:phoenix\nv1\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\u4e0d\u7b26\u5408\u5224\u65ad\u6761\u4ef6\uff0c\u751f\u6548\u7684\u4ecd\u7136\u662fv1\u7248\u672c </p> <p>\u5bf9\u4e8e\u8fd9\u4e2a<code>VirtualService</code>\u6211\u4eec\u9700\u8981\u4e86\u89e3\u4ee5\u4e0b\u5185\u5bb9\u3002</p> <ul> <li>\u8fd9\u91cc\u4e5f\u5728<code>http</code>\u5b57\u6bb5\u5b9a\u4e49\u4e86\u4e24\u4e2a\u8def\u7531(<code>HTTPRoute</code>\u5bf9\u8c61\uff0c\u533a\u522b\u662f\u8fd9\u6b21\u52a0\u4eba\u4e86\u4e00\u4e2a<code>match</code>\u5b57\u6bb5match\u5b57\u6bb5\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u5339\u914d \u529f\u80fd\u5176\u5339\u914d\u8303\u56f4\u4e0d\u4ec5\u5305\u62ec<code>HTTP Header</code>,\u8fd8\u5305\u62ec<code>uri</code>\u3001 <code>scheme</code>\u3001 <code>method</code>\u3001<code>authority</code>,\u7aef\u53e3\uff0c\u6765\u6e90\u6807\u7b7e\u548c<code>gateway</code>\u7b49</li> <li>\u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u9488\u5bf9<code>http header</code>\u7684\u5339\u914d\uff0c\u8981\u6c42lab\u7684\u53d6\u503c\u5fc5\u987b\u5b8c\u5168\u5339\u914d<code>canary</code>,\u8fd9\u91cc\u9664\u4e86\u53ef\u4ee5\u4f7f\u7528\u4ee3\u8868\u5b8c\u5168\u76f8\u7b49\u7684<code>exact</code>\u52a8\u8bcd\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>prefix</code>\u548c<code>regex</code>\uff0c\u5206\u522b\u4ee3\u8868\u524d\u7f00\u548c\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5339\u914d\u65b9\u5f0f</li> </ul>"},{"location":"chap5/10Istio_http2/#2","title":"2\u3001\u6839\u636e\u6765\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531","text":"<p>\u6211\u4eec\u6839\u636e\u7528\u6237\u53d1\u51fa\u7684\u8bf7\u6c42\u4e2d\u7684<code>HTTP Header</code>\u8fdb\u884c\u4e86\u8f6c\u53d1\u3002\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\u8fd8\u5b58\u5728\u53e6\u4e00\u79cd\u60c5\u51b5\uff1a</p> <p>\u6765\u81ea\u4e0d\u540c\u7248\u672c\u7684\u670d\u52a1\u8bbf\u95ee\u4e0d\u540c\u7248\u672c\u7684\u76ee\u6807\u670d\u52a1</p> <ul> <li>\u6bd4\u5982<code>v1</code>\u7248\u672c\u7684<code>sleep</code>\u5411<code>flaskapp</code>\u53d1\u51fa\u7684\u8bf7\u6c42\u7531<code>flaskapp</code>\u7684<code>v1</code>\u7248\u672c\u63d0\u4f9b\u54cd\u5e94\uff0c</li> <li>\u5176\u4ed6\u7248\u672c\u7531<code>flaskapp</code>\u7684<code>v2</code>\u7248\u672c\u8d1f\u8d23\uff0c\u5982\u56fe\u6240\u793a\u3002 </li> </ul> <p> </p> <p><code>sourceLabels-virtualservice.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp \nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  http: \n  - match:\n    - sourceLabels:\n        app: sleep\n        version: v1\n    route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v1\n  - route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v2\n</code></pre> <p>\u4f7f\u7528<code>kubectl apply</code>\u66f4\u65b0<code>VirtualService</code>\uff0c\u7136\u540e\u5206\u522b\u8fdb\u4eba\u4e24\u4e2a\u7248\u672c\u7684<code>sleep Pod</code>\u8fdb\u884c </p> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\n\nbash-4.4# http --body http://flaskapp/env/version\nv1\n\n$ kubectl exec -it sleep-v2-7c6b874968-hl6dj -c sleep bash\n\nbash-4.4# http --body http://flaskapp/env/version\nv2\n</code></pre> <p>\u4fa7\u8bd5\u7ed3\u679c\u5f88\u6e05\u695a,\u4ece<code>sleep</code>\u670d\u52a1\u7684<code>v1</code>\u7248\u672c\u53d1\u7ed9<code>flaskapp</code>\u7684\u8bf7\u6c42\uff0c\u7531<code>flaskapp</code>\u7684<code>v1</code>\u7248\u672c\u8fdb\u884c\u4e86\u5904\u7406\uff0c\u8ddf\u6211\u4eec\u7684\u9884\u671f\u662f\u4e00\u81f4\u7684\u3002 </p> <p> </p> <p>\u5728\u4e0a\u9762\u7684<code>VirtualService</code>\u5b9a\u4e49\u91cc\uff0c\u7528<code>SourceLabels</code>\u5bf9\u6765\u6e90\u8def\u7531\u8fdb\u884c\u4e86\u5339\u914d\uff0c<code>app</code>\u6807\u7b7e\u4e3a<code>sleep</code>\u6807\u7b7e\u4e3a<code>version</code>\u6807\u7b7e<code>v1</code>\u7684\u8bf7\u6c42\uff0c\u4f1a\u88ab\u53d1\u9001\u7ed9<code>flaskapp</code>\u7684<code>v1</code>\u7248\u672c\u8fdb\u884c\u5904\u7406, \u5176\u4ed6\u6765\u6e90\u7684\u8bf7\u6c42\u7531<code>V2</code> \u7248\u672c\u8fdb\u884c\u5339\u914d\u3002 </p>"},{"location":"chap5/10Istio_http2/#3-uri","title":"3\u3001 \u5bf9<code>URI</code>\u8fdb\u884c\u91cd\u5b9a\u5411","text":"<p>\u8fd8\u6709\u53e6\u5916\u4e00\u79cd\u5bf9\u76ee\u6807\u8def\u7531\u7684\u5206\u6d41\u65b9\u5f0f\uff0c\u5373\u6839\u636eURL\u8fdb\u884c\u91cd\u5b9a\u5411</p> <p>\u4f8b\u5982\uff0c<code>v2</code>\u7248\u672c\u7684<code>sleep</code>\u670d\u52a1\u53d1\u8d77\u5bf9<code>flaskapp</code>\u670d\u52a1<code>\"/env/HOSTNAME\"</code>\u8def\u5f84\u7684\u8bf7\u6c42\uff0c \u90a3\u4e48\u5c06\u5176\u7167\u5b9e\u8fd4\u56de\uff1b</p> <p>\u5982\u679c\u8bf7\u6c42\u6765\u81ea<code>v1</code>\u7248\u672c\u7684<code>sleep</code>\u670d\u52a1,\u90a3\u4e48\u5c06\u5176\u8bf7\u6c42\u8def\u5f84\u7531 <code>\"/env/HOSTNAME\"</code>\u4fee\u6539\u4e3a<code>\"/env/version\"</code>\u3002\u5c06<code>flaskapp.virtualservice.yaml</code>\u7684<code>spec</code>\u5b57\u6bb5\u4fee\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9\uff1a </p> <p><code>uri-virtualservice.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp \nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  http: \n  - match:\n    - sourceLabels:\n        app: sleep\n        version: v1\n      uri:\n        exact: \"/env/HOSTNAME\"\n    redirect:\n      uri: /env/version\n  - route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v2\n</code></pre> <p>\u5206\u522b\u8fdb\u5165\u4e24\u4e2a<code>sleep pod</code> <code>v1</code>\uff0c<code>v2</code></p> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\n\nbash-4.4# http http://flaskapp/env/HOSTNAME\nHTTP/1.1 301 Moved Permanently\ncontent-length: 0\ndate: Sun, 27 Oct 2019 07:54:40 GMT\nlocation: http://flaskapp/env/version\nserver: envoy\n\nkubectl exec -it sleep-v2-7c6b874968-hl6dj -c sleep bash\n\nhttp http://flaskapp/env/HOSTNAME\nHTTP/1.1 200 OK\ncontent-length: 27\ncontent-type: text/html; charset=utf-8\ndate: Sun, 27 Oct 2019 07:55:39 GMT\nserver: envoy\nx-envoy-upstream-service-time: 1\n\nflaskapp-v2-d5bc47bf5-5kk5k\n</code></pre> <p> </p> <p> </p> <p>\u5728<code>v1</code>\u4e2d\u4f1a\u53d1\u73b0\u8fd4\u56de\u4e00\u4e2a301\u6307\u4ee4\uff0c\u6211\u4eec\u5728\u6307\u4ee4\u4e2d\u52a0\u5165\u91cd\u5b9a\u5411\u7684\u6307\u4ee4\u518d\u6b21\u5c1d\u8bd5</p> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\n\nbash-4.4# http --follow http://flaskapp/env/HOSTNAME\nHTTP/1.1 200 OK\ncontent-length: 2\ncontent-type: text/html; charset=utf-8\ndate: Sun, 27 Oct 2019 07:59:25 GMT\nserver: envoy\nx-envoy-upstream-service-time: 1\n\nv2\n</code></pre> <p>\u8fd9\u4e00\u6b21\u6210\u529f\u770b\u5230\u53d1\u751f\u4e86\u91cd\u5b9a\u5411\uff0c\u5373\u6700\u7ec8\u7531<code>\u201c/env/version\u201d</code>\u8def\u5f84\u5904\u7406\u4e86\u6211\u4eec\u7684\u8bf7\u6c42\u3002 </p> <p>\u5728\u8fd9\u6b21\u7684<code>VirtualService</code>\u5b9a\u4e49\u4e2d\uff0c\u5c06\u7531<code>v1</code>\u7248\u672c\u7684<code>sleep</code>\u670d\u52a1\u53d1\u8d77\u7684\u5230<code>http://flaskapp/env/HOSTNAME</code>\u7684\u8bf7\u6c42\uff0c\u7528<code>301</code>\u6307\u4ee4\u8fdb\u884c\u4e86\u91cd\u5b9a\u5411\u3002</p> <p>\u8fd9\u91cc\u8981\u6ce8\u610f\uff1a<code>redirect</code>\u6307\u4ee4\u4f1a\u628a<code>URI</code>\u8fdb\u884c\u6574\u4f53\u66ff\u6362\uff0c\u56e0\u6b64\u7075\u6d3b\u6027\u4e0d\u9ad8\uff1b</p> <p>\u53e6\u5916<code>301</code>\u6307\u4ee4\u65e0\u6cd5\u652f\u6301<code>Post</code>\u65b9\u6cd5\u3002</p> <p>\u4f8b\u5982\u6211\u4eec\u60f3\u8981\u7ed9<code>httpbin</code>\u8bbe\u7f6e\u4e00\u4e2a\u4f7f\u7528<code>Post</code>\u65b9\u6cd5\u7684\u91cd\u5b9a\u5411\uff0c\u5219\u53ef\u7f16\u5199\u5982\u4e0b\u4ee3\u7801\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: httpbin \nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  http: \n  - match:\n    - uri:\n        exact: \"get\"\n    redirect:\n      uri: /post\n  - route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n</code></pre> <p>\u5c06\u8fd9\u4e00\u6bb5\u4ee3\u7801\u4fdd\u5b58\u5230<code>httpbin.virtualservice.yaml</code>\u4e2d\uff0c\u5e76\u4f7f\u7528<code>kubectl apply</code>\u5c06\u5176\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\u3002</p> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u5c06\u5bf9<code>httpbin</code>\u670d\u52a1<code>\u201c/get\u201d</code>\u8def\u5f84\u7684\u8bbf\u95ee\u91cd\u5b9a\u5411\u5230<code>\u201c/post\"</code>\u4e0a\uff0c\u4e0b\u9762\u7528<code>sleep Pod</code>\u53d1\u8d77\u8bf7\u6c42\u6d4b\u8bd5\u4e00\u4e0b\uff1a </p> <pre><code>$ kubectl get vs\nNAME       GATEWAYS   HOSTS                                  AGE\nflaskapp              [flaskapp.default.svc.cluster.local]   32m\nhttpbin               [flaskapp.default.svc.cluster.local]   5s\n</code></pre> <p>\u6211\u9047\u5230\u7684\u95ee\u9898\uff1a</p> <pre><code>bash-4.4# http -f POST http://httpbin:8000/post data=nothing\nHTTP/1.1 503 Service Unavailable\ncontent-length: 95\ncontent-type: text/plain\ndate: Sun, 27 Oct 2019 08:27:56 GMT\nserver: envoy\n\nupstream connect error or disconnect/reset before headers. reset reason: connection termination\n</code></pre> <p>\u539f\u56e0\u6211\u9519\u8bef\u7684\u4fee\u6539\u4e86<code>mlts</code>\uff0c\u53d8\u6210\u4e86<code>global enabled</code></p> <pre><code>$ kubectl get MeshPolicy default -oyaml\napiVersion: authentication.istio.io/v1alpha1\nkind: MeshPolicy\nmetadata:\n  annotations:\n    kubectl.kubernetes.io/last-applied-configuration: |\n      {\"apiVersion\":\"authentication.istio.io/v1alpha1\",\"kind\":\"MeshPolicy\",\"metadata\":{\"annota\ntions\":{},\"name\":\"default\"},\"spec\":{\"peers\":[{\"mtls\":{}}]}}\n  creationTimestamp: \"2019-10-18T09:23:09Z\"\n  generation: 2\n  name: default\n  resourceVersion: \"198498\"\n  selfLink: /apis/authentication.istio.io/v1alpha1/meshpolicies/default\n  uid: f1b9dc29-d94c-415d-b879-25c71a3d4769\nspec:\n  peers:\n  - mtls: {}\n</code></pre> <p>\u89e3\u51b3\u65b9\u5f0f\uff0c\u8be5\u56de\u5230<code>permissive</code>, </p> <pre><code>$ kubectl edit  MeshPolicy default\nmeshpolicy.authentication.istio.io/default edited\n\npeers:\n- mtls: \n    mode: PERMISSIVE\n</code></pre> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\n\nhttp -f POST http://httpbin:8000/post data=nothing\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\ncontent-length: 586\ncontent-type: application/json\ndate: Sun, 27 Oct 2019 09:24:50 GMT\nserver: envoy\nx-envoy-upstream-service-time: 6\n\n{\n    \"args\": {},\n    \"data\": \"\",\n    \"files\": {},\n    \"form\": {\n        \"data\": \"nothing\"\n    },\n    \"headers\": {\n        \"Accept\": \"*/*\",\n        \"Accept-Encoding\": \"gzip, deflate\",\n        \"Content-Length\": \"12\",\n        \"Content-Type\": \"application/x-www-form-urlencoded; charset=utf-8\",\n        \"Host\": \"httpbin:8000\",\n        \"User-Agent\": \"HTTPie/0.9.9\",\n        \"X-B3-Parentspanid\": \"159205ecd8ddc070\",\n        \"X-B3-Sampled\": \"1\",\n        \"X-B3-Spanid\": \"cda267c471801f5e\",\n        \"X-B3-Traceid\": \"fda0d72802b78b9c159205ecd8ddc070\"\n    },\n    \"json\": null,\n    \"origin\": \"127.0.0.1\",\n    \"url\": \"http://httpbin:8000/post\"\n}\n</code></pre> <p> </p> <p>\u53ef\u4ee5\u770b\u5230\uff0cPOST\u6210\u529f\u3002\u6211\u4eec\u518d\u6b21\u53d1\u8d77\u8bf7\u6c42\uff0c\u8fd9\u6b21\u8bf7\u6c42\u7684\u76ee\u6807\u662f<code>\"/get\"</code>: </p> <pre><code>bash-4.4# http --follow -f POST http://httpbin:8000/get data=nothing\nHTTP/1.1 405 Method Not Allowed\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\nallow: OPTIONS, POST\ncontent-length: 178\ncontent-type: text/html\ndate: Sun, 27 Oct 2019 09:32:51 GMT\nserver: envoy\nx-envoy-upstream-service-time: 3\n\n&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 3.2 Final//EN\"&gt;\n&lt;title&gt;405 Method Not Allowed&lt;/title&gt;\n&lt;h1&gt;Method Not Allowed&lt;/h1&gt;\n&lt;p&gt;The method is not allowed for the requested URL.&lt;/p&gt;\n</code></pre> <p>\u8fd9\u6b21\u53d1\u751f\u4e86\u91cd\u5b9a\u5411\uff0c \u4f46\u662f\u5f88\u660e\u663e\uff0c \u5e76\u6ca1\u6709\u6ee1\u8db3\u6211\u4eec\u7684\u8981\u6c42\uff0c <code>Istio</code>\u8fd8\u63d0\u4f9b\u4e86<code>Rewrite</code>\u7684\u65b9\u5f0f\u6765\u63d0\u4f9b\u8fd9\u79cd\u5728\u8c03\u7528\u524d\u8fdb\u884c<code>URI</code>\u91cd\u5199\u7684\u652f\u6301\u3002 </p> <p>\u4e0b\u9762\u518d\u6b21\u4fee\u6539<code>httpbin</code>\u7684\u8def\u7531\u89c4\u5219\uff0c \u628a<code>redirect</code>\u4fee\u6539\u4e3a<code>rewrite</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: httpbin \nspec: \n  hosts:\n  - httpbin.default.svc.cluster.local\n  http: \n  - match:\n    - uri:\n        exact: \"/get\"\n    rewrite:\n      uri: /post\n    route: \n    - destination: \n        host: httpbin.default.svc.cluster.local\n  - route: \n    - destination: \n        host: httpbin.default.svc.cluster.local\n</code></pre> <p>\u5728\u63d0\u4ea4\u65b0\u7684\u89c4\u5219\u4e4b\u540e\uff0c\u518d\u6b21\u8fdb\u5165<code>Sleep Pod</code>\u8fdb\u884c\u5c1d\u8bd5\uff1a </p> <pre><code>bash-4.4#  http -f POST http://httpbin:8000/get data=nothing\nHTTP/1.1 301 Moved Permanently\nconnection: close\ncontent-length: 0\ndate: Sun, 27 Oct 2019 09:43:13 GMT\nlocation: http://httpbin:8000/post\nserver: envoy\n</code></pre> <p>\u8fd9\u6b21\u5b8c\u6210\u4e86\u5bf9<code>post</code>\u65b9\u5f0f\u6539\u5199</p> <p><code>rewrite</code>\u65b9\u6cd5\u548c<code>rediret</code>\u65b9\u6cd5\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\uff0c\u5728<code>rewrite</code>\u65b9\u6cd5\u7684<code>match</code>\u4e00\u8282\u5fc5\u987b\u5305\u542b\u5bf9\u76ee\u6807\u7684\u5b9a\u4e49\u3002\u5e76\u4e14\uff0c<code>rewrite</code>\u65b9\u6cd5\u548c<code>rediret</code>\u65b9\u6cd5\u4e0d\u80fd\u5171\u5b58\u3002</p>"},{"location":"chap5/11Istio_http3/","title":"\u7b2c\u5341\u4e00\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u901a\u4fe1\u8d85\u65f6/\u6545\u969c\u91cd\u8bd5/\u5165\u53e3~\u51fa\u53e3\u6d41\u91cf\u7ba1\u7406\uff09","text":"<ul> <li>1 \u901a\u4fe1\u8d85\u65f6\u63a7\u5236 </li> <li>2 \u6545\u969c\u91cd\u8bd5\u63a7\u5236</li> <li>3 \u5165\u53e3\u6d41\u91cf\u7ba1\u7406</li> <li>4 \u51fa\u53e3\u6d41\u91cf\u7ba1\u7406</li> </ul>"},{"location":"chap5/11Istio_http3/#1","title":"1\u3001 \u901a\u4fe1\u8d85\u65f6\u63a7\u5236","text":"<p>\u5728\u5fae\u670d\u52a1\u4e4b\u95f4\u8fdb\u884c\u76f8\u4e92\u8c03\u7528\u65f6\uff0c\u56e0\u4e3a\u670d\u52a1\u95ee\u9898\u6216\u8005\u7f51\u7edc\u6545\u969c\u7684\u5f71\u54cd\uff0c\u53d1\u751f\u8d85\u65f6 \u662f\u5728\u6240\u96be\u514d\u7684\u3002\u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\u5982\u679c\u4e0d\u52a0\u63a7\u5236\uff0c\u5219\u901a\u5e38\u9700\u8981\u7b49\u5f85\u9ed8\u8ba4\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u4f1a\u5bfc\u81f4\u4e1a\u52a1\u5904\u7406\u65f6\u95f4\u5927\u5e45\u5ea6\u5ef6\u957f\uff1b\u5982\u679c\u6545\u969c\u6301\u7eed\u5b58\u5728\uff0c\u5219\u5f80\u5f80\u4f1a\u9020\u6210\u4e1a\u52a1\u79ef\u538b\uff0c\u5230\u4e86\u4e00\u5b9a\u7a0b\u5ea6\u4e4b\u540e\u751a\u81f3\u4f1a\u5bfc\u81f4\u6545\u969c\u6269\u4e00\u6563\uff0c\u9020\u6210\u5927\u9762\u79ef\u6545\u969c\u3002</p> <p>\u5373\u4f7f\u5168\u90e8\u52a0\u4ee5\u63a7\u5236\uff08\u4f8b\u5982\uff0c\u5bf9\u4e8e\u67d0\u4e00\u670d\u52a1\u7684\u8c03\u7528\uff0c\u4e00\u65e6\u8d85\u8fc7\u4e00\u5b9a\u7684\u65f6\u95f4\u5219\u81ea\u52a8\u7ec8\u6b62\u8be5\u8c03\u7528\uff09\uff0c\u4f46\u56e0\u4e3a\u670d\u52a1\u548c\u4e1a\u52a1\u60c5\u51b5\u591a\u53d8\uff0c\u9700\u8981\u4e0d\u65ad\u8c03\u6574\u63a7\u5236\u8fc7\u7a0b\u6765\u8fdb\u884c\u8c03\u6574\u548c\u4f18\u5316\u3002\u4f8b\u5982\uff0c\u6709\u54ea\u4e9b\u8c03\u7528\u70b9\u9700\u8981\u63a7\u5236\uff1f</p> <p>\u6bcf\u4e2a\u8c03\u7528\u70b9\u7684\u8d85\u65f6\u5e94\u8be5\u8bbe\u7f6e\u4e3a\u591a\u5c11\uff1f\u4fee\u6539\u5176\u4e2d\u4e00\u70b9\u4e4b\u540e\uff0c\u4f1a\u5bf9\u5176\u4ed6\u8c03\u7528\u70b9\u7684\u8d85\u65f6\u8bbe\u7f6e\u4ea7\u751f\u4ec0\u4e48\u6837\u7684\u5f71\u54cd\uff1f\u8fd9\u79cd\u8c03\u6574\u610f\u5473\u7740\u5f88\u591a\u7684\u91cd\u590d\u5de5\u4f5c\uff0c\u5f80\u5f80\u9700\u8981\u975e\u5e38\u591a\u7684\u4eba\u529b\u548c\u65f6\u95f4\u6295\u4eba\u624d\u80fd\u8fbe\u5230\u8f83\u597d\u7684\u6548\u679c\u3002 </p> <p>\u901a\u8fc7<code>Istio</code>\u7684\u6d41\u91cf\u63a7\u5236\u529f\u80fd\u53ef\u4ee5\u5bf9\u670d\u52a1\u95f4\u7684\u8d85\u65f6\u8fdb\u884c\u63a7\u5236\uff0c\u5728\u5e94\u7528\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u6839\u636e<code>VirtualService</code>\u7684\u914d\u7f6e\uff0c\u52a8\u6001\u8c03\u6574\u8c03\u7528\u8fc7\u7a0b\u4e2d\u7684\u8d85\u65f6\u4e0a\u9650\uff0c\u4ece\u800c\u8fbe\u5230\u63a7\u5236\u6545\u969c\u8303\u56f4\u7684\u76ee\u7684\u3002</p> <p>\u76f8\u5bf9\u4e8e\u4ee3\u7801\u4fee\u6539\uff0c\u8fd9\u79cd\u975e\u4eba\u4fb5\u7684\u8c03\u6574\u65b9\u5f0f\u80fd\u591f\u8282\u7701\u5927\u91cf\u7684\u6210\u672c\u3002 </p> <p>\u8fd9\u91cc\u4e3a<code>httpbin</code>\u670d\u52a1\u7f16\u5199\u4e00\u4e2a<code>VirtualService</code>\uff0c\u8bbe\u7f6e\u5b83\u7684\u8d85\u65f6\u4e0a\u9650\uff0c\u4f7f\u5bf9<code>httpbin</code> \u670d\u52a1\u7684\u8c03\u7528\u4e00\u65e6\u8d85\u8fc7<code>3</code>\u79d2\uff0c\u5219\u5224\u5b9a\u4e3a\u8d85\u65f6\uff1a <code>timeout: 3s</code></p> <p><code>httpbin.timeout.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: httpbin \nspec: \n  hosts:\n  - httpbin.default.svc.cluster.local\n  http: \n    - route:\n      - destination: \n          host: httpbin.default.svc.cluster.local\n      timeout: 3s\n</code></pre> <pre><code>$ kubectl apply -f httpbin.timeout.yaml \nvirtualservice.networking.istio.io/httpbin created\n</code></pre> <p>\u7136\u540e\u4f7f\u7528<code>sleep Pod</code>\u8fdb\u884c\u6d4b\u8bd5\uff0c\u5728\u6d4b\u8bd5\u4e2d\u4f7f\u7528<code>httpbin</code>\u7684<code>\"/delay\"</code>\u8def\u5f84\uff0c\u8fd9\u4e2a\u8def\u5f84\u63a5\u6536\u4e00\u4e2a\u6574\u6570\u4f5c\u4e3a\u53c2\u6570\uff0c\u5728\u670d\u52a1\u5668\u5ef6\u65f6\u6307\u5b9a\u79d2\u6570\u4e4b\u540e\u624d\u8fd4\u56de\u54cd\u5e94</p> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-448v6  -c sleep bash \n\nbash-4.4# http --body http://httpbin:8000/delay/2\n{\n    \"args\": {},\n    \"data\": \"\",\n    \"files\": {},\n    \"form\": {},\n    \"headers\": {\n        \"Accept\": \"*/*\",\n        \"Accept-Encoding\": \"gzip, deflate\",\n        \"Content-Length\": \"0\",\n        \"Host\": \"httpbin:8000\",\n        \"User-Agent\": \"HTTPie/0.9.9\",\n        \"X-B3-Parentspanid\": \"a35e61fc2a2adba8\",\n        \"X-B3-Sampled\": \"1\",\n        \"X-B3-Spanid\": \"8bbbca0d349b1326\",\n        \"X-B3-Traceid\": \"66816ed2aa478250a35e61fc2a2adba8\"\n    },\n    \"origin\": \"127.0.0.1\",\n    \"url\": \"http://httpbin:8000/delay/2\"\n}\n\nhttp --body http://httpbin:8000/delay/4\nupstream request timeout\n\nbash-4.4# http --body http://httpbin:8000/delay/5\nupstream request timeout\n</code></pre> <p>\u5982\u6b64\u770b\u6765\u6211\u4eec\u7684\u8d85\u65f6\u8bbe\u7f6e\u5df2\u7ecf\u751f\u6548\uff0c\u5982\u679c\u5ef6\u8fdf\u4e862\u79d2\uff0c\u5219\u65b9\u6cd5\u53ef\u4ee5\u6b63\u5e38\u5b8c\u6210\u8c03\u7528, \u5982\u679c\u5ef6\u8fdf\u8d85\u8fc73\u79d2\u5219\u4f1a\u53d1\u751f\u8d85\u65f6\u3001\u5931\u8d25 </p> <p>\u53ef\u4ee5\u770b\u51fa\uff0c\u8d85\u65f6\u914d\u7f6e\u975e\u5e38\u7b80\u5355\uff0c\u800c\u4e14\u662f<code>VirtualService</code>\u7684\u4e00\u90e8\u5206\uff0c\u56e0\u6b64\u5404\u79cd\u8fc7\u6ee4\u548c\u8def\u7531\u4e5f\u662f\u6709\u6548\u7684\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bf7\u6c42\u7684\u6e90\u548c\u76ee\u7684\u3001\u6807\u7b7e\u7b49\u6d41\u91cf\u7279\u5f81\u6765\u52a8\u6001\u786e\u5b9a\u8d85\u65f6\u5185\u5bb9.</p>"},{"location":"chap5/11Istio_http3/#2","title":"2\u3001 \u6545\u969c\u91cd\u8bd5\u63a7\u5236","text":"<p>\u5728\u670d\u52a1\u95f4\u8c03\u7528\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6709\u65f6\u4f1a\u53d1\u751f\u95ea\u65ad\u7684\u968b\u51b5\u76ee\u6807\u670d\u52a1\u5728\u77ed\u65f6\u95f4\u5185\u4e0d\u53ef\u7528\uff0c\u6b64\u65f6\u5982\u679c\u8fdb\u884c\u91cd\u8bd5\uff0c\u5219\u53ef\u80fd\u4f1a\u7ee7\u7eed\u987a\u5229\u5730\u5b8c\u6210\u8c03\u7528\u3002\u8fd9\u4e00\u529f\u80fd\u548c\u5728\u8d85\u65f6\u63a7\u5236\u4e00\u6837\uff0c\u90fd\u662f\u7528\u4e8e\u5e94\u5bf9\u6545\u969c\u7684\u5e38\u7528\u624b\u6bb5\u3002\u5728\u65e0\u987b\u5f00\u53d1\u4ecb\u5165\u7684\u60c5\u51b5\u4e0b\uff0c\u76f4\u63a5\u5728\u8fd0\u884c\u73af\u5883\u4e2d\u5bf9\u6545\u969c\u91cd\u8bd5\u884c\u4e3a\u8fdb\u884c\u8c03\u6574, \u80fd\u591f\u6781\u5927\u5730\u589e\u5f3a\u7cfb\u7edf\u5f39\u6027\u548c\u5065\u6027\u3002 </p> <p>\u4e0b\u9762\u7ee7\u7eed\u5229\u7528<code>httpbin</code>\u670d\u52a1\uff0c\u8fd4\u56de\u4e00\u4e2a<code>500</code>\u9519\u8bef\uff0c\u770b\u770b\u91cd\u8bd5\u8fc7\u7a0b\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u3002 </p> <p>\u6539\u5199<code>httpbin virtualservice.yaml</code>\uff0c\u5728\u5176\u4e2d\u52a0\u4eba\u91cd\u8bd5\u5b9a\u4e49 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: httpbin \nspec: \n  hosts:\n  - httpbin.default.svc.cluster.local\n  http: \n    - route:\n      - destination: \n          host: httpbin.default.svc.cluster.local\n      retries:\n        attempts: 3\n</code></pre> <p>\u8fd9\u91cc\u5b9a\u4e49\uff1a</p> <p>\u5728\u5bf9<code>httpbin</code>\u670d\u52a1\u7684\u8bbf\u95ee\u8fd4\u56de\u6545\u969c\u4e4b\u540e\uff0c\u53ef\u4ee5\u8fdb\u884c\u4e09\u6b21\u91cd\u8bd5\u3002</p> <p>\u5c06\u65b0\u5b9a\u4e49\u7684<code>Virtual Service</code>\u89c4\u5219\u4f7f\u7528<code>kubectl apply</code>\u547d\u4ee4\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\uff0c\u4e4b\u540e\u4f7f\u7528<code>sleep Pod</code>\u8fdb\u884c\u6d4b\u8bd5\uff1a </p> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-448v6  -c sleep bash \n\nbash-4.4# http http://httpbin:8000/status/500\nHTTP/1.1 500 Internal Server Error\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\ncontent-length: 0\ncontent-type: text/html; charset=utf-8\ndate: Sun, 27 Oct 2019 10:39:54 GMT\nserver: envoy\nx-envoy-upstream-service-time: 6\n</code></pre> <p> </p> <p>\u7ed3\u679c\u6beb\u65e0\u60ac\u5ff5\u5730\u8fd4\u56de\u4e86\u5185\u90e8\u9519\u8bef\u3002\u5982\u4f55\u624d\u80fd\u77e5\u9053\u662f\u5426\u771f\u7684\u8fdb\u884c\u4e86\u91cd\u8bd5\uff1f\u53ef\u4ee5\u67e5\u770b<code>httpbin pod</code>\u4e2d<code>istio-proxy</code>\u5bb9\u5668\u8bbf\u95ee\u65e5\u5fd7</p> <pre><code>$ kubectl logs -f httpbin-7d9d5b55b9-kzt5k -c istio-proxy\n</code></pre> <pre><code>[2019-10-27T10:39:54.372Z] \"GET /status/500 HTTP/1.1\" 500 - \"-\" 0 0 5 3 \"-\" \"HTTPie/0.9.9\" \"0d1cc197-8376-9756-a3c9-7d7c5706ca6f\" \"httpbin:8000\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local - 10.1.0.120:80 10.1.0.122:41152 -\n[2019-10-27T10:39:54.372Z] \"GET /status/500 HTTP/1.1\" 500 - \"-\" 0 0 5 3 \"-\" \"HTTPie/0.9.9\" \"0d1cc197-8376-9756-a3c9-7d7c5706ca6f\" \"httpbin:8000\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local - 10.1.0.120:80 10.1.0.122:41152 -\n...\n</code></pre> <p>\u4f1a\u53d1\u73b0\uff0c\u6bcf\u6b21\u8bbf\u95ee\u90fd\u4ea7\u751f\u4e864\u6761\u8bbf\u95ee\u65e5\u5fd7\uff0c\u4e5f\u5c31\u662f\u8bf4\u53d1\u751f\u4e863\u6b21\u91cd\u8bd5 </p> <p>\u8d85\u65f6\u63a7\u5236\u5185\u5bb9\u95ee\u9898\u53d8\u5f97\u590d\u6742\u4e86\u8d77\u6765\uff1a</p> <p>\u91cd\u8bd5\u6709\u8d85\u65f6\u8bbe\u7f6e\uff0c \u670d\u52a1\u8c03\u7528\u672c\u8eab\u4e5f\u6709\u8d85\u65f6\u8bbe\u7f6e\uff0c \u4e24\u8005\u662f\u5982\u4f55\u534f\u8c03\u7684\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u63a5\u7740\u8fdb\u884c\u6d4b\u8bd5 \u5c06\u4e0a\u9762\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u4fee\u6539\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: httpbin \nspec: \n  hosts:\n  - httpbin.default.svc.cluster.local\n  http: \n    - route:\n      - destination: \n          host: httpbin.default.svc.cluster.local\n      # timeout: 3s\n      retries:\n        attempts: 3\n        perTryTimeout: 1s\n      timeout: 7s\n</code></pre> <pre><code>retries:\n    attempts: 3\n    perTryTimeout: 1s\ntimeout: 7s\n</code></pre> <p>\u8fd9\u91cc\u8bbe\u7f6e\u6bcf\u6b21\u91cd\u8bd5\u7684\u8d85\u65f6\u5bb9\u5fcd\u65f6\u95f4\u4e3a1\u79d2\uff0c\uff5b\u4fea\u6025\u4f53\u7684\u8d85\u65f6\u5bb9\u5fcd\u65f6\u95f4\u4e3a7\u79d2\uff0c\u5728\u5e94\u7528\u8fd9\u4e00\u89c4\u5219\u540e\u8fdb\u5165<code>sleep Pod</code>\uff0c\u4f7f\u7528<code>http://httpbin:8000/delay/10</code>\u8fdb\u884c\u6d4b\u8bd5 </p> <pre><code># time http http://httpbin:8000/delay/10\nHTTP/1.1 504 Gateway Timeout\ncontent-length: 24\ncontent-type: text/plain\ndate: Sun, 27 Oct 2019 11:09:09 GMT\nserver: envoy\n\nupstream request timeout\n\n\nreal    0m4.309s\nuser    0m0.265s\nsys     0m0.037s\nbash-4.4# \n\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd4\u56de\u65f6\u95f4\u662f4\u79d2\u591a\uff0c\u53ef\u4ee5\u5224\u65ad\u662f\u91cd\u8bd5\u7684\u8d85\u65f6\u8bbe\u7f6e\u4ea7\u751f\u4e86\u4f5c\u7528.</p> <p>\u518d\u6b21\u4fee\u6539\u8def\u7531\u89c4\u5219\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: httpbin \nspec: \n  hosts:\n  - httpbin.default.svc.cluster.local\n  http: \n    - route:\n      - destination: \n          host: httpbin.default.svc.cluster.local\n      # timeout: 3s\n      retries:\n        attempts: 3\n        perTryTimeout: 1s\n      timeout: 3s\n</code></pre> <pre><code>bash-4.4# time http http://httpbin:8000/delay/10\nHTTP/1.1 504 Gateway Timeout\ncontent-length: 24\ncontent-type: text/plain\ndate: Sun, 27 Oct 2019 11:12:36 GMT\nserver: envoy\n\nupstream request timeout\n\n\nreal    0m3.337s\nuser    0m0.297s\nsys     0m0.025s\n</code></pre> <p>\u8fd9\u6b21\u751f\u6548\u7684\u5c31\u662f\u603b\u4f53\u7684\u8d85\u65f6\u65f6\u95f4\u4e86\u3002</p> <p>\u53ef\u4ee5\u5f97\u7ed3\u8bba\uff1a\u5bf9\u4e8e\u91cd\u8bd5\u7684\u8d85\u65f6\u8bbe\u7f6e\u548c\u603b\u4f53\u7684\u8d85\u65f6\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u5c06\u91cd\u8bd5\u7684\u8d85\u65f6\u548c\u91cd\u8bd5\u6b21\u6570\u7684\u4e58\u79ef\u4e0e\u603b\u4f53\u7684\u8d85\u65f6\u8fdb\u884c\u6bd4\u8f83\uff0c\u54ea\u4e2a\u5c0f\uff0c\u54ea\u4e2a\u8bbe\u7f6e\u5c31\u4f1a\u4f18\u5148\u751f\u6548\u3002</p>"},{"location":"chap5/11Istio_http3/#3","title":"3\u3001\u5165\u53e3\u6d41\u91cf\u7ba1\u7406","text":"<p><code>Kubernetes</code>\u4e3a\u7b2c\u4e09\u65b9\u5382\u5546\u63d0\u4f9b\u4e86<code>Ingress Controller</code>\u89c4\u8303\uff0c\u7528\u4e8e\u5165\u7ad9\u6d41\u91cf\u7ba1\u7406\u3002 </p> <p>**<code>Istio</code>\u7684\u65e9\u671f\u7248\u672c\u4e5f\u636e\u6b64\u5b9e\u73b0\u4e86\u81ea\u5df1\u7684<code>Ingress Controller</code>\uff0c\u53c8\u56e0<code>Ingress Controller</code>\u5728\u540e\u6765\u65e0\u6cd5\u6ee1\u8db3\u4e0d\u65ad\u589e\u52a0\u7684\u9700\u6c42\uff0c\u6240\u4ee5<code>Istio</code>\u53c8\u63a8\u51fa\u4e86<code>Gateway</code>\u7684\u6982\u5ff5\uff0c\u7528\u4e8e\u5728\u7f51\u7edc\u8fb9\u7f18\u8fdb\u884c\u5165\u7ad9\u548c\u51fa\u7ad9\u7684\u6d41\u91cf\u7ba1\u7406\u3002 **</p> <p><code>Ingress Gateway</code>\u5728\u903b\u8f91\u4e0a\u76f8\u5f53\u4e8e\u7f51\u7edc\u8fb9\u7f18\u7684\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u7528\u4e8e\u63a5\u6536\u548c\u5904\u7406\u7f51\u683c\u8fb9\u7f18\u51fa\u7ad9\u548c\u5165\u7ad9\u7684\u7f51\u7edc\u8fde\u63a5\uff0c \u5176\u4e2d\u5305\u542b\u5f00\u653e\u7aef\u53e3\u548c<code>TLS</code>\u7684\u914d\u7f6e\u7b49\u5185\u5bb9\u3002</p> <p>\u5728\u4f7f\u7528<code>Helm</code>\u8fdb\u884c<code>Istio</code>\u90e8\u7f72\u65f6, \u9700\u8981\u901a\u8fc7\u4e0b\u9762\u7684\u8bbe\u7f6e\u6765\u542f\u7528<code>Ingress Gateway</code>: </p> <pre><code>gateways: \n    enabled:true \n    istio-ingressgateway: \n        enabled\uff1atrue \n</code></pre> <p>\u5b9e\u9645\u4e0a\uff0c\u5728\u524d\u9762\u7684\u6d41\u91cf\u7ba1\u7406\u63a2\u8ba8\u4e2d\u4f7f\u7528\u7684<code>VirtualService</code>\u5bf9\u8c61\uff0c\u90fd\u9ed8\u8ba4\u5305\u542b<code>gateways</code>\u5b57\u6bb5\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a\uff0c\u90a3\u4e48\u5176\u9ed8\u8ba4\u503c\u662f\uff1a </p> <pre><code>gatways:\n- mesh\n</code></pre> <p>\u8fd9\u91cc\u7684<code>mesh</code>\u662f<code>Istio</code>\u5185\u90e8\u7684\u865a\u62df<code>Gateway</code>\uff0c\u4ee3\u8868\u7f51\u683c\u5185\u90e8\u7684\u6240\u6709<code>Sidecar</code>\uff0c</p> <p>\u6362\u53e5\u8bdd\u8bf4\uff1a</p> <p>\u6240\u6709\u7f51\u683c\u5185\u90e8\u670d\u52a1\u4e4b\u95f4\u7684\u4e92\u76f8\u901a\u4fe1\uff0c\u90fd\u662f\u901a\u8fc7\u8fd9\u4e2a\u7f51\u5173\u8fdb\u884c\u7684\u3002\u5982\u679c\u8981\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u5c31\u9700\u8981\u5b9a\u4e49<code>Gateway</code>\u5bf9\u8c61\uff0c\u5e76\u5728<code>gateways</code>\u5b57\u6bb5\u4e2d\u8fdb\u884c\u8d4b\u503c\u3002</p> <p>\u4e00\u65e6\u5728<code>gateways</code>\u4e2d\u586b\u5199\u4e86<code>mesh</code>\u4e4b\u5916\u7684\u5bf9\u8c61\u540d\u79f0\uff0c\u5c31\u8981\u7ee7\u7eed\u5bf9\u5185\u90e8\u901a\u4fe1\u8fdb\u884c\u6d41\u91cf\u63a7\u5236\uff0c\u5e76\u5fc5 \u987b\u663e\u5f0f\u5730\u5c06\u5185\u7f6e\u7684<code>mesh</code>\u5bf9\u8c61\u540d\u79f0\u4e5f\u52a0\u5165\u5217\u8868\u4e2d\u3002 </p>"},{"location":"chap5/11Istio_http3/#3-1-gateway","title":"3-1 \u4f7f\u7528Gateway\u5f00\u653e\u670d\u52a1","text":"<p>\u6211\u4eec\u9996\u5148\u5c1d\u8bd5\u4f7f\u7528<code>Gateway</code>\u5f00\u653e\u670d\u52a1\u3002\u4e0e<code>Kubernetes Ingress</code>\u7c7b\u4f3c\uff0c\u6211\u4eec\u9996\u5148\u8981\u5b9a\u4e49\u4e00\u4e2a<code>Gateway</code>: </p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: Gateway \nmetadata: \n  name: example-gateway \nspec: \n  selector: \n    istio: ingressgateway \n  servers: \n    - port: \n        number: 80 \n        name: http \n        protocol: HTTP \n      hosts: \n      - \"*.microservice.rocks\" \n      - \"*.microservice.xyz\"  \n</code></pre> <p>\u628a\u6587\u4ef6\u5185\u5bb9\u4fdd\u5b58\u4e3a<code>example.gateway.yaml</code>.</p> <p>\u5728\u8fd9\u4e2a\u5b9a\u4e49\u4e2d\u6709\u4ee5\u4e0b\u513f\u70b9\u9700\u8981\u6ce8\u610f\uff1a</p> <ul> <li><code>selector</code>\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u6807\u7b7e\u9009\u62e9\u5668\uff0c\u7528\u4e8e\u6307\u5b9a\u7531\u54ea\u4e9b<code>Gateway Pod</code>\u6765\u8d1f\u8d23\u8fd9\u4e2a<code>Gateway</code>\u5bf9\u8c61\u7684\u8fd0\u884c\u3002</li> <li>\u5728<code>hosts</code>\u5b57\u6bb5\u4e2d\u7528\u4e86\u4e00\u4e2a\u901a\u914d\u7279\u57df\u540d\u6765\u6307\u660e\u8fd9\u4e2a<code>Gateway</code>\u53ef\u80fd\u8981\u8d1f\u8d23\u7684\u4e3b\u673a\u540d\u3002</li> <li>\u53ef\u4ee5\u4f7f\u7528<code>kubectl get svc -n istio-system istio-ingressgateway</code>\u6765\u67e5\u770b\u8be5\u670d\u52a1  \u7684<code>IP</code>, \u5e76\u5c06\u6d4b\u8bd5\u57df\u540d\u6620\u5c04\u8fd9\u4e2a<code>IP</code></li> </ul> <p>\u5c06\u914d\u7f6e\u63d0\u4ea4\u7ed9<code>Kubernetes</code>\u96c6\u7fa4</p> <pre><code>$ kubectl apply -f example.gateway.yaml \ngateway.networking.istio.io/example-gateway created\n\n$ kubectl get gw\nNAME              AGE\nexample-gateway   16s\n</code></pre> <pre><code>$ sudo vi /etc/hosts\n127.0.0.1 flaskapp.microservice.xyz flaskapp.microservice.xyz\n127.0.0.1 flaskapp.microservice.rocks flaskapp.microservice.rocks\n</code></pre> <pre><code>$ kubectl get svc -n istio-system istio-ingressgateway\nNAME                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)           AGE                                                                       \nistio-ingressgateway   LoadBalancer   10.104.0.103   localhost     15020:30047/TCP,80:31380/TC\nP,443:31390/TCP,31400:31400/TCP,15029:32144/TCP,15030:30106/TCP,15031:30007/TCP,15032:31464/TC\nP,15443:31744/TCP   9d\n</code></pre> <pre><code>$ pip3 install --upgrade httpie\n\n\n$ http flask.microservice.rocks\nHTTP/1.1 404 Not Found\nAge: 0\nConnection: keep-alive\nContent-Encoding: gzip\nContent-Type: text/html\nDate: Mon, 28 Oct 2019 07:21:18 GMT\nServer: nginx/1.14.0 (Ubuntu)\nTransfer-Encoding: chunked\nVia: 1.1 akamai (ACE 5.10.3/5.10.3)\n</code></pre> <p>\u56de\u8fc7\u5934\u770b<code>Gateway</code>\u7684\u6982\u5ff5\uff0c\u4e0d\u96be\u53d1\u73b0\uff0c\u5176\u4e2d\u5e76\u6ca1\u6709\u6307\u5b9a\u8d1f\u8d23\u54cd\u5e94\u8bf7\u6c42\u7684\u670d\u52a1\uff0c\u6211\u4eec\u9700\u8981\u5bf9<code>flaskapp</code>\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u4fee\u6539\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp\nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  - flaskapp.microservice.rocks\n  gateways:\n  - mesh\n  - example-gateway\n  http:\n    - route: \n      - destination: \n          host: flaskapp.default.svc.cluster.local\n          subset: v2\n</code></pre> <pre><code>$ kubectl apply -f gatway-flaskapp-virtualservice.yaml \nvirtualservice.networking.istio.io/flaskapp configured\n</code></pre> <pre><code>bash-4.4# http flaskapp.microservice.rocks/env/version\nHTTP/1.1 200 OK\ncontent-length: 2\ncontent-type: text/html; charset=utf-8\ndate: Mon, 28 Oct 2019 07:18:49 GMT\nserver: envoy\nx-envoy-upstream-service-time: 0\n\nv2\n</code></pre>"},{"location":"chap5/11Istio_http3/#3-2-gatwaway","title":"3-2 \u4e3a<code>gatwaway</code>\u6dfb\u52a0\u8bc1\u4e66\u652f\u6301","text":"<p>\u5165\u53e3\u7f51\u5173\u901a\u5e38\u627f\u62c5\u7740\u6d41\u91cf\u52a0\u5bc6\u7684\u4efb\u52a1\uff0c<code>Ingress Gateway</code>\u4e5f\u5177\u5907\u8fd9\u6837\u7684\u80fd\u529b</p> <p>\u5728<code>Ingress Gateway</code>\u4e2d\u7528\u53ef\u9009\u65b9\u5f0f\u52a0\u8f7d\u4e86\u4e00\u4e2a\u540d\u79f0\u4e3a<code>istio-ingressgateway-certs</code>\u7684<code>Secret</code>, </p> <p>\u5e76\u5c06\u5176\u52a0\u8f7d\u5230\u4e86<code>/etc/istio/ingressgateway-ca-cert</code> \u76ee\u5f55\u4e2d\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u8981\u4f7f\u7528\u8bc1\u4e66\u548c\u5bc6\u94a5\u521b\u5efa\u8fd9\u4e2a<code>Secret</code>\uff0c\u5c31\u53ef\u4ee5\u5c06\u5176\u63d0\u4f9b\u7ed9<code>Gateway</code>\u4f7f\u7528\u4e86\u3002</p> <p>\u5728<code>Gateway</code>\u4e2d\u53ef\u4ee5\u4f7f\u7528<code>tls</code>\u5b57\u6bb5\u6765\u5b9a\u4e49\u5bf9\u8bc1\u4e66\u7684\u4f7f\u7528\u3002 </p> <p>\u9996\u5148\u4f7f\u7528\u8bc1\u4e66\u6587\u4ef6\u521b\u5efa<code>Secret</code>: </p> <pre><code>kubectl create -n istio-secret tls istio-ingressgateway-certs --key rocks/key.pem --cert rocks/cert.pem\n</code></pre> <p>\u7136\u540e\u4fee\u6539<code>Gateway</code>\u7684\u5b9a\u4e49</p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: Gateway \nmetadata: \n  name: example-gateway \nspec: \n  selector: \n    istio: ingressgateway \n  servers: \n    - port: \n        number: 80 \n        name: http \n        protocol: HTTP \n      hosts: \n      - \"*.microservice.rocks\" \n      - \"*.microservice.xyz\" \n    - port: \n        number: 443 \n        name: https \n        protocol: HTTPS \n      tls: \n        mode: SIMPLE \n        serverCertificate: /etc/istio/ingressgateway-certs/tls.crt \n        privateKey: /etc/istio/ingressgateway-certs/tls.key \n      hosts: \n      - \"flaskapp.microservice.rocks\" \n      - \"flaskapp.microservice.xyz\" \n</code></pre> <pre><code>http https://flaskapp.microservice.rocks/env/version\nHTTP/1.1 200 OK\n...\nserver: envoy\nx-envoy-upstream-service-time: 1\n\nv2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5bf9\u57df\u540d<code>flaskapp.microservice.rocks</code>\u7684<code>HTTPS</code>\u8bbf\u95ee\u5df2\u7ecf\u751f\u6548\uff1a </p>"},{"location":"chap5/11Istio_http3/#3-3-gatwaway","title":"3-3 \u4e3a<code>gatwaway</code>\u6dfb\u52a0\u591a\u4e2a\u8bc1\u4e66\u652f\u6301","text":"<p>\u53c2\u7167\u5b98\u65b9\u6587\u6863\u53ef\u4ee5\u53d1\u73b0\uff0c<code>tls secret</code>\u53ea\u80fd\u5305\u542b\u4e00\u4e2a\u8bc1\u4e66\u5bf9\uff0c\u56e0\u6b64\u4e00\u4e2a<code>Gateway</code>\u662f\u65e0\u6cd5\u5904\u7406\u4e24\u4e2a\u57df\u540d\u7684<code>HTTPS</code>\u7684\uff0c\u53ef\u4ee5\u6362\u7528<code>Generic</code>\u7c7b\u578b\u7684\u8bc1\u4e66, \u8fd9\u91cc\u9700\u8981\u5220\u9664\u539f\u6709\u7684<code>Secret</code>\u5e76\u91cd\u65b0\u521b\u5efa\uff1a </p> <pre><code>$ kubectl delete secret istio-ingressgateway-certs -n istio-system \nsecret \"istio-ingressgateway-certs\" deleted \n\n$ kubectl create secret generic istio-ingressgateway-certs -n istio-system -from-file=rocks-cert.pem --from-file=rocks-key.pem --from-file=xyz-cert.pem --from-file=xyz-keys.pem \nsecret/istio-ingressgateway-certs created \n</code></pre> <p>\u5728\u65b0\u7684<code>Secret</code>\u521b\u5efa\u597d\u4e4b\u540e\uff0c\u8fd8\u9700\u8981\u4fee\u6539<code>Gateway</code>\u7684\u914d\u7f6e</p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: Gateway \nmetadata: \n  name: example-gateway \nspec: \n  selector: \n    istio: ingressgateway \n  servers: \n    - port: \n        number: 80 \n        name: http-all\n        protocol: HTTP \n      hosts: \n      - \"*.microservice.rocks\" \n      - \"*.microservice.xyz\" \n    - port: \n        number: 443 \n        name: https-rocks \n        protocol: HTTPS \n      tls: \n        mode: SIMPLE \n        serverCertificate: /etc/istio/ingressgateway-certs/rocks-cert.pem \n        privateKey: /etc/istio/ingressgateway-certs/rocks-cert.pem\n      hosts: \n      - \"flaskapp.microservice.rocks\" \n    - port: \n        number: 443 \n        name: https-xyz\n        protocol: HTTPS \n      tls: \n        mode: SIMPLE \n        serverCertificate: /etc/istio/ingressgateway-certs/xyz-cert.pem \n        privateKey: /etc/istio/ingressgateway-certs/xyz-cert.pem\n      hosts: \n      - \"flaskapp.microservice.xyz\" \n</code></pre> <p>\u5728\u63d0\u4ea4\u5230\u96c6\u7fa4\u4e4b\u540e\uff0c\u518d\u6b21\u8fdb\u884c\u6d4b\u8bd5\uff1a </p> <pre><code>$ http --body https://flaskapp.microservice.xyz/env/version \nv2 \n\n$ http --body https://flaskapp.microservice.rocks/env/version \nv2 \n</code></pre>"},{"location":"chap5/11Istio_http3/#3-4","title":"3-4 \u914d\u7f6e\u5165\u53e3\u6d41\u91cf\u7684\u8def\u7531","text":"<p><code>VirtualService</code>\u4e2d\u7684\u8def\u7531\u5339\u914d\u529f\u80fd\u5bf9 <code>ingress</code>\u6d41\u91cf\u4e5f\u662f\u6709\u6548\u7684\uff0c \u4f8b\u5982\uff0c\u6211\u4eec\u5e0c\u671b\u6d41\u91cf\u6765\u81ea\u5916\u90e8\u6d41\u91cf\u7531<code>flaskapp</code>\u670d\u52a1<code>v1</code>,\u5219\u53ef\u4ee5\u8fd9\u6837\u4fee\u6539\u539f\u6709\u7684<code>VirtualService</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp\nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  - flaskapp.microservice.rocks\n  - flaskapp.microservice.xyz\n  gateways:\n  - mesh\n  - example-gateway\n  http:\n  - match:\n    - gateways:\n      - example-gateway\n    route:\n      - destination: \n          host: flaskapp.default.svc.cluster.local\n          subset: v1\n  - route:\n     - destination: \n          host: flaskapp.default.svc.cluster.local\n          subset: v2\n</code></pre> <pre><code>$ http --body http://flaskapp.microservice.xyz/env/version\nv1\n\n$ http --body http://flaskapp.microservice.rocks/env/version\nv1\n</code></pre> <p>delete <code>127.0.0.1 flaskapp.microservice.rocks flaskapp.microservice.rocks</code> from /etc/hosts</p> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\nhttp --body http://flaskapp.microservice.xyz/env/version\nv2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6309\u7167\u6211\u4eec\u7684\u8bbe\u8ba1\uff0c\u6240\u6709\u4ece<code>example-gateway</code>\u8fdb\u4eba\u7684\u6d41\u91cf\uff0c\u90fd\u7531<code>flaskapp</code>\u670d\u52a1\u7684<code>v</code>\u7248\u672c\u8fdb\u884c\u5904\u7406 </p> <p>\u6765\u81ea\u5185\u90e8\u7684\u6d41\u91cf\u5219\u7531<code>flaskapp</code>\u670d\u52a1\u7684<code>v2</code>\u7248\u672c\u8fdb\u884c\u5904\u7406\u3002 </p>"},{"location":"chap5/11Istio_http3/#4","title":"4\u3001 \u51fa\u53e3\u6d41\u91cf\u7ba1\u7406","text":"<p><code>Istio</code>\u5728\u5bf9\u5e94\u7528\u8fdb\u884c\u6ce8\u5165\u7684\u65f6\u5019\uff0c\u4f1a\u52ab\u6301\u8be5\u5e94\u7528\u7684\u6240\u6709\u6d41\u91cf\uff0c\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7f51\u683c\u4e4b\u5185\u7684\u5e94\u7528\u662f\u65e0\u6cd5\u8bbf\u95ee\u7f51\u683c\u4e4b\u5916\u7684\u670d\u52a1\u7684, \u4f8b\u5982\u5c1d\u8bd5\u5728<code>Sleep Pod</code>\u4e2d\u8bbf\u95ee <code>http://api.jd.com</code></p> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\n\nbash-4.4# http http://api.jd.com\nHTTP/1.1 200 OK\nage: 0\ncache-control: max-age=0\ncontent-encoding: gzip\ncontent-type: text/html\ndate: Tue, 29 Oct 2019 09:03:50 GMT\netag: W/\"131-1571644820000\"\nexpires: Tue, 29 Oct 2019 09:03:51 GMT\nlast-modified: Mon, 21 Oct 2019 08:00:20 GMT\nserver: envoy\ntransfer-encoding: chunked\nvary: Accept-Encoding\nx-envoy-upstream-service-time: 279\n\n&lt;html&gt;\n&lt;script type=\"text/javascript\"&gt;\n    window.location=\"http://jos.jd.com\";\n&lt;/script&gt;\n&lt;body&gt;\n&lt;h2&gt;&lt;/h2&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u4f46\u662f\u4ece\u7f51\u683c\u5185\u90e8\u53d1\u8d77\u5bf9\u5916\u7684\u7f51\u7edc\u8bf7\u6c42\u662f\u5e38\u89c1\u7684\u9700\u6c42\uff0c<code>Istio</code>\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\u7528\u4e8e\u7f51\u683c\u5916\u90e8\u901a\u4fe1\u3002</p> <ul> <li>\u8bbe\u7f6e<code>Sidcar</code>\u7684\u6d41\u91cf\u52ab\u6301\u8303\u56f4\u6839\u636e<code>IP</code>\u5730\u5740\u6765\u544a\u77e5<code>Sidecar</code>\u54ea\u4e9b\u5916\u90e8\u8d44\u6e90\u53ef\u4ee5\u653e\u5f00\u8bbf\u95ee\u3002</li> <li>\u6ce8\u518c<code>ServiceEntry</code>\uff1a\u628a\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u4f7f\u7528<code>ScrviceEntry</code>\u7684\u65b9\u5f0f\u6ce8\u518c\u5230\u7f51\u683c\u5185\u90e8.</li> </ul> <p>\u4e0b\u9762\u5c06\u5206\u522b\u8fdb\u884c\u5b9e\u8df5\u3002 </p>"},{"location":"chap5/11Istio_http3/#4-1-sidecar","title":"4-1 \u8bbe\u7f6e<code>Sidecar</code>\u7684\u6d41\u91cf\u52ab\u6301\u8303\u56f4","text":"<p>\u7f51\u683c\u5185\u90e8\u7684\u5e94\u7528\u6d41\u5740\u52ab\u6301\u662f\u7531<code>istio-init</code>\u5bb9\u5668\u5b8c\u6210\u7684\u6709\u4ee5\u4e0b\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u5f71\u54cd\u5b83\u7684\u52ab\u6301\u8303\u56f4</p> <ul> <li>\u7b2c1\u79cd\u8bbe\u7f6e<code>values.yaml</code>\u4e2d\u7684<code>proxy.includeIPRange</code>\u53d8\u91cf\u3002</li> <li>\u7b2c2\u79cd\u4f7f\u7528<code>Pod</code>\u6ce8\u89e3<code>traffic.sidecar.istio.io/includeOutboundIPRanges</code>\u8868\u660e\u52ab\u6301\u8303\u56f4 </li> </ul> <p>\u7b2c<code>1</code>\u79cd\u65b9\u5f0f\u548c\u4e4b\u524d\u4fee\u6539<code>HELM</code>\u8f93\u4eba\u53d8\u91cf\u7684\u6240\u6709\u65b9\u5f0f\u57fa\u672c\u76f8\u540c\u4f46\u662f\uff0c \u9700\u8981\u91cd\u65b0\u521b\u5efa\u6240\u6709\u88ab\u6ce8\u4eba\u7684<code>Pod</code>\u3002</p> <p>\u4e0b\u9762\u6d4b\u8bd5\u4e00\u4e0b\u6ce8\u89e3\u65b9\u5f0f</p> <p>\u4f7f\u7528<code>kubectl</code>\u7f16\u8f91<code>sleep-v1</code>\u5bf9\u8c61, \u5728<code>template</code>\u4e2d\u52a0\u4eba\u65b0\u7684\u6ce8\u89e3\uff1a</p> <pre><code>metadata:\n  name: sleep-v1\n  annotations: \n    traffic.sidecar.istio.io/includeOutboundIPRanges: 10.96.0.0/12\n</code></pre> <p>\u8fd9\u91cc\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u767d\u540d\u5355\u8981\u6c42\u521d\u59cb\u5316\u5bb9\u5668\u53ea\u5bf9\u81ea\u540d\u5355\u8303\u56f4\u5185\u7684\u62a4\u8fdb\u884c\u52ab\u6301\u8fd9 </p> <p>\u91cc\u8f93\u4eba\u7684<code>CIDR</code>\u8303\u56f4\u5c31\u662f\u7b14\u8005\u7684\u6d4b\u8bd5\u96c6\u7fa4\u7684\u670d\u52a1\u5730\u5740\u8303\u56f4, </p> <p>\u901a\u8fc7<code>kubectl</code>\u547d\u4ee4\u53ef\u4ee5\u770b\u5230<code>sleep-v1</code>\u7684<code>Pod</code>\u4f1a\u88ab\u91cd\u5efa </p> <p>\u5728<code>Pod</code>\u542f\u52a8\u5b8c\u6210\u4e4b\u540e\u6211\u4eec\u518d\u6b21\u8fdb\u884c\u6d4b\u8bd5 </p> <p>Get Services IPs range</p> <pre><code> kubectl cluster-info dump | grep -m 1 service-cluster-ip-range\n                            \"--service-cluster-ip-range=10.96.0.0/12\",\n</code></pre> <pre><code>$ kubectl apply -f sleep.istio.yaml \nservice/sleep configured\ndeployment.extensions/sleep-v1 configured\ndeployment.extensions/sleep-v2 unchanged\n</code></pre> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\n$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sle\nep bash\nbash-4.4# http http://api.jd.com\nHTTP/1.1 200 OK\ncache-control: max-age=0\ncontent-encoding: gzip\ncontent-type: text/html\ndate: Tue, 29 Oct 2019 09:42:01 GMT\netag: W/\"131-1571644820000\"\nexpires: Tue, 29 Oct 2019 09:42:01 GMT\nlast-modified: Mon, 21 Oct 2019 08:00:20 GMT\nserver: envoy\ntransfer-encoding: chunked\nvary: Accept-Encoding\nx-envoy-upstream-service-time: 1792\n\n&lt;html&gt;\n&lt;script type=\"text/javascript\"&gt;\n    window.location=\"http://jos.jd.com\";\n&lt;/script&gt;\n&lt;body&gt;\n&lt;h2&gt;&lt;/h2&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u4fee\u6539\u5df2\u7ecf\u751f\u6548.</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u975e\u5e38\u76f4\u63a5\u4f46\u5b9e\u9645\u571f\u5728\u7f51\u683c\u5185\u90e8\u662f\u4e00\u4e2a\u4f8b\u5916\uff1a</p> <p>\u8bbf\u95ee\u5916\u90e8\u5730\u5740\u7684\u8bf7\u6c42\u4f1a\u7531\u4e1a\u52a1<code>Pod</code>\u53d1\u51fa\u7ed5\u8fc7<code>Sidecar</code>\u5b8c\u5168\u4e0d\u53d7<code>Istio</code>\u7684\u76d1\u63a7\u548c\u7ba1\u7406</p> <p>\u4e3a\u4e86\u8fdb\u884c\u6d4b\u8bd5\u627e\u4eec\u518d\u6b21\u7f16\u8f91<code>sleep-v1</code>\u53bb\u6389\u6ce8\u89e3\u7684\u5185\u5bb9 </p>"},{"location":"chap5/11Istio_http3/#4-2-serviceentry","title":"4-2 \u8bbe\u7f6e<code>ServiceEntry</code>","text":"<p>\u53ef\u4ee5\u4e3a\u5916\u90e8\u670d\u52a1\u8bbe\u7f6e<code>ServiceEntry</code>\u76f8\u5f53\u4e8e\u5c06\u5916\u90e8\u670d\u52a1\u5728\u7f51\u683c\u5185\u90e8\u8fdb\u884c\u4e86\u6ce8\u518c.</p> <p>**\u76f8\u5bf9\u4e8e\u4f7f\u7528<code>CIDR</code>\u767d\u540d\u5355\u7684\u65b9\u5f0f\u8fd9\u79cd\u65b9\u5f0f\uff0c \u8ba9<code>Istio</code>\u5bf9\u5916\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u6709\u4e86\u66f4\u5927\u7684\u7ba1\u7406\u80fd\u529b **</p> <p>\u6211\u4eec\u9996\u5148\u4e3a<code>httpbin.org</code>\u8bbe\u7f6e\u4e00\u4e2a<code>ServicerEntry</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: ServiceEntry \nmetadata: \n  name: httpbin-ext \nspec: \n  hosts: \n  - httpbin.org \n  ports: \n  - number: 80 \n    name: http \n    protocol: HTTP \n  resolution: DNS \n</code></pre> <p>\u4e0a\u8ff0\u5185\u5bb9\u88ab\u4fdd\u5b58\u4e3a<code>httpbin.entry.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectL apply</code>\u63d0\u4ea4\u5230\u96c6\u7fa4\uff0c\u7136\u540e\u5c1d\u8bd5\u8bbf\u95ee\uff1a </p> <pre><code>$ kubectl apply -f httpbin.entry.yaml \nserviceentry.networking.istio.io/httpbin-ext created\n$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\n</code></pre> <pre><code>http http://httpbin.org/get\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\nage: 0\ncontent-encoding: gzip\ncontent-length: 503\ncontent-type: application/json\ndate: Wed, 30 Oct 2019 01:59:25 GMT\nreferrer-policy: no-referrer-when-downgrade\nserver: envoy\nx-content-type-options: nosniff\nx-envoy-upstream-service-time: 615\nx-frame-options: DENY\nx-xss-protection: 1; mode=block\n\n{\n    \"args\": {},\n    \"headers\": {\n        \"Accept\": \"*/*\",\n        \"Accept-Encoding\": \"gzip, deflate\",\n        \"Cache-Control\": \"max-stale=0\",\n        \"Host\": \"httpbin.org\",\n        \"User-Agent\": \"HTTPie/0.9.9\",\n        \"X-B3-Sampled\": \"1\",\n        \"X-B3-Spanid\": \"fbf90cdccaae19eb\",\n        \"X-B3-Traceid\": \"6af3dc0f3e12e8f5fbf90cdccaae19eb\",\n        \"X-Bluecoat-Via\": \"0aa8a714ac138a74\",\n        \"X-Envoy-Decorator-Operation\": \"httpbin.org:80/*\",\n        \"X-Istio-Attributes\": \"CikKGGRlc3RpbmF0aW9uLnNlcnZpY2UuaG9zdBINEgtodHRwYmluLm9yZwoqCh1\nkZXN0aW5hdGlvbi5zZXJ2aWNlLm5hbWVzcGFjZRIJEgdkZWZhdWx0CikKGGRlc3RpbmF0aW9uLnNlcnZpY2UubmFtZRINE\ngtodHRwYmluLm9yZwo+Cgpzb3VyY2UudWlkEjASLmt1YmVybmV0ZXM6Ly9zbGVlcC12MS01NDhkODdjYzVjLXdmazd2LmR\nlZmF1bHQ=\"\n    },\n    \"origin\": \"169.145.197.12, 169.145.197.12\",\n    \"url\": \"https://httpbin.org/get\"\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6ce8\u518c\u540e\u7684\u5185\u5bb9\u8bbf\u95ee\u6210\u529f\u4e86 </p> <p>\u4f7f\u7528<code>ServiceEntry</code>\u7684\u4e00\u4e2a\u597d\u5904\u5c31\u662f\uff0c\u53ef\u4ee5\u5229\u7528\u6d41\u91cf\u7ba1\u7406\u7279\u80dc\uff0c\u5bf9\u5916\u90e8\u8bbf\u95ee\u8fdb\u884c\u76d1\u63a7\u548c\u7ba1\u7406\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u5bf9\u521a\u624d\u7684<code>ServiceEntry</code>\u8bbe\u7f6e\u4e86\u4e00\u4e2a<code>3</code>\u79d2\u7684\u8d85\u65f6\u9650\u5236\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: VirtualService \nmetadata: \n  name: httpbin-service \nspec: \n  hosts: \n  - httpbin.org \n  http: \n  - timeout: 3s\n    route:\n    - destination:\n    host: httbin.org\n</code></pre> <p>\u5c06\u6587\u672c\u4fdd\u5b58\u4e3a<code>serviceentry.virtualservice.yaml</code>,\u5e76\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\u8fd0\u884c </p> <pre><code>$ kubectl apply -f serviceentry.virtualservice.yaml\nvirtualservice.networking.istio.io/httpbin-service created\n</code></pre> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash\nbash-4.4# time http --body http://httpbin.org/delay/10\n\n\n\nreal    0m0.302s\nuser    0m0.262s\nsys     0m0.031s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8d85\u65f6\u7b56\u7565\u5df2\u7ecf\u751f\u6548\uff0c\u5728\u8bf7\u6c42\u65f6\u95f4\u8fbe\u5230\u6211\u4eec\u8bbe\u7f6e\u7684\u8d85\u65f6\u65f6\u95f4\u4e4b\u540e\u4f1a\u76f4\u63a5\u8fd4\u56de\u5931\u8d25\u3002 </p>"},{"location":"chap5/11Istio_http3/#4-3-gateway","title":"**4-3 \u65b0\u5efa<code>Gateway</code>\u63a7\u5236\u5668 **","text":"<p>\u53d7\u5230\u7f51\u7edc\u7b56\u7565\u6216\u8005\u5b89\u5168\u56e0\u7d20\u7684\u5f71\u54cd\uff0c\u6211\u4eec\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\u901a\u5e38\u9700\u8981\u8bbe\u7f6e\u591a\u4e2a\u4e0d\u540c \u7684\u8fb9\u7f18\u7f51\u5173\u6765\u5b8c\u6210\u4e0d\u540c\u7684\u4efb\u52a1\uff0c\u4f8b\u5982\uff0c\u53ea\u6709\u7279\u5b9a\u8282\u70b9\u63d0\u4f9b\u4e86\u51fa\u7ad9\u8fde\u63a5\u80fd\u529b\uff0c\u6216\u8005\u5916 \u90e8\u8d1f\u8f7d\u5747\u8861\u53ea\u80fd\u4e3a\u90e8\u5206\u670d\u52a1\u5668\u5206\u53d1\u8d1f\u8f7d\u7b49\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5bf9\u670d\u52a1\u7f51\u683c\u4e2d\u7684<code>Gateway</code>\u63a7\u5236\u5668\u90e8\u7f72\u8fdb\u884c\u5b9a\u5236\u3002 </p> <p>\u4e0d\u540c\u7528\u9014\u7684<code>Gateway</code>\u63a7\u5236\u5668\u53ef\u4ee5\u5206\u5e03\u5728\u4e0d\u540c\u7684\u8282\u70b9\uff0c\u6216\u8005\u4f7f\u7528\u4e0d\u540c\u6570\u91cf\u7684\u8d44\u6e90\u7b49\u3002</p> <p><code>Istio</code>\u5728<code>Helm chart</code>\u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65b0\u5efa<code>Gateway</code>\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u5728\u5bf9\u8f93\u4eba\u503c\u8fdb\u884c\u5b9a\u5236\u4e4b\u540e\uff0c\u9996\u5148\u4f7f\u7528<code>Helm</code>\u6307\u4ee4\u751f\u6210\u65b0\u7684\u63a7\u5236\u5668\u3002</p> <p>\u4e0b\u9762\u8fdb\u884c\u5b9e\u9645\u64cd\u4f5c\u3002 </p> <p>\u5728<code>values.yaml</code>\u7684<code>gateways</code>\u5b57\u6bb5\u52a0\u4eba\u5982\u4e0b\u5185\u5bb9\uff1a </p> <pre><code>$ cd Istio/istio-1.1.16/install/kubernetes/helm/istio/charts/gateways\n$ values.yaml\n\n... \nenabled: true\n\nistio-myingress: \n  enabled: true \n  labels: \n    app: istio-ingressgateway \n    istio: myingress \n  replicaCount: 3 \n  autoscaleMax: 5 \n  resources: {}\n  cpu: \n    targetAverageUtilization: 80 \n  loadBalancerIP: \"\" \n  serviceAnnotations: {} \n  # type: LoadBalancer \n  type: NodePort \n  ports: \n  - port: 80 \n    targetPort: 80 \n    name: http-myingress \n\n\nistio-ingressgateway:\n  enabled: true\n...\n</code></pre> <p>https://istio.io/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports Change from loadbalancer to NodePort</p> <p>\u8fd9\u91cc\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u65b0\u7684<code>Ingress Gateway</code>\u63a7\u5236\u5668\uff0c\u5b83\u4f1a\u5efa\u7acb\u4e09\u4e2a<code>Pod</code>\uff0c\u5f00\u653e<code>80</code>\u7aef\u53e3\u4f9b\u5916\u754c\u8bbf\u95ee\u3002 </p> <p>\u4f7f\u7528<code>Helm</code>\u6e32\u67d3\u5e76\u8fdb\u884c\u90e8\u7f72\uff1a </p> <pre><code>$ cd Istio/istio-1.1.16/install/kubernetes/helm/\n</code></pre> <pre><code>helm template istio --name istio -f istio/values.yaml --namespace istio-system  |  kubectl apply -f -\n</code></pre> <pre><code>$ kubectl get pod -n istio-system\n...\nistio-myingress-5bbcddc954-8jvp7           1/1     Running     0          9m37s\nistio-myingress-5bbcddc954-f4k82           1/1     Running     0          9m37s\nistio-myingress-5bbcddc954-ftc6r           1/1     Running     0          9m37s\n...\n</code></pre> <p>\u5728\u5b8c\u6210\u4e4b\u540e\u53ef\u4ee5\u5c1d\u8bd5\u4e3a<code>httpbin</code>\u670d\u52a1\u521b\u5efa\u4e00\u4e2a<code>Gateway</code>\u5bf9\u8c61\u6765\u5bf9\u5916\u5f00\u653e\u670d\u52a1\uff1a </p> <p><code>http-bin-gateway.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: Gateway \nmetadata:\n  name: httpbin-gateway \nspec: \n  selector: \n    istio: myingress \n  servers: \n  - port: \n      number: 80 \n      name: http-all \n      protocol: HTTP \n    hosts:\n    - \"*\"  \n</code></pre> <pre><code>$ kubectl apply -f httpbin-gateway.yaml\n\ngateway.networking.istio.io/httpbin-gateway created\n</code></pre> <p>\u5728\u8fd9\u4e2a\u5b9a\u4e49\u4e2d\uff1a </p> <ul> <li>\u4ec5\u5f00\u653e\u4e86<code>80</code>\u7aef\u53e3\uff1b </li> <li>\u6ca1\u6709\u5bf9\u4e3b\u673a\u540d\u505a\u51fa\u8981\u6c42\uff0c\u4f7f\u7528\u4e86\u901a\u914d\u7b26\u201c*\u201d\u4f5c\u4e3a\u4e3b\u673a\u540d\uff1b </li> <li><code>selector</code>\u7528\u4e8e\u9009\u62e9\u6211\u4eec\u65b0\u5efa\u7684<code>Gateway</code>\u63a7\u5236\u5668\u3002 </li> </ul> <p>\u7136\u540e\uff0c\u4fee\u6539<code>httpbin.gatwayservice.yaml</code>\uff0c\u8bbe\u7f6e\u5176\u4e2d\u7684<code>gateways</code>\u5b57\u6bb5\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: VirtualService \nmetadata: \n  name: httpbin \nspec: \n  hosts: \n  - \"*\"\n  gateways: \n  - httpbin-gateway \n  http: \n  - route: \n    - destination: \n    host: httpbin.default.svc.cluster.local \ntimeouts: 5s\n</code></pre> <pre><code>$ kubectl delete vs httpbin\nvirtualservice.networking.istio.io \"httpbin\" deleted\n\n$ kubectl create -f httpbin.gatwayservice.yaml \nvirtualservice.networking.istio.io/httpbin created\n</code></pre> <p>\u8fd9\u91cc\u8ba9<code>VirtualService</code>\u4f7f\u7528\u65b0\u5efa\u7684<code>httbin-gateway</code>\u5bf9\u8c61\u5bf9\u5916\u5f00\u653e\u670d\u52a1\u6211\u4eec\u6d4b\u8bd5\u4e00\u4e0b </p> <pre><code>$ kubectl get svc  -n istio-system\n...\nistio-myingress          NodePort       10.103.69.251    &lt;none&gt;        80:31472/TCP   \n...\n</code></pre> <pre><code>$ http 127.0.0.1/31472\nHTTP/1.1 200 OK\n...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8bbf\u95ee\u6210\u529f\u5f97\u5230\u4e86\u54cd\u5e94\u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u6210\u529f\u4f7f\u7528\u65b0\u5efa\u7684<code>GateWay</code>\u63a7\u5236\u5668\u5b8c\u6210\u4e86\u670d\u52a1\u7684\u5bf9\u5916\u5f00\u653e </p>"},{"location":"chap5/12Istio_http4/","title":"\u7b2c\u5341\u4e8c\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u670d\u52a1\u7194\u65ad/\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5/\u6ce8\u5165\u4e2d\u65ad/\u6d41\u91cf\u590d\u5236)","text":"<ul> <li>1 \u8bbe\u7f6e\u670d\u52a1\u7194\u65ad</li> <li>2 \u6545\u969c\u6ce8\u5165\u6d4b\u8bd5</li> <li>3 \u6ce8\u5165\u4e2d\u65ad</li> <li>4 \u6d41\u91cf\u590d\u5236</li> </ul>"},{"location":"chap5/12Istio_http4/#1","title":"1\u3001\u8bbe\u7f6e\u670d\u52a1\u7194\u65ad","text":"<p>\u670d\u52a1\u7194\u65ad\u662f\u4e00\u79cd\u4fdd\u62a4\u6027\u63aa\u65bd\uff0c\u5373\u5728\u670d\u52a1\u5b9e\u4f8b\u65e0\u6cd5\u6b63\u5e38\u63d0\u4f9b\u670d\u52a1\u7684\u6e05\u51b5\u4e0b\u5c06\u5176\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u79fb\u9664\uff0c\u4e0d\u518d\u4e3a\u5176\u5206\u914d\u4efb\u52a1\uff0c\u907f\u514d\u5728\u6545\u969c\u5b9e\u4f8b\u4e0a\u79ef\u538b\u66f4\u591a\u7684\u4efb\u52a1\u5e76\u4e14\u53ef\u4ee5\u5728\u7b49\u5f85\u670d\u52a1\u80fd\u529b\u6062\u590d\u540e\uff0c\u91cd\u65b0\u5c06\u53d1\u751f\u6545\u969c\u7684<code>Pod</code>\u52a0\u4eba\u8d1f\u8f7d\u5747\u8861\u6c60\u3002</p> <p>\u8fd9\u4e5f\u662f\u4e00\u79cd\u5e38\u89c1\u7684\u670d\u52a1\u964d\u7ea7\u65b9\u6cd5\u3002 \u5728<code>Istio</code>\u4e2d\u540c\u6837\u63d0\u4f9b\u4e86\u975e\u4fb5\u5165\u5f0f\u7684\u670d\u52a1\u7194\u65ad\u529f\u80fd\u3002</p> <p>\u5bf9\u8fd9\u4e00\u529f\u80fd\u53ea\u9700\u8bbe\u7f6e<code>DestinationRule</code>\u5bf9\u8c61\u5373\u53ef\u5b8c\u6210\u3002</p> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u4e3a<code>httpbin</code>\u670d\u52a1\u8bbe\u7f6e\u4e00\u4e2a\u76ee\u6807\u89c4\u5219\uff1a </p> <p><code>httpbin-fuse-dr.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: DestinationRule \nmetadata: \n  name: httpbin \nspec: \n  host: httpbin \n  trafficPolicy:\n    connectionPool:\n      tcp: \n        maxConnections: 1 \n      http: \n        http1MaxPendingRequests: 1 \n        maxllequesisPerConnection: 1 \n    outlierDetection: \n        consecutiveErrors: 1 \n        interval: 1s \n        baseEjectionT1me: 1m \n        maxejectiosPercent: 100 \n</code></pre> <pre><code>$ kubectl apply -f httpbin-fuse-dr.yaml \ndestinationrule.networking.istio.io/httpbin created\n</code></pre> <p>\u63a5\u4e0b\u6765\u4f7f\u7528<code>sleep Pod</code>\u4e2d\u7684<code>wrk</code>\u5de5\u5177\u6d4b\u8bd5\u7194\u65ad\u6548\u679c\uff1a </p> <pre><code>$ kubectl exec sleep-6c9c898f6c-448v6 -it bash -c sleep\nbash-4.4# wrk -c 3 -t 3 http://httpbin:8000/ip\nRunning 10s test @ http://httpbin:8000/ip\n  3 threads and 3 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     4.49ms    5.93ms  65.45ms   88.70%\n    Req/Sec   338.84    298.81     1.20k    77.78%\n  10108 requests in 10.03s, 2.39MB read\n  Non-2xx or 3xx responses: 6140  \u2764\ufe0f\nRequests/sec:   1007.53\nTransfer/sec:    243.48KB\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u975e\u6b63\u5e38\u7ed3\u679c\u5360\u4e86\u7edd\u5927\u591a\u6570\uff0c\u8868\u660e\u7194\u65ad\u5df2\u7ecf\u751f\u6548\u3002 </p> <p>\u63a5\u7740\u5220\u9664\u7194\u65ad\u8bbe\u7f6e\uff0c\u91cd\u65b0\u6d4b\u8bd5\uff1a </p> <pre><code>$ kubectl delete dr httpbin\ndestinationrule.networking.istio.io \"httpbin\" deleted\n</code></pre> <pre><code>$ kubectl exec sleep-6c9c898f6c-448v6 -it bash -c sleep\nbash-4.4# wrk -c 3 -t 3 http://httpbin:8000/ip\nRunning 10s test @ http://httpbin:8000/ip\n  3 threads and 3 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     5.47ms    5.53ms  60.24ms   87.98%\n    Req/Sec   229.36     71.43   440.00     69.70%\n  6861 requests in 10.04s, 1.68MB read\nRequests/sec:    683.52\nTransfer/sec:    171.58KB\n</code></pre> <p>\u5728\u5220\u6389\u7194\u65ad\u8bbe\u7f6e\u4e4b\u540e\uff0cwrk\u91cd\u65b0\u8fd0\u884c\uff0c\u6240\u6709\u8bf7\u6c42\u90fd\u4f1a\u5b8c\u6210\u3002 </p> <p>\u8fd9\u91cc\u4f7f\u7528\u7684\u7194\u65ad\u8bbe\u7f6e\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\uff0c\u6bd4\u8f83\u6781\u7aef\uff1a </p> <ul> <li><code>TCP</code>\u548c<code>HTTP</code>\u8fde\u63a5\u6c60\u5927\u5c0f\u90fd\u88ab\u8bbe\u7f6e\u4e3a1; </li> <li>\u53ea\u5141\u8bb8\u51fa\u9519\u4e00\u6b21\uff1b </li> <li>\u6bcf\u79d2\u505a\u4e00\u6b21\u8bf7\u6c42\u8ba1\u6570\uff1b </li> <li>\u53ef\u4ee5\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u79fb\u9664<code>100\uff05</code>\u7684<code>Pod</code>; </li> <li>\u53d1\u751f\u6545\u969c\u7684<code>Pod</code>\u6700\u5c11\u5728\u88ab\u79fb\u9664<code>3</code>\u5206\u949f\u540e\u624d\u80fd\u518d\u6b21\u52a0\u5165\u8d1f\u8f7d\u5747\u8861\u6c60\u3002 </li> </ul> <p>\u8fd9\u91cc\u7528<code>wrk</code>\u5de5\u5177\u76f4\u63a5\u4f7f\u7528\u8d85\u51fa\u7194\u65ad\u6807\u51c6\u7684\u5e76\u884c\u6570\u91cf\u6765\u8bbf\u95ee<code>httpbin</code>\u670d\u52a1\uff0c\u5728\u5f15\u53d1\u7194\u65ad\u540e\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u5f02\u5e38\u54cd\u5e94\uff1b\u5728\u5220\u9664\u76ee\u6807\u89c4\u5219\u540e\uff0c\u7194\u65ad\u89c4\u5219\u4e0d\u590d\u5b58\u5728\uff0c\u518d\u6b21\u7528\u540c\u6837\u7684\u53c2\u6570\u8fd0\u884cwrk\uff0c\u5c31\u4f1a\u6062\u590d\u6b63\u5e38\u7684\u8bbf\u95ee\u80fd\u529b\u4e86\u3002 </p>"},{"location":"chap5/12Istio_http4/#2","title":"2\u3001\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5","text":"<p>\u5728\u5fae\u670d\u52a1\u7684\u6d4b\u8bd5\u8fc7\u7a0b\u4e2d\uff0c\u5f80\u5f80\u9700\u8981\u5bf9\u7f51\u7edc\u6545\u969c\u7684\u573a\u666f\u8fdb\u884c\u6a21\u62df\uff0c<code>Istio</code>\u4e5f\u5728\u8fd9\u65b9\u9762\u63d0\u4f9b\u4e86\u4e24\u79cd\u6545\u969c\u6ce8\u5165\u7684\u80fd\u529b\uff1a<code>\u5ef6\u8fdf</code>\u548c<code>\u4e2d\u65ad</code>\u3002</p> <p>\u501f\u52a9<code>Istio</code>\u7684\u6545\u969c\u6ce8\u4eba\u80fd\u529b\uff0c\u6d4b\u8bd5\u4eba\u5458\u53ef\u4ee5\u4f7f\u7528<code>VirtualService</code>\u914d\u7f6e\u65b9\u5f0f\uff0c\u5728\u4efb\u610f\u8c03\u7528\u4e2d\u52a0\u5165\u6a21\u62df\u6545\u969c\uff0c\u4ece\u800c\u6d4b\u8bd5\u5e94\u7528\u5728\u6545\u969c\u72b6\u6001\u4e0b\u7684\u54cd\u5e94\u60c5\u51b5\uff0c\u751a\u81f3\u53ef\u4ee5\u5728\u8bf7\u6c42\u4e2d\u6ce8\u5165\u4e2d\u65ad\uff0c\u6765\u963b\u6b62\u67d0\u4e9b\u60c5\u51b5\u4e0b\u7684\u670d\u52a1\u8bbf\u95ee\u3002 </p>"},{"location":"chap5/12Istio_http4/#2-1","title":"2-1 \u6ce8\u5165\u5ef6\u8fdf","text":"<p>\u9996\u5148\uff0c\u7f16\u8f91<code>httpbin</code>\u7684<code>VirtualService</code>\uff0c\u4e3a\u670d\u52a1\u52a0\u4eba\u4e00\u4e2a<code>3</code>\u79d2\u7684\u5ef6\u8fdf\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: VirtualService \nmetadata: \n  name: httpbin \nspec: \n  hosts: \n  - \"httpbin.default.svc.cluster.local\"\n  http:\n  - route: \n    - destination: \n        host: httpbin.default.svc.cluster.local \n    fault:\n      delay:\n        fixedDelay: 3s\n        percent: 100\n</code></pre> <pre><code>$ kubectl apply -f http-lag-virtualservice.yaml \nvirtualservice.networking.istio.io/httpbin configure\n</code></pre> <pre><code>\nbash-4.4# http --body http://httpbin:8000/delay/1\n...\n\nreal    0m 4.321s\n</code></pre> <p>\u5b9e\u9645\u5ef6\u8fdf\u4e86<code>3</code>\u79d2\uff0c\u4e5f\u5c31\u662f\u8bf4\u6ce8\u4eba\u7684\u5ef6\u8fdf\u751f\u6548\u4e86\u3002 </p> <p>\u8fd9\u5f88\u81ea\u7136\u5c31\u8ba9\u4eba\u8054\u60f3\u5230\u524d\u9762\u63d0\u5230\u7684\u8d85\u65f6\u63a7\u5236\u3002 </p> <p>\u8fd9\u91cc\u4e3a<code>httpbin</code>\u670d\u52a1\u8bbe\u7f6e\u4e00\u4e2a\u4e24\u79d2\u7684\u8d85\u65f6\u9650\u5236\uff0c\u4e5f\u5c31\u662f\u5728\u8def\u7531\u89c4\u5219\u4e2d\u52a0\u5165 <code>timeout: 2s\"</code>,\u518d\u6b21\u8fdb\u884c\u6d4b\u8bd5\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: VirtualService \nmetadata: \n  name: httpbin \nspec: \n  hosts: \n  - httpbin.default.svc.cluster.local\n  http:\n  - route: \n    - destination: \n        host: httpbin.default.svc.cluster.local \n    timeout: 2s\n    fault:\n      delay:\n        fixedDelay: 3s\n        percent: 100\n</code></pre> <pre><code>bash-4.4# time http --body http://httpbin:8000/ip\n...\nreal    0m 3.331s\n...\n\nhttp --body http://httpbin:8000/delay/2\nreal    0m 5.45s\n</code></pre> <p>\u7ed3\u679c\u4e00\u76ee\u4e86\u7136\uff0c\u6211\u4eec\u5728\u8bf7\u6c42\u4e2d\u6ce8\u5165\u7684\u5ef6\u65f6\u5e76\u4e0d\u4f1a\u89e6\u53d1\u8d85\u65f6\uff0c\u5bf9\u5ef6\u8fdf\u7684\u6ce8\u4eba\u7531\u4ee5\u4e0b\u4e24\u9879\u6784\u6210\u3002 </p> <ul> <li><code>percent</code>\uff1a\u662f\u4e00\u4e2a\u767e\u5206\u6bd4\uff0c\u7528\u4e8e\u6307\u5b9a\u6ce8\u4eba\u5ef6\u8fdf\u7684\u6bd4\u7387\uff0c\u5176\u9ed8\u8ba4\u503c\u4e3a<code>1000</code> \u3002</li> <li><code>fixedDelay</code>\uff1a\u8868\u660e\u5ef6\u8fdf\u7684\u65f6\u95f4\u957f\u5ea6\uff0c\u5fc5\u987b\u5927\u4e8e<code>1</code>\u6beb\u79d2\u3002 </li> </ul>"},{"location":"chap5/12Istio_http4/#3","title":"3\u3001 \u6ce8\u5165\u4e2d\u65ad","text":"<p>\u53ef\u4ee5\u901a\u8fc7\u5411\u670d\u52a1\u8c03\u7528\u8fc7\u7a0b\u4e2d\u6ce8\u4eba\u4e2d\u65ad\u7684\u65b9\u5f0f\u6d4b\u8bd5\u670d\u52a1\u901a\u4fe1\u4e2d\u65ad\u7684\u7ed3\u679c\u3002\u4ecd\u7136\u4ee5<code>httpbin</code>\u670d\u52a1\u4e3a\u4f8b\u6211\u4eec\u5c06\u6237\u7684\u670d\u62df\u670d\u52a1\u5b9a\u4e49\u4fee\u6539\u4e3a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: VirtualService \nmetadata: \n  name: httpbin \nspec: \n  hosts: \n  - \"httpbin.default.svc.cluster.local\"\n  http:\n  - fault:\n      abort:\n        httpStatus: 500\n        percent: 100\n    match:\n    - sourceLabels:\n        version: v1\n    route:\n    - destination:\n        host: httpbin.default.svc.cluster.local\n  - route:\n    - destination:\n        host: httpbin.default.svc.cluster.local\n</code></pre> <pre><code>$ kubectl apply -f httpbin-abort-virtualservice.yaml\nvirtualservice.networking.istio.io/httpbin created\n</code></pre> <pre><code>$  kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\nbash-4.4# http --body http://httpbin:8000/ip\nfault filter abort\n\n$  kubectl exec -it sleep-v2-7c6b874968-hl6dj -c sleep bash\nbash-4.4# http --body http://httpbin:8000/ip\n{\n    \"origin\": \"127.0.0.1\"\n}\n</code></pre> <p>\u540c\u6211\u4eec\u8bbe\u8ba1\u7684\u6267\u884c\u8fc7\u7a0b\u4e00\u81f4\uff1a</p> <p>\u6765\u81ea<code>sleep</code>\u670d\u52a1<code>v1</code>\u7248\u672c\u7684\u6d41\u91cf\uff0c\u4f1a\u88ab\u6ce8\u4eba\u4e00\u4e2a<code>HTTP 500</code>\u9519\u8bef\uff1b\u6765\u81ea<code>sleep</code>\u670d\u52a1<code>v2</code>\u7248\u672c\u7684\u6d41\u91cf\uff0c\u5219\u4e0d\u4f1a\u53d7\u5230\u5f71\u54cd\u3002\u548c\u5ef6\u8fdf\u6ce8\u4eba\u4e00\u6837\uff0c\u4e2d\u65ad\u6ce8\u4eba\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>percent</code>\u5b57\u6bb5\u6765\u8bbe\u7f6e\u6ce8\u5165\u767e\u5206\u6bd4\u3002 </p>"},{"location":"chap5/12Istio_http4/#4","title":"4\u3001 \u6d41\u91cf\u590d\u5236","text":"<p>\u6d41\u91cf\u590d\u5236\u662f\u53e6\u4e00\u4e2a\u7528\u4e8e\u6d4b\u8bd5\u7684\u5f3a\u5927\u529f\u80fd\uff0c\u5b83\u53ef\u4ee5\u628a\u6307\u5411\u4e00\u4e2a\u670d\u52a1\u7248\u672c\u7684\u6d41\u91cf\u590d\u5236\u4e00\u4efd\u51fa\u6765\uff0c\u53d1\u9001\u7ed9\u53e6\u4e00\u4e2a\u670d\u52a1\u7248\u672c\u3002</p> <p>\u8fd9\u4e00\u529f\u80fd\u80fd\u591f\u5c06\u751f\u4ea7\u6d41\u91cf\u5bfc\u4eba\u6d4b\u8bd5\u5e94\u7528, \u5728\u590d\u5236\u51fa\u6765\u7684\u955c\u50cf\u6d41\u91cf\u53d1\u51fa\u4e4b\u540e\u4e0d\u4f1a\u7b49\u5f85\u54cd\u5e94\uff0c\u56e0\u6b64\u5bf9\u6b63\u5e38\u5e94\u7528\u7684\u6027\u80fd\u5f71\u54cd\u8f83\u5c0f\uff0c\u53c8\u80fd\u5728\u4e0d\u5f71\u54cd\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\u7528\u66f4\u5b9e\u9645\u7684\u6570\u636e\u5bf9\u5e94\u7528\u8fdb\u884c\u6d4b\u8bd5\u3002 </p> <p>\u8fd9\u91cc\u5c06\u4f7f\u7528<code>flaskapp</code>\u670d\u52a1\u4f5c\u4e3a\u6d4b\u8bd5\u76ee\u6807.\u5c06\u8bbf\u95ee\u6d41\u91cf\u90fd\u53d1\u7ed9\u5176<code>v1</code>\u7248\u672c, \u540c\u65f6\u590d\u5236\u4e00\u4efd\u5230\u5176<code>v2</code>\u7248\u672c</p> <p>\u8be5\u5de5\u4f5c\u540c\u6837\u5728<code>VirtualService</code>\u4e2d\u5b8c\u6210\uff0c\u7f16\u8f91<code>flaskapp</code>\u7684<code>VirtualService</code>\uff0c\u5c06\u5176\u8bbe\u7f6e\u4e3a\u5982\u4e0b\u5185\u5bb9\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: VirtualService \nmetadata: \n  name: flaskapp \nspec: \n  hosts: \n  - fiaskapp.default.svc.cluster.local \n  http: \n  - route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local \n        subset: v1 \n    mirror:  \u2764\ufe0f\n      host: flaskapp.default.svc.cluster.local \n      subset: v2 \n</code></pre> <pre><code>$ kubectl apply -f flaskapp-copy-virtualservice.yaml \nvirtualservice.networking.istio.io/flaskapp created\n</code></pre> <ul> <li>Source pod <code>sleep-v1</code></li> </ul> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\nbash-4.4# http --body http://flaskapp/env/version\nv1\n</code></pre> <ul> <li>Dest pod 1 <code>flask-v1</code></li> </ul> <pre><code>$ kubectl logs flaskapp-v1-578d79dbcf-74ptj -c flaskapp | tail -1\n[pid: 12|app: 0|req: 488/790] 10.1.0.122 () {50 vars in 1085 bytes} [Fri Nov  1 07:28:47 2019] GET /env/version =&gt; generated 2 bytes in 24 msecs\n (HTTP/1.1 200) 2 headers in 78 bytes (1 switches on core \n</code></pre> <ul> <li>Dest pod 2 <code>flask-v2</code></li> </ul> <pre><code>$ kubectl logs flaskapp-v2 -c flaskapp | tail -1\n[pid: 13|app: 0|req: 873/1441] 10.1.0.122 () {50 vars in 1085 bytes} [Fri Nov  1 07:26:53 2019] GET /env/version =&gt; generated 2 bytes in 29 msec\ns (HTTP/1.1 200) 2 headers in 78 bytes (1 switches on core 0)\n</code></pre> <p></p> <p>\u5728\u4ece<code>sleep Pod</code>\u53d1\u51fa\u6d4b\u8bd5\u4e4b\u540e\uff0c\u53ef\u4ee5\u770b\u5230,\u6309\u7167\u9ed8\u8ba4\u8def\u7531\u8c03\u7528\u4e86<code>flaskapp</code>\u670d\u52a1\u7684<code>v1</code>\u7248\u672c\uff0c\u8fd4\u56de\u4e86\u6b63\u5e38\u7684\u7ed3\u679c\uff1b</p> <p>\u4f7f\u7528<code>kubectl logs</code>\u547d\u4ee4\u67e5\u770b<code>flaskapp</code>\u670d\u52a1\u4e24\u4e2a\u4e0d\u7684<code>Pod</code>\uff0c\u4f1a\u53d1\u73b0\u5728\u5176<code>v2</code>\u7248\u672c\u7684<code>Pod</code>\u4e2d, \u5728\u540c\u4e00\u65f6\u95f4\u5185\u4e5f\u4ea7\u751f\u4e86\u540c\u6837\u7684\u8c03\u7528\u8bb0\u5f55\u3002 </p>"},{"location":"chap5/13Istio_Mixer1/","title":"\u7b2c\u5341\u4e09\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(\u7b80\u4ecb/Denier\u8bbf\u95ee\u63a7\u5236/Listchecker\u8bbf\u95ee\u63a7\u5236)","text":"<p><code>Istio</code> \u9664\u4e86\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u6d41\u91cf\u63a7\u5236\u529f\u80fd\uff0c\u8fd8\u901a\u8fc7<code>Mixer</code>\uff1a\u63d0\u4f9b\u4e86\u53ef\u6269\u5c55\u7684\u5916\u63a5\u529f\u80fd\u3002</p> <p><code>Mixer</code>\u201c\u77e5\u6653\u201d\u6bcf\u4e00\u6b21\u670d\u52a1\u95f4\u7684\u8c03\u7528\u8fc7\u7a0b\uff0c\u8fd9\u4e9b\u8c03\u7528\u8fc7\u7a0b\u4f1a\u4e3a<code>Mixer</code>\uff1a\u63d0\u4f9b\u4e30\u5bcc\u7684\u76f8\u5173\u4fe1\u606f\uff0c<code>Mixer</code>\u901a\u8fc7\u63a5\u4eba\u7684\u9002\u914d\u5668\u5bf9\u8fd9\u4e9b\u4fe1\u606f\u8fdb\u884c\u5904\u7406\uff0c\u80fd\u591f\u5728\u8c03\u7528\u7684\u9884\u68c0\uff08\u6267\u884c\u524d)\u548c\u62a5\u544a\uff08\u6267\u884c\u540e\uff09\u9636\u6bb5\u6267\u884c\u591a\u79cd\u4efb\u52a1</p> <p>\u5e76\u4e14<code>Mixer</code>\u7684\u9002\u914d\u5668\u6a21\u578b\u662f\u53ef\u4ee5\u6269\u5145\u7684\uff0c\u8fd9\u4e5f\u8d4b\u4e88\u4e86<code>Mixer</code>\u66f4\u5927\u7684\u6269\u5c55\u80fd\u529b\u3002 </p>"},{"location":"chap5/13Istio_Mixer1/#1mixer","title":"1\u3001Mixer\u9002\u914d\u5668\u7b80\u4ecb","text":"<p>Mixer\uff1a\u4e2d\u73b0\u6709\u7684\u9002\u914d\u5668\u5927\u81f4\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u4e24\u7c7b\u3002</p> <ul> <li>\u4e00\u7c7b\u662f<code>Istio</code>\u5185\u90e8\u5b9e\u73b0\u7684\u9002\u914d\u5668\uff0c\u7528\u4e8e\u5b8c\u6210\u7f51\u683c\u7684\u5185\u90e8\u529f\u80fd\uff0c\u4f8b\u5982<code>Fluentd</code>\u3001 <code>Stdio</code>\u3001<code>RedisQuota</code>\u7b49\u3002</li> <li>\u53e6\u4e00\u7c7b\u662f\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u9002\u914d\u5668\uff0c\u7528\u4e8e\u548c\u5916\u90e8\u7cfb\u7edf\u8fdb\u884c\u5bf9\u63a5\uff0c\u4f8b\u5982<code>DataDog</code>\u3001 <code>StackDriver</code>\u7b49\u3002 </li> </ul> <p>\u672c\u7ae0\u540c\u6837\u4ece\u5e94\u7528\u573a\u666f\u51fa\u53d1\uff0c\u4ecb\u7ecd\u5728<code>Istio</code>\u4e2d\u4f7f\u7528<code>Mixer</code>\uff1a\u80fd\u591f\u5b8c\u6210\u7684\u5404\u79cd\u4efb\u52a1\uff0c\u53ea\u6d89\u53ca\u7f51\u683c\u5185\u90e8\u529f\u80fd\u76f8\u5173\u7684\u9002\u914d\u5668\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 </p> <ul> <li><code>Denier</code>\uff1a\u6839\u636e\u81ea\u5b9a\u4e49\u6761\u4ef6\u5224\u65ad\u662f\u5426\u62d2\u7edd\u670d\u52a1\u3002 </li> <li><code>Fluentd</code>: \u5411<code>Fluentd</code>\u670d\u52a1\u63d0\u4ea4\u65e5\u5fd7\u3002 </li> <li><code>List</code>\uff1a\u7528\u4e8e\u6267\u884c\u767d\u540d\u5355\u6216\u8005\u9ed1\u540d\u5355\u68c0\u67e5\u3002 </li> <li><code>MemQuota</code>\uff1a\u4ee5\u5185\u5b58\u4e3a\u5b58\u50a8\u540e\u7aef\uff0c\u63d0\u4f9b\u7b80\u6613\u7684\u914d\u989d\u63a7\u5236\u529f\u80fd\u3002 </li> <li><code>Prometheus</code>\uff1a\u4e3a<code>Prometheus</code>\u63d0\u4f9b<code>Istio</code>\u7684\u76d1\u63a7\u6307\u6807\u3002 </li> <li><code>RedisQuota</code>\uff1a\u57fa\u4e8e<code>Redis</code>\u5b58\u50a8\u540e\u7aef\uff0c\u63d0\u4f9b\u914d\u989d\u7ba1\u7406\u529f\u80fd\u3002 </li> <li><code>StatsD</code>\uff1a\u5411<code>StatsD</code>\u53d1\u9001\u76d1\u63a7\u6307\u6807\u3002 </li> <li><code>Stdio</code>\uff1a\u7528\u4e8e\u5728\u672c\u5730\u8f93\u51fa\u65e5\u5fd7\u548c\u6307\u6807\u3002 </li> </ul> <p><code>Mixer</code>\uff1a\u7684\u914d\u7f6e\u901a\u5e38\u7531\u4ee5\u4e0b\u4e09\u90e8\u5206\u7ec4\u6210\u3002 </p> <ul> <li><code>Handler</code>: \u58f0\u660e\u4e00\u4e2a\u9002\u914d\u5668\u7684\u914d\u7f6e</li> <li><code>Instance</code>: \u58f0\u660e\u4e00\u4e2a\u6a21\u677f\uff0c\u7528\u6a21\u677f\u5c06\u4f20\u7ed9<code>Mixer</code>\u7684\u6570\u636e\u8f6c\u6362\u4e3a\u7279\u5b9a\u9002\u914d\u5668\u7684\u8f93\u51fa\u683c\u5f0f</li> <li><code>Rule</code>: \u5c06<code>Instance</code>\u548c<code>Hanlder</code>\u8fde\u63a5\u8d77\u6765\uff0c \u786e\u8ba4\u5904\u7406\u5173\u7cfb</li> </ul>"},{"location":"chap5/13Istio_Mixer1/#2-denier","title":"2\u3001 \u57fa\u4e8e<code>Denier</code>\u9002\u914d\u5668\u7684\u8bbf\u95ee\u63a7\u5236","text":"<p>\u672c\u8282\u4f1a\u5229\u7528<code>Denier</code>\u9002\u914d\u5668\u4e3a<code>httpbin</code>\u670d\u52a1\u521b\u5efa\u4e00\u4e2a<code>Rule</code>\u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u4f1a\u963b\u6b62\u6765\u81ea<code>sleep</code> \u670d\u52a1\u7684<code>v1</code>\u7248\u672c\u7684\u8bf7\u6c42\u3002</p> <p>\u8981\u4f7f\u7528<code>Denier</code>\u9002\u914d\u5668, \u5219\u9996\u5148\u8981\u5b9a\u4e49\u5b83\u7684\u4e2a<code>Handler</code>\uff0c\u6bcf\u4e2a\u9002\u914d\u5668\u90fd\u4f1a\u81ea\u5df1\u7684\u914d\u7f6e\u683c\u5f0f\uff0c\u53ef\u524d\u5f80\u5b98\u65b9\u7f51\u7ad9\uff08<code>https://istio.io/docs/reference/config/policy-and-telemetry/adapters/</code>\uff09\u8fdb\u884c\u67e5\u8be2\u3002</p> <p>\u672c\u8282\u4e3a<code>Denier</code>\uff1a\u9002\u914d\u5668\u5b9a\u4e49\u7684<code>Handler</code>\u7ed3\u6784\u5f88\u7b80\u5355\uff0c\u4ec5\u5305\u542b\u4e00\u4e2a\u9519\u8bef\u7801\u548c\u6d88\u606f\uff1a </p> <pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: denier \nmetadata: \n  name: code-7 \nspec: \n  status: \n    code: 7 \n    message: Not allowed \n</code></pre> <p>\u8fd9\u6bb5\u4ee3\u7801\u610f\u5473\u7740\uff1a\u5982\u679c\u6709\u6d41\u91cf\u7684\u9884\u68c0\u8bf7\u6c42\u901a\u8fc7<code>Rule</code>\u5bf9\u8c61\u4f20\u9012\u7ed9\u4e86\u8fd9\u4e2a<code>Handler</code>\u5c31\u4f1a\u8c03\u7528\u5931\u8d25\uff0c\u8fd4\u56de\u9519\u8bef\u7801<code>7</code>\u53ca\u9519\u8bef\u4fe1\u6025<code>Not allowed</code>\u3002</p> <p>\u5c06\u5176\u4fdd\u5b58\u4e3a<code>denier.yaml</code> \u7136\u540e\u4f7f\u7528<code>kubectl apply</code>\u547d\u4ee4\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4 </p> <pre><code>$ kubectl apply -f denier.yaml \ndenier.config.istio.io/code-7 created\n</code></pre> <p>\u6211\u4eec\u73b0\u5728\u53ea\u60f3\u7981\u6b62\u4e00\u4e2a<code>sleep</code>\u670d\u52a1\u7684<code>v1</code>\u7248\u672c\uff0e\u4ec5\u901a\u8fc7<code>Rule</code>\u5bf9\u8c61\u7684<code>match</code>\u5b57\u6bb5\u5339\u914d\u5373\u53ef\u56e0\u6b64\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a<code>checknonting</code>\u7684\u6821\u677f\u6765\u5b9a\u4e49\u8f93\u5165\uff0e\u5c31\u662f\u8bf4\u65e0\u987b\u5bf9\u8fdb\u5165\u7684\u6570\u636e\u8fdb\u884c\u68c0\u67e5 </p> <pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: checknothing \nmetadata: \n  name: place-holder \nspec: \n</code></pre> <p><code>checknothing</code>\u7684\u6a21\u677f\u56e0\u4e3a\u6ca1\u505a\u4efb\u4f55\u5904\u7406\uff0e\u6240\u4ee5\u4e5f\u662f\u76f8\u5f53\u7b80\u5355\u7684\u5c06\u5176\u6df1\u5b58\u4e3a<code>checknothing.yaml</code>\u5e76\u4f7f\u7528<code>kubectl apply</code>\u547d\u4ee4\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4 </p> <pre><code>$ kubectl apply -f checknonthing.yaml --validate=false\nchecknothing.config.istio.io/place-holder created\n</code></pre> <p>\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a<code>Rule</code>\u5bf9\u8c61\u628a\u4e8c\u8005\u8fde\u63a5\u8d77\u6765\u7f16\u8f91<code>denier.rule.yaml</code></p> <pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: rule \nmetadata: \n  name: deny-sleep-v1-to-httpbin \nspec: \n  match: destination.labels[\"app\"] == \"httpbin\" &amp;&amp; source.labels[\"app\"] == \"sleep\" &amp;&amp; source.labels[\"version\"] == \"v1\"\n  actions: \n  - handler: code-7.denier \n    instances: place-holder.checknothing\n</code></pre> <p>\u6ce8\u610f\uff0c\u5728<code>instance</code>\u548c<code>handler</code>\u4e24\u4e2a\u5b87\u6bb5\u4e2d\u5f15\u7528\u5bf9\u8c61\u7684\u65b9\u5f0f\u4e3a\u4e00<code>\u540d\u79f0.\u7c7b\u578b</code></p> <pre><code>handler: code-7.denier \ninstances: [place-holder.checknothing]\n</code></pre> <p>\u5728<code>match</code>\u5b57\u6bb5\u4e2d\u4f7f\u7528\u6e90\u548c\u76ee\u6807\u7684\u6807\u7b7e\u65f6\u670d\u8fdb\u884c\u9274\u522b\u3001\u6574\u4e2a\u8868\u8fbe\u5f0f\u5b9e\u73b0\u4e86\u5bf9\u6765\u81ea<code>Sleep</code>\u670d\u52a1\u7684<code>v1</code>\u7248\u672c\u5411<code>httpbin</code>\u670d\u52a1\u53d1\u8d77\u8c03\u7528\u7684\u6d41\u91cf\u7684\u8bc6\u522b</p> <pre><code>$ kubectl apply -f denier.rule.yaml \nrule.config.istio.io/deny-sleep-v1-to-httpbin created\n</code></pre> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-92lqk -c sleep bash\nbash-4.4# http --body http://httpbin:8000/ip\nPERMISSION DENIED:code\u4e007.denier.defau1t:Not allowed\n\n\n$ kubectl exec -it sleep-v2-7c6b874968-dx6ll -c sleep bash\nbash-4.4# http --body http://httpbin:8000/ip\n{\n    \"origin\": \"127.0.0.1\"\n}\n</code></pre> <p>\u6d4b\u8bd5\u7ed3\u679c\u8868\u660e\uff0c\u4ece<code>sleep</code>\u670d\u52a1\u7684<code>v1</code>\u7248\u672c\u5411<code>httpbin</code>\u670d\u52a1\u53d1\u8d77i\u8bf7\u6c42\uff0c\u4f1a\u5931\u8d25\u4e14\u8fd4\u56de<code>\"PERMISSION DENIED:code\u4e007.denier.defau1t:Not allowed\"</code> ,</p> <p>\u4ece<code>sleep</code>\u670d\u52a1\u7684<code>v2</code>\u7248\u672c\u5411<code>httpbin</code>\u670d\u52a1\u53d1\u8d77\u8bf7\u6c42\uff0c\u5c31\u4f1a\u6b63\u5e38\u8fd4\u56de\u7ed3\u679c\u3002 </p> <p>\u4e3a\u4e86\u540e\u7eed\u5185\u5bb9\u7684\u7ee7\u7eed\u8fdb\u884c\uff0c\u5220\u9664\u521a\u521a\u521b\u5efa\u7684\u4e09\u4e2a\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl delete -f denier.rule.yaml -f checknonthing.yaml -f denier.yaml \nrule.config.istio.io \"deny-sleep-v1-to-httpbin\" deleted\nchecknothing.config.istio.io \"place-holder\" deleted\ndenier.config.istio.io \"code-7\" deleted\n</code></pre>"},{"location":"chap5/13Istio_Mixer1/#3-listchecker","title":"3\u3001 \u57fa\u4e8e<code>Listchecker</code>\u9002\u914d\u5668\u7684\u8bbf\u95ee\u63a7\u5236","text":"<p>\u4e0a\u9762\u63d0\u4f9b\u7684<code>Denier</code>\u9002\u914d\u5668\u7684\u8bbf\u95ee\u63a7\u5236\u662f\u6bd4\u8f83\u6b7b\u677f\u7684\uff0c\u8868\u8fbe\u5f0f\u4fee\u6539\u4e5f\u7a0d\u663e\u70e6\u7410\uff0c\u5982\u679c\u60f3\u4f7f\u7528\u66f4\u7075\u6d3b\u7684\u63a7\u5236\u65b9\u5f0f\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528<code>Listchecker</code>\u9002\u914d\u5668\u3002 </p> <p>\u5728<code>Listechecker</code>\u9002\u914d\u5668\u4e2d\u4f1a\u4fdd\u5b58\u4e00\u4e2a\u5217\u8868\uff0c\u5e76\u53ef\u4ee5\u58f0\u660e\u8fd9\u4e00\u5217\u8868\u662f\u9ed1\u540d\u5355\u8fd8\u662f\u767d\u540d\u5355\uff0c\u5728\u6709\u6570\u636e\u8f93\u5165\u540e\uff0c\u9996\u5148\u5224\u65ad\u8be5\u6570\u636e\u662f\u5426\u5c5e\u4e8e\u5217\u8868\u6210\u5458\uff0c\u7136\u540e\u6839\u636e\u5217\u8868\u7684\u9ed1\u540d\u5355\u6216\u767d\u540d\u5355\u5c5e\u6027\u6765\u8fd4\u56de\u662f\u5426\u8bb8\u53ef\u6b64\u6b21\u8c03\u7528\u3002</p> <p></p> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u7cfb\u5217\u5bf9\u8c61\u6765\u9a8c\u8bc1\u8fd9\u4e00\u5217\u8868\u662f\u5426\u6b63\u786e\u4e86\u3002\u4e3a<code>Listchecker</code>\u9002\u914d\u5668\u521b\u5efa\u4e00\u4e2a<code>Handler</code>\u5bf9\u8c61\uff0c\u5176\u4e2d\u7684\u6570\u636e\u5b9a\u4e49\u6765\u81ea\u8868\u7684\u7b2c<code>1</code>\u884c\uff1a </p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: listchecker \nmetadata:\n  name: chaos \nspec: \n  overrides: [\"v1\", \"v3\"] \n  blacklist: true\n</code></pre> <pre><code>$ kubectl apply -f chaos-listchcker.yaml \nlistchecker.config.istio.io/chaos created\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86<code>overrides</code>\u5b57\u6bb5\u4fdd\u5b58\u4e00\u4e2a\u5217\u8868\u7528\u4e8e\u68c0\u67e5\u5e76\u5728<code>blacklist</code>\u5b57\u6bb5\u58f0\u660e\u8fd9\u4e00\u5217\u8868\u4e3a\u9ed1\u540d\u5355\u3002</p> <p><code>Listchecker</code>\u9002\u914d\u5668\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>providerUrl</code>\u5b57\u6bb5\u5f15\u7528\u4e00\u4e2a\u8fdc\u7a0b\u5217\u8868\u5e76\u5b9a\u65f6\u66f4\u65b0\uff0c\u4ee5\u83b7\u5f97\u66f4\u5927\u7684\u7075\u8bdd\u6027</p> <p>\u63a5\u4e0b\u6765\u4f7f\u7528<code>listentry</code>\u6a21\u677f\u4ece\u8f93\u5165\u6570\u636e\u4e2d\u63d0\u53d6\u5185\u5bb9\u5e76\u8f93\u51fa\u7ed9<code>Listchecker</code>\u9002\u914d\u5668\u3002\u5c06\u4e0b\u9762\u4ee3\u7801\u4fdd\u5b58\u4e3a<code>version.listentry.yaml</code></p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: listentry \nmetadata:\n  name: version \nspec: \n  value: source.labels[\"version\"]\n</code></pre> <p><code>listentry</code>\u53ea\u6709<code>value</code>\u4e00\u4e2a\u5b57\u6bb5\u5728\u5176\u4e2d\u7528\u8868\u8fbe\u5f0f\u4ece\u8f93\u5165\u6570\u636e\u4e2d\u63d0\u53d6\u5185\u5bb9\u8fdb\u884c\u540e\u7eed\u8f93\u51fa</p> <pre><code>$ kubectl apply -f version.listentry.yaml \nlistentry.config.istio.io/version created\n</code></pre> <p>\u6700\u540e\u521b\u5efa<code>Rule</code>\u5bf9\u8c61\u5c06<code>Instance</code>\u548c <code>Handler</code> \u8fde\u63a5\u5728\u4e00\u8d77\u8fd9\u4e3a<code>httpbin</code>\u7684\u6d41\u5740\u8fdb\u884c\u6d4b\u8bd5\uff1a </p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: rule \nmetadata:\n  name: checkversion \nspec: \n  match: destination.labels[\"app\"] == \"httpbin\" \n  actions: \n  - handler: chaos.listchecker \n    instances: \n      - version.listentry\n</code></pre> <p><code>listentry.rule.yaml</code></p> <pre><code>$ kubectl apply -f listentry.rule.yaml \nrule.config.istio.io/checkversion created\n</code></pre> <p>\u73b0\u5728<code>Handler</code>\u3001 <code>Instance</code>, \u53ca<code>Rule</code>\u4e09\u4e2a\u5bf9\u8c61\u90fd\u5df2\u7ecf\u521b\u5efa\u5b8c\u6bd5\u4e86\uff0e\u6211\u4eec\u53ef\u4ee5\u8fdb\u884c\u6d4b\u8bd5\u4e86\uff1a </p> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-92lqk -c sleep bash\nbash-4.4# http --body http://httpbin:8000/ip\nPERMISSION DENIED:chaos.Iistchecker.default:v1 is blacklisted\n\n$ kubectl exec -it sleep-v2-7c6b874968-dx6ll -c sleep bash\nbash-4.4# http --body http://httpbin:8000/ip\n{\n    \"origin\": \"127.0.0.1\"\n}\n\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u4f7f\u7528<code>sleep Pod</code>\u7684<code>v1</code>\u7248\u672c\u8bbf\u95f4<code>httpbin</code>\u670d\u52a1\u65f6\uff0c\u8bbf\u95ee\u88ab\u62d2\u7edd\uff0c\u51fa\u73b0\u9519\u8bef\u4fe1\u606f<code>\"PERMISSION DENIED:chaos.Iistchecker.default:v1 is blacklisted</code>\uff1b</p> <p>\u800c\u4ece<code>sleep</code>\u670d\u52a1\u7684<code>v2</code>\u7248\u672c\u8fdb\u884c\u8bbf\u95ee\u65f6\u5c31\u53ef\u4ee5\u6210\u529f\u8fd4\u56de\u5411\u5e94\u7684\u5185\u5bb9\u8981\u9a8c\u8bc1\u767d\u540d\u5355\u4e5f\u5f88\u7b80\u5355\u3001\u53ea\u8981\u628a<code>chaos.listchecker.yaml</code>\u4e2d\u7684<code>blacklist: true</code>\u6539\u6210 <code>blacklist: false</code>.\u7136\u540e\u91cd\u65b0\u63d0\u4ea4\u5373\u53ef\u3002</p> <p>\u518d\u6b21\u6267\u884c\u6d4b\u8bd5\uff1a </p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: listchecker \nmetadata:\n  name: chaos \nspec: \n  overrides: [\"v1\", \"v3\"] \n  blacklist: false\n</code></pre> <pre><code>$ kubectl apply -f chaos-listchcker.yaml \nlistchecker.config.istio.io/chaos configured\n</code></pre> <pre><code>$ kubectl exec -it sleep-v1-548d87cc5c-92lqk -c sleep bash\nbash-4.4# http --body http://httpbin:8000/ip\n{\n    \"origin\": \"127.0.0.1\"\n}\n\n$ kubectl exec -it sleep-v2-7c6b874968-dx6ll -c sleep bash\nbash-4.4# http --body http://httpbin:8000/ip\nNOT FOUND:chaoslistchecker.default:v2 is not whitelisted\n</code></pre> <p>\u5728<code>Listchecker</code>\u9002\u914d\u5668\u66f4\u65b0\u4e4b\u540e\u8fdb\u884c\u65b0\u4e00\u8f6e\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u770b\u5230\u6d4b\u8bd5\u7ed3\u679c\u53d1\u751f\u4e86\u53d8\u5316\uff0c \u4e0e\u4e2d\u7684<code>3:4</code>\u884c\u4e00\u81f4</p> <p>sleep\u670d\u52a1\u7684<code>v2</code>\u7248\u672c\u5411httpbin\u53d1\u51fa\u7684\u8bbf\u95ee\u88ab\u62d2\u7edd\uff0c\u8fd4\u56de\u4fe1\u606f\u4e3a <code>NOT FOUND:chaoslistchecker.default:v2 is not whitelisted</code></p>"},{"location":"chap5/14Istio_Mixer2/","title":"\u7b2c\u5341\u56db\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(MemQuota\u670d\u52a1\u9650\u6d41/Mixer\u5bf9\u8c61\u7684\u5b9a\u4e49/RedisQuota\u670d\u52a1\u9650\u6d41)","text":""},{"location":"chap5/14Istio_Mixer2/#1memquota","title":"1\u3001\u4f7f\u7528<code>MemQuota</code>\u9002\u914d\u5668\u8fdb\u884c\u670d\u52a1\u9650\u6d41","text":"<p>\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u95f4\u8c03\u7528\uff0c\u56e0\u4e3a\u5b58\u5728\u4e1a\u52a1\u4f18\u5148\u7ea7\u3001\u8d44\u6e90\u5206\u914d\u53ca\u670d\u52a1\u8d1f\u8f7d\u80fd\u529b\u7b49\u8981\u6c42\uff0c\u6240\u4ee5\u5e38\u5e38\u9700\u8981\u5bf9\u7279\u5b9a\u7684\u670d\u52a1\u8c03\u7528\u8fdb\u884c\u9650\u5236\uff0c\u9632\u6b62\u670d\u52a1\u8fc7\u8f7d\u3002</p> <p>\u5728<code>Istio</code>\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528<code>Mixer</code>\u7684<code>MemQuota</code>\u6216<code>RedisQuota</code>\u9002\u914d\u5668\uff0c\u5728\u9884\u68c0\u6bb5\u5bf9\u6d41\u91cf\u8fdb\u884c\u914d\u989d\u5224\u65ad\uff0c\u6839\u636e\u4e3a\u7279\u5b9a\u6d41\u91cf\u8bbe\u5b9a\u7684\u989d\u5ea6\u89c4\u5219\u6765\u5224\u65ad\u6d41\u91cf\u8bf7\u6c42\u662f\u5426\u5df2\u7ecf\u8d85\u8fc7\u6307\u5b9a\u7684\u989d\u5ea6\uff08\u7b80\u79f0\u8d85\u989d\uff09\uff0c\u5982\u679c\u53d1\u751f\u8d85\u989d\uff0c\u5c31\u8fdb\u884c\u9650\u6d41\u5904\u7406\u3002</p> <p>\u5728<code>Istio</code>\u7684\u9650\u6d41\u529f\u80fd\u5b9e\u73b0\u4e2d\uff0c\u914d\u7f6e\u5de5\u4f5c\u5206\u4e3a<code>\u5ba2\u6237\u7aef</code>\u548c<code>Mixer</code>\u7aef\u4e24\u90e8\u5206\uff1a</p> <ul> <li>\u5ba2\u6237\u7aef\u4f7f\u7528<code>QuotaSpec</code>\u5b9a\u4e49\u4e00\u4e2a\u9650\u989d\uff0c\u7528<code>QuotaSpecBinding</code>\u5bf9\u8c61\u5c06<code>QuotaSpec</code>\u7ed1\u5b9a\u5230\u7279\u5b9a\u7684\u670d\u52a1\u4e0a\uff1b</li> <li><code>Mixer</code>\uff1a\u7aef\u9700\u8981\u5904\u7406\u9650\u989d\u7684\u5b9e\u73b0\u903b\u8f91\uff0c\u7528\u4e00\u4e2a<code>quota</code>\u5b9e\u4f8b\u5b9a\u4e49\u6d41\u91cf\u5904\u7406\u89c4\u5219,\u7528<code>MemQuota/RedisQuota</code>\u7684<code>Handler</code>\u6765\u5b9e\u9645\u5904\u7406\u6d41\u91cf\uff0c\u6700\u540e\u4f7f\u7528<code>Rule</code>\u5bf9\u8c61\u5c06\u4e8c\u8005\u8fdb\u884c\u7ed1\u5b9a\uff1a </li> </ul> <p>\u672c\u8282\u4f9d\u7136\u4f1a\u4f7f\u7528<code>sleep</code>\u670d\u52a1\u4f5c\u4e3a\u5ba2\u6237\u7aef\uff0c\u5e76\u4f7f\u7528<code>httpbin</code>\u4f5c\u4e3a\u670d\u52a1\u7aef\u3002 </p>"},{"location":"chap5/14Istio_Mixer2/#1-1-mixer","title":"1-1 <code>Mixer</code>\u5bf9\u8c61\u7684\u5b9a\u4e49","text":"<p>**\u5728\u9650\u6d41\u8fc7\u7a0b\u4e2d\u7528\u5230\u7684\u670d\u52a1\u7aef\u5bf9\u8c61\u5e76\u65e0\u7279\u522b\uff0c\u548c\u6240\u6709\u7684<code>Mixer</code>\u9002\u914d\u5668\u5e94\u7528\u4e00\u6837\uff0c \u7531<code>Handler</code>, <code>Instance</code>\u7ed3\u5408<code>Rule</code>\uff0c\u8fd9\u4e8c\u79cd\u5bf9\u8c61\u4e00\u8d77\u5b9a\u4e49\u8fd9\u4e00\u884c\u4e3a\u3002 **</p> <ul> <li>\u9996\u5148\u5b9a\u4e49\u4e00\u4e2a<code>MemQuota</code>\u7c7b\u578b\u7684<code>Handler</code>\uff0c\u901a\u8fc7\u5b83\u6765\u5b9a\u4e49<code>MemQuota</code>\u9002\u914d\u5668\u7684\u884c\u4e3a</li> </ul> <p>\u8fd9\u91cc\u9996\u5148\u5b9a\u4e49\u4e86\u9ed8\u8ba4\u7684\u9650\u6d41\u89c4\u5b9a\uff0c\u6bcf\u79d2\u6700\u591a\u8c03\u7528<code>20</code>\u6b21\uff0c\u7136\u540e\u901a\u8fc7<code>overrides</code>\u7684\u65b9\u5f0f\u4e3a<code>httpbin</code>\u670d\u52a1\u5b9a\u4e49\u4e00\u4e2a\u9650\u6d41\uff0c\u6bcf<code>5</code>\u79d2\u53ea\u80fd\u8c03\u7528\u4e00\u6b21\uff1a </p> <p><code>memquota-handler.yaml</code></p> <pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: memquota \nmetadata: \n  name: handler \nspec: \n  quotas: \n  - name: dent-quota.quota.default \n    maxAmount: 20 \n    validDuration: 10s \n    overrides: \n    - dimensions: \n        destination: httpbin \n      maxAmount: 1 \n      validDuration : 5s \n</code></pre> <pre><code>$ kubectl apply -f memquota-handler.yaml \nmemquota.config.istio.io/handler created\n</code></pre> <p>\u628a\u4e0a\u8ff0\u6587\u4ef6\u547d\u540d\u4e3a<code>memquota-handler.yaml</code>\uff0c\u5e76\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\u3002 \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6bcf<code>10</code>\u79d2\u8c03\u7528<code>20</code>\u6b21\u7684\u9ed8\u8ba4\u8c03\u7528\u914d\u989d\uff0c\u53c8\u4e3a<code>httpbin</code>\u670d\u52a1\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7279\u4f8b: \u6bcf<code>5</code>\u79d2\u53ea\u5141\u8bb8\u8c03\u7528\u4e00\u6b21\u3002 </p> <ul> <li>\u63a5\u4e0b\u6765\u9700\u8981\u5b9a\u4e49\u7684\u662f\u57fa\u4e8e<code>Quota</code>\u6a21\u677f\u7684<code>Instance</code>\u5bf9\u8c61\uff1a </li> </ul> <p><code>quota-instance.yaml</code></p> <pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: quota \nmetadata: \n  name: dest-quota \nspec: \n  dimensions: \n    destination: destination.labels[\"app\"] | destination.service | \"unknown\" \n</code></pre> <pre><code>$ kubectl apply -f quota-instance.yaml \nquota.config.istio.io/dest-quota created\n</code></pre> <p>\u628a\u4ee3\u7801\u4fdd\u5b58\u4e3a<code>quota-instance.yaml</code>\uff0c\u5e76\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\u3002</p> <p>\u8fd9\u91cc\u4e3a<code>quota</code>\u6a21\u677f\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8f93\u5165\u9879<code>demensions</code>\uff0c\u5176\u4e2d\u5305\u542b\u5bf9\u670d\u52a1\u76ee\u6807\u7684\u5b9a\u4e49\u3002</p> <p>\u5bf9<code>destination</code>\u5b57\u6bb5\u7684\u5b9a\u4e49\u662f\u4e00\u4e2a\u5c5e\u6027\u8868\u8fbe\u5f0f\uff0c\u5176\u53d6\u503c\u903b\u8f91\u662f\uff1a</p> <ul> <li>\u9996\u5148\u5224\u65ad\u6d41\u91cf\u76ee\u6807\u662f\u5426\u5177\u6709<code>app</code>\u6807\u7b7e\uff0c</li> <li> <p>\u5982\u679c\u6ca1\u6709\uff0c\u5219\u83b7\u53d6\u76ee\u6807\u670d\u52a1\u7684\u540d\u79f0\uff0c\u5426\u5219\u53d6\u503c\u4e3a<code>\u201cunknown\"</code>\u3002 </p> </li> <li> <p>\u63a5\u4e0b\u6765\u4f7f\u7528\u4e00\u4e2a<code>Rule</code>\u5bf9\u8c61\u5c06\u4e24\u8005\u5173\u8054\u8d77\u6765\uff1a </p> </li> </ul> <p><code>quota-rule.yaml</code></p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: rule \nmetadata: \n  name: quota \nspec: \n  actions: \n  - handler: handler.memquota \n    instances: \n    - dest-quota.quota \n</code></pre> <pre><code>$ kubectl apply -f quota-rule.yaml \nrule.config.istio.io/quota created\n</code></pre> <p>\u540c\u6837\uff0c\u5c06\u4ee3\u7801\u4fdd\u5b58\u4e3a\uff1a<code>quota-rule.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectl apply</code>\u547d\u4ee4\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\u3002 </p> <p>\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u5bf9<code>Mixer</code>\u7aef\u4e09\u4e2a\u5bf9\u8c61\u7684\u5b9a\u4e49\uff0c\u4e09\u4e2a\u5bf9\u8c61\u8054\u5408\u8d77\u6765\u5b8c\u6210\u4efb\u52a1\uff1a</p> <ul> <li><code>Rule</code> \u5bf9\u8c61\u8d1f\u8d23\u8bc6\u522b\u6d41\u91cf\uff0c\u5bf9\u7b26\u5408\u6761\u4ef6\u5e76\u8fdb\u5165\u8be5<code>Rule</code>\u5bf9\u8c61\u5904\u7406\u6d41\u7a0b\u7684\u6d41\u91cf\uff0c</li> <li>\u4f7f\u7528<code>dest-quota</code>\u8fdb\u884c\u5904\u7406\uff0c\u5c06\u5904\u7406\u7ed3\u679c\u8f93\u51fa\u7ed9<code>MemQuota</code>\u9002\u914d\u5668\u7684<code>Handler</code>\u5bf9\u8c61\u8fdb\u884c\u5224\u65ad</li> </ul>"},{"location":"chap5/14Istio_Mixer2/#1-2","title":"1-2 \u5ba2\u6237\u7aef\u5bf9\u8c61\u5b9a\u4e49","text":"<p><code>Mixer</code>\u7aef\u5df2\u7ecf\u5b9a\u4e49\u4e86\u914d\u989d\u65b9\u5f0f\u548c\u5904\u7406\u65b9\u5f0f\uff0c\u800c\u5ba2\u6237\u7aef\u7684\u914d\u7f6e\u9700\u8981\u5b9a\u4e49\u4e24\u4e2a\u5185\u5bb9\uff1a </p> <p>\u53d7\u9650\u7684\u5e94\u7528\u548c\u914d\u989d\u7684\u6263\u51cf\u65b9\u5f0f\uff0c\u9700\u8981\u7528<code>QuotaSpec</code>\u548c<code>QuotaSpecBinding</code>\u5bf9\u8c61\u6765\u5b8c\u6210\uff1a </p> <p>\u521b\u5efa\u4e00\u4e2a<code>QuotaSpec</code>\u5bf9\u8c61\uff1a </p> <p><code>quotaspec.yaml</code></p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: QuotaSpec \nmetadata: \n  name: request-count \nspec: \n  rules: \n  - quotas: \n    - charge: 5 \n      quota: dest-quota \n</code></pre> <pre><code>$ kubectl apply -f quotaspec.yaml \nquotaspec.config.istio.io/request-count created\n</code></pre> <p>\u628a\u4e0a\u8ff0\u4ee3\u7801\u4fdd\u5b58\u4e3a<code>quotaspec.yaml</code>\uff0c\u4f7f\u7528<code>kubectl apply</code>\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\u3002 </p> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a<code>quota</code>\u6263\u51cf\u65b9\u5f0f\uff0c\u5176\u4e2d\u7684<code>quota</code>\u5bf9\u5e94\u7684\u662f\u521b\u5efa\u7684<code>dest-quota</code> </p> <p>\u7136\u540e\u5b9a\u4e49<code>QuotaSpecBindng</code>\u5bf9\u8c61\uff0c\u628a<code>QuotaSpec</code>\u7ed1\u5b9a\u5230\u670d\u52a1\u4e0a\uff1a </p> <p><code>quotaspec-binding.yaml</code></p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: QuotaSpecBinding \nmetadata: \n  name: spec-sleep \nspec: \n  quotaSpecs: \n  - name: request-count \n    namespace: default \n  services: \n  - name: httpbin \n    namespace: default \n</code></pre> <pre><code>$ kubectl apply -f quotaspec-binding.yaml\nquotaspecbinding.config.istio.io/spec-sleep created\n</code></pre>"},{"location":"chap5/14Istio_Mixer2/#1-3","title":"1-3 \u6d4b\u8bd5\u9650\u6d41\u529f\u80fd","text":"<p>\u5728\u76f8\u5173\u7684<code>5</code>\u4e2a\u5bf9\u8c61\u90fd\u521b\u5efa\u6210\u529f\u540e\uff0c\u5c31\u53ef\u4ee5\u8fdb\u884c\u6d4b\u8bd5\u4e86\uff1a </p> <pre><code>$ kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep\n\nbash-4.4# for i in 'seq 10';do http --body http://httpbin:8000/ip; done\n{\n    \"origin\": \"127.0.0.1\"\n}\n\nRESOURCE EXHAUSTED:Quota is exhausted for: dest-quota \n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u8fde\u7eed\u8c03\u7528\u4e86<code>httpbin</code>\u670d\u52a1\uff0c\u5e76\u8fd4\u56de\u4e86\u8d85\u989d\u9519\u8bef\u3002 </p> <p>\u4e0b\u9762\u5c1d\u8bd5\u8c03\u7528<code>flaskapp</code>\u670d\u52a1\uff1a </p> <pre><code>bash-4.4# for i in 'seq 10'; do  http --body http://flaskapp/env/version; done\nv2\n</code></pre> <p>\u53d1\u73b0<code>flaskapp</code>\u5e76\u672a\u53d7\u5230\u5f71\u54cd</p>"},{"location":"chap5/14Istio_Mixer2/#1-4","title":"1-4 \u6ce8\u610f\u4e8b\u9879","text":"<p>\u901a\u8fc7\u4e0a\u9762\u7684\u5c1d\u8bd5\u80af\u5b9a\u6709\u4e0d\u5c11\u8bfb\u8005\u4f1a\u60f3\uff1a\u8fd9\u592a\u590d\u6742\u4e86\u800c\u4e14\u5bf9\u8c61\u4e4b\u95f4\u7684\u5f15\u7528\u592a\u6df7\u4e71</p> <p></p> <p>\u540c\u65f6\u3001\u5bf9\u670d\u52a1\u8eab\u4efd\u7684\u7ed1\u5b9a\u5173\u7cfb\u4e5f\u6563\u4e71\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u5bf9\u8c61\u4e2d\u3002</p> <p>\u751a\u81f3\u5230\u76ee\u524d\u4e3a\u6b62<code>QuotaSpec</code>\u548c<code>QcotaSpecBinding</code>\u8fd8\u6ca1\u6709\u63d0\u4f9b<code>Reference</code>\u7b14\u8005\u63a8\u6d4b\u8fd9\u90e8\u5206\u53d1\u751f\u53d8\u5316\u7684 \u53ef\u80fd\u6027\u975e\u5e38\u5927, \u5f3a\u70c8\u5efa\u8bae\u4e0d\u8981\u91c7\u7528</p>"},{"location":"chap5/14Istio_Mixer2/#2-redisquota","title":"2\u3001 \u4f7f\u7528<code>RedisQuota</code>\u9002\u914d\u5668\u8fdb\u884c\u670d\u52a1\u9650\u6d41","text":"<p><code>MemQuota</code>\u9002\u914d\u5668\u9650\u6d41\uff0c\u662f\u4e00\u79cd\u5b9e\u9a8c\u6027\u8d28\u7684\u505a\u6cd5\uff0c\u5b83\u4ec5\u652f\u6301\u56fa\u5b9a\u7a97\u53e3\u7684\u9650\u6d41\u7b97\u6cd5\uff0c \u5e76\u4e14\u5728<code>Mixer</code>\u662f\u591a\u526f\u672c\u7684\u8fd0\u884c\u72b6\u6001\u4e0b\u5185\u5b58\u8ba1\u6570\u4f1a\u5b8c\u5168\u5931\u6548, \u5fc5\u987b\u63d0\u4f9b\u4e00\u4e2a\u72ec\u7acb\u4e8e<code>Mixer</code>\u8fdb\u7a0b\u4e4b\u5916\u7684\u540e\u7aef\u670d\u52a1\u6765\u63d0\u4f9b\u6570\u636e\u652f\u6301, \u76ee\u524d\u5b98\u65b9\u5efa\u8bae\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528<code>RedisQuota</code>\u5bf9\u8c61\u8fdb\u884c\u9650\u6d41.</p> <p>\u5176\u6574\u4f53\u73af\u8282\u548c<code>MemQuota</code>\u6d41\u7684\u6d41\u7a0b\u662f\u4e00\u81f4, \u7684\u53ea\u4e0d\u8fc7\u5176\u4e2d\u7684<code>MemQuota Handler</code>\u8981\u66f4\u6362\u4e3a<code>Redis</code>\u7248\u672c\u8fd8\u9700\u8981\u4e00\u4e2a\u7528\u4e8e\u63d0\u4f9b\u6570\u636e\u540e\u7aef\u7684<code>Redis</code>\u5e94\u7528\u3002 </p>"},{"location":"chap5/14Istio_Mixer2/#2-1-redis","title":"2-1 \u542f\u52a8<code>Redis</code>\u670d\u52a1","text":"<p>\u9996\u5148\u6211\u4eec\u505a\u4e00\u4e0b\u51c6\u5907\u5de5\u4f5c\u542f\u7528\u4e00\u4e2a<code>Redis</code>\u670d\u52a1\u5668\u6765\u652f\u6301\u9650\u6d41\u64cd\u4f5c\uff0c\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u5148\u5728<code>Kubernetes</code>\u96c6\u7fa4\u4e2d\u542f\u52a8\u4e00\u4e2a\u5355\u5b9e\u4f8b\u670d\u52a1\u6765\u5b8c\u6210\u529f\u80fd\u5c55\u793a\u3002 </p> <p>\u8fd9\u91cc\u9009\u62e9\u4f7f\u7528<code>Redis</code>\u7684\u5b98\u65b9\u955c\u50cf, \u521b\u5efa\u4e00\u4e2a\u5355\u5b9e\u4f8b\u7684<code>Deployment</code>\u548c\u5bf9\u5e94\u7684<code>Service</code>: </p> <pre><code>apiVersion: v1\nkind: ReplicationController\nmetadata:\n  name: redis\n  labels:\n    name: redis\nspec:\n  replicas: 1\n  selector:\n    name: redis\n  template:\n    metadata:\n      labels:\n        name: redis\n    spec:\n      containers:\n      - name: redis\n        image: k8s.gcr.io/redis:v1\n        ports:\n        - containerPort: 6379\n---\napiVersion: v1\nkind: Service\nmetadata:\n    name: redis\n    labels:\n      name: redis\nspec:\n  ports:\n    - port: 6379\n      targetPort: 6379\n  selector:\n    name: redis\n</code></pre> <p>\u5c06\u4e0a\u8ff0\u6587\u4ef6\u4fdd\u5b58\u4e3a<code>redis.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectl apply</code>\u547d\u4ee4\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4<code>RC</code>\u5728\u542f\u52a8\u4e4b\u540e\uff0c\u4f1a\u5728<code>6379</code>\u7aef\u53e3\u5f00\u653e\u4e00\u4e2a<code>Redis</code>\u670d\u52a1\u3002 </p>"},{"location":"chap5/14Istio_Mixer2/#2-2","title":"2-2 \u5b9a\u4e49\u9650\u6d41\u76f8\u5173\u5bf9\u8c61","text":"<p>\u4e24\u79cd\u9650\u6d41\u65b9\u5f0f\u7684\u5bf9\u8c61\u5b9a\u4e49\u683c\u5f0f\u57fa\u672c\u662f\u4e00\u81f4\u7684\uff0c\u533a\u522b\u4ec5\u5728\u4e8e<code>RedisQuota</code>\u7684\u5b9a\u4e49\u8981\u6bd4<code>MemQuota</code>\u7684\u5b9a\u4e49\u7ec6\u81f4\u4e00\u4e9b\u3002 </p> <p>\u8fd9\u91cc\u9996\u5148\u5b9a\u4e49<code>RedisQuota</code>: </p> <p><code>redisquota.yaml</code></p> <pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: redisquota \nmetadata: \n  name: handler \nspec: \n  redisServerUrl: \"10.245.90.154:6379\" \n  quotas:\n  - name: dest-quota.quota.default \n  maxAmount: 20 \n  bucketDuration: 1s \n  validDuration: 10s \n  rateLimitAlgorithm: ROLLING_WINDOW \n  overrides: \n  - dimensions: \n      destination: httpbin \n    maxAmount: 1 \n</code></pre> <pre><code>$ kubectl apply -f redisquota.yaml \nredisquota.config.istio.io/handler created\n</code></pre> <p>\u5c06\u4e0a\u8ff0\u4ee3\u7801\u4fdd\u5b58\u4e3a<code>redisquota.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectl apply</code>\u547d\u4ee4\u63d0\u4ea4\u5230\u96c6\u7fa4\u3002 </p> <ul> <li><code>redisServerUrl</code>\uff1a\u7528\u4e8e\u6307\u5b9a<code>Redis</code>\u670d\u52a1\u7684\u5730\u5740\u3002</li> <li><code>quota.bucketDuratio</code>n\uff1a\u5fc5\u987b\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5927\u4e8e\u96f6\u7684\u79d2\u6570\u3002 </li> <li><code>quota.rateLimitAlgorithm</code>\uff1a\u53ef\u4ee5\u4e3a\u6bcf\u4e2a<code>Quota</code>\u6307\u5b9a\u5404\u81ea\u7684\u9650\u6d41\u7b97\u6cd5\uff0c\u5728<code>MemQuota</code>\u4e2d\u91c7\u7528\u7684\u662f<code>FIXED_ WINDOW\u7b97</code>\u6cd5\uff0c\u4e14\u4e0d\u53ef\u66f4\u6539\u3002 </li> <li><code>overrides.validDuration</code>\uff1a\u8be5\u5b57\u6bb5\u65e0\u6cd5\u7ee7\u7eed\u4f7f\u7528\u3002 </li> </ul> <p><code>redis-rule.yaml</code></p> <pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: rule\nmetadata: \n  name: quota\nspec: \n  actions:\n  - handler: handler.redisquota\n    instances:\n      - dest-quota.quota\n</code></pre> <pre><code>$ kubectl apply -f redis-rule.yaml \nrule.config.istio.io/quota unchanged\n</code></pre> <pre><code>$ kubectl apply -f quotaspec.yaml \nquotaspec.config.istio.io/request-count created\n\n$ kubectl apply -f quotaspec-binding.yaml \nquotaspecbinding.config.istio.io/spec-sleep created\n</code></pre>"},{"location":"chap5/14Istio_Mixer2/#2-3","title":"2-3 \u6d4b\u8bd5\u9650\u6d41\u529f\u80fd","text":"<pre><code>$ kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep\nbash-4.4# for i in 'seq 10'; do  http --body http://httpbin:8000/ip; done\n\nRESOURCE_EXHAUSTED:Quota is exhausted for. dest-quota \n\n{\n    \"origin\": \"127.0.0.1\"\n}\nRESOURCE_EXHAUSTED:Quota is exhausted for. dest-quota \n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u548c<code>MemQuota</code>\u4e00\u6837\uff0c\u9650\u6d41\u5df2\u7ecf\u751f\u6548\uff0c\u8c03\u7528\u5931\u8d25\u3002 </p>"},{"location":"chap5/15Istio_Mixer3_prometheus/","title":"\u7b2c\u5341\u4e94\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528 - \u4e3aPrometheus\u5b9a\u4e49\u76d1\u63a7\u6307\u6807","text":"<p><code>Mixe</code>\uff1a\u63d0\u4f9b\u4e86\u5185\u7f6e\u7684<code>Prometheus</code>\u9002\u914d\u5668\uff0c\u8be5\u9002\u914d\u5668\u4f1a\u5f00\u653e\u670d\u52a1\u7aef\u70b9\uff0c\u4f7f\u7528\u6765\u81ea<code>metrics</code>\u6a21\u677f\u5b9e\u4f8b\u7684\u6570\u636e\u4f9b<code>Prometheus</code>\u8fdb\u884c\u6307\u6807\u6293\u53d6\uff0c\u5de5\u4f5c\u6d41\u7a0b\u5927\u81f4\u5982\u56fe</p> <p></p> <ol> <li>\u670d\u52a1\u95f4\u901a\u8fc7<code>Sidecar</code>\u96a7\u9053\u8fdb\u884c\u76f8\u4e92\u8c03\u7528\u65f6\u3002 </li> <li>\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u4f1a\u5411<code>Mixer Telemetry</code>\u670d\u52a1\u62a5\u544a\u6d41\u91cf\u4fe1\u606f\uff0c<code>Mixer Telemetry</code>\u4f1a\u6839\u636e\u6d41\u91cf\u4fe1\u606f\u5728\u6ce8\u518c\u7684<code>Rule</code>\u5bf9\u8c61\u4e2d\u67e5\u627e\u7b26\u5408\u5176<code>match</code>\u5b57\u6bb5\u7684\u5185\u5bb9\uff0c\u5982</li> <li>\u679c\u6709\u7b26\u5408\u8981\u6c42\u7684\u7ed3\u679c\uff0c\u5219\u4f1a\u4f7f\u7528\u5728<code>Rule</code>\u5bf9\u8c61\u4e2d\u6307\u5b9a\u7684<code>metrics</code>\u6a21\u677f\u5b9e\u4f8b\u5904\u7406\u6d41\u91cf\u4fe1\u606f\uff0c\u5bf9\u4e8e\u5904\u7406\u540e\u7684\u8f93\u51fa\u5185\u5bb9\uff0c</li> <li>\u7531<code>Rule</code>\u5bf9\u8c61\u4e2d\u6307\u5b9a\u7684<code>Prometheus Handler</code>\u8fdb\u884c\u8f93\u51fa </li> </ol>"},{"location":"chap5/15Istio_Mixer3_prometheus/#1","title":"1\u3001 \u9ed8\u8ba4\u76d1\u63a7\u6307\u6807","text":"<p>\u5728<code>Istio</code>\u7684\u5b89\u88c5\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230<code>Prometheus Chart</code>\u91cc<code>templates/configmap.yaml</code> \u63d0\u4f9b\u7684<code>Prometheus</code>\u914d\u7f6e\u6a21\u677f\uff0c\u5176\u4e2d\u9664\u4e86\u63d0\u4f9b\u4e86<code>Kubernetes</code>\u7684\u4efb\u52a1\uff0c\u8fd8\u63d0\u4f9b\u4e86\u51e0\u4e2a\u4e0d\u540c\u7684\u6293\u53d6\u4efb\u52a1\uff0c\u5982\u4e0b\u6240\u8ff0 </p> <ul> <li><code>istio-mesh</code>\uff1a\u4ece<code>Mixer</code>\u7684<code>telemtry</code>\u670d\u52a1\u4e2d\u6293\u53d6<code>Mixer</code>\u751f\u6210\u7684\u7f51\u683c\u6307\u6807\u3002 </li> <li><code>envoy-stats</code>\uff1a\u4ece\u7f51\u683c\u7684<code>Pod</code>\u4e2d\u6293\u53d6<code>Envoy</code>\u7684\u7edf\u8ba1\u6570\u636e\u3002 </li> <li><code>istio-policy</code>:\u4ece<code>Mixer</code>\u7684<code>policy</code>\u670d\u52a1\u4e2d\u6293\u53d6<code>Poicy</code>\u7ec4\u4ef6\u7684\u76d1\u63a7\u6307\u6807\u3002 </li> <li><code>istio-telemetry</code>\uff1a\u4ece<code>Mixer</code>\u7684<code>telemtry</code>\u670d\u52a1\u4e2d\u6293\u53d6<code>Mixer</code>\u670d\u52a1\u7684\u6307\u6807\u3002 </li> <li><code>pilot</code>: <code>Pilot</code>\u7684\u81ea\u8eab\u6307\u6807\u3002 </li> <li><code>galley</code>: <code>Galley</code>\u7ec4\u4ef6\u7684\u81ea\u8eab\u76d1\u63a7\u6307\u6807\u3002 </li> </ul> <p>\u672c\u8282\u8981\u8bb2\u7684\u81ea\u5b9a\u4e49\u6307\u6807\uff0c\u5c31\u4f1a\u88ab\u8f93\u51fa\u5230<code>istio-telernetry</code>\u4efb\u52a1\u4e2d\u3002 </p> <p>\u5728\u5b89\u88c5\u5b8c\u6bd5<code>Istio</code>\u4e4b\u540e\uff0c\u5728<code>Istio</code>\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u52a0\u4eba\u4e00\u4e9b\u521d\u59cb\u6307\u6807\uff1a </p> <pre><code>$ kubectl get metrics -n istio-system\nNAME                   AGE\nrequestcount           16d\nrequestduration        16d\nrequestsize            16d\nresponsesize           16d\ntcpbytereceived        16d\ntcpbytesent            16d\ntcpconnectionsclosed   16d\ntcpconnectionsopened   16d\n</code></pre> <p>\u4f8b\u5982<code>requestsize</code></p> <pre><code>$ kubectl get metrics -n istio-system requestsize -oyaml\napiVersion: config.istio.io/v1alpha2\nkind: metric\nmetadata:\n  annotations:\n    kubectl.kubernetes.io/last-applied-configuration: |\n    ...\n     creationTimestamp: \"2019-10-18T09:23:04Z\"\n  generation: 1\n  labels:\n    app: mixer\n    chart: mixer\n    heritage: Tiller\n    release: istio\n  name: requestsize\n  namespace: istio-system\n  resourceVersion: \"39282\"\n  selfLink: /apis/config.istio.io/v1alpha2/namespaces/istio-system/metrics/requestsize\n  uid: d090508b-a9d2-4dad-a4e1-16a3494b3de9\nspec:\n  dimensions:\n    connection_security_policy: conditional((context.reporter.kind | \"inbound\") ==\n      \"outbound\", \"unknown\", conditional(connection.mtls | false, \"mutual_tls\", \"none\"))\n    destination_app: destination.labels[\"app\"] | \"unknown\"\n    destination_principal: destination.principal | \"unknown\"\n    destination_service: destination.service.host | \"unknown\"\n    destination_service_name: destination.service.name | \"unknown\"\n    destination_service_namespace: destination.service.namespace | \"unknown\"\n    destination_version: destination.labels[\"version\"] | \"unknown\"\n    destination_workload: destination.workload.name | \"unknown\"\n    destination_workload_namespace: destination.workload.namespace | \"unknown\"\n    permissive_response_code: rbac.permissive.response_code | \"none\"\n    permissive_response_policyid: rbac.permissive.effective_policy_id | \"none\"\n    reporter: conditional((context.reporter.kind | \"inbound\") == \"outbound\", \"source\",\n      \"destination\")\n    request_protocol: api.protocol | context.protocol | \"unknown\"\n    response_code: response.code | 200\n    response_flags: context.proxy_error_code | \"-\"\n    source_app: source.labels[\"app\"] | \"unknown\"\n    source_principal: source.principal | \"unknown\"\n    source_version: source.labels[\"version\"] | \"unknown\"\n    source_workload: source.workload.name | \"unknown\"\n    source_workload_namespace: source.workload.namespace | \"unknown\"\n  monitored_resource_type: '\"UNSPECIFIED\"'\n  value: request.size | 0\n</code></pre> <p>\u8fd9\u662f\u4e2a<code>metric</code>\u6a21\u677f\u7684\u5b9e\u4f8b\uff0c\u5728<code>dimensions</code> \u5b57\u6bb5\u4f7f\u7528<code>Istio</code>\u7684\u5c5e\u6027\u8868\u8fbe\u5f0f\u4e3a\u6307\u6807\u52a0\u4eba\u5404\u79cd\u6807\u7b7e\uff0c\u5e76\u51e0\u7528<code>request.size</code>\u4f5c\u4e3a\u6307\u6807\u7684\u6570\u503c </p> <p>\u63a5\u4e0b\u6765\u81ea\u7136\u8981\u770b\u770b\u5bf9\u5e94\u7684\u9002\u914d\u5668\u914d\u7f6e</p> <pre><code>$ kubectl get handler prometheus -n istio-system -oyaml\napiVersion: config.istio.io/v1alpha2\nkind: handler\nmetadata:\n  annotations:\n  ...\n  generation: 1\n  labels:\n    app: mixer\n    chart: mixer\n    heritage: Tiller\n    release: istio\n  name: prometheus\n  namespace: istio-system\n  ...\n  params:\n    metrics:\n    - instance_name: requestcount.metric.istio-system\n      kind: COUNTER\n      label_names:\n      - reporter\n      - source_app\n      - source_principal\n      - source_workload\n      - source_workload_namespace\n      - source_version\n      ...\n</code></pre> <p>\u53ef\u4ee5\u541e\u5230\u5728\u8fd9\u4e2a\u5bf9\u8c61\u4e3a<code>Prometheus</code>\u5b9a\u4e49\u4e86\u7cfb\u5217\u7684\u76d1\u63a7\u6307\u6807\u89c4\u5219 </p> <p>\u4e09\u8981\u7d20\u4e2d\u7684\u9002\u914d\u5668\u548c\u6a21\u677f\u90fd\u9f50\u5168\u4e86\uff0c\u5c31\u53ef\u4ee5\u770b\u770b<code>rule</code>\u5bf9\u8c61\u4e86\u5728<code>Istio-system</code> \u547d\u540d\u7a7a\u95f4\uff0c \u9ed8\u8ba4\u5305\u542b\u4e24\u4e2a\u4e0e <code>Prometheus</code> \u76f8\u5173\u7684<code>Rule</code>\u5bf9\u8c61\u5206\u522b\u662f<code>promhttp</code>\u548c<code>promtcp</code> \u5b83\u4eec\u4eec\u628a\u4e24\u7c7b\u4e0d\u540c\u7684<code>metric</code>\u5b9e\u4f8b\u548c<code>Prometheus Handler</code>\u8fde\u63a5\u8d77\u6765 </p> <pre><code>$ kubectl get rules -n istio-system\nNAME                      AGE\nkubeattrgenrulerule       16d\npromhttp                  16d\npromtcp                   16d\n...\n</code></pre> <p>\u8fd9\u6837\u4e00\u6765\uff0c<code>Istio</code>\u5c31\u901a\u8fc7<code>Mixer</code> \u63d0\u4f9b\u7684\u529f\u80fd\uff0c\u518d\u7ed3\u5408<code>Prometheus</code>\u5f62\u6210\u5b8c\u6574\u7684\u6570\u636e\u636e\u91c7\u96c6\u548c\u76d1\u63a7\u529f\u80fd\uff0c\u4e5f\u4e3a\u7528\u6237\u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807\u63d0\u4f9b\u4e86\u57fa\u7840\u3002 </p>"},{"location":"chap5/15Istio_Mixer3_prometheus/#2","title":"2\u3001 \u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807","text":"<p>\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>Mixer</code>\uff1a\u9002\u914d\u5668\u7684\u914d\u7f6e\u6765\u751f\u6210\u65b0\u7684\u76d1\u63a7\u6307\u6807\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u76d1\u63a7\u6307\u6807\u3002</p> <p>\u5728\u73b0\u6709\u7684<code>requestsize</code>\u6307\u6807\u4e2d\u662f\u4e0d\u5305\u542b<code>Header</code>\u5927\u5c0f\u7684</p> <p>\u4e3a\u6b64\uff0c\u6211\u4eec\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u76d1\u63a7\u6307\u6807\u3002 \u9996\u5148\u5b9a\u4e49\u4e00\u4e2a\uff1a<code>metric</code>\u5bf9\u8c61\uff0c\u5728<code>value</code>\u5b57\u6bb5\u4f7f\u7528<code>request.total_size</code>\u6765\u83b7\u53d6<code>request</code>\u7684\u5927\u5c0f\u5e76\u52a0\u4ee5\u76d1\u63a7\uff1a </p> <pre><code>$ kubectl get metrics -n istio-system requestsize -oyaml &gt; request.totalsize.yaml\n</code></pre> <p>\u7f16\u8f91\u65b0\u751f\u6210\u7684<code>request.totalsize.yaml</code></p> <pre><code>apiVersion: config.istio.io/v1alpha2\nkind: metric\nmetadata:\n  annotations:\n  ...\n  name: requesttotalsize\n  namespace: istio-system\n  ...\nspec:\n  dimensions:\n  ...\n  value: request.total_size | 0\n</code></pre> <pre><code>$ kubectl apply -f request.totalsize.yaml \nmetric.config.istio.io/requesttotalsize created\n</code></pre> <p>\u63a5\u4e0b\u6765\u4fee\u6539<code>Prometheus Handler</code>\u7684\u5b9a\u4e49\uff0c \u8ba9<code>Handler</code>\u5bf9\u8c61\u5904\u7406\u65b0\u5efa\u7684\u6307\u6807</p> <pre><code>$ kubectl get  handler prometheus -n istio-system -oyaml &gt; prometheus_handler.yaml\n...\n- buckets:\n        exponentialBuckets:\n          growthFactor: 10\n          numFiniteBuckets: 8\n          scale: 1\n      instance_name: requesttotalsize.metric.istio-system\n      kind: DISTRIBUTION\n      label_names:\n      - reporter\n      - source_app\n      - source_principal\n      - source_workload\n      - source_workload_namespace\n      - source_version\n      - destination_app\n      - destination_principal\n      - destination_workload\n      - destination_workload_namespace\n      - destination_version\n      - destination_service\n      - destination_service_name\n      - destination_service_namespace\n      - request_protocol\n      - response_code\n      - response_flags\n      - permissive_response_code\n      - permissive_response_policyid\n      - connection_security_policy\n      name: request__total_bytes\n</code></pre> <pre><code>$ kubectl apply -f prometheus_handler.yaml\nhandler.config.istio.io/prometheus configured\n</code></pre> <p>\u5728\u7f16\u8f91\u7ed3\u675f\u4e4b\u540e\uff0c\u518d\u4f7f\u7528<code>kubectl edit</code>\u547d\u4ee4\u4fee\u6539\u7cfb\u7edf\u539f\u6709\u7684<code>Rule</code>\u5bf9\u8c61\uff08<code>promhttp</code>), </p> <pre><code>$ kubectl edit rule promhttp -n istio-s\nystem\nrule.config.istio.io/promhttp edited\n</code></pre> <pre><code>apiVersion: config.istio.io/v1alpha2\nkind: rule\nmetadata:\n  annotations:\n...\n    name: promhttp\n  namespace: istio-system\n  resourceVersion: \"39293\"\nspec:\n  actions:\n  - handler: prometheus\n    instances:\n    - requestcount.metric\n    - requestduration.metric\n    - requestsize.metric\n    - responsesize.metric\n    - requesttotalsize.metric\n    ...\n</code></pre> <p>\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u4f7f\u7528<code>sleep Pod</code>\u4e2d\u7684\u8f93\u51fa\u6d41\u91cf\uff1a<code>wrk</code>\u5de5\u5177\u53d1\u8d77\u5bf9<code>httpbin</code>\u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4ee5\u4fbf\u8f93\u51fa\u6d41\u91cf</p> <pre><code>$ kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep\nbash-4.4# wrk http://httpbin:8000/ip\nRunning 10s test @ http://httpbin:8000/ip\n  2 threads and 10 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency    12.44ms    7.56ms  58.04ms   78.43%\n    Req/Sec   416.38     95.33   696.00     65.66%\n  8310 requests in 10.04s, 2.04MB read\nRequests/sec:    827.42\nTransfer/sec:    207.95KB\n</code></pre> <p>\u8fd9\u6837\u5c31\u751f\u6210\u4e86\u6d41\u91cf\u3002 </p> <p>\u63a5\u7740\u8bbf\u95ee<code>Prometheus</code>\u7684\u67e5\u8be2\u754c\u9762\uff0c\u8f93\u4eba\u6211\u4eec\u65b0\u5efa\u7684\u6307\u6807\uff0c\u5c31\u80fd\u770b\u5230\u6307\u6807\u6570\u636e\u4e86\uff08\u6307\u6807\u540d\u79f0\u4f1a\u81ea\u52a8\u52a0\u4eba\u201cistio_\u201d\u524d\u7f00\uff09</p> <p>\u4e8b\u5b9e\u4e0a\uff0c\u76ee\u524d\u8fd9\u65b9\u9762\u80fd\u591f\u5b9a\u5236\u7684\u5185\u5bb9\u8fd8\u5f88\u6709\u9650\uff0c\u4e3b\u8981\u7684\u5b9a\u5236\u80fd\u529b\u53d6\u51b3\u4e8e<code>Envoy</code>\u548c\u5404\u79cd<code>Mixer</code>\u9002\u914d\u5668\u7684\u8f93\u51fa\u5185\u5bb9\u3002 </p> <pre><code>kubectl -n istio-system port-forward prometheus-d44645598-xh8wn 9090:9090\nForwarding from 127.0.0.1:9090 -&gt; 9090\nForwarding from [::1]:9090 -&gt; 9090\n</code></pre> <p><code>istio_request_total_bytes_bucket</code></p> <p></p>"},{"location":"chap5/16Istio_Mixer4_stdio/","title":"\u7b2c\u5341\u516d\u8282 \u4f7f\u7528<code>stdio</code>\u8f93\u51fa\u81ea\u5b9a\u4e49\u65e5\u5fd7","text":"<p>\u5e73\u53f0\u53ca\u8fd0\u884c\u5728\u5e73\u53f0\u4e4b\u4e0a\u7684\u5e94\u7528\u90fd\u4f1a\u6709\u5404\u81ea\u7684\u65e5\u5fd7\u8f93\u51fa, \u4f8b\u5982\uff0c<code>Kubernetes</code>\u4e2d\u5e38\u89c1\u7684\u4e00\u79cd\u65b9\u6848\u5982\u56fe\u6240\u793a\u3002 </p> <p></p> <p>\u5176\u4e2d</p> <ul> <li>\u4e1a\u52a1\u5e94\u7528\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230\u5bb9\u5668\u81ea\u8eab\u7684<code>stdio</code>\u8bbe\u5907\u4e0a\uff1b </li> <li>\u5bb9\u5668\u5f15\u64ce\u5c06<code>Pod</code>\u7684<code>stdio</code>\u6620\u5c04\u5230\u6240\u5728\u8282\u70b9\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff1b </li> <li><code>Fluentd</code>\u7b49\u65e5\u5fd7\u6293\u53d6\u5de5\u5177<code>mount</code>\u7684\u65b9\u5f0f\u52a0\u8f7d\u8282\u70b9\u6587\u4ef6\u7cfb\u7edf\uff1b </li> <li>\u65e5\u5fd7\u6293\u53d6\u5de5\u5177\u5728\u5904\u7406\u539f\u59cb\u65e5\u5fd7\u4e4b\u540e\u5c06\u5176\u53d1\u9001\u7ed9<code>Elasticsearch</code></li> </ul> <p>\u90a3\u4e48\uff0c\u4e3a\u4ec0\u4e48<code>Mixer</code>\uff1a\u8fd8\u8981\u63d0\u4f9b\u989d\u5916\u7684\u65e5\u5fd7\u80fd\u529b\uff1f</p> <p>\u6709\u65f6\u6211\u4eec\u53ef\u80fd\u9700\u8981\u6839\u636e\u901a\u4fe1\u5185\u5bb9\u505a\u4e00\u4e9b\u8de8\u670d\u52a1\u7684\u65e5\u5fd7\u8bb0\u5f55\uff0c\u8fd9\u79cd\u9700\u6c42\u53ef\u80fd\u662f\u4e34\u63d0\u51fa\u7684\uff0c\u4e5f\u53ef\u80fd\u662f\u8c03\u8bd5\u9700\u8981\u7684\uff0c\u8fc7\u53bb\u5f80\u5f80\u9700\u8981\u901a\u8fc7\u5bf9\u5e94\u7528\u7684\u4ee3\u7801\u8fdb\u884c\u4fee\u6539\u6216\u8005\u91cd\u65b0\u914d\u7f6e\u6765\u5b8c\u6210\uff1b</p> <p>\u800c<code>Istio</code>\u53ef\u4ee5\u5728\u4e0d\u5f71\u54cd\u5e94\u7528\u8fd0\u884c\u7684\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7<code>Mixer</code>\u7ec4\u4ef6\uff0e\u4f7f\u7528<code>logentry</code>\u6a21\u677f\u7ed3\u5408<code>std io</code>\u6216\u8005<code>Fluentd</code>\u9002\u914d\u5668\u6765\u5b8c\u6210\u8fd9\u4e00\u4efb\u52a1</p> <p></p> <ol> <li>\u7f51\u683c\u5185\u90e8\u7684\u5e94\u7528\u5728\u901a\u8fc7<code>Sidecar</code>\u8fdb\u884c\u4e92\u8bbf\u7684\u65f6\u5019, <code>Sidecar</code>\u4f1a\u53d1\u51fa\u62a5\u544a\u7ed9<code>Mixer Telemetry</code>,\u5176\u4e2d\u5305\u542b\u5927\u91cf\u7684\u4e0e\u672c\u6b21\u901a\u4fe1\u76f8\u5173\u7684\u4fe1\u606f\u3002</li> <li><code>Mixer Telemetry Pod</code>\u5728\u63a5\u6536\u5230\u8fd9\u4e9b\u4fe1\u606f\u4e4b\u540e\uff0c\u4f1a\u67e5\u8be2\u5df2\u6ce8\u518c\u7684<code>Rule</code>\u5bf9\u8c61\uff0c\u5982\u679c\u6709\u7b26\u5408<code>match</code>\u8981\u6c42\u7684\u6d41\u91cf\uff0e\u5219\u4f1a\u5c06\u6d41\u91cf\u4fe1\u606f\u8f6c\u53d1\u7ed9<code>Rule</code>\u5bf9\u8c61\u7684<code>logentry Instance</code>\u8fdb\u884c\u5904\u7406</li> <li>\u5904\u7406\u540e\u4ea7\u751f\u7684\u6807\u51c6\u6570\u636e\u4f1a \u4ea4\u7531<code>stdio</code>\u9002\u914d\u5668\u76f4\u63a5\u663e\u793a\u5728<code>Mixer Telemetry</code>\u7684<code>stdio</code>\u8bbe\u5907\u4e0a\uff0c\u53ef\u4ee5\u88ab<code>Kebernetes</code>\u7684\u6807\u51c6\u65e5\u5fd7\u91c7\u96c6\u65b9\u5f0f\u6240\u83b7\u53d6\uff0c</li> <li>\u6216\u8005\u7531<code>Fluentd</code>\u9002\u914d\u5668\u63d0\u4ea4\u7ed9<code>Flutend</code>\u8fdb\u7a0b\u8fdb\u884c\u540e\u7eed\u7684\u91c7\u96c6\u8fc7\u7a0b </li> </ol>"},{"location":"chap5/16Istio_Mixer4_stdio/#1","title":"1\u3001\u9ed8\u8ba4\u7684\u8bbf\u95ee\u65e5\u5fd7","text":"<p><code>istio</code>\u9ed8\u8ba4\u5728\u5b89\u88c5\u65f6\u63d0\u4f9b<code>accesslog</code>\u548c<code>tcpaccesslog</code>\u4e24\u4e2a<code>logentry</code>\u5b9e\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf<code>accesslog</code>\u7684\u914d\u7f6e\u65b9\u6cd5\uff1a </p> <pre><code>$ kubectl get logentry -n istio-system\nNAME           SEVERITY   TIMESTAMP                                         RES TYPE   AGE\naccesslog      \"Info\"     request.time                                      \"global\"   16d\ntcpaccesslog   \"Info\"     context.time |timestamp(\"2017-01-01T00:00:00Z\")   \"global\"   16d\n</code></pre> <pre><code>$ kubectl get logentry -n istio-system accesslog -oyaml\n\napiVersion: config.istio.io/v1alpha2\nkind: logentry\nmetadata:\n  annotations:\n  ...\n  name: accesslog\n  namespace: istio-system\n  ...\nspec:\n  monitored_resource_type: '\"global\"'\n  severity: '\"Info\"'\n  timestamp: request.time\n  variables:\n      apiClaims: request.auth.raw_claims | \"\"\n    apiKey: request.api_key | request.headers[\"x-api-key\"] | \"\"\n    clientTraceId: request.headers[\"x-client-trace-id\"] | \"\n    ...\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbf\u95ee\u65e5\u5fd7\u7684\u7ed3\u6784\uff0c\u5176\u4e2d\u9664\u4e86\u5e38\u89c1\u7684\u65e5\u5fd7\u7ea7\u522b\u3001\u65f6\u95f4\u6233\uff0c\u8fd8\u7528<code>variables</code>\u5b57\u6bb5\u5b9a\u4e49\u4e86\u4e00\u7ec4\u590d\u6742\u7684\u6570\u636e\u7ed3\u6784\u3002 </p> <p>\u518d\u6765\u770b\u770b<code>stdio</code>\u7684\u9002\u914d\u5668\u914d\u7f6e\uff1a </p> <pre><code>$ kubectl get handler stdio  -n istio-system -oyaml\napiVersion: config.istio.io/v1alpha2\nkind: handler\nmetadata:\n  annotations:\n  ...\n  creationTimestamp: \"2019-10-18T09:23:04Z\"\n  generation: 1\n  labels:\n    app: mixer\n    chart: mixer\n    heritage: Tiller\n    release: istio\n  name: stdio\n  namespace: istio-system\n  resourceVersion: \"39273\"\n  selfLink: /apis/config.istio.io/v1alpha2/namespaces/istio-system/handlers/stdio\n  uid: 2a398bff-838d-44c1-9bfa-248b68a46033\nspec:\n  compiledAdapter: stdio\n  params:\n    outputAsJson: true\n</code></pre> <pre><code>$ kubectl get rule  stdio  -n istio-system -oyaml\napiVersion: config.istio.io/v1alpha2\nkind: rule\nmetadata:\n  annotations:\n  ...\n  creationTimestamp: \"2019-10-18T09:23:04Z\"\n  generation: 1\n  labels:\n    app: mixer\n    chart: mixer\n    heritage: Tiller\n    release: istio\n  name: stdio\n  namespace: istio-system\n  resourceVersion: \"39277\"\n  selfLink: /apis/config.istio.io/v1alpha2/namespaces/istio-system/rules/stdio\n  uid: c3236133-8dfa-46c8-a9d4-e5d1b060ed52\nspec:\n  actions:\n  - handler: stdio\n    instances:\n    - accesslog.logentry\n  match: context.protocol == \"http\" || context.protocol == \"grpc\"\n</code></pre> <p>\u8fd9\u4e2a\u5bf9\u8c61\u4f7f\u7528\u901a\u4fe1\u534f\u8bae\u4f5c\u4e3a\u8fc7\u6ee4\u6807\u51c6\uff0c\u5982\u679c\u901a\u4fe1\u534f\u8bae\u662f<code>HTTP</code>\u6216\u8005<code>GRPC</code>\uff0c\u5219\u4f7f\u7528<code>accesslog</code>\u8fdb\u884c\u5904\u7406\uff0c\u6700\u540e\u4f20\u9012\u7ed9<code>stdio</code>\u9002\u914d\u5668\uff0c\u5e76\u8f93\u51fa\u5230<code>Mixer</code>\u7684<code>stdio</code>\u8bbe\u5907\u4e2d\u3002 </p>"},{"location":"chap5/16Istio_Mixer4_stdio/#2","title":"2\u3001 \u5b9a\u4e49\u65e5\u5fd7\u5bf9\u8c61","text":"<p>\u6709\u4e86\u81ea\u5b9a\u4e49\u65e5\u5fd7\u6761\u76ee\u7684\u80fd\u529b\u6211\u4eec\u5c31\u53ef\u4ee5\u4e13\u95e8\u4e3a<code>sleep</code>\u670d\u52a1\u5bf9\u5176\u4ed6\u670d\u52a1\u7684\u8bbf\u95ee\u8bbe\u7f6e\u4e00\u6761\u65e5\u5fd7, \u8bb0\u5f55\u5176\u6240\u6709\u5916\u53d1\u8bf7\u6c42</p> <p>\u9996\u5148\u5b9a\u4e49\u4e00\u4e2a<code>logentry</code>\u6a21\u677f\u7684\u5b9e\u4f8b </p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: logentry\nmetadata: \n  name: sleep-log \nspec:\n  monitored_resource_type: '\"global\"' \n  severity: '\"Info\"'\n  timestamp: \"request.time\" \n  variables: \n    destinationApp: destination.labels[\"app\"] | \"\" \n    dentinationIp: destination.ip | ip(\"0.0.0.0\") \n    destinationName: destination.name | \"\" \n    destinationNamespace: destination.namespace | \"\"\n    destinationWorkload: destination.workload.name | \"\" \n    message: \"Extra log\" \n</code></pre> <pre><code>$ kubectl apply -f logentry.yaml \nlogentry.config.istio.io/sleep-log created\n\n\n$ kubectl get logentry\nNAME        SEVERITY   TIMESTAMP      RES TYPE   AGE\nsleep-log   \"Info\"     request.time   \"global\"   10s\n</code></pre> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a<code>longentry</code>\u5bf9\u8c61\u5176\u4e2d\u63cf\u8ff0\u7684\u662f\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\uff0c\u5305\u542b\u4e86\u8c03\u7528\u65f6\u95f4\uff0c\u65e5\u5fd7\u7ea7\u522b\u53ca\u4e00\u7cfb\u5217\u76ee\u6807\u4fe1\u606f\u7684\u76f8\u5173\u53d8\u91cf\u5c06\u5176\u4fdd\u5b58\u4e3a<code>logentry.yaml</code>\u4e95\u63d0\u4ea4\u5230 <code>Kubernetes</code>\u96c6\u7fa4</p> <p>\u7136\u540e\u5b9a\u4e49\u4e00\u4e2a<code>stdio</code>\u9002\u914d\u5668\u7684<code>Handler</code>\u6307\u5b9a<code>JSON</code>\u683c\u5f0f\u8f93\u51fa </p> <pre><code>apiVersion: config.istio.io/v1alpha2\nkind: stdio\nmetadata:\n  name: handler\nspec:\n  outputAsJson: true\n</code></pre> <p><code>handler.yaml</code></p> <pre><code>kubectl apply -f handler.yaml \nhandler.config.istio.io/handler created\n\n$ kubectl get handler\nNAME      AGE\nhandler   11s\n</code></pre> <p>\u6700\u540e\u5b9a\u4e49\u4e00\u4e2a<code>Rule</code>\u5bf9\u8c61\uff0c\u52a0\u5165\u5bf9<code>sleep</code>\u5e94\u7528\u7684\u6761\u4ef6\u9650\u5236\uff0c\u5e76\u628a\u65b0\u5efa\u7acb\u7684<code>Handler</code> \u548c<code>Instance</code>\u8fdb\u884c\u7ed1\u5b9a\uff1a </p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: rule \nmetadata: \n  name: stdio \nspec: \n  actions:\n  - handler: handler.stdio \n    instances: \n    - sleep-log.logentry\n  match: context.protocol == \"http\" &amp;&amp; sourceLabel[\"app\"] == \"sleep\" \n</code></pre> <pre><code>$ kubectl apply -f rule.yaml \nrule.config.istio.io/stdio created\n\n$ kubectl get rule \nNAME    AGE\nquota   21h\nstdio   18s\n</code></pre>"},{"location":"chap5/16Istio_Mixer4_stdio/#3","title":"3\u3001 \u6d4b\u8bd5\u8f93\u51fa","text":"<p>\u63a5\u4e0b\u6765\u9a8c\u8bc1\u65e5\u5fd7\u662f\u5426\u80fd\u591f\u6210\u529f\u8f93\u51fa\uff1a </p>"},{"location":"chap5/16Istio_Mixer4_stdio/#3-1-source-sleep-v1","title":"3-1 Source <code>sleep-v1</code>:","text":"<pre><code>kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep\nbash-4.4#  wrk http://httpbin:8000/ip\nRunning 10s test @ http://httpbin:8000/ip\n  2 threads and 10 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency    12.66ms    8.37ms  63.15ms   80.17%\n    Req/Sec   416.32     96.02   653.00     71.72%\n  8324 requests in 10.06s, 2.04MB read\nRequests/sec:    827.12\nTransfer/sec:    207.86KB\n</code></pre> <p>\u4f7f\u7528<code>grep</code>\u8fc7\u6ee4\uff0c\u67e5\u770b <code>itsio-telemetry</code>\u4e2d\u7684\u65e5\u5fd7\uff1a </p>"},{"location":"chap5/16Istio_Mixer4_stdio/#3-2-destination-itsio-telemetry","title":"3-2 Destination <code>itsio-telemetry</code>:","text":"<pre><code>$ kubectl get pod -n istio-system | grep istio-telemetry\nistio-telemetry-7d7845478d-d2h5f           2/2     Running     1          5d1h\n\n$ kubectl logs -n  istio-system istio-telemetry-7d7845478d-d2h5f -c mixer | grep sleep-log\n...... \n{\"level\" : \"info\", \"time\" : \"2018-12-23T19:05: 06.897249Z\", \"instance\":\"sleep -log.logentry.default\", \"destinationApp\":\"httpbin\", \"destinationIp\" : \"10.244.4 7,9\", \"destinationName\" :\"httpbin-f455f64c4-k4c6x\", \"destinationNamespace\" : \"default\", \"destinationWorkload\" : \"httpbin\" \n} \n{\"level\" : \"info\", \"time\" : \"2018-12-23T19:05:06.898289Z\", \"instance\" : \"sleep \n-log. logentry . default\" \"destinationApp\" : \"httpbin\", \"destinationIp\" : \"10.244.4 7.9\", \"destinationName\" .\"httpbin-f455f64c4-k4c6x\", \"destinationNamespace\" : \"de fault\", \"destinationWorkload\" : \"httpbin\"} \n...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u65e5\u5fd7\u5728<code>Mixer telemetry Po</code>d\u4e2d\u6309\u7167\u6211\u4eec\u5b9a\u4e49\u7684\u6a21\u677f\u5b8c\u6210\u4e86\u8f93\u51fa\u3002\u5982\u679c\u5728\u96c6\u7fa4\u4e2d\u914d\u7f6e\u4e86\u5bb9\u5668\u65e5\u5fd7\u91c7\u96c6\uff0c\u5219\u8fd9\u90e8\u5206\u65e5\u5fd7\u4e5f\u4f1a\u88ab\u8bc6\u522b\u548c\u91c7\u96c6\u3002 </p>"},{"location":"chap5/17Istio_Mixer5_fluentd/","title":"\u7b2c\u5341\u4e03\u8282 \u4f7f\u7528Fluentd\u8f93\u51fa\u65e5\u5fd7","text":"<p>\u5411<code>Mixer Telemetry</code>\u7684<code>stdio</code>\u8f93\u51fa\u65e5\u5fd7\u7684\u65b9\u6cd5\uff0c\u7136\u800c<code>Mixer</code>\u672c\u8eab\u5df2\u7ecf\u662f\u4e2a\u91cd\u8d1f\u8f7d\u7ec4\u4ef6\uff0c\u5982\u679c\u65e5\u5fd7\u8f93\u51fa\u91cf\u8f83\u5927\uff0c\u5219\u4f1a\u9020\u6210\u5927\u91cf\u7684<code>I/O</code>\u8d1f\u8f7d\u3002\u56e0\u6b64\uff0c\u5c06\u8f93\u51fa\u65e5\u5fd7\u7684\u5de5\u4f5c\u4ea4\u7ed9<code>Fluentd</code>\u53ef\u80fd\u662f\u4e2a\u66f4\u597d\u7684\u9009\u62e9\u3002 </p> <p>\u8fd9\u91cc\u505a\u4e00\u4e2a\u7b80\u5355\u7684<code>Fluentd</code>\u7684<code>Deployment</code>\u548c<code>Service</code>\u90e8\u7f72\uff0c\u5c1d\u8bd5\u5c06\u81ea\u5b9a\u4e49\u65e5\u5fd7\u8f93\u51fa\u5230<code>Fluentd</code>\u4e2d\u3002 </p>"},{"location":"chap5/17Istio_Mixer5_fluentd/#1-fluentd","title":"1\u3001 \u90e8\u7f72<code>Fluentd</code>","text":"<p>\u9996\u5148\u521b\u5efa<code>Fluentd</code>\u7684<code>Deployment</code>\u548c<code>Service</code>\uff0c\u7528\u4e8e\u63a5\u6536\u65e5\u5fd7\uff1a </p> <pre><code># Fluentd Service\napiVersion: v1\nkind: Service\nmetadata:\n  name: fluentd-listener\n  labels:\n    app: fluentd-listener\nspec:\n  ports:\n  - name: fluentd-tcp\n    port: 24224\n    protocol: TCP\n    targetPort: 24224\n  - name: fluentd-udp\n    port: 24224\n    protocol: UDP\n    targetPort: 24224\n  selector:\n    app: fluentd-listener\n---\n# Fluentd Deployment\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: fluentd-listener\n  labels:\n    app: fluentd-listener\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: fluentd-listener\n  template:\n    metadata:\n      labels:\n        app: fluentd-listener\n      annotations:\n        sidecar.istio.io/inject: \"false\"\n    spec:\n      containers:\n      - name: fluentd-listener\n        image: rocklviv/fluentd\n</code></pre> <pre><code>$ kubectl get pod | grep fluentd\nfluentd-listener-76dcb45f49-74pqz   1/1     Running            0          63s\n</code></pre>"},{"location":"chap5/17Istio_Mixer5_fluentd/#handler","title":"handler","text":"<pre><code>apiVersion: config.istio.io/v1alpha2\nkind: fluentd\nmetadata:\n  name: handler\nspec:\n  address: \"fluentd-listener:24224\"\n</code></pre> <pre><code>$ kubectl apply -f fluentd.handler.yaml\nfluentd.config.istio.io/handler created\n</code></pre> <p>\u5c06\u4fdd\u5b58\u4e3a<code>fluentd.handler.yaml</code>\uff0c\u5e76\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\u3002 </p> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u9002\u914d\u5668\u7684\u914d\u7f6e\u5f88\u7b80\u5355\uff0c \u53ea\u8981\u6307\u5b9a\u4e00\u4e2a\u5730\u5740\u5373\u53ef\uff0c\u8fd9\u91cc\u4f7f\u7528\u4e86\u6211\u4eec </p> <p>\u7136\u540e\u76f4\u63a5\u4f7f\u7528\u5728\u4e0a\u4e00\u8282\u4e2d\u5b9a\u4e49\u7684<code>logentry.yaml</code></p> <pre><code>$ kubectl apply -f logentry.yaml \nlogentry.config.istio.io/sleep-log created\n</code></pre> <p>\u6700\u540e\u4f7f\u7528<code>Rule</code>\u5bf9\u8c61\u5c06<code>handler</code>\u548c<code>sleep-log</code>\u4e24\u4e2a\u5bf9\u8c61\u8fde\u63a5\u8d77\u6765\uff1a </p> <pre><code>apiVersion: config.istio.io/v1alpha2 \nkind: rule \nmetadata: \n  name: fluentd\nspec: \n  actions:\n  - handler: handler.fluentd \n    instances: \n    - sleep-log.logentry\n  match: context.protocol == \"http\" &amp;&amp; sourceLabel[\"app\"] == \"sleep\" \n</code></pre> <p><code>fluentd-rule.yaml</code></p> <pre><code>$ kubectl apply -f fluentd-rule.yaml \nrule.config.istio.io/fluentd created\n</code></pre>"},{"location":"chap5/17Istio_Mixer5_fluentd/#2","title":"2\u3001 \u6d4b\u8bd5\u8f93\u51fa","text":"<p>\u63a5\u4e0b\u6765\u9a8c\u8bc1\u65e5\u5fd7\u662f\u5426\u80fd\u591f\u6210\u529f\u8f93\u51fa\uff1a </p>"},{"location":"chap5/17Istio_Mixer5_fluentd/#2-1-source-sleep-v1","title":"2-1 Source <code>sleep-v1</code>:","text":"<pre><code>kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep\nbash-4.4# http --body http://httpbin:8000/ip\n{\n    \"origin\": \"127.0.0.1\"\n}\n</code></pre> <p>\u8fd9\u91cc\u5728<code>sleep Pod</code>\u4e2d\u53d1\u51fa<code>HTT</code>P\u8bf7\u6c42\uff0c\u8be5\u901a\u4fe1\u7b26\u5408<code>Rule</code>\u5bf9\u8c61\u7684\u8981\u6c42\uff0c\u5e94\u8be5\u51fa\u73b0\u5728\u65e5\u5fd7\u4e2d\u3002 </p> <p>\u63a5\u4e0b\u6765\u67e5\u770b<code>Fluentd Pod</code>\u4e2d\u7684\u8f93\u51fa\uff1a </p> <pre><code>$ kuebctl logs fluentd-listener-76dcb45f49-74pqz \n...\n1 2018-12-27 19:54:44.000000000 +0000 sleep-log.logentry.default: {\"severity\":\"info\",\"destinationName\":\"httpbin-7d67ccc9b-sdp8n\",\"destinatio Namespace\":\"default\",\"destinationWorkload\":\"httpbin\",\"destinationApp\":\"htt bin\",\"destinationIp\":[0,0,0,0,0,0,0,0,0,0,255,255,10,244,30,9]} \n</code></pre> <p>\u53ef\u4ee5\u770b\u5230, <code>Fluentd</code>\u6210\u529f\u63a5\u6536\u5230\u4e86\u65e5\u5fd7\u5185\u5bb9\uff0c\u5176\u4e2d\u7684\u5185\u5bb9\u4e5f\u7b26\u5408\u6211\u4eec\u5bf9<code>logentry</code>\u5bf9\u8c61\u7684\u5b9a\u4e49, \u6240\u4ee5\uff0c\u4f7f\u7528<code>Fluentd</code>\u4ee3\u66ff<code>Mixer Telementry</code>\u8fdb\u884c\u65e5\u5fd7\u91c7\u96c6\u662f\u5b8c\u5168\u53ef\u884c\u7684</p>"},{"location":"chap5/18Istio_Sec1/","title":"\u7b2c\u5341\u516b\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa\uff08\u542f\u7528mTLS\\\u52a0\u56fa\u6982\u8ff0)","text":"<p><code>Istio</code>\u4e3a\u8fd0\u884c\u5728\u4e0d\u53ef\u4fe1\u73af\u5883\u5185\u7684\u670d\u52a1\u7f51\u683c\u63d0\u4f9b\u65e0\u987b\u4ee3\u7801\u4fb5\u5165\u7684\u5b89\u5168\u52a0\u56fa\u80fd\u529b\u3002  </p> <p>\u5728\u5b8c\u6210\u5fae\u670d\u52a1\u6539\u9002\u4e4b\u540e\uff0c\u5728\u6d41\u91cf\u3001\u76d1\u63a7\u7b49\u57fa\u672c\u4e1a\u52a1\u76ee\u6807\u4e4b\u5916\uff0c\u5b89\u5168\u95ee\u9898\u4f1a\u9010\u6e10\u51f8\u663e</p> <p>\u539f\u672c\u5728\u5355\u4f53\u5e94\u7528\u5185\u901a\u8fc7\u8fdb\u7a0b\u5185\u8bbf\u95ee\u63a7\u5236\u63a7\u5236\u6846\u67b6\u5b8c\u6210\u7684\u4efb\u52a1\uff0c\u88ab\u5206\u6563\u5230\u5404\u4e2a\u5fae\u670d\u52a1\u4e2d</p> <p>\u5728\u5bb9\u5668\u96c6\u7fa4\u4e2d\u8fd8\u53ef\u80fd\u51fa\u73b0\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u53ca\u4e0d\u540c\u4e1a\u52a1\u57df\u7684\u8bbf\u95ee\u95ee\u9898</p> <p>\u5728<code>Istio</code>\u4e2d\u4e5f\u63d0\u4f9b\u4e86\u65e0\u4fb5\u5165\u7684\u5b89\u5168\u89e3\u51b3\u65b9\u6848\uff0c\u80fd\u591f\u63d0\u4f9b\u7f51\u683c\u5185\u90e8\u3001\u7f51\u683c\u548c\u8fb9\u7f18\u4e4b\u95f4\u7684\u5b89\u5168\u901a\u4fe1\u548c\u8bbf\u95ee\u63a7\u5236\u80fd\u529b\u3002 </p>"},{"location":"chap5/18Istio_Sec1/#1istio","title":"1\u3001Istio\u5b89\u5168\u52a0\u56fa\u6982\u8ff0","text":"<p>\u5b89\u5168\u52a0\u56fa\u80fd\u529b\u662f<code>Istio</code>\u5404\u4e2a\u7ec4\u4ef6\u534f\u4f5c\u5b8c\u6210\u7684\uff0c\u5982\u4e0b\u6240\u8ff0\uff1a </p> <ul> <li><code>Citadel</code>\u63d0\u4f9b\u8bc1\u4e66\u548c\u8ba4\u8bc1\u7ba1\u7406\u529f\u80fd </li> <li><code>Sidecar</code>\u5efa\u7acb\u52a0\u5bc6\u901a\u9053\uff0c\u4e3a\u5176\u4ee3\u7406\u7684\u5e94\u7528\u8fdb\u884c\u534f\u8bae\u5347\u7ea7\uff0c\u4e3a\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4e4b\u95f4\u63d0\u4f9b\u57fa\u4e8e<code>mTLS</code>\u7684\u52a0\u5bc6\u901a\u4fe1\uff1b </li> <li><code>Pilot</code>\u8d1f\u8d23\u4f20\u64ad\u52a0\u5bc6\u8eab\u4efd\u548c\u8ba4\u8bc1\u7b56\u7565\u3002 </li> </ul> <p>\u603b\u4f53\u7684\u534f\u4f5c\u5173\u7cfb\u5927\u81f4\u5982\u56fe</p> <p></p> <p>\u5176\u4e2d\uff1a </p> <ul> <li><code>Citadel</code>\u4f1a\u76d1\u63a7<code>Kubernetes API Server</code>\uff0c\u4e3a\u73b0\u5b58\u548c\u65b0\u5efa\u7684<code>Service Account</code>\u7b7e\u53d1 \u8bc1\u4e66\uff0c\u5e76\u5c06\u5176\u4fdd\u5b58\u5728<code>Secret</code>\u4e2d\uff0c\u5728<code>Pod</code>\u542f\u52a8\u52a0\u8f7d\u65f6\u4f1a\u52a0\u8f7d\u8fd9\u4e9b<code>Secret</code>;</li> <li><code>Pilot</code>\u4f1a\u5c06\u8ba4\u8bc1\u76f8\u5173\u7684\u7b56\u7565\u53d1\u9001\u7ed9<code>Sidecar</code>\uff0c\u5e76\u4e14\u7528\u76ee\u6807\u89c4\u5219\u6765\u4fdd\u969c\u5b9e\u65bd\u8fc7\u7a0b\uff1b </li> <li>\u4e1a\u52a1\u5bb9\u5668\u548c<code>Sidecar</code>\uff1a\u4e4b\u95f4\u7684\u660e\u6587\u901a\u4fe1\u4f1a\u88ab\u5347\u7ea7\u4e3a<code>Sidecar</code>\u4e4b\u95f4\u7684<code>mTLS</code>\u901a\u4fe1\u3002 </li> </ul> <p>\u672c\u7ae0\u540c\u6837\u4f1a\u9009\u62e9\u4e24\u4e2a\u5178\u578b\u573a\u666f\u6765\u5c55\u793a<code>Istio</code>\u7684\u5b89\u5168\u52a0\u56fa\u80fd\u529b\u3002 </p>"},{"location":"chap5/18Istio_Sec1/#2mtls","title":"2\u3001\u542f\u7528mTLS","text":"<p>\u9996\u5148\u542f\u7528\u5168\u5c40<code>mTLS</code>\u6765\u67e5\u770b\u6548\u679c\u3002 \u521b\u5efa\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u5206\u522b\u5c06\u5176\u547d\u540d\u4e3a<code>mesh</code>\u548c<code>plain</code>\uff0c\u5e76\u4e14\u4e3a<code>mesh</code>\u547d\u540d\u7a7a\u95f4\u5f00\u542f </p> <p><code>Istio sidecar</code>\u81ea\u52a8\u6ce8\u5165\u529f\u80fd\uff1a </p> <pre><code>$ kubectl create ns mesh\nnamespace/mesh created\n\n$ kubectl create ns plain\nnamespace/plain created\n\n$ kubectl label namespace mesh istio-injection=enabled\nnamespace/mesh labeled\n</code></pre> <p>\u63a5\u4e0b\u6765\u5206\u522b\u5728\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u6211\u4eec\u7684<code>Sleep</code>\u548c<code>httpbin</code>\u5e94\u7528 </p> <pre><code>$ kubectl apply -f sleep.istio.yaml -n mesh\nservice/sleep created\ndeployment.extensions/sleep-v1 created\ndeployment.extensions/sleep-v2 created\n\n$ kubectl apply -f sleep.istio.yaml -n plain\nservice/sleep created\ndeployment.extensions/sleep-v1 created\ndeployment.extensions/sleep-v2 created\n</code></pre> <pre><code>$ cd Istio/istio-1.1.16/samples/httpbin\n\n$ kubectl apply -f httpbin.yaml -n mesh\nservice/httpbin created\ndeployment.extensions/httpbin created\n\n$ kubectl apply -f httpbin.yaml -n plain\nservice/httpbin created\ndeployment.extensions/httpbin created\n</code></pre> <p>\u5728\u90e8\u7f72\u5b8c\u6210\u4e4b\u540e\uff0c\u6709\u4e24\u7ec4\u5e94\u7528\u5728\u540c\u65f6\u8fd0\u884c\u8fd9\u4e24\u7ec4\u5e94\u7528\u5206\u522b\u5904\u4e8e\u7f51\u683c\u7684\u5185\u90e8\u548c\u5916\u90e8, \u6211\u4eec\u5c1d\u8bd5\u8ba9\u4e8c\u8005\u4e92\u8bbf </p> <ul> <li>PLAIN_SLEEP</li> </ul> <pre><code>$ kubectl get pods -n plain | grep sleep-v1\nsleep-v1-548d87cc5c-gjqf4   1/1     Running   0          5m39s\n</code></pre> <ul> <li>MESH_SLEEP</li> </ul> <pre><code>$ kubectl get pods -n mesh | grep sleep-v1\nsleep-v1-548d87cc5c-6vxmn   2/2     Running   0          6m23s\n</code></pre> <pre><code>$ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash\nbash-4.4# http http://httpbin.mesh:8000/get\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\ncontent-length: 387\ncontent-type: application/json\ndate: Tue, 05 Nov 2019 03:02:54 GMT\nserver: istio-envoy\nx-envoy-decorator-operation: httpbin.mesh.svc.cluster.local:8000/*\nx-envoy-upstream-service-time: 3\n\n...\n    },\n    \"origin\": \"127.0.0.1\",\n    \"url\": \"http://httpbin.mesh:8000/get\"\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 , \u6b64\u65f6\u7531\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1, \u4ee5\u53ca\u7531\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1, \u90fd\u662f\u6ca1\u6709\u95ee\u9898\u7684</p> <p>\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a<code>MeshPolicy</code>, \u5f3a\u5236\u7f51\u683c\u5185\u90e8\u7684\u6240\u6709\u670d\u52a1\u90fd\u9ed8\u8ba4\u5f00\u542f<code>mTLS</code></p> <pre><code>apiVersion: \"authentication.istio.io/v1alpha1\"\nkind: \"MeshPolicy\"\nmetadata:\n  name: \"default\"\nspec:\n  peers:\n  - mtls: {}\n</code></pre> <pre><code>$ kubectl apply -f meshpolicy.yaml \nmeshpolicy.authentication.istio.io/default configured\n</code></pre> <p>\u5728\u9ed8\u8ba4\u7b56\u7565\u521b\u5efa\u4e4b\u540e, \u91cd\u65b0\u5c1d\u8bd5\u521a\u624d\u7684\u4e92\u8bbf </p> <pre><code>$ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash\nbash-4.4# http http://httpbin.mesh:8000/get\n\nhttp: error: ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) while doing GET request to URL: http://httpbin.mesh:8000/get\n\n\n$ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn  -c sleep bash\nbash-4.4# http http://httpbin.plain:8000/get\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\ncontent-length: 855\ncontent-type: application/json\ndate: Tue, 05 Nov 2019 03:12:50 GMT\nserver: envoy\nx-envoy-upstream-service-time: 3\n...\n} \n</code></pre> <p>\u8fd9\u6b21\u53d1\u73b0\uff0c</p> <ul> <li> <p>\u7531\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u53d1\u751f\u5931\u8d25</p> </li> <li> <p>\u800c\u7531\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u53ef\u4ee5\u6b63\u5e38\u5b8c\u6210</p> </li> </ul> <p>\u540c\u4e00\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\uff0c \u7ed3\u679c\u4f1a\u662f\u600e\u6837\u5462\uff1f</p> <pre><code>$ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn  -c sleep bash\nbash-4.4# http http://httpbin.mesh:8000/get\nHTTP/1.1 503 Service Unavailable\ncontent-length: 95\ncontent-type: text/plain\ndate: Tue, 05 Nov 2019 03:12:34 GMT\nserver: envoy\n\nupstream connect error or disconnect/reset before headers. reset reason: connection termination\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\uff0c \u5373\u4fbf\u662f\u540c\u4e00\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\uff0c \u4e5f\u8fd8\u662f\u51fa\u4e86\u4e86\u95ee\u9898\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u6240\u6709\u7684\u670d\u52a1\u7aef<code>Sidecar</code>\u90fd\u53ea\u63a5\u53d7<code>mTLS</code>\u5ba2\u6237\u7aef\u7684\u63a5\u5165\uff0c\u5ba2\u6237\u7aef\u5374\u6ca1\u6709\u968f\u4e4b\u53d8\u5316\uff0c \u8981\u5e94\u5bf9\u8fd9\u79cd\u7684\u60c5\u51b5\uff0c \u5c31\u53ef\u4ee5\u4f7f\u7528 <code>DestinationRule</code>\u5bf9\u8c61\u6765\u663e\u793a\u58f0\u660e\u8fd9\u4e2a\u8981\u6c42</p> <p><code>destinationrule.mtls.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: \"DestinationRule\"\nmetadata:\n  name: \"httpbin\"\n  namespace: mesh\nspec:\n  host: httpbin.mesh.svc.cluster.local\n  trafficPolicy:\n    tls:\n      mode: ISTIO_MUTUAL\n</code></pre> <p>\u6ce8\u610f<code>DestinationRule</code>\u7684<code>namespace</code></p> <pre><code>$ kubectl apply -f destinationrule.mtls.yaml \ndestinationrule.networking.istio.io/httpbin created\n</code></pre> <pre><code>$ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash\nbash-4.4# http http://httpbin.mesh:8000/get\n\nhttp: error: ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) while doing GET request to URL: http://httpbin.mesh:8000/get\n\n\n$ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn  -c sleep bash\nbash-4.4# http http://httpbin:8000/get\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\ncontent-length: 632\ncontent-type: application/json\ndate: Tue, 05 Nov 2019 05:43:20 GMT\nserver: envoy\nx-envoy-upstream-service-time: 17\n...\n    \"origin\": \"127.0.0.1\",\n    \"url\": \"http://httpbin:8000/get\"\n}\n\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6765\u81ea<code>pain</code>\u547d\u540d\u7a7a\u95f4\u7684\u8bbf\u95ee\u4f9d\u7136\u662f\u65e0\u6cd5\u5b8c\u6210\u7684\uff0c\u4f46\u662f\u5728\u5f00\u542f\u4e86<code>DestinationRule\u4e4b</code>\u540e\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u5c31\u6062\u590d\u6b63\u5e38\u4e86\u3002 </p> <p>\u5982\u6b64\u4e00\u6765\uff0c\u901a\u8fc7\u7b80\u5355\u7684<code>Policy</code>\u548c<code>DestinationRule</code>\u5bf9\u8c61\u5b9a\u4e49\uff0c\u6211\u4eec\u5728\u5e94\u7528\u7a0b\u5e8f\u4e0d\u6539\u52a8, \u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\u5c06\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u95f4\u7684\u901a\u4fe1\u534f\u8bae\u4ece\u660e\u6587\u4f20\u8f93\u5347\u7ea7\u4e3a<code>mTLS</code>\u52a0\u5bc6 , \u5e76\u9650\u5236\u4e86\u5916\u90e8\u7684\u660e\u6587\u8bbf\u95ee\u3002</p> <p>\u90a3\u4e48\uff0c\u5982\u679c\u53ea\u60f3\u542f\u7528<code>mTLS</code>\u4f5c\u4e3a<code>RBAC</code>\u7684\u524d\u63d0\uff0c\u4f46\u662f\u5bf9\u5916\u90e8\u670d\u52a1\u65f6\u4e0d\u5e0c\u671b\u8bbf\u95ee\u53d7\u5230\u9650\u5236\u5219\u8be5\u5982\u4f55\u5b8c\u6210\u5462\uff1f</p> <p>\u53ea\u9700\u4fee\u6539\u4e00\u4e0b\u6211\u4eec\u7684<code>Mesh Policy</code> </p> <pre><code>apiVersion: \"authentication.istio.io/v1alpha1\"\nkind: \"MeshPolicy\"\nmetadata:\n  name: \"default\"\nspec:\n  peers:\n  # - mtls: {}\n  - mtls:\n      mode: PERMISSIVE\n</code></pre> <p>\u4e3a<code>mtls</code>\u5b57\u6bb5\u52a0\u4eba<code>mode:PERMISSIVE</code>\u91cd\u65b0\u63d0\u4ea4 </p> <pre><code>$ kubectl apply -f meshpolicy.yaml -n mesh\nmeshpolicy.authentication.istio.io/default configured\n</code></pre> <p>\u518d\u6b21\u4ece<code>plain</code>\u547d\u540d\u7a7a\u95f4\u53d1\u8d77\u8bbf\u95ee </p> <pre><code>$ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash\nbash-4.4# http http://httpbin.mesh:8000/get\n\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\ncontent-length: 387\ncontent-type: application/json\ndate: Tue, 05 Nov 2019 05:52:33 GMT\nserver: istio-envoy\nx-envoy-decorator-operation: httpbin.mesh.svc.cluster.local:8000/*\nx-envoy-upstream-service-time: 1\n...\n}\n</code></pre> <pre><code>$ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn  -c sleep bash\nbash-4.4# http http://httpbin.plain:8000/get\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\n...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u591a\u4e2a\u65b9\u5411\u7684\u4e92\u8bbf\u4e5f\u90fd\u6ca1\u6709\u95ee\u9898\uff0c\u8fd9\u79cd\u5bbd\u5bb9\u6a21\u5f0f\u5bf9\u4e8e\u8bd5\u70b9\u548c\u8fc1\u79fb\u8fc7\u7a0b\u4e2d\u7684\u6df7\u5408\u90e8\u7f72\u662f\u975e\u5e38\u6709\u5e2e\u52a9\u7684\u3002 </p>"},{"location":"chap5/19Istio_Sec2_RBAC/","title":"\u7b2c\u5341\u4e5d\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa(RBAC\u8bbe\u7f6e\\\u6392\u9519\uff09","text":""},{"location":"chap5/19Istio_Sec2_RBAC/#1rbac","title":"1\u3001\u8bbe\u7f6e<code>RBAC</code>","text":"<p><code>RBAC(Role Based Access Control\uff09</code>\u662f\u76ee\u524d\u8f83\u4e3a\u901a\u7528\u7684\u4e00\u79cd\u8bbf\u95ee\u63a7\u5236\u65b9\u6cd5\u3002<code>Istio</code>\u4e5f\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u65b9\u5f0f\u6765\u652f\u6301\u670d\u52a1\u95f4\u7684\u6388\u6743\u548c\u9274\u6743\u3002</p> <p>\u6ce8\u610f\uff0c\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u9996\u5148\u8981\u5728<code>values.yaml</code>\u4e2d\u8bbe\u7f6e\uff1a </p> <pre><code>apiVersion: \"authentication.istio.io/v1alpha1\"\nkind: \"MeshPolicy\"\nmetadata:\n  name: \"default\"\n  namespace: \"default\"\nspec:\n  peers:\n  - mtls: {}\n</code></pre> <p>\u5728\u90e8\u7f72\u6210\u529f\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u7f51\u683c\u4e2d\u542f\u52a8\u6211\u4eec\u7684<code>sleep</code>\u5e94\u7528\u548c<code>httpbin</code>\u5e94\u7528\u4e86\u3002\u5728\u542f\u52a8\u5b8c\u6210\u540e\uff0c \u5c1d\u8bd5\u4f7f\u7528<code>sleep Pod</code>\u8bbf\u95ee<code>httpbin</code>\u670d\u52a1\uff1a </p> <pre><code>$ kubectl apply -f meshpolicy.yaml\nmeshpolicy.authentication.istio.io/default configured\n</code></pre> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash\nbash-4.4# http http://httpbin:8000/ip\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\n...\n</code></pre> <p><code>defa-destinationrule.mtls.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: \"DestinationRule\"\nmetadata:\n  name: \"httpbin\"\n  namespace: default\nspec:\n  host: httpbin.default.svc.cluster.local\n  trafficPolicy:\n    tls:\n      mode: ISTIO_MUTUAL\n</code></pre> <p>\u4e0d\u51fa\u610f\u5916\u8bbf\u95ee\u53ef\u4ee5\u6b63\u5e38\u5b8c\u6210 </p> <p>\u4e0b\u9762\u542f\u52a8\u4e00\u4e2a\u7b56\u7565\uff0c \u542f\u52a8<code>RBAC</code></p> <pre><code>apiVersion: \"rbac.istio.io/v1alpha1\" \nkind: RbacConfig \nmetadata: \n  name: default \nspec: \n  mode: 'ON_WITH_INCLUSION' \n  inclusion: \n    namespaces: [\"default\"]\n</code></pre> <pre><code>$ kubectl apply -f rbac.yaml \nrbacconfig.rbac.istio.io/default created\n</code></pre> <p>\u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a<code>rbac.yaml</code>\uff0c\u5e76\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4, \u8fd9\u4e00\u89c4\u5219\u7684\u610f\u4e49\u5728\u4e8e\uff0c\u4e3a\u6240\u6709<code>default</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u670d\u52a1\u90fd\u542f\u52a8RBAC\u7b56\u7565\u3002 </p> <p>\u518d\u6b21\u542f\u52a8\u6d4b\u8bd5\uff1a </p> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash\nbash-4.4# http http://httpbin:8000/ip\nHTTP/1.1 403 Forbidden\ncontent-length: 19\ncontent-type: text/plain\ndate: Tue, 05 Nov 2019 06:23:03 GMT\nserver: envoy\nx-envoy-upstream-service-time: 1\n\nRBAC: access denied\n</code></pre> <p>\u95ee\u9898\u51fa\u73b0\u4e86\uff0c\u5728<code>RBAC</code>\u542f\u52a8\u4e4b\u540e\uff0c\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u670d\u52a1\u7684\u8c03\u7528\u90fd\u4f1a\u88ab\u62d2\u7edd\u3002\u63a5\u4e0b\u6765\u9700\u8981\u505a\u7684\u5c31\u662f\u5236\u5b9a\u7b56\u7565\uff0c\u5f00\u653e\u5bf9<code>httpbin</code>\u670d\u52a1\u7684\u8bbf\u95ee\u3002 </p> <p>\u4e00\u822c\u6765\u8bf4\uff0c<code>RBAC</code>\u7cfb\u7edf\u4e2d\u7684\u6388\u6743\u8fc7\u7a0b\u90fd\u662f\u901a\u8fc7\u4ee5\u4e0b\u51e0\u6b65\u8fdb\u884c\u8bbe\u7f6e\u7684\uff1a</p> <ol> <li>\u5728\u7cfb\u7edf\u4e2d\u5b9a\u4e49\u539f\u5b50\u7c92\u5ea6\u7684\u6743\u9650\uff1b </li> <li>\u5c06\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u6743\u9650\u7ec4\u5408\u4e3a\u89d2\u8272\uff1b </li> <li>\u5c06\u89d2\u8272\u548c\u7528\u6237\u8fdb\u884c\u7ed1\u5b9a\uff0c\u4ece\u800c\u8ba9\u7528\u6237\u5177\u5907\u7ed1\u5b9a\u7684\u89d2\u8272\u6240\u62e5\u6709\u7684\u6743\u9650\u3002 </li> </ol> <p>\u5728<code>Istio</code>\u4e2d\u4f7f\u7528\u5728\u63d0\u5230\u7684<code>ServiceRole</code>\u548c<code>ServiceRoleBinding</code>\u8fd9\u4e24\u4e2a\u5bf9\u8c61\u6765\u5b8c\u6210\u8fd9\u4e00\u8fc7\u7a0b\u3002</p> <p>\u9996\u5148\u5b9a\u4e49\u4e00\u4e2a\u53ef\u4ee5\u4f7f\u7528<code>HTTP GET</code>\u8bbf\u95ee\u6240\u6709\u670d\u52a1\u7684<code>ServiceRole</code>: </p> <pre><code>apiVersion: \"rbac.istio.io/v1alpha1\" \nkind: ServiceRole \nmetadata: \n  name: service-viewer \nspec: \n  rules: \n  - services: [\"*\"] \n    methods: [\"GET\"] \n</code></pre> <pre><code>$ kubectl apply -f servicerole.yaml \nservicerole.rbac.istio.io/service-viewer created\n</code></pre> <p>\u5c06\u5176\u4fdd\u5b58\u4e3a<code>servicerole.yaml</code> </p> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u79f0\u4e3a<code>service-viewer</code>\u7684\u89d2\u8272\uff0c\u5728<code>rules</code>\u5b57\u6bb5\u4e2d\u8fdb\u884c\u6388\u6743\uff0c\u5141\u8bb8\u8be5\u89d2\u8272\u4f7f\u7528<code>GET</code>\u65b9\u6cd5\u8bbf\u95ee\u6240\u6709\u670d\u52a1\u3002 </p> <p>\u7136\u540e\u5b9a\u4e49\u4e00\u4e2a<code>ServiceRoleBinding</code>\uff0c\u5c06\u4e0a\u9762\u7684\u89d2\u8272\u7ed1\u5b9a\u5230\u6240\u6709<code>default</code>\u547d\u540d\u7a7a\u95f4\u7684<code>ServiceAccount</code>\u4e0a\uff1a </p> <pre><code>apiVersion: \"rbac.istio.io/v1alpha1\" \nkind: ServiceRoleBinding \nmetadata: \n  name: bind-service-viewer \nspec: \n  subjects: \n  - properties: \n      source.namespace: \"default\" \n  roleRef: \n    kind: ServiceRole \n    name: \"service-viewer\" \n</code></pre> <pre><code>$ kubectl apply -f servicerolebinding.yaml \nservicerolebinding.rbac.istio.io/bind-service-viewer created\n</code></pre> <p>\u5c06\u5176\u4fdd\u5b58\u4e3a<code>servicerolebinding.yaml</code>\u3002 </p> <p>\u8fd9\u91cc\u7684<code>subject</code>\u7528\u4e86\u4e00\u4e2a\u5c5e\u6027\u9650\u5236\u6765\u6307\u5b9a\u7ed1\u5b9a\u76ee\u6807\uff1a\u6240\u6709\u6765\u81ea<code>default</code>\u547d\u540d\u7a7a\u95f4\u7684\u8c03\u7528\u8005\u3002</p> <p>\u7b26\u5408\u8fd9\u4e00\u6761\u4ef6\u7684\u7528\u6237\u90fd\u88ab\u7ed1\u5b9a\u5230<code>service-viewer</code>\u8fd9\u4e2a\u89d2\u8272\u4e0a\u3002 </p> <p>\u6211\u4eec\u5c06\u8fd9\u4e24\u4e2a\u6587\u4ef6\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\uff1a </p> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash\nbash-4.4# http http://httpbin:8000/ip\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\ncontent-length: 28\ncontent-type: application/json\ndate: Tue, 05 Nov 2019 07:24:53 GMT\n...\n</code></pre> <p>\u8fdb\u4e00\u6b65\u5c1d\u8bd5<code>post</code>\u65b9\u5f0f</p> <pre><code>bash-4.4# http -f POST http://httpbin:8000/post name=ja\nHTTP/1.1 403 Forbidden\ncontent-length: 19\ncontent-type: text/plain\ndate: Tue, 05 Nov 2019 07:27:01 GMT\nserver: envoy\nx-envoy-upstream-service-time: 0\n\nRBAC: access denied\n</code></pre> <p>\u56e0\u4e3a\u5728<code>ServiceRole</code>\u4e2d\u4ec5\u8bbe\u7f6e\u4e86<code>GET</code>\u65b9\u6cd5\u7684\u6388\u6743\uff0c\u56e0\u6b64<code>POST</code>\u65b9\u6cd5\u8fd8\u662f\u65e0\u6cd5\u901a\u8fc7\u3002 </p> <p>\u4e0b\u9762\u5c06\u8fd9\u4e2a\u89d2\u8272\u8fdb\u884c\u7ec6\u5316\u3002\u5047\u8bbe\u6211\u4eec\u7684\u4e24\u4e2a\u7248\u672c\u7684<code>sleep</code>\u5e94\u7528\u4f7f\u7528\u4e0d\u540c\u7684 <code>ServiceAccount</code>\u8fd0\u884c\uff1a    <code>v1</code>\u7248\u672c\u4f7f\u7528<code>sleep</code>, <code>v2</code>\u7248\u672c\u4f7f\u7528<code>sleep-v2</code>\u3002\u6211\u4eec\u5bf9<code>sleep</code>\u670d\u52a1\u7684<code>v1</code>\u7248\u672c\u5f00\u653e<code>POST</code>\u65b9\u6cd5\u3002 \u9996\u5148\u521b\u5efa\u65b0\u7684<code>Service Account</code>: </p> <pre><code>$ kubectl create sa sleep\nserviceaccount/sleep created\n\n$ kubectl create sa sleep-v2\nserviceaccount/sleep-v2 created\n</code></pre> <p>\u63a5\u4e0b\u6765\u66f4\u65b0<code>sleep.yaml</code>\uff0c\u5728\u5176\u4e2d\u589e\u52a0<code>ServiceAccount</code>: </p> <pre><code>...\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: sleep-v1\n  # annotations: \n  #   traffic.sidecar.istio.io/includeOutboundIPRanges: 10.96.0.0/12\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: sleep\n        version: v1\n    spec:\n      ServiceAccountName: sleep\n      containers:\n      - name: sleep\n        image: dustise/sleep\n        imagePullPolicy: Always\n---\n...\n      labels:\n        app: sleep\n        version: v2\n    spec:\n      ServiceAccountName: sleep-v2\n      containers:\n      ...\n</code></pre> <p>\u5220\u9664\u539f\u6709\u90e8\u7f72\uff0c\u91cd\u65b0\u542f\u52a8\u5e76\u6ce8\u4eba<code>sleep</code>\u5e94\u7528\uff0c\u7ee7\u7eed\u540e\u7eed\u7684\u6d4b\u8bd5\u64cd\u4f5c\uff1a </p> <pre><code>$ kubectl exec -it sleep-v2-6b7d67797b-48pk6 -c sleep bash\n\nhttp -f POST http://httpbin:8000/post name=ja\nHTTP/1.1 403 Forbidden\ncontent-length: 19\ncontent-type: text/plain\ndate: Tue, 05 Nov 2019 08:01:33 GMT\nserver: envoy\nx-envoy-upstream-service-time: 5\n\nRBAC: access denied\n\n\n\n\nhttp -f  http://httpbin:8000/ip\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\ncontent-length: 28\ncontent-type: application/json\ndate: Tue, 05 Nov 2019 08:02:05 GMT\nserver: envoy\nx-envoy-upstream-service-time: 2\n\n{\n    \"origin\": \"127.0.0.1\"\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c <code>sleep</code>\u670d\u52a1\u7684<code>v2</code>\u7248\u672c\u76ee\u524d\u548c\u5176\u4ed6\u670d\u52a1\u6743\u9650\u662f\u4e00\u81f4\u7684\u3002 \u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a\u65b0\u7684<code>Service Role</code>: </p> <pre><code>apiVersion: \"rbac.istio.io/v1alpha1\" \nkind: ServiceRole \nmetadata: \n  name: service-owner \nspec: \n  rules: \n  - services: [\"*\"] \n    methods: [\"GET\",\"POST\"] \n</code></pre> <ul> <li><code>servicerole-owner.yaml</code></li> </ul> <pre><code>$ kubectl apply -f servicerole-owner.yaml \nservicerole.rbac.istio.io/service-owner created\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u65b0\u7684<code>servicerolebinding.yaml</code>\u7684\u7ed1\u5b9a\u5173\u7cfb, \uff0c\u5c06<code>sleep-v2</code>\u548c<code>service-owner</code> \u5173\u8054\u8d77\u6765\uff1a</p> <pre><code>apiVersion: \"rbac.istio.io/v1alpha1\" \nkind: ServiceRoleBinding \nmetadata: \n  name: bind-service-owner \nspec: \n  subjects: \n  - user: \"cluster.local/ns/default/sa/sleep\" \n  roleRef: \n    kind: ServiceRole \n    name: \"service-owner\" \n</code></pre> <pre><code>$ kubectl apply -f servicerolebinding-owner.yaml \nservicerolebinding.rbac.istio.io/bind-service-owner created\n</code></pre> <pre><code>$ kubectl exec -it sleep-v2-6b7d67797b-48pk6 -c sleep bash \nbash-4.4# http -f POST http://httpbin:8000/post name=ja\nHTTP/1.1 403 Forbidden\ncontent-length: 19\ncontent-type: text/plain\n...\n\nRBAC: access denied\n</code></pre> <pre><code>$ kubectl exec -it sleep-v1-64fddd5d85-nmgl5  -c sleep bash\n\nbash-4.4# http -f POST http://httpbin:8000/post name=ja\nHTTP/1.1 200 OK\naccess-control-allow-credentials: true\naccess-control-allow-origin: *\ncontent-length: 793\n...\n</code></pre> <p>\u5982\u6b64\u4e00\u6765\uff0c\u4f7f\u7528\u4e0d\u540c<code>Service Account</code>\u8fd0\u884c\u7684\u670d\u52a1\u7248\u672c\uff0c\u5c31\u5206\u522b\u5177\u5907\u4e86\u4e0d\u540c\u7684\u6743\u9650\u3002\u56e0\u4e3a\u670d\u52a1\u548c<code>ServiceAccount</code>\u7684\u5173\u7cfb\u53ef\u4ee5\u7531\u7ba1\u7406\u5458\u8fdb\u884c\u6307\u5b9a\u6709\u975e\u5e38\u5927\u7684\u7075\u6d3b\u6027\uff0c\u6240\u4ee5\u5728\u6388\u6743\u65b9\u9762\u4f1a </p>"},{"location":"chap5/19Istio_Sec2_RBAC/#2-rbac","title":"2\u3001 <code>RBAC</code>\u7684\u9664\u9519\u8fc7\u7a0b","text":"<p><code>RBAC</code>\u7684\u8bbe\u7f6e\u8fc7\u7a0b\u662f\u975e\u5e38\u5bb9\u6613\u51fa\u9519\u7684\uff0c\u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u4e49\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u5728<code>Mixer Telemetry</code>\u4e2d\u76d1\u63a7</p> <p>\u8fd9\u91cc\u7ed9\u51fa\u4e00\u4e2a\u7b80\u5355\u6837\u4f8b\uff1a </p> <pre><code>apiVersion: \"config.istio.io/v1alpha2\" \nkind: logentry \nmetadata: \n  name: rbaclog \nspec: \n  severity: '\"warning\"' \n  timestamp: request.time \n  variables: \n    source: source.labels[\"app\"] | source.workload.name | \"unknown\" \n    user: source.user | \"unknown\" \n    destination: destination.labels[\"app\"] | destination.workload.name | \"unknown\" \n    responseCode: response.code | 0 \n    responseSize: response.size | 0 \n    latency: response.duration |  \"Oms\" \n  monitored_resource_type: '\"UNSPECIFIED\"' \n---\napiVersion: \"config.istio.io/v1alpha2\" \nkind: stdio \nmetadata: \n  name: rbachandler \nspec: \n  outputAsJson: true \n---\napiVersion: \"config.istio.io/v1alpha2\" \nkind: rule \nmetadata: \n  name: rabcstdio \nspec: \n  actions: \n  - handler: rbachandler.stdio \n    instances: \n    - rbaclog.logentry \n</code></pre> <pre><code>$ kubectl apply -f rbaclog.yaml \nlogentry.config.istio.io/rbaclog unchanged\nstdio.config.istio.io/rbachandler unchanged\nrule.config.istio.io/rabcstdio created\n</code></pre> <pre><code>kubectl logs -n  istio-system istio-telemetry-7d7845478d-d2h5f -c mixer | grep rbaclog\n...\n\n</code></pre> <p>\u6839\u636e\u65e5\u5fd7\u5185\u5bb9\u4e2d\u7684<code>source</code>\u3001 <code>destination</code>\u7b49\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5c31\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230\u5728\u8bbf\u95ee\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u7684\u95ee\u9898\u4e86\u3002 </p>"},{"location":"chap5/1Service_Mesh_Intro/","title":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u7684\u57fa\u672c\u7279\u5f81","text":"<p>Buoyant\u516c\u53f8\u7684CEO William,\u66fe\u7ecf\u7ed9\u51fa\u5bf9\u670d\u52a1\u7f51\u683c\u7684\u5b9a\u4e49\uff1a</p> <p>\u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u7528\u6765\u5904\u7406\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u3002</p> <p>\u73b0\u4ee3\u7684\u4e91\u539f\u751f\u5e94\u7528\u662f\u7531\u5404\u79cd\u590d\u6742\u6280\u672f\u6784\u5efa\u7684\u670d\u52a1\u7ec4\u6210\u7684\uff0c\u670d\u52a1\u7f51\u683c\u8d1f\u8d23\u5728\u8fd9\u4e9b\u7ec4\u6210\u90e8\u5206\u4e4b\u95f4\u8fdb\u884c\u53ef\u9760\u7684\u8bf7\u6c42\u4f20\u9012\u3002\u76ee\u524d \u5178\u578b\u7684\u670d\u52a1\u7f51\u683c\u901a\u5e38\u63d0\u4f9b\u4e86\u4e00\u7ec4\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\uff0c\u8fd9\u4e9b\u4ee3\u7406\u4f1a\u5728\u5e94\u7528\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u540c\u5e94\u7528\u5e76\u884c\u90e8\u7f72\u3001\u8fd0\u884c\u3002 </p> <p>\u8fd9\u91cc\u5c06Istio\u7684\u7279\u6027\u603b\u7ed3\u5982\u4e0b\u3002</p> <ul> <li>\u8fde\u63a5\uff1a\u5bf9\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u6240\u4ea7\u751f\u7684\u6d41\u91cf\u8fdb\u884c\u667a\u80fd\u7ba1\u7406\uff0c\u5e76\u4ee5\u6b64\u4e3a\u57fa\u7840\uff0c\u4e3a\u5fae\u670d\u52a1\u7684\u90e8\u7f72\u3001\u6d4b\u8bd5\u548c\u5347\u7ea7\u7b49\u64cd\u4f5c\u63d0\u4f9b\u6709\u529b\u4fdd\u969c</li> <li>\u5b89\u5168\uff1a\u4e3a\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u63d0\u4f9b\u8ba4\u8bc1\u3001\u52a0\u5bc6\u548c\u9274\u6743\u652f\u6301\uff0c\u5728\u4e0d\u4fb5\u4eba \u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\uff0c\u52a0\u56fa\u73b0\u6709\u670d\u52a1\uff0c\u63d0\u9ad8\u5176\u5b89\u5168\u6027\u3002 </li> <li>\u7b56\u7565\uff1a\u5728\u63a7\u5236\u9762\u5b9a\u5236\u7b56\u7565\uff0c\u5e76\u5728\u670d\u52a1\u4e2d\u5b9e\u65bd\u3002</li> <li>\u89c2\u5bdf\uff1a\u5bf9\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u8fdb\u884c\u8ddf\u8e2a\u548c\u6d4b\u91cf\uff0c\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u4fe1\u606f\u3002 </li> </ul> <p>\u4e0b\u9762\u5bf9\u8fd9\u4e9b\u7279\u6027\u5c55\u5f00\u8be6\u7ec6\u63cf\u8ff0\u3002 </p>"},{"location":"chap5/1Service_Mesh_Intro/#1","title":"1.\u8fde\u63a5","text":"<p>\u5fae\u670d\u52a1\u9519\u7efc\u590d\u6742\uff0c\u8981\u5b8c\u6210\u5176\u4e1a\u52a1\u76ee\u6807\uff0c\u8fde\u63a5\u95ee\u9898\u662f\u9996\u8981\u95ee\u9898\u3002\u8fde\u63a5\u5b58\u5728\u4e8e\u6240\u6709 \u670d\u52a1\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\uff0c\u7528\u4e8e\u7ef4\u6301\u670d\u52a1\u7684\u8fd0\u884c\uff0c\u7b97\u5f97\u4e0a\u91cd\u4e2d\u4e4b\u91cd\u3002 </p> <p>\u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684\u5355\u4f53\u5e94\u7528\uff0c\u5fae\u670d\u52a1\u7684\u7aef\u70b9\u6570\u91cf\u4f1a\u6025\u5267\u589e\u52a0\uff0c\u73b0\u4ee3\u7684\u5e94\u7528\u7cfb\u7edf\u5728\u90e8\u5206\u6216\u8005\u5168\u90e8\u751f\u547d\u5468\u671f\u4e2d\uff0c\u90fd\u5b58\u5728\u540c\u4e00\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\uff0c\u4e3a\u4e0d\u540c\u7684\u5ba2\u6237\u3001\u573a\u666f\u6216\u8005\u4e1a\u52a1\u63d0\u4f9b\u4e0d\u540c\u7684\u670d\u52a1\u3002</p> <p>\u540c\u65f6\uff0c\u540c\u4e00\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u4e5f\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u8bbf\u95ee\u8981\u6c42\uff0c\u751a\u81f3\u4ea7 \u751f\u4e86\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u8fdb\u884c\u6d4b\u8bd5\u7684\u65b0\u65b9\u6cd5\u8bba\u3002\u9519\u7efc\u590d\u6742\u7684\u670d\u52a1\u5173\u7cfb\u5bf9\u6240\u6709\u76f8\u5173\u5206\u5de5\u6765\u8bf4 \u90fd\u662f\u5f88\u4e25\u5cfb\u7684\u8003\u9a8c\u3002\u9488\u5bf9\u76ee\u524d\u7684\u5e38\u89c1\u4e1a\u52a1\u5f62\u6001\uff0c\u8fd9\u91cc\u753b\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u610f\u56fe\u6765\u63cf\u8ff0<code>Service Mesh</code>\u7684\u8fde\u63a5\u529f\u80fd</p> <p></p> <p>\u5982\u56fe\u6240\u793a\uff0c\u4ece\u4e0d\u540c\u7684\u5916\u90e8\u7528\u6237\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u4ed6\u4eec\u8bbf\u95ee\u7684\u90fd\u662f\u540c\u4e00\u670d\u52a1\u7aef\u53e3\uff0c \u4f46\u5b9e\u9645\u4e0a\u4f1a\u56e0\u4e3a\u4e0d\u540c\u7684\u7528\u6237\u8bc6\u522b\uff0c\u5206\u522b\u8bbf\u95ee\u670d\u52a1A\u7684\u4e0d\u540c\u7248\u672c\uff1b\u5728\u7f51\u683c\u5185\u90e8\uff0c\u670d\u52a1A\u7684\u7248\u672c1\u53ef\u80fd\u4f1a\u8bbf\u95ee\u670d\u52a1B\u7684\u4e24\u4e2a\u7248\u672c\uff0c\u670d\u52a1A\u7684\u7248\u672c2\u5219\u53ea\u4f1a\u8bbf\u95ee\u670d\u52a1B\u7684\u7248\u672c1\uff1b\u670d\u52a1B\u7684\u7248\u672c1\u9700\u8981\u8bbf\u95ee\u5916\u90e8\u7684\u4e91\u670d\u52a1\uff0c\u7248\u672c2\u5219\u65e0\u6b64\u9700\u6c42\u3002 </p> <p>\u5728\u8fd9\u4e2a\u7b80\u5316\u7684\u6a21\u578b\u4e2d\uff0c\u5305\u542b\u4e86\u4ee5\u4e0b\u8bc9\u6c42\uff1a </p> <ul> <li>\u7f51\u683c\u5185\u90e8\u7684\u8c03\u7528\uff08\u670d\u52a1A   <code>-&gt;</code> \u670d\u52a1B)</li> <li>\u51fa\u7ad9\u8fde\u63a5\uff08\u670d\u52a1B<code>\u4e00&gt;</code>\u5916\u90e8\u4e91\u670d\u52a1\uff09</li> <li>\u5165\u7ad9\u8fde\u63a5\uff08\u7528\u6237<code>-&gt;</code>\u670d\u52a1A);</li> <li>\u6d41\u91cf\u5206\u5272\uff08\u670d\u52a1A\u7684\u7248\u672c1\u5206\u522b\u8c03\u7528\u4e86\u670d\u52a1B\u7684\u7248\u672c1\u548c\u7248\u672c2);</li> <li>\u6309\u8c03\u7528\u65b9\u7684\u670d\u52a1\u7248\u672c\u8fdb\u884c\u8def\u7531\uff1b </li> <li>\u6309\u7528\u6237\u8eab\u4efd\u8fdb\u884c\u8def\u7531\u3002 </li> </ul> <p>\u8fd9\u91cc\u9664\u4e86\u8fd9\u4e9b\u95ee\u9898\uff0c\u8fd8\u5b58\u5728\u4e00\u4e9b\u6f5c\u5728\u9700\u6c42\uff0e\u5982\u4e0b\u6240\u8ff0\u3002 </p> <ul> <li>(1) \u5728\u7f51\u683c\u5185\u7684\u670d\u52a1\u4e4b\u95f4\u5982\u4f55\u6839\u636e\u5b9e\u9645\u9700\u8981\u5bf9\u670d\u52a1\u95f4\u7684\u8c03\u7528\u8fdb\u884c\u8def\u7531\u3001\u6761\u4ef6\u53ef\u80fd\u5305\u62ec\uff1a</li> <li>\u8c03\u7528\u6e90\u548c\u76ee\u7684\u7684\u670d\u52a1</li> <li>\u8c03\u7528\u5185\u5bb9\uff1b </li> <li> <p>\u8ba4\u8bc1\u8eab\u4efd</p> </li> <li> <p>(2) \u5982\u4f55\u5e94\u5bf9\u7f51\u7edc\u6545\u969c\u6216\u8005\u670d\u52a1\u6545\u964d\u3002 </p> </li> <li>(3\uff09\u5982\u4f55\u5904\u7406\u4e0d\u540c\u670d\u52a1\u4e0d\u540c\u7248\u672c\u4e4b\u95ee\u7684\u5173\u7cfb\u3002 </li> <li>(4\uff09\u600e\u6837\u5bf9\u51fa\u7ad9\u8fde\u63a5\u8fdb\u884c\u63a7\u5236\u3002 </li> <li>(5\uff09\u600e\u6837\u63a5\u6536\u5165\u7ad9\u8fde\u63a5\u6765\u542f\u52a8\u540e\u7eed\u7684\u6574\u4e2a\u670d\u52a1\u94fe\u6761</li> </ul> <p>\u8fd9\u4e9b\u5f53\u7136\u4e0d\u662f\u95ee\u9898\u7684\u5168\u90e8\uff0c\u5176\u4e2d\uff0c\u4e0e\u6d41\u91cf\u76f8\u5173\u7684\u95ee\u9898\u8fd8\u5f15\u53d1\u4e86\u51e0\u4e2a\u5173\u952e\u7684\u529f\u80fd\u9700\u6c42\uff0c\u5982\u4e0b\u6240\u8ff0\u3002</p> <ul> <li>(1)\u670d\u52a1\u6ce8\u518c\u548c\u53d1\u73b0\uff1a\u8981\u6c42\u80fd\u591f\u5bf9\u7f51\u683c\u4e2d\u4e0d\u540c\u7684\u670d\u52a1\u548c\u4e0d\u540c\u7248\u8fdb\u884c\u51c6\u786e\u6807\u8bc6\uff0c\u4e0d\u540c\u7684\u670d\u52a1\u53ef\u4ee5\u7ecf\u7531\u540c\u4e00\u6ce8\u518c\u673a\u6784\u4f7f\u7528\u516c\u8ba4\u7684\u65b9\u5f0f\u4e92\u76f8\u67e5\u627e\u3002 </li> <li>(2)\u8d1f\u8f7d\u5747\u8861\u7b56\uff1a\u4e0d\u540c\u7c7b\u578b\u7684\u670d\u52a1\u5e94\u8be5\u7531\u4e0d\u540c\u7684\u7b56\u7565\u6765\u6ee1\u8db3\u4e0d\u540c\u7684\u9700\u6c42</li> <li>(3)\u670d\u52a1\u6d41\u91cf\u7279\u5f81\uff1a \u5728\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u7684\u57fa\u7840\u4e0a\uff0c\u6839\u636e\u53cc\u65b9\u7684\u670d\u52a1\u8eab\u4efd\uff0c\u4ee5\u53ca\u670d\u52a1\u6d41\u91cf\u7279\u5f81\u6765\u8c03\u7528\u8fc7\u7a0b\u60ca\u9192\u7504\u522b</li> <li>(4)\u52a8\u6001\u6d41\u91cf\u5206\u914d\uff1a \u6839\u636e\u5bf9\u6d41\u91cf\u7279\u5f81\u7684\u8bc6\u522b\uff0c\u5728\u4e0d\u540c\u7684\u670d\u52a1\u548c\u7248\u672c\u4e4b\u95f4\u5bf9\u6d41\u91cf\u8fdb\u884c\u5f15\u5bfc</li> </ul> <p>\u8fde\u63a5\u662f\u670d\u52a1\u7f51\u683c\u5e94\u7528\u8fc7\u7a0b\u4e2d\u4ece\u65e0\u5230\u6709\u7684\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u73af\u8282</p>"},{"location":"chap5/1Service_Mesh_Intro/#2","title":"2.\u5b89\u5168","text":"<p>\u5b89\u5168\u4e5f\u662f\u4e00\u4e2a\u5e38\u8c08\u5e38\u65b0\u7684\u8bdd\u9898\u5728\u8fc7\u53bb\u79c1\u6709\u57fa\u7840\u8bbe\u65bd\u7ed3\u5408\u5355\u5e94\u7528\u7684\u73af\u5883\u4e0b\uff0c\u8fd9\u4e00\u95ee\u9898\u5e76\u4e0d\u7a81\u51fa\uff0c\u7136\u800c\u8fdb\u4eba\u5bb9\u5668\u4e91\u65f6\u4ee3\u4e4b\u540e\uff0c\u4ee5\u4e0b\u95ee\u9898\u51fa\u73b0 </p> <ul> <li>\u6709\u5927\u91cf\u5bb9\u5668\u6f02\u6d6e\u5728\u5bb9\u5668\u4e91\u4e2d \uff0c\u91c7\u7528\u4f20\u7edf\u7684\u7f51\u7edc\u7b56\u7565\u5e94\u5bf9\u8fd9\u79cd\u6d6e\u52a8\u7684\u5e94\u7528\u6bd4\u8f83\u5403\u529b\u7684\u3002 </li> <li>\u5728\u7531\u4e0d\u540c\u7684\u8bed\u8a00\u3001\u5e73\u53f0\u6240\u5b9e\u73b0\u7684\u5fae\u670d\u52a1\u4e4b\u95f4\uff0c\u5b9e\u65bd\u4e00\u81f4\u7684\u8bbf\u95ee\u63a7\u5236\u4e5f\u7ecf\u5e38\u4f1a\u56e0\u4e3a\u5b9e\u73b0\u7684\u4e0d\u4e00\u81f4\u800c\u56f0\u96be\u91cd\u91cd\u3002 </li> <li>\u5982\u679c\u662f\u5171\u4eab\u96c6\u7fa4\uff0c\u5219\u670d\u52a1\u7684\u8ba4\u8bc1\u548c\u52a0\u5bc6\u53d8\u5f97\u5c24\u4e3a\u91cd\u8981\uff0c\u4f8b\u5982\uff1a </li> <li>\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u8981\u9632\u6b62\u88ab\u5176\u4ed6\u670d\u52a1\u76d1\u542c</li> <li>\u53ea\u6709\u63d0\u4f9b\u6709\u6548\u8eab\u4efd\u7684\u5ba2\u6237\u7aef\u624d\u53ef\u4ee5\u8bbf\u95ee\u6307\u5b9a\u7684\u670d\u52a1</li> <li>\u670d\u52a1\u4e4b\u95f4\u7684\u4e92\u8bbf\u5e94\u8be5\u63d0\u4f9b\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\u529f\u80fd</li> </ul> <p>\u603b\u4e4b\uff0c\u8981\u63d0\u4f9b\u7f51\u683c\u5185\u90e8\u7684\u5b89\u5168\u4fdd\u969c\uff0c\u5c31\u5e94\u5177\u5907\u670d\u52a1\u901a\u4fe1\u52a0\u5bc6\u3001\u670d\u52a1\u8eab\u4efd\u8be2\uff0c \u670d\u52a1\u8bbf\u95ee\u63a7\u5236\uff08\u6388\u6743\u548c\u9274\u6743\uff09\u529f\u80fd\u3002 </p> <p>\u4e0a\u8ff0\u529f\u80fd\u901a\u5e38\u9700\u8981\u6570\u5b57\u8bc1\u4e66\u7684\u652f\u6301\uff0c\u8fd9\u5c31\u9690\u85cf\u4e86\u5bf9<code>CA</code>\u7684\u9700\u6c42\uff0c\u5373\u9700\u8981\u5b8c\u6210\u8bc1\u4e66\u7684\u7b7e\u53d1\u3001\u4f20\u64ad\u548c\u66f4\u65b0\u4e1a\u52a1\u3002 </p> <p>\u9664\u4e86\u4e0a\u8ff0\u6838\u5fc3\u8981\u6c42\uff0c\u8fd8\u5b58\u5728\u5bf9\u8ba4\u8bc1\u5931\u8d25\u7684\u5904\u7406\u3001\u5916\u90e8\u8bc1\u4e66\uff08\u7edf\u4e00CA\uff09\u7684\u63a5\u53e3\u7b49\u76f8\u5173\u652f\u6491\u5185\u5bb9\u3002 </p>"},{"location":"chap5/1Service_Mesh_Intro/#3","title":"3.\u7b56\u7565","text":"<p>\u9664\u4e86\u524d\u9762\u63d0\u5230\u7684\u5b89\u5168\u95ee\u9898\uff0c\u5728\u7531\u5fae\u670d\u52a1\u6784\u6210\u7684\u7f51\u683c\u4e2d\uff0c\u6211\u4eec\u5e38\u5e38\u8fd8\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u63a7\u5236\uff0c\u4f8b\u5982\u5bf9\u8c03\u7528\u9891\u7387\u7684\u9650\u5236\u3001\u5bf9\u670d\u52a1\u4e92\u8bbf\u7684\u63a7\u5236\uff0c\u4ee5\u53ca\u9488\u5bf9\u6d41\u91cf\u7684\u4e00\u4e9b\u9650\u5236\u548c\u53d8\u66f4\u80fd\u529b\u7b49\u3002 \u5728<code>Istio</code>\u4e2d\u4f7f\u7528<code>Mixer</code>\u4f5c\u4e3a\u7b56\u7565\u7684\u6267\u884c\u8005\uff0c<code>Envoy\u7684</code>\u6bcf\u6b21\u8c03\u7528\uff0c\u5728\u903b\u8f91\u4e0a\u90fd\u4f1a\u901a\u8fc7<code>Mixer</code>\u8fdb\u884c\u4e8b\u5148\u9884\u68c0\u548c\u4e8b\u540e\u62a5\u544a\uff0c\u8fd9\u6837<code>Mixer</code>\u5c31\u62e5\u6709\u4e86\u5bf9\u6d41\u91cf\u7684\u90e8\u5206\u63a7\u5236\u80fd\u529b\uff1b \u5728Istio\u3002\u4e2d\u8fd8\u6709\u4e3a\u6570\u4f17\u591a\u7684\u5185\u90e8\u9002\u914d\u5668\u53ca\u8fdb\u7a0b\u5916\u9002\u914d\u5668\uff0c\u53ef\u4ee5\u548c\u5916\u90e8\u8f6f\u4ef6\u8bbe\u65bd\u4e00\u540c\u5b8c \u6210\u7b56\u7565\u7684\u5236\u5b9a\u548c\u6267\u884c\u3002 </p>"},{"location":"chap5/1Service_Mesh_Intro/#4","title":"4.\u89c2\u5bdf","text":"<p>\u968f\u7740\u670d\u52a1\u6570\u91cf\u7684\u589e\u52a0\uff0c\u76d1\u63a7\u548c\u8ddf\u8e2a\u9700\u6c42\u81ea\u7136\u6c34\u6da8\u8239\u9ad8\u3002\u5728\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u53ef\u89c2\u5bdf \u7684\u4fdd\u969c\u90fd\u662f\u7cfb\u7edf\u529f\u80fd\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\uff0c\u662f\u7cfb\u7edf\u8fd0\u7ef4\u529f\u80fd\u7684\u91cd\u8981\u4fdd\u969c\u3002 </p> <p>\u968f\u7740\u5ec9\u4ef7\u670d\u52a1\u5668\uff08\u76f8\u5bf9\u4e8e\u4f20\u7edf\u5c0f\u578b\u673a\uff09\u7684\u6570\u91cf\u8d8a\u6765\u8d8a\u591a\uff0c\u670d\u52a1\u5668\u53d1\u751f\u6545\u969c\u7684\u9891\u7387\u4e5f\u8d8a\u6765\u8d8a\u9ad8\uff0c\u4eba\u4eec\u5f00\u59cb\u5bf9<code>Cattle vs. Cat</code>\u4ea7\u751f\u4e89\u8bba\uff1a\u6211\u4eec\u5e94\u8be5\u5c06\u670d\u52a1\u5668\u89c6\u4e3a\u5bb6\u755c\u8fd8\u662f\u5ba0\u7269\uff1f\u5bb6\u755c\u7684\u7279\u70b9\u662f\u6709\u529f\u80fd\u3001\u65e0\u4e2a\u6027\u3001\u53ef\u66ff\u6362\uff1b\u800c\u5ba0\u7269\u7684\u7279\u70b9\u662f\u6709\u529f\u80fd\u3001\u6709\u4e2a\u6027\u3001\u96be\u66ff\u6362\u3002 </p> <p>\u6211\u4eec\u8d8a\u6765\u8d8a\u503e\u5411\u4e8e\u5c06\u670d\u52a1\u5668\u89c6\u4e3a\u65e0\u4e2a\u6027\u3001\u53ef\u66ff\u6362\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u5982\u679c\u4e3b\u673a\u53d1\u751f\u6545\u969c\uff0c\u90a3\u4e48\u76f4\u63a5\u5c06\u5176\u66ff\u6362\u5373\u53ef\uff1b\u5e76\u4e14\uff0c\u6211\u4eec\u66f4\u52a0\u5173\u6ce8\u7684\u662f\u670d\u52a1\u7684\u603b\u4f53\u8d28\u91cf\u3002\u56e0\u6b64\uff0c\u5fae\u670d\u52a1\u7cfb\u7edf\u76d1\u63a7\uff0c\u9664\u4e86\u6709\u4f20\u7edf\u7684\u4e3b\u673a\u76d1\u63a7\uff0c\u8fd8\u66f4\u52a0\u91cd\u89c6\u9ad8\u5c42\u6b21\u7684\u670d\u52a1\u5065\u5eb7\u76d1\u63a7\u3002</p> <p>\u670d\u52a1\u7684\u5065\u5eb7\u60c5\u51b5\u5f80\u5f80\u4e0d\u662f\u975e\u9ed1\u5373\u767d\u7684\u79bb\u6563\u503c\uff0c\u800c\u662f\u4e00\u7cfb\u5217\u8fde\u7eed\u72b6\u6001\uff0c\u4f8b\u5982\u6211\u4eec\u7ecf\u5e38\u9700\u8981\u5173\u6ce8\u670d\u52a1\u7684\u8c03\u7528\u6210\u529f\u7387\u3001\u54cd\u5e94\u65f6\u95f4\u3001\u8c03\u7528\u91cf\u3001\u4f20\u8f93\u91cf\u7b49\u8868\u73b0\uff1a</p> <p>\u800c\u4e14\uff0c\u9762\u5bf9\u6570\u91cf\u4f17\u591a\u7684\u670d\u52a1\uff0c\u6211\u4eec\u5e94\u8be5\u80fd\u5bf9\u5404\u79cd\u7ea7\u522b\u548c\u5c42\u6b21\u7684\u6307\u6807\u8fdb\u884c\u91c7\u6837\u3001\u91c7\u96c6\u53ca\u6c47\u603b\uff0c\u83b7\u53d6\u8f83\u4e3a\u7cbe\u5bc6\u3001\u7fd4\u5b9e\u7684\u8fd0\u884c\u6570\u636e\uff0c\u6700\u7ec8\u901a\u8fc7\u4e00\u5b9a\u7684\u65b9\u6cd5\u8fdb\u884c\u5f52\u7eb3\u603b\u7ed3\u548c\u5c55\u793a\u3002 </p> <p>\u4e0e\u6b64\u540c\u65f6\uff0c\u670d\u52a1\u7f51\u683c\u8fd8\u5e94\u63d0\u4f9b\u5206\u5e03\u5f0f\u8ddf\u8e2a( <code>Distributed Tracing</code>\uff09\u529f\u80fd\u5bf9\u670d\u52a1\u7684\u8c03\u7528\u94fe\u8def\u8fdb\u884c\u8ddf\u8e2a\u3002 </p>"},{"location":"chap5/20Istio_Usage/","title":"\u7b2c\u4e8c\u5341\u8282 Istio\u7684\u8bd5\u7528\u5efa\u8bae","text":"<p>\u524d\u9762\u5df2\u7ecf\u5c55\u793a\u4e86<code>istio</code>\u7684\u5927\u591a\u6570\u529f\u80fd\uff0c\u5728\u65e0\u987b\u5bf9\u7a0b\u5e8f\u8fdb\u884c\u4fee\u6539\uff08\u5206\u5e03\u5f0f\u8ddf\u8e2a\u9664\u5916)\u7684\u60c5\u51b5\u4e0b\uff0c\u80fd\u5bf9\u5e94\u7528\u63d0\u4f9b\u5982\u6b64\u4e4b\u591a\u7684\u529f\u80fd\u652f\u6301\uff0c\u53ef\u4ee5\u8bc1\u660e<code>Istio</code>\u662f\u975e\u5e38\u6709\u5438\u5f15\u529b\u7684\u3002</p> <p><code>Istio</code>\u7684\u529f\u80fd\u96c6\u5b8c\u5168\u53ef\u4ee5\u8bf4\u662f\u670d\u52a1\u7f51\u683c\u6280\u672f\u7684\u5178\u8303\u3002 \u7136\u800c\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u65b0\u751f\u4e8b\u7269\uff0c<code>Istio</code>\u8fd8\u5f88\u521d\u7ea7\u7684\u3002\u867d\u7136\u524d\u9762\u8bb2\u4e86\u5f88\u591a\u529f\u80fd\uff0c\u4f46\u7b14\u8005\u8ba4\u4e3a\u5bf9\u4e8e\u9009\u578b\u51b3\u7b56\u6765\u8bf4\uff0c\u66f4\u91cd\u8981\u7684\u662f\uff1a</p> <p>\u8be5\u7cfb\u7edf\u5177\u6709\u4ec0\u4e48\u6837\u7684\u7f3a\u70b9\uff0c\u6211\u4eec\u80fd\u5426\u63a5\u53d7\uff0c \u5bf9\u4e8e\u65e0\u6cd5\u63a5\u53d7\u7684\u95ee\u9898\u662f\u5426\u53ef\u4ee5\u89c4\u907f\u3002\u4e0b\u9762\u4ec5\u5c31\u7b14\u8005\u4e2a\u4eba\u7684\u8ba4\u77e5\uff0c\u5217\u51fa<code>Istio</code>\u7684\u4e00\u4e9b\u95ee\u9898\uff0c\u540c\u65f6\u7ed3\u5408\u4ee5\u5f80\u7684\u7ecf\u9a8c\uff0c\u8c08\u8c08\u8bd5\u7528<code>Istio</code>\u65f6\u7684\u4e00\u4e9b\u5efa\u8bae\u548c\u6ce8\u610f\u4e8b\u9879\u3002 </p> <p>\u7ed3\u5408<code>Istio</code>\u7684\u73b0\u72b6\uff0c\u4ee5\u53ca\u591a\u6570\u4f01\u4e1a\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u4e2a\u4eba\u6d45\u89c1\uff1a<code>Istio</code>\u7684\u5e94\u7528\u5728\u73b0\u9636\u6bb5\u53ea\u80fd\u5c0f\u8303\u56f4\u8bd5\u63a2\u6027\u5730\u8fdb\u884c\uff0c\u5728\u8fdb\u884c\u8fc7\u7a0b\u4e2d\u8981\u4e25\u683c\u5b9a\u4e49\u8bd5\u7528\u8303\u56f4\uff0c\u4e25\u63a7\u5404\u4e2a\u6d41\u7a0b\u3002 </p> <p>\u6309\u7167\u4e2a\u4eba\u7ecf\u9a8c\uff0c\u7b14\u8005\u5c06\u8bd5\u7528\u8fc7\u7a0b\u5206\u4e3a\u5982\u4e0b4\u4e2a\u9636\u6bb5\u3002</p> <ul> <li>\u8303\u56f4\u5b9a\u4e49\uff1a\u9009\u62e9\u8fdb\u5165\u8bd5\u7528\u7684\u670d\u52a1\uff0c\u786e\u5b9a\u53d7\u5f71\u54cd\u7684\u8303\u56f4\uff0c\u5e76\u6839\u636e<code>Istio</code>\u9879\u76ee\u73b0\u72b6\u51b3\u5b9a\u9884\u5907\u4f7f\u7528\u7684<code>Istio</code>\u76f8\u5173\u529f\u80fd\u3002\u56f4\u7ed5\u8fd9\u4e9b\u9700\u8981\uff0c\u5236\u5b9a\u8bd5\u7528\u9700\u6c42\u3002</li> <li>\u65b9\u6848\u90e8\u7f72\uff1a\u6839\u636e\u8303\u56f4\u5b9a\u4e49\u7684\u51b3\u7b56\uff0c\u5236\u5b9a\u548c\u6267\u884c\u76f8\u5173\u7684\u90e8\u7f72\u5de5\u4f5c\u3002\u5176\u4e2d\u5305\u542b<code>Istio</code>\u81ea\u8eab\u7684\u90e8\u7f72\u548c\u4e1a\u52a1\u670d\u52a1\u3001\u540e\u5907\u670d\u52a1\u7684\u90e8\u7f72\u5de5\u4f5c\u3002</li> <li>\u6d4b\u8bd5\u9a8c\u8bc1\uff1a\u6839\u636e\u65e2\u6709\u4e1a\u52a1\u76ee\u6807\u5bf9\u90e8\u7f72\u7ed3\u679c\u8fdb\u884c\u6d4b\u8bd5\u3002 </li> <li>\u5207\u6362\u6f14\u7ec3\uff1a\u9632\u5fa1\u63aa\u65bd\uff0c\u7528\u4e8e\u5728\u4e1a\u52a1\u5931\u8d25\u65f6\u5207\u56de\u5230\u539f\u6709\u7684\u7a33\u5b9a\u73af\u5883\u3002\u4e0b\u9762\u4f1a\u6839\u636e\u8fd9\u51e0\u70b9\u5185\u5bb9\uff0c\u9010\u4e00\u5c55\u5f00\u8ba8\u8bba\uff09 </li> </ul>"},{"location":"chap5/20Istio_Usage/#1istio","title":"1\u3001<code>Istio</code>\u81ea\u8eab\u7684\u7a81\u51fa\u95ee\u9898","text":"<p><code>API</code>\u7a33\u5b9a\u6027\u53ef\u80fd\u662f\u6700\u4e25\u91cd\u7684\u4e00\u4e2a\u95ee\u9898\u3002\u76ee\u524d\u6700\u6210\u719f\u7684\u529f\u80fd\u7ec4\u522b\u5e94\u8be5\u662f\u6d41\u91cf\u63a7\u5236\uff0c\u5176\u7248\u672c\u53f7\u4e5f\u4ec5\u662f<code>v1alpha 3</code>\u3002\u4e00\u822c\u6765\u8bf4\uff0c<code>alpha</code>\u9636\u6bb5\u7684\u4ea7\u54c1\uff0c\u4e0d\u4f1a\u63d0\u4f9b\u5411\u540e\u517c\u5bb9\u7684\u627f\u8bfa\uff0c\u6d41\u91cf\u63a7\u5236<code>API</code>\u5728\u4ece<code>v1alpha 2</code>\u5347\u7ea7\u4e3a<code>v1alpha 3</code>\u7684\u8fc7\u7a0b\u4e2d\uff0c<code>API</code>\u51e0\u4e4e\u5168\u90e8\u6539\u5199\uff0c\u4f7f\u5f97\u5f88\u591a\u65e9\u671f\u7528\u6237\u7684\u7cbe\u529b\u6295\u5165\u4ed8\u8bf8\u4e1c\u6d41\u3002\u6838\u5fc3\u529f\u80fd\u5c1a\u4e14\u5982\u6b64\uff0c\u66f4\u522b\u63d0\u76f8\u5bf9\u6bd4\u8f83\"\u8fb9\u7f18\u201d\u7684<code>Mixer</code>,<code>Citadel</code>\u53ca<code>Galley</code>\u7ec4\u4ef6\u7684\u76f8\u5173\u5185\u5bb9\u3002 </p> <p><code>Istio</code>\u7684\u53d1\u5e03\u8282\u594f\u548c\u53d1\u5e03\u8d28\u91cf\u65b9\u9762\u7684\u95ee\u9898\u4e5f\u76f8\u5f53\u4e25\u91cd\u3002\u5728<code>Istio</code>\u5e76\u4e0d\u7b97\u957f\u7684\u5386\u53f2\u4e2d\u51fa\u73b0\u4e86\u591a\u6b21\u7248\u672c\u64a4\u56de\u3001\u5927\u7248\u672c\u4e25\u91cd\u5ef6\u671f\u3001\u53d1\u5e03\u8d28\u91cf\u4f4e\u4e0b\u65e0\u6cd5\u4f7f\u7528\u53ca<code>Bug</code>\u53cd\u590d\u7b49\u72b6\u51b5\uff0c\u8fd9\u65e0\u7591\u4f1a\u8ba9\u6bcf\u6b21\u5347\u7ea7\u5c1d\u8bd5\u90fd\u5145\u6ee1\u4e86\u4e0d\u786e\u5b9a\u6027\uff0c\u4f1a\u6781\u5927\u5f71\u54cd\u751f\u4ea7\u8fc7\u7a0b\u7684\u8fde\u7eed\u6027\u3002 </p> <ul> <li> <p><code>Mixer</code>\uff1a\u662f\u4e00\u4e2a\u95ee\u9898\u7126\u70b9\uff0c\u5176\u6570\u636e\u6a21\u578b\u8f83\u4e3a\u590d\u6742\uff0c\u5e76\u4e14\u5c06\u6240\u6709\u5e94\u7528\u7684\u6d41\u91cf\u96c6\u4e00\u70b9\uff0c\u867d\u7136\u5728\u5176\u4e2d\u52a0\u5165\u4e86\u5404\u79cd\u7f13\u5b58\u7b49\u6280\u672f\u6765\u51cf\u5c11\u5ef6\u8fdf\uff0c\u4f46\u662f\u5176\u72ec\u7279\u5730\u4f4d\u51b3\u5b9a\u4e86<code>Mixer</code>\u59cb\u7ec8\u5904\u4e8e\u4e00\u4e2a\u9ad8\u98ce\u9669\u7684\u4f4d\u7f6e\u3002 </p> </li> <li> <p><code>Pilot</code>\u5728\u6027\u80fd\u65b9\u9762\u4e5f\u7ecf\u5e38\u88ab\u4eba\u57a2\u75c5\uff0c\u867d\u7136\u7ecf\u8fc7\u51e0\u6b21\u5347\u7ea7\uff0c\u4f46\u4ecd\u5728<code>1.0</code>\u7248\u672c\u4e4b\u540e\uff0c\u51fa\u73b0\u4e86<code>Pilot</code>\u5728\u96c6\u7fa4\u4e2d\u670d\u52a1\u6216<code>Pod</code>\u8fc7\u591a\u7684\u60c5\u51b5\u4e0b\u4f1a\u8d85\u91cf\u6d88\u8017\u8d44\u6e90\u7684\u4e24\u6b21\u72b6\u51b5\u3002 </p> </li> </ul> <p>\u5b89\u5168\u3001\u7269\u7406\u673a\u548c\u865a\u62df\u673a\u7684\u652f\u6301\u53ca\u7f51\u683c\u8fb9\u7f18\u901a\u4fe1\u8fd9\u4e8c\u7ec4\u529f\u80fd\u3002\u76ee\u524d\u7528\u6237\u8f83\u5c11\uff0c\u8d28\u91cf\u5c1a\u4e0d\u660e\u786e\u3002 </p> <p>\u6700\u540e\u5c31\u662f<code>Istio sidecar</code>\u6ce8\u4eba\u6a21\u5f0f\uff0c\u8fd9\u79cd\u6a21\u5f0f\u4e00\u5b9a\u4f1a\u589e\u52a0\u670d\u52a1\u95f4\u8c03\u7528\u7684\u7f51\u7edc\u5ef6\u8fdf\uff0c\u76ee\u524d\u662f\u4e00\u4e2a\u987d\u75be, <code>Sidecar</code>\u7684\u56fa\u5b9a\u5ef6\u8fdf\u548c<code>Mixer</code>\u7684\u4e0d\u786e\u5b9a\u884c\u4e3a\u76f8\u7ed3\u5408\uff0c\u6709\u53ef\u80fd\u4f1a\u4ea7\u751f\u4e25\u91cd\u540e\u679c\u3002 </p> <p>\u8fd9\u91cc\u63d0\u51fa\u7684\u53ea\u662f\u88ab\u53cd\u590d\u63d0\u53ca\u6216\u8005\u7ecf\u5e38\u51fa\u73b0\u5728<code>Issue</code>\u5217\u8868\u4e2d\u7684\u95ee\u9898\uff0c\u4ece\u53d1\u5e03\u7684\u95ee\u9898\u6765\u770b\uff0c\u9762\u4e34\u7684\u98ce\u9669\u53ef\u80fd\u8fdc\u4e0d\u6b62\u8fd9\u4e9b\u3002 </p>"},{"location":"chap5/20Istio_Usage/#2","title":"2\u3001\u786e\u5b9a\u529f\u80fd\u8303\u56f4","text":"<p>\u5728<code>Istio</code>\u4e2d\u5305\u542b\u4e86\u975e\u5e38\u591a\u7684\u529f\u80fd\u70b9\uff0c\u4ece\u539f\u5219\u4e0a\u6765\u8bf4\uff0c\u5404\u79cd\u529f\u80fd\u90fd\u662f\u6709\u5176\u5b9e\u9645\u4f5c\u7528\u7684\u7136\u800c\uff0c<code>Istio</code> \u4f5c\u4e3a\u4e00\u4e2a\u65b0\u4ea7\u54c1\uff0c\u672c\u8eab\u4e5f\u6709\u5f88\u591a\u4e0d\u8db3.</p> <p><code>Istio</code>\u63d0\u4f9b\u7684\u4f17\u591a\u529f\u80fd\u5bf9\u6bcf\u4e2a\u516c\u53f8\u6216\u8005\u9879\u76ee\uff0c\u90fd\u4f1a\u6709\u4e0d\u540c\u4ef7\u503c\u3002\u6211\u4eec\u5728\u91c7\u7528\u4e00\u4e2a \u65b0\u7cfb\u7edf\u65f6\uff0c\u9996\u5148\u8981\u8003\u8651\u7684\u5c31\u662f\u6027\u4ef7\u6bd4\u95ee\u9898\uff0c\u8fd9\u91cc\u7684\u201c\u4ef7\" \u5bf9\u4e1a\u52a1\u5e94\u7528\u7684\u5f71\u54cd\uff0c\u8fd8\u5305\u62ec\u53ef\u80fd\u51fa\u73b0\u7684\u670d\u52a1\u505c\u673a\u7b49\u95ee\u9898  \u4ee3\u8868\u7740<code>Istio</code>\u5e26\u6765\u7684\u98ce\u9669\u3001</p> <p>\u7b14\u8005\u66fe\u7ecf\u505a\u51fa\u8fd9\u6837\u4e00\u4e2a\u6027\u4ef7\u6bd4\u7684\u964d\u5e8f\u6392\u5217\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 </p> <ol> <li>\u670d\u52a1\u76d1\u63a7\u548c\u8ddf\u8e2a\uff1a\u5bf9\u5b58\u91cf\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\u8d28\u91cf\u53ef\u89c6\u5316\u652f\u6301\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u5b9e\u73b0\u6307\u6807\u548c\u65e5\u5fd7\u7684\u5b9a\u5236\uff0c\u6709\u6548\u5730\u6839\u636e\u670d\u52a1\u8d28\u91cf\u7684\u53d8\u5316\u63d0\u4f9b\u544a\u8b66\u548c\u5206\u6790\u652f\u6301\u3002 </li> <li>\u8def\u7531\u7ba1\u7406\uff1a\u80fd\u6709\u6548\u5730\u652f\u6301\u7248\u672c\u66f4\u65b0\u548c\u56de\u6eda\u3001\u91d1\u4e1d\u96c0\u6d4b\u8bd5\u7b49\u53d1\u5e03\u76f8\u5173\u7684\u529f\u80fd\uff1b\u5e76\u4e14\u5176\u4e2d\u7684\u91cd\u8bd5\u63a7\u5236\u3001\u8d85\u65f6\u63a7\u5236\u5bf9\u5e94\u5bf9\u7f51\u7edc\u6ce2\u52a8\u975e\u5e38\u5177\u6709\u5b9e\u9645\u610f\u4e49\uff1b\u540c\u65f6\uff0c\u6545\u969c\u6ce8\u5165\u548c\u6d41\u91cf\u590d\u5236\u529f\u80fd\u5bf9\u6d4b\u8bd5\u6765\u8bf4\u4e5f\u662f\u5f88\u6709\u5e2e\u52a9\u7684\u3002 </li> <li>\u9650\u6d41\u548c\u9ed1\u767d\u540d\u5355\u529f\u80fd\uff1a\u80fd\u6709\u6548\u5730\u63d0\u9ad8\u670d\u52a1\u7684\u5065\u58ee\u6027\uff1b\u4f46\u662f\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c\u98ce\u9669\u5df2\u7ecf\u5f00\u59cb\u63d0\u9ad8\u4e86\u3002 </li> <li><code>mTLS</code>\u548c<code>RBAC</code>\u529f\u80fd\uff1a\u5927\u5e45\u63d0\u9ad8\u5b89\u5168\u6027\uff0c\u5e26\u6765\u7684\u4ee3\u4ef7\u662f\u56e0\u4e3a\u914d\u7f6e\u9519\u8bef\u6216\u8005\u8bc1\u4e66\u8f6e\u8f6c\u7b49\u95ee\u9898\uff0c\u9020\u6210\u670d\u52a1\u4e2d\u65ad\u7684\u98ce\u9669\u3002 </li> </ol> <p>\u5f53\u7136\uff0c\u6bcf\u4e2a\u4e0d\u540c\u7684\u7ec4\u7ec7\u90fd\u53ef\u80fd\u4f1a\u6709\u81ea\u5df1\u7684\u8bc4\u5224\u65b9\u6cd5\uff0c\u8fd9\u91cc\u7684\u6392\u5217\u4ec5\u4f9b\u53c2\u8003\u3002 </p> <p>\u5728\u5236\u5b9a\u4e86\u4f18\u5148\u7ea7\u5217\u8868\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6839\u636e\u8fd9\u4e00\u5217\u8868\uff0c\u7ed3\u5408\u9879\u76ee\u7684\u5b9e\u9645\u9700\u6c42\uff0c\u6309\u7167\u6548\u679c\u660e\u663e\u3001\u529f\u80fd\u7a33\u5b9a\u3001\u90e8\u7f72\u6210\u672c\u4f4e\u3001\u5c11\u6539\u9020\u6216\u8005\u4e0d\u6539\u9020\u7684\u6807\u51c6\u6765\u8fdb\u884c\u9009\u62e9\uff0c\u6700\u7ec8\u786e\u5b9a\u5f85\u6d4b\u8bd5\u7684\u529f\u80fd\u70b9\u3002 </p> <p>\u5728\u9009\u5b9a\u529f\u80fd\u70b9\u4e4b\u540e\uff0c\u5e94\u8be5\u9075\u5faa\u76ee\u524d\u5df2\u6709\u7684<code>Istio</code>\u6587\u6863\uff0c\u5bf9\u5404\u4e2a\u529f\u80fd\u70b9\u8fdb\u884c\u5355\u9879\u6d4b\u8bd5\u548c\u9a8c\u8bc1\uff0c\u4ee5\u786e\u4fdd\u5176\u6709\u6548\u6027\u3002\u5e76\u901a\u8fc7\u5b98\u65b9<code>GitHub</code>\u7684<code>Issue</code>\u5217\u8868\u53ca\u8ba8\u8bba\u7ec4\u5185\u5bb9\uff0c\u4e86\u89e3\u73b0\u6709\u529f\u80fd\u662f\u5426\u5b58\u5728\u5f85\u89e3\u51b3\u7684\u95ee\u9898\uff0c\u4ee5\u53ca\u76f8\u5173\u7684\u6ce8\u610f\u4e8b\u9879\u7b49\u3002 </p>"},{"location":"chap5/20Istio_Usage/#3","title":"3\u3001\u9009\u62e9\u8bd5\u7528\u4e1a\u52a1","text":"<p>\u5728\u8bd5\u7528\u529f\u80fd\u70b9\u786e\u5b9a\u4e4b\u540e\uff0c\u5c31\u8981\u9009\u62e9\u7528\u4e8e\u8bd5\u7528\u7684\u4e1a\u52a1\u5e94\u7528\u4e86\u3002<code>Istio</code>\u4f5c\u4e3a\u4e00\u4e2a\u76f8\u5bf9\u5e95\u5c42\u7684\u7cfb\u7edf\uff0c\u5176\u90e8\u7f72\u548c\u8c03\u8bd5\u8fc7\u7a0b\u5fc5\u7136\u4f1a\u5bf9\u4e1a\u52a1\u4ea7\u751f\u4e00\u5b9a\u7684\u5f71\u54cd\uff0c\u5728\u8fd0\u884c\u9636\u6bb5\u53c8\u6709<code>Sidecar</code>\u548c\u5404\u4e2a\u7ec4\u4ef6\u9020\u6210\u7684\u635f\u8017\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 </p> <ul> <li>\u6240\u6709\u7f51\u683c\u4e4b\u95f4\u7684\u901a\u4fe1\u90fd\u8981\u7ecf\u8fc7<code>Sidecar</code>\u7684\u4e2d\u8f6c\uff0c\u4f1a\u9020\u6210\u5927\u7ea6<code>10</code>\u6beb\u79d2\u7684\u5ef6\u8fdf\u3002 </li> <li><code>Pilot</code>\u5bf9\u96c6\u7fa4\u89c4\u6a21\u654f\u611f\uff0c\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u6570\u91cf\u3001<code>Pod</code>\u6570\u91cf\u90fd\u53ef\u80fd\u5bf9<code>Pilot</code>\u9020\u6210\u8f83\u5927\u5f71\u54cd\uff0c\u4e5f\u4f1a\u5f71\u54cd\u5230<code>Istio</code>\u5404\u79cd\u89c4\u5219\u5411<code>Pod</code>\u7684\u4f20\u8f93\u8fc7\u7a0b\u3002 </li> <li>\u6240\u6709\u6d41\u91cf\u90fd\u4f1a\u7ecf\u7531<code>Mixer</code>\u5904\u7406\uff0c\u4e5f\u6709\u9020\u6210\u74f6\u9888\u7684\u53ef\u80fd\u3002 </li> <li>\u5b89\u5168\u529f\u80fd\u8bbe\u7f6e\u4e0d\u5f53\u540c\u6837\u4f1a\u9020\u6210\u670d\u52a1\u4e2d\u65ad\u3002 </li> </ul> <p>\u5982\u4e0a\u6240\u8ff0\u8fd8\u53ea\u662f\u4e2a\u6982\u8981\uff0c\u5bf9\u4e1a\u52a1\u6765\u8bf4\uff0c\u5bf9\u8fd9\u4e9b\u98ce\u9669\u90fd\u662f\u5fc5\u987b\u6b63\u89c6\u5e76\u505a\u597d\u9884\u6848\u7684\u3002 </p> <p>\u4e3a\u4e86\u907f\u514d\u5f15\u8d77\u8fc7\u5927\u635f\u5931\uff0c\u5efa\u8bae\u5c06\u5982\u4e0b\u6807\u51c6\u4f5c\u4e3a\u9009\u62e9\u8bd5\u7528\u670d\u52a1\u7684\u4f9d\u636e\u3002 </p> <ul> <li>\u80fd\u591f\u5bb9\u5fcd\u4e00\u5b9a\u7684\u4e2d\u65ad\u65f6\u95f4\uff1a\u4e0d\u7ba1\u662f<code>Istio</code>\u8fd8\u662f\u5176\u4ed6\u65b0\u6280\u672f\u7684\u91c7\u7528\uff0c\u90fd\u53ef\u80fd\u4f1a\u9020\u6210\u670d\u52a1\u4e2d\u65ad\uff0c\u5e94\u8be5\u907f\u514d\u9009\u62e9\u4f7f\u7528\u5173\u952e\u4e1a\u52a1\u8fdb\u884c\u8bd5\u70b9 </li> <li>\u5bf9\u5ef6\u8fdf\u4e0d\u654f\u611f\uff1a\u5bf9\u4e8e\u9ad8\u9891\u5ea6\u3001\u4f4e\u5ef6\u8fdf\u7684\u670d\u52a1\u7c7b\u578b\uff0c<code>Sidecar</code>\u9020\u6210\u7684\u56fa\u5b9a\u5ef6\u8fdf\u603b\u4f53\u6765\u770b\u4f1a\u975e\u5e38\u53ef\u89c2\uff0c\u56e0\u6b64\u4e0d\u5efa\u8bae\u91c7\u7528\u8fd9\u79cd\u8d1f\u8f7d\u7c7b\u578b\u7684\u4e1a\u52a1\u4f5c\u4e3a\u8bd5\u7528\u670d\u52a1\u3002 </li> <li>\u8c03\u7528\u6df1\u5ea6\u8f83\u6d45\uff1a\u4e00\u4e2a\u8bd5\u7528\u670d\u52a1\u5982\u679c\u5305\u542b\u592a\u591a\u5c42\u6b21\uff0c\u5219\u6bcf\u4e2a\u5c42\u6b21\u4e4b\u95f4\u90fd\u4f1a\u56e0\u4e3a<code>Sidecar</code>\u7684\u5ef6\u8fdf\u53d8\u6162\u5c11\u8bb8\uff0c\u4f46\u662f\u53e0\u52a0\u8d77\u6765\u4f1a\u4f7f\u5f97\u6574\u4e2a\u4e1a\u52a1\u4ea7\u751f\u6bd4\u8f83\u660e\u663e\u7684\u5ef6\u8fdf\u3002 </li> <li>\u80fd\u591f\u65b9\u4fbf\u5730\u56de\u6eda\u548c\u5207\u6362\uff1a\u5e94\u8be5\u5728\u524d\u7aef\u8d1f\u8f7d\u5747\u8861\u5668\u3001\u53cd\u5411\u4ee3\u7406\u65b9\u800c\u505a\u597d\u5207\u6362\u51c6\u5907\uff0c\u5728\u670d\u52a1\u53d1\u751f\u4e2d\u65ad\u65f6\uff0c\u80fd\u591f\u8fc5\u901f\u5207\u56de\u539f\u6709\u73af\u5883\u3002 </li> <li>\u5177\u5907\u6210\u719f\u5b8c\u5584\u7684\u529f\u80fd\u3001\u6027\u80fd\u548c\u75b2\u52b3\u6d4b\u8bd5\u65b9\u6848\uff1a\u8bd5\u7528\u670d\u52a1\u7684\u4e0a\u7ebf\u5fc5\u987b\u6709\u4e00\u4e2a\u660e\u786e\u7684\u6807\u51c6\uff0c\u5e76\u4ee5\u7b26\u5408\u6807\u51c6\u7684\u6d4b\u8bd5\u7ed3\u679c\u6765\u5bf9\u6807\u51c6\u8fdb\u884c\u9a8c\u8bc1\u3002 </li> </ul>"},{"location":"chap5/20Istio_Usage/#4","title":"4\u3001\u8c03\u7528\u8fc7\u7a0b","text":"<p>\u5728\u9009\u62e9\u4e86<code>Istio</code>\u529f\u80fd\u8fd9\u65b9\u9762\u7684\u5efa\u8bae\u3002\u80fd\u8303\u56f4\u548c\u8bd5\u7528\u670d\u52a1\u4e4b\u540e\uff0c\u5c31\u5e94\u8be5\u5f00\u59cb\u8bd5\u7528\u4e86\uff0c\u8fd9\u91cc\u5206\u4eab\u7b14\u8005\u5728 </p>"},{"location":"chap5/20Istio_Usage/#4-1","title":"4-1 \u5236\u5ea6\u76ee\u6807","text":"<p>\u9996\u5148\u6309\u5206\u6790\u7c7b\u4f3c\uff0c \u7167\u73b0\u6709\u4e1a\u52a1\u7684\u5b9e\u9645\u9700\u8981\uff0c\u5bf9\u8bd5\u7528\u670d\u52a1\u8fdb\u884c\u529f\u80fd\u5206\u6790\u3002\u548c\u4f20\u7edf\u7684\u9700\u6c42\u529f\u80fd\u8981\u5728\u8be5\u8fc7\u7a0b\u4e2d\u660e\u786e\u4e00\u4e9b\u5177\u4f53\u7684\u9700\u6c42\u5185\u5bb9\u3002 </p> <ul> <li>\u73af\u5883\u9700\u6c42\uff1a </li> </ul> <p>\u8bf4\u660e<code>Istio</code>\u90e8\u7f72\u6240\u9700\u7684<code>Kubernetes</code>\u90e8\u7f72\u9700\u6c42\uff0c\u7684\u7cfb\u7edf\u8d44\u6e90\u9700\u6c42\uff0c\u5e76\u6839\u636e\u5b9e\u9645\u7684\u7ec4\u7ec7\u8fd0\u884c\u6d41\u7a0b\u8fdb\u884c\u7533\u8bf7\u3001\u4ee5\u53ca\u6574\u4f53\u529f\u80fd\u6240\u9700\u5206\u914d\uff0c\u5efa\u7acb\u73af\u5883\u9700\u6c42\u8bf4\u660e\u4e66\u4f9b\u540e\u7eed\u6b65\u9aa4\u6838\u5bf9\u3002 </p> <ul> <li>\u529f\u80fd\u6027\u9700\u6c42\uff1a</li> </ul> <p>\u5728<code>Istio</code>\u7684\u529f\u80fd\u4e2d\u9009\u62e9\u9700\u8981<code>Istio</code>\u4e3a\u8bd5\u7528\u670d\u52a1\u63d0\u4f9b\u652f\u6491\u7684\u529f\u80fd\u5e94\u5f62\u6210\u529f\u80fd\u6d4b\u8bd5\u6848\u4f8b\u3002 </p> <ul> <li>\u670d\u52a1\u8d28\u91cf\u9700\u6c42\uff1a</li> </ul> <p>\u6839\u636e\u73b0\u6709\u4e1a\u52a1\u7684\u8fd0\u884c\u72b6\u51b5\uff0c\u5bf9\u670d\u52a1\u8d28\u91cf\u63d0\u51fa\u5177\u4f53\u8981\u6c42\uff0c\u4f8b\u5982\u5e76\u53d1\u6570\u91cf\u3001\u54cd\u5e94\u65f6\u95f4\u3001\u6210\u529f\u7387\u7b49\uff0c\u5e94\u5f62\u6210\u6027\u80fd\u6d4b\u8bd5\u6848\u4f8b\u3002 </p> <ul> <li>\u6545\u969c\u5904\u7406\u9700\u6c42\uff1a </li> </ul> <p>\u5bf9\u4e8e\u8bd5\u70b9\u5e94\u7528\u53d1\u751f\u6545\u969c\u65f6\uff0c\u5982\u4f55\u5728\u7f51\u683c\u548c\u975e\u7f51\u683c\u7248\u672c\u7684\u8bd5\u7528\u670d\u52a1\u4e4b\u95f4\u8fdb\u884c\u5207\u6362\u4ee5\u964d\u4f4e\u6545\u969c\u5f71\u54cd\uff0c\u5e94\u5f62\u6210\u6545\u969c\u9884\u6848\u3002 </p> <p>\u8fd9\u91cc\u9700\u8981\u91cd\u89c6\u7684\u4e00\u70b9\u662f\uff0c\u5728\u8bd5\u7528\u8fc7\u7a0b\u4e2d\uff0c\u975e\u5e38\u4e0d\u5efa\u8bae\"\u501f\u673a\u4f1a\"\u5bf9\u73b0\u6709\u8bd5\u70b9\u5e94\u7528\u8fdb\u884c\u4e1a\u52a1\u6216\u8005\u8d1f\u8f7d\u65b9\u9762\u7684\u6539\u52a8\uff0c\u4ee5\u514d\u8bd5\u7528\u8fc7\u7a0b\u9020\u6210\u5e72\u6270\uff0c\u6df7\u6dc6\u8bd5\u7528\u7ed3\u679c\u3002 </p> <p>\u53e6\u5916\uff0c\u5efa\u8bae\u5f62\u6210\u4e00\u4efd\u5173\u8054\u670d\u52a1\u5217\u8868, \u7528\u4e8e\u8bc4\u4f30\u8bd5\u7528\u670d\u52a1\u7684\u5f71\u54cd\u8303\u56f4\uff0c\u5c24\u5176\u662f\u5173\u7f51\u683c\u5916\u670d\u52a1\u7684\u5f15\u7528\u4f1a\u5f71\u54cd\u6ce8\u4eba\u884c\u4e3a\uff0c\u6709\u9700\u8981\u989d\u5916\u5173\u6ce8\u3002 </p>"},{"location":"chap5/20Istio_Usage/#4-2","title":"4-2 \u65b9\u6848\u90e8\u7f72","text":"<p>\u8bd5\u7528\u65b9\u6848\u7684\u90e8\u7f72\u8fc7\u7a0b\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u513f\u6b65\u3002 </p> <ol> <li><code>Istio</code>\u90e8\u7f72\u9996\u5148\u662f\u57fa\u672c\u73af\u5883\u7684\u51c6\u5907\uff0c\u6309\u7167\u5728\u4e0a\u8282\u4e2d\u5236\u5b9a\u7684\u73af\u5883\u9700\u6c42\uff0c\u590d\u67e5\u96c6\u7fa4\u73af\u5883\u3002 \u5982\u679c\u662f\u5185\u7f51\u90e8\u7f72\uff0c\u5219\u5e94\u8be5\u90e8\u7f72\u5185\u7f51\u53ef\u8fbe\u7684\u79c1\u6709\u955c\u50cf\u5e93\uff0c\u63a8\u9001\u5168\u90e8\u6240\u9700\u7684\u955c\u50cf\uff0c\u5e76\u5229 \u7528He In\uff1a\u53d8\u91cf\u8bbe\u7f6e\u5408\u7406\u7684\u955c\u50cf\u5730\u5740\u3002 \u63a5</li> </ol> <p>\u4e0b\u6765\u6839\u636e\u8bd5\u7528\u9700\u6c42\uff0c\u5229\u7528<code>Helm</code>\u5bf9<code>Istio</code>\u90e8\u7f72\u8fdb\u884c\u8c03\u6574\uff0c\u8fd9\u65b9\u9762\u7684\u8c03\u6574\u4e3b\u8981\u5206\u4e3a\u4e24\u7c7b\uff1a\u8d44\u6e90\u8c03\u5ea6\u548c\u529f\u80fd\u88c1\u526a\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 </p> <p>\u5148\u8bf4\u529f\u80fd\u8c03\u5ea6\uff0c<code>Istio</code>\u7684\u9ed8\u8ba4\u914d\u7f6e\u662f\u975e\u5e38\u4fdd\u5b88\u7684\uff0c\u7533\u8bf7\u7684<code>CPU</code>\u548c\u5185\u5b58\u8d44\u6e90\u90fd\u5f88\u4f4e\uff0c \u5e76\u4e14\u6b8b\u7559\u4e86\u4e00\u90e8\u5206\u8c03\u8bd5\u4fe1\u606f\uff0c\u8fd9\u662f\u4e3a\u4e86\u8ba9\u6d4b\u8bd5\u7528\u6237\u5728\u5c3d\u91cf\u5c11\u6d88\u8017\u8d44\u6e90\u7684\u524d\u63d0\u4e0b\uff0c\u5c3d\u53ef\u80fd\u591a\u5730\u4f53\u9a8c<code>Istio</code>\u7684\u529f\u80fd\u800c\u8bbe\u8ba1\u7684\uff0c\u800c\u6211\u4eec\u7684\u76ee\u7684\u662f\u4e3a\u751f\u4ea7\u670d\u52a1\uff0c\u81ea\u7136\u5c31\u5e94\u8be5\u6839\u636e\u5b9e\u9645\u5e94\u7528\u8fdb\u884c\u8c03\u8282\u4e86\u3002 </p> <p>\u76ee\u524d\u53ef\u4ee5\u901a\u8fc7<code>values.yaml</code>\u8fdb\u884c\u8c03\u6574\u7684\u8d44\u6e90\u9879\u76ee\u5982\u4e0b\u3002 </p> <ul> <li><code>proxy.resources</code>\uff1a\u8d1f\u8d23\u6307\u5b9a<code>Sidecar</code>\u7684\u8d44\u6e90\u5206\u914d\u3002 </li> <li><code>defaultResources</code>\uff1a\u8d1f\u8d23<code>Istio</code>\u5404\u4e2a\u63a7\u5236\u9762\u7ec4\u4ef6\u7684\u9ed8\u8ba4\u8d44\u6e90\u5206\u914d\u3002 </li> <li><code>gateway.resources</code>\uff1a\u8d1f\u8d23<code>Istio Gateway Controller</code>\u7684\u8d44\u6e90\u5206\u914d\u3002 </li> <li><code>pilot.resources</code>\uff1a\u8d1f\u8d23<code>Pilot</code>\u7ec4\u4ef6\u7684\u8d44\u6e90\u5206\u914d\u3002 </li> </ul> <p>\u5728\u8bd5\u7528\u8fc7\u7a0b\u4e2d\uff0c\u5efa\u8bae\u8be6\u7ec6\u8c03\u6574\u5404\u4e2a\u7ec4\u4ef6\u53ca<code>Sidecar</code>\u7684\u8d44\u6e90\u8bbe\u7f6e\uff0c\u5e76\u542f\u7528<code>HPA</code>.</p> <p><code>Istio</code>\u5b98\u65b9\u7ed9\u51fa\u7684\u4e00\u4e9b\u8d44\u6e90\u5206\u914d\u5efa\u8bae\u5982\u4e0b\u3002</p> <ul> <li>\u5728\u6bcf\u79d2\u6709<code>1000</code>\u4e2a\u8bf7\u6c42\u5e76\u6253\u5f00\u65e5\u5fd7\u7684\u60c5\u51b5\u4e0b\uff0c<code>Sidecar</code>\u9700\u8981<code>1 vCPU</code>\u3002 </li> <li><code>Mixer</code>\u9884\u68c0\u529f\u80fd\u5728\u6bcf\u79d2\u6709<code>1000</code>\u8bf7\u6c42\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u7f13\u5b58\u8fbe\u5230<code>80%</code>\u7684\u547d\u4e2d\u7387\uff0c\u5219\u9700\u8981<code>0.5 vCPU</code>\u3002 </li> <li>\u670d\u52a1\u95f4\u7684\u5ef6\u8fdf\u901a\u5e38\u4f1a\u589e\u52a0<code>10</code>\u6beb\u79d2\u3002 </li> </ul> <p>\u7b14\u8005\u7ed9\u51fa\u5982\u4e0b\u8865\u5145\u5efa\u8bae\u3002 </p> <ul> <li>\u5728\u8bd5\u7528\u8fc7\u7a0b\u4e2d\uff0c\u5c24\u5176\u662f\u5728\u538b\u529b\u6d4b\u8bd5\u6216\u4e1a\u52a1\u9ad8\u5cf0\u573a\u666f\u4e0b\uff0c\u5efa\u8bae\u5229\u7528\u8282\u70b9\u4eb2\u548c\u6027\u53ca<code>Pod</code>\u4eb2\u548c\u6027\u8bbe\u7f6e\uff0c\u5c06\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u5206\u79bb\uff0c\u4ee5\u5907\u5728\u51fa\u73b0\u6027\u80fd\u95ee\u9898\u65f6\u8fc5\u901f\u6392\u67e5\u3002 </li> <li>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u591a\u4e2a\u7ec4\u4ef6\u90fd\u5f00\u542f\u4e86\u8bbf\u95ee\u65e5\u5fd7\uff08\u53ef\u80fd\u6765\u81ea\u5404\u8fdb\u7a0b\u672c\u8eab\uff0c\u4e5f\u6709\u53ef\u80fd\u6765\u81ea<code>stdio</code>\u9002\u914d\u5668\uff09\uff0c\u8fd9\u800c\u53ef\u80fd\u4f1a\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff0c\u9700\u8981\u68c0\u67e5\u5e76\u8fdb\u884c\u8bbe\u7f6e\u3002 </li> <li>\u90e8\u5206\u7ec4\u4ef6\u5f00\u542f\u4e86\u8ddf\u8e2a\u529f\u80fd\uff0c\u4e5f\u53ef\u80fd\u4f1a\u5bf9\u6027\u80fd\u6709\u6240\u5f71\u54cd\u3002 </li> <li>\u5bf9\u670d\u52a1\u5668\u8282\u70b9\u7684<code>I/O</code>\u8981\u4e25\u5bc6\u5173\u6ce8\uff0c\u4e5f\u5e94\u968f\u65f6\u6ce8\u610f<code>Istio</code>\u63a7\u5236\u9762\u5404\u5e94\u7528\u7684\u8d44\u6e90\u5360\u7528\u548cHPA\u5de5\u4f5c\u60c5\u51b5\u3002 </li> </ul> <p>\u5728\u8bbe\u7f6e\u597d\u8d44\u6e90\u53ca\u76f8\u5173\u9009\u9879\u4e4b\u540e\uff0c\u8fd8\u5e94\u6839\u636e\u8bd5\u7528\u76ee\u6807\u6765\u5bf9<code>Istio</code>\u7ec4\u4ef6\u529f\u80fd\u8fdb\u884c\u88c1\u526a\uff0c\u4f8b\u5982:</p> <ul> <li>\u589e\u5220<code>Ingress Gateway Controller</code>; <code>Prometheus</code>, <code>Grafana</code>\u8fd9\u4e9b\u7b2c\u4e09\u65b9\u7ec4\u4ef6\u662f\u5426\u542f\u52a8\uff1b</li> <li><code>Galley</code>\u6821\u9a8c</li> <li><code>Mixer</code>\u9884\u68c0\u662f\u5426\u4f7f\u7528\u7b49\u3002 </li> </ul> <p>\u8fd8\u9700\u8981\u5bf9<code>Istio</code>\u8fdb\u884c\u4e00\u4e9b\u4e2a\u6027\u5316\u914d\u7f6e\uff0c\u4f8b\u5982\u5f00\u653e\u7aef\u53e3\u3001Ingress\u8d44\u6e90\u7b49\u3002 \u4e0a</p> <p>\u8ff0\u8fd9\u4e9b\u5185\u5bb9\u90fd\u53ef\u4ee5\u5728<code>values.yarml</code>\u4e2d\u8fdb\u884c\u914d\u7f6e\u3002 </p> <ol> <li>\u540e\u5907\u670d\u52a1\u90e8\u7f72 </li> </ol> <p>\u5728\u8fdb\u884c\u8bd5\u7528\u5e94\u7528\u7684\u6ce8\u5165\u4e4b\u524d\uff0c\u9996\u5148\u5e94\u8be5\u90e8\u7f72\u4e00\u7ec4\u5907\u4efd\u670d\u52a1\uff0c\u8fd9\u7ec4\u670d\u52a1\u9700\u8981\u548c\u6574\u4f53\u670d\u52a1\u7f51\u683c\u8fdb\u884c\u9694\u79bb\u3002\u8fd9\u4e00\u7ec4\u5907\u4efd\u670d\u52a1\u5e94\u5904\u4e8e\u5f85\u673a\u6a21\u5f0f\uff0c\u4ee5\u5907\u7f51\u683c\u7248\u672c\u7684\u5e94\u7528\u5728\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u8fdb\u884c\u6574\u4f53\u5207\u6362\u3002</p> <p>\u57fa\u4e8e\u8fd9\u4e00\u70b9\u8003\u8651\uff0c\u8d1f\u8f7d\u5747\u8861\u7b49\u524d\u7aef\u63a7\u5236\u8bbe\u65bd\u4e5f\u5e94\u5907\u9f50\u3002 </p> <ol> <li>\u8bd5\u7528\u670d\u52a1\u90e8\u7f72</li> </ol> <p>\u63a5\u4e0b\u6765\u8981\u628a\u8bd5\u7528\u670d\u52a1\u90e8\u7f72\u5230\u7f51\u683c\u4e2d\uff0c\u540c\u5176\u4ed6<code>Kubernetes</code>\u4e00\u6837\uff0c\u7f51\u683c\u5e94\u7528\u7684\u90e8\u7f72\u4e5f\u662f\u4ece<code>YAML</code>\u4ee3\u7801\u5f00\u59cb\u7684\u3002\u539f\u6709\u5e94\u7528\u7684\u90e8\u7f72\u4ee3\u7801\u9700\u8981\u6839\u636e<code>Istio</code>\u6807\u51c6\u8fdb\u884c\u590d\u6838\uff0c\u68c0\u67e5\u5176\u4e2d\u7684\u7aef\u53e3\u547d\u540d\u3001\u6807\u7b7e\u8bbe\u7f6e\u3002 </p> <p>\u9664\u4e86\u5f85\u6ce8\u4eba\u7684\u5e94\u7528\u6e05\u5355\u6587\u4ef6\uff0c\u8fd8\u5e94\u8be5\u4e3a\u6bcf\u4e2a\u90e8\u7f72\u5355\u5143\u90fd\u63d0\u4f9b\u9ed8\u8ba4\u7684 <code>VirtualService</code>\u548c<code>Destination Rule</code>\uff0c\u5efa\u7acb\u57fa\u672c\u7684\u8def\u7531\u5173\u7cfb\uff0c\u63d0\u4f9b\u4e00\u4e2a\u8def\u7531\u57fa\u51c6\uff0c\u65b9\u4fbf \u5728\u8def\u7531\u8c03\u6574\u8fc7\u7a0b\u4e2d\u8fdb\u5bf9\u6bd4\u3002 </p> <p>\u5236\u5b9a\u7684\u5177\u4f53\u7f51\u683c\u9700\u6c42\u5217\u8868\uff0c\u9010\u4e2a\u7f16\u5199\u6240\u9700\u7684\u8def\u7531\u3001\u89c4\u5219\u7b49\u65b9\u9762\u7684\u914d\u7f6e\u5185\u5bb9\u3002 </p> <p>\u5728\u8fd9\u4e9b\u90fd\u5b8c\u6210\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6309\u7167\u987a\u5e8f\u9010\u4e2a\u63d0\u4ea4\u90e8\u7f72\u4e86\u3002</p> <p>4. \u76d1\u63a7\u544a\u8b66\u90e8\u7f72 </p> <p>\u5728\u8bd5\u7528\u670d\u52a1\u90e8\u7f72\u4e4b\u540e\uff0c\u5c31\u6709\u66f4\u591a\u7684\u9879\u76ee\u53ef\u4ee5\u76d1\u6d4b\u4e86\uff0c\u8fd9\u91cc\u5efa\u8bae\u5c06\u5176\u81ea\u5e26\u7684<code>Prometheus</code>\u8fdb\u884c\u53d8\u66f4\uff0c\u8fde\u63a5\u5230\u80fd\u591f\u6709\u6548\u53d1\u51fa\u544a\u8b66\u7684<code>Alertmanager</code>\u7ec4\u4ef6\u4e0a\uff0c\u5e76\u4e3a\u4ee5\u4e0b\u51e0\u7ec4\u76ee\u6807\u8fdb\u884c\u76d1\u6d4b\u548c\u544a\u8b66\u3002 </p> <ul> <li><code>Pilot</code>\u7684\u5185\u5b58\u548c<code>Cpu</code>\u5360\u7528\uff1a<code>Pilot</code>\u7684\u8d44\u6e90\u6d88\u8017\u95ee\u9898\u53cd\u590d\u51fa\u73b0\u591a\u6b21\uff0c\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u3002 </li> <li><code>Mixer</code>\u7684\u5185\u5b58\u5360\u7528\uff1a<code>Mixer</code>\u7684\u7f13\u5b58\u5230\u76ee\u524d\u4e3a\u6b62\u8fd8\u5c1a\u672a\u5b8c\u5584\uff0c\u6709\u98ce\u9669\u3002 </li> <li>\u4e1a\u52a1\u5e94\u7528\u7684\u6210\u529f\u7387\uff1a\u5c24\u5176\u662f\u542f\u7528\u4e86<code>mTLS</code>\u7684<code>Istio</code>\u670d\u52a1\u7f51\u683c\uff0c\u5e94\u8be5\u7740\u91cd\u5173\u6ce8\u3002 </li> <li>\u4e1a\u52a1\u5e94\u7528\u7684\u54cd\u5e94\u65f6\u957f\uff1a\u54cd\u5e94\u65f6\u957f\u6709\u53ef\u80fd\u53d7\u5230<code>Envoy Sidecar</code>\u548c<code>Mixer/Adapter</code>\u7684\u591a\u91cd\u5f71\u54cd\uff0c\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u3002 </li> <li>\u5173\u8054\u670d\u52a1\u5217\u8868\uff1a\u5e94\u6839\u636e\u5728\u4e0a\u8282\u4e2d\u5236\u5b9a\u7684\u5173\u8054\u670d\u52a1\u5217\u8868\uff0c\u63d0\u9ad8\u5bf9\u5f71\u54cd\u8303\u56f4\u5185\u7684\u670d\u52a1\u7684\u76d1\u63a7\u7ea7\u522b\u3002 </li> </ul>"},{"location":"chap5/20Istio_Usage/#4-3","title":"4-3 \u6d4b\u8bd5\u9a8c\u8bc1","text":"<p>\u6839\u636e\u572820.4.1\u4e2d\u5236\u5b9a\u7684\u529f\u80fd\u9700\u6c42\u5bf9\u8bd5\u7528\u670d\u52a1\u8fdb\u884c\u529f\u80fd\u6d4b\u8bd5\uff0c\u5728\u6d4b\u8bd5\u901a\u8fc7\u4e4b\u8fdb\u884c\u6027\u80fd\u548c\u75b2\u52b3\u6d4b\u8bd5\uff0c\u89c2\u5bdf\u5404\u65b9\u9762\u7684\u6027\u80fd\u6307\u6807\u662f\u5426\u7b26\u5408\uff0c\u5982\u679c\u6027\u80fd\u51fa\u73b0\u4e0b\u964d\uff0c\u5219\u53ef\u4ee5\u5c1d\u8bd5\u6269\u5bb9\uff0c\u63d0\u9ad8\u8d44\u6e90\u5206\u914d\u7387\u3002\u5173\u952e\u7ec4\u4ef6\u53ef\u80fd\u662f<code>Istio</code>\u81ea\u8eab\u7684\u95ee\u9898, \u5e94\u68c0\u67e5\u793e\u533a<code>Issue</code>\u6216\u63d0\u51fa\u65b0\u7684<code>Issue</code>\u3002 </p> <p>\u6b64\u5904\u662f\u4e00\u4e2a\u5173\u952e\u6b65\u9aa4\uff0c \u5982\u679c\u6d4b\u8bd5\u65b9\u6848\u4e0d\u7b26\u5408\u5b9e\u9645\u60c5\u51b5\u6216\u8005\u9884\u671f\u76ee\u6807\u65e0\u6cd5\u8fbe\u5230\uff0c\u5219\u5f3a\u70c8\u5efa\u8bae\u653e\u5f03\u8bd5\u7528\u3002 </p>"},{"location":"chap5/20Istio_Usage/#4-4","title":"4-4 \u5207\u6362\u6f14\u7ec3","text":"<p>\u5728\u529f\u80fd \u548c\u6027\u80fd\u6d4b\u8bd5\u5168\u90e8\u901a\u8fc7\u4e4b\u540e\uff0c\u5c31\u5e94\u8be5\u8fdb\u884c\u8bd5\u7528\u670d\u52a1\u548c\u540e\u5907\u670d\u52a1\u4e4b\u95f4\u7684\u53cc\u5411\uff0c\u5728\u53cc\u65b9\u5207\u6362\u4e4b\u540e\u90fd\u5e94\u8be5\u91cd\u590d\u8fdb\u884c\u572820.4.3\u8282\u63d0\u5230\u7684\u9a8c\u8bc1\u8fc7\u7a0b\uff0c\u9632\u6b62\u6545\u969c\u53cd\u590d\u3002  </p> <p>\u5207\u6362\u6f14\u7ec3\u662f\u8bd5\u70b9\u5e94\u7528\u7684\u6700\u540e\u4e00\u9053\u4fdd\u9669\uff0c\u5728\u7f51\u683c\u4e25\u91cd\u6545\u969c\u4e4b\u540e\u80fd\u5426\u8fc5\u901f\u6062\u590d\u4e1a\u52a1\uff0c\u5168\u9760\u8fd9\u4e00\u6b65\u7684\u652f\u6301\u3002</p>"},{"location":"chap5/20Istio_Usage/#4-5","title":"4-5 \u8bd5\u70b9\u4e0a\u7ebf","text":"<p>\u5728\u901a\u8fc7\u6d4b\u8bd5\u9a8c\u8bc1\u548c\u5207\u6362\u6f14\u7ec3\u7684\u8fc7\u7a0b\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5c06\u8bd5\u7528\u7684\u7f51\u683c\u5e94\u7528\u4e0a\u7ebf\u5230\u751f\u4ea7\u73af\u5883\u5f00\u59cb\u8bd5\u8fd0\u884c\u4e86\u3002\u548c\u6240\u6709\u5176\u4ed6\u4e0a\u7ebf\u6d3b\u52a8\u4e00\u6837\uff0c\u5728\u4e0a\u7ebf\u4e4b\u540e\u9700\u8981\u63d0\u9ad8\u76d1\u63a7\u7ea7\u522b\uff0c\u5173\u6ce8\u8bd5\u7528\u670d\u52a1\u81ea\u8eab\u548c\u8bd5\u7528\u670d\u52a1\u5f71\u54cd\u8303\u56f4\u5185\u7684\u76f8\u5173\u529f\u80fd\u7684\u5065\u5eb7\u60c5\u51b5\u3002 </p>"},{"location":"chap5/2Istio_Intro/","title":"\u7b2c\u4e8c\u8282 Istio \u57fa\u672c\u4ecb\u7ecd","text":"<p>\u524d\u9762\u63d0\u5230\uff0cIstio\u51fa\u81ea\u540d\u95e8\uff0c\u7531Google. IBM\u548cLyft\u57282017\u5e745\u6708\u5408\u4f5c\u63a8\u51fa\uff0c\u5b83\u7684\u521d\u59cb\u8bbe\u8ba1\u76ee\u6807\u662f\u5728Kubernetes\u7684\u57fa\u7840\u4e0a\uff0c\u4ee5\u975e\u4fb5\u5165\u7684\u65b9\u5f0f\u4e3a\u8fd0\u884c\u5728\u96c6\u7fa4\u4e2d\u7684\u5fae\u670d\u52a1\u63d0\u4f9b\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u52a0\u56fa\u3001\u670d\u52a1\u76d1\u63a7\u548c\u7b56\u7565\u7ba1\u7406\u7b49\u529f\u80fd\u3002 \u9664\u4e86\u524d\u9762\u63d0\u5230\u7684\u670d\u52a1\u7f51\u683c\u57fa\u672c\u529f\u80fd\uff0cIstio\u8fd8\u63d0\u4f9b\u4e86\u5bf9\u7269\u7406\u673a\u548cConsul\u7684\u6ce8\u518c\u670d\u52a1\u7684\u652f\u6301\uff0c\u5e76\u63d0\u4f9b\u4e86\u63a5\u53e3\uff0c\u7528\u9002\u914d\u5668\u4e0e\u5916\u754c\u7684\u7b2c\u4e09\u65b9IT\u7cfb\u7edf\u8fdb\u884c\u5bf9\u63a5\u3002</p> <p><code>Kubernetes</code> \u662f\u5176\u4e3b\u8981\u652f\u6301\u7684\u5e73\u53f0\uff0c\u5bf9\u5176\u4ed6\u5e73\u53f0\u7684\u652f\u6301\u8fd8\u5f88\u521d\u7ea7\uff0e\u5982\u679c\u6ca1\u6709\u81ea\u7814\u529f\u80fd\uff0c\u5219\u4e0d\u5efa\u8bae \u5c1d\u8bd5\uff0c\u672c\u4e66\u4e5f\u4e0d\u4f1a\u63d0\u53ca\u8fd9\u4e00\u90e8\u5206\u5185\u5bb9\u3002 </p>"},{"location":"chap5/2Istio_Intro/#1-istio","title":"1\u3001 Istio\u7684\u6838\u5fc3\u7ec4\u4ef6\u53ca\u5176\u529f\u80fd","text":"<p>Istio\u603b\u4f53\u6765\u8bf4\u5206\u4e3a\u4e24\u90e8\u5206\uff1a<code>\u63a7\u5236\u9762</code>\u548c<code>\u6570\u636e\u9762</code></p> <p>\u5982\u4e0b\u6240\u8ff0\u3002 </p> <ul> <li>\u6570\u636e\u9762\u88ab\u79f0\u4e3a\u201cSidecar\"\uff0c\u53ef\u5c06\u5176\u7406\u89e3\u4e3a\u65e7\u5f0f\u4e09\u8f6e\u6469\u6258\u8f66\u7684\u6302\u6597\u3002Sidecar, \u901a\u8fc7\u6ce8\u4eba\u7684\u65b9\u5f0f\u548c\u4e1a\u52a1\u5bb9\u5668\u5171\u5b58\u4e8e\u4e00\u4e2a<code>Pod</code>\u4e2d\uff0c\u4f1a\u52ab\u6301\u4e1a\u52a1\u5e94\u7528\u5bb9\u5668\u7684\u6d41\u91cf\uff0c\u5e76\u63a5\u53d7\u63a7\u5236\u9762\u7ec4\u4ef6\u7684\u63a7\u5236\uff0c\u540c\u65f6\u4f1a\u5411\u63a7\u5236\u9762\u8f93\u51fa\u65e5\u5fd7\u3001\u8ddf\u8e2a\u53ca\u76d1\u63a7\u6570\u636e\u3002 </li> <li>\u63a7\u5236\u9762\u662f<code>Istio</code>\u7684\u6838\u5fc3\uff0c\u7ba1\u7406<code>Istio</code>\u7684\u6240\u6709\u529f\u80fd\u3002 </li> </ul> <p><code>Istio</code>\u7684\u4e3b\u8981\u7ec4\u4ef6\u53ca\u5176\u76f8\u4e92\u5173\u7cfb\u5927\u81f4\u5982\u56fe\u6240\u793a\uff0c\u4e0b\u9762\u5bf9\u8fd9\u4e9b\u5173\u952e\u7ec4\u4ef6\u8fdb\u884c\u8bb2\u89e3\u3002 </p>"},{"location":"chap5/2Istio_Intro/#1-1-pilot","title":"1-1 Pilot","text":"<p><code>Pilot</code>\u662f<code>Istio</code>\u7684\u4e3b\u8981\u63a7\u5236\u70b9\uff0c<code>Istio</code>\u7684\u6d41\u91cf\u5c31\u662f\u7531<code>Pilot</code>\u7ba1\u7406\u7684\uff08\u5177\u4f53\u6267\u884c\u662f\u7531 <code>Sidecar</code> \u5b8c\u6210\u7684\uff09\u3002 </p> <p></p> <p>\u5728\u6574\u4e2a\u7cfb\u7edf\u4e2d\uff0c<code>Pilot</code>\u5b8c\u6210\u4ee5\u4e0b\u4efb\u52a1\uff1a</p> <ul> <li>\u4ece<code>Kubernetes</code>\u6216\u8005\u5176\u4ed6\u5e73\u53f0\u7684\u6ce8\u518c\u4e2d\u5fc3\u83b7\u53d6\u670d\u52a1\u4fe1\u606f\uff0c\u5b8c\u6210\u670d\u52a1\u53d1\u73b0\u8fc7\u7a0b\uff1b </li> <li>\u8bfb\u53d6<code>Istio</code>\u7684\u5404\u9879\u63a7\u5236\u914d\u7f6e\uff0c\u5728\u8fdb\u884c\u8f6c\u6362\u4e4b\u540e\uff0c\u5c06\u5176\u53d1\u7ed9\u6570\u636e\u9762\u8fdb\u884c\u5b9e\u65bd\u3002 </li> </ul> <p><code>Pilot</code>\u7684\u914d\u7f6e\u5185\u5bb9\u4f1a\u88ab\u8f6c\u6362\u4e3a\u6570\u636e\u9762\u80fd\u591f\u7406\u89e3\u7684\u683c\u5f0f\uff0c\u4e0b\u53d1\u7ed9\u6570\u636e\u9762\u7684<code>Sidecar</code>, <code>Sidecar</code> \u6839\u636e <code>Pilot</code> \u6307\u4ee4\uff0c\u5c06\u8def\u7531\u3001\u670d\u52a1\u3001\u76d1\u542c\u3001\u96c6\u7fa4\u7b49\u5b9a\u4e49\u4fe1\u606f\u8f6c\u6362\u4e3a\u672c\u5730\u914d\u7f6e\uff0c\u5b8c\u6210\u63a7\u5236\u884c\u4e3a\u7684\u843d\u5730\u3002</p> <p></p> <ol> <li>\u7528\u6237\u901a\u8fc7 <code>kubectl</code> \u6216\u8005 <code>istioctl</code> \uff08\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7API\uff09\u5728Kubernetes \u4e0a\u521b\u5efa <code>CRD</code>\u8d44\u6e90\uff0c \u5bf9 <code>Istio</code>\u63a7\u5236\u5e73\u9762\u53d1\u51fa\u6307\u4ee4</li> <li><code>Pilot</code> \u76d1\u542c CRD \u4e2d\u7684 <code>config</code>, <code>rbac</code>, <code>networking</code>\uff0c \u5728\u68c0\u6d4b\u5230\u8d44\u6e90\u5bf9\u8c61\u7684\u53d8\u66f4\u4e4b\u540e,\u9488\u5bf9\u5176\u4e2d\u6d89\u53ca\u7684\u670d\u52a1\uff0c \u53d1\u51fa\u6307\u4ee4\u7ed9\u5bf9\u5e94\u7684<code>Sidecar</code></li> <li><code>Sidecar</code> \u6839\u636e\u8fd9\u4e9b\u6307\u4ee4\u66f4\u65b0\u81ea\u8eab\u7684\u914d\u7f6e\uff0c\u6839\u636e\u914d\u7f6e\u4fee\u6b63\u901a\u4fe1\u7684\u884c\u4e3a</li> </ol>"},{"location":"chap5/2Istio_Intro/#1-2-mixer","title":"1-2 Mixer","text":"<p><code>Mixer</code>\u7684\u804c\u8d23\u4e3b\u8981\u6709\u4e24\u4e2a\uff0c \u9884\u68c0\u548c\u56de\u62a5, \u7b80\u5355\u7684\u793a\u610f\u56fe</p> <p></p> <p>Mixer\u7684\u7b80\u5355\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\u3002 </p> <ol> <li>\u7528\u6237\u5c06<code>Mixer</code>\uff1a\u914d\u7f6e\u53d1\u9001\u5230<code>Kubernetes</code>\u4e2d\u3002 </li> <li><code>Mixer</code>\uff1a\u901a\u8fc7\u5bf9<code>Kubernetes</code>\u8d44\u6e90\u7684\u76d1\u542c\uff0c\u83b7\u77e5\u914d\u7f6e\u7684\u53d8\u5316\u3002 </li> <li>\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u5728\u6bcf\u6b21\u8c03\u7528\u4e4b\u524d\uff0c\u90fd\u5411 <code>Mixer</code> \u53d1\u51fa\u9884\u68c0\u8bf7\u6c42\uff0c\u67e5\u770b\u8c03\u7528\u662f\u5426\u5141\u8bb8\u6267\u884c\u3002\u5728\u6bcf\u6b21\u8c03\u7528\u4e4b\u540e\uff0c\u90fd\u53d1\u51fa\u62a5\u544a\u4fe1\u606f\uff0c\u5411<code>Mixer</code>\u6c47\u62a5\u5728\u8c03\u7528\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u76d1\u63a7\u8ddf\u8e2a\u6570\u636e\u3002</li> </ol> <p>\u5728<code>Mixer</code>\u4e2d\u5305\u542b\u591a\u4e2a\u88ab\u79f0\u4e3a<code>Adapter</code>\u7684\u7ec4\u4ef6\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u7528\u6765\u5904\u7406 \u5728<code>Mixer</code>\u4e2d\u63a5\u6536\u7684\u9884\u68c0\u548c\u62a5\u544a\u6570\u636e\uff0c\u4ece\u800c\u5b8c\u6210<code>Mixer</code>\u7684\u5404\u79cd\u529f\u80fd\u3002 </p>"},{"location":"chap5/2Istio_Intro/#1-3-citadel","title":"1-3 Citadel","text":"<p><code>Citadel</code>\u5728Istio\u7684\u65e9\u671f\u7248\u672c\u4e2d\u88ab\u79f0\u4e3a<code>Istio-CA</code>\uff0c\u4e0d\u96be\u770b\u51fa\uff0c\u5b83\u662f\u7528\u4e8e\u8bc1\u4e66\u7ba1\u7406\u7684\u3002 \u5728\u96c6\u7fa4\u4e2d\u542f\u7528\u4e86\u670d\u52a1\u4e4b\u95f4\u7684\u52a0\u5bc6\u4e4b\u540e\uff0c<code>Citadel</code>\u8d1f\u8d23\u4e3a\u96c6\u7fa4\u4e2d\u7684\u5404\u4e2a\u670d\u52a1\u5728\u7edf\u4e00<code>CA</code>\u7684\u6761\u4ef6\u4e0b\u751f\u6210\u8bc1\u4e66\uff0c\u5e76\u4e0b\u53d1\u7ed9\u5404\u4e2a\u670d\u52a1\u4e2d\u7684<code>Sidecar</code>\uff0c\u670d\u52a1\u4e4b\u95f4\u7684<code>TLS</code>\u5c31\u4f9d\u8d56\u8fd9\u4e9b\u8bc1\u4e66\u5b8c\u6210\u6821\u9a8c\u8fc7\u7a0b\u3002</p>"},{"location":"chap5/2Istio_Intro/#1-4-sidecarenvoy","title":"1-4 Sidecar(Envoy)","text":"<p><code>Sidecar</code>\u5c31\u662f<code>Istio</code>\u4e2d\u7684\u6570\u636e\u9762\uff0c\u8d1f\u8d23\u63a7\u5236\u9762\u5bf9\u7f51\u683c\u63a7\u5236\u7684\u5b9e\u9645\u6267\u884c\u3002</p> <p><code>Istio</code>\u4e2d\u7684\u9ed8\u8ba4<code>Sidecar</code>\u662f\u7531<code>Envoy</code>\u6d3e\u751f\u51fa\u6765\u7684\uff0c\u5728\u7406\u8bba\u4e0a\uff0c\u53ea\u8981\u652f\u6301<code>Envoy</code>\u7684 <code>xDS</code>\u534f\u8bae\uff0c\u5176\u4ed6\u7c7b\u4f3c\u7684\u53cd\u5411\u4ee3\u7406\u8f6f\u4ef6\u5c31\u90fd\u53ef\u4ee5\u4ee3\u66ff<code>Envoy</code>\u6765\u62c5\u5f53\u8fd9\u4e00\u89d2\u8272\u3002 </p> <p>\u5728<code>Istio</code>\u7684\u9ed8\u8ba4\u5b9e\u73b0\u4e2d\uff0c<code>Istio</code>\u5229\u7528<code>istio-init</code>\u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u7684<code>iptables</code>\u6307\u4ee4\uff0c\u5bf9\u4e00\u6240\u5728<code>Pod</code>\u7684\u6d41\u91cf\u8fdb\u884c\u52ab\u6301\uff0c\u4ece\u800c\u63a5\u7ba1<code>Pod</code>\u4e2d\u5e94\u7528\u7684\u901a\u4fe1\u8fc7\u7a0b\uff0c\u5982\u6b64\u4e00\u6765\uff0c\u5c31\u83b7\u5f97\u4e86\u901a\u4fe1\u7684\u63a7\u5236\u6743\uff0c\u63a7\u5236\u9762\u7684\u63a7\u5236\u76ee\u7684\u6700\u7ec8\u5f97\u4ee5\u5b9e\u73b0\u3002 </p> <p>\u6ce8\u4eba<code>Sidecar</code>\u524d\u540e\u7684\u901a\u4fe1\u6a21\u5f0f\u53d8\u5316\u5982\u56fe\u6240\u793a\u3002 </p> <p>\u719f\u6089<code>Kubernetes</code>\u7684\u5e94\u8be5\u90fd\u77e5\u9053\uff0c\u5728\u540c\u4e00\u4e2a<code>Pod</code>\u5185\u7684\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\uff0c\u7f51\u7edc\u6808\u662f\u5171\u4eab\u7684\uff0c\u8fd9\u6b63\u662f<code>Sidecar</code>\u6a21\u5f0f\u7684\u5b9e\u73b0\u57fa\u7840(Pause Pod)\u3002\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c<code>Sidecar</code>\u5728\u52a0\u4eba\u4e4b\u540e\uff0c\u539f\u6709\u7684\u6e90\u5bb9\u5668\u4e00\u76ee\u7684\u5bb9\u5668\u7684\u76f4\u63a5\u901a\u4fe1\u65b9\u5f0f\uff0c\u53d8\u6210\u4e86<code>\u6e90\u5bb9\u5668\u4e00&gt;Sidecar-&gt;Sidecar\u4e00&gt;\u76ee\u7684\u5bb9\u5668</code>\u7684\u6a21\u5f0f\u3002</p> <p>\u800c<code>Sidecar</code>\u662f\u7528\u6765\u63a5\u53d7\u63a7\u5236\u9762\u7ec4\u4ef6\u7684\u64cd\u4f5c\u7684\uff0c\u8fd9\u6837\u4e00\u6765\uff0c\u5c31\u8ba9\u901a\u4fe1\u8fc7\u7a0b\u4e2d\u7684\u63a7\u5236\u548c\u89c2\u5bdf\u6210\u4e3a\u53ef\u80fd\u3002 </p> <p></p>"},{"location":"chap5/2Istio_Intro/#2","title":"2\u3001 \u6838\u5fc3\u914d\u7f6e\u5bf9\u8c61","text":"<p><code>Istio</code>\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4f1a\u8fdb\u884c<code>CRD</code>\u7684\u521d\u59cb\u5316\uff0c\u5728<code>Kubernetes</code>\u96c6\u7fa4\u4e2d\u6ce8\u518c\u4e00\u7cfb\u5217\u7684 <code>CRD</code>. <code>CRD</code>\u5728\u6ce8\u518c\u6210\u529f\u4e4b\u540e\uff0c\u4f1a\u5efa\u7acb\u4e00\u4e9b\u57fa\u7840\u5bf9\u8c61\uff0c\u5b8c\u6210<code>Istio</code>\u7684\u521d\u59cb\u8bbe\u7f6e\u3002</p> <p>\u5728\u524d\u9762\u4ecb\u7ecd\u7ec4\u4ef6\u65f6\u66fe\u591a\u6b21\u63d0\u5230\uff0c\u7528\u6237\u5229\u7528<code>Istio</code>\u63a7\u5236\u5fae\u670d\u52a1\u901a\u4fe1\uff0c\u662f\u901a\u8fc7\u5411 <code>Kubernetes</code>\u63d0\u4ea4<code>CRD</code>\u8d44\u6e90\u7684\u65b9\u5f0f\u5b8c\u6210\u7684\u3002</p> <p><code>Istio</code>\u4e2d\u7684\u8d44\u6e90\u5206\u4e3a\u4e09\u7ec4\u8fdb\u884c\u7ba1\u7406\uff0c\u5206\u522b\u662f <code>networking.istio.io</code>. <code>config.istio.io</code>\u53ca<code>authentication.istio.io</code>\uff0c\u4e0b\u9762\u5c06\u5206\u522b\u8fdb\u884c\u4ecb\u7ecd\u3002 </p>"},{"location":"chap5/2Istio_Intro/#2-1-networkingistio","title":"2-1 <code>networking.istio</code>","text":"<p><code>networking.istio</code> \u7cfb\u5217\u5bf9\u8c61\u5728<code>Istio</code> \u4e2d\u53ef\u80fd\u662f\u4f7f\u7528\u9891\u7387\u6700\u9ad8\u7684 <code>Istio</code>\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\u5c31\u662f\u7528\u8fd9\u4e00\u7ec4\u5bf9\u8c61\u5b8c\u6210\u7684\u8fd9\u91cc\u9009\u62e9\u5176\u5dfe\u6700\u5e38\u7528\u7684\u5bf9\u8c61\u8fdb\u884c\u7b80\u5355\u4ecb\u7ecd.</p> <p>\u5728<code>networking.istio,io</code>\u7684\u4e0b\u5c5e\u8d44\u6e90\u4e2d<code>Virtual Service</code>\u662f\u4e00\u4e2a\u63a7\u5236\u4e2d\u5fc3\u5b83\u7684\u529f\u80fd  \u7b80\u5355\u8bf4\u6765\u5c31\u662f\uff1b\u5b9a\u4e49\u4e00\u7ec4\u6761\u4ef6\uff0c\u5c06\u7b26\u5408\u8be5\u6761\u4ef6\u7684\u6d41\u91cf\u6309\u7167\u5728\u5bf9\u8c61\u4e2d\u914d\u7f6e\u7684\u5bf9\u5e94\u7b56\u7565  \u8fdb\u884c\u5904\u7406\uff0c\u6700\u540e\u5c06\u8def\u7531\u8f6c\u5230\u5339\u914d\u7684\u65e5\u6807\u4e2d\u3002\u4e0b\u9762\u5217\u51fa\u51e0\u4e2a\u5178\u578b\u7684\u5e94\u7528\u573a\u666f\u3002 </p> <ul> <li>(1\uff09\u6765\u81ea\u670d\u52a1<code>A</code>\u7248\u672c<code>1</code>\u7684\u670d\u52a1\uff0c\u5982\u679c\u8981\u8bbf\u95ee\u670d\u52a1<code>B</code>\uff0c\u5219\u8981\u5c06\u8def\u7531\u6307\u5411\u670d\u52a1<code>B</code>\u7684\u7248\u672c<code>2</code> </li> <li>(2\uff09\u5728\u670d\u52a1<code>x</code>\u53d1\u5f80\u670d\u52a1<code>Y</code>\u7684<code>HTTP</code>\u8bf7\u6c42\u4e2d\uff0c\u5982\u679c<code>Header</code>\u5305\u542b<code>canary=true</code> \u5219\u628a\u670d\u52a1\u76ee\u6807\u6307\u5411\u670d\u52a1<code>Y</code>\u7684\u7248\u672c<code>3</code>.\u5426\u5219\u53d1\u7ed9\u670d\u52a1<code>Y</code>\u7684\u7248\u672c<code>2</code> </li> <li>(3\uff09\u4e3a\u4ece\u670d\u52a1<code>M</code>\u5230\u670d\u52a1<code>N</code>\u7684\u6240\u6709\u8bbf\u95ee\u90fd\u52a0\u4eba\u5ef6\u8fdf\uff0c\u4ee5\u6d4b\u8bd5\u5728\u7f51\u7edc\u72b6\u51b5\u4e0d\u4f73\u65f6\u7684\u8868\u73b0\u3002 </li> </ul> <p>\u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u65b9\u9762\u7684\u529f\u80fd\u662f\u6bd4\u8f83\u590d\u6742\u7684 \u56e0\u6b64\u5176\u4e2d\u5305\u542b\u7684\u884c\u4e3a\u5b9a\u4e49\u4e5f\u4e00\u5b9a\u4e0d\u7b80\u5355\u3002 <code>Istio</code> \u5bf9\u8def\u7531\u7ba1\u7406\u505a\u4e86\u5f88\u597d\u7684\u62bd\u8c61\u3002\u56fe\u5c55\u793a\u4e86\u6d41\u91cf\u8bbf\u95ee\u6d41\u7a0b\u4e2d\u7684\u51e0\u4e2a\u5173\u952e\u5bf9\u8c61 </p> <p></p>"},{"location":"chap5/2Istio_Intro/#1-gateway","title":"1. Gateway","text":"<p>\u5728\u8bbf\u95ee\u670d\u52a1\u65f6\uff0c\u4e0d\u8bba\u662f\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e92\u8bbf\uff0c\u8fd8\u662f\u901a\u8fc7<code>ingress</code>\u8fdb\u4eba\u7f51\u683c\u7684\u5916\u90e8\u6d41\u91cf\uff0c\u9996\u5148\u8981\u7ecf\u8fc7\u7684\u8bbe\u65bd\u90fd\u662f<code>Gateway</code>. </p> <p><code>Gateway</code>\u5bf9\u8c61\u63cf\u8ff0\u4e86\u8fb9\u7f18\u63a5\u4eba\u8bbe\u5907\u7684\u6982\u5ff5\uff0c \u5176\u4e2d\u5305\u542b\u5bf9\u5f00\u653e\u7aef\u53e3\u3001\u4e3b\u673a\u540d\u53ca\u53ef\u80fd\u5b58\u5728\u7684<code>TLS</code>\u8bc1\u4e66\u7684\u5b9a\u4e49\u3002</p> <ul> <li>\u7f51\u7edc\u8fb9\u7f18\u7684<code>ingress</code> \u6d41\u91cf\uff0c\u4f1a\u901a\u8fc7\u5bf9\u5e94\u7684<code>Istio Ingress Gateway Controller</code>\u8fdb\u5165\uff1b</li> <li> <p>\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e92\u8bbf\uff0c \u5219\u901a\u8fc7\u865a\u62df\u7684<code>mesh</code>\u7f51\u5173\u8fdb\u884c\uff08<code>mesh</code>\u7f51\u5173\u4ee3\u8868\u7f51\u683c\u5185\u90e8\u7684\u6240\u6709<code>Sidecar</code>)</p> </li> <li> <p><code>Pilot</code>\u4f1a\u6839\u636e<code>Gateway</code> \u548c\u4e3b\u673a\u540d\u8fdb\u884c\u68c0\u7d22\uff0c\u5982\u679c\u5b58\u5728\u5bf9\u5e94\u7684<code>VirtualService</code>\uff0c\u5219\u4ea4 \u7531<code>VirtualService</code>\u5904\u7406\uff1b</p> </li> <li>\u5982\u679c\u662f<code>Mesh Gateway</code>\u4e14\u4e0d\u5b58\u5728\u5bf9\u5e94\u8fd9\u4e00\u4e3b\u673a\u540d\u7684 <code>VirtualService</code>\uff0c\u5219\u5c1d\u8bd5\u8c03\u7528<code>Kubernetes Service</code>(SVC)\uff1b\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u53d1\u751f<code>404</code>\u9519\u8bef\u3002 </li> </ul>"},{"location":"chap5/2Istio_Intro/#2-virtualservice","title":"2 VirtualService","text":"<p><code>Virtual Service</code>\u5bf9\u8c61\u4e3b\u8981\u7531\u4ee5\u4e0b\u90e8\u5206\u7ec4\u6210\u3002 </p> <ul> <li>(1) <code>Host</code>\uff1a\u8be5\u5bf9\u8c61\u6240\u8d1f\u8d23\u7684\u4e3b\u673a\u540d\u79f0\uff0c\u5982\u679c\u5728<code>Kubernetes</code>\u96c6\u7fa4\u4e2d\uff0c\u5219\u8fd9\u4e2a\u4e3b\u673a\u540d\u53ef\u4ee5\u662f\u670d\u52a1\u540d\u3002 </li> <li>(2) <code>Gateway</code>\uff1a\u6d41\u91cf\u7684\u6765\u6e90\u7f51\u5173\uff0c\u5728\u540e\u9762\u4f1a\u4ecb\u7ecd\u7f51\u5173\u7684\u6982\u5ff5\u3002\u5982\u679c\u8fd9\u4e00\u5b57\u6bb5\u88ab\u7701 \u7565\uff0c\u5219\u4ee3\u8868\u4f7f\u7528\u7684\u7f51\u5173\u540d\u4e3a<code>\u201cmesh\"</code>\uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u7684\u7f51\u683c\u5185\u90e8\u670d\u52a1\u4e92\u8054\u6240\u7528\u7684\u7f51\u5173\u3002 </li> <li>(3\uff09\u8def\u7531\u5bf9\u8c61\uff1a\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\uff0c\u5982\u679c\u7b26\u5408\u524d\u9762\u7684<code>Host</code>\u548c<code>Gateway</code>\u7684\u6761\u4ef6\uff0c\u5c31\u9700\u8981\u6839\u636e\u5b9e\u9645\u534f\u8bae\u5bf9\u6d41\u91cf\u7684\u5904\u7406\u65b9\u5f0f\u8fdb\u884c\u7504\u522b\u3002\u5176\u539f\u56e0\u662f\uff1a<code>HTTP</code>\u662f\u4e00\u79cd\u900f\u660e\u534f\u8bae\uff0c\u53ef\u4ee5\u7ecf\u8fc7\u5bf9\u62a5\u6587\u7684\u89e3\u6790\uff0c\u5b8c\u6210\u66f4\u7ec6\u81f4\u7684\u63a7\u5236\uff1b\u800c\u5bf9\u4e8e\u539f\u59cb\u7684TCP\u6d41\u91cf\u6765\u8bf4\uff0c\u5c31\u65e0\u6cd5 \u5b8c\u6210\u8fc7\u4e8e\u590d\u6742\u7684\u4efb\u52a1\u4e86\u3002 </li> </ul>"},{"location":"chap5/2Istio_Intro/#3-tcptlshttp-route","title":"3 TCP/TLS/HTTP Route","text":"<p>\u8def\u7531\u5bf9\u8c61\u76ee\u524d\u53ef\u4ee5\u662f<code>HTTP</code>\u3001<code>TCP</code>\u6216\u8005<code>TLS</code>\u4e2d\u7684\u4e00\u4e2a\uff0c\u5206\u522b\u9488\u5bf9\u4e0d\u540c\u7684\u534f\u8bae\u8fdb\u884c\u5de5\u4f5c\u3002\u6bcf\u79cd\u8def\u7531\u5bf9\u8c61\u90fd\u81f3\u5c11\u5305\u542b\u4e24\u90e8\u5206\uff1a\u5339\u914d\u6761\u4ef6\u548c\u76ee\u7684\u8def\u7531\u3002 \u4f8b\u5982\uff0c\u5728<code>HTTPRoute</code>\u3002 </p> <p>\u5bf9\u8c61\u4e2d\u5c31\u5305\u542b\u7528\u4e8e\u5339\u914d\u7684<code>HTTPMatchRequest</code>\u5bf9\u8c61\u6570\u7ec4\uff0c\u4ee5\u53ca\u7528\u4e8e\u63cf\u8ff0\u76ee\u6807\u670d\u52a1\u7684 <code>DestinationWeight</code>\u5bf9\u8c61\uff0c\u5e76\u4e14<code>HTTPMatchRequest</code>\u7684\u5339\u914d\u6761\u4ef6\u8f83\u4e3a\u4e30\u5bcc\uff0c\u4f8b\u5982\u524d\u9762\u63d0\u5230\u7684<code>http header</code>\u6216\u8005<code>uri</code>\u7b49\u9664\u6b64\u4e4b\u5916\uff0c<code>HTTP</code>\u8def\u7531\u5bf9\u8c61\u53d7\u76ca\u4e8e<code>HTTP</code>\u7684\u900f\u660e\u6027\uff0c\u5305\u542b\u5f88\u591a\u4e13\u5c5e\u7684\u989d\u5916\u7279\u6027\uff0c\u4f8b\u5982\u8d85\u65f6\u63a7\u5236\u3001\u91cd\u8bd5\u3001\u9519\u8bef\u6ce8\u5165\u7b49\u3002</p> <p>\u76f8\u5bf9\u6765\u8bf4\uff0c<code>TCPRoute</code>\u3002 \u7b80\u5355\u5f88\u591a\uff0c\u5b83\u7684\u5339\u914d\u501f\u52a9\u8d44\u6e90<code>L4MatchAttributes</code>\u5bf9\u8c61\u5b8c\u6210\uff0c\u5176\u4e2d\u9664<code>Istio</code>\u56fa\u6709\u7684\u6807\u7b7e\u548c<code>Gateway</code>\u5916\uff0c\u4ec5\u5305\u542b\u5730\u5740\u548c\u7aef\u53e3\u3002 </p> <p>\u5728\u5339\u914d\u5b8c\u6210\u540e\uff0c\u81ea\u7136\u5c31\u662f\u9009\u62e9\u5408\u9002\u7684\u76ee\u6807\u4e86\u3002 </p>"},{"location":"chap5/2Istio_Intro/#4-destinationweight","title":"4 DestinationWeight","text":"<p>\u5404\u534f\u8bae\u8def\u7531\u7684\u76ee\u6807\u5b9a\u4e49\u662f\u4e00\u81f4\u7684\uff0c\u90fd<code>\u7531Destination Weight</code>\u5bf9\u8c61\u6570\u7ec4\u6765\u5b8c\u6210 <code>Destination Weight</code>\u6307\u5230\u67d0\u4e2a\u76ee\u6807\uff08<code>Destination</code>\u5bf9\u8c61\uff09\u7684\u6d41\u91cf\u6743\u91cd\uff0c\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u591a\u4e2a\u76ee\u6807\u53ef\u4ee5\u540c\u65f6\u4e3a\u8be5<code>Virtual Service</code>\u63d0\u4f9b\u670d\u52a1\uff0c\u5e76\u6309\u7167\u6743\u91cd\u8fdb\u884c\u6d41\u91cf\u5206\u914d\u3002</p>"},{"location":"chap5/2Istio_Intro/#5-destination","title":"5 Destination","text":"<p>\u76ee\u6807\u5bf9\u8c61\uff08<code>Destination</code>\uff09\u7531<code>Subset</code>\u548c<code>Port</code>\u4e24\u4e2a\u5143\u7d20\u7ec4\u6210\u3002</p> <p><code>Subset</code>\u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u6307\u670d\u52a1\u7684\u4e00\u4e2a\u5b50\u96c6\uff0c\u5b83\u5728<code>Kubernetes</code>\u4e2d\u4ee3\u8868\u4f7f\u7528\u6807\u7b7e\u9009\u62e9\u5668\u533a\u5206\u7684\u4e0d\u540c<code>Pod</code>\uff08\u4f8b\u5982\u4e24\u4e2a<code>Deployment</code>)\u3002 <code>Port</code>\u4ee3\u8868\u7684\u5219\u662f\u670d\u52a1\u7684\u7aef\u53e3\u3002 </p> <p>6\uff0e\u5c0f\u7ed3</p> <p>\u81f3\u6b64\uff0c\u6d41\u91cf\u7ecf\u8fc7\u591a\u4e2a\u5bf9\u8c61\u7684\u9010\u7ea7\u5904\u7406\uff0c\u6210\u529f\u5230\u8fbe\u4e86<code>Pod</code>\uff0c </p>"},{"location":"chap5/2Istio_Intro/#2-2-configistioio","title":"2-2 <code>config.istio.io</code>","text":"<p><code>config.istio.io</code>\u4e2d\u7684\u5bf9\u8c61\u7528\u4e8e\u4e3a<code>Mixer</code>\u7ec4\u4ef6\u63d0\u4f9b\u914d\u7f6e\u3002</p> <p><code>Mixer</code> \u4f9b\u4e86\u9884\u68c0\u548c\u62a5\u544a\u8fd9\u4e24\u4e2a\u529f\u80fd\uff0c\u8fd9\u4e24\u4e2a\u529f\u80fd\u770b\u4f3c\u7b80\u5355\uff0c\u4f46\u662f\u56e0\u4e3a\u5927\u91cf\u9002\u914d\u5668\u7684\u5b58\u5728\u3002\u53d8\u5f97\u76f8\u5f53\u590d\u6742\uff0c \u56fe\u5c55\u793a\u4e86<code>Mixer</code>\u5bf9\u6570\u636e\u5904\u7406\u8fc7\u7a0b</p> <p></p> <p>1.Rule</p> <ul> <li><code>Rule</code>\u5bf9\u8c61\u662f<code>Mixer</code>\u7684\u4eba\u53e3\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e2a<code>match</code>\u6210\u5458\u548c\u4e00\u4e2a\u903b\u8f91\u8868\u8fbe\u5f0f\uff0c\u53ea\u6709\u7b26\u5408\u8868\u8fbe\u5f0f\u5224\u65ad\u7684\u6570\u636e\u624d\u4f1a\u88ab\u4ea4\u7ed9<code>Action</code>\u5904\u7406\u3002</li> <li>\u903b\u8f91\u8868\u8fbe\u5f0f\u4e2d\u7684\u53d8\u91cf\u88ab\u79f0\u4e3a<code>attribute</code> \uff08\u5c5e\u6027\uff09\uff0c\u5176\u4e2d\u7684\u5185\u5bb9\u6765\u81ea<code>Envoy</code>\u63d0\u4ea4\u7684\u6570\u636e\u3002 </li> </ul> <p>2.Action</p> <p><code>Action</code>\u8d1f\u8d23\u89e3\u51b3\u7684\u95ee\u9898\u5c31\u662f\uff1a\u5c06\u7b26\u5408\u4eba\u53e3\u6807\u51c6\u7684\u6570\u636e\uff0c\u5728\u7528\u4ec0\u4e48\u65b9\u5f0f\u52a0\u5de5\u4e4b\u540e\uff0c\u4ea4\u7ed9\u54ea\u4e2a\u9002\u914d\u5668\u8fdb\u884c\u5904\u7406\u3002<code>Action</code>\u5305\u542b\u4e24\u4e2a\u6210\u5458\u5bf9\u8c61\uff1a</p> <ul> <li>\u4e00\u4e2a\u662f<code>Instance</code>\uff0c\u4f7f\u7528<code>Template</code>\u5bf9\u63a5\u6536\u5230\u7684\u6570\u636e\u8fdb\u884c\u5904\u7406\uff1b</li> <li>\u4e00\u4e2a\u662f<code>Handler</code>\uff0c\u4ee3\u8868\u4e00\u4e2a\u9002\u914d\u5668\u7684\u5b9e\u4f8b\uff0c\u7528\u4e8e\u63a5\u6536\u5904\u7406\u540e\u7684\u6570\u636e\u3002 </li> </ul> <p>3.Instance</p> <p><code>Instance</code>\u4e3b\u8981\u7528\u4e8e\u4e3a\u8fdb\u5165\u7684\u6570\u636e\u9009\u62e9\u4e00\u4e2a\u6a21\u677f\uff0c\u5e76\u5728\u6570\u636e\u4e2d\u62bd\u53d6\u67d0\u4e9b\u5b57\u6bb5\u4f5c\u4e3a\u6a21\u677f\u7684\u53c2\u6570\uff0c\u4f20\u8f93\u7ed9\u6a21\u677f\u8fdb\u884c\u5904\u7406\u3002 </p> <p>4.Adapter </p> <p><code>Adapter</code>\u5728<code>Istio</code>\u53ea\u88ab\u5b9a\u4e49\u4e3a\u4e00\u4e2a\u884c\u4e3a\u89c4\u8303\uff0c\u800c\u4e00\u4e9b\u5fc5\u8981\u7684\u5b9e\u4f8b\u5316\u6570\u636e\u662f\u9700\u8981\u518d\u6b21\u8fdb\u884c\u521d\u59cb\u5316\u7684\uff0c\u4f8b\u5982<code>RedisQuota</code>\u9002\u914d\u5668\u4e2d\u7684<code>Redis</code>\u5730\u5740\uff0c\u6216\u8005<code>Listchecker</code>\u4e2d\u7684\u9ed1\u767d\u540d\u5355\u7b49\uff0c\u53ea\u6709\u8fd9\u4e9b\u6570\u636e\u5f97\u5230\u6b63\u5f0f\u7684\u521d\u59cb\u5316\uff0c<code>Adapter</code>\u624d\u80fd\u88ab\u6295\u4eba\u4f7f\u7528</p> <p>\u7ecf\u8fc7<code>Handler</code>\u5b9e\u4f8b\u5316\u4e4b\u540e\u7684\u00b7Adapter\u00b7\uff0c\u5c31\u5177\u5907\u4e86\u5de5\u4f5c\u529f\u80fd\u3002</p> <ul> <li>\u6709\u4e9b<code>Adapter</code>\u662f<code>Istio</code>\u7684\u81ea\u8eab\u5b9e\u73b0\uff0c\u4f8b\u5982\u524d\u9762\u63d0\u5230\u7684<code>listcheck</code>\u6216\u8005<code>memquota</code>\uff1b</li> <li>\u6709\u4e9b<code>Adapter</code>\u662f\u7b2c\u4e09\u65b9\u670d\u52a1\uff0c\u4f8b\u5982<code>Prometheus</code>\u6216\u8005<code>Datadog</code>\u7b49\u3002</li> </ul> <p><code>Envoy</code>\u4f20\u51fa\u7684\u6570\u636e\u5c06\u4f1a\u901a\u8fc7\u8fd9\u4e9b\u5177\u4f53\u8fd0\u884c\u7684<code>Adapter</code>\u7684\u5904\u7406\uff0c\u5f97\u5230\u9884\u68c0\u7ed3\u679c\uff0c\u6216\u8005\u8f93\u51fa\u5404\u79cd\u76d1\u63a7\u3001\u65e5\u5fd7\u53ca\u8ddf\u8e2a\u6570\u636e\u3002</p> <p>5.Template</p> <p>\u987e\u540d\u601d\u4e49\uff0c<code>Template</code>\u662f\u4e00\u4e2a\u6a21\u677f\uff0c\u7528\u4e8e\u5bf9\u63a5\u6536\u5230\u7684\u6570\u636e\u8fdb\u884c\u518d\u52a0\u5de5. </p> <p>\u8fdb\u4eba<code>Mixer</code>\u4e2d\u7684\u6570\u636e\u90fd\u6765\u81ea<code>Sidecar</code>\uff0c\u4f46\u662f\u5404\u79cd\u9002\u914d\u5668\u5e94\u5bf9\u7684\u9700\u6c42\u5404\u6709\u5343\u79cb\uff0c\u751a\u81f3\u540c\u6837\u4e00\u4e2a\u9002\u914d\u5668\uff0c\u4e5f\u53ef\u80fd\u63a5\u6536\u5404\u79cd\u4e0d\u540c\u5f62\u5f0f\u7684\u6570\u636e\uff08\u4f8b\u5982<code>Prometheus</code>\u53ef\u80fd\u4f1a\u5728\u540c\u6837\u4e00\u6279\u6570\u636e\u4e2d\u83b7\u53d6\u4e0d\u540c\u7684\u6307\u6807\uff09,<code>Envoy</code>\u63d0\u4f9b\u7684\u539f\u59cb\u6570\u636e\u548c\u9002\u914d\u5668\u6240\u9700\u8981\u7684\u8f93\u4eba\u6570\u636e\u5b58\u5728\u683c\u5f0f\u4e0a\u7684\u5dee\u522b\uff0c\u56e0\u6b64\u9700\u8981\u5bf9\u539f\u59cb\u6570\u636e\u8fdb\u884c\u518d\u52a0\u5de5\u3002 </p> <p><code>Template</code>\u5c31\u662f\u8fd9\u6837\u4e00\u79cd\u5de5\u5177\uff0c\u5728\u7528\u6237\u7f16\u5236\u6a21\u677f\u5bf9\u8c61\u4e4b\u540e\uff0c\u7ecf\u8fc7\u6a21\u677f\u5904\u7406\u7684\u539f\u59cb\u6570\u636e\u4f1a\u88ab\u8f6c\u6362\u4e3a\u7b26\u5408\u9002\u914d\u5668\u8f93\u4eba\u8981\u6c42\u7684\u6570\u636e\u683c\u5f0f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728<code>Instance</code>\u5b57\u6bb5\u4e2d\u5f15\u7528</p> <p>6.Handler</p> <p><code>Handler</code>\u5bf9\u8c61\u7528\u4e8e\u5bf9<code>Adapter</code>\u8fdb\u884c\u5b9e\u4f8b\u5316\u3002</p> <p>\u8fd9\u7ec4\u5bf9\u8c61\u7684\u547d\u540d\u975e\u5e38\u4ee4\u4eba\u8d39\u89e3\uff0c\u4f46\u662f\u4ece\u5176\u529f\u80fd\u5217\u8868\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c<code>Mixer</code>\u7ba1\u7406\u4e86\u6240\u6709\u7b2c\u4e09\u65b9\u8d44\u6e90\u7684\u63a5\u5165\uff0c\u5927\u5927\u6269\u5c55\u4e86<code>Istio</code>\u7684\u4f5c\u7528\u8303\u56f4\uff0c\u5176\u5e94\u7528\u96be\u5ea6\u81ea\u7136\u6c34\u6da8\u8239\u9ad8\uff0c \u5e94\u8be5\u8bf4\u8fd8\u662f\u53ef\u4ee5\u7406\u89e3\u7684\u3002 </p>"},{"location":"chap5/2Istio_Intro/#2-3-authenticationistioio","title":"2-3 <code>authentication.istio.io</code>","text":"<p>\u8fd9\u4e00\u7ec4<code>API</code>\u7528\u4e8e\u5b9a\u4e49\u8ba4\u8bc1\u7b56\u7565\u3002\u5b83\u5728\u7f51\u683c\u7ea7\u522b\u3001\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u53ca\u670d\u52a1\u7ea7\u522b\u90fd\u63d0 \u4f9b\u4e86\u8ba4\u8bc1\u7b56\u7565\u7684\u8981\u6c42\uff0c\u8981\u6c42\u5728\u5185\u5bb9\u4e2d\u5305\u542b\u670d\u52a1\u95f4\u7684\u901a\u4fe1\u8ba4\u8bc1\uff0c\u4ee5\u53ca\u57fa\u4e8e<code>JWT</code>\u7684\u7ec8\u7aef\u8ba4\u8bc1\u3002\u8fd9\u91cc\u7b80\u5355\u4ecb\u7ecd\u5176\u4e2d\u6d89\u53ca\u7684\u5bf9\u8c61\u3002 </p> <p>1.Policy</p> <p><code>Policy</code>\u7528\u4e8e\u6307\u5b9a\u670d\u52a1\u4e00\u7ea7\u7684\u8ba4\u8bc1\u7b56\u7565\uff0c\u5982\u679c\u5c06\u5176\u547d\u540d\u4e3a<code>\u201cdefault\"</code>\uff0c\u90a3\u4e48\u8be5\u5bf9\u8c61\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u4f1a\u9ed8\u8ba4\u91c7\u7528\u8fd9\u4e00\u8ba4\u8bc1\u7b56\u7565\u3002<code>Policy</code>\u5bf9\u8c61\u7531\u4e24\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a\u7b56\u7565\u65e5\u6807\u548c\u8ba4\u8bc1\u65b9\u6cd5\u3002 </p> <ul> <li>\u7b56\u7565\u76ee\u6807\u5305\u542b\u670d\u52a1\u540d\u79f0\uff08\u6216\u4e3b\u673a\u540d\u79f0)\u53ca\u670d\u52a1\u7aef\u53e3\u53f7\u3002 </li> <li>\u8ba4\u8bc1\u65b9\u6cd5\u7531\u4e24\u4e2a\u53ef\u9009\u90e8\u5206\u7ec4\u6210\uff0c\u5206\u522b\u662f\u7528\u4e8e\u8bbe\u7f6e\u670d\u52a1\u95f4\u8ba4\u8bc1\u7684<code>peers</code>\u5b50\u5bf9\u8c61\uff0c\u4ee5\u53ca\u7528\u4e8e\u8bbe\u7f6e\u7ec8\u7aef\u8ba4\u8bc1\u7684origins\u5b50\u5bf9\u8c61\u3002 </li> </ul> <p>2.Mesh Policy</p> <p><code>MeshPolicy</code>\u53ea\u80fd\u88ab\u547d\u540d\u4e3a<code>\u201cdefault\"</code>\uff0c\u5b83\u4ee3\u8868\u7684\u662f\u6240\u6709\u7f51\u683c\u5185\u90e8\u5e94\u7528\u7684\u9ed8\u8ba4\u8ba4\u8bc1\u7b56\u7565\uff0c\u5176\u4f59\u90e8\u5206\u5185\u5bb9\u548c\u00b7Policy\u00b7\u4e00\u81f4\u3002 </p>"},{"location":"chap5/2Istio_Intro/#2-4-rbacistioio","title":"2-4 <code>rbac.istio.io</code>","text":"<p>\u5728<code>Istio</code>\u4e2d\u5b9e\u73b0\u4e86\u4e00\u4e2a\u548c<code>Kubernetes</code>\u9887\u4e3a\u76f8\u4f3c\u7684<code>RBAC</code>\uff08\u57fa\u4e8e\u89d2\u8272\u7684\uff09\u8bbf\u95ee\u63a7\u5236\u7cfb\u7edf\uff0c\u5176\u4e3b\u8981\u5bf9\u8c61\u4e3a<code>ServiceRole</code>\u548c<code>ServiceRoleBinding</code>.</p> <p>1 Service Role</p> <p><code>ServiceRole</code>\u7531\u4e00\u7cfb\u5217\u89c4\u5219\uff08rules\uff09\u7ec4\u6210\uff0c\u6bcf\u6761\u89c4\u5219\u90fd\u5bf9\u5e94\u4e00\u6761\u6743\u9650\uff0c\u5176\u4e2d\u63cf\u8ff0\u4e86\u6743\u9650\u6240\u5bf9\u5e94\u7684\u670d\u52a1\u3001\u670d\u52a1\u8def\u5f84\u53ca\u65b9\u6cd5\uff0c\u8fd8\u5305\u542b\u4e00\u7ec4\u53ef\u4ee5\u8fdb\u884c\u81ea\u5b9a\u4e49\u7684\u7ea6\u675f\u3002 </p> <p>2 Service Role Binding </p> <p>\u548c   Kubernetes RBAC \u7c7b\u4f3c\uff0c\u8be5\u5bf9\u8c61\u7528\u4e8e\u5c06\u7528\u6237\u4e3b\u4f53\uff08\u53ef\u80fd\u662f\u7528\u6237\u6216\u8005\u670d\u52a1\uff09\u548c<code>ServiceRole</code>\u8fdb\u884c\u7ed1\u5b9a</p>"},{"location":"chap5/3Istro_ServiceM_Prac/","title":"\u7b2c\u4e09\u8282 Istio, Service Mesh \u5feb\u901f\u5165\u95e8\uff08Istio 1.1.16\uff09","text":"<p>\u672c\u7ae0\u5c06\u4f1a\u7528\u4e00\u4e2a\u5c0f\u4f8b\u5b50\u6765\u5c55\u793a<code>Istio</code>\u5728\u6d41\u7ae5\u7ba1\u7406\u65b9\u9762\u7684\u80fd\u529b\uff0c\u5c55\u793a\u6d41\u7a0b\u5982\u4e0b </p> <ol> <li>\u4f7f\u7528\u4e00\u4e2a\u73b0\u6709\u7684<code>Istio</code>\u90e8\u7f72\u6587\u4ef6\u7684\u9ed8\u8ba4\u914d\u7f6e\u6765\u5b8c\u6210<code>Istio</code>\u7684\u5b89\u88c5\uff1b </li> <li>\u4f7f\u7528<code>Deployment</code>\u5c06\u4e00\u4e2a\u5e94\u7528\u7684\u4e24\u4e2a\u7248\u672c\u4f5c\u4e3a\u6d4b\u8bd5\u670d\u52a1\u90e8\u7f72\u5230\u7f51\u683c\u4e2d\uff1b </li> <li>\u5c06\u4e00\u4e2a\u5ba2\u6237\u7aef\u670d\u52a1\u90e8\u7f72\u5230\u7f51\u683c\u4e2d\u8fdb\u884c\u6d4b\u8bd5\uff1b </li> <li>\u4e3a\u6211\u4eec\u7684\u76ee\u6807\u670d\u52a1\u7f16\u5199\u7b56\u7565\u6587\u4ef6\uff0c\u5bf9\u76ee\u6807\u670d\u52a1\u7684\u6d41\u91cf\u8fdb\u884c\u7ba1\u7406\uff1b </li> <li>\u5728\u6d4b\u8bd5\u670d\u52a1\u4e2d\u7528\u4e0d\u540c\u7684<code>HTTP</code>\u5934\u8c03\u7528\u76ee\u6807\u670d\u52a1\uff0c\u9a8c\u8bc1\u8fd4\u56de\u7684\u5185\u5bb9\u662f\u5426\u7b26\u5408\u6211\u4eec\u5728\u7b2c3\u6b65\u4e2d\u5b9a\u4e49\u7684\u6d41\u91cf\u7ba1\u7406\u7b56\u7565\u3002 </li> </ol> <p>\u5728<code>Istio</code>\u5b98\u7f51\u4e5f\u63d0\u4f9b<code>\u4e86Bookinfo</code>\u5e94\u7528\u8fdb\u884c\u6f14\u793a\uff0c\u7136\u800c\u8fd9\u4e2a\u5e94\u7528\u672c\u8eab\u5c31\u8f83\u4e3a\u590d\u6742\u5f88\u591a\u7ed3\u679c\u9a8c\u8bc1\u90fd\u9700\u8981\u4f7f\u7528\u6d4f\u89c8\u5668\u91cd\u590d\u5237\u65b0\u6765\u5b8c\u6210\uff0c\u56e0\u6b64\u672c\u4e66\u5bf9\u6d4b\u8bd5\u6848\u4f8b\u8fdb\u884c\u4e86\u91cd\u65b0\u8bbe\u8ba1\u3002 </p>"},{"location":"chap5/3Istro_ServiceM_Prac/#1","title":"1.\u73af\u5883\u4ecb\u7ecd","text":"<p>\u672c\u4e66\u4ec5\u56f4\u7ed5<code>Kubernetes</code>\u73af\u5883\u4e0b\u7684<code>Istio</code>\u5b89\u88c5\u548c\u4f7f\u7528\u8fdb\u884c\u8bb2\u89e3\uff0c\u8fd9\u91cc\u4e5f\u4ec5\u7ed9\u51fa\u5bf9 Kubernetes\u73af\u5883\u7684\u8981\u6c42\uff1a</p> <ol> <li><code>Kubernetes1.9</code>\u6216\u4ee5\u4e0a\u7248\u672c\uff1b</li> <li>\u5177\u5907\u7ba1\u7406\u6743\u9650\u7684<code>kubectl</code>\u53ca\u5176\u914d\u7f6e\u6587\u4ef6\uff0c\u80fd\u591f\u64cd\u4f5c\u6d4b\u8bd5\u96c6\u7fa4\uff1b </li> <li>Kubernetes\u96c6\u7fa4\u8981\u6709\u83b7\u53d6\u4e92\u8054\u7f51\u955c\u50cf\u7684\u80fd\u529b </li> <li>\u8981\u652f\u6301<code>Istio</code>\u7684\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff0c\u9700\u8981\u68c0\u67e5<code>Kubernetes API Server</code>\u7684\u542f\u52a8\u53c2\u6570\uff0c \u4fdd\u8bc1\u5176\u4e2d\u7684<code>admission control</code>\u90e8\u5206\u6309\u987a\u5e8f\u542f\u7528<code>MutatingAdmissionWebhhook</code> \u548c<code>ValidatingAdmission Webhook</code></li> </ol>"},{"location":"chap5/3Istro_ServiceM_Prac/#2","title":"2.\u5feb\u901f\u90e8\u7f72","text":"<ul> <li>https://github.com/istio/istio/releases</li> <li>\u7248\u672c\u9009\u62e9 Istio 1.1.16</li> <li>\u5b89\u88c5\u5305 <code>istio-1.1.16-mac.tar.gz</code></li> <li>K8S\u73af\u5883 </li> </ul> <pre><code>NAME             STATUS   ROLES    AGE   VERSION\ndocker-desktop   Ready    master   32d   v1.14.6\n</code></pre>"},{"location":"chap5/3Istro_ServiceM_Prac/#2-1-istioctl","title":"2-1 \u5b89\u88c5<code>istioctl</code>","text":"<pre><code>export PATH=\"$HOME/Istio/istio-1.1.16/bin:$PATH\"\n</code></pre> <ul> <li>\u5feb\u901f\u5b89\u88c5 (Quick Start Evaluation Install)</li> </ul> <p>https://istio.io/docs/setup/install/kubernetes/</p> <pre><code>$ cd Istio/istio-1.1.16/install/kubernetes\n$ ls -l\nREADME.md               istio-citadel-plugin-certs.yaml     istio-demo.yaml\nansible                 istio-citadel-standalone.yaml       mesh-expansion.yaml\nglobal-default-sidecar-scope.yaml   istio-citadel-with-health-check.yaml    namespace.yaml\nhelm                    istio-demo-auth.yaml\n</code></pre> <ul> <li>Install CRD(<code>optional</code>)</li> </ul> <pre><code>$ for i in helm/istio-init/files/crd*yaml; do kubectl apply -f $i; done\n\ncustomresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io created\ncustomresourcedefinition.apiextensions.k8s.io/destinationrules.networking.istio.io created\ncustomresourcedefinition.apiextensions.k8s.io/serviceentries.networking.istio.io crea\n...\ncustomresourcedefinition.apiextensions.k8s.io/orders.certmanager.k8s.io created\ncustomresourcedefinition.apiextensions.k8s.io/challenges.certmanager.k8s.io created\n</code></pre> <ul> <li>Install Istio-demo</li> </ul> <pre><code>kubectl apply -f istio-demo.yaml\nsecret/kiali created\nconfigmap/istio-galley-configuration created\nconfigmap/istio-grafana-custom-resources created\nconfigmap/istio-grafana-configuration-dashboards-galley-dashboard created\nconfigmap/istio-grafana-configuration-dashboards-istio-mesh-dashboard created\n...\nrule.config.istio.io/kubeattrgenrulerule created\nrule.config.istio.io/tcpkubeattrgenrulerule created\nkubernetes.config.istio.io/attributes created\ndestinationrule.networking.istio.io/istio-policy created\ndestinationrule.networking.istio.io/istio-telemetry created\n</code></pre> <p>\u4e0d\u96be\u770b\u51fa\uff0c <code>Kubernetes</code>\u5bf9\u8c61\u9664\u4e86\u5e38\u4e00\u89c1\u7684<code>Deployment</code>\u3001 <code>Service</code>\u3001 <code>Configmap</code>\u3001 <code>ServiceAccount</code>\u7b49\u8fd9\u91cc\u8fd8\u521b\u5efa\u4e86\u5927\u91cf\u7684<code>CRD</code>\u53ca\u5404\u79cd<code>CRD</code>\u7684\u4e0b\u5c5e\u8d44\u6e90\u3002 </p> <ul> <li>Verifying the installation</li> </ul> <pre><code>$ kubectl get svc -n istio-system\nNAME                     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                                                      AGE\ngrafana                  ClusterIP      10.97.103.25     &lt;none&gt;        3000/TCP                                                                                                                                     3m21s\nistio-citadel            ClusterIP      10.100.168.139   &lt;none&gt;        8060/TCP,15014/TCP                                                                                                                           3m21s\nistio-egressgateway      ClusterIP      10.106.95.123    &lt;none&gt;        80/TCP,443/TCP,15443/TCP                                                                                                                     3m22s\nistio-galley             ClusterIP      10.108.209.18    &lt;none&gt;        443/TCP,15014/TCP,9901/TCP                                                                                                                   3m22s\nistio-ingressgateway     LoadBalancer   10.107.84.164    localhost     15020:31984/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32733/TCP,15030:31365/TCP,15031:31173/TCP,15032:31320/TCP,15443:32343/TCP   3m21s\nistio-pilot              ClusterIP      10.107.118.185   &lt;none&gt;        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       3m21s\nistio-policy             ClusterIP      10.111.42.225    &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP                                                                                                                 3m21s\nistio-sidecar-injector   ClusterIP      10.107.211.88    &lt;none&gt;        443/TCP                                                                                                                                      3m21s\nistio-telemetry          ClusterIP      10.98.81.13      &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       3m21s\njaeger-agent             ClusterIP      None             &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP                                                                                                                   3m20s\njaeger-collector         ClusterIP      10.103.140.100   &lt;none&gt;        14267/TCP,14268/TCP                                                                                                                          3m20s\njaeger-query             ClusterIP      10.107.110.32    &lt;none&gt;        16686/TCP                                                                                                                                    3m20s\nkiali                    ClusterIP      10.100.10.115    &lt;none&gt;        20001/TCP                                                                                                                                    3m21s\nprometheus               ClusterIP      10.108.193.251   &lt;none&gt;        9090/TCP                                                                                                                                     3m21s\ntracing                  ClusterIP      10.102.103.34    &lt;none&gt;        80/TCP                                                                                                                                       3m20s\nzipkin                   ClusterIP      10.111.148.171   &lt;none&gt;        9411/TCP                                                                                                                                     3m20s\n</code></pre> <p>\u8fd0\u884c\u5982\u4e0b\u547d\u4ee4\uff0c\u67e5\u770b<code>istio-system</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u7684Pod\u542f\u52a8\u72b6\u51b5\uff0c\u5176\u4e2d\u7684<code>-w</code>\u53c2\u6570  \u7528\u4e8e\u6301\u7eed\u67e5\u8be2<code>Pod</code>\u72b6\u6001\u7684\u53d8\u5316\uff1a </p> <pre><code>$ kubectl get pods  -n istio-sysem\ntem  -w\nNAME                                       READY   STATUS      RESTARTS   AGE\ngrafana-67c69bb567-sxtrt                   1/1     Running     0          93m\nistio-citadel-5966cb6796-67zz5             1/1     Running     0          93m\nistio-cleanup-secrets-1.1.16-7mrdr         0/1     Completed   0          93m\nistio-egressgateway-65559f6769-5qzpq       1/1     Running     0          93m\nistio-galley-84c585d695-52jvg              1/1     Running     0          93m\nistio-grafana-post-install-1.1.16-wcpd9    0/1     Completed   0          93m\nistio-ingressgateway-6499cc6d8b-qpj8d      1/1     Running     0          93m\nistio-pilot-5546948cf8-6rf2p               2/2     Running     0          93m\nistio-policy-68c98f8464-tvz8c              2/2     Running     7          93m\nistio-security-post-install-1.1.16-f49mn   0/1     Completed   0          93m\nistio-sidecar-injector-766758654c-8gpj4    1/1     Running     0          93m\nistio-telemetry-579cfdb5b-h7l64            2/2     Running     7          93m\nistio-tracing-5d8f57c8ff-j7xrn             1/1     Running     0          93m\nkiali-d4d886dd7-whm5w                      1/1     Running     0          93m\nprometheus-d8d46c5b5-tjhbb                 1/1     Running     0          93m\n</code></pre>"},{"location":"chap5/3Istro_ServiceM_Prac/#3","title":"3.\u90e8\u7f72\u4e24\u4e2a\u7248\u672c\u7684\u670d\u52a1","text":""},{"location":"chap5/3Istro_ServiceM_Prac/#3-1-python","title":"3-1 \u4e00\u4e2a\u7b80\u5355\u7684Python\u811a\u672c\u4f5c\u4e3a\u670d\u52a1\u7aef","text":"<p>\u8fd9\u6bb5\u811a\u672c\u662f\u4e00\u4e2aFlask\u5e94\u7528\uff0c \u63d0\u4f9b\u8fde\u4e2aURL\u8def\u5f84\uff0c \u4e00\u4e2a\u662f<code>/env</code>\u7528\u4e8e\u83b7\u53d6\u5bb9\u5668\u4e2d\u7684\u73af\u5883\u53d8\u91cf\uff0c \u4f8b\u5982 <code>http://flaskapp/env/version</code>; \u53e6\u5916\u4e00\u4e2a\u662f<code>/fetch</code>\u7528\u4e8e\u83b7\u53d6\u53c2\u6570url\u4e2d\u6307\u5b9a\u7684\u7f51\u5740\u5185\u5bb9\uff0c \u4f8b\u5982<code>http://flaskapp/fetch?url=https://weibo.com</code></p> <pre><code>#!/usr/bin/env python3 \nfrom flask import Flask, request \nimport os \nimport url lib.request \n\napp=Flask(__name__) \n\n@app.route('/env/&lt;env&gt;')\ndef showenv(env): \n    return os.environ.get(env)\n\n\n@app.route\uff08'/fetch'\uff09 \ndef fetch_env():\n    url=request.args.get('url','')\n    with urllib.request.urlopen(url) as reponse:\n        return reponse.read \n\n\nif __name__ ==  \"__main__\": \napp.run(host=\"0,0,0,0\", port=80, debug=True)\n</code></pre> <p>\u6211\u4eec\u4e3a\u8fd9\u4e2a<code>App</code>\u521b\u5efa\u4e24\u4e2a<code>Deployment</code>\uff0c\u5c06\u5176\u5206\u522b\u547d\u540d\u4e3a <code>flaskapp-v1</code>\u548c<code>flaskapp-v2</code>; \u540c\u65f6\u521b\u5efa\u4e00\u4e2a<code>Service</code>\uff0c\u5c06\u5176\u547d\u540d\u4e3a<code>flask app</code>\uff0c\u5c06\u4e0b\u9762\u7684\u5185\u5bb9\u4fdd\u5b58\u4e3a<code>flaskapp.istio.yaml</code>: </p> <pre><code>apiVersion: v1 \nkind: Service \nmetadata: \n  name: flaskapp \n  labels: \n    app: flaskapp \nspec: \n  selector: \n    app: flaskapp \n  ports: \n    - name: http \n      port: 80 \n---\napiVersion: extensions/v1beta1\nkind: Deployment \nmetadata: \n  name: flaskapp-v1 \nspec: \n  replicas: 1\n  template: \n    metadata: \n      labels: \n        app: flaskapp \n        version: v1 \n      spec: \n        containers: \n        - name: flaskapp \n          image: dustise/flaskapp\n          imagePullPolicy: IfNotPresent \n          env:\n          - name: version\n            value: v1\n---\napiVersion: extensions/v1beta1\nkind: Deployment \nmetadata: \n  name: flaskapp-v2\nspec: \n  replicas: 1\n  template: \n    metadata: \n      labels: \n        app: flaskapp \n        version: v1 \n      spec: \n        containers: \n        - name: flaskapp \n          image: dustise/flaskapp\n          imagePullPolicy: IfNotPresent \n          env:\n          - name: version\n            value: v2\n</code></pre> <p>\u5728\u4e0a\u9762\u7684YAML\u6e90\u7801\u4e2d\u6709\u4ee5\u4e0b\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u3002 </p> <ul> <li>\u4e24\u4e2a\u7248\u672c\u7684<code>Deployment</code>\u7684\u955c\u50cf\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u4f7f\u7528\u4e86\u4e0d\u540c\u7684<code>version</code>\u6807\u7b7e\u8fdb\u884c\u533a\u5206\uff0c\u5206\u522b\u662f<code>v1</code>\u548c<code>v2</code></li> <li>\u5728\u4e24\u4e2a\u7248\u672c\u7684<code>Deployment</code>\u5bb9\u5668\u4e2d\u90fd\u6ce8\u518c\u4e86\u4e00\u4e2a\u88ab\u547d\u540d\u4e3a<code>version</code>\u7684\u73af\u5883\u53d8\u91cf\u53d6\u503c\u5206\u522b\u4e3a<code>v1</code>\u548c<code>v2</code> </li> <li>\u4e24\u4e2a<code>Deployment</code>\u90fd\u4f7f\u7528\u4e86<code>app</code>\u548c<code>version</code>\u6807\u7b7e, \u5728<code>Istio</code>\u7f51\u683c\u5e94\u7528\u4e2d\u901a\u5e38\u4f1a\u4f7f\u7528\u8fd9\u4e24\u4e2a\u6807\u7b7e\u4f5c\u4e3a\u5e94\u7528\u548c\u7248\u672c\u7684\u6807\u8bc6</li> <li><code>Service</code>\u4e2d\u7684<code>Selector</code>\u4ec5\u4f7f\u7528\u4e86\u4e00\u4e2a<code>app</code>\u6807\u7b7e <code>Deployment</code>\u90fd\u662f\u6709\u6548\u7684\u3002 </li> </ul> <p>\u63a5\u4e0b\u6765\u4f7f\u7528<code>istioctl</code>\u8fdb\u884c\u6ce8\u5165\u3002\u4e4b\u540e\u4f1a\u4e00\u76f4\u7528\u5230<code>istioctl</code>\u547d\u4ee4\uff0c\u5b83\u7684\u57fa\u672c\u4f5c\u7528\u5c31\u8d77\u4fee\u6539<code>Kubernetes Deployment</code>\uff0c\u5728Pod\u4e2d\u6ce8\u5165\u5728\u524d\u9762\u63d0\u5230\u7684<code>Sidecar</code>\u5bb9\u5668\uff0c\u901a\u5e38\u4e3a\u4e86\u65b9\u4fbf\uff0c\u6211\u4eec\u4f1a\u4f7f\u7528\u4e00\u4e2a\u7ba1\u9053\u547d\u4ee4\uff0c\u5728\u5c06<code>YAML</code>\u6587\u4eec \u901a\u8fc7<code>istioctl</code>\u5904\u7406\u4e4b\u540e\uff0c\u901a\u8fc7\u547d\u4ee4\u884c\u7ba1\u9053\u8f93\u51fa\u7ed9<code>kubectl</code>\uff0c\u6700\u7ec8\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\u3002 \u547d\u4ee4\u5982\u4e0b\uff1a </p> <pre><code>$ cd ~/Devops_sap/Istio/flaskapp\n</code></pre> <pre><code>$ istioctl kube-inject -f flask.istio.yaml | kubectl apply -f -\nservice/flaskapp unchanged\ndeployment.extensions/flaskapp-v1 created\ndeployment.extensions/flaskapp-v2 created\n</code></pre> <pre><code>$ kubectl get pods\nNAME                          READY   STATUS    RESTARTS   AGE\nflaskapp-v1-bc4679d-cd54v     2/2     Running   0          50s\nflaskapp-v2-89866b97c-4zsqf   2/2     Running   0          50s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6bcf\u4e2aPod\u90fd\u53d8\u6210\u4e86\u4e24\u4e2a\u5bb9\u5668\uff0c \u4e5f\u5c31\u662f\u662f<code>Istio</code>\u6ce8\u5165<code>Sidecar</code>\u7684\u7ed3\u679c\uff0c \u53ef\u4ee5\u4f7f\u7528<code>kubectl describe pod</code>\u547d\u4ee4\u67e5\u770b<code>Pod</code>\u7684\u5bb9\u5668</p> <pre><code>$ kubectl describe pod flaskapp-v1-74cbbdbdf6-8wxvn\n\n...\nInit Containers:\n  istio-init:              \n    Container ID:\n...\n  istio-proxy:\n    Container ID:\n...\n</code></pre> <p>\u4e0d\u96be\u53d1\u73b0\uff0c\u5728\u8fd9\u4e2a<code>Pod</code>\u4e2d\u591a\u4e86\u4e00\u4e2a\u5bb9\u5668\uff0c\u540d\u79f0\u4e3a<code>istio-proxy</code>\uff0c\u8fd9\u5c31\u662f\u6ce8\u4eba\u7684\u7ed3\u679c\u3002\u53e6\u5916\uff0c\u524d\u9762\u8fd8\u6709\u4e00\u4e2a\u540d\u79f0\u4e3a<code>istio-init</code>\u7684\u521d\u59cb\u5316\u5bb9\u5668(job)\uff0c\u8fd9\u4e2a\u5bb9\u5668\u662f\u7528\u4e8e\u521d\u59cb\u5316\u52ab\u6301\u7684\u3002</p> <pre><code>kubectl get pods -o=jsonpath='{range .items[*]}{\"\\n\"}{.metadata.name}{\":\\t\"}{range .spec.containers[*]}{.image}{\", \"}{end}{end}' |\\sort\n</code></pre> <pre><code>$ kubectl get pods -o custom-columns='NAME:metadata.name,ImageName:spec.containers[*].image'\nNAME                          ImageName\nflaskapp-v1-bc4679d-cd54v     dustise/flaskapp,docker.io/istio/proxyv2:1.1.16\nflaskapp-v2-89866b97c-4zsqf   dustise/flaskapp,docker.io/istio/proxyv2:1.1.16\nsleep-6c9b45d956-5hjl6        dustise/sleep,docker.io/istio/proxyv2:1.1.16\n</code></pre>"},{"location":"chap5/3Istro_ServiceM_Prac/#3-2-istioctl-kube-inject-h","title":"3-2 <code>istioctl kube-inject -h</code>","text":"<pre><code>kube-inject manually injects the Envoy sidecar into Kubernetes workloads.\n\nUsage:\n  istioctl kube-inject [flags]\n\nExamples:\n\n# Update resources on the fly before applying.\nkubectl apply -f &lt;(istioctl kube-inject -f &lt;resource.yaml&gt;)\n\n# Create a persistent version of the deployment with Envoy sidecar injected.\nistioctl kube-inject -f deployment.yaml -o deployment-injected.yaml\n\n# Update an existing deployment.\nkubectl get deployment -o yaml | istioctl kube-inject -f - | kubectl apply -f -\n\n# Create a persistent version of the deployment with Envoy sidecar\n# injected configuration from Kubernetes configmap 'istio-inject'\nistioctl kube-inject -f deployment.yaml -o deployment-injected.yaml --injectConfigMapName istio-inject\n</code></pre>"},{"location":"chap5/3Istro_ServiceM_Prac/#4","title":"4.\u90e8\u7f72\u5ba2\u6237\u7aef\u670d\u52a1","text":"<p>\u5ba2\u6237\u7aef\u670d\u52a1\u5f88\u7b80\u5355\u53ea\u662f\u4f7f\u7528\u4e86\u4e00\u4e2a\u5df2\u5b89\u88c5\u597d\u5404\u79cd\u6d4b\u8bd5\u5de5\u5177\u7684\u955c\u50cf\uff0c\u5177\u4f53\u7684\u6d4b\u8bd5\u53ef\u4ee5\u5728\u5176\u5185\u90e8\u7684<code>Shell</code>\u4e2d\u5b8c\u6210\u3002\u540c\u6837\uff0c\u7f16\u5199\u4e00\u4e2a\u3001<code>YAML</code>\u6587\u4ef6\u5c06\u5176\u547d\u540d\u4e3a<code>sleep.yaml</code></p> <pre><code>apiVersion: v1\nkind: Service \nmetadata: \n  name: sleep \n  labels: \n    app: sleep \n    version: v1 \nspec: \n  selector: \n    app: sleep \n    version: v1 \n  ports: \n    - name: ssh \n      port: 80 \n--- \napiVersion: extensions/v1beta1 \nkind: Deployment \nmetadata:\n  name: sleep \nspec: \n  replicas: 1 \n  template: \n    metadata: \n      labels: \n        app: sleep \n        version: v1 \n    spec: \n      containers: \n      - name: sleep \n        image: dustise/sleep \n        imagePullPolicy: IfNotPresent\n</code></pre> <p>\u8fd9\u4e2a\u5e94\u7528\u5e76\u6ca1\u6709\u63d0\u4f9b\u5bf9\u5916\u670d\u52a1\u7684\u80fd\u529b, \u6211\u4eec\u7ed9\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a<code>Service</code>\u3002\u65f6\u8c61\u8fd9\u540c\u6837\u662fIstio\u7684\u6ce8\u4eba\u8981\u6c42\uff1a</p>"},{"location":"chap5/3Istro_ServiceM_Prac/#4-1-servicedeploymentistio","title":"4-1 \u6ca1\u6709<code>Service</code>\u7684<code>Deployment</code>\u662f\u65e0\u6cd5\u88ab<code>Istio</code>\u53d1\u73b0\u4e95\u8fdb\u884c\u64cd\u4f5c\u7684","text":"<p>\u540c\u6837\u5bf9\u8be5\u6587\u4ef6\u8fdb\u884c\u6ce8\u4eba\u5e76\u63d0\u4ea4\u5230<code>Kubernetes</code>\u8fd0\u884c </p> <pre><code>$ istioctl kube-inject -f sleep.yaml | kubectl apply -f -\nservice/sleep created\ndeployment.extensions/sleep created\n</code></pre> <pre><code>$ kubectl get pod\nNAME                           READY   STATUS    RESTARTS   AGE\nflaskapp-v1-74cbbdbdf6-4mbb8   1/1     Running   0          12s\nflaskapp-v2-74cbbdbdf6-zp79g   1/1     Running   0          12s\nsleep-6c9b45d956-5hjl6         2/2     Running   0          4m31s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c <code>sleep</code> \u5e94\u7528\u7684<code>Pod</code>\u5df2\u7ecf\u5f00\u59cb\u4e86</p>"},{"location":"chap5/3Istro_ServiceM_Prac/#5","title":"5.\u9a8c\u8bc1\u670d\u52a1","text":"<p>**\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>kubectl exec -it</code> \u670d\u52a1\u7684\u5177\u4f53\u8868\u73b0\u3002 \u547d\u4ee4\u8fdb\u4eba\u5ba2\u6237\u7aef<code>Pod</code>\uff0c\u6765\u6d4b\u8bd5<code>flaskapp</code> **</p> <p>\u4f7f\u7528\u4e00\u4e2a\u7b80\u5355\u7684<code>for</code>\u5faa\u73af\uff0c\u91cd\u590d\u83b7\u53d6<code>http://flaskapp/env/version</code>\u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u8c03\u7528<code>flaskapp</code>\u670d\u52a1\uff0c\u67e5\u770b\u5176\u8fd4\u56de\u7ed3\u679c\uff1a </p> <pre><code>kubectl exec -it sleep-6c9b45d956-5hjl6 -c sleep bash\n\n# -c, --container='': Container name. If omitted, the first container in the pod will be chosen\n\n\nbash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done\nv2\n\nv1\n\nv2\n\nv1\n\nv2\n\nv1\n\nv1\n\nv2\n\nv1\n\nv2\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u8fd0\u884c\u7ed3\u679c\u4e2d\u53ef\u4ee5\u770b\u5230 \u8fd9\u5f88\u5bb9\u6613\u7406\u89e3\uff0c<code>v2</code>\u548c<code>v1</code>\u8fd9\u4e24\u79cd\u7ed3\u679c\u968f\u673a\u51fa\u73b0\uff0c\u5927\u7ea6\u5404\u5360\u4e00\u534a\u3002</p> <p>\u56e0\u4e3a\u6211\u4eec\u7684<code>flaskapp</code>\u670d\u52a1\u7684\u9009\u62e9\u5668\u88ab\u5b9a\u4e49\u4e3a\u53ea\u6839\u636e<code>App</code>\u6807\u7b7e\u8fdb\u884c\u9009\u62e9\uff0c\u4e24\u4e2a\u7248\u672c\u7684\u670d\u52a1<code>Pod</code>\u6570\u91cf\u76f8\u540c\uff0c\u56e0\u6b64\u4f1a\u51fa\u73b0\u8f6e\u6d41\u8f93\u51fa\u7684\u6548\u679c\u3002 </p>"},{"location":"chap5/3Istro_ServiceM_Prac/#6","title":"6.\u521b\u5efa\u76ee\u6807\u89c4\u5219\u548c\u9ed8\u8ba4\u8def\u7531","text":"<p>\u63a5\u4e0b\u6765\u4f7f\u7528<code>Istio</code>\u6765\u7ba1\u7406\u8fd9\u4e24\u4e2a\u670d\u52a1\u7684\u6d41\u91cf</p> <p>\u9996\u5148\u521b\u5efa flaskapp \u5e94\u7528\u7684\u76ee\u6807\u89c4\u5219\uff0c\u8f93\u5165\u4e00\u4e0b\u5185\u5bb9\u5e76\u5c06\u5176\u4fdd\u5b58\u4e3a <code>flask-detinationrule.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: DestinationRule \nmetadata: \n    name: flaskapp \nspec: \n    host: flaskapp \n    subsets: \n    - name: v1 \n      labels: \n        version: v1 \n    - name: v2 \n      labels: \n         version: v2 \n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8be5\u6587\u4ef6\u8fd8\u662f\u5e38\u89c1\u7684<code>YAML</code>\u683c\u5f0f,\u5b9e\u9645\u4e0a\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>kubectl</code>\u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c </p> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u79f0\u4e3a<code>flaskapp</code>\u7684<code>DestinationRule</code>,\u5b83\u5229\u7528<code>Pod</code>\u6807\u7b7e\u628a\u670d\u52a1\u5206\u6210\u4e24\u4e2a<code>subset</code> , \u5c06\u5199\u5206\u522b\u547d\u540d\u4e3a    <code>v1</code>\u548c<code>v2</code> </p> <p>\u4e0b\u9762\u5c06<code>flask-detinationrule.yaml</code>\u63d0\u4ea4\u5230\u96c6\u7fa4</p> <pre><code>$ kubectl apply -f flask-detinationrule.yaml\ndestinationrule.networking.istio.io/flaskapp created\n</code></pre> <pre><code>$ kubectl get destinationrule\nNAME       HOST       AGE\nflaskapp   flaskapp   4m52s\n</code></pre> <p>\u63a5\u4e0b\u6765\u5c31\u9700\u8981\u4e3a<code>flaskapp</code>\u670d\u52a1\u521b\u5efa\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\u4e86,</p> <p>\u4e0d\u8bba\u662f\u5426\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u6d41\u91cf\u63a7\u5236, \u90fd\u5efa\u8bae\u4e3a\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u521b\u5efa\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\uff0c \u4ee5\u9632\u53d1\u751f\u610f\u6599\u4e4b\u5916\u7684\u8bbf\u95ee\u7ed3\u679c </p> <p>\u4fbf\u7528\u4e0b\u9762\u7684\u5185\u5bb9\u521b\u5efa\u6587\u672c\u6587\u4ef6<code>flask-default-vs-v2.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp-default-v2 \nspec: \n  hosts:\n  - flaskapp \n  http: \n  - route: \n    - destination: \n        host: flaskapp \n        subset: v2\n</code></pre> <p>\u5728\u8be5\u6587\u672c\u6587\u4ef6\u4e2d\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a<code>VirtualService</code>\u5bf9\u8c61, \u5c06\u5176\u547d\u540d\u4e3a<code>flaskapp-default-v2</code>, \u5b83\u8d1f\u8d23\u63a5\u7ba1<code>flaskapp</code>\u8fd9\u4e00\u4e3b\u673a\u540d\u7684\u8bbf\u95ee,\u4f1a\u5c06\u6240\u6709\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230<code>DestinationRule</code>\u5b9a\u4e49\u7684<code>v2 subset</code>\u4e0a </p> <p>\u518d\u6b21\u6267\u884c<code>kubectl</code>\u5c06<code>VirtualService</code>\u63d0\u4ea4\u5230\u96c6\u7fa4 </p> <pre><code>kubectl apply -f flask-default-vs-v2.yaml\nvirtualservice.networking.istio.io/flaskapp-default-v2 created\n\n$ kubectl get vs\nNAME                  GATEWAYS   HOSTS        AGE\nflaskapp-default-v2              [flaskapp]   48s\n</code></pre> <p>\u5728\u521b\u5efa\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u518d\u6b21\u8fdb\u5165\u5ba2\u6237\u7aef\u7684Pod, \u770b\u770b\u65b0\u5b9a\u4e49\u7684\u6d41\u91cf\u89c4\u5219\u662f\u5426\u751f\u6548</p> <pre><code>$ kubectl exec -it sleep-85cfc95c7-tvlxq -c sleep bash\nbash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done\nv2\n\nv2\n\nv2\n\nv2\n\nv2\n\nv2\n\nv2\n\nv2\n\nv2\n\nv2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230, \u9ed8\u8ba4\u7684\u8def\u7531\u5df1\u7ecf\u751f, \u73b0\u5728\u590d\u591a\u6b21\u8bbf\u95ee\uff0c \u8fd4\u56de\u7684\u5185\u5bb9\u6765\u81ea\u73af\u5883\u53d8\u91cf<code>version</code>\u88ab\u8bbe\u7f6e\u4e3a<code>v2</code>\u7684\u7248\u672c. </p>"},{"location":"chap5/4Istio_Helm/","title":"\u7b2c\u56db\u8282 \u7528<code>Helm</code>\u90e8\u7f72<code>Istio</code>","text":"<p><code>Istio</code> \u662f\u7531\u591a\u4e2a\u7ec4\u4ef6\u6784\u6210\u7684\uff0c\u4e95\u4e14\u53ef\u4ee5\u901a\u8fc7 <code>kubectl</code> \u547d\u4ee4\u5728<code>Kubernetes</code>\u96c6\u7fa4\u4e0a\u8fdb\u884c\u90e8\u7f72\uff0c\u90e8\u7f72\u65f6\u4f1a\u5728<code>Kubernetes</code>\u96c6\u7fa4\u4e0a\u521b\u5efa\u5927\u91cf\u7684\u5bf9\u8c61\u3002<code>Istio</code>\u4e0e<code>Kubernetes</code>\u8fdb\u884c\u4e86\u6df1\u5ea6\u96c6\u6210\uff0c\u6784\u6210<code>Istio</code>\u7684\u5404\u4e2a\u7ec4\u4ef6\u90fd\u4ee5<code>Deployment</code> \u7684\u5f62\u5f0f\u5728<code>Kubernetes</code>\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff0c\u5e76\u4e14\u5176\u5728\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u6240\u9700\u7684\u914d\u7f6e\u6570\u636e\u4e5f\u9700\u8981\u4f9d\u8d56\u5404\u79cd<code>CRD</code>\u53ca<code>ConfigMap</code>\u3001 <code>Secret</code>\u7b49\u6765\u8fdb\u884c\u5b58\u50a8\u3002\u8fd9\u79cd\u5305\u542b\u590d\u6742\u4f9d\u8d56\u5173\u7cfb\u7684\u5e94\u7528\u90e8\u7f72 \u8fc7\u7a0b\uff0c\u9700\u8981\u7531\u529f\u80fd\u8db3\u591f\u5f3a\u5927\u7684\u6a21\u677f\u7cfb\u7edf\u63d0\u4f9b\u652f\u6301\uff0c\u56e0\u6b64<code>Istio</code>\u5b98\u65b9\u63a8\u8350\u4f7f\u7528<code>Helm</code>\u5bf9<code>Istio</code>\u8fdb\u884c\u90e8\u7f72\u3002</p> <p>\u672c\u7ae0\u5c06\u4f1a\u8f83\u4e3a\u8be6\u7ec6\u5730\u5bf9\u4e00<code>Istio</code>\u7684<code>Helm Chart</code>\u90e8\u7f72\u65b9\u5f0f\u8fdb\u884c\u8bb2\u89e3\u3002</p>"},{"location":"chap5/4Istio_Helm/#1istio-chart","title":"1\u3001Istio Chart\u6982\u8ff0","text":"<p><code>Helm</code>\u662f\u76ee\u524d<code>Istio</code>\u5b98\u65b9\u63a8\u8350\u7684\u5b89\u88c5\u65b9\u5f0f\u3002\u9664\u53bb\u5b89\u88c5\u540e\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5bf9\u8f93\u4eba\u503c\u8fdb\u884c\u4e00\u4e9b\u8c03\u6574\uff0c\u5b8c\u6210\u5bf9<code>Istio</code>\u7684\u90e8\u5206\u914d\u7f6eT\u4f5c\u3002<code>Istio Chart</code>\u662f\u4e00\u4e2a\u603b\u5206\u7ed3\u6784\uff0c\u5176\u5206\u7ea7\u7ed3\u6784\u548c\u8bbe\u8ba1\u7ed3\u6784\u662f\u4e00\u81f4\u7684.</p> <p><code>Istio</code>\u4e2d<code>Chart</code>\u7684\u5206\u7ea7\u7ed3\u6784\u548c\u76ee\u5f55\u7ed3\u6784\u662f\u5bf9\u7b49\u7684\uff0c\u4e0b\u9762\u8fdb\u884c\u7b80\u8981\u8bf4\u660e\u3002 </p>"},{"location":"chap5/4Istio_Helm/#1-1-chartyaml","title":"1-1 Chart.yaml","text":"<p>\u8be5\u6587\u4ef6\u662f<code>Chart</code>\u7684\u57fa\u7840\u4fe1\u606f\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u7248\u672c\u53f7\u3001\u540d\u79f0\u3001\u5173\u952e\u5b57\u7b49\u5143\u6570\u636e\u4fe1\u606f\u3002 </p> <p></p>"},{"location":"chap5/4Istio_Helm/#1-2-valuesyaml","title":"1-2 <code>values\u4e00*.yaml</code>","text":"<p>\u5728<code>Istio</code>\u7684\u53d1\u884c\u5305\u4e2d\u5305\u542b\u4e00\u7ec4<code>values</code>\u6587\u4ef6\uff0c\u63d0\u4f9b<code>Istio</code>\u5728\u5404\u79cd\u573a\u666f\u4e0b\u7684\u5173\u952e\u914d\u7f6e\u8303\u672c\uff0c\u8fd9\u4e9b\u8303\u672c\u6587\u4ef6\u53ef\u4ee5\u4f5c\u4e3a<code>Helm</code>\u7684\u8f93\u5165\u6587\u4ef6\uff0c\u6765\u5bf9<code>Istio</code>\u8fdb\u884c\u5178\u578b\u5b9a\u5236\u3002\u5bf9<code>Istio</code>\u7684\u5b9a\u5236\u53ef\u4ee5\u4ece\u5bf9\u8fd9\u4e9b\u8f93\u4eba\u6587\u4ef6\u7684\u6539\u5199\u5f00\u59cb\uff0c\u5728\u6539\u5199\u5b8c\u6210\u540e\u4f7f\u7528<code>helm template</code>\u547d\u4ee4\u751f\u6210\u6700\u7ec8\u7684\u90e8\u7f72\u6587\u4ef6\uff0c\u8fd9\u6837\u5c31\u80fd\u7528<code>kubectl</code>\u5b8c\u6210\u90e8\u7f72\u4e86\u3002</p> <ul> <li>\u4e0b\u9762\u5217\u4e3e\u8fd9\u4e9b\u5178\u578b\u8f93\u4eba\u6587\u4ef6\u7684\u4f5c\u7528\u3002<code>values_istio_auth-galley.yaml</code>\uff1a\u542f\u7528\u63a7\u5236\u9762<code>mTLS</code>,\u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684<code>mTLS</code>, \u542f\u7528<code>Galley</code> </li> <li><code>values-istio-multicluster.yaml</code>\uff1a\u591a\u96c6\u7fa4\u914d\u7f6e\u3002 </li> <li><code>values-istio-auth-multicluster.yaml</code>\uff1a\u591a\u96c6\u7fa4\u914d\u7f6e\uff0c\u542f\u7528\u63a7\u5236\u9762<code>mTLS</code>\uff0c\u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684<code>mTLS</code>\u7981\u7528\u81ea\u7b7e\u7f72\u8bc1\u4e66 \u3002</li> <li><code>values-isito-demo-auth.yml</code>: \u542f\u7528\u63a7\u5236\u9762<code>mTLS</code>\u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684<code>mTLs</code></li> <li><code>values-istio-auth.yaml</code>: \u542f\u7528\u63a7\u5236\u9762<code>mTLS</code>\u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684<code>Grafana</code>, <code>Jaeger</code> <code>ServiceGraph</code> \u53ca<code>Galley</code>,\u5141\u8bb8\u81ea\u52a8\u6ce8\u5165</li> <li><code>values-istio-galley.yaml</code>: \u542f\u7528<code>Galley</code>\u548c<code>Prometheus</code></li> <li><code>values-istio-gateways.yaml</code>: \u8fd9\u662f\u4e00\u4e2a\u6837\u4f8b\u53ef\u4ee5\u7528\u8fd9\u79cd\u5f62\u5f0f\u5b9a\u4e49\u65b0\u7684<code>Gateway</code>\u3002</li> <li><code>values-istio-one-namespace.yaml</code>: \u5355\u547d\u540d\u7a7a\u95f4\u90e8\u7f72, \u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684<code>mTLS</code></li> <li><code>values-istio-one-namespace-auth.yaml</code>: \u5355\u547d\u540d\u7a7a\u95f4\u90e8\u7f72\uff0c \u542f\u7528\u63a7\u5236\u9762<code>mTLS</code> </li> <li><code>values.yaml</code>: \u7f57\u5217\u4e86\u7edd\u5927\u591a\u6570\u5e38\u7528\u53d8\u91cf\uff0c\u4e5f\u662f\u6211\u4eec\u505a\u5b9a\u5236\u7684\u57fa\u7840 </li> </ul>"},{"location":"chap5/4Istio_Helm/#1-3-requirementsyaml","title":"1-3 <code>requirements.yaml</code>","text":"<p>\u8be5\u6587\u4ef6\u7528\u4e8e\u7ba1\u7406\u5bf9\u5b50<code>Chart</code>\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u5176\u4e2d\u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217\u5f00\u5173\u53d8\u91cf\u3002 </p> <p>\u5728<code>Helm</code>\u7684\u8f93\u4eba\u5185\u5bb9\u4e2d\u5bf9\u76f8\u5173\u53d8\u91cf\u8fdb\u884c\u5b9a\u4e49\uff0c\u5c31\u53ef\u4ee5\u5bf9<code>Istio</code>\u7684\u90e8\u7f72\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\uff0c\u6765\u63a7\u5236\u5bf9\u5e94\u7ec4\u4ef6\u7684\u542f\u7528\u72b6\u6001\u3002\u4f8b\u5982\uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5bf9<code>Grafana</code>\u7684\u63a7\u5236\u4ee3\u7801\uff1a </p> <pre><code>- name: grafana \n  version: 1.0.3 \n  condition:grafana.enabled\n</code></pre> <p>\u8fd9\u6bb5\u63a7\u5236\u4ee3\u7801\u4ee3\u8868\uff1a\u5982\u679c\u4fee\u6539\u5168\u5c40\u53d8\u91cf<code>grafana.enabled</code>\u4e3a<code>False</code>,\u5c31\u4e0d\u4f1a\u5b89\u88c5<code>Grafana</code>\u4e86\u3002 </p>"},{"location":"chap5/4Istio_Helm/#1-4-template_affinitytpl","title":"1-4 <code>template/_affinity.tpl</code>","text":"<p>\u8be5\u6587\u4ef6\u4f1a\u751f\u6210\u4e00\u7ec4\u8282\u70b9\u4eb2\u548c\u6216\u4e92\u65a5\u5143\u7d20\uff0c\u4f9b\u5404\u4e2a\u7ec4\u4ef6\u5728\u6e32\u67d3YAML\u65f6\u4f7f\u7528\u8be5\u6587\u4ef6\u91cc\u4f7f\u7528\u4e86\u4e00\u7cfb\u5217\u53d8\u91cf\uff0c\u7528\u4e8e\u63a7\u5236<code>Istio</code>\u7ec4\u4ef6\u7684\u8282\u70b9\u4eb2\u548c\u6027\uff08\u4e5f\u5c31\u662f\u9650\u5236\u5728\u90e8\u7f72\u65f6\u5bf9\u8282\u70b9\u7684\u9009\u62e9\u3002</p> <p>\u5728\u6a21\u677f\u4e2d\u5f15\u7528\u4e86\u5168\u5c40\u53d8\u91cf<code>arch</code>\uff0c\u9ed8\u8ba4\u5185\u5bb9\u662f\uff1a </p> <pre><code>arch: \n amd64:2 \n s390x:2 \n ppc64le:2 \n</code></pre> <p>\u8fd9\u91cc\u5b9a\u4e49\u5982\u4e0b\u4e24\u4e2a\u5c40\u90e8\u6a21\u677f\uff1a </p> <ul> <li><code>nodeAffinityRequiredDuringScheduling</code>\uff1a\u4f1a\u6839\u636e\u5168\u5c40\u53d8\u91cf\u4e2d\u7684<code>arch</code>\u53c2\u6570\u5bf9\u90e8\u7f72\u8282\u70b9\u8fdb\u884c\u9650\u5236\u3002<code>Istio</code>\u7ec4\u4ef6\u7684<code>Pod</code>\u4f1a\u6839\u636e<code>arch</code>\u53c2\u6570\u4e2d\u7684\u670d\u52a1\u5668\u7c7b\u578b\u5217\u8868\u6765\u51b3\u5b9a\u662f\u5426\u90e8\u7f72\u5230\u67d0\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\uff0c\u5e76\u6839\u636e\u5404\u79cd\u670d\u52a1\u5668\u7c7b\u578b\u7684\u4e0d\u540c\u6743\u91cd\u6765\u51b3\u5b9a\u4f18\u5148\u7ea7\u3002 </li> <li><code>nodeAffinityPreferredDuringScheduling</code>\uff1a\u8ddf\u4e0a\u4e00\u4e2a\u53d8\u91cf\u7684\u4f5c\u7528\u7c7b\u4f3c\uff0c\u4e0d\u540c\u7684\u662f\uff0c\u8fd9\u4e00\u4e2a\u8f6f\u9650\u5236\u3002 </li> </ul> <p>\u63a5\u4e0b\u6765\u4f1a\u4f7f\u7528\u5728\u4e0a\u9762\u5b9a\u4e49\u7684\u4e24\u4e2a\u6a21\u677f\u751f\u6210\u65b0\u6a21\u677f\uff0c\u5c06\u5176\u547d\u540d\u4e3a<code>nodeaffinity</code>\uff0c\u5e76\u63d0\u4f9b\u7ed9\u5176\u4ed6\u7ec4\u4ef6\u5f15\u7528\uff0c\u7528\u4e8e\u751f\u6210\u5404\u4e2a\u7ec4\u4ef6<code>Deployment</code>\u5bf9\u8c61\u7684\u8282\u70b9\u4eb2\u548c\u6027\u9650\u5236\u3002 </p>"},{"location":"chap5/4Istio_Helm/#1-5-templatessidecar-injector-configmapyaml","title":"1-5 <code>templates/sidecar-injector-configmap.yaml</code>","text":"<p>\u6839\u636e\u6587\u4ef6\u540d\u5c31\u53ef\u4ee5\u5224\u65ad\u51fa\u6765\uff0c\u8be5\u6587\u4ef6\u6700\u7ec8\u4f1a\u7528\u4e8e\u751f\u6210\u4e00\u4e2a<code>ConfigMap</code>\u5bf9\u8c61\uff0c\u5728\u8be5\u5bf9\u8c61\u4e2d\u4fdd\u5b58\u7684\u914d\u7f6e\u6570\u636e\u88ab\u7528\u4e8e\u8fdb\u884c<code>Sidecar</code>\u6ce8\u5165\u3002</p> <p><code>istioctl</code>\u5b8c\u6210\u7684\u624b\u5de5\u6ce8\u4eba\uff0c\u6216\u8005 <code>Istioctl</code> \u7684\u81ea\u52a8\u6ce8\u4eba\uff0c\u90fd\u4f1a\u5f15\u7528\u8fd9\u4e2a<code>ConfigMap</code>\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u5982\u679c\u5e0c\u671b\u4fee\u6539<code>Istio</code>\u7684<code>Sidecar</code>\u7684\u6ce8\u4eba\u8fc7\u7a0b\u53ca\u5177\u4f53\u884c\u4e3a\uff0c\u5c31\u53ef\u4ee5\u4ece\u8be5\u6587\u4ef6\u6216\u8005\u5bf9\u5e94\u7684<code>ConfigMap</code>\u4eba\u624b\u4e86\u3002 </p>"},{"location":"chap5/4Istio_Helm/#1-6-templatesconfigmapyaml","title":"1-6 <code>templates/configmap.yaml</code>","text":"<p>\u8be5\u6587\u4ef6\u4e5f\u4f1a\u751f\u6210\u4e00\u4e2a<code>ConfigMap</code>\uff0c\u540d\u79f0\u4e3a<code>istio</code>\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u7528\u4e8e\u4e3a<code>Pilot</code>\u63d0\u4f9b\u542f\u52a8\u914d\u7f6e\u6570\u636e\u3002 </p>"},{"location":"chap5/4Istio_Helm/#1-7-templatescrdsyaml","title":"1-7 <code>templates/crds.yaml</code>","text":"<p>\u8be5\u6587\u4ef6\u5305\u542b\u4e86<code>Istio</code>\u6240\u9700\u7684<code>CRD</code>\u5b9a\u4e49\uff0c\u5b83\u7684\u90e8\u7f72\u65b9\u5f0f\u8f83\u4e3a\u7279\u6b8a\uff1a </p> <ul> <li>\u5982\u679c\u4f7f\u7528<code>Helm 2.10</code>\u4e4b\u524d\u7684\u7248\u672c\u8fdb\u884c\u5b89\u88c5\uff0c\u5219\u9700\u8981\u5148\u4f7f\u7528<code>kubectl</code>\u63d0\u4ea4\u8be5\u6587\u4ef6\u5230<code>Kubernetes</code>\u96c6\u7fa4\u4e2d\uff1b </li> <li>\u5982\u679c\u4f7f\u7528<code>Helm 2.10</code>\u4e4b\u540e\u7684\u7248\u672c\uff0c\u5219\u5176\u4e2d\u7684<code>Helm hook</code>\u4f1a\u81ea\u52a8\u63d0\u524d\u5b89\u88c5\uff0c\u65e0\u987b\u7279\u522b\u6ce8\u610f\u3002 </li> </ul>"},{"location":"chap5/4Istio_Helm/#1-8-charts","title":"1-8 <code>charts</code>","text":"<p>\u8fd9\u4e2a\u76ee\u5f55\u4e2d\u7684\u5b50\u76ee\u5f55\u5c31\u662f<code>Istio</code>\u7684\u7ec4\u4ef6\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 </p> <ul> <li><code>certrnanager</code>\uff1a\u4e00\u4e2a\u57fa\u4e8e<code>Jetstack Cert-Manager</code>\u9879\u76ee\u7684<code>ACME</code>\u8bc1\u4e66\u5ba2\u6237\u7aef\uff0c\u7528\u4e8e\u81ea\u52a8\u8fdb\u884c\u8bc1\u4e66\u7684\u7533\u8bf7\u3001\u83b7\u53d6\u53ca\u5206\u53d1\u3002 </li> <li><code>galley</code>: <code>Istio</code>\u5229\u7528<code>Galley</code>\u8fdb\u884c\u914d\u7f6e\u7ba1\u7406\u5de5\u4f5c\u3002</li> <li><code>gateways</code>\uff1a\u5bf9<code>Gateways Chart</code>\u8fdb\u884c\u914d\u7f6e\uff0c\u53ef\u4ee5\u5b89\u88c5\u591a\u4e2a<code>Gateway Controller</code>,</li> <li><code>grafana</code>\uff1a\u56fe\u5f62\u5316\u7684<code>Istio Dashboard</code> </li> <li><code>ingress</code>\uff1a\u4e00\u4e2a\u9057\u7559\u8bbe\u8ba1\uff0c\u9ed8\u8ba4\u5173\u95ed\uff0c\u5728\u6d41\u91cf\u63a7\u5236\u534f\u8bae\u5347\u7ea7\u5230<code>network.istio.io/vlalpha3</code>\u4e4b\u540e\uff0c\u5df2\u7ecf\u5efa\u8bae\u5f03\u7528\u3002 </li> <li><code>kiali</code>\uff1a\u5e26\u6709\u5206\u5e03\u5f0f\u8ddf\u8e2a\u3001\u914d\u7f6e\u6821\u9a8c\u7b49\u591a\u9879\u529f\u80fd\u7684<code>Dashboard</code>\u3002</li> <li><code>mixer</code>: <code>Istio</code>\u7684\u7b56\u7565\u5b9e\u65bd\u7ec4\u4ef6\u3002</li> <li><code>pilot</code>: <code>Istio</code>\u7684\u6d41\u91cf\u7ba1\u7406\u7ec4\u4ef6\u3002 </li> <li><code>prometheus</code>\uff1a \u76d1\u63a7\u8f6f\u4ef6<code>Prometheus</code>,\u5176\u4e2d\u5305\u542b<code>Istio</code>\u7279\u5b9a\u7684\u6307\u6807\u6293\u53d6\u8bbe\u7f6e\u3002 </li> <li><code>security</code>: <code>Citadel</code>\u7ec4\u4ef6\uff0c\u7528\u4e8e\u8bc1\u4e66\u7684\u81ea\u52a8\u7ba1\u7406 </li> <li><code>servicegraph</code>\uff1a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7ec4\u4ef6\uff0c\u7528\u4e8e\u83b7\u53d6\u548c\u5c55\u793a\u670d\u52a1\u8c03\u7528\u5173\u7cfb\u56fe\uff0c\u5373\u5c06\u5e9f\u9664</li> <li><code>sidecarInjectorWebhook</code>: \u81ea\u52a8\u6ce8\u4eba<code>Webhook</code>\u7684\u76f8\u5173\u914d\u7f6e\uff1b </li> <li><code>tracing</code>\uff1a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7ec4\u4ef6\uff0c\u4f7f\u7528<code>Jaeger</code>\u5b9e\u73b0\uff0c\u66ff\u4ee3\u539f\u6709\u7684<code>Service Graph</code>\u7ec4\u4ef6\u3002 </li> </ul>"},{"location":"chap5/4Istio_Helm/#2-charts","title":"2\u3001 <code>charts</code>\u5168\u5c40\u53d8\u91cf\u4ecb\u7ecd","text":"<p>\u6211\u4eec\u5728\u4f7f\u7528\u73b0\u6709<code>Chart</code>\u7684\u65f6\u5019\uff0c\u901a\u5e38\u90fd\u4e0d\u4f1a\u4fee\u6539<code>Chart</code>\u7684\u672c\u4f53\uff0c\u4ec5\u901a\u8fc7\u5bf9\u53d8\u91cf\u7684\u63a7\u5236\u6765\u5b9e\u73b0\u5bf9\u90e8\u7f72\u8fc7\u7a0b\u7684\u5b9a\u5236\u3002<code>Istio Helm Chart</code>\u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u53d8\u91cf\u6765\u5e2e\u52a9\u7528\u6237\u5bf9 <code>Istio</code>\u7684\u5b89\u88c5\u8fdb\u884c\u5b9a\u5236\u3002 </p> <p><code>Istio Chart</code>\u5206\u4e3a\u7236\u5b50\u4e24\u5c42\uff0c\u56e0\u6b64\u53d8\u91cf\u4e5f\u5177\u6709\u5168\u5c40\u548c\u672c\u5730\u4e24\u7ea7\u3002 \u5168\u5c40\u53d8\u91cf\u4f7f\u7528\u4fdd\u7559\u5b57<code>global</code> \u8fdb\u884c\u5b9a\u4e49\uff0c\u5b50<code>Chart</code>\u53ef\u4ee5\u901a\u8fc7<code>Values.global</code>\u7684\u65b9\u5f0f\u5f15\u7528\u5168\u5c40\u53d8\u91cf\uff0c\u800c\u5728\u4e3b<code>Chart</code>\u4e2d\u4e5f\u53ef\u4ee5\u7528<code>chart.var</code>\u7684\u65b9\u5f0f\u4e3a\u5b50<code>Chart</code>\u6307\u5b9a\u53d8\u91cf\u503c\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2-1-hubtag","title":"2-1 <code>hub</code>\u548c<code>tag</code>","text":"<p>\u5728\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e24\u4e2a\u53d8\u91cf\u4ee3\u8868\u6240\u6709\u955c\u50cf\u7684\u5730\u5740\uff0c\u5177\u4f53\u540d\u79f0\u4e00\u822c\u4ee5 <code>\uff5b{ .Values. global.hub}}/[component]/:{{ .Values.global.tag }\uff5d</code> \u7684\u5f62\u5f0f\u62fc\u63a5\u800c\u6210\u3002</p> <p>\u5728 <code>proxy_init</code>\u3001<code>Mixer</code>\u3001 <code>Grafana</code> \u548c <code>Pilot</code>\u7684<code>Deployment</code>\u6a21\u677f\u4e2d, </p> <p>\u4e00\u65e6\u5728\u5176<code>image</code>\u53d8\u91cf\u4e2d \u5305\u542b\u8def\u5f84\u7b26<code>\u201c/\"</code>,\u5219\u4f1a\u5f03\u7528<code>global.hub</code>\uff0c\u76f4\u63a5\u91c7\u7528<code>image</code>\u7684\u5b9a\u4e49\uff0c</p> <p>\u4ee3\u7801\u5982\u4e0b\uff1a </p> <pre><code>{{- if contains \"/\" .Values.image }}\n        image: \"{{ .Values.image }}\"\n{{- else }}\n        image: \"{{ $.Values.global.hub }}/{{ $.Values.image }}:{{ $.Values.global.tag }}\"\n{{- end }}\n</code></pre> <p>\u8fd9\u4e24\u4e2a\u53d8\u91cf\u5bf9\u4e8e\u5185\u7f51\u90e8\u7f72\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\uff0c\u5c06<code>istio</code>\u7684\u955c\u50cf\u62c9\u53d6\u56de\u6765\uff0c\u4e95\u63a8\u9001\u81f3\u79c1\u5e93\u4e4b\u540e\uff0e\u53ea\u8981\u5728<code>Values.yaml</code> \u4e2d\u8fdb\u884c\u4fee\u6539\u3001\u5c31\u53ef\u4ee5\u5c06<code>Istio</code>\u6240\u9700\u955c\u50cf\u7684\u5f15\u7528\u6307\u5411\u5185\u7f51\u79c1\u5e93\uff0e\u7701\u53bb\u4e86\u9010\u4e2a\u4fee\u6539<code>Deployment</code>\u6587\u6863\u7684\u9ebb\u70e6 </p>"},{"location":"chap5/4Istio_Helm/#2-2-ingressenabled","title":"2-2 <code>ingress.enabled</code>","text":"<p>\u8fd9\u4e2a\u5f00\u5173\u7528\u6765\u63a7\u5236\u662f\u5426\u542f\u7528<code>Istio</code> \u7684<code>Ingress Controller</code>.</p> <p>\u5982\u679c\u8fd9\u4e2a\u503c\u88ab\u8bbe\u7f6e\u4e3a<code>True</code> \u5c31\u4f1a\u542f\u7528\u65f6<code>Kubernetes Ingress</code>\u8d44\u6e90\u7684\u652f\u6301\uff0c\u8fd9\u662f\u4e00\u4e2a\u517c\u5bb9\u7684\u529f\u80fd</p>"},{"location":"chap5/4Istio_Helm/#2-3-istio-ingressingress-gateway","title":"2-3 <code>Istio</code>\u5e76\u4e0d\u63a8\u8350 <code>ingress</code>\u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u5efa\u8bae\u4f7f\u7528<code>Ingress Gateway</code>, \u53d6\u800c\u4ee3\u4e4b","text":"<p>\u6709\u4e24\u4e2a\u53d8\u91cf\u4f1a\u53d7\u5230\u8fd9\u4e2a\u5f00\u5173\u7684\u5f71\u554a\uff0c\u8fd9\u4e24\u4e2a\u53d8\u91cf\u5206\u522b\u662f<code>k8sIngressSelector</code>\u548c <code>k8sIngressHttps</code> \u53ea\u6709\u5728<code>ingress.enabled</code>\u88ab\u8bbe\u7f6e\u4e3a<code>True</code>\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e24\u4e2a\u53d8\u91cf\u7684\u76f8\u5173\u5185\u5bb9\u624d\u4f1a\u751f\u6548\u3002 </p> <ul> <li><code>k8sIngresSelector</code>\u4f1a\u5229\u7528<code>Pod</code>\u6807\u7b7e\u9009\u62e9\u4e00\u4e2a<code>Gateway</code>\uff0c\u4f5c\u4e3a<code>Ingress Controller</code> </li> <li>\u5982\u679c\u5c06<code>k8sIngressHttps</code>\u53d8\u91cf\u8d4b\u503c\u4e3a<code>True</code>\uff0c\u5c31\u4f1a\u5728<code>istio-autogenerated-k8s-in gress</code> \u8fd9\u4e2a<code>Gateway</code>\u5b9a\u4e49\u4e2d\u52a0\u5165<code>443</code>\u7aef\u53e3\u53ca\u5176<code>TLS</code>\u914d\u7f6e.</li> </ul> <p><code>k8sIngressHttps</code>\u7684\u76f8\u5173\u5f15\u7528\u5bf9<code>Ingress Gateway Pod</code>\u7684<code>/etc/istio/ingress/certs\uff0f</code>\u4e0b\u7684\u8bc1\u4e66\u6587\u4ef6\u6709\u4f9d\u8d56\uff0e</p> <p>\u56e0\u6b64\u9700\u8981\u542f\u7528\u8fd9\u4e00\u9009\u9879\uff1a\u9700\u8981\u628a<code>ingress.enabled</code>\u8bbe\u7f6e\u4e3a<code>true</code>\u3002</p> <ul> <li>\u4ece\u800c\u6210\u529f\u521b\u5efa<code>ingress Chart</code>\u7684<code>Deployment</code>\uff1b</li> <li>\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u88ab\u547d\u540d\u4e3a<code>Ingress-certs</code>\u7684<code>tls secret</code>\u7ed9<code>istio-ingress Deployment</code> \u8fdb\u884c\u52a0\u8f7d\u3002\u5982\u679c\u6ca1\u6709\u6ee1\u8db3\u8fd9\u4e9b\u6761\u4ef6\uff0c<code>LDS</code>\u5c31\u4f1a\u62d2\u7edd\u670d\u52a1\uff0c\u4ece\u800c\u65e0\u6cd5\u63d0\u4f9b<code>Ingress</code>\u529f\u80fd.</li> </ul>"},{"location":"chap5/4Istio_Helm/#2-4-proxy","title":"2-4 Proxy\u76f8\u5173\u53c2\u6570","text":"<p>\u5728<code>values.yaml</code>\u4e2d\u5b9a\u4e49\u4e00\u7ec4<code>Proxy</code>\u53d8\u91cf, \u7528\u4e8e\u5bf9<code>Sidecar</code>\u8fdb\u884c\u63a7\u5236\u3002  </p>"},{"location":"chap5/4Istio_Helm/#1proxyresources","title":"1.<code>proxy.resources</code>","text":"<p>\u7528\u4e8e\u4e3a<code>Sidecar</code>\u5206\u914d\u8d44\u6e90\u3002\u7528\u6237\u53ef\u4ee5\u6839\u636e\u4e1a\u52a1Pod\u7684\u8d1f\u8f7d\u60c5\u51b5, \u4e3a<code>Sidecar</code>\u6307\u5b9a<code>CPU</code>\u548c\u5185\u5b58\u8d44\u6e90\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2proxyconcurrency","title":"**2.<code>proxy.concurrency</code> **","text":"<p><code>Proxy worker</code> \u6570\u91cf\u8fdb\u884c\u5206\u914d\u3002\u5982\u679c\u88ab\u8bbe\u7f6e\u4e3a0\uff08\u9ed8\u8ba4\u503c\uff09\uff0c\u5219\u6839\u636e<code>CPU</code>\u7ebf\u7a0b\u6216\u6838\u7684\u6570\u91cf\u8fdb\u884c\u5206\u914d\u3002</p>"},{"location":"chap5/4Istio_Helm/#3proxyaccesslogfi1e","title":"3.<code>Proxy.accessLogFi1e</code>","text":"<p><code>Sidecar</code>\u7684\u8bbf\u95ee\u65e5\u5fd7\u4f4d\u7f6e\u3002 \u5982\u679c\u88ab\u8bbe\u7f6e\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u5219\u5173\u95ed\u8bbf\u95ee\u65e5\u5fd7\u529f\u80fd\u3002\u9ed8\u8ba4\u503c\u4e3a<code>/dev/stdout</code>\u3002 </p>"},{"location":"chap5/4Istio_Helm/#4-proxyprivileged","title":"4. <code>proxy.privileged</code>","text":"<p><code>istio-init</code>\u3001<code>istio-proxy</code>\u7684\u7279\u6743\u6a21\u5f0f\u5f00\u5173\u3002\u9ed8\u8ba4\u503c\u4e3a<code>false</code>\u3002 </p>"},{"location":"chap5/4Istio_Helm/#5proxyenablecoredump","title":"5.<code>Proxy.enableCoreDump</code>","text":"<p>\u5982\u679c\u6253\u5f00, \u5219\u65b0\u6ce8\u4eba\u7684<code>Sidecar</code>\u4f1a\u542f\u52a8<code>CoreDump</code>\u529f\u80fd\uff0c \u5728<code>Pod</code>\u4e2d\u52a0\u4eba\u521d\u59cb\u5316\u5bb9\u5668  <code>enable-core-dump</code>\u9ed8\u8ba4\u503c\u4e3a<code>false</code> </p>"},{"location":"chap5/4Istio_Helm/#6proxyincludeipranges","title":"6.<code>proxy.includeIPRanges</code>","text":"<p>\u52ab\u6301<code>IP</code>\u8303\u56f4\u7684\u767d\u540d\u5355\u3002\u9ed8\u8ba4\u503c\u4e3a<code>\u201c*\"</code>\uff0c\u4e5f\u5c31\u662f\u52ab\u6301\u6240\u6709\u5730\u5740\u7684\u6d41\u91cf\u3002</p> <p>\u5728<code>sidecar-injector-configmap.yaml</code>\u4e2d\u5e94\u7528\u4e86\u8fd9\u4e00\u53d8\u91cf\uff0c\u7528\u4e8e\u751f\u6210<code>istio-sidecar-injector</code>\u8fd9\u4e2a<code>ConfigMap</code>\uff0c\u8fd9\u4e2a<code>ConfigMap</code>\u8bbe\u7f6e\u4e86<code>istio-init</code>\u7684\u8fd0\u884c\u53c2\u6570\uff0c\u901a\u8fc7\u5bf9<code>istio-init</code>\u7684<code>\"-i\u201d</code>\u53c2\u6570\u8fdb\u884c\u4fee\u6539\u6765\u5b8c\u6210\u8fd9\u4e00\u4efb\u52a1\u3002 </p>"},{"location":"chap5/4Istio_Helm/#7-proxyexcludeipranges","title":"7. <code>Proxy.excludeIPRanges</code>","text":"<p>\u52ab\u6301<code>IP</code>\u8303\u56f4\u7684\u9ed1\u540d\u5355\u3002\u9ed8\u8ba4\u503c\u4e3a\u7a7a\u5b57\u7b26\u4e32, \u4e5f\u5c31\u52ab\u6301\u8303\u56f4\u4ee5\u5916\u7684IP\u3002\u540c<code>proxy.includeIPRanges</code> \u7684\u60c5\u51b5\u7c7b\u4f3c\u3002\u5b83\u5f71\u54cd\u7684\u662f<code>istio-init</code>\u7684<code>-x</code>\u53c2\u6570</p>"},{"location":"chap5/4Istio_Helm/#8proxyincludeinboundports","title":"8.<code>Proxy.includeInboundPorts</code>","text":"<p>\u5165\u7ad9\u6d41\u91cf\u7684\u7aef\u53e3\u52ab\u6301\u767d\u540d\u5355\u3002\u6240\u6709\u4ece\u8303\u56f4\u5185\u7684\u7aef\u53e3\u8fdb\u5165Pod\u7684\u6d41\u91cf\u90fd\u4f1a\u88ab\u52ab\u6301\u3002\u5b83\u5f71\u54cd\u7684\u662f<code>istio-init</code>\u7684<code>\"-b\"</code>\u53c2\u6570</p>"},{"location":"chap5/4Istio_Helm/#9proxyexcludeinboundports","title":"9.<code>proxy.excludeInboundports</code>","text":"<p>\u5165\u7ad9\u6d41\u91cf\u7684\u7aef\u53e3\u52ab\u6301\u9ed1\u540d\u5355\u3002\u8fd9\u4e00\u7aef\u53e3\u8303\u56f4\u4e4b\u5916\u7684\u5165\u7ad9\u6d41\u91cf\u624d\u4f1a\u88ab\u52ab\u6301\u3002 \u5b83\u5f71\u54cd\u7684\u662f<code>Istio-init</code>\u7684<code>\u201c-d\u201d</code>\u53c2\u6570\u3002 </p>"},{"location":"chap5/4Istio_Helm/#10proxyautoinject","title":"10.<code>proxy.autoInject</code>","text":"<p>\u7528\u4e8e\u63a7\u5236\u662f\u5426\u81ea\u52a8\u5b8c\u6210<code>Sidecar</code>\u7684\u6ce8\u5165\u5de5\u4f5c\u3002 </p>"},{"location":"chap5/4Istio_Helm/#11-proxyenvoystatsd","title":"11. <code>proxy.envoyStatsd</code>","text":"<p>\u8be5\u53d8\u91cf\u7684\u9ed8\u8ba4\u503c\u5982\u4e0b\u3002 </p> <ul> <li><code>enabled:true</code> </li> <li><code>host:istio-statsd-prom-bridge</code> </li> <li><code>port:9125</code> </li> </ul> <p>\u5b83\u4f1a\u8bbe\u7f6e<code>Envoy</code>\u7684<code>\u201c--statsdUdpAddress\u201d</code>\u53c2\u6570\uff0c\u5728\u67d0\u4e9b\u53c2\u6570\u4e0b\uff08\u4f8b\u5982\u6ca1\u6709\u5b89\u88c5 <code>Mixer</code>\uff09\u53ef\u4ee5\u5173\u95ed\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2-4-proxy_initimage","title":"2-4 <code>proxy_init.image</code>","text":"<p>\u7f51\u683c\u4e2d\u7684\u670d\u52a1<code>Pod</code>\u5728\u542f\u52a8\u4e4b\u524d\uff0c\u9996\u5148\u4f1a\u8fd0\u884c\u4e00\u4e2a\u521d\u59cb\u5316\u955c\u50cf\u6765\u5b8c\u6210\u6d41\u91cf\u52ab\u6301\u5de5\u4f5c\uff0c\u8fd9\u4e2a\u53d8\u91cf\u53ef\u4ee5\u7528\u4e8e\u6307\u5b9a\u521d\u59cb\u5316\u5bb9\u5668\u955c\u50cf\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2-5-imagepullpolicy","title":"2-5 <code>imagePullPolicy</code>","text":"<p>\u955c\u50cf\u7684\u62c9\u53d6\u7b56\u7565\u3002\u9ed8\u8ba4\u503c\u4e3a<code>\u201cIfNotPresent\"</code>.</p>"},{"location":"chap5/4Istio_Helm/#2-6-controlplanesecurityenabled","title":"2-6 <code>controlPlaneSecurityEnabled</code>","text":"<p>\u6307\u5b9a\u662f\u5426\u5728<code>Istio</code>\u63a7\u5236\u9762\u7ec4\u4ef6\u4e0a\u542f\u7528<code>mTLS</code>\u901a\u4fe1\u3002</p> <p>\u5728\u542f\u7528\u4e4b\u540e\uff0c<code>Sidecar</code>\u548c\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u4e4b\u95f4\uff0c\u4ee5\u53ca\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u4e4b\u95f4\u7684\u901a\u4fe1\uff0c\u90fd\u4f1a\u88ab\u6539\u4e3a<code>mTLS</code>\u65b9\u5f0f\u3002\u53d7\u5f71\u54cd\u7684\u7ec4\u4ef6\u5305\u62ec<code>Ingress</code>. <code>Mixer</code>, <code>Pilot</code>\u53ca<code>Sidecar</code>.</p>"},{"location":"chap5/4Istio_Helm/#2-7-disablepolicychecks","title":"2-7 <code>disablePolicyChecks</code>","text":"<p>\u5982\u679c\u628a\u8fd9\u4e2a\u5f00\u5173\u53d8\u91cf\u8bbe\u7f6e\u4e3a<code>true</code>\uff0c\u5219\u4f1a\u7981\u7528<code>Mixer</code>\u7684\u9884\u68c0\u529f\u80fd\u3002\u9884\u68c0\u529f\u80fd\u662f\u4e00\u4e2a\u540c\u6b65\u8fc7\u7a0b\uff0c\u6709\u53ef\u80fd\u56e0\u4e3a\u9884\u68c0\u7f13\u6162\u9020\u6210\u4e1a\u52a1\u5e94\u7528\u7684\u963b\u585e\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2-8-enabletracing","title":"2-8 <code>enableTracing</code>","text":"<p>\u662f\u5426\u542f\u7528\u5206\u5e03\u5f0f\u8ddf\u8e2a\u529f\u80fd\uff0c\u9ed8\u8ba4\u503c\u4e3a<code>true</code> </p>"},{"location":"chap5/4Istio_Helm/#2-9-mtlsenabled","title":"2-9 <code>mtls.enabled</code>","text":"<p>\u6240\u6709\u670d\u52a1\u4e4b\u95ee\u7684\u901a\u4fe1\u90fd\u4f1a\u4f7f\u7528<code>mTLS</code>\u8fdb\u884c\u5b89\u5168\u52a0\u56fa\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u4e00\u53d8\u91cf\u7684\u8bbe\u7f6e\u662f\u5168\u5c40\u7684\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u670d\u52a1\u8fd8\u4ee5\u5355\u72ec\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6216\u8005\u670d\u52a1\u6ce8\u89e3\u7684\u65b9\u5f0f\uff0c\u81ea\u884c\u8bc0\u5b9a\u662f\u5426\u91c7\u7528<code>mTLS</code>\u52a0\u56fa</p>"},{"location":"chap5/4Istio_Helm/#2-10-imagepullsecrets","title":"2-10 <code>imagePullSecrets</code>","text":"<p>\u7528\u4e8e\u4e3a<code>ServiceAccount</code>\u5206\u914d\u5728\u955c\u50cf\u62c9\u53d6\u8fc7\u7a0b\u4e2d\u6240\u9700\u7684\u8ba4\u8bc1\u51ed\u636e\u3002\u9ed8\u8ba4\u503c\u4e3a\u7a7a\u503c </p>"},{"location":"chap5/4Istio_Helm/#2-11-arch","title":"2-11 <code>arch</code>","text":"<p>\u5728\u8bbe\u7f6e<code>Istio</code>\u7ec4\u4ef6\u7684\u8282\u70b9\u4eb2\u548c\u6027\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u4f7f\u7528\u8fd9\u4e00\u53d8\u91cf\u7684\u5217\u8868\u5185\u5bb9\u6765\u786e\u5b9a\u53ef\u4ee5\u7528\u4e8e\u90e8\u7f72\u7684\u8282\u70b9\u8303\u56f4\uff0c\u5e76\u6309\u7167\u4e0d\u540c\u7684\u670d\u52a1\u5668\u67b6\u6784\u8bbe\u7f6e\u4e86\u4f18\u5148\u987a\u5e8f\u3002\u5b83\u7684\u9ed8\u8ba4\u5217\u8868\u5185\u5bb9\u5982\u4e0b\uff1a </p> <ul> <li><code>amd64:2</code> </li> <li><code>s390x:2</code></li> <li><code>ppc64le:2</code></li> </ul>"},{"location":"chap5/4Istio_Helm/#2-12-onenamespace","title":"2-12 <code>oneNamespace</code>","text":"<p>\u9ed8\u8ba4\u503c\u4e3a<code>false</code>, <code>Pilot</code>\u4f1a\u76d1\u63a7\u6240\u6709\u547d\u540d\u7a7a\u95f4\u5185\u7684\u670d\u52a1\u53d8\u5316\u5982\u679c\u8fd9\u4e2a\u53d8\u91cf\u88ab\u8bbe\u7f6e\u4e3a<code>true</code>\uff0c\u5219\u4f1a\u5728<code>Pilot</code>\u7684\u670d\u52a1\u53d1\u73b0\u53c2\u6570\u4e2d\u52a0\u5165<code>\"-a\"</code>, \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c<code>Pilot</code>\u53ea\u4f1a\u5bf9<code>Istio</code>\u7ec4\u4ef6\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u8fdb\u884c\u76d1\u63a7\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2-13-configvalidation","title":"2-13 <code>configValidation</code>","text":"<p>\u7528\u4e8e\u914d\u7f6e\u662f\u5426\u5f00\u542f\u670d\u52a1\u7aef\u7684\u914d\u7f6e\u9a8c\u8bc1\u3002\u9ed8\u8ba4\u503c\u4e3a<code>true</code>. \u8be5\u9009\u9879\u5728\u5f00\u542f\u4e4b\u540e\uff0c \u4f1a\u751f\u6210\u4e00\u4e2a<code>ValidatingWebhook Configuration</code> \u5bf9\u8c61\uff0c\u5e76\u88ab\u5305\u542b\u5230<code>Galley</code>\u7684\u914d\u7f6e\u4e2d\uff0c\u4ece\u800c\u542f\u7528\u6821\u9a8c\u529f\u80fd\u3002</p>"},{"location":"chap5/4Istio_Helm/#2-14-meshexpansion","title":"2-14 <code>meshExpansion</code>","text":"<p>\u8981\u5c06\u670d\u52a1\u7f51\u683c\u6269\u5c55\u5230\u7269\u7406\u673a\u6216\u8005\u865a\u62df\u673a\u4e0a\uff0c\u5c31\u4f1a\u4f7f\u7528\u5230\u8fd9\u4e00\u53d8\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a<code>false</code> \u5982\u679c\u88ab\u8bbe\u7f6e\u4e3a<code>true</code>\uff0c\u5219\u4f1a\u5728<code>Ingress Gateway</code>\u4e0a\u516c\u5f00<code>Pilot</code>\u548c<code>Citadel</code>\u7684\u670d\u52a1\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2-15-meshexpansionilb","title":"2-15 <code>meshExpansionILB</code>","text":"<p>\u662f\u5426\u5728\u5185\u90e8\u7f51\u5173\u4e2d\u516c\u5f00<code>Pilot</code>\u548c<code>Citadel</code>\u7684\u7aef\u53e3\u3002</p> <p>\u9ed8\u8ba4\u503c\u4e3a<code>false</code>\uff0c\u4ec5\u5728\u670d\u52a1\u7f51\u683c\u6269\u5c55\u65f6\u4f1a\u4f7f\u7528\u5230\u8fd9\u4e00\u53d8\u91cf\u3002</p>"},{"location":"chap5/4Istio_Helm/#2-16-defaultresources","title":"2-16 <code>defaultResources</code>","text":"<p>\u4e3a\u6240\u6709<code>Istio</code>\u7ec4\u4ef6\u90fd\u63d0\u4f9b\u4e00\u4e2a\u6700\u5c0f\u8d44\u6e90\u9650\u5236\u3002\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53ea\u8bbe\u7f6e\u4e00\u4e2a\u8bf7\u6c42<code>10m Cpu</code>\u8d44\u6e90\u7684\u503c\u3002\u53ef\u4ee5\u5728\u5404\u4e2a<code>Chart</code>\u7684\u5c40\u90e8\u53d8\u91cf\u4e2d\u5206\u522b\u8bbe\u7f6e\u8d44\u6e90\u9700\u6c42\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2-17-hyperkube","title":"2-17 <code>hyperkube</code>","text":"<p>\u5728<code>Istio</code>\u7684\u8bbe\u7f6e\u8fc7\u7a0b\u4f1a\u4f7f\u7528\u4e00\u4e2a\u955c\u50cf\u6267\u884c\u4e00\u4e9b<code>Job</code>\uff0c\u4f8b\u5982\u5728\u65e9\u671f\u7248\u672c\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u7684<code>CRD</code>\u521d\u59cb\u5316\uff0c\u6216\u8005\u73b0\u5728\u7684\u6e05\u7406\u8fc7\u671f\u8bc1\u4e66\u7b49\u4efb\u52a1\u3002\u8fd9\u4e2a\u955c\u50cf\u9ed8\u8ba4\u4f7f\u7528\u7684\u662f <code>quay.io/coreos:v1.7.6_coreos.0</code>\uff0c\u5728\u5185\u7f51\u4e2d\u540c\u6837\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u8986\u76d6\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2-18-priorityclassname","title":"2-18 <code>priorityClassName</code>","text":"<p><code>Kubernetes</code>\u5728<code>1.11.0</code>\u4ee5\u4e0a\u7248\u672c\u4e2d\u63d0\u51fa\u4e86<code>PriorityClass</code>\u7684\u6982\u5ff5\uff0c\u5177\u6709\u4f18\u5148\u7ea7\u7684<code>Pod</code>  \u4e0d\u4f1a\u88ab\u9a71\u9010\u6216\u62a2\u5360\u8d44\u6e90\u3002\u8be5\u53d8\u91cf\u7684\u9ed8\u8ba4\u503c\u4e3a\u7a7a\uff0c\u53ef\u9009\u503c\u5305\u62ec<code>\u201csystem-cluster-critical\"</code> \u548c<code>\"system-node-critical\"</code>\u3002 </p>"},{"location":"chap5/4Istio_Helm/#2-19-crds","title":"2-19 <code>crds</code>","text":"<p>\u8be5\u53d8\u91cf\u7528\u4e8e\u51b3\u5b9a\u662f\u5426\u5305\u542b<code>CRD</code>\u5b9a\u4e49\u3002\u5982\u679c\u4f7f\u7528<code>helm templat</code>e\u547d\u4ee4\uff0c\u6216\u8005\u662f<code>2.10</code>\u4ee5\u571f\u7248\u672c\u7684<code>helm install</code>\u547d\u4ee4\uff0c\u5219\u5e94\u8be5\u5c06\u5176\u8bbe\u7f6e\u4e3a<code>true</code>;</p> <p>\u5426\u5219\u5728\u5b89\u88c5\u4e4b\u524d\u9996\u5148\u8981\u6267\u884c <code>kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml</code>\uff0c\u5e76\u5c06\u8be5\u53d8\u91cf\u8bbe\u7f6e\u4e3a <code>false</code>\u3002 </p>"},{"location":"chap5/4Istio_Helm/#3istio","title":"3\u3001Istio \u5b89\u88c5\u6e05\u5355\u7684\u751f\u6210\u548c\u90e8\u7f72","text":""},{"location":"chap5/4Istio_Helm/#3-1-valuesyaml","title":"3-1 \u7f16\u8f91<code>values.yaml</code>","text":"<p>\u6211\u4eec\u9700\u8981\u5148\u6839\u636e\u5b9e\u9645\u9700\u6c42\u5bf9<code>Istio</code>\u8fdb\u884c\u5b9a\u5236\uff0c<code>values.yaml</code>\u3002\u6700\u5e38\u89c1\u7684\u4fee\u6539\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\u3002 </p> <ul> <li>\u955c\u50cf\u5730\u5740 </li> </ul> <p>\u5982\u679c\u662f\u5185\u7f51\u90e8\u7f72\uff0c\u90a3\u4e48\u9700\u8981\u5148\u89e3\u51b3\u955c\u50cf\u5730\u5740\u95ee\u9898\u3002\u6211\u4eec\u901a\u5e38\u4f1a\u5728\u5177\u5907\u5916\u7f51\u8fde\u63a5\u6761\u4ef6\u7684\u670d\u52a1\u5668\u4e0a\u62c9\u53d6\u6240\u9700\u955c\u50cf\uff0c\u7136\u540e\u5bfc\u51fa\u955c\u50cf\uff0c\u5c06\u5176\u63a8\u9001\u5230\u672c\u5730\u79c1\u6709\u955c\u50cf\u5e93\u3002\u90a3\u4e48\uff0c \u5982\u4f55\u77e5\u9053\u6211\u4eec\u9700\u8981\u54ea\u4e9b\u955c\u50cf\uff1f </p> <p>\u6211\u4eec\u53ef\u4ee5<code>grep istio-demo.yaml</code></p> <pre><code>$ cd Istio/istio-1.1.16/install/kubernetes\n\n$ grep -r image: istio-demo.yaml | egrep -o -e \"image:.*\" | sort | uniq\nimage: \"docker.io/istio/citadel:1.1.16\"\nimage: \"docker.io/istio/galley:1.1.16\"\nimage: \"docker.io/istio/kubectl:1.1.16\"\nimage: \"docker.io/istio/kubectl:1.1.16\"\nimage: \"docker.io/istio/mixer:1.1.16\"\nimage: \"docker.io/istio/pilot:1.1.16\"\nimage: \"docker.io/istio/proxy_init:1.1.16\"\nimage: \"docker.io/istio/proxyv2:1.1.16\"\nimage: \"docker.io/istio/sidecar_injector:1.1.16\"\nimage: \"docker.io/jaegertracing/all-in-one:1.9\"\nimage: \"docker.io/kiali/kiali:v0.16\"\nimage: \"docker.io/prom/prometheus:v2.3.1\"\nimage: \"grafana/grafana:6.0.2\"\nimage: [[ annotation .ObjectMeta `sidecar.istio.io/proxyImage`  \"docker.io/istio/proxyv2:1.1.16\"  ]]\n</code></pre> <p>\u5728\u5f97\u5230\u8fd9\u4e9b\u955c\u50cf\u540d\u79f0\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u9010\u4e2a\u8fdb\u884c\u955c\u50cf\u7684\u62c9\u53d6\u548c\u63a8\u9001\u64cd\u4f5c\u4e86\u3002 </p> <p>\u63a5\u4e0b\u6765\u6839\u636e\u79c1\u5e93\u5730\u5740\uff0c\u4fee\u6539<code>values.yaml</code>\u4e2d\u5404\u4e2a\u955c\u50cf\u7684\u5730\u5740\uff0c\u751f\u6210\u65b0\u7684\u5b89\u88c5\u6e05\u5355\u6587\u4ef6\uff0c\u7136\u540e\u91cd\u65b0\u7528\u4e0a\u8ff0\u547d\u4ee4\u8fdb\u884c\u68c0\u67e5\u5373\u53ef\u3002 </p>"},{"location":"chap5/4Istio_Helm/#3-2","title":"3-2 \u7cfb\u7edf\u8d44\u6e90","text":"<p><code>Values.yaml</code>\u4e2d\u7684\u7cfb\u7edf\u8d44\u6e90\u8bbe\u7f6e\u662f\u975e\u5e38\u4fdd\u5b88\u7684\uff0c\u5e76\u4e14\u4e0d\u591f\u5b8c\u6574\uff0c\u56e0\u6b64\u8fd9\u91cc\u5efa\u8bae\u6839\u636e\u5b9e\u9645\u968b\u51b5\u8c03\u6574\u5404\u4e2a\u7ec4\u4ef6\u7684\u8d44\u6e90\u5206\u914d\u3002</p>"},{"location":"chap5/4Istio_Helm/#3-3","title":"3-3 \u670d\u52a1\u7c7b\u578b","text":"<p><code>Istio</code>\u7684<code>Istio-ingressgateWay</code>\u670d\u52a1\u7684\u9ed8\u8ba4\u7c7b\u578b\u662f<code>Loadbalancer</code>\uff0c\u5982\u679c\u5728\u8981\u90e8\u7f72\u7684 \u76ee\u6807<code>Kubernetes</code>\u96c6\u7fa4\u4e2d\u6ca1\u6709\u8d1f\u8f7d\u5747\u8861\u652f\u6301\uff0c\u5c31\u9700\u8981\u5bf9\u670d\u52a1\u7c7b\u578b\u8fdb\u884c\u4fee\u6539\u4e86</p>"},{"location":"chap5/4Istio_Helm/#3-4","title":"3-4 \u53ef\u89c6\u5316\u7ec4\u4ef6\u7684\u670d\u52a1\u5f00\u653e","text":"<p>\u5728<code>Istio</code>\u4e2d\u5305\u542b\u4e86<code>Prometheus</code>, <code>Grafana</code>\u53ca<code>Kiali</code>\u7b49\u53ef\u89c6\u5316\u7ec4\u4ef6\uff0c\u5728\u9ed8\u8ba4\u72b6\u6001\u4e0b\u90fd\u662f<code>ClusterIP</code>\u7c7b\u578b\u7684\uff0c\u8981\u987a\u5229\u4f7f\u7528\uff0c\u5219\u53ef\u80fd\u9700\u8981\u4e3a\u5176\u5206\u914d<code>Ingress</code>\u6216\u8005\u4fee\u6539\u670d\u52a1\u7c7b\u578b\u3002 </p>"},{"location":"chap5/4Istio_Helm/#4","title":"4\u3001\u751f\u6210\u90e8\u7f72\u6e05\u5355","text":"<p>\u5728\u5b8c\u6210\u5bf9<code>values.yaml</code> \u7684\u7f16\u8f91\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528<code>helm template</code>\u547d\u4ee4\u6765\u751f\u6210\u6700\u7ec8\u7684 \\\u90e8\u7f72\u6e05\u5355\u6587\u4ef6\u4e86\uff0c\u4f8b\u5982\u6211\u4eec\u751f\u6210\u7684\u8f93\u4eba\u6587\u4ef6\u4e3a<code>my-values.yaml</code>\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528\u5982\u4e0b\u547d\u4ee4\u751f\u6210\u6211\u4eec\u9700\u8981\u7684YAML\u6587\u4ef6\uff1a </p> <pre><code>$ helm template install/kubernetes/helm/istio  \\\n--namespace istio\u4e00system \\ \n-f my-values.yaml&gt;my-istio.yaml\n</code></pre> <p>\u8fd9\u4e2a\u547d\u4ee4\u5047\u8bbe\u6211\u4eec\u7684\u5f53\u524d\u76ee\u5f55\u662f<code>Istio</code>\u53d1\u884c\u5305\u7684\u6839\u76ee\u5f55\uff0c\u5176\u4e2d\uff1a </p> <ul> <li><code>\"--name istio\u201d</code> \u4ee3\u8868\u751f\u6210\u7684\u90e8\u7f72\u5185\u5bb9\u7684\u57fa\u7840\u540d\u79f0\u4e3a\u201cistio\"; </li> <li><code>\"--namespace istio-system\u201d</code>\u4ee3\u8868\u5c06<code>Istlo</code>\u90e8\u7f72\u5230\u547d\u540d\u7a7a\u95f4 \"istio-system\u201d\u4e2d\uff1b</li> <li><code>\"-f my-values.yaml\u201d</code>\u4ee3\u8868\u4ece<code>my-values.yaml</code>\u6587\u4ef6\u4e2d\u83b7\u53d6\u8f93\u4eba\u7684\u5185\u5bb9\u3002 </li> </ul> <p>\u8be5\u547d\u4ee4\u5728\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\uff0c\u4f1a\u751f\u6210\u90e8\u7f72\u6e05\u5355\u6587\u4ef6<code>my-istio.yaml</code>\uff0c\u53ef\u4ee5\u6253\u5f00\u8be5\u6587\u4ef6\uff0c\u68c0\u67e5\u5176\u4e2d\u7684\u5185\u5bb9\u662f\u5426\u7b26\u5408\u9884\u671f\u3002 </p>"},{"location":"chap5/4Istio_Helm/#5istio","title":"5\u3001\u90e8\u7f72Istio","text":"<p>\u5728\u90e8\u7f72\u6e05\u5355\u751f\u6210\u5e76\u68c0\u67e5\u5b8c\u6bd5\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5f00\u59cb\u90e8\u7f72\u4e86\u3002 </p> <p>\u6211\u4eec\u751f\u6210\u7684<code>my-istio.yaml</code>\u662f\u8981\u6c42\u90e8\u7f72\u5230<code>istio-system</code>\u547d\u540d\u7a7a\u95f4\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f7f\u7528<code>kubectl</code>\u547d\u4ee4\u6765\u521b\u5efa\u5b83\uff1a </p> <pre><code>$ kubectl create ns istio-system \nnamespace/istio-system created \n</code></pre> <pre><code>kubectl apply -f my-istio.yaml \nconfigmap/istio-galley-configuration created \nconfigmap/istio-statsd-prom-bridge created \nconfigmap/prometheus created \nconfigmap/istio-security-custom-resources created \n</code></pre> <p>\u7b49\u8fd0\u884c\u7ed3\u675f\u4e4b\u540e\uff0c\u540c\u6837\u53ef\u4ee5\u4f7f\u7528<code>\u201ckubecti get po -n istio-system -w\u201d</code>\u547d\u4ee4\u6765\u67e5\u770b <code>Pod</code>\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u76f4\u5230\u5168\u90e8<code>Pod</code>\u6210\u529f\u8fdb\u4eba<code>Running</code>\u6216\u8005<code>Completed</code>\u72b6\u6001\uff0c<code>Istio</code>\u7684\u5b89\u88c5\u90e8\u7f72\u5de5\u4f5c\u5c31\u5b8c\u6210\u4e86\u3002 </p>"},{"location":"chap5/4Istio_Helm/#6","title":"6\u3001\u5c0f\u7ed3","text":"<p>Helm\u8fd8\u6709\u4e00\u79cd\u5e38\u89c1\u7684\u90e8\u7f72\u65b9\u5f0f\uff0c\u5c31\u662f\u901a\u8fc7<code>helm install</code>\u547d\u4ee4\u8fdb\u884c\u90e8\u7f72\u3002\u4f46\u662f\uff0c\u91c7\u7528\u8fd9\u79cd\u90e8\u7f72\u65b9\u5f0f\u65f6\uff0c\u9700\u8981\u5728<code>Kubernetes</code>\u4e2d\u90e8\u7f72<code>Tiller</code>\uff1a\u670d\u52a1\u7aef\uff0c\u800c\u4e14\u4e0d\u4f1a\u751f\u6210\u90e8\u7f72\u6e05\u5355\u6587\u4ef6\uff0c\u8fd9\u5bf9\u4e8e\u914d\u7f6e\u7ba1\u7406\u6765\u8bf4\u662f\u5f88\u4e0d\u65b9\u4fbf\u7684\uff0c\u56e0\u6b64\u8fd9\u91cc\u4e0d\u505a\u63a8\u8350\u3002</p> <p>\u53e6\u5916\uff0c\u5728<code>Helm</code>\u7684<code>template</code>\u6216\u8005<code>install</code>\u547d\u4ee4\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7<code>\u201c--set\u201d</code>\u7684\u65b9\u5f0f\u6765\u8bbe\u7f6e  \u53d8\u91cf\u503c\u3002\u8fd9\u91cc\u6ca1\u6709\u63d0\u53ca\u8fd9\u79cd\u65b9\u5f0f\uff0c\u539f\u56e0\u5f88\u7b80\u5355\uff1a<code>Istio</code>\u90e8\u7f72\u8fc7\u7a0b\u4e2d\u6d89\u53ca\u7684\u53d8\u91cf\u592a\u591a\uff0c\u547d\u4ee4\u884c\u65b9\u5f0f\u66f4\u663e\u7b28\u91cd\u3002 </p>"},{"location":"chap5/5Istio_funcs/","title":"\u7b2c\u4e94\u8282 Istio \u5e38\u7528\u529f\u80fd \uff08\u81ea\u52a8/\u624b\u52a8\u90e8\u7f72<code>Istio</code>\u5e94\u7528\uff09","text":"<p><code>Istio</code>\u5728\u5fae\u670d\u52a1\u4f53\u7cfb\u4e2d\u63d0\u4f9b\u4e86\u4e3a\u6570\u4f17\u591a\u7684\u5404\u79cd\u529f\u80fd\uff0c\u8fd9\u4e48\u591a\u529f\u80fd\u96be\u514d\u8ba9\u4eba\u773c\u82b1\u7f2d\u4e71\uff0c\u672c\u7ae0\u5c06\u4f1a\u4ece\u5728\u7f51\u683c\u4e2d\u90e8\u7f72\u5e94\u7528\u5f00\u59cb\uff0c\u5c55\u793a<code>Istio</code>\u7684\u5e38\u7528\u529f\u80fd\uff0c\u5305\u62ec\u57fa\u672c\u7684\u6d41\u91cf\u63a7\u5236\u3001\u5f00\u7bb1\u5373\u7528\u7684\u53ef\u89c6\u5316\u529f\u80fd\u7b49\u3002 </p> <p>\u672c\u7ae0\u5185\u5bb9\u6d89\u53ca<code>Grafana</code>, <code>Prometheus</code>, <code>Jaeger</code>\u53ca<code>Kiali</code>\uff0c\u90fd\u662f\u72ec\u7acb\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u5404 \u9879\u76ee\u6240\u6d89\u53ca\u7684\u5185\u5bb9\u90fd\u975e\u5e38\u4e30\u5bcc\u548c\u6df1\u5165\u3002</p>"},{"location":"chap5/5Istio_funcs/#1","title":"1\u3001\u5728\u7f51\u683c\u4e2d\u90e8\u7f72\u5e94\u7528","text":"<p>\u6211\u4eec\u5728\u7b2c3\u7ae0\u4e2d\u5df2\u7ecf\u4f7f\u7528\u8fc7<code>istioctl kube-inject</code>\u547d\u4ee4\u6765\u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u6ce8\u4eba<code>Istio Sidecar</code>\uff0c\u672c\u8282\u4f1a\u7a0d\u5fae\u6df1\u4eba\u5730\u63a2\u8ba8\u8fd9\u4e2a\u529f\u80fd\u3002</p> <p>\u6dfb\u52a0\u4e00\u4e2a<code>\"-o\"</code>\u53c2\u6570\uff0c\u5c06\u6ce8\u4eba\u7ed3\u679c\u8f93\u51fa\u4e3a\u6587\u4ef6\uff0c\u4ee5\u4fbf\u89c2\u5bdf\uff1a</p> <pre><code>istioctl kube-inject -f flask.istio.yaml -o flask.istio.injected.yaml\n</code></pre> <p>\u5728\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u591a\u51fa\u4e86\u4e00\u4e2a <code>flask.istio.injected.yaml</code>\u6587\u4ef6\u3002</p> <p>\u6253\u5f00\u8be5\u6587\u4ef6\uff0c\u5c06\u5176\u548c\u6e90\u6587\u4ef6<code>flask.istio.yaml</code>\u8fdb\u884c\u5bf9\u6bd4\uff0c\u4e0d\u96be\u53d1\u73b0\u5176\u4e2d\u7684<code>Service</code>\u5bf9\u8c61\u6ca1 \u6709\u53d1\u751f\u4efb\u4f55\u53d8\u5316\uff0c\u4e24\u4e2a<code>Deployment</code>\u5bf9\u8c61\u5219\u6709\u5f88\u5927\u7684\u6539\u53d8\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: flaskapp\n  labels:\n    app: flaskapp\nspec:\n  selector:\n    app: flaskapp\n  ports:\n    - name: http\n      port: 80\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  creationTimestamp: null\n  name: flaskapp-v1\nspec:\n  ...\n        sidecar.istio.io/status: '{\"version\":\"4457e141f44dbeb1708490f938c6723acfa1090eef4a5becb97e6329952a2d8d\",\"initContainers\":[\"istio-init\"],\"containers\":[\"istio-proxy\"],\"volumes\":[\"istio-envoy\",\"istio-certs\"],\"imagePullSecrets\":null}'\n     ...\n    spec:\n      containers:\n      ...\n      - args:\n        - proxy\n        - sidecar\n        ...\n        env:\n        ...\n        image: docker.io/istio/proxyv2:1.1.16\n        imagePullPolicy: IfNotPresent\n        name: istio-proxy\n        ...\n        image: docker.io/istio/proxy_init:1.1.16\n        imagePullPolicy: IfNotPresent\n        name: istio-init\n        resources:\n          limits:\n            cpu: 100m\n            memory: 50Mi\n          requests:\n            cpu: 10m\n            memory: 10Mi\n        securityContext:\n          capabilities:\n            add:\n            - NET_ADMIN\n          runAsNonRoot: false\n          runAsUser: 0\n      volumes:\n      - emptyDir:\n          medium: Memory\n        name: istio-envoy\n      - name: istio-certs\n        secret:\n          optional: true\n          secretName: istio.default\nstatus: {}\n...\n</code></pre> <p>\u6211\u4eec\u4f1a\u53d1\u73b0\u591a,\u4e00\u4e2a\u88ab\u5c61\u6b21\u63d0\u5230\u7684<code>sidecar</code>\u5bb9\u5668\u4e95\u4e14\u51fa\u73b0\u4e86\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668<code>(init-containers)</code>\u8fd9\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u5c31\u662f\u7528\u6765\u52ab\u6301\u5e94\u7528\u5230<code>Sidecar</code></p> <p>\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u4f7f\u7528<code>kubectl</code> \u5c06\u6ce8\u4eba\u540e\u7684YAML\u6e05\u5355\u6587\u4ef6\u63d0\u4ea4\u5230\u96c6\u7fa4\u91cc\u4e0a\u8fd0\u884c\u4e86</p> <pre><code>$ kubectl apply -f flask.istio.injected.yaml \nservice/flaskapp unchanged\ndeployment.extensions/flaskapp-v1 configured\ndeployment.extensions/flaskapp-v2 configured\n</code></pre> <p>\u9664\u4e86\u652f\u6301\u624b\u5de5\u6ce8\u4eba,<code>Istio</code>\u8fd8\u652f\u6301\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u81ea\u52a8\u6ce8\u4eba,\u5e76\u5bf9\u5f85\u6ce8\u4eba\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6709\u4e00\u5b9a\u7684\u8981\u6c42</p> <p>\u56e0\u4e3a<code>istioctl</code>\u8981\u6839\u636e<code>configmap</code>\u6765\u83b7\u53d6\u6ce8\u5165\u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u8bf4\u6267\u884c<code>Istioctl</code>\u7684\u7528\u6237\u5fc5\u987b\u80fd\u591f\u8bbf\u95ee\u5b89\u88c5\u4e86Istio\u7684<code>Kubernetes</code>\u96c6\u7fa4\u4e2d\u7684\u8fd9\u4e2a<code>ConfigMap</code>\u3002</p> <p>\u5982\u679c\u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u65e0\u6cd5\u8bbf\u95ee\uff0c\u5219\u8fd8\u53ef\u4ee5\u5728<code>istioctl</code>\u4e2d\u4f7f\u7528\u4e00\u4e2a\u672c\u5730\u7684\u914d\u7f6e\u6587\u4ef6\u3002 </p> <p>\u9996\u5148\u7528\u6709<code>ConfigMap</code>\u83b7\u53d6\u6743\u9650\u7684\u7528\u6237\u8eab\u4efd\u8fd0\u884c\u5982\u4e0b\u547d\u4ee4\uff1a </p> <pre><code>$ kubectl -n istio-system get configmap istio-sidecar-injector -o=jsonpath='{.data.config}' &gt; inject-config.yaml\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u5bf9\u8be5\u6587\u4ef6\u8fdb\u884c\u4efb\u610f\u4fee\u6539\uff0c\u5c31\u53ef\u4ee5\u5728<code>istioctl</code>\u4e2d\u4f7f\u7528\u4e86\uff1a</p> <pre><code>$ istioctl kube-inject --injectConfigFile inject-config.yaml\n</code></pre>"},{"location":"chap5/5Istio_funcs/#1-1","title":"1-1 \u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8981\u6c42","text":"<p>\u76ee\u524d\u652f\u6301\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7c7b\u578b\u5305\u62ec\uff1a<code>Job</code>\u3001 <code>DaemonSet</code>\u3001 <code>ReplicaSet</code>\u3001 <code>Pod</code>\u53ca<code>Deployment</code>. \u5bf9\u8fd9\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8981\u6c42\u5982\u4e0b\u3002 </p> <p>1.\u8981\u6b63\u786e\u547d\u540d\u670d\u52a1\u7aef\u53e3</p> <p><code>Service</code>\u5bf9\u8c61\u4e2d\u7684<code>Port</code>\u90e8\u5206\u5fc5\u987b\u4ee5\u201c\u534f\u8bae\u540d\u201d\u4e3a\u524d\u7f00\uff0c\u76ee\u524d\u652f\u6301\u7684\u534f\u8bae\u540d\u5305\u62ec <code>http</code>\u3001 <code>http2</code> \u3001<code>mongo</code>\u3001 <code>redis</code>\u548c<code>grpc</code>\uff0c\u4f8b\u5982\uff0c\u6211\u4eec\u7684<code>flaskapp</code>\u4e2d\u7684\u670d\u52a1\u7aef\u53e3\u5c31\u88ab\u547d\u540d  \u4e3a<code>\u201chttp\"</code>\u3002</p> <p><code>Istio</code>\u4f1a\u6839\u636e\u8fd9\u4e9b\u547d\u540d\u6765\u786e\u5b9a\u4e3a\u8fd9\u4e9b\u7aef\u53e3\u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u670d\u52a1\uff0c\u4e0d\u7b26\u5408\u547d\u540d\u89c4\u8303\u7684\u7aef\u53e3\u4f1a\u88ab\u5f53\u4f5c<code>TCP</code>\u670d\u52a1\uff0c\u5176\u529f\u80fd\u652f\u6301\u8303\u56f4\u4f1a\u5927\u5e45\u7f29\u5c0f\u3002</p> <p>\u76ee\u524d\u7684<code>Istio</code>\u7248\u672c\u5bf9<code>HTTP</code>, <code>HTTP2</code>\u53ca<code>gRPC</code>\u534f\u8bae\u90fd\u63d0\u4f9b\u4e86\u6700\u5927\u8303\u56f4\u7684\u652f\u6301\u3002 </p> <p>2.\u5de5\u4f5c\u8d1f\u8f7d\u7684Pod\u5fc5\u987b\u6709\u5173\u8054\u7684<code>Service</code></p> <p>\u4e3a\u4e86\u6ee1\u8db3\u670d\u52a1\u53d1\u73b0\u7684\u9700\u8981\uff0c\u6240\u6709<code>Pod</code>\u90fd\u5fc5\u987b\u6709\u5173\u8054\u7684\u670d\u52a1\uff0c\u56e0\u6b64\u6211\u4eec\u7684\u5ba2\u6237\u7aef\u5e94\u7528<code>sleep</code>\u867d\u7136\u6ca1\u6709\u5f00\u653e\u4efb\u4f55\u7aef\u53e3\uff0c\u4f46\u8fd8\u662f\u8981\u6ce8\u518c\u4e00\u4e2a<code>Service</code>\u5bf9\u8c61\u3002 </p> <p>\u53e6\u5916\uff0c\u5b98\u65b9\u5efa\u8bae\u4e3a<code>Pod</code>\u6a21\u677f\u52a0\u5165\u4e24\u4e2a\u6807\u7b7e\uff1a<code>app</code>\u548c<code>version</code>\uff0c\u5206\u522b\u6807\u6ce8\u5e94\u7528\u540d\u79f0\u548c\u7248\u672c\u3002\u8fd9\u4ec5\u4ec5\u662f\u4e2a\u5efa\u8bae\uff0c\u4f46\u662f<code>Istio</code>\u7684\u5f88\u591a\u9ed8\u8ba4\u7b56\u7565\u90fd\u4f1a\u5f15\u7528\u8fd9\u4e24\u4e2a\u6807\u7b7e\uff1b\u5982\u679c\u6ca1\u6709\u8fd9\u4e24\u4e2a\u6807\u7b7e\uff0c\u5c31\u4f1a\u5f15\u53d1\u5f88\u591a\u4e0d\u5fc5\u8981\u7684\u9ebb\u70e6\u3002 </p>"},{"location":"chap5/5Istio_funcs/#1-2","title":"1-2 \u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8981\u6c42\u4f7f\u7528\u81ea\u52a8\u6ce8\u5165","text":"<p>\u9664\u4e86\u4f7f\u7528<code>istioctl</code>\u8fdb\u884c\u624b\u5de5\u6ce8\u5165\uff0c<code>Istio</code> \u8fd8\u63d0\u4f9b\u4e86\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff0c\u8be5\u529f\u80fd\u63d0\u4f9b\u4e86\u8f83\u4e3a\u4e30\u5bcc\u7684\u5fae\u8c03\u9009\u9879\uff0c\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u66f4\u7075\u6d3b\u5730\u9009\u62e9\u6ce8\u4eba\u76ee\u6807\u3002</p> <p>\u5728<code>values.yaml</code>\u4e2d\u9ed8\u8ba4\u5305\u542b\u5982\u4e0b\u6240\u793a\u7684\u7c7b\u4f3c\u4ee3\u7801\uff0c\u53ef\u4ee5\u7528\u4e8e\u8c03\u6574\u81ea\u52a8\u6ce8\u4eba\u7684\u5c5e\u6027\uff1a </p> <pre><code>autoInject: enabled \nsidecarInjectorWebhook: \n    enabled: true \n    replicaCount: 1 \n    image: sidecar_injector \n    enableNamespacesByDefault: false \n</code></pre> <p>\u4e0b\u9762\u5bf9\u4ee5\u4e0a\u8fd9\u6bb5\u4ee3\u7801\u8fdb\u884c\u8bb2\u89e3\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 </p> <ul> <li>\u5982\u679c\u5c06<code>sidecarInjectorWebhook.enabled</code>\u8bbe\u7f6e\u4e3a<code>true</code>\uff0c\u5c31\u4f1a\u5f00\u542f<code>Sidecar</code>\u7684\u81ea\u52a8\u6ce8\u5165\u7279\u6027\u3002 </li> <li>\u5982\u679c\u5c06<code>enableNamespacesByDefault</code>\u53d8\u91cf\u8d4b\u503c\u4e3a<code>true</code>\uff0c\u5c31\u4f1a\u4e3a\u6240\u6709\u547d\u540d\u7a7a\u95f4\u5f00\u542f\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff1b\u5982\u679c\u8d4b\u503c\u4e3a<code>false</code>\uff0c\u5219\u53ea\u6709\u6807\u7b7e\u4e3a<code>istio-injection: enabled</code> \u7684\u547d\u540d\u7a7a\u95f4\u624d\u4f1a\u5f00\u542f\u81ea\u52a8\u6ce8\u5165\u529f\u80fd\u3002 </li> <li><code>autoInject</code>\u8fd9\u4e2a\u53d8\u91cf\u547d\u540d\u6709\u6b67\u4e49\uff0c\u5b83\u7684<code>enabled/disabled</code>\u8d4b\u503c\uff0c\u8bbe\u7f6e\u7684\u5e76\u4e0d\u662f\u662f\u5426\u5f00\u542f\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff0c\u800c\u662f\u5728\u542f\u7528\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\u4e4b\u540e\uff0c\u5bf9\u4e8e\u6307\u5b9a\u7684\u547d\u540d\u7a7a\u95f4\u5185\u65b0\u5efa\u7684<code>Pod</code>\u662f\u5426\u8fdb\u884c\u81ea\u52a8\u6ce8\u5165\u3002</li> <li>\u5982\u679c\u53d6\u503c\u4e3a<code>enabled</code>\uff0c\u5219\u8be5\u547d\u540d\u7a7a\u95f4\u5185\u7684<code>Pod</code>\u53ea\u8981\u6ca1\u6709\u88ab\u6ce8\u89e3\u4e3a<code>sidecar.istio.io/inject: \"false\"</code>\uff0c\u5c31\u4f1a\u81ea\u52a8\u5b8c\u6210\u6ce8\u4eba\uff1b </li> <li>\u5982\u679c\u53d6\u503c\u4e3a<code>disabled</code>\uff0c\u5219\u9700\u8981\u4e3a<code>Pod</code>\u8bbe\u7f6e\u6ce8\u89e3<code>sidecar.istio.io/inject: \"true\"</code>, \u624d\u4f1a\u8fdb\u884c\u6ce8\u5165\u3002 </li> </ul> <p><code>autoInject</code>\u3001\u547d\u540d\u7a7a\u95f4\u6807\u7b7e\u53ca<code>Pod</code>\u6ce8\u89e3\u76f8\u4e92\u5173\u8054\uff0c\u5f62\u6210\u4e86\u975e\u5e38\u7075\u6d3b\u7684\u6ce8\u5165\u89c4\u5219\u3002\u5982\u56fe\u6240\u793a\u4e3a\u5404\u79cd\u7ec4\u5408\u4ea7\u751f\u7684\u6548\u679c\u5217\u8868\uff08\u547d\u540d\u7a7a\u95f4\u7b26\u5408\u6761\u4ef6\u6307\u7684\u662f\u547d\u540d\u7a7a\u95f4\u88ab\u8bbe\u7f6e\u4e86\u6ce8\u5165\u6807\u7b7e\uff0c\u6216\u8005<code>enableNamespacesByDefault: true</code>)</p> <p></p> <p>\u63a5\u4e0b\u6765\u6d4b\u8bd5\u8fd9\u4e2a\u529f\u80fd\u3002\u9ed8\u8ba4\u5b89\u88c5\u7684<code>Istio</code>(\u4e5f\u5c31\u662f\u4f7f\u7528<code>\"-f istio/valus.yaml</code>\u9009\u9879\u751f\u6210\u7684\u5b89\u88c5\u6e05\u5355\uff09\u542f\u7528\u4e86\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd, \u53ea\u8981\u4e3a\u547d\u540d\u7a7a\u95f4\u8bbe\u7f6e\u6ce8\u4eba\u6807\u7b7e, \u5e76\u4e14\u5c06<code>autoInject</code>\u8bbe\u7f6e\u4e3a<code>enabled</code>\u3002\u6839\u636e\u5728\u8be5\u547d\u540d\u7a7a\u5bc2\u4e2d\u521b\u5efa\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5c31\u4f1a\u88ab\u81ea\u52a8\u6ce8\u4eba<code>Sidecar</code>\u4e86 </p> <pre><code>$ kubectl create ns auto\nnamespace/auto created\n\n$ kubectl label namespaces auto istio-injection=enabled \u2764\ufe0f\u2764\ufe0f\u2764\ufe0f\nnamespace/auto labeled\n\n$ kubectl create ns manually\nnamespace/manually created\n</code></pre> <p>\u8fd9\u6837\u5c31\u521b\u5efa\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u5176\u4e2d\u7684<code>auto</code>\u547d\u540d\u7a7a\u95f4\u88ab\u8bbe\u7f6e\u4e86<code>istio-injction=enabled</code>\u6807\u7b7e</p> <p>\u63a5\u4e0b\u6765\u5206\u522b\u5728\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u4f7f\u7528<code>sleep.yaml</code>\u521b\u5efa\u5de5\u4f5c\u8d1f\u8f7d\u770b\u770b\u4ea7\u751f\u7684<code>Pod</code></p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: sleep\n  labels:\n    app: sleep\n    version: v1\nspec:\n  selector:\n    app: sleep\n    version: v1\n  ports:\n    - name: ssh\n      port: 80\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: sleep\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: sleep\n        version: v1\n    spec:\n      containers:\n      - name: sleep\n        image: dustise/sleep\n        imagePullPolicy: Always\n---\n</code></pre> <pre><code>$ kubectl create -f sleep.yaml -n auto\nservice/sleep created\ndeployment.extensions/sleep created\n</code></pre> <pre><code>$ kubectl get pod -n auto\nNAME                     READY   STATUS    RESTARTS   AGE\nsleep-6c9c898f6c-b7scw   2/2     Running   0          28s\n</code></pre> <pre><code>$ kubectl create -f sleep.yaml -n manually\nservice/sleep created\ndeployment.extensions/sleep created\n</code></pre> <ul> <li>\u901a\u8fc7\u5bf9\u6bd4\u53ef\u4ee5\u770b\u51fa, <code>auto</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fc7\u7a0b\uff1b<code>Pod</code>\u88ab\u6ce8\u4eba\u4e86<code>Sidecar</code>\u5e76\u5f00\u59cb\u4e86\u521d\u59cb\u8fc7\u7a0b;</li> <li>\u800c<code>manually</code>\u547d\u540d\u7a7a\u95f4\u7684<code>Pod</code>\u4fdd\u6301\u539f\u6837 \uff0c\u6ca1\u6709\u8fdb\u884c\u6ce8\u5165</li> </ul> <p>\u4e0d\u7ba1\u662f\u624b\u5de5\u6ce8\u4eba\u8fd8\u662f\u81ea\u52a8\u6ce8\u4eba\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u7f16\u8f91<code>Istio system</code>\u547d\u540d\u7a7a\u95f4\u4e2d <code>ConfigMap istio-sidecar-injector</code>\uff0c\u6765\u5f71\u54cd\u6ce8\u4eba\u7684\u6548\u679c</p> <p>\u4f8b\u5982\u5728<code>1.1.0</code>\u7248\u672c\u4e2d<code>Istio</code> \u81ea\u52a8\u6ce8\u4eba\u53ef\u4ee5\u62a5\u636e\u6807\u7b7e\u4f8b\u5916\u8bbe\u7f6e.</p> <p>\u4e0d\u7ba1\u547d\u540d\u7a7a\u95f4\u6807\u7b7e\u53ca\u7b56\u7565\u5982\u4f55, \u5bf9\u7b26\u5408\u6807\u7b7e\u9009\u62e9\u5668\u8981\u6c42\u7684<code>Pod</code>\u90fd\u4e0d\u8fdb\u884c\u6ce8\u5165</p> <p>\u53ef\u4ee5\u5728<code>istio-sidecar-injector Configmap</code>\u4e2d\u52a0\u5165\u8fd9\u4e00\u4f8b\u5916\u8bbe\u7f72</p> <p><code>istio/templates/sidecar-injector-configmap.yaml</code></p> <pre><code>$ kubectl -n istio-system describe configmap istio-sidecar-injector\n\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: istio-sidecar-injector\ndata:\n  config: |-\n    policy: enabled\n    neverInjectSelector:\n      - matchExpressions:\n        - {key: openshift.io/build.name, operator: Exists}\n      - matchExpressions:\n        - {key: openshift.io/deployer-pod-for.name, operator: Exists}\n    template: |-\n      initContainers:\n...\n</code></pre> <p>\u5982\u4e0a\u6240\u793a\u7684<code>neverInjectSelector</code>\u5b57\u6bb5\u662f\u4e00\u4e2a<code>Kubernetes</code>\u6807\u7b7e\u9009\u62e9\u5668\u7684\u6570\u7ec4\u3002</p> <p>\u4e0d\u540c\u5143\u7d20\u4e4b\u95f4\u662f<code>\u201c\u6216\u201d</code>\u7684\u5173\u7cfb\uff0c\u5728\u7b2c\u4e00\u6b21\u53d1\u73b0\u6709\u7b26\u5408\u6761\u4ef6\u7684\u6807\u7b7e\u4e4b\u540e\u4f1a\u8df3\u8fc7\u5176\u4ed6\u5224\u65ad\u3002 </p> <p>\u4e0a\u9762\u7684\u8bed\u53e5\u610f\u5473\u7740\uff1a\u5bf9\u4e8e\u5305\u542b<code>openshift.io/build.name</code>\u6216\u8005<code>openshift.io/deployer-pod-for.name</code>\u6807\u7b7e\u7684<code>Pod</code>\uff0c\u4e0d\u7ba1\u6807\u7b7e\u53d6\u503c\u662f\u4ec0\u4e48\uff0c\u90fd\u4e0d\u4f1a\u8fdb\u884c\u6ce8\u5165\u3002 </p> <p>\u4e0e\u4e4b\u76f8\u5bf9\u7684\u8fd8\u6709\u4e00\u4e2a<code>alwaysInjectSelector</code>\u6807\u7b7e\uff0c\u7b26\u5408\u8fd9\u4e00\u9009\u62e9\u5668\u7684<code>Pod</code>\uff0c\u4e0d\u7ba1\u5168\u5c40\u7b56\u7565\u5982\u4f55\uff0c\u90fd\u4f1a\u88ab\u6ce8\u4eba<code>Sidecar</code>. </p> <p>\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c<code>Pod</code>\u6ce8\u89e3\u8fd8\u6709\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7\uff0c\u4e00\u5982\u679c<code>Pod</code>\u6ce8\u89e3\u5305\u542b <code>sidecar.istio.io/inject: \"true/false\"</code>\uff0c\u5219\u4f1a\u88ab\u4f18\u5148\u5904\u7406\u3002 </p> <p>\u6240\u4ee5\uff0c\u81ea\u52a8\u6ce8\u4eba\u7684\u8bc4\u4f30\u987a\u5e8f\u662f\uff1a</p> <p><code>Pod\u6ce8\u89e3 -&gt; NeverInjectSelector \u4e00&gt; Always InjsectSelector \u4e00&gt; \u547d\u540d\u7a7a\u95f4\u7b56\u7565</code></p> <p>\u5982\u679c\u6309\u7167\u524d\u9762\u7684\u4ecb\u7ecd\u8fdb\u884c\u64cd\u4f5c\uff0c\u4f8b\u5982\u7ed9\u547d\u540d\u7a7a\u95f4\u6253\u6807\u7b7e\uff0c\u5219\u7ed3\u679c\u662fPod\u6ca1\u6709\u88ab\u6ce8\u4eba\u3002\u6216\u8005\u521a\u597d\u76f8\u53cd\uff0c<code>Pod</code>\u660e\u660e\u88ab\u6ce8\u89e3\u4e3a<code>sidecar.istio.io/inject: \"false\"</code>\uff0c\u8fd8\u662f\u88ab\u6ce8\u4eba\u4e86\u3002\u8fd9\u662f\u4e3a\u4ec0\u4e48\uff1f </p> <p>\u53ef\u4ee5\u770b\u770b<code>sidecar-injector Pod</code>\u7684\u65e5\u5fd7\uff1a </p> <pre><code>$ pod=$(kubectl -n istio-system get pods -l istio=sidecar-injector -o jsonpath='{.items[0].metadata.name}')\n\n$ echo $pod\nistio-sidecar-injector-6b57b9cbd-dd4qt\n\n$ kubectl logs $pod -n istio-system\n\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u521b\u5efa\u4e1a\u52a1Pod\u770b\u770b\u65e5\u5fd7\u8f93\u51fa\u7684\u5176\u4f53\u5185\u5bb9, \u8981\u770b\u5230\u66f4\u8be6\u7ec6\u7684\u65e5\u5fd7\uff08\u7ecf\u5e38\u4f1a\u5f88\u6709\u7528\uff09\u5219\u53ef\u4ee5\u7f16\u8f91<code>sidecar-iniector Deployment</code> \u5bf9\u8c61, \u7ed9\u5b83\u52a0\u4e0a\u53c2\u6570 <code>\"--log_output_level=default:debug\"</code>;</p> <pre><code>$ kubectl -n  istio-system edit deployment istio-sidecar-injector\n...\ncontainers:\n      - args:\n        - --caCertFile=/etc/istio/certs/root-cert.pem\n        - --tlsCertFile=/etc/istio/certs/cert-chain.pem\n        - --tlsKeyFile=/etc/istio/certs/key.pem\n        - --injectConfig=/etc/istio/inject/config\n        - --meshConfig=/etc/istio/config/mesh\n        - --healthCheckInterval=2s\n        - --healthCheckFile=/health\n        - --log_output_level=default:debug\n...\n</code></pre> <p>\u7f16\u8f91\u6210\u529f\u540e<code>pod</code>\u4f1a\u91cd\u542f</p> <pre><code>$  pod=$(kubectl -n istio-system get pods -l istio=sidec\nar-injector -o jsonpath='{.items[0].metadata.name}')\n\n$ echo $pod\nistio-sidecar-injector-77dfb5c66b-lzb8p\n\n$ kubectl logs $pod -n istio-system\n\n...\n:{\\\"matchLabels\\\":{\\\"istio-injection\\\":\\\"enabled\\\"}},\\\n...\n</code></pre> <p>\u5982\u679c\u5728\u65e5\u5fd7\u4e2d\u8fd8\u662f\u627e\u4e0d\u5230\u53d1\u751f\u95ee\u9898\u7684\u539f\u56e0\uff0c\u5c31\u4ee3\u8868<code>side-injector</code>\u6ca1\u6709\u6536\u5230Pod\u521b\u5efa\u7684\u901a\u77e5\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u89e6\u53d1\u81ea\u52a8\u6ce8\u5165\u7684\u64cd\u4f5c\u4e86</p> <p>\u8fd9\u53ef\u80fd\u662f\u56e0\u4e3a\u547d\u540d\u7a7a\u95f4\u6ca1\u6709\u6b63\u786e\u8bbe\u7f6e\u6807\u7b7e\u5bfc\u81f4\u7684\uff0c\u56e0\u6b64\u9700\u8981\u68c0\u67e5\u547d\u540d\u7a7a\u95f4\u7684\u6807\u7b7e\u53ca<code>MutatingWebhookConfiguration</code>\u7684\u914d\u7f6e</p> <p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u547d\u540d\u7a7a\u95f4\u5e94\u8be5\u8bbe\u7f6e<code>istio-injection=enabled</code>\uff0c\u53ef\u4ee5\u4f7f\u7528</p> <pre><code>$ kubectl -n istio-system edit MutatinWebhookConfiguration isitio-sidecar-injector\n</code></pre> <p>\u547d\u4ee4\u68c0\u67e5<code>namespaceSelecor</code>\u5b57\u6bb5\u7684\u5185\u5bb9</p> <p>\u5728\u5b8c\u6210\u6392\u67e5\u4e4b\u540e\uff0c \u53ef\u4ee5\u518d\u6b21\u7f16\u8f91<code>Sidecar-injector Deployment</code>\u5bf9\u8c61\uff0c\u6e05\u9664\u65b0\u52a0\u4eba\u7684\u53c2\u6570.</p>"},{"location":"chap5/5Istio_funcs/#1-3","title":"1-3 \u51c6\u5907\u6d4b\u8bd5\u5e94\u7528","text":"<p>\u628a <code>default namespace</code> \u8bbe\u7f6e\u4e3a\u81ea\u52a8\u6ce8\u5165, \u5e76\u5728\u5176\u4e2d\u8fd0\u884c<code>flaskapp</code>\u4ee5\u53ca<code>sleep</code>\u4e24\u4e2a\u7248\u672c</p> <pre><code>$ kubectl label namespace default istio-injection=enabled\nnamespace/default labeled\n</code></pre> <p><code>sleep.istio.yaml</code></p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: sleep\n  labels:\n    app: sleep\nspec:\n  selector:\n    app: sleep\n  ports:\n    - name: ssh\n      port: 80\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: sleep-v1\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: sleep\n        version: v1\n    spec:\n      containers:\n      - name: sleep\n        image: dustise/sleep\n        imagePullPolicy: Always\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: sleep-v2\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: sleep\n        version: v2\n    spec:\n      containers:\n      - name: sleep\n        image: dustise/sleep\n        imagePullPolicy: Always\n</code></pre> <pre><code>$ kubectl apply -f sleep.istio.yaml \nservice/sleep created\ndeployment.extensions/sleep-v1 created\ndeployment.extensions/sleep-v2 created\n\n$ kubectl get pods | grep sleep\nsleep-v1-548d87cc5c-fg9ng      2/2     Running   0          21s\nsleep-v2-7c6b874968-qfkvt      2/2     Running   0          21s\n</code></pre>"},{"location":"chap5/5Istio_funcs/#2istio","title":"2\u3001\u4fee\u6539<code>Istio</code>\u914d\u7f6e","text":"<p>Istio\u7ecf\u5e38\u6709\u53d8\u66f4\u914d\u7f6e\u7684\u9700\u6c42\uff0c \u8fd9\u65f6\u53ef\u4ee5\u7528\u201dHelm\u201c \u7684 <code>--set</code>\u7684\u53c2\u6570\u6765\u5b8c\u6210\u8fd9\u4e00\u4efb\u52a1</p> <p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\u4f1a\u5c06\u53d8\u91cf <code>sidecarInjectorWebhook.enabled</code>\u8d4b\u503c\u4e3a<code>true</code>\u4e5f\u5c31\u662f\u542f\u7528\u81ea\u52a8\u6ce8\u5165\u529f\u80fd</p> <p>\u5982\u679c\u60f3\u5173\u95ed\uff0c\u5219\u5728\u4e4b\u524d\u4f7f\u7528<code>Helm</code>\u5b89\u88c5<code>Istio</code>\u7684\u547d\u4ee4\u4e2d\u52a0\u5165<code>sidecarInjectorWebhook.enabled=false</code>\u7684\u53c2\u6570\u5373\u53ef\u3002\u4f8b\u5982</p> <pre><code>$ helm template istio \\ \n--name istio --namespace istio-system \\ \n--set sidecarInjectorWebhook.enabled=false \n</code></pre> <p>\u4ee5\u4e0a\u662f\u5bf9\u5b98\u65b9\u8bf4\u6cd5\u7684\u4e00\u4e2a\u6025\u7ed3\u4f46\u662f\u4e8b\u5b9e\u4e0a\u5e76\u6ca1\u6709\u8fd9\u4e48\u7b80\u5355,</p> <p><code>Istio</code>\u7684<code>Sidecar</code>\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\u662f\u901a\u8fc7<code>Kubernetes</code>\u7684<code>mutating</code>\u63a7\u5236\u5668\u6765\u5b8c\u6210\u7684, \u5982\u679c\u542f\u7528\u4e86\u81ea\u52a8\u751f\u6548\u7684<code>Istio</code> \u5b89\u88c5\u6e05\u5355\u5c31\u4f1a\u751f\u6210\u4e00\u4e2a\u540d\u79f0\u4e3a<code>Istio-sidecar-injector</code>\u7684 <code>mutatingwebhookconfigurations</code>\u7684\u5bf9\u8c61\uff0c \u5728\u8fd9\u4e2a\u5bf9\u8c61\u4e2d\u4fdd\u5b58\u7684\u5c31\u662f\u81ea\u52a8\u6ce8\u4eba\u7684\u914d\u7f6e </p> <p>\u62a5\u636e<code>Helm</code>\u548c<code>Kubernetes</code>\u7684\u4e0b\u4f5c\u539f\u7406\u91cd\u590d\u6267\u884c<code>kubecet apply</code>\u547d\u4ee4\u662f\u4e0d\u4f1a\u8fdb\u884c\u5220\u9664\u64cd\u4f5c\u7684, \u56e0\u6b64\u901a\u8fc7\u4e0a\u9762\u7684\u64cd\u4f5c\u751f\u6210\u7684\u6e05\u5355\u4e00\u65e6\u88ab\u63d0\u4ea4\uff0c \u540e\u679c\u5c31\u662f<code>mutating</code>\u63a7\u5236\u5668\u7ee7\u7eed\u4f7f\u7528<code>istio-sidecar-injector</code>\u7684\u914d\u7f6e\u8fdb\u884c\u4e0b\u4f5c </p> <p>\u56e0\u6b64\u8fd9\u79cd\u65b9\u5f0f\u53ea\u9488\u5bf9\u65b0\u589e\u6216\u4fee\u6539\u64cd\u4f5c\u751f\u6548,\u5bf9\u4e8e\u5220\u9664\u64cd\u4f5c\u662f\u65e0\u6548\u7684</p>"},{"location":"chap5/6Istio_func2_grafana_prometheus/","title":"\u7b2c\u516d\u8282 \u4f7f\u7528 Istio Dashboard Grafana / Prometheus","text":""},{"location":"chap5/6Istio_func2_grafana_prometheus/#1istio-dashboard","title":"1\u3001\u4f7f\u7528<code>Istio Dashboard</code>","text":"<p><code>Istio</code>\u4e3a\u670d\u52a1\u7f51\u683c\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u89c2\u5bdf\u80fd\u529b</p> <p><code>Istio Dashboard</code>\u662f\u4e00\u4e2a\u5305\u542b<code>Istio</code>\u5b9a\u5236\u6a21\u677f\u7684<code>Grafana(https://grafanacom/)\u3002</code> </p> <p><code>Grafana</code>\u662f\u4e00\u4e2a\u901a\u7528\u7684<code>Dashboard</code>\u6e90\u8f6f\u4ef6\uff0c\u652f\u6301<code>Elasticsearch</code>,<code>Zabbix</code>\u3001 <code>Prometheus</code>, <code>InfluxDB</code>\u7b49\u591a\u79cd\u6570\u636e\u6e90\uff0c\u5e76\u63d0\u4f9b\u4e86\u6761\u5f62\u56fe\u3001\u997c\u56fe\u3001\u8868\u683c\u3001\u6298\u7ebf\u56fe\u7b49\u4e30\u5bcc\u7684\u53ef\u89c6\u5316\u7ec4\u4ef6\uff0c\u5bf9\u5176\u4e2d\u7684\u6570\u636e\u6e90\u548c\u53ef\u89c6\u5316\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\uff0c\u7528\u6237\u53ef\u4ee5\u5c06\u6570\u636e\u6e90\u548c\u53ef\u89c6\u5316\u7ec4\u4ef6\u7ed3\u5408\u8d77\u6765\u5b9a\u5236\u81ea\u5df1\u7684<code>Dashboard</code> </p>"},{"location":"chap5/6Istio_func2_grafana_prometheus/#1-1-grafana","title":"1-1 \u542f\u7528<code>Grafana</code>","text":"<p><code>Istio</code>\u5728\u9ed8\u8ba4\u6e05\u51b5\u4e0b\u662f\u6ca1\u6709\u542f\u7528<code>Grafana</code>\u7684\uff0c</p> <pre><code>$ helm template istio \\\n --name istio --set grafana.enabled=true \\ \n --namespace istio-system &gt; default-grafana.yaml \n\n$ kubectl apply -f default-grafana.yaml \n...\nconfigmap/istio-grafana-custom-resources created \nconfigmap/istio-grafana-configuration-dashboards \ncreated configmap/istio-grafana created \nconfigmap/istio-statsd-prom-bridge unchanged\n...\n</code></pre>"},{"location":"chap5/6Istio_func2_grafana_prometheus/#1-2-grafana","title":"1-2 \u8bbf\u95eeGrafana","text":"<p>\u5728\u521b\u5efa\u6210\u529f\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528<code>kubectl port-forward</code>\u6307\u4ee4\u5bf9<code>Grafana pod</code>\u8fdb\u884c\u7aef\u53e3\u8f6c\u53d1\uff0c \u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u4e0d\u5bf9\u5916\u7f51\u5f00\u653e\u670d\u52a1\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528<code>Grafana</code></p> <pre><code>$ kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}'\n\n$ kubectl -n istio-system port-forward grafana-86f89dbd84-v7rrn 3000:3000\nForwarding from 127.0.0.1:3000 -&gt; 3000\nForwarding from [::1]:3000 -&gt; 3000 \n</code></pre> <p>\u63a5\u4e0b\u6765\u53ef\u4ee5\u4f7f\u7528\u6d4f\u89c8\u5668\u6253\u5f00<code>http://localhost:3000/</code>\uff0c\u5355\u51fb\u5de6\u4e0a\u89d2\u7684<code>Home</code>\u94fe\u63a5\uff0c\u5728\u51fa\u73b0\u7684\u9875\u9762\u4e2d\u5355\u51fb<code>Istio</code>\u6587\u4ef6\u5939\uff0c\u4f1a\u5217\u51fa<code>Istio</code>\u7684\u5185\u7f6e<code>Dashboard</code>\uff0c</p> <p></p> <p>\u5355\u51fb<code>Istio Mesh Dashboard</code></p> <p></p> <p>\u56e0\u4e3a\u6ca1\u6709\u4ea7\u751f\u4efb\u4f55\u6d41\u91cf\uff0c\u6240\u4ee5\u8fd9\u91cc\u6240\u6709\u7684\u6570\u636e\u90fd\u662f\u7a7a\u7684\uff0c\u6211\u4eec\u8fdb\u5165 <code>sleep</code> pod \u53bb\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf</p> <pre><code>$ kubectl get pod -l app=sleep,version=v1 -o custom-columns='\nName:metadata.name'\nName\nsleep-v1-548d87cc5c-fg9ng\n</code></pre> <pre><code>$ kubectl exec -it -c sleep sleep-v1-548d87cc5c-fg9ng bash\n</code></pre> <pre><code>bash-4.4# for i in 'seq 100';do http --body http://flaskapp/fetch?url=http://flaskapp/env/version &gt;&gt; /dev/null;done\n</code></pre> <p></p>"},{"location":"chap5/6Istio_func2_grafana_prometheus/#1-3-grafana","title":"1-3 \u5f00\u653e<code>Grafana</code>\u670d\u52a1","text":"<p><code>kubectl</code>\u7684\u7aef\u53e3\u8f6c\u53d1\u65b9\u5f0f\u662f\u5f88\u4e0d\u7a33\u5b9a\u7684\u957f\u671f\u4f7f\u7528\u7684\u8bdd\uff0c\u53ef\u4ee5\u8003\u8651\u5bf9<code>Grafana</code>\u670d  \u52a1\u8fdb\u884c\u5b9a\u5236\uff0c\u4f8b\u5982\u5728<code>values.yaml</code>\u4e2d\u7684<code>grafana</code>\u4e00\u8282\u6709\u5982\u4e0b\u5b9a\u4e49 </p> <pre><code>Grafana: \n    enabled: false \n    replicaCount: 1 \n    image: \n        repository: grafana/grafana \n        tag: 5.2.3 \n    persist: false \n    storageClassName: \"\"\n    security: \n        enabled: false \n        adminUser: admin \n        adminpassword: admin \n    service: \n        annotations: {} \n        name: http \n        type: ClusterIP \n        externalport: 3000 \n        internalPort: 3000 \n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5c06\u670d\u52a1\u7c7b\u578b\u4fee\u6539\u4e3a<code>LoadBalancer</code>,\u6216\u8005\u4e3a\u5176\u521b\u5efa<code>Ingress</code>\u5bf9\u8c61\uff0c\u5e76\u8bbe\u7f6e\u7528\u6237\u540d\u548c\u5bc6\u7801</p>"},{"location":"chap5/6Istio_func2_grafana_prometheus/#1-4","title":"1-4 \u5b66\u4e60\u548c\u5b9a\u5236","text":"<p><code>Istio</code>\u63d0\u4f9b\u4e3a\u6570\u4f17\u591a\u7684<code>Darsboord</code>\u6a21\u677f\u6570\u636e\u6765\u81ea<code>Prometheus</code>\u670d\u52a1\u3002\u4e86\u89e3\u8fd9\u4e9b<code>Dashboard</code> \u7684\u6e90\u7801\u65f6\u53ef\u4ee5\u53d1\u73b0\u5f88\u591a\u6709\u7528\u7684\u67e5\u8be2\u8bed\u53e5, \u65b9\u4fbf\u65e5\u540e\u5efa\u7acb\u81ea\u5df1\u7684\u76d1\u63a7\u4f53\u7cfb, \u4f8b\u5982\u6211\u4eec\u53ef\u80fd\u66f4\u52a0\u5173\u6ce8\u7684<code>Istio Server Dashboard</code>\u5c31\u5305\u542b\u4e86\u4e1a\u52a1\u5e94\u7528\u7684\u76f8\u5173\u4fe1\u606f  </p> <p></p> <p>\u5982\u679c\u6211\u4eec\u5173\u5fc3<code>Incoming Requests by Source And Reponse Code</code>\u8fd9\u4e2a\u6298\u7ebf\u56fe\u7684\u7a7a\u73b0\u5c31\u53ef\u4ee5\u5355\u51fb\u8fd9\u4e2a\u533a\u57df\u6807\u9898\u53f3\u4fa7\u7684\u4e09\u89d2\u7b26\u53f7\uff0c \u5728\u5f39\u51fa\u7684\u83dc\u5355\u4e2d\u9009\u62e9<code>Edit</code>,\u4f1a\u663e\u793a\u4e00\u7ec4\u4ef6\u7684\u5b9a\u5236\u5185\u5bb9\u3002</p> <p></p> <p>\u663e\u793a\u7684\u5185\u5bb9\u8868\u660e\u6570\u636e\u6765\u81ea\u540d\u4e3a<code>Prometheus</code>\u7684\u6570\u636e\u6e90, \u4e24\u4e2a\u6307\u6807\u5217\u7684\u516c\u5f0f\u4e4b\u4e5f\u90fd\u6e05\u695a\u5730\u5c55\u793a\u51fa\u6765\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u8fbe\u4e9b\u5185\u5bb9\uff0c \u5b66\u4e60\u5404\u79cd<code>Istio</code>\u76d1\u63a7\u6307\u6807\u7684\u7528\u6cd5,\u516c\u5f0f\u548c\u5c55\u793a\u65b9\u6cd5\u4ee5\u4f7f\u5b9a\u5236\u81ea\u5df1\u7684<code>Dashboad</code> </p> <p>\u5982\u679c\u5728\u4ecd\u7fa4\u5dfe\u5df2\u7ecf\u5b89\u88c5<code>Grafana</code>, \u5219\u8fd8\u53ef\u4ee5\u901a\u8fc7\u53f3\u4e0a\u89d2\u5de5\u5177\u680f\u7684\u7b2c\u4e8c\u4e2a\u6309\u94ae(Share Dashboad)\u83b7\u53d6<code>Dashboard</code> \u7684\u4ee3\u7801\u6e90\uff0c\u5c06\u5176\u5012\u5165\u5176\u4ed6<code>Grafana</code></p>"},{"location":"chap5/6Istio_func2_grafana_prometheus/#2prometheus","title":"2\u3001\u4f7f\u7528<code>Prometheus</code>","text":"<p><code>Prometheus</code> (<code>https//Pprometheus.io</code>\uff09\u662fCNCF\u4e2d\u7684\u4e00\u4e2a\u6807\u5fd7\u6027\u7684\u76d1\u63a7\u8f6f\u4ef6\u76ee\u524d\u5df2\u7ecf\u662f\u4e91\u539f\u751f\u9635\u8425\u4e2d\u76d1\u63a7\u7cfb\u7edf\u7684\u4e8b\u5b9e\u6807\u51c6\u3002\u5728<code>Istio</code>\u3002\u4e2d\u5df2\u7ecf\u96c6\u6210\u4e86<code>Prometheus</code>\u5c06\u5176\u7528\u4f5c\u7cfb\u7edf\u7684\u76d1\u63a7\u7ec4\u4ef6 </p> <p><code>Grafana</code>\u53ea\u662f\u4e00\u4e2a\u53ef\u89c6\u5316\u7684\u524d\u7aef\u5176\u6570\u636e\u90fd\u6765\u81ea\u6211\u4eec\u4e5f\u9700\u8981\u76f4\u63a5\u5230<code>Prometheus</code>\u4e2d\u8fdb\u884c\u4e00\u4e9b\u67e5\u8be2  <code>Prometheus</code>\u6765\u83b7\u53d6\u4e00\u6b64\uff0c\u6765<code>Dashboard</code>\u4e2d\u6ca1\u6709\u4f53\u73b0\u7684\u4fe1\u606f\u3002 </p>"},{"location":"chap5/6Istio_func2_grafana_prometheus/#2-1-prometheus","title":"2-1 \u8bbf\u95ee<code>Prometheus</code>","text":"<p><code>Prometheus</code>\u670d\u52a1\u662f\u9ed8\u8ba4\u542f\u7528\u7684\u56e0\u6b64\u5728\u901a\u5e38\u6084\u51b5\u4e0b\u65e0\u987b\u989d\u5916\u64cd\u4f5c\u76f4\u63a5\u4f7f\u7528\u7aef\u53e3\u8f6c\u53d1\u5373\u53ef\u8bbf\u95ee\uff1a</p> <pre><code>$ kubectl -n istio-system get pod -l  app=prometheus -o custom-columns='Name:metadata.name'\nName\nprometheus-d44645598-xh8wn\n\n$ kubectl -n istio-system  port-forward prometheus-d44645598-xh8wn 9090:9090\n</code></pre> <p>\u7136\u540e\u7528\u6d4f\u89c8\u5668\u6253\u5f00<code>http://localhost:9O9O</code>\u4f1a\u5f97\u5230<code>prometheus</code>\u7684\u67e5\u8be2\u754c\u800c\u5728\u5176\u4e2d\u8f93\u4eba<code>isito_requests_total</code>\u5c31\u80fd\u6392\u5230\u4e00\u7cfb\u5217\u8bf7\u6c42\u7684\u603b\u6570\u6307\u6807\u503c</p> <p></p> <p>\u70b9\u51fb<code>Graph</code></p> <p></p>"},{"location":"chap5/6Istio_func2_grafana_prometheus/#2-2-prometheus","title":"2-2 \u5f00\u653ePrometheus\u670d\u52a1","text":"<p>\u548c<code>Grafana</code>\u4e00\u6837\uff0c<code>Prometheus</code>\u7684<code>Service</code>\u4e5f\u53ef\u4ee5\u901a\u8fc7<code>values.yaml</code>\u5b9a\u5236\u5bf9\u670d\u52a1\u5f00\u653e\u65b9\u5f0f\u3002 </p>"},{"location":"chap5/7Istio_fun3_Jager/","title":"\u7b2c\u4e03\u8282 \u4f7f\u7528 Istio Dashboard","text":"<p><code>Jaeger</code> (<code>https://github.com/jaegertracing/jaeger</code>\uff09\u662f\u4e00\u4e2a\u7528\u4e8e\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7684\u5f00\u6e90\u8f6f\u4ef6\u3002 </p> <p>\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u5f80\u5f80\u6bd4\u8f83\u590d\u6742\uff0c\u5728\u6df1\u5ea6\u548c\u5e7f\u5ea6\u65b9\u9762\u90fd\u4f1a\u6709\u8f83\u957f\u7684\u8c03\u7528\u8def\u7ebf\uff0c\u56e0\u6b64\u9700\u8981\u6709\u8de8\u670d\u52a1\u7684\u8ddf\u8e2a\u80fd\u529b\u3002</p> <p>\u5728<code>Istio</code>\u4e2d\u63d0\u4f9b\u4e86<code>Jaeger</code>\u4f5c\u4e3a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7ec4\u4ef6\u3002</p> <p><code>Jaeger</code>\u4e5f\u662fCNCF\u7684\u6210\u5458\uff0c\u662f\u4e00 \u4e2a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u5de5\u5177\uff0c\u63d0\u4f9b\u4e86\u539f\u751f\u7684<code>OpenTracing</code>\u652f\u6301\uff0c\u5411\u4e0b\u517c\u5bb9<code>ZipKin</code>\uff0c\u540c\u65f6\u652f\u6301\u591a\u79cd\u5b58\u50a8\u540e\u7aef\u3002 </p> <p>\u7b80\u5355\u8bf4\u660e\u5728<code>Istio</code>\u4e2d\u5982\u4f55\u67e5\u770b\u8c03\u7528\u94fe\u8def\uff0c\u4ee5\u53ca\u5982\u4f55\u8ba9\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u652f\u6301\u5206\u5e03 </p> <p>\u9700\u8981\u6ce8\u5ff5\u7684\u662f<code>IstioSidecar</code>\u4e3a\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u63d0\u4f9b\u8c03\u7528\u73af\u8282\u7684\u6570\u636e\uff0c\u8981\u652f\u6301\u6574\u6761\u94fe\u8def\uff0c \u8fd8\u9700\u8981\u6839\u636e<code>OpenTracing</code>\u89c4\u8303\u5bf9\u5e94\u7528\u8fdb\u884c\u6539\u5199</p>"},{"location":"chap5/7Istio_fun3_Jager/#1-jaeger","title":"1\u3001 \u542f\u7528<code>Jaeger</code>","text":"<p><code>Jager</code>\u9ed8\u8ba4\u5144\u4e0d\u542f\u7528\u7684 </p> <p>\u56e0\u6b64\u9700\u8981\u4f7f\u7528\u542f\u7528<code>Grafana</code>\u7684\u7c7b\u4f3c\u65b9\u5f0f\uff0c\u8bbe\u7f6e<code>tracing.enabled</code>\u4e3a<code>True</code></p> <pre><code>$ helm init\n$HELM_HOME has been configured at /Users/i515190/.helm.\n\nTiller (the Helm server-side component) has been installed into your Kubernetes Cluster.\n\nPlease note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy.\nTo prevent this, run `helm init` with the --tiller-tls-verify flag.\nFor more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation\n\n$ helm version\nClient: &amp;version.Version{SemVer:\"v2.14.2\", GitCommit:\"a8b13cc5ab6a7dbef0a58f5061bcc7c0c61598e7\", GitTreeState:\"clean\"}\nServer: &amp;version.Version{SemVer:\"v2.14.2\", GitCommit:\"a8b13cc5ab6a7dbef0a58f5061bcc7c0c61598e7\", GitTreeState:\"clean\"}\n</code></pre> <pre><code>$ cd Istio/istio-1.1.16/install/kubernetes/helm/istio\n\n$ helm template istio --name istio --set tracing.enabled=true --namespace istio-system &gt; default-tracing.yaml \n\n\n$ grep -C 2 \"enableTracing\" default-tracing.yaml \n    disablePolicyChecks: true\n\n    # Set enableTracing to false to disable request tracing.\n    enableTracing: true\n\n    # Set accessLogFile to empty string to disable access log.\n\n</code></pre> <pre><code>$ kubectl apply -f default-tracing.yaml \n\n$ kubectl get pod -n istio-system \n...\nistio-tracing-555cf644d-h9hr9              1/1     Running     1          3d21\n...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8be5\u670d\u52a1\u7684<code>Pod</code>\u5df2\u7ecf\u5f00\u59cb\u8fd0\u884c</p>"},{"location":"chap5/7Istio_fun3_Jager/#2-jaeger","title":"2\u3001 \u8bbf\u95ee<code>Jaeger</code>","text":"<p>\u540c\u6837\u53ef\u4ee5\u4f7f\u7528\u7aef\u53e3</p> <pre><code>kubectl -n istio-system get pod -l app=jaeger -o custom-columns='Name:metadata.name'\nName\nistio-tracing-555cf644d-h9hr9 \n</code></pre> <pre><code>$ kubectl -n istio-system port-forward istio-tracing-555cf644d-h9hr9  16686:16686\n</code></pre> <p>\u63a5\u4e0b\u6765\u65e2\u53ef\u4ee5\u8bbf\u95ee<code>http://127.0.0.1:16686</code>,\u6765\u67e5\u770b<code>jaeger</code>\u7684\u754c\u9762\uff0c \u5176\u521d\u59cb\u754c\u9762\u5982\u56fe\u6240\u793a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230<code>Jaeger</code>\u521a\u521a\u542f\u52a8, <code>service</code>\u65e2\u5217\u8868\u4e2d\u7684\u6570\u91cc\u662f<code>O</code>\u3002\u8fd9\u540c\u6837\u662f\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709\u8fd0\u884c\u6ca1\u6709\u4ea7\u751f\u8ddf\u8e2a\u7684\u6570\u636e\u5bfc\u81f4</p> <p>\u53ef\u4ee5\u8fdb\u4eba<code>sleep Pod</code>\u4f7f\u7528\u4e4b\u524d\u7684\u65b9\u6cd5\u6765\u751f\u6210\u8d1f\u8f7d </p> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-gvqng -c sleep bash\n\nbash-4.4# for i in 'seq 100';do http --body http://flaskapp/env/version; done\n</code></pre> <p></p> <p></p>"},{"location":"chap5/7Istio_fun3_Jager/#3","title":"3\u3001\u8ddf\u8e2a\u53c2\u6570\u7684\u4f20\u9012","text":"<p>\u524d\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u8ddf\u8e2a\u6d3b\u52a8\u5305\u542b\u4e00\u4e2a\u670d\u52a1\u7aef\u548c\u4e00\u4e2a\u5ba2\u6237\u7aef\u3002</p> <p>\u5982\u679c\u8ba9\u4eec<code>flaskapp</code>\u518d\u6b21\u83b7\u53d6\u53e6\u4e00\u4e2a\u670d\u52a1\u7684\u5185\u5bb9\u5219\u4f1a\u53d1\u751f\u4ec0\u4e48\u5462\uff0c\u6211\u4eec\u518d\u5f15\u4eba\u4e00\u4e2a<code>httpbin</code>\u670d\u52a1\u6765\u8bd5\u8bd5 </p> <p>\u9996\u5148\u542f\u52a8\u8fd9\u4e2a\u670d\u52a1\u5e76\u7b49\u5f85\u6210\u529f\u8fd0\u884c </p> <pre><code>$ cd Istio/istio-1.1.16/samples/httpbin\n$ kubectl apply -f httpbin.yaml\nservice/httpbin created\ndeployment.extensions/httpbin created\n</code></pre> <pre><code>$ kubectl get pods | grep httpbin\nhttpbin-7d9d5b55b9-kzt5k       2/2     Running   0          9m36s\n</code></pre> <p>\u63a5\u4e0b\u6765\u5728<code>sleep</code>\u670d\u52a1\u7684<code>Pod</code>\u53d1\u8d77\u8bf7\u6c42,\u8981\u6c42<code>flaskapp</code>\u8c03\u7528<code>httpbin</code>\u670d\u52a1\u7684<code>/get</code> \u8def\u5f84, \u5e76\u8fd4\u56de<code>httpbin</code>\u7ed9\u51fa\u54cd\u5e94\uff0c \u540c\u65f6\u8981\u663e\u793a<code>sleep</code>\u53d1\u51fa\u7684\u8bf7\u6c42<code>Header</code>\u7684\u5185\u5bb9</p> <pre><code>/# http --debug http://flaskapp/fetch_with_header?url=http://httpbin:8000/get \n</code></pre> <p>\u6b64\u65f6\u4f1a\u53d1\u73b0\uff0c <code>httpie</code>\u5ba2\u6237\u7aef\u53d1\u51fa\u7684\u8bf7\u6c42<code>Header</code>\u7684\u539f\u59cb\u5185\u5bb9\u4e3a</p> <pre><code>requests.request(**{\n    \"allow_redirects\": false,\n    \"auth\": \"None\",\n    \"cert\": \"None\",\n    \"data\": {},\n    \"files\": {},\n    \"headers\": {\n        \"User-Agent\": \"HTTPie/0.9.9\"\n    },\n    \"method\": \"get\",\n    \"params\": {},\n    \"proxies\": {},\n    \"stream\": true,\n    \"timeout\": 30,\n    \"url\": \"http://flaskapp/fetch_with_header?url=http://httpbin:8000/get\",\n</code></pre> <p><code>flaskapp</code>\u6536\u5230\u7684\u8bf7\u6c42\u8981\u6bd4<code>Header</code>\u7684\u5185\u5bb9\u590d\u6742\u7684\u591a</p> <pre><code>{\"Content-Length\": \"0\", \n \"Host\": \"flaskapp\", \n \"User-Agent\": \"HTTPie/0.9.9\", \n \"Accept-Encoding\": \"gzip, deflate\", \n \"Accept\": \"*/*\", \n \"X-Forwarded-Proto\": \"http\", \n \"X-Request-Id\": \"999b9783-0b10-4140-8226-62ae1f5b15fd\", \n \"X-Envoy-Decorator-Operation\": \"flaskapp.default.svc.cluster.local:80/*\", \n \"X-Istio-Attributes\": \"....\"\n \"X-B3-Traceid\": \"efbd625ec2a1de04df63cf6195b6646f\", \n \"X-B3-Spanid\": \"df63cf6195b6646f\", \n \"X-B3-Sampled\": \"0\"}\n</code></pre> <p><code>\"X-Envoy-Decorator-Operation\": \"flaskapp.default.svc.cluster.local:80/*\"</code></p> <p>\u4e0d\u96be\u770b\u51fa, \u591a\u51fa\u4e86\u4e00\u7cfb\u5217\u7684<code>X-\uff0a</code>\u7684\u8bf7\u6c42<code>Header</code>, \u5e94\u8be5\u662f<code>Envoy</code>\u4ee3\u7406\u5bf9\u8be5\u8bf7\u6c42\u8fdb\u884c\u4e86\u4fee\u6539\u5176\u4e2d\u5c31\u5305\u542b\u5206\u5e03\u5f0f\u8ddf\u8e2a\u6240\u9700\u8981\u7684<code>Request ID</code>\u7b49\u8bf7\u6c42<code>Header</code></p> <p>\u540c\u65f6, \u5728\u7ecf\u8fc7\u591a\u6b21\u8bbf\u95ee\u540e,\u5982\u679c\u56de\u5230<code>Japer</code>\u7684<code>web</code>\u754c\u9762\uff0c\u5c31\u4f1a\u53d1\u73b0sleep\u5e94\u7528\u7684\u8ddf\u8e2a\u8bb0\u5f55\u975e\u5e38\u5c11 </p> <p></p> <p>\u6211\u4eec\u5f53\u7136\u5e0c\u671b\u770b\u5230<code>sleep-&gt;flaskapp-&gt;httpbin</code>\u7684\u5b8c\u6574\u8ddf\u8e2a\u4fe1\u606f\uff0c</p> <p>\u4f46\u662f<code>OpenTracing</code>\u6240\u4f9d\u8d56<code>Header</code>\u6ca1\u6709\u4f20\u9012\uff0c \u56e0\u6b64<code>jager</code>\u65e0\u6cd5\u786e\u5b9a\u8c03\u7528\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c \u53ea\u4f1a\u6709<code>sleep-&gt;flask</code>\u548c<code>flaskapp-&gt;httbin</code>\u4e24\u7aef\u9f13\u52b1\u7684\u8ddf\u8e2a\u4fe1\u606f</p> <p>\u8981\u628a\u5b64\u7acb\u7684\u8ddf\u8e2a\u4fe1\u606f\u878d\u5408\u8d77\u6765\uff0c\u539f\u5219\u4e0a\u6bd4\u8f83\u7b80\u5355\uff1a\u5bf9\u4e8e\u4e2d\u95f4\u670d\u52a1\u6536\u5230\u7684\u8bf7\u6c42\uff0c \u5728\u8fdb\u884c\u4e0b\u4e00\u7ea7\u8bf7\u6c42\u65f6\uff0c\u5c06\u5176\u4e2d\u7528\u4e8e\u8ddf\u8e2a\u7684<code>Header</code>\u4f20\u9012\u4e0b\u53bb\u5c31\u53ef\u4ee5\u4e86\u3002 </p> <p>\u7b80\u5355\u6765\u8bf4\uff0c\u5982\u679c\u5728\u8bf7\u6c42\u4e2d\u5b58\u5728\u5982\u4e0b<code>Header</code>\uff0c\u5c31\u9700\u8981\u8fdb\u884c\u8f6c\u53d1\uff1a </p> <ul> <li>x-request-id </li> <li>x-b3-traceid </li> <li>x-b3-spanid </li> <li>x-b3-parentspanid </li> <li>x-b3-sampled </li> <li>x-b3-flags </li> <li>x-ot-span-context </li> </ul> <p>\u56e0\u6b64\uff0c\u6211\u4eec\u7ed9<code>flaskapp</code>\u7684<code>Python</code>\u3002\u4ee3\u7801\u52a0\u4eba\u4e00\u70b9\u65b0\u4e1c\u897f\uff0c\u6765\u4f20\u9012\u8fd9\u4e9b\u5185\u5bb9\uff1a </p> <pre><code>...\nTRACE_HEADERS = [\n    'x-request-id',\n    'x-b3-traceid',\n    'x-b3-spanid',\n    'x-b3-parentspanid',\n    'x-b3-sampled',\n    'x-b3-flags',\n    'x-ot-span-context'\n]\n...\n    req = Request(url, headers = new_header)\n    res = urlopen(req).read()\n...\n</code></pre> <p>\u6211\u4eec\u65b0\u5efa\u4e86\u4e00\u4e2a<code>URL</code>\u8def\u5f84<code>\u201cfetch_with_trace\"</code>\uff0c\u5728<code>flaskapp</code>\u7684\u4ee3\u7801\u4e2d\u52a0\u4eba\u4e86\u3001 <code>Header</code>\u7684\u8bc6\u522b\uff0c\u4e00\u65e6\u5728\u63a5\u53d7\u7684\u8bf7\u6c42\u4e2d\u5305\u542b\u7279\u5b9a\u7684<code>Header</code>\uff0c\u5c31\u5c06\u5176\u4fdd\u5b58\u4e0b\u6765\uff0c\u5e76\u5728\u4e0b\u4e00\u6b21\u8bf7\u6c42\u4e2d\u53d1\u9001\u51fa\u53bb\u3002</p> <p>\u4e0b\u9762\u5c31\u7528\u8fd9\u4e2a\u65b0\u65b9\u6cd5\u6765\u6d4b\u8bd5\u4e00\u4e0b\uff0c\u770b\u770b\u7528\u65b0\u65b9\u6cd5\u5b8c\u6210\u7684\u8c03\u7528\u662f\u5426\u4f1a\u5728<code>Jaeger</code>\u4e2d\u5c55\u793a\u5b8c\u6574\u7684\u8ddf\u8e2a\u4fe1\u606f\uff1a </p> <pre><code>for i in 'seq 100';do http --debug http://flaskapp/fetch_with_trace?url=http://httpbin:8000/ip;done\n</code></pre> <p></p> <p>\u5355\u51fb\u8fdb\u5165\u67e5\u770b\u8be6\u7ec6\u8bb0\u5f55</p> <p></p> <p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230<code>sleep</code>\u7684\u8c03\u7528\u5148\u540e\u5f15\u53d1\u4e86<code>flaskapp</code>\u548c<code>httpbin</code>\u7684\u8ddf\u8e2a\u8bb0\u5f55\u94fe\u8def\u53d8\u5f97\u5b8c\u6574\u4e86</p> <p></p> <p>\u5728<code>flaskapp</code>\u4e2d\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a<code>URL:\"/fetch_with_header\"</code>\u3002\u5229\u7528\u8fd9\u4e00\u65b9\u6cd5\uff0c\u53ef\u4ee5\u770b\u5230<code>Header</code>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u53d1\u751f\u7684\u53d8\u5316 </p> <p>\u6211\u4eec\u53ef\u4ee5\u5728<code>sleep</code>\u5bb9\u5668\u4e2d\u6d4b\u8bd5\u8fd9\u4e2a\u65b9\u6cd5\uff1a </p> <pre><code>...\n\"X-Request-Id\": \"b4706d04-b01a-4b46-a8a6-49969fd69412\",\n\"X-Envoy-Decorator-Operation\": \"flaskapp.default.svc.cluster.local:80/*\", \"X-Istio-Attributes\": \"..\", \n\"X-B3-Traceid\": \"bf6812da453a130b41700b913f6cd354\", \n\"X-B3-Spanid\": \"41700b913f6cd354\",\n\"X-B3-Sampled\": \"0\"\n...\n\"X-B3-Parentspanid\": \"c47b04e9488308e5\",\n\"X-B3-Sampled\": \"0\"\n\"X-B3-Spanid\": \"037db9a260a2ede6\",\n\"X-B3-Traceid\": \"bf6812da453a130b41700b913f6cd354\"\n\"origin\": \"127.0.0.1\",\n\"url\": \"http://httpbin:8000/get\"\n</code></pre> <p>\u5728\u8f93\u51fa\u5185\u5bb9\u4e2d\u4f1a\u5305\u542b\u4e24\u7ec4<code>HTTP Header</code>\uff1a</p> <ul> <li>\u7b2c1\u7ec4\u6765\u81ea<code>flaskapp</code>\uff0c\u8868\u793a<code>sleep-&gt;flaskapp</code>\u7684\u8bf7\u6c42\u5185\u5bb9\uff1b</li> <li>\u7b2c2\u7ec4\u6765\u81ea<code>httpbin</code>\uff0c\u8868\u793a<code>flaskapp-&gt;httpbin</code>\u7684\u5185\u5bb9 </li> </ul> <p>\u4e0d\u96be\u53d1\u73b0 :</p> <ul> <li>\u6211\u4eec\u6307\u5b9a\u7684<code>Header</code>\u5728\u4e24\u6bb5\u8def\u5f84\u4e2d\u91cd\u590d\u51fa\u73b0\uff1b</li> <li><code>X-Request-Id</code>\u548c<code>X-B3-Traceid</code>\u662f\u76f4\u63a5\u4e0b\u53d1\u7684\uff0c\u4e24\u4e2a\u670d\u52a1\u6536\u5230\u7684\u5185\u5bb9\u662f\u4e00\u81f4\u7684\uff1b </li> <li>\u5728<code>httpbin</code>\u6536\u5230\u7684\u8ddf\u8e2a\u4fe1\u606f\u4ef6,<code>X-B3-Parentspanid</code>\u5c31\u7b49\u540c\u4e8e<code>flaskapp</code>\u53d1\u51fa <code>X-B3-Spanid</code>\uff0c\u8fd9\u8868\u660e\u4e86\u7236\u5b50\u5173\u7cfb\u3002 </li> </ul>"},{"location":"chap5/7Istio_fun3_Jager/#4jaeger","title":"4\u3001\u5f00\u653eJaeger\u670d\u52a1","text":"<p>\u548c<code>Grafana</code>\u3001 <code>Prometheus</code>\u4e00\u6837\uff0c<code>Jaege</code>r\u540c\u6837\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u670d\u52a1\u7c7b\u578b\u7b49\u65b9\u5f0f\u5c06\u670d\u52a1\u516c\u5f00\u5230\u7f51\u683c\u5916\u90e8\uff1b\u4e0d\u540c\u7684\u662f\uff0c<code>Jaeger</code>\u8fd8\u76f4\u63a5\u5728<code>Chart</code>\u4e2d\u63d0\u4f9b\u4e86<code>Ingress</code>\u7684\u8bbe\u7f6e\u65b9\u5f0f\u3002 </p> <p>\u5982\u679c\u5df1\u7ecf\u5728<code>Kubernetes</code>\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e86<code>Ingress Controller</code>,\u53ef\u4ee5\u5728<code>values.yaml</code>\u4e2d\u76f4\u63a5\u8bbe\u7f6e\uff1a </p> <pre><code>ingress:\n    enabled: false\n    # Used to create an Ingress record.\n    hosts:\n      - jaeger.local\n    annotations:\n      # kubernetes.io/ingress.class: nginx\n      # kubernetes.io/tls-acme: \"true\"\n    tls:\n      # Secrets must be manually created in the namespace.\n      # - secretName: chart-example-tls\n      #   hosts:\n      #     - chart-example.local\n</code></pre> <p><code>helm template</code>\u547d\u4ee4\u4f1a\u4e3a\u8fd9\u4e9b\u8bbe\u7f6e\u751f\u6210<code>Ingress</code>\u8d44\u6e90\u4ece\u800c\u5b8c\u6210<code>Jaeger</code>\u670d\u52a1\u7684\u5f00\u653e</p>"},{"location":"chap5/8Istio_func4_Kiali/","title":"\u7b2c\u516b\u8282 \u4f7f\u7528Kiali","text":"<p><code>Kiali</code>\u4ee5(<code>https://www.kiali.com</code>\uff09\u4e5f\u662f\u4e00\u4e2a\u7528\u4e8e<code>Istio</code>\u53ef\u89c6\u5316\u7684\u8f6f\u4ef6\uff0c\u540c\u524d\u9762\u7684<code>Grafana</code>, <code>Promtheus</code> \u7b49\u901a\u7528\u8f6f\u4ef6\u4e0d\u540c<code>Kiali</code>\u76ee\u524d\u662f\u4e13\u7528\u4e8e<code>Istio</code>\u7cfb\u7edf\u7684, \u53ef\u89c6\u5316\u53ca\u8ddf\u8e2a\u7b49\u901a\u7528\u529f\u80fd, \u8fd8\u4e13\u95e8\u63d0\u4f9b\u4e86<code>Istio</code>\u7684\u914d\u7f6e\u9a8c\u8bc1\uff0c\u5065\u5eb7\u8bc4\u4f30\u7684\u7b49\u9ad8\u7ea7\u529f\u80fd</p>"},{"location":"chap5/8Istio_func4_Kiali/#1-kiali","title":"1\u3001 \u542f\u7528<code>Kiali</code>","text":"<p>\u5728\u542f\u7528<code>Kiali</code>\u65f6\u540c\u6837\u9700\u8981\u5bf9<code>values.yaml</code>\u8fdb\u884c\u4fee\u6539\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c06<code>Kiali</code>\u7684\u76f8\u5173\u53d8\u91cf\u8bbe\u7f6e\u5982\u4e0b\uff1b </p> <p><code>istio/charts/kiali/values.yaml</code></p> <pre><code>#\n# addon kiali\n#\nenabled: false # Note that if using the demo or demo-auth yaml when installing via Helm, this default will be `true`.\nreplicaCount: 1\nhub: docker.io/kiali\ntag: v0.16\ncontextPath: /kiali # The root context path to access the Kiali UI.\nnodeSelector: {}\n\npodAntiAffinityLabelSelector: []\npodAntiAffinityTermLabelSelector: []\n\ningress:\n  enabled: false\n  ## Used to create an Ingress record.\n  hosts:\n    - kiali.local\n  annotations:\n    # kubernetes.io/ingress.class: nginx\n    # kubernetes.io/tls-acme: \"true\"\n  tls:\n    # Secrets must be manually created in the namespace.\n    # - secretName: kiali-tls\n    #   hosts:\n    #     - kiali.local\n\ndashboard:\n  secretName: kiali # You must create a secret with this name - one is not provided out-of-box.\n  grafanaURL:  # If you have Grafana installed and it is accessible to client browsers, then set this to its external URL. Kiali will redirect users to this URL when Grafana metrics are to be shown.\n  jaegerURL:  # If you have Jaeger installed and it is accessible to client browsers, then set this property to its external URL. Kiali will redirect users to this URL when Jaeger tracing is to be shown.\nprometheusAddr: http://prometheus:9090\n\n# When true, a secret will be created with a default username and password. Useful for demos.\ncreateDemoSecret: false\n</code></pre> <p>\u8981\u7b80\u5355\u542f\u7528<code>Kiali</code>, \u5219\u53ea\u8bbe\u7f6e\u5176<code>enabled</code>\u4e3a<code>true</code>\u5373\u53ef\uff0c \u4f46\u6709\u4e9b\u5730\u65b9\u9700\u8981\u7279\u522b\u6ce8\u610f\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 </p> <ul> <li>\u4e0e<code>Jaeger</code>\u4e00\u6837,\u53ef\u4ee5\u4e3a<code>Kiali</code>\u8bbe\u7f6e<code>Ingress</code>\u51fa\u53e3</li> </ul> <p>\u548c\u5176\u4ed6\u7ec4\u4ef6\u4e00\u6837\uff0c \u5728\u8bbe\u7f6e<code>enabled</code>\u4e3atrue\u4e4b\u540e\u4f7f\u7528<code>helm template</code>\u6e32\u67d3\uff0c<code>kubectl apply</code>\u547d\u4ee4\u8fdb\u884c\u5b89\u88c5 ,\u7b49\u5f85 <code>Pod</code>\u542f\u52a8\u6210\u529f\u5373\u53ef\u3002 </p> <p>\u6211\u4eec\u5728\u8fd9\u91cc\u4fee\u6539<code>kiali</code>\u7684image\u5230\u6700\u65b0\u7684\u7248\u672c image: \"docker.io/kiali/kiali:v0.16\" =&gt; image: \"docker.io/kiali/kiali:v1.4.0\" $ kubectl apply -f istio-demo.yaml</p>"},{"location":"chap5/8Istio_func4_Kiali/#2kiali","title":"2\u3001\u8bbf\u95ee<code>Kiali</code>","text":"<p>\u901a\u8fc7\u7aef\u53e3\u8f6c\u53d1\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee</p> <pre><code>$ kubectl -n istio-system get pod -l app=kiali  -o custom-columns='Name:metadata.name'\nName\nkiali-785fc9f67b-gc42t\n\n$ kubectl -n istio-system port-forward kiali-785fc9f67b-gc42t 20001:20001\n</code></pre> <p>\u4f7f\u7528\u6d4f\u89c8\u5668\u6253\u5f00\u9875\u9762\uff0c \u767b\u5f55\u9875\u9762\u7684\u9ed8\u8ba4\u7528\u6237\u540d\u548c\u5bc6\u7801\u4e3a<code>values.yaml</code>\u7684<code>tracing</code>\u4e00\u8282\u4fee\u6539\u3002  \u5728\u767b\u5f55\u6210\u529f\u4e4b\u540e\u8fdb\u4eba\u9996\u9875\uff0c<code>admin:admin</code>\uff0c\u4e5f\u53ef\u4ee5\u5728\u9996\u9875\u5c55\u793a\u4e86\u76ee\u524d\u7684\u547d\u540d\u7a7a\u95f4\u4e2a\u548c\u5176\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u60c5\u51b5 </p> <pre><code>http://127.0.0.1:20001/kiali/console\n</code></pre> <p></p> <p>\u5355\u51fb\u5176\u4e2d\u7684<code>default</code>\u547d\u540d\u7a7a\u95ee\u4f1a\u770b\u5230\u5404\u4e2a\u670d\u52a1\u7684\u60c5\u51b5\uff0c\u5305\u62ec\u5065\u5eb7\u72b6\u51b5\u3001\u662f\u5426\u6ce8\u5165</p> <p></p> <p>\u5355\u51fb\u5177\u4f53\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u770b\u5230\u670d\u52a1\u76f8\u5173\u7684\u4e00\u4e9b\u6307\u6807\u5c55\u793a\uff0c\u4f8b\u5982\u67e5\u770b<code>flaskapp-v1</code>\u7684\u51fa\u7ad9\u8bf7\u6c42</p> <p>\u6ce8\u610f\uff0c\u8fd9\u4e9b\u56fe\u5f62\u662f\u6839\u636e\u8bbf\u95ee\u5f97\u51fa\u7684\uff0c\u5982\u679c\u4e3a\u7a7a\uff0c\u5219\u53ef\u80fd\u662f\u56e0\u4e3a\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u8303\u56f4\u5185\u6ca1\u6709\u6d41\u91cf\u6d69\u6210\u7684\u3002</p> <p>\u5c1d\u8bd5\u9009\u62e9\u5408\u9002\u7684\u65f6\u95f4\u8de8\u5ea6\uff0c\u770b\u770b\u662f\u5426\u6b63\u786e\u663e\u793a\u3002</p> <p>\u53ef\u4ee5\u8fdb\u4eba<code>sleep Pod</code>\u4f7f\u7528\u4e4b\u524d\u7684\u65b9\u6cd5\u6765\u751f\u6210\u8d1f\u8f7d </p> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-gvqng -c sleep bash\n\nbash-4.4# for i in 'seq 1000';do http --body http://flaskapp/env/version; done\n</code></pre> <p><code>Workloads -&gt; sleep -&gt; Outbound Metrics</code></p> <p></p> <p>\u5728<code>Graph</code>\u83dc\u5355\u4e2d\u4f1a\u663e\u793a\u670d\u52a1\u7684\u62d3\u6251\u5173\u7cfb\u4f8b\u5982\u6211\u4eec\u5728\u524d\u800c\u8fdb\u884c\u6d4b\u8bd5\u65f6\u4f7f\u7528\u7684, \u51e0\u4e2a\u670d\u52a1\u90fd\u4f1a\u6709\u5982\u56fe\u6240\u793a\u7684\u663e\u793a\u6548\u679c </p> <p></p> <p></p> <p></p> <p>\u8fd9\u91cc\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230\u5404\u4e2a\u670d\u52a1\u7684\u8c03\u7528\u5173\u7cfb\u548c\u6d41\u91cf\u72b6\u51b5\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u5728\u524d\u9762\u4f7f\u7528 <code>sleep pod</code>\u7684<code>Shell</code>\u4e2d\uff0c\u4f7f\u7528<code>HTTP</code>\u5ba2\u6237\u7aef\u4e00\u5de5\u5177\u901a\u8fc7<code>flaskapp</code>\u5e94\u7528\u8c03\u7528<code>httpbin</code>\u7684\u8fc7\u7a0b\uff0c \u5728\u8fd9\u5f20\u56fe\u4e2d\u7684\u8868\u73b0\u5c31\u5f88\u660e\u663e\u3002</p> <p>\u53e6\u5916\uff0c\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u529f\u80fd\u5c31\u662fKiali\u83dc\u5355\u5de6\u4fa7\u7684<code>Istio Confi</code>g\u9879\u3002\u5355\u51fb\u8fd9\u4e00\u9879\uff0c \u9009\u62e9<code>istio-system\u547d</code>\u540d\u7a7a\u95f4\uff0c\u4f1a\u770b\u5230<code>Istio</code>\u9ed8\u8ba4\u7684\u5404\u79cd\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684\u8bbe\u7f6e\u60c5\u51b5</p> <p></p> <p>\u5355\u51fb\u5176\u4e2d\u7684\u5404\u4e2a\u9879\u76ee, \u4f1a\u5c55\u793a\u8be5\u5bf9\u8c61\u7684\u5b9a\u4e49\u6587\u672c,\u5176\u4e2d\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e9b\u914d\u7f6e\u6821\u9a8c\u65b9\u9762\u7684\u529f\u80fd\u3002\u5982\u6240\u793a\u7684\u662f<code>istio-policy</code>\u7684<code>destinationrules</code>\u3002 </p> <p></p> <p></p>"},{"location":"chap5/8Istio_func4_Kiali/#kiali_1","title":"\u5f00\u653eKiali\u670d\u52a1","text":"<p>\u5728<code>values.yaml</code>\u4e2d\u4e5f\u4e3a<code>Kiali</code>\u63d0\u4f9b\u4e86<code>Ingress</code>\u7684\u914d\u7f6e\u9879\u76ee\uff0c\u56e0\u6b64\u5f00\u653e<code>Kiali</code>\u670d\u52a1\u7684  \u65b9\u5f0f\u548c<code>Jaeger</code>\u4e00\u6837\uff0c\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u670d\u52a1\u7c7b\u578b\u6216\u8bbe\u7f6e<code>Ingress</code>\u5c06\u670d\u52a1\u5f00\u653e\u3002 </p>"},{"location":"chap5/8Istio_func4_Kiali/#3","title":"3\u3001\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u8bb2\u89e3\u4e86\u5982\u4f55\u5728\u7f51\u683c\u4e2d\u8fdb\u884c\u5e94\u7528\u90e8\u7f72\uff0c\u8fd8\u9010\u4e2a\u5c55\u793a\u4e86<code>Istio</code>\u5e38\u7528\u53ef\u89c6\u5316\u7ec4\u4ef6\u7684\u542f\u52a8\u548c\u4f7f\u7528\u65b9\u6cd5\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u5bf9<code>Istio</code>\u670d\u52a1\u7f51\u683c\u7684\u8fd0\u7ef4\u6709\u5f88\u91cd\u8981\u7684\u610f\u4e49\uff0c\u662f\u670d\u52a1\u7f51\u683c\u53ef\u89c2\u5bdf\u6027\u7684\u5177\u4f53\u8868\u73b0\u3002<code>Grafana</code> , <code>Prometheus</code>\u53ca<code>Jaeger</code>\u8fd9\u4e9b\u7b2c\u4e09\u65b9\u7ec4\u4ef6\u90fd\u76f8\u5bf9\u6210\u719f\u548c\u7a33\u5b9a\uff1b<code>Kiali</code>\u76ee\u524d\u8fd8\u76f8\u5bf9\u5e7c\u7a1a\uff0c\u4f46\u662f\u4e5f\u770b\u5f97\u51fa\u6765<code>Istio</code>\u5bf9\u5176\u529f\u80fd\u7684\u501f\u91cd\u548c\u671f\u5f85\u3002 </p>"},{"location":"chap5/9Istio_http1/","title":"\u7b2c\u4e5d\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u76ee\u6807\u89c4\u5219/\u9ed8\u8ba4\u8def\u7531/\u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb)","text":"<ul> <li>9.1 \u5b9a\u4e49\u76ee\u6807\u89c4\u5219 </li> <li>9.2 \u5b9a\u4e49\u9ed8\u8ba4\u8def\u7531 </li> <li>9.3 \u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb</li> </ul> <p>\u5728\u7b2c2\u7ae0\u4e2d\u63d0\u5230\u8fc7\uff0c\u8fde\u63a5\u80fd\u529b\u662f<code>Istio</code>\u7684\u6838\u5fc3\u529f\u80fd\u4e4b\u4e00\uff0c\u5982\u4e0b\u6240\u793a</p> <ul> <li>\u5728\u5fae\u670d\u52a1\u73af\u5883\u4e2d\uff0c\u5982\u4f55\u5c06\u5927\u91cf\u7684\u5fae\u670d\u52a1\u94fe\u63a5\u5728\u4e00\u8d77\uff0c \u8fdb\u884c\u6709\u6548\u7684\u8fdc\u7a0b\u670d\u52a1\u8c03\u7528\uff0c\u662f\u4e1a\u52a1\u8fd0\u8f6c\u7684\u57fa\u672c\u8981\u6c42</li> <li>\u5728\u4e0d\u53ef\u9760\u7684\u7f51\u7edc\u72b6\u51b5\u4e0b\uff0c\u5982\u4f55\u4fdd\u8bc1\u670d\u52a1\u6b63\u786e\u5e94\u5bf9\u7f51\u7edc\u8fc7\u8d26\uff0c\u4fdd\u8bc1\u670d\u52a1\u8d28\u91cf\uff0c\u4e5f\u662f\u5fc5\u987b\u8003\u8651\u7684\u95ee\u9898</li> <li>\u5728\u5347\u7ea7\uff0c\u6d4b\u8bd5\u548c\u6269\u7f29\u5bb9\u7684\u573a\u666f\u4e2d\uff0c\u8fdb\u884c\u6709\u5e8f\u53ef\u9760\u7684\u6d41\u91cf\u5f15\u5bfc\u548c\u8f6c\u79fb\uff0c\u540c\u6837\u662f\u5f88\u73b0\u5b9e\u7684\u8981\u6c42</li> <li>\u5728\u5fae\u670d\u52a1\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u80fd\u591f\u91c7\u53d6\u63aa\u65bd\u8fdb\u884c\u6545\u969c\u9694\u79bb\uff0c\u9632\u6b62\u6545\u969c\u6269\u6563\u5f71\u54cd\u6574\u4f53\u5e94\u7528\u7684\u8fd0\u884c\uff0c \u5bf9\u4e1a\u52a1\u5065\u58ee\u6027\u662f\u4e00\u4e2a\u91cd\u8981\u4fdd\u969c</li> </ul> <p>Istio\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u6d41\u91cf\u63a7\u5236\u80fd\u529b\uff0c\u53ef\u4ee5\u5728\u4e1a\u52a1\u53ef\u4ee5\u5728\u4e1a\u52a1\u5e94\u7528\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u5bf9\u5e94\u7528\u7684\u901a\u4fe1\u8fdb\u884c\u914d\u7f6e\u548c\u7ba1\u7406\uff0c \u80fd\u591f\u6709\u6548\u964d\u4f4e\u5f00\u53d1\u548c\u8fd0\u7ef4\u6210\u672c\uff0c\u5e76\u63d0\u9ad8\u670d\u52a1\u7684\u63a7\u5236\u80fd\u529b</p>"},{"location":"chap5/9Istio_http1/#1","title":"1\u3001\u5b9a\u4e49\u76ee\u6807\u89c4\u5219","text":"<p>\u5728\u8fdb\u884c\u6d41\u91cf\u7ba1\u7406\u5b9e\u8df5\u4e4b\u524d\uff0c\u9996\u5148\u8981\u4e86\u89e3<code>Istio</code>\u5bf9\u6d41\u91cf\u8bbf\u95ee\u76ee\u6807\u7684\u5b9a\u4e49\u901a\u5e38\u6765\u8bf4\uff0c\u5728<code>Kubernetes</code>\u4e2d\u8bbf\u95ee\u4e00\u4e2a\u670d\u52a1\u65f6\uff0c\u9700\u8981\u6307\u5b9a\u5176\u534f\u8bae\u3001\u670d\u52a1\u540d\u53ca\u7aef\u53e3  \u4f8b\u5982<code>http://httpbin:8000</code>\u3002</p> <p>\u800c\u5728<code>Istio</code>\u7684\u670d\u52a1\u7f51\u683c\u4e2d\u5bf9\u670d\u52a1\u8fdb\u884c\u4e86\u8fdb\u4e00\u6b65\u62bd\u8c61\uff1a </p> <ul> <li>\u53ef\u4ee5\u4f7f\u7528<code>Pod</code>\u6807\u7b7e\u5bf9\u5177\u4f53\u7684\u670d\u52a1\u8fdb\u7a0b\u8fdb\u884c\u5206\u7ec4\uff1b </li> <li>\u53ef\u4ee5\u5b9a\u4e49\u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff1b </li> <li>\u53ef\u4ee5\u4e3a\u670d\u52a1\u6307\u5b9a<code>TLS</code>\u8981\u6c42\uff1b </li> <li>\u53ef\u4ee5\u4e3a\u670d\u52a1\u8bbe\u7f6e\u8fde\u63a5\u6c60\u5927\u5c0f\u3002 </li> </ul> <p>\u6211\u4eec\u7528\u5230\u7684<code>flaskapp.istio.yaml</code>\u901a\u8fc7\u4e2a<code>Servie</code>\u5bf9\u5e94\u4e24\u4e2a\u4e0d\u540c\u7248 <code>Deployment</code> \u4e24\u4e2a<code>Deployment</code>\u4e2d\u7684Pod\u4f7f\u7528\u4e86\u4e0d\u540c\u7684\u6807\u7b7e\u8fdb\u884c\u533a\u5206</p> <p>\u5728<code>Kubernetes</code>\u4e2d<code>Service</code>\u548c<code>Deployment</code>\u6216\u8005\u5176\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5173\u7cfb\u901a\u5e38\u662f\u4e00\u5bf9\u4e00\u7684\u3002</p> <p></p> <p>\u800c\u5728<code>Istio</code>\u4e2d<code>Service</code>\u7ecf\u5e38\u4f1a\u5bf9\u5e94\u4e0d\u540c\u7684<code>Deployment</code> </p> <p></p> <p>\u8fd9\u4e2a\u5dee\u5f02\u770b\u8d77\u6765\u4f3c\u4e4e\u5fae\u4e0d\u8db3\u9053\uff0c\u4f46\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u4e24\u79cd\u6a21\u5f0f\u7684\u7075\u6d3b\u6027\u9ad8\u4e0b\u7acb\u5224\uff0c \u5982\u4e0b\u6240\u8ff0 </p> <ul> <li>\u5728<code>Istio</code>\u4e2d\uff0c\u5ba2\u6237\u7aef\u53ea\u4f7f\u7528\u4e00\u4e2a\u670d\u52a1\u5165\u53e3\u5c31\u53ef\u4ee5\u8bbf\u95ee\u591a\u4e0d\u540c\u7684\u670d\u52a1\uff0c\u65e0\u987b\u5ba2\u6237\u7aef\u5e72\u9884\u3002 \u4f46\u5ba2\u6237\u7aef\u5982\u679c\u76f4\u63a5\u4f7f\u7528<code>Kubernetes Service</code>\uff0c\u5c31\u5fc5\u987b\u4f7f\u7528\u4e24\u4e2a\u4e0d\u540c\u7684\u670d\u52a1\u5165\u53e3\u3002 </li> <li><code>Istio</code>\u53ef\u4ee5\u901a\u8fc7\u6d41\u91cf\u7279\u5f81\u6765\u5b8c\u6210\u5bf9\u540e\u7aef\u670d\u52a1\u7684\u9009\u62e9, \u5b83\u7684\u6d41\u91cf\u63a7\u5236\u529f\u80fd\u4f1a\u6839\u636e\u6bcf\u6b21\u8bbf\u95ee\u4ea7\u751f\u7684\u6d41\u91cf\u8fdb\u884c\u5224\u65ad\uff0c \u6839\u636e\u5224\u65ad\u7ed3\u679c\u6765\u9009\u62e9\u4e00\u4e2a\u540e\u7aef\u8d1f\u8d23\u672c\u6b21\u8bbf\u95ee\u7684\u54cd\u5e94\u3002</li> </ul> <p><code>Kubernetes</code>\u5f53\u7136\u4e5f\u53ef\u4ee5\u8fd9\u6837\u505a, \u4f46\u662f\u56e0\u4e3a<code>Kubernetes</code>\u7684<code>Service</code>\u4e0d \u5177\u5907\u9009\u62e9\u540e\u7aef\u7684\u80fd\u529b\uff0c\u6240\u4ee5\u5982\u679c\u5b83\u4f7f\u7528\u4e86<code>Istio</code>\u8fd9\u79cd\u4e00\u5bf9\u591a\u7684\u6a21\u5f0f, \u5219\u540e\u679c\u53ea\u80fd\u662f\u4f7f\u7528\u8f6e\u8be2\u65b9\u5f0f\u968f\u673a\u8c03\u7528\u4e24\u4e2a\u4e0d\u540c\u7684\u5de5\u4f5c\u8d1f\u8f7d</p> <p>\u800c\u5728<code>Istio</code>\u4e2d\uff0c\u8fd9\u79cd\u540c\u4e00\u670d\u52a1\u4e0d\u540c\u7ec4\u522b\u7684\u540e\u7aef\u88ab\u79f0\u4e3a\u5b50\u96c6(Subset)\uff0c\u4e5f\u7ecf\u5e38\u88ab\u79f0\u4e3a\u670d\u52a1\u7248\u672c\u3002 </p> <p>\u5728<code>Istio</code>\u4e2d\u5efa\u8bae\u4e3a\u6bcf\u4e2a\u7f51\u683c\u90fd\u8bbe\u7f6e\u660e\u786e\u7684\u76ee\u6807\u8bbf\u95ee\u89c4\u5219\u3002</p> <p>\u5728\u901a\u8fc7<code>Istio</code>\u6d41\u91cf\u63a7\u5236\u4e4b\u540e\u4f1a\u9009\u62e9\u660e\u786e\u7684\u5b50\u96c6, \u6839\u636e\u8be5\u89c4\u5219\u6216\u8005\u5728\u5b50\u96c6\u4e2d\u89c4\u5b9a\u7684\u6d41\u91cf\u7b56\u7565\u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u8fd9\u79cd\u89c4\u5219\u5728<code>Istio</code>\u88ab\u79f0\u4e3a<code>DestionationRule</code></p> <p>\u4f8b\u5982\u6211\u4eec\u4e3a<code>flaskapp</code>\u5efa\u7acb\u4e00\u4e2a\u76ee\u6807\u89c4\u5219\u5b9a\u4e49 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: DestinationRule \nmetadata: \n  name: flaskapp \nspec: \n  host: flaskapp.default.svc.cluster.local \n  trafficPolicy: \n    loadBalancer: \n      simple: LEAST_CONN \n  subsets: \n  - name: v1 \n    labels: \n      version: v1 \n    trafficPolicy: \n      loadBalancer: \n        simple: ROUND_ROBIN \n  - name: v2 \n    labels: \n      version: v2 \n</code></pre> <ul> <li>DestinationRule</li> <li>trafficPolicy / loadBalancer / simple: LEAST_CONN</li> <li>subsets </li> </ul> <p>\u8be5\u89c4\u5219\u6709\u4ee5\u4e0b\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u3002 </p> <ul> <li> <p><code>host</code>\uff1a\u662f\u4e00\u4e2a\u5fc5\u8981\u5b57\u6bb5\uff0c\u4ee3\u8868<code>Kubernetes</code>\u4e2d\u7684\u4e00\u4e2a<code>Service</code>\u8d44\u6e90\uff0c\u6216\u8005\u4e00\u4e2a  \u7531<code>ServiceEntry</code> \u5b9a\u4e49\u7684\u5916\u90e8\u670d\u52a1\u3002 \u4e3a\u4e86\u9632\u6b62<code>Kubernetes</code>\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u670d\u52a1\u91cd\u540d,  \u8fd9\u91cc\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528\u5b8c\u5168\u9650\u5b9a\u540d\uff0c\u4e5f\u5c31\u662f\u4f7f\u7528<code>FQDN</code>\u6765\u8d4b\u503c\u3002</p> </li> <li> <p><code>trafficPolicy</code>\uff1a\u662f\u6d41\u91cf\u7b56\u7565\u3002\u5728<code>DestinationRule</code>\u548c<code>Subsets</code>\u4e24\u7ea7\u4e2d\u90fd\u53ef\u4ee5\u5b9a\u4e49<code>trafficPolicy</code>\uff0c\u5728<code>Subset</code>\u4e2d\u8bbe\u7f6e\u7684\u7ea7\u522b\u9ad8\u3002 </p> </li> <li><code>subsets</code>\uff1a\u5728\u8be5\u5b57\u6bb5\u4e2d\u4f7f\u7528\u6807\u7b7e\u9009\u62e9\u5668\u6765\u5b9a\u4e49\u4e0d\u540c\u7684\u5b50\u96c6\u3002</li> </ul> <p>\u7efc\u4e0a\u6240\u8ff0\uff0c\u6211\u4eec\u4e3a<code>flaskapp</code>\u5efa\u7acb\u4e86<code>v1</code>\u548c<code>v2</code>\u8fd9\u4e24\u4e2a\u5b50\u96c6\uff0c\u5e76\u4e14<code>v1</code>\u5b50\u96c6\u4f7f\u7528\u4e86\u72ec\u7acb\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u3002</p> <p>\u4e3a\u4e86\u540e\u7eed\u73af\u8282\u7684\u987a\u5229\u8fdb\u884c\uff0c\u521b\u5efa\u7684<code>flaskapp</code>\u670d\u52a1\uff08<code>Service</code>\u548c<code>Deployment</code>\u521b\u5efa\u76ee\u6807\u89c4\u5219\uff0c\u5c06\u5176\u5206\u6210<code>v1</code>\u548c<code>v2</code>\u4e24\u4e2a\u7248\u672c\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3 \nkind: DestinationRule \nmetadata: \n  name: flaskapp \nspec: \n  host: flaskapp.default.svc.cluster.local  \n  subsets: \n  - name: v1 \n    labels: \n      version: v1\n  - name: v2 \n    labels: \n      version: v2\n</code></pre> <p>\u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a<code>flaskapp-dr.yaml</code>\u5e76\u4f7f\u7528<code>kubectl apply</code>\u547d\u4ee4\u63d0\u4ea4\u5230<code>kubernetes</code>\u96c6\u7fa4\uff1b </p> <pre><code>$ kubectl apply -f flaskapp-dr.yaml\ndestinationrule.networking.istio.io/flaskapp configured\n\n\n$ kubectl get dr\nNAME       HOST                                 AGE\nflaskapp   flaskapp.default.svc.cluster.local   6d23h\n</code></pre> <p>\u8fd9\u6837, \u6211\u4eec\u5c31\u5bf9\u5177\u4f53\u8d1f\u8d23\u6267\u884c\u670d\u52a1\u7684\u4e0b\u4f5c\u8d1f\u8f7d\u6709\u4e86\u4e00\u4e2a\u660e\u786e\u7684\u5b9a\u4e49, \u5e76\u53ef\u4ee5\u5c06\u5176\u5f53\u4f5c\u6d41\u91cf\u63a7\u5236\u7684\u57fa\u7840</p>"},{"location":"chap5/9Istio_http1/#2","title":"2\u3001\u5b9a\u4e49\u9ed8\u8ba4\u8def\u7531","text":"<p>\u5728\u670d\u52a1\u90e8\u7f72\u5b8c\u6210\u4e4b\u540e, \u6211\u4eec\u4e3a\u5176\u5b9a\u4e49\u4e86\u76ee\u6807\u89c4\u5219\u8282, \u63a5\u4e0b\u6765\u9762\u4e34\u4e00\u4e2a\u95ee\u9898: \u5728\u6ca1\u6709\u4efb\u4f55\u7279\u5b9a\u8def\u7531\u89c4\u5219\u7684\u60c5\u51b5\u4e0b, \u5bf9<code>flaskpp</code>\u670d\u52a1\u7684\u8bbf\u95ee\u4f1a\u5230\u8fbe\u54ea\u4e2a\u5b50\u96c6\uff08\u6216\u79f0\u7248\u672c\uff09\u5462\uff1f</p> <pre><code>$ kubectl get pod -l app=sleep,version=v1 -o custom-columns='Name:metadata.name'\nName\nsleep-6c9c898f6c-snzx5\nsleep-v1-548d87cc5c-wfk7v\n</code></pre> <pre><code>$ kubectl delete vs flaskapp-default-v2\nvirtualservice.networking.istio.io \"flaskapp-default-v2\" deleted\n\n$ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash\n\nbash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done\nv2\n\nv2\n\nv1\n\nv1\n\nv2\n\nv2\n\nv1\n\nv1\n\nv2\n\nv2\n</code></pre> <p>\u5728\u91cd\u590d\u6267\u884c\u540e\u4e0d\u96be\u53d1\u73b0\uff0c\u6211\u4eec\u5b9a\u4e49\u7684\u76ee\u6807\u89c4\u5219\u5e76\u672a\u5f71\u54cd\u901a\u4fe1\u8fc7\u7a0b\uff0c\u8fd8\u662f\u6309\u7167<code>kube-proxy</code>\u7684\u9ed8\u8ba4\u968f\u673a\u884c\u4e3a\u8fdb\u884c\u8bbf\u95ee\u7684\uff0c\u8fd4\u56de\u7ed3\u679c\u5206\u522b\u6765\u81ea\u4e24\u4e2a\u4e0d\u540c\u7684\u7248\u672c\u3002 </p> <p><code>Istio</code>\u5efa\u8bae\u4e3a\u6bcf\u4e2a\u670d\u52a1\u90fd\u521b\u5efa\u4e00\u4e2a\u9ed8\u8ba4\u8def\u7531\uff0c\u5728\u8bbf\u95ee\u67d0\u4e00\u670d\u52a1\u7684\u65f6\u5019\uff0c\u5982\u679c\u6ca1\u6709\u7279\u5b9a\u7684\u8def\u7531\u5219\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\u6765\u8bbf\u95ee\u6307\u5b9a\u7684\u5b50\u96c6\uff0c\u4ee5\u6b64\u6765\u786e\u4fdd\u670d\u52a1\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u7684\u884c\u4e3a\u7a33\u5b9a\u6027\u3002 </p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u9ed8\u8ba4\u8bbf\u95ee<code>v1</code>\u7248\u672c\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u6d4b\u8bd5\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp \nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  http: \n  - route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v1\n</code></pre> <p>\u8fd9\u662f\u6700\u7b80\u5355\u7684\u4e00\u4e2a<code>VirtualService</code>\u5b9a\u4e49\u3002<code>VirtualService</code>\u662f<code>Istio</code>\u6d41\u5740\u63a7\u5236\u8fc7\u7a0b\u4e2d\u7684\u4e00\u4e2a\u67a2\u7ebd\u8d1f\u8d23\u5bf9\u6d41\u91cf\u8fdb\u884c\u7504\u522b\u548c\u8f6c\u53d1\u3002 </p> <p>\u4e0b\u9762\u5bf9\u672c\u8282\u6d89\u53ca\u7684\u6982\u5ff5\u8fdb\u884c\u8bb2\u89e3\u3002</p> <ul> <li><code>VirtualService</code>\u540c\u6837\u662f\u9488\u5bf9\u4e3b\u673a\u540d\u5de5\u4f5c\u7684\uff0c\u4f46\u6ce8\u610f\u8fd9\u4e2a\u5b57\u6bb5\u662f\u4e00\u4e2a\u6570\u7ec4\u5185\u5bb9\uff0c\u56e0\u6b64\u5b83\u53ef\u4ee5\u9488\u5bf9\u591a\u4e2a\u4e3b\u673a\u540d\u8fdb\u884c\u5de5\u4f5c\uff0c <code>VirtualService</code> \u53ef\u4ee5\u4e3a\u591a\u79cd\u534f\u8bae\u7684\u6d41\u91cf\u63d0\u4f9b\u670d\u52a1\uff0c \u9664\u4e86\u652f\u6301\u672c\u6587\u4f7f\u7528\u7684\u662f<code>HTTP</code>\u8fd8\u652f\u6301<code>TCP</code>\u548c<code>TLS</code> \u3002</li> <li>\u5728<code>http</code>\u5b57\u6bb5\u7684\u4e0b\u4e00\u7ea7, \u5c31\u662f\u5177\u4f53\u7684\u8def\u7531\u89c4\u5219\u4e86\u3002\u4e0d\u96be\u770b\u51fa\uff0c\u8fd9\u91cc\u662f\u652f\u6301\u591a\u7684\u8def\u7531\u7684\uff0c \u6211\u4eec\u7b80\u5355\u5b9a\u4e49\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u76ee\u6807\uff1a<code>flaskapp.default.svc.cluster.local</code> \u4e5f\u5c31\u662f\u8bf4, <code>flaskapp</code>\u9ed8\u8ba4\u4f7f\u7528<code>v1</code>\u7248\u672c\u6765\u5904\u7406\u8bf7\u6c42</li> </ul> <p>\u63a5\u4e0b\u6765\u6d4b\u8bd5\u4e00\u4e0b\u3002 </p> <p>\u9996\u5148\u5c06\u4e0a\u8ff0<code>YAML</code>\u4ee3\u7801\u4fdd\u5b58\u4e3a<code>flask-default-vs-v1.yaml</code>\uff0c\u7136\u540e\u4f7f\u7528<code>kubectl  apply</code>\u547d\u4ee4\u5c06\u5176\u63d0\u4ea4\u5230<code>Kubernetes</code>\u96c6\u7fa4\uff1a </p> <pre><code>$ kubectl apply -f flask-default-vs-v1.yaml\nvirtualservice.networking.istio.io/flaskapp created\n</code></pre> <p>\u518d\u6b21\u8fdb\u5165<code>sleep pod</code> \u8fdb\u884c\u6d4b\u8bd5</p> <pre><code>kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash\n\nbash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done\nv1\n\nv1\n\nv1\n\nv1\n\nv1\n\nv1\n\nv1\n\nv1\n\nv1\n\nv1\n</code></pre> <p>\u91cd\u590d\u6267\u884c\u547d\u4ee4\u5c31\u4f1a\u53d1\u73b0\u6240\u6709\u8bbf\u95ee\u90fd\u4ece<code>v1</code>\u7248\u672c\u8fd4\u56de\u4e86, \u8fd9\u8868\u660e\u627e\u4eec\u5b9a\u5236\u7684\u9ed8\u8ba4\u8def\u7531\u5df1\u7ecf\u751f\u6548\u6548 </p> <p>\u5728\u8bbf\u95ee\u8fc7\u7a0b\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95ee<code>kiali</code>\u6765\u67e5\u770b\u6d41\u91cf\u7684\u53ef\u89c6\u5316\u7ed3\u679c\uff0c<code>kiali</code>\u4f1a\u901a\u8fc7\u52a8\u753b\u7684\u5f62\u5f0f\u5448\u73b0\u8bbf\u95ee\u6e05\u51b5 </p> <p><code>http://127.0.0.1:20001/kiali/console/graph/namespaces/?edges=noEdgeLabels&amp;graphType=versionedApp&amp;namespaces=default&amp;injectServiceNodes=true&amp;duration=60&amp;pi=10000&amp;layout=dagre&amp;unusedNodes=false</code></p> <p></p> <p>\u8fd9\u91cc\u7a0d\u4f5c\u56de\u987e\uff0c\u5728<code>Istio</code>\u4e2d\u90e8\u7f72\u4e00\u4e2a\u4e1a\u52a1\u5e94\u7528\u65f6\uff0c\u5efa\u8bae\u505a\u5230\u4ee5\u4e0b\u51e0\u70b9 </p> <ul> <li>\u4f7f\u7528<code>app</code>\u6807\u7b7e\u8868\u660e\u5e94\u7528\u8eab\u4efd\uff1b </li> <li>\u4f7f\u7528<code>version</code>\u6807\u7b7e\u8868\u660e\u5e94\u7528\u7248\u672c\uff1b </li> <li>\u521b\u5efa\u76ee\u6807\u89c4\u5219(DestinationRule)\uff1b </li> <li>\u521b\u5efa\u9ed8\u8ba4\u8def\u7531\u89c4\u5219(VirtualService)\u3002 </li> </ul> <p>\u9ed8\u8ba4\u8def\u7531\u9664\u4e86\u53ef\u4ee5\u4fdd\u8bc1\u5e94\u7528\u884c\u4e3a\u7684\u7a33\u5b9a\u6027\uff0c \u4e5f\u662f<code>Istio</code>\u7684\u4e00\u4e9b\u914d\u7f6e\u5bf9\u8c61\u7684\u6784\u5efa\u57fa\u7840\u3002</p> <p>\u56e0\u6b64\u548c\u65e5\u5e38\u7684<code>Dockerfile</code>\u3001 <code>Service</code>\u3001 <code>Deployment</code>\u7b49\u6e05\u5355\u6587\u4ef6\u4e00\u6837\u9ed8\u8ba4\u8def\u7531\u7684\u914d\u7f6e\u6e05\u5355\u5e94\u8be5\u6210\u4e3a\u670d\u52a1\u7f51\u683c\u73af\u5883\u4e0b\u7684\u5fc5\u8981\u90e8\u7f72\u5185\u5bb9 </p>"},{"location":"chap5/9Istio_http1/#3","title":"3\u3001 \u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb","text":"<p>\u4e0a\u4e00\u8282\u4e2d\u6709\u8fc7\u63d0\u793a<code>VirtualService</code>\u7684<code>http</code>\u5b57\u6bb5\u7684\u4e0b\u4e00\u7ea7\u6210\u5458\u662f\u4e00\u4e2a\u6570\u7ec4, \u4ee3\u8868\u591a\u6761\u8def\u7531\u89c4\u5219\u3002</p> <p>\u8fd9\u5f88\u81ea\u7136\u4f1a\u8ba9\u6211\u4eec\u60f3\u5230\uff1a\u5728\u591a\u7248\u672c\u5e76\u5b58\u7684\u60c5\u51b5\u4e0b\u662f\u5426\u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u7684\u7248\u672c\u8fdb\u884c\u6d41\u5740\u5206\u914d\u5462?</p> <p>\u8fd9\u79cd\u7279\u6027\u5728\u6d4b\u8bd5\u548c\u7248\u672c\u66f4\u65b0\u7684\u6e05\u51b5\u4e0b\u662f\u5f88\u6709\u7528\u7684\uff0c\u4f8b\u5982\u5728\u6211\u4eec\u7684\u65b0\u7248\u672c\u8fd8\u6ca1\u6709\u5b8c\u5168\u901a\u8fc7\u751f\u4ea7\u9a8c\u8bc1\u4e4b\u524d\u6211\u4eec\u53ea\u5e0c\u671b\u5df2\u627f\u62c5\u5c11\u90e8\u5206\u6d41\u91cf\uff0c \u6765\u89c2\u5bdf\u5b83\u5728\u751f\u4ea7\u73af\u5883\u7684\u7a33\u5b9a\u6027\u3002 </p> <p>\u56e0\u4e3a\u6837\u672c\u91cf\u592a\u5c11\uff0c\u6240\u4ee5\u6211\u4eec\u4f1a\u770b\u5230\u5728\u8c03\u7528\u8fc7\u7a0b\u4e2d\u8fd4\u56de\u7684\u5185\u5bb9\u8fd8\u662f\u968f\u673a\u5206\u5e03\u7684\uff0c \u56e0\u6b64\u8fd9\u91cc\u7528\u4e00\u4e2a<code>for</code>\u5faa\u73af\u8fdb\u884c\u591a\u6b21\u6d4b\u8bd5\uff0c\u67e5\u770b\u201cv1\u201d\u5728\u5176\u4e2d\u51fa\u73b0\u7684\u6b21\u6570\uff1a </p> <p>\u5148\u5220\u6389\u539f\u6765\u7684\u5efa\u7acb\u7684<code>VS</code>,\u7136\u540e\u8fdb\u5165<code>sleep pod</code>, \u53ef\u89c1\u5206\u914d\u6bd4\u7387\u63a5\u8fd1<code>50%</code></p> <pre><code>$ kubectl get vs\nNAME       GATEWAYS   HOSTS                                  AGE\nflaskapp              [flaskapp.default.svc.cluster.local]   22h\n\n$ kubectl delete vs flaskapp\nvirtualservice.networking.istio.io \"flaskapp\" deleted\n\n$ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash\n</code></pre> <pre><code>for i in `seq 10`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}'\n4\n\nfor i in `seq 100`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}'\n50\n\n\nfor i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}'\n151\n</code></pre> <p></p> <p>\u4e0b\u9762\u5b9a\u4e49\u4e00\u4e2a\u5206\u6d41\u89c4\u5219\uff1a\u5bf9<code>flaskpp</code>\u670d\u52a1\u7684\u8bbf\u95ee, \u6709<code>70\uff05</code>\u8fdb\u4eba<code>v1</code>\u7248\u672c, \u6709<code>30%</code>\u8fdb\u4eba<code>v2</code>\u7248\u672c. \u76f4\u63a5\u4fee\u6539<code>flaskapp.virtualservice.yaml</code> ,\u6dfb\u52a0\u5bf9<code>v2</code>\u7248\u672c\u7684\u76ee\u6807\u652f\u6301\uff0c \u5e76\u5b9a\u4e49\u5206\u914d\u6743\u91cd</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp \nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  http: \n  - route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v1\n      weight: 70\n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v2\n      weight: 30\n</code></pre> <p>\u4f7f\u7528<code>kubectl apply</code>\u547d\u4ee4\u63d0\u4ea4\u66f4\u65b0\u540e\u7684\u89c4\u5219\uff0c \u5e76\u6d4b\u8bd5\u5176\u5b9e\u9645\u7ed3\u679c</p> <pre><code>$ kubectl apply -f flaskapp.virtualservice.yaml \nvirtualservice.networking.istio.io/flaskapp created\n</code></pre> <p>\u8fdb\u4eba<code>Sleep Pod</code>\u8fde\u7eed\u5bf9<code>flaskapp</code>\u53d1\u51fa\u8bf7\u6c42\u5e76\u7edf\u8ba1\u8fd4\u56de\u7ed3\u679c </p> <pre><code>$ kubectl get vs\nNAME       GATEWAYS   HOSTS                                  AGE\nflaskapp              [flaskapp.default.svc.cluster.local]   2m39s\n\n$ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash\n\nfor i in `seq 10`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{pr\nint NF-1}'\n8\n\nbash-4.4# for i in `seq 100`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{p\nrint NF-1}'\n59\n\nbash-4.4# for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{p\nrint NF-1}'\n215\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa, \u968f\u82e5\u6d4b\u8bd5\u6b21\u6570\u7684\u589e\u52a0<code>v1</code>\u51fa\u73b0\u7684\u6b21\u6570\u4f1a\u9010\u6b65\u63a5\u8fd1\u6211\u4eec\u5b9a\u4e49\u7684\u5206\u914d\u6bd4\u7387\u3002</p> <p> </p> <p>\u56de\u5230\u73b0\u5b9e\u573a\u666f\u4e2d,\u5982\u679c\u6d4b\u8bd5\u7ed3\u679c\u4e50\u89c2, \u5219\u6211\u4eec\u4f1a\u5e0c\u671b\u4e3a\u65b0\u7248\u672c\u5206\u914d\u66f4\u591a\u7684\u6d41\u5740\u3002 \u8fd9\u65f6\u8be5\u5982\u4f55\u5904\u7406\uff1f </p> <p>\u5f88\u7b80\u5355\uff0c\u4fee\u6539\u8def\u7531\u5373\u53ef\u3002\u6211\u4eec\u7ee7\u7eed\u4fee\u6539\u5e76\u63d0\u4ea4<code>flaskapp.virtualservice.yaml</code>\u6587\u4ef6 </p> <p>\u4e0d\u540c\u7684\u662f\u8fd9\u6b21v1\u548cv2\u7684\u6bd4\u4f8b\u4ece<code>70: 30</code>\u4fee\u6539\u4e3a<code>10:90</code>, \u5728\u4fee\u6539\u4e4b\u540e\u91cd\u65b0\u8fdb<code>sleep pod</code>\u884c\u6d4b\u8bd5 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp \nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  http: \n  - route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v1\n      weight: 10\n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v2\n      weight: 90\n</code></pre> <pre><code>$ kubectl apply -f flaskapp.virtualservice.yaml \nvirtualservice.networking.istio.io/flaskapp configured\n\n$ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash\n\n$ bash-4.4# for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}'\n32\n</code></pre> <p> </p> <p>\u53ef\u4ee5\u770b\u5230\uff0c \u6211\u4eec\u5b9a\u4e49\u7684\u6d41\u867d\u5206\u914d\u539f\u5219\u5df2\u7ecf\u751f\u6548\u4e86</p> <p>\u66f4\u8fdb\u4e00\u6b65\uff0c \u5982\u679c<code>v2</code>\u7248\u672c\u6d4b\u8bd5\u6210\u529f,\u5219\u53ef\u4ee5\u518d\u6b21\u4fee\u6539\u5220\u9664<code>v1</code>\u7248\u672c\u7684\u8def\u7531\uff0c\u8ba9\u5168\u90e8\u6d41\u91cf\u90fd\u8fdb\u5165<code>v2</code>\u7248\u672c. </p> <p>\u4e5f\u5c31\u662f\u4f7f\u7528<code>v2</code>\u7248\u672c\u5b8c\u5168\u66ff\u4ee3\u539f\u6709\u7684<code>v1</code>\u7248\u672c, \u5b8c\u6210\u6700\u7ec8\u7684\u5347\u7ea7\u3002 </p> <p>\u7ee7\u7eed\u4fee\u6539<code>flaskapp.virtualservice.yaml</code>,\u5c06\u5176\u4e2d\u7684<code>http</code>\u90e8\u5206\u4fee\u6539\u4e3a\u4ec5\u5305\u542b<code>v2</code>\u7684\u5185\u5bb9</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata: \n  name: flaskapp \nspec: \n  hosts:\n  - flaskapp.default.svc.cluster.local\n  http: \n  - route: \n    - destination: \n        host: flaskapp.default.svc.cluster.local\n        subset: v2\n      weight: 100\n</code></pre> <pre><code>$ kubectl apply -f flaskapp.virtualservice.yaml \nvirtualservice.networking.istio.io/flaskapp configured\n</code></pre> <p>\u518d\u6b21\u6d4b\u8bd5\u6d41\u91cf\u5206\u914d\u60c5\u51b5</p> <pre><code>$ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash\n\nbash-4.4# for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}'\n0\n</code></pre> <p> </p> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u5df2\u7ecf\u5b8c\u5168\u6ca1\u6709\u6765\u81ea<code>v1</code>\u7248\u672c\u7684\u54cd\u5e94\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4\u6240\u6709\u6d41\u91cf\u90fd\u5df2\u7ecf\u6309\u8ba1\u5212\u8fdb\u4eba<code>v2</code>\u7248\u672c\uff0c <code>v1</code>\u7248\u672c\u53ef\u4ee5\u4e0b\u7ebf \u3002</p> <p>\u672c\u8282\u6709\u4ee5\u4e0b\u51e0\u70b9\u9700\u8981\u6ce8\u610f\u3002 </p> <ul> <li>\u6d41\u91cf\u5206\u914d\u662f\u6709\u6743\u91cd\u7684\uff0c\u5e76\u4e14\u6743\u91cd\u603b\u548c\u5fc5\u987b\u662f<code>100</code>\u3002 </li> <li>\u5982\u679c\u4e0d\u663e\u5f0f\u58f0\u660e\u6743\u91cd, \u5219\u5176\u9ed8\u8ba4\u503c\u4e3a<code>100</code>\u3002  </li> </ul> <p>\u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u7f51\u683c\u73b0\u6709\u7684\u8def\u7531\u89c4\u5219\u6216\u8005\u5176\u4ed6<code>Istio</code>\u5bf9\u8c61\u5462\uff1f\u65b9\u6cd5\u6709\u4ee5\u4e0b\u4e24\u79cd\u3002</p> <ol> <li>\u4f7f\u7528<code>kubectl get</code>. <code>Istio</code>\u7684\u8d44\u6e90\u548c<code>Kubernetes</code>\u5185\u7f6e\u7684\u8d44\u6e90\u4e00\u6837\uff0c\u90fd\u80fd\u901a\u8fc7<code>kubectl</code> \u83b7\u53d6\uff0e\u5e76\u80fd\u591f\u5c55\u793a\u5f53\u524d\u5b58\u5728\u7684<code>VirtualService</code>\uff1b\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>kubectl api-resources</code>\u547d\u4ee4\uff0c \u5217\u51fa\u5f53\u524d\u96c6\u7fa4\u652f\u6301\u7684\u6240\u6709\u5bf9\u8c61\u7c7b\u578b\u3002 </li> <li>\u4f7f\u7528<code>Kiali</code>\u3002\u9009\u62e9\u5de6\u4fa7\u83dc\u5355\u4e2d\u7684<code>Istio Config</code>\uff0c\u5982\u56fe\u6240\u793a\u4e3a\u6211\u4eec\u65b0\u5efa\u7684\u8def\u7531\u89c4\u5219\u548c\u76ee\u6807\u89c4\u5219\u3002 </li> </ol> <p> </p>"},{"location":"chap6/1Istio_install_docker/","title":"L1 Docker for Mac\u5b89\u88c5istio(k8s-1.10/istio-1.3)","text":"<p>\u4ece\u4eca\u5929\u8d77\uff0c\u6211\u4eec\u5c06\u63a8\u51fa\u4e00\u8d77\u5b66 istio \u7684\u7cfb\u5217\u8bfe\u7a0b\uff0c\u548c\u5927\u5bb6\u4e00\u8d77\u5b66\u4e60\u70ed\u95e8\u7684 Servie Mesh \u6280\u672f\uff1aistio\uff0c\u4eca\u5929\u7b2c\u4e00\u7bc7\u5185\u5bb9\uff1a\u5728 Docker for Mac \u4e0a\u9762\u5b89\u88c5 istio\u3002</p>"},{"location":"chap6/1Istio_install_docker/#1-docker-k8s","title":"1\u3001\u5b89\u88c5 docker \u548c k8s","text":"<p>\u6211\u8fd9\u91cc\u5b89\u88c5\u7684\u662f Stable \u7248\u672c\uff0c\u6700\u65b0\u7684\u7a33\u5b9a\u7248\u672c\u4e4b\u4e2d\u4e5f\u81ea\u5e26\u4e86 Kubernetes\uff0c\u4e4b\u524d\u7684\u7248\u672c\u4e2d\u9700\u8981 Edge \u7248\u672c\u624d\u884c\u3002</p> <p><code>docker for mac</code> \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u76f4\u63a5\u901a\u8fc7\u4e0b\u9762\u7684\u754c\u9762\u542f\u7528 Kubernetes \u5373\u53ef\u5b89\u88c5\u4e0a Kubernetes:</p> <p>Kubernetes -&gt; preference -&gt; Kubernetes</p> <p></p> <p>\u7531\u4e8e\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u9700\u8981\u62c9\u53d6\u4e00\u7cfb\u5217\u955c\u50cf\uff0c\u6240\u4ee5\u53ef\u80fd\u9700\u8981\u82b1\u8d39\u51e0\u5206\u949f\u65f6\u95f4\uff0c\u5f53\u53f3\u4e0b\u89d2\u51fa\u73b0\u6807\u8bc6 kubernetes is running \u65f6\u5219\u8bc1\u660e\u5b89\u88c5\u6210\u529f\u4e86\u3002</p> <p>\u5f53\u524d\u7248\u672c\u5b89\u88c5\u7684 Kubernetes \u7248\u672c\u662f v1.10.3\uff0c\u6d89\u53ca\u5230\u7684\u4e00\u4e9b\u955c\u50cf\u5982\u4e0b\uff1a</p> <pre><code>$ docker ../images/exp |grep k8s\nk8s.gcr.io/kubernetes-dashboard-amd64      v1.10.0             0dab2435c100        3 weeks ago         122MB\nk8s.gcr.io/kube-proxy-amd64                v1.10.3             4261d315109d        4 months ago        97.1MB\nk8s.gcr.io/kube-apiserver-amd64            v1.10.3             e03746fe22c3        4 months ago        225MB\nk8s.gcr.io/kube-controller-manager-amd64   v1.10.3             40c8d10b2d11        4 months ago        148MB\nk8s.gcr.io/kube-scheduler-amd64            v1.10.3             353b8f1d102e        4 months ago        50.4MB\nk8s.gcr.io/etcd-amd64                      3.1.12              52920ad46f5b        6 months ago        193MB\nk8s.gcr.io/k8s-dns-dnsmasq-nanny-amd64     1.14.8              c2ce1ffb51ed        8 months ago        41MB\nk8s.gcr.io/k8s-dns-sidecar-amd64           1.14.8              6f7f2dc7fab5        8 months ago        42.2MB\nk8s.gcr.io/k8s-dns-kube-dns-amd64          1.14.8              80cc5ea4b547        8 months ago        50.5MB\nk8s.gcr.io/pause-amd64                     3.1                 da86e6ba6ca1        9 months ago        742kB\n</code></pre> <p>\u53e6\u5916\uff0c\u7531\u4e8e\u5b89\u88c5 istio \u9700\u8981\u7528\u5230\u7684\u8d44\u6e90\u8f83\u591a\uff0c\u5efa\u8bae\u589e\u5927 CPU \u548c\u5185\u5b58\u7684\u4f7f\u7528\u9650\u5236\uff1a</p> <p></p>"},{"location":"chap6/1Istio_install_docker/#2-kubectl","title":"2\u3001\u5b89\u88c5 kubectl","text":"<p>Kubernetes \u96c6\u7fa4\u542f\u7528\u6210\u529f\u4e86\uff0c\u73b0\u5728\u8981\u53bb\u64cd\u4f5c\u8be5\u96c6\u7fa4\u7684\u8bdd\u5c31\u5f97\u5b89\u88c5\u4e00\u4e2a kubectl \u5de5\u5177\uff0c\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d kubectl \u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u5230\u672c\u5730\u76f4\u63a5\u4f7f\u7528\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Mac \u4e0a\u5b89\u88c5\u8f6f\u4ef6\u7684\u5e38\u7528\u5de5\u5177 Homebrew\uff1a</p> <pre><code>$ kubectl version\n\nClient Version: version.Info{Major:\"1\", Minor:\"13\", GitVersion:\"v1.13.2\", GitCommit:\"cff46ab41ff0bb44d8584413b598ad8360ec1def\", GitTreeState:\"clean\", BuildDate:\"2019-01-13T23:15:13Z\", GoVersion:\"go1.11.4\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\nServer Version: version.Info{Major:\"1\", Minor:\"10\", GitVersion:\"v1.10.11\", GitCommit:\"637c7e288581ee40ab4ca210618a89a555b6e7e9\", GitTreeState:\"clean\", BuildDate:\"2018-11-26T14:25:46Z\", GoVersion:\"go1.9.3\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n</code></pre> <p>\u6ce8\u610f docker for mac \u7684 k8s \u7684 context \u662f <code>docker-for-desktop</code>\uff0c\u5982\u679c\u76ee\u524d\u5df2\u6709\u5176\u4ed6\u96c6\u7fa4\u73af\u5883\uff0c\u9700\u8981\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u5207\u6362\uff1a</p> <pre><code>$  kubectl config get-contexts\nCURRENT   NAME                 CLUSTER                      AUTHINFO             NAMESPACE\n*         docker-for-desktop   docker-for-desktop-cluster   docker-for-desktop\n</code></pre> <p>If not  <code>docker-for-desktop</code></p> <pre><code>$ kubectl config use-context docker-for-desktop\n</code></pre> <p>kubectl \u5de5\u5177\u5b89\u88c5\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u6267\u884c\u547d\u4ee4\u9a8c\u8bc1\u4e0b\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u64cd\u4f5c\u96c6\u7fa4\uff1a</p> <pre><code>$ kubectl get ns\nNAME          STATUS   AGE\ndefault       Active   4d\ndocker        Active   4d\nkube-public   Active   4d\nkube-system   Active   4d\n\n$ kubectl get nodes\nNAME                 STATUS   ROLES    AGE   VERSION\ndocker-for-desktop   Ready    master   4d    v1.10.11\n\n$ kubectl get pods -n kube-system\nNAME                                         READY   STATUS    RESTARTS   AGE\netcd-docker-for-desktop                      1/1     Running   0          4d\nkube-apiserver-docker-for-desktop            1/1     Running   0          4d\nkube-controller-manager-docker-for-desktop   1/1     Running   0          4d\nkube-dns-86f4d74b45-57fmt                    3/3     Running   0          4d\nkube-proxy-zlc2n                             1/1     Running   0          4d\nkube-scheduler-docker-for-desktop            1/1     Running   0          4d\n</code></pre> <p>\u80fd\u591f\u6b63\u5e38\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u8bc1\u660e Kubernetes \u96c6\u7fa4\u4e00\u5207\u6b63\u5e38\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 kubectl \u5de5\u5177\u64cd\u4f5c\u96c6\u7fa4\uff0c\u8fd9\u4e00\u6b65\u975e\u5e38\u91cd\u8981\u3002</p>"},{"location":"chap6/1Istio_install_docker/#3-kubernetes-dashboard","title":"3\u3001\u5b89\u88c5 kubernetes dashboard","text":"<p><code>https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</code></p> <p>\u76f4\u63a5\u4e0b\u8f7d\u5b98\u65b9\u63a8\u8350\u7684 <code>dashboard yaml</code> \u6587\u4ef6\uff1a</p> <pre><code>$ wget https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml\n--2019-04-19 10:00:01--  https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml\nResolving raw.githubusercontent.com... 151.101.248.133\nConnecting to raw.githubusercontent.com|151.101.248.133|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 1454 (1.4K) [text/plain]\nSaving to: 'kubernetes-dashboard.yaml'\n\nkubernetes-dashboard.yaml          100%[===============================================================&gt;]   1.42K  --.-KB/s    in 0s\n\n2019-04-19 10:00:02 (53.3 MB/s) - 'kubernetes-dashboard.yaml' saved [4784]\n</code></pre> <p>\u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\uff0c\u6211\u4eec\u5c06 <code>kubernetes-dashboard.yaml</code> \u6587\u4ef6\u4e2d \u7684 <code>Service</code> \u6539\u6210 <code>NodePort</code> \u7c7b\u578b\u7684\u670d\u52a1\uff1a</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard-certs\n  namespace: kube-system\ntype: Opaque\n\n---\n...\n# ------------------- Dashboard Service ------------------- #\n\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard\n  namespace: kube-system\nspec:\n  ports:\n    - port: 443\n      targetPort: 8443\n  type: NodePort\n  selector:\n    k8s-app: kubernetes-dashboard\n</code></pre> <pre><code>$ kubectl create -f kubernetes-dashboard.yaml\n\n$ kubectl get pods -n kube-system\nNAME                                         READY   STATUS    RESTARTS   AGE\n...\nkubernetes-dashboard-669f9bbd46-6vlng        1/1     Running   0          59s\n</code></pre> <pre><code>$ kubectl get svc -n kube-system\nNAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE\nkube-dns               ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP   4d\nkubernetes-dashboard   NodePort    10.100.124.180   &lt;none&gt;        443:30771/TCP   20s\n</code></pre> <p>\u73b0\u5728\u76f4\u63a5\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee <code>https://localhost:30771</code> \u5373\u53ef\uff0c\u8bb0\u4f4f\u4e00\u5b9a\u8981\u52a0\u4e0a https\uff0c\u5728\u767b\u5f55\u9875\u9762\u76f4\u63a5\u8df3\u8fc7\u6743\u9650\u9a8c\u8bc1\u5373\u53ef\uff1a</p> <p></p> <p>How to get token from dashboard</p> <pre><code>$ kubectl get secret,sa,role,rolebinding,services,deployments -n kube-system | grep dashboard\nsecret/kubernetes-dashboard-certs                       Opaque                                0      7m\nsecret/kubernetes-dashboard-csrf                        Opaque                                1      7m\nsecret/kubernetes-dashboard-key-holder                  Opaque                                2      6m\nsecret/kubernetes-dashboard-token-sl5kb                 kubernetes.io/service-account-token   3      7m\n\nserviceaccount/kubernetes-dashboard                 1         7m\n\nrole.rbac.authorization.k8s.io/kubernetes-dashboard-minimal                     7m2s\n\nrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal                     7m2s\n\n\nservice/kubernetes-dashboard   NodePort    10.100.124.180   &lt;none&gt;        443:30771/TCP   7m\ndeployment.extensions/kubernetes-dashboard   1   \n</code></pre> <pre><code>$ kubectl describe secret  kubernetes-dashboard-token-sl5kb -n kube-system\nName:         kubernetes-dashboard-token-sl5kb\nNamespace:    kube-system\nLabels:       &lt;none&gt;\nAnnotations:  kubernetes.io/service-account.name: kubernetes-dashboard\n              kubernetes.io/service-account.uid: dc0660b1-6248-11e9-a3d8-025000000001\n\nType:  kubernetes.io/service-account-token\n\nData\n====\nnamespace:  11 bytes\ntoken:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1zbDVrYiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImRjMDY2MGIxLTYyNDgtMTFlOS1hM2Q4LTAyNTAwMDAwMDAwMSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.fttRDpKfmLY7oozOuwgYIGnm-WLre-RbpY5rM0qHTsihl7gNsOwUtlGwPHGfK7SQADlvTMElAVScdEUGg665HCrglQubl-DfVKEBGZiYcmjdi1E2fhp7cdsbL3hJpZi6iW126ykoH9q7q_EzNrLiUfnCGIaXlGGIHch1Y8xdnNjo5HpSwH7wknX9sWyi0dEI5LR5MYMQ1IiqqKqW5whC9Kr4RvD8h-h7SkuvymGydSEEQefIhTgjZhpP2wmmY__QKzz4JdykHu5a94lqu5CZWpDvoSHtCPooOKau71K8bUqAatG487ov31dmQxcP9TaWHFOnSyynJMGfv4Rlwbag1A\nca.crt:     1025 bytes\n</code></pre> <p>Put the token into the dashboard</p> <p></p>"},{"location":"chap6/1Istio_install_docker/#3-helm","title":"3\u3001\u5b89\u88c5 Helm","text":"<p><code>https://istio.io/docs/setup/kubernetes/install/helm/</code></p> <p>istio \u5b98\u65b9\u7ed9\u51fa\u4e86\u51e0\u79cd\u5b89\u88c5\u7684\u65b9\u5f0f\uff0c\u624b\u52a8\u901a\u8fc7 yaml \u6587\u4ef6\u53bb\u5b89\u88c5\u4e5f\u6bd4\u8f83\u65b9\u4fbf\uff0c\u4f46\u662f\u8fd8\u662f\u9700\u8981\u5fcd\u53d7\u955c\u50cf\u7ffb\u5899\u7684\u95ee\u9898\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u5b98\u65b9\u66f4\u52a0\u63a8\u8350\u7684 <code>Helm</code> \u65b9\u5f0f\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u800c\u4e14\u8be5\u65b9\u5f0f\u6d89\u53ca\u5230\u7684\u955c\u50cf\u90fd\u5728 <code>docker hub</code> \u4e0a\u9762\uff0c\u4e0d\u9700\u8981\u7ffb\u5899\u5c31\u53ef\u4ee5\u62c9\u53d6\u3002</p>"},{"location":"chap6/1Istio_install_docker/#3-1-helm","title":"3-1 \u9996\u5148\u5b89\u88c5 Helm \u5305\u7ba1\u5de5\u5177","text":"<p>\u901a\u8fc7 <code>Homebrew</code> \u5b89\u88c5 <code>Helm</code> \u7684\u5ba2\u6237\u7aef\uff1a</p> <pre><code>$ brew install kubernetes-helm\n...\n$ helm version\nClient: &amp;version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"}\nError: could not find tiller\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u9700\u8981\u521d\u59cb\u5316 <code>Helm</code> \u5bf9\u5e94\u7684\u670d\u52a1\u7aef\u7a0b\u5e8f <code>Tiller Server</code>\uff1a</p> <pre><code>$ helm init\nCreating /Users/jxi/.helm\nCreating /Users/jxi/.helm/repository\nCreating /Users/jxi/.helm/repository/cache\nCreating /Users/jxi/.helm/repository/local\nCreating /Users/jxi/.helm/plugins\nCreating /Users/jxi/.helm/starters\nCreating /Users/jxi/.helm/cache/archive\nCreating /Users/jxi/.helm/repository/repositories.yaml\nAdding stable repo with URL: https://kubernetes-charts.storage.googleapis.com\nAdding local repo with URL: http://127.0.0.1:8879/charts\n$HELM_HOME has been configured at /Users/jxi/.helm.\n\nTiller (the Helm server-side component) has been installed into your Kubernetes Cluster.\n\nPlease note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy.\nTo prevent this, run `helm init` with the --tiller-tls-verify flag.\nFor more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation\nHappy Helming!\n</code></pre> <p>\u53e6\u5916\u6211\u4eec\u8fd8\u9700\u8981\u4e3a <code>Tiller</code> \u521b\u5efa\u4e00\u4e2a <code>ServiceAccount</code>\uff0c\u8ba9\u4ed6\u6709\u6743\u9650\u53bb\u64cd\u4f5c\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e9b\u8d44\u6e90\uff1a</p> <pre><code>$ kubectl get pods -n kube-system\nNAME                                         READY   STATUS    RESTARTS   AGE\ntiller-deploy-78c6868dd6-bcpb5               1/1     Running   0          1m\n</code></pre> <p><code>tiller-rbac.yaml</code></p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: tiller\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: tiller\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n  - kind: ServiceAccount\n    name: tiller\n    namespace: kube-system\n</code></pre> <p>\u4fdd\u5b58\u4e3a <code>tiller-rbac.yaml</code> \u7136\u540e\u521b\u5efa\uff1a</p> <pre><code>$ kubectl apply -f tiller-rbac.yaml\nserviceaccount/tiller created\nclusterrolebinding.rbac.authorization.k8s.io/tiller created\n</code></pre> <pre><code>$ kubectl get sa,secret,role,rolebinding -n kube-system | grep tiller\nNAME                                 SECRETS   AGE\nserviceaccount/tiller                               1         1m\n\nsecret/tiller-token-9krvm                               kubernetes.io/service-account-token   3      1m\n</code></pre> <p>\u521b\u5efa\u4e86 <code>tiller</code> \u7684 <code>ServceAccount</code> \u540e\u8fd8\u6ca1\u5b8c\uff0c\u56e0\u4e3a\u6211\u4eec\u7684 <code>Tiller</code> \u4e4b\u524d\u5df2\u7ecf\u5c31\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u800c\u4e14\u662f\u6ca1\u6709\u6307\u5b9a <code>ServiceAccount</code> \u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u7ed9 <code>Tiller</code> \u6253\u4e0a\u4e00\u4e2a <code>ServiceAccount</code> \u7684\u8865\u4e01\uff1a</p> <pre><code>$ kubectl patch deploy --namespace kube-system tiller-deploy -p '{\"spec\":{\"template\":{\"spec\":{\"serviceAccount\":\"tiller\"}}}}'\ndeployment.extensions/tiller-deploy patched\n</code></pre> <p>\u81f3\u6b64, Helm \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u914d\u7f6e\u5b8c\u6210\u4e86\uff1a</p> <pre><code>$ helm version\nClient: &amp;version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"}\nServer: &amp;version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"}\n</code></pre>"},{"location":"chap6/1Istio_install_docker/#4-istio","title":"4\u3001\u5b89\u88c5 istio","text":"<p>\u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684 istio\uff1ahttps://github.com/istio/istio/releases/\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528<code>istio-1.1.3-osx.tar.gz</code>\uff0c\u7136\u540e\u89e3\u538b\uff0c\u5c06 <code>bin/</code> \u4e2d\u7684 <code>istioctl</code> \u53ef\u6267\u884c\u6587\u4ef6\u62f7\u8d1d\u5230 <code>$PATH</code> \u5305\u542b\u7684\u76ee\u5f55\u4e2d\u3002</p> <pre><code>$ echo  $PATH\n/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin\n...\n$ cd \n$ ls -la | grep istio\n-rwxr-xr-x@   1 jxi   660531311  62307200 Apr 13 06:36 istioctl\n</code></pre> <p>\u9a8c\u8bc1\u662f\u5426\u751f\u6548\uff1a</p> <pre><code>$ istioctl version\nversion.BuildInfo{Version:\"1.1.3\", GitRevision:\"d19179769183541c5db473ae8d062ca899abb3be\", User:\"root\", Host:\"fbd493e1-5d72-11e9-b00d-0a580a2c0205\", GolangVersion:\"go1.10.4\", DockerHub:\"docker.io/istio\", BuildStatus:\"Clean\", GitTag:\"1.1.2-56-gd191797\"}\n</code></pre>"},{"location":"chap6/1Istio_install_docker/#4-1-helm","title":"4-1 \u7136\u540e\u4f7f\u7528 helm \u547d\u4ee4\u76f4\u63a5\u5b89\u88c5","text":"<pre><code>cd /Users/jxi/Devops/bookinfo/istio-1.1.3\n</code></pre> <p><code>https://istio.io/docs/setup/kubernetes/install/helm/</code></p> <p>Option 2:</p> <p>Install the istio-init chart to bootstrap all the Istio\u2019s CRDs</p> <pre><code>$  helm install install/kubernetes/helm/istio-init --name istio-init --namespace istio-system\nNAME:   istio-init\nLAST DEPLOYED: Fri Apr 19 11:19:08 2019\nNAMESPACE: istio-system\nSTATUS: DEPLOYED\n\nRESOURCES:\n==&gt; v1/ClusterRole\nNAME                     AGE\nistio-init-istio-system  0s\n\n==&gt; v1/ClusterRoleBinding\nNAME                                        AGE\nistio-init-admin-role-binding-istio-system  0s\n\n==&gt; v1/ConfigMap\nNAME          DATA  AGE\nistio-crd-10  1     0s\nistio-crd-11  1     0s\n\n==&gt; v1/Job\nNAME               COMPLETIONS  DURATION  AGE\nistio-init-crd-10  0/1          0s        0s\nistio-init-crd-11  0/1          0s        0s\n\n==&gt; v1/Pod(related)\nNAME                     READY  STATUS             RESTARTS  AGE\nistio-init-crd-10-p84cq  0/1    ContainerCreating  0         0s\nistio-init-crd-11-g9vfx  0/1    ContainerCreating  0         0s\n\n==&gt; v1/ServiceAccount\nNAME                        SECRETS  AGE\nistio-init-service-account  1        0s\n\n$ kubectl get pods -n istio-system\nNAME                      READY   STATUS      RESTARTS   AGE\nistio-init-crd-10-p84cq   0/1     Completed   0          6s\nistio-init-crd-11-g9vfx   0/1     Completed   0          6s\n\n$ kubectl get crds | grep 'istio.io\\|certmanager.k8s.io' | wc -l\n53\n</code></pre> <p>\u7136\u540e\u4f7f\u7528 helm \u547d\u4ee4\u76f4\u63a5\u5b89\u88c5\uff1a</p> <pre><code>$ helm install install/kubernetes/helm/istio --name istio --namespace istio-system --set tracing.enabled=true --set kiali.enabled=true --set grafana.enabled=true\nNAME:   istio\nLAST DEPLOYED: Fri Apr 19 11:21:24 2019\nNAMESPACE: istio-system\nSTATUS: DEPLOYED\n\nRESOURCES:\n==&gt; v1/ClusterRole\nNAME                                     AGE\nistio-citadel-istio-system               22s\nistio-galley-istio-system                23s\nistio-grafana-post-install-istio-system  23s\nistio-ingressgateway-istio-system        23s\nistio-mixer-istio-system                 23s\nistio-pilot-istio-system                 23s\nistio-reader                             22s\nistio-sidecar-injector-istio-system      22s\nkiali                                    23s\nprometheus-istio-system                  22s\n\n==&gt; v1/ClusterRoleBinding\nNAME                                                    AGE\nistio-citadel-istio-system                              22s\nistio-galley-admin-role-binding-istio-system            22s\nistio-grafana-post-install-role-binding-istio-system    22s\nistio-ingressgateway-istio-system                       22s\nistio-kiali-admin-role-binding-istio-system             22s\nistio-mixer-admin-role-binding-istio-system             22s\nistio-multi                                             22s\nistio-pilot-istio-system                                22s\nistio-sidecar-injector-admin-role-binding-istio-system  22s\nprometheus-istio-system                                 22s\n\n==&gt; v1/ConfigMap\nNAME                                                                DATA  AGE\nistio                                                               2     23s\nistio-galley-configuration                                          1     23s\nistio-grafana                                                       2     23s\nistio-grafana-configuration-dashboards-galley-dashboard             1     23s\nistio-grafana-configuration-dashboards-istio-mesh-dashboard         1     23s\nistio-grafana-configuration-dashboards-istio-performance-dashboard  1     23s\nistio-grafana-configuration-dashboards-istio-service-dashboard      1     23s\nistio-grafana-configuration-dashboards-istio-workload-dashboard     1     23s\nistio-grafana-configuration-dashboards-mixer-dashboard              1     23s\nistio-grafana-configuration-dashboards-pilot-dashboard              1     23s\nistio-grafana-custom-resources                                      2     23s\nistio-security-custom-resources                                     2     23s\nistio-sidecar-injector                                              1     23s\nkiali                                                               1     23s\nprometheus                                                          1     23s\n\n==&gt; v1/Pod(related)\nNAME                                     READY  STATUS             RESTARTS  AGE\ngrafana-7f8d4cdd9-btb24                  0/1    ContainerCreating  0         22s\nistio-citadel-f55646d75-cq7fn            0/1    ContainerCreating  0         22s\nistio-galley-76c4fcb6d5-f546l            0/1    ContainerCreating  0         22s\nistio-ingressgateway-5c94457876-txblr    0/1    ContainerCreating  0         22s\nistio-pilot-77f7d5b9f-lrx5r              0/2    ContainerCreating  0         22s\nistio-policy-56d88f4f86-464zx            0/2    ContainerCreating  0         22s\nistio-sidecar-injector-5cb4cfdbc8-cr4nd  0/1    ContainerCreating  0         22s\nistio-telemetry-78967c7b9b-kdkn4         0/2    ContainerCreating  0         22s\nistio-tracing-79c7955c98-6jtsg           0/1    ContainerCreating  0         21s\nkiali-7677969794-kvsxs                   1/1    Running            0         22s\nprometheus-5b59764bb9-qvqgj              0/1    Init:0/1           0         22s\n\n==&gt; v1/Role\nNAME                      AGE\nistio-ingressgateway-sds  22s\n\n==&gt; v1/RoleBinding\nNAME                      AGE\nistio-ingressgateway-sds  22s\n\n==&gt; v1/Service\nNAME                    TYPE          CLUSTER-IP      EXTERNAL-IP  PORT(S)                                                                                                                                     AGE\ngrafana                 ClusterIP     10.111.237.238  &lt;none&gt;       3000/TCP                                                                                                                                    22s\nistio-citadel           ClusterIP     10.96.74.209    &lt;none&gt;       8060/TCP,15014/TCP                                                                                                                          22s\nistio-galley            ClusterIP     10.105.161.220  &lt;none&gt;       443/TCP,15014/TCP,9901/TCP                                                                                                                  22s\nistio-ingressgateway    LoadBalancer  10.99.227.74    localhost    15020:32340/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30713/TCP,15030:32699/TCP,15031:30774/TCP,15032:31966/TCP,15443:32409/TCP  22s\nistio-pilot             ClusterIP     10.98.254.224   &lt;none&gt;       15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                      22s\nistio-policy            ClusterIP     10.110.112.240  &lt;none&gt;       9091/TCP,15004/TCP,15014/TCP                                                                                                                22s\nistio-sidecar-injector  ClusterIP     10.100.107.179  &lt;none&gt;       443/TCP                                                                                                                                     22s\nistio-telemetry         ClusterIP     10.102.207.93   &lt;none&gt;       9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                      22s\njaeger-agent            ClusterIP     None            &lt;none&gt;       5775/UDP,6831/UDP,6832/UDP                                                                                                                  22s\njaeger-collector        ClusterIP     10.98.27.207    &lt;none&gt;       14267/TCP,14268/TCP                                                                                                                         22s\njaeger-query            ClusterIP     10.96.49.6      &lt;none&gt;       16686/TCP                                                                                                                                   22s\nkiali                   ClusterIP     10.96.89.238    &lt;none&gt;       20001/TCP                                                                                                                                   22s\nprometheus              ClusterIP     10.110.170.226  &lt;none&gt;       9090/TCP                                                                                                                                    22s\ntracing                 ClusterIP     10.106.179.73   &lt;none&gt;       80/TCP                                                                                                                                      22s\nzipkin                  ClusterIP     10.108.211.139  &lt;none&gt;       9411/TCP                                                                                                                                    22s\n\n==&gt; v1/ServiceAccount\nNAME                                    SECRETS  AGE\nistio-citadel-service-account           1        23s\nistio-galley-service-account            1        23s\nistio-grafana-post-install-account      1        23s\nistio-ingressgateway-service-account    1        23s\nistio-mixer-service-account             1        23s\nistio-multi                             1        23s\nistio-pilot-service-account             1        23s\nistio-security-post-install-account     1        23s\nistio-sidecar-injector-service-account  1        23s\nkiali-service-account                   1        23s\nprometheus                              1        23s\n\n==&gt; v1alpha2/attributemanifest\nNAME        AGE\nistioproxy  22s\nkubernetes  22s\n\n==&gt; v1alpha2/handler\nNAME           AGE\nkubernetesenv  22s\nprometheus     22s\n\n==&gt; v1alpha2/kubernetes\nNAME        AGE\nattributes  22s\n\n==&gt; v1alpha2/metric\nNAME                  AGE\nrequestcount          22s\nrequestduration       22s\nrequestsize           22s\nresponsesize          22s\ntcpbytereceived       22s\ntcpbytesent           22s\ntcpconnectionsclosed  22s\ntcpconnectionsopened  22s\n\n==&gt; v1alpha2/rule\nNAME                     AGE\nkubeattrgenrulerule      22s\npromhttp                 22s\npromtcp                  22s\npromtcpconnectionclosed  22s\npromtcpconnectionopen    22s\ntcpkubeattrgenrulerule   22s\n\n==&gt; v1alpha3/DestinationRule\nNAME             AGE\nistio-policy     22s\nistio-telemetry  22s\n\n==&gt; v1beta1/ClusterRole\nNAME                                      AGE\nistio-security-post-install-istio-system  22s\n\n==&gt; v1beta1/ClusterRoleBinding\nNAME                                                   AGE\nistio-security-post-install-role-binding-istio-system  22s\n\n==&gt; v1beta1/Deployment\nNAME                    READY  UP-TO-DATE  AVAILABLE  AGE\ngrafana                 0/1    1           0          22s\nistio-citadel           0/1    1           0          22s\nistio-galley            0/1    1           0          22s\nistio-ingressgateway    0/1    1           0          22s\nistio-pilot             0/1    1           0          22s\nistio-policy            0/1    1           0          22s\nistio-sidecar-injector  0/1    1           0          22s\nistio-telemetry         0/1    1           0          22s\nistio-tracing           0/1    1           0          22s\nkiali                   1/1    1           1          22s\nprometheus              0/1    1           0          22s\n\n==&gt; v1beta1/MutatingWebhookConfiguration\nNAME                    AGE\nistio-sidecar-injector  22s\n\n==&gt; v1beta1/PodDisruptionBudget\nNAME                  MIN AVAILABLE  MAX UNAVAILABLE  ALLOWED DISRUPTIONS  AGE\nistio-galley          1              N/A              0                    23s\nistio-ingressgateway  1              N/A              0                    23s\nistio-pilot           1              N/A              0                    23s\nistio-policy          1              N/A              0                    23s\nistio-telemetry       1              N/A              0                    23s\n\n==&gt; v2beta1/HorizontalPodAutoscaler\nNAME                  REFERENCE                        TARGETS        MINPODS  MAXPODS  REPLICAS  AGE\nistio-ingressgateway  Deployment/istio-ingressgateway  &lt;unknown&gt;/80%  1        5        0         22s\nistio-pilot           Deployment/istio-pilot           &lt;unknown&gt;/80%  1        5        0         22s\nistio-policy          Deployment/istio-policy          &lt;unknown&gt;/80%  1        5        0         22s\nistio-telemetry       Deployment/istio-telemetry       &lt;unknown&gt;/80%  1        5        0         22s\n\n\nNOTES:\nThank you for installing istio.\n\nYour release is named istio.\n\nTo get started running application with Istio, execute the following steps:\n1. Label namespace that application object will be deployed to by the following command (take default namespace as an example)\n\n$ kubectl label namespace default istio-injection=enabled\n$ kubectl get namespace -L istio-injection\n\n2. Deploy your applications\n\n$ kubectl apply -f &lt;your-application&gt;.yaml\n\nFor more information on running Istio, visit:\nhttps://istio.io/\n</code></pre> <p>\u9ed8\u8ba4 tracing \u3001kiali \u3001grafana \u5e76\u4e0d\u4f1a\u5f00\u542f\uff0c\u8fd9\u91cc\u9700\u8981\u5728\u5b89\u88c5\u65f6\u624b\u52a8 \u2013set xxx.enabled=true \u8fdb\u884c\u5f00\u542f\u3002\u914d\u7f6e\u8bf4\u660e\u53ef\u67e5\u770b\u6587\u6863\uff1a<code>install/kubernetes/helm/istio/README.md</code></p> <p>\u7531\u4e8e\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u6d89\u53ca\u5230\u7684\u955c\u50cf\u6bd4\u8f83\u591a\uff0c\u7136\u540e\u9694\u4e00\u4f1a\u513f\u518d\u67e5\u770b Kubernets \u4e2d\u7684 istio-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a:</p> <pre><code>$ kubectl get pods -n istio-system\nNAME                                      READY   STATUS      RESTARTS   AGE\ngrafana-7f8d4cdd9-btb24                   1/1     Running     0          4m\nistio-citadel-f55646d75-cq7fn             1/1     Running     0          4m\nistio-galley-76c4fcb6d5-f546l             1/1     Running     0          4m\nistio-ingressgateway-5c94457876-txblr     1/1     Running     0          4m\nistio-init-crd-10-p84cq                   0/1     Completed   0          6m\nistio-init-crd-11-g9vfx                   0/1     Completed   0          6m\nistio-pilot-77f7d5b9f-lrx5r               2/2     Running     0          4m\nistio-policy-56d88f4f86-464zx             2/2     Running     3          4m\nistio-sidecar-injector-5cb4cfdbc8-cr4nd   1/1     Running     0          4m\nistio-telemetry-78967c7b9b-kdkn4          2/2     Running     4          4m\nistio-tracing-79c7955c98-6jtsg            1/1     Running     0          4m\nkiali-7677969794-kvsxs                    1/1     Running     0          4m\nprometheus-5b59764bb9-qvqgj               1/1     Running     0          4m\n\n\n$ kubectl get svc -n istio-system\nNAME                     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                                                      AGE\ngrafana                  ClusterIP      10.111.237.238   &lt;none&gt;        3000/TCP                                                                                                                                     5m\nistio-citadel            ClusterIP      10.96.74.209     &lt;none&gt;        8060/TCP,15014/TCP                                                                                                                           5m\nistio-galley             ClusterIP      10.105.161.220   &lt;none&gt;        443/TCP,15014/TCP,9901/TCP                                                                                                                   5m\nistio-ingressgateway     LoadBalancer   10.99.227.74     localhost     15020:32340/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30713/TCP,15030:32699/TCP,15031:30774/TCP,15032:31966/TCP,15443:32409/TCP   5m\nistio-pilot              ClusterIP      10.98.254.224    &lt;none&gt;        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       5m\nistio-policy             ClusterIP      10.110.112.240   &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP                                                                                                                 5m\nistio-sidecar-injector   ClusterIP      10.100.107.179   &lt;none&gt;        443/TCP                                                                                                                                      5m\nistio-telemetry          ClusterIP      10.102.207.93    &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       5m\njaeger-agent             ClusterIP      None             &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP                                                                                                                   5m\njaeger-collector         ClusterIP      10.98.27.207     &lt;none&gt;        14267/TCP,14268/TCP                                                                                                                          5m\njaeger-query             ClusterIP      10.96.49.6       &lt;none&gt;        16686/TCP                                                                                                                                    5m\nkiali                    ClusterIP      10.96.89.238     &lt;none&gt;        20001/TCP                                                                                                                                    5m\nprometheus               ClusterIP      10.110.170.226   &lt;none&gt;        9090/TCP                                                                                                                                     5m\ntracing                  ClusterIP      10.106.179.73    &lt;none&gt;        80/TCP                                                                                                                                       5m\nzipkin                   ClusterIP      10.108.211.139   &lt;none&gt;        9411/TCP\n</code></pre> <p>\u5230\u8fd9\u91cc istio \u5c31\u7b97\u90e8\u7f72\u6210\u529f\u4e86\u3002</p> <p></p>"},{"location":"chap6/1Istio_install_docker/#5","title":"5\u3001\u5b89\u88c5\u793a\u4f8b","text":"<p>\u76ee\u524d\u5927\u90e8\u5206 <code>istio</code> \u7684\u4f7f\u7528\u793a\u4f8b\u90fd\u662f\u4f7f\u7528\u7684\u5b98\u65b9\u7684 <code>Bookinfo</code> \u5e94\u7528\u793a\u4f8b:</p> <p></p> <p>\u8fd9\u4e2a\u793a\u4f8b\u662f\u4e00\u4e2a\u591a\u8bed\u8a00\u5f00\u53d1\u7684\u5fae\u670d\u52a1\u5e94\u7528\u3002\u9996\u5148\u6709\u4e00\u4e2a python \u5b9e\u73b0\u7684 <code>ProductPage</code> \u5165\u53e3\u5e94\u7528\u5c55\u793a\u4e66\u7c4d\u7684\u8be6\u7ec6\u4fe1\u606f\u548c\u8bc4\u4ef7\uff0c\u5b83\u4f1a\u8c03\u7528 <code>Ruby</code> \u5b9e\u73b0\u7684 <code>Detail</code> \u5e94\u7528\u83b7\u53d6\u4e66\u7c4d\u8be6\u60c5\uff0c\u540c\u65f6\u8c03\u7528 <code>Java</code> \u5b9e\u73b0\u7684\u8bc4\u4ef7\u5e94\u7528\u83b7\u53d6\u4e66\u7c4d\u7684\u8bc4\u4ef7\u3002</p> <p>\u4e0a\u56fe\u5c55\u793a\u4e86\u4f7f\u7528 <code>istio</code> \u540e\uff0c\u6574\u4e2a\u5e94\u7528\u5b9e\u9645\u7684\u7ed3\u6784\u3002\u6240\u6709\u7684\u5fae\u670d\u52a1\u90fd\u548c\u4e00\u4e2a <code>Envoy sidecar</code> \u5c01\u88c5\u5230\u4e00\u8d77\uff0c<code>sidecar</code> \u62e6\u622a\u6240\u6709\u5230\u8fbe\u548c\u79bb\u5f00\u670d\u52a1\u7684\u8bf7\u6c42\u3002</p> <p>\u9996\u5148\u8fdb\u5165\u89e3\u538b\u7684<code>istio</code>\u76ee\u5f55\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)\nservice/details created\ndeployment.extensions/details-v1 created\nservice/ratings created\ndeployment.extensions/ratings-v1 created\nservice/reviews created\ndeployment.extensions/reviews-v1 created\ndeployment.extensions/reviews-v2 created\ndeployment.extensions/reviews-v3 created\nservice/productpage created\ndeployment.extensions/productpage-v1 created\n</code></pre> <ul> <li>\u5176\u4e2d <code>bookinfo.yaml</code> \u5c31\u662f\u666e\u901a\u7684 k8s \u7684 <code>Deployment</code> \u548c <code>Service</code> \u7684 yaml \u6587\u4ef6\uff0c</li> <li>\u800c <code>istioctl kube-inject</code> \u4f1a\u5728\u8fd9\u4e2a\u6587\u4ef6\u7684\u57fa\u7840\u4e0a\u5411\u5176\u4e2d\u7684 <code>Deployment</code> \u8ffd\u52a0\u5185\u5bb9\uff0c\u901a\u5e38\u4f1a\u8ffd\u52a0\u4e00\u4e2a <code>initContainer(image:docker.io/istio/proxy_init)</code> \u4f5c\u4e3a <code>sidecar</code> \u7684\u5f62\u5f0f\u4e0e\u5e94\u7528\u7684\u5bb9\u5668\u8fd0\u884c\u5728\u540c\u4e00\u4e2a pod \u4e2d\u3002</li> </ul> <p>\u8fc7\u4e00\u4f1a\u513f\u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b <code>service</code> \u548c <code>pod</code> \u542f\u52a8:</p> <pre><code>$ kubectl get po\nNAME                              READY   STATUS    RESTARTS   AGE\ndetails-v1-7988597495-mvh8s       2/2     Running   0          2m\nproductpage-v1-5447c894b9-m89r7   2/2     Running   0          2m\nratings-v1-5cfbb7d4c5-5l6fl       2/2     Running   0          2m\nreviews-v1-b65dfcc76-9tgtt        2/2     Running   0          2m\nreviews-v2-5dd8bf9bcc-ql2b8       2/2     Running   0          2m\nreviews-v3-7bd5bb9786-tzbtz       2/2     Running   0          2m\n\n\n$ kubectl get svc\nNAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\ndetails       ClusterIP   10.105.227.220   &lt;none&gt;        9080/TCP   2m\nkubernetes    ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    4d\nproductpage   ClusterIP   10.108.78.109    &lt;none&gt;        9080/TCP   2m\nratings       ClusterIP   10.109.154.91    &lt;none&gt;        9080/TCP   2m\nreviews       ClusterIP   10.99.40.241     &lt;none&gt;        9080/TCP   2m\n</code></pre> <p>\u73b0\u5728\u5e94\u7528\u7684\u670d\u52a1\u90fd\u90e8\u7f72\u6210\u529f\u5e76\u542f\u52a8\u4e86\uff0c\u73b0\u5728\u9700\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\uff0c\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a <code>istio gateway</code>\u3002 </p>"},{"location":"chap6/1Istio_install_docker/#gateway-k8s-ingress-controller-ingress","title":"<code>gateway</code> \u76f8\u5f53\u4e8e k8s \u7684 <code>ingress controller</code> \u548c <code>ingress</code>\u3002","text":""},{"location":"chap6/1Istio_install_docker/#httptcp-load-balancer-ingress-trafic","title":"\u5b83\u4e3a <code>HTTP/TCP</code> \u6d41\u91cf\u914d\u7f6e <code>load balancer</code>\uff0c\u901a\u5e38\u5728\u670d\u52a1\u7f51\u683c\u8fb9\u7f18\u4f5c\u4e3a\u5e94\u7528\u7684 <code>ingress trafic</code>\u7ba1\u7406\u3002","text":"<p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a gateway:</p> <pre><code>$  kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml\ngateway.networking.istio.io/bookinfo-gateway created\nvirtualservice.networking.istio.io/bookinfo created\n</code></pre> <p>\u9a8c\u8bc1 gateway \u662f\u5426\u542f\u52a8\u6210\u529f:</p> <pre><code>$ istioctl get gateway\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nGATEWAY NAME       HOSTS     NAMESPACE   AGE\nbookinfo-gateway   *         default     12s\n\n$ kubectl get gateway\nNAME               CREATED AT\nbookinfo-gateway   38s\n</code></pre> <p>\u5b98\u65b9\u6587\u6863\u4e2d\u540e\u9762\u8fd8\u4f1a\u53bb\u83b7\u53d6 ingress \u7684 ip \u548c\u7aef\u53e3\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 <code>docker for mac</code> \u5b9e\u9645\u4e0a\u4e0d\u9700\u8981\u4e86\uff0c\u5728 <code>service</code> \u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u8fd9\u6837\u7684\u4e00\u6761 <code>service</code> \u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get service -n istio-system\nNAME                     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)\nistio-ingressgateway     LoadBalancer   10.99.227.74     localhost     15020:32340/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30713/TCP,15030:32699/TCP,15031:30774/TCP,15032:31966/TCP,15443:32409/TCP   20m\n</code></pre> <p>\u8fd9\u91cc\u4f7f\u7528\u7684\u662f LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u5b9e\u9645\u4e0a\u662f\u7528\u6765\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\uff0c\u5982\u679c\u6211\u4eec\u6ca1\u6709\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\u8bdd\uff0c\u53ef\u4ee5\u5c06\u8fd9\u91cc\u7c7b\u578b\u6539\u6210 <code>NodePort</code>\uff0c\u4f46\u662f\u8fd9\u6837\u6211\u4eec\u8981\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u5c31\u5f97\u52a0\u4e0a <code>nodePort</code> \u7aef\u53e3\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u5176\u5b9e\u76f4\u63a5\u4f7f\u7528 <code>localhost</code> \u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 <code>Bookinfo</code>\uff0c\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u5730\u5740\uff1a<code>http://localhost/productpage</code> \u5373\u53ef</p> <p></p> <p>\u5237\u65b0\u9875\u9762\u53ef\u4ee5\u770b\u5230 Book Reviews \u53d1\u751f\u4e86\u6539\u53d8\uff0c\u56e0\u4e3a\u8c03\u7528\u5230\u4e86\u4e0d\u540c\u7684 Reviews\u670d\u52a1\uff1a</p> <p></p> <p></p>"},{"location":"chap6/2BookInfo_1/","title":"L2 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u670d\u52a1\u7248\u672c/\u57fa\u4e8e\u6743\u91cd/\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9)","text":"<p>\u5728\u524d\u9762\u6211\u4eec\u6210\u529f\u642d\u5efa\u5e76\u90e8\u7f72\u4e86<code>istio</code>\u53ca\u5176\u5176 <code>Bookinfo</code> \u793a\u4f8b\u5e94\u7528\uff1a</p> <p></p> <p>\u76ee\u524d\u642d\u5efa <code>Bookinfo</code> \u5e94\u7528\u6211\u4eec\u53ea\u7528\u5230\u4e86\u4e0b\u9762\u4e24\u4e2a\u8d44\u6e90\u6587\u4ef6\uff1a</p> <pre><code>samples/bookinfo/platform/kube/bookinfo.yaml\nsamples/bookinfo/networking/bookinfo-gateway.yaml\n</code></pre> <ul> <li> <p>\u524d\u8005\u5c31\u662f\u901a\u5e38\u7684<code>k8s</code>\u5b9a\u4e49\u7684 <code>Deployment</code> \u548c <code>Service</code> \u7684 <code>yaml</code> \u6587\u4ef6\uff0c\u53ea\u662f\u5728\u90e8\u7f72\u65f6\u4f7f\u7528<code>istioctl kube-inject</code>\u5bf9\u8fd9\u4e2a\u6587\u4ef6\u5b9a\u4e49\u7684 <code>pod</code> \u6ce8\u5165\u4e86 <code>sidecar</code> \u4ee3\u7406.</p> </li> <li> <p>\u540e\u8005\u5b9a\u4e49\u4e86\u8fd9\u4e2a\u5e94\u7528\u7684\u5916\u90e8\u8bbf\u95ee\u5165\u53e3 <code>gateway</code>\uff0c\u4ee5\u53ca\u5e94\u7528\u5185\u90e8 <code>productpage</code> \u670d\u52a1\u7684<code>VirtualService</code>\u89c4\u5219\uff0c\u800c\u5176\u4ed6\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fd8\u6ca1\u6709\u88ab\u5b9a\u4e49\u3002</p> </li> </ul> <pre><code>$ istioctl --help\nIstio configuration command line utility for service operators to\ndebug and diagnose their Istio mesh.\n\nUsage:\n  istioctl [command]\n\nAvailable Commands:\n  authn          Interact with Istio authentication policies\n  deregister     De-registers a service instance\n  experimental   Experimental commands that may be modified or deprecated\n  help           Help about any command\n  kube-inject    Inject Envoy sidecar into Kubernetes pod resources\n  proxy-config   Retrieve information about proxy configuration from Envoy [kube only]\n  proxy-status   Retrieves the synchronization status of each Envoy in the mesh [kube only]\n  register       Registers a service instance (e.g. VM) joining the mesh\n  validate       Validate Istio policy and rules\n  version        Prints out build version information\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684 <code>gateway</code> :</p> <pre><code>$ kubectl get gateway --all-namespaces\nNAMESPACE   NAME               CREATED AT\ndefault     bookinfo-gateway   4h\n\n$ istioctl get gateway\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nGATEWAY NAME       HOSTS     NAMESPACE   AGE\nbookinfo-gateway   *         default     4h\n</code></pre> <pre><code>$ kubectl get virtualservices\nNAME       CREATED AT\nbookinfo   4h\n</code></pre> <p>\u73b0\u5728\u8bbf\u95ee\u5e94\u7528\u754c\u9762\u5e76\u5237\u65b0\uff0c\u4f1a\u770b\u5230 <code>Reviews</code> \u6709\u65f6\u4e0d\u4f1a\u663e\u793a\u8bc4\u5206\uff0c\u6709\u65f6\u5019\u4f1a\u663e\u793a\u4e0d\u540c\u6837\u5f0f\u7684\u8bc4\u5206\uff0c\u56e0\u4e3a\u540e\u9762\u6709<code>3</code>\u4e2a\u4e0d\u540c\u7684<code>Reviews</code> \u670d\u52a1\u7248\u672c\uff0c\u800c\u6ca1\u6709\u914d\u7f6e\u8be5\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219<code>route rule</code>\u7684\u60c5\u51b5\u4e0b\uff0c\u8be5\u670d\u52a1\u7684\u51e0\u4e2a\u5b9e\u4f8b\u4f1a\u88ab\u968f\u673a\u8bbf\u95ee\u5230\uff0c\u6709\u7684\u7248\u672c\u670d\u52a1\u4f1a\u8fdb\u4e00\u6b65\u8c03\u7528 <code>Ratings</code> \u670d\u52a1\uff0c\u6709\u7684\u4e0d\u4f1a\u3002</p>"},{"location":"chap6/2BookInfo_1/#1","title":"1\u3001\u4e0d\u540c\u670d\u52a1\u7248\u672c\u8bbf\u95ee\u89c4\u5219\u7684\u57fa\u672c\u4f7f\u7528","text":"<pre><code>$ cd /Users/jxi/Devops/bookinfo/istio-1.1.3\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6765\u5bf9 Reviews \u670d\u52a1\u6dfb\u52a0\u4e00\u6761\u8def\u7531\u89c4\u5219\uff0c\u542f\u7528<code>samples/bookinfo/networking/virtual-service-reviews-v3.yaml</code> \u5b9a\u4e49\u7684<code>VirtualService</code>\u89c4\u5219\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v3\n</code></pre> <p>\u8fd9\u6837\uff0c\u6240\u6709\u8bbf\u95ee reviews \u670d\u52a1\u7684\u6d41\u91cf\u5c31\u4f1a\u88ab\u5f15\u5bfc\u5230 <code>reviews</code> \u670d\u52a1\u5bf9\u5e94\u7684 <code>subset</code> \u4e3a <code>v3</code> \u7684 <code>Pod</code> \u4e2d\u3002\u542f\u7528\u8fd9\u6761\u89c4\u5219\uff1a</p> <pre><code>$ istioctl create -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml\nCommand \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nCreated config virtual-service/default/reviews at revision 23414\n</code></pre> <p>\u7136\u540e\u67e5\u770b\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff1a</p> <pre><code>$ kubectl get virtualservices\nNAME       CREATED AT\nbookinfo   4h\nreviews    48s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>reviews</code> \u7684<code>VirtualService</code>\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u4f46\u662f\u6b64\u65f6\u5237\u65b0\u5e94\u7528\u9875\u9762\uff0c\u53d1\u73b0\u8bbf\u95ee Reviews \u5931\u8d25\u4e86\uff1a</p> <p></p> <p></p> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u521b\u5efa <code>DestinationRule</code></p> <p><code>DestinationRule</code>\u5c06 <code>VirtualService</code> \u4e2d\u6307\u5b9a\u7684<code>subset</code> \u4e0e <code>pod</code> \u7684<code>{labels:{version: v3}}</code>\u5173\u8054\u8d77\u6765\u3002</p> <p>\u5728 <code>samples/bookinfo/networking/destination-rule-all.yaml</code> \u6587\u4ef6\u4e2d\u6709\u5b9a\u4e49\u6240\u6709\u8be5\u5e94\u7528\u4e2d\u8981\u7528\u5230\u7684\u6240\u6709<code>DestinationRule</code>\uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5c31\u662f\u5bf9 <code>Reviews</code> \u76f8\u5173\u7684 <code>DestinationRule</code> \u7684\u5b9a\u4e49:</p> <pre><code>---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: reviews\nspec:\n  host: reviews\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n  - name: v3\n    labels:\n      version: v3\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>DestinationRule</code> \u4e2d\u5b9a\u4e49\u4e86 <code>subsets</code> \u96c6\u5408\uff0c\u5176\u4e2d <code>labels</code> \u5c31\u548c\u6211\u4eec\u4e4b\u524d <code>service</code> \u7684 <code>labelselector</code> \u4e00\u6837\u662f\u53bb\u5339\u914d <code>Pod</code> \u7684 <code>labels</code> \u6807\u7b7e\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc <code>subsets</code> \u4e2d\u5c31\u5305\u542b\u4e00\u4e2a\u540d\u4e3a <code>v3</code> \u7684 <code>subset</code>\uff0c\u800c\u8fd9\u4e2a <code>subset</code> \u5339\u914d\u7684\u5c31\u662f\u5177\u6709 <code>version=v3</code> \u8fd9\u4e2a <code>label</code> \u6807\u7b7e\u7684 <code>Pod</code> \u96c6\u5408.</p> <p>\u518d\u56de\u5230\u4e4b\u524d\u7684 <code>samples/bookinfo/platform/kube/bookinfo.yaml</code>\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 <code>reviews</code> \u7684 <code>Deployment</code>\u786e\u5b9e\u6709\u58f0\u660e\u4e0d\u540c\u7684 <code>labels-&gt;version</code>:</p> <pre><code>---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: reviews-v3\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: reviews\n        version: v3\n    spec:\n      containers:\n      - name: reviews\n        image: istio/examples-bookinfo-reviews-v3:1.8.0\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 9080\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u901a\u8fc7 <code>DestinationRule</code> \u5c06<code>VirtualService</code> \u4e0e <code>service</code> \u4e0d\u540c\u7684\u7248\u672c\u5173\u8054\u8d77\u6765\u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa <code>DestinationRule</code> \u8d44\u6e90\uff1a</p> <pre><code>$ istioctl create -f samples/bookinfo/networking/destination-rule-all.yaml\nCommand \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nCreated config destination-rule/default/productpage at revision 24074\nCreated config destination-rule/default/reviews at revision 24075\nCreated config destination-rule/default/ratings at revision 24076\nCreated config destination-rule/default/details at revision 24077\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u76ee\u524d\u6211\u4eec\u7f51\u683c\u4e2d\u7684 <code>DestinationRules</code>:</p> <pre><code>$ istioctl get destinationrule\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nDESTINATION-RULE NAME   HOST          SUBSETS                      NAMESPACE   AGE\ndetails                 details       v1,v2                        default     13s\nproductpage             productpage   v1                           default     13s\nratings                 ratings       v1,v2,v2-mysql,v2-mysql-vm   default     13s\nreviews                 reviews       v1,v2,v3                     default     13s\n</code></pre> <p>\u6b64\u65f6\u518d\u8bbf\u95ee\u5e94\u7528\u5c31\u6210\u529f\u4e86\uff0c\u591a\u6b21\u5237\u65b0\u9875\u9762\u53d1\u73b0 <code>Reviews</code> \u90fd\u5c55\u793a\u7684\u662f <code>v3</code> \u7248\u672c\u5e26\u7ea2\u8272\u661f\u7684 <code>Ratings</code>\uff0c\u8bf4\u660e\u6211\u4eec<code>VirtualService</code> \u7684\u914d\u7f6e\u6210\u529f\u4e86\u3002</p>"},{"location":"chap6/2BookInfo_1/#2","title":"2\u3001\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u4f7f\u7528","text":"<p>\u521a\u521a\u6211\u4eec\u6f14\u793a\u7684\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u7684\u670d\u52a1\u7f51\u683c\u7684\u63a7\u5236\uff0c\u73b0\u5728\u6211\u4eec\u6765\u6f14\u793a\u4e0b\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u3002</p> <p>\u9996\u5148\u79fb\u9664\u521a\u521a\u521b\u5efa\u7684 <code>VirtualService</code> \u5bf9\u8c61:</p> <pre><code>$ istioctl delete virtualservice reviews\nCommand \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nDeleted config: virtualservice reviews\n\n$ istioctl get virtualservices\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nVIRTUAL-SERVICE NAME   GATEWAYS           HOSTS     #HTTP     #TCP      NAMESPACE   AGE\nbookinfo               bookinfo-gateway   *             1        0      default     4h\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u8bbf\u95ee <code>Bookinfo</code> \u5e94\u7528\u53c8\u56de\u5230\u6700\u521d\u968f\u673a\u8bbf\u95ee <code>Reviews</code> \u7684\u60c5\u51b5\u4e86\u3002\u73b0\u5728\u6211\u4eec\u67e5\u770b\u6587\u4ef6 <code>samples/bookinfo/networking/virtual-service-reviews-80-20.yaml</code> \u7684\u5b9a\u4e49\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v1\n      weight: 80\n    - destination:\n        host: reviews\n        subset: v2\n      weight: 20\n</code></pre> <p>\u8fd9\u4e2a\u89c4\u5219\u5b9a\u4e49\u4e86:</p> <ul> <li><code>80%</code> \u7684\u5bf9 <code>Reviews</code> \u7684\u6d41\u91cf\u4f1a\u843d\u5165 <code>v1</code> \u8fd9\u4e2a <code>subset</code>\uff0c\u5c31\u662f\u6ca1\u6709 <code>Ratings</code> \u7684\u8fd9\u4e2a\u670d\u52a1\uff0c</li> <li><code>20%</code> \u4f1a\u843d\u5165 <code>v2</code> \u5e26\u9ed1\u8272 <code>Ratings</code> \u7684\u8fd9\u4e2a\u670d\u52a1\uff0c\u7136\u540e\u6211\u4eec\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</li> </ul> <pre><code>$ kubectl create -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml\nvirtualservice.networking.istio.io/reviews created\n\n$ istioctl get virtualservices\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nVIRTUAL-SERVICE NAME   GATEWAYS           HOSTS     #HTTP     #TCP      NAMESPACE   AGE\nbookinfo               bookinfo-gateway   *             1        0      default     4h\nreviews                                   reviews       1        0      default     11s\n</code></pre> <p>\u6211\u4eec\u67e5\u770b\u5f53\u524d\u7f51\u683c\u4e2d\u7684 <code>virtualservices</code> \u5bf9\u8c61\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6709 <code>reviews</code> \u4e86\uff0c\u8bc1\u660e\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u5e94\u7528\u4e2d\u6240\u6709\u7684 <code>DestinationRules</code> \u90fd\u5df2\u7ecf\u521b\u5efa\u8fc7\u4e86\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u8bbf\u95ee\u5e94\u7528\u5c31\u53ef\u4ee5\u4e86\uff0c</p> <p>\u6211\u4eec\u591a\u6b21\u5237\u65b0\uff0c\u53ef\u4ee5\u53d1\u73b0\u6ca1\u6709\u51fa\u73b0 <code>Ratings</code> \u7684\u6b21\u6570\u4e0e\u51fa\u73b0\u9ed1\u8272\u661f <code>Ratings</code> \u7684\u6bd4\u4f8b\u5927\u6982\u5728<code>4:1</code>\u5de6\u53f3\uff0c\u5e76\u4e14\u6ca1\u6709\u7ea2\u8272\u661f\u7684 <code>Ratings</code> \u7684\u60c5\u51b5\u51fa\u73b0\uff0c\u8bf4\u660e\u6211\u4eec\u914d\u7f6e\u7684 <code>VirtualService</code> \u89c4\u5219\u751f\u6548\u4e86\u3002</p> <p> </p> <p></p> <p>\u8fd9\u5c31\u662f\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p>"},{"location":"chap6/2BookInfo_1/#3","title":"3\u3001\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u4f7f\u7528","text":"<p>\u9664\u4e86\u4e0a\u9762\u57fa\u4e8e\u670d\u52a1\u7248\u672c\u548c\u670d\u52a1\u6743\u91cd\u7684\u65b9\u5f0f\u63a7\u5236\u670d\u52a1\u8bbf\u95ee\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u6765\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\u3002</p> <p>\u540c\u6837\uff0c\u5c06\u4e0a\u9762\u521b\u5efa\u7684 <code>VirtualService</code> \u5bf9\u8c61\u5220\u9664\uff1a</p> <pre><code>$ istioctl delete virtualservice reviews\nCommand \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nDeleted config: virtualservice reviews\n\n$ istioctl get virtualservices\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nVIRTUAL-SERVICE NAME   GATEWAYS           HOSTS     #HTTP     #TCP      NAMESPACE   AGE\nbookinfo               bookinfo-gateway   *             1        0      default     4h\n</code></pre> <p>\u67e5\u770b\u6587\u4ef6 <code>samples/bookinfo/networking/virtual-service-reviews-jason-v2-v3.yaml</code> \u7684\u5b9a\u4e49\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    route:\n    - destination:\n        host: reviews\n        subset: v2\n  - route:\n    - destination:\n        host: reviews\n        subset: v3\n</code></pre> <p>\u8fd9\u4e2a <code>VirtualService</code> \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 <code>reviews</code> \u670d\u52a1\u8bbf\u95ee\u7684 <code>match</code> \u89c4\u5219\u3002</p> <p>\u610f\u601d\u662f\u5982\u679c\u5f53\u524d\u8bf7\u6c42\u7684 <code>header</code> \u4e2d\u5305\u542b <code>jason</code> \u8fd9\u4e2a\u7528\u6237\u4fe1\u606f\uff0c\u5219\u53ea\u4f1a\u8bbf\u95ee\u5230 <code>v2</code> \u7684 <code>reviews</code> \u8fd9\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u5373\u90fd\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u5982\u679c\u4e0d\u5305\u542b\u8be5\u7528\u6237\u4fe1\u606f\uff0c\u5219\u90fd\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u53d1\u7ed9 <code>v3</code> \u8fd9\u4e2a <code>reviews</code> \u7684\u670d\u52a1\u3002</p> <p>\u6211\u4eec\u5148\u4e0d\u542f\u7528\u8fd9\u4e2a <code>VirtualService</code>\uff0c\u73b0\u5728\u6211\u4eec\u53bb\u8bbf\u95ee\u4e0b <code>Bookinfo</code> \u8fd9\u4e2a\u5e94\u7528\uff1a</p> <p>\u53f3\u4e0a\u89d2\u6709\u767b\u5f55\u6309\u94ae\uff0c\u5728\u6ca1\u6709\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u5237\u65b0\u9875\u9762\uff0c<code>reviews</code> \u670d\u52a1\u662f\u88ab\u968f\u673a\u8bbf\u95ee\u7684\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u5e26\u661f\u4e0d\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u70b9\u51fb\u767b\u5f55\uff0c\u5728\u5f39\u7a97\u4e2d <code>User Name</code> \u8f93\u5165 <code>jason</code>\uff0c<code>Password</code>\u4e3a\u7a7a\uff0c\u767b\u5f55\uff1a</p> <p></p> <p></p> <p>\u518d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u8ddf\u672a\u767b\u5f55\u524d\u7684\u8bbf\u95ee\u89c4\u5219\u4e00\u6837\uff0c\u4e5f\u662f\u968f\u673a\u7684\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8fd9\u4e2a\u5bf9\u8c61:</p> <pre><code>\n$ kubectl create -f samples/bookinfo/networking/virtual-service-reviews-jason-v2-v3.yaml\nvirtualservice.networking.istio.io/reviews created\n\n$ istioctl get virtualservice\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nVIRTUAL-SERVICE NAME   GATEWAYS           HOSTS     #HTTP     #TCP      NAMESPACE   AGE\nbookinfo               bookinfo-gateway   *             1        0      default     4h\nreviews  \n</code></pre> <p>\u6b64\u65f6\u518d\u56de\u53bb\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u4e00\u76f4\u90fd\u662f\u9ed1\u661f\u7684 Reviews \u7248\u672c<code>(v2)</code>\u88ab\u8bbf\u95ee\u5230\u4e86\u3002 \u6ce8\u9500\u9000\u51fa\u540e\u518d\u8bbf\u95ee\uff0c\u6b64\u65f6\u53c8\u4e00\u76f4\u662f\u7ea2\u8272\u661f\u7684\u7248\u672c<code>(v3)</code>\u88ab\u8bbf\u95ee\u4e86\u3002</p> <p></p> <p></p> <p>\u8bf4\u660e\u6211\u4eec\u57fa\u4e8e <code>headers-&gt;end-user-&gt;exact:jason</code>\u7684\u63a7\u5236\u89c4\u5219\u751f\u6548\u4e86\u3002\u5728 <code>productpage</code> \u670d\u52a1\u8c03\u7528 <code>reviews</code> \u670d\u52a1\u65f6\uff0c\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u4f1a\u5728 <code>header</code> \u4e2d\u5e26\u4e0a\u7528\u6237\u4fe1\u606f\uff0c\u901a\u8fc7 <code>exact</code> \u89c4\u5219\u5339\u914d\u5230\u76f8\u5173\u4fe1\u606f\u540e\uff0c\u6d41\u91cf\u88ab\u5f15\u5411\u4e86\u4e0a\u9762\u914d\u7f6e\u7684v2\u7248\u672c\u4e2d\u3002</p> <p>\u8fd9\u91cc\u8981\u8bf4\u660e\u4e00\u4e0bmatch\u7684\u5339\u914d\u89c4\u5219\uff1a</p> <p>All conditions inside a single match block have AND semantics, while the list of match blocks have OR semantics. The rule is matched if any one of the match blocks succeed.</p> <p>\u610f\u601d\u662f\u4e00\u4e2a match \u5757\u91cc\u7684\u6761\u4ef6\u662f\u9700\u8981\u540c\u65f6\u6ee1\u8db3\u624d\u7b97\u5339\u914d\u6210\u529f\u7684\uff0c\u5982:</p> <pre><code>- match:\n    - uri:\n        prefix: \"/wpcatalog\"\n      port: 443\n</code></pre> <p>\u591a\u4e2a match \u5757\u4e4b\u95f4\u662f\u53ea\u8981\u6709\u4e00\u4e2a match \u5339\u914d\u6210\u529f\u4e86\uff0c\u5c31\u4f1a\u8d70\u5411\u5b83\u6307\u5b9a\u7684\u670d\u52a1\u7248\u672c\u53bb\uff0c\u800c\u5ffd\u7565\u5176\u4ed6\u7684\u3002</p> <p>\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\u5728\u767b\u5f55\u7684\u6761\u4ef6\u4e0b\uff0c\u6ee1\u8db3\u7b2c\u4e00\u4e2a <code>match</code>\uff0c\u6240\u4ee5\u670d\u52a1\u4e00\u76f4\u4f1a\u8bbf\u95ee\u5230 <code>v2</code> \u7248\u672c\u3002\u9000\u51fa\u767b\u5f55\u540e\uff0c\u6ca1\u6709 <code>match</code> \u89c4\u5219\u6ee1\u8db3\u5339\u914d\uff0c\u4f1a\u8d70\u5411\u6700\u540e\u4e00\u4e2a <code>route</code> \u89c4\u5219\uff0c\u5373 <code>v3</code> \u7248\u672c\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c31\u548c\u5927\u5bb6\u4e00\u8d77\u5b66\u4e60\u4e86\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u3001\u6743\u91cd\u4ee5\u53ca\u8bf7\u6c42\u5185\u5bb9\u6765\u63a7\u5236\u670d\u52a1\u6d41\u91cf\u7684\u914d\u7f6e\uff0c\u540e\u9762\u6211\u4eec\u5c06\u8fdb\u4e00\u6b65\u5b66\u4e60\u6d41\u91cf\u7ba1\u7406\u7684\u5176\u4ed6\u7528\u6cd5\u3002</p>"},{"location":"chap6/3BookInfo_2/","title":"L3 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u5ef6\u8fdf\u8bbf\u95ee/\u4e2d\u65ad\u8bbf\u95ee/\u4e0d\u540c\u73af\u5883/\u670d\u52a1\u7f51\u683c\u5916)","text":""},{"location":"chap6/3BookInfo_2/#1","title":"1\u3001\u5ef6\u8fdf\u8bbf\u95ee\u6545\u969c\u6ce8\u5165","text":"<p>\u63a5\u4e0a\u8282\u8bfe\u7684\u5185\u5bb9\uff0c\u7b2c\u4e00\u6b65\u8fd8\u662f\u9700\u8981\u79fb\u9664\u4e4b\u524d\u521b\u5efa\u7684 <code>VirtualService</code>:</p> <pre><code>$ istioctl get virtualservice\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nVIRTUAL-SERVICE NAME   GATEWAYS           HOSTS     #HTTP     #TCP      NAMESPACE   AGE\nbookinfo               bookinfo-gateway   *             1        0      default     23h\nreviews  \n\n$ istioctl delete virtualservice reviews\nCommand \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nDeleted config: virtualservice reviews\n\n\n$ istioctl get virtualservice\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nVIRTUAL-SERVICE NAME   GATEWAYS           HOSTS     #HTTP     #TCP      NAMESPACE   AGE\nbookinfo               bookinfo-gateway   *             1        0      default     23h\n</code></pre> <pre><code>cd /Users/jxi/Devops/bookinfo/istio-1.1.3\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u67e5\u770b istio \u6837\u4f8b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6\uff1a<code>samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml</code> \u7684\u5185\u5bb9</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n  - ratings\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    fault:\n      delay:\n        percent: 100\n        fixedDelay: 7s\n    route:\n    - destination:\n        host: ratings\n        subset: v1\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n</code></pre> <p>\u8fd9\u4e2a <code>VirtualService</code> \u5b9a\u4e49\u4e86\u4e00\u4e2a\u5728 <code>jason</code> \u767b\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u8bbf\u95ee <code>ratings</code> \u670d\u52a1\u7684 <code>100%</code> \u7684 <code>7s</code> \u8bbf\u95ee\u5ef6\u8fdf\u3002</p> <p>\u524d\u9762\u6211\u4eec\u77e5\u9053\uff0c<code>Bookinfo</code> \u8fd9\u4e2a\u793a\u4f8b <code>productpage</code> \u670d\u52a1\u8c03\u7528 <code>reviews</code>\uff0c<code>reviews</code> \u7684\u4e0d\u540c\u7248\u672c\u4f1a\u5bf9 <code>ratings</code> \u8fdb\u884c\u4e0d\u540c\u7684\u8c03\u7528\uff0c</p> <ul> <li>\u5176\u4e2d <code>reviews-v1</code> \u4e0d\u8c03\u7528 <code>ratings</code>\uff0c</li> <li><code>reviews-v2</code> \u548c <code>reviews-v3</code> \u4f1a\u8c03\u7528 <code>ratings</code>\uff0c\u5e76\u505a\u4e0d\u540c\u6837\u5f0f\u7684\u6e32\u67d3\u3002</li> <li>\u5e76\u4e14\u5728 <code>productpage</code> \u8bbf\u95ee <code>reviews</code> \u65f6\uff0c\u4ee3\u7801\u4e2d\u6709\u786c\u7f16\u7801 <code>6s</code> \u4e2d\u7684\u8bbf\u95ee\u8d85\u65f6\u9650\u5236\uff0c</li> <li>\u800c <code>reviews</code> \u8bbf\u95ee <code>ratings</code> \u7f16\u7801\u4e86 <code>10s</code> \u7684\u8bbf\u95ee\u8d85\u65f6\u9650\u5236\u3002</li> </ul> <p>\u4e86\u89e3\u8fd9\u4e00\u70b9\u540e\uff0c\u6211\u4eec\u73b0\u5728\u6765\u521b\u5efa\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f  samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml\nvirtualservice.networking.istio.io/ratings created\n\n$ istioctl get virtualservice\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nVIRTUAL-SERVICE NAME   GATEWAYS           HOSTS     #HTTP     #TCP      NAMESPACE   AGE\nbookinfo               bookinfo-gateway   *             1        0      default     23h\nratings    \n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u524d\u5f80 <code>Bookinfo</code> \u5e94\u7528\uff0c\u767b\u5f55 <code>jason</code>\uff0c\u6253\u5f00\u6d4f\u89c8\u5668\u7684<code>Network</code>\uff0c\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u8bf7\u6c42\u52a0\u8f7d\u5f88\u6162\uff0c\u5927\u7ea6 <code>6s</code> \u540e\uff0c\u51fa\u73b0\u5982\u4e0b\u754c\u9762</p> <p></p> <p></p> <p>\u770b\u5230 <code>productpage</code> \u7684\u8bf7\u6c42\u5927\u7ea6\u8017\u65f6 <code>6s</code>\uff0c<code>Reviews</code>\u663e\u793a <code>unavailable</code> \u7684\u9519\u8bef\u3002</p> <p>\u56e0\u4e3a\u6b64\u65f6 <code>reviews</code> \u8bf7\u6c42 <code>ratings</code> \u7684\u8bbf\u95ee\u8d85\u8fc7\u4e86 <code>6s</code> \u8fd8\u6ca1\u6709\u54cd\u5e94\uff0c\u4f7f\u5f97 <code>productpage</code> \u4e2d\u7684\u786c\u7f16\u7801\u7684\u8d85\u65f6\u8bbe\u7f6e\u751f\u6548\u4e86\u3002</p> <p></p> <p>\u901a\u8fc7\u8fd9\u79cd\u8d85\u65f6\u6545\u969c\u6ce8\u5165\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u65b9\u4fbf\u5730\u53d1\u73b0\u670d\u52a1\u95f4\u76f8\u4e92\u8bbf\u95ee\u4e2d\u5b58\u5728\u7684\u6f5c\u5728\u95ee\u9898\u3002</p>"},{"location":"chap6/3BookInfo_2/#2","title":"2\u3001\u4e2d\u65ad\u8bbf\u95ee\u6545\u969c\u6ce8\u5165","text":"<p>\u540c\u6837\u79fb\u9664\u521a\u624d\u7684 <code>VirutualService</code> \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ istioctl delete virtualservice ratings\nCommand \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nDeleted config: virtualservice ratings\n\n$  istioctl get virtualservice\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nVIRTUAL-SERVICE NAME   GATEWAYS           HOSTS     #HTTP     #TCP      NAMESPACE   AGE\nbookinfo               bookinfo-gateway   *             1        0      default     23h\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u67e5\u770b istio \u6837\u4f8b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6\uff1a<code>samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml</code> \u7684\u5185\u5bb9</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n  - ratings\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    fault:\n      abort:\n        percent: 100\n        httpStatus: 500\n    route:\n    - destination:\n        host: ratings\n        subset: v1\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u8fd9\u4e2a <code>yaml</code> \u6587\u4ef6\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u8fd9\u4e2a <code>VirtualService</code> \u8d44\u6e90\u5bf9\u8c61\u914d\u7f6e\u4e86\u5728 <code>jason</code> \u767b\u5f55\u65f6\uff0c<code>reviews</code> \u5bf9 <code>ratings</code> \u8bbf\u95ee\u65f6 <code>100%</code> \u7684\u8fd4\u56de\u4e00\u4e2a<code>500</code>\u9519\u8bef\u54cd\u5e94\u3002</p> <p>\u7136\u540e\u540c\u6837\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a(\u7528 <code>kubectl</code> \u6216\u8005 <code>istioctl</code> \u5de5\u5177\u90fd\u662f\u53ef\u4ee5\u7684)</p> <pre><code>$ istioctl create -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml\nCreated config virtual-service/default/ratings at revision 32143909\n$ istioctl get virtualservice\nVIRTUAL-SERVICE NAME   GATEWAYS           HOSTS     #HTTP     #TCP      NAMESPACE   AGE\nbookinfo               bookinfo-gateway   *             1        0      default     6d\nratings                                   ratings       2        0      default     4s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u56de\u5230 <code>BookInfo</code> \u5e94\u7528\uff0c\u767b\u5f55 <code>jason</code>\uff0c\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u4e0b\u9762\u7684\u73b0\u8c61\uff1a </p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>reviews</code> \u5bf9 <code>ratings</code> \u7684\u8bbf\u95ee\u5931\u8d25\u4e86\uff0c\u670d\u52a1\u4e0a\u9762\u6211\u4eec VirtualService \u8d44\u6e90\u5bf9\u8c61\u7684\u914d\u7f6e\u3002</p>"},{"location":"chap6/3BookInfo_2/#3","title":"3\u3001\u4e0d\u540c\u73af\u5883\u670d\u52a1\u8bbf\u95ee","text":"<p>\u4f7f\u7528 istio \u7684\u8def\u7531\u89c4\u5219\u7ba1\u7406\uff0c\u8fd8\u53ef\u4ee5\u914d\u7f6e\u5bf9\u4e0d\u540c\u73af\u5883(<code>prod, staging, dev</code>\u7b49)\u7684\u540c\u4e00\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u3002\u7531\u4e8e\u6211\u7684\u5b9e\u9a8c\u73af\u5883\u6ca1\u6709\u642d\u5efa\u591a\u73af\u5883\u7684\u96c6\u7fa4\uff0c\u8fd9\u91cc\u6307\u4f7f\u7528\u5b98\u65b9\u7684demo\u6765\u505a\u63cf\u8ff0\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: my-productpage-rule\n  namespace: istio-system\nspec:\n  hosts:\n  - productpage.prod.svc.cluster.local # ignores rule namespace\n  http:\n  - timeout: 5s\n    route:\n    - destination:\n        host: productpage.prod.svc.cluster.local\n</code></pre> <p>\u901a\u5e38\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u5982\u679c\u642d\u5efa\u591a\u73af\u5883\u7684\u60c5\u51b5\u53ef\u4ee5\u4f7f\u7528<code>namespace</code>\u6765\u8fdb\u884c\u5212\u5206\uff0c\u800c\u4f7f\u7528\u4e0a\u9762\u7684\u65b9\u5f0f\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u5176\u4ed6 <code>namepaces</code> \u7684\u670d\u52a1\u7684\u8bbf\u95ee\u3002</p> <p>\u4e0a\u9762\u7684 <code>VirtualService</code> \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 <code>namespace</code> \u4e3a <code>prod</code> \u4e2d\u7684 <code>productpage</code> \u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4f1a\u5728 <code>5s</code> \u7684 <code>timeout</code> \u540e\u624d\u4f1a\u8c03\u7528\u8be5\u670d\u52a1\u3002</p> <p>\u8fd9\u4e2a\u8bbf\u95ee\u89c4\u5219\u6ca1\u6709\u5b9a\u4e49 <code>subset</code>\uff0cistio \u4f1a\u83b7\u53d6<code>productpage.prod.svc.cluster.local</code> \u670d\u52a1\u5bf9\u5e94\u7684\u6240\u6709\u5b9e\u4f8b\u5e76\u5411\u5176\u4ed6\u670d\u52a1\u5b9e\u4f8b\u6ce8\u5165\u8fd9\u4e9b\u5b9e\u4f8b\u7684\u4fe1\u606f\u5230\u4ed6\u4eec\u7684 <code>load balancing pool</code> \u4e2d\u53bb\u3002</p> <p>\u540c\u65f6\u6ce8\u610f\u8fd9\u4e2a <code>VirtualService</code> \u662f\u5b9a\u4e49\u5728 <code>istio-system</code> \u7684<code>namespace</code>\u4e2d\u7684\uff0c\u6b64\u65f6\u8981\u4f7f\u7528\u5b8c\u6574\u7684\u670d\u52a1\u57df\u540d\uff1a</p> <p><code>productpage.prod.svc.cluster.local</code>\uff0c\u8fd9\u6837\u8fd9\u6761\u89c4\u5219\u6240\u5c5e\u7684 namespace \u624d\u4f1a\u89e3\u6790\u5230\u5176\u4ed6 namespace \u7684\u670d\u52a1\u3002</p>"},{"location":"chap6/3BookInfo_2/#4","title":"4\u3001\u670d\u52a1\u7f51\u683c\u5916\u7684\u6d41\u91cf\u7ba1\u7406","text":"<p>\u4e3a\u4e86\u63a7\u5236\u670d\u52a1\u7f51\u683c\u5916\u7684\u670d\u52a1\u7684\u6d41\u91cf\u8bbf\u95ee\uff0c\u5916\u90e8\u7684\u670d\u52a1\u5fc5\u987b\u9996\u5148\u4f7f\u7528\u4e00\u4e2a<code>ServiceEntry</code>\u5bf9\u8c61\u52a0\u5165\u5230 <code>istio</code> \u7684\u5185\u90e8 <code>service registry</code> \u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u624d\u4f1a\u77e5\u9053\u5982\u4f55\u5bfc\u5411\u8fd9\u4e9b\u5916\u90e8\u670d\u52a1\u7684\u6d41\u91cf\u3002</p> <p>\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e2a\u529f\u80fd\uff0c\u6211\u4eec\u4f7f\u7528 <code>istio</code> \u6837\u4f8b\u4e2d\u7684 <code>sleep</code> \u5e94\u7528\u6765\u9a8c\u8bc1\u6539\u529f\u80fd\uff0c\u67e5\u770b <code>samples/sleep/sleep.yaml</code> \u6587\u4ef6\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: sleep\n  labels:\n    app: sleep\nspec:\n  ports:\n  - port: 80\n    name: http\n  selector:\n    app: sleep\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: sleep\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: sleep\n    spec:\n      containers:\n      - name: sleep\n        image: tutum/curl\n        command: [\"/bin/sleep\",\"infinity\"]\n        imagePullPolicy: IfNotPresent\n---\n</code></pre> <p>\u8fd9\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5e94\u7528\uff0c\u901a\u8fc7 Deployment \u8fdb\u884c\u63a7\u5236\uff0c\u901a\u8fc7 Service \u66b4\u9732\u670d\u52a1\uff0c\u73b0\u5728\u6211\u4eec\u6765\u90e8\u7f72\u8be5\u5e94\u7528\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f samples/sleep/sleep.yaml)\nservice \"sleep\" created\ndeployment.extensions \"sleep\" created\n</code></pre> <p>\u5f85\u5e94\u7528\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u8fdb\u5165\u8be5\u5e94\u7528\u5bb9\u5668\u5185\u90e8\u6267\u884c\u4e00\u4e9b\u6d4b\u8bd5\u64cd\u4f5c\uff1a</p> <pre><code>$ export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})\n$ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics\nHTTP/1.1 404 Not Found\ndate: Sat, 20 Apr 2019 03:08:34 GMT\nserver: envoy\ncontent-length: 0\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4f1a\u8fd4\u56de\u4e0a\u9762\u7684<code>404</code>\u7684\u4fe1\u606f\uff0c\u56e0\u4e3a\u8be5\u57df\u540d\u4e0d\u5728\u5f53\u524d\u7684\u670d\u52a1\u7f51\u683c\u4e2d\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b <code>istio</code> \u4e0d\u5141\u8bb8\u8bbf\u95ee\u670d\u52a1\u7f51\u683c\u5916\u90e8\u7684 URL\uff0c\u5373\u670d\u52a1\u7f51\u683c\u4e2d\u5bf9\u672a\u77e5\u7684\u670d\u52a1\u8bf7\u6c42\u4f1a\u88ab\u4e22\u5f03\u3002</p> <p>\u8fd9\u5c31\u9700\u8981\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a <code>ServiceEntry</code> \u5bf9\u8c61\uff0c\u5c06\u5916\u90e8\u7684\u8bbf\u95ee\u670d\u52a1\u5f15\u5165\u5230\u670d\u52a1\u7f51\u683c\u4e2d\u6765\u3002</p> <p>\u4f8b\u5982\u4e0b\u9762\u7684\u89c4\u5219\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbf\u95ee <code>edition.cnn.com</code> \u7684\u670d\u52a1\u7684 <code>ServiceEntry</code>:\uff08<code>cnn-service-entry.yaml</code>\uff09</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: cnn\nspec:\n  hosts:\n  - edition.cnn.com\n  ports:\n  - number: 80\n    name: http-port\n    protocol: HTTP\n  - number: 443\n    name: https\n    protocol: HTTPS\n  resolution: DNS\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6765\u90e8\u7f72\u4e0a\u9762\u7684 ServiceEntry \u8d44\u6e90\uff1a</p> <pre><code> $ istioctl create -f cnn-service-entry.yaml\nCommand \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nCreated config service-entry/default/cnn at revision 37978\n\n$ istioctl get serviceentry\nCommand \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nSERVICE-ENTRY NAME   HOSTS             PORTS               NAMESPACE   AGE\ncnn                  edition.cnn.com   HTTP/80,HTTPS/443   default     13s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u4e0a\u9762\u7684 <code>sleep</code> \u5bb9\u5668\u4e2d\u6267\u884c\u4e0a\u9762\u7684\u6d4b\u8bd5\u8bf7\u6c42\uff1a</p> <pre><code>$ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics\nHTTP/1.1 301 Moved Permanently\nserver: envoy\nretry-after: 0\ncontent-length: 0\ncache-control: public, max-age=600\nlocation: https://edition.cnn.com/politics\naccept-ranges: bytes\ndate: Sat, 20 Apr 2019 03:10:47 GMT\nvia: 1.1 varnish\nset-cookie: countryCode=JP; Domain=.cnn.com; Path=/\nset-cookie: geoData=minato|13|105-0001|JP|AS|900|broadband; Domain=.cnn.com; Path=/\nx-served-by: cache-hnd18731-HND\nx-cache: HIT\nx-cache-hits: 0\nx-envoy-upstream-service-time: 608\n\nHTTP/2 200\ncontent-type: text/html; charset=utf-8\nx-servedbyhost: ::ffff:127.0.0.1\naccess-control-allow-origin: *\ncache-control: max-age=60\ncontent-security-policy: default-src 'self' blob: https://*.cnn.com:* http://*.cnn.com:* *.cnn.io:* *.cnn.net:* *.turner.com:* *.turner.io:* *.ugdturner.com:* courageousstudio.com *.vgtf.net:*; script-src 'unsafe-eval' 'unsafe-inline' 'self' *; style-src 'unsafe-inline' 'self' blob: *; child-src 'self' blob: *; frame-src 'self' *; object-src 'self' *; img-src 'self' data: blob: *; media-src 'self' data: blob: *; font-src 'self' data: *; connect-src 'self' *; frame-ancestors 'self' https://*.cnn.com:* http://*.cnn.com https://*.cnn.io:* http://*.cnn.io:* *.turner.com:* courageousstudio.com;\nx-content-type-options: nosniff\nx-xss-protection: 1; mode=block\nvia: 1.1 varnish\naccept-ranges: bytes\ndate: Sat, 20 Apr 2019 03:10:48 GMT\nvia: 1.1 varnish\nage: 156\nset-cookie: countryCode=JP; Domain=.cnn.com; Path=/\nset-cookie: geoData=minato|13|105-0001|JP|AS|900|broadband; Domain=.cnn.com; Path=/\nset-cookie: tryThing00=0110; Domain=.cnn.com; Path=/; Expires=Mon Jul 01 2019 00:00:00 GMT\nset-cookie: tryThing01=7956; Domain=.cnn.com; Path=/; Expires=Sun Mar 01 2020 00:00:00 GMT\nset-cookie: tryThing02=3144; Domain=.cnn.com; Path=/; Expires=Wed Jan 01 2020 00:00:00 GMT\nx-served-by: cache-iad2121-IAD, cache-hnd18726-HND\nx-cache: HIT, MISS\nx-cache-hits: 3, 0\nx-timer: S1555729848.352917,VS0,VE542\nvary: Accept-Encoding\ncontent-length: 1247678\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53d1\u73b0\u53ef\u4ee5\u6b63\u5e38\u8fd4\u56de\u5185\u5bb9\u4e86\uff0c\u8fd4\u56de200\uff0c\u8bc1\u660e\u8bf7\u6c42\u6210\u529f\u4e86\u3002</p> <p>\u8bf4\u660e\uff1a<code>-L</code>\u8ba9 <code>curl</code> \u8ddf\u968f\u8fde\u63a5\u8fdb\u884c\u91cd\u5b9a\u5411\u3002 \u8fd9\u91cc\u670d\u52a1\u5668\u76f4\u63a5\u8fd4\u56de\u7684 <code>30</code>1 \u91cd\u5b9a\u5411\u54cd\u5e94\uff0c\u8981\u6c42\u5ba2\u6237\u7aef\u518d\u4f7f\u7528HTTPS\u7684\u65b9\u5f0f\u5bf9 <code>https://edition.cnn.com/</code> <code>politics</code> \u5730\u5740\u8fdb\u884c\u8bbf\u95ee\uff0c\u7b2c\u4e8c\u6b21\u8bbf\u95ee\u624d\u8fd4\u56de\u4e86<code>200</code>\u7684\u6210\u529f\u7801\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u8fdb\u4e00\u6b65\u914d\u7f6e<code>egress gateway</code>\uff0c\u4f7f\u8fd9\u4e9b\u5bf9\u5916\u90e8\u7684\u6d41\u91cf\u8bbf\u95ee\u7ecf\u7531<code>egress</code>\u53bb\u5230\u5916\u90e8\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5728 <code>istio</code> \u4e2d\u5b9a\u4e49\u4e00\u4e2a<code>egress gateway</code>\u5bf9\u8c61\u6765\u6ce8\u518c\u5141\u8bb8\u4ece\u670d\u52a1\u7f51\u683c\u51fa\u53bb\u7684\u670d\u52a1\uff0c\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e<code>edition.cnn.com</code> \u7684 <code>egress gateway</code> \u5bf9\u8c61:(<code>cnn-egress-gateway.yaml</code>)</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-egressgateway\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    hosts:\n    - edition.cnn.com\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u7684 <code>engress gateway</code> \u5bf9\u8c61\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa <code>VirtualService</code> \u548c <code>DestinationRule</code> \u8fd9\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61:\uff08<code>cnn-virtual-rule.yaml</code>\uff09</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: direct-cnn-through-egress-gateway\nspec:\n  hosts:\n  - edition.cnn.com\n  gateways:\n  - istio-egressgateway\n  - mesh\n  http:\n  - match:\n    - gateways:\n      - mesh\n      port: 80\n    route:\n    - destination:\n        host: istio-egressgateway.istio-system.svc.cluster.local\n        subset: cnn\n        port:\n          number: 80\n      weight: 100\n  - match:\n    - gateways:\n      - istio-egressgateway\n      port: 80\n    route:\n    - destination:\n        host: edition.cnn.com\n        port:\n          number: 80\n      weight: 100\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: egressgateway-for-cnn\nspec:\n  host: istio-egressgateway.istio-system.svc.cluster.local\n  subsets:\n  - name: cnn\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e0a\u97623\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ istioctl create -f cnn-virtual-rule.yaml\nCommand \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nCreated config virtual-service/default/direct-cnn-through-egress-gateway at revision 38205\nCreated config destination-rule/default/egressgateway-for-cnn at revision 38206\n\n$ istioctl create -f cnn-egress-gateway.yaml\nCommand \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl)\nCreated config gateway/default/istio-egressgateway at revision 38218\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u73b0\u5728\u6211\u4eec\u518d\u53bb <code>sleep</code> \u5bb9\u5668\u6267\u884c\u4e0b\u4e0a\u9762\u7684\u8bf7\u6c42\uff1a</p> <pre><code>$ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics\nHTTP/1.1 301 Moved Permanently\nserver: envoy\nretry-after: 0\ncontent-length: 0\ncache-control: public, max-age=600\nlocation: https://edition.cnn.com/politics\naccept-ranges: bytes\ndate: Mon, 15 Oct 2018 17:33:57 GMT\nvia: 1.1 varnish\nset-cookie: countryCode=CN; Domain=.cnn.com; Path=/\nset-cookie: geoData=beijing|BJ|100000|CN|AS; Domain=.cnn.com; Path=/\nx-served-by: cache-nrt6151-NRT\nx-cache: HIT\nx-cache-hits: 0\nx-envoy-upstream-service-time: 439\n\nHTTP/1.1 200 OK\nContent-Type: text/html; charset=utf-8\nx-servedByHost: ::ffff:172.17.25.25\naccess-control-allow-origin: *\ncache-control: max-age=60\ncontent-security-policy: default-src 'self' blob: https://*.cnn.com:* http://*.cnn.com:* *.cnn.io:* *.cnn.net:* *.turner.com:* *.turner.io:* *.ugdturner.com:* courageousstudio.com *.vgtf.net:*; script-src 'unsafe-eval' 'unsafe-inline' 'self' *; style-src 'unsafe-inline' 'self' blob: *; child-src 'self' blob: *; frame-src 'self' *; object-src 'self' *; img-src 'self' data: blob: *; media-src 'self' data: blob: *; font-src 'self' data: *; connect-src 'self' *; frame-ancestors 'self' https://*.cnn.com:* http://*.cnn.com https://*.cnn.io:* http://*.cnn.io:* *.turner.com:* courageousstudio.com;\nx-content-type-options: nosniff\nx-xss-protection: 1; mode=block\nVia: 1.1 varnish\nContent-Length: 1704385\nAccept-Ranges: bytes\nDate: Mon, 15 Oct 2018 09:34:01 GMT\nVia: 1.1 varnish\nAge: 127\nConnection: keep-alive\nSet-Cookie: countryCode=CN; Domain=.cnn.com; Path=/\nSet-Cookie: geoData=beijing|BJ|100000|CN|AS; Domain=.cnn.com; Path=/\nSet-Cookie: tryThing00=6048; Domain=.cnn.com; Path=/; Expires=Mon Jul 01 2019 00:00:00 GMT\nSet-Cookie: tryThing01=0013; Domain=.cnn.com; Path=/; Expires=Fri Mar 01 2019 00:00:00 GMT\nSet-Cookie: tryThing02=9990; Domain=.cnn.com; Path=/; Expires=Wed Jan 01 2020 00:00:00 GMT\nX-Served-By: cache-iad2127-IAD, cache-tyo19949-TYO\nX-Cache: HIT, MISS\nX-Cache-Hits: 1, 0\nX-Timer: S1539596041.954017,VS0,VE471\nVary: Accept-Encoding\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53d1\u73b0\u53ef\u4ee5\u6b63\u5e38\u8fd4\u56de\u5185\u5bb9\uff0c\u8fd9\u65f6\u6211\u4eec\u53bb\u67e5\u770b<code>egressgateway</code>\u7684 <code>Pod</code> \u4e2d\u7684\u5bb9\u5668\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs $(kubectl get pod -l istio=egressgateway -n istio-system -o jsonpath='{.items[0].metadata.name}') -n istio-system | tail\n......\n[2019-04-20T17:33:57.261Z] \"GET /politics HTTP/2\" 301 - 0 0 437 429 \"10.244.4.206\" \"curl/7.35.0\" \"6d4f2ac3-0957-97a5-961a-241c7fd72536\" \"edition.cnn.com\" \"151.101.129.67:80\"\n......\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u6761\u4e0a\u9762\u7684 <code>GET /politics</code>\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u8bf4\u660e\u8bbf\u95ee\u7ecf\u8fc7\u4e86 <code>egress gateway</code> \u51fa\u53bb\u4e86\u3002</p>"},{"location":"chap6/3BookInfo_2/#5virtualservice-destinationrule","title":"5\u3001<code>VirtualService</code> &amp; <code>DestinationRule</code> \u89c4\u5219\u8bf4\u660e","text":"<p>\u6700\u540e\u7b80\u5355\u603b\u7ed3\u4e0b <code>VirtualService</code> \u548c <code>DestinationRule</code> \u7684\u4e00\u4e9b\u914d\u7f6e\u89c4\u5219\u3002</p>"},{"location":"chap6/3BookInfo_2/#5-1-virtualservice","title":"5-1 <code>VirtualService</code> \u7684\u914d\u7f6e\u89c4\u5219\u8bf4\u660e","text":""},{"location":"chap6/3BookInfo_2/#5-2-destinationrule","title":"5-2 <code>DestinationRule</code> \u7684\u914d\u7f6e\u89c4\u5219\u8bf4\u660e\uff1a","text":"<p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u628a\u57fa\u4e8e BookInfo \u793a\u4f8b\u7684\u6d41\u91cf\u63a7\u5236\u7ba1\u7406\u7684\u914d\u7f6e\u548c\u5927\u5bb6\u8bb2\u89e3\u5b8c\u4e86\u3002</p>"},{"location":"chap6/3BookInfo_2/#6","title":"6\u3001\u6536\u4e2a\u5c3e","text":"<pre><code>$ kubectl delete namespace istio-system\nnamespace \"istio-system\" deleted\n\n$ kubectl delete --all pods --namespace=default\n$  kubectl delete --all deployments --namespace=default\n$ kubectl delete --all services --namespace=default\n</code></pre>"},{"location":"chap7/k8s_adv54_release/","title":"L1 Kubernetes \u4e2d\u7684\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u84dd\u7eff\u90e8\u7f72\u548c\u91d1\u4e1d\u96c0\u90e8\u7f72, shipper, Istio, Flagger","text":"<p>\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u662f\u6301\u7eed\u4ea4\u4ed8\u7684\u4e0b\u4e00\u6b65\uff0c \u5b83\u5c06\u65b0\u7248\u672c\u90e8\u7f72\u5230\u7528\u6237\u7684\u4e00\u4e2a\u5b50\u96c6\uff0c\u5e76\u5728\u5c06\u5176\u6eda\u52a8\u5230\u5168\u90e8\u7528\u6237\u4e4b\u524d\u5bf9\u5176\u6b63\u786e\u6027\u548c\u6027\u80fd\u8fdb\u884c\u8bc4\u4f30\uff0c \u5982\u679c\u4e0d\u5339\u914d\u67d0\u4e9b\u5173\u952e\u6307\u6807\uff0c\u5219\u8fdb\u884c\u56de\u6eda\u3002</p> <p>\u8fd9\u91cc\u6709\u4e00\u4e9b\u6709\u8da3\u7684\u9879\u76ee\uff0c\u4f7f\u5f97\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u5728 Kubernetes \u4e2d\u53d8\u5f97\u66f4\u7b80\u5355\u3002\u6211\u5c06\u4f7f\u7528\u4e00\u4e2a <code>Jenkins X</code> \u793a\u4f8b\u9879\u76ee \u5bf9\u5b83\u4eec\u4e4b\u4e2d\u7684\u4e09\u4e2a\u8fdb\u884c\u8ba8\u8bba\uff1a<code>Shipper</code>\u3001<code>Istio</code> \u4ee5\u53ca <code>Flagger</code>\u3002</p>"},{"location":"chap7/k8s_adv54_release/#1shipper","title":"1\u3001Shipper","text":"<p><code>shipper</code> \u662f\u6765\u81ea <code>booking.com</code> \u7684\u4e00\u4e2a\u9879\u76ee\uff0c \u5b83\u5bf9 Kubernetes \u8fdb\u884c\u4e86\u6269\u5c55\uff0c\u6dfb\u52a0\u4e86\u590d\u6742\u7684\u90e8\u7f72\u7b56\u7565\u548c\u591a\u96c6\u7fa4\u7f16\u6392\uff08\u6587\u6863\uff09\u3002\u5b83\u652f\u6301\u4ece\u4e00\u4e2a\u96c6\u7fa4\u5230\u591a\u4e2a\u96c6\u7fa4\u7684\u90e8\u7f72\uff0c\u5141\u8bb8\u591a\u533a\u57df\u90e8\u7f72\u3002</p> <p><code>Shipper</code> \u901a\u8fc7\u4e00\u4e2a <code>shipperctl</code> \u547d\u4ee4\u884c\u8fdb\u884c\u5b89\u88c5\u3002\u5b83\u589e\u52a0\u4e0d\u540c\u96c6\u7fa4\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u8fdb\u884c\u7ba1\u7406\u3002\u8bf7\u6ce8\u610f\u8fd9\u4e2a\u4e0e GKE \u4e0a\u4e0b\u6587\u76f8\u5173\u7684\u95ee\u9898\u3002</p> <p><code>Shipper</code> \u4f7f\u7528 <code>Helm</code> \u5305\u6765\u90e8\u7f72\uff0c\u4f46\u662f\u5b83\u4eec\u6ca1\u6709\u968f\u7740 <code>Helm</code>\u4e00\u8d77\u5b89\u88c5\uff0c\u5b83\u4eec\u4e0d\u4f1a\u5728 <code>helm list</code> \u7684\u8f93\u51fa\u663e\u793a\u3002</p> <p>\u540c\u6837\u5730\uff0c<code>deployments</code> \u7684\u7248\u672c\u5fc5\u987b\u662f <code>apps/v1</code> \uff0c \u5426\u5219 <code>shipper</code> \u5c06\u4e0d\u80fd\u7f16\u8f91 <code>deployment</code> \u6765\u6dfb\u52a0\u6b63\u786e\u7684\u6807\u7b7e\u548c\u526f\u672c\u6570\u91cf\u3002</p> <p>\u4f7f\u7528 <code>shipper</code> \u90e8\u7f72\u90fd\u662f\u4e0e\u4ece\u65e7\u7248\u672c(\u73b0\u6709\u7248\u672c)\u8fc7\u6e21\u5230\u65b0\u7248\u672c(\u7ade\u4e89\u7248\u672c)\u76f8\u5173\u3002\u8fd9\u662f\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5e94\u7528\u5bf9\u8c61\u5b9e\u73b0\u7684\uff0c \u5b83\u5b9a\u4e49\u4e86\u90e8\u7f72\u9700\u8981\u901a\u8fc7\u7684\u591a\u4e2a\u9636\u6bb5\u3002\u4f8b\u5982\u4e0b\u9762 3 \u4e2a\u6b65\u9aa4\u8fc7\u7a0b\uff1a</p> <ul> <li>Staging\uff1a\u90e8\u7f72\u65b0\u7248\u672c\u5230\u4e00\u4e2a <code>pod</code>\uff0c\u6ca1\u6709\u6d41\u91cf</li> <li>50 / 50\uff1a\u90e8\u7f72\u65b0\u7248\u672c\u5230 <code>50%</code> \u7684 <code>pods</code>\uff0c<code>50%</code> \u7684\u6d41\u91cf</li> <li>Full on\uff1a\u90e8\u7f72\u65b0\u7248\u672c\u5230\u5168\u90e8\u7684 <code>pods</code>\uff0c\u5168\u90e8\u7684\u6d41\u91cf</li> </ul> <pre><code>strategy:\n  steps:\n  - name: staging\n    capacity:\n      contender: 1\n      incumbent: 100\n    traffic:\n      contender: 0\n      incumbent: 100\n  - name: 50/50\n    capacity:\n      contender: 50\n      incumbent: 50\n    traffic:\n      contender: 50\n      incumbent: 50\n  - name: full on\n    capacity:\n      contender: 100\n      incumbent: 0\n    traffic:\n      contender: 100\n      incumbent: 0\n</code></pre> <p>\u5982\u679c\u53d1\u5e03\u7684\u67d0\u4e2a\u6b65\u9aa4\u6ca1\u6709\u5c06\u6d41\u91cf\u53d1\u9001\u5230 pods \uff0c \u5219\u53ef\u4ee5\u4f7f\u7528 <code>kubectl port-forward</code> \u8bbf\u95ee\u5b83\u4eec\uff0c\u5982\uff1a<code>kubectl port-forward mypod 8080:8080</code>\uff0c \u8fd9\u5bf9\u4e8e\u5728\u7528\u6237\u770b\u5230\u65b0\u7248\u672c\u4e4b\u524d\u8fdb\u884c\u6d4b\u8bd5\u975e\u5e38\u6709\u7528\u3002</p> <p><code>Shipper</code> \u652f\u6301\u591a\u96c6\u7fa4\u7684\u6982\u5ff5\uff0c\u4f46\u662f\u4ee5\u76f8\u540c\u7684\u65b9\u5f0f\u5bf9\u5f85\u6240\u6709\u96c6\u7fa4\uff0c\u4ec5\u4f7f\u7528\u533a\u57df\u5e76\u901a\u8fc7 <code>capabilities</code>\uff08\u914d\u7f6e\u5728\u96c6\u7fa4\u5bf9\u8c61\u4e2d\uff09\u8fdb\u884c\u7b5b\u9009\uff0c \u6240\u6709\u5bf9\u4e00\u4e2a\u5e94\u7528\u5bf9\u8c61\u6765\u8bf4\uff0c\u8fd9\u91cc\u6ca1\u6709\u4e00\u4e2a <code>dev</code>, <code>staging</code>, <code>prod</code> \u96c6\u7fa4\u7684\u9009\u9879\u3002\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u6709\u4e24\u4e2a\u5e94\u7528\u5bf9\u8c61\uff1a</p> <ul> <li>myapp-staging \u90e8\u7f72\u5230 \"staging\" \u533a\u57df</li> <li>myapp \u90e8\u7f72\u5230\u5176\u5b83\u533a\u57df</li> </ul> <p>\u5728 GKE \u4e2d\uff0c\u4f60\u53ef\u4ee5\u8f7b\u677e\u5730\u914d\u7f6e\u591a\u96c6\u7fa4 <code>ingress</code> \uff0c \u8be5\u5165\u53e3\u5c06\u516c\u5f00\u5728\u591a\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684\u670d\u52a1\uff0c\u5e76\u4ece\u79bb\u4f60\u6240\u5728\u4f4d\u7f6e\u6700\u8fd1\u7684\u96c6\u7fa4\u63d0\u4f9b\u670d\u52a1\u3002</p>"},{"location":"chap7/k8s_adv54_release/#1-1","title":"1-1 \u5c40\u9650\u6027","text":"<p>Shipper \u4e2d\u7684\u4e3b\u8981\u7684\u5c40\u9650\u6027\u6709\uff1a</p> <ul> <li><code>Chart</code> \u9650\u5236\uff1aChart \u5fc5\u987b\u6709\u4e00\u4e2a\u90e8\u7f72\u5bf9\u8c61\u3002<code>Deployment</code> \u7684\u540d\u79f0\u5fc5\u987b\u4f7f\u7528 <code>{{.Release.Name}}</code> \u6a21\u677f\u5316\u3002<code>Deployment</code> \u5bf9\u8c61\u5e94\u8be5\u6709 <code>apiVersion\uff1aapps/v1</code> \u3002</li> <li>\u57fa\u4e8e <code>Pod</code> \u7684\u6d41\u91cf\u5207\u6362\uff1a\u8fd9\u91cc\u6ca1\u6709\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u8def\u7531\uff0c\u4f8b\u5982\uff1a\u53d1\u9001 <code>1%</code> \u7684\u6d41\u91cf\u5230\u65b0\u7248\u672c\uff0c\u5b83\u57fa\u4e8e\u6b63\u5728\u8fd0\u884c\u7684 Pod \u6570\u91cf\u3002</li> <li>\u5982\u679c <code>Shipper</code> \u4e0d\u5de5\u4f5c\u4e86\uff0c\u65b0\u7684 Pod \u5c06\u83b7\u53d6\u4e0d\u5230\u6d41\u91cf\u3002</li> </ul>"},{"location":"chap7/k8s_adv54_release/#2istio","title":"2\u3001Istio","text":"<p><code>Istio</code> \u4e0d\u662f\u4e00\u4e2a\u90e8\u7f72\u5de5\u5177\uff0c\u800c\u662f\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\u3002\u7136\u800c\uff0c\u5b83\u5f88\u4ee4\u4eba\u611f\u5174\u8da3\uff0c\u56e0\u4e3a\u5b83\u5df2\u7ecf\u53d8\u5f97\u975e\u5e38\u6d41\u884c\uff0c\u5e76\u4e14\u5141\u8bb8\u6d41\u91cf\u7ba1\u7406\uff0c\u4f8b\u5982\uff0c\u5c06\u4e00\u5b9a\u6bd4\u4f8b\u7684\u6d41\u91cf\u53d1\u9001\u5230\u4e0d\u540c\u7684\u670d\u52a1\u548c\u5176\u4ed6\u9ad8\u7ea7\u7f51\u7edc\u3002</p> <p>\u5728 <code>GKE</code> \u4e2d\uff0c\u53ea\u9700\u5728\u96c6\u7fa4\u914d\u7f6e\u4e2d\u9009\u4e2d\u590d\u9009\u6846\u5373\u53ef\u542f\u7528 <code>Istio</code> \u3002\u5728\u5176\u5b83\u96c6\u7fa4\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>Helm</code> \u624b\u52a8\u5b89\u88c5\u3002</p> <p>\u6709\u4e86 <code>Istio</code> \uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u7f51\u5173\uff0c\u901a\u8fc7 <code>Ingress</code> \u7f51\u5173\u5904\u7406\u6240\u6709\u5916\u90e8\u6d41\u91cf\uff0c\u5e76\u521b\u5efa\u865a\u62df\u670d\u52a1\u6765\u7ba1\u7406\u5230\u6211\u4eec\u670d\u52a1\u7684\u8def\u7531\u3002</p> <p>\u4e3a\u6b64\uff0c\u53ea\u9700\u627e\u5230 <code>ingress</code> \u7f51\u5173\u7684 <code>ip</code> \u5730\u5740\u5e76\u4e3a\u5176\u914d\u7f6e\u901a\u914d\u7b26 <code>DNS</code> \u3002\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u7f51\u5173\uff0c\u901a\u8fc7 <code>Ingress</code> \u7f51\u5173\u8def\u7531\u6240\u6709\u5916\u90e8\u6d41\u91cf\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n name: public-gateway\n namespace: istio-system\nspec:\n selector:\n   istio: ingressgateway\n servers:\n - port:\n     number: 80\n     name: http\n     protocol: HTTP\n   hosts:\n   - \"*\"\n</code></pre> <p><code>Isito</code> \u4e0d\u7ba1\u7406\u5e94\u7528\u7684\u751f\u547d\u5468\u671f\uff0c\u53ea\u7ba1\u7406\u7f51\u7edc\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u670d\u52a1\uff0c\u4e3a\u6240\u6709\u8fdb\u5165 <code>ingress</code> \u7f51\u5173\u7684\u8bf7\u6c42 \u5411 <code>pull request</code> \u6216 <code>master</code> \u5206\u652f\u4e2d\u90e8\u7f72\u7684\u670d\u52a1\u53d1\u9001 1% \u7684\u6d41\u91cf\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n name: croc-hunter-jenkinsx\n namespace: jx-production\nspec:\n gateways:\n - public-gateway.istio-system.svc.cluster.local\n - mesh\n hosts:\n - croc-hunter.istio.example.org\n http:\n - route:\n   - destination:\n       host: croc-hunter-jenkinsx.jx-production.svc.cluster.local\n       port:\n         number: 80\n     weight: 99\n   - destination:\n       host: croc-hunter-jenkinsx.jx-staging.svc.cluster.local\n       port:\n         number: 80\n     weight: 1\n</code></pre>"},{"location":"chap7/k8s_adv54_release/#3flagger","title":"3\u3001Flagger","text":"<p>Flagger \u662f\u4e00\u4e2a\u7531 Weaveworks \u8d5e\u52a9\u7684\u4f7f\u7528\u4e86 <code>Istio</code> \u7684\u9879\u76ee\uff0c \u8be5\u9879\u76ee\u4f7f\u7528 <code>Prometheus</code> \u7684\u6307\u6807\u8fdb\u884c\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u53d1\u5e03\u548c\u56de\u6eda\u3002\u5b83\u8d85\u8d8a\u4e86 <code>Isito</code> \u63d0\u4f9b\u4e86\u57fa\u4e8e\u6307\u6807\u7684\u81ea\u52a8\u5316\u6e10\u8fdb\u5f0f\u53d1\u5e03\u548c\u56de\u6eda\u3002</p> <p><code>Flager</code> \u9700\u8981\u5c06 <code>Istio</code>\u4e0e <code>Prometheus</code>\u3001<code>Servicegraph</code> \u548c\u67d0\u4e9b\u7cfb\u7edf\u7684\u914d\u7f6e\u4e00\u8d77\u5b89\u88c5\uff0c \u53e6\u5916\u8fd8\u8981\u5b89\u88c5 <code>Flager</code> \u63a7\u5236\u5668\u672c\u8eab\u3002\u5b83\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a <code>Grfana</code> \u9762\u677f\u6765\u76d1\u63a7\u90e8\u7f72\u8fdb\u5ea6\u3002</p> <p></p> <p>\u90e8\u7f72 <code>rollout</code>\u901a\u8fc7 <code>Canary</code> \u5bf9\u8c61\u5b9a\u4e49\uff0c \u5b83\u4f1a\u751f\u6210\u4e3b\u8981\u7684\u548c\u91d1\u4e1d\u96c0 <code>Deployment</code> \u5bf9\u8c61\u3002\u7f16\u8f91 <code>Deployment</code> \u65f6\uff0c\u4f8b\u5982\u8981\u4f7f\u7528\u65b0\u7684\u955c\u50cf\u7248\u672c\uff0c <code>Flagger</code> \u63a7\u5236\u5668\u5c06\u8d1f\u8f7d\u4ece <code>0%</code>\u5207\u6362\u5230 <code>50%</code> \uff0c\u6bcf\u5206\u949f\u589e\u52a0 <code>10%</code>\uff0c\u7136\u540e\u5b83\u5c06\u5207\u6362\u5230\u65b0\u7684 <code>deployment</code> \u6216\u8005\u5982\u679c\u54cd\u5e94\u9519\u8bef\u548c\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u7b49\u6307\u6807\u5931\u8d25\u5219\u8fdb\u884c\u56de\u6eda\u3002</p>"},{"location":"chap7/k8s_adv54_release/#4","title":"4\u3001\u6bd4\u8f83","text":"<p>\u6b64\u8868\u603b\u7ed3\u4e86 <code>Shipper</code> \u548c <code>Flagger</code> \u5728\u51e0\u4e2a\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u7279\u6027\u65b9\u9762\u7684\u4f18\u52bf\u548c\u52a3\u52bf\u3002</p> <p></p> <p>\u7efc\u4e0a\u6240\u8ff0\uff0c\u6211\u770b\u5230\u4e86 <code>Shipper</code> \u5728\u591a\u96c6\u7fa4\u7ba1\u7406\u548c\u7b80\u5355\u6027\u65b9\u9762\u7684\u4ef7\u503c\uff0c\u5b83\u4e0d\u9700\u8981 Kubernetes \u4ee5\u5916\u7684\u4efb\u4f55\u4e1c\u897f\uff0c\u4f46\u662f\u5b83\u6709\u4e00\u4e9b\u4e25\u91cd\u7684\u5c40\u9650\u6027\u3002</p>"},{"location":"chap7/k8s_adv56_jenkinsX/","title":"L2 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8","text":"<p>Jenkins X \u4e2d\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u84dd\u7eff\u8272\u90e8\u7f72\u7684\u4e09\u79cd\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u65b9\u6848\u3002</p> <ul> <li><code>Shipper</code> \u4e3a <code>Jenkins X</code> \u6784\u5efa\u7684 <code>Helm</code> \u56fe\u8868\u542f\u7528\u4e86\u84dd\u7eff\u90e8\u7f72\u548c\u591a\u96c6\u7fa4\u90e8\u7f72\uff0c\u4f46\u662f\u5bf9\u56fe\u8868\u7684\u5185\u5bb9\u6709\u9650\u5236\u3002\u4f60\u53ef\u4ee5\u5728 <code>staging</code> \u548c\u751f\u4ea7\u73af\u5883\u4e4b\u95f4\u505a\u84dd\u7eff\u90e8\u7f72\u3002</li> <li><code>Istio</code> \u5141\u8bb8\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u670d\u52a1\u5c06\u4e00\u5b9a\u6bd4\u4f8b\u7684\u6d41\u91cf\u53d1\u9001\u5230 <code>staging</code> \u6216\u9884\u89c8\u73af\u5883\u3002</li> <li><code>Flagger</code> \u6784\u5efa\u5728 <code>Istio</code> \u4e4b\u4e0a\uff0c\u5e76\u6dfb\u52a0\u4e86\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0c\u53ef\u4ee5\u6839\u636e\u6307\u6807\u81ea\u52a8\u8fdb\u884c\u6eda\u52a8\u90e8\u7f72\u548c\u56de\u6eda\u3002<code>Jenkins X</code>\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a <code>Canary</code> \u5bf9\u8c61\u81ea\u52a8\u542f\u7528\u91d1\u4e1d\u96c0\u529f\u80fd\uff0c\u4ece\u800c\u5b9e\u73b0\u4f18\u96c5\u7684\u6eda\u52a8\u90e8\u7f72\uff0c\u4ee5\u5347\u7ea7\u5230\u751f\u4ea7\u73af\u5883\u3002</li> </ul> <p>\u8fd9\u91cc\u53ef\u4ee5\u67e5\u770b Shipper\u3001Isito \u548c Flager \u7684\u793a\u4f8b\u4ee3\u7801\u3002</p>"},{"location":"chap7/k8s_adv56_jenkinsX/#1shipper","title":"1\u3001Shipper","text":"<p>\u7531\u4e8e <code>Shipper</code> \u5bf9\u521b\u5efa\u7684 <code>Helm Chart</code> \u6709\u591a\u4e2a\u9650\u5236\uff0c\u56e0\u6b64\u6211\u5fc5\u987b\u5bf9\u5e94\u7528\u505a\u4e00\u4e9b\u66f4\u6539\u3002\u800c\u4e14 <code>Jenkins X</code> \u53ea\u4ece <code>master</code> \u5206\u652f\u6784\u5efa <code>Helm</code> \u5305\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u80fd\u505a <code>PRs</code> \u7684\u6eda\u52a8\u90e8\u7f72\uff0c\u53ea\u80fd\u5bf9 <code>master</code>\u5206\u652f\u505a\u6eda\u52a8\u90e8\u7f72\u3002</p> <p>\u5e94\u7528\u6807\u7b7e\u4e0d\u80fd\u5305\u542b\u53d1\u5e03\u540d\u79f0\uff0c\u4f8b\u5982\uff1a<code>app: {{ template \u201cfullname\u201d . }}</code> \u4e0d\u8d77\u4f5c\u7528\uff0c \u9700\u8981\u4e00\u4e9b\u7c7b\u4f3c\u8fd9\u6837\u7684\u6807\u7b7e\uff1a<code>app: {{ .Values.appLabel }}</code>\u3002</p> <p>\u7531 <code>Jenkins X</code> \u751f\u6210\u7684\u56fe\u8868\u5bfc\u81f4\u5e94\u7528\u6eda\u52a8\u5931\u8d25\uff0c\u5f52\u56e0\u4e8e\u751f\u6210\u7684 <code>templates/release.yaml</code> \u53ef\u80fd\u548c <code>jenkins.io/releases CRD</code> \u51b2\u7a81\u3002</p> <pre><code>Chart croc-hunter-jenkinsx-0.0.58 failed to render:\ncould not decode manifest: no kind \"Release\" is registered for version \"jenkins.io/v1\"\n</code></pre> <p>\u6211\u4eec\u53ea\u9700\u8981\u5c06 <code>jx step changelog</code> \u66f4\u6539\u4e3a <code>jx step changelog -generate-yaml =false</code> \uff0c\u8fd9\u6837\u5c31\u4e0d\u4f1a\u751f\u6210\u6587\u4ef6\u3002</p> <p>\u5728\u591a\u96c6\u7fa4\u73af\u5883\uff0c\u9700\u8981\u5728 <code>shipper</code> \u5e94\u7528 <code>yaml</code> \u4e2d\u4e3a <code>chartmuseum</code> \u548c <code>docker registry</code> \u4f7f\u7528\u516c\u5f00\u7684 <code>url</code>\uff0c\u4ee5\u4fbf\u5176\u4ed6\u96c6\u7fa4\u53ef\u4ee5\u53d1\u73b0\u7ba1\u7406\u96c6\u7fa4\u670d\u52a1\u6765\u4e0b\u8f7d\u56fe\u8868\u3002</p>"},{"location":"chap7/k8s_adv56_jenkinsX/#2istio","title":"2\u3001Istio","text":"<p>\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u8fd9\u4e2a\u865a\u62df\u670d\u52a1\uff0c \u5c06\u6240\u6709\u8fdb\u5165 <code>Ingress</code> \u7f51\u5173\u7684\u4e3b\u673a\u4e3a <code>croc-hunter.istio.example.org</code> \u7684\u8bf7\u6c42\u7684 <code>1%</code> \u7684\u6d41\u91cf\u53d1\u9001\u5230 <code>Jenkins X</code> \u9884\u89c8\u73af\u5883( PR \u53f7\u4e3a 35 )\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n name: croc-hunter-jenkinsx\n namespace: jx-production\nspec:\n gateways:\n - public-gateway.istio-system.svc.cluster.local\n - mesh\n hosts:\n - croc-hunter.istio.example.com\n http:\n - route:\n   - destination:\n       host: croc-hunter-jenkinsx.jx-production.svc.cluster.local\n       port:\n         number: 80\n     weight: 99\n   - destination:\n       host: croc-hunter-jenkinsx.jx-carlossg-croc-hunter-jenkinsx-serverless-pr-35.svc.cluster.local\n       port:\n         number: 80\n</code></pre>"},{"location":"chap7/k8s_adv56_jenkinsX/#3flagger","title":"3\u3001Flagger","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4e3a <code>Jenkins X</code>\u5728 <code>jx-production</code> \u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u7684\u56fe\u8868\u521b\u5efa\u4e00\u4e2a <code>Canary</code> \u5bf9\u8c61\uff0c \u6240\u6709\u65b0\u7684 <code>Jenkins X</code>\u5bf9 <code>jx-production</code> \u7684 <code>promotions</code> \u6bcf\u6b21\u5c06\u81ea\u52a8\u6eda\u52a8 <code>10%</code> \uff0c \u5982\u679c\u51fa\u73b0\u4efb\u4f55\u5931\u8d25\uff0c\u5c06\u81ea\u52a8\u56de\u6eda\u3002</p> <pre><code>apiVersion: flagger.app/v1alpha2\nkind: Canary\nmetadata:\n  # canary name must match deployment name\n  name: jx-production-croc-hunter-jenkinsx\n  namespace: jx-production\nspec:\n  # deployment reference\n  targetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: jx-production-croc-hunter-jenkinsx\n  # HPA reference (optional)\n  # autoscalerRef:\n  #   apiVersion: autoscaling/v2beta1\n  #   kind: HorizontalPodAutoscaler\n  #   name: jx-production-croc-hunter-jenkinsx\n  # the maximum time in seconds for the canary deployment\n  # to make progress before it is rollback (default 600s)\n  progressDeadlineSeconds: 60\n  service:\n    # container port\n    port: 8080\n    # Istio gateways (optional)\n    gateways:\n    - public-gateway.istio-system.svc.cluster.local\n    # Istio virtual service host names (optional)\n    hosts:\n    - croc-hunter.istio.example.com\n  canaryAnalysis:\n    # schedule interval (default 60s)\n    interval: 15s\n    # max number of failed metric checks before rollback\n    threshold: 5\n    # max traffic percentage routed to canary\n    # percentage (0-100)\n    maxWeight: 50\n    # canary increment step\n    # percentage (0-100)\n    stepWeight: 10\n    metrics:\n    - name: istio_requests_total\n      # minimum req success rate (non 5xx responses)\n      # percentage (0-100)\n      threshold: 99\n      interval: 1m\n    - name: istio_request_duration_seconds_bucket\n      # maximum req duration P99\n      # milliseconds\n      threshold: 500\n      interval: 30s\n</code></pre>"},{"location":"chap7/k8s_adv57_Auto_Canary/","title":"L3 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u90e8\u7f72","text":"<p>\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u88ab Netflix\uff0c Facebook \u4ee5\u53ca\u5176\u5b83\u516c\u53f8\u4f7f\u7528\u7528\u6765\u51cf\u8f7b\u90e8\u7f72\u7684\u98ce\u9669\u3002 \u4f46\u662f\u73b0\u5728\u4f60\u53ef\u4ee5\u5728\u4f7f\u7528 Jenkins X \u65f6\u91c7\u7528\u5b83\u3002</p> <p>\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u662f\u6301\u7eed\u4ea4\u4ed8\u7684\u4e0b\u4e00\u6b65\uff0c\u5b83\u5c06\u65b0\u7248\u672c\u90e8\u7f72\u5230\u7528\u6237\u7684\u4e00\u4e2a\u5b50\u96c6\uff0c\u5e76\u5728\u5c06\u5176\u6eda\u52a8\u5230\u5168\u90e8\u7528\u6237\u4e4b\u524d\u5bf9\u5176\u6b63\u786e\u6027\u548c\u6027\u80fd\u8fdb\u884c\u8bc4\u4f30\uff0c\u5982\u679c\u4e0d\u5339\u914d\u67d0\u4e9b\u5173\u952e\u6307\u6807\uff0c\u5219\u8fdb\u884c\u56de\u6eda\u3002</p> <p>\u5c24\u5176\u662f\uff0c\u6211\u4eec\u805a\u7126\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u5e76\u8ba9\u5b83\u5728\u4f60\u7684 <code>Jenkins X</code> \u5e94\u7528\u4e2d\u53d8\u5f97\u6613\u4e8e\u91c7\u7528\u3002</p> <p>\u91d1\u4e1d\u96c0\u53d1\u5e03\u5305\u62ec\u5411\u5e94\u7528\u7a0b\u5e8f\u7684\u65b0\u7248\u672c\u53d1\u9001\u4e00\u5c0f\u90e8\u5206\u6d41\u91cf\uff0c\u5e76\u5728\u5411\u5176\u4ed6\u7528\u6237\u53d1\u5e03\u4e4b\u524d\u9a8c\u8bc1\u8fd9\u91cc\u6ca1\u6709\u9519\u8bef\u3002 </p> <p><code>Facebook</code> \u5c31\u662f\u8fd9\u6837\u505a\u7684\uff0c\u9996\u5148\u5411\u5185\u90e8\u5458\u5de5\u63d0\u4f9b\u65b0\u7248\u672c\uff0c\u7136\u540e\u662f\u4e00\u5c0f\u90e8\u5206\u7528\u6237\uff0c\u7136\u540e\u662f\u5176\u4ed6\u6240\u6709\u7528\u6237\uff0c\u4f46\u662f\u4f60\u8981\u91c7\u7528\u5b83\u5e76\u4e0d\u9700\u8981\u6210\u4e3a Facebook \uff01</p> <p></p> <p>\u4f60\u53ef\u4ee5\u5728 Martin Fowler \u7684\u7f51\u7ad9\u9605\u8bfb\u66f4\u591a\u4e0e\u91d1\u4e1d\u96c0\u53d1\u5e03\u76f8\u5173\u4fe1\u606f\u3002</p>"},{"location":"chap7/k8s_adv57_Auto_Canary/#1jenkins-x","title":"1\u3001Jenkins X","text":"<p>\u5982\u679c\u5728 Jenkins X \u4e2d\u4f60\u5df2\u7ecf\u6709\u4e00\u4e2a\u5e94\u7528\uff0c\u90a3\u4e48\u4f60\u77e5\u9053\u7684\u4f60\u53ef\u4ee5 \u901a\u8fc7 <code>jx promote myapp --version 1.0 --env production</code> \u547d\u4ee4 <code>promote</code> \u5b83\u5230\"\u751f\u4ea7\"\u73af\u5883\u3002 </p> <p>\u4f46\u662f\uff0c\u5728\u68c0\u67e5\u65b0\u7248\u672c\u662f\u5426\u5931\u8d25\u7684\u540c\u65f6\uff0c\u5b83\u4e5f\u53ef\u4ee5\u81ea\u52a8\u5e76\u9010\u6b65\u5730\u5411\u4e00\u5b9a\u6bd4\u4f8b\u7684\u7528\u6237\u63a8\u51fa\u3002 \u5982\u679c\u53d1\u751f\u5931\u8d25\uff0c\u5e94\u7528\u7a0b\u5e8f\u5c06\u81ea\u52a8\u56de\u6eda\u3002 \u6574\u4e2a\u8fc7\u7a0b\u4e2d\u5b8c\u5168\u6ca1\u6709\u4eba\u4e3a\u5e72\u9884\u3002</p> <p>\u6ce8\u610f\uff1a\u8fd9\u4e2a\u65b0\u529f\u80fd\u662f\u975e\u5e38\u65b0\u7684\uff0c\u5728\u5c06\u6765\u8fd9\u4e9b\u6b65\u9aa4\u5c06\u4e0d\u518d\u9700\u8981\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e5f\u5c06\u7531 <code>Jenkins X</code> \u81ea\u52a8\u5316\u4e86\u3002</p>"},{"location":"chap7/k8s_adv57_Auto_Canary/#1-1-jenkins-x","title":"1-1 \u4f5c\u4e3a\u7b2c\u4e00\u6b65\uff0c\u4e09\u4e2a <code>Jenkins X</code> \u63d2\u4ef6\u9700\u8981\u88ab\u5b89\u88c5\uff1a","text":"<ul> <li><code>Istio</code> : \u4e00\u79cd\u670d\u52a1\u7f51\u683c\u5bb9\u8bb8\u6211\u4eec\u7ba1\u7406\u6211\u4eec\u670d\u52a1\u7684\u6d41\u91cf\u3002</li> <li><code>Prometheus</code> \uff1a<code>Kubernetes</code> \u4e2d\u6700\u6d41\u884c\u7684\u76d1\u63a7\u7cfb\u7edf\u3002</li> <li><code>Flagger</code> \uff1a\u4e00\u4e2a\u4f7f\u7528 <code>Istio</code> \u7684\u9879\u76ee\uff0c\u8be5\u9879\u76ee\u4f7f\u7528 <code>Prometheus</code> \u7684\u6307\u6807\u81ea\u52a8\u5316\u8fdb\u884c\u91d1\u4e1d\u96c0\u53d1\u5e03\u548c\u56de\u6eda\u3002</li> </ul> <p>\u63d2\u4ef6\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5b89\u88c5\uff08\u4f7f\u7528\u4e00\u4e2a\u6700\u8fd1\u7248\u672c\u7684 jx CLI \uff09\uff1a</p> <ol> <li><code>jx create addon istio</code></li> <li><code>jx create addon prometheus</code></li> <li><code>jx create addon flagger</code></li> </ol> <p>\u8fd9\u5c06\u5728 <code>jx-production</code> \u547d\u540d\u7a7a\u95f4\u542f\u52a8 Istio \u6765\u8fdb\u884c\u6307\u6807\u6536\u96c6\u3002</p> <p>\u73b0\u5728\u83b7\u53d6 <code>Istio ingress</code> \u7684 IP \uff0c\u5e76\u5c06\u4e00\u4e2a\u901a\u914d\u7b26\u57df\u540d\uff08\u5982\uff1a<code>*.example.com</code> \uff09\u6307\u5411\u5b83\uff0c\u4ee5\u4fbf\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5b83\u6839\u636e\u4e3b\u673a\u540d\u8def\u7531\u591a\u4e2a\u670d\u52a1\u3002 <code>Istio ingress</code> \u63d0\u4f9b\u4e86\u91d1\u4e1d\u96c0\u53d1\u5e03\u9700\u8981\u7684\u8def\u7531\u80fd\u529b\uff08\u6d41\u91cf\u8f6c\u79fb\uff09\uff0c\u4f20\u7edf\u7684 <code>Kubernetes ingress</code> \u5bf9\u8c61\u4e0d\u652f\u6301\u8be5\u529f\u80fd\u3002</p> <p>\u96c6\u7fa4\u88ab\u914d\u7f6e\u540e\uff0c\u662f\u65f6\u5019\u914d\u7f6e\u6211\u4eec\u7684\u5e94\u7528\u4e86\u3002 \u5728 <code>charts/myapp/templates</code> \u76ee\u5f55\u4e0b\u5411\u4f60\u7684 <code>helm chart</code> \u6dfb\u52a0\u4e00\u4e2a <code>canary.yaml</code>\u3002</p> <p></p> <p>\u7136\u540e\u5f80 <code>charts/myapp/values.yaml</code> \u8ffd\u52a0\u5982\u4e0b\u5185\u5bb9\uff0c\u5c06 <code>myapp.example.com</code> \u4fee\u6539\u4e3a\u4f60\u7684\u4e3b\u673a\u540d\u6216\u57df\u540d\uff1a</p> <p></p> <p>\u4e0d\u4e45\uff0c\u5f53\u4f60\u4ece <code>Jenkins X</code> \u5feb\u901f\u5f00\u59cb\u521b\u5efa\u4f60\u7684\u5e94\u7528\uff0c\u5c06\u4e0d\u518d\u9700\u8981\u4fee\u6539 <code>canary.yaml</code> \u548c <code>values.yaml</code> \u8fd9\u4e24\u4e2a\u6587\u4ef6\uff0c\u56e0\u4e3a\u5b83\u4eec\u9ed8\u8ba4\u542f\u7528\u91d1\u4e1d\u96c0\u90e8\u7f72\u3002</p> <p>\u5c31\u8fd9\u6837\uff01\u73b0\u5728\u5f53\u4f7f\u7528 <code>jx promote myapp --version 1.0 --env production</code> \u5c06\u4f60\u7684\u5e94\u7528 <code>promote</code> \u5230\u751f\u4ea7\u73af\u5883\uff0c\u5b83\u5c06\u6267\u884c\u4e00\u6b21\u91d1\u4e1d\u96c0\u90e8\u7f72\u3002 \u8bf7\u6ce8\u610f\uff0c\u7b2c\u4e00\u6b21\u88ab <code>promote</code> \u65f6\uff0c\u5b83\u4e0d\u4f1a\u6267\u884c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0c\u56e0\u4e3a\u5b83\u9700\u8981\u4e0e\u4ee5\u524d\u7684\u7248\u672c\u6570\u636e\u8fdb\u884c\u6bd4\u8f83\uff0c\u4f46\u4ece\u7b2c\u4e8c\u6b21 <code>promotion</code> \u5f00\u59cb\uff0c\u5b83\u5c06\u8d77\u4f5c\u7528\u3002</p> <p>\u6839\u636e\u4e0a\u9762 values.yaml \u6587\u4ef6\u4e2d\u7684\u914d\u7f6e\uff0c\u5b83\u770b\u8d77\u6765\u50cf\uff1a</p> <ul> <li>\u7b2c 1 \u5206\u949f\uff1a\u5c06 10% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c</li> <li>\u7b2c 2 \u5206\u949f\uff1a\u5c06 20% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c</li> <li>\u7b2c 3 \u5206\u949f\uff1a\u5c06 30% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c</li> <li>\u7b2c 4 \u5206\u949f\uff1a\u5c06 40% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c</li> <li>\u7b2c 5 \u5206\u949f\uff1a\u5c06 100% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c</li> </ul> <p>\u5982\u679c\u6211\u4eec\u914d\u7f6e\u7684\u6307\u6807\uff08\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u8d85\u8fc7 500 \u6beb\u79d2\u6216\u8d85\u8fc7 1% \u7684\u54cd\u5e94\u8fd4\u56de 500 \u9519\u8bef\uff09\u5931\u8d25\uff0c<code>Flagger</code> \u5c06\u6ce8\u610f\u5230\u5931\u8d25\uff0c\u5e76\u4e14\u5982\u679c\u91cd\u590d <code>5</code> \u6b21\uff0c\u5b83\u5c06\u56de\u6eda\u8fd9\u6b21\u53d1\u5e03\uff0c\u5c06 <code>100%</code> \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65e7\u7248\u672c\u3002</p> <p>\u83b7\u5f97\u91d1\u4e1d\u96c0\u4e8b\u4ef6\u8f93\u51fa\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl -n jx-production get events --watch\\\n\n--field-selector involvedObject.kind=Canary\n\n23m ... New revision detected! Scaling up jx-production-myapp.jx-production\n\n22m ... Starting canary analysis forjx-production-myapp.jx-production\n\n22m ... Advance jx-production-myapp.jx-production canary weight 10\n\n21m ... Advance jx-production-myapp.jx-production canary weight 20\n\n20m ... Advance jx-production-myapp.jx-production canary weight 30\n\n19m ... Advance jx-production-myapp.jx-production canary weight 40\n\n18m ... Advance jx-production-myapp.jx-production canary weight 50\n\n18m ... Copying jx-production-myapp.jx-production template spec to jx-production-myapp-primary.jx-production\n\n17m ... Promotion completed! Scaling down jx-production-myapp.jx-production\n</code></pre>"},{"location":"chap7/k8s_adv57_Auto_Canary/#2","title":"2\u3001\u4eea\u8868\u76d8","text":"<p>\u4e3a\u4e86\u53ef\u89c6\u5316\u7684\u76ee\u7684\uff0cFlagger \u5305\u542b\u4e00\u4e2a Grafana \u9762\u677f\uff0c\u5c3d\u7ba1\u5b83\u5728\u91d1\u4e1d\u96c0\u53d1\u5e03\u4e2d\u4e0d\u9700\u8981\u3002 \u53ef\u4ee5\u5728\u672c\u5730\u901a\u8fc7 Kubernetes \u7aef\u53e3\u8f6c\u53d1\u8bbf\u95ee\u5b83\u3002</p> <p>\u7136\u540e\u4f7f\u7528 <code>admin/admin</code> \u8bbf\u95ee <code>http://localhost:3000</code>/\uff0c\u9009\u62e9 <code>canary-analysis</code> \u9762\u677f\u4ee5\u53ca</p> <ul> <li><code>namespace</code> \u9009\u62e9 <code>jx-production</code></li> <li><code>primary</code> \u9009\u62e9 <code>jx-production-myapp-primary</code></li> <li><code>canary</code> \u9009\u62e9 <code>jx-production-myapp</code></li> </ul> <p>\u5b83\u5c06\u4e3a\u6211\u4eec\u63d0\u4f9b\u5f53\u524d\u7248\u672c\u548c\u65b0\u7248\u672c\u7684\u5bf9\u6bd4\u89c6\u56fe\uff0c\u89c6\u56fe\u4e2d\u5305\u542b\u4e0d\u540c\u6307\u6807\uff08CPU\uff0c\u5185\u5b58\uff0c\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\uff0c\u54cd\u5e94\u9519\u8bef\u2026\u2026\uff09\u3002</p> <p></p> <p>\u5982\u679c\u56e0\u4e3a\u6307\u6807\u5931\u8d25\u51fa\u73b0\u81ea\u52a8\u56de\u6eda\uff0c\u751f\u4ea7\u73af\u5883\u7684 Jenkins X GitOps \u4ed3\u5e93\u4f1a\u8fc7\u65f6\uff0c\u4ecd\u7136\u4f7f\u7528\u65b0\u7248\u672c\u800c\u4e0d\u662f\u65e7\u7248\u672c\u3002 \u8fd9\u662f\u8ba1\u5212\u5728\u5373\u5c06\u53d1\u5e03\u7684\u7248\u672c\u4e2d\u4fee\u590d\u7684\u5185\u5bb9\u3002</p>"},{"location":"chap7/k8s_isitio_gray/","title":"\u4f7f\u7528Rainbond+Istio\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03","text":"<p>Kubernetes \u4f5c\u4e3a\u57fa\u7840\u5e73\u53f0\uff0c\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u5bb9\u5668\u7f16\u6392\u80fd\u529b\u3002\u4f46\u662f\u5728\u5176\u4e0a\u90e8\u7f72\u4e1a\u52a1\u548c\u670d\u52a1\u6cbb\u7406\u4e0a\uff0c\u4ecd\u7136\u4f1a\u9762\u5bf9\u4e00\u4e9b\u590d\u6742\u6027\u548c\u5c40\u9650\u6027\u3002</p> <p>\u5728\u670d\u52a1\u6cbb\u7406\u4e0a\uff0c\u5df2\u7ecf\u6709\u8bb8\u591a\u6210\u719f\u7684 ServiceMesh \u6846\u67b6\u7528\u4e8e\u6269\u5145\u5176\u80fd\u529b\uff0c\u5982 Istio\u3001Linkerd\u3001Dapr \u7b49\u3002\u672c\u6587\u5c06\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528 Istio \u6269\u5145 Kubernetes \u7070\u5ea6\u53d1\u5e03\u7684\u80fd\u529b\u3002</p> <p>\u800c\u5728\u90e8\u7f72\u4e0a\uff0c\u5219\u4f1a\u5229\u7528\u5f00\u6e90\u9879\u76ee Rainbond \u4f5c\u4e3a\u57fa\u7840\u5e73\u53f0\u6765\u8fdb\u884c\u5b9e\u8df5\u3002Rainbond \u662f\u4e00\u4e2a\u4e91\u539f\u751f\u5e94\u7528\u7ba1\u7406\u5e73\u53f0\uff0c\u5b83\u4f7f\u7528\u300c\u4ee5\u5e94\u7528\u4e3a\u4e2d\u5fc3\u300d\u7684\u8bbe\u8ba1\u6a21\u5f0f\u3002\u57fa\u4e8e\u8fd9\u4e00\u8bbe\u8ba1\u6a21\u5f0f\u62bd\u8c61\u51fa\u4e86\u6807\u51c6\u5316\u7684\u5e94\u7528\u6a21\u578b\u3002</p> <p>\u4ece\u4f7f\u7528\u7684\u4f53\u9a8c\u4e0a\u4e0d\u9700\u8981\u5b66\u4e60\u548c\u7f16\u5199YAML\uff0c\u5373\u53ef\u5b9e\u73b0\u4e1a\u52a1\u5e94\u7528\u7684\u5168\u751f\u547d\u5468\u671f\u7ba1\u7406\u3002\u56e0\u6b64\u4f7f\u7528\u5b83\u7b80\u5316\u4e1a\u52a1\u7684\u90e8\u7f72\u548c\u7ba1\u7406\u3002\u540c\u65f6 Rainbond \u652f\u6301 ServiceMesh \u6846\u67b6\u7684\u66ff\u6362\uff0c\u4f7f\u6211\u4eec\u53ef\u4ee5\u6309\u9700\u9009\u62e9\u4e0e\u4e1a\u52a1\u6700\u5339\u914d\u7684 ServiceMesh \u6846\u67b6\u8fdb\u884c\u670d\u52a1\u6cbb\u7406\u3002</p>"},{"location":"chap7/k8s_isitio_gray/#kubernetes","title":"Kubernetes \u4e2d\u5982\u4f55\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03","text":"<p>\u5f53\u4f60\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e1a\u52a1\u65f6\uff0c\u53ef\u4ee5\u5229\u7528 Kubernetes \u539f\u751f\u63d0\u4f9b\u7684\u7070\u5ea6\u53d1\u5e03\u7684\u65b9\u5f0f\u53bb\u4e0a\u7ebf\u4e1a\u52a1\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u662f\u901a\u8fc7\u5728\u65e7\u7248\u672c\u548c\u65b0\u7248\u672c\u7684\u670d\u52a1\u4e4b\u95f4\uff0c\u5b9a\u4e49\u4e00\u4e2a\u5dee\u5f02\u5316\u7684 Label\uff0c\u6839\u636e\u4e0d\u540c\u7248\u672c\u4e4b\u95f4\u7684\u516c\u5171 Label \u8d1f\u8f7d\u6d41\u91cf\u5230\u540e\u7aef Pod\uff0c\u6700\u7ec8\u5b9e\u73b0\u6839\u636e Pod \u7684\u526f\u672c\u6570\u63a7\u5236\u6d41\u91cf\u7684\u767e\u5206\u6bd4\u3002</p> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff1a\u7528\u6237\u5b9a\u4e49\u4e86\u4e24\u4e2a Deployment \u5bf9\u8c61\uff0c\u5176\u4e2d\u65e7\u7248\u672c\u540d\u4e3a frontend-stable\uff0c\u67093\u4e2a\u526f\u672c\u3002</p> <p>\u65b0\u7248\u672c\u4e3a frontend-canary\uff0c\u67091\u4e2a\u526f\u672c\u3002\u6b64\u65f6\u5b9a\u4e49\u4e86\u4e00\u4e2a Service \u5bf9\u8c61\uff0c\u4f7f\u7528\u5b83\u4eec\u4e4b\u95f4\u516c\u5171\u7684 Label \u8fdb\u884c\u9009\u62e9\u3002\u8fd9\u5c31\u4f7f\u5f97\u7528\u6237\u8bbf\u95ee frontend \u8fd9\u4e2a Service \u65f6\uff0c\u80fd\u4ee5 3:1 \u7684\u6bd4\u4f8b\u540c\u65f6\u8bbf\u95ee\u5230\u4e24\u4e2a\u7248\u672c\u3002\u5e76\u4e14\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8c03\u6574\u526f\u672c\u6570\u6301\u7eed\u63a7\u5236\u6d41\u91cf\u6bd4\u4f8b\uff0c\u6700\u7ec8\u8fbe\u5230\u5b8c\u6574\u4e0a\u7ebf\u3002</p> <p> </p> <p>Kubernetes \u9ed8\u8ba4\u7684\u5b9e\u73b0\u65b9\u5f0f\u5728\u7b80\u5355\u7684\u90e8\u7f72\u573a\u666f\u4e0b\u5f88\u6709\u6548\uff0c\u4f46\u662f\u5728\u4e00\u4e9b\u590d\u6742\u573a\u666f\u4e2d\uff0c\u4ecd\u7136\u4f1a\u6709\u8f83\u5927\u7684\u5c40\u9650\uff0c\u5982\uff1a</p> <ul> <li>\u4e1a\u52a1\u914d\u7f6e\u81ea\u52a8\u4f38\u7f29\u540e\uff0c\u4f1a\u76f4\u63a5\u5f71\u54cd\u7070\u5ea6\u53d1\u5e03\u7684\u6d41\u91cf\u6bd4\u4f8b</li> <li>\u4f4e\u767e\u5206\u6bd4\u7684\u6d41\u91cf\u63a7\u5236\u5360\u7528\u8d44\u6e90\u9ad8\uff0c\u5982 1 % \u7684\u6d41\u91cf\u5230\u8fbe\u65b0\u7248\u672c\uff0c\u5219\u81f3\u5c11\u9700\u8981 100 \u4e2a\u526f\u672c</li> <li>\u7cbe\u786e\u7684\u6d41\u91cf\u5206\u53d1\u63a7\u5236\uff0c\u4f7f\u8bbf\u95ee\u5230\u65b0\u7248\u672c\u4e2d\u7684\u7528\u6237\u4e00\u76f4\u662f\u540c\u4e00\u6279\uff0c\u800c\u4e0d\u662f\u67d0\u4e2a\u7528\u6237\u8bbf\u95ee\u65f6\u968f\u673a\u5207\u6362</li> </ul>"},{"location":"chap7/k8s_isitio_gray/#istio","title":"Istio \u7070\u5ea6\u53d1\u5e03\u7b80\u8ff0","text":"<p>\u7531\u4e8e Kubernetes \u63d0\u4f9b\u7684\u7070\u5ea6\u53d1\u5e03\u65b9\u5f0f\u7684\u5c40\u9650\u6027\uff0c\u5728\u4e00\u4e9b\u590d\u6742\u573a\u666f\u4e0b\uff0c\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528 Istio \u6765\u5b9e\u73b0\u66f4\u7cbe\u7ec6\u7684\u7070\u5ea6\u53d1\u5e03\u7b56\u7565\u3002\u5728\u4f7f\u7528 Istio \u8fdb\u884c\u7070\u5ea6\u53d1\u5e03\u65f6\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3\u4e24\u4e2a\u91cd\u8981\u6982\u5ff5\uff1a</p> <ul> <li> <p>Virtual services: \u865a\u62df\u670d\u52a1\u5b9a\u4e49\u4e86\u8bf7\u6c42\u5230\u670d\u52a1\u7684\u8def\u5f84\u3002\u53ef\u4ee5\u5305\u542b\u4e00\u7ec4\u8def\u7531\u89c4\u5219\uff0c\u4f7f\u5339\u914d\u5230\u5bf9\u5e94\u89c4\u5219\u7684\u8bf7\u6c42\u80fd\u5230\u8fbe\u6307\u5b9a\u76ee\u6807\u3002</p> </li> <li> <p>Destination rules: \u76ee\u6807\u89c4\u5219\u53ef\u4ee5\u7ba1\u7406\u5230\u8fbe\u8be5\u76ee\u6807\u7684\u6d41\u91cf\uff0c\u5982\u5bf9\u670d\u52a1\u540e\u7aef\u6240\u5bf9\u5e94\u7684\u5b9e\u4f8b\u6c60\u8fdb\u884c\u5206\u7ec4\uff0c\u518d\u7ed3\u5408 Virtual services \u5b9a\u4e49\u7684\u8def\u7531\u89c4\u5219\uff0c\u6700\u7ec8\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u6b63\u786e\u7684\u5b9e\u4f8b\u4e0a\u3002</p> </li> </ul> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4ee5 istio \u5b98\u7f51\u63d0\u4f9b\u7684 Bookinfo \u793a\u4f8b\u7a0b\u5e8f\u4e3a\u4f8b\uff0c\u7ed9\u51fa\u4e86 virtual services \u548c destination rules \u7684\u4e3b\u8981\u5b9a\u4e49\u3002</p> <p>\u5176\u4e2d virtual services \u4e3b\u8981\u5206\u4e3a\u4e24\u5757\uff0c\u4e3b\u673a\u540d\u548c\u8def\u7531\u89c4\u5219\u3002\u4e3b\u673a\u540d\u662f\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\u65f6\u4f7f\u7528\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u5730\u5740\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe virtual services \u65f6\uff0c\u5219\u4f1a\u6839\u636e\u5176\u5b9a\u4e49\u7684\u8def\u7531\u89c4\u5219\u5339\u914d\u3002</p> <p>\u56fe\u4e2d\u5c31\u5b9a\u4e49\u4e86\u90ae\u7bb1\u4ee5 gmail.com \u7ed3\u5c3e\u7684\u7528\u6237\u6d41\u91cf\u53ea\u4f1a\u5230\u8fbe v3 \u7248\u672c\u7684\u5b9e\u4f8b\u4e0a\u3002\u800c\u5176\u4ed6\u7528\u6237\u5219\u4ee5 1:9 \u7684\u6bd4\u4f8b\u5206\u522b\u8bbf\u95ee\u5230 v1 \u548c v2 \u7248\u672c\u7684\u670d\u52a1\u3002\u8fd9\u79cd\u65b9\u5f0f\u5b9e\u73b0\u4e86\u7cbe\u786e\u7684\u6d41\u91cf\u5206\u53d1\u63a7\u5236\u3002</p> <p>\u5f53\u7528\u6237\u6d41\u91cf\u6765\u5230 <code>reviews.demo.svc.cluster.local</code> \u8fd9\u4e2a Service \u4e0a\u65f6\uff0c\u53ef\u4ee5\u770b\u5230 <code>destination rules</code> \u7684\u89c4\u5219\u5b9a\u4e49\u4e2d\u6839\u636e version \u8fd9\u4e2a label \u5b9a\u4e49\u4e86\u4e0d\u540c\u7684\u5b9e\u4f8b\u96c6\uff0c\u5b9e\u73b0\u4e86\u6d41\u91cf\u6bd4\u4f8b\u4e0e\u526f\u672c\u6570\u7684\u89e3\u8026\u3002</p> <p>\u4e0d\u7ba1 reviews-v1 \u6709\u591a\u5c11\u5b9e\u4f8b\u3002\u59cb\u7ec8\u53ea\u6709 10% \u7684\u6d41\u91cf\u5230\u8fbe destination rules \u7684 v1 \u5b50\u96c6\u4e2d\u3002\u8fd9\u5c31\u89e3\u51b3\u4e86\u4e1a\u52a1\u526f\u672c\u6570\u4e0e\u6d41\u91cf\u6bd4\u4f8b\u7684\u51b2\u7a81\u95ee\u9898\uff0c\u4e5f\u4f7f\u5f97\u8d44\u6e90\u4f7f\u7528\u66f4\u52a0\u5408\u7406\u3002</p> <p> </p>"},{"location":"chap7/k8s_isitio_gray/#istio-rainbond","title":"Istio \u7070\u5ea6\u53d1\u5e03\u5728 Rainbond \u4e0a\u7684\u5b9e\u8df5","text":"<p>\u57fa\u4e8e\u4ee5\u4e0a\u7406\u89e3\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u4ee5 BookInfo \u4e3a\u4f8b\u6765\u4f53\u9a8c Istio \u7684\u7070\u5ea6\u53d1\u5e03\u3002</p>"},{"location":"chap7/k8s_isitio_gray/#1","title":"1. \u51c6\u5907\u5de5\u4f5c\uff1a","text":"<p>\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u63d0\u524d\u5b89\u88c5\u597d\u6240\u9700\u8981\u7684\u73af\u5883\u3002</p> <p>\u300c\u5b89\u88c5 Rainbond\u300d</p> <p>\u53c2\u8003 Rainbond \u5b98\u65b9\u6587\u6863 \u5feb\u901f\u5b89\u88c5\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u901a\u8fc7\u5bf9\u63a5 Helm \u5546\u5e97\u4e00\u952e\u5b89\u88c5 Istio \u4ee5\u53ca\u76f8\u5e94\u7ec4\u4ef6\u3002</p> <p>\u300c\u5b89\u88c5 Istio \u4ee5\u53ca Kiali\u300d</p> <p>\u767b\u5f55\u5230 Rainbond \u63a7\u5236\u53f0\u540e\uff0c\u5148\u521b\u5efa\u4e00\u4e2a\u56e2\u961f\uff0c\u56e2\u961f\u82f1\u6587\u540d\u5bf9\u5e94 Kubernetes \u4e2d\u7684\u547d\u540d\u7a7a\u95f4\uff0cIstio \u9ed8\u8ba4\u5b89\u88c5\u7684\u547d\u540d\u7a7a\u95f4\u4e3a istio-system \uff0c\u56e0\u6b64\u56e2\u961f\u82f1\u6587\u540d\u586b\u5199istio-system\uff0c\u540d\u79f0\u53ef\u4ee5\u586b\u5199\u4e3a istio\u9879\u76ee\u3002\u63a5\u4e0b\u6765\u5bf9\u63a5 Helm \u5546\u5e97\uff0c\u901a\u8fc7 \u5e94\u7528\u5e02\u573a -&gt; \u70b9\u51fb\u2795\u53f7 -&gt; Helm \u5546\u5e97 \u5bf9\u63a5\u3002\u5546\u5e97\u540d\u79f0\u968f\u610f\u586b\u5199\uff0c\u5730\u5740\u586b\u5199 <code>https://openchart.goodrain.com/goodrain/rainbond</code>\u3002\u5546\u5e97\u5bf9\u63a5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5373\u53ef\u70b9\u51fb\u5b89\u88c5 istio\u3001kiali \u7b49\u5e94\u7528\u3002\u8be6\u7ec6\u53ef\u53c2\u8003 Istio \u5b89\u88c5\u3002</p>"},{"location":"chap7/k8s_isitio_gray/#2-bookinfo","title":"2. \u90e8\u7f72 BookInfo \u5e94\u7528","text":"<p>\u5728\u90e8\u7f72 BookInfo \u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5728 Rainbond \u4e2d\u521b\u5efa\u4e00\u4e2a\u56e2\u961f\u548c\u5e94\u7528\uff0c\u5e76\u5c06\u5e94\u7528\u7684\u6cbb\u7406\u6a21\u5f0f\u5207\u6362\u4e3a Istio \u6cbb\u7406\u6a21\u5f0f\u3002\u5728 Rainbond \u4e2d\u5e94\u7528\u6cbb\u7406\u6a21\u5f0f\u5207\u6362\u662f\u6307\u53ef\u4ee5\u65e0\u4fb5\u5165\u5730\u53d8\u66f4\u5e94\u7528\u4e0b\u7ec4\u4ef6\u95f4\u901a\u4fe1\u6cbb\u7406\u6a21\u5f0f\u3002</p> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4e00\u4e2a\u5b8c\u6574\u5e94\u7528\u4f1a\u5305\u542b\u591a\u4e2a\u5fae\u670d\u52a1\u6a21\u5757\uff0c\u800c ServiceMesh \u6846\u67b6\u5219\u662f\u5bf9\u6240\u6709\u4e1a\u52a1\u5bb9\u5668\u6ce8\u5165 Proxy\uff0c\u6839\u636e\u6ce8\u5165Proxy\u7684\u5dee\u5f02\u53ef\u4ee5\u652f\u6301\u591a\u79cd\u7c7b\u578b\u7684 ServiceMesh \u5b9e\u73b0\uff0c\u6bd4\u5982\uff1aIstio\u3001Linkerd\u3001Dapr\uff0c\u5e94\u7528\u53ef\u4ee5\u6309\u9700\u5f00\u542f ServiceMesh \u80fd\u529b\uff0c\u6216\u66f4\u6362\u5b9e\u73b0\u6846\u67b6\u3002</p> <p>\u4e3a\u4e86\u8ba9 BookInfo \u8fd9\u4e2a\u5e94\u7528\u4f7f\u7528\u5230 Istio \u7684\u6cbb\u7406\u80fd\u529b\uff0c\u6240\u4ee5\u9700\u8981\u5207\u6362\u5230 Istio \u6cbb\u7406\u6a21\u5f0f\u3002</p> <p> </p> <p>\u300c2.1 \u51c6\u5907\u955c\u50cf\u300d</p> <p>BookInfo \u8fd9\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7531 6 \u4e2a\u5fae\u670d\u52a1\u7ec4\u6210\uff0c\u5b83\u4eec\u4e4b\u95f4\u7684\u4f9d\u8d56\u5982\u4e0b\u56fe\u6240\u793a\u3002\u5176\u4e2d Productpage \u8fd9\u4e2a\u670d\u52a1\u63d0\u4f9b\u4e86\u8bbf\u95ee\u9875\u9762\uff0c\u4ece Details \u8fd9\u4e2a\u670d\u52a1\u4e2d\u83b7\u5f97\u4e66\u7c4d\u8be6\u7ec6\u4fe1\u606f\u3002\u4ece Reviews \u670d\u52a1\u4e2d\u83b7\u5f97\u4e66\u7c4d\u8bc4\u4ef7\u3002</p> <p>\u5176\u4e2d Reviews-v2 \u548c Reviews-v3 \u4f1a\u4ece Ratings \u8fd9\u4e2a\u670d\u52a1\u4e2d\u83b7\u5f97\u4e66\u7c4d\u7684\u8bc4\u7ea7\u4fe1\u606f\u3002\u8fd9\u516d\u4e2a\u5fae\u670d\u52a1\u7684\u955c\u50cf\u5982\u4e0b</p> <pre><code>docker.io/istio/examples-bookinfo-productpage-v1:1.17.0\ndocker.io/istio/examples-bookinfo-details-v1:1.17.0\ndocker.io/istio/examples-bookinfo-reviews-v1:1.17.0\ndocker.io/istio/examples-bookinfo-reviews-v2:1.17.0\ndocker.io/istio/examples-bookinfo-reviews-v3:1.17.0\ndocker.io/istio/examples-bookinfo-ratings-v1:1.17.0\n</code></pre> <p>\u300c2.2 \u90e8\u7f72\u7ec4\u4ef6\u300d</p> <p>\u6211\u4eec\u5728\u5e94\u7528\u4e0b\uff0c\u9009\u62e9\u6dfb\u52a0\u7ec4\u4ef6 -&gt; \u6307\u5b9a\u955c\u50cf -&gt; \u586b\u5199\u955c\u50cf\u5730\u5740 -&gt; \u65b0\u5efa\u7ec4\u4ef6 -&gt; \u786e\u8ba4\u521b\u5efa\uff0c\u5373\u53ef\u4f9d\u6b21\u521b\u5efa\u51fa\u8fd9 5 \u4e2a\u5fae\u670d\u52a1\u5bf9\u5e94\u7684\u7ec4\u4ef6\u3002</p> <p>\u300c2.3 \u751f\u6210\u53ef\u7528\u7684 Service\u300d</p> <p>\u521a\u521a\u6211\u4eec\u4ec5\u5b8c\u6210\u4e86\u6240\u6709\u670d\u52a1\u7684\u90e8\u7f72\uff0c\u8fd8\u672a\u5b9a\u4e49\u8fd9\u4e9b\u5fae\u670d\u52a1\u7684\u8bbf\u95ee\u7b56\u7565\u3002\u4ee5 Productpage \u4e3a\u4f8b\uff0c\u6211\u4eec\u901a\u8fc7\u70b9\u51fb\u62d3\u6251\u56fe\u4e2d Productpage \u8fd9\u4e2a\u7ec4\u4ef6\uff0c\u5373\u53ef\u8fdb\u5165\u8fd9\u4e2a\u670d\u52a1\u7684\u7ba1\u7406\u9875\u9762\u3002\u627e\u5230 \u7aef\u53e3 -&gt; \u6dfb\u52a0\u7aef\u53e3 -&gt; \u7aef\u53e3\u53f7\u586b\u51999080 -&gt; \u6253\u5f00\u5bf9\u5916\u670d\u52a1 -&gt; \u70b9\u51fb\u751f\u6210\u7684\u8def\u7531\uff0c\u5373\u53ef\u8bbf\u95ee\u6210\u529f\u3002\u6b64\u65f6\u4f1a\u53d1\u73b0 Productpage \u8fd9\u4e2a\u7ec4\u4ef6\u7684\u9875\u9762\u8fd8\u65e0\u6cd5\u62c9\u53d6\u5230\u4e66\u7c4d\u8bc4\u4ef7\u4fe1\u606f\u3002\u8fd9\u662f\u7531\u4e8e\u5b83\u9ed8\u8ba4\u4f7f\u7528 details \u548c reviews \u8fd9\u4e24\u4e2a Service \u540d\u79f0\u8fde\u63a5\u5230\u5b83\u4f9d\u8d56\u7684\u7ec4\u4ef6\u3002\u6b64\u65f6\u6211\u4eec\u90e8\u7f72\u7684 Reviews-v1 \u7b49\u7ec4\u4ef6\u8fd8\u6ca1\u6709\u6b63\u786e\u7684 Service \u540d\u79f0\u3002\u56e0\u6b64\u8fd8\u662f\u8fdb\u5165\u7ec4\u4ef6\u7ba1\u7406\u9875\u9762\uff0c\u7ec4\u4ef6\u7aef\u53e3 -&gt; \u6dfb\u52a0\u7aef\u53e3 -&gt; \u7aef\u53e3\u53f7\u586b\u51999080 -&gt; \u4fee\u6539\u4f7f\u7528\u522b\u540d -&gt; \u5185\u90e8\u57df\u540d\u586b\u5199\u4e3a reviews-v1 -&gt; \u6253\u5f00\u5bf9\u5185\u670d\u52a1\u3002details\u3001reviews-v2\u3001ratings \u7b49\u7ec4\u4ef6\u90fd\u662f\u5982\u6b64\uff0c\u586b\u5199\u5176\u5bf9\u5e94\u7684 Service \u540d\u79f0\u540e\uff0c\u6253\u5f00\u5bf9\u5185\u670d\u52a1\u5373\u53ef\u3002</p> <p>\u6700\u540e\u5728\u5e94\u7528\u7684 K8s \u8d44\u6e90\u4e0b\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u7684 Service\uff0c\u7528\u6765\u5728 Reviews \u7684\u4e09\u4e2a\u7248\u672c\u4e4b\u95f4\u8d1f\u8f7d\u6d41\u91cf\u3002</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: reviews\n    service: reviews\n  name: reviews\nspec:\n  ports:\n  - name: http\n    port: 9080\n    protocol: TCP\n    targetPort: 9080\n  selector:\n    component: reviews # \u9700\u8981\u5728 Reviews \u4e09\u4e2a\u7248\u672c\u4e2d\uff0c\u5747\u6dfb\u52a0 Kubernetes \u5c5e\u6027\uff0c\u8bbe\u7f6e\u4e0a\u8be5 Label\uff0c\u624d\u80fd\u6b63\u786e\u751f\u6548\n  sessionAffinity: None\n  type: ClusterIP\n</code></pre> <p>\u300c2.4 \u7f16\u6392\u4f9d\u8d56\u5173\u7cfb\u300d</p> <p>\u5b8c\u6210\u4ee5\u4e0a\u64cd\u4f5c\u540e\uff0c\u8bbf\u95ee Productpage \u5e94\u7528\uff0c\u53ef\u4ee5\u770b\u5230\u4e66\u7c4d\u8bc4\u8bba\u80fd\u6b63\u786e\u5728\u4e09\u4e2a\u7248\u672c\u4e2d\u5207\u6362\u4e86\u3002</p> <p>\u6b64\u65f6\uff0c\u53ef\u4ee5\u5728\u5e94\u7528\u89c6\u56fe\u4e0b\uff0c\u5207\u6362\u5230\u7f16\u6392\u6a21\u5f0f\uff0c\u6839\u636e\u4e0a\u8ff0 BookInfo \u5e94\u7528\u7684\u67b6\u6784\u56fe\u8fdb\u884c\u8fde\u7ebf\uff0c\u5b9e\u73b0\u62d3\u6251\u56fe\u7684\u7f16\u6392\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u8fd9\u6837\u7f16\u6392\u7684\u597d\u5904\u662f\u540e\u671f\u53ef\u4ee5\u5c06\u8fd9\u4e2a\u5e94\u7528\u6574\u4f53\u53d1\u5e03\u51fa\u53bb\uff0c\u5176\u4ed6\u7528\u6237\u76f4\u63a5\u5b89\u88c5\u4e0b\u6765\u5373\u53ef\u5f97\u5230\u4e00\u6837\u7684\u62d3\u6251\u5173\u7cfb\uff0c\u518d\u4e5f\u4e0d\u7528\u62c5\u5fc3\u627e\u4e0d\u5230\u5404\u4e2a\u670d\u52a1\u4f9d\u8d56\u7684\u7ec4\u4ef6\u3002</p> <p> </p>"},{"location":"chap7/k8s_isitio_gray/#3","title":"3. \u7070\u5ea6\u53d1\u5e03","text":"<p>\u5728\u5b8c\u6210\u4ee5\u4e0a\u90e8\u7f72\u64cd\u4f5c\u540e\uff0c\u6211\u4eec\u5f97\u5230\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684 BookInfo \u7a0b\u5e8f\uff0c\u4f46\u6b64\u65f6\u8fd8\u672a\u5b9a\u4e49 Istio \u76f8\u5173\u914d\u7f6e\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u901a\u8fc7 Kiali \u53bb\u5b9a\u4e49\u6d41\u91cf\u89c4\u5219\u3002\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03\u3002</p> <p>\u300c3.1 \u914d\u7f6e\u8def\u7531\u89c4\u5219\u300d</p> <p>\u8bbf\u95ee Kiali \u7ba1\u7406\u9875\u9762\uff0c\u5373\u53ef\u770b\u5230\u8be5\u5e94\u7528\u3002\u5728\u5de6\u4fa7\u8fb9\u680f\u9009\u62e9 Services\uff0c\u627e\u5230 reviews \u8fd9\u4e2a Service\uff0c\u70b9\u51fb\u8fdb\u5165\uff0c\u53f3\u4e0a\u89d2 Actions \u9009\u62e9 Traffic Shifting\uff0c\u5373\u53ef\u770b\u5230\u5982\u4e0b\u914d\u7f6e\uff1a\u62d6\u52a8\u6ed1\u5757\u9009\u62e9\u6d41\u91cf\u6bd4\u4f8b\u3002\u4e0b\u56fe\u4e2d 30% \u7684\u6d41\u91cf\u5c06\u4f1a\u8bbf\u95ee\u5230 reviews-v1 \u4e0a\uff0c70% \u7684\u6d41\u91cf\u8bbf\u95ee\u5230 reviews-v2\u4e0a\u3002\u70b9\u51fb\u521b\u5efa\u540e\uff0c\u5373\u53ef\u770b\u89c1\u9875\u9762\u5de6\u4e0b\u89d2\uff0cKiali \u81ea\u52a8\u4e3a\u4f60\u751f\u6210\u4e86 virtual services \u548c destination rules \u8d44\u6e90\u3002\u4f60\u53ef\u4ee5\u70b9\u51fb\u8fdb\u53bb\u6839\u636e\u81ea\u5df1\u9700\u6c42\u518d\u6b21\u7f16\u8f91\u3002</p> <p>\u300c3.2 \u9a8c\u8bc1\u8def\u7531\u89c4\u5219\u662f\u5426\u751f\u6548\u300d</p> <p>\u627e\u5230\u6700\u5f00\u59cb\u90e8\u7f72\u7684\u7ec4\u4ef6 Productpage\uff0c\u8fdb\u5165\u7ec4\u4ef6\u7ba1\u7406\u9875\u9762\uff0c\u70b9\u51fb\u53f3\u4e0a\u89d2\u8bbf\u95ee\u5165\u53e3\uff0c\u53ef\u4ee5\u770b\u5230\u4e66\u7c4d\u8be6\u60c5\u548c\u8bc4\u7ea7\uff0c\u53cd\u590d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u5e26\u661f\u7ea7\u7684\u8bc4\u4ef7\u4fe1\u606f(reviews-v1)\u4e0e\u9ed1\u8272\u661f\u7ea7\u8bc4\u4ef7\u4fe1\u606f(reviews-v2)\u51fa\u73b0\u7684\u6bd4\u4f8b\u5927\u6982\u662f 3:7\u3002\u7ea2\u8272\u661f\u7ea7\u8bc4\u4ef7\u4fe1\u606f(reviews-v3)\u4ece\u672a\u51fa\u73b0\u3002</p> <p>\u300c3.3 \u9a8c\u8bc1\u7ec4\u4ef6\u6269\u5bb9\u5bf9\u6d41\u91cf\u7684\u5f71\u54cd\u300d</p> <p>\u627e\u5230\u90e8\u7f72\u7684\u7ec4\u4ef6 reviews-v1 \uff0c\u8fdb\u5165\u7ec4\u4ef6\u7ba1\u7406\u9875\u9762 -&gt; \u4f38\u7f29 -&gt; \u5b9e\u4f8b\u6570\u91cf\u8bbe\u7f6e\u4e3a4\uff0c\u6b64\u65f6\u518d\u6b21\u8bbf\u95ee Productpage \u9875\u9762\uff0c\u53cd\u590d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230 reviews-v1  \u6269\u5bb9\u540e\uff0c\u8bbf\u95ee\u5230 reviews-v1 \u4e0e reviews-v2 \u7684\u6bd4\u4f8b\u4ecd\u4e3a 3:7\uff0c\u7ec4\u4ef6\u5b9e\u4f8b\u6570\u7684\u591a\u5c11\u5bf9\u6d41\u91cf\u5206\u53d1\u7b56\u7565\u6ca1\u6709\u5f71\u54cd\u3002</p>"},{"location":"chap8/10Istio_terms/","title":"\u7b2c\u5341\u8282 \u672f\u8bed\u8868","text":""},{"location":"chap8/10Istio_terms/#1","title":"1\u3001\u5bb9\u5668\uff0f\u5bb9\u5668\u955c\u50cf","text":"<p>\u5bb9\u5668\u5c06\u4f60\u7684\u4ee3\u7801\u548c\u6240\u6709\u7684\u4f9d\u8d56\u5173\u7cfb\u6253\u5305\u3002\u8fd9\u4f7f\u5f97\u5f97\u5bb9\u5668\u5316\u7684\u5e94\u7528\u7a0b\u5e8f\u80fd\u5668\u66f4\u5feb\uff0c\u66f4\u53ef\u9760\u5730\u8fd0\u884c\u800c\u4e0d\u53d7\u8ba1\u7b97\u673a\u5468\u73af\u5883\u7684\u5f71\u54cd\u3002\u5bb9\u5668\u9540\u50cf\u662f\u4e2a\u8f7b\u91cf\u7ea7\u7684\u72ec\u7acb\u7684\u53ef\u6267\u884c\u7684\u8f6f\u4ef6\u5305\u5305\u62ec\u8fd0\u884c\u5e94\u7528\uff0c\u7a0b\u5e8f\u6240\u9700\u7684\u4e00\u5207\uff1a \u4ee3\u7801\uff0c\u5de5\u5177\uff0c\u7cfb\u7edf\u5e93\u548c\u8bbe\u7f6e</p>"},{"location":"chap8/10Istio_terms/#2","title":"2\u3001\u63a7\u5236\u5e73\u9762","text":"<p>\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\u914d\u7f6e\u5e76\u63a7\u5236\u6570\u636e\u5e73\u9762\u3002</p> <p>\u5b83\u7531API\u548c\u5de5\u5177\u7ec4\u6210\u7528\u4e8e\u7ba1\u7406\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002</p> <p>\u670d\u52a1\u7f51\u683c\u8fd0\u7ef4\u53ef\u4ee5\u8bbf\u95ee\u63a7\u5236\u5e73\u9762\u4ee5\u914d\u7f6e\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002\u4f8b\u5982\uff0c\u5c06\u6d41\u91cf\u914d\u7f6e\u5e94\u7528\u4e8e\u63a7\u5236\u5e73\u9762\u7ffb\u8bd1\u914d\u7f6e\u5e76\u5c06\u5176\u63a8\u9001\u5230\u6570\u636e\u5e73\u9762</p>"},{"location":"chap8/10Istio_terms/#3","title":"3\u3001\u6570\u636e\u5e73\u9762","text":"<p>\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531\u8d1f\u8d23\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u53d1\u73b0\u3001\u5065\u5eb7\u68c0\u67e5\u548c\u6388\u6743/\u8ba4\u8bc1\u7684Envoy\u4ee3\u7406\u3002\u8fd9\u4e9b\u4ee3\u7406\u6bcf\u4e2a\u5b9e\u4f8b\u670d\u52a1\u5b9e\u4f8b\u8981\u8fb9\u8fd0\u884c\uff0c\u62e6\u622a\u6240\u6709\u4f20\u5165\u548c\u4f20\u51fa\u7684\u7528\u6237\u6d41\u91cf</p>"},{"location":"chap8/10Istio_terms/#4envoy","title":"4\u3001Envoy","text":"<p>Envoy\u4ee3\u7406\u662f\u4e2a\u73b0\u4ee3\u7684\u3001\u9ad8\u6027\u80fd\u8fb9\u7f18\u7684\u3001\u5c0f\u578b\u7684L7\u4ee3\u7406\u3002Envoy\u662f\u4e3a\u5927\u578b\u73b0\u4ee3\u9762\u5411\u670d\u52a1\u67b6\u6784\u8bbe\u8ba1\u7684\u3002\u5b83\u53ef\u4ee5\u4e0eNginx\u548cHAproxy\u7b49\u8f6f\u4ef6\u8d1f\u622a\u5747\u8857\u5668\u76f8\u5ab2\u7f8e\u3002 </p>"},{"location":"chap8/10Istio_terms/#5","title":"5\u3001\u5fae\u670d\u52a1","text":"<p>\u5fae\u670d\u52a1\u6216\u5fae\u670d\u52a1\u67b6\u6784\u662f\u4e00\u79cd\u67b6\u6784\u98ce\u683c\u3002\u5b83\u5c06\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6784\u5efa\u4e3a\u670d\u52a1\u7684\u96c6\u5408\u3002\u677e\u6563\u8026\u5408\u7684\u5fae\u670d\u52a1\u96c6\u5408\u63d0\u4f9b\u4e86\u4e0e\u5355\u4e2a\u5355\u4f53\u5e94\u7528\u76f8\u540c\u7684\u529f\u80fd\uff0c \u4f46\u6709\u989d\u5916\u7684\u4f18\u52bf\u3002\u5fae\u670d\u52a1\u53ef\u4ee5\u62bd\u7acb\u4e8e\u5176\u4ed6\u670d\u52a1\u8fdb\u884c\u5f00\u53d1\u548c\u90e8\u7f72\u3002\u5b83\u4eec\u662f\u56f4\u7ed5\u4e1a\u52a1\u80fd\u529b\u7ec4\u7ec7\u7684\uff0c \u7531\u8f83\u5c0f\u7684\u56e2\u961f\u62e5\u6709\u3002\u5b83\u4eec\u5728\u90e8\u7f72\u5f00\u53d1\u4e2d\u66f4\u5c0f\u3001\u66f4\u72ec\u7acb\u53ef\u4ee5\u66f4\u597d\u5730\u7ef4\u62a4\u548c\u6d4b\u8bd5 </p>"},{"location":"chap8/10Istio_terms/#6","title":"6\u3001\u4ee3\u7406","text":"<p>\u5728\u7f51\u7edc\u4e2d\uff0c\u4ee3\u7406\u670d\u52a1\u5668\u4f5c\u4e3a\u4e24\u65b9\u4e4b\u95f4\u7684\u4e00\u4e2a\u7f51\u5173\u3002\u5b83\u662f\u4e00\u4e2a\u4e2d\u95f4\u670d\u52a1\u5668\u4f4d\u5e72\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4e4b\u95f4\uff0c\u53ef\u4ee5\u7ba1\u7406\u8bf7\u6c42\u548c\u54cd\u5e94\u3002\u5728\u670d\u52a1\u7f51\u683c\u7684\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u4ee3\u7406(Envoy\uff09\u5728\u6bcf\u4e2a\u5e94\u7528\u5b9e\u4f8b\u524d\u9762\u8fd0\u884c</p> <p>\u5f53\u4f60\u5411\u5e94\u7528\u7a0b\u5e8f\u53d1\u51fa\u8bf7\u6c42\u65f6\uff0c\u4ee3\u7406\u62e6\u622a\u8be5\u8c13\u6c42\u5e76\u5c06\u5176\u8f6c\u53d1\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5b9e\u4f8b\u3002\u540c\u6837\u5730\uff0c\u5f53\u7a0b\u5e8f\u8bd5\u56fe\u53d1\u51fa\u8bf7\u5f55\u65f6\uff0c\u4ee3\u7406\u62e6\u622a\u51fa\u7ad9\u8c13\u6c42\u5e76\u5c06\u5176\u53d1\u8fed\u5230\u76ee\u7684\u5730\u3002\u7531\u4e8e\u4ee3\u7406\u62e6\u622a\u4e86\u6240\u6709\u7684\u6d41\u91cf\u3002 \u5b83\u4e5f\u53ef\u4ee5\u4fee\u6539\u8bf7\u6c42\u2014\u2014\u8fd9\u4f7f\u5f97\u6d41\u91cf\u8def\u7531\uff0c\u6545\u969c\u6ce8\u5165\u548c\u6388\u6743\u7b49\u529f\u80fd\u5f97\u4ee5\u5b9e\u73b0</p>"},{"location":"chap8/10Istio_terms/#7l7","title":"7\u3001L7\u4ee3\u7406","text":"<p>L7(\u7b2c\u4e03\u5c42)\u4ee3\u7406\u5728OSI\u5f15\u6a21\u578b\u7684\u5e94\u7528\u5c42\u5de5\u4f5c\u3002\u5728\u8fd9\u4e00\u5c42\u4ee3\u7406\u53ef\u4ee5\u5916\u56db\u6bcf\u4e2a\u8bf7\u6c42\u7684\u5185\u5bb9\u3002\u4e00\u4e2a\u6d41\u884c\u7684L7\u534f\u8bae\u662fHTTP,\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u8bbf\u95ee\u8c13\u6c42\u7684\u6570\u636e\uff0cL7\u4ee3\u7406\u53ef\u4ee5\u6839\u636e\u8c13\u6c42\u5185\u5bb9(URL\u3001cookies)\u505a\u51fa\u8d1f\u8f7d\u5747\u8861\u7684\u51b3\u5b9a </p>"},{"location":"chap8/1service_mesh/","title":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8","text":""},{"location":"chap8/1service_mesh/#1","title":"1\u3001\u670d\u52a1\u7f51\u683c\u6982\u8ff0","text":"<p>Service Mesh</p> <p>Dedicated infrastructure layer for managing service-to-service communication to make it manageable, visible, and controlled. </p> <ul> <li>Communication logic move out of the service </li> <li>Infrastructure layer = array of network proxies </li> <li>Network proxies deal with all communication between srvices </li> </ul> <p>Why Do I need Service Mesh</p> <ul> <li>Mutual TLS and automatic certificate rotation </li> <li>Identify performance and reliability issues using metrics </li> <li>Visualize metrics</li> <li>Debug services and tracing </li> <li>Traffic routing and mirroring </li> <li>Chaos testing </li> <li>Circuit breakers </li> </ul> <p> </p> <p>\u670d\u52a1\u7f51\u683c\u6240\u505a\u7684\u662f\uff0c\u5b83\u5c06\u8fd9\u79cd\u901a\u4fe1\u903b\u8f91\u3001\u91cd\u8bd5\u3001\u8d85\u65f6\u7b49\u4ece\u5355\u4e2a\u670d\u52a1\u4e2d\u5206\u79bb\u51fa\u6765\uff0c\u5e76\u5c06\u5176\u79fb\u5230\u4e00\u4e2a\u5355\u72ec\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\u3002</p> <p>\u5728\u670d\u52a1\u7f51\u683c\u7684\u60c5\u51b5\u4e0b\uff0c\u57fa\u7840\u8bbe\u65bd\u5c42\u662f\u4e00\u4e2a\u7f51\u7edc\u4ee3\u7406\u7684\u9635\u5217\u3002\u8fd9\u4e9b\u7f51\u7edc\u4ee3\u7406\u7684\u96c6\u5408\uff08\u6bcf\u4e2a\u670d\u52a1\u5b9e\u4f8b\u65c1\u8fb9\u90fd\u6709\u4e00\u4e2a\uff09\u5904\u7406\u4f60\u7684\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u903b\u8f91\u3002\u6211\u4eec\u79f0\u8fd9\u4e9b\u4ee3\u7406 \u4e3asidecar\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0e\u6bcf\u4e2a\u670d\u52a1\u5e76\u5b58\u3002 </p>"},{"location":"chap8/1service_mesh/#_1","title":"\u4e3a\u4ec0\u4e48\u9700\u8981\u670d\u52a1\u7f51\u683c","text":"<p>\u670d\u52a1\u7f51\u683c\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u79cd\u4e00\u81f4\u7684\u65b9\u5f0f\u6765\u8fde\u63a5\u3001\u4fdd\u62a4\u548c\u89c2\u5bdf\u5fae\u670d\u52a1\u3002\u7f51\u683c\u5185\u7684\u4ee3\u7406\u6355\u83b7\u4e86\u7f51\u683c \u5185\u6240\u6709\u901a\u4fe1\u7684\u8bf7\u6c42\u548c\u6307\u6807\u3002\u6bcf\u4e00\u6b21\u5931\u8d25\u3001\u6bcf\u4e00\u6b21\u6210\u529f\u7684\u8c03\u7528\u3001\u91cd\u8bd5\u6216\u8d85\u65f6\u90fd\u53ef\u4ee5\u88ab\u6355\u83b7\u3001\u53ef\u89c6\u5316\uff0c\u5e76\u53d1\u51fa\u8b66\u62a5\u3002\u6b64\u5916\uff0c\u53ef\u4ee5\u6839\u636e\u8bf7\u6c42\u5c5e\u6027\u505a\u51fa\u51b3\u5b9a\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u67e5\u5165\u7ad9\uff08\u6216\u51fa\u7ad9\uff09\u8bf7\u6c42\u5e76\u7f16\u5199\u89c4\u5219\uff0c\u5c06\u6240\u6709\u5177\u6709\u7279\u5b9a\u5934\u503c\u7684\u8bf7\u6c42\u8def\u7531\u5230\u4e0d\u540c\u7684\u670d\u52a1\u7248\u672c\u3002</p> <p>\u6240\u6709\u8fd9\u4e9b\u4fe1\u606f\u548c\u6536\u96c6\u5230\u7684\u6307\u6807\u4f7f\u5f97\u4e00\u4e9b\u573a\u666f\u53ef\u4ee5\u5408\u7406\u5730\u76f4\u63a5\u5b9e\u73b0\u3002\u5f00\u53d1\u4eba\u5458\u548c\u8fd0\u8425\u5546\u53ef\u4ee5\u914d\u7f6e\u548c\u6267\u884c\u4ee5\u4e0b\u65b9\u6848\uff0c\u800c\u4e0d\u9700\u8981\u5bf9\u670d\u52a1\u8fdb\u884c\u4efb\u4f55\u4ee3\u7801\u4fee\u6539\u3002 </p> <ul> <li>mTLS\u548c\u81ea\u52a8\u8bc1\u4e66\u8f6e\u6362 </li> <li>\u4f7f\u7528\u6307\u6807\u8bc6\u522b\uff0c\u6027\u80fd\u548c\u53ef\u9760\u6027\u95ee\u9898 </li> <li>\u5728Grafana\u7b49\u5de5\u5177\u4e2d\u5b9e\u73b0\u6307\u6807\u7684\u53ef\u89c6\u5316\uff1b\u8fd9\u8fdb\u4e00\u6b65\u5141\u8bb8\u6539\u53d8\u5e76\u4e0ePagerDuty\u6574\u5408</li> <li>\u4f7f\u7528Jaeger\u6216Zipkin\u5bf9\u670d\u52a1\u8fdb\u884c\u8c03\u8bd5\u548c\u8ffd\u8e2a </li> <li>\u57fa\u4e8e\u6743\u91cd\u548c\u8bf7\u6c42\u7684\u6d41\u91cf\u8def\u7531\uff0c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0cA/B\u6d4b\u8bd5 </li> <li>\u6d41\u91cf\u955c\u50cf </li> <li>\u901a\u8fc7\u8d85\u65f6\u548c\u91cd\u8bd5\u63d0\u9ad8\u670d\u52a1\u7684\u5f39\u6027 </li> <li>\u901a\u8fc7\u5728\u670d\u52a1\u4e4b\u95f4\u6ce8\u5165\u6545\u969c\u548c\u5ef6\u8fdf\u6765\u8fdb\u884c\u6df7\u6c8c\u6d4b\u8bd5 </li> <li>\u68c0\u6d4b\u548c\u5f39\u51fa\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u5b9e\u4f8b\u7684\u65ad\u8def\u5668\u3002 </li> </ul>"},{"location":"chap8/1service_mesh/#2istio","title":"2\u3001Istio \u7b80\u4ecb","text":""},{"location":"chap8/1service_mesh/#istio-features","title":"Istio Features","text":"<ul> <li> <p>Traffic management </p> <ul> <li>Control flow of traffic between service </li> <li>Circuit breakers, timeouts, and retries </li> </ul> </li> <li> <p>Observability </p> <ul> <li>Tracing, monitoring, and logging </li> </ul> </li> <li> <p>Security </p> <ul> <li>Authentication, authorization, and encryption </li> <li>Enforce policies </li> </ul> </li> </ul> <p> </p>"},{"location":"chap8/1service_mesh/#envoy-data-plane","title":"Envoy (data plane)","text":"<ul> <li>High-performance proxy (C++) </li> <li>Injected next to application containers </li> <li>Intercepts all traffic for the service </li> <li>Pluggable extension model based on WebAssembly </li> </ul>"},{"location":"chap8/1service_mesh/#istiod-control-plane","title":"Istiod (control plane)","text":"<ul> <li>Service discovery </li> <li>Configuration </li> <li>Certificate management </li> <li>Converts YAML to Envoy-readable configuration <ul> <li>propagates it to all sidecars in the mesh </li> </ul> </li> </ul>"},{"location":"chap8/1service_mesh/#istlo","title":"Istlo\u7b80\u4ecb","text":"<p>Istio\u662f\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\u7684\u5f00\u6e90\u5b9e\u73b0\u3002\u4ece\u5b8f\u89c2\u4e0a\u6765\u770bIstio\u652f\u6301\u4ee5\u4e0b\u529f\u80fd\u3002 </p> <p>1\uff0e\u6d41\u91cf\u7ba1\u7406 </p> <p>\u5229\u7528\u914d\u7f6e\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u670d\u52a1\u95f4\u7684\u6d41\u91cf\u3002\u8bbe\u7f6e\u65ad\u8def\u5668\u3001\u8d85\u65f6\u6216\u91cd\u8bd5\u90fd\u53ef\u4ee5\u901a\u8fc7\u7b80\u5355\u7684\u914d\u7f6e\u6539\u53d8 \u6765\u5b8c\u6210\u3002 </p> <p>2\uff0e\u53ef\u89c2\u5bdf\u6027 </p> <p>Istio\u901a\u8fc7\u8ddf\u8e2a\u3001\u76d1\u63a7\u548c\u8bb0\u5f55\u8ba9\u6211\u4eec\u66f4\u597d\u5730\u4e86\u89e3\u670d\u52a1\uff0c\u8ba9\u6211\u4eec\u80fd\u591f\u5feb\u901f\u53d1\u73b0\u548c\u4fee\u590d\u95ee\u9898\u3002 </p> <p>3\uff0e\u5b89\u5168\u6027 </p> <p>Istio\u53ef\u4ee5\u5728\u4ee3\u7406\u5c42\u9762\u4e0a\u7ba1\u7406\u8ba4\u8bc1\u3001\u6388\u6743\u548c\u901a\u4fe1\u7684\u52a0\u5bc6\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5feb\u901f\u7684\u914d\u7f6e\u53d8\u66f4\u5728\u5404\u4e2a\u670d \u52a1\u4e2d\u6267\u884c\u7b56\u7565\u3002 </p>"},{"location":"chap8/1service_mesh/#istio_1","title":"Istio\u7ec4\u4ef6","text":"<p>Istio\u670d\u52a1\u7f51\u683c\u6709\u4e24\u4e2a\u90e8\u5206\uff1a\u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762\u3002 </p> <p>\u5728\u6784\u5efa\u5206\u5e03\u5f0f\u7cfb\u7edf\u65f6\uff0c\u5c06\u7ec4\u4ef6\u5206\u79bb\u6210\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u662f\u4e00\u79cd\u5e38\u89c1\u7684\u6a21\u5f0f\u3002</p> <p>\u6570\u636e\u5e73\u9762\u7684\u7ec4\u4ef6\u5728\u8bf7\u6c42\u8def\u5f84\u4e0a\uff0c\u800c\u63a7\u5236\u5e73\u9762\u7684\u7ec4\u4ef6\u5219\u5e2e\u52a9\u6570\u636e\u5e73\u9762\u5b8c\u6210\u5176\u5de5\u4f5c\u3002 </p> <p>Istio\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531Envoy\u4ee3\u7406\u7ec4\u6210\uff0c\u63a7\u5236\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u3002\u7f51\u683c\u7684\u63a7\u5236\u5e73\u9762\u90e8\u5206\u8d1f\u8d23\u7ba1\u7406\u4e0d\u53e3\u914d\u7f6e\u4ee3\u7406\u3002 </p>"},{"location":"chap8/1service_mesh/#envoy","title":"Envoy\uff08\u6570\u636e\u5e73\u9762\uff09","text":"<p>Envoy\u662f\u4e00\u4e2a\u7528C+\uff0b\u5f00\u53d1\u7684\u9ad8\u6027\u80fd\u4ee3\u7406\u3002Istio\u670d\u52a1\u7f51\u683c\u5c06Envoy\u4ee3\u7406\u4f5c\u4e3a\u4e00\u4e2a sidecar\u5bb9\u5668\u6ce8\u5165\u5230\u4f60\u7684\u5e94\u7528\u5bb9\u5668\u65c1\u8fb9\u3002\u7136\u540e\u8be5\u4ee3\u7406\u62e6\u622a\u8be5\u670d\u52a1\u7684\u6240\u6709\u5165\u7ad9\u548c\u51fa\u7ad9 \u6d41\u91cf\u3002\u6ce8\u5165\u7684\u4ee3\u7406\u4e00\u8d77\u6784\u6210\u4e86\u670d\u52a1\u7f51\u683c\u7684\u6570\u636e\u5e73\u9762\u3002 </p> <p>Envoy\u4ee3\u7406\u4e5f\u662f\u552f\u4e00\u4e0e\u6d41\u91cf\u8fdb\u884c\u4ea4\u4e92\u7684\u7ec4\u4ef6\u3002\u9664\u4e86\u524d\u9762\u63d0\u5230\u7684\u529f\u80fd\u2015\u8d1f\u8f7d\u5747\u8861\u3001\u65ad\u8def\u5668\u3001\u6545\u969c\u6ce8\u5165\u7b49\u3002Envoy\u8fd8\u652f\u6301\u57fa\u4e8eWebAssembly (WASM\uff09\u7684\u53ef\u63d2\u62d4\u6269\u5c55\u6a21\u578b\u3002\u8fd9\u79cd\u53ef\u6269\u5c55\u6027\u4f7f\u6211\u4eec\u80fd\u591f\u6267\u884c\u81ea\u5b9a\u4e49\u7b56\u7565\uff0c\u5e76\u4e3a\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\u751f\u6210\u9065\u6d4b\u6570\u636e\u3002 </p>"},{"location":"chap8/1service_mesh/#istiod","title":"Istiod\uff08\u63a7\u5236\u5e73\u9762)","text":"<p>Istiod\u662f\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\uff0c\u63d0\u4f9b\u670d\u52a1\u53d1\u73b0\u3001\u914d\u7f6e\u548c\u8bc1\u4e66\u7ba1\u7406\u529f\u80fd\u3002Istiod\u91c7\u7528YAML\u7f16\u5199\u7684\u9ad8\u7ea7\u89c4\u5219\uff0c\u5e76\u5c06\u5176\u8f6c\u6362\u4e3aEnvoy\u7684\u53ef\u64cd\u4f5c\u914d\u7f6e\u3002\u7136\u540e\uff0c\u5b83\u628a\u8fd9\u4e2a\u914d\u7f6e\u4f20\u64ad\u7ed9 \u7f51\u683c\u4e2d\u7684\u6240\u6709sidecar</p> <p>Istiod\u5185\u90e8\u7684Pilot\u7ec4\u4ef6\u62bd\u8c61\u51fa\u7279\u5b9a\u5e73\u53f0\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\uff08Kubernetes\u3001 Consul \u6216VM)\uff0c\u5e76\u5c06\u5176\u8f6c\u6362\u4e3asidecar\u53ef\u4ee5\u4f7f\u7528\u7684\u6807\u51c6\u683c\u5f0f\u3002</p> <p>\u4f7f\u7528\u5185\u7f6e\u7684\u8eab\u4efd\u548c\u51ed\u8bc1\u7ba1\u7406\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9e\u73b0\u5f3a\u5927\u7684\u670d\u52a1\u95f4\u548c\u7ec8\u7aef\u7528\u6237\u8ba4\u8bc1\u3002\u901a\u8fc7\u6388 \u6743\u529f\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u8c01\u53ef\u4ee5\u8bbf\u95ee\u670d\u52a1\u3002 </p> <p>\u63a7\u5236\u5e73\u9762\u7684\u90e8\u5206\u4ee5\u524d\u88ab\u79f0\u4e3aCitadel\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u8bc1\u4e66\u6388\u6743\u673a\u6784\uff0c\u751f\u6210\u8bc1\u4e66\uff0c\u5141\u8bb8\u6570\u636e\u5e73\u9762\u4e2d\u7684\u4ee3\u7406\u4e4b\u95f4\u8fdb\u884c\u5b89\u5168\u7684mTLS\u901a\u4fe1\u3002 </p>"},{"location":"chap8/1service_mesh/#3-istio","title":"3\u3001\u6d4b\u9a8c\uff1a\u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8","text":"<p>1.\u670d\u52a1\u7f51\u683c\u5982\u4f55\u5e2e\u52a9\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u903b\u8f91\uff1f </p> <ul> <li>A \u964d\u4f4e\u5ef6\u8fdf </li> <li>B \u53ef\u4ee5\u8ba9\u4f60\u66f4\u5feb\u7684\u4f38\u7f29\u670d\u52a1 </li> <li>C \u5c06\u903b\u8f91\u5206\u79bb\u5230\u57fa\u7840\u5b9e\u65bd\u5c42 </li> <li>D \u8ba9\u90e8\u7f72\u66f4\u52a0\u8fc5\u901f </li> </ul> <p>2.\u4ece\u5b8f\u89c2\u4e0a\u770b\uff0cIstio\u670d\u52a1\u7f51\u683c\u7531\u54ea\u4e24\u90e8\u5206\u7ec4\u6210\uff1f </p> <ul> <li>\u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 </li> <li>Istio Pilot\u548cEnvoy </li> <li>\u6570\u636e\u5e73\u9762\u548cEnvoy\u4ee3\u7406 </li> <li>Envoy\u4ee3\u7406\u548c\u914d\u7f6e </li> </ul> <p>3.\u670d\u52a1\u7f51\u683c\u7684\u4ee3\u7406\u4e5f\u53eb\u505a\u4ec0\u4e48\uff1f </p> <ul> <li>A Ambassador </li> <li>B Adapter </li> <li>C Interface </li> <li>D Sidecar </li> </ul> <p>4.Istio\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531\u7528\u6237\u7684\u670d\u52a1\u7ec4\u6210\u3002\u5bf9\u8fd8\u662f\u9519\uff1f </p> <ul> <li>\u5bf9</li> <li>\u9519</li> </ul> <p>6.Istio\u4e2d\u7684\u54ea\u4e2a\u7ec4\u4ef6\u53ef\u4ee5\u5c06YAML\u89c4\u5219\u8f6c\u6362\u4e3aEnvoy\u914d\u7f6e\uff1f </p> <ul> <li>A Envoy </li> <li>B Istiod </li> <li>C Sidecar </li> <li>D Citadel </li> </ul> <p>7.\u4ece\u4e0b\u9762\u7684\u5217\u8868\u4e2d\u9009\u51fa\u5fae\u670d\u52a1\u67b6\u6784\u7684\u4e24\u4e2a\u597d\u5904\uff1f </p> <ul> <li>A \u53ef\u4f38\u7f29\u6027</li> <li>B \u66f4\u5c0f\u7684\u56e2\u961f </li> <li>C \u7b80\u5316\u670d\u52a1\u4e4b\u95f4\u7684\u6c9f\u901a </li> <li>D \u4fbf\u4e8e\u8c03\u8bd5 </li> <li>E \u4fbf\u4e8e\u6d4b\u8bd5 </li> </ul>"},{"location":"chap8/2Istio_install/","title":"\u7b2c\u4e8c\u8282 \u5b89\u88c5 Istio","text":""},{"location":"chap8/2Istio_install/#1-istio","title":"1\u3001\u5b89\u88c5 Istio","text":"<ul> <li>istioctl <ul> <li>Command-line utilitiy </li> </ul> </li> </ul> <p>Istio Operator </p> <ul> <li>Uses a custom resource</li> <li>Deals with Istio upgrades </li> </ul> <p>Configuration profiles</p> <ul> <li>Istio configuration profiles: <ul> <li>default </li> <li>demo </li> <li>empty </li> <li>minimal </li> <li>preview </li> <li>remote </li> </ul> </li> </ul> <p>\u6211\u4eec\u6709\u4e24\u79cd\u65b9\u6cd5\u53ef\u4ee5\u5728\u5355\u4e2aKubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5Istio\uff1a\u4f7f\u7528Istiocti (istiocti)\u6216\u4f7f\u7528 Istio Operator\u3002\u5728\u672c\u6a21\u5757\u4e2d\uff0c\u6211\u4eec\u5c06\u4f7f\u7528Istio Operator\u5728\u4e00\u4e2aKubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5 Istio\u3002 </p>"},{"location":"chap8/2Istio_install/#istioctl","title":"\u4f7f\u7528Istioctl\u5b89\u88c5","text":"<p>Istioctl \u662f\u4e00\u4e2a\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u5b89\u88c5\u548c\u5b9a\u5236Istio\u7684\u5b89\u88c5\u3002\u4f7f\u7528\u8be5\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u6211\u4eec\u751f\u6210\u4e00\u4e2a\u5305\u542b\u6240\u6709Istio\u8d44\u6e90\u7684YAML\u6587\u4ef6\uff0c\u7136\u540e\u5c06\u5176\u90e8\u7f72\u5230Kubernetes\u96c6\u7fa4\u4e0a\u3002 </p>"},{"location":"chap8/2Istio_install/#istio-operator","title":"\u4f7f\u7528Istio Operator\u5b89\u88c5","text":"<p>\u4e0eistioctl\u76f8\u6bd4\uff0cIstio Operator\u5b89\u88c5\u7684\u4f18\u52bf\u5728\u4e8e\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u624b\u52a8\u5347\u7ea7Istio\u3002\u76f8\u53cd\uff0c\u6211\u4eec\u53ef \u4ee5\u90e8\u7f72Istio Operator\uff0c\u4e3a\u4f60\u7ba1\u7406\u5b89\u88c5\u3002\u6211\u4eec\u901a\u8fc7\u66f4\u65b0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u8d44\u6e90\u6765\u63a7\u5236Operator\uff0c\u800c Operator\u5219\u4e3a\u4f60\u5e94\u7528\u914d\u7f6e\u53d8\u5316\u3002 </p>"},{"location":"chap8/2Istio_install/#_1","title":"\u751f\u4ea7\u90e8\u7f72\u60c5\u51b5\u5982\u4f55\uff1f","text":"<p>\u5728\u51b3\u5b9aIstio\u7684\u751f\u4ea7\u90e8\u7f72\u6a21\u5f0f\u65f6\uff0c\u8fd8\u6709\u4e00\u4e9b\u989d\u5916\u7684\u8003\u8651\u56e0\u7d20\u9700\u8981\u7262\u8bb0\u3002\u6211\u4eec\u53ef\u4ee5\u914d\u7f6eIstio\u5728\u4e0d\u540c\u7684\u90e8\u7f72\u6a21\u578b\u4e2d\u8fd0\u884c\u2015\u53ef\u80fd\u8de8\u8d8a\u591a\u4e2a\u96c6\u7fa4\u548c\u7f51\u7edc\uff0c\u5e76\u4f7f\u7528\u591a\u4e2a\u63a7\u5236\u5e73\u9762\u3002\u6211\u4eec\u5c06\u5728\u9ad8\u7ea7\u529f\u80fd \u6a21\u5757\u4e2d\u4e86\u89e3\u5176\u4ed6\u90e8\u7f72\u6a21\u5f0f\u3001\u591a\u96c6\u7fa4\u5b89\u88c5\u4ee5\u53ca\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u5de5\u4f5c\u8d1f\u8f7d\u3002</p>"},{"location":"chap8/2Istio_install/#2getmesh","title":"2\u3001GetMesh","text":"<p>Istio\u662f\u6700\u53d7\u6b22\u8fce\u548c\u53d1\u5c55\u6700\u5feb\u7684\u5f00\u6e90\u9879\u76ee\u4e4b\u4e00\u3002\u5b83\u7684\u53d1\u5e03\u65f6\u95f4\u8868\u5bf9\u4f01\u4e1a\u7684\u751f\u547d\u5468\u671f\u548c\u53d8\u66f4\u7ba1\u7406\u5b9e \u8df5\u6765\u8bf4\u53ef\u80fd\u975e\u5e38\u6fc0\u8fdb\u3002GetMesh\u901a\u8fc7\u9488\u5bf9\u4e0d\u540c\u7684Ku bernetes\u5206\u53d1\u7248\u6d4b\u8bd5\u6240\u6709Istio\u7248\u672c\u4ee5\u786e\u4fdd\u529f\u80fd\u7684\u5b8c\u6574\u6027\u6765\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u3002</p> <p>GetMesh\u7684Istio\u7248\u672c\u5728\u5b89\u5168\u8865\u4e01\u548c\u5176\u4ed6\u9519\u8bef\u66f4\u65b0\u65b9\u9762\u5f97\u5230 \u79ef\u6781\u7684\u652f\u6301\uff0c\u5e76\u62e5\u6709\u6bd4\u4e0a\u6e38Istio\u63d0\u4f9b\u7684\u66f4\u957f\u7684\u652f\u6301\u671f\u3002 \u4e00\u4e9b\u670d\u52a1\u7f51\u683c\u5ba2\u6237\u9700\u8981\u652f\u6301\u66f4\u9ad8\u7684\u5b89\u5168\u8981\u6c42\u3002</p>"},{"location":"chap8/2Istio_install/#_2","title":"\u5982\u4f55\u5f00\u59cb\uff1f","text":"<p>\u7b2c\u4e00\u6b65\u662f\u4e0b\u8f7dGetMesh CLI\u3002\u4f60\u53ef\u4ee5\u5728macOS\u548cLinux\u5e73\u53f0\u4e0a\u5b89\u88c5GetMesh\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684GetMesh\u5e76\u8ba4\u8bc1Istio0 </p> <pre><code>curl -sL https://istio.tetratelabs.io/getmesh/install.sh | bash\n</code></pre> <pre><code>$ getmesh version\ngetmesh version: 1.1.3\nactive istioctl: 1.10.3-tetrate-v0\nno running Istio pods in \"istio-system\"\n1.10.3-tetrate-v0\n</code></pre> <p>\u7248\u672c\u547d\u4ee4\u8f93\u51fa<code>GetMesh</code>\u7684\u7248\u672c\u3001\u6d3b\u8dc3\u7684Istio CLI\u7684\u7248\u672c\u4ee5\u53caKubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5\u7684 Istio\u7684\u7248\u672c\u3002 </p>"},{"location":"chap8/2Istio_install/#getmeshistio","title":"\u4f7f\u7528GetMesh\u5b89\u88c5Istio","text":"<p>GetMesh\u901a\u8fc7Kubernetes\u914d\u7f6e\u6587\u4ef6\u4e0e\u6d3b\u8dc3\u7684Kubernetes\u96c6\u7fa4\u8fdb\u884c\u901a\u4fe1\u3002 </p> <p>\u8981\u5728\u5f53\u524d\u6d3b\u8dc3\u7684Kubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5Istio\u7684\u6f14\u793a\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u50cf\u8fd9\u6837\u4f7f\u7528<code>getmesh istioctl</code>\u547d\u4ee4\uff1a </p> <pre><code>getmesh istioctl install --set profile=demo\n</code></pre> <p>\u8be5\u547d\u4ee4\u5c06\u68c0\u67e5\u96c6\u7fa4\uff0c\u4ee5\u786e\u4fdd\u5b83\u51c6\u5907\u597d\u5b89\u88c5Istio\uff0c\u4e00\u65e6\u4f60\u786e\u8ba4\uff0c\u5b89\u88c5\u7a0b\u5e8f\u5c06\u7ee7\u7eed\u4f7f\u7528\u9009\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u5b89\u88c5Istio</p> <p>\u5982\u679c\u6211\u4eec\u73b0\u5728\u68c0\u67e5\u7248\u672c\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u8f93\u51fa\u663e\u793a\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u7684\u7248\u672c\u3002 </p>"},{"location":"chap8/2Istio_install/#_3","title":"\u9a8c\u8bc1\u914d\u7f6e","text":"<p><code>config-validate</code>\u547d\u4ee4\u5141\u8bb8\u4f60\u5bf9\u5f53\u524d\u914d\u7f6e\u548c\u4efb\u4f55\u5c1a\u672a\u5e94\u7528\u7684YAML\u6e05\u5355\u8fdb\u884c\u9a8c\u8bc1\u3002 </p> <p>\u8be5\u547d\u4ee4\u4f7f\u7528\u5916\u90e8\u8d44\u6e90\u8c03\u7528\u4e00\u7cfb\u5217\u9a8c\u8bc1\uff0c\u5982\u4e0a\u6e38Istio\u9a8c\u8bc1\u3001Kiali\u5e93\u548cGetMesh\u81ea\u5b9a\u4e49\u914d\u7f6e\u68c0\u67e5\u3002 </p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u547d\u4ee4\u8f93\u51fa\u7684\u4f8b\u5b50\uff0c\u5982\u679c\u6ca1\u6709\u6807\u8bb0\u4e3aIstio\u6ce8\u5165\u7684\u547d\u540d\u7a7a\u95f4\u3002 </p> <pre><code>$ getmesh config-validate\nRunning the config validator. This may take some time...\n\nResource PeerAuthentication not found in the cluster. Maybe Istio has not been installed in your cluster. Please make sure Istio is installed before execute \"getmesh config-validate\"\n</code></pre> <p> </p> <pre><code>getmesh config-validate my-resource.yaml\n</code></pre>"},{"location":"chap8/2Istio_install/#istio-cli","title":"\u7ba1\u7406\u591a\u4e2a Istio CLI","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 show \u547d\u4ee4\u6765\u5217\u51fa\u5f53\u524d\u4e0b\u8f7d\u7684 Istio \u7248\u672c</p> <pre><code>$ getmesh show\n1.10.3-tetrate-v0 (Active)\n</code></pre> <p>\u5982\u679c\u7535\u8111\u4e0a\u6ca1\u6709\u6211\u4eec\u60f3\u4f7f\u7528\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>getmesh list</code> \u547d\u4ee4\u6765\u5217\u51fa\u6240\u6709\u53ef\u4fe1\u7684 Istio \u7248\u672c\uff1a</p> <pre><code>$ getmesh list\nISTIO VERSION     FLAVOR    FLAVOR VERSION     K8S VERSIONS\n   *1.10.3        tetrate         0         1.17,1.18,1.19,1.20\n   1.10.3       tetratefips       0         1.17,1.18,1.19,1.20\n   1.10.3          istio          0         1.17,1.18,1.19,1.20\n    1.9.7         tetrate         0         1.17,1.18,1.19,1.20\n    1.9.7       tetratefips       0         1.17,1.18,1.19,1.20\n    1.9.7          istio          0         1.17,1.18,1.19,1.20\n    1.9.5         tetrate         0         1.17,1.18,1.19,1.20\n    1.9.5          istio          0         1.17,1.18,1.19,1.20\n    1.9.4         tetrate         0         1.17,1.18,1.19,1.20\n    1.9.4          istio          0         1.17,1.18,1.19,1.20\n    1.9.0         tetrate         0         1.17,1.18,1.19,1.20\n    1.9.0       tetratefips       1         1.17,1.18,1.19,1.20\n    1.9.0          istio          0         1.17,1.18,1.19,1.20\n    1.8.6         tetrate         0         1.16,1.17,1.18,1.19\n    1.8.6          istio          0         1.16,1.17,1.18,1.19\n    1.8.5         tetrate         0         1.16,1.17,1.18,1.19\n    1.8.5          istio          0         1.16,1.17,1.18,1.19\n    1.8.3         tetrate         0         1.16,1.17,1.18,1.19\n    1.8.3       tetratefips       1         1.16,1.17,1.18,1.19\n    1.8.3          istio          0         1.16,1.17,1.18,1.19\n    1.7.8         tetrate         0           1.16,1.17,1.18\n    1.7.8          istio          0           1.16,1.17,1.18\n</code></pre> <p>\u8981\u83b7\u53d6\u4e00\u4e2a\u7279\u5b9a\u7684\u7248\u672c</p> <pre><code>getmesh fetch --version 1.9.0 --flavor tetratefips --flavor-version 1\n</code></pre> <pre><code>$ getmesh show \n1.9.0-tetratefips-v1 (Active) \n1.9.5-tetrate-v0 \n</code></pre> <p>\u540c\u6837\uff0c\u5982\u679c\u6211\u4eec\u8fd0\u884c <code>getmesh istioctl version</code> \uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6b63\u5728\u4f7f\u7528\u7684 Istio CLI \u7684\u7248\u672c\uff1a</p> <pre><code>$ getmesh istioctl version\nclient version: 1.9.0-tetratefips-v1\ncontrol plane version: 1.9.5-tetrate-v0\ndata plane version: 1.9.5-tetrate-v0 (2 proxies)\n</code></pre> <p>\u8981\u5207\u6362\u5230\u4e0d\u540c\u7248\u672c\u7684 Istio CLI\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c <code>getmesh switch</code>\u547d\u4ee4</p> <pre><code>getmesh  switch --version 1.9.5 --flavor tetrate --flavor-version 0\n</code></pre>"},{"location":"chap8/2Istio_install/#ca","title":"CA \u96c6\u6210","text":"<p>\u6211\u4eec\u6ca1\u6709\u4f7f\u7528\u81ea\u7b7e\u7684\u6839\u8bc1\u4e66\uff0c\u800c\u662f\u4ece GCP CAS\uff08\u8bc1\u4e66\u6388\u6743\u670d\u52a1\uff09\u83b7\u5f97\u4e00\u4e2a\u4e2d\u95f4\u7684 Istio \u8bc1\u4e66\u6388\u6743\uff08CA\uff09\u6765\u7b7e\u7f72\u5de5\u4f5c\u8d1f\u8f7d\u8bc1\u4e66</p> <p>\u5047\u8bbe\u4f60\u5df2\u7ecf\u914d\u7f6e\u4e86\u81ea\u5df1\u7684 CAS \u5b9e\u4f8b\uff0c \u53ef\u4ee5\u7528 CA \u7684\u53c2\u6570\u521b\u5efa\u4e00\u4e2a YAML \u914d\u7f6e\u3002\u4e0b\u9762\u662f YAML \u914d\u7f6e\u7684\u4e00\u4e2a\u4f8b\u5b50\uff1a</p> <pre><code>providerName: \"gcp\"\nproviderConfig:\n  gcp:\n  # \u4f60\u5728 GCP \u4e0a\u521b\u5efa\u7684\u8bc1\u4e66\u6388\u6743\u7684\u5b8c\u6574 CA \u540d\u79f0\n   casCAName: \"projects/tetrate-io-istio/locations/us-west1/certificateAuthorities/tetrate-example-io\"\n\ncertificateParameters:\n  secretOptions:\n   istioCANamespace: \"istio-system\" # cacerts secret \u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\n   overrideExistingCACertsSecret: true # \u91cd\u5199\u5df2\u5b58\u5728\u7684 cacerts secret\uff0c\u4f7f\u7528\u65b0\u7684\u66ff\u6362\n  caOptions:\n   validityDays: 365 # CA \u5230\u671f\u524d\u7684\u6709\u6548\u5929\u6570\n   keyLength: 2048 # \u521b\u5efa\u7684 key \u7684\u6bd4\u7279\u6570\n   certSigningRequestParams: # x509.CertificateRequest\uff1b\u5927\u90e8\u5206\u5b57\u6bb5\u7701\u7565\n    subject:\n     commonname: \"tetrate.example.io\"\n     country: \n      - \"US\"\n     locality:\n      - \"Sunnyvale\"\n     organization:\n      - \"Istio\"\n     organizationunit:\n      - \"engineering\"\n    emailaddresses:\n     - \"youremail@example.io\"\n</code></pre> <p>\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>gen-ca</code> \u547d\u4ee4\u6765\u521b\u5efa <code>cacert</code></p> <pre><code>getmesh gen-ca --config-file gcp-cas-config.yaml\n</code></pre> <p>\u8be5\u547d\u4ee4\u5728 <code>istio-system</code> \u4e2d\u521b\u5efa <code>cacert  Kubernetes Secret</code> \u4e3a\u4e86\u8ba9 istiod \u63a5\u53d7\u65b0\u7684 cert\uff0c\u4f60\u5fc5\u987b\u91cd\u65b0\u542f\u52a8 istiod\u3002</p> <p>\u5982\u679c\u4f60\u521b\u5efa\u4e00\u4e2a sample \u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5e76\u68c0\u67e5\u6240\u4f7f\u7528\u7684\u8bc1\u4e66\uff0c\u4f60\u4f1a\u53d1\u73b0\u662f CA \u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u53d1\u5e03\u7684\u8bc1\u4e66\u3002</p>"},{"location":"chap8/2Istio_install/#3","title":"3\u3001\u53d1\u73b0\u9009\u62e9\u5668","text":"<p>Discovery selectors </p> <ul> <li>Introduced in Istio 1.10 </li> <li>Which namespaces to watch&amp;send configuration updates for </li> <li>All proxies configured with information about all other services </li> </ul> <p>Configuring discovery selectors</p> <ul> <li>At the mesh level </li> <li>List of Kubernetes selectors(e.g.hello=world,version=v1 ...) </li> <li>Use discoverySelectors to limit the watched &amp; processed items </li> </ul> <p>\u53d1\u73b0\u9009\u62e9\u5668\u662fIstio 1.10\u4e2d\u5f15\u5165\u7684\u65b0\u529f\u80fd\u4e4b\u4e00\u3002\u53d1\u73b0\u9009\u62e9\u5668\u5141\u8bb8\u6211\u4eec\u63a7\u5236Istio\u63a7\u5236\u5e73\u9762\u89c2\u5bdf\u548c\u53d1\u9001\u914d\u7f6e\u66f4\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstlo\u63a7\u5236\u5e73\u9762\u4f1a\u89c2\u5bdf\u548c\u5904\u7406\u96c6\u7fa4\u4e2d\u6240\u6709Ku bernetes\u8d44\u6e90\u7684\u66f4\u65b0\u3002\u670d\u52a1\u7f51\u683c\u4e2d\u65f7 \u6240\u6709Envoy\u4ee3\u7406\u7684\u914d\u7f6e\u65b9\u5f0f\u662f\uff0c\u5b83\u4eec\u53ef\u4ee5\u5230\u8fbe\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5e76\u63a5\u53d7\u4e0e\u5de5\u4f5c\u8d1f\u8f7d\u76f8\u5173\u7684\u6240\u6709\u7aef\u53e3\u7684\u6d41\u91cf\u3002 </p> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u5728\u4e0d\u540c\u7684\u547d\u540d\u7a7a\u95f4\u90e8\u7f72\u4e86\u4e24\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u2015foo\u548cbar\u3002</p> <p>\u5c3d\u7ba1\u6211\u4eec\u77e5\u9053foo\u6c38\u8fdc\u4e0d\u4f1a\u4e0ebar\u901a\u4fe1\uff0c\u53cd\u4e4b\u4ea6\u7136\uff0c\u4f46\u4e00\u4e2a\u670d\u52a1\u7684\u7aef\u70b9\u5c06\u88ab\u5305\u542b\u5728\u53e6\u4e00\u4e2a\u670d\u52a1\u7684\u5df2\u53d1\u73b0\u7aef\u70b9\u5217\u8868\u4e2d\u3002 </p> <p> </p> <p>\u5982\u679c\u6211\u4eec\u8fd0\u884c<code>istioctl proxy-config</code>\u547d\u4ee4\uff0c\u5217\u51fafoo\u547d\u540d\u7a7a\u95f4\u7684foo\u5de5\u4f5c\u8d1f\u8f7d\u53ef\u4ee5\u770b\u5230\u7684\u6240\u6709\u7aef\u70b9\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u4e00\u4e2a\u540d\u4e3abar\u7684\u670d\u52a1\u6761\u76ee\uff1a</p> <pre><code>$ istioctl proxy-config endpoints deploy/foo.foo\n</code></pre> <p> </p> <p>\u5982\u679cIstio\u4e0d\u65ad\u7528\u96c6\u7fa4\u4e2d\u6bcf\u4e2a\u670d\u52a1\u7684\u4fe1\u606f\u6765\u66f4\u65b0\u4ee3\u7406\uff0c\u5373\u4f7f\u8fd9\u4e9b\u670d\u52a1\u662f\u4e0d\u76f8\u5173\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u60f3\u8c61\u8fd9\u5c06\u5982\u4f55\u62d6\u7d2f\u4e8b\u60c5\u3002 </p> <p>\u5982\u679c\u8fd9\u542c\u8d77\u6765\u5f88\u719f\u6089\uff0c\u4f60\u53ef\u80fd\u77e5\u9053\u5df2\u7ecf\u6709\u4e00\u4e2a\u89e3\u51b3\u65b9\u6848\u4e86 - Sidecar\u8d44\u6e90\u3002 </p>"},{"location":"chap8/2Istio_install/#_4","title":"\u914d\u7f6e\u53d1\u73b0\u9009\u62e9\u5668","text":"<p>\u53d1\u73b0\u9009\u62e9\u5668\u53ef\u4ee5\u5728<code>MeshConfig</code>\u4e2d\u7684Mesh\u5c42\u9762\u4e0a\u8fdb\u884c\u914d\u7f6e\u3002\u5b83\u4eec\u662f\u4e00\u4e2aKubernetes\u9009\u62e9\u5668\u7684\u5217\u8868\uff0c\u6307\u5b9a\u4e86Istio\u5728\u5411sidecar\u63a8\u9001\u914d\u7f6e\u65f6\u89c2\u5bdf\u548c\u66f4\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u7684\u96c6\u5408\u3002 </p> <p>\u5c31\u50cfSidecar\u8d44\u6e90\u4e00\u6837, discoverySelectors\u53ef\u4ee5\u7528\u6765\u9650\u5236\u88ab<code>Istio</code>\u89c2\u5bdf\u548c\u5904\u7406\u7684\u9879\u76ee\u6570\u91cf</p> <p>\u6211\u4eec\u53ef\u4ee5\u66f4\u65b0<code>IstioOperator</code>\u4ee5\u5305\u62ec<code>discoverySelectors</code>\u5b57\u6bb5\uff0c\u5982\u4e0b\u6240\u793a\uff1a </p> <pre><code>apiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nmetadata:\n  namespace: istio-system\n  name: istio-demo\nspec:\n  meshConfig:\n   discoverySelectors:\n   - matchLabels:\n       env: test\n</code></pre> <p>\u4e0a\u9762\u7684\u4f8b\u5b50\u5c06<code>env=test</code>\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5339\u914d\u6807\u7b7e\u3002\u8fd9\u610f\u6627\u7740\u6807\u6709<code>env=test</code>\u6807\u7b7e\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5c06\u88ab\u5305\u542b\u5728Istio\u76d1\u63a7\u548c\u66f4\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u5217\u8868\u4e2d\u3002 </p> <p>\u5982\u679c\u6211\u4eec\u7ed9foo\u547d\u540d\u7a7a\u95f4\u8d34\u4e0a<code>env=test</code>\u6807\u7b7e\uff0c\u7136\u540e\u5217\u51fa\u7aef\u70b9\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u73b0\u5728\u914d\u7f6e\u4e2d\u5217\u51fa\u7684\u7aef\u70b9\u6ca1\u6709\u90a3\u4e48\u591a\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u6807\u6ce8\u7684\u552f\u4e00\u547d\u540d\u7a7a\u95f4\u662ffoo\u547d\u540d\u7a7a\u95f4\uff0c\u8fd9\u4e5f\u662fIstlo\u63a7\u5236\u5e73\u9762\u89c2\u5bdf\u548c\u53d1\u9001\u66f4\u65b0\u7684\u552f\u4e00\u547d\u540d\u7a7a\u95f4\u3002 </p> <pre><code>$ istioctl proxy-config endpoints deploy/foo.foo\n</code></pre> <p> </p> <p>\u5982\u679c\u6211\u4eec\u628a\u547d\u540d\u7a7a\u95f4bar\u4e5f\u8d34\u4e0a\u6807\u7b7e\uff0c\u7136\u540e\u91cd\u65b0\u8fd0\u884c<code>istiocti proxy-config</code>\u547d\u4ee4\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0bar\u7aef\u70b9\u663e\u793a\u4e3afoo\u670d\u52a1\u914d\u7f6e\u7684\u4e00\u90e8\u5206\u3002 </p> <pre><code>$ istioctl proxy-config endpoints deploy/foo.foo\n</code></pre> <p> </p>"},{"location":"chap8/2Istio_install/#4istio","title":"4\u3001\u5b9e\u9a8cIstio\u5b89\u88c5","text":"<pre><code>$ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh -\n$ cd istio-1.10.3\n$ sudo cp bin/istioctl /usr/local/bin/istioctl\n$ istioctl version\nno running Istio pods in \"istio-system\"\n1.10.3\n</code></pre> <p>Istlo\u652f\u6301\u591a\u4e2a\u914d\u7f6e\u6587\u4ef6\uff08<code>profile</code>)\u3002\u914d\u7f6e\u6587\u4ef6\u4e4b\u95f4\u7684\u533a\u522b\u5728\u4e8e\u6240\u5b89\u88c5\u7684\u7ec4\u4ef6\u3002 </p> <pre><code>$ istioctl profile list\nIstio configuration profiles:\n    default\n    demo\n    empty\n    external\n    minimal\n    openshift\n    preview\n    remote    \n</code></pre> <p>\u63a8\u8350\u7528\u4e8e\u751f\u4ea7\u90e8\u7f72\u7684\u914d\u7f6e\u6587\u4ef6\u662fdefault\u914d\u7f6e\u6587\u4ef6\u3002</p> <p>\u6211\u4eec\u5c06\u5b89\u88c5demo\u914d\u7f6e\u6587\u4ef6\uff0c\u56e0\u4e3a\u5b83\u5305\u542b\u6240\u6709\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u542f\u7528\u4e86\u8ddf\u8e2a\u548c\u65e5\u5fd7\u8bb0\u5f55\uff0c\u4fbf\u4e8e\u5b66\u4e60\u4e0d\u540c\u7684Istio\u529f\u80fd\u3002 </p> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u4eceminimal\u7684\u7ec4\u4ef6\u5f00\u59cb\uff0c\u4ee5\u540e\u5355\u72ec\u5b89\u88c5\u5176\u4ed6\u529f\u80fd\uff0c\u5982ingress\u548cegress\u7f51\u5173\u3002 </p> <p>\u56e0\u4e3a\u6211\u4eec\u5c06\u4f7f\u7528Istio Operator\u8fdb\u884c\u5b89\u88c5\uff0c\u6240\u4ee5\u6211\u4eec\u5fc5\u987b\u5148\u90e8\u7f72Operator0</p> <p>\u8981\u90e8\u7f72<code>Istio Operator</code>\uff0c\u8bf7\u8fd0\u884c </p> <pre><code>$ istioctl operator init\nInstalling operator controller in namespace: istio-operator using image: docker.io/istio/operator:1.10.3\nOperator controller will watch namespaces: istio-system\n\u2714 Istio operator installed                                                                                                                            \n\u2714 Installation complete\n</code></pre> <p>init\u547d\u4ee4\u521b\u5efa\u4e86   <code>istio-operator</code> \u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u90e8\u7f72\u4e86CRD\u3001Operator Deployment\u4ee5\u53caoperator\u5de5\u4f5c\u6240\u9700\u7684\u5176\u4ed6\u8d44\u6e90\u3002\u5b89\u88c5\u5b8c\u6210\u540e\uff0cOperator\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e86\u3002 </p> <p>\u8981\u5b89\u88c5Istio\uff0c\u6211\u4eec\u5fc5\u987b\u521b\u5efa<code>IstioOperator</code>\u8d44\u6e90\uff0c\u5e76\u6307\u5b9a\u6211\u4eec\u8981\u4f7f\u7528\u7684\u914d\u7f6e\u914d\u7f6e\u6587\u4ef6\u3002  \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a<code>demo-profile.yaml</code>\u7684\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a </p> <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: istio-system\n---\napiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nmetadata:\n  namespace: istio-system\n  name: demo-istio-install\nspec:\n  profile: demo\n</code></pre> <p>\u5b89\u88c5 istio \u7684\u5de5\u5177\u548c\u6587\u4ef6\u51c6\u5907\u597d\u8fc7\u540e\uff0c\u76f4\u63a5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u5b89\u88c5\u547d\u4ee4\u5373\u53ef\uff0c\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u7684\u662f <code>demo</code>\u914d\u7f6e\u7ec4\u5408\u7684\u5f62\u5f0f\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u5305\u542b\u4e86\u4e00\u7ec4\u4e13\u4e3a\u6d4b\u8bd5\u51c6\u5907\u7684\u529f\u80fd\u96c6\u5408\uff0c\u53e6\u5916\u8fd8\u6709\u7528\u4e8e\u751f\u4ea7\u6216\u6027\u80fd\u6d4b\u8bd5\u7684\u914d\u7f6e\u7ec4\u5408\u3002</p> <pre><code>$  istioctl install --set profile=demo -y\n\u2714 Istio core installed                                                                                                              \n\u2714 Istiod installed                                                                                                                  \n\u2714 Ingress gateways installed                                                                                                        \n\u2714 Egress gateways installed                                                                                                         \n\u2714 Installation complete                                                                                                             \nThank you for installing Istio 1.10.  Please take a few minutes to tell us about your install/upgrade experience!  https://forms.gle\n/KjkrDnMPByq7akrYA\n</code></pre> <pre><code>$ kubectl apply -f demo-profile.yaml \nnamespace/istio-system unchanged\nistiooperator.install.istio.io/demo-istio-install created\n</code></pre> <p>\u4e00\u65e6Operator\u68c0\u6d4b\u5230<code>IstioOperator</code>\u8d44\u6e90\uff0c\u5b83\u5c06\u5f00\u59cb\u5b89\u88c5Istio\u3002\u6574\u4e2a\u8fc7\u7a0b\u53ef\u80fd\u9700\u89815\u5206\u949f\u5de6\u53f3\u3002 </p> <p>\u4e3a\u4e86\u68c0\u67e5\u5b89\u88c5\u7684\u72b6\u6001\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u770b<code>istio-system</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u7684Pod\u7684\u72b6\u6001\u3002 </p> <pre><code>$ kubectl get pod -n istio-operator\nNAME                            READY   STATUS    RESTARTS   AGE\nistio-operator-dbc5db55-wjngn   1/1     Running   0          8m16s\n\n$ kubectl get pod -n istio-system \nNAME                                   READY   STATUS    RESTARTS   AGE\nistio-egressgateway-5547fcc8fc-7kj9c   1/1     Running   0          7m17s\nistio-ingressgateway-8f568d595-zj9bs   1/1     Running   0          7m17s\nistiod-6659979bdf-l7kgk                1/1     Running   0          7m23s\n</code></pre> <p>\u5f53\u6240\u6709\u7684Pod\u90fd\u5728\u8fd0\u884c\u65f6\uff0cOperator\u5df2\u7ecf\u5b8c\u6210\u4e86Istio\u7684\u5b89\u88c5\u3002 </p>"},{"location":"chap8/2Istio_install/#sidecar","title":"\u542f\u7528sidecar\u6ce8\u5165","text":"<p>\u670d\u52a1\u7f51\u683c\u9700\u8981\u8ba9\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u540c\u65f6\u8fd0\u884csidecar\u4ee3\u7406\u3002 </p> <p>\u8981\u5c06sidecar\u4ee3\u7406\u6ce8\u5165\u5230\u73b0\u6709\u7684Kubernetes\u90e8\u7f72\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>istioctl</code>\u547d\u4ee4\u4e2d\u7684 <code>kube-inject</code>\u52a8\u4f5c\u3002</p> <p>\u7136\u800c\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728\u4efb\u610fKubernetes\u547d\u540d\u7a7a\u95f4\u4e0a\u542f\u7528sidecar\u81ea\u52a8\u6ce8\u5165\u3002\u5982\u679c\u6211\u4eec\u7528 <code>istio-injection=enabled</code>\u6807\u8bb0\u547d\u540d\u7a7a\u95f4\uff0cIstio\u4f1a\u81ea\u52a8\u4e3a\u6211\u4eec\u5728\u8be5\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u7684\u6240\u6709 <code>Kubernetes Pod</code>\u6ce8\u5165<code>sidecar</code></p> <p>\u8ba9\u6211\u4eec\u901a\u8fc7\u6dfb\u52a0\u6807\u7b7e\u6765\u542f\u7528default\u547d\u540d\u7a7a\u95f4\u7684sidecar\u81ea\u52a8\u6ce8\u5165\u3002 </p> <pre><code>$ kubectl label namespace default istio-injection=enabled\nnamespace/default labeled\n</code></pre> <p>\u8981\u68c0\u67e5\u547d\u540d\u7a7a\u95f4\u662f\u5426\u88ab\u6807\u8bb0\uff0c\u8bf7\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u3002defaul\u4e03\u547d\u540d\u7a7a\u95f4\u5e94\u8be5\u662f\u552f\u4e00\u4e00\u4e2a\u542f\u7528\u4e86\u8be5\u503c\u7684\u547d\u540d\u7a7a\u95f4\u3002 </p> <pre><code>$ kubectl get namespace -L istio-injection\nNAME              STATUS   AGE   ISTIO-INJECTION\ndefault           Active   12d   enabled\nistio-operator    Active   22m   disabled\nistio-system      Active   30m   \nkube-demo         Active   12d   \nkube-node-lease   Active   12d   \nkube-public       Active   12d   \nkube-system       Active   12d   \nvelero            Active   12d\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5728defaul\u4e03\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u4e00\u4e2aDeployment\uff0c\u5e76\u89c2\u5bdf\u6ce8\u5165\u7684\u4ee3\u7406\u3002\u6211\u4eec\u5c06 \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a<code>my-nginx</code>\u7684<code>Deployment</code>\uff0c\u4f7f\u7528nginx\u955c\u50cf\u7684\u5355\u4e00\u5bb9\u5668\u3002 </p> <pre><code>kubectl create deploy my-nginx --image=nginx\n</code></pre> <pre><code>kubectl get pod \nNAME                        READY   STATUS    RESTARTS   AGE\nmy-nginx-6b74b79f57-ps779   2/2     Running   0          111s\n</code></pre> <pre><code>$ kubectl describe pod my-nginx-6b74b79f57-ps779\nEvents:\n  Type    Reason     Age    From                     Message\n  ----    ------     ----   ----                     -------\n  Normal  Scheduled  2m27s  default-scheduler        Successfully assigned default/my-nginx-6b74b79f57-ps779 to docker-desktop\n  Normal  Pulled     2m24s  kubelet, docker-desktop  Container image \"docker.io/istio/proxyv2:1.10.3\" already present on machine\n  Normal  Created    2m23s  kubelet, docker-desktop  Created container istio-init\n  Normal  Started    2m23s  kubelet, docker-desktop  Started container istio-init\n  Normal  Pulling    2m22s  kubelet, docker-desktop  Pulling image \"nginx\"\n  Normal  Pulled     98s    kubelet, docker-desktop  Successfully pulled image \"nginx\" in 44.2681088s\n  Normal  Created    98s    kubelet, docker-desktop  Created container nginx\n  Normal  Started    98s    kubelet, docker-desktop  Started container nginx\n  Normal  Pulled     98s    kubelet, docker-desktop  Container image \"docker.io/istio/proxyv2:1.10.3\" already present on machine\n  Normal  Created    98s    kubelet, docker-desktop  Created container istio-proxy\n  Normal  Started    98s    kubelet, docker-desktop  Started container istio-proxy\n</code></pre>"},{"location":"chap8/2Istio_install/#4-istio","title":"4\u3001\u6d4b\u9a8c\uff1a\u5b89\u88c5 Istio","text":"<p>1.\u5b89\u88c5\u540e\uff0cIstio\u4f1a\u81ea\u52a8\u5c06Envoy\u4ee3\u7406\u6ce8\u5165\u6240\u6709\u5728default\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u7684Kubernetes\u90e8\u7f72\u4e2d\u3002\u5bf9\u8fd8\u662f\u9519\uff1f </p> <ul> <li>A \u5bf9</li> <li>B \u9519 </li> </ul> <p>2.Istio\u6709\u591a\u4e2a\u914d\u7f6e\u6587\u4ef6\u3002\u54ea\u79cd\u914d\u7f6e\u6587\u4ef6\u6700\u9002\u5408\u751f\u4ea7\u90e8\u7f72\uff1f </p> <p>Choose only ONE best answer. </p> <ul> <li>Default profile </li> <li>Production profile  </li> <li>Minimal </li> <li>Demo </li> </ul> <p>3.\u4f60\u53ef\u4ee5\u7528\u54ea\u4e2a\u6807\u7b7e\u6765\u542f\u7528\u81ea\u52a8sidecar\u6ce8\u5165\uff1f </p> <p>Choose only ONE best answer. </p> <ul> <li>A injection=enabled </li> <li>B sidecar-injection=1 </li> <li>C istio-injection=enabled </li> <li>D inject\uff1dtrue </li> </ul> <p>4.\u8fd0\u884cEnvoy\u4ee3\u7406sidecar\u7684\u5bb9\u5668\u7684\u540d\u79f0\u662f\u4ec0\u4e48\uff1f </p> <p>Choose only ONE best answer. </p> <ul> <li>A istio-proxy</li> <li>B sidecar </li> <li>C envoy-proxy </li> <li>D proxy </li> </ul> <p>5\u3002\u53ea\u53ef\u4ee5\u4f7f\u7528Istio CLI (istiocti\uff09\u6765\u5b89\u88c5Istio\uff0c\u5bf9\u8fd8\u662f\u9519\uff1f </p> <p>Choose only ONE best answer. </p> <ul> <li>A \u5bf9</li> <li>B \u9519 </li> </ul>"},{"location":"chap8/3Istio_mon/","title":"\u7b2c\u4e09\u8282 \u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7","text":""},{"location":"chap8/3Istio_mon/#1","title":"1\u3001\u6a21\u5757\u6982\u5ff5","text":"<p>\u5728\u8fd9\u4e2a\u6a21\u5757\u4e2d\uff0c\u5b66\u4e60\u4e00\u4e9b\u76d1\u63a7\uff08Prometheus)\u3001\u8ffd\u8e2a\uff08Zipkin)\u548c\u6570\u636e\u53ef\u89c6\u5316\u5de5\u5177 (Grafana)\u3002 </p> <p>\u4e3a\u4e86\u8ba9<code>Grafana</code>\u548c<code>Kiali</code>\u5de5\u4f5c\uff0c\u6211\u4eec\u9996\u5148\u8981\u5b89\u88c5Prometheus\u63d2\u4ef6\u3002 </p>"},{"location":"chap8/3Istio_mon/#1-1","title":"1-1 \u53ef\u89c2\u5bdf\u6027","text":"<p>\u7531\u4e8e\u91c7\u7528\u4e86sidecar\u90e8\u7f72\u6a21\u5f0f\uff0c\u5373Envoy\u4ee3\u7406\u8fd0\u884c\u5728\u5e94\u7528\u5b9e\u4f8b\u65c1\u8fb9\u5e76\u62e6\u622a\u6d41\u91cf\uff0c\u8fd9\u4e9b\u4ee3\u7406\u4e5f\u6536\u96c6\u6307\u6807\u3002 </p> <p>Envoy\u4ee3\u7406\u6536\u96c6\u7684\u6307\u6807\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u83b7\u5f97\u7cfb\u7edf\u72b6\u6001\u7684\u53ef\u89c1\u6027\u3002</p> <p>\u83b7\u5f97\u7cfb\u7edf\u7684\u8fd9\u79cd\u53ef\u89c1\u6027\u662f\u81f3\u5173\u91cd\u8981\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u4e86\u89e3\u6b63\u5728\u53d1\u751f\u7684\u4e8b\u60c5\uff0c\u5e76\u6388\u6743\u8fd0\u7ef4\u4eba\u5458\u5bf9\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u6545\u969c\u6392\u9664\u3001\u7ef4\u62a4\u548c\u4f18\u5316\u3002 </p> <p>Istio\u751f\u6210\u4e09\u79cd\u7c7b\u578b\u7684\u9065\u6d4b\u6570\u636e\uff0c\u4e3a\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b\u53ef\u89c2\u5bdf\u6027\uff1a</p> <ul> <li>\u6307\u6807\u5ea6\u91cf\uff08Metric)</li> <li>\u5206\u5e03\u5f0f\u8ffd\u8e2a</li> <li>\u8bbf\u95ee\u65e5\u5fd7 </li> </ul>"},{"location":"chap8/3Istio_mon/#1-2","title":"1-2 \u6307\u6807","text":"<p>Istlo\u57fa\u4e8e\u56db\u4e2a\u9ec4\u91d1\u4fe1\u53f7\u751f\u6210\u6307\u6807\uff1a\u5ef6\u8fdf\u3001\u6d41\u91cf\u3001\u9519\u8bef\u548c\u9971\u548c\u5ea6\u3002 </p> <ol> <li>Latency: the time it takes to service a request </li> <li>Traffic: how much demand is placed on the system </li> <li>Errors: rate of failed requests </li> <li>Saturation: how full the most constrained resources of service are </li> </ol> <p>Collected at Envoy proxy, service, and control plane</p> <ul> <li>\u5ef6\u8fdf\u8868\u793a\u670d\u52a1\u4e00\u4e2a\u8bf7\u6c42\u6240\u9700\u7684\u65f6\u95f4\u3002\u8fd9\u4e2a\u6307\u6807\u5e94\u8be5\u5206\u6210\u6210\u529f\u8bf7\u6c42\uff08\u5982\u65e5I 1P200)\u548c\u5931\u8d25\u8bf7\u6c42 \uff08\u5982HTTP 500\uff09\u7684\u5ef6\u8fdf\u3002 </li> <li>\u6d41\u91cf\u662f\u8861\u91cf\u5bf9\u7cfb\u7edf\u7684\u9700\u6c42\u6709\u591a\u5927\uff0c\u5b83\u662f\u4ee5\u7cfb\u7edf\u7684\u5177\u4f53\u6307\u6807\u6765\u8861\u91cf\u7684\u3002\u4f8b\u5982\uff0c\u6bcf\u79d2\u7684HTTP\u8bf7\u6c42\uff0c\u6216\u5e76\u53d1\u4f1a\u8bdd\uff0c\u6bcf\u79d2\u7684\u68c0\u7d22\u91cf\uff0c\u7b49\u7b49\u3002 </li> <li>\u9519\u8bef\u7528\u6765\u8861\u91cf\u8bf7\u6c42\u5931\u8d25\u7684\u6bd4\u7387\uff08\u4f8b\u5982HTTP 500)\u3002 </li> <li>\u9971\u548c\u5ea6\u8861\u91cf\u4e00\u4e2a\u670d\u52a1\u4e2d\u6700\u7d27\u5f20\u7684\u8d44\u6e90\u6709\u591a\u6ee1\u3002\u4f8b\u5982\uff0c\u7ebf\u7a0b\u6c60\u7684\u5229\u7528\u7387\u3002 </li> <li>\u8fd9\u4e9b\u6307\u6807\u662f\u5728\u4e0d\u540c\u7684\u5c42\u9762\u4e0a\u6536\u96c6\u7684\uff0c\u9996\u5148\u662f\u6700\u7ec6\u7684\uff0c\u5373Envoy\u4ee3\u7406\u5c42\u9762\uff0c\u7136\u540e\u662f\u670d\u52a1\u5c42\u9762\u548c\u63a7\u5236\u5e73\u9762\u7684\u6307\u6807\u3002 </li> </ul>"},{"location":"chap8/3Istio_mon/#1-3","title":"1-3 \u4ee3\u7406\u7ea7\u6307\u6807","text":"<p>\u751f\u6210\u6307\u6807\u7684\u5173\u952e\u89d2\u8272\u662fEnvoy\uff0c\u5b83\u751f\u6210\u4e86\u4e00\u5957\u5173\u4e8e\u6240\u6709\u901a\u8fc7\u4ee3\u7406\u7684\u6d41\u91cf\u7684\u4e30\u5bcc\u6307\u6807\u3002\u4f7f\u7528 Envoy\u751f\u6210\u7684\u6307\u6807\uff0c\u6211\u4eec\u53ef\u4ee5\u4ee5\u6700\u4f4e\u7684\u7c92\u5ea6\u6765\u76d1\u63a7\u670d\u52a1\u7f51\u683c\uff0c\u4f8b\u5982Envoy\u4ee3\u7406\u4e2d\u7684\u6bcf\u4e2a\u76d1\u542c \u5668\u548c\u96c6\u7fa4\u7684\u6307\u6807\u3002 </p> <p>\u4f5c\u4e3a\u7f51\u683c\u8fd0\u7ef4\u4eba\u5458\uff0c\u6211\u4eec\u6709\u80fd\u529b\u63a7\u5236\u751f\u6210\u548c\u6536\u96c6\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u4f8b\u4e2d\u7684\u54ea\u4e9bEnvoy\u6307\u6807\u3002 </p> <p>\u4e0b\u9762\u662f\u51e0\u4e2a\u4ee3\u7406\u7ea7\u6307\u6807\u7684\u4f8b\u5b50\u3002 </p> <pre><code>envoy_cluster_internal_upstream_rq{response_code_class=\"2xx\",cluster_name=\"xds-grpc\"} 7163\nenvoy_cluster_upstream_rq_completed{cluster_name=\"xds-grpc\"} 7164\nenvoy_cluster_ssl_connection_error{cluster_name=\"xds-grpc\"} 0\nenvoy_cluster_lb_subsets_removed{cluster_name=\"xds-grpc\"} 0\nenvoy_cluster_internal_upstream_rq{response_code=\"503\",cluster_name=\"xds-grpc\"} 1\n</code></pre> <p>\u6ce8\u610f\u4f60\u53ef\u4ee5\u4ece\u6bcf\u4e2a\u538bEnvoy\u4ee3\u7406\u5b9e\u4f8b\u7684\uff0fStats \u7aef\u70b9\u67e5\u770b\u4ee3\u7406\u7ea7\u6307\u6807\u3002 </p>"},{"location":"chap8/3Istio_mon/#1-4","title":"1-4 \u670d\u52a1\u7ea7\u6307\u6807","text":"<p>\u670d\u52a1\u7ea7\u522b\u7684\u6307\u6807\u6db5\u76d6\u4e86\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u56db\u4e2a\u9ec4\u91d1\u4fe1\u53f7\u3002\u8fd9\u4e9b\u6307\u6807\u4f7f\u6211\u4eec\u80fd\u591f\u76d1\u63a7\u670d\u52a1\u4e0e\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u3002\u6b64\u5916\uff0cIstlo\u8fd8\u63d0\u4f9b\u4e86\u4e00\u7ec4\u4eea\u8868\u76d8\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u8fd9\u4e9b\u6307\u6807\u6765\u76d1\u63a7\u670d\u52a1\u884c\u4e3a\u3002</p> <p>\u5c31\u50cf\u4ee3\u7406\u7ea7\u522b\u7684\u6307\u6807\u4e00\u6837\uff0c\u8fd0\u7ef4\u4eba\u5458\u53ef\u4ee5\u81ea\u5b9a\u4e49\u6536\u96c6\u54ea\u4e9b\u670d\u52a1\u7ea7\u522b\u7684\u6307\u6807\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\u7684\u6807\u51c6\u6307\u6807\u96c6\u4f1a\u88ab\u5bfc\u51fa\u5230Prometheus</p> <p>\u4e0b\u9762\u662f\u51e0\u4e2a\u670d\u52a1\u7ea7\u6307\u6807\u7684\u4f8b\u5b50\uff1a </p> <pre><code>istio_requests_total{\n  connection_security_policy=\"mutual_tls\",\n  destination_app=\"hello-world\",\n  destination_canonical_service=\"hello-world\",\n  destination_canonical_revision=\"v1\",\n  destination_principal=\"cluster.local/ns/default/sa/default\",\n  destination_service=\"hello-world.default.svc.cluster.local\",\n  destination_service_name=\"hello-world\",\n  destination_service_namespace=\"default\",\n  destination_version=\"v1\",\n  destination_workload=\"hello-world-v1\",\n  destination_workload_namespace=\"default\",\n  reporter=\"destination\",\n  request_protocol=\"http\",\n  response_code=\"200\",\n  response_flags=\"-\",\n  source_app=\"hello-web\",\n  source_canonical_service=\"hello-web\",\n  source_canonical_revision=\"v1\",\n  source_principal=\"cluster.local/ns/default/sa/default\",\n  source_version=\"v1\",\n  source_workload=\"hello-web-v1\",\n  source_workload_namespace=\"default\"\n} 981\n</code></pre>"},{"location":"chap8/3Istio_mon/#1-5","title":"1-5 \u63a7\u5236\u5e73\u9762\u5ea6\u91cf","text":"<p>Istio\u4e5f\u4f1a\u751f\u6210\u63a7\u5236\u5e73\u9762\u6307\u6807\uff0c\u7528\u4e8e\u76d1\u63a7Istio\u7684\u63a7\u5236\u5e73\u9762\uff0c\u800c\u4e0d\u662f\u7528\u6237\u670d\u52a1\u3002</p> <p>\u8f93\u51fa\u7684\u63a7\u5236\u5e73\u9762\u6307\u6807\u7684\u5b8c\u6574\u5217\u8868\u53ef\u4ee5\u5728\u8fd9\u91cc\u627e\u5230\u3002 </p> <p>\u63a7\u5236\u5e73\u9762\u6307\u6807\u5305\u62ec\u51b2\u7a81\u7684\u5165\u7ad9\uff0f\u51fa\u7ad9\u76d1\u542c\u5668\u7684\u6570\u91cf\u3001\u6ca1\u6709\u5b9e\u4f8b\u7684\u96c6\u7fa4\u6570\u91cf\u3001\u88ab\u62d2\u7edd\u6216\u88ab\u5ffd\u7565\u7684\u914d\u7f6e\u7b49\u6307\u6807\u3002 </p>"},{"location":"chap8/3Istio_mon/#2prometheus","title":"2\u3001Prometheus","text":""},{"location":"chap8/3Istio_mon/#prometheus","title":"Prometheus","text":"<ul> <li>Open-source monitoring system and time series DB </li> <li>Records metrics: </li> <li>Track mesh health </li> <li>Track application health </li> <li>Install from /samples/addons folder </li> <li>istioctl dashboard prometheus </li> </ul> <p>Prometheus\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u76d1\u63a7\u7cfb\u7edf\u548c\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\u3002Istlo\u4f7f\u7528Prometheus\u6765\u8bb0\u5f55\u6307\u6807\uff0c\u8ddf\u8e2aIstio\u548c\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5\u3002 </p> <p>\u8981\u5b89\u88c5Prometheus\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Istio\u5b89\u88c5\u5305\u4e2d\uff0fsamples/addons \u6587\u4ef6\u5939\u4e2d\u7684\u793a\u4f8b\u5b89\u88c5\u3002</p> <pre><code>$ kubectl apply -f istio-1.10.3/samples/addons/prometheus.yaml \nserviceaccount/prometheus created\nconfigmap/prometheus created\nclusterrole.rbac.authorization.k8s.io/prometheus created\nclusterrolebinding.rbac.authorization.k8s.io/prometheus created\nservice/prometheus created\ndeployment.apps/prometheus created\n</code></pre> <pre><code>$ kubectl get pod -n istio-system \nNAME                                   READY   STATUS    RESTARTS   AGE\nistio-egressgateway-5547fcc8fc-7kj9c   1/1     Running   0          4h31m\nistio-ingressgateway-8f568d595-zj9bs   1/1     Running   0          4h31m\nistiod-6659979bdf-l7kgk                1/1     Running   0          4h31m\nprometheus-8958b965-hpp2v              2/2     Running   0          2m11s\n</code></pre> <p>\u8981\u6253\u5f00 Prometheus \u4eea\u8868\u677f\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Istio CLI \u4e2d\u7684 </p> <pre><code>$ Istioctl dashboard prometheus\nhttp://localhost:9090\n</code></pre> <p> </p>"},{"location":"chap8/3Istio_mon/#_2","title":"\u90e8\u7f72\u5b9e\u4f8b\u5e94\u7528","text":"<p>\u4e3a\u4e86\u80fd\u591f\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf\u5e76\u8bbf\u95eeNginx Pod\uff0c\u6211\u4eec\u9700\u8981\u4ee5\u67d0\u79cd\u65b9\u5f0f\u8ba9\u5b83\u53ef\u4ee5\u88ab\u8bbf\u95ee\u3002 </p> <p>\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u5c06Nginx\u90e8\u7f72\u4f5c\u4e3a\u670d\u52a1\u516c\u5f00\uff1a </p> <pre><code>kubectl create deploy my-nginx --image=ngix\n</code></pre> <pre><code>kubectl expose deployment my-nginx --type=NodePort --name=my-nginx --port 80\nservice/my-nginx exposed\n</code></pre> <p>\u6ce8\u610f\uff1a \u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528Istio\u8d44\u6e90\u5e76\u901a\u8fc7Istio\u7684\u5165\u53e3\u7f51\u5173\u66b4\u9732\u670d </p> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c<code>kubectl get services</code>\uff0c\u83b7\u5f97<code>my-nginx</code>\u670d\u52a1\u7684\u5916\u90e8IP\u5730\u5740\uff1a </p> <pre><code>$ kubectl get svc\nNAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nkubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        13d\nmy-nginx     NodePort    10.109.102.197   &lt;none&gt;        80:31837/TCP   2s\n</code></pre> <pre><code>$ curl 127.0.0.1:$(kubectl get service my-nginx -o jsonpath='{.spec.ports[0].nodePort}')\n\n\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\nhtml { color-scheme: light dark; }\nbody { width: 35em; margin: 0 auto;\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u7136\u540e\uff0c\u4ece<code>Prometheus UI</code>\u4e2d\uff0c\u4f60\u53ef\u4ee5\u641c\u7d22Istio\u7684\u4e00\u4e2a\u6307\u6807\uff08\u4f8b\u5982 <code>istio_requests_total{app=\"my-nginx\"}</code>)\uff0c\u4ee5\u4e86\u89e3\u54ea\u4e9b\u6570\u636e\u70b9\u6b63\u5728\u88ab\u6536\u96c6\u3002 </p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u6765\u81eaPrometheus\u7528\u6237\u754c\u9762\u7684\u793a\u4f8b\u5143\u7d20\uff1a </p> <pre><code>$  istio_requests_total{app=\"my-nginx\"}\n\n\nistio_requests_total{app=\"my-nginx\", connection_security_policy=\"none\", destination_app=\"my-nginx\", destination_canonical_revision=\"latest\", destination_canonical_service=\"my-nginx\", destination_cluster=\"Kubernetes\", destination_principal=\"unknown\", destination_service=\"my-nginx.default.svc.cluster.local\", destination_service_name=\"my-nginx\", destination_service_namespace=\"default\", destination_version=\"unknown\", destination_workload=\"my-nginx\", destination_workload_namespace=\"default\", instance=\"10.1.0.221:15020\", istio_io_rev=\"default\", job=\"kubernetes-pods\", kubernetes_namespace=\"default\", kubernetes_pod_name=\"my-nginx-6b74b79f57-6spkz\", pod_template_hash=\"6b74b79f57\", reporter=\"destination\", request_protocol=\"http\", response_code=\"200\", response_flags=\"-\", security_istio_io_tlsMode=\"istio\", service_istio_io_canonical_name=\"my-nginx\", service_istio_io_canonical_revision=\"latest\", source_app=\"unknown\", source_canonical_revision=\"latest\", source_canonical_service=\"unknown\", source_cluster=\"unknown\", source_principal=\"unknown\", source_version=\"unknown\", source_workload=\"unknown\", source_workload_namespace=\"unknown\"}     2\n</code></pre> <p> </p>"},{"location":"chap8/3Istio_mon/#3grafana","title":"3\u3001Grafana","text":""},{"location":"chap8/3Istio_mon/#3-1-grafana","title":"3-1 Grafana","text":"<ul> <li>Open platform for analytics and monitoring </li> <li>Connects to Prometheus (and other sources) </li> <li>Monitor health of lstio and apps in the mesh </li> <li>Install from <code>/samples/addons</code> folder <ul> <li><code>istioctl dashboard grafana</code></li> </ul> </li> </ul> <p>Grafana\u662f\u4e00\u4e2a\u7528\u4e8e\u5206\u6790\u548c\u76d1\u63a7\u7684\u5f00\u653e\u5e73\u53f0\u3002Grafana\u53ef\u4ee5\u8fde\u63a5\u5230\u5404\u79cd\u6570\u636e\u6e90\uff0c\u5e76\u4f7f\u7528\u56fe\u5f62\u3001 \u8868\u683c\u3001\u70ed\u56fe\u7b49\u5c06\u6570\u636e\u53ef\u89c6\u5316\u3002\u901a\u8fc7\u5f3a\u5927\u7684\u67e5\u8be2\u8bed\u8a00\uff0c\u4f60\u53ef\u4ee5\u5b9a\u5236\u73b0\u6709\u7684\u4eea\u8868\u76d8\u5e76\u521b\u5efa\u66f4\u9ad8\u7ea7\u7684\u53ef\u89c6\u5316\u3002 </p> <p>\u901a\u8fc7Grafana\uff0c\u6211\u4eec\u53ef\u4ee5\u76d1\u63a7Istio\u5b89\u88c5\u548c\u670d\u52a1\u7f51\u683c\u4e2d\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5\u3002 </p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528grafana . yami\u6765\u90e8\u7f72\u5e26\u6709\u9884\u914d\u7f6e\u4eea\u8868\u76d8\u7684Grafana\u793a\u4f8b\u5b89\u88c5\u3002\u8be5YAML\u6587\u4ef6\u5728Istio\u5b89\u88c5\u5305\u7684<code>/samples /addons</code>\u4e0b\u3002 </p> <p>\u786e\u4fdd\u5728\u90e8\u7f72Grafana\u4e4b\u524d\u90e8\u7f72<code>Promeheus</code>\u63d2\u4ef6\uff0c\u56e0\u4e3a<code>Grafana</code>\u4f7f\u7528<code>Prometheus</code>\u4f5c\u4e3a\u5176\u6570\u636e\u6e90\u3002  \u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u90e8\u7f72<code>Grafana</code>\u548c\u9884\u914d\u7f6e\u7684\u4eea\u8868\u76d8\uff1a </p> <pre><code>$ kubectl apply -f istio-1.10.3/samples/addons/grafana.yaml \n\nserviceaccount/grafana created\nconfigmap/grafana created\nservice/grafana created\ndeployment.apps/grafana created\nconfigmap/istio-grafana-dashboards created\nconfigmap/istio-services-grafana-dashboards created\n</code></pre> <pre><code>$ kubectl get pod -n istio-system\nNAME                                   READY   STATUS    RESTARTS   AGE\ngrafana-56d978ff77-d6m4w               1/1     Running   0          64s\nistio-egressgateway-5547fcc8fc-7kj9c   1/1     Running   0          2d4h\nistio-ingressgateway-8f568d595-zj9bs   1/1     Running   0          2d4h\nistiod-6659979bdf-l7kgk                1/1     Running   0          2d4h\nprometheus-8958b965-hpp2v              2/2     Running   0          47h\n</code></pre> <p>\u8fd9\u4e2aGrafana\u3002\u5b89\u88c5\u4e0d\u6253\u7b97\u5728\u751f\u4ea7\u4e2d\u8fd0\u884c\uff0c\u56e0\u4e3a\u5b83\u6ca1\u6709\u7ecf\u8fc7\u6027\u80fd\u6216\u5b89\u5168\u65b9\u9762\u7684\u8c03\u6574\u3002 </p> <p>Kubernetes\u5c06Grafana\u90e8\u7f72\u5728 <code>istio-System</code>\u547d\u540d\u7a7a\u95f4\u3002\u8981\u8bbf\u95eeGrafana\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528  <code>istioctl dashboard</code></p> <pre><code>$ istioctl dashboard grafana \nhttp://localhost:3000 \n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00<code>http://localhost:3000</code>\uff0c\u8fdb\u5165Grafana\u3002\u7136\u540e\uff0c\u70b9\u51fb\u9996\u9875\u548cistlo\u6587\u4ef6\u5939\uff0c\u67e5\u770b\u5df2\u5b89\u88c5\u7684\u4eea\u8868\u76d8\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 </p> <p> </p> <p>Istio Grafana\u5b89\u88c5\u65f6\u9884\u914d\u7f6e\u4e86\u4ee5\u4e0b\u4eea\u8868\u76d8\uff1a </p> <p>1.Istlo\u63a7\u5236\u5e73\u9762\u4eea\u8868\u76d8 </p> <p>\u4eceIstio\u63a7\u5236\u5e73\u9762\u4eea\u8868\u76d8\uff0c\u6211\u4eec\u53ef\u4ee5\u76d1\u63a7Istio\u63a7\u5236\u5e73\u9762\u7684\u5065\u5eb7\u548c\u6027\u80fd\u3002 </p> <p> </p> <p>\u8fd9\u4e2a\u4eea\u8868\u76d8\u5c06\u5411\u6211\u4eec\u5c55\u793a\u63a7\u5236\u5e73\u9762\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff08\u5185\u5b58\u3001CPU'\u78c1\u76d8\u3001Go routines)\uff0c\u4ee5\u53ca\u5173\u4e8ePiIot\u3001 Envoy\u548cWebhook\u7684\u4fe1\u606f\u3002 </p> <p>2.Istio\u7f51\u683c\u4eea\u8868\u76d8</p> <p>\u7f51\u683c\u4eea\u8868\u76d8\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u5728\u7f51\u683c\u4e2d\u8fd0\u884c\u7684\u6240\u6709\u670d\u52a1\u7684\u6982\u89c8\u3002\u4eea\u8868\u76d8\u5305\u62ec\u5168\u5c40\u8bf7\u6c42\u91cf\u3001\u6210\u529f\u7387\u4ee5\u53ca 4xx\u548c 5xx \u54cd\u5e94\u7684\u6570\u91cf\u3002 </p> <p> </p> <p>3. Istlo\u6027\u80fd\u4eea\u8868\u76d8</p> <p>\u6027\u80fd\u4eea\u8868\u76d8\u5411\u6211\u4eec\u5c55\u793a\u4e86Istio\u4e3b\u8981\u7ec4\u4ef6\u5728\u7a33\u5b9a\u8d1f\u8f7d\u4e0b\u7684\u8d44\u6e90\u5229\u7528\u7387\u3002 </p> <p> </p> <p>4.Istlo\u670d\u52a1\u4eea\u8868\u76d8 </p> <p>\u670d\u52a1\u4eea\u8868\u76d8\u5141\u8bb8\u6211\u4eec\u5728\u7f51\u683c\u4e2d\u67e5\u770b\u670d\u52a1\u7684\u7ec6\u8282\u3002 </p> <p>\u6211\u4eec\u53ef\u4ee5\u83b7\u5f97\u5173\u4e8e\u8bf7\u6c42\u91cf\u3001\u6210\u529f\u7387\u3001\u6301\u7eed\u65f6\u95f4\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u663e\u793a\u6309\u6765\u6e90\u548c\u54cd\u5e94\u4ee3\u7801\u3001\u6301\u7eed\u65f6\u95f4\u548c\u5927\u5c0f\u7684\u4f20\u5165\u8bf7\u6c42\u7684\u8be6\u7ec6\u56fe\u8868\u3002 </p> <p> </p> <p>5. Istlo Wasm\u6269\u5c55\u4eea\u8868\u76d8</p> <p>Istlo Wasm\u6269\u5c55\u4eea\u8868\u76d8\u663e\u793a\u4e0eWebAssembly\u6a21\u5757\u6709\u5173\u7684\u6307\u6807\u3002\u4ece\u8fd9\u4e2a\u4eea\u8868\u76d8\uff0c\u6211\u4eec\u53ef\u4ee5\u76d1\u63a7\u6d3b\u52a8\u7684\u548c\u521b\u5efa\u7684Wasm\u865a\u62df\u673a\uff0c\u5173\u4e8e\u83b7\u53d6\u5220\u9664Wasm\u6a21\u5757\u548c\u4ee3\u7406\u8d44\u6e90\u4f7f\u7528\u7684\u6570\u636e\u3002 </p> <p> </p> <p>6. Istlo\u5de5\u4f5c\u8d1f\u8f7d\u4eea\u8868\u76d8</p> <p>\u8fd9\u4e2a\u4eea\u8868\u76d8\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8be6\u7ec6\u6307\u6807\u5206\u7c7b\u3002 </p> <p> </p>"},{"location":"chap8/3Istio_mon/#4zipkin","title":"4\u3001Zipkin","text":""},{"location":"chap8/3Istio_mon/#4-1-trace-and-spans","title":"4-1 Trace and spans","text":"<ul> <li>Trace: collection of spans </li> <li>Span: name, start/finish timestamp, tags, context </li> <li>Tags: applied to all spans, used for querying/filtering </li> <li>Spans are sent to the collector to validate, index &amp; store the data </li> </ul> <p>\u5206\u5e03\u5f0f\u8ffd\u8e2a\u662f\u4e00\u79cd\u76d1\u6d4b\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u7684\u65b9\u6cd5\u3002\u4f7f\u7528\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8bf7\u6c42\u901a\u8fc7\u88ab\u76d1\u63a7\u7cfb\u7edf\u7684\u4e0d\u540c\u90e8\u5206\u65f6\u8ffd\u8e2a\u5b83\u4eec\u3002 </p> <p>\u6bcf\u5f53\u4e00\u4e2a\u8bf7\u6c42\u8fdb\u5165\u670d\u52a1\u7f51\u683c\u65f6\uff0cEnvoy\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a\u552f\u4e00\u7684\u8bf7\u6c42ID\u548c\u8ffd\u8e2a\u4fe1\u606f\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3aHTTP\u5934\u7684\u4e00\u90e8\u5206\u6765\u5b58\u50a8\u3002\u4efb\u4f55\u5e94\u7528\u7a0b\u5e8f\u90fd\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u5934\u4fe1\u606f\u8f6c\u53d1\u7ed9\u5b83\u6240\u8c03\u7528\u7684\u5176\u4ed6\u670d\u52a1\uff0c\u4ee5\u4fbf\u5728\u7cfb\u7edf\u4e2d\u521b\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684\u8ffd\u8e2a\u3002 </p>"},{"location":"chap8/3Istio_mon/#span","title":"\u5206\u5e03\u5f0f\u8ffd\u8e2a\u662f\u4e00\u4e2a\u8de8\u5ea6\uff08span)\u7684\u96c6\u5408\u3002","text":"<p>\u5f53\u8bf7\u6c42\u6d41\u7ecf\u4e0d\u540c\u7684\u7cfb\u7edf\u7ec4\u4ef6\u65f6\uff0c\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\u8de8\u5ea6\u3002\u6bcf\u4e2a\u8de8\u5ea6\u90fd\u6709\u4e00\u4e2a\u540d\u79f0\uff0c\u5f00\u59cb\u548c\u7ed3\u675f\u7684\u65f6\u95f4\u6233\uff0c\u4e00\u7ec4\u79f0\u4e3a\u6807\u7b7e\uff08tag\uff09\u548c\u65e5\u5fd7\uff08log) \u7684\u952e\u503c\u5bf9\uff0c\u4ee5\u53ca\u4e00\u4e2a\u8de8\u5ea6\u4e0a\u4e0b\u6587\u3002 </p> <p>\u6807\u7b7e\u88ab\u5e94\u7528\u4e8e\u6574\u4e2a\u8de8\u5ea6\uff0c\u5e76\u7528\u4e8e\u67e5\u8be2\u548c\u8fc7\u6ee4\u3002\u4e0b\u9762\u662f\u6211\u4eec\u5728\u4f7f\u7528Zipkin\u65f6\u5c06\u770b\u5230\u7684\u51e0\u4e2a\u6807\u7b7e\u7684\u4f8b\u5b50\u3002\u6ce8\u610f\uff0c\u5176\u4e2d\u6709\u4e9b\u662f\u901a\u7528\u7684\uff0c\u6709\u4e9b\u662flstio\u7279\u6709\u7684\uff1a </p> <p>Examples: </p> <ul> <li><code>istio.mesh_id</code> </li> <li><code>istio.canonical_service</code> </li> <li><code>upstream_cluster</code> </li> <li><code>http.url</code> </li> <li><code>http.status_code</code></li> <li><code>zone</code></li> </ul> <p>\u5355\u4e2a\u8de8\u5ea6\u4e0e\u8bc6\u522b\u8de8\u5ea6\u3001\u7236\u8de8\u5ea6\u3001\u8ffd\u8e2aID\u7684\u4e0a\u4e0b\u6587\u5934\u4e00\u8d77\u88ab\u53d1\u9001\u5230\u4e00\u4e2a\u53eb\u505a\u91c7\u96c6\u5668\u7684\u7ec4\u4ef6\u3002\u91c7\u96c6\u5668\u5bf9\u6570\u636e\u8fdb\u884c\u9a8c\u8bc1\u3001\u7d22\u5f15\u548c\u5b58\u50a8\u3002</p> <p>\u5f53\u8bf7\u6c42\u6d41\u7ecfEnvoy\u4ee3\u7406\u65f6\uff0cEnvoy\u4ee3\u7406\u4f1a\u81ea\u52a8\u53d1\u9001\u5404\u4e2a\u8de8\u5ea6\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0cEnvoy\u53ea\u80fd\u5728\u8fb9\u7f18\u6536\u96c6\u8de8\u5ea6\u3002\u6211\u4eec\u8981\u8d1f\u8d23\u5728\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u751f\u6210\u4efb\u4f55\u989d\u5916\u7684\u8de8\u5ea6\uff0c\u5e76\u786e\u4fdd\u6211\u4eec\u5728\u8c03\u7528\u5176\u4ed6\u670d\u52a1\u65f6\u8f6c\u53d1\u8ffd\u8e2a\u5934\u4fe1\u606f\u3002\u8fd9\u6837\u4e00\u6765\uff0c\u5404\u4e2a\u8de8\u5ea6\u5c31\u53ef\u4ee5\u6b63\u786e\u5730\u5173\u8054\u5230\u4e00\u4e2a\u5355\u4e00\u7684\u8ffd\u8e2a\u4e2d\u3002 </p> <p> </p>"},{"location":"chap8/3Istio_mon/#4-2-distributed-tracing-with-zipkin","title":"4-2 Distributed Tracing with Zipkin","text":"<ul> <li>Zipkin = distributed tracing system </li> <li>Discover latency and performance issues </li> <li>Requirements: propagate HTTP headers (B3 and Envoy request ID) <ul> <li>Traces captured at service boundaries </li> </ul> </li> <li>Instrument your applications </li> <li>Install from <code>/samples/addons/extras</code> folder <ul> <li><code>istioctl dashboard zipkin</code></li> </ul> </li> </ul>"},{"location":"chap8/3Istio_mon/#5zipkin","title":"5\u3001\u4f7f\u7528Zipkin\u8fdb\u884c\u5206\u5e03\u5f0f\u8ffd\u8e2a","text":"<p>Zipkin\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf\u3002\u6211\u4eec\u53ef\u4ee5\u8f7b\u677e\u5730\u76d1\u63a7\u670d\u52a1\u7f51\u683c\u4e2d\u53d1\u751f\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\uff0c\u53d1\u73b0\u4efb\u4f55\u6027\u80fd\u6216\u5ef6\u8fdf\u95ee\u9898\u3002 </p> <p>\u4e3a\u4e86\u8ba9\u6211\u4eec\u7684\u670d\u52a1\u53c2\u4e0e\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff0c\u6211\u4eec\u9700\u8981\u5728\u8fdb\u884c\u4efb\u4f55\u4e0b\u6e38\u670d\u52a1\u8c03\u7528\u65f6\u4f20\u64ad\u670d\u52a1\u7684HTTP\u5934\u4fe1\u606f\u3002\u5c3d\u7ba1\u6240\u6709\u7684\u8bf7\u6c42\u90fd\u8981\u7ecf\u8fc7<code>Istio sidecar</code>\uff0c</p> <p>\u4f46<code>Istio</code>\u6ca1\u6709\u529e\u6cd5\u5c06\u51fa\u7ad9\u8bf7\u6c42\u4e0e\u4ea7\u751f\u8fd9\u4e9b\u8bf7\u6c42\u7684\u5165\u7ad9\u8bf7\u6c42\u8054\u7cfb\u8d77\u6765\u3002\u901a\u8fc7\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4f20\u64ad\u76f8\u5173\u7684\u5934\u4fe1\u606f\u53ef\u4ee5\u5e2e\u52a9Zipkin\u5c06\u8fd9\u4e9b\u8ddf\u8e2a\u4fe1\u606f\u62fc\u63a5\u8d77\u6765\u3002</p> <p>Istio\u4f9d\u8d56\u4e8eB3\u8ddf\u8e2a\u5934\uff08\u4ee5<code>x-b3</code>\u5f00\u5934\u7684header) \u548cEnvoy\u751f\u6210\u7684\u8bf7\u6c42ID (<code>x-request-Id</code>)\u3002B3\u5934\u4fe1\u606f\u7528\u4e8e\u8de8\u670d\u52a1\u8fb9\u754c\u7684\u8ddf\u8e2a\u4e0a\u4e0b\u6587\u4f20\u64ad\u3002</p> <p>\u4ee5\u4e0b\u662f\u6211\u4eec\u9700\u8981\u5728\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5bf9\u6bcf\u4e2a\u53d1\u51fa\u7684\u8bf7\u6c42\u8fdb\u884c\u4f20\u64ad\u7684\u7279\u5b9a\u5934\u6587\u4ef6\u540d\u79f0\uff1a </p> <ul> <li><code>x-request-id</code> </li> <li><code>x-b3-traceid</code> </li> <li><code>x-b3-spanid</code> </li> <li><code>x-b3-parentspanid</code> `</li> <li><code>x-b3-sampled</code> </li> <li><code>x-b3-flags</code></li> <li><code>b3</code> </li> </ul> <p>\u5982\u679c\u4f60\u4f7f\u7528Lightstep\uff0c\u4f60\u8fd8\u9700\u8981\u8f6c\u53d1\u540d\u4e3a<code>x-ot-span-context</code>\u7684\u5934\u3002 </p> <p>\u4f20\u64ad\u5934\u4fe1\u606f\u6700\u5e38\u89c1\u7684\u65b9\u6cd5\u662f\u4ece\u4f20\u5165\u7684\u8bf7\u6c42\u4e2d\u590d\u5236\u5b83\u4eec\uff0c\u5e76\u5c06\u5b83\u4eec\u5305\u542b\u5728\u6240\u6709\u4ece\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u53d1\u51fa\u7684\u8bf7\u6c42\u4e2d</p> <p>\u4f60\u7528Istio\u670d\u52a1\u7f51\u683c\u5f97\u5230\u7684\u8ddf\u8e2a\u53ea\u5728\u670d\u52a1\u8fb9\u754c\u6355\u83b7\u3002\u4e3a\u4e86\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u7684\u884c\u4e3a\u5e76\u6392\u9664\u6545\u969c\uff0c\u4f60\u9700\u8981\u901a\u8fc7\u521b\u5efa\u989d\u5916\u7684\u8de8\u5ea6\uff08span)\u6765\u6b63\u786e\u68c0\u6d4b\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u3002 </p> <p>\u8981\u5b89\u88c5Zipkin\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528addons\u6587\u4ef6\u5939\u4e2d\u7684\uff1a<code>zipkin.yaml</code>\u6587\u4ef6\u3002 </p> <pre><code>$ kubectl apply -f istio-1.10.3/samples/addons/extras/zipkin.yaml \ndeployment.apps/zipkin created\nservice/tracing created\nservice/zipkin created\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>getmesh istioctl dashboard zipkin</code>\u6765\u6253\u5f00Zipkin\u4eea\u8868\u677f\u3002\u5728\u7528\u6237\u754c\u9762\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u8ddf\u8e2a\u67e5\u8be2\u7684\u6807\u51c6\u3002\u70b9\u51fb\u6309\u94ae\uff0c\u4ece\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9<code>serviceName</code>\uff0c\u7136\u540e\u9009\u62e9<code>customers. default</code> service\uff0c\u70b9\u51fb\u641c\u7d22\u6309\u94ae\uff08\u6216\u6309\u56de\u8f66\u952e\uff09\uff0c\u5c31\u53ef\u4ee5\u641c\u7d22\u5230<code>trace</code>\u4fe1\u606f\u3002 </p> <p> </p> <p>\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb\u4e2a\u522btrace\u6765\u6df1\u5165\u6316\u6398\u4e0d\u540c\u7684\u8de8\u5ea6\u3002\u8be6\u7ec6\u7684\u89c6\u56fe\u5c06\u663e\u793a\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u65f6\u95f4\uff0c\u4ee5\u53ca\u8bf7\u6c42\u7684\u7ec6\u8282\uff0c\u5982\u65b9\u6cd5\u3001\u534f\u8bae\u3001\u72b6\u6001\u7801\u7b49\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u670d\u52a1\u5728\u8fd0\u884c\uff08Nginx)\uff0c\u6240\u4ee5\u4f60\u4e0d\u4f1a\u770b\u5230\u5f88\u591a\u7ec6\u8282\u3002\u7a0d\u540e\uff0c\u6211\u4eec\u5c06\u56de\u5230Zipkin\uff0c\u66f4\u8be6\u7ec6\u5730\u63a2\u7d22\u8fd9\u4e9btrace</p> <p> </p>"},{"location":"chap8/3Istio_mon/#6kiali","title":"6\u3001Kiali","text":"<p>Kiali\u662f\u4e00\u4e2a\u57fa\u4e8eIstio\u7684\u670d\u52a1\u7f51\u683c\u7684\u7ba1\u7406\u63a7\u5236\u53f0\u3002\u5b83\u63d0\u4f9b\u4e86\u4eea\u8868\u76d8\u3001\u53ef\u89c2\u5bdf\u6027\uff0c\u5e76\u8ba9\u6211\u4eec\u901a\u8fc7\u5f3a\u5927\u7684\u914d\u7f6e\u548c\u9a8c\u8bc1\u80fd\u529b\u6765\u64cd\u4f5c\u7f51\u683c\u3002\u5b83\u901a\u8fc7\u63a8\u65ad\u6d41\u91cf\u62d3\u6251\u6765\u663e\u793a\u670d\u52a1\u7f51\u683c\uff0c\u5e76\u663e\u793a\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u51b5\u3002</p> <p>Kiali\u63d0\u4f9b\u4e86\u8be6\u7ec6\u7684\u6307\u6807\uff0c\u5f3a\u5927\u7684\u9a8c\u8bc1\uff0cGrafana\u8bbf\u95ee\uff0c\u4ee5\u53ca\u4e0e<code>Jaeger</code>\u7684\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7684\u5f3a\u5927\u96c6\u6210\u3002 </p> <p>\u8981\u5b89\u88c5Kiali\uff0c\u8bf7\u4f7f\u7528<code>addons</code>\u6587\u4ef6\u5939\u4e2d\u7684<code>kiali.yaml</code>\u6587\u4ef6\uff1a</p> <pre><code> kubectl apply -f istio-1.10.3/samples/addons/kiali.yaml\n</code></pre> <p>\u6ce8\u610f\uff0c\u5982\u679c\u4f60\u770b\u5230\u4efb\u4f55\u9519\u8bef\uff0c\u4f8b\u5982\u5728\u7248\u672c<code>monitoringkiali/vlalpha</code>\u4e2d\u6ca1\u6709\u5339\u914d\u7684<code>MonitoringDashboard</code>, \u8bf7\u91cd\u65b0\u8fd0\u884c<code>kubectl apply</code>\u547d\u4ee4\u3002\u95ee\u9898\u662f\uff0c\u5728\u5b89\u88c5CRD\uff08\u81ea\u5b9a  \u5b9a\u4e49\u7684\u8d44\u6e90\u65f6\uff0c\u53ef\u80fd\u5b58\u5728\u4e00\u4e2a\u5339\u914d\u6761\u4ef6)\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u7528<code>getmesh istioctl dashboard kiali</code>\u6253\u5f00<code>Kiali</code></p> <p>Kiali\u53ef\u4ee5\u751f\u6210\u4e00\u4e2a\u50cf\u4e0b\u56fe\u8fd9\u6837\u7684\u670d\u52a1\u56fe\u3002 </p> <p> </p> <p>\u8be5\u56fe\u5411\u6211\u4eec\u5c55\u793a\u4e86\u670d\u52a1\u7684\u62d3\u6251\u7ed3\u6784\uff0c\u5e76\u5c06\u670d\u52a1\u7684\u901a\u4fe1\u65b9\u5f0f\u53ef\u89c6\u5316\u3002\u5b83\u8fd8\u663e\u793a\u4e86\u5165\u7ad9\u548c\u51fa\u7ad9\u7684\u6307 \u6807\uff0c\u4ee5\u53ca\u901a\u8fc7\u8fde\u63a5Jaeger\u548cGrafana\uff08\u5982\u679c\u5b89\u88c5\u4e86\uff09\u7684\u8ffd\u8e2a\u3002\u56fe\u4e2d\u7684\u989c\u8272\u4ee3\u8868\u670d\u52a1\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u51b5\u3002\u7ea2\u8272\u6216\u6a59\u8272\u7684\u8282\u70b9\u53ef\u80fd\u9700\u8981\u6ce8\u610f\u3002\u7ec4\u4ef6\u4e4b\u95f4\u7684\u8fb9\u7684\u989c\u8272\u4ee3\u8868\u8fd9\u4e9b\u7ec4\u4ef6\u4e4b\u95f4\u7684\u8bf7\u6c42\u7684\u5065\u5eb7\u72b6\u51b5\u3002\u8282\u70b9\u5f62\u72b6\u8868\u793a\u7ec4\u4ef6\u7684\u7c7b\u578b\uff0c\u5982\u670d\u52a1\u3001\u5de5\u4f5c\u8d1f\u8f7d\u6216\u5e94\u7528\u7a0b\u5e8f\u3002 </p> <p>\u8282\u70b9\u548c\u8fb9\u7684\u5065\u5eb7\u72b6\u51b5\u4f1a\u6839\u636e\u7528\u6237\u7684\u504f\u597d\u81ea\u52a8\u5237\u65b0\u3002\u8be5\u56fe\u4e5f\u53ef\u4ee5\u6682\u505c\u4ee5\u68c0\u67e5\u4e00\u4e2a\u7279\u5b9a\u7684\u72b6\u6001\uff0c\u6216\u56de\u653e\u4ee5\u91cd\u65b0\u68c0\u67e5\u4e00\u4e2a\u7279\u5b9a\u7684\u65f6\u671f\u3002 </p> <p>Kiali\u63d0\u4f9b\u521b\u5efa\u3001\u66f4\u65b0\u548c\u5220\u9664Istio\u914d\u7f6e\u7684\u64cd\u4f5c\uff0c\u7531\u5411\u5bfc\u9a71\u52a8\u3002\u6211\u4eec\u53ef\u4ee5\u914d\u7f6e\u8bf7\u6c42\u8def\u7531\u3001\u6545\u969c\u6ce8\u5165\u3001\u6d41\u91cf\u8f6c\u79fb\u548c\u8bf7\u6c42\u8d85\u65f6\uff0c\u6240\u6709\u8fd9\u4e9b\u90fd\u6765\u81ea\u7528\u6237\u754c\u9762\u3002\u5982\u679c\u6211\u4eec\u6709\u4efb\u4f55\u73b0\u6709\u7684Istio\u914d\u7f6e\u5df2\u7ecf\u90e8\u7f72, Kiali\u53ef\u4ee5\u9a8c\u8bc1\u5b83\u5e76\u62a5\u544a\u4efb\u4f55\u8b66\u544a\u6216\u9519\u8bef\u3002 </p>"},{"location":"chap8/3Istio_mon/#7","title":"7\u3001\u53ef\u89c2\u6d4b\u6027\u6d4b\u8bd5","text":"<p>1\u3001Prometheus\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684\uff1f </p> <ul> <li>A \u8bb0\u5f55\u6307\u6807\uff0c\u8ddf\u8e2aIstio\u548c\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5</li> <li>B \u53ef\u89c6\u5316\u670d\u52a1\u4e4b\u95f4\u7684\u6d41\u91cf </li> <li>C \u91c7\u96c6\u5206\u5e03\u5f0f\u8ddf\u8e2a </li> <li>D \u90e8\u7f72\u5206\u5e03\u5f0f\u5e94\u7528 </li> </ul> <p>2\u3001\u4ec0\u4e48\u662fZipkin? </p> <ul> <li>A \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf</li> <li>B \u53ef\u89c6\u5316\u6d41\u91cf\u7684\u5e73\u53f0 </li> <li>C \u6536\u96c6\u670d\u52a1\u65e5\u5fd7\u7684\u6846\u67b6 </li> <li>D \u8bb0\u5f55Istio\u670d\u52a1\u5065\u5eb7\u7684\u51ed\u6761 </li> </ul> <p>3\u3001\u4ec0\u4e48\u662fKiali?</p> <ul> <li>A \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf </li> <li>B Grafana\u63d2\u4ef6 </li> <li>C Istio\u53ef\u89c2\u6d4b\u6027\u9762\u677f </li> <li>D \u65e5\u5fd7\u6536\u96c6\u5de5\u5177 </li> </ul> <p>4\u3001\u4f60\u53ef\u4ee5\u4f7f\u7528Istio CLI\u4e2d\u7684\u54ea\u4e2a\u8f85\u52a9\u547d\u4ee4\u6765\u6253\u5f00 Prometheus/Grafana/Jaeger/Zipkin? </p> <ul> <li>A  <code>istioctl open dash</code></li> <li>B <code>istiocti dashboard open</code> </li> <li>C <code>istioctl --dashboard</code> </li> <li>D <code>istioctl dashboard</code> </li> </ul> <p>5\u3001Istio\u4f9d\u9760\u54ea\u4e9b\u5934\u4fe1\u606f\u6765\u8fdb\u884c\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1f</p> <ul> <li>A X-headers </li> <li>B B3 header\u548cEnvoy requestID </li> <li>C Host\u548cUser header </li> <li>D Request ID header </li> </ul> <p>6\u3001\u4ec0\u4e48\u662fGrafana?</p> <ul> <li>A \u50a8\u5b58\u591a\u4e2a\u6765\u6e90\u7684\u65e5\u5fd7\u7684\u89e3\u51b3\u65b9\u6848 </li> <li>B Prometheus\u548c\u5176\u4ed6\u6765\u6e90\u7684\u6570\u636e\u7684\u53ef\u89c6\u5316\u5e73\u53f0 </li> <li>C \u6536\u96c6\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7684\u6846\u67b6 </li> <li>D \u7528\u4e8e\u53ef\u89c6\u5316\u6570\u636e\u7684Prometheus\u63d2\u4ef6 </li> </ul>"},{"location":"chap8/4Istio_net_control/","title":"\u7b2c\u56db\u8282 \u6d41\u91cf\u7ba1\u7406","text":""},{"location":"chap8/4Istio_net_control/#0traffic-management","title":"0\u3001Traffic Management","text":"<ul> <li>Traffic routing </li> <li>Service resiliency and failure injection </li> <li>Envoy filters </li> <li>Labs: <ul> <li>Exposing services using Gateway resource </li> <li>Observing failure injection and delays </li> <li>Simple traffic routing </li> <li>Advanced traffic routing </li> <li>Quiz </li> </ul> </li> </ul>"},{"location":"chap8/4Istio_net_control/#1gateway","title":"1\u3001\u4f7f\u7528Gateway","text":"<p>\u4f5c\u4e3a Istio \u5b89\u88c5\u7684\u4e00\u90e8\u5206\uff0c\u6211\u4eec\u5b89\u88c5\u4e86Istio\u7684\u5165\u53e3\u548c\u51fa\u53e3\u7f51\u5173\u3002</p> <p>\u8fd9\u4e24\u4e2a\u7f51\u5173\u90fd\u8fd0\u884c\u4e00\u4e2aEnvoy\u4ee3\u7406\u5b9e\u4f8b\uff0c\u5b83\u4eec\u5728\u7f51\u683c\u7684\u8fb9\u7f18\u4f5c\u4e3a\u8d1f\u8f7d\u5747\u8861\u5668\u8fd0\u884c\u3002\u5165\u53e3\u7f51\u5173\u63a5\u6536\u5165\u7ad9\u8fde\u63a5\uff0c\u800c\u51fa\u53e3\u7f51\u5173\u63a5\u6536 \u4ece\u96c6\u7fa4\u51fa\u53bb\u7684\u8fde\u63a5\u3002 </p> <p>\u4f7f\u7528\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u8fdb\u5165\u96c6\u7fa4\u7684\u6d41\u91cf\u5e94\u7528\u8def\u7531\u89c4\u5219\u3002\u6211\u4eec\u53ef\u4ee5\u6709\u4e00\u4e2a\u6307\u5411\u5165\u53e3\u7f51\u5173\u7684\u5355\u4e00\u5916\u90e8IP\u5730\u5740\uff0c\u5e76\u6839\u636e\u4e3b\u673a\u5934\u5c06\u6d41\u91cf\u8def\u7531\u5230\u96c6\u7fa4\u5185\u7684\u4e0d\u540c\u670d\u52a1\u3002 </p> <p> </p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528Gateway\u8d44\u6e90\u6765\u914d\u7f6e\u7f51\u5173\u3002\u7f51\u5173\u8d44\u6e90\u63cf\u8ff0\u4e86\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u66b4\u9732\u7aef\u53e3\u3001\u534f\u8bae\u3001SNI \uff08\u670d\u52a1\u5668\u540d\u79f0\u6307\u793a\uff09\u914d\u7f6e\u7b49\u3002</p> <p>\u7f51\u5173\u8d44\u6e90\u5728\u80cc\u540e\u63a7\u5236\u7740Envoy\u4ee3\u7406\u5728\u7f51\u7edc\u63a5\u53e3\u4e0a\u7684\u76d1\u542c\u65b9\u5f0f\u4ee5\u53ca\u5b83\u51fa\u793a\u7684\u8bc1\u4e66\u3002 </p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u7f51\u5173\u8d44\u6e90\u7684\u4f8b\u5b50\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: my-gateway\n  namespace: default\nspec:\n  selector:\n   istio: ingressgateway\n  servers:\n  - port:\n    number: 80\n    name: http\n    protocol: HTTP\n   hosts:\n   - dev.example.com\n   - test.example.com\n</code></pre> <p>\u4e0a\u8ff0\u7f51\u5173\u8d44\u6e90\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u4ee3\u7406\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u4e3a\u5165\u53e3\u66b4\u973280\u7aef\u53e3\u3002</p> <p>\u7f51\u5173\u914d\u7f6e\u88ab\u5e94\u7528\u4e8e<code>Istio</code>\u5165\u53e3\u7f51\u5173\u4ee3\u7406\uff0c\u6211\u4eec\u5c06\u5176\u90e8\u7f72\u5230<code>istio-system</code>\u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u8bbe\u7f6e\u4e86\u6807\u7b7e<code>istio:ingressgateway</code>\u3002</p> <p>\u901a\u8fc7\u7f51\u5173\u8d44\u6e90\uff0c\u6211\u4eec\u53ea\u80fd\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\u3002<code>hosts</code>\u5b57\u6bb5\u4f5c\u4e3a\u4e00\u4e2a\u8fc7\u6ee4\u5668\uff0c\u53ea\u6709\u4ee5<code>dev.example.com</code>\u548c<code>test.example.com</code>\u4e3a\u76ee\u7684\u5730\u7684\u6d41\u91cf\u4f1a\u88ab\u5141\u8bb8\u901a\u8fc7\u3002 </p> <p>\u4e3a\u4e86\u63a7\u5236\u548c\u8f6c\u53d1\u6d41\u91cf\u5230\u96c6\u7fa4\u5185\u8fd0\u884c\u7684\u5b9e\u9645<code>Kubernetes</code>\u670d\u52a1\uff0c\u6211\u4eec\u5fc5\u987b\u7528\u7279\u5b9a\u7684\u4e3b\u673a\u540d\uff08\u4f8b\u5982 <code>dev.example.com</code>\u548c<code>test.example.com</code>\uff09\u914d\u7f6e\u4e00\u4e2a<code>VirtualService</code>\uff0c\u7136\u540e\u5c06\u7f51\u5173\u8fde\u63a5\u5230 \u5b83\u3002 </p> <p> </p> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u4f5c\u4e3aIstio\u5b89\u88c5demo\u7684\u4e00\u90e8\u5206\u800c\u90e8\u7f72\u7684Ingress\u7f51\u5173\u521b\u5efa\u4e86\u4e00\u4e2a\u5177\u6709 Load Balancer\u7c7b\u578b\u7684Kubernetes\u670d\u52a1\uff0c\u5e76\u4e3a\u5176\u5206\u914d\u4e86\u4e00\u4e2a\u5916\u90e8IP: </p> <pre><code>$ kubectl get svc -n istio-system \nNAME                   TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                      AGE\ngrafana                ClusterIP      10.106.113.25    &lt;none&gt;        3000/TCP                                                                     23h\nistio-egressgateway    ClusterIP      10.104.176.79    &lt;none&gt;        80/TCP,443/TCP                                                               3d3h\nistio-ingressgateway   LoadBalancer   10.105.159.70    localhost     15021:31875/TCP,80:32344/TCP,443:31252/TCP,31400:31315/TCP,15443:31199/TCP   3d3h\nistiod                 ClusterIP      10.96.216.110    &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        3d3h\n</code></pre> <p>LoadBalancer Kubernetes\u670d\u52a1\u7c7b\u578b\u7684\u5de5\u4f5c\u65b9\u5f0f\u53d6\u51b3\u4e8e\u6211\u4eec\u8fd0\u884cKubernetes\u96c6\u7fa4\u7684\u65b9\u5f0f\u548c\u5730\u70b9\u3002\u5bf9\u4e8e\u4e91\u6258\u7ba1\u7684\u96c6\u7fa4\uff08GCPS. AWS\u3001 Azure\u7b49\uff09\uff0c\u5728\u4f60\u7684\u4e91\u8d26\u6237\u4e2d\u914d\u7f6e\u4e86\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u8d44\u6e90\uff0cKubernetes LoadBalancer\u670d\u52a1\u5c06\u83b7\u5f97\u4e00\u4e2a\u5206\u914d\u7ed9\u5b83\u7684\u5916\u90e8IP\u5730\u5740\u3002\u5047\u8bbe\u6211\u4eec\u6b63\u5728\u4f7f\u7528Minikube\u6216DockerDesktop\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5916\u90e8IP\u5730\u5740\u5c06\u88ab\u8bbe\u7f6e\u4e3alocalhost (Docker Desktop)\uff0c\u6216\u8005\uff0c\u5982\u679c\u6211\u4eec\u4f7f\u7528Minikube\uff0c\u5b83\u5c06\u4fdd\u6301\u5f85\u5b9a\uff0c\u6211\u4eec\u5c06\u4e0d\u5f97\u4e0d\u4f7f\u7528minikube tunnel\u547d\u4ee4\u6765\u83b7\u5f97\u4e00\u4e2aIP\u5730\u5740\u3002 </p> <p>\u9664\u4e86\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u90e8\u7f72\u4e00\u4e2a\u51fa\u53e3\u7f51\u5173\u6765\u63a7\u5236\u548c\u8fc7\u6ee4\u79bb\u5f00\u7f51\u683c\u7684\u6d41\u91cf\u3002</p> <p>\u5c31\u50cf\u6211\u4eec\u914d\u7f6e\u5165\u53e3\u7f51\u5173\u4e00\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u76f8\u540c\u7684\u7f51\u5173\u8d44\u6e90\u6765\u914d\u7f6e\u51fa\u53e3\u7f51\u5173\u3002\u8fd9\u4f7f\u6211\u4eec\u80fd\u591f\u96c6\u4e2d\u7ba1\u7406\u6240\u6709\u6d41\u51fa\u7684\u6d41\u91cf\u3001\u65e5\u5fd7\u548c\u6388\u6743\u3002</p>"},{"location":"chap8/4Istio_net_control/#2","title":"2\u3001\u7b80\u5355\u8def\u7531","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>VirtualService</code>\u8d44\u6e90\u5728Istio\u670d\u52a1\u7f51\u683c\u4e2d\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002</p> <p>\u901a\u8fc7<code>VirtualService</code>, \u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u6d41\u91cf\u8def\u7531\u89c4\u5219\uff0c\u5e76\u5728\u5ba2\u6237\u7aef\u8bd5\u56fe\u8fde\u63a5\u5230\u670d\u52a1\u65f6\u5e94\u7528\u8fd9\u4e9b\u89c4\u5219\u3002\u4f8b\u5982\u5411<code>dev.example.com</code>\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff0c\u6700\u7ec8\u5230\u8fbe\u76ee\u6807\u670d\u52a1\u3002 </p> <p>\u8ba9\u6211\u4eec\u770b\u4e00\u4e0b\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c<code>customers</code>\u5e94\u7528\u7a0b\u5e8f\u7684\u4e24\u4e2a\u7248\u672c\uff08v1\u548cv2\uff09\u7684\u4f8b\u5b50\u3002\u6211\u4eec\u6709\u4e24\u4e2a <code>Kubernetes</code> \u90e8\u7f72\uff0c<code>customers-v1</code>\u548c<code>customers-v2</code>\u3002</p> <p>\u5c5e\u4e8e\u8fd9\u4e9b\u90e8\u7f72\u7684Pod\u6709\u4e00\u4e2a\u6807\u7b7e <code>version: v1</code>\u6216\u4e00\u4e2a\u6807\u7b7e<code>version: v2</code>\u7684\u8bbe\u7f6e\u3002</p> <p> </p> <p>\u6211\u4eec\u60f3\u628aVirtualService\u914d\u7f6e\u4e3a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u5e94\u7528\u7a0b\u5e8f\u7684V1\u7248\u672c\u300270\uff05\u7684\u4f20\u5165\u6d41\u91cf\u5e94\u8be5\u88ab\u8def\u7531\u5230V1\u7248\u672c\u300230\uff05\u7684\u8bf7\u6c42\u5e94\u8be5\u88ab\u53d1\u9001\u5230\u5e94\u7528\u7a0b\u5e8f\u7684V2\u7248\u672c\u3002</p> <p>\u4e0b\u9762\u662f\u4e0a\u8ff0\u60c5\u51b5\u4e0b<code>VirtualService</code>\u8d44\u6e90\u7684\u6837\u5b50\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers-route\nspec:\n  hosts:\n  - customers.default.svc.cluster.local\n  http:\n  - name: customers-v1-routes\n   route:\n   - destination:\n     host: customers.default.svc.cluster.local\n     subset: v1\n    weight: 70\n  - name: customers-v2-routes\n   route:\n   - destination:\n     host: customers.default.svc.cluster.local\n     subset: v2\n    weight: 30\n</code></pre> <p>\u5728<code>hosts</code>\u5b57\u6bb5\u4e0b\uff0c\u6211\u4eec\u8981\u5b9a\u4e49\u6d41\u91cf\u88ab\u53d1\u9001\u5230\u7684\u76ee\u6807\u4e3b\u673a\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u8fd9\u5c31\u662f <code>customers.default.svc.cluster.local</code> Kubernetes\u670d\u52a1\u3002 </p> <ul> <li>\u4e0b\u4e00\u4e2a\u5b57\u6bb5\u662fhttp\uff0c\u8fd9\u4e2a\u5b57\u6bb5\u5305\u542b\u4e00\u4e2aHTTP\u6d41\u91cf\u7684\u8def\u7531\u89c4\u5219\u7684\u6709\u5e8f\u5217\u8868\u3002</li> <li><code>destination</code>\u662f\u6307\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u7684\u4e00\u4e2a\u670d\u52a1\uff0c\u4e5f\u662f\u8def\u7531\u89c4\u5219\u5904\u7406\u540e\u8bf7\u6c42\u5c06\u88ab\u53d1\u9001\u5230\u7684\u76ee\u7684\u5730</li> <li><code>Istio</code>\u7684\u670d\u52a1\u6ce8\u518c\u8868\u5305\u542b\u6240\u6709\u7684Kubernetes\u670d\u52a1\uff0c\u4ee5\u53ca\u4efb\u4f55\u7528<code>ServiceEntry</code>\u8d44\u6e90\u58f0\u660e\u7684\u670d\u52a1\u3002</li> </ul> <p>\u6211\u4eec\u4e5f\u5728\u8bbe\u7f6e\u6bcf\u4e2a\u76ee\u7684\u5730\u7684\u6743\u91cd\uff08weight)\u3002\u6743\u91cd\u7b49\u4e8e\u53d1\u9001\u5230\u6bcf\u4e2a\u5b50\u96c6\u7684\u6d41\u91cf\u7684\u6bd4\u4f8b\u3002\u6240\u6709\u6743\u91cd\u7684\u603b\u548c\u5e94\u8be5\u662f100\u3002\u5982\u679c\u6211\u4eec\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u76ee\u7684\u5730\uff0c\u6743\u91cd\u88ab\u5047\u5b9a\u4e3a100\u3002</p> <p>\u901a\u8fc7<code>gateways</code>\u5b57\u6bb5\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6307\u5b9a\u6211\u4eec\u60f3\u8981\u7ed1\u5b9a\u8fd9\u4e2a<code>VirtualService</code>\u7684\u7f51\u5173\u540d\u79f0\u3002\u6bd4\u5982 \u8bf4\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers-route\nspec:\n  hosts:\n    - customers.default.svc.cluster.local\n  gateways:\n     - my-gateway\n  http:\n     ...\n</code></pre> <p>\u4e0a\u9762\u7684YAML\u5c06<code>customers-route</code> VirtualService\u7ed1\u5b9a\u5230\u540d\u4e3a<code>my-gateway</code>\u7684\u7f51\u5173\u4e0a\u3002\u8fd9 \u6709\u6548\u5730\u66b4\u9732\u4e86\u901a\u8fc7\u7f51\u5173\u7684\u76ee\u6807\u8def\u7531\u3002 </p> <p>\u5f53\u4e00\u4e2a<code>VirtualService</code>\u88ab\u9644\u52a0\u5230\u4e00\u4e2a\u7f51\u5173\u4e0a\u65f6, \u53ea\u5141\u8bb8\u5728\u7f51\u5173\u8d44\u6e90\u4e2d\u5b9a\u4e49\u7684\u4e3b\u673a\u3002</p> <p>\u4e0b\u8868\u89e3\u91ca\u4e86\u7f51\u5173\u8d44\u6e90\u4e2d\u7684<code>hosts</code>\u5b57\u6bb5\u5982\u4f55\u4f5c\u4e3a\u8fc7\u6ee4\u5668\uff0c<code>VirtualService</code>\u4e2d\u7684hosts\u5b57\u6bb5\u5982\u4f55\u4f5c\u4e3a\u5339\u914d</p> <p> </p>"},{"location":"chap8/4Istio_net_control/#3subsetdestination-rule","title":"3\u3001Subset\u548cDestination Rule","text":"<p>\u76ee\u7684\u5730\u6307\u7684\u662f\u4e0d\u540c\u7684\u5b50\u96c6\uff08subset\uff09\u6216\u670d\u52a1\u7248\u672c\u3002\u901a\u8fc7\u5b50\u96c6\uff0c\u6211\u4eec\u53ef\u4ee5\u8bc6\u522b\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u53d8\u4f53\u3002</p> <p>\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u6709\u4e24\u4e2a\u5b50\u96c6\uff0cv1\u548cv2\uff0c\u5b83\u4eec\u5bf9\u5e94\u4e8e\u6211\u4eeccustomer\u670d\u52a1\u7684\u4e24\u4e2a\u4e0d\u540c\u7248\u672c\u3002\u6bcf\u4e2a\u5b50\u96c6\u90fd\u4f7f\u7528\u952e\uff0f\u503c\u5bf9\uff08\u6807\u7b7e\uff09\u7684\u7ec4\u5408\u6765\u786e\u5b9a\u54ea\u4e9bPod\u8981\u5305\u542b\u5728\u5b50\u96c6\u4e2d\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u540d\u4e3a<code>DestinationRule</code>\u7684\u8d44\u6e90\u7c7b\u578b\u4e2d\u58f0\u660e\u5b50\u96c6\u3002 </p> <p>\u4e0b\u9762\u662f\u5b9a\u4e49\u4e86\u4e24\u4e2a\u5b50\u96c6\u7684DestinationRule\u8d44\u6e90\u7684\u6837\u5b50\u3002 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: customers-destination\nspec:\n  host: customers.default.svc.cluster.local\n  subsets:\n  - name: v1\n   labels:\n    version: v1\n  - name: v2\n   labels:\n    version: v2\n</code></pre> <p>\u8ba9\u6211\u4eec\u770b\u770b\u6211\u4eec\u53ef\u4ee5\u5728DestinationRule\u4e2d\u8bbe\u7f6e\u7684\u6d41\u91cf\u7b56\u7565\u3002 </p>"},{"location":"chap8/4Istio_net_control/#3-1-destination-rule","title":"3-1 Destination Rule\u4e2d\u7684\u6d41\u91cf\u7b56\u7565","text":"<p>\u901a\u8fc7<code>DestinationRule</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u8bbe\u7f6e\uff0c\u5982\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u3001\u8fde\u63a5\u6c60\u5927\u5c0f\u3001\u5c40\u90e8\u5f02\u5e38\u68c0\u6d4b\u7b49\uff0c\u5728\u8def\u7531\u53d1\u751f\u540e\u5e94\u7528\u4e8e\u6d41\u91cf\u3002\u6211\u4eec\u53ef\u4ee5\u5728trafficPolicy\u5b57\u6bb5\u4e0b\u8bbe\u7f6e\u6d41\u91cf\u7b56\u7565\u8bbe\u7f6e\u3002</p> <p>\u4ee5\u4e0b\u662f\u8fd9\u4e9b\u8bbe\u7f6e\uff1a</p> <ul> <li>\u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e </li> <li>\u8fde\u63a5\u6c60\u8bbe\u7f6e </li> <li>\u5c40\u90e8\u5f02\u5e38\u70b9\u68c0\u6d4b </li> <li>\u5ba2\u6237\u7aefTLS\u8bbe\u7f6e</li> <li>\u7aef\u53e3\u6d41\u91cf\u7b56\u7565 </li> </ul> <p>Traffic Policies</p> <ul> <li>Load balancer settings </li> <li>Connection pool settings </li> <li>Outlier detection </li> <li>Client TLS settings </li> <li>Port traffic policy </li> </ul> <p>\u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e </p> <p>\u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u76ee\u7684\u5730\u4f7f\u7528\u54ea\u79cd\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u5e26\u6709\u6d41\u91cf\u7b56\u7565\u7684DestinationRule\u7684\u4f8b\u5b50\uff0c\u5b83\u628a\u76ee\u7684\u5730\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u8bbe\u7f6e\u4e3a<code>round-robin</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: customers-destination\nspec:\n  host: customers.default.svc.cluster.local\n  trafficPolicy:\n   loadBalancer:\n    simple: ROUND_ROBIN\n  subsets:\n  - name: v1\n   labels:\n    version: v1\n  - name: v2\n   labels:\n    version: v2\n</code></pre> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u57fa\u4e8e\u54c8\u5e0c\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5e76\u6839\u636eHTTP\u5934\u3001cookies\u6216\u5176\u4ed6\u8bf7\u6c42\u5c5e\u6027\u63d0\u4f9b\u4f1a\u8bdd\u4eb2\u548c\u6027\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u6d41\u91cf\u7b56\u7565\u7684\u7247\u6bb5\uff0c\u5b83\u8bbe\u7f6e\u4e86\u57fa\u4e8e\u54c8\u5e0c\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5e76\u4f7f\u7528\u4e00\u4e2a\u53eb\u505a <code>location</code>\u7684<code>cookie</code>\u6765\u5b9e\u73b0\u4eb2\u548c\u529b\u3002 </p> <pre><code>trafficPolicy:\n  loadBalancer:\n   consistentHash:\n    httpCookie:\n     name: location\n     ttl: 4s\n</code></pre>"},{"location":"chap8/4Istio_net_control/#3-2","title":"3-2 \u8fde\u63a5\u6c60\u914d\u7f6e","text":"<p>\u8fd9\u4e9b\u8bbe\u7f6e\u53ef\u4ee5\u5728TCP\u548cHTTP\u5c42\u9762\u5e94\u7528\u4e8e\u4e0a\u6e38\u670d\u52a1\u7684\u6bcf\u4e2a\u4e3b\u673a, \u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u4eec\u6765\u63a7\u5236\u94fe\u63a5\u91cf </p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u7247\u6bb5\uff0c\u663e\u793a\u4e86\u6211\u4eec\u5982\u4f55\u8bbe\u7f6e\u5bf9\u670d\u52a1\u7684\u5e76\u53d1\u8bf7\u6c42\u7684\u9650\u5236\u3002 </p> <pre><code>spec:\n  host: myredissrv.prod.svc.cluster.local\n  trafficPolicy:\n   connectionPool:\n    http:\n     http2MaxRequests: 50\n</code></pre>"},{"location":"chap8/4Istio_net_control/#3-3","title":"3-3 \u5f02\u5e38\u70b9\u68c0\u6d4b","text":"<p>\u5f02\u5e38\u70b9\u68c0\u6d4b\u662f\u4e00\u4e2a\u65ad\u8def\u5668\u7684\u5b9e\u73b0\uff0c\u5b83\u8ddf\u8e2a\u4e0a\u6e38\u670d\u52a1\u4e2d\u6bcf\u4e2a\u4e3b\u673a\uff08Pod)\u7684\u72b6\u6001\u3002\u5982\u679c\u4e00\u4e2a\u4e3b\u673a\u5f00\u59cb\u8fd4\u56de5xx HTTP\u9519\u8bef\uff0c\u5b83\u5c31\u4f1a\u5728\u9884\u5b9a\u7684\u65f6\u95f4\u5185\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\u3002\u5bf9\u4e8eTCP\u670d\u52a1\uff0cEnvoy\u5c06\u8fde\u63a5\u8d85\u65f6\u6216\u5931\u8d25\u8ba1\u7b97\u4e3a\u9519\u8bef\u3002 </p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5b83\u8bbe\u7f6e\u4e86500\u4e2a\u5e76\u53d1\u7684HTTP2\u8bf7\u6c42\uff08<code>http2MaxRequests</code>\uff09\u7684\u9650\u5236\uff0c\u6bcf\u4e2a\u8fde\u63a5\u4e0d\u8d85\u8fc710\u4e2a\u8bf7\u6c42\uff08<code>maxRequestsPerConnection</code>)\u5230\u8be5\u670d\u52a1\u3002</p> <p>\u6bcf5\u5206\u949f\u626b\u63cf\u4e00\u6b21\u4e0a\u6e38\u4e3b\u673a\uff08Pod) (interval)\uff0c\u5982\u679c\u5176\u4e2d\u4efb\u4f55\u4e00\u4e2a\u4e3b\u673a\u8fde\u7eed\u5931\u8d2510\u6b21 (contracticalErrors),Envoy\u4f1a\u5c06\u5176\u5f39\u51fa10\u5206\u949f\uff08baseEjectionTime)\u3002 </p>"},{"location":"chap8/4Istio_net_control/#3-4-tls","title":"3-4 \u5ba2\u6237\u7aefTLS\u8bbe\u7f6e","text":"<p>\u5305\u542b\u4efb\u4f55\u4e0e\u4e0a\u6e38\u670d\u52a1\u8fde\u63a5\u7684\u4e01LS\u76f8\u5173\u8bbe\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u4f7f\u7528\u63d0\u4f9b\u7684\u8bc1\u4e66\u914d\u7f6emTLS\u7684\u4f8b\u5b50\u3002</p> <pre><code>trafficPolicy:\n  tls:\n   mode: MUTUAL\n   clientCertificate: /etc/certs/cert.pem\n   privateKey: /etc/certs/key.pem\n   caCertificates: /etc/certs/ca.pem\n</code></pre> <ul> <li>\u5176\u4ed6\u652f\u6301\u7684TLS\u6a21\u5f0f\u6709<code>DISABLE</code>\uff08\u6ca1\u6709TLS\u8fde\u63a5\uff09, </li> <li>SIMPLE\uff08\u5728\u4e0a\u6e38\u7aef\u70b9\u53d1\u8d77TLS\u8fde\u63a5,\uff09 </li> <li><code>ISTIO_MUTUAL</code>\uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09</li> </ul>"},{"location":"chap8/4Istio_net_control/#3-5","title":"3-5 \u7aef\u53e3\u6d41\u91cf\u7b56\u7565","text":"<p>\u4f7f\u7528<code>portLevelSettings</code>\u5b57\u6bb5\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u6d41\u91cf\u7b56\u7565\u5e94\u7528\u4e8e\u5355\u4e2a\u7aef\u53e3\u3002\u6bd4\u5982\u8bf4\uff1a </p> <pre><code>trafficPolicy:\n  portLevelSettings:\n  - port:\n    number: 80\n   loadBalancer:\n    simple: LEAST_CONN\n  - port:\n    number: 8000\n   loadBalancer:\n    simple: ROUND_ROBIN\n</code></pre>"},{"location":"chap8/4Istio_net_control/#4","title":"4\u3001\u5f39\u6027","text":"<p>\u5f39\u6027\uff08Resiliency\uff09\u662f\u6307\u5728\u9762\u5bf9\u6545\u969c\u548c\u5bf9\u6b63\u5e38\u8fd0\u884c\u7684\u6311\u6218\u65f6\uff0c\u63d0\u4f9b\u548c\u4fdd\u6301\u53ef\u63a5\u53d7\u7684\u670d\u52a1\u6c34\u5e73\u7684\u80fd\u529b\u3002\u8fd9\u4e0d\u662f\u4e3a\u4e86\u907f\u514d\u6545\u969c\uff0c\u800c\u662f\u4ee5\u4e00\u79cd\u6ca1\u6709\u505c\u673a\u6216\u6570\u636e\u4e22\u5931\u7684\u65b9\u5f0f\u6765\u5e94\u5bf9\u6545\u969c\u3002\u5f39\u6027\u7684\u76ee\u6807 \u662f\u5728\u6545\u969c\u53d1\u751f\u540e\u5c06\u670d\u52a1\u6062\u590d\u5230\u4e00\u4e2a\u5b8c\u5168\u6b63\u5e38\u7684\u72b6\u6001\u3002 </p> <p>Provide and maintain an acceptable level of service in the face of faults and challenges to regular operation. </p> <ul> <li>Timeouts </li> <li>Retry policies </li> <li>Configurable on VirtualService </li> <li>Retries <ul> <li>Number of retries </li> <li>Timeout per try </li> <li>Conditions to retry on </li> </ul> </li> </ul> <p>Note: endpoint that caused the retry is not included in the LB pool on the next try. </p> <p>\u4f7f\u670d\u52a1\u53ef\u7528\u7684\u4e00\u4e2a\u5173\u952e\u56e0\u7d20\u662f\u5728\u63d0\u51fa\u670d\u52a1\u8bf7\u6c42\u65f6\u4f7f\u7528\u8d85\u65f6\uff08timeout\uff09\u548c\u91cd\u8bd5\uff08retry\uff09\u7b56\u7565\u3002 \u6211\u4eec\u53ef\u4ee5\u5728<code>Istio</code>\u7684<code>VirtualService</code>\u4e0a\u914d\u7f6e\u8fd9\u4e24\u8005\u3002 </p> <p>\u4f7f\u7528\u8d85\u65f6\u5b57\u6bb5\u7684\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u4e3aHTTP\u8bf7\u6c42\u5b9a\u4e49\u4e00\u4e2a\u8d85\u65f6\u3002\u5982\u679c\u8bf7\u6c42\u7684\u65f6\u95f4\u8d85\u8fc7\u4e86\u8d85\u65f6\u5b57\u6bb5\u4e2d\u6307\u5b9a\u7684\u503c\uff0cEnvoy\u4ee3\u7406\u5c06\u653e\u5f03\u8bf7\u6c42\uff0c\u5e76\u5c06\u5176\u6807\u8bb0\u4e3a\u8d85\u65f6\uff08\u5411\u5e94\u7528\u7a0b\u5e8f\u8fd4\u56de\u4e00\u4e2aHTTP 408)\u3002</p> <p>\u8fde\u63a5\u4fdd\u6301\u5f00\u653e\uff0c\u9664\u975e\u89e6\u53d1\u4e86\u5f02\u5e38\u70b9\u68c0\u6d4b\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u4e3a\u8def\u7531\u8bbe\u7f6e\u8d85\u65f6\u7684\u4f8b\u5b50\uff1a </p> <pre><code>...\n- route:\n  - destination:\n    host: customers.default.svc.cluster.local\n    subset: v1\n  timeout: 10s\n...\n</code></pre> <p>\u9664\u4e86\u8d85\u65f6\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u914d\u7f6e\u66f4\u7ec6\u5316\u7684\u91cd\u8bd5\u7b56\u7565\u3002\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u4e00\u4e2a\u7ed9\u5b9a\u8bf7\u6c42\u7684\u91cd\u8bd5\u6b21\u6570\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u4ee5\u53ca\u6211\u4eec\u60f3\u8981\u91cd\u8bd5\u7684\u5177\u4f53\u6761\u4ef6\u3002</p> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u53ea\u5728\u4e0a\u6e38\u670d\u52a1\u5668\u8fd4\u56de5xx\u54cd\u5e94\u4ee3\u7801\u65f6\u91cd\u8bd5\u8bf7\u6c42\uff0c\u6216\u8005\u53ea\u5728\u7f51\u5173\u9519\u8bef\uff08HTTP 5O2\u3001 503\u6216504\uff09\u65f6\u91cd\u8bd5\uff0c\u6216\u8005\u751a\u81f3\u5728\u8bf7\u6c42\u5934\u4e2d\u6307\u5b9a\u53ef\u91cd\u8bd5\u7684\u72b6\u6001\u4ee3\u7801\u3002</p> <p>\u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\u3002\u5f53Envoy\u91cd\u8bd5\u4e00\u4e2a\u5931\u8d25\u7684\u8bf7\u6c42\u65f6\uff0c\u6700\u521d\u5931\u8d25\u5e76\u5bfc\u81f4\u91cd\u8bd5\u7684\u7aef\u70b9\u5c31\u4e0d\u518d\u5305\u542b\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u4e86\u3002\u5047\u8bbeKubernetes\u670d\u52a1\u67093\u4e2a\u7aef\u70b9\uff08Pod)\uff0c\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u4e86\uff0c \u5e76\u51fa\u73b0\u4e86\u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u4ee3\u7801\u3002</p> <p>\u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u5b83\u4e0d\u4f1a\u518d\u5411\u539f\u6765\u7684\u7aef\u70b9\u91cd\u65b0\u53d1\u9001\u8bf7\u6c42\u3002\u76f8\u53cd\uff0c\u5b83\u5c06\u628a\u8bf7\u6c42\u53d1 \u9001\u5230\u4e24\u4e2a\u6ca1\u6709\u5931\u8d25\u7684\u7aef\u70b9\u4e2d\u7684\u4e00\u4e2a\u3002 </p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff0c\u8bf4\u660e\u5982\u4f55\u4e3a\u4e00\u4e2a\u7279\u5b9a\u7684\u76ee\u7684\u5730\u8bbe\u7f6e\u91cd\u8bd5\u7b56\u7565\u3002 </p> <pre><code>...\n- route:\n  - destination:\n    host: customers.default.svc.cluster.local\n    subset: v1\n  retries:\n   attempts: 10\n   perTryTimeout: 2s\n   retryOn: connect-failure,reset\n...\n</code></pre> <p>\u4e0a\u8ff0\u91cd\u8bd5\u7b56\u7565\u5c06\u5c1d\u8bd5\u91cd\u8bd5\u4efb\u4f55\u8fde\u63a5\u8d85\u65f6\uff08connect-failure)\u6216\u670d\u52a1\u5668\u5b8c\u5168\u4e0d\u54cd\u5e94 (reset)\u7684\u5931\u8d25\u8bf7\u6c42\u3002\u6211\u4eec\u5c06\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a2\u79d2\uff0c\u5c1d\u8bd5\u7684\u6b21\u6570\u8bbe\u7f6e\u4e3a10\u6b21\u3002</p> <p>\u6ce8\u610f\uff0c\u5982\u679c\u540c\u65f6\u8bbe\u7f6e\u91cd\u8bd5\u548c\u8d85\u65f6\uff0c\u8d85\u65f6\u503c\u5c06\u662f\u8bf7\u6c42\u7b49\u5f85\u7684\u6700\u957f\u65f6\u95f4\u3002\u5982\u679c\u6211\u4eec\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\u6307\u5b9a\u4e8610\u79d2\u7684\u8d85\u65f6\uff0c\u90a3\u4e48\u5373\u4f7f\u91cd\u8bd5\u7b56\u7565\u4e2d\u8fd8\u5269\u4e0b\u4e00\u4e9b\u5c1d\u8bd5\uff0c\u6211\u4eec\u4e5f\u53ea\u80fd\u6700\u591a\u7b49\u5f8510\u79d2\u3002 </p> <p>\u53c2\u9605  x-envoy-retry </p>"},{"location":"chap8/4Istio_net_control/#5","title":"5\u3001\u6545\u969c\u6ce8\u5165","text":"<p>\u4e3a\u4e86\u5e2e\u52a9\u6211\u4eec\u63d0\u9ad8\u670d\u52a1\u7684\u5f39\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u6545\u969c\u6ce8\u5165\u529f\u80fd\u3002\u6211\u4eec\u53ef\u4ee5\u5728HTTP\u6d41\u91cf\u4e0a\u5e94\u7528\u6545\u969c\u6ce8\u5165\u7b56\u7565\uff0c\u5728\u8f6c\u53d1\u76ee\u7684\u5730\u7684\u8bf7\u6c42\u65f6\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u6545\u969c\u6ce8\u5165\u3002</p> <p>\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u6545\u969c\u6ce8\u5165\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u8f6c\u53d1\u524d\u5ef6\u8fdf\uff08delay\uff09\u8bf7\u6c42\uff0c\u6a21\u62df\u7f13\u6162\u7684\u7f51\u7edc\u6216\u8fc7\u8f7d\u7684\u670d\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u4e2d\u6b62\uff08abort) HTTP\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u7279\u5b9a\u7684HTTP\u9519\u8bef\u4ee3\u7801\u7ed9\u8c03\u7528\u8005\u3002</p> <p>\u901a\u8fc7\u4e2d\u6b62\uff0c\u6211\u4eec\u53ef\u4ee5\u6a21\u62df\u4e00\u4e2a\u6709\u6545\u969c\u7684\u4e0a\u6e38\u670d\u52a1\u3002 </p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u4e2d\u6b62HTTP\u8bf7\u6c42\u5e76\u8fd4\u56de<code>HTTP 404</code>\u7684\u4f8b\u5b50\uff0c\u9488\u5bf930\uff05\u7684\u4f20\u5165\u8bf7\u6c42\u3002</p> <pre><code>- route:\n  - destination:\n    host: customers.default.svc.cluster.local\n    subset: v1\n  fault:\n   abort:\n    percentage:\n     value: 30\n    httpStatus: 404\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u4e0d\u6307\u5b9a\u767e\u5206\u6bd4\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u4e2d\u6b62\u3002\u8bf7\u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u4f1a\u5f71\u54cd\u4f7f\u7528\u8be5 VirtualService\u7684\u670d\u52a1\u3002\u5b83\u5e76\u4e0d\u5f71\u54cd\u8be5\u670d\u52a1\u7684\u6240\u6709\u6d88\u8d39\u8005\u3002 </p> <p>\u540c\u6837\u5730\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>fixedDelay</code>\u5b57\u6bb5\u5bf9\u8bf7\u6c42\u5e94\u7528\u4e00\u4e2a\u53ef\u9009\u7684\u5ef6\u8fdf\u3002 </p> <pre><code>- route:\n  - destination:\n    host: customers.default.svc.cluster.local\n    subset: v1\n  fault:\n   delay:\n    percentage:\n     value: 5\n    fixedDelay: 3s\n</code></pre> <p>\u4e0a\u8ff0\u8bbe\u7f6e\u5c06\u5bf9<code>5\uff05</code>\u7684\u4f20\u5165\u8bf7\u6c42\u5e94\u75283\u79d2\u7684\u5ef6\u8fdf\u3002 </p> <p>\u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u5c06\u4e0d\u4f1a\u89e6\u53d1\u6211\u4eec\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u6ce8\u5165\u4e86\u4e00\u4e2aHTTP 500\u7684\u9519\u8bef\uff0c\u914d\u7f6e\u4e3aHTTP 500\u4e0a\u7684\u91cd\u8bd5\u7b56\u7565\u5c06\u4e0d\u4f1a\u88ab\u89e6\u53d1\u3002 </p>"},{"location":"chap8/4Istio_net_control/#6","title":"6\u3001\u9ad8\u7ea7\u8def\u7531","text":"<p>\u5728\u524d\u9762\uff0c\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u5229\u7528\u6d41\u91cf\u7684\u6bd4\u4f8b\uff08weight\u5b57\u6bb5\uff09\u5728\u591a\u4e2a\u5b50\u96c6\u4e4b\u95f4\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u7eaf\u7cb9\u7684\u57fa\u4e8e\u6743\u91cd\u7684\u6d41\u91cf\u8def\u7531\u6216\u5206\u5272\u5df2\u7ecf\u8db3\u591f\u4e86\u3002\u7136\u800c\uff0c\u5728\u6709\u4e9b\u573a\u666f\u548c\u60c5\u51b5\u4e0b\uff0c\u6211 \u4eec\u53ef\u80fd\u9700\u8981\u5bf9\u6d41\u91cf\u5982\u4f55\u88ab\u5206\u5272\u548c\u8f6c\u53d1\u5230\u76ee\u6807\u670d\u52a1\u8fdb\u884c\u66f4\u7ec6\u5316\u7684\u63a7\u5236\u3002 </p> <p>Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528\u4f20\u5165\u8bf7\u6c42\u7684\u4e00\u90e8\u5206\uff0c\u5e76\u5c06\u5176\u4e0e\u5b9a\u4e49\u7684\u503c\u76f8\u5339\u914d\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u5339\u914d\u4f20\u5165\u8bf7\u6c42\u7684URI\u524d\u7f00\uff0c\u5e76\u57fa\u4e8e\u6b64\u8def\u7531\u6d41\u91cf\u3002 </p> <p> </p> <p> </p> <p>\u4e0a\u8ff0\u6bcf\u4e2a\u5c5e\u6027\u90fd\u53ef\u4ee5\u7528\u8fd9\u4e9b\u65b9\u6cd5\u4e2d\u7684\u4e00\u79cd\u8fdb\u884c\u5339\u914d </p> <ul> <li>\u7cbe\u786e\u5339\u914d\uff1a\u4f8b\u5982\uff0c<code>exact: \"value\"</code>\u5339\u914d\u7cbe\u786e\u7684\u5b57\u7b26\u4e32 </li> <li>\u524d\u7f00\u5339\u914d\uff1a\u4f8b\u5982\uff0c<code>prefix: \"value\"</code>\u53ea\u5339\u914d\u524d\u7f00 </li> <li>\u6b63\u5219\u5339\u914d: \u4f8b\u5982\uff0c<code>regex: \"value\"</code>\u6839\u636e<code>ECMAscript</code>\u98ce\u683c\u7684\u6b63\u5219\u8fdb\u884c\u5339\u914d  </li> </ul> <p>\u4f8b\u5982\uff0c\u5047\u8bbe\u8bf7\u6c42\u7684URI\u770b\u8d77\u6765\u50cf\u8fd9\u6837 <code>https://dev.example.com/v1/api</code>\u4e3a\u4e86\u5339\u914d\u8be5\u8bf7\u6c42\u7684URI\uff0c\u6211\u4eec\u4f1a\u8fd9\u6837\u5199\uff1a  </p> <pre><code>http:\n- match:\n  - uri:\n    prefix: /v1\n</code></pre> <p>\u4e0a\u8ff0\u7247\u6bb5\u5c06\u5339\u914d\u4f20\u5165\u7684\u8bf7\u6c42\uff0c\u5e76\u4e14\u8bf7\u6c42\u5c06\u88ab\u8def\u7531\u5230\u8be5\u8def\u7531\u4e2d\u5b9a\u4e49\u7684\u76ee\u7684\u5730\u3002 </p> <p>\u53e6\u4e00\u4e2a\u4f8b\u5b50\u662f\u4f7f\u7528\u6b63\u5219\u5e76\u5728\u5934\u4e0a\u8fdb\u884c\u5339\u914d\u3002</p> <pre><code> http:\n - match:\n   - headers:\n       user-agent:\n         regex: '.*Firefox.*'\n</code></pre> <p>\u4e0a\u8ff0\u5339\u914d\u5c06\u5339\u914d\u4efb\u4f55\u7528\u6237\u4ee3\u7406\u5934\u4e0eRegex\u5339\u914d\u7684\u8bf7\u6c42\u3002 </p>"},{"location":"chap8/4Istio_net_control/#6-1","title":"6-1 \u91cd\u5b9a\u5411\u548c\u91cd\u5199\u8bf7\u6c42","text":"<p>\u5728\u5934\u4fe1\u606f\u548c\u5176\u4ed6\u8bf7\u6c42\u5c5e\u6027\u4e0a\u8fdb\u884c\u5339\u914d\u662f\u6709\u7528\u7684\uff0c\u4f46\u6709\u65f6\u6211\u4eec\u53ef\u80fd\u9700\u8981\u901a\u8fc7\u8bf7\u6c42URI\u4e2d\u7684\u503c\u6765\u5339\u914d\u8bf7\u6c42\u3002</p> <ul> <li>\u4f8b\u5982\uff0c\u8ba9\u6211\u4eec\u8003\u8651\u8fd9\u6837\u4e00\u79cd\u60c5\u51b5\uff1a\u4f20\u5165\u7684\u8bf7\u6c42\u4f7f\u7528<code>/v1/api</code>\u8def\u5f84\uff0c\u800c\u6211\u4eec\u60f3\u628a\u8bf7\u6c42\u8def\u7531\u5230 <code>/v2/api</code>\u7acb\u6e4d\u70b9\u3002 </li> <li>\u8fd9\u6837\u505a\u7684\u65b9\u6cd5\u662f\u91cd\u5199\u6240\u6709\u4f20\u5165\u7684\u8bf7\u6c42\u548c\u4e0e<code>/v1/api</code>\u5339\u914d\u7684<code>authority/host headers</code>\u5230 <code>/v2/api</code>\u3002 </li> </ul> <p>\u4f8b\u5982\uff1a </p> <pre><code>...\nhttp:\n  - match:\n   - headers:\n     my-header:\n      exact: hello\n   redirect:\n    uri: /hello\n    authority: my-service.default.svc.cluster.local:8000\n...\n</code></pre> <p><code>redirect</code>\u548c<code>destination</code>\u5b57\u6bb5\u662f\u76f8\u4e92\u6392\u65a5\u7684\u3002\u5982\u679c\u6211\u4eec\u4f7f\u7528redirect\uff0c\u5c31\u4e0d\u9700\u8981\u8bbe\u7f6e<code>destination</code>\u3002 </p>"},{"location":"chap8/4Istio_net_control/#6-2-and-or","title":"6-2 AND \u548c OR\u8bed\u4e49","text":"<p>\u5728\u8fdb\u884c\u5339\u914d\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528AND\u548cOR\u4e24\u79cd\u8bed\u4e49\u3002\u8ba9\u6211\u4eec\u770b\u4e00\u4e0b\u4e0b\u9762\u7684\u7247\u6bb5\uff1a </p> <p>AND</p> <pre><code>...\nhttp:\n  - match:\n   - uri:\n     prefix: /v1\n    headers:\n     my-header:\n      exact: hello\n...\n</code></pre> <p>\u4e0a\u9762\u7684\u7247\u6bb5\u4f7f\u7528\u7684\u662fAND\u8bed\u4e49\u3002\u8fd9\u610f\u6627\u7740URI\u524d\u7f00\u9700\u8981\u4e0e<code>/v1</code>\u76f8\u5339\u914d\uff0c\u5e76\u4e14\u5934\u4fe1\u606f<code>my-header</code>\u6709\u4e00\u4e2a\u786e\u5207\u7684\u503chello</p> <p>OR</p> <p>\u8981\u4f7f\u7528OR\u8bed\u4e49\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u53e6\u4e00\u4e2a<code>match</code>\u9879\uff0c\u50cf\u8fd9\u6837\uff1a</p> <pre><code>...\nhttp:\n  - match:\n   - uri:\n     prefix: /v1\n   ...\n  - match:\n   - headers:\n     my-header:\n      exact: hello\n...\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5c06\u9996\u5148\u5bf9URI\u524d\u7f00\u8fdb\u884c\u5339\u914d\uff0c\u5982\u679c\u5339\u914d\uff0c\u8bf7\u6c42\u5c06\u88ab\u8def\u7531\u5230\u76ee\u7684\u5730\u3002 \u5982\u679c\u7b2c\u4e00 \u4e2a\u4e0d\u5339\u914d\uff0c\u7b97\u6cd5\u4f1a\u8f6c\u79fb\u5230\u7b2c\u4e8c\u4e2a\uff0c\u5e76\u5c1d\u8bd5\u5339\u914d\u5934\u3002 </p> <p>\u5982\u679c\u6211\u4eec\u7701\u7565\u8def\u7531\u4e0a\u7684\u5339\u914d\u5b57\u6bb5, \u5b83\u5c06\u603b\u662f\u8bc4\u4f30\u4e3atrue</p>"},{"location":"chap8/4Istio_net_control/#7serviceentry","title":"7\u3001ServiceEntry","text":"<p>\u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002 </p> <p>\u5f53\u4e00\u4e2a\u670d\u52a1\u5728\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u65f6\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u6d41\u91cf\u8def\u7531\u3001\u6545\u969c\u6ce8\u5165\u548c\u5176\u4ed6\u7f51\u683c\u529f\u80fd\uff0c\u5c31\u50cf\u6211\u4eec\u5bf9\u5176\u4ed6\u670d\u52a1\u4e00\u6837\u3002</p>"},{"location":"chap8/4Istio_net_control/#7-1-serviceentry-resource","title":"7-1 ServiceEntry Resource","text":"<ul> <li>Add entries to Istio's service registry </li> <li>Use traffic routing, failure injection, and other features against external services </li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a<code>ServiceEntry</code>\u8d44\u6e90\u7684\u4f8b\u5b50\uff0c\u5b83\u58f0\u660e\u4e86\u4e00\u4e2a\u53ef\u4ee5\u901a\u8fc7HTTPS\u8bbf\u95ee\u7684\u5916\u90e8API  (<code>api.external-svc.com</code>)\u3002 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: external-svc\nspec:\n  hosts:\n   - api.external-svc.com\n  ports:\n   - number: 443\n    name: https\n    protocol: TLS\n  resolution: DNS\n  location: MESH_EXTERNAL\n</code></pre> <p><code>hosts</code>\u5b57\u6bb5\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u5916\u90e8API\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cEnvoy sidecar\u4f1a\u6839\u636e\u4e0b\u9762\u7684\u5c42\u6b21\u7ed3\u6784\u6765\u8fdb\u884c\u68c0\u67e5\u3002\u5982\u679c\u4efb\u4f55\u4e00\u9879\u4e0d\u80fd\u88ab\u68c0\u67e5\uff0cEnvoy\u5c31\u4f1a\u8f6c\u5230\u5c42\u6b21\u7ed3\u6784\u4e2d\u7684\u4e0b\u4e00\u9879\u3002</p> <ul> <li>HTTP Authority\u5934\uff08\u5728HTTP/2\u4e2d\uff09\u548cHost\u5934\uff08HTTP/1.1\u4e2d\uff09 </li> <li>SNI</li> <li>IP\u5730\u5740\u548c\u7aef\u53e3 </li> </ul> <p>\u5982\u679c\u4e0a\u8ff0\u6570\u503c\u90fd\u65e0\u6cd5\u68c0\u67e5\uff0cEnvoy\u4f1a\u6839\u636eIstio\u7684\u5b89\u88c5\u914d\u7f6e\uff0c\u76f2\u76ee\u5730\u8f6c\u53d1\u8bf7\u6c42\u6216\u653e\u5f03\u8be5\u8bf7\u6c42\u3002 </p>"},{"location":"chap8/4Istio_net_control/#7-2-workloadentry","title":"7-2 WorkloadEntry","text":"<ul> <li>Handle migration of VM workloads to Kubernetes </li> <li>Specify VM workloads and make them part of Istio's service registry </li> </ul> <p>\u4e0eWorkloadEntry\u8d44\u6e90\u4e00\u8d77\uff0c\u6211\u4eec\u53ef\u4ee5\u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5411Kubernetes\u8fc1\u79fb\u7684\u95ee\u9898\u3002</p> <p>\u5728Workload Entry\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ec6\u8282\uff08\u540d\u79f0\u3001\u5730\u5740\u3001\u6807\u7b7e\uff09\uff0c\u7136\u540e\u4f7f\u7528ServiceEntry\u4e2d\u7684<code>workloadSelector</code>\u5b57\u6bb5\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3a<code>Istio</code>\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206\u3002 </p> <p>\u4f8b\u5982\uff0c\u5047\u8bbecustomers\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6b63\u5728\u4e24\u4e2a\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u3002\u6b64\u5916\uff0c\u6211\u4eec\u5df2\u7ecf\u6709\u5728Kuternetes\u4e2d\u8fd0\u884c\u7684Pod\uff0c\u5176\u6807\u7b7e\u4e3a<code>app: customers</code></p> <p>**\u8ba9\u6211\u4eec\u8fd9\u6837\u6765\u5b9a\u4e49WorkloadEntry\u8d44\u6e90\uff1a **</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: WorkloadEntry\nmetadata:\n  name: customers-vm-1\nspec:\n  serviceAccount: customers\n  address: 1.0.0.0\n  labels:\n   app: customers\n   instance-id: vm1\n---\napiVersion: networking.istio.io/v1alpha3\nkind: WorkloadEntry\nmetadata:\n  name: customers-vm-2\nspec:\n  serviceAccount: customers\n  address: 2.0.0.0\n  labels:\n   app: customers\n   instance-id: vm2\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a<code>ServiceEntry</code>\u8d44\u6e90\uff0c\u8be5\u8d44\u6e90\u540c\u65f6\u8de8\u8d8aKubernetes\u4e2d\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u548c\u865a\u62df\u673a\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: customers-svc\nspec:\n  hosts:\n  - customers.com\n  location: MESH_INTERNAL\n  ports:\n  - number: 80\n   name: http\n   protocol: HTTP\n  resolution: STATIC\n  workloadSelector:\n   labels:\n    app: customers\n</code></pre> <p>\u5728location\u5b57\u6bb5\u4e2d\u8bbe\u7f6e<code>MESH_INTERNAL</code>\uff0c\u8fd9\u662f\u8bf4\u8fd9\u4e2a\u670d\u52a1\u662f\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002\u8fd9\u4e2a\u503c\u901a\u5e38\u7528\u4e8e\u5305\u62ec\u672a\u7ba1\u7406\u7684\u57fa\u7840\u8bbe\u65bd\uff08VM\uff09\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u60c5\u51b5\u3002</p> <ul> <li>\u8fd9\u4e2a\u5b57\u6bb5\u7684\u53e6\u4e00\u4e2a\u503c\uff0c <code>MESH_EXTERNAL</code>\uff0c\u7528\u4e8e\u901a\u8fc7API\u6d88\u8d39\u7684\u5916\u90e8\u670d\u52a1\u3002</li> <li><code>MESH_EXTERNAL</code>\u548c<code>MESH_EXTERNAL</code> \u8bbe\u7f6e\u63a7\u5236\u4e86\u7f51\u683c\u4e2d\u7684sidecar\u5982\u4f55\u5c1d\u8bd5\u4e0e\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u901a\u4fe1\uff0c\u5305\u62ec\u5b83\u4eec\u662f\u5426\u4f1a\u9ed8\u8ba4\u4f7f\u7528Istio\u53cc\u5411TLS\u3002 </li> </ul>"},{"location":"chap8/4Istio_net_control/#8sidecar","title":"8\u3001Sidecar","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6ce8\u5165\u7684sidecar\u4ee3\u7406\u63a5\u6536\u6240\u6709\u7aef\u53e3\u7684\u6d41\u91cf\uff0c\u5e76\u4e14\u5728\u8f6c\u53d1\u6d41\u91cf\u65f6\u53ef\u4ee5\u5230\u8fbe\u7f51\u683c\u4e2d\u7684\u4efb\u4f55\u670d\u52a1\u3002 </p> <p>\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u80fd\u60f3\u6539\u53d8\u8fd9\u79cd\u914d\u7f6e\uff0c\u914d\u7f6e\u4ee3\u7406\uff0c\u6240\u4ee5\u5b83\u53ea\u80fd\u4f7f\u7528\u7279\u5b9a\u7684\u7aef\u53e3\u548c\u8bbf\u95ee\u67d0\u4e9b\u670d\u8d44\u6e90\u3002 \u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u4f60\u53ef\u4ee5\u5728Istio\u4e2d\u4f7f\u7528Sidecar\u8d44\u6e90 </p> <p>Sidecar\u8d44\u6e90\u53ef\u4ee5\u88ab\u90e8\u7f72\u5230Kubernetes\u96c6\u7fa4\u5185\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u4f46\u5982\u679c\u6ca1\u6709\u5b9a\u4e49\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\uff0c\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u53ea\u80fd\u6709\u4e00\u4e2asidecar\u8d44\u6e90\u3002 </p> <p>Sidecar\u8d44\u6e90\u7531\u4e09\u90e8\u5206\u7ec4\u6210\uff0c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u3001\u4e00\u4e2a\u5165\u53e3\uff08ingress)\u76d1\u542c\u5668\u548c\u4e00\u4e2a\u51fa\u53e3  (egress)\u76d1\u542c\u5668\u3002</p> <p>Sidecar Resource </p> <ul> <li>Proxies accept traffic on all ports </li> <li>Configure Sidecar to specific ports/services </li> <li>Three parts: <ul> <li>Workload selector </li> <li>Ingress listener </li> <li>Egress listener </li> </ul> </li> </ul>"},{"location":"chap8/4Istio_net_control/#8-1","title":"8-1 \u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668","text":"<p>\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u51b3\u5b9a\u4e86\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u4f1a\u53d7\u5230sidecar\u914d\u7f6e\u7684\u5f71\u54cd\u3002</p> <p>\u4f60\u53ef\u4ee5\u51b3\u5b9a\u63a7\u5236\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709sidecar\uff0c\u800c\u4e0d\u8003\u8651\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6216\u8005\u63d0\u4f9b\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\uff0c\u5c06\u914d\u7f6e\u53ea\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 </p> <p>\u4f8b\u5982\uff0c\u8fd9\u4e2aYAML\u9002\u7528\u4e8e\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u5185\u7684\u6240\u6709\u4ee3\u7406\uff0c\u56e0\u4e3a\u6ca1\u6709\u5b9a\u4e49\u9009\u62e9\u5668\u3002 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Sidecar\nmetadata:\n  name: default-sidecar\n  namespace: default\nspec:\n  egress:\n  - hosts:\n   - \"default/*\"\n   - \"istio-system/*\"\n   - \"staging/*\"\n</code></pre> <p>\u5728egress\u90e8\u5206\uff0c\u6211\u4eec\u6307\u5b9a\u4ee3\u7406\u53ef\u4ee5\u8bbf\u95ee\u8fd0\u884c\u5728<code>default</code>\u3001<code>istio-system</code>\u548c<code>Staging</code>\u547d\u540d\u7a7a\u95f4\u7684\u670d\u52a1\u3002</p> <p>\u8981\u5c06\u8d44\u6e90\u4ec5\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>workloadSelector</code>\u5b57\u6bb5\u3002 \u4f8b\u5982\uff0c\u5c06\u9009\u62e9\u5668\u8bbe\u7f6e\u4e3a<code>version:v1</code>\u5c06\u53ea\u9002\u7528\u4e8e\u6709\u8be5\u6807\u7b7e\u8bbe\u7f6e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Sidecar\nmetadata:\n  name: default-sidecar\n  namespace: default\nspec:\n  workloadSelector:\n   labels:\n    version: v1\n  egress:\n  - hosts:\n   - \"default/*\"\n   - \"istio-system/*\"\n   - \"staging/*\"\n</code></pre>"},{"location":"chap8/4Istio_net_control/#8-2","title":"8-2 \u5165\u53e3\u548c\u51fa\u53e3\u76d1\u542c\u5668","text":"<p>\u8d44\u6e90\u7684\u5165\u53e3\uff08ingress)\u76d1\u542c\u5668\u90e8\u5206\u5b9a\u4e49\u4e86\u54ea\u4e9b\u5165\u7ad9\u6d41\u91cf\u88ab\u63a5\u53d7\u3002\u540c\u6837\u5730\uff0c\u901a\u8fc7\u51fa\u53e3  (egress)\u76d1\u542c\u5668\uff0c\u4f60\u53ef\u4ee5\u5b9a\u4e49\u51fa\u7ad9\u6d41\u91cf\u7684\u5c5e\u6027\u3002</p> <p>\u6bcf\u4e2a\u5165\u53e3\u76d1\u542c\u5668\u90fd\u9700\u8981\u4e00\u4e2a\u7aef\u53e3\u8bbe\u7f6e\uff0c\u4ee5\u4fbf\u63a5\u6536\u6d41\u91cf\uff08\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\u76843000)\u548c\u4e00\u4e2a\u9ed8\u8ba4\u7684\u7aef\u70b9\u3002\u9ed8\u8ba4\u7aef\u70b9\u53ef\u4ee5\u662f\u4e00\u4e2a\u56de\u73afIP\u7aef\u70b9\u6216Unix\u57df\u5957\u63a5\u5b57\u3002\u7aef\u70b9\u914d\u7f6e\u4e86\u6d41\u91cf\u5c06\u88ab\u8f6c\u53d1\u5230\u54ea\u91cc\u3002 </p> <pre><code>...\n  ingress:\n  - port:\n    number: 3000\n    protocol: HTTP\n    name: somename\n   defaultEndpoint: 127.0.0.1:8080\n...\n</code></pre> <p>\u4e0a\u9762\u7684\u7247\u6bb5\u5c06\u5165\u53e3\u76d1\u542c\u5668\u914d\u7f6e\u4e3a\u5728\u7aef\u53e33000\u4e0a\u76d1\u542c\uff0c\u5e76\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u670d\u52a1\u76d1\u542c\u7684\u7aef\u53e38080\u4e0a\u7684\u56de\u73afIP\u3002</p> <p>\u6b64\u5916\uff0c\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6ebind\u5b57\u6bb5\uff0c\u4ee5\u6307\u5b9a\u4e00\u4e2aIP\u5730\u5740\u6216\u57df\u5957\u63a5\u5b57\uff0c\u6211\u4eec\u5e0c\u671b\u4ee3\u7406\u76d1\u542c\u4f20\u5165\u7684\u6d41\u91cf\u3002\u6700\u540e\uff0c\u5b57\u6bb5<code>captureMode</code>\u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u5982\u4f55\u4ee5\u53ca\u662f\u5426\u6355\u83b7\u6d41\u91cf\u3002</p> <p>\u51fa\u53e3\u76d1\u542c\u5668\u6709\u7c7b\u4f3c\u7684\u5b57\u6bb5\uff0c\u4f46\u589e\u52a0\u4e86<code>hosts</code>\u5b57\u6bb5\u3002\u901a\u8fc7<code>hosts</code>\u5b57\u6bb5,  \u4f60\u53ef\u4ee5\u7528<code>default</code>\u6216  <code>namespace/dnsName</code> \u7684\u683c\u5f0f\u6307\u5b9a\u670d\u52a1\u4e3b\u673a\u3002\u4f8b\u5982 <code>myservice.default</code>\u6216<code>default/*</code>\u3002</p> <p>\u5728<code>hosts</code>\u5b57\u6bb5\u4e2d\u6307\u5b9a\u7684\u670d\u52a1\u53ef\u4ee5\u662f\u6765\u81ea\u7f51\u683c\u6ce8\u518c\u8868\u7684\u5b9e\u9645\u670d\u52a1\u3001\u5916\u90e8\u670d\u52a1\uff08\u7528<code>ServiceEntry</code>\u5b9a\u4e49\uff09,  \u6216\u865a\u62df\u670d\u52a1\u3002</p> <pre><code>  egress:\n  - port:\n        number: 8080\n        protocol: HTTP\n    hosts:\n   - \"staging/*\"\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u7684 YAML\uff0csidecar \u4ee3\u7406\u4e86\u8fd0\u884c\u5728\u547d\u540d\u7a7a\u95f4\u7684\u670d\u52a1\u7684 8080 \u7aef\u53e3\u7684\u6d41\u91cf\u3002</p>"},{"location":"chap8/4Istio_net_control/#9envoy-filter","title":"9\u3001Envoy Filter","text":"<p>EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531<code>Istio Pilot</code>\u751f\u6210\u7684Envoy\u914d\u7f6e\u3002\u4f7f\u7528\u8be5\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u66f4\u65b0\u6570\u503c\uff0c\u6dfb\u52a0\u7279\u5b9a\u7684\u8fc7\u6ee4\u5668\uff0c\u751a\u81f3\u6dfb\u52a0\u65b0\u7684\u76d1\u542c\u5668\u3001\u96c6\u7fa4\u7b49\u7b49\u3002\u5c0f\u5fc3\u4f7f\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u56e0\u4e3a\u4e0d\u6b63\u786e\u7684 \u5b9a\u5236\u53ef\u80fd\u4f1a\u7834\u574f\u6574\u4e2a\u7f51\u683c\u7684\u7a33\u5b9a\u6027\u3002 </p> <p>\u8fc7\u6ee4\u5668\u662f\u53e0\u52a0\u5e94\u7528\u7684\uff0c\u8fd9\u610f\u6627\u7740\u5bf9\u4e8e\u7279\u5b9a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u7279\u5b9a\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u53ef\u4ee5\u6709\u4efb\u4f55\u6570\u91cf\u7684\u8fc7\u6ee4\u5668\u3002</p> <p>\u6839\u547d\u540d\u7a7a\u95f4\uff08\u4f8b\u5982<code>istio-system</code>)\u4e2d\u7684\u8fc7\u6ee4\u5668\u9996\u5148\u88ab\u5e94\u7528\uff0c\u7136\u540e\u662f\u5de5\u4f5c\u8d1f\u8f7d\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u5339\u914d\u8fc7\u6ee4\u5668\u3002</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a<code>EnvoyFilter</code>\u7684\u4f8b\u5b50\uff0c\u5b83\u5728\u8bf7\u6c42\u4e2d\u6dfb\u52a0\u4e86\u4e00\u4e2a\u540d\u4e3a<code>api-version</code>\u7684\u5934\u3002 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  name: api-header-filter\n  namespace: default\nspec:\n  workloadSelector:\n   labels:\n    app: web-frontend\n  configPatches:\n  - applyTo: HTTP_FILTER\n   match:\n    context: SIDECAR_INBOUND\n    listener:\n     portNumber: 8080\n     filterChain:\n      filter:\n       name: \"envoy.http_connection_manager\"\n       subFilter:\n        name: \"envoy.router\"\n   patch:\n    operation: INSERT_BEFORE\n    value:\n     name: envoy.lua\n     typed_config:\n      \"@type\": \"type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua\"\n      inlineCode: |\n       function envoy_on_response(response_handle)\n        response_handle:headers():add(\"api-version\", \"v1\")\n       end\n</code></pre> <p>\u5982\u679c\u4f60\u5411<code>\uff04GATEWAY_URL</code>\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f60\u53ef\u4ee5\u6ce8\u610f\u5230<code>api-version</code>\u5934\u88ab\u6dfb\u52a0\u4e86\uff0c\u5982\u4e0b\u6240 </p> <pre><code>$ curl -s -I -X HEAD  http://$GATEWAY_URL\nHTTP/1.1 200 OK\nx-powered-by: Express\ncontent-type: text/html; charset=utf-8\ncontent-length: 2471\netag: W/\"9a7-hEXE7lJW5CDgD+e2FypGgChcgho\"\ndate: Tue, 17 Nov 2020 00:40:16 GMT\nx-envoy-upstream-service-time: 32\napi-version: v1\nserver: istio-envoy\n</code></pre>"},{"location":"chap8/5Istio_net_control_exp/","title":"\u7b2c\u4e94\u8282 \u6d41\u91cf\u7ba1\u7406\u5b9e\u9a8c\u4e0e\u6d4b\u8bd5","text":""},{"location":"chap8/5Istio_net_control_exp/#1","title":"1\u3001\u521b\u5efa\u90e8\u7f72\u5e76\u4f7f\u7528\u7f51\u5173\u66b4\u9732","text":"<p>\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e00\u4e2aHello World\u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>\u7136\u540e\u6211\u4eec\u5c06\u90e8\u7f72\u4e00\u4e2a Gateway\u8d44\u6e90\u548c\u4e00\u4e2a\u4e0eGateway\u7ed1\u5b9a\u7684VirtualService\uff0c\u4ee5\u4fbf\u5728\u5916\u90e8IP\u5730\u5740\u4e0a\u516c\u5f00\u8be5\u5e94\u7528\u7a0b\u5e8f\u3002 </p> <p>\u8ba9\u6211\u4eec\u5148\u4ece\u90e8\u7f72Gateway\u8d44\u6e90\u5f00\u59cb\u3002\u6211\u4eec\u5c06\u628a<code>hosts</code>\u5b57\u6bb5\u8bbe\u7f6e\u4e3a<code>\uff0a</code>\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4ece\u5916\u90e8IP\u5730\u5740\u8bbf\u95ee\u5165\u53e3\u7f51\u5173\u3002\u5982\u679c\u6211\u4eec\u60f3\u901a\u8fc7\u57df\u540d\u8bbf\u95ee\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06<code>hosts</code>\u7684\u503c\u8bbe\u7f6e\u4e3a\u57df\u540d\uff08\u4f8b\u5982<code>example.com</code>)\uff0c\u7136\u540e\u5c06\u5916\u90e8IP\u5730\u5740\u6dfb\u52a0\u5230\u8be5\u57df\u540d\u7684A\u8bb0\u5f55\u4e2d\u3002 </p> <p><code>gateway.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n        - '*'\n</code></pre> <pre><code>$ kubectl apply -f gateway-210119-085144.yaml \ngateway.networking.istio.io/gateway created\n</code></pre> <p>\u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a<code>gateway.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectl apply -f gateway.yaml</code> \u90e8\u7f72\u8be5\u7f51\u5173\u3002</p> <p>\u5982\u679c\u6211\u4eec\u8bd5\u56fe\u8bbf\u95ee\u5165\u53e3\u7f51\u5173\u7684\u5916\u90e8IP\u5730\u5740\uff0c\u6211\u4eec\u5c06\u5f97\u5230\u4e00\u4e2a<code>HTTP 404</code>\uff0c\u56e0\u4e3a\u6ca1\u6709\u4efb\u4f55\u7ed1\u5b9a\u5230\u7f51\u5173\u7684<code>VirtualService</code>\u3002\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u8def\u7531\uff0c\u6240\u4ee5\u5165\u53e3\u4ee3\u7406\u4e0d\u77e5\u9053\u8981\u628a\u6d41\u91cf\u8def\u7531\u5230\u54ea\u91cc\u3002 </p> <p>\u8981\u83b7\u5f97\u5165\u53e3\u7f51\u5173\u7684\u5916\u90e8iP\u5730\u5740\uff0c\u8bf7\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5e76\u67e5\u770b<code>EXTERNAL-IP</code>\u5217\u7684\u503c\uff1a </p> <pre><code>$ kubectl get svc -l=istio=ingressgateway -n istio-system\nNAME                   TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE\nistio-ingressgateway   LoadBalancer   10.105.159.70   localhost     15021:31875/TCP,80:32344/TCP,443:31252/TCP,31400:31315/TCP,15443:31199/TCP   7d5h\n</code></pre> <p>\u5728\u6574\u4e2a\u8bfe\u7a0b\u7684\u5176\u4f59\u90e8\u5206\uff0c\u5f53\u6211\u4eec\u8c08\u5230\u5165\u53e3\u7f51\u5173\u7684\u5916\u90e8IP\u65f6\uff0c\u6211\u4eec\u5c06\u5728\u4f8b\u5b50\u548c\u6587\u672c\u4e2d\u4f7f\u7528 <code>GATEWAY URL</code>\u3002 </p> <p>\u4e0b\u4e00\u6b65\u662f\u521b\u5efa<code>Hello World</code>\u90e8\u7f72\u548c\u670d\u52a1\u3002 <code>Hello world</code>\u5e94\u7528\u7a0b\u5e8f\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u7f51\u7ad9\uff0c\u53ea\u662f\u6e32\u67d3  \"Hello world\"</p> <p><code>hello-world.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hello-world\n  labels:\n    app: hello-world\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: hello-world\n  template:\n    metadata:\n      labels:\n        app: hello-world\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/hello-world:1.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: hello-world\n  labels:\n    app: hello-world\nspec:\n  selector:\n    app: hello-world\n  ports:\n    - port: 80\n      name: http\n      targetPort: 3000\n</code></pre> <pre><code>$ kubectl get pod,svc -l=app=hello-world\nNAME                              READY   STATUS    RESTARTS   AGE\npod/hello-world-85c8685dd-gf9xf   2/2     Running   0          5m4s\n\nNAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE\nservice/hello-world   ClusterIP   10.102.151.188   &lt;none&gt;        80/TCP    5m4s\n</code></pre> <p>\u4e0b\u4e00\u6b65\u662f\u4e3a<code>hello-world</code>\u670d\u52a1\u521b\u5efa\u4e00\u4e2a<code>VirtualService</code>\uff0c\u5e76\u5c06\u5176\u7ed1\u5b9a\u5230<code>Gateway</code>\u8d44\u6e90\u4e0a\uff1a </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: hello-world\nspec:\n  hosts:\n    - \"*\"\n  gateways:\n    - gateway\n  http:\n    - route:\n        - destination:\n            host: hello-world.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <p>\u6211\u4eec\u5728<code>hosts</code>\u5b57\u6bb5\u4e2d\u4f7f\u7528<code>*</code>\uff0c\u5c31\u50cf\u6211\u4eec\u5728Gateway\u4e2d\u505a\u7684\u90a3\u6837\u3002\u6211\u4eec\u8fd8\u5c06\u4e4b\u524d\u521b\u5efa\u7684<code>Gateway</code>\u8d44\u6e90\uff08gateway\uff09\u6dfb\u52a0\u5230<code>gateways</code>\u6570\u7ec4\u4e2d\u3002</p> <p>\u6700\u540e\uff0c\u6211\u4eec\u6307\u5b9a\u4e86\u4e00\u4e2a\u76ee\u7684\u5730\u4e3a <code>Kubernetes</code>\u670d\u52a1<code>hello-world.default.svc.cluster.local</code>\u7684\u5355\u4e00\u8def\u7531\u3002 </p> <p>\u5c06\u4e0a\u8ff0<code>YAML</code>\u4fdd\u5b58\u4e3a<code>vs-hello-world.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectl apply -f vs-hello-world.yaml</code>\u521b\u5efaVirtualService\u3002</p> <p>\u5982\u679c\u4f60\u770b\u4e00\u4e0b\u90e8\u7f72\u7684<code>VirtualService</code>, \u4f60\u5e94\u8be5\u770b\u5230\u7c7b\u4f3c\u7684\u8f93\u51fa\uff1a </p> <pre><code>$ kubectl get vs\nNAME          GATEWAYS      HOSTS   AGE\nhello-world   [\"gateway\"]   [\"*\"]   25s\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5bf9<code>GATEWAY URL</code>\u8fd0\u884c<code>cURL</code>\u6216\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u5b83\uff0c\u6211\u4eec\u5c06\u5f97\u5230<code>Hello World</code>\u7684\u54cd\u5e94\uff1a </p> <pre><code> curl -v http://localhost\n*   Trying 127.0.0.1:80...\n* TCP_NODELAY set\n* Connected to localhost (127.0.0.1) port 80 (#0)\n&gt; GET / HTTP/1.1\n&gt; Host: localhost\n&gt; User-Agent: curl/7.65.1\n&gt; Accept: */*\n&gt; \n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 200 OK\n&lt; date: Sat, 09 Oct 2021 14:17:41 GMT\n&lt; content-length: 11\n&lt; content-type: text/plain; charset=utf-8\n&lt; x-envoy-upstream-service-time: 25\n&lt; server: istio-envoy\n&lt; \n* Connection #0 to host localhost left intact\nHello World\n</code></pre> <p>\u53e6\u5916\uff0c\u6ce8\u610f\u5230server\u5934\u8bbe\u7f6e\u4e3aistio-envoy\uff0c\u544a\u8bc9\u6211\u4eec\u8be5\u8bf7\u6c42\u901a\u8fc7\u4e86Envoy\u4ee3\u7406\u3002 </p> <p>\u6e05\u7406 </p> <p>\u5220\u9664Deployment\u3001 Services VirtualService\u548cGateway </p> <pre><code>$ kubectl delete deploy hello-world\ndeployment.apps \"hello-world\" deleted\n\n$ kubectl delete service hello-world\nservice \"hello-world\" deleted\n\n$ kubectl delete vs hello-world\nvirtualservice.networking.istio.io \"hello-world\" deleted\n\n$ kubectl delete gateway gateway\ngateway.networking.istio.io \"gateway\" deleted\n</code></pre>"},{"location":"chap8/5Istio_net_control_exp/#2grafana-zipkinkiali","title":"2\u3001\u5728Grafana\u3001 Zipkin\u548cKiali\u4e2d\u89c2\u5bdf\u6545\u969c\u6ce8\u5165\u548c\u5ef6\u8fdf\u60c5\u51b5","text":"<p>\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c \u6211\u4eec\u5c06\u90e8\u7f72Web\u524d\u7aef\u548c<code>Customer V1</code>\u670d\u52a1\u3002\u7136\u540e\uff0c\u6211\u4eec\u5c06\u5728Zipkin\u3001 Kiali  \u548cGrafana\u4e2d\u6ce8\u5165\u6545\u969c\u548c\u5ef6\u8fdf\uff0c\u5e76\u89c2\u5bdf\u5b83\u4eec\u3002 </p> <p> </p> <p><code>gateway.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n        - '*'\n</code></pre> <pre><code>$ kubectl get svc -l=istio=ingressgateway -n istio-system\nNAME                   TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE\nistio-ingressgateway   LoadBalancer   10.105.159.70   localhost     15021:31875/TCP,80:32344/TCP,443:31252/TCP,31400:31315/TCP,15443:31199/TCP   8d\n</code></pre> <p>\u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a<code>gateway.yaml</code>\u5e76\u4f7f\u7528<code>kubectl apply -f gateway.yaml</code>\u521b\u5efa\u7f51\u5173\u3002 </p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u90e8\u7f72<code>Web Frontend</code>\u3001<code>Service</code>\u548c<code>VirtualService</code></p> <p><code>web-frontend.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: web-frontend\n  template:\n    metadata:\n      labels:\n        app: web-frontend\n        version: v1\n    spec:\n      containers:\n        - image: pj3677/web-frontend:1.0.0\n          imagePullPolicy: Always\n          name: web\n          ports:\n            - containerPort: 8080\n          env:\n            - name: CUSTOMER_SERVICE_URL\n              value: 'http://customers.default.svc.cluster.local'\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  selector:\n    app: web-frontend\n  ports:\n    - port: 80\n      name: http\n      targetPort: 8080\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: web-frontend\nspec:\n  hosts:\n    - '*'\n  gateways:\n    - gateway\n  http:\n    - route:\n        - destination:\n            host: web-frontend.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <pre><code>$ kubectl get vs\nNAME           GATEWAYS      HOSTS   AGE\nweb-frontend   [\"gateway\"]   [\"*\"]   83s\n</code></pre> <p>\u5c06\u4e0a\u8ff0<code>YAML</code>\u4fdd\u5b58\u4e3a<code>web-frontend.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubect1 apply -f web-frontend.yaml</code>\u521b\u5efa\u8d44\u6e90\u3002 </p> <p>\u6700\u540e\uff0c\u6211\u4eec\u5c06\u90e8\u7f72<code>Customers v1</code>\u548c\u76f8\u5e94\u7684\u8d44\u6e90\u3002</p> <p><code>customers-default.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: customers-v1\n  labels:\n    app: customers\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: customers\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: customers\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/customers:1.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: customers\n  labels:\n    app: customers\nspec:\n  selector:\n    app: customers\n  ports:\n    - port: 80\n      name: http\n      targetPort: 3000\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: customers\nspec:\n  host: customers.default.svc.cluster.local\n  subsets:\n    - name: v1\n      labels:\n        version: v1\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n            subset: v1\n</code></pre> <pre><code>$ kubectl apply -f customers-210121-151301.yaml \ndeployment.apps/customers-v1 created\nservice/customers created\ndestinationrule.networking.istio.io/customers created\nvirtualservice.networking.istio.io/customers created\n</code></pre> <p> </p>"},{"location":"chap8/5Istio_net_control_exp/#delay-inject","title":"Delay inject\uff08\u5ef6\u8fdf\u6ce8\u5165\uff09","text":"<p><code>customers-delay.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n            subset: v1\n      fault:\n        delay:\n          percent: 50\n          fixedDelay: 5s\n</code></pre> <pre><code>$ kubectl apply -f customersdelay-210121-151301.yaml \nvirtualservice.networking.istio.io/customers configured\n</code></pre> <p>\u5c06\u4e0a\u8ff0<code>YAML</code>\u4fdd\u5b58\u4e3a<code>customers-delay.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectl apply -f customers-delay.yaml</code>\u66f4\u65b0<code>VirtualService</code>\u3002</p> <p>\u4e3a\u4e86\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf\uff0c\u8ba9\u6211\u4eec\u6253\u5f00\u4e00\u4e2a\u5355\u72ec\u7684\u7ec8\u7aef\u7a97\u53e3\uff0c\u5f00\u59cb\u5411<code>GATEWAY URL</code>\u53d1\u51fa\u65e0\u7a77\u7684\u5faa\u73af\u8bf7\u6c42\u3002</p> <pre><code>while true; do curl http://$GATEWAY_URL/; done\n\n\nwhile true; do curl http://127.0.0.1/; done\n</code></pre> <p>\u6211\u4eec\u5e94\u8be5\u5f00\u59cb\u6ce8\u610f\u5230\u4e00\u4e9b\u8bf7\u6c42\u7684\u65f6\u95f4\u6bd4\u5e73\u65f6\u957f\u3002\u8ba9\u6211\u4eec\u6253\u5f00Grafana\u5e76\u89c2\u5bdf\u8fd9\u4e9b\u5ef6\u8fdf\u3002 </p> <pre><code>$ istioctl dash grafana\nhttp://localhost:3000\n</code></pre> <p>\u5f53Grafana\u6253\u5f00\u65f6\uff0c\u70b9\u51fb\u4e3b\u9875\u548c<code>Istio Service Dashboard</code>\u3002\u5728\u4eea\u8868\u677f\u4e0a\uff0c\u786e\u4fdd\u5728\u670d\u52a1\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9<code>customers.default.svc.cluster.local</code></p> <p>\u5982\u679c\u4f60\u5c55\u5f00<code>Client Workload</code>\u9762\u677f\uff0c\u4f60\u4f1a\u53d1\u73b0\u5ba2\u6237\u7aef\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u56fe\u4e0a\u7684\u6301\u7eed\u65f6\u95f4\u589e\u52a0\u4e86\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 </p> <p> </p> <p>\u4f60\u53ef\u4ee5\u6ce8\u610f\u5230<code>web-frontend.default.svc.cluster.local</code>\u670d\u52a1\u65b9\u9762\u4e5f\u6709\u540c\u6837\u7684\u5ef6\u8fdf\u3002 </p> <p>\u8ba9\u6211\u4eec\u770b\u770b\u8fd9\u4e2a\u5ef6\u8fdf\u5728<code>Zipkin</code>\u4e2d\u662f\u5982\u4f55\u663e\u793a\u7684\u3002 \u7528<code>istioctl dash zipkin</code>\u6253\u5f00Zipkin\u3002</p> <p>\u5728\u4e3b\u5c4f\u5e55\u4e0a\uff0c\u9009\u62e9<code>serviceName</code>\u548c <code>web-frontend.default</code>\uff0c\u7136\u540e\u6dfb\u52a0<code>minDuration</code>\u6761\u4ef6\uff0c \u8f93\u5165<code>5S</code>\uff0c\u70b9\u51fb\u641c\u7d22\u6309\u94ae\uff0c\u627e\u5230<code>trace</code></p> <p>\u70b9\u51fb\u5176\u4e2d\u4e00\u4e2atrace\uff0c\u6253\u5f00\u8be6\u7ec6\u4fe1\u606f\u9875\u9762\u3002\u5728\u8be6\u60c5\u9875\u4e0a\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6301\u7eed\u65f6\u95f4\u662f5\u79d2\u3002 </p> <p>\u5355\u4e2atrace\u67094\u4e2aspan\u2014\u2014\u70b9\u51fb3\u4e2a\u8de8\u5ea6\uff0c\u4ee3\u8868\u4ece<code>web-frontend</code>\u5230\u5ba2\u6237\u670d\u52a1\u7684\u8bf7\u6c42\u3002 </p> <p>\u4f60\u4f1a\u6ce8\u610f\u5230\u5728\u7ec6\u8282\u4e2d\uff0c<code>response_flags</code>\u6807\u7b7e\u8bbe\u7f6e\u4e3a<code>DI</code>\u3002\"DI\u201d\u4ee3\u8868\u201d\u5ef6\u8fdf\u6ce8\u5165\u201d\uff0c\u8868\u793a\u8be5\u8bf7\u6c42\u88ab\u5ef6\u8fdf\u4e86\u3002 </p> <p> </p>"},{"location":"chap8/5Istio_net_control_exp/#fault-inject","title":"Fault inject\uff08\u6545\u969c\u6ce8\u5165\uff09","text":"<p>\u8ba9\u6211\u4eec\u518d\u6b21\u66f4\u65b0<code>VirtualService</code>\uff0c\u8fd9\u4e00\u6b21\uff0c\u6211\u4eec\u5c06\u6ce8\u5165\u4e00\u4e2a\u6545\u969c\uff0c\u5bf950\uff05\u7684\u8bf7\u6c42\u8fd4\u56de<code>HTTP 500</code>\u3002 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n            subset: v1\n      fault:\n        abort:\n          httpStatus: 500\n          percentage: \n            value: 50\n</code></pre> <p>\u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a<code>customers\u4e00fault.yaml</code>\uff0c\u7136\u540e\u7528</p> <p><code>kubectl apply -f customers-fault.yaml</code> \u66f4\u65b0<code>VirtualService</code>\u3002 </p> <p>\u5c31\u50cf\u524d\u9762\u4e00\u6837\uff0c\u6211\u4eec\u5c06\u5f00\u59cb\u6ce8\u610f\u5230\u6765\u81ea\u8bf7\u6c42\u5faa\u73af\u7684\u5931\u8d25\u3002\u5982\u679c\u6211\u4eec\u56de\u5230Grafana\u5e76\u6253\u5f00<code>Istio Service Dashboard</code>\uff0c</p> <p>\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u5ba2\u6237\u7aef\u7684\u6210\u529f\u7387\u5728\u4e0b\u964d\uff0c\u5e76\u4e14\u5728\u6309\u6765\u6e90\u548c\u54cd\u5e94\u4ee3\u7801\u5212\u5206\u7684\u4f20\u5165\u8bf7\u6c42\u56fe\u4e0a<code>500</code>\u54cd\u5e94\u5728\u589e\u52a0\uff0c\u5982\u56fe\u6240\u793a\u3002</p> <pre><code>$ kubectl apply -f customersfault-210121-151301.yaml \nvirtualservice.networking.istio.io/customers configured\n</code></pre> <p> </p> <p>\u5728Zipkin\u4e2d\u4e5f\u6709\u7c7b\u4f3c\u7684\u60c5\u51b5\u3002\u5982\u679c\u6211\u4eec\u518d\u6b21\u641c\u7d22<code>trace</code>\uff08\u6211\u4eec\u53ef\u4ee5\u5220\u9664\u6700\u5c0f\u6301\u7eed\u65f6\u95f4\uff09\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6709\u9519\u8bef\u7684trace\u4f1a\u4ee5\u7ea2\u8272\u663e\u793a\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 </p> <p> </p> <p>\u8ba9\u6211\u4eec\u4e5f\u6253\u5f00Kiali (<code>istioctl dash kiali</code>)\uff0c\u901a\u8fc7\u70b9\u51fbGraph\u9879\u67e5\u770b\u670d\u52a1\u56fe\u3002\u4f60\u4f1a\u6ce8\u610f\u5230web- frontend\u670d\u52a1\u6709\u4e00\u4e2a\u7ea2\u8272\u7684\u8fb9\u6846\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p> </p> <p>\u5982\u679c\u6211\u4eec\u70b9\u51fb<code>web-frontend</code>\u670d\u52a1\uff0c\u770b\u770b\u53f3\u8fb9\u7684\u4fa7\u8fb9\u680f\uff0c\u4f60\u4f1a\u53d1\u73b0HTTP\u8bf7\u6c42\u7684\u7ec6\u8282\u3002\u56fe\u4e2d\u663e\u793a\u4e86\u6210\u529f\u548c\u5931\u8d25\u7684\u767e\u5206\u6bd4\uff0c\u8fd9\u4e24\u4e2a\u6570\u5b57\u90fd\u572850\uff05\u5de6\u53f3\uff0c\u8fd9\u4e0e\u6211\u4eec\u5728VirtualService\u4e2d\u8bbe\u7f6e \u7684\u767e\u5206\u6bd4\u503c\u76f8\u4e00\u81f4\u3002 </p>"},{"location":"chap8/5Istio_net_control_exp/#_2","title":"\u6e05\u7406","text":"<p>\u5220\u9664DepIoyment\u3001 Services VirtuaIService\u3001 DestinationRule\u548cGateway</p> <pre><code>$ kubectl delete deploy web-frontend\ndeployment.apps \"web-frontend\" deleted\n\n\n$ kubectl delete svc customers web-frontend\nservice \"customers\" deleted\nservice \"web-frontend\" deleted\n\n$ kubectl delete vs customers web-frontend\nvirtualservice.networking.istio.io \"customers\" deleted\nvirtualservice.networking.istio.io \"web-frontend\" deleted\n\n$ kubectl delete gateway gateway\ngateway.networking.istio.io \"gateway\" deleted\n</code></pre>"},{"location":"chap8/5Istio_net_control_exp/#3","title":"3\u3001\u7b80\u5355\u6d41\u91cf\u8def\u7531","text":"<p>\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u6743\u91cd\u5728\u4e0d\u540c\u7684\u670d\u52a1\u7248\u672c\u4e4b\u95f4\u8def\u7531\u6d41\u91cf\u3002\u7136\u540e\uff0c\u6211\u4eec\u5c06\u90e8\u7f72 <code>Customers</code>\u670d\u52a1\u7248\u672c<code>v2</code>\uff0c\u5e76\u4f7f\u7528\u5b50\u96c6\u5728\u8fd9\u4e24\u4e2a\u7248\u672c\u4e4b\u95f4\u5206\u914d\u6d41\u91cf\u3002 </p> <p>\u8ba9\u6211\u4eec\u4ece\u90e8\u7f72Gateway\u5f00\u59cb </p> <p><code>gateway.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n        - '*'\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u521b\u5efa<code>Web Frontend</code>\u548c<code>Customers</code>\u670d\u52a1\u7684\u90e8\u7f72\u4ee5\u53ca\u76f8\u5e94\u7684<code>Kubernetes</code>\u670d\u52a1\u3002\u8ba9\u6211\u4eec\u9996\u5148\u4ece<code>web-frontend</code>\u5f00\u59cb\uff1a </p> <p><code>web-frontend.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: web-frontend\n  template:\n    metadata:\n      labels:\n        app: web-frontend\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/web-frontend:1.0.0\n          imagePullPolicy: Always\n          name: web\n          ports:\n            - containerPort: 8080\n          env:\n            - name: CUSTOMER_SERVICE_URL\n              value: 'http://customers.default.svc.cluster.local'\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  selector:\n    app: web-frontend\n  ports:\n    - port: 80\n      name: http\n      targetPort: 8080\n</code></pre> <p>\u6ce8\u610f\uff0c\u6211\u4eec\u6b63\u5728\u8bbe\u7f6e\u4e00\u4e2a\u540d\u4e3a<code>CUSTOMER_SERVICE_URL</code>\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5b83\u6307\u5411\u6211\u4eec\u63a5\u4e0b\u6765\u8981\u90e8\u7f72\u7684<code>customer</code>\u670d\u52a1\u3002We\u5315Frontend\u4f7f\u7528\u8fd9\u4e2aURL\u6765\u8c03\u7528<code>Customers</code>\u670d\u52a1\u3002 </p> <p>\u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a<code>web-frontend.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectl apply -f web-frontend.yaml</code>\u521b\u5efa\u90e8\u7f72\u548c\u670d\u52a1\u3002 </p> <pre><code>$ kubectl apply -f webfrontend-210121-151152.yaml \ndeployment.apps/web-frontend created\nservice/web-frontend created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u90e8\u7f72<code>Customers</code>\u670d\u52a1\u7684<code>v1</code>\u7248\u672c\u4e86\u3002\u6ce8\u610f\u6211\u4eec\u662f\u5982\u4f55\u5728Pod\u6a21\u677f\u4e2d\u8bbe\u7f6e <code>version: v1</code>\u6807\u7b7e\u7684\u3002</p> <p>\u7136\u800c\uff0c\u8be5\u670d\u52a1\u5728\u5176\u9009\u62e9\u5668\u4e2d\u53ea\u4f7f\u7528<code>app: customers</code>\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5c06\u5728<code>Destination Rule</code>\u4e2d\u521b\u5efa\u5b50\u96c6\uff0c\u8fd9\u4e9b\u5b50\u96c6\u5c06\u5728\u9009\u62e9\u5668\u4e2d\u5e94\u7528\u989d\u5916\u7684\u7248\u672c\u6807\u7b7e\uff0c\u4f7f\u6211\u4eec\u80fd\u591f\u5230\u8fbe\u8fd0\u884c\u7279\u5b9a\u7248\u672c\u7684<code>Pod</code></p> <p><code>customers-v1.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: customers-v1\n  labels:\n    app: customers\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: customers\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: customers\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/customers:1.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: customers\n  labels:\n    app: customers\nspec:\n  selector:\n    app: customers\n  ports:\n    - port: 80\n      name: http\n      targetPort: 3000\n</code></pre> <pre><code>$ kubectl apply -f customersvs-210121-151152.yaml \nvirtualservice.networking.istio.io/customers created\n</code></pre> <p>\u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a<code>custmers-v1.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectl apply -f customers-v1.yaml</code>\u521b\u5efa\u90e8\u7f72\u548c\u670d\u52a1\u3002 </p> <p>\u6211\u4eec\u5e94\u8be5\u6709\u4e24\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u548c\u8fd0\u884c\uff1a </p> <pre><code>$ kubectl get pod\nNAME                            READY   STATUS    RESTARTS   AGE\ncustomers-v1-7b5b4b76fc-t8sgx   2/2     Running   0          23h\nweb-frontend-69b64f974c-lplmx   2/2     Running   0          9m25s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4e3a<code>web-frontend</code>\u521b\u5efa\u4e00\u4e2a<code>VirtualService</code>\uff0c\u5e76\u5c06\u5176\u7ed1\u5b9a\u5230Gateway\u8d44\u6e90\u4e0a\uff1a </p> <p><code>web-frontend-vs.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: web-frontend\nspec:\n  hosts:\n    - '*'\n  gateways:\n    - gateway\n  http:\n    - route:\n        - destination:\n            host: web-frontend.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <pre><code>$ kubectl apply -f webfrontendvs-210121-151152.yaml \nvirtualservice.networking.istio.io/web-frontend created\n</code></pre> <pre><code>$ kubectl get vs\nNAME           GATEWAYS      HOSTS   AGE\nweb-frontend   [\"gateway\"]   [\"*\"]   12s\n</code></pre> <p> </p>"},{"location":"chap8/5Istio_net_control_exp/#v1-and-v2","title":"\u521b\u5efaV1 and V2\u4e24\u4e2a\u5b50\u96c6","text":"<p>\u5982\u679c\u6211\u4eec\u90e8\u7f72\u4e86Customers\u670d\u52a1<code>v2</code>\u7248\u672c\uff0c\u6211\u4eec\u5728\u8c03\u7528 <code>http://customers.default.svc.cluster.local</code>\uff0c\u5f97\u5230\u7684\u56de\u5e94\u5c06\u662f\u968f\u673a\u7684\u3002\u5b83\u4eec\u8981\u4e48\u6765\u81ea<code>Customers</code>\u670d\u52a1\u7684<code>v2</code>\u7248\u672c\uff0c\u8981\u4e48\u6765\u81ea<code>v1</code>\u7248\u672c\u3002 </p> <p>\u6211\u4eec\u9700\u8981\u4e3a<code>Customers</code>\u670d\u52a1\u521b\u5efa<code>Destination Rule</code>\uff0c\u5e76\u5b9a\u4e49\u4e24\u4e2a\u5b50\u96c6\uff0c\u4ee3\u8868<code>v1</code>\u548c<code>v2</code>\u7248\u672c\u3002</p> <p>\u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a<code>VirtualService</code>\uff0c\u5e76\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230v1\u7248\u672c\u7684\u5b50\u96c6\u3002</p> <p>\u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e0d\u5f71\u54cd\u73b0\u6709\u670d\u52a1\u7684\u60c5\u51b5\u4e0b\u90e8\u7f72v2\u7248\u672c\u7684Customers\u670d\u52a1\u3002</p> <p>\u8ba9\u6211\u4eec\u4ece<code>Destination Rule</code>\u548c\u4e24\u4e2a\u5b50\u96c6\u5f00\u59cb\uff1a </p> <p><code>customers-dr.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: customers\nspec:\n  host: customers.default.svc.cluster.local\n  subsets:\n    - name: v1\n      labels:\n        version: v1\n    - name: v2\n      labels:\n        version: v2\n</code></pre> <pre><code>$ kubectl apply -f customersdr-210121-151152.yaml \ndestinationrule.networking.istio.io/customers created\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u521b\u5efa<code>VirtualService</code>\u5e76\u5728\u76ee\u6807\u4e2d\u6307\u5b9a<code>v1</code>\u5b50\u96c6\uff1a </p> <p><code>customers-vs.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - customers.default.svc.cluster.local\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n            subset: v1\n</code></pre> <pre><code>$ kubectl get vs\nNAME           GATEWAYS      HOSTS                                     AGE\ncustomers                    [\"customers.default.svc.cluster.local\"]   3s\nweb-frontend   [\"gateway\"]   [\"*\"]                                     33m\n</code></pre> <p>\u6bcf\u5f53\u6709\u8bf7\u6c42\u88ab\u53d1\u9001\u5230<code>Kubernetes Customers</code>\u670d\u52a1\u65f6\uff0c\u5b83\u5c06\u88ab\u8def\u7531\u5230\u540c\u4e00\u670d\u52a1\u7684v1\u5b50\u96c6\u3002 </p> <p>\u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a<code>customers-vs.yaml</code>\uff0c\u5e76\u4f7f\u7528<code>kubectl apply -f customers-vs.yaml</code>\u521b\u5efa<code>VirtualService</code></p>"},{"location":"chap8/5Istio_net_control_exp/#v2-customers-deployment","title":"\u521b\u5efa <code>V2</code> \u7684 Customers Deployment","text":"<p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u51c6\u5907\u597d\u90e8\u7f72<code>v2</code>\u7248\u7684<code>Customers</code>\u670d\u52a1\u4e86\u3002<code>v2</code>\u7248\u672c\u8fd4\u56de\u4e0e\u524d\u4e00\u7248\u672c\u76f8\u540c\u7684\u5ba2\u6237\u5217\u8868\uff0c\u4f46\u5b83\u4e5f\u5305\u62ec\u57ce\u5e02\u540d\u79f0\u3002 </p> <p>\u8ba9\u6211\u4eec\u521b\u5efa<code>Customers v2</code>\u90e8\u7f72\u3002\u6211\u4eec\u4e0d\u9700\u8981\u90e8\u7f72<code>Kubernetes</code>\u670d\u52a1\uff0c\u56e0\u4e3a\u6211\u4eec\u5df2\u7ecf\u90e8\u7f72\u4e86\u4e00\u4e2av1\u7248\u672c\u7684\u670d\u52a1\u3002 </p> <p><code>customers-v2.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: customers-v2\n  labels:\n    app: customers\n    version: v2\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: customers\n      version: v2\n  template:\n    metadata:\n      labels:\n        app: customers\n        version: v2\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/customers:2.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n</code></pre> <pre><code>$ kubectl apply -f customersv2-210121-151152.yaml \ndeployment.apps/customers-v2 created\n</code></pre> <p>\u8be5\u90e8\u7f72\u4e0e<code>v1</code>\u90e8\u7f72\u51e0\u4e4e\u76f8\u540c\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\u6240\u4f7f\u7528\u7684<code>Docker</code>\u955c\u50cf\u7248\u672c\u548c\u8bbe\u7f6e\u5728\u7248\u672c\u6807\u7b7e\u4e0a\u7684<code>v2</code>\u503c\u3002  \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a<code>customers-v2.yaml</code>\u521b\u5efa\u90e8\u7f72\u3002</p> <p>\u5e76\u4f7f\u7528<code>kubectl apply -f customers-v2.yaml</code> </p> <p>\u8ba9\u6211\u4eec\u4f7f\u7528<code>weight</code>\u5b57\u6bb5\u5e76\u4fee\u6539<code>virtualService</code>\uff0c\u4f7f<code>50\uff05</code>\u7684\u6d41\u91cf\u88ab\u53d1\u9001\u5230<code>v1\u5b50</code>\u96c6\uff0c\u53e6<code>50%</code>\u53d1\u9001\u5230<code>v2</code>\u5b50\u96c6\u3002</p> <p>\u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u7b2c\u4e8c\u4e2a<code>destination</code>\uff0c\u6709\u76f8\u540c\u7684\u4e3b\u673a\u540d\uff0c\u4f46\u6709\u4e0d\u540c\u7684\u5b50\u96c6\u3002\u6211\u4eec\u8fd8\u5c06\u4e3a<code>destination</code>\u6dfb\u52a0<code>weight:50</code>\uff0c\u4ee5\u4fbf\u5728\u4e24\u4e2a\u7248\u672c\u4e4b\u95f4\u5e73\u5747\u5206\u914d\u6d41\u91cf</p> <p><code>customers-50-50.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n            subset: v1\n          weight: 50\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n            subset: v2\n          weight: 50\n</code></pre> <p>\u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a<code>customers-50-50.yaml</code>\u5e76\u4f7f\u7528<code>kubectl apply -f customers-50-50.yaml</code>\u66f4\u65b0<code>VirtualService</code>\u3002 </p> <p>\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00<code>GATEWAY_URL</code>, \u5237\u65b0\u51e0\u6b21\u9875\u9762\uff0c\u770b\u770b\u4e0d\u540c\u7684\u54cd\u5e94\u3002\u6765\u81ea<code>Customers v2</code>\u7684\u54cd\u5e94\u663e\u793a\u5728\u4e0b\u56fe\u4e2d </p> <pre><code>$ kubectl get vs\nNAME           GATEWAYS      HOSTS                                     AGE\ncustomers                    [\"customers.default.svc.cluster.local\"]   16m\nweb-frontend   [\"gateway\"]   [\"*\"]                                     50m\n</code></pre> <p> </p> <pre><code>$ istioctl dashboard kiali\nhttp://localhost:20001/kiali\n</code></pre> <p> </p> <p>\u4e3a\u4e86\u6539\u53d8\u53d1\u9001\u5230\u4e00\u4e2a\u6216\u53e6\u4e00\u4e2a\u7248\u672c\u7684\u6d41\u91cf\u6bd4\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u66f4\u65b0VirtualService\u3002\u540c\u6837\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u6dfb\u52a0<code>v3</code>\u6216<code>v4</code>\u7248\u672c\uff0c\u5e76\u5728\u8fd9\u4e9b\u7248\u672c\u4e4b\u95f4\u5206\u5272\u6d41\u91cf\u3002 </p>"},{"location":"chap8/5Istio_net_control_exp/#_3","title":"\u6e05\u7406","text":"<p>\u5220\u9664Deployments\u3001 Services\u3001 VirtualServices\u3001 DestinationRule\u548cGateway: </p> <pre><code>kubectl delete -f .\n</code></pre>"},{"location":"chap8/5Istio_net_control_exp/#4","title":"4\u3001\u9ad8\u7ea7\u6d41\u91cf\u8def\u7531","text":"<p>\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u8bf7\u6c42\u5c5e\u6027\u591a\u4e2a\u670d\u52a1\u7248\u672c\u4e4b\u95f4\u8def\u7531\u6d41\u91cf\u3002 </p> <p>\u6211\u4eec\u5c06\u4ece\u90e8\u7f72Gateway\u5f00\u59cb\uff1a </p> <p><code>gateway.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n        - '*'\n</code></pre> <pre><code>kubectl apply -f 1gateway.yaml \ngateway.networking.istio.io/gateway created\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u90e8\u7f72Web\u524d\u7aef\u3001<code>Customersv1</code>\u3001 <code>Customersv2</code>\uff0c\u4ee5\u53ca\u76f8\u5e94\u7684 <code>Vi rtualServices</code>\u548c<code>Destination Rule</code>\u3002\u4e00\u65e6\u4e00\u5207\u90e8\u7f72\u5b8c\u6bd5\uff0c\u6240\u6709\u6d41\u91cf\u5c06\u88ab\u8def\u7531\u5230<code>Customers v1</code>\u3002 </p> <p><code>webfrontend.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: web-frontend\n  template:\n    metadata:\n      labels:\n        app: web-frontend\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/web-frontend:1.0.0\n          imagePullPolicy: Always\n          name: web\n          ports:\n            - containerPort: 8080\n          env:\n            - name: CUSTOMER_SERVICE_URL\n              value: 'http://customers.default.svc.cluster.local'\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  selector:\n    app: web-frontend\n  ports:\n    - port: 80\n      name: http\n      targetPort: 8080\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: web-frontend\nspec:\n  hosts:\n    - '*'\n  gateways:\n    - gateway\n  http:\n    - route:\n        - destination:\n            host: web-frontend.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <pre><code>$ kubectl apply -f 2webfrontend.yaml \ndeployment.apps/web-frontend created\nservice/web-frontend created\nvirtualservice.networking.istio.io/web-frontend created\n</code></pre> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: customers-v1\n  labels:\n    app: customers\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: customers\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: customers\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/customers:1.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: customers-v2\n  labels:\n    app: customers\n    version: v2\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: customers\n      version: v2\n  template:\n    metadata:\n      labels:\n        app: customers\n        version: v2\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/customers:2.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: customers\n  labels:\n    app: customers\nspec:\n  selector:\n    app: customers\n  ports:\n    - port: 80\n      name: http\n      targetPort: 3000\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n            subset: v1\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: customers\nspec:\n  host: customers.default.svc.cluster.local\n  subsets:\n    - name: v1\n      labels:\n        version: v1\n    - name: v2\n      labels:\n        version: v2\n</code></pre> <pre><code>$ kubectl apply -f 3customers.yaml \ndeployment.apps/customers-v1 created\ndeployment.apps/customers-v2 created\nservice/customers created\nvirtualservice.networking.istio.io/customers created\ndestinationrule.networking.istio.io/customers created\n</code></pre> <p>\u4e3a\u4e86\u786e\u4fdd\u4e00\u5207\u90e8\u7f72\u548c\u5de5\u4f5c\u6b63\u5e38\uff0c\u6253\u5f00<code>GATEWAY_URL</code>\u5e94\u5e76\u786e\u4fdd\u6211\u4eec\u4ece<code>Customersv1</code>\u83b7\u5f97\u54cd\u5e94</p> <p>\u6211\u4eec\u5c06\u66f4\u65b0Customers\u7684VirtualService\uff0c\u5e76\u66f4\u65b0\u6d41\u91cf\u5728\u4e24\u4e2a\u7248\u672c\u7684Customers\u670d\u52a1\u4e4b\u95f4\u7684\u8def\u7531  \u8ba9\u6211\u4eec\u770b\u4e00\u4e0b<code>YAML</code>\uff0c\u5982\u679c\u8bf7\u6c42\u4e2d\u5305\u542b\u4e00\u4e2a<code>header user debug</code>\uff0c\u5c31\u628a\u6d41\u91cf\u8def\u7531\u5230<code>Customersv2</code>\u3002\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u8fd9\u4e2aheader\uff0c\u6211\u4eec\u5c31\u88ab\u8def\u7531\u5230<code>Customersv1</code></p> <p><code>customersvs.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n  - match:\n    - headers:\n        user:\n          exact: debug\n    route:\n    - destination:\n        host: customers.default.svc.cluster.local\n        port:\n          number: 80\n        subset: v2\n  - route:\n      - destination:\n          host: customers.default.svc.cluster.local\n          port:\n            number: 80\n          subset: v1\n</code></pre> <pre><code>http:\n  - match:\n    - headers:\n        user:\n          exact: debug\n</code></pre> <pre><code>$ kubectl get vs\nNAME           GATEWAYS      HOSTS                                     AGE\ncustomers                    [\"customers.default.svc.cluster.local\"]   9m2s\nweb-frontend   [\"gateway\"]   [\"*\"]                                     11m\n</code></pre> <p><code>http://127.0.0.1/</code></p> <p> </p>"},{"location":"chap8/5Istio_net_control_exp/#header","title":"header \u5339\u914d","text":"<pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n  - match:\n    - headers:\n        user:\n          exact: debug\n    route:\n    - destination:\n        host: customers.default.svc.cluster.local\n        port:\n          number: 80\n        subset: v2\n  - route:\n      - destination:\n          host: customers.default.svc.cluster.local\n          port:\n            number: 80\n          subset: v1\n</code></pre> <pre><code>$kubectl apply -f 4customersvs.yaml \nvirtualservice.networking.istio.io/customers configured\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u4e0d\u63d0\u4f9b\u7aef\u53e3\u53f7\uff0c<code>VirtualService</code>\u4e2d\u7684\u76ee\u7684\u5730\u4e5f\u4f1a\u5de5\u4f5c\u3002\u8fd9\u662f\u56e0\u4e3a\u8be5\u670d\u52a1\u53ea\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7aef\u53e3\u3002 </p> <p>\u5982\u679c\u6211\u4eec\u6253\u5f00<code>GATEWAY_URL</code>\uff0c\u6211\u4eec\u4ecd\u7136\u5e94\u8be5\u5f97\u5230\u6765\u81ea<code>Customers v1</code>\u7684\u54cd\u5e94\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5728\u8bf7\u6c42\u4e2d\u6dfb\u52a0<code>header user: debug</code>\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230<code>customers</code>\u7684\u54cd\u5e94\u662f\u6765\u81ea<code>Customers v2</code> </p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528ModHeader\u6269\u5c55\u6765\u4fee\u6539\u6d4f\u89c8\u5668\u4e2d\u7684\u5934\u4fe1\u606f\u3002\u53e6\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>cURL</code>\uff0c\u50cf\u8fd9\u6837\u628a\u5934\u4fe1\u606f\u6dfb\u52a0\u5230\u8bf7\u6c42\u4e2d\u3002 </p> <p> </p> <p> </p> <pre><code>$ curl -H \"user: debug\" http://127.0.0.1/\n...\n&amp;lt;th class=\"px-4 py-2\"&amp;gt;CITY&amp;lt;/th&amp;gt;\n&amp;lt;th class=\"px-4 py-2\"&amp;gt;NAME&amp;lt;/th&amp;gt;\n...\n</code></pre> <p> </p> <p>\u5982\u679c\u6211\u4eec\u770b\u4e00\u4e0b\u56de\u590d\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u6709\u4e24\u680f  CITY\u548cNAME\u3002 </p> <p>\u6e05\u7406 </p> <p>\u5220\u9664DepIoyment\u3001 Services\u3001 VirtualService\u3001 DestinationRule\u548cGateway: </p> <pre><code>$ kubectl delete -f .\n</code></pre>"},{"location":"chap8/5Istio_net_control_exp/#5","title":"5\u3001\u6d41\u91cf\u7ba1\u7406\uff1a\u6d4b\u8bd5","text":"<p>1\u3001\u6211\u4eec\u53ef\u4ee5\u7528\u4ec0\u4e48\u8d44\u6e90\u914d\u7f6eIstlo ingress gateway?</p> <ul> <li>A Gateway </li> <li>B VirtualService </li> <li>C Deployment </li> <li>D Service </li> </ul> <p><code>Gateway</code> :  <code>istio: ingressgateway</code></p> <p>2\u3001\u4f7f\u7528Gateway\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u5c06\u6d41\u91cf\u8def\u7531\u5230Kubernetes\u5185\u90e8 \u7684\u4e00\u4e2a\u7279\u5b9a\u670d\u52a1\u3002\u5bf9\u8fd8\u662f\u9519\uff1f </p> <ul> <li>A \u5bf9</li> <li>B \u9519</li> </ul> <p><code>VirtualService</code></p> <p>3\u3001Istio ingress \u7f51\u5173\u662f\u4f5c\u4e3a\u54ea\u79cd\u670d\u52a1\u7c7b\u578b\u90e8\u7f72\u7684\uff1f </p> <ul> <li>A ClusterIP </li> <li>B NodePort </li> <li>C Loadbalancer </li> <li>D \u4e0d\u662f\u4ee5Service\u5f62\u5f0f\u90e8\u7f72\u7684</li> </ul> <p>4\u3001\u4e0b\u9762\u7684<code>VirtualService</code>\u662f\u505a\u4ec0\u4e48\u7684\uff1f </p> <p> </p> <p>\u90e8\u7f72\u5728\u4e0a\u8ff0VirtualService\u65c1\u8fb9\u7684Gateway\u8d44\u6e90\uff1a </p> <p> </p> <ul> <li>A \u5c06\u6240\u6709\u8fdb\u5165\u7684\u6d41\u91cf\u901a\u8fc7ingress\u8def\u7531\u5230Orders\u670d\u52a1 </li> <li>B \u4ec0\u4e48\u4e5f\u4e0d\u505a\u3002\u5b83\u662f\u65e0\u6548\u7684\uff0c\u56e0\u4e3ahosts\u5b57\u6bb5\u88ab\u8bbe\u7f6e\u4e3a<code>\uff0a</code>\u3002 </li> <li>C Routes all traffic from the ingress gateway to the orders service \u5c06\u6240\u6709\u6d41\u91cf\u4ece\u5165\u53e3\u7f51\u5173\u8def\u7531\u5230Orders\u670d\u52a1 </li> <li>D \u865a\u62df\u670d\u52a1\u662f\u65e0\u6548\u7684\uff0c\u56e0\u4e3a\u5b83\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\u5730\u3002 </li> </ul> <p>5\u3001\u4f60\u53ef\u4ee5\u5728\u54ea\u4e2a\u8d44\u6e90\u4e2d\u4e3aHTTP\u6d41\u91cf\u6307\u5b9a\u8def\u7531\u89c4\u5219\uff1f </p> <ul> <li>A DestinationRule </li> <li>B VirtuaLService </li> <li>C Gateway </li> <li>D Deployment </li> </ul> <p>6\u3001\u5982\u4f55\u5b9a\u4e49\u591a\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u4ee5\u4fbf\u80fd\u591f\u5728\u5b83\u4eec\u4e4b\u95f4\u8fdb\u884c\u6d41\u91cf\u8def\u7531\uff1f </p> <ul> <li>A \u4f7f\u7528Destination Rule\u548csubset </li> <li>B \u4f7f\u7528VirtualService destinations </li> <li>C \u5728Gateway\u5b9a\u4e49\u591a\u4e2ahost </li> <li>D \u5728Pod\u6a21\u677f\u4e2d\u4f7f\u7528\u6807\u7b7e </li> </ul> <p>7\u3001\u5f53\u4f7f\u7528\u79bb\u7fa4\u68c0\u6d4b\u65f6\uff0c\u4e3b\u673a\u4f55\u65f6\u4f1a\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\uff1f </p> <ul> <li>A \u5f53\u4e0d\u54cd\u5e94\u65f6 </li> <li>B \u5f53\u8fd4\u56deHTTP 4xx\u9519\u8bef\u65f6 </li> <li>C \u5f53\u8fd4\u56deHTTP 5xx\u9519\u8bef\u65f6 </li> <li>D \u4e0d\u4f1a\u88ab\u5f39\u51fa </li> </ul> <p>8\u3001\u5728\u79bb\u7fa4\u68c0\u6d4b\u914d\u7f6e\u4e2d\uff0c\u95f4\u9694\u8bbe\u7f6e\u6307\u7684\u662f\u4ec0\u4e48\uff1f</p> <ul> <li>A. \u79bb\u7fa4\u68c0\u6d4b\u5f00\u59cb\u6240\u9700\u7684\u65f6\u95f4 </li> <li>B. \u626b\u63cf\u4e0a\u6e38\u4e3b\u673a\u65f6\u95f4\u7684\u95f4\u9694</li> <li>C. \u5f02\u5e38\u503c\u88ab\u5f39\u51fa\u7684\u65f6\u95f4\u95f4\u9694 </li> <li>D. \u5237\u65b0\u914d\u7f6e\u7684\u65f6\u95f4\u95f4\u9694 </li> </ul> <p>9\u3001\u80fd\u5c06\u6d41\u91cf\u7b56\u7565\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u7aef\u53e3\u5417\uff1f\uff08\u662f/\u5426\uff09 </p> <ul> <li>A \u80fd </li> <li>B \u4e0d\u80fd </li> </ul> <p><code>trafficPolicy: portLevelSettings: port</code></p> <p>10\u3001 <code>ISTIO_MUTUAL</code>\u548c<code>MUTUAL TLS</code>\u6a21\u5f0f\u4e4b\u95f4\u6709\u4ec0\u4e48\u533a\u522b\uff1f </p> <ul> <li>A \u6ca1\u6709\u533a\u522b </li> <li>B <code>ISTIO_MUTUAL</code>\u9700\u8981\u751f\u4ea7istio\u914d\u7f6e\u6587\u4ef6\uff0c\u800cMUTUAL\u4e0d\u9700\u8981\u3002 </li> <li>C MUTUAL\u53ef\u4ee5\u4e0e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u4e00\u8d77\u4f7f\u7528\uff0c\u800c<code>ISTIO_MUTUAL</code>\u4e0d\u80fd </li> <li>D <code>ISTIO_MUTUAL</code>\u5728mTLS\u4e2d\u4f7f\u7528Istio\u7684\u8bc1\u4e66\uff0c\u800c\u5728<code>MUTUAL TLS</code>\u4e2d\u4f60\u53ef\u4ee5\u7528\u4f60\u81ea\u5df1\u7684\u8bc1\u4e66 </li> </ul> <p><code>ISTIO_MUTUAL</code>\uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09</p> <p>11. (Resiliency\uff09\u5c31\u662f\u8981\u907f\u514d\u548c\u9632\u6b62\u6545\u969c\u3002\u5bf9\u8fd8\u662f\u9519\uff1f </p> <ul> <li>A \u5bf9</li> <li>B \u9519 </li> </ul> <p>\u8fd9\u4e0d\u662f\u4e3a\u4e86\u907f\u514d\u6545\u969c\uff0c\u800c\u662f\u4ee5\u4e00\u79cd\u6ca1\u6709\u505c\u673a\u6216\u6570\u636e\u4e22\u5931\u7684\u65b9\u5f0f\u6765\u5e94\u5bf9\u6545\u969c\u3002\u5f39\u6027\u7684\u76ee\u6807 \u662f\u5728\u6545\u969c\u53d1\u751f\u540e\u5c06\u670d\u52a1\u6062\u590d\u5230\u4e00\u4e2a\u5b8c\u5168\u6b63\u5e38\u7684\u72b6\u6001</p> <p>12. Istio\u7684\u54ea\u4e24\u4e2a\u529f\u80fd\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u89e3\u51b3\u5f39\u6027\u95ee\u9898\uff1f</p> <ul> <li>A \u91cd\u8bd5\u7b56\u7565 </li> <li>B \u6d41\u91cf\u8def\u7531 </li> <li>C mTLS </li> <li>D \u8d85\u65f6 </li> <li>E \u6388\u6743\u7b56\u7565 </li> </ul> <p>13 \u6211\u4eec\u662f\u5426\u53ef\u4ee5\u4f7f\u7528\u6807\u5934\u6765\u6307\u5b9a\u53ef\u6536\u56de\u7684\u72b6\u6001\u4ee3\u7801\uff1f\uff08\u662f\uff0f\u5426\uff09 </p> <ul> <li>A  \u662f</li> <li>B \u5426</li> </ul> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u53ea\u5728\u4e0a\u6e38\u670d\u52a1\u5668\u8fd4\u56de5xx\u54cd\u5e94\u4ee3\u7801\u65f6\u91cd\u8bd5\u8bf7\u6c42\uff0c\u6216\u8005\u53ea\u5728\u7f51\u5173\u9519\u8bef\uff08HTTP 5O2\u3001 503\u6216504\uff09\u65f6\u91cd\u8bd5\uff0c\u6216\u8005\u751a\u81f3\u5728\u8bf7\u6c42\u5934\u4e2d\u6307\u5b9a\u53ef\u91cd\u8bd5\u7684\u72b6\u6001\u4ee3\u7801\u3002</p> <p>13 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f </p> <ul> <li>A \u4ec0\u4e48\u4e5f\u4e0d\u4f1a\u53d1\u751f\uff0c\u7aef\u70b9\u4fdd\u6301\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d </li> <li>B Pod\u91cd\u542f </li> <li>C \u4f60\u53ef\u4ee5\u914d\u7f6e\u91cd\u8bd5\u662f\u5426\u6392\u9664\u7aef\u70b9  </li> <li>D \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 </li> </ul> <p>\u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\u3002\u5f53Envoy\u91cd\u8bd5\u4e00\u4e2a\u5931\u8d25\u7684\u8bf7\u6c42\u65f6\uff0c\u6700\u521d\u5931\u8d25\u5e76\u5bfc\u81f4\u91cd\u8bd5\u7684\u7aef\u70b9\u5c31\u4e0d\u518d\u5305\u542b\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u4e86\u3002\u5047\u8bbeKubernetes\u670d\u52a1\u67093\u4e2a\u7aef\u70b9\uff08Pod)\uff0c\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u4e86\uff0c \u5e76\u51fa\u73b0\u4e86\u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u4ee3\u7801</p> <p>14 \u4f60\u80fd\u4e3a\u540c\u4e00\u4e2a\u8bf7\u6c42\u540c\u65f6\u6ce8\u5165\u5ef6\u8fdf\u548c\u4e2d\u6b62\u5417\uff1f\uff08\u662f/\u5426\uff09</p> <ul> <li>A \u662f</li> <li>B \u5426</li> </ul> <p>15 \u8003\u8651\u5230\u4e0b\u9762\u7684\u7247\u6bb5\uff0c\u6709\u591a\u5c11\u767e\u5206\u6bd4\u7684\u8bf7\u6c42\u4f1a\u88ab\u4e2d\u6b62\uff1f</p> <pre><code>\u2026 \nfault: \n  abort: \n    httpStatus:404 \n</code></pre> <ul> <li>A 0% </li> <li>B 100% </li> <li>C \u8be5\u7247\u6bb5\u662f\u65e0\u6548\u7684 </li> <li>D \u4e0d\u6e05\u695a\uff0c\u56e0\u4e3a\u767e\u5206\u6bd4\u672a\u6307\u5b9a </li> </ul> <p>\u5982\u679c\u6211\u4eec\u4e0d\u6307\u5b9a\u767e\u5206\u6bd4\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u4e2d\u6b62</p> <p>16 \u6545\u969c\u6ce8\u5165\u662f\u5426\u89e6\u53d1\u91cd\u8bd5\u7b56\u7565\uff1f\uff08\u662f\uff0f\u5426\uff09 </p> <ul> <li>A \u662f</li> <li>B \u5426</li> </ul> <p>\u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u5c06\u4e0d\u4f1a\u89e6\u53d1\u6211\u4eec\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u6ce8\u5165\u4e86\u4e00\u4e2aHTTP 500\u7684\u9519\u8bef\uff0c\u914d\u7f6e\u4e3aHTTP 500\u4e0a\u7684\u91cd\u8bd5\u7b56\u7565\u5c06\u4e0d\u4f1a\u88ab\u89e6\u53d1\u3002</p> <p>17 \u4f60\u53ef\u4ee5\u4f7f\u7528<code>VirtualService</code>\u4e2d\u7684\u54ea\u4e2a\u5b57\u6bb5\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230Kubernetes\u4e2d\u4e00\u4e2a\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\uff1f </p> <ul> <li>A destination </li> <li>B authority </li> <li>C redirect</li> <li>D host-redirect </li> </ul> <pre><code>...\nhttp:\n  - match:\n   - headers:\n     my-header:\n      exact: hello\n   redirect:\n    uri: /hello\n    authority: my-service.default.svc.cluster.local:8000\n...\n</code></pre> <p>18  \u5728\u7f16\u5199\u5339\u914d\u89c4\u5219\u65f6\uff0c\u5982\u4f55\u8868\u8fbeAND\u548cOR\u7684\u8bed\u4e49\uff1f </p> <ul> <li>A \u5bf9\u4e8eOR\uff0c\u4f60\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a\u5355\u72ec\u7684\u5339\u914d\u6761\u76ee\uff0c\u800c\u5bf9\u4e8eAND\uff0c\u4f60\u5728\u4e00\u4e2a\u5355\u4e00\u7684\u5339\u914d\u6761\u76ee\u4e2d\u5305\u62ec\u6240\u6709\u7684\u6761\u4ef6 </li> <li>B \u4f60\u4e0d\u80fd\u8fd9\u6837\u505a\u3002\u53ea\u5141\u8bb8\u4f7f\u7528OR\u8bed\u4e49 </li> <li>C \u4f60\u4e0d\u80fd\u8fd9\u6837\u505a\u3002\u53ea\u5141\u8bb8\u4f7f\u7528AND\u8bed\u4e49 </li> <li>D \u5bf9\u4e8eOR\uff0c\u5728\u4e00\u4e2a\u5355\u4e00\u7684\u5339\u914d\u6761\u76ee\u4e2d\u5305\u62ec\u6240\u6709\u6761\u4ef6\uff0c\u5bf9\u4e8eAND\uff0c\u6dfb\u52a0\u4e00\u4e2a\u5355\u72ec\u7684\u5339\u914d\u6761\u76ee </li> </ul> <p>19 \u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u4f7f\u5916\u90e8\u670d\u52a1\u6210\u4e3a\u4f60\u7684\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206\uff1f </p> <ul> <li>A Service </li> <li>B ServiceEntry </li> <li>C VirtualService </li> <li>D Gateway </li> </ul> <p>\u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206</p> <p>20 Envoy sidecar\u68c0\u67e5ServiceEntry\u8d44\u6e90\u4e2d\u7684hosts\u5b57\u6bb5\u7684\u987a\u5e8f\u662f\u4ec0\u4e48\uff1f </p> <ul> <li>A IP\u5730\u5740\u3001\u7aef\u53e3\u3001SNI\u3001HTTP</li> <li>B SNI\u3001 IP\u5730\u5740\u3001\u7aef\u53e3\u3001HTTP </li> <li>C HTTP\u3001 SNI\u3001 IP\u5730\u5740\u3001\u7aef\u53e3 </li> <li>D HTTP\u3001 IP\u5730\u5740\u3001\u7aef\u53e3\u3001SNI </li> </ul> <pre><code>* HTTP Authority\u5934\uff08\u5728HTTP/2\u4e2d\uff09\u548cHost\u5934\uff08HTTP/1.1\u4e2d\uff09 \n* SNI\n* IP\u5730\u5740\u548c\u7aef\u53e3 \n</code></pre> <p>21 ServiceEntry\u8d44\u6e90\u4e2d\u7684workloadSelector\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f </p> <ul> <li>A \u4ece\u5916\u90e8\u96c6\u7fa4\u4e2d\u9009\u62e9pod\u5e76\u4f7f\u5176\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 </li> <li>B \u9009\u62e9Kubernetes\u670d\u52a1\uff0c\u4f7f\u5176\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 </li> <li>C \u8981\u9009\u62e9WorkloadEntry\u8d44\u6e90\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 </li> <li>D ServiceEntry\u6ca1\u6709workloadSelector\u5b57\u6bb5 </li> </ul> <p>\u5728Workload Entry\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ec6\u8282\uff08\u540d\u79f0\u3001\u5730\u5740\u3001\u6807\u7b7e\uff09\uff0c\u7136\u540e\u4f7f\u7528ServiceEntry\u4e2d\u7684<code>workloadSelector</code>\u5b57\u6bb5\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3a<code>Istio</code>\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206\u3002</p> <p>22 \u5982\u4f55\u914d\u7f6esidecar\u4ee3\u7406\uff0c\u4f7f\u5176\u53ea\u5bf9\u67d0\u4e9b\u670d\u52a1\u4f7f\u7528\u7279\u5b9a\u7684\u7aef\u53e3\uff1f </p> <ul> <li>A \u4f7f\u7528Proxy\u8d44\u6e90 </li> <li>B \u4f7f\u7528Filter\u8d44\u6e90 </li> <li>C \u4f7f\u7528VirtualService\u8d44\u6e90 </li> <li>D \u4f7f\u7528Sidecar\u8d44\u6e90 </li> </ul> <p>23 Sidecar\u8d44\u6e90\u4e2d\u7684Ingress\u548cegress\u76d1\u542c\u5668\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f </p> <ul> <li>A \u8981\u914d\u7f6e\u54ea\u4e9b\u6d41\u91cf\u662fsidecar\u963b\u65ad\u7684 </li> <li>B \u8981\u5c06ingress\u548cegress\u7f51\u5173\u8fde\u63a5\u5230Sidecar\u4e0a</li> <li>C \u5b9a\u4e49\u54ea\u4e9b\u5165\u7ad9\uff0f\u51fa\u7ad9\u6d41\u91cf\u88absidecar\u63a5\u53d7 </li> <li>D Ingress\u5b57\u6bb5\u7528\u4e8e\u914d\u7f6e\u8fdb\u5165sidecar\u7684\u6d41\u91cf\uff0c\u800cegress\u5b57\u6bb5\u662f\u4e0d\u53ef\u914d\u7f6e\u7684\u3002 .</li> </ul> <pre><code>* Workload selector \n* Ingress listener \n* Egress listener \n</code></pre> <p>24 EnvoyFilters\u662f\u5426\u7528\u4e8e\u5b9a\u5236\u7531Pilot\u751f\u6210\u7684Envoy\u914d\u7f6e\uff1f \uff08\u662f\uff0f\u5426\uff09</p> <ul> <li>A \u662f</li> <li>B \u5426</li> </ul> <p>EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531<code>Istio Pilot</code>\u751f\u6210\u7684Envoy\u914d\u7f6e</p> <p>25 \u5f53\u6709\u591a\u4e2aEnvoyFilter\u90e8\u7f72\u65f6\uff0c\u54ea\u4e9b\u8fc7\u6ee4\u5668\u4f1a\u5148\u88ab\u5e94\u7528\uff1f </p> <ul> <li>A default\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fc7\u6ee4\u5668 </li> <li>B \u6839\uff08\u5982istio-system)\u547d\u540d\u7a7a\u95f4\u7684\u8fc7\u6ee4\u5668</li> <li>C \u5b83\u4eec\u662f\u6309\u5b57\u6bcd\u987a\u5e8f\u5e94\u7528\u7684 </li> <li>D \u5b83\u4eec\u662f\u6839\u636epriority\u5b57\u6bb5\u6765\u5e94\u7528\u7684 </li> </ul> <p>\u6839\u547d\u540d\u7a7a\u95f4\uff08\u4f8b\u5982<code>istio-system</code>)\u4e2d\u7684\u8fc7\u6ee4\u5668\u9996\u5148\u88ab\u5e94\u7528\uff0c\u7136\u540e\u662f\u5de5\u4f5c\u8d1f\u8f7d\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u5339\u914d\u8fc7\u6ee4\u5668\u3002</p> <p>26 \u5982\u4f55\u5c06VirtualService\u4e0eGateway\u7ed1\u5b9a\uff1f </p> <ul> <li>A VirtualService\u4e2d\u7684hosts\u5b57\u6bb5 </li> <li>B \u5c06VirtualService\u548cGateway\u5728\u540c\u4e00\u6587\u4ef6\u4e2d\u90e8\u7f72 </li> <li>C \u65e0\u6cd5\u505a\u5230 </li> <li>D \u4f7f\u7528gateways\u5b57\u6bb5 </li> </ul> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: hello-world\nspec:\n  hosts:\n    - \"*\"\n  gateways:\n    - gateway\n  http:\n...\n</code></pre> <p>27 \u53ef\u4ee5\u5728VirtualService\u4e2d\u914d\u7f6e\u6d41\u91cf\u7b56\u7565\u3002\u5bf9\u8fd8\u662f\u9519\uff1f </p> <ul> <li>A \u5bf9</li> <li>B \u9519</li> </ul> <p>28 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f</p> <ul> <li>A \u4ec0\u4e48\u4e5f\u4e0d\u4f1a\u53d1\u751f\uff0c\u7aef\u70b9\u4fdd\u6301\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d </li> <li>B Pod\u91cd\u542f </li> <li>C \u4f60\u53ef\u4ee5\u914d\u7f6e\u662f\u5426\u6392\u9664\u7aef\u70b9</li> <li>D \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 </li> </ul> <p>29 \u4f60\u53ef\u4ee5\u7528Workload Entry\u8d44\u6e90\u505a\u4ec0\u4e48\uff1f</p> <ul> <li>A \u5411Pod\u4e2d\u6ce8\u5165\u6545\u969c </li> <li>B \u914d\u7f6e\u5916\u90e8API </li> <li>C \u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5411Kubernetes\u7684\u8fc1\u79fb </li> <li>D \u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6d41\u91cf\u8def\u7531 </li> </ul>"},{"location":"chap8/6Istio_secruity/","title":"\u7b2c\u516d\u8282 Istio Secuirty","text":"<ul> <li>Authentication </li> <li>Authorization </li> <li>Mutual TLS, secure naming and identity </li> <li>Labs: <ul> <li>Enabling mutual TLS </li> <li>Using authorization policies to control access between workloads </li> </ul> </li> <li>Quiz </li> </ul>"},{"location":"chap8/6Istio_secruity/#1authentication","title":"1\u3001\u8ba4\u8bc1(Authentication)","text":"<p>Authentication </p> <ul> <li>Principal = Kubernetes service </li> <li>Action = HTTP request methods (e.g. GET, POST, DELETE, ...) </li> <li> <p>Object = Kubernetes service </p> </li> <li> <p>All about the principal (service identity) </p> </li> <li>\"Validating a credential and ensuring it's both valid and trusted\" </li> </ul> <p>Identity </p> <ul> <li>Unique identity in Kubernetes = Kubernetes service account </li> <li>X.509 certificate (from SA) + SPIFFE spec = Identity <ul> <li>Naming scheme (spiffe://cluster.localinsidefault/sa/my-sa) </li> <li>Encoding names into X.509 </li> <li>Validating the X.509 to authenticate the SPIFFE identity </li> </ul> </li> </ul> <p>\u4e3a\u4e86\u89e3\u91ca\u4ec0\u4e48\u662f\u8ba4\u8bc1\u6216auth\uff0c\u6211\u4eec\u5c06\u4ece\u8bbf\u95ee\u63a7\u5236\u8bd5\u56fe\u56de\u7b54\u7684\u95ee\u9898\u5f00\u59cb\uff1a\u4e00\u4e2a\u4e3b\u4f53\u80fd\u5426\u64cd\u4f5c\u53e6\u4e00\u4e2a\u5bf9\u8c61\uff1f </p> <p>\u5982\u679c\u6211\u4eec\u628a\u4e0a\u8ff0\u95ee\u9898\u6362\u5230Istio\u548cKubernetes\u8bed\u5883\uff0c\u90a3\u5c06\u662f\u201d\u670d\u52a1x\u80fd\u5426\u64cd\u4f5c\u670d\u52a1Y?\" </p> <p>\u8fd9\u4e2a\u95ee\u9898\u7684\u4e09\u4e2a\u5173\u952e\u90e8\u5206\u662f\uff1a\u59d4\u6258\u4eba\u3001\u52a8\u4f5c\u548c\u5bf9\u8c61\u3002 </p> <p>\u4e3b\u4f53\u548c\u5bf9\u8c61\u90fd\u662fKubernetes\u4e2d\u7684\u670d\u52a1\u3002\u52a8\u4f5c\uff0c\u5047\u8bbe\u6211\u4eec\u8c08\u8bba\u7684\u662fHTTP\uff0c\u53ef\u4ee5\u662fGET\u3001POST\u6216\u8005PUT\u4e0b\u8bf7\u6c42\u7b49\u7b49\u3002</p> <p>\u8ba4\u8bc1\u662f\u5173\u4e8e\u59d4\u6258\u4eba\uff08\u6216\u8005\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f\u670d\u52a1\u7684\u8eab\u4efd\uff09\u7684\u3002\u8ba4\u8bc1\u662f\u9a8c\u8bc1\u67d0\u79cd\u51ed\u8bc1\u7684\u884c\u4e3a\uff0c\u5e76\u786e\u4fdd\u8be5\u51ed\u8bc1\u662f\u6709\u6548\u548c\u53ef\u4fe1\u7684\u3002\u4e00\u65e6\u8fdb\u884c\u4e86\u8ba4\u8bc1\uff0c\u6211\u4eec\u5c31\u6709\u4e86\u4e00\u4e2a\u7ecf\u8fc7\u8ba4\u8bc1\u7684\u59d4\u6258\u4eba\u3002\u4e0b\u6b21\u4f60\u65c5\u884c\u65f6\uff0c\u4f60\u5411\u6d77\u5173\u5b98\u5458\u51fa\u793a\u4f60\u7684\u62a4\u7167\u6216\u8eab\u4efd\u8bc1\uff0c\u4ed6\u4eec\u4f1a\u5bf9\u5176\u8fdb\u884c\u8ba4\u8bc1\uff0c\u786e\u4fdd\u4f60\u7684\u51ed\u8bc1\uff08\u62a4\u7167\u6216\u8eab\u4efd\u8bc1\uff09\u662f\u6709\u6548\u548c\u53ef\u4fe1\u7684\u3002 </p> <p>\u5728Kubernetes\u4e2d\uff0c\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u88ab\u5206\u914d\u4e86\u4e00\u4e2a\u72ec\u7279\u7684\u8eab\u4efd\u6765\u4e0e\u5176\u4ed6\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u901a\u4fe1 \u2015\u8be5\u8eab\u4efd\u4ee5\u670d\u52a1\u8d26\u6237\u7684\u5f62\u5f0f\u63d0\u4f9b\u7ed9\u5de5\u4f5c\u8d1f\u8f7d\u3002\u670d\u52a1\u8d26\u6237\u662f\u8fd0\u884c\u65f6\u4e2d\u5b58\u5728\u7684\u8eab\u4efdPod</p> <p>Istio\u4f7f\u7528\u6765\u81ea\u670d\u52a1\u8d26\u6237\u7684<code>X.509</code>\u8bc1\u4e66\uff0c\u5b83\u6839\u636e\u540d\u4e3aSPIFFE\uff08\u6bcf\u4e2a\u4eba\u7684\u5b89\u5168\u751f\u4ea7\u8eab\u4efd\u6846\u67b6\uff09\u7684\u89c4\u8303\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8eab\u4efd\u3002 </p> <p>\u8bc1\u4e66\u4e2d\u7684\u8eab\u4efd\u88ab\u7f16\u7801\u5728\u8bc1\u4e66\u7684<code>Subject alternate name</code>\u5b57\u6bb5\u4e2d\uff0c\u5b83\u770b\u8d77\u6765\u50cf\u8fd9\u6837\u3002</p> <pre><code>spiffe://cluster.local/ns/&lt;pod namespace&gt;/sa/&lt;pod service account&gt;\n</code></pre> <p>\u5f53\u4e24\u4e2a\u670d\u52a1\u5f00\u59cb\u901a\u4fe1\u65f6\uff0c\u5b83\u4eec\u9700\u8981\u4ea4\u6362\u5e26\u6709\u8eab\u4efd\u4fe1\u606f\u7684\u51ed\u8bc1\uff0c\u4ee5\u76f8\u4e92\u9a8c\u8bc1\u81ea\u5df1\u3002\u5ba2\u6237\u7aef\u6839\u636e\u5b89\u5168\u547d\u540d\u4fe1\u606f\u68c0\u67e5\u670d\u52a1\u5668\u7684\u8eab\u4efd\uff0c\u770b\u5b83\u662f\u5426\u662f\u670d\u52a1\u7684\u6388\u6743\u8fd0\u884c\u8005\u3002</p> <p>\u670d\u52a1\u5668\u6839\u636e\u6388\u6743\u7b56\u7565\u786e\u5b9a\u5ba2\u6237\u53ef\u4ee5\u8bbf\u95ee\u54ea\u4e9b\u4fe1\u606f\u3002\u6b64\u5916\uff0c\u670d\u52a1\u5668\u53ef\u4ee5\u5ba1\u8ba1\u8c01\u5728\u4ec0\u4e48\u65f6\u95f4\u8bbf\u95ee\u4e86\u4ec0\u4e48\uff0c\u5e76\u51b3\u5b9a\u662f\u5426\u6279\u51c6\u6216\u62d2\u7edd\u5ba2\u6237\u5bf9\u670d\u52a1\u5668\u7684\u8c03\u7528\u3002 </p> <p>\u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04\u3002</p> <p>\u670d\u52a1\u5668\u8eab\u4efd\u662f\u5728\u8bc1\u4e66\u4e2d\u7f16\u7801\u7684\uff0c\u800c\u670d\u52a1\u540d\u79f0\u662f\u7531\u53d1\u73b0\u670d\u52a1\u6216DNS\u4f7f\u7528\u7684\u540d\u79f0\u3002\u4ece\u4e00\u4e2a\u8eab\u4efdA\u5230\u4e00\u4e2a\u670d\u52a1\u540d\u79f0B\u7684\u5355\u4e00\u6620\u5c04\u610f\u6627\u7740\u201dA\u88ab\u5141\u8bb8\u548c\u6388\u6743\u8fd0\u884c\u670d\u52a1B\"\u3002</p> <p>\u5b89\u5168\u547d\u540d\u4fe1\u606f\u7531Pilot\u751f\u6210\uff0c\u7136\u540e\u5206\u53d1\u7ed9\u6240\u6709sidecar\u4ee3\u7406\u3002 </p>"},{"location":"chap8/6Istio_secruity/#2","title":"2\u3001\u8bc1\u4e66\u521b\u5efa\u548c\u8f6e\u6362","text":"<p>\u5bf9\u4e8e\u7f51\u683c\u4e2d\u7684\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\uff0cIstio\u63d0\u4f9b\u4e00\u4e2a<code>X.509</code>\u8bc1\u4e66\u3002</p> <p>\u4e00\u4e2a\u540d\u4e3a<code>pilot-agent</code>\u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08<code>istiod</code>\uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c\u3002 </p> <p> </p> <p>Certificate creation </p> <ul> <li>Istio Agent </li> <li>Envoy's Secret Discovery Service(SDS) </li> <li>Citadel(part of the control plane) </li> </ul> <p><code>Istio Agent</code>\u4e0e<code>Envoy sidecar</code>\u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c\u3002\u5373\u4fbf<code>Istio</code>\u4ee3\u7406\u5728\u6bcf\u4e2apod\u4e2d\u8fd0\u884c\u6211\u4eec\u4e5f\u8ba4\u4e3a\u5b83\u662f\u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u79d8\u94a5\u53d1\u73b0\u670d\u52a1(SDS)\u7b80\u5316\u4e86\u8bc1\u4e66\u7ba1\u7406\u3002\u5982\u679c\u6ca1\u6709SDS\u8bc1\u4e66\u5fc5\u987b\u4f5c\u4e3a\u79d8\u5bc6(Secret) \u521b\u5efa\uff0c\u7136\u540e\u88c5\u5165\u4ee3\u7406\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002</p> <p>\u5f53\u8bc1\u4e66\u8fc7\u670b\u65f6\uff0c\u9700\u8981\u66f4\u65b0\u79d8\u5bc6\uff0c\u5e76\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u56e0\u4e3aEnvoy\u4e0d\u4f1a\u4ece\u76d8\u52a8\u6001\u91cd\u65b0\u52a0\u8f7d\u8bc1\u4e66\u3002</p> <p>\u5f53\u7528SDS\u65f6SDS\u670d\u52a1\u5668\u5c06\u8bc1\u4e66\u63a8\u9001\u7ed9Envoy\u5b9e\u4f8b\u3002</p> <p>\u6bcf\u5f53\u8bc1\u4e66\u8fc7\u671f\u65f6SDS\u4f1a\u63a8\u9001\u66f4\u65b0\u7684\u8bc1\u4e66Envoy\u53ef\u4ee5\u7acb\u5373\u4fbf\u7528\u5b83\u4eec\u3002\u4e0d\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u670d\u52a1\u5668\u4e5f\u4e0d\u9700\u8981\u4e2d\u65ad\u6d41\u91cf\u3002</p> <p>\u5728Istio\u4e2dIstio Agent\u4f5c\u4e3aSDS\u670d\u52a1\u5668\u5b9e\u73b0\u4e86\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\u63a5\u53e3</p> <p>\u6bcf\u6b21\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u8d26\u6237\u65f6,  Citadel\u90fd\u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2aSPIFFE\u8eab\u4efd\u3002</p> <p>\u6bcf\u5f53\u6211\u4eec\u5b89\u6392\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u65f6\uff0c Pilot\u4f1a\u7528\u5305\u62ec\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\u5728\u5185\u7684\u521d\u6021\u5316\u4fe1\u606f\u6765\u914d\u7f6e\u5176sidecar </p> <p>\u5f53\u5de5\u4f5c\u8d1f\u8f7d\u65c1\u8fb9\u7684Envoy\u4ee3\u7406\u542f\u52a8\u65f6\uff0c \u5b83\u4f1a\u8054\u7cfbIstio\u4ee3\u7406\u5e76\u544a\u8bc9\u5b83\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\u3002\u4ee3\u7406\u9a8c\u8bc1\u8be5\u5b9e\u4f8b\u751f\u6210CSR\uff08\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42Certicate Secret Reuqest\uff09\u5c06CSR\u4ee5\u53ca\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\u8bc1\u660e\uff08\u5728Kubernetes\u4e2d\u662fpod\u7684\u670d\u52a1\u8d26\u6237JWT\uff09\u53d1\u9001\u7ed9Citadel\u3002 </p> <p>Citadel\u5c06\u6267\u884c\u8ba4\u8bc1\u548c\u6388\u6743\u5e76\u4ee5\u7b7e\u540d\u7684<code>X.509</code>\u8bc1\u4e66\u4f5c\u4e3a\u56de\u5e94\u3002Istio\u4ee3\u7406\u4eceCitadel\u83b7\u53d6\u54cd\u5e94\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\u5e76\u901a\u8fc7<code>SDS</code>\u548c<code>Unix</code>\u57df\u5957\u63a5\u5b87\u5c06\u5176\u63d0\u4f9b\u7ed9<code>Envoy</code>\u3002</p> <p>\u5c06\u5bc6\u94a5\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u6bd4\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u66f4\u5b89\u5168\uff1b</p> <p>\u5728\u4f7f\u7528SDS\u65f6\uff0c\u7edd\u4e0d\u4f1a\u5c06\u4efb\u4f55\u5bc6\u94a5\u5199\u5165\u78c1\u76d8\u3002Istio\u4ee3\u7406\u8fd8\u5b9a\u671f\u5237\u65b0\u51ed\u8bc1\uff0c \u5728\u5f53\u524d\u51ed\u8bc1\u8fc7\u670b\u524d\u4eceCitadel\u68c0\u7d22\u4efb\u4f55\u65b0\u7684SVID(SPIFFE\u53ef\u9a8c\u8bc1\u8eab\u4efd\u6587\u4ef6\uff09 </p> <p> </p> <p>SVID\u662f\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u6548\u53ef\u4ee5\u7528\u91c7\u5411\u8d44\u6e90\u6216\u8c03\u7528\u8005\u8bc1\u660e\u5176\u8eab\u4efd\u7684\u6587\u4ef6\u5b83\u5fc5\u987b\u7531\u4e00\u4e2a\u6743\u5a01\u673a\u6784\u7b7e\u53d1\u5e76\u5305\u542b\u4e00\u4e2a<code>SPIEFE ID</code>, \u5b83\u4ee3\u8868\u4e86\u63d0\u51fa\u8be5\u6587\u4ef6\u7684\u670d\u52a1\u7684\u8eab\u4efd</p> <p>\u89e3\u51b3\u65b9\u6848\u662f\u53ef\u6269\u5c55\u7684\u56e0\u4e3a\u6d41\u7a0b\u4e2d\u7684\u6bcf\u4e2a\u7ec4\u4ef6\u53ea\u8d1f\u4ece\u4e00\u90e8\u5206\u5de5\u4f5c\u3002\u4f8b\u5982\uff0c Envoy\u8d1f\u8d23\u8fc7\u671f\u8bc1\u4e66\uff0c istio\u4ee3\u7406\u8d1f\u8d35\u751f\u6210\u79c1\u94a5\u548cCSR. CitadeL\u8d1f\u8d5e\u6388\u6743\u548c\u7b7e\u7f72\u8bc1\u4e66</p>"},{"location":"chap8/6Istio_secruity/#3peer-and-request-authentication","title":"3\u3001Peer and Request Authentication(\u5bf9\u7b49\u8ba4\u8bc1\u548c\u8bf7\u6c42\u8ba4\u8bc1)","text":"<p>Peer authentication</p> <ul> <li>Peer authentication </li> <li>service-to-service </li> </ul> <p>All mTLS about the communication between services</p> <p>Request authentication </p> <ul> <li>end user authentication </li> <li>uses JWTs </li> </ul>"},{"location":"chap8/6Istio_secruity/#3-1-istio","title":"3-1 Istio\u63d0\u4f9b\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1a\u5bf9\u7b49\u8ba4\u8bc1\u548c\u8bf7\u6c42\u8ba4\u8bc1","text":""},{"location":"chap8/6Istio_secruity/#3-2","title":"3-2 \u5bf9\u7b49\u8ba4\u8bc1","text":"<p>\u5bf9\u7b49\u8ba4\u8bc1\u7528\u4e8e\u670d\u52a1\u95f4\u7684\u8ba4\u8bc1\uff0c\u4ee5\u9a8c\u8bc1\u5efa\u7acb\u8fde\u63a5\u7684\u5ba2\u6237\u7aef\u3002 </p> <p>\u5f53\u4e24\u4e2a\u670d\u52a1\u8bd5\u56fe\u8fdb\u884c\u901a\u4fe1\u65f6\uff0c\u53cc\u5411TLS\u8981\u6c42\u5b83\u4eec\u90fd\u5411\u5bf9\u65b9\u63d0\u4f9b\u8bc1\u4e66\uff0c\u56e0\u6b64\u53cc\u65b9\u90fd\u77e5\u9053\u5b83\u4eec\u5728\u4e0e\u8c01\u4ea4\u8c08\u3002</p> <p>\u5982\u679c\u6211\u4eec\u60f3\u5728\u670d\u52a1\u4e4b\u95f4\u542f\u7528\u4e25\u683c\u7684\u53cc\u5411TLS\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>PeerAuthentication</code>\u8d44\u6e90\uff0c\u5c06<code>mTLS</code>\u6a21\u5f0f\u8bbe\u7f6e\u4e3a<code>STRICT</code>\u3002 </p> <p>\u4f7f\u7528PeerAuthentication\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u7684\u53cc\u5411TLS(mTLS)\uff0c\u800c\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u4ee3\u7801\u4fee\u6539\u3002 </p> <p>\u7136\u800c\uff0cIstio\u4e5f\u652f\u6301\u4e00\u79cd\u4f18\u96c5\u7684\u6a21\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u5728\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6216\u547d\u540d\u7a7a\u95f4\u5185\u8fdb\u5165\u53cc\u5411TLS\u3002\u8fd9\u79cd\u6a21\u5f0f\u88ab\u79f0\u4e3a\u8bb8\u53ef\u6a21\u5f0f\u3002 </p> <ul> <li>\u5f53\u4f60\u5b89\u88c5Istio\u65f6\uff0c\u8bb8\u53ef\u6a21\u5f0f\u662f\u9ed8\u8ba4\u542f\u7528\u7684\u3002</li> <li>\u542f\u7528\u8bb8\u53ef\u6a21\u5f0f\u540e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u8bd5\u56fe\u901a\u8fc7\u53cc\u5411TLS\u8fde\u63a5\u5230\u6211\uff0cIstio\u5c06\u63d0\u4f9b\u53cc\u5411TLS\u3002</li> <li>\u5982\u679c\u5ba2\u6237\u7aef\u4e0d\u4f7f\u7528\u53cc\u5411TLS, Istio\u4e5f\u53ef\u4ee5\u7528\u7eaf\u6587\u672c\u54cd\u5e94\u3002 </li> <li>\u4f60\u53ef\u4ee5\u5141\u8bb8\u5ba2\u6237\u7aef\u505a\u6216\u4e0d\u505amTLS\u3002\u4f7f\u7528\u8fd9\u79cd\u6a21\u5f0f\uff0c\u4f60\u53ef\u4ee5\u5728\u4f60\u7684\u670d\u52a1\u7f51\u683c\u4e2d\u9010\u6e10\u63a8\u51fa\u53cc\u5411TLS\u3002 </li> </ul> <p>\u7b80\u800c\u8a00\u4e4b\uff0c<code>PeerAuthentication</code>\u8c08\u8bba\u7684\u662f\u5de5\u4f5c\u8d1f\u8f7d\u6216\u670d\u52a1\u7684\u901a\u4fe1\u65b9\u5f0f\uff0c\u5b83\u5e76\u6ca1\u6709\u8bf4\u5230\u6700\u7ec8\u7528\u6237\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u600e\u6837\u624d\u80fd\u8ba4\u8bc1\u7528\u6237\u5462\uff1f </p>"},{"location":"chap8/6Istio_secruity/#3-3","title":"3-3 \u8bf7\u6c42\u8ba4\u8bc1","text":"<p>\u8bf7\u6c42\u8ba4\u8bc1\uff08<code>RequestAuthentication</code>\u8d44\u6e90\uff09\u9a8c\u8bc1\u4e86\u9644\u52a0\u5728\u8bf7\u6c42\u4e0a\u7684\u51ed\u8bc1\uff0c\u5b83\u88ab\u7528\u4e8e\u7ec8\u7aef\u7528\u6237\u8ba4\u8bc1\u3002 </p> <p>\u8bf7\u6c42\u7ea7\u8ba4\u8bc1\u662f\u901a\u8fc7<code>JSON Web Tokens (JWT)</code>\u9a8c\u8bc1\u5b8c\u6210\u7684\u3002</p> <p>Istio\u652f\u6301\u4efb\u4f55<code>OpenID Connect</code>\u63d0\u4f9b\u5546\uff0c\u5982AuthO\u3001 Firebase\u6216Google Auth\u3001Keycloak\u3001ORY Hydra\u3002\u56e0\u6b64\uff0c\u5c31\u50cf\u6211\u4eec\u4f7f\u7528SPIFFE\u8eab\u4efd\u6765\u9a8c\u8bc1\u670d\u52a1\u4e00\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528JWT\u4ee4\u724c\u6765\u9a8c\u8bc1\u7528\u6237\u3002 </p>"},{"location":"chap8/6Istio_secruity/#4tls","title":"4\u3001\u53cc\u5411TLS","text":"<p>Mutual TLS(mTLS) </p> <ul> <li>Traffic is re-routed through proxies </li> <li> <p>Envoy starts an mTLS handshake </p> <ul> <li>Secure naming check is done </li> </ul> </li> <li> <p>Once mTLS connection is established: </p> <ul> <li>Request is forwarded to server-side proxy </li> <li>Server-side forwards traffic to the workload </li> </ul> </li> </ul> <p>mTLS Behavior </p> <ul> <li>DISABLE: no TLS connection </li> <li>SIMPLE: originate to the upstream </li> <li>MUTUAL: uses mTLS and certs for auth </li> <li><code>ISTIO_MUTUAL</code>: like MUTUAL; but uses Istlo's certs for mTLS </li> </ul> <p>Permissive mode</p> <ul> <li>Allows services to accpet both plaintext and mTLS </li> <li>Improves mTLS onboarding experience </li> <li>Gradually Install/configure sidecars for mTLS </li> </ul>"},{"location":"chap8/6Istio_secruity/#4-1-tls","title":"4-1 \u53cc\u5411TLS","text":"<p>\u670d\u52a1\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u7684\u901a\u4fe1\u662f\u901a\u8fc7Envoy\u4ee3\u7406\u8fdb\u884c\u7684\u3002\u5f53\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u4f7f\u7528mTLS\u5411\u53e6\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u53d1\u9001\u8bf7\u6c42\u65f6\uff0cIstio\u4f1a\u5c06\u6d41\u91cf\u91cd\u65b0\u8def\u7531\u5230sidecar\u4ee3\u7406\uff08Envoy)\u3002 </p> <p>\u7136\u540e\uff0c<code>sidecar Envoy</code>\u5f00\u59cb\u4e0e\u670d\u52a1\u5668\u7aef\u7684<code>Envoy</code>\u8fdb\u884c<code>mTLS</code>\u63e1\u624b\u3002 </p> <p>\u5728\u63e1\u624b\u8fc7\u7a0b\u4e2d\uff0c\u8c03\u7528\u8005\u4f1a\u8fdb\u884c\u5b89\u5168\u547d\u540d\u68c0\u67e5\uff0c\u4ee5\u9a8c\u8bc1\u670d\u52a1\u5668\u8bc1\u4e66\u4e2d\u7684\u670d\u52a1\u8d26\u6237\u662f\u5426\u88ab\u6388\u6743\u8fd0\u884c\u76ee\u6807\u670d\u52a1\u3002\u4e00\u65e6<code>mTLS</code>\u8fde\u63a5\u5efa\u7acb\uff0c<code>Istio</code>\u5c31\u4f1a\u5c06\u8bf7\u6c42\u4ece\u5ba2\u6237\u7aef\u7684<code>Envoy</code>\u4ee3\u7406\u8f6c\u53d1\u5230\u670d\u52a1\u5668\u7aef\u7684<code>Envoy</code>\u4ee3\u7406\u3002</p> <p>\u5728\u670d\u52a1\u5668\u7aef\u7684\u6388\u6743\u540e\uff0csidecar\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u5de5\u4f5c\u8d1f\u8f7d\u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u670d\u52a1\u7684\u76ee\u6807\u89c4\u5219\u4e2d\u6539\u53d8mTLS\u884c\u4e3a\u3002</p> <ul> <li>\u652f\u6301\u7684TLS\u6a21\u5f0f\u6709\uff1a<code>DISABLE\uff08\u65e0TLS\u8fde\u63a5\uff09</code></li> <li><code>SIMPLE</code>\uff08\u5411\u4e0a\u6e38\u7aef\u70b9\u53d1\u8d77TLS\u8fde\u63a5)</li> <li><code>MUTUAL</code>\uff08\u901a\u8fc7\u51fa\u793a\u5ba2\u6237\u7aef\u8bc1\u4e66\u8fdb\u884c\u8ba4\u8bc1\u6765\u4f7f\u7528 mTLS)</li> <li><code>ISTIO MUTUAL</code>\uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f46\u4f7f\u7528Istio\u81ea\u52a8\u751f\u6210\u7684\u8bc1\u4e66\u8fdb\u884cmTLS)</li> </ul>"},{"location":"chap8/6Istio_secruity/#4-2","title":"4-2 \u5141\u8bb8\u6a21\u5f0f","text":"<p>\u5141\u8bb8\u6a21\u5f0f\uff08Permissive Mode)\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u9009\u9879\uff0c\u5b83\u5141\u8bb8\u4e00\u4e2a\u670d\u52a1\u540c\u65f6\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u91cf\u548c <code>mTLS</code>\u6d41\u91cf\u3002\u8fd9\u4e2a\u529f\u80fd\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u6539\u5584<code>mTLS</code>\u7684\u7528\u6237\u4f53\u9a8c\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\u4f7f\u7528\u5141\u8bb8\u6a21\u5f0f\u914d\u7f6e\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u3002Istio\u8ddf\u8e2a\u4f7f\u7528Istio\u4ee3\u7406\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5e76\u81ea\u52a8\u5411\u5176\u53d1\u9001mTLS\u6d41\u91cf\u3002\u5982\u679c\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709\u4ee3\u7406\uff0cIstio\u5c06\u53d1\u9001\u7eaf\u6587\u672c\u6d41\u91cf\u3002 </p> <p>\u5f53\u4f7f\u7528\u5141\u8bb8\u6a21\u5f0f\u65f6\uff0c\u670d\u52a1\u5668\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u91cf\u548cmTLS\u6d41\u91cf\uff0c\u4e0d\u4f1a\u7834\u574f\u4efb\u4f55\u4e1c\u897f\u3002\u5141\u8bb8\u6a21\u5f0f\u7ed9\u4e86\u6211\u4eec\u65f6\u95f4\u6765\u5b89\u88c5\u548c\u914d\u7f6e<code>sidecar</code>\uff0c\u4ee5\u9010\u6b65\u53d1\u9001<code>mTLS</code>\u6d41\u91cf\u3002</p> <p>\u4e00\u65e6\u6240\u6709\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u5b89\u88c5\u4e86<code>sidecar</code>\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5207\u6362\u5230\u4e25\u683c\u7684<code>mTLS</code>\u6a21\u5f0f\u3002\u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a<code>PeerAuthentication</code>\u8d44\u6e90\u3002\u6211\u4eec\u53ef\u4ee5\u9632\u6b62\u975e\u53cc\u5411<code>TLS</code>\u6d41\u91cf\uff0c\u5e76\u8981\u6c42\u6240\u6709\u901a\u4fe1\u90fd\u4f7f\u7528mTLS</p> <p>\u6211\u4eec\u53ef\u4ee5\u521b\u5efa<code>PeerAuthentication</code>\u8d44\u6e90\uff0c\u9996\u5148\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5206\u522b\u6267\u884c\u4e25\u683c\u6a21\u5f0f\u3002\u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u547d\u540d\u7a7a\u95f4\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f<code>istio-system</code>)\u521b\u5efa\u4e00\u4e2a\u7b56\u7565\uff0c\u5728\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u4e2d\u6267\u884c\u8be5\u7b56\u7565\uff1a </p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: PeerAuthentication\nmetadata:\n  name: default\n  namespace: istio-system\nspec:\n  mtls:\n   mode: STRICT\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6307\u5b9a<code>selector</code>\u5b57\u6bb5\uff0c\u5c06\u7b56\u7565\u4ec5\u5e94\u7528\u4e8e\u7f51\u683c\u4e2d\u7684\u7279\u5b9a\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4e0b\u9762\u7684\u4f8b\u5b50 \u5bf9\u5177\u6709\u6307\u5b9a\u6807\u7b7e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u542f\u7528<code>STRICT</code>\u6a21\u5f0f\uff1a </p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: PeerAuthentication\nmetadata:\n  name: default\n  namespace: my-namespace\nspec:\n  selector:\n   matchLabels:\n    app: customers\n  mtls:\n   mode: STRICT\n</code></pre>"},{"location":"chap8/6Istio_secruity/#5","title":"5\u3001 \u6388\u6743","text":""},{"location":"chap8/6Istio_secruity/#authorization","title":"Authorization","text":"<ul> <li>Can user A send a GET request to <code>/hello</code> on service B? </li> <li>Authn without authz (and vice-versa) is useless </li> <li>Control authenticated principals with AuthorizationPolicy </li> </ul>"},{"location":"chap8/6Istio_secruity/#authorization-policy","title":"Authorization policy","text":"<ul> <li> <p>Make use of identities extracted from PeerAuthentication and RequestAuthentication: </p> <ul> <li>requestPrincipals (users) </li> <li>principals (service/peer) </li> </ul> </li> <li> <p>Defined at mesh, namespace, and workload level </p> </li> </ul>"},{"location":"chap8/6Istio_secruity/#authorization-policy_1","title":"Authorization policy","text":"<ul> <li>Workloads policy applies to </li> <li>Action to take (deny, allow, or audit) </li> <li>Rules when to take action </li> </ul>"},{"location":"chap8/6Istio_secruity/#5-1","title":"5-1 \u6388\u6743","text":"<p>\u6388\u6743\u662f\u5bf9\u8bbf\u95ee\u63a7\u5236\u95ee\u9898\u4e2d\u8bbf\u95ee\u63a7\u5236\u90e8\u5206\u7684\u54cd\u5e94\u3002\u67d0\u4e2a\uff08\u7ecf\u8fc7\u8ba4\u8bc1\u7684\uff09\u4e3b\u4f53\u662f\u5426\u88ab\u5141\u8bb8\u64cd\u4f5c\u67d0\u4e2a\u5bf9\u8c61\uff1f\u7528\u6237A\u80fd\u5426\u5411\u670d\u52a1B\u7684\u8def\u5f84<code>/hello</code>\u53d1\u9001\u4e00\u4e2aGET\u8bf7\u6c42\uff1f </p> <p>\u8bf7\u6ce8\u610f\uff0c\u5c3d\u7ba1\u4e3b\u4f53\u53ef\u4ee5\u88ab\u8ba4\u8bc1\uff0c\u4f46\u5b83\u53ef\u80fd\u4e0d\u88ab\u5141\u8bb8\u6267\u884c\u67d0\u4e2a\u52a8\u4f5c\u3002\u4f60\u7684\u516c\u53f8\u65e7\u5361\u53ef\u80fd\u662f\u6709\u6548\u7684\u3001\u771f\u5b9e\u7684\uff0c\u4f46\u6211\u4e0d\u80fd\u7528\u5b83\u6765\u8fdb\u5165\u53e6\u4e00\u5bb6\u516c\u53f8\u7684\u529e\u516c\u5ba4\u3002\u5982\u679c\u6211\u4eec\u7ee7\u7eed\u4e4b\u524d\u7684\u6d77\u5173\u5b98\u5458\u7684\u6bd4\u55bb\uff0c\u6211\u4eec\u53ef\u4ee5\u8bf4\u6388\u6743\u7c7b\u4f3c\u4e8e\u4f60\u62a4\u7167\u4e0a\u7684\u7b7e\u8bc1\u7ae0\u3002</p> <p>\u8fd9\u5c31\u5f15\u51fa\u4e86\u4e0b\u4e00\u4e2a\u95ee\u9898\u2014\u2014\u6709\u8ba4\u8bc1\u800c\u65e0\u6388\u6743\uff08\u53cd\u4e4b\u4ea6\u7136\uff09\u5bf9\u6211\u4eec\u6ca1\u6709\u4ec0\u4e48\u597d\u5904\u3002\u5bf9\u4e8e\u9002\u5f53\u7684\u8bbf\u95ee\u63a7\u5236\uff0c\u6211\u4eec\u9700\u8981\u4e24\u8005\u3002</p> <p>\u8ba9\u6211\u7ed9\u4f60\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5982\u679c\u6211\u4eec\u53ea\u8ba4\u8bc1\u4e3b\u4f53\u800c\u4e0d\u6388\u6743\u4ed6\u4eec\uff0c\u4ed6\u4eec\u5c31\u53ef\u4ee5\u505a\u4efb\u4f55\u4ed6\u4eec\u60f3\u505a\u7684\u4e8b\uff0c\u5bf9\u4efb\u4f55\u5bf9\u8c61\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002\u76f8\u53cd\uff0c\u5982\u679c\u6211\u4eec\u6388\u6743\u4e86\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f46\u6211\u4eec\u6ca1 \u6709\u8ba4\u8bc1\u5b83\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5047\u88c5\u6210\u5176\u4ed6\u4eba\uff0c\u518d\u6b21\u5bf9\u4efb\u4f55\u5bf9\u8c61\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002 </p> <p>Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528<code>AuthorizationPolicy</code>\u8d44\u6e90\u5728\u7f51\u683c\u3001\u547d\u540d\u7a7a\u95f4\u548c\u5de5\u4f5c\u8d1f\u8f7d\u5c42\u9762\u5b9a\u4e49\u8bbf\u95ee\u63a7\u5236\u3002<code>AuthorizationPolicy</code> \u652f\u6301<code>DENY</code>\u3001<code>ALLOW</code>\u3001 <code>AUDIT</code>\u548c<code>CUSTOM</code>\u64cd\u4f5c\u3002</p> <p>\u6bcf\u4e2a<code>Envoy</code>\u4ee3\u7406\u5b9e\u4f8b\u90fd\u8fd0\u884c\u4e00\u4e2a\u6388\u6743\u5f15\u64ce\uff0c\u5728\u8fd0\u884c\u65f6\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6388\u6743\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe\u4ee3\u7406\u65f6\uff0c\u5f15\u64ce\u4f1a\u6839\u636e\u6388\u6743\u7b56\u7565\u8bc4\u4f30\u8bf7\u6c42\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u8fd4\u56de<code>ALLOW</code>\u6216<code>DENY</code>\u3002</p> <p><code>AUDIT</code>\u52a8\u4f5c\u51b3\u5b9a\u662f\u5426\u8bb0\u5f55\u7b26\u5408\u89c4\u5219\u7684\u8bf7\u6c42\u3002\u6ce8\u610f<code>AUDIT</code>\u7b56\u7565\u5e76\u4e0d\u5f71\u54cd\u8bf7\u6c42\u88ab\u5141\u8bb8\u6216\u62d2\u7edd\u3002</p> <p>\u6ca1\u6709\u5fc5\u8981\u660e\u786e\u5730\u542f\u7528\u6388\u6743\u529f\u80fd\u3002 \u4e3a\u4e86\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u6765\u5e94\u7528\u4e8e\u6211\u4eec\u7684\u5de5\u4f5c\u8d1f\u8f7d <code>AuthorizationPolicy</code>\u8d44\u6e90\u662f\u6211\u4eec\u53ef\u4ee5\u5229\u7528<code>PeerAuthentication</code>\u7b56\u7565\u548c<code>RequestAuthentication</code>\u7b56\u7565\u4e2d\u7684\u4e3b\u4f53\u7684\u5730\u65b9\u3002 </p> <p>\u5728\u5b9a\u4e49<code>Authorizationpolicy</code>\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u8003\u8651\u4e09\u4e2a\u90e8\u5206\uff0e </p> <ul> <li>\u9009\u62e9\u8981\u5e94\u7528\u8be5\u7b56\u7565\u7684\u5de5\u4f5c\u8d1f\u8f7d </li> <li>\u8981\u91c7\u53d6\u7684\u884c\u52a8\uff08\u62d2\u7edd\u3001\u5141\u8bb8\u6216\u5ba1\u8ba1\uff09 </li> <li>\u91c7\u53d6\u8be5\u884c\u52a8\u7684\u89c4\u5219 </li> </ul> <p>\u6211\u4eec\u770b\u770b\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u5982\u4f55\u4e0e<code>Authonizationpolicy</code>\u8d44\u6e90\u4e2d\u7684\u5b57\u6bb5\u76f8\u5bf9\u5e94\uff0e</p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n name: customers-deny\n namespace: default\nspec:\n selector:\n  matchLabels:\n   app: customers\n   version: v2\n action: DENY\n rules:\n - from:\n  - source:\n    notNamespaces: [\"default\"]\n</code></pre> <p>\u4f7f\u7528<code>selector</code>\u548c<code>matchLabels</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u7b56\u7565\u6240\u9002\u7528\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002</p> <p>\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u6211\u4eec\u9009\u62e9\u7684\u662f\u6240\u6709\u8bbe\u7f6e\u4e86<code>app: customers</code>\u548c<code>version: v2</code>\u6807\u7b7e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002<code>action</code>\u5b57\u6bb5\u88ab\u8bbe\u7f6e\u4e3a<code>DENY</code></p> <p>\u6700\u540e\uff0c\u6211\u4eec\u5728<code>rules</code>\u5b57\u6bb5\u4e2d\u5b9a\u4e49\u6240\u6709\u89c4\u5219\u3002\u6211\u4eec\u4f8b\u5b50\u4e2d\u7684\u89c4\u5219\u662f\u8bf4\uff0c\u5f53\u8bf7\u6c42\u6765\u81ea<code>default</code>\u547d\u540d\u7a7a\u95f4\u4e4b\u5916\u65f6\u62d2\u7edd<code>customers v2</code>\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8bf7\u6c42(action)\u3002</p> <p>\u9664\u4e86\u89c4\u5219\u4e2d\u7684from\u5b57\u6bb5\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>to</code>\u548c<code>when</code>\u5b57\u6bb5\u8fdb\u4e00\u6b65\u5b9a\u5236\u89c4\u5219\u3002\u8ba9\u6211\u4eec\u770b\u4e00\u4e2a\u4f7f\u7528\u8fd9\u4e9b\u5b57\u6bb5\u7684\u4f8b\u5b50 </p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n name: customers-deny\n namespace: default\nspec:\n selector:\n  matchLabels:\n   app: customers\n   version: v2\n action: DENY\n rules:\n - from:\n  - source:\n    notNamespaces: [\"default\"]\n - to:\n   - operation:\n     methods: [\"GET\"]\n - when:\n   - key: request.headers [User-Agent]\n    values: [\"Mozilla/*\"]\n</code></pre> <p>\u6211\u4eec\u5728\u89c4\u5219\u90e8\u5206\u6dfb\u52a0\u4e86<code>to</code>\u548c<code>when</code>\u5b57\u6bb5\u3002\u5982\u679c\u6211\u4eec\u7ffb\u8bd1\u4e00\u4e0b\u4e0a\u9762\u7684\u89c4\u5219\uff0c\u6211\u4eec\u53ef\u4ee5\u8bf4\uff0c\u5f53\u5ba2\u6237\u7684GET\u8bf7\u6c42\u6765\u81ea<code>default</code>\u547d\u540d\u7a7a\u95f4\u4e4b\u5916\uff0c\u5e76\u4e14<code>User Agent</code>\u5934\u7684\u503c\u4e0e\u6b63\u5219\u8868\u8fbe\u5f0f<code>Mozilla/*</code>\u76f8\u5339\u914d\u65f6\uff0c\u6211\u4eec\u4f1a\u62d2\u7edd<code>customers v2</code>\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 </p> <p>\u603b\u7684\u6765\u8bf4\uff0c<code>to</code>\u5b9a\u4e49\u4e86\u7b56\u7565\u6240\u5141\u8bb8\u7684\u884c\u52a8\uff0c<code>from</code>\u5b9a\u4e49\u4e86\u8c01\u53ef\u4ee5\u91c7\u53d6\u8fd9\u4e9b\u884c\u52a8\uff0c<code>when</code>\u5b9a\u4e49\u4e86\u6bcf\u4e2a\u8bf7\u6c42\u5fc5\u987b\u5177\u5907\u7684\u5c5e\u6027\uff0c\u4ee5\u4fbf\u88ab\u7b56\u7565\u6240\u5141\u8bb8\uff0c<code>selector</code>\u5b9a\u4e49\u4e86\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u5c06\u6267\u884c\u8be5\u7b56\u7565\u3002 </p> <p>\u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c\u5219\u9996\u5148\u8bc4\u4f30\u62d2\u7edd\u7684\u7b56\u7565\u3002\u8bc4\u4f30\u9075\u5faa\u8fd9\u4e9b\u89c4\u5219\uff1a </p> <ol> <li>\u5982\u679c\u6709\u4e0e\u8bf7\u6c42\u76f8\u5339\u914d\u7684<code>DENY</code>\u7b56\u7565\uff0c\u5219\u62d2\u7edd\u8be5\u8bf7\u6c42 </li> <li>\u5982\u679c\u6ca1\u6709\u9002\u5408\u8be5\u5de5\u4f5c\u8d1f\u8f7d\u7684<code>ALLOW</code>\u7b56\u7565\uff0c\u5219\u5141\u8bb8\u8be5\u8bf7\u6c42 </li> <li>\u5982\u679c\u6709\u4efb\u4f55<code>ALLOW</code>\u7b56\u7565\u4e0e\u8be5\u8bf7\u6c42\u76f8\u5339\u914d\uff0c\u5219\u5141\u8bb8\u8be5\u8bf7\u6c42\uff0e </li> <li>\u62d2\u7edd\u8be5\u8bf7\u6c42 </li> </ol>"},{"location":"chap8/6Istio_secruity/#5-2","title":"5-2 \u6765\u6e90","text":"<p>\u6211\u4eec\u5728\u4e0a\u8ff0\u4f8b\u5b50\u4e2d\u4f7f\u7528\u7684\u6e90\u662f<code>notNameepaces</code>\uff0e\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u4efb\u4f55\u4e00\u4e2a\u5b57\u6bb5\u6765\u6307\u5b9a\u8bf7\u6c42\u7684\u6765\u6e90\u5982\u8868\u4e2d\u6240\u793a\uff0e</p> <p> </p>"},{"location":"chap8/6Istio_secruity/#5-4","title":"5-4 \u64cd\u4f5c","text":"<p>\u64cd\u4f5c\u88ab\u5b9a\u4e49\u5728<code>to</code>\u5b57\u6bb5\u4e0b\uff0c\u5982\u679c\u591a\u4e8e\u4e00\u4e2a\uff0c\u5219\u4f7f\u7528AND\u8bed\u4e49\u3002\u5c31\u50cf\u6765\u6e90\u4e00\u6837\uff0c\u64cd\u4f5c\u662f\u6210\u5bf9\u7684\uff0c\u6709\u6b63\u53cd\u4e24\u9762\u7684\u5339\u914d\u3002\u8bbe\u7f6e\u5728\u64cd\u4f5c\u5b57\u6bb5\u7684\u503c\u662f\u5b57\u7b26\u4e32</p> <ul> <li><code>hosts</code>\u548c<code>notHosts</code> </li> <li><code>ports</code>\u548c<code>notPorts</code> </li> <li><code>methods</code>\u548c<code>notMethods</code> </li> <li><code>paths</code>\u548c<code>notPath</code> </li> </ul> <p>\u6240\u6709\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u9002\u7528\u4e8e\u8bf7\u6c42\u5c5e\u965b\u3002\u4f8b\u5982\uff0c\u8981\u5728\u4e00\u4e2a\u7279\u5b9a\u7684\u8bf7\u6c42\u8def\u5f84\u4e0a\u8fdb\u884c\u5339\u914d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8def\u5f84\u3002<code>\uff3b\"/api/*\",\"/admin\"\uff3d</code>\u6216\u7279\u5b9a\u7684\u7aef\u53e3<code>ports: [\"8080\"]</code>\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002 </p>"},{"location":"chap8/6Istio_secruity/#5-5","title":"5-5 \u6761\u4ef6","text":"<p>\u4e3a\u4e86\u6307\u5b9a\u6761\u4ef6\uff0c\u6211\u4eec\u5fc5\u987b\u63d0\u4f9b\u4e00\u4e2a<code>key</code>\u5b57\u6bb5\u3002<code>key</code>\u5b57\u6bb5\u662f\u4e00\u4e2a<code>Istio</code>\u5c5e\u6027\u7684\u540d\u79f0\u3002\u4f8b\u5982\uff0c<code>requsst.headers</code>\u3001 <code>source.ip</code>\u3001 <code>destinatisn.port</code>\u7b49\u7b49\u3002</p> <p>\u6761\u4ef6\u7684\u7b2c\u4e8c\u90e8\u5206\u662f<code>values</code>\u6216<code>notValues</code>\u7684\u5b57\u7b26\u4e32\u5217\u8868\u3002\u4e0b\u9762\u662f\u4e00\u4e2a<code>when</code>\u6761\u4ef6\u7684\u7247\u6bb5\uff1a </p> <pre><code>...\n - when:\n   - key: source.ip\n    notValues: [\"10.0.1.1\"]\n</code></pre>"},{"location":"chap8/6Istio_secruity/#61-mtls","title":"6\u3001\u5b9e\u9a8c1 \u542f\u7528mTLS","text":"<p>\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u90e8\u7f72\u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\uff08WebFrontend\u548cCustomers\u670d\u52a1\uff09\u3002Web\u524d\u7aef\u7684\u90e8\u7f72\u5c06\u4e0d\u5305\u542bEnvoy\u4ee3\u7406sidecar\uff0c\u800cCustomers\u670d\u52a1\u5c06\u88ab\u6ce8\u5165sidecar\u3002\u901a\u8fc7\u8fd9\u4e2a\u8bbe\u7f6e\uff0c\u6211\u4eec\u5c06\u770b\u5230Istio\u5982\u4f55\u540c\u65f6\u53d1\u9001mTLS\u548c\u7eaf\u6587\u672c\u6d41\u91cf\uff0c\u4ee5\u53ca\u5982\u4f55\u5c06TLS\u6a21\u5f0f\u6539\u4e3aSTRICT\u3002 </p> <p>\u8ba9\u6211\u4eec\u4ece\u90e8\u7f72\u4e00\u4e2aGateway\u8d44\u6e90\u5f00\u59cb\uff1a </p> <p><code>1gateway.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n        - '*'\n</code></pre> <pre><code>$ kubectl apply -f 1gateway.yaml \ngateway.networking.istio.io/gateway created\n\n\n$ kubectl get gateway\nNAME      AGE\ngateway   2m41s\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u521b\u5efa<code>WebFrontend</code>\u548c<code>Customers</code>\u670d\u52a1\u7684\u90e8\u7f72\u4ee5\u53ca\u76f8\u5173\u7684<code>Kubernetes</code>\u5728\u670d\u52a1\u3002\u5f00\u59cb\u90e8\u7f72\u4e4b\u524d\uff0c\u6211\u4eec\u5c06\u7981\u7528<code>default</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u81ea\u52a8<code>sidecar</code>\u6ce8\u5165\uff0c \u8fd9\u6837\u4ee3\u7406\u5c31\u4e0d\u88ab\u6ce8\u5165\u5230<code>Web</code>\u524d\u7aef\u90e8\u7f72\u4e2d\u3002\u5728\u6211\u4eec\u90e8\u7f72<code>Customers</code>\u670d\u52a1\u4e4b\u524d\uff0c\u6211\u4eec\u5c06\u518d\u6b21\u542f\u7528\u6ce8\u5165\u3002 </p> <pre><code>$ kubectl label namespace default istio-injection-\nnamespace/default labeled\n</code></pre> <p>\u7981\u7528\u6ce8\u5165\u540e\uff0c\u90e8\u7f72<code>web-frontend</code></p> <p><code>2webfrontend.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: web-frontend\n  template:\n    metadata:\n      labels:\n        app: web-frontend\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/web-frontend:1.0.0\n          imagePullPolicy: Always\n          name: web\n          ports:\n            - containerPort: 8080\n          env:\n            - name: CUSTOMER_SERVICE_URL\n              value: 'http://customers.default.svc.cluster.local'\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  selector:\n    app: web-frontend\n  ports:\n    - port: 80\n      name: http\n      targetPort: 8080\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: web-frontend\nspec:\n  hosts:\n    - '*'\n  gateways:\n    - gateway\n  http:\n    - route:\n        - destination:\n            host: web-frontend.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <p><code>3customersv1.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: customers-v1\n  labels:\n    app: customers\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: customers\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: customers\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/customers:1.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: customers\n  labels:\n    app: customers\nspec:\n  selector:\n    app: customers\n  ports:\n    - port: 80\n      name: http\n      targetPort: 3000\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n\n</code></pre> <pre><code>$ kubectl apply -f 2webfrontend.yaml \ndeployment.apps/web-frontend created\nservice/web-frontend created\nvirtualservice.networking.istio.io/web-frontend created\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u770b\u4e00\u4e0b\u6b63\u5728\u8fd0\u884c\u7684Pod\uff0c\u6211\u4eec\u5e94\u8be5\u770b\u5230\u6709\u4e00\u4e2aPod\u6b63\u5728\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\uff0c\u7531READY\u680f\u4e2d\u76841/1\u8868\u793a\uff1a </p> <pre><code>$ kubectl get pod\nNAME                            READY   STATUS    RESTARTS   AGE\nweb-frontend-69b64f974c-cr79v   1/1     Running   0          29s\n</code></pre> <p>\u542f\u7528\u81ea\u52a8\u6ce8\u5165\uff1a </p> <pre><code>$ kubectl label namespace default istio-injection=enabled\nnamespace/default labeled\n</code></pre> <p>\u90e8\u7f72Customers\u670d\u52a1\u7684<code>v1</code>\u7248\u672c </p> <p><code>3customersv1.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: customers-v1\n  labels:\n    app: customers\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: customers\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: customers\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/customers:1.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: customers\n  labels:\n    app: customers\nspec:\n  selector:\n    app: customers\n  ports:\n    - port: 80\n      name: http\n      targetPort: 3000\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <pre><code>$ kubectl apply -f 3customersv1.yaml \ndeployment.apps/customers-v1 created\nservice/customers created\nvirtualservice.networking.istio.io/customers created\n</code></pre> <pre><code>$ kubectl get pod\nNAME                            READY   STATUS    RESTARTS   AGE\ncustomers-v1-7b5b4b76fc-zttpn   2/2     Running   0          21s\nweb-frontend-69b64f974c-cr79v   1/1     Running   0          21m\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u4ece<code>GATEWAY_URL</code>\u8bbf\u95ee\u7f51\u9875\uff0c\u6211\u4eec\u4f1a\u5f97\u5230\u5e26\u6709\u5ba2\u670d\u4eba\u5458\u56de\u5e94\u7684\u7f51\u9875\u3002 </p> <p> </p> <p>\u8bbf\u95ee<code>GATEWAY_URL</code>\u4e4b\u6240\u4ee5\u6709\u6548\uff0c\u662f\u56e0\u4e3a\u91c7\u7528\u4e86\u8bb8\u53ef\u6a21\u5f0f\uff0c\u7eaf\u6587\u672c\u6d41\u91cf\u88ab\u53d1\u9001\u5230\u6ca1\u6709\u4ee3\u7406\u7684\u670d\u52a1\u3002\u5728\u8fd9\u79cd\u6e05\u51b5\u4e0b\uff0c\u5165\u53e3\u7f51\u5173\u5c06\u7eaf\u6587\u672c\u6d41\u91cf\u53d1\u9001\u5230Web\u524d\u7aef\uff0c\u56e0\u4e3a\u6ca1\u6709\u4ee3\u7406 </p> <p>\u5982\u679c\u6211\u4eec\u7528<code>istioctl dashboard kiali</code>\u6253\u5f00Kiali\uff0c\u770b\u4e00\u4e0bGraph\uff0c\u4f60\u4f1a\u53d1\u73b0Kiali\u68c0\u6d4b\u5230\u4ece\u5165\u53e3\u7f51\u5173\u5230Web\u524d\u7aef\u7684\u8c03\u7528\u3002\u7136\u800c\uff0c\u5bf9Customers\u670d\u52a1\u7684\u8c03\u7528\u662f\u6765\u81ea\u672a\u77e5\u7684\u670d\u52a1\u3002\u8fd9\u662f\u56e0\u4e3aWeb\u524d\u7aef\u65c1\u8fb9\u6ca1\u6709\u4ee3\u7406\uff0cIstio\u4e0d\u77e5\u9053\u8fd9\u4e2a\u670d\u52a1\u662f\u8c01\u3001\u5728\u54ea\u91cc\u3001\u662f\u4ec0\u4e48\u3002 </p> <p> </p> <p>\u8ba9\u6211\u4eec\u66f4\u65b0<code>Customers</code>\u7684<code>Virtualservice</code>\u5e76\u5c06\u7f51\u5173\u9644\u52a0\u5230\u5b83\u4e0a\u9762\u3002\u8fd9\u5c06\u4f7f\u6211\u4eec\u80fd\u591f\u76f4\u63a5\u8c03\u7528<code>Customers</code>\u7684\u670d\u52a1 </p> <p><code>4vscustomersgateway.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  gateways:\n    - gateway\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <pre><code>$ kubectl apply -f 4vscustomersgateway.yaml \nvirtualservice.networking.istio.io/customers configured\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a<code>Host</code>\u5934\u4e86\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5165\u53e3\u7f51\u5173(<code>GATEWAY_URL</code>)\u5c06\u8bf7\u6c42\u53d1\u9001\u5230<code>Customers</code>\u670d\u52a1\uff1a  </p> <pre><code>$ curl -H \"Host: customers.default.svc.cluster.local\" http://127.0.0.1\n\n[{\"name\":\"Jewel Schaefer\"},{\"name\":\"Raleigh Larson\"},{\"name\":\"Eloise Senger\"},{\"name\":\"Moshe Zieme\"},{\"name\":\"Filiberto Lubowitz\"},{\"name\":\"Ms.Kadin Kling\"},{\"name\":\"Jennyfer Bergstrom\"},{\"name\":\"Candelario Rutherford\"},{\"name\":\"Kenyatta Flatley\"},{\"name\":\"Gianni Pouros\"}]\n</code></pre> <p> </p> <p>\u4e3a\u4e86\u901a\u8fc7Ingress\u7ed9Web\u524d\u7aef\u548cCustomers\u670d\u52a1\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf\uff0c\u6253\u5f00\u4e24\u4e2a\u7ec8\u7aef\u7a97\u53e3\uff0c\u5206\u522b\u8fd0\u884c\u4e00\u6761\u547d\u4ee4\uff1a </p> <pre><code>// Terminal1\nwhile true; do curl -H \"Host: customers.default.svc.cluster.local\" http://127.0.0.1; done\n\n// Terminal2\nwhile true; do curl http://127.0.0.1/; done\n</code></pre> <p>\u6253\u5f00Kiali\uff0c\u770b\u4e00\u4e0b\u56fe\u8868\u3002\u5728Display\u4e0b\u62c9\u83dc\u5355\u4e2d\uff0c\u786e\u4fdd\u6211\u4eec\u9009\u4e2dSecurity\u9009\u9879\u3002\u4f60\u5e94\u8be5\u770b\u5230\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u4e0b\u56fe\u7684\u56fe\u8868 </p> <p> </p> <p>\u6ce8\u610f\u5728\u5165\u53e3\u7f51\u5173\u548c<code>Customers</code>\u670d\u52a1\u4e4b\u95f4\u6709\u4e00\u4e2a\u6302\u9501\u56fe\u6807\uff0c\u8fd9\u610f\u6627\u7740\u6d41\u91cf\u662f\u4f7f\u7528mTLS\u53d1\u9001\u7684\u3002</p> <p>\u5982\u679c\u4f60\u6ca1\u6709\u770b\u5230\u6302\u9501\u56fe, \u6807\u8bf7\u70b9\u51fb<code>Display</code>\u4e8c\u4e0b\u62c9\u83dc\u5355\uff0c\u786e\u4fdd<code>Security</code>\u9009\u9879\u88ab\u9009\u4e2d\u3002 </p> <p>\u7136\u800c\uff0c\u5728\u672a\u77e5\u7684\uff08web\u524d\u7aef\uff09\u548cCustomers\u670d\u52a1\u4e4b\u95f4\uff0c\u4ee5\u53ca<code>istio-ingress-gateway</code>\u548c<code>web</code>\u524d\u7aef\u4e4b\u95f4\uff0c\u90fd\u6ca1\u6709\u6302\u9501\u3002<code>Istio</code>\u5728\u6ca1\u6709\u6ce8\u5165<code>sidecar</code>\u7684\u6e05\u51b5\u4e0b\u5411\u670d\u52a1\u53d1\u9001\u7eaf\u6587\u672c\u6d41\u91cf\u3002</p> <p>\u8ba9\u6211\u4eec\u770b\u770b\u5982\u679c\u6211\u4eec\u5728<code>STRICT</code>\u6a21\u5f0f\u4e0b\u542f\u7528<code>mTLS</code>\u4f1a\u53d1\u751f\u4ec0\u4e48\u3002</p> <p>\u6211\u4eec\u9884\u8ba1\u4ece\u524d\u7aef\u5230<code>Customers</code>\u670d\u52a1\u7684\u8c03\u7528\u4f1a\u5f00\u59cb\u5931\u8d25\uff0c\u56e0\u4e3a\u6ca1\u6709\u6ce8\u5165\u4ee3\u7406\u6765\u8fdb\u884c<code>mTLS</code>\u901a\u4fe1\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4ece\u5165\u53e3\u7f51\u5173\u5230<code>Customers</code>\u670d\u52a1\u7684\u8c03\u7528\u5c06\u7ee7\u7eed\u5de5\u4f5c </p> <p><code>5strictmtls.yaml</code></p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: PeerAuthentication\nmetadata:\n  name: default\n  namespace: default\nspec:\n  mtls:\n    mode: STRICT\n</code></pre> <pre><code>$ kubectl apply -f 5strictmtls.yaml \npeerauthentication.security.istio.io/default created\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u4ecd\u7136\u5728\u8fd0\u884c\u8bf7\u6c42\u5faa\u73af\uff0c\u6211\u4eec\u5c06\u5f00\u59cb\u770b\u5230\u6765\u81ea<code>web</code>\u524d\u7aef\u7684<code>ECONNRESET</code>\u9519\u8bef\u4fe1\u606f\u3002</p> <p>\u8fd9\u4e2a\u9519\u8bef\u8868\u660e\uff0cCustomers\u7aef\u5173\u95ed\u4e86\u8fde\u63a5\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u671f\u5f85\u7740\u4e00\u4e2a<code>mTLS</code>\u8fde\u63a5</p> <pre><code>CONNRESET\"\"read ECONNRESET\"\"read ECONNRESET\"^C\n</code></pre> <p>\u53e6\u4e00\u65b9\u9762\uff0c\u6211\u4eec\u76f4\u63a5\u5411<code>Customers</code>\u670d\u52a1\u53d1\u51fa\u7684\u8bf7\u6c42\u7ee7\u7eed\u5de5\u4f5c\uff0c\u56e0\u4e3a<code>Customers</code>\u670d\u52a1\u65c1\u8fb9\u6709\u4e00\u4e2a<code>Envoy</code>\u4ee3\u7406\u5728\u8fd0\u884c\uff0c\u5b83\u53ef\u4ee5\u8fdb\u884c<code>mTLS</code></p> <p>\u5982\u679c\u6211\u4eec\u5220\u9664\u4e4b\u524d\u90e8\u7f72\u7684<code>PeerAuthentication</code>\u8d44\u6e90(<code>kubectl delete peerauthentication default</code>),Istio\u5c31\u4f1a\u961f\u590d\u5230\u9ed8\u8ba4\u72b6\u6001\uff08<code>PERMISSIVE</code>\u6a21\u5f0f\uff09\uff0c\u9519\u8bef\u4e5f\u4f1a\u6d88\u5931</p>"},{"location":"chap8/6Istio_secruity/#72","title":"7\u3001\u5b9e\u9a8c2 \u8bbf\u95ee\u63a7\u5236","text":"<p>\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u6388\u6743\u7b56\u7565\u6765\u63a7\u5236\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u7684\u8bbf\u95ee\u3002 </p> <p>\u9996\u5148\u90e8\u7f72<code>Gateway</code></p> <p><code>1gateway.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n        - '*'\n</code></pre> <pre><code>$ kubectl apply -f 1gateway.yaml \ngateway.networking.istio.io/gateway created\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u521b\u5efaWeb\u524d\u7aef\u90e8\u7f72\u3001\u670d\u52a1\u8d26\u6237\u3001\u670d\u52a1\u548c<code>VirtualService</code>. </p> <p><code>2webfrontend.yaml</code></p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: web-frontend\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: web-frontend\n  template:\n    metadata:\n      labels:\n        app: web-frontend\n        version: v1\n    spec:\n      serviceAccountName: web-frontend\n      containers:\n        - image: gcr.io/tetratelabs/web-frontend:1.0.0\n          imagePullPolicy: Always\n          name: web\n          ports:\n            - containerPort: 8080\n          env:\n            - name: CUSTOMER_SERVICE_URL\n              value: 'http://customers.default.svc.cluster.local'\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  selector:\n    app: web-frontend\n  ports:\n    - port: 80\n      name: http\n      targetPort: 8080\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: web-frontend\nspec:\n  hosts:\n    - '*'\n  gateways:\n    - gateway\n  http:\n    - route:\n        - destination:\n            host: web-frontend.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <pre><code>$ kubectl apply -f 2webfrontend.yaml \nserviceaccount/web-frontend created\ndeployment.apps/web-frontend created\nservice/web-frontend created\nvirtualservice.networking.istio.io/web-frontend created\n</code></pre> <p><code>3customersv1.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: customers-v1\n  labels:\n    app: customers\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: customers\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: customers\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/customers:1.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: customers\n  labels:\n    app: customers\nspec:\n  selector:\n    app: customers\n  ports:\n    - port: 80\n      name: http\n      targetPort: 3000\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <pre><code>$ kubectl apply -f 3customersv1.yaml \ndeployment.apps/customers-v1 created\nservice/customers created\nvirtualservice.networking.istio.io/customers created\n</code></pre> <pre><code>$ kubectl get vs\nNAME           GATEWAYS      HOSTS                                     AGE\ncustomers                    [\"customers.default.svc.cluster.local\"]   6s\nweb-frontend   [\"gateway\"]   [\"*\"]                                     19s\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u4ece<code>GATEWAY_URL</code>\u8bbf\u95ee\u7f51\u9875\uff0c\u6211\u4eec\u4f1a\u5f97\u5230\u5e26\u6709\u5ba2\u670d\u4eba\u5458\u56de\u5e94\u7684\u7f51\u9875\u3002 </p> <p> </p>"},{"location":"chap8/6Istio_secruity/#7-1","title":"7-1 \u6388\u6743\u7b56\u7565\u62d2\u7edd","text":"<p>\u8ba9\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u62d2\u7edd<code>default</code>\u547d\u540d\u7a7a\u95f4\u7684\u6240\u6709\u8bf7\u6c42 </p> <p><code>4denyall.yaml</code></p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n name: deny-all\n namespace: default\nspec:\n  {}\n</code></pre> <pre><code>$ kubectl apply -f 4denyall.yaml \nauthorizationpolicy.security.istio.io/deny-all created\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u4ece<code>GATEWAY_URL</code>\u8bbf\u95ee\u7f51\u9875\u3002</p> <pre><code>RBAC: access denied\n</code></pre> <p>\u540c\u6837\u5982\u679c\u6211\u4eec\u8bd5\u56fe\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\u4e00\u4e2aPod\u5e76\u4ece<code>default</code>\u547d\u540d\u7a7a\u95f4\u5185\u5411<code>Web</code>\u524d\u7aef\u6216<code>customers</code>\u670d\u52a1\u63d0\u51fa\u8bf7\u6c42\u6211\u4eec\u4f1a\u5f97\u5230\u540c\u6837\u7684\u9519\u8bef </p> <pre><code>$ kubectl run curl --image=radial/busyboxplus:cur\nl -i --ttykubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a futu\nre version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.\nIf you don't see a command prompt, try pressing enter.\n\n[ root@curl-6cd5b579fb-2xcx9:/ ]$ curl customers\nRBAC: access denied\n[ root@curl-6cd5b579fb-2xcx9:/ ]$ curl web-frontend\nRBAC: access denied\n</code></pre> <p>\u5728\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u90fd\u5f97\u5230\u4e86\u62d2\u7edd\u8bbf\u95ee\u7684\u9519\u8bef </p>"},{"location":"chap8/6Istio_secruity/#7-2-allow-web-frontend","title":"7-2 ALLOW \u52a8\u4f5c\u5141\u8bb8\u4ece\u5165\u53e3\u7f51\u5173\u5411web-frontend","text":"<p>\u6211\u4eec\u8981\u505a\u7684\u7b2c\u4e00\u4ef6\u4e8b\u662f\u4f7f\u7528<code>ALLOW</code>\u52a8\u4f5c\u5141\u8bb8\u4ece\u5165\u53e3\u7f51\u5173\u5411<code>web-frontend</code>\u5e94\u7528\u7a0b\u5e8f\u53d1\u9001\u8bf7\u6c42\u3002\u5728\u89c4\u5219\u4e2d\u6211\u4eec\u6307\u5b9a\u4e86\u5165\u53e3\u7f51\u5173\u8fd0\u884c\u7684\u6e90\u547d\u540d\u7a7a\u95f4\uff08<code>istio-system</code>\uff09\u548c\u5165\u53e3\u7f51\u5173\u7684\u670d\u52a1\u8d26\u6237\u540d\u79f0 </p> <p><code>5allow-webfrontend-customers.yaml</code></p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n  name: allow-ingress-frontend\n  namespace: default\nspec:\n  selector:\n    matchLabels:\n      app: web-frontend\n  action: ALLOW\n  rules:\n    - from:\n        - source:\n            namespaces: [\"istio-system\"]\n        - source:\n            principals: [\"istio-ingressgateway-service-account\"]\n</code></pre> <pre><code>- source:\n    principals: [\"cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"]\n</code></pre> <pre><code>$ kubectl apply -f 5allowingressfrontend.yaml \nauthorizationpolicy.security.istio.io/allow-ingress-frontend created\n</code></pre> <pre><code>$ curl http://127.0.0.1\n\"Request failed with status code 403\"\n</code></pre> <p>\u8bf7\u6ce8\u610f\u7b56\u5cea\u9700\u8981\u51e0\u79d2\u949f\u624d\u80fd\u5206\u53d1\u5230\u6240\u6709\u4ee3\u7406\u6240\u4ee5\u4f60\u53ef\u80fd\u4ecd\u7136\u4f1a\u770b\u5230<code>node: access denied</code>\u7684\u6d88\u606f\u65f6\u95f4\u4e3a\u51e0\u79d2\u949f </p> <p>\u8fd9\u4e2a\u9519\u8bef\u6765\u81ea<code>customers</code>\u670d\u52a1\u2014\u2014\u8bb0\u5f97\u6211\u4eec\u5141\u8bb8\u8c03\u7528Web\u524d\u7aef\u3002</p> <p>\u7136\u800c<code>web-fronted</code>\u4ecd\u7136\u4e0d\u80fd\u8c03\u7528<code>customers</code>\u670d\u52a1  \u5982\u679c\u6211\u4eec\u56de\u5230\u6211\u4eec\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\u7684<code>curl Pod</code>\u5c1d\u8bd5\u8bf7\u6c42<code>http://web-fronted</code>\u6211\u4eec\u4f1a\u5f97\u5230\u4e00\u4e2aRBAC\u9519\u8bef\u3002DENY\u7b56\u7565\u662f\u6709\u6548\u7684\u6211\u4eec\u53ea\u5141\u8bb8\u4ece\u5165\u53e3\u7f51\u5173\u8fdb\u884c\u8c03\u7528</p> <p>\u5f53\u6211\u4eec\u90e8\u7f72Web\u524d\u7aef\u65f6\u6211\u4eec\u4e5f\u4e3aPod\u521b\u5efa\u4e86\u4e00\u4e2a\u670d\u52a1\u8d26\u6237\uff08\u5426\u5219\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709Pod\u90fd\u88ab\u5206\u914d\u4e86\u9ed8\u8ba4\u7684\u670d\u52a1\u8d26\u6237\uff09\u3002\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8be5\u670d\u52a1\u8d26\u6237\u6765\u6307\u5b9acustomers\u670d\u52a1\u8c03\u7528\u7684\u6765\u6e90\uff0e </p> <p><code>6allowwebfrontendcustomers.yaml</code></p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n  name: allow-web-frontend-customers\n  namespace: default\nspec:\n  selector:\n    matchLabels:\n        app: customers\n        version: v1\n  action: ALLOW\n  rules:\n  - from:\n    - source:\n        namespaces: [\"default\"]\n    - source:\n        principals: [\"web-frontend\"]\n</code></pre> <pre><code>principals: [\"cluster.local/ns/default/sa/web-frontend\"]\n</code></pre> <pre><code>$ kubectl apply -f 6allowwebfrontendcustomers.yaml \nauthorizationpolicy.security.istio.io/allow-web-frontend-customers created\n</code></pre> <p>\u4e00\u65e6\u7b56\u7565\u88ab\u521b\u5efa\u6211\u4eec\u5c06\u770b\u5230Web\u524d\u7aef\u518d\u6b21\u5de5\u4f5c\u2015\u5b83\u5c06\u83b7\u5f97customers\u670d\u52a1\u7684\u56de\u5e94 </p> <pre><code>$ curl http://127.0.0.1\n&lt;!DOCTYPE html&gt;\n...\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528\u4e86\u591a\u4e2a\u6388\u6743\u7b56\u7565\u660e\u786e\u5730\u5141\u8bb8\u961f\u5165\u53e3\u5230\u524d\u7aef\u4ee5\u53ca\u961f\u524d\u7aef\u5230<code>customers</code>\u670d\u52a1\u7684\u8c03\u7528\u3002 \u4f7f\u7528<code>deny-all</code>\u7b56\u7565\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u5f00\u59cb\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u3001\u7ba1\u7406\u7136\u540e\u660e\u786e\u5730\u5141\u8bb8\u6211\u4eec\u5e0c\u671b\u5728\u670d\u52a1\u4e4b\u95f4\u53d1\u751f\u7684\u901a\u4fe1 </p>"},{"location":"chap8/6Istio_secruity/#8","title":"8\u3001\u5b89\u5168\u6d4b\u8bd5","text":"<p>1\u3001\u5728\u901a\u4fe1\u65f6\uff0cEnvoy\u4ee3\u7406\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u51ed\u8bc1\uff1f </p> <ul> <li>A \u7528\u6237\u548c\u5bc6\u7801</li> <li>B API\u79d8\u94a5</li> <li>C Token</li> <li>D X509\u8bc1\u4e66 </li> </ul> <p>Validating the X.509 to authenticate the SPIFFE identity</p> <p>2\u3001\u54ea\u4e2a\u7ec4\u4ef6\u4e3a\u4e00\u4e2a\u670d\u52a1\u8d26\u6237\u521b\u5efaSPIFFE\u8eab\u4efd\uff1f </p> <ul> <li>A Pilot</li> <li>B Citadel</li> <li>C Mixer</li> <li>D Envoy SDS</li> </ul> <p>\u6bcf\u6b21\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u8d26\u6237\u65f6,  Citadel\u90fd\u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2aSPIFFE\u8eab\u4efd\u3002</p> <p>3\u3001\u4f60\u4f1a\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u542f\u7528\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4e25\u683cmTLS\u6a21\u5f0f\uff1f</p> <ul> <li>A IstioAuth</li> <li>B ClusterRole</li> <li>C PeerAuthentication</li> <li>D Auth</li> </ul> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: PeerAuthentication\nmetadata:\n  name: default\n  namespace: default\nspec:\n  mtls:\n    mode: STRICT\n</code></pre> <p>4\u3001AuthorizationPolicy\u8d44\u6e90\u4e2d\u4f7f\u7528\u54ea\u4e24\u4e2a\u52a8\u4f5c\uff1f </p> <ul> <li>ACCPET\u548cRJECT</li> <li>VALIDATE\u548cCANCEL</li> <li>DENY\u548cACCEPT </li> <li>DENY\u548cALLOW</li> </ul> <p>\u6bcf\u4e2a<code>Envoy</code>\u4ee3\u7406\u5b9e\u4f8b\u90fd\u8fd0\u884c\u4e00\u4e2a\u6388\u6743\u5f15\u64ce\uff0c\u5728\u8fd0\u884c\u65f6\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6388\u6743\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe\u4ee3\u7406\u65f6\uff0c\u5f15\u64ce\u4f1a\u6839\u636e\u6388\u6743\u7b56\u7565\u8bc4\u4f30\u8bf7\u6c42\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u8fd4\u56de<code>ALLOW</code>\u6216<code>DENY</code></p> <p>5\u3001\u5f53\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\uff08SDS)\u66f4\u65b0\u8bc1\u4e66\u65f6\uff0c\u662f\u5426\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u4ee5\u4f7f\u7528\u65b0\u8bc1\u4e66\u3002 </p> <ul> <li>A \u662f </li> <li>B \u5426 </li> </ul> <p>6\u3001AUDIT\u52a8\u4f5c\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f </p> <ul> <li>A \u8bb0\u5f55\u548c\u62d2\u7edd\u8bf7\u6c42\uff0e</li> <li>B \u8bb0\u5f55\u8bf7\u6c42</li> <li>C \u53d1\u9001\u8c13\u6c42\u901a\u77e5</li> <li>D \u8bb0\u5f55\u548c\u5141\u8bb8\u8bf7\u6c42</li> </ul> <p><code>AUDIT</code>\u52a8\u4f5c\u51b3\u5b9a\u662f\u5426\u8bb0\u5f55\u7b26\u5408\u89c4\u5219\u7684\u8bf7\u6c42\u3002\u6ce8\u610f<code>AUDIT</code>\u7b56\u7565\u5e76\u4e0d\u5f71\u54cd\u8bf7\u6c42\u88ab\u5141\u8bb8\u6216\u62d2\u7edd\u3002</p> <p>7\u3001\u4ec0\u4e48\u662f\u5141\u8bb8\u6a21\u5f0f\uff08permissive mode)?</p> <ul> <li>A \u4e00\u4e2a\u5141\u8bb8\u670d\u52a1\u540c\u65f6\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u6700\u548cmTLS\u6d41\u91cf\u7684\u9009\u9879</li> <li>B \u4e00\u4e2a\u5141\u8bb8\u670d\u52a1\u53ea\u63a5\u53d7\u660e\u6587\u6d41\u91cf\u7684\u9009\u9879 </li> <li>C\u4e00\u4e2a\u5141\u8bb8\u7528\u6237\u76f4\u63a5\u5411\u670d\u52a1\u63d0\u51fa\u8bf7\u6c42\u7684\u9009\u9879 </li> <li>D \u4e00\u4e2a\u5141\u8bb8\u4f60\u4fbf\u7528\u57fa\u4e8e\u4ee4\u724c\u7684\u8ba4\u8bc1\u7684\u9009\u9879 </li> </ul> <p>Allows services to accpet both plaintext and mTLS</p> <p>8\u3001\u662f\u5426\u53ef\u4ee5\u5728Istio\u4e2d\u4f7f\u7528JSON Web Tokens (JWTs)? </p> <ul> <li>A \u662f</li> <li>B \u5426</li> </ul> <p>9\u3001\u9009\u62e9\u4e09\u4e2a\u8d1f\u8d35\u5728\u8fd0\u884c\u65f6\u521b\u5efa\u8eab\u4efd\u7684\u7ec4\u4ef6</p> <ul> <li>A Citedel </li> <li>B lstio Agent</li> <li>C Envoys Secret Discovery Service</li> <li>D Pilot </li> <li>E citadel-agent</li> <li>E Envoy proxy</li> </ul> <p>10\u3001\u4f7f\u7528\u8bb8\u53ef\u6a21\u5f0f\u53ef\u4ee5\u6539\u5584mTLS\u7684\u4e0a\u673a\u4f53\u9a8c\u3002</p> <ul> <li>\u662f</li> <li>\u5426</li> </ul> <p>11\u3001 Istlo Agent\u7684\u5de5\u4f5c\u662f\u4ec0\u4e48\uff1f </p> <ul> <li>A \u4e0eEnvoy sidecar\u5408\u4f5c\uff0c\u901a\u8fc7\u4e13\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\uff0c\u5e2e\u52a9\u4ed6\u4eec\u94fe\u63a5\u5230Service mesh </li> <li>B \u4e0eIstio PIot\u5408\u4f5c\uff0c\u914d\u7f6eCitadel</li> <li>C \u4e0eCitadel\u5408\u4f5c\uff0c\u5728Ku bernetes\u7684\u79d8\u5bc6\u4e2d\u5bf9\u8bc1\u4e66\u8fdb\u884c\u7f16\u7801 </li> <li>D \u9a8c\u8bc1<code>ISTIO_MUTUAL</code>\u914d\u7f6e </li> </ul> <p><code>Istio Agent</code>\u4e0e<code>Envoy sidecar</code>\u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c</p> <p>12\u3001Istlo\u63d0\u4f9b\u54ea\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1f </p> <ul> <li>A \u5bf9\u7b49\u548c\u8bf7\u6c42\u8ba4\u8bc1</li> <li>B JWT\u4ee4\u724c\u548c\u5bc6\u7801\u8ba4\u8bc1 </li> <li>C Istio\u53ea\u63d0\u4f9b\u5bf9\u7b49\u8ba4\u8bc1 </li> <li>D \u591a\u56e0\u7d20\u8ba4\u8bc1\u548c\u5be1\u4e8e\u8bc1\u4e66\u7684\u8ba4\u8bc1 </li> </ul> <p>13 Istlo\u4ee3\u7406\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u5b58\u50a8\u5728\u54ea\u91cc\uff1f</p> <ul> <li>\u78c1\u76d8 </li> <li>Secret\u4e2d </li> <li>\u5185\u5b58 </li> <li>\u94a5\u5319\u548c\u8bc1\u4e66\u4e0d\u5b58\u50a8\u5728\u4efb\u4f55\u5730\u65b9 </li> </ul> <p>Istio\u4ee3\u7406\u4eceCitadel\u83b7\u53d6\u54cd\u5e94\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\u5e76\u901a\u8fc7<code>SDS</code>\u548c<code>Unix</code>\u57df\u5957\u63a5\u5b87\u5c06\u5176\u63d0\u4f9b\u7ed9<code>Envoy</code>\u3002</p> <p>\u5c06\u5bc6\u94a5\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u6bd4\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u66f4\u5b89\u5168\uff1b</p> <p>\u5728\u4f7f\u7528SDS\u65f6\uff0c\u7edd\u4e0d\u4f1a\u5c06\u4efb\u4f55\u5bc6\u94a5\u5199\u5165\u78c1\u76d8\u3002Istio\u4ee3\u7406\u8fd8\u5b9a\u671f\u5237\u65b0\u51ed\u8bc1\uff0c \u5728\u5f53\u524d\u51ed\u8bc1\u8fc7\u670b\u524d\u4eceCitadel\u68c0\u7d22\u4efb\u4f55\u65b0\u7684SVID(SPIFFE\u53ef\u9a8c\u8bc1\u8eab\u4efd\u6587\u4ef6\uff09 </p> <p>15 \u54ea\u79cd\u4ee3\u7406\u4e0eistiod\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u5b9e\u73b0\u94a5\u5319\u548c\u8bc1\u4e66\u8f6e\u6362\u7684\u81ea\u52a8\u5316</p> <ul> <li>A envoy-agent </li> <li>B pilot-agent </li> <li>C citadel-agent </li> <li>D sds-agent </li> </ul> <p>\u4e00\u4e2a\u540d\u4e3a<code>pilot-agent</code>\u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08<code>istiod</code>\uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c\u3002 </p> <p>16\u3001\u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u54ea\u4e9b\u5185\u5bb9\uff1f</p> <ul> <li>A \u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04 </li> <li>B \u52a0\u5bc6\u7684Kubernetes secret </li> <li>C Base64\u7f16\u7801\u7684\u670d\u52a1\u540d\u79f0 </li> <li>D \u5bc6\u7801\u548c\u8bc1\u4e66 </li> </ul> <p>\u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04\u3002</p> <p>17\u3001\u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c\u54ea\u4e9b\u7b56\u7565\u4f1a\u5148\u88ab\u8bc4\u4f30\uff1f</p> <ul> <li>Deny \u7b56\u7565</li> <li>ALLOW\u7b56\u7565 </li> <li>AUDIT\u7b56\u7565 </li> <li>\u7b56\u7565\u662f\u968f\u673a\u8bc4\u4f30\u7684</li> </ul> <p>\u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c\u5219\u9996\u5148\u8bc4\u4f30\u62d2\u7edd\u7684\u7b56\u7565\u3002</p> <p>18\u3001\u4f60\u5982\u4f55\u5728Istio\u4e2d\u542f\u7528\u6388\u6743\u529f\u80fd\uff1f</p> <ul> <li>A \u521b\u5efaPeerAuthentication \u8d44\u6e90</li> <li>B \u914d\u7f6eRBAC</li> <li>C \u90e8\u7f72AuthPolicv\u8d44\u6e90 </li> <li>D \u4e0d\u9700\u8981\u660e\u786e\u5730\u542f\u7528\u8be5\u529f\u80fd</li> </ul> <p>\u6ca1\u6709\u5fc5\u8981\u660e\u786e\u5730\u542f\u7528\u6388\u6743\u529f\u80fd\u3002 \u4e3a\u4e86\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u6765\u5e94\u7528\u4e8e\u6211\u4eec\u7684\u5de5\u4f5c\u8d1f\u8f7d <code>AuthorizationPolicy</code>\u8d44\u6e90\u662f\u6211\u4eec\u53ef\u4ee5\u5229\u7528<code>PeerAuthentication</code>\u7b56\u7565\u548c<code>RequestAuthentication</code>\u7b56\u7565\u4e2d\u7684\u4e3b\u4f53\u7684\u5730\u65b9\u3002</p> <p>19\u3001Istio\u5982\u4f55\u9a8c\u8bc1\u7528\u6237\uff0f\u8fdb\u7a0b\u7684\u8eab\u4efd\uff1f </p> <ul> <li>A \u901a\u8fc7\u63d0\u793a\u5bc6\u7801\uff08\u7528\u6237\uff09\u548cAPI\u79d8\u94a5\uff08\u8fc7\u7a0b\uff09</li> <li>B \u901a\u8fc7\u4f7f\u7528PeerAuthentication\u8d44\u6e90 </li> <li>C \u901a\u8fc7\u4ece\u8bf7\u6c42\u4e2d\u63d0\u53d6\u51ed\u8bc1 </li> <li>D \u901a\u8fc7\u7b2c\u4e09\u65b9\u670d\u52a1</li> </ul> <p>20\u3001\u5728Kubernetes\u4e2d\uff0c\u54ea\u4e2a\u8d44\u6e90\u4ee3\u8868\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\uff1f</p> <ul> <li>A \u7528\u6237\u5bf9\u8c61</li> <li>B Service Account</li> <li>C Context</li> <li>D \u8bc1\u4e66</li> </ul> <p>21 \u4f60\u5982\u4f55\u5728\u6574\u4e2a\u7f51\u683c\u4e2d\u5f3a\u5236\u6267\u884c\u4e25\u683c\u7684mTLS\u6a21\u5f0f\uff1f </p> <ul> <li>A \u901a\u8fc7\u90e8\u7f72\u4e00\u4e2aClusterRoIe\u5e76\u5c06mode\u5b57\u6bb5\u8bbe\u7f6e\u4e3aMUTUAL </li> <li>B \u901a\u8fc7\u90e8\u7f72\u4e00\u4e2aDestinationRule\u5e76\u5c06policy\u8bbe\u7f6e\u4e3a<code>ISTIO_ MUTUAL</code></li> <li>C \u4f60\u4e0d\u80fd\u5728\u5168\u5c40\u8303\u56f4\u5185\u6267\u884c\u4e25\u683c\u7684mTLS\uff08\u53ea\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\uff09 </li> <li>D \u901a\u8fc7\u5c06<code>PeerAuthentication</code>\u8d44\u6e90\u90e8\u7f72\u5230\u6839\u547d\u540d\u7a7a\u95f4(Istlo system\uff09\u4e2d</li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u521b\u5efa<code>PeerAuthentication</code>\u8d44\u6e90\uff0c\u9996\u5148\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5206\u522b\u6267\u884c\u4e25\u683c\u6a21\u5f0f\u3002\u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u547d\u540d\u7a7a\u95f4\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f<code>istio-system</code>)\u521b\u5efa\u4e00\u4e2a\u7b56\u7565\uff0c\u5728\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u4e2d\u6267\u884c\u8be5\u7b56\u7565\uff1a </p> <p>22 \u5bf9\u7b49\u8ba4\u8bc1\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684\uff1f </p> <ul> <li>A \u7528\u6237\u8ba4\u8bc1</li> <li>B \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762\u4e4b\u95f4\u7684\u8ba4\u8bc1 </li> <li>C \u5bf9\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684Envoy\u4ee3\u7406\u8fdb\u884c\u8ba4\u8bc1 </li> <li>D \u670d\u52a1\u95f4\u8ba4\u8bc1</li> </ul> <p>23 \u5982\u679cKubernetes\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709Envoy\u4ee3\u7406\uff0cIstio\u662f\u5426\u4f1a\u53d1\u9001mTLS\u6d41\u91cf\uff1f </p> <ul> <li>A \u662f</li> <li>B \u5426</li> </ul> <p>24 Authorization Policy\u8d44\u6e90\u4e2d\u7684selector\u548cmatchLabel\u5b57 \u6bb5\u6709\u4ec0\u4e48\u7528\u9014\uff1f</p> <ul> <li>A \u8981\u628a\u5de5\u4f5c\u8d1f\u8f7d\u4ece\u7b56\u7565\u4e2d\u6392\u9664\u51fa\u53bb </li> <li>B \u8981\u9009\u62e9\u7b56\u7565\u9002\u7528\u7684\u5de5\u4f5c\u8d1f\u8f7d </li> <li>C \u8981\u62d2\u7edd\u9009\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d </li> <li>D \u5141\u8bb8\u9009\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d </li> </ul>"},{"location":"chap8/7Istio_adv_feas/","title":"\u7b2c\u4e03\u8282 Istio\u9ad8\u7ea7\u529f\u80fd","text":""},{"location":"chap8/7Istio_adv_feas/#advanced-features","title":"Advanced Features","text":"<ul> <li> <p>Installing Isho on multiple clusters </p> <ul> <li>Network deployment models </li> <li>Control plane deployment models </li> <li>Mesh deployment models </li> <li>Tenancy models </li> </ul> </li> <li> <p>Working with VM workloads </p> </li> <li>Lab: Connecting a VM to Istlo service mesh </li> <li>Quiz </li> </ul>"},{"location":"chap8/7Istio_adv_feas/#1","title":"1\u3001\u591a\u96c6\u7fa4\u90e8\u7f72","text":"<p>\u591a\u96c6\u7fa4\u90e8\u7f72\uff08\u4e24\u4e2a\u6216\u66f4\u591a\u7684\u96c6\u7fa4\uff09\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7a0b\u5ea6\u7684\u9694\u79bb\u548c\u53ef\u7528\u6027\uff0c\u4f46\u6211\u4eec\u4ed8\u51fa\u7684\u4ee3\u4ef7\u662f\u589e\u52a0\u4e86\u590d\u6742\u6027\u3002\u5982\u679c\u573a\u666f\u8981\u6c42\u9ad8\u53ef\u7528\u6027\uff08HA)\uff0c\u6211\u4eec\u5c06\u4e0d\u5f97\u4e0d\u5728\u591a\u4e2a\u533a\u57df\u548c\u5730\u533a\u90e8\u7f72\u96c6\u7fa4\u3002 </p> <p>\u6211\u4eec\u9700\u8981\u505a\u51fa\u7684\u4e0b\u4e00\u4e2a\u51b3\u5b9a\u662f\uff0c\u51b3\u5b9a\u6211\u4eec\u662f\u5426\u8981\u5728\u4e00\u4e2a\u7f51\u7edc\u5185\u8fd0\u884c\u96c6\u7fa4\uff0c\u6216\u8005\u662f\u5426\u8981\u4f7f\u7528\u591a\u4e2a\u7f51\u7edc\u3002 </p> <p>\u4e0b\u56fe\u663e\u793a\u4e86\u4e00\u4e2a\u591a\u96c6\u7fa4\u65b9\u6848\uff08\u96c6\u7fa4A\u3001B\u548cC)\uff0c\u8de8\u4e24\u4e2a\u7f51\u7edc\u90e8\u7f72\u3002 </p> <p>Mesh Deployment Models </p> <ul> <li>Service communicate across mesh boundaries </li> <li>Cleaner organizational boundary </li> <li>Stronger isolation </li> <li>Reuse service names and namespaces </li> </ul> <p> </p>"},{"location":"chap8/7Istio_adv_feas/#1-1","title":"1-1 \u7f51\u7edc\u90e8\u7f72\u6a21\u5f0f","text":"<p>\u5f53\u6d89\u53ca\u5230\u591a\u4e2a\u7f51\u7edc\u65f6\uff0c\u96c6\u7fa4\u5185\u90e8\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5fc5\u987b\u4f7f\u7528Istio\u7f51\u5173\u624d\u80fd\u5230\u8fbe\u5176\u4ed6\u96c6\u7fa4\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4f7f\u7528\u591a\u4e2a\u7f51\u7edc\u53ef\u4ee5\u5b9e\u73b0\u66f4\u597d\u7684\u5bb9\u9519\u548c\u7f51\u7edc\u5730\u5740\u7684\u6269\u5c55</p> <p> </p>"},{"location":"chap8/7Istio_adv_feas/#1-2","title":"1-2 \u63a7\u5236\u5e73\u9762\u90e8\u7f72\u6a21\u578b","text":"<p>Istio\u670d\u52a1\u7f51\u683c\u4f7f\u7528\u63a7\u5236\u5e73\u9762\u6765\u914d\u7f6e\u7f51\u683c\u5185\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6240\u8fde\u63a5\u7684\u63a7\u5236\u5e73\u9762\u53d6\u51b3\u4e8e\u5176\u914d\u7f6e\u3002 </p> <p>\u5728\u6700\u7b80\u5355\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\uff0c\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u53ea\u6709\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u3002\u8fd9\u5c31\u662f\u6211\u4eec\u5728\u672c\u8bfe\u7a0b\u4e2d\u4e00\u76f4\u4f7f\u7528\u7684\u914d\u7f6e\u3002 </p> <p>\u5171\u4eab\u63a7\u5236\u5e73\u9762\u6a21\u578b\u6d89\u53ca\u591a\u4e2a\u96c6\u7fa4\uff0c\u63a7\u5236\u5e73\u9762\u53ea\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\u3002\u8be5\u96c6\u7fa4\u88ab\u79f0\u4e3a\u4e3b\u96c6\u7fa4\uff0c\u800c\u90e8\u7f72\u4e2d\u7684\u5176\u4ed6\u96c6\u7fa4\u88ab\u79f0\u4e3a\u8fdc\u7a0b\u96c6\u7fa4\u3002\u8fd9\u4e9b\u96c6\u7fa4\u6ca1\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762\uff0c\u76f8\u53cd\uff0c\u5b83\u4eec\u4ece\u4e3b\u96c6\u7fa4\u5171\u4eab\u63a7\u5236\u5e73\u9762\u3002 </p> <p> </p> <p>\u53e6\u4e00\u79cd\u90e8\u7f72\u6a21\u5f0f\u662f\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684\u96c6\u7fa4\u90fd\u89c6\u4e3a\u7531\u5916\u90e8\u63a7\u5236\u5e73\u9762\u63a7\u5236\u7684\u8fdc\u7a0b\u96c6\u7fa4\u3002</p> <p>\u8fd9\u4f7f\u6211\u4eec\u5728\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u6709\u4e86\u5b8c\u5168\u7684\u5206\u79bb\u3002\u4e00\u4e2a\u5178\u578b\u7684\u5916\u90e8\u63a7\u5236\u5e73\u9762\u7684\u4f8b\u5b50\u662f\u5f53\u4e00\u4e2a\u4e91\u4f9b\u5e94\u5546\u5728\u7ba1\u7406\u5b83\u3002 </p> <p>\u4e3a\u4e86\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\uff0c\u6211\u4eec\u5e94\u8be5\u5728\u591a\u4e2a\u96c6\u7fa4\u3001\u533a\u57df\u6216\u5730\u533a\u90e8\u7f72\u591a\u4e2a\u63a7\u5236\u5e73\u9762\u5b9e\u4f8b\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 </p> <p> </p> <p>\u8fd9\u79cd\u6a21\u5f0f\u63d0\u4f9b\u4e86\u66f4\u597d\u7684\u53ef\u7528\u80dc\u548c\u914d\u7f6e\u9694\u79bb\u3002\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u53d8\u5f97\u4e0d\u53ef\u7528\u90a3\u4e48\u505c\u673a\u5c31\u53ea\u9650\u4e8e\u8fd9\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u3002\u4e3a\u4e86\u6539\u5584\u8fd9\u4e00\u70b9\u4f60\u53ef\u4ee5\u5b9e\u65bd\u6545\u969c\u8f6c\u79fb\u5e76\u914d\u7f6e\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u4f8b\u5728\u53d1\u751f\u6545\u969c\u65f6\u8fde\u63a5\u5230\u53e6\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\uff0e </p> <p>\u4e3a\u4e86\u8fbe\u5230\u6700\u9ad8\u7684\u53ef\u7528\u6027\u6211\u4eec\u53ef\u4ee5\u5728\u591a\u4e2a\u96c6\u7fa4\u5185\u90e8\u7f72\u4e00\u4e2a\u63a7\u5236\u5e73\u9762</p>"},{"location":"chap8/7Istio_adv_feas/#1-3","title":"1-3 \u7f51\u683c\u90e8\u7f72\u6a21\u578b","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\u6211\u4eec\u6240\u770b\u7684\u6240\u6709\u56fe\u8868\u548c\u573a\u666f\u90fd\u662f\u4f7f\u7528\u5355\u4e00\u7684\u7f51\u683c\u3002\u5728\u5355\u7f51\u683c\u6a21\u578b\u4e2d\u6240\u6709\u7684\u670d\u52a1\u90fd\u5728\u4e00\u4e2a\u7f51\u683c\u4e2d\u4e0d\u7ba1\u5b83\u4eec\u8de8\u8d8a\u591a\u5c11\u96c6\u7fa4\u548c\u7f51\u7edc </p> <p>\u5c06\u591a\u4e2a\u7f51\u683c\u8054\u5408\u8d77\u6765\u7684\u90e8\u7f72\u6a21\u578b\u88ab\u79f0\u4e3a\u591a\u7f51\u683c\u90e8\u7f72\u3002\u5728\u8fd9\u79cd\u6a21\u5f0f\u4e0b\u670d\u52a1\u53ef\u4ee5\u8de8\u7f51\u683c\u8fb9\u754c\u8fdb\u884c\u901a\u4fe1\u3002\u8be5\u6a21\u578b\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u66f4\u6e05\u6670\u7684\u7ec4\u7ec7\u8fb9\u754c\u66f4\u5f3a\u7684\u9694\u79bb\u80dc\u5e76\u5141\u8bb8\u6211\u4eec\u91cd\u590d\u4f7f\u7528\u670d\u52a1\u540d\u79f0\u548c\u547d\u540d\u7a7a\u95f4</p> <p>\u5f53\u8054\u5408\u4e24\u4e2a\u7f51\u683c\u65f6\u6bcf\u4e2a\u7f51\u683c\u53ef\u4ee5\u66b4\u9732\u4e00\u7ec4\u670d\u52a1\u548c\u8eab\u4efd\u6240\u6709\u53c2\u4e0e\u7684\u7f51\u683c\u90fd\u53ef\u4ee5\u8bc6\u522b\u8fd9\u4e9b\u8eab\u4efd\u3002\u4e3a\u4e86\u5b9e\u73b0\u8de8\u7f51\u683c\u7684\u670d\u52a1\u901a\u4fe1\u6211\u4eec\u5fc5\u987b\u5728\u4e24\u4e2a\u7f51\u683c\u4e4b\u95f4\u5b9e\u73b0\u4fe1\u4efb\u3002\u4fe1\u4efb\u53ef\u4ee5\u901a\u8fc7\u5411\u7f51\u683c\u5bfc \u5165\u4fe1\u4efb\u5305\u548c\u4e3a\u8fd9\u4e9b\u8eab\u4efd\u914d\u7f6e\u672c\u5730\u7b56\u7565\u6765\u5efa\u7acb</p>"},{"location":"chap8/7Istio_adv_feas/#1-4","title":"1-4 \u79df\u6237\u6a21\u5f0f","text":"<p>Tenancy models </p> <ul> <li>Tenant = group of users sharing common access and privileges to workloads </li> <li>Network configuration and policy used for isolation </li> <li>Istio: namespace and cluster tenancies (soft multi-tenancy) </li> <li>Namespace is a unit of tenancy</li> </ul> <p>\u79df\u6237\u662f\u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650\u7684\u7528\u6237\u3002\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u901a\u8fc7\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565\u5b8c\u6210\u7684\u3002</p> <p>Istio\u652f\u6301\u547d\u540d\u7a7a\u95f4\u548c\u96c6\u7fa4\u79df\u6237\u3002\u8bf7\u6ce8\u610f\u6211\u4eec\u5728\u8fd9\u91cc\u8c08\u8bba\u7684\u79df\u6237\u662f\u8f6f\u591a\u79df\u6237\u800c\u4e0d\u662f\u786c\u79df\u6237\u3002**\u5f53\u591a\u4e2a\u79df\u6237\u5171\u4eab\u540c\u4e00\u4e2aIstio\u63a7\u5236\u5e73\u9762\u65f6\u6ca1\u6709\u4fdd\u8bc1\u5bf9\u8bf8\u5982\u566a\u97f3\u90bb\u5c45\u95ee\u9898\u7684\u4fdd\u62a4 **</p> <p>\u5728\u4e00\u4e2a\u7f51\u683c\u4e2dIstio\u4f7f\u7528\u547d\u540d\u7a7a\u95f4\u4f5c\u4e3a\u79df\u6237\u7684\u5355\u4f4d\u3002</p> <p>\u5982\u679c\u4f7f\u7528Kubernetes\u6211\u4eec\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90e8\u7f72\u6388\u4e88\u6743\u9650\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6765\u81ea\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u7684\u670d\u52a1\u53ef\u4ee5\u901a\u8fc7\u5b8c\u5168\u9650\u5b9a\u540d\u76f8\u4e92\u901a\u4fe1 </p> <p>\u5728\u5b89\u5168\u6a21\u5757\u4e2d\u6211\u4eec\u5df2\u7ecf\u5b66\u4f1a\u4e86\u5982\u4f55\u4f7f\u7528\u6388\u6743\u7b56\u7565\u6765\u63d0\u9ad8\u9694\u79bb\u5ea6\u5e76\u9650\u5236\u53ea\u5bf9\u9002\u5f53\u7684\u8c03\u7528\u8005\u8fdb\u884c\u8bbf\u95ee\uff0e \u5728\u591a\u96c6\u7fa4\u90e8\u7f72\u6a21\u578b\u4e2d\u6bcf\u4e2a\u96c6\u7fa4\u4e2d\u5171\u4eab\u76f8\u540c\u540d\u79f0\u7684\u547d\u540d\u7a7a\u95f4\u88ab\u8ba4\u4e3a\u662f\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u3002</p> <p>\u96c6\u7fa4A\u4e2ddefault\u547d\u540d\u7a7a\u95f4\u7684Customers\u670d\u52a1\u4e0e\u96c6\u7fa4B\u4e2ddefault\u547d\u540d\u7a7a\u95f4\u4e2d\u7684Customers\u670d\u52a1\u6307\u7684\u662f\u540c\u4e00\u4e2a\u670d\u52a1\u3002\u5f53\u6d41\u91cf\u88ab\u53d1\u9001\u5230Customers\u670d\u52a1\u65f6\u8d1f\u8f7d\u5747\u8861\u5728\u4e24\u4e2a\u670d\u52a1\u7684\u5408\u5e76\u7aef\u70b9\u4e0a\u8fdb\u884c\u5982\u4e0b\u56fe\u6240\u793a </p> <p> </p> <p>\u4e3a\u4e86\u5728Istio\u4e2d\u914d\u7f6e\u96c6\u7fa4\u79df\u7ea6\uff0c\u6211\u4eec\u9700\u8981\u5c06\u6bcf\u4e2a\u96c6\u7fa4\u914d\u7f6e\u4e3a\u4e00\u4e2a\u72ec\u7acb\u7684\u670d\u52a1\u7f51\u683c\u3002</p> <p>\u7f51\u683c\u53ef\u4ee5\u7531\u4e0d\u540c\u7684\u56e2\u961f\u63a7\u5236\u548c\u64cd\u4f5c\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u7f51\u683c\u8fde\u63a5\u5230\u4e00\u8d77\uff0c\u5f62\u6210\u4e00\u4e2a\u591a\u7f51\u683c\u90e8\u7f72\u3002\u5982\u679c\u6211\u4eec\u4f7f\u7528\u4e0e\u4e4b\u524d\u76f8\u540c\u7684\u4f8b\u5b50\uff0c\u5728\u96c6\u7fa4A\u7684default\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u7684\u670d\u52a1Customers\u4e0e\u96c6\u7fa4B\u7684default\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u670d\u52a1Customers\u6240\u6307\u7684\u4e0d\u662f\u540c\u4e00\u4e2a\u670d\u52a1\u3002</p> <p>\u79df\u6237\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u662f\u9694\u79bb\u4e0d\u540c\u79df\u6237\u7684\u914d\u7f6e\u3002\u76ee\u524d\uff0cIstio\u5e76\u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u8fc7\uff0c\u5b83\u901a\u8fc7\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u7684\u8303\u56f4\u914d\u7f6e\u6765\u5c1d\u8bd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002 </p>"},{"location":"chap8/7Istio_adv_feas/#1-5","title":"1-5 \u6700\u4f73\u591a\u96c6\u7fa4\u90e8\u7f72","text":"<p>Best multi-cluster deployment</p> <ul> <li>Each cluster has its own control plane </li> <li>Use multi-mesh deployments </li> <li>External system for orchestrating meshes </li> <li>Always use ingress gateways across cluster <ul> <li>Pod-to-pod connectivity can slow down and complicate things </li> </ul> </li> </ul> <p>\u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\u662f\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762\u3002\u5bf9\u4e8e\u6b63\u5e38\u7684\u670d\u52a1\u7f51\u683c\u90e8\u7f72\u89c4\u6a21\u5efa\u8bae\u4f60\u4f7f\u7528\u591a\u7f51\u683c\u90e8\u7f72\uff0c\u5e76\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u7cfb\u7edf\u5728\u5916\u90e8\u534f\u8c03\u7f51\u683c\u3002</p> <p>\u4e00\u822c\u5efa\u8bae\u603b\u662f\u5728\u96c6\u7fa4\u95f4\u4f7f\u7528\u5165\u53e3\u7f51\u5173\uff0c\u5373\u4f7f\u5b83\u4eec\u5728\u540c\u4e00\u4e2a\u7f51\u7edc\u4e2d\u3002\u76f4\u63a5\u7684pod\u5230pod\u7684\u8fde\u63a5\u9700\u8981\u5728\u591a\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u586b\u5145\u7ec8\u7aef\u6570\u636e\uff0c\u8fd9\u53ef\u80fd\u4f1a\u4f7f\u4e8b\u6e05\u53d8\u5f97\u7f13\u6162\u548c\u590d\u6742\u3002\u4e00\u4e2a\u66f4\u7b80\u5355\u7684\u89e3\u51b3\u65b9\u6848\u662f\u8ba9\u6d41\u91cf\u901a\u8fc7\u8de8\u96c6\u7fa4\u7684\u5165\u53e3\u6765\u6d41\u52a8\u3002 </p>"},{"location":"chap8/7Istio_adv_feas/#2","title":"2\u3001\u865a\u62df\u673a\u8d1f\u8f7d","text":"<p>\u5982\u679c\u6211\u4eec\u6709\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5b83\u4eec\u8fde\u63a5\u5230Istio\u670d\u52a1\u7f51\u683c\uff0c\u4f7f\u5176\u6210\u4e3a\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002 </p> <p>\u5e26\u6709\u865a\u62df\u673a\u7684Istio\u670d\u52a1\u7f51\u683c\u6709\u4e24\u79cd\u67b6\u6784\uff1a\u5355\u7f51\u7edc\u67b6\u6784\u548c\u591a\u7f51\u7edc\u67b6\u6784\u3002 </p> <p>Working with VM Workloads </p> <ul> <li>Connect VMS to Istio service mesh </li> <li>Steps: <ul> <li>Install Istio with meshExpension setting (IstioOperator) 0</li> <li>Create a dedicated namespace and service account</li> <li>Extract Istio's root certificate </li> <li>Collett network CIDR information </li> <li>Configure VM (install sidecar package, copy certs and config) </li> </ul> </li> </ul>"},{"location":"chap8/7Istio_adv_feas/#2-1","title":"2-1 \u5355\u7f51\u7edc\u67b6\u6784","text":"<p>\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u7f51\u7edc\u3002Kubernetes\u96c6\u7fa4\u548c\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u5728\u540c\u4e00\u4e2a\u7f51\u7edc\u4e2d\uff0c\u5b83\u4eec\u53ef\u4ee5\u76f4\u63a5\u76f8\u4e92\u901a\u4fe1\u3002 </p> <p> </p> <p>\u63a7\u5236\u5e73\u9762\u7684\u6d41\u91cf\uff08\u914d\u7f6e\u66f4\u65b0\u3001\u8bc1\u4e66\u7b7e\u7f72\uff09\u662f\u901a\u8fc7Gatewey\u53d1\u9001\u7684\u3002 </p> <p>\u865a\u62df\u673a\u88ab\u914d\u7f6e\u4e86\u7f51\u5173\u5730\u5740\uff0c\u6240\u4ee5\u5b83\u4eec\u5728\u542f\u52a8\u65f6\u53ef\u4ee5\u8fde\u63a5\u5230\u63a7\u5236\u5e73\u9762</p>"},{"location":"chap8/7Istio_adv_feas/#2-2","title":"2-2 \u591a\u7f51\u7edc\u67b6\u6784","text":"<p>\u591a\u7f51\u7edc\u67b6\u6784\u6a2a\u8de8\u591a\u4e2a\u7f51\u7edc\u3002Kubernetes\u96c6\u7fa4\u5728\u4e00\u4e2a\u7f51\u7edc\u5185\uff0c\u800c\u865a\u62df\u673a\u5219\u5728\u53e6\u4e00\u4e2a\u7f51\u7edc\u5185\u3002\u8fd9\u4f7f\u5f97Kubernetes\u96c6\u7fa4\u4e2d\u7684Pod\u548c\u865a\u62df\u673a\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u65e0\u6cd5\u76f4\u63a5\u76f8\u4e92\u901a\u4fe1 </p> <p> </p> <p>\u6240\u6709\u7684\u6d41\u91cf\u63a7\u5236\u5e73\u9762\u548cpod\u5230\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6d41\u91cf\u90e1\u6d41\u7ecf\u7f51\u5173\u7f51\u5173\u4f5c\u4e3a\u4e24\u4e2a\u7f51\u7edc\u4e4b\u95f4\u7684\u6865\u6881 </p>"},{"location":"chap8/7Istio_adv_feas/#2-3-istio","title":"2-3 Istio\u4e2d\u5982\u4f55\u8868\u793a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\uff1f","text":"<p>\u5728Istio\u670d\u52a1\u7f51\u683c\u4e2d\u6709\u4e24\u79cd\u65b9\u5f0f\u91c7\u8868\u793a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d </p> <p>\u5de5\u4f5c\u8d1f\u8f7d\u7ec4(WorkloadGroup\u8d44\u6e90\uff09\u7c7b\u4f3c\u4e8eKubernetes \u4e2d\u7684\u90e8\u7f72(Deployments)\u5b83\u4ee3\u8868\u4e86\u5171\u4eab\u5171\u540c\u5c5e\u6027\u7684\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u903b\u8f91\u7ec4 </p> <p>\u63cf\u8ff0\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee(WorkloadEntry\u8d44\u6e90\uff09\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee\u7c7b\u4f3c\u4e8ePod\u5b83\u4ee3\u8868\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5355\u4e00\u5b9e\u4f8b </p> <p>\u8bf7\u6ce8\u610f\uff0c\u521b\u5efa\u8d44\u6e90\u5c06\u4e0d\u4f1a\u63d0\u4f9b\u6216\u8fd0\u884c\u4efb\u4f55\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u4e70\u4f8b\u3002\u8fd9\u4e9b\u8d44\u6e90\u53ea\u662f\u7528\u6765\u5f15\u7528\u6216\u6307\u5411\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u3002Istio\u4f7f\u7528\u5b83\u4eec\u6765\u4e86\u89e3\u5982\u4f55\u9002\u5f53\u62bd\u914d\u7f6e\u7f51\u683c\u5c06\u54ea\u4e9b\u670b\u52a1\u6dfb\u52a0\u5230\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u7b49\u7b49</p> <p>\u4e3a\u4e86\u5c06\u865a\u62df\u673a\u6dfb\u52a0\u5230\u7f51\u683c\u4e2d\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u7ec4\u4f5c\u4e3a\u6478\u677f\u3002\u7136\u540e\u5f53\u6211\u4eec\u914d\u7f6e\u5e76\u5c06\u865a\u62df\u673a\u6dfb\u52a0\u5230\u7f51\u683c\u4e2d\u65f6\u63a7\u5236\u5e73\u9762\u4f1a\u76ee\u52a8\u521b\u5efa\u4e00\u4e2a\u76f8\u5e94\u7684WorkloadEntry</p> <p>\u6211\u4eec\u5df2\u7ecf\u63d0\u5230WorkloadEntry\u7684\u4f5c\u7528\u7c7b\u4f3c\u4e8ePod\u3002\u5728\u6dfb\u52a0\u865a\u62df\u673a\u65f6\u4f1a\u521b\u5efa<code>WorkloadEntry</code>\u8d44\u6e90\u800c\u5f53\u865a\u62df\u673a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4ece\u7f51\u683c\u4e2d\u79fb\u9664\u65f6\u8be5\u8d44\u6e90\u4f1a\u88ab\u76ee\u52a8\u5220\u9664 </p> <p>\u9664\u4e86<code>WorkloadEntry</code>\u8d44\u6e90\u5916\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2aKubernetes\u670d\u52a1\u3002\u521b\u5efa\u4e00\u4e2aKubernetes\u670d\u52a1\u7ed9\u4e86\u6211\u4eec\u4e00\u4e2a\u7a33\u8db3\u7684\u4e3b\u673a\u540d\u548cIP\u5730\u5740\u4ee5\u4fbf\u4f7f\u7528\u9009\u62e9\u5668\u5b57\u6bb5\u8bbf\u95ee\u865a\u4f3c\u673a\u5de5\u4f5c\u8d1f\u8f7d\u548cpod\u3002\u8fd9\u4e5f\u4fbf\u6211\u4eec\u80fd\u591f\u901a\u8fc7<code>DestinationRule</code>\u548c<code>Virtualservice</code>\u8d44\u6e90\u4fbf\u7528<code>Istio</code>\u7684\u8def\u7531\u529f\u80fd</p>"},{"location":"chap8/7Istio_adv_feas/#3istio-mesh","title":"3\u3001\u5c06\u865a\u62df\u673a\u5f15\u5165\u5230Istio Mesh","text":"<p>\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u5c06\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u5230Kubernetes\u96c6\u7fa4\u4e0a\u8fd0\u884c\u7684 Istio\u670d\u52a1\u7f51\u683c\u3002Kubernetes\u96c6\u7fa4\u548c\u865a\u62df\u673a\u90fd\u5c06\u5728\u8c37\u6b4c\u4e91\u5e73\u53f0\uff08GCP)\u4e0a\u8fd0\u884c\u3002\u6211\u4eec\u5c06\u4f7f\u7528\u5355\u4e00\u7f51\u7edc\u67b6\u6784 </p> <p>\u5728\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2aKubernetes\u96c6\u7fa4\u540e\u6211\u4eec\u53ef\u4ee5\u4e0b\u8f7d\u3001\u5b89\u88c5\u548c\u914d\u7f6eIstio.</p>"},{"location":"chap8/7Istio_adv_feas/#3-1-kubernetesistio","title":"3-1 \u5728Kubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5Istio","text":"<p>\u8ba9\u6211\u4eec\u4e0b\u8f7d<code>Istio 1.10.3</code> </p> <pre><code>$ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh -\n</code></pre> <p>\u4e0b\u8f7d\u4e86Istio\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>IstioOperator</code>\u6765\u5b89\u88c5\u5b83\uff0c\u5b83\u53ef\u4ee5\u8bbe\u7f6e\u7f51\u683cID\u3001\u96c6\u7fa4\u540d\u79f0\u548c\u7f51\u7edc\u540d\u79f0\u3002\u7f51\u7edc\u540d\u79f0\u5c06\u662f\u7a7a\u7684\u56e0\u4e3a\u6211\u4eec\u8981\u7528\u5355\u4e00\u7f51\u7edc\u67b6\u6784 </p> <p>\u8ba9\u6211\u4eec\u6765\u8bbe\u7f6e\u51e0\u4e2a\u73af\u5883\u53d8\u91cf\u6211\u4eec\u5c06\u5728\u672c\u5b9e\u9a8c\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u53d8\u91cf </p> <pre><code>export SERVICE_ACCOUNT=\"vm-sa\"\nexport VM_APP=\"hello-vm\"\nexport VM_NAMESPACE=\"vm-namespace\"\nexport WORK_DIR=\"${HOME}/vmfiles\"\nexport CLUSTER_NETWORK=\"\"\nexport VM_NETWORK=\"\"\nexport CLUSTER=\"Kubernetes\"\n</code></pre> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u521b\u5efa<code>$WORK_DIR</code>\u5728\u8fd9\u91cc\u6211\u4eec\u5c06\u5b58\u50a8\u8bc1\u4e66\u548c\u5176\u4ed6\u6211\u4eec\u5fc5\u987b\u590d\u5236\u5230\u865a\u62df\u673a\u4e0a\u7684\u6587\u4ef6 </p> <pre><code>istioctl operator init\nmkdir -p $WORK_DIR\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u521d\u59cb\u5316<code>Istio Operator</code>\u5e76\u5b89\u88c5Istio: </p> <p>\u4e00\u65e6<code>Operator</code>\u88ab\u521d\u59cb\u5316\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa<code>IstioOperator</code>\u8d44\u6e90\uff0c\u6307\u5b9a\u7f51\u683cID\u3001\u96c6\u7fa4\u540d\u79f0\u548c\u7f51\u7edc\u5e76\u5b89\u88c5<code>Istio</code>: </p> <pre><code>cat &lt;&lt; EOF | kubectl apply -f -\napiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nmetadata:\n  name: istio\n  namespace: istio-system\nspec:\n  values:\n   global:\n    meshID: mesh1\n    multiCluster:\n     clusterName: \"${CLUSTER}\"\n    network: \"${CLUSTER_NETWORK}\"\nEOF\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>kubectl get iop -n istio-system</code>\u547d\u4ee4\u6765\u68c0\u67e5<code>Istio</code>\u5b89\u88c5\u72b6\u6001\u4f55\u65f6\u53d8\u4e3a\u5065\u5eb7 </p> <p>\u5728\u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u5c06\u5b89\u88c5\u4e1c\u897f\u5411\u7f51\u5173\u3002\u8fd9\u662f\u63a7\u5236\u5e73\u9762\u7528\u6765\u4e0e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5bf9\u8bdd\u7684\u7f51\u5173\uff0c\u53cd\u4e4b\u4ea6\u7136</p> <p><code>gen-eastwest-gateway.sh</code>\u811a\u672c\u662f\u6211\u4eec\u4e4b\u524d\u4e0b\u8f7d\u7684Istio\u5305\u7684\u4e00\u90e8\u5206\u3002\u5c06\u6587\u4ef6\u5939\u6539\u4e3a\uff08\u6216\u4f60\u89e3\u538b`Istio\u7684\u6587\u4ef6\u5939\uff09\u5e76\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>samples/multicluster/gen-eastwest-gateway.sh --single-cluster | istioctl install -y -f -\n</code></pre> <p><code>gen-eastwesi-gateway.sh</code>\u811a\u672c\u4f7f\u7528\u4e00\u4e2a<code>IstioOperetor</code>\u6765\u90e8\u7f72\u4e00\u4e2a\u989d\u5916\u7684\u7f51\u5173\uff0c\u540d\u4e3a <code>istio-eastwestgateway</code>\u5e76\u914d\u7f6e\u670d\u52a1\u7aef\u53e3\u3002 </p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b<code>istio-system</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u7684<code>Kubernetes</code>\u670d\u52a1\u6765\u68c0\u67e5\u65b0\u7f51\u5173\u6700\u540e\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u914d\u7f6e\u7f51\u5173\uff0c\u901a\u8fc7\u5b83\u6765\u66b4\u9732\u63a7\u5236\u5e73\u9762\uff08<code>istiod</code>)\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u90e8\u7f72<code>expose-istiod.yaml</code>\u6587\u4ef6\u6765\u505a\u5230\u8fd9\u4e00\u70b9\uff1a </p> <pre><code>$ kubectl apply -n istio-system -f samples/multicluster/expose-istiod.yaml\ngateway.networking.istio.io/istiod-gateway created\nvirtualservice.networking.istio.io/istiod-vs created\n</code></pre>"},{"location":"chap8/7Istio_adv_feas/#3-2","title":"3-2 \u51c6\u5907\u865a\u62df\u673a\u547d\u540d\u7a7a\u95f4\u548c\u6587\u4ef6","text":"<p>\u5bf9\u4e8e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6211\u4eec\u5fc5\u987b\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u547d\u540d\u7a7a\u95f4\u6765\u5b58\u50a8<code>WorkloadEntry</code>\u8d44\u6e90\u548c\u4efb\u4f55\u5176\u4ed6\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u76f8\u5173\u7684\u8d44\u6e90\u3002</p> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u5fc5\u987b\u5bfc\u51fa\u96c6\u7fa4\u73af\u5883\u6587\u4ef6\u3001\u4ee4\u724c\u3001\u8bc1\u4e66\u548c\u5176\u4ed6\u6211\u4eec\u5fc5\u987b\u8f6c\u79fb\u5230\u865a\u62df\u673a\u4e0a\u7684\u6587\u4ef6\u3002 </p> <p>\u6211\u4eec\u5c06\u628a\u6240\u6709\u6587\u4ef6\u5b58\u653e\u5728\u6211\u4eec\u5728\u5b9e\u9a8c\u5f00\u59cb\u65f6\u521b\u5efa\u7684\u4e32<code>$WORK_DIR</code>\u4e2d\u8ba9\u6211\u4eec\u5728\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u865a\u62df\u673a\u547d\u540d\u7a7a\u95f4\u548c\u6211\u4eec\u5c06\u7528\u4e8e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\uff1a </p> <pre><code>$ kubectl create ns \"${VM_NAMESPACE}\"\nnamespace/vm-namespace created\n\n$ kubectl create serviceaccount \"${SERVICE_ACCOUNT}\" -n \"${VM_NAMESPACE}\"\nserviceaccount/vm-sa created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a<code>WorkloadGroup</code>\u8d44\u6e90\u5e76\u5c06\u5176\u4fdd\u5b58\u5230<code>workloadgroup.yaml</code>\u4e2d\uff1a</p> <pre><code>cat &lt;&lt;EOF &gt; workloadgroup.yaml\napiVersion: networking.istio.io/v1alpha3\nkind: WorkloadGroup\nmetadata:\n  name: \"${VM_APP}\"\n  namespace: \"${VM_NAMESPACE}\"\nspec:\n  metadata:\n   labels:\n    app: \"${VM_APP}\"\n  template:\n   serviceAccount: \"${SERVICE_ACCOUNT}\"\n   network: \"${VM_NETWORK}\"\nEOF\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a<code>WorkloadGroup</code>\u8d44\u6e90\u5e76\u5c06\u5176\u4fdd\u5b58\u5230<code>workloadgroup.yaml</code>\u4e2d\uff1a </p> <pre><code>$ kubectl apply -n istio-system -f samples/multicluster/expose-istiod.yaml\ngateway.networking.istio.io/istiod-gateway created\nvirtualservice.networking.istio.io/istiod-vs created\n\n$ kubectl create ns \"${VM_NAMESPACE}\"\nnamespace/vm-namespace created\n\n$ kubectl create serviceaccount \"${SERVICE_ACCOUNT}\" -n \"${VM_NAMESPACE}\"\nserviceaccount/vm-sa created\n</code></pre> <pre><code>$ istioctl x workload entry configure -f workloadgroup.yaml -o \"${WORK_DIR}\" --clusterID \"${CLUSTER}\"\nWarning: a security token for namespace \"vm-namespace\" and service account \"vm-sa\" has been generated and stored at \"/vmfiles/istio-token\" \nconfiguration generation into directory /vmfiles was successful\n</code></pre>"},{"location":"chap8/7Istio_adv_feas/#3-3","title":"3-3 \u914d\u7f6e\u865a\u62df\u673a","text":"<p>\u73b0\u5728\u662f\u65f6\u5019\u521b\u5efa\u548c\u914d\u7f6e\u4e00\u4e2a\u865a\u62df\u673a\u4e86\u3002GCP\u4e2d\u8fd0\u884c\u8fd9\u4e2a\u865a\u62df\u673a\u5c31\u50cfKubernetes\u96c6\u7fa4\u4e00\u6837\u3002\u865a\u62df\u673a\u4f7f\u7528\u7684\u662f<code>Debian CNU/Linux10\uff08Buster</code> \u955c\u50cf\u3002\u786e\u4fdd\u4f60\u5728\u9632\u706b\u5899\u90e8\u5206\u52fe\u9009\u4e86\u5141\u8bb8HTTP\u6d41\u91cf\u5e76\u4e14\u4f60\u6709SSH\u8bbf\u95ee\u8be5\u5b9e\u4f8b\u7684\u6743\u9650 </p> <p>**\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u6211\u4eec\u572880\u7aef\u53e3\u8fd0\u884c\u4e00\u4e2a\u7b80\u5355\u7684<code>Python HTTP</code>\u670d\u52a1\u5668\u3002\u4f60\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u7aef\u53e3\u4e0a\u914d\u7f6e\u4efb\u4f55\u5176\u4ed6\u670d\u52a1\u3002\u53ea\u8981\u786e\u4fdd\u4f60\u914d\u7f6e\u4e86\u76f8\u5e94\u7684\u5b89\u5168\u548c\u9632\u706b\u5899\u89c4\u5219. **</p> <p>1.\u5c06<code>$WORK_DIR</code>\u4e2d\u7684\u6587\u4ef6\u590d\u5236\u5230\u5b9e\u4f8b\u7684\u4e3b\u6587\u4ef6\u5939\u4e2d\u3002\u76f8\u5e94\u5730\u66ff\u6362<code>USERNAME</code>\u548c<code>INSTANCE_IP</code></p> <pre><code>$ scp $WORK_DIR/* [USERNAME]@[INSTANCE_IP]:~\nEnter passphrase for key '/Users/peterj/.ssh/id_rsa':\nbash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)\ncluster.env                     100% 589  12.6KB/s  00:00\nhosts                        100%  38   0.8KB/s  00:00\nistio-token                     100% 906  19.4KB/s  00:00\nmesh.yaml                      100% 667  14.4KB/s  00:00\nroot-cert.pem                    100% 1094  23.5KB/s  00:00\n</code></pre> <p>\u6216\u8005\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528<code>gcloud</code>\u547d\u4ee4\u548c\u4e70\u4f8b\u540d\u79f0\uff1a</p> <pre><code>gcloud compute scp --zone=us-west1-b ${WORK_DIR}/* [INSTANCE_NAME]:~\n</code></pre> <p>2.SSH\u8fdb\u5165\u5b9e\u4f8b,\u5c06\u6839\u8bc1\u4e66\u590d\u5236\u5230<code>/etc/certs</code></p> <pre><code>sudo mkdir -p /etc/certs\nsudo cp root-cert.pem /etc/certs/root-cert.pem\n</code></pre> <p>3.\u62f7\u8d1d<code>istio-token</code> \u6587\u4ef6\u5230<code>/var/run/secrets/tokens</code>\u76ee\u5f55</p> <pre><code>sudo mkdir -p /var/run/secrets/tokens\nsudo cp istio-token /var/run/secrets/tokens/istio-token\n</code></pre> <p>4.\u4e0b\u8f7d\u548c\u5b89\u88c5 Istio sidecar \u5305\uff1a</p> <pre><code>curl -LO https://storage.googleapis.com/istio-release/releases/1.10.3/deb/istio-sidecar.deb\nsudo dpkg -i istio-sidecar.deb\n</code></pre> <p>5.\u62f7\u8d1d<code>cluster.env</code>\u5230<code>/var/lib/istio/envoy/</code> </p> <pre><code>sudo cp cluster.env /var/lib/istio/envoy/cluster.env\n</code></pre> <p>6.\u5c06<code>Mesh</code>\u914d\u7f6e\uff08<code>mesh.yaml</code>)\u6dfb\u52a0\u5230<code>/etc/istio/config/mesh</code></p> <pre><code>sudo cp mesh.yaml /etc/istio/config/mesh\n</code></pre> <p>7.\u5c06 <code>istiod host</code> \u6dfb\u52a0\u5230 <code>/etc/hosts</code></p> <pre><code>sudo sh -c 'cat $(eval echo ~$SUDO_USER)/hosts &gt;&gt; /etc/hosts'\n</code></pre> <p>8.\u5c06<code>/etc/certs</code> \u548c<code>/var/lib/istio/envoy</code> \u7684\u6240\u6709\u8005\u4fee\u6539\u4e3aistio proxy:</p> <pre><code>sudo mkdir -p /etc/istio/proxy\nsudo chown -R istio-proxy /var/lib/istio /etc/certs /etc/istio/proxy /etc/istio/config /var/run/secrets /etc/certs/root-cert.pem\n</code></pre> <p>\u4ee5\u4e0a\u90fd\u5c31\u7eea\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u865a\u62df\u673a\u4e2d\u542f\u52a8 Istio\uff1a</p> <pre><code>sudo systemctl start istio\n</code></pre> <p>\u865a\u62df\u673a\u88ab\u914d\u7f6e\u4e3a\u4e0eKubernetes\u96c6\u7fa4\u4e2dIstio\u7684\u63a7\u5236\u5e73\u9762\u901a\u4fe1 </p>"},{"location":"chap8/7Istio_adv_feas/#3-4","title":"3-4 \u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u670d\u52a1","text":"<p>\u4ece\u865a\u62df\u673a\u8bbf\u95ee\u670d\u52a1 \u8ba9\u6211\u4eec\u5728Kubernetes\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e00\u4e2a<code>Hello word</code>\u5e94\u7528\u7a0b\u5e8f\u3002\u9996\u5148\u6211\u4eec\u9700\u8981\u5728<code>default</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u542f\u7528\u81ea\u52a8<code>sidecar</code>\u6ce8\u5165</p> <p><code>hello-world.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hello-world\n  labels:\n    app: hello-world\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: hello-world\n  template:\n    metadata:\n      labels:\n        app: hello-world\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/hello-world:1.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: hello-world\n  labels:\n    app: hello-world\nspec:\n  selector:\n    app: hello-world\n  ports:\n    - port: 80\n      name: http\n      targetPort: 3000\n</code></pre> <p>\u7b49\u5f85Pod\u51c6\u5907\u597d\u7136\u540e\u56de\u5230\u865a\u62df\u673a\u4e0a\u5c1d\u8bd5\u8bbf\u95ee<code>Kubernetes</code>\u670d\u52a1 </p> <pre><code>$ curl http://hello-world.default\nHello World\n</code></pre> <p>\u4f60\u53ef\u4ee5\u4ece\u865a\u62df\u673a\u4e0a\u8bbf\u95ee\u5728\u4f60\u7684Kubernetes\u96c6\u7fa4\u5185\u8fd0\u884c\u7684\u4efb\u4f55\u670d\u52a1 </p>"},{"location":"chap8/7Istio_adv_feas/#3-5","title":"3-5 \u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u670d\u52a1","text":"<p>\u6211\u4eec\u4e5f\u53f8\u4ee5\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u3002\u5207\u6362\u5230\u5b9e\u4f8b\u4e0a\u8fd0\u884c\u4e00\u4e2a\u7b80\u5355\u7684<code>Python HTTP</code>\u670d\u52a1\u5668 </p> <pre><code>$ sudo python3 -m http.server 80\nServing HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...\n</code></pre> <p>\u5982\u679c\u4f60\u8bd5\u56fe\u76f4\u63a5 curl \u5230\u5b9e\u4f8b IP\uff0c\u4f60\u4f1a\u5f97\u5230\u4e00\u4e2a\u54cd\u5e94\uff08\u76ee\u5f55\u5217\u8868\uff09\u3002</p> <pre><code>$ curl [INSTANCE_IP]\n&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\" \"http://www.w3.org/TR/html4/strict.dtd\"&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"&gt;\n&lt;title&gt;Directory listing for /&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Directory listing for /&lt;/h1&gt;\n&lt;hr&gt;\n...\n</code></pre> <p>\u4f46\u6211\u4eec\u8981\u505a\u7684\u662f\u5c06\u5de5\u4f5c\u8d1f\u8f7d\uff08Python HTTP\u670d\u52a1\uff09\u6dfb\u52a0\u5230\u7f51\u683c\u4e2d\u3002\u51fa\u4e8e\u8fd9\u4e2a\u539f\u56e0\u6211\u4eec\u5728\u524d\u9762\u521b\u5efa\u4e86\u865a\u62df\u673a\u547d\u540d\u7a7a\u95f4\u6240\u4ee5\u8ba9\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u4ee3\u8868\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u6548\u7684<code>Kubernetes</code>\u670d\u52a1</p> <p>\u6ce8\u610f\uff0c\u540d\u79f0\u548c\u6807\u7b7e\u503c\u7b49\u4e8e\u6211\u4eec\u4e4b\u524d\u8bbe\u7f6e\u7684<code>VM_APP</code>\u73af\u8c19\u604b\u660c\u7684\u503c\u3002\u4e0d\u8981\u5fd8\u8bb0\u5c06\u670d\u52a1\u90e8\u7f72\u5230<code>VM_NAMESPACE</code> </p> <p><code>hello-vm-service.yaml</code></p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: hello-vm\n  labels:\n    app: hello-vm\nspec:\n  ports:\n  - port: 80\n    name: http-vm\n    targetPort: 80\n  selector:\n    app: hello-vm\n</code></pre> <pre><code>kubectl apply -f hello-vm-service.yaml -n vm-namespace\n</code></pre> <p>\u5c06\u5176\u90e8\u7f72\u5230VM\u547d\u540d\u7a7a\u95f4\uff0c\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u4fbf\u7528\u4e70\u9a8c\u6027\u7684\u865a\u62df\u673a\u76ee\u52a8\u6ce8\u518c\u5b83\u5c06\u81ea\u52a8\u521b\u5efa<code>WorkloadEntry</code>\u8d44\u6e90\u6211\u4eec\u9700\u8981\u624b\u52a8\u521b\u5efa\u5b83\u4eec </p> <p>\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u4ee3\u8868\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684<code>WorkloadEntry</code>\u2014\u2014\u8be5\u8d44\u6e90\u4f7f\u7528\u865a\u62df\u673a\u670d\u52a1\u8d26\u6237(<code>SERVICE_ACCOUNT</code>)\u548c\u6807\u7b7e\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u540d\u79f0\uff08<code>VM_APP</code>\uff09\u3002 </p> <p>\u6ce8\u610f\uff0c\u6211\u4eec\u8fd8\u9700\u83b7\u5f97\u865a\u62df\u673a\u7684\u5185\u90e8<code>IP</code>\u5730\u5740\uff0c \u8fd9\u6837Istio\u5c31\u77e5\u9053\u5728\u54ea\u91cc\u53ef\u4ee5\u5230\u8fbe\u865a\u62df\u673a\u3002\u8ba9\u6211\u4eec\u628a\u5b83\u5b58\u50a8\u5728\u53e6\u4e00\u4e2a\u73af\u5883\u53d8\u91cf\u4e2d\uff08\u786e\u4fdd\u7528\u4f60\u7684\u503c\u66ff\u6362<code>INSTANCE_NAME</code>\u548c<code>ZONE</code>)\u3002</p> <pre><code>export VM_IP=$(gcloud compute instances describe [INSTANCE_NAME] --format='get(networkInterfaces[0].networkIP)' --zone=[ZONE])\n</code></pre> <p><code>workloadentry.yaml</code></p> <pre><code>cat &lt;&lt;EOF&gt; workloadentry.yaml\napiVersion: networking.istio.io/v1alpha3\nkind: WorkloadEntry\nmetadata:\n  name: ${VM_APP}\n  namespace: ${VM_NAMESPACE}\nspec:\n  serviceAccount: ${SERVICE_ACCOUNT}\n  address: ${VM_IP}\n  labels:\n   app: ${VM_APP}\n   instance-id: vm1\nEOF\n</code></pre> <pre><code>kubectl apply -n ${VM_NAMESPACE} -f workloadentry.yaml\n</code></pre> <p>\u4e3a\u4e86\u628a\u865a\u62df\u673a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u52a0\u5165\u5230\u7f51\u683c\u5185\u6211\u4eec\u8fd8\u9700\u8981\u5b9a\u4e49ServiceEntry </p> <pre><code>cat &lt;&lt;EOF&gt;&gt; serviceentry.yaml\napiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: ${VM_APP}\nspec:\n  hosts:\n - ${VM_APP}\n  location: MESH_INTERNAL\n  ports:\n - number: 80\n   name: http\n   protocol: HTTP\n   targetPort: 80\n  resolution: STATIC\n  workloadSelector:\n   labels:\n    app: ${VM_APP}\n</code></pre> <p>\u8bf7\u6ce8\u610f\uff0cWorkloadEntry \u548c ServiceEntry \u5728\u672a\u6765\u6700\u7ec8\u5c06\u81ea\u52a8\u521b\u5efa\u3002</p> <pre><code>kubectl apply -n ${VM_NAMESPACE} -f serviceentry.yaml\n</code></pre> <p>\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u4fbf\u7528Kubernetes\u670d\u52a1\u540d\u79f0<code>hello-vm.vm-namespace</code>\u6765\u8bbf\u95ee\u865a\u4f3c\u673a\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8ba9\u6211\u4eec\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\u4e00\u4e2aPod\u5e76\u5c1d\u8bd5\u4ece\u90a3\u91cc\u8bbf\u95ee\u8be5\u670d\u52a1 </p> <pre><code>$ kubectl run curl --image=radial/busyboxplus:curl -i --tty\nIf you don't see a command prompt, try pressing enter.\n[ root@curl:/ ]$\n</code></pre> <p>Pod\u4e2d\u7684\u547d\u4ee4\u63d0\u793a\u540e\u4f60\u53ef\u4ee5\u8fd0\u884ccurl\u5e76\u8bbf\u95ee\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4f60\u5e94\u8be5\u770b\u5230\u4e00\u4e2a\u76ee\u5f55\u5217\u8868\u540c\u6837\u5730\u4f60\u4f1a\u6ce8\u610f\u5230\u5728<code>HTTP</code>\u670d\u52a1\u5668\u8fd0\u884c\u7684\u5b9e\u4f8b\u4e0a\u6709\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\uff1a </p> <pre><code>[ root@curl:/ ]$ curl hello-vm.vm-namespace\n&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\" \"http://www.w3.org/TR/html4/strict.dtd\"&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"&gt;\n&lt;title&gt;Directory listing for /&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Directory listing for /&lt;/h1&gt;\n&lt;hr&gt;\n...\n</code></pre>"},{"location":"chap8/7Istio_adv_feas/#4","title":"4\u3001\u9ad8\u7ea7\u529f\u80fd\u6d4b\u8bd5","text":"<p>1\u3001Istio\u5728\u7f51\u683c\u4e2d\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u79df\u6237\u5355\u4f4d\uff1f</p> <ul> <li>A. Deployment</li> <li>B. \u7528\u6237\u7ec4</li> <li>C. Namespace</li> <li>D. \u96c6\u7fa4</li> </ul> <p>\u5728\u4e00\u4e2a\u7f51\u683c\u4e2dIstio\u4f7f\u7528\u547d\u540d\u7a7a\u95f4\u4f5c\u4e3a\u79df\u6237\u7684\u5355\u4f4d\u3002</p> <p>2\u3001\u4f60\u4f7f\u7528\u54ea\u4e9b\u8d44\u6e90\u5c06\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c\uff1f </p> <ul> <li>A. Deployment \u548c Service</li> <li>B. VirtualService \u548c Deployment</li> <li>C. Ingress \u548c Deployment</li> <li>D. WorkloadGroup \u548c WorkloadEntry</li> </ul> <p>\u5de5\u4f5c\u8d1f\u8f7d\u7ec4(WorkloadGroup\u8d44\u6e90\uff09\u7c7b\u4f3c\u4e8eKubernetes \u4e2d\u7684\u90e8\u7f72(Deployments)\u5b83\u4ee3\u8868\u4e86\u5171\u4eab\u5171\u540c\u5c5e\u6027\u7684\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u903b\u8f91\u7ec4 </p> <p>\u63cf\u8ff0\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee(WorkloadEntry\u8d44\u6e90\uff09\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee\u7c7b\u4f3c\u4e8ePod\u5b83\u4ee3\u8868\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5355\u4e00\u5b9e\u4f8b </p> <p>3\u3001\u4f60\u662f\u5426\u53ef\u4ee5\u901a\u8fc7\u5c06\u6240\u6709\u96c6\u7fa4\u4f5c\u4e3a\u8fdc\u7a0b\u96c6\u7fa4\u6765\u5b9e\u73b0\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u7684\u5b8c\u5168\u5206\u79bb\uff1f\uff08\u662f/\u5426\uff1f)</p> <ul> <li>A \u662f</li> <li>B \u5426</li> </ul> <p>\u53e6\u4e00\u79cd\u90e8\u7f72\u6a21\u5f0f\u662f\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684\u96c6\u7fa4\u90fd\u89c6\u4e3a\u7531\u5916\u90e8\u63a7\u5236\u5e73\u9762\u63a7\u5236\u7684\u8fdc\u7a0b\u96c6\u7fa4\u3002\u8fd9\u4f7f\u6211\u4eec\u5728\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u6709\u4e86\u5b8c\u5168\u7684\u5206\u79bb\u3002</p> <p>4\u3001Istio\u662f\u5982\u4f55\u89e3\u51b3\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u914d\u7f6e\u9694\u79bb\u7684\uff1f </p> <ul> <li>A. \u901a\u8fc7\u4f7f\u7528\u5355\u72ec\u7684\u63a7\u5236\u5e73\u9762</li> <li>B. \u901a\u8fc7\u5728\u96c6\u7fa4\u5916\u5b58\u50a8\u914d\u7f6e</li> <li>C. \u4e0d\u53ef\u884c</li> <li>D \u901a\u8fc7\u5bf9etcd\u4e2d\u7684\u914d\u7f6e\u548c\u79d8\u5bc6\u8fdb\u884c\u52a0\u5bc6 </li> </ul> <p>\u79df\u6237\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u662f\u9694\u79bb\u4e0d\u540c\u79df\u6237\u7684\u914d\u7f6e\u3002\u76ee\u524d\uff0cIstio\u5e76\u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u8fc7\uff0c\u5b83\u901a\u8fc7\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u7684\u8303\u56f4\u914d\u7f6e\u6765\u5c1d\u8bd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898</p> <p>5\u3001\u591a\u96c6\u7fa4\u90e8\u7f72\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f </p> <ul> <li>A \u4e3a\u4e86\u83b7\u5f97\u66f4\u5927\u7a0b\u5ea6\u7684\u9694\u79bb\u548c\u53ef\u7528\u6027\uff0e </li> <li>B \u4e3a\u4e86\u63d0\u9ad8\u670d\u52a1\u7f51\u683c\u7684\u6027\u80fd</li> <li>C \u4e3a\u4e86\u5f15\u865a\u62df\u673a\u8d1f\u8f7d</li> <li>D \u518d\u90e8\u7f72\u591a\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u65f6\uff0c\u4e3a\u4e86\u8282\u7701\u6210\u672c</li> </ul> <p>\u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\u662f\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762\u3002\u5bf9\u4e8e\u6b63\u5e38\u7684\u670d\u52a1\u7f51\u683c\u90e8\u7f72\u89c4\u6a21\u5efa\u8bae\u4f60\u4f7f\u7528\u591a\u7f51\u683c\u90e8\u7f72\uff0c\u5e76\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u7cfb\u7edf\u5728\u5916\u90e8\u534f\u8c03\u7f51\u683c\u3002</p> <p>6\u3001\u4ec0\u4e48\u662f\u79df\u6237\uff1f</p> <ul> <li>A \u5355\u4e2a\u96c6\u7fa4\u53ca\u5176\u6240\u6709\u7528\u6237 </li> <li>**B \u4e00\u7ec4\u7528\u6237\u5171\u4eab\u4e00\u7ec4\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650 **</li> <li>C \u591a\u4e2a\u96c6\u7fa4\u5171\u4eab\u76f8\u540c\u7684\u7528\u6237\u8d26\u6237 </li> <li>D \u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u96c6\u7fa4 </li> </ul> <p>\u79df\u6237\u662f\u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650\u7684\u7528\u6237\u3002\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u901a\u8fc7\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565\u5b8c\u6210\u7684\u3002</p> <p>7\u3001\u90e8\u7f72\u591a\u4e2a\u63a7\u5236\u5e73\u9762\u662f\u5426\u80fd\u63d0\u9ad8\u6210\u672c\u6548\u7387\uff1f\uff08\u662f\uff0f\u5426\uff09 </p> <ul> <li>\u662f</li> <li>\u5426</li> </ul> <p>8\u3001What does the shared control plane model involve?</p> <ul> <li>A \u5728\u4e91\u63d0\u4f9b\u5546\u5904\u5e26\u6709\u63a7\u5236\u5e73\u9762\u7684\u5355\u4e00\u96c6\u7fa4\u90e8\u7f72</li> <li>B \u591a\u4e2a\u96c6\u7fa4\u63a7\u5236\u5e73\u9762\u53ea\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff08\u4e3b\u96c6\u7fa4\uff09 </li> <li>C \u591a\u4e2a\u96c6\u7fa4\uff0c\u6bcf\u4e2a\u96c6\u7fa4\u6709\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\uff0c\u53ef\u4ee5\u5728\u4efb\u4f55\u65f6\u5019\u53d1\u6325\u5171\u4eab\u63a7\u5236\u5e73\u9762\u4f5c\u7528 </li> <li>D \u5728\u4f7f\u7528\u591a\u4e2a\u96bd\u7fa4\u65f6\u80fd\u591f\u56de\u9000\u5230\u4e0d\u540c\u7684\u63a7\u5236\u5e73\u9762 </li> </ul> <p>9\u3001\u4ec0\u4e48\u88ab\u8ba4\u4e3a\u662f\u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\uff1f</p> <ul> <li>A \u6bcf\u4e2a\u96c6\u7fa4\u5171\u4eab\u6570\u636e\u5e73\u9762 </li> <li>B \u6bcf\u4e2a\u96c6\u7fa4\u5171\u4eab\u63a7\u5236\u5e73\u9762 </li> <li>C \u6bcf\u4e2a\u96c6\u7fa4\u90fd\u4f9d\u8d56\u4e00\u4e2a\u63a7\u5236\u6570\u636e\u5e73\u9762 </li> <li>D \u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762 </li> </ul> <p>10\u3001\u4e3a\u4e86\u652f\u6301\u96c6\u7fa4\u79df\u6237\uff0c\u4f60\u9700\u8981\u914d\u7f6e\u591a\u4e2a\u96c6\u7fa4\u6765\u5171\u4eab\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u3002\uff08\u662f\uff0f\u5426\uff1f)</p> <ul> <li>A \u662f </li> <li>B \u5426 </li> </ul> <p>11\u3001\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1f </p> <ul> <li>\u4f7f\u7528namespace </li> <li>\u4f7f\u7528\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565 </li> <li>\u4f7f\u7528EnvoyFilter </li> <li>\u4f7f\u7528Sidecar\u8d44\u6e90 </li> </ul> <p>12\u3001\u5de5\u4f5c\u8d1f\u8f7d\u5e94\u8be5\u5982\u4f55\u5728\u96c6\u7fa4\u4e4b\u95f4\u8fdb\u884c\u901a\u4fe1\uff1f</p> <ul> <li>\u76f4\u63a5\u4ece\u4e00\u4e2aPod\u5230\u53e6\u4e00\u4e2aPod </li> <li>\u901a\u8fc7ingress gateway </li> <li>\u4ece\u4e00\u4e2aKubernetes\u670d\u52a1\u5230\u4e0d\u540c\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e2a\u7aef\u70b9 </li> <li>\u4f7f\u7528\u5916\u90e8gateway </li> </ul>"},{"location":"chap8/8Istio_trouble_shoot/","title":"\u7b2c\u516b\u8282 Istio \u95ee\u9898\u6392\u67e5","text":""},{"location":"chap8/8Istio_trouble_shoot/#1envoy","title":"1\u3001Envoy\u57fa\u7840","text":"<p>\u4e3a\u4e86\u6392\u9664Istio\u7684\u95ee\u9898\uff0c\u5bf9Envoy\u7684\u5de5\u4f5c\u539f\u7406\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u4e86\u89e3\u662f\u5f88\u6709\u5e2e\u52a9\u7684\u3002Envoy\u914d\u7f6e\u662f \u4e00\u4e2aJSON\u6587\u4ef6\uff0c\u5206\u4e3a\u591a\u4e2a\u90e8\u5206\u3002\u6211\u4eec\u9700\u8981\u4e86\u89e3Envoy\u7684\u57fa\u672c\u6982\u5ff5\u662f\u76d1\u542c\u5668\u3001\u8def\u7531\u3001\u96c6\u7fa4\u548c\u7aef\u70b9\u3002 </p> <p>\u8fd9\u4e9b\u6982\u5ff5\u6620\u5c04\u5230istio\u548cKubernetes\u8d44\u6e90\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 </p> <p> </p>"},{"location":"chap8/8Istio_trouble_shoot/#basics-of-envoy","title":"Basics of Envoy","text":"<ul> <li>JSON configuration </li> <li> <p>Basic concepts:</p> <ul> <li>Listeners </li> <li>Routes </li> <li>Cluster</li> <li>Endpoints </li> </ul> </li> <li> <p>Multiple listeners for each sidecar </p> <ul> <li>Inbound: <code>0.0.0.0:15006</code> </li> <li>Outbound: <code>0.0.0.0:15001</code> </li> </ul> </li> <li> <p>Listeners hands off requests off to a virtual listener </p> </li> <li>Default: PassthroughCluster </li> </ul> <p>\u76d1\u542c\u5668\u662f\u547d\u540d\u7684\u7f51\u7edc\u4f4d\u7f6e\uff0c\u901a\u5e38\u662f\u4e00\u4e2aIP\u548c\u7aef\u53e3\u3002Envoy\u5bf9\u8fd9\u4e9b\u4f4d\u7f6e\u8fdb\u884c\u76d1\u542c\uff0c\u8fd9\u662f\u5b83\u63a5\u6536\u548c\u8fde\u63a5\u548c\u8bf7\u6c42\u7684\u5730\u65b9\u3002 </p> <ul> <li>\u6bcf\u4e2asidecar\u90fd\u6709\u591a\u4e2a\u76d1\u542c\u5668\u751f\u6210\u3002\u6bcf\u4e2asidecar\u90fd\u6709\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u5b83\u88ab\u7ed1\u5b9a\u5230 <code>0.0.0.0:15006</code>\u3002</li> <li>\u8fd9\u662f<code>IP Tables</code>\u5c06\u6240\u6709\u5165\u7ad9\u6d41\u91cf\u53d1\u9001\u5230Pod\u7684\u5730\u5740\u3002\u7b2c\u4e8c\u4e2a\u76d1\u542c\u5668\u88ab\u7ed1\u5b9a\u5230<code>0.0.0.0:15001</code>\uff0c\u8fd9\u662f\u6240\u6709\u4ecePod\u4e2d\u51fa\u7ad9\u7684\u6d41\u91cf\u5730\u5740\u3002</li> </ul> <p>\u5f53\u4e00\u4e2a\u8bf7\u6c42\u88ab\u91cd\u5b9a\u5411\uff08\u4f7f\u7528IP Tables\u914d\u7f6e\uff09\u523015001\u7aef\u53e3\u65f6\uff0c\u76d1\u542c\u5668\u4f1a\u628a\u5b83\u4ea4\u7ed9\u4e0e\u8bf7\u6c42\u7684\u539f\u59cb\u76ee\u7684\u5730\u6700\u5339\u914d\u7684\u865a\u62df\u76d1\u542c\u5668\u3002\u5982\u679c\u5b83\u627e\u4e0d\u5230\u76ee\u7684\u5730\uff0c\u5b83\u5c31\u6839\u636e\u914d\u7f6e\u7684 <code>OutboundTrafficPolicy</code>\u6765\u53d1\u9001\u6d41\u91cf\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8bf7\u6c42\u88ab\u53d1\u9001\u5230<code>PassthroughCluster</code>, \u8be5\u96c6\u7fa4\u8fde\u63a5\u5230\u5e94\u7528\u7a0b\u5e8f\u9009\u62e9\u7684\u76ee\u7684\u5730\uff0cEnvoy\u6ca1\u6709\u8fdb\u884c\u4efb\u4f55\u8d1f\u8f7d\u5747\u8861\u3002 </p>"},{"location":"chap8/8Istio_trouble_shoot/#2envoy","title":"2\u3001Envoy\u5b9e\u4f8b","text":"<p>\u8ba9\u6211\u4eec\u4ee5<code>Web</code>\u524d\u7aef\u548c<code>customers</code>\u670d\u52a1\u4e3a\u4f8b\uff0c\u770b\u770b<code>Envoy</code>\u5982\u4f55\u786e\u5b9a\u5c06\u8bf7\u6c42\u4eceWeb\u524d\u7aef\u53d1\u9001\u5230<code>customers</code>\u670d\u52a1\uff08<code>customers.default.svc.cluster.local</code>\uff09\u7684\u4f4d\u7f6e\u3002</p> <p><code>1gateway.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n        - '*'\n</code></pre> <p><code>2webfrontend.yaml</code></p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: web-frontend\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: web-frontend\n  template:\n    metadata:\n      labels:\n        app: web-frontend\n        version: v1\n    spec:\n      serviceAccountName: web-frontend\n      containers:\n        - image: gcr.io/tetratelabs/web-frontend:1.0.0\n          imagePullPolicy: Always\n          name: web\n          ports:\n            - containerPort: 8080\n          env:\n            - name: CUSTOMER_SERVICE_URL\n              value: 'http://customers.default.svc.cluster.local'\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: web-frontend\n  labels:\n    app: web-frontend\nspec:\n  selector:\n    app: web-frontend\n  ports:\n    - port: 80\n      name: http\n      targetPort: 8080\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: web-frontend\nspec:\n  hosts:\n    - '*'\n  gateways:\n    - gateway\n  http:\n    - route:\n        - destination:\n            host: web-frontend.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <p><code>3customersv1.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: customers-v1\n  labels:\n    app: customers\n    version: v1\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: customers\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: customers\n        version: v1\n    spec:\n      containers:\n        - image: gcr.io/tetratelabs/customers:1.0.0\n          imagePullPolicy: Always\n          name: svc\n          ports:\n            - containerPort: 3000\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: customers\n  labels:\n    app: customers\nspec:\n  selector:\n    app: customers\n  ports:\n    - port: 80\n      name: http\n      targetPort: 3000\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n    - 'customers.default.svc.cluster.local'\n  http:\n    - route:\n        - destination:\n            host: customers.default.svc.cluster.local\n            port:\n              number: 80\n</code></pre> <pre><code>kubectl apply -f *.yaml \n</code></pre>"},{"location":"chap8/8Istio_trouble_shoot/#2-1-istioctl-proxy-config","title":"2-1 <code>istioctl proxy-config</code>\u5217\u51fa\u76d1\u542c\u5668","text":"<p>\u4f7f\u7528 <code>istioctl proxy-config</code>\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u5217\u51faweb\u524d\u7aefpod\u7684\u6240\u6709\u76d1\u542c\u5668\u3002 </p> <pre><code>$ istioctl proxy-config listeners web-frontend-74dd5cbcdc-8mfpb\nADDRESS        PORT  MATCH                                                                                           DESTINATION\n10.96.0.10     53    ALL                                                                                             Cluster: outbound|53||kube-dns.kube-system.svc.cluster.local\n0.0.0.0        80    Trans: raw_buffer; App: HTTP                                                                    Route: 80\n0.0.0.0        80    ALL                                                                                             PassthroughCluster\n10.104.176.79  443   ALL                                                                                             Cluster: outbound|443||istio-egressgateway.istio-system.svc.cluster.local\n10.105.159.70  443   ALL                                                                                             Cluster: outbound|443||istio-ingressgateway.istio-system.svc.cluster.local\n10.96.0.1      443   ALL                                                                                             Cluster: outbound|443||kubernetes.default.svc.cluster.local\n10.96.216.110  443   ALL                                                                                             Cluster: outbound|443||istiod.istio-system.svc.cluster.local\n10.106.113.25  3000  Trans: raw_buffer; App: HTTP                                                                    Route: grafana.istio-system.svc.cluster.local:3000\n10.106.113.25  3000  ALL                                                                                             Cluster: outbound|3000||grafana.istio-system.svc.cluster.local\n0.0.0.0        8383  Trans: raw_buffer; App: HTTP                                                                    Route: 8383\n0.0.0.0        8383  ALL                                                                                             PassthroughCluster\n10.100.136.154 9000  Trans: raw_buffer; App: HTTP                                                                    Route: minio.velero.svc.cluster.local:9000\n10.100.136.154 9000  ALL                                                                                             Cluster: outbound|9000||minio.velero.svc.cluster.local\n10.100.136.154 9001  Trans: raw_buffer; App: HTTP                                                                    Route: minio.velero.svc.cluster.local:9001\n10.100.136.154 9001  ALL                                                                                             Cluster: outbound|9001||minio.velero.svc.cluster.local\n0.0.0.0        9090  Trans: raw_buffer; App: HTTP                                                                    Route: 9090\n0.0.0.0        9090  ALL                                                                                             PassthroughCluster\n10.96.0.10     9153  Trans: raw_buffer; App: HTTP                                                                    Route: kube-dns.kube-system.svc.cluster.local:9153\n10.96.0.10     9153  ALL                                                                                             Cluster: outbound|9153||kube-dns.kube-system.svc.cluster.local\n0.0.0.0        9411  Trans: raw_buffer; App: HTTP                                                                    Route: 9411\n0.0.0.0        9411  ALL                                                                                             PassthroughCluster\n0.0.0.0        15001 ALL                                                                                             PassthroughCluster\n0.0.0.0        15001 Addr: *:15001                                                                                   Non-HTTP/Non-TCP\n0.0.0.0        15006 Addr: *:15006                                                                                   Non-HTTP/Non-TCP\n0.0.0.0        15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0                        InboundPassthroughClusterIpv4\n0.0.0.0        15006 Trans: raw_buffer; App: HTTP; Addr: 0.0.0.0/0                                                   InboundPassthroughClusterIpv4\n0.0.0.0        15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0                                                       InboundPassthroughClusterIpv4\n0.0.0.0        15006 Trans: raw_buffer; Addr: 0.0.0.0/0                                                              InboundPassthroughClusterIpv4\n0.0.0.0        15006 Trans: tls; Addr: 0.0.0.0/0                                                                     InboundPassthroughClusterIpv4\n0.0.0.0        15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:8080 Cluster: inbound|8080||\n0.0.0.0        15006 Trans: raw_buffer; Addr: *:8080                                                                 Cluster: inbound|8080||\n0.0.0.0        15010 Trans: raw_buffer; App: HTTP                                                                    Route: 15010\n0.0.0.0        15010 ALL                                                                                             PassthroughCluster\n10.96.216.110  15012 ALL                                                                                             Cluster: outbound|15012||istiod.istio-system.svc.cluster.local\n0.0.0.0        15014 Trans: raw_buffer; App: HTTP                                                                    Route: 15014\n0.0.0.0        15014 ALL                                                                                             PassthroughCluster\n0.0.0.0        15021 ALL                                                                                             Inline Route: /healthz/ready*\n10.105.159.70  15021 Trans: raw_buffer; App: HTTP                                                                    Route: istio-ingressgateway.istio-system.svc.cluster.local:15021\n10.105.159.70  15021 ALL                                                                                             Cluster: outbound|15021||istio-ingressgateway.istio-system.svc.cluster.local\n0.0.0.0        15090 ALL                                                                                             Inline Route: /stats/prometheus*\n10.105.159.70  15443 ALL                                                                                             Cluster: outbound|15443||istio-ingressgateway.istio-system.svc.cluster.local\n0.0.0.0        20001 Trans: raw_buffer; App: HTTP                                                                    Route: 20001\n0.0.0.0        20001 ALL                                                                                             PassthroughCluster\n10.105.159.70  31400 ALL                                                                                             Cluster: outbound|31400||istio-ingressgateway.istio-system.svc.cluster.local\n</code></pre> <p>\u4eceWeb\u524d\u7aef\u5230customers\u7684\u8bf7\u6c42\u662f\u4e00\u4e2a\u5411\u5916\u7684HTTP\u8bf7\u6c42\uff0c\u7aef\u53e3\u4e3a80\u3002</p> <p>\u8fd9\u610f\u5473\u7740\u5b83\u88ab\u79fb\u4ea4\u7ed9\u4e86<code>0.0.0.0:80</code>\u7684\u865a\u62df\u76d1\u542c\u5668\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>Istio CLI</code>\u6309\u5730\u5740\u548c\u7aef\u53e3\u6765\u8fc7\u6ee4\u76d1\u542c\u5668\u3002</p> <p> </p> <p>\u4f60\u53ef\u4ee5 \u6dfb\u52a0<code>-o json</code>\u6765\u83b7\u5f97\u76d1\u542c\u5668\u7684JSON\u8868\u793a\uff1a </p> <pre><code>$ istioctl proxy-config listeners web-frontend-74dd5cbcdc-8mfpb --address 0.0.0.0 --port 80 -o json\n\n...\n\"statPrefix\": \"outbound_0.0.0.0_80\",\n\"rds\": {\n    \"configSource\": {\n        \"ads\": {},\n        \"initialFetchTimeout\": \"0s\",\n        \"resourceApiVersion\": \"V3\"\n    },\n    \"routeConfigName\": \"80\"\n},\n...\n</code></pre> <p>Listener\u4f7f\u7528RDS\uff08\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff09\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f80)\u3002\u8def\u7531\u9644\u5c5e\u4e8e\u76d1\u542c\u5668\uff0c\u5305\u542b\u5c06\u865a\u62df\u4e3b\u673a\u6620\u5c04\u5230\u96c6\u7fa4\u7684\u89c4\u5219\u3002\u8fd9\u5141\u8bb8\u6211\u4eec\u521b\u5efa\u6d41\u91cf\u8def\u7531\u89c4\u5219\uff0c\u56e0\u4e3aEnvoy\u53ef\u4ee5\u67e5\u770b\u5934\u6587\u4ef6\u6216\u8def\u5f84\uff08\u8bf7\u6c42\u5143\u6570\u636e\uff09\u5e76\u5bf9\u6d41\u91cf\u8fdb\u884c\u8def\u7531\u3002</p> <p>\u8def\u7531\uff08route)\u9009\u62e9\u96c6\u7fa4\uff08cluster)\u3002\u96c6\u7fa4\u662f\u4e00\u7ec4\u63a5\u53d7\u6d41\u91cf\u7684\u7c7b\u4f3c\u7684\u4e0a\u6e38\u4e3b\u673a\u2014\u2014\u5b83\u662f\u4e00\u4e2a\u7aef\u70b9\u7684\u96c6\u5408\u3002\u4f8b\u5982\uff0cWeb\u524d\u7aef\u670d\u52a1\u7684\u6240\u6709\u5b9e\u4f8b\u7684\u96c6\u5408\u5c31\u662f\u4e00\u4e2a\u96c6\u7fa4\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u96c6\u7fa4\u5185\u914d\u7f6e\u5f39\u6027\u529f\u80fd\uff0c\u5982\u65ad\u8def\u5668\u3001\u79bb\u7fa4\u68c0\u6d4b\u548cTLS\u914d\u7f6e\u3002</p> <p>\u4f7f\u7528routes\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u540d\u79f0\u8fc7\u6ee4\u6240\u6709\u7684\u8def\u7531\u6765\u83b7\u5f97\u8def\u7531\u7684\u8be6\u7ec6\u4fe1\u606f\u3002 </p> <pre><code>$ istioctl proxy-config routes web-frontend-74dd5cbcdc-8mfpb --address 0.0.0.0 --port 80 -o json\n\n\n\n[\n    {\n        \"name\": \"80\",\n        \"virtualHosts\": [\n            {\n                \"name\": \"allow_any\",\n                \"domains\": [\n                    \"*\"\n                ],\n                \"routes\": [\n                    {\n                        \"name\": \"allow_any\",\n                        \"match\": {\n                            \"prefix\": \"/\"\n                        },\n                        \"route\": {\n                            \"cluster\": \"PassthroughCluster\",\n                            \"timeout\": \"0s\",\n                            \"maxGrpcTimeout\": \"0s\"\n                        }\n                    }\n                ],\n                \"includeRequestAttemptCount\": true\n            },\n            {\n                \"name\": \"customers.default.svc.cluster.local:80\",\n                \"domains\": [\n                    \"customers.default.svc.cluster.local\",\n                    \"customers.default.svc.cluster.local:80\",\n                    \"customers\",\n                    \"customers:80\",\n                    \"customers.default.svc\",\n                    \"customers.default.svc:80\",\n                    \"customers.default\",\n                    \"customers.default:80\",\n                    \"10.109.29.3\",\n                    \"10.109.29.3:80\"\n                ],\n                \"routes\": [\n                    {\n                        \"match\": {\n                            \"prefix\": \"/\"\n                        },\n                        \"route\": {\n                            \"cluster\": \"outbound|80||customers.default.svc.cluster.local\",\n                            \"timeout\": \"0s\",\n                            \"retryPolicy\": {\n                                \"retryOn\": \"connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes\",\n                                \"numRetries\": 2,\n                                \"retryHostPredicate\": [\n                                    {\n                                        \"name\": \"envoy.retry_host_predicates.previous_hosts\"\n                                    }\n                                ],\n                                \"hostSelectionRetryMaxAttempts\": \"5\",\n                                \"retriableStatusCodes\": [\n                                    503\n                                ]\n                            },\n                            \"maxGrpcTimeout\": \"0s\"\n                        },\n                        ]\n.....\n</code></pre> <p>\u8def\u753180\u914d\u7f6e\u4e3a\u6bcf\u4e2a\u670d\u52a1\u90fd\u6709\u4e00\u4e2a\u865a\u62df\u4e3b\u673a\u3002</p> <p>\u7136\u800c\uff0c\u7531\u4e8e\u6211\u4eec\u7684\u8bf7\u6c42\u88ab\u53d1\u9001\u5230<code>customers.default.svc.cluster.local</code>, Envoy\u4f1a\u9009\u62e9\u4e0e\u5176\u4e2d\u4e00\u4e2a\u57df\u5339\u914d\u7684\u865a\u62df\u4e3b\u673a (<code>customers.default.svc.cluster.local:80</code>\uff09\u3002</p> <p>\u4e00\u65e6\u57df\u88ab\u5339\u914d\uff0c\u7279\u6b8a\u7684\u8def\u7531\u89c4\u5219<code>Envoy</code>\u5c31\u4f1a\u67e5\u770b\u8def\u7531\uff0c\u5e76\u9009\u62e9\u7b2c\u4e00\u4e2a\u5339\u914d\u8bf7\u6c42\u7684\u8def\u7531\u3002\u7531\u4e8e\u6211\u4eec\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u5b83\u5339\u914d\u7b2c\u4e00\u4e2a\uff08\u4e5f\u662f\u552f\u4e00\u7684\uff09\u5b9a\u4e49\u7684\u8def\u7531\uff0c\u5e76\u6307\u793aEnvoy\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u540d\u4e3a\u7684\u96c6\u7fa4\u3002<code>outbound|80|v1|customers.default.svc.cluster.local</code>\u7684\u96c6\u7fa4</p> <p>\u6ce8\u610f\u96c6\u7fa4\u540d\u79f0\u4e2d\u7684v1\u662f\u56e0\u4e3a\u6211\u4eec\u90e8\u7f72\u4e86\u4e00\u4e2a<code>DestinationRule</code>\u6765\u521b\u5efa<code>v1</code>\u5b50\u96c6\u3002\u5982\u679c\u4e00\u4e2a\u670d\u52a1\u6ca1\u6709\u5b50\u96c6\uff0c\u8fd9\u90e8\u5206\u5c31\u7559\u7a7a\uff1a </p> <p>outbound|80||customers.default.svc.cluster.local</p> <p>\u73b0\u5728\u6211\u4eec\u6709\u4e86\u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u66f4\u591a\u7684\u7ec6\u8282\u3002 \u4e3a\u4e86\u5f97\u5230\u4e00\u4e2a\u6e05\u695a\u663e\u793aFQDN\u3001\u7aef\u53e3\u3001\u5b50\u96c6\u548c\u5176\u4ed6\u4fe1\u606f\u7684\u8f93\u51fa\uff0c\u4f60\u53ef\u4ee5\u7701\u7565<code>-o json</code>\u6807\u5fd7\u3002 </p> <pre><code>$ istioctl proxy-config cluster web-frontend-74dd5cbcdc-8mfpb --fqdn customers.default.svc.cluster.loc\nal\nSERVICE FQDN                            PORT     SUBSET     DIRECTION     TYPE     DESTINATION RULE\ncustomers.default.svc.cluster.local     80       -          outbound      EDS\n</code></pre> <p>\u6700\u540e\uff0c\u4f7f\u7528\u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u8bf7\u6c42\u6700\u7ec8\u5c06\u5230\u8fbe\u7684\u5b9e\u9645\u7aef\u70b9\uff1a </p> <pre><code>$ istioctl proxy-config endpoints web-frontend-74dd5cbcdc-8mfpb --cluster \"outbound|80|v1|customers.default.svc.cluster.local\"\nENDPOINT            STATUS      OUTLIER CHECK     CLUSTER\n10.1.1.152:3000     HEALTHY     OK                outbound|80||customers.default.svc.cluster.local\n</code></pre> <p>\u7aef\u70b9\u5730\u5740\u7b49\u4e8ecustomers\u5e94\u7528\u7a0b\u5e8f\u6b63\u5728\u8fd0\u884c\u7684pod IP\u3002\u5982\u679c\u6211\u4eec\u6269\u5c55customers\u7684\u90e8\u7f72\u989d\u5916\u7684\u7aef\u70b9\u4f1a\u51fa\u73b0\u5728\u8f93\u51fa\u4e2d\uff0c\u50cf\u8fd9\u6837\uff1a </p> <pre><code>$ kubectl get pod\nNAME                            READY   STATUS    RESTARTS   AGE\ncurl-6cd5b579fb-2xcx9           2/2     Running   3          9d\ncustomers-v1-7b5b4b76fc-dslg9   2/2     Running   0          24m\ncustomers-v1-7b5b4b76fc-rh8zb   2/2     Running   0          18s\ncustomers-v1-7b5b4b76fc-x7jb8   2/2     Running   0          18s\nweb-frontend-74dd5cbcdc-8mfpb   2/2     Running   0          24m\n</code></pre> <pre><code>$ istioctl proxy-config endpoints web-frontend-74dd5cbcdc-8mfpb --cluster \"outbound|80||customers.defa\nult.svc.cluster.local\"\nENDPOINT            STATUS      OUTLIER CHECK     CLUSTER\n10.1.1.152:3000     HEALTHY     OK                outbound|80||customers.default.svc.cluster.local\n10.1.1.153:3000     HEALTHY     OK                outbound|80||customers.default.svc.cluster.local\n10.1.1.154:3000     HEALTHY     OK                outbound|80||customers.default.svc.cluster.local\n</code></pre>"},{"location":"chap8/8Istio_trouble_shoot/#3","title":"3\u3001\u8c03\u8bd5\u5907\u5fd8\u5f55","text":"<p>\u6bcf\u5f53\u4f60\u9047\u5230\u914d\u7f6e\u95ee\u9898\u65f6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u8fd9\u7ec4\u6b65\u9aa4\u6765\u6d4f\u89c8\u548c\u89e3\u51b3\u95ee\u9898\u3002\u5728\u7b2c\u4e00\u90e8\u5206\uff0c\u6211\u4eec\u8981\u68c0\u67e5\u914d \u7f6e\u662f\u5426\u6709\u6548\u3002\u5982\u679c\u914d\u7f6e\u662f\u6709\u6548\u7684\uff0c\u4e0b\u4e00\u6b65\u5c31\u662f\u770b\u770b\u8fd0\u884c\u65f6\u662f\u5982\u4f55\u5904\u7406\u914d\u7f6e\u7684\uff0c\u4e3a\u6b64\uff0c\u4f60\u9700\u8981\u5bf9 Envoy\u914d\u7f6e\u6709\u57fa\u672c\u7684\u4e86\u89e3\u3002 </p> <p>Checklist for debugging</p> <ul> <li>Configuration validation </li> <li>Runtime validation </li> </ul>"},{"location":"chap8/8Istio_trouble_shoot/#3-1","title":"3-1 \u914d\u7f6e","text":"<p>1\uff0e\u914d\u7f6e\u662f\u5426\u6709\u6548\uff1f </p> <p>Istio CLI\u6709\u4e00\u4e2a\u53ebvalidate\u7684\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u9a8c\u8bc1.YAML\u914d\u7f6e\u3002YAML\u6700\u5e38\u89c1\u7684\u95ee\u9898\u662f\u7f29\u8fdb\u548c\u6570\u7ec4\u7b26\u53f7\u76f8\u5173\u7684\u95ee\u9898\u3002\u8981\u9a8c\u8bc1\u4e00\u4e2a\u914d\u7f6e\uff0c\u8bf7\u5c06YAML\u6587\u4ef6\u4f20\u9012\u7ed9validate\u547d\u4ee4\uff0c\u50cf\u8fd9\u6837\uff1a </p> <pre><code>$ istioctl validate -f myresource.yaml\nvalidation succeed\n</code></pre> <p>\u5982\u679c\u8d44\u6e90\u662f\u65e0\u6548\u7684\uff0cCLI\u4f1a\u7ed9\u6211\u4eec\u4e00\u4e2a\u8be6\u7ec6\u7684\u9519\u8bef\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u62fc\u9519\u4e86\u4e00\u4e2a\u5b57\u6bb5\u540d\uff1a </p> <pre><code>unknown field \"worloadSelector\" in v1alpha3.ServiceEntry\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u53e6\u4e00\u4e2a\u547d\u4ee4<code>istioctl analyze</code>\u3002</p> <p>\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u6d4bIstio\u914d\u7f6e\u7684\u6f5c \u5728\u95ee\u9898\u3002\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u672c\u5730\u7684\u4e00\u7ec4\u914d\u7f6e\u6587\u4ef6\u6216\u5b9e\u65f6\u96c6\u7fa4\u8fd0\u884c\u5b83\u3002\u540c\u65f6\uff0c\u5bfb\u627e\u6765\u81eaistiod\u7684\u4efb\u4f55\u8b66\u544a\u6216\u9519\u8bef\u3002 </p> <p>\u4e0b\u9762\u662f\u8be5\u547d\u4ee4\u7684\u4e00\u4e2a\u8f93\u51fa\u6837\u672c\uff0c\u5b83\u6355\u6349\u5230\u4e86\u76ee\u7684\u5730\u4e3b\u673a\u540d\u79f0\u4e2d\u7684\u4e00\u4e2a\u9519\u5b57\uff1a </p> <pre><code>$ istioctl analyze\nError [IST0101] (VirtualService customers.default) Referenced host not found: \"cusomers.default.svc.cluster.local\"\nError [IST0101] (VirtualService customers.default) Referenced host+subset in destinationrule not found: \"cusomers.default.svc.cluster.local+v1\"\nError: Analyzers found issues when analyzing namespace: default.\nSee https://istio.io/docs/reference/config/analysis for more information about causes and resolutions.\n</code></pre> <p>2\uff0e\u547d\u540d\u662f\u5426\u6b63\u786e\uff1f\u8d44\u6e90\u662f\u5426\u5728\u6b63\u786e\u7684\u547d\u540d\u7a7a\u95f4\uff1f </p> <ul> <li>Nearly all Istio resources are namespace scoped </li> <li>Selectors are also namespaced </li> <li>Common misconfiguration: <ul> <li>Publishing VirtualService in default, binding to a gateway in istio-system</li> <li>Deploying Sidecar in istio-system, referencing VirtualService from application namespace </li> </ul> </li> </ul> <p>\u51e0\u4e4e\u6240\u6709\u7684Istio\u8d44\u6e90\u90fd\u662f\u547d\u540d\u7a7a\u95f4\u8303\u56f4\u7684\u3002\u786e\u4fdd\u5b83\u4eec\u4e0e\u4f60\u6b63\u5728\u5904\u7406\u7684\u670d\u52a1\u5904\u4e8e\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u3002\u5c06Istio\u8d44\u6e90\u653e\u5728\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u5c24\u5176\u91cd\u8981\uff0c\u56e0\u4e3a\u9009\u62e9\u5668\u4e5f\u662f\u6709\u547d\u540d\u7a7a\u95f4\u7684\u3002 </p> <p>\u4e00\u4e2a\u5e38\u89c1\u7684\u9519\u8bef\u914d\u7f6e\u662f\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u53d1\u5e03VirtualService\uff08\u4f8b\u5982default)\uff0c\u7136\u540e\u4f7f\u7528<code>istio: ingressgateway</code>\u9009\u62e9\u5668\u6765\u7ed1\u5b9a\u5230<code>istio-system</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u7684ingress\u7f51\u5173\u90e8\u7f72\u3002\u8fd9\u53ea\u6709\u5728\u4f60\u7684<code>VirtualService</code>\u4e5f\u5728<code>istio-system</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u65f6\u624d\u6709\u6548\u3002 </p> <p>\u540c\u6837\u5730\uff0c\u4e0d\u8981\u5728<code>istio-system</code>\u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u5f15\u7528\u7528\u5e94\u7528\u7a0b\u5e8f\u547d\u540d\u7a7a\u95f4\u4e2d\u7684<code>VirtualService</code>\u7684Sidecar\u8d44\u6e90\u3002\u76f8\u53cd\uff0c\u4e3a\u6bcf\u4e2a\u9700\u8981\u5165\u53e3\u7684\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u4e00\u7ec4Envoy\u7f51\u5173\u3002 </p> <p>3\uff0e\u8d44\u6e90\u9009\u62e9\u5668\u662f\u5426\u6b63\u786e\uff1f </p> <p>\u9a8c\u8bc1\u90e8\u7f72\u4e2d\u7684pod\u662f\u5426\u6709\u6b63\u786e\u7684\u6807\u7b7e\u8bbe\u7f6e\u3002\u6b63\u5982\u4e0a\u4e00\u6b65\u63d0\u5230\u7684\uff0c\u8d44\u6e90\u9009\u62e9\u5668\u4e0e\u8d44\u6e90\u53d1\u5e03\u7684\u547d\u540d \u7a7a\u95f4\u7ed1\u5b9a\u3002 </p> <p>\u5728\u8fd9\u4e00\u70b9\u4e0a\uff0c\u6211\u4eec\u5e94\u8be5\u6709\u7406\u7531\u76f8\u4fe1\uff0c\u914d\u7f6e\u662f\u6b63\u786e\u7684\u3002\u63a5\u4e0b\u6765\u7684\u6b65\u9aa4\u662f\u8fdb\u4e00\u6b65\u7814\u7a76\u8fd0\u884c\u65f6\u7cfb\u7edf\u662f \u5982\u4f55\u5904\u7406\u914d\u7f6e\u7684\u3002 </p>"},{"location":"chap8/8Istio_trouble_shoot/#3-2","title":"3-2 \u8fd0\u884c\u65f6","text":"<p>Istio CLI \u7684\u4e00\u4e2a\u5b9e\u9a8c\u6027\u529f\u80fd\u53ef\u4ee5\u63d0\u4f9b\u4fe1\u606f\uff0c\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u5f71\u54cdPod\u6216\u670d\u52a1\u7684\u914d\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u9488\u5bf9Pod\u8fd0\u884cdescribe\u547d\u4ee4\u7684\u4f8b\u5b50\uff0c\u8fd9\u4e2aPod\u7684\u4e3b\u673a\u540d\u79f0\u4e2d\u6709\u4e00\u4e2a\u9519\u5b57\uff1a </p> <pre><code>$ istioctl x describe pod customers-v1-64455cd4c6-xvjzm.default\nPod: customers-v1-64455cd4c6-xvjzm\n  Pod Ports: 3000 (svc), 15090 (istio-proxy)\n--------------------\nService: customers\n  Port: http 80/HTTP targets pod port 3000\nDestinationRule: customers for \"customers.default.svc.cluster.local\"\n  Matching subsets: v1\n  No Traffic Policy\nVirtualService: customers\n  WARNING: No destinations match pod subsets (checked 1 HTTP routes)\n    Route to cusomers.default.svc.cluster.local\n\u00b7\u00b7\u00b7\n</code></pre> <pre><code>$ istioctl x describe pod customers-v1-7b5b4b76fc-dslg9\nPod: customers-v1-7b5b4b76fc-dslg9\n   Pod Ports: 3000 (svc), 15090 (istio-proxy)\n--------------------\nService: customers\n   Port: http 80/HTTP targets pod port 3000\nVirtualService: customers\n   1 HTTP route(s)\n</code></pre> <p>1. Envoy\u662f\u5426\u63a5\u53d7\uff08ACK\uff09\u8be5\u914d\u7f6e\uff1f </p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528<code>istioctl proxy-status</code>\u547d\u4ee4\u6765\u68c0\u67e5\u72b6\u6001\uff0c\u770b\u770bEnvoy\u662f\u5426\u63a5\u53d7\u914d\u7f6e\u3002\u6211\u4eec\u5e0c\u671b\u6240\u6709\u4e1c\u897f\u7684\u72b6\u6001\u90fd\u8bbe\u7f6e\u4e3aSYNCHED\u3002\u4efb\u4f55\u5176\u4ed6\u503c\u90fd\u53ef\u80fd\u8868\u660e\u6709\u9519\u8bef\uff0c\u4f60\u5e94\u8be5\u68c0\u67e5Pilot\u7684\u65e5\u65e5\u5fd7\u3002 </p> <pre><code>$ istioctl proxy-status\nNAME                                                  CDS        LDS        EDS        RDS          ISTIOD                      VERSION\ncurl-6cd5b579fb-2xcx9.default                         SYNCED     SYNCED     SYNCED     SYNCED       istiod-6659979bdf-l7kgk     1.10.3\ncustomers-v1-7b5b4b76fc-dslg9.default                 SYNCED     SYNCED     SYNCED     SYNCED       istiod-6659979bdf-l7kgk     1.10.3\ncustomers-v1-7b5b4b76fc-rh8zb.default                 SYNCED     SYNCED     SYNCED     SYNCED       istiod-6659979bdf-l7kgk     1.10.3\ncustomers-v1-7b5b4b76fc-x7jb8.default                 SYNCED     SYNCED     SYNCED     SYNCED       istiod-6659979bdf-l7kgk     1.10.3\nistio-egressgateway-5547fcc8fc-7kj9c.istio-system     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-6659979bdf-l7kgk     1.10.3\nistio-ingressgateway-8f568d595-b2d6q.istio-system     SYNCED     SYNCED     SYNCED     SYNCED       istiod-6659979bdf-l7kgk     1.10.3\nweb-frontend-74dd5cbcdc-8mfpb.default                 SYNCED     SYNCED     SYNCED     SYNCED       istiod-6659979bdf-l7kgk     1.10.3\n</code></pre> <p>\u5217\u8868\u663e\u793a\u6240\u6709\u8fde\u63a5\u5230<code>Pilot</code>\u5b9e\u4f8b\u7684\u4ee3\u7406\u3002\u5982\u679c\u5217\u8868\u4e2d\u7f3a\u5c11\u4e00\u4e2a\u4ee3\u7406\uff0c\u8fd9\u610f\u6627\u7740\u5b83\u6ca1\u6709\u8fde\u63a5\u5230Pilot\uff0c\u4e5f\u6ca1\u6709\u6536\u5230\u4efb\u4f55\u914d\u7f6e\u3002\u5982\u679c\u4efb\u4f55\u4e00\u4e2a\u4ee3\u7406\u88ab\u6807\u8bb0\u4e3aSTALE\uff0c\u53ef\u80fd\u6709\u7f51\u7edc\u95ee\u9898\uff0c\u6216\u8005\u6211\u4eec \u9700\u8981\u6269\u5c55Pilot</p> <p>\u5982\u679cEnvoy\u63a5\u53d7\u4e86\u914d\u7f6e\uff0c\u4f46\u6211\u4eec\u4ecd\u7136\u770b\u5230\u95ee\u9898\uff0c\u6211\u4eec\u9700\u8981\u786e\u4fdd\u914d\u7f6e\u5728Envoy\u4e2d\u7684\u8868\u73b0\u7b26\u5408\u9884\u671f\u3002</p> <p>2\uff0e\u914d\u7f6e\u5728Envoy\u4e2d\u7684\u8868\u73b0\u548c\u9884\u671f\u7684\u4e00\u6837\u5417\uff1f </p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>proxy-config</code>\u547d\u4ee4\u6765\u68c0\u7d22\u7279\u5b9a<code>Envoy</code>\u5b9e\u4f8b\u7684\u4fe1\u606f\u3002\u8bf7\u53c2\u8003\u4e0b\u9762\u7684\u8868\u683c\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u7d22\u4e0d\u540c\u7684\u4ee3\u7406\u914d\u7f6e\u3002 </p> <p> </p> <p>\u8be5\u547d\u4ee4\u4ece<code>Envoy</code>\u7684\u7ba1\u7406\u7aef\u70b9\uff08\u4e3b\u8981\u662f<code>/config_dump</code>\uff09\u6536\u96c6\u6570\u636e\uff0c\u5b83\u5305\u542b\u4e86\u5f88\u591a\u6709\u7528\u7684\u4fe1\u606f\u3002 </p> <p>\u53e6\u5916\uff0c\u8bf7\u53c2\u8003\u663e\u793aEnvoy\u548cIstio\u8d44\u6e90\u4e4b\u95f4\u6620\u5c04\u7684\u56fe\u3002\u4f8b\u5982\uff0c\u8bb8\u591a<code>VirtualService</code>\u89c4\u5219\u5c06\u8868\u73b0\u4e3a<code>Envoy</code>\u8def\u7531\uff0c\u800c<code>DestinationRules</code>\u548c<code>ServiceEntries</code>\u5219\u8868\u73b0\u4e3aCluster</p> <p><code>DestinationRules</code>\u4e0d\u4f1a\u51fa\u73b0\u5728\u914d\u7f6e\u4e2d\uff0c\u9664\u975e\u5176\u4e3b\u673a\u7684<code>ServiceEntry</code>\u9996\u5148\u5b58\u5728\u3002 </p> <p>\u8ba9\u6211\u4eec\u4ee5\u5ba2\u6237\u7684<code>VirtualService</code>\u4e3a\u4f8b\u3002 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: customers\nspec:\n  hosts:\n   - 'customers.default.svc.cluster.local'\n  http:\n   - route:\n    - destination:\n      host: customers.default.svc.cluster.local\n      port:\n       number: 80\n      subset: v1\n     weight: 80\n    - destination:\n      host: customers.default.svc.cluster.local\n      port:\n       number: 80\n      subset: v2\n     weight: 20\n    timeout: 5s\n</code></pre> <p>\u5982\u679c\u4f60\u8fd0\u884c<code>istioctl proxy-config routes[POD\uff3d-o json</code>\u547d\u4ee4\uff0c\u4f60\u4f1a\u770b\u5230\u52a0\u6743\u76ee\u7684\u5730\u548c\u8d85\u65f6\u662f\u5982\u4f55\u5728\u914d\u7f6e\u4e2d\u4f53\u73b0\u7684\uff1a</p> <pre><code>..\n{\n  \"name\": \"80\",\n  \"virtualHosts\": [\n    {\n   \"name\": \"customers.default.svc.cluster.local:80\",\n   \"domains\": [\n     \"customers.default.svc.cluster.local\",\n     ...\n    ],\n   \"routes\": [\n     {\n      \"match\": {\"prefix\": \"/\"},\n      \"route\": {\n         \"weightedClusters\": {\n           \"clusters\": [\n             {\n               \"name\": \"outbound|80|v1|customers.default.svc.cluster.local\",\n               \"weight\": 80\n             },\n             {\n               \"name\": \"outbound|80|v2|customers.default.svc.cluster.local\",\n               \"weight\": 20\n             }\n           ]\n          },\n         \"timeout\": \"5s\",\n...\n</code></pre> <p>\u5f53\u4f60\u8bc4\u4f30VirtualService\u65f6\uff0c\u4f60\u8981\u5bfb\u627e\u4e3b\u673a\u540d\u662f\u5426\u50cf\u4f60\u5199\u7684\u90a3\u6837\u51fa\u73b0\u5728Envoy\u914d\u7f6e\u4e2d\uff08\u4f8b\u5982  <code>customers.default.svc.cluster.local</code>)\uff0c\u4ee5\u53ca\u8def\u7531\u662f\u5426\u5b58\u5728(\u89c1\u8f93\u51fa\u4e2d\u768480-20\u6d41\u91cf\u5206\u5272\uff09\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e4b\u524d\u7684\u4f8b\u5b50\uff0c\u901a\u8fc7\u76d1\u542c\u5668\u3001\u8def\u7531\u548c\u96c6\u7fa4(\u548c\u7aef\u70b9\uff09\u6765\u8ffd\u8e2a\u8c03\u7528\u3002 </p> <p>Envoy\u8fc7\u6ee4\u5668\u4f1a\u8868\u73b0\u5728\u4f60\u544a\u8bc9Istio\u628a\u5b83\u4eec\u653e\u5728\u54ea\u91cc\uff08EnvoyFilter\u8d44\u6e90\u4e2d\u7684applyTo\u5b57\u6bb5\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u574f\u7684\u8fc7\u6ee4\u5668\u4f1a\u8868\u73b0\u4e3aEnvoy\u62d2\u7edd\u914d\u7f6e\uff08\u5373\u4e0d\u663e\u793aSYNCED\u72b6\u6001\uff09\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u9700\u8981\u68c0\u67e5Istiod\u65e5\u5fd7\u4e2d\u7684\u9519\u8bef</p> <p>3. Istiod (Pilot\uff09\u4e2d\u662f\u5426\u6709\u9519\u8bef\uff1f </p> <p>\u4ecePilot\u67e5\u770b\u9519\u8bef\u7684\u6700\u5feb\u65b9\u6cd5\u662f\u8ddf\u8e2a\u65e5\u5fd7\uff08\u4f7f\u7528<code>--follow</code>\u6807\u5fd7\uff09\uff0c\u7136\u540e\u5e94\u7528\u914d\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u6765\u81eaPilot\u7684\u9519\u8bef\u7684\u4f8b\u5b50\uff0c\u8fd9\u662f\u7531\u4e8e\u8fc7\u6ee4\u5668\u7684\u5185\u8054\u4ee3\u7801\u4e2d\u7684\u4e00\u4e2a\u9519\u5b57\u800c\u5bfc\u81f4\u7684\u3002 </p> <pre><code>2020-11-20T21:49:16.017487Z   warn   ads   ADS:LDS: ACK ERROR sidecar~10.120.1.8~web-frontend-58d497b6f8-lwqkg.default~default.svc.cluster.local-4 Internal:Error adding/updating listener (s) virtualInbound: script load error: [string\"fction envoy_on_response (response_handle)...\"]:1: '=' expected near 'envoy_on_response'\n</code></pre> <p>\u5982\u679c\u914d\u7f6e\u6839\u672c\u6ca1\u6709\u51fa\u73b0\u5728Envoy\u4e2d\uff08Envoy\u6ca1\u6709ACK\u5b83\uff09\uff0c\u6216\u8005\u5b83\u662f\u4e00\u4e2aEnvoyFilter\u914d\u7f6e\uff0c\u90a3\u4e48\u8fd9\u4e2a\u914d\u7f6e\u5f88\u53ef\u80fd\u662f\u65e0\u6548\u7684\u3002Istio\u65e0\u6cd5\u4ece\u8bed\u6cd5\u4e0a\u9a8c\u8bc1EnvoyFilter\u5185\u90e8\u7684\u914d\u7f6e\u3002\u53e6\u4e00\u4e2a\u95ee\u9898\u53ef\u80fd\u662f\uff0c\u8fc7\u6ee4\u5668\u5728Envoy\u7684\u914d\u7f6e\u4e2d\u4f4d\u4e8e\u9519\u8bef\u7684\u4f4d\u7f6e\u3002 </p> <p>\u65e0\u8bba\u54ea\u79cd\u60c5\u51b5\uff0cEnvoy\u90fd\u4f1a\u62d2\u7edd\u8be5\u914d\u7f6e\uff0c\u56e0\u4e3a\u5b83\u662f\u65e0\u6548\u7684\uff0cPilot\u4f1a\u8bb0\u5f55\u8fd9\u4e2a\u9519\u8bef\u3002\u4e00\u822c\u6765 \u8bf4\uff0c\u4f60\u53ef\u4ee5\u641c\u7d22\u4f60\u7684\u8d44\u6e90\u7684\u540d\u79f0\u6765\u627e\u5230\u9519\u8bef\u3002</p> <p>\u5728\u8fd9\u91cc\uff0c\u4f60\u5fc5\u987b\u4f7f\u7528\u5224\u65ad\u529b\u6765\u786e\u5b9a\u5b83\u662f\u4f60\u5199\u7684\u914d\u7f6e\u4e2d\u7684\u9519\u8bef\uff0c\u8fd8\u662fPilot\u7684\u9519\u8bef\u5bfc\u81f4\u5b83\u4ea7\u751f\u4e86 \u4e00\u4e2a\u65e0\u6548\u7684\u914d\u7f6e\u3002 </p>"},{"location":"chap8/8Istio_trouble_shoot/#3-3-envoy","title":"3-3 \u68c0\u67e5Envoy\u65e5\u5fd7","text":"<p>\u8981\u68c0\u67e5Envoy\u4ee3\u7406\u7684\u65e5\u5fd7\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>kubectl logs</code>\u547d\u4ee4\uff1a </p> <pre><code>kubect1 logs PODNAME -c istio-proxy \u4e00n NAMESPACE \n\n</code></pre> <p>\u8981\u4e86\u89e3\u8bbf\u95ee\u65e5\u5fd7\u7684\u683c\u5f0f\u548c\u54cd\u5e94\u6807\u5fd7\uff0c\u6211\u4eec\u53ef\u4ee5\u53c2\u8003Envoy\u8bbf\u95ee\u65e5\u5fd7\u7684\u5185\u5bb9 </p> <p>\u6700\u5e38\u89c1\u7684\u54cd\u5e94\u6807\u5fd7\u3002 </p> <ul> <li>NP\uff1a\u6ca1\u6709\u914d\u7f6e\u8def\u7531\uff0c\u68c0\u67e5DestinationRule\u6216VirtualService </li> <li>UO\uff1a\u4e0a\u6e38\u6ea2\u51fa\u5e76\u65ad\u8def\u3002\u68c0\u67e5DestinationRule\u4e2d\u7684\u65ad\u8def\u5668\u914d\u7f6e\u3002 </li> <li>UF:\u4e0a\u6e38\u8fde\u63a5\u5931\u8d25\uff0c\u5982\u679c\u4f7f\u7528Istio\u8ba4\u8bc1\uff0c\u68c0\u67e5mTLS\u914d\u7f6e\u3002</li> <li>UH\uff1a\u6ca1\u6709\u5065\u5eb7\u7684\u4e0a\u6e38\u4e3b\u673a\u3002 </li> </ul>"},{"location":"chap8/8Istio_trouble_shoot/#3-4-istiod","title":"3-4 \u914d\u7f6e istiod \u65e5\u5fd7","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528ControlZ\u4eea\u8868\u677f\uff0c\u901a\u8fc7Logging Scopes\u83dc\u5355\u914d\u7f6e\u5806\u6808\u8ddf\u8e2a\u7ea7\u522b\u548c\u65e5\u5fd7\u7ea7\u522b\u3002 </p> <p>\u8981\u6253\u5f00\u4eea\u8868\u677f\uff0c\u8bf7\u8fd0\u884c\uff1a </p> <pre><code>istioctl dashboard controlz $(kubectl -n istio-system get pods -l app=istiod -o jsonpath='{.items [0].metadata.name}').istio-system\n</code></pre> <p>\u4eea\u8868\u677f\u6253\u5f00\u540e\uff0c\u70b9\u51fbLogging Scopes\u9009\u9879\uff0c\u8c03\u6574\u65e5\u5fd7\u7ea7\u522b\u548c\u5806\u6808\u8ddf\u8e2a\u7ea7\u522b\u3002 </p> <p> </p>"},{"location":"chap8/8Istio_trouble_shoot/#4","title":"4\u3001\u95ee\u9898\u68c0\u6d4b\u68c0\u6d4b","text":"<p>1\u3001\u5982\u679c\u865a\u62df\u76d1\u542c\u5668\u627e\u4e0d\u5230\u8bf7\u6c42\u7684\u76ee\u7684\u5730\u4f1a\u600e\u6837\uff1f </p> <ul> <li>A \u629b\u5f03\u8be5\u8bf7\u6c42 </li> <li>B \u8df3\u8f6c\u5230\u7b2c\u4e8c\u63a5\u8fd1\u7684\u8bf7\u6c42 </li> <li>C \u6839\u636eOutboundTrafficPolicy\u53d1\u9001\u6d41\u91cf</li> <li>D \u6839\u636e\u865a\u62df\u670d\u52a1\u7684\u8981\u6c42\u53d1\u9001\u6d41\u91cf </li> </ul> <p>\u5f53\u4e00\u4e2a\u8bf7\u6c42\u88ab\u91cd\u5b9a\u5411\uff08\u4f7f\u7528IP Tables\u914d\u7f6e\uff09\u523015001\u7aef\u53e3\u65f6\uff0c\u76d1\u542c\u5668\u4f1a\u628a\u5b83\u4ea4\u7ed9\u4e0e\u8bf7\u6c42\u7684\u539f\u59cb\u76ee\u7684\u5730\u6700\u5339\u914d\u7684\u865a\u62df\u76d1\u542c\u5668\u3002**\u5982\u679c\u5b83\u627e\u4e0d\u5230\u76ee\u7684\u5730\uff0c\u5b83\u5c31\u6839\u636e\u914d\u7f6e\u7684 <code>OutboundTrafficPolicy</code>\u6765\u53d1\u9001\u6d41\u91cf\u3002 <p>2\u3001\u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e2aIstio CLI\u547d\u4ee4\u6765\u5217\u51fa\u6240\u6709\u76d1\u542c\u5668\uff1f</p> <ul> <li>A istiocti get listeners </li> <li>B istiocti proxy-config listeners </li> <li>C istiocti describe listeners </li> <li>D istioctl config listeners</li> </ul> <p><code>istioctl proxy-config</code>\u5217\u51fa\u76d1\u542c\u5668</p> <p>3\u3001\u76d1\u542c\u5668\u4f7f\u7528\u54ea\u4e2a\u670d\u52a1\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e\uff1f </p> <ul> <li>A SDS</li> <li>B RDS(route discovery service) </li> <li>C Listener service </li> <li>D Envoy service </li> </ul> <p>Listener\u4f7f\u7528RDS\uff08\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff09\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f80)</p> <p>4\u3001Envoy\u7684\u57fa\u672c\u6982\u5ff5\u662f\u4ec0\u4e48\uff1f</p> <ul> <li>A listener\u3001route\u3001cluster\u548cendpoint </li> <li>B request\u3001response\u548cendpoint </li> <li>C request\u3001header\u548ccookies </li> <li>D header\u3001cluster\u548croute </li> </ul> <p>5\u3001Envoy\u4e3a\u6bcf\u4e2asidecar\u751f\u6210\u4e00\u4e2a\u76d1\u542c\u5668\u3002\uff08\u5bf9/\u9519\uff09</p> <ul> <li>A True </li> <li>B False </li> </ul> <p>\u6bcf\u4e2asidecar\u90fd\u6709\u591a\u4e2a\u76d1\u542c\u5668\u751f\u6210\u3002\u6bcf\u4e2asidecar\u90fd\u6709\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u5b83\u88ab\u7ed1\u5b9a\u5230 <code>0.0.0.0:15006</code>\u3002</p> <p>6\u3001Where are the circuit breakers defined?</p> <ul> <li>A In virtual listeners </li> <li>B In endpoint configuration </li> <li>C In clusters configuration </li> <li>D In routes configuration</li> </ul> <p>7\u3001\u4ec0\u4e48\u7c7b\u578b\u7684\u6d41\u91cf\u4f1a\u88ab\u8def\u7531\u523015006\u7aef\u53e3\uff1f</p> <ul> <li>A \u5165\u7ad9Pod\u6d41\u91cf</li> <li>B \u51fa\u7ad9Pod \u6d41\u91cf</li> <li>C \u6240\u6709\u6d41\u91cf </li> <li>D \u6ca1\u6709\u6d41\u91cf </li> </ul>"},{"location":"chap8/9Istio_real_instance/","title":"\u7b2c\u4e5d\u8282 \u5b9e\u9645\u6848\u4f8b","text":"<p>\u5728\u672c\u6a21\u5757\u4e2d\uff0c\u6211\u4eec\u5c06\u90e8\u7f72\u540d\u4e3a<code>Online Boutique</code>\u7684\u5fae\u670d\u52a1\u6f14\u793a\u5e94\u7528\u7a0b\u5e8f\uff0c\u8bd5\u7528Istio\u7684\u4e0d\u540c\u529f\u80fd </p> <p><code>Online Boutique</code>\u662f\u4e00\u4e2a\u4e91\u539f\u751f\u5fae\u670d\u52a1\u6f14\u793a\u5e94\u7528\u7a0b\u5e8f\u3002<code>Online Boutique</code>\u662f\u4e00\u4e2a\u753110\u4e2a\u5fae\u670d \u52a1\u7ec4\u6210\u7684\u5e94\u7528\u3002\u8be5\u5e94\u7528\u662f\u4e00\u4e2a\u57fa\u4e8eWeb\u7684\u7535\u5b50\u5546\u52a1\u5e94\u7528\uff0c\u7528\u6237\u53ef\u4ee5\u6d4f\u89c8\u5546\u54c1\uff0c\u5c06\u5176\u6dfb\u52a0\u5230\u8d2d\u7269\u8f66\uff0c\u5e76\u8d2d\u4e70\u5546\u54c1\u3002 </p> <ul> <li>Deploy microservices demo application(Online Boutique) </li> <li>Demonstrate how to use lstio features; <ul> <li>Traffic routing </li> <li>Fault injection </li> <li>Resiliency </li> </ul> </li> </ul>"},{"location":"chap8/9Istio_real_instance/#1","title":"1\u3001\u521b\u5efa\u96c6\u7fa4","text":"<p>\u6211\u4eec\u5c06\u4f7f\u7528\u8c37\u6b4c\u4e91\u5e73\u53f0\u6765\u6258\u7ba1Kubernetes\u96c6\u7fa4\u3002\u6253\u5f00\u5e76\u767b\u5f55\u5230\u4f60\u7684GCP\u63a7\u5236\u53f0\u8d26\u6237\uff0c\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u521b\u5efa\u4e00\u4e2aKubernetes\u96c6\u7fa4\u3002 </p> <ul> <li>1\uff0e\u4ece\u5bfc\u822a\u4e2d\uff0c\u9009\u62e9Kubernetes Engine</li> <li>2\uff0e\u70b9\u51fb\u521b\u5efa\u96c6\u7fa4\u3002 </li> <li>3\uff0e\u5c06\u96c6\u7fa4\u547d\u540d\u4e3a<code>Boutique-demo</code> </li> <li>4\uff0e\u9009\u62e9\u533a\u57df\u9009\u9879\uff0c\u9009\u62e9\u6700\u63a5\u8fd1\u4f60\u7684\u4f4d\u7f6e\u7684\u533a\u57df\u3002 </li> <li>5\uff0e\u70b9\u51fb<code>default-pool</code>\uff0c\u5728\u8282\u70b9\u6570\u4e2d\u8f93\u51655 </li> <li>6\uff0e\u70b9\u51fbNodes\uff08\u8282\u70b9\uff09\u3002 </li> <li>7\uff0e\u70b9\u51fb\u673a\u5668\u914d\u7f6e\u673a\u5668\u7c7b\u578b\u4e0b\u62c9\uff0c\u9009\u62e9<code>e2-medium</code> (2 vCPU, 4 GB memory)\u3002 </li> <li>8\uff0e\u70b9\u51fb\u201dCreate\u201d\u6765\u521b\u5efa\u96c6\u7fa4\u3002 </li> </ul> <p>\u96c6\u7fa4\u7684\u521b\u5efa\u5c06\u9700\u8981\u51e0\u5206\u949f\u7684\u65f6\u95f4\u3002\u4e00\u65e6\u5b89\u88c5\u5b8c\u6210\uff0c\u96c6\u7fa4\u5c06\u663e\u793a\u5728\u5217\u8868\u4e2d\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 </p> <p> </p> <p>\u4f60\u4e5f\u53ef\u4ee5\u5c06Online Boutique\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u6258\u7ba1\u5728\u5176\u4ed6\u4e91\u5e73\u53f0\u4e0a\u7684Ku bernetes\u96c6 \u7fa4\uff0c\u5982Azure\u6216AWS\u3002 </p>"},{"location":"chap8/9Istio_real_instance/#_2","title":"\u8bbf\u95ee\u96c6\u7fa4","text":"<p>\u6211\u4eec\u6709\u4e24\u79cd\u65b9\u5f0f\u6765\u8bbf\u95ee\u96c6\u7fa4\u3002\u6211\u4eec\u53ef\u4ee5\u4ece\u6d4f\u89c8\u5668\u4e2d\u4f7f\u7528Cloud Shell\u3002\u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u70b9\u51fb\u96c6 \u7fa4\u65c1\u8fb9\u7684Connect\uff0c\u7136\u540e\u70b9\u51fbRun in Cloud Shell\u6309\u94ae\u3002\u70b9\u51fb\u8be5\u6309\u94ae\u53ef\u4ee5\u6253\u5f00Cloud Shell\uff0c\u5e76\u914d\u7f6eKubernetes CLI\u6765\u8bbf\u95ee\u8be5\u96c6\u7fa4\u3002 </p> <p>\u7b2c\u4e8c\u4e2a\u9009\u62e9\u662f\u5728\u4f60\u7684\u7535\u8111\u4e0a\u5b89\u88c5gcloud CLI\uff0c\u7136\u540e\u4ece\u4f60\u7684\u7535\u8111\u4e0a\u8fd0\u884c\u76f8\u540c\u7684\u547d\u4ee4\u3002 </p>"},{"location":"chap8/9Istio_real_instance/#2istio","title":"2\u3001\u5b89\u88c5Istio","text":"<p>\u5b89\u88c5Istlo \u6211\u4eec\u5c06\u4f7f\u7528GetMesh CLI\u5728\u96c6\u7fa4\u4e2d\u5b89\u88c5<code>Istio 1.1O.3</code>\u3002 </p> <p>1\uff0e\u4e0b\u8f7dGetMesh CLI:</p> <pre><code>curl -sL https://istio.tetratelabs.io/getmesh/install.sh | bash\n</code></pre> <p>2\uff0e\u5b89\u88c5Istio: </p> <pre><code>istioctl install --set profile=demo\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u7ed9\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u8bbe\u7f6e\u4e0a<code>istio-injection=enabled</code>\u6807\u7b7e\uff1a </p> <pre><code>kubectl label namespace default istio-injection=enabled\n</code></pre>"},{"location":"chap8/9Istio_real_instance/#3online-boutique","title":"3\u3001\u90e8\u7f72<code>Online Boutique</code> \u5e94\u7528","text":"<p>\u5728\u96c6\u7fa4\u548cIstio\u51c6\u5907\u597d\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u514b\u9686\u5728<code>Online Boutique</code>\u5e94\u7528\u5e93\u3002 </p>"},{"location":"chap8/9Istio_real_instance/#3-1","title":"3-1 \u514b\u9686\u4ed3\u5e93","text":"<pre><code>git clone https://github.com/GoogleCloudPlatform/microservices-demo.git\n</code></pre>"},{"location":"chap8/9Istio_real_instance/#3-2-microservices-demo","title":"3-2 \u524d\u5f80<code>microservices-demo</code>\u76ee\u5f55","text":"<pre><code>cd microservices-demo \n</code></pre>"},{"location":"chap8/9Istio_real_instance/#3-3-kubernetes","title":"3-3 \u521b\u5efaKubernetes\u8d44\u6e90\uff1a","text":"<pre><code>kubectl apply -f release/kubernetes-manifests.yaml \n</code></pre>"},{"location":"chap8/9Istio_real_instance/#3-4-pod","title":"3-4 \u68c0\u67e5\u6240\u6709Pod\u90fd\u5728\u8fd0\u884c\uff1a","text":"<pre><code>$ kubectl get pods\nNAME                   READY  STATUS   RESTARTS  AGE\nadservice-5c9c7c997f-n627f        2/2   Running  0      2m15s\ncartservice-6d99678dd6-767fb       2/2   Running  2      2m16s\ncheckoutservice-779cb9bfdf-l2rs9     2/2   Running  0      2m18s\ncurrencyservice-5db6c7d559-9drtc     2/2   Running  0      2m16s\nemailservice-5c47dc87bf-dk7qv      2/2   Running  0      2m18s\nfrontend-5fcb8cdcdc-8c9dk        2/2   Running  0      2m17s\nloadgenerator-79bff5bd57-q9qkd      2/2   Running  4      2m16s\npaymentservice-6564cb7fb9-f6dwr     2/2   Running  0      2m17s\nproductcatalogservice-5db9444549-hkzv7  2/2   Running  0      2m17s\nrecommendationservice-ff6878cf5-jsghw  2/2   Running  0      2m18s\nredis-cart-57bd646894-zb7ch       2/2   Running  0      2m15s\nshippingservice-f47755f97-dk7k9     2/2   Running  0      2m15s\n</code></pre>"},{"location":"chap8/9Istio_real_instance/#3-5-istio","title":"3-5 \u521b\u5efaIstio\u8d44\u6e90\uff1a","text":"<pre><code>kubectl apply -f ./istio-maifest\n</code></pre> <p>\u90e8\u7f72\u4e86\u4e00\u5207\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5f97\u5230\u5165\u53e3\u7f51\u5173\u7684IP\u5730\u5740\u5e76\u6253\u5f00\u524d\u7aef\u670d\u52a1\uff1a </p> <pre><code>INGRESS_HOST=\"$(kubectl -n istio-system get service istio-ingressgateway \\\n  -o jsonpath='{.status.loadBalancer.ingress[0].ip}')\"\necho \"$INGRESS_HOST\"\n</code></pre> <p>\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00<code>INGRESS_HOST</code>\uff0c\u4f60\u4f1a\u770b\u5230\u524d\u7aef\u670d\u52a1\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 </p> <p> </p> <p> </p> <p>\u6211\u4eec\u9700\u8981\u505a\u7684\u6700\u540e\u4e00\u4ef6\u4e8b\u662f\u5220\u9664<code>frontend-external</code>\u670d\u52a1\u3002<code>frontend-external</code>\u670d\u52a1\u662f\u4e00\u4e2a<code>LoadBalancer</code>\u670d\u52a1\uff0c\u5b83\u66b4\u9732\u4e86\u524d\u7aef\u3002\u7531\u4e8e\u6211\u4eec\u6b63\u5728\u4f7f\u7528Istio\u7684\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u4e0d\u518d\u9700\u8981\u8fd9\u4e2aLoadBalancer\u670d\u52a1\u4e86\u3002 </p> <p>\u5220\u9664\u670d\u52a1\uff0c\u8fd0\u884c\uff1a</p> <pre><code>kubectl delete svc frontend-external \n</code></pre> <p><code>Online Boutique</code>\u5e94\u7528\u6e05\u5355\u8fd8\u5305\u62ec\u4e00\u4e2a\u8d1f\u8f7d\u53d1\u751f\u5668\uff0c\u5b83\u6b63\u5728\u751f\u6210\u5bf9\u6240\u6709\u670d\u52a1\u7684\u8bf7\u6c42\u2015\u8fd9\u662f\u4e3a\u4e86\u8ba9\u6211\u4eec\u80fd\u591f\u6a21\u62df\u7f51\u7ad9\u7684\u6d41\u91cf\u3002 </p> <pre><code>$ istioctl dashboard kiali\nhttp://localhost:20001/kiali\n</code></pre> <p> </p>"},{"location":"chap8/9Istio_real_instance/#4","title":"4\u3001\u8def\u7531\u6d41\u91cf","text":"<p>\u6211\u4eec\u5df2\u7ecf\u5efa\u7acb\u4e86\u4e00\u4e2a\u65b0\u7684Docker\u955c\u50cf\uff0c\u5b83\u4f7f\u7528\u4e86\u4e0e\u5f53\u524d\u8fd0\u884c\u7684\u524d\u7aef\u670d\u52a1\u4e0d\u540c\u7684\u6807\u5934\u3002\u8ba9\u6211\u4eec\u770b\u770b\u5982\u4f55\u90e8\u7f72\u6240\u9700\u7684\u8d44\u6e90\u5e76\u5c06\u4e00\u5b9a\u6bd4\u4f8b\u7684\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684\u524d\u7aef\u670d\u52a1\u7248\u672c\u3002 </p> <p>\u5728\u6211\u4eec\u521b\u5efa\u4efb\u4f55\u8d44\u6e90\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u5220\u9664\u73b0\u6709\u7684\u524d\u7aef\u90e8\u7f72\uff08<code>kubectl delete deploy frontend</code>)\uff0c\u5e76\u521b\u5efa\u4e00\u4e2a\u7248\u672c\u6807\u7b7e\u8bbe\u7f6e\u4e3a<code>original</code>\u3002</p> <pre><code>$ kubectl delete deploy frontend\ndeployment.apps \"frontend\" deleted\n</code></pre> <pre><code>$ curl localhost\nno healthy upstream\n</code></pre> <p><code>1frontendoriginal.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: frontend\nspec:\n  selector:\n    matchLabels:\n      app: frontend\n      version: original\n  template:\n    metadata:\n      labels:\n        app: frontend\n        version: original\n      annotations:\n        sidecar.istio.io/rewriteAppHTTPProbers: \"true\"\n    spec:\n      containers:\n        - name: server\n          image: gcr.io/google-samples/microservices-demo/frontend:v0.2.1\n          ports:\n          - containerPort: 8080\n          readinessProbe:\n            initialDelaySeconds: 10\n            httpGet:\n              path: \"/_healthz\"\n              port: 8080\n              httpHeaders:\n              - name: \"Cookie\"\n                value: \"shop_session-id=x-readiness-probe\"\n          livenessProbe:\n            initialDelaySeconds: 10\n            httpGet:\n              path: \"/_healthz\"\n              port: 8080\n              httpHeaders:\n              - name: \"Cookie\"\n                value: \"shop_session-id=x-liveness-probe\"\n          env:\n          - name: PORT\n            value: \"8080\"\n          - name: PRODUCT_CATALOG_SERVICE_ADDR\n            value: \"productcatalogservice:3550\"\n          - name: CURRENCY_SERVICE_ADDR\n            value: \"currencyservice:7000\"\n          - name: CART_SERVICE_ADDR\n            value: \"cartservice:7070\"\n          - name: RECOMMENDATION_SERVICE_ADDR\n            value: \"recommendationservice:8080\"\n          - name: SHIPPING_SERVICE_ADDR\n            value: \"shippingservice:50051\"\n          - name: CHECKOUT_SERVICE_ADDR\n            value: \"checkoutservice:5050\"\n          - name: AD_SERVICE_ADDR\n            value: \"adservice:9555\"\n          - name: ENV_PLATFORM\n            value: \"gcp\"\n          resources:\n            requests:\n              cpu: 100m\n              memory: 64Mi\n            limits:\n              cpu: 200m\n              memory: 128Mi\n</code></pre> <p> </p> <p>**\u73b0\u5728\u6211\u4eec\u51c6\u5907\u521b\u5efa\u4e00\u4e2a<code>DestinationRule</code>\uff0c\u5b9a\u4e49\u4e24\u4e2a\u7248\u672c\u7684\u524d\u7aef\u2014\u2014\u73b0\u6709\u7684original\u548c\u65b0\u7684\uff08v1)\u3002 **</p> <p><code>frontenddr.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: frontend\nspec:\n  host: frontend.default.svc.cluster.local\n  subsets:\n    - name: original\n      labels:\n        version: original\n    - name: v1\n      labels:\n        version: 1.0.0\n</code></pre> <pre><code>$ kubectl apply -f 2frontenddr.yaml \ndestinationrule.networking.istio.io/frontend created\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u66f4\u65b0VirtualService\uff0c\u5e76\u6307\u5b9a\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u7684\u5b50\u96c6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5c06\u628a\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u539f\u59cb\u7248\u672c\u7684\u524d\u7aef\u3002 </p> <p><code>3frontendvs.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: frontend-ingress\nspec:\n  hosts:\n    - '*'\n  gateways:\n    - frontend-gateway\n  http:\n  - route:\n    - destination:\n        host: frontend\n        port:\n          number: 80\n        subset: original\n</code></pre> <pre><code>$ kubectl apply -f 3frontendvs.yaml \nvirtualservice.networking.istio.io/frontend-ingress configured\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5c06\u65b0\u521b\u5efa\u65b0\u7684<code>VirtualService</code>\u914d\u7f6e\u4e3a\u5c06\u6240\u6709\u8fdb\u5165\u7684\u6d41\u91cf\u8def\u7531\u5230original\u5b50\u96c6\uff0c\u6211\u4eec\u53ef\u4ee5\u5b89\u5168\u5730\u521b\u5efa\u65b0\u7684\u524d\u7aef\u90e8\u7f72</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: frontend-v1\nspec:\n  selector:\n    matchLabels:\n      app: frontend\n      version: 1.0.0\n  template:\n    metadata:\n      labels:\n        app: frontend\n        version: 1.0.0\n      annotations:\n        sidecar.istio.io/rewriteAppHTTPProbers: \"true\"\n    spec:\n      containers:\n        - name: server\n          image: gcr.io/tetratelabs/boutique-frontend:1.0.0\n          ports:\n          - containerPort: 8080\n          readinessProbe:\n            initialDelaySeconds: 10\n            httpGet:\n              path: \"/_healthz\"\n              port: 8080\n              httpHeaders:\n              - name: \"Cookie\"\n                value: \"shop_session-id=x-readiness-probe\"\n          livenessProbe:\n            initialDelaySeconds: 10\n            httpGet:\n              path: \"/_healthz\"\n              port: 8080\n              httpHeaders:\n              - name: \"Cookie\"\n                value: \"shop_session-id=x-liveness-probe\"\n          env:\n          - name: PORT\n            value: \"8080\"\n          - name: PRODUCT_CATALOG_SERVICE_ADDR\n            value: \"productcatalogservice:3550\"\n          - name: CURRENCY_SERVICE_ADDR\n            value: \"currencyservice:7000\"\n          - name: CART_SERVICE_ADDR\n            value: \"cartservice:7070\"\n          - name: RECOMMENDATION_SERVICE_ADDR\n            value: \"recommendationservice:8080\"\n          - name: SHIPPING_SERVICE_ADDR\n            value: \"shippingservice:50051\"\n          - name: CHECKOUT_SERVICE_ADDR\n            value: \"checkoutservice:5050\"\n          - name: AD_SERVICE_ADDR\n            value: \"adservice:9555\"\n          - name: ENV_PLATFORM\n            value: \"gcp\"\n          resources:\n            requests:\n              cpu: 100m\n              memory: 64Mi\n            limits:\n              cpu: 200m\n              memory: 128Mi\n</code></pre> <pre><code>$ kubectl apply -f 4frontendv1.yaml \ndeployment.apps/frontend-v1 created\n</code></pre> <pre><code>$ kubectl get pod | grep front\nfrontend-8658d97d64-rbwjw                2/2     Running            0          16m\nfrontend-v1-664f8ff6c6-lvnwr             2/2     Running            0          61s\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 VirtualService\u4e2d\u7684\u6743\u91cd<code>INGRESS_HOST</code>, \u6211\u4eec\u4ecd\u7136\u4f1a\u770b\u5230\u539f\u59cb\u7248\u672c\u7684\u524d\u7aef\u3002\u8ba9\u6211\u4eec\u66f4\u65b0\uff0c\u5f00\u59cb\u5c0630\uff05\u7684\u6d41\u91cf\u8def\u7531\u5230<code>v1</code>\u7684\u5b50\u96c6\u3002 </p> <p><code>5frontend.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: frontend-ingress\nspec:\n  hosts:\n    - '*'\n  gateways:\n    - frontend-gateway\n  http:\n  - route:\n    - destination:\n        host: frontend\n        port:\n          number: 80\n        subset: original\n      weight: 70\n    - destination:\n        host: frontend\n        port:\n          number: 80\n        subset: v1\n      weight: 30\n\n</code></pre> <pre><code>$ kubectl apply -f 5frontend30.yaml \nvirtualservice.networking.istio.io/frontend-ingress configured\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5237\u65b0\u51e0\u6b21\u7f51\u9875\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u6765\u81ea\u524d\u7aefv1\u7684\u66f4\u65b0\u6807\u5934 </p> <p> </p> <p> </p>"},{"location":"chap8/9Istio_real_instance/#5","title":"5\u3001\u6545\u969c\u6ce8\u5165","text":"<p>\u5728\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u4e3a\u63a8\u8350\u670d\u52a1\u5f15\u51655\u79d2\u7684\u5ef6\u8fdf\u3002Envoy\u5c06\u4e3a50\uff05\u7684\u8bf7\u6c42\u6ce8\u5165\u5ef6\u8fdf\u3002 </p> <p><code>recommendationdelay.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: recommendationservice\nspec:\n  hosts:\n  - recommendationservice\n  http:\n  - route:\n      - destination:\n          host: recommendationservice\n    fault:\n      delay:\n        percentage:\n          value: 50\n        fixedDelay: 5s\n</code></pre> <pre><code>$ kubectl get vs\nNAME                    GATEWAYS               HOSTS                                    AGE\nfrontend                                       [\"frontend.default.svc.cluster.local\"]   28h\nfrontend-ingress        [\"frontend-gateway\"]   [\"*\"]                                    28h\nrecommendationservice                          [\"recommendationservice\"]                84s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00<code>INGRESS_HOST</code>\uff0c\u7136\u540e\u70b9\u51fb\u5176\u4e2d\u4e00\u4e2a\u4ea7\u54c1\u3002\u63a8\u8350\u670d\u52a1\u7684\u7ed3\u679c\u663e\u793a\u5728\u5c4f\u5e55\u5e95\u90e8\u7684\u201dOther Products You Might Light\u201c\u90e8\u5206\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5237\u65b0\u51e0\u6b21\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\uff0c\u8be5\u9875\u9762\u8981\u4e48\u7acb\u5373\u52a0\u8f7d\uff0c\u8981\u4e48\u6709\u4e00\u4e2a\u5ef6\u8fdf\u52a0\u8f7d\u9875\u9762\u3002\u8fd9\u4e2a\u5ef6\u8fdf\u662f\u7531\u4e8e\u6211\u4eec\u6ce8\u5165\u4e865\u79d2\u7684\u5ef6\u8fdf\u3002 </p> <p>\u6211\u4eec\u53ef\u4ee5\u6253\u5f00Grafana (<code>istioctl dash grafana</code>)\u548cIstio\u670d\u52a1\u4eea\u8868\u677f\u3002\u786e\u4fdd\u4ece\u670d\u52a1\u5217\u8868\u4e2d\u9009\u62e9<code>recommendationsservice</code>\uff0c\u5728Reporter\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9source\uff0c\u5e76\u67e5\u770b\u663e\u793a\u5ef6\u8fdf\u7684Client Request Duration\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 </p> <p> </p> <p>\u540c\u6837\u5730\uff0c\u6211\u4eec\u53ef\u4ee5\u6ce8\u5165\u4e00\u4e2a\u4e2d\u6b62\u3002\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4e3a\u53d1\u9001\u5230\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u768450\uff05\u7684\u8bf7\u6c42\u6ce8\u5165\u4e00\u4e2a<code>HTTP 5000</code> </p> <p><code>productcatalogserviceabort.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: productcatalogservice\nspec:\n  hosts:\n  - productcatalogservice\n  http:\n  - route:\n      - destination:\n          host: productcatalogservice\n    fault:\n      abort:\n        percentage:\n          value: 50\n        httpStatus: 500\n</code></pre> <pre><code>$ kubectl apply -f 7productcatalogserviceabort.yaml \nvirtualservice.networking.istio.io/productcatalogservice created\n\n$ kubectl get vs\nNAME                    GATEWAYS               HOSTS                                    AGE\nfrontend                                       [\"frontend.default.svc.cluster.local\"]   28h\nfrontend-ingress        [\"frontend-gateway\"]   [\"*\"]                                    28h\nproductcatalogservice                          [\"productcatalogservice\"]                12s\nrecommendationservice                          [\"recommendationservice\"]                11m\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5237\u65b0\u51e0\u6b21\u4ea7\u54c1\u9875\u9762\uff0c\u6211\u4eec\u5e94\u8be5\u5f97\u5230\u5982\u4e0b\u56fe\u6240\u793a\u7684\u9519\u8bef\u4fe1\u606f\u3002 </p> <p> </p> <p>\u8bf7\u6ce8\u610f\uff0c\u9519\u8bef\u4fe1\u606f\u8bf4\uff0c\u5931\u8d25\u7684\u539f\u56e0\u662f\u6545\u969c\u8fc7\u6ee4\u5668\u4e2d\u6b62\u3002\u5982\u679c\u6211\u4eec\u6253\u5f00Grafana (<code>istioctl dash grafana</code>)\uff0c\u6211\u4eec\u4e5f\u4f1a\u6ce8\u610f\u5230\u56fe\u4e2d\u62a5\u544a\u7684\u9519\u8bef\u3002 </p> <p> </p>"},{"location":"chap8/9Istio_real_instance/#6","title":"6\u3001\u5f39\u6027","text":"<p>\u4e3a\u4e86\u6f14\u793a\u5f39\u6027\u529f\u80fd\uff0c\u6211\u4eec\u5c06\u5728\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u90e8\u7f72\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a<code>EXTRA LATENCY</code>\u7684\u73af\u5883\u53d8\u91cf\u3002\u8fd9\u4e2a\u53d8\u91cf\u4f1a\u5728\u6bcf\u6b21\u8c03\u7528\u670d\u52a1\u65f6\u6ce8\u5165\u4e00\u4e2a\u989d\u5916\u7684\u4f53\u7720\u3002 </p> <p>\u901a\u8fc7\u8fd0\u884c<code>kubectl edit deploy productcatalogservice</code>\u6765\u7f16\u8f91\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u90e8\u7f72\u3002 \u8fd9\u5c06\u6253\u5f00\u4e00\u4e2a\u7f16\u8f91\u5668\u3002\u6eda\u52a8\u5230\u6709\u73af\u5883\u53d8\u91cf\u7684\u90e8\u5206\uff0c\u6dfb\u52a0<code>EXTRA_LATENCY</code>\u73af\u5883\u53d8\u91cf\u3002 </p> <pre><code>...\n   spec:\n    containers:\n    - env:\n     - name: EXTRA_LATENCY\n      value: 6s\n...\n</code></pre> <pre><code>$ kubectl edit deploy productcatalogservice\ndeployment.apps/productcatalogservice edited\n</code></pre> <p>\u4fdd\u5b58\u5e76\u63a8\u51fa\u7f16\u8f91\u5668\u3002 </p> <p>\u5982\u679c\u6211\u4eec\u5237\u65b0\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u9875\u9762\u9700\u89816\u79d2\u7684\u65f6\u95f4\u6765\u52a0\u8f7d\u2014\u2014\u90a3\u662f\u7531\u4e8e\u6211\u4eec\u6ce8\u5165\u7684\u5ef6\u8fdf\u3002 </p> <p> </p> <p>\u8ba9\u6211\u4eec\u7ed9\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u6dfb\u52a0\u4e00\u4e2a2\u79d2\u7684\u8d85\u65f6\u3002 </p> <p><code>productcatalogservice-timeout.yaml</code></p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: productcatalogservice\nspec:\n  hosts:\n  - productcatalogservice\n  http:\n  - route:\n   - destination:\n     host: productcatalogservice\n   timeout: 2s\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5237\u65b0\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u4e00\u4e2a\u9519\u8bef\u4fe1\u606f\u7684\u51fa\u73b0 </p> <pre><code>$ kubectl apply -f 8productcatalogservice-timeout.yaml \nvirtualservice.networking.istio.io/productcatalogservice created\n\n$ kubectl get vs\nNAME                    GATEWAYS               HOSTS                                    AGE\nfrontend                                       [\"frontend.default.svc.cluster.local\"]   29h\nfrontend-ingress        [\"frontend-gateway\"]   [\"*\"]                                    18m\nproductcatalogservice                          [\"productcatalogservice\"]                18s\n</code></pre> <p>\u8be5\u9519\u8bef\u8868\u660e\u5bf9\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u7684\u8bf7\u6c42\u8d85\u65f6\u4e86\u3002\u6211\u4eec\u4fee\u6539\u4e86\u670d\u52a1\uff0c\u589e\u52a0\u4e866\u79d2\u7684\u5ef6\u8fdf\uff0c\u5e76\u5c06\u8d85\u65f6\u8bbe\u7f6e\u4e3a2\u79d2\u3002</p> <p> </p> <p> </p> <p>\u8ba9\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u91cd\u8bd5\u7b56\u7565\uff0c\u6709\u4e09\u6b21\u5c1d\u8bd5\uff0c\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u4e3a1\u79d2\u3002 </p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: productcatalogservice\nspec:\n  hosts:\n  - productcatalogservice\n  http:\n  - route:\n    - destination:\n        host: productcatalogservice\n    retries:\n      attempts: 3\n      perTryTimeout: 1s\n</code></pre> <pre><code>$ kubectl apply -f 9productcatalogservice-att.yaml \nvirtualservice.networking.istio.io/productcatalogservice configured\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u5728\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u90e8\u7f72\u4e2d\u7559\u4e0b\u4e86\u989d\u5916\u7684\u5ef6\u8fdf\uff0c\u6211\u4eec\u4ecd\u7136\u4f1a\u770b\u5230\u9519\u8bef\u3002\u8ba9\u6211\u4eec\u6253\u5f00<code>Zipkin</code>\u4e2d\u7684\u8ffd\u8e2a\uff0c\u770b\u770b\u91cd\u8bd5\u7b56\u7565\u7684\u4f5c\u7528\u3002</p> <p>\u4f7f\u7528<code>istioctl dash zipkin</code>\u6765\u6253\u5f00Zipkin\u4eea\u8868\u76d8\u3002\u70b9\u51fb\u5341\u6309\u94ae\uff0c\u9009\u62e9<code>serviceName</code>\u548c<code>frontend.default</code>\u3002\u4e3a\u4e86\u53ea\u5f97\u5230\u81f3\u5c11\u4e00\u79d2\u949f\u7684\u54cd\u5e94\uff08\u8fd9\u5c31\u662f\u6211\u4eec\u7684<code>perTryTimeout</code>)\uff0c\u9009\u62e9<code>minDuration</code>\uff0c\u5728\u6587\u672c\u6846\u4e2d\u8f93\u51651s\u3002\u70b9\u51fb\u641c\u7d22\u6309\u94ae\uff0c\u663e\u793a\u6240\u6709\u8ffd\u8e2a\u3002</p> <p>\u70b9\u51fbFilter\u6309\u94ae\uff0c\u4ece\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9<code>productCatalogService.default</code>\u3002\u4f60\u5e94\u8be5\u770b\u5230\u82b1\u4e861\u79d2\u949f\u7684trace\u3002\u8fd9\u4e9btrace\u5bf9\u5e94\u4e8e\u6211\u4eec\u4e4b\u524d\u5b9a\u4e49\u7684<code>perTryTimeout</code></p> <p> </p>"},{"location":"chap9/1Istio_intro_ppt/","title":"\u7b2c\u4e00\u8282 istio\u6d45\u6790 (Slide\u5907\u6848\uff09","text":""},{"location":"chap9/1Istio_intro_ppt/#1istio","title":"1\u3001istio\u7b80\u4ecb","text":"<p>istio\u662f\u4e00\u4e2a\u5f00\u6e90\u670d\u52a1\u7f51\u683c\u5e73\u53f0\uff0c\u5b83\u53ef\u4ee5\u63a7\u5236\u5fae\u670d\u52a1\u4e4b\u95f4\u6570\u636e\u7684\u5171\u4eab\u65b9\u5f0f\uff0c\u5176\u9644\u5e26\u7684 API \u53ef\u4ee5\u5c06 Istio \u96c6\u6210\u5230\u4efb\u4f55\u65e5\u5fd7\u8bb0\u5f55\u5e73\u53f0\u3001\u9065\u6d4b\u6216\u7b56\u7565\u7cfb\u7edf\u4e2d\u3002</p> <p>\u5728\u8bbe\u8ba1\u4e0a\uff0cIstio \u53ef\u4ee5\u5728\u591a\u79cd\u73af\u5883\u4e2d\u8fd0\u884c\uff1a\u4f01\u4e1a\u672c\u5730\u3001\u4e91\u6258\u7ba1\u3001Kubernetes\u5bb9\u5668\uff0c\u6216\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u670d\u52a1\u7b49\u3002 </p> <p> </p> <p>Istio \u63d0\u4f9b\u4e00\u79cd\u7b80\u5355\u7684\u65b9\u5f0f\u6765\u4e3a\u5df2\u90e8\u7f72\u7684\u670d\u52a1\u5efa\u7acb\u7f51\u7edc\uff0c\u8be5\u7f51\u7edc\u5177\u6709\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u95f4\u8ba4\u8bc1\u3001\u76d1\u63a7\u7b49\u529f\u80fd\uff0c</p> <p>\u53ea\u9700\u8981\u5bf9\u670d\u52a1\u7684\u4ee3\u7801\u8fdb\u884c\u4e00\u70b9\u6216\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u6539\u52a8\uff0c\u8ba9\u670d\u52a1\u652f\u6301 Istio\uff0c\u53ea\u9700\u8981\u5728\u73af\u5883\u4e2d\u90e8\u7f72\u4e00\u4e2a\u7279\u6b8a\u7684 sidecar \u4ee3\u7406\uff0c\u4f7f\u7528 Istio \u63a7\u5236\u5e73\u9762\u529f\u80fd\u914d\u7f6e\u548c\u7ba1\u7406\u4ee3\u7406\uff0c\u62e6\u622a\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1\uff1a</p> <ul> <li>HTTP\u3001gRPC\u3001WebSocket \u548c TCP \u6d41\u91cf\u7684\u81ea\u52a8\u8d1f\u8f7d\u5747\u8861\u3002</li> <li>\u901a\u8fc7\u4e30\u5bcc\u7684\u8def\u7531\u89c4\u5219\u3001\u91cd\u8bd5\u3001\u6545\u969c\u8f6c\u79fb\u548c\u6545\u969c\u6ce8\u5165\uff0c\u53ef\u4ee5\u5bf9\u6d41\u91cf\u884c\u4e3a\u8fdb\u884c\u7ec6\u7c92\u5ea6\u63a7\u5236\u3002</li> <li>\u53ef\u63d2\u5165\u7684\u7b56\u7565\u5c42\u548c\u914d\u7f6e API\uff0c\u652f\u6301\u8bbf\u95ee\u63a7\u5236\u3001\u901f\u7387\u9650\u5236\u548c\u914d\u989d\u3002</li> <li>\u5bf9\u51fa\u5165\u96c6\u7fa4\u5165\u53e3\u548c\u51fa\u53e3\u4e2d\u6240\u6709\u6d41\u91cf\u7684\u81ea\u52a8\u5ea6\u91cf\u6307\u6807\u3001\u65e5\u5fd7\u8bb0\u5f55\u548c\u8ffd\u8e2a\u3002</li> <li>\u901a\u8fc7\u5f3a\u5927\u7684\u57fa\u4e8e\u8eab\u4efd\u7684\u9a8c\u8bc1\u548c\u6388\u6743\uff0c\u5728\u96c6\u7fa4\u4e2d\u5b9e\u73b0\u5b89\u5168\u7684\u670d\u52a1\u95f4\u901a\u4fe1\u3002</li> </ul>"},{"location":"chap9/1Istio_intro_ppt/#2istio","title":"2\u3001istio \u6846\u67b6","text":""},{"location":"chap9/1Istio_intro_ppt/#2-1-istio","title":"2-1 istio\u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762","text":"<ul> <li>\u6570\u636e\u5e73\u9762 \u7531\u4e00\u7ec4\u667a\u80fd\u4ee3\u7406\uff08Envoy\uff09\u7ec4\u6210\uff0c\u88ab\u90e8\u7f72\u4e3a sidecar\u3002\u8fd9\u4e9b\u4ee3\u7406\u8d1f\u8d23\u534f\u8c03\u548c\u63a7\u5236\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1\u3002\u4ed6\u4eec\u8fd8\u6536\u96c6\u548c\u62a5\u544a\u6240\u6709\u7f51\u683c\u6d41\u91cf\u7684\u9065\u6d4b\u6570\u636e\u3002</li> <li>\u63a7\u5236\u5e73\u9762 \u7ba1\u7406\u5e76\u914d\u7f6e\u4ee3\u7406\u6765\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002</li> </ul> <p>istio \u4e2d\u7684\u6d41\u91cf\u5206\u4e3a\u6570\u636e\u5e73\u9762\u6d41\u91cf\u548c\u63a7\u5236\u5e73\u9762\u6d41\u91cf\u3002</p> <ul> <li>\u6570\u636e\u5e73\u9762\u6d41\u91cf\u662f\u6307\u5de5\u4f5c\u8d1f\u8f7d\u7684\u4e1a\u52a1\u903b\u8f91\u53d1\u9001\u548c\u63a5\u6536\u7684\u6d88\u606f</li> <li>\u63a7\u5236\u5e73\u9762\u6d41\u91cf\u662f\u6307\u5728 Istio \u7ec4\u4ef6\u4e4b\u95f4\u53d1\u9001\u7684\u914d\u7f6e\u548c\u63a7\u5236\u6d88\u606f\u7528\u6765\u7f16\u6392\u7f51\u683c\u7684\u884c\u4e3a\u3002</li> </ul> <p>Istio \u4e2d\u7684\u6d41\u91cf\u7ba1\u7406\u7279\u6307\u6570\u636e\u5e73\u9762\u6d41\u91cf\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#3envoy","title":"3\u3001Envoy","text":"<p>Istio \u4f7f\u7528 Envoy \u4ee3\u7406\u7684\u6269\u5c55\u7248\u672c\u3002Envoy \u662f\u7528 C++ \u5f00\u53d1\u7684\u9ad8\u6027\u80fd\u4ee3\u7406\uff0c\u7528\u4e8e\u534f\u8c03\u670d\u52a1\u7f51\u683c\u4e2d\u6240\u6709\u670d\u52a1\u7684\u5165\u7ad9\u548c\u51fa\u7ad9\u6d41\u91cf\u3002Envoy \u4ee3\u7406\u662f\u552f\u4e00\u4e0e\u6570\u636e\u5e73\u9762\u6d41\u91cf\u4ea4\u4e92\u7684 Istio \u7ec4\u4ef6\u3002</p> <p>Envoy \u4ee3\u7406\u88ab\u90e8\u7f72\u4e3a\u670d\u52a1\u7684 sidecar\uff0c\u5728\u903b\u8f91\u4e0a\u4e3a\u670d\u52a1\u589e\u52a0\u4e86 Envoy \u7684\u8bb8\u591a\u5185\u7f6e\u7279\u6027\uff0c\u4f8b\u5982:</p> <ul> <li>\u52a8\u6001\u670d\u52a1\u53d1\u73b0</li> <li>\u8d1f\u8f7d\u5747\u8861</li> <li>TLS \u7ec8\u7aef</li> <li>HTTP/2 \u4e0e gRPC \u4ee3\u7406</li> <li>\u7194\u65ad\u5668</li> <li>\u5065\u5eb7\u68c0\u67e5</li> <li>\u57fa\u4e8e\u767e\u5206\u6bd4\u6d41\u91cf\u5206\u5272\u7684\u5206\u9636\u6bb5\u53d1\u5e03</li> <li>\u6545\u969c\u6ce8\u5165</li> <li>\u4e30\u5bcc\u7684\u6307\u6807</li> </ul> <p>\u8fd9\u79cd sidecar \u90e8\u7f72\u5141\u8bb8 Istio \u63d0\u53d6\u5927\u91cf\u5173\u4e8e\u6d41\u91cf\u884c\u4e3a\u7684\u4fe1\u53f7\u4f5c\u4e3a\u5c5e\u6027\u3002</p> <p>Istio \u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u5c5e\u6027\u6765\u5b9e\u65bd\u7b56\u7565\u51b3\u7b56\uff0c\u5e76\u5c06\u5176\u53d1\u9001\u5230\u76d1\u89c6\u7cfb\u7edf\u4ee5\u63d0\u4f9b\u6709\u5173\u6574\u4e2a\u7f51\u683c\u884c\u4e3a\u7684\u4fe1\u606f\u3002</p> <p>sidecar \u4ee3\u7406\u6a21\u578b\u53ef\u4ee5\u5b9e\u73b0\u73b0\u6709\u7684\u90e8\u7f72\u6dfb\u52a0 Istio \u529f\u80fd\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u8bbe\u8ba1\u67b6\u6784\u6216\u91cd\u5199\u4ee3\u7801\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#4pilot","title":"4\u3001Pilot","text":"<p>Pilot \u4e3a Envoy sidecar \u63d0\u4f9b\u670d\u52a1\u53d1\u73b0\u3001\u7528\u4e8e\u667a\u80fd\u8def\u7531\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff08\u4f8b\u5982\uff0cA/B \u6d4b\u8bd5\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\uff09\u4ee5\u53ca\u5f39\u6027\u529f\u80fd\uff08\u8d85\u65f6\u3001\u91cd\u8bd5\u3001\u7194\u65ad\u5668\u7b49\uff09\u3002</p> <p>Pilot \u5c06\u63a7\u5236\u6d41\u91cf\u884c\u4e3a\u7684\u9ad8\u7ea7\u8def\u7531\u89c4\u5219\u8f6c\u6362\u4e3a\u7279\u5b9a\u4e8e\u73af\u5883\u7684\u914d\u7f6e\uff0c\u5e76\u5728\u8fd0\u884c\u65f6\u5c06\u5b83\u4eec\u4f20\u64ad\u5230 sidecar\u3002</p> <p>Pilot \u5c06\u7279\u5b9a\u4e8e\u5e73\u53f0\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\u62bd\u8c61\u51fa\u6765\uff0c\u5e76\u5c06\u5b83\u4eec\u5408\u6210\u4e3a\u4efb\u4f55\u7b26\u5408 Envoy API \u7684 sidecar \u90fd\u53ef\u4ee5\u4f7f\u7528\u7684\u6807\u51c6\u683c\u5f0f\u3002</p> <p> </p> <p>\u5e73\u53f0\u542f\u52a8\u4e00\u4e2a\u670d\u52a1\u7684\u65b0\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u901a\u77e5\u5176\u5e73\u53f0\u9002\u914d\u5668\u3002</p> <ol> <li>\u5e73\u53f0\u9002\u914d\u5668\u4f7f\u7528 Pilot \u62bd\u8c61\u6a21\u578b\u6ce8\u518c\u5b9e\u4f8b\u3002</li> <li>Pilot \u5c06\u6d41\u91cf\u89c4\u5219\u548c\u914d\u7f6e\u6d3e\u53d1\u7ed9 Envoy \u4ee3\u7406\uff0c\u6765\u4f20\u8fbe\u6b64\u6b21\u66f4\u6539\u3002</li> <li>\u8fd9\u79cd\u677e\u8026\u5408\u5141\u8bb8 Istio \u5728 Kubernetes\u3001Consul \u6216 Nomad \u7b49\u591a\u79cd\u73af\u5883\u4e2d\u8fd0\u884c\uff0c\u540c\u65f6\u7ef4\u62a4\u76f8\u540c\u7684 operator \u63a5\u53e3\u6765\u8fdb\u884c\u6d41\u91cf\u7ba1\u7406\u3002\u53ef\u4ee5\u4f7f\u7528 Istio \u7684\u6d41\u91cf\u7ba1\u7406 API \u6765\u6307\u793a Pilot \u4f18\u5316 Envoy \u914d\u7f6e\uff0c\u4ee5\u4fbf\u5bf9\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\u8fdb\u884c\u66f4\u7ec6\u7c92\u5ea6\u5730\u63a7\u5236\u3002</li> </ol>"},{"location":"chap9/1Istio_intro_ppt/#5citadel","title":"5\u3001Citadel","text":"<p>Citadel \u901a\u8fc7\u5185\u7f6e\u7684\u8eab\u4efd\u548c\u8bc1\u4e66\u7ba1\u7406\uff0c\u53ef\u4ee5\u652f\u6301\u5f3a\u5927\u7684\u670d\u52a1\u5230\u670d\u52a1\u4ee5\u53ca\u6700\u7ec8\u7528\u6237\u7684\u8eab\u4efd\u9a8c\u8bc1\uff0c\u53ef\u4ee5\u4f7f\u7528 Citadel \u6765\u5347\u7ea7\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u672a\u52a0\u5bc6\u6d41\u91cf\uff0c\u4f7f\u7528 Citadel\uff0coperator \u53ef\u4ee5\u6267\u884c\u57fa\u4e8e\u670d\u52a1\u8eab\u4efd\u7684\u7b56\u7565\uff0c\u800c\u4e0d\u662f\u76f8\u5bf9\u4e0d\u7a33\u5b9a\u7684 3 \u5c42\u6216 4 \u5c42\u7f51\u7edc\u6807\u8bc6\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#6galley","title":"6\u3001Galley","text":"<p>Galley \u662f Istio \u7684\u914d\u7f6e\u9a8c\u8bc1\u3001\u63d0\u53d6\u3001\u5904\u7406\u548c\u5206\u53d1\u7ec4\u4ef6\u3002\u5b83\u8d1f\u8d23\u5c06\u5176\u4f59\u7684 Istio \u7ec4\u4ef6\u4e0e\u4ece\u5e95\u5c42\u5e73\u53f0\uff08\u4f8b\u5982 Kubernetes\uff09\u83b7\u53d6\u7528\u6237\u914d\u7f6e\u7684\u7ec6\u8282\u9694\u79bb\u5f00\u6765\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#7istio","title":"7\u3001Istio\u8bbe\u8ba1\u76ee\u6807","text":"<p>\u51e0\u4e2a\u5173\u952e\u7684\u8bbe\u8ba1\u76ee\u6807\u5f62\u6210\u4e86 Istio \u7684\u67b6\u6784\u3002\u8fd9\u4e9b\u76ee\u6807\u5bf9\u4e8e\u4f7f\u7cfb\u7edf\u80fd\u591f\u5927\u89c4\u6a21\u548c\u9ad8\u6027\u80fd\u5730\u5904\u7406\u670d\u52a1\u662f\u81f3\u5173\u91cd\u8981\u7684\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#1","title":"1. \u900f\u660e\u5ea6\u6700\u5927\u5316","text":"<p>\u4e3a\u4e86\u91c7\u7528 Istio\uff0c\u8fd0\u7ef4\u4eba\u5458\u6216\u5f00\u53d1\u4eba\u5458\u9700\u8981\u505a\u5c3d\u53ef\u80fd\u5c11\u7684\u5de5\u4f5c\uff0c\u624d\u80fd\u4ece\u7cfb\u7edf\u4e2d\u83b7\u5f97\u771f\u6b63\u7684\u4ef7\u503c\u3002\u4e3a\u6b64\uff0cIstio \u53ef\u4ee5\u81ea\u52a8\u5c06\u81ea\u5df1\u6ce8\u5165\u5230\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u8def\u5f84\u4e2d\u3002Istio \u4f7f\u7528 sidecar \u4ee3\u7406\u6765\u6355\u83b7\u6d41\u91cf\uff0c\u5e76\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u5728\u4e0d\u66f4\u6539\u5df2\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\uff0c\u81ea\u52a8\u5bf9\u7f51\u7edc\u5c42\u8fdb\u884c\u914d\u7f6e\uff0c\u4ee5\u5b9e\u73b0\u901a\u8fc7\u8fd9\u4e9b\u4ee3\u7406\u6765\u8def\u7531\u6d41\u91cf\u3002</p> <p>\u5728 Kubernetes \u4e2d\uff0c\u4ee3\u7406\u88ab\u6ce8\u5165\u5230pods\u4e2d\uff0c\u901a\u8fc7\u7f16\u5199iptables\u89c4\u5219\u6765\u6355\u83b7\u6d41\u91cf\u3002</p> <p>\u4e00\u65e6 sidecar \u4ee3\u7406\u88ab\u6ce8\u5165\u4ee5\u53ca\u6d41\u91cf\u8def\u7531\u88ab\u7f16\u7a0b\uff0cIstio \u5c31\u53ef\u4ee5\u534f\u8c03\u6240\u6709\u7684\u6d41\u91cf\u3002\u8fd9\u4e2a\u539f\u5219\u4e5f\u9002\u7528\u4e8e\u6027\u80fd\u3002\u5f53\u5c06 Istio \u5e94\u7528\u4e8e\u90e8\u7f72\u65f6\uff0c\u8fd0\u7ef4\u4eba\u5458\u4f1a\u770b\u5230\u6240\u63d0\u4f9b\u529f\u80fd\u7684\u8d44\u6e90\u6210\u672c\u589e\u52a0\u7684\u6700\u5c0f\u3002\u7ec4\u4ef6\u548c API \u7684\u8bbe\u8ba1\u5fc5\u987b\u8003\u8651\u5230\u6027\u80fd\u548c\u53ef\u4f38\u7f29\u6027\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#2","title":"2 \u53ef\u6269\u5c55\u6027","text":"<p>\u968f\u7740\u8fd0\u7ef4\u4eba\u5458\u548c\u5f00\u53d1\u4eba\u5458\u8d8a\u6765\u8d8a\u4f9d\u8d56\u4e8e Istio \u63d0\u4f9b\u7684\u529f\u80fd\uff0c\u7cfb\u7edf\u5fc5\u987b\u968f\u7740\u4ed6\u4eec\u7684\u9700\u6c42\u800c\u589e\u957f\u3002</p> <p>\u5728\u7ee7\u7eed\u6dfb\u52a0\u65b0\u7279\u6027\u65f6\uff0c\u6700\u5927\u7684\u9700\u6c42\u662f\u6269\u5c55\u7b56\u7565\u7cfb\u7edf\u7684\u80fd\u529b\uff0c\u4e0e\u5176\u4ed6\u7b56\u7565\u548c\u63a7\u5236\u6e90\u7684\u96c6\u6210\uff0c\u4ee5\u53ca\u5c06\u5173\u4e8e\u7f51\u683c\u884c\u4e3a\u7684\u4fe1\u53f7\u4f20\u64ad\u5230\u5176\u4ed6\u7cfb\u7edf\u8fdb\u884c\u5206\u6790\u7684\u80fd\u529b\u3002\u7b56\u7565\u8fd0\u884c\u65f6\u652f\u6301\u7528\u4e8e\u63a5\u5165\u5176\u4ed6\u670d\u52a1\u7684\u6807\u51c6\u6269\u5c55\u673a\u5236\u3002\u6b64\u5916\uff0c\u5b83\u5141\u8bb8\u6269\u5c55\u5176\u8bcd\u6c47\u8868\uff0c\u5141\u8bb8\u6839\u636e\u7f51\u683c\u751f\u6210\u7684\u65b0\u4fe1\u53f7\u6267\u884c\u7b56\u7565\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#3","title":"3 \u53ef\u79fb\u690d\u6027","text":"<p>\u4f7f\u7528 Istio \u7684\u751f\u6001\u7cfb\u7edf\u5728\u8bb8\u591a\u65b9\u9762\u90fd\u6709\u6240\u4e0d\u540c\u3002Istio \u5fc5\u987b\u5728\u4efb\u4f55\u4e91\u73af\u5883\u6216\u672c\u5730\u73af\u5883\u4e2d\u901a\u8fc7\u6700\u5c0f\u7684\u52aa\u529b\u5c31\u80fd\u8fd0\u884c\u8d77\u6765\u3002\u5c06\u57fa\u4e8e Istio \u7684\u670d\u52a1\u79fb\u690d\u5230\u65b0\u73af\u5883\u7684\u4efb\u52a1\u5fc5\u987b\u662f\u5bb9\u6613\u5b9e\u73b0\u7684\u3002</p> <p>\u4f7f\u7528 Istio\uff0c\u53ef\u4ee5\u64cd\u4f5c\u90e8\u7f72\u5230\u591a\u4e2a\u73af\u5883\u4e2d\u7684\u5355\u4e2a\u670d\u52a1\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u5728\u591a\u4e2a\u4e91\u4e0a\u90e8\u7f72\u6765\u5b9e\u73b0\u5197\u4f59\u3002</p> <p>\u7b56\u7565\u4e00\u81f4\u6027\uff1a\u5c06\u7b56\u7565\u5e94\u7528\u4e8e\u670d\u52a1\u4e4b\u95f4\u7684 API \u8c03\u7528\u63d0\u4f9b\u4e86\u5bf9\u7f51\u683c\u884c\u4e3a\u7684\u5927\u91cf\u63a7\u5236\u3002\u7136\u800c\uff0c\u5c06\u7b56\u7565\u5e94\u7528\u5728\u533a\u522b\u4e8e API \u5c42\u4e0a\u7684\u8d44\u6e90\u4e5f\u540c\u6837\u91cd\u8981\u3002\u4f8b\u5982\uff0c\u5728\u673a\u5668\u5b66\u4e60\u8bad\u7ec3\u4efb\u52a1\u6d88\u8017\u7684 CPU \u6570\u91cf\u4e0a\u5e94\u7528\u914d\u989d\u6bd4\u5728\u53d1\u8d77\u4efb\u52a1\u7684\u8bf7\u6c42\u8c03\u7528\u4e0a\u5e94\u7528\u914d\u989d\u66f4\u6709\u7528\u3002\u4e3a\u6b64\uff0cIstio \u4f7f\u7528\u81ea\u5df1\u7684 API \u5c06\u7b56\u7565\u7cfb\u7edf\u7ef4\u62a4\u4e3a\u4e00\u4e2a\u72ec\u7acb\u7684\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u5c06\u7b56\u7565\u7cfb\u7edf\u96c6\u6210\u5230 sidecar \u4ee3\u7406\u4e2d\uff0c\u4ece\u800c\u5141\u8bb8\u670d\u52a1\u6839\u636e\u9700\u8981\u76f4\u63a5\u4e0e\u4e4b\u96c6\u6210\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#8istio","title":"8\u3001istio\u7ec4\u4ef6\u8be6\u89e3","text":""},{"location":"chap9/1Istio_intro_ppt/#8-1-istiosidecar","title":"8-1 Istio\u7684sidecar\u4ee3\u7406","text":"<p>\u7f51\u7edc\u6a21\u578b\u53d1\u5c55</p> <p> </p> <p>\u6211\u4eec\u56de\u987e\u8ba1\u7b97\u7f51\u7edc\u7684\u53d1\u5c55\u53f2\u3002\u5728\u5206\u7ec4\u4ea4\u6362\u7f51\u7edc\u7684\u51fa\u73b0\u540e\uff0c\u9700\u8981\u7528\u6237\u81ea\u5df1\u6765\u4f7f\u7528\u63e1\u624b\u3001\u91cd\u4f20\u548c\u56e0\u7279\u7f51\u5c06\u4e00\u5806\u6570\u636e\u5305\u8f6c\u6362\u4e3a\u6709\u5e8f\u7684\u5b57\u8282\u6d41\u3002\u51fa\u4e8e\u4e92\u64cd\u4f5c\u6027\u548c\u7b80\u5355\u6027\u7684\u8003\u8651\uff0c\u53c8\u51fa\u73b0\u4e86\u201c\u6700\u4f73\u5b9e\u8df5\u201d\u6d41\u6570\u636e\u5305\uff1aTCP\u3002TCP\u7684\u6807\u51c6\u5316\u4f7f\u5f97\u4e00\u4ee3\u7a0b\u5e8f\u5458\u6446\u8131\u4e86\u6ed1\u52a8\u7a97\u53e3\uff0c\u91cd\u8bd5\u548c\u62e5\u585e\u5d29\u6e83\u7684\u5b9e\u73b0\u3002</p> <p>\u63a5\u7740\uff0c\u8bb8\u591a\u8bf7\u6c42/\u54cd\u5e94\u5728TCP\u534f\u8bae\u4e4b\u4e0a\u8fd0\u884c\uff0c\u5176\u4e2d\u8bb8\u591a\u6700\u7ec8\u8fc1\u79fb\u5230HTTP\uff08\u6216HTTP/2\u6216gRPC\uff09\u3002HTTP\u534f\u8bae\u4e0d\u4ec5\u4ec5\u7528\u4e8e\u57fa\u4e8e\u6d4f\u89c8\u5668\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd8\u6709\u50cfMongo\u8fd9\u6837\u7684\u6570\u636e\u5e93\u4e5f\u63d0\u4f9bHTTP\u63a5\u53e3\uff0c\u6781\u5927\u7684\u63d0\u5347\u4e86\u5f00\u53d1\u7684\u4fbf\u5229\u6027\u548c\u6807\u51c6\u5316\u3002</p> <p>\u800c\u5fae\u670d\u52a1\u7684\u901a\u4fe1\u6a21\u5f0f\u4e2d\u7684 API \u548c\u76f8\u5173\u5b9e\u73b0\u5f62\u6210\u4e86\u65b0\u7684\u901a\u4fe1\u5c42\uff0c\u670d\u52a1\u7f51\u683c\uff08ServiceMesh\uff09\u53ef\u4ee5\u89c6\u4f5c\u8fd9\u4e9b\u65b0\u8981\u7d20\u7684\u96c6\u5927\u6210\u8005\u3002</p> <p>\u901a\u8baf\u5c42\u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u6709\u4ee5\u4e0b\u9009\u62e9\uff1a</p> <ul> <li>\u7528\u5e93\u7684\u5f62\u5f0f\u5728\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5bfc\u5165\u4f7f\u7528\u3002</li> <li>\u7528\u8282\u70b9\u4ee3\u7406\u6216\u5b88\u62a4\u7a0b\u5e8f\u7684\u5f62\u5f0f\u4e3a\u7279\u5b9a\u8282\u70b9/\u8ba1\u7b97\u673a\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u63d0\u4f9b\u670d\u52a1\u3002</li> <li>\u7528Sidecar\u5bb9\u5668\u7684\u5f62\u5f0f\u8fd0\u884c\uff0c\u548c\u5e94\u7528\u5bb9\u5668\u4e00\u540c\u8fd0\u884c\u3002</li> </ul> <p>\u670d\u52a1\u7f51\u683c\u5b9e\u73b0\u65b9\u5f0f</p> <ul> <li>lib\u6a21\u5f0f</li> </ul> <p> </p> <p>\u4f7f\u7528\u5ba2\u6237\u7aef\u5e93\u6709\u4e24\u4e2a\u597d\u5904\uff1a\u6bcf\u9879\u670d\u52a1\u90fd\u4f7f\u7528\u672c\u5730\u8d44\u6e90\uff0c\u5e76\u4e14\u5f00\u53d1\u4eba\u5458\u6709\u6743\u81ea\u884c\u9009\u62e9\u73b0\u6709\u5e93\u6216\u8005\u6784\u5efa\u65b0\u7684\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u5e93\u3002</p> <p>\u800c\u5176\u6700\u5927\u7684\u7f3a\u70b9\u662f\u57fa\u7840\u8bbe\u65bd\u4e0e\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u7d27\u5bc6\u8026\u5408\u5728\u4e00\u8d77\uff0c\u5ba2\u6237\u7aef\u5e93\u7684\u4e0d\u7edf\u4e00\uff0c\u7279\u5b9a\u8bed\u8a00\u7684\u8bbe\u8ba1\u4f7f\u5f97\u4ed6\u4eec\u7684\u529f\u80fd\u548c\u884c\u4e3a\u65e0\u6cd5\u4fdd\u6301\u4e00\u81f4\u3002\u5927\u89c4\u6a21\u91c7\u7528\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u5f39\u6027\u5e93\u7684\u4ee3\u4ef7\u5f88\u9ad8\uff0c\u4e00\u822c\u662f\u5f88\u96be\u5d4c\u5165\u672a\u5f00\u53d1\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u6216\u8005\u5b8c\u5168\u4e0d\u80fd\u5408\u5e76\u5230\u73b0\u6709\u7684\u67b6\u6784\u4e2d\u3002\u5e76\u4e14\u5728\u5927\u578b\u73af\u5883\u4e2d\uff0c\u534f\u8c03\u5347\u7ea7\u5ba2\u6237\u7aef\u5e93\u4e5f\u662f\u5f88\u56f0\u96be\u7684\u3002</p> <p>\u5982\u4f55\u5728\u4e3a\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5b9e\u4f8b\u4f7f\u7528\u670d\u52a1\u4ee3\u7406\uff0c\u5e94\u7528\u7a0b\u5e8f\u4e0d\u518d\u9700\u8981\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u5f39\u6027\u5e93\u6765\u5904\u7406\u7194\u65ad\uff0c\u8d85\u65f6\uff0c\u91cd\u8bd5\uff0c\u670d\u52a1\u53d1\u73b0\uff0c\u8d1f\u8f7d\u5747\u8861\u7b49\u3002\u5176\u4e2dKubernetes\u4f7f\u7528\u8282\u70b9\u4ee3\u7406proxy\u7684\u6a21\u5f0f\uff0cistio\u4f7f\u7528Sidecar\u6ce8\u5165\u7684\u6a21\u5f0f\u3002</p> <ul> <li>proxy \u6a21\u5f0f</li> </ul> <p> </p> <p>\u5728\u6b64\u67b6\u6784\u4e2d\uff0c\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u8fd0\u884c\u4e00\u4e2a\u5355\u72ec\u7684\u4ee3\u7406\uff08\u901a\u5e38\u662f\u7528\u6237\u8fdb\u7a0b\uff09\uff0c\u4e3a\u5f02\u6784\u7684\u670d\u52a1\u63d0\u4f9b\u8d1f\u8f7d\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u8be5\u6a21\u578b\u4e0e\u5e93\u6a21\u578b\u76f8\u53cd\uff1a\u5b83\u4e0d\u5173\u5fc3\u5e94\u7528\u7a0b\u5e8f\u7684\u8bed\u8a00\uff0c\u53ef\u4ee5\u4e3a\u8bb8\u591a\u4e0d\u540c\u7684\u5fae\u670d\u52a1\u79df\u6237\u63d0\u4f9b\u670d\u52a1\u3002\u4f8b\u5982\uff0cKubernetes\u9ed8\u8ba4\u7684kube-proxy\u4ee3\u7406\u3002</p> <p>\u4f18\u70b9</p> <ul> <li>\u901a\u8fc7\u8282\u70b9\u5171\u4eab\u5f00\u9500\uff08\u5c24\u5176\u662f\u5185\u5b58\uff09</li> <li>\u66f4\u5c11\u3001\u66f4\u5bb9\u6613\u6269\u5c55\u548c\u5206\u53d1\u914d\u7f6e\u4fe1\u606f</li> </ul> <p>\u7f3a\u70b9</p> <ul> <li> <p>\u5bf9\u5171\u4eab\u8d44\u6e90\u7684\u7ba1\u7406\u590d\u6742\uff0c\u6613\u51fa\u73b0\u5355\u70b9\u6545\u969c</p> </li> <li> <p>Sidecar\u6a21\u5f0f</p> </li> </ul> <p> </p> <p>\u5728Sidecar\u6a21\u5f0f\u4e0b\uff0c\u589e\u52a0\u670d\u52a1\u4ee3\u7406\u8981\u505a\u4e24\u4e2a\u4e8b\u60c5\uff1aSidecar\u6ce8\u5165\u548c\u7f51\u7edc\u6d41\u91cf\u6355\u83b7\u3002Sidecar\u6ce8\u5165\u662f\u5c06\u4e00\u4e2a\u4ee3\u7406\u6dfb\u52a0\u5230\u4e00\u4e2a\u7ed9\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u65b9\u6cd5\uff0c\u800c\u7f51\u7edc\u6d41\u91cf\u7684\u6355\u83b7\u5219\u662f\u4e00\u79cd\u5c06\u5165\u7ad9\u6d41\u91cf\u5b9a\u5411\u5230\u4ee3\u7406\u5e76\u5c06\u51fa\u7ad9\u6d41\u91cf\u4e5f\u5b9a\u5411\u5230\u4ee3\u7406\u7684\u65b9\u6cd5\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#9istio","title":"9\u3001\u4e3a\u4ec0\u4e48\u9700\u8981istio\uff1f","text":"<p>\u6211\u4eec\u5df2\u7ecf\u6709\u4e86\u5bb9\u5668\u7684\u534f\u8c03\u5668\uff0c\u4f8b\u5982Kubernetes\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981\u53e6\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u5462\uff1f\u968f\u7740\u5fae\u670d\u52a1\u548c\u5bb9\u5668\u6210\u4e3a\u4e3b\u6d41\uff0c\u5bb9\u5668\u534f\u8c03\u5668\u63d0\u4f9b\u4e86\u96c6\u7fa4\uff08\u8282\u70b9\u548c\u5bb9\u5668\uff09\u6240\u9700\u7684\u5927\u90e8\u5206\u7684\u529f\u80fd\uff0c\u8fd9\u4e9b\u529f\u80fd\u4e3b\u8981\u662f\u96c6\u4e2d\u5728\u57fa\u7840\u8bbe\u65bd\u7ea7\u522b\u7684\u8c03\u5ea6\uff0c\u53d1\u73b0\u548c\u5065\u5eb7\u72b6\u51b5\uff0c\u800c\u7f3a\u5c11\u5fae\u670d\u52a1\u6240\u9700\u7684\u670d\u52a1\u7ea7\u522b\u7684\u529f\u80fd\u3002istio\u662f\u4e13\u7528\u4e8e\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u53d8\u5f97\u66f4\u52a0\u5b89\u5168\uff0c\u5feb\u901f\uff0c\u9ad8\u6548\u7684\u57fa\u7840\u8bbe\u65bd\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#10sidecar","title":"10\u3001Sidecar \u6ce8\u5165\u53ca\u6d41\u91cf\u52ab\u6301\u6b65\u9aa4\u6982\u8ff0","text":"<p>istio sidecar\u6ce8\u5165\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u4e3a\u624b\u52a8\u6ce8\u5165\uff0c\u81ea\u52a8\u6ce8\u5165\u3002</p> <p>\u4e0b\u9762\u662f\u4ece Sidecar \u6ce8\u5165\u3001Pod \u542f\u52a8\u5230 Sidecar proxy \u62e6\u622a\u6d41\u91cf\u53ca Envoy \u5904\u7406\u8def\u7531\u7684\u6b65\u9aa4\u6982\u89c8\u3002</p> <ul> <li>Kubernetes \u901a\u8fc7 Admission Controller \u81ea\u52a8\u6ce8\u5165\uff0c\u6216\u8005\u7528\u6237\u4f7f\u7528 istioctl \u547d\u4ee4\u624b\u52a8\u6ce8\u5165 sidecar \u5bb9\u5668\u3002</li> <li>\u5e94\u7528 YAML \u914d\u7f6e\u90e8\u7f72\u5e94\u7528\uff0c\u6b64\u65f6 Kubernetes API server \u63a5\u6536\u5230\u7684\u670d\u52a1\u521b\u5efa\u914d\u7f6e\u6587\u4ef6\u4e2d\u5df2\u7ecf\u5305\u542b\u4e86 Init \u5bb9\u5668\u53ca sidecar proxy</li> <li>\u5728 sidecar proxy \u5bb9\u5668\u548c\u5e94\u7528\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\uff0c\u9996\u5148\u8fd0\u884cinit-container\uff0cinit-container\u7528\u4e8e\u8bbe\u7f6e iptables\uff08Istio \u4e2d\u9ed8\u8ba4\u7684\u6d41\u91cf\u62e6\u622a\u65b9\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528 BPF\u3001IPVS \u7b49\u65b9\u5f0f\uff09 \u5c06\u8fdb\u5165 pod \u7684\u6d41\u91cf\u52ab\u6301\u5230 Envoy sidecar proxy\u3002\u6240\u6709 TCP \u6d41\u91cf\uff08Envoy \u76ee\u524d\u53ea\u652f\u6301 TCP \u6d41\u91cf\uff09\u5c06\u88ab sidecar \u52ab\u6301\uff0c\u5176\u4ed6\u534f\u8bae\u7684\u6d41\u91cf\u5c06\u6309\u539f\u6765\u7684\u76ee\u7684\u5730\u8bf7\u6c42\u3002</li> <li>\u542f\u52a8 Pod \u4e2d\u7684 Envoy sidecar proxy \u548c\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u3002</li> <li>\u4e0d\u8bba\u662f\u8fdb\u5165\u8fd8\u662f\u4ece Pod \u53d1\u51fa\u7684 TCP \u8bf7\u6c42\u90fd\u4f1a\u88ab iptables \u52ab\u6301\uff0cinbound \u6d41\u91cf\u88ab\u52ab\u6301\u540e\u7ecf Inbound Handler \u5904\u7406\u540e\u8f6c\u4ea4\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u5904\u7406\uff0coutbound \u6d41\u91cf\u88ab iptables \u52ab\u6301\u540e\u8f6c\u4ea4\u7ed9 Outbound Handler \u5904\u7406\uff0c\u5e76\u786e\u5b9a\u8f6c\u53d1\u7684 upstream \u548c Endpoint\u3002</li> <li>Sidecar proxy \u8bf7\u6c42 Pilot \u4f7f\u7528 xDS \u534f\u8bae\u540c\u6b65 Envoy \u914d\u7f6e\uff0c\u5176\u4e2d\u5305\u62ec LDS\u3001EDS\u3001CDS \u7b49\uff0c\u4e0d\u8fc7\u4e3a\u4e86\u4fdd\u8bc1\u66f4\u65b0\u7684\u987a\u5e8f\uff0cEnvoy \u4f1a\u76f4\u63a5\u4f7f\u7528 ADS \u5411 Pilot \u8bf7\u6c42\u914d\u7f6e\u66f4\u65b0\u3002</li> </ul>"},{"location":"chap9/1Istio_intro_ppt/#11envoy","title":"11\u3001Envoy","text":"<p>Envoy \u67b6\u6784</p> <p> </p> <ul> <li>Downstream/\u4e0b\u6e38\uff1a\u4e0b\u6e38\u4e3b\u673a\u8fde\u63a5\u5230 Envoy\uff0c\u53d1\u9001\u8bf7\u6c42\u5e76\u63a5\u6536\u54cd\u5e94\u3002</li> <li>Upstream/\u4e0a\u6e38\uff1a\u4e0a\u6e38\u4e3b\u673a\u63a5\u6536\u6765\u81ea Envoy \u7684\u8fde\u63a5\u548c\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u54cd\u5e94\u3002</li> <li>Listener/\u76d1\u542c\u5668\uff1a\u76d1\u542c\u5668\u662f\u547d\u540d\u7f51\u5730\u5740\uff08\u4f8b\u5982\uff0c\u7aef\u53e3\u3001unix domain socket\u7b49)\uff0c\u53ef\u4ee5\u88ab\u4e0b\u6e38\u5ba2\u6237\u7aef\u8fde\u63a5\u3002Envoy \u66b4\u9732\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u76d1\u542c\u5668\u7ed9\u4e0b\u6e38\u4e3b\u673a\u8fde\u63a5</li> <li>Cluster/\u96c6\u7fa4\uff1a\u96c6\u7fa4\u662f\u6307 Envoy \u8fde\u63a5\u5230\u7684\u903b\u8f91\u4e0a\u76f8\u540c\u7684\u4e00\u7ec4\u4e0a\u6e38\u4e3b\u673a\u3002Envoy \u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u6765\u53d1\u73b0\u96c6\u7fa4\u7684\u6210\u5458\u3002\u53ef\u4ee5\u9009\u62e9\u901a\u8fc7\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6765\u786e\u5b9a\u96c6\u7fa4\u6210\u5458\u7684\u5065\u5eb7\u72b6\u6001\u3002Envoy \u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u51b3\u5b9a\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u54ea\u4e2a\u96c6\u7fa4\u6210\u5458\u3002</li> </ul>"},{"location":"chap9/1Istio_intro_ppt/#12envoyistio","title":"12\u3001Envoy\u5728istio\u7684\u5de5\u4f5c\u539f\u7406","text":"<p>Listener\u662f\u4e00\u4e2a\u53ef\u4ee5\u63a5\u6536\u4e0b\u6e38\u5ba2\u6237\u7aef\u8fde\u63a5\u7684\u6307\u5b9a\u7684\u7f51\u7edc\u4f4d\u7f6e\uff08\u4f8b\u5982\uff0c\u7aef\u53e3\uff0cunix\u57df\u5957\u63a5\u5b57\u7b49\uff09\u3002Envoy\u516c\u5f00\u4e00\u4e2a\u6216\u591a\u4e2aListener\uff0c\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\u662f\u5bf9\u5916\u5f00\u653e\u7aef\u53e3\uff0c\u5916\u90e8\u5ba2\u6237\u53ef\u4ee5\u4f7f\u7528\u8be5\u7aef\u53e3\u5efa\u7acb\u8fde\u63a5\u3002\u53ef\u4ee5\u9009\u62e9\u4e3aListener\u914d\u7f6e\u4e00\u7cfb\u5217\u7684\u7684\u76d1\u542c\u5668\u8fc7\u6ee4\u5668Listener Filter\uff0c\u7528\u4e8e\u64cd\u4f5c\u8fde\u63a5\u5143\u6570\u636e\uff0c\u5728\u4e0d\u5bf9\u6838\u5fc3\u8fdb\u884c\u53d8\u66f4\u7684\u60c5\u51b5\u4e0b\u63d0\u4f9b\u66f4\u597d\u7684\u7cfb\u7edf\u96c6\u6210\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528\u9759\u6001\u914d\u7f6e\u6587\u4ef6\u6216\u8005\u901a\u8fc7API\u52a8\u6001\u914d\u7f6e\u8bbe\u7f6e\u76d1\u542c\u5668\uff08Listerens\uff09\uff0c\u8def\u7531\uff08routes\uff09\uff0c\u96c6\u7fa4\uff08clusters\uff09\uff0c\u7aef\u70b9\uff08endpoints\uff09\uff0c\u8fd9\u4e9bAPI\u5305\u62ec\u76d1\u542c\u5668\u53d1\u73b0\u670d\u52a1\uff08LDS\uff09\uff0c\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff08RDS\uff09\uff0c\u96c6\u7fa4\u53d1\u73b0\u670d\u52a1\uff08CDS\uff09\uff0c\u7aef\u70b9\u53d1\u73b0\u670d\u52a1\uff08EDS\uff09\uff0c\u8fd9\u4e9b\u670d\u52a1\u53d1\u73b0\u7684\u96c6\u5408\u79f0\u4e3axDS\u3002</p>"},{"location":"chap9/1Istio_intro_ppt/#13istiod","title":"13\u3001Istiod","text":"<p>\u6ce8\uff1aistio\u7684\u7f51\u7edc\u67b6\u6784\u6709\u591a\u6b21\u5927\u7684\u6f14\u8fdb\uff0c\u76ee\u524d\u7248\u672cv1.8\u662f\u5982\u4e0b\u7684\u67b6\u6784\u6a21\u5f0f\u3002\u67b6\u6784\u6f14\u8fdb\u7684\u76ee\u7684\u53ef\u4ee5\u53c2\u8003\u4e0b\u6587\u7684\u6587\u732e(\u4ecb\u7ecd istiod\uff1a\u7b80\u5316\u63a7\u5236\u5e73\u9762)\u3002</p> <p>\u672c\u7ae0\u8282\u4e3b\u8981\u4ecb\u7ecdpilot\u7684\u5b9e\u73b0\u3002</p> <p> </p> <p>Pilot\u8d1f\u8d23\u5bf9istio\u4e2d\u90e8\u7f72\u7684\u6570\u636e\u5e73\u9762\u3001\u5165\u53e3\u7f51\u5173\u3001\u51fa\u53e3\u7f51\u5173\u3001\u4ee5\u53ca\u670d\u52a1\u4ee3\u7406\u8fdb\u884c\u7f16\u7a0b\u3002\u4e3b\u8981\u662f\u5982\u4e0b3\u4e2a\u914d\u7f6e\uff0c</p> <ul> <li>\u7f51\u683c\u914d\u7f6e\uff1a\u670d\u52a1\u7f51\u683c\u7684\u4e00\u7ec4\u5168\u5c40\u914d\u7f6e</li> <li>\u7f51\u7edc\u914d\u7f6e\uff1aserviceEntry\u3001DestinationRule\u3001VirtualService\u3001Gateway\u548c\u670d\u52a1\u4ee3\u7406\u7684\u914d\u7f6e</li> <li>\u670d\u52a1\u53d1\u73b0\uff1a\u6765\u81ea\u6ce8\u518c\u8868\u7684\u6709\u5173\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u5e95\u5c42\u5e73\u53f0\u4e2d\u7684\u670d\u52a1\u76ee\u5f55\u7684\u4f4d\u7f6e\u548c\u5143\u6570\u636e\u4fe1\u606f\u3002</li> </ul> <p> </p> <p>Pilot\u6839\u636e\u7f51\u683c\u914d\u7f6e\u3001\u7f51\u7edc\u914d\u7f6e\u3001\u670d\u52a1\u53d1\u73b0\u8fd9\u4e09\u4e2a\u914d\u7f6e\u521b\u5efa\u8d44\u6e90\u548c\u90e8\u7f72\u72b6\u7684\u6a21\u578b\u3002\u5f53\u670d\u52a1\u4ee3\u7406\u5f02\u6b65\u5730\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\uff0c\u4ed6\u4eec\u5c06\u8fde\u63a5\u5230Pilot\u3002Pilot\u6839\u636e\u6807\u7b7e\u548c\u670d\u52a1\u4ee3\u7406\u9644\u5c5e\u7684\u670d\u52a1\u5c06\u670d\u52a1\u4ee3\u7406\u8fdb\u884c\u5206\u7ec4\u3002Pilot\u4f7f\u7528\u8fd9\u4e2a\u6a21\u578b\u4e3a\u6bcf\u7ec4\u8fde\u63a5\u7684\u670d\u52a1\u4ee3\u7406\uff0c\u751f\u6210\u53d1\u73b0\u670d\u52a1\uff08xDS\uff09\u54cd\u5e94\uff0c\u5f53\u670d\u52a1\u4ee3\u7406\u8fde\u63a5\u540e\uff0cPilot\u53d1\u9001\u73af\u5883\u7684\u5f53\u524d\u7684\u72b6\u6001\u548c\u914d\u7f6e\u3002\u5982\u679c\u57fa\u7840\u5e73\u53f0\u7684\u72b6\u6001\u53d8\u5316\u65f6\uff0c\u6a21\u578b\u4f1a\u4ee5\u4e00\u5b9a\u7684\u9891\u7387\u8fdb\u884c\u66f4\u65b0\uff0c\u66f4\u65b0\u6a21\u578b\u9700\u8981\u66f4\u65b0\u5f53\u524d\u7684xDS\u7684\u914d\u7f6e\u96c6\uff0c\u5f53xDS\u914d\u7f6e\u6539\u53d8\u540e\uff0cPilot\u4f1a\u8ba1\u7b97\u53d7\u5f71\u54cd\u7684\u670d\u52a1\u4ee3\u7406\u7ec4\uff0c\u5e76\u5c06\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u63a8\u9001\u7ed9\u4ed6\u4eec\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/","title":"\u7b2c\u4e94\u8282 Istio \u5e38\u89c1\u7684 10 \u4e2a\u5f02\u5e38\u5206\u6790","text":""},{"location":"chap9/24Istio_troubleshoot/#1service","title":"1\u3001Service \u7aef\u53e3\u547d\u540d\u7ea6\u675f","text":"<p>Istio \u652f\u6301\u591a\u5e73\u53f0\uff0c\u4e0d\u8fc7 Istio \u548c Kubernetes \u7684\u517c\u5bb9\u6027\u662f\u6700\u4f18\u7684\uff0c\u4e0d\u7ba1\u662f\u8bbe\u8ba1\u7406\u5ff5\uff0c\u6838\u5fc3\u56e2\u961f\u8fd8\u662f\u793e\u533a\uff0c \u90fd\u6709\u4e00\u8109\u76f8\u627f\u7684\u610f\u601d\u3002</p> <p>\u4f46  <code>Istio</code> \u548c <code>Kubernetes</code>\u7684\u9002\u914d\u5e76\u975e\u5b8c\u5168\u6ca1\u6709\u51b2\u7a81\uff0c\u4e00\u4e2a\u5178\u578b\u95ee\u9898\u5c31\u662f <code>Istio</code> \u9700\u8981 <code>Kubernetes Service</code> \u6309\u7167\u534f\u8bae\u8fdb\u884c\u7aef\u53e3\u547d\u540d\uff08<code>Port Naming</code>\uff09\u3002</p> <p>\u7aef\u53e3\u547d\u540d\u4e0d\u6ee1\u8db3\u7ea6\u675f\u800c\u5bfc\u81f4\u7684\u6d41\u91cf\u5f02\u5e38\uff0c\u662f\u4f7f\u7528 <code>Mesh</code> \u8fc7\u7a0b\u4e2d\u6700\u5e38\u89c1\u7684\u95ee\u9898\uff0c\u5176\u73b0\u8c61\u662f\u534f\u8bae\u76f8\u5173\u7684\u6d41\u63a7\u89c4\u5219\u4e0d\u751f\u6548\uff0c\u8fd9\u901a\u5e38\u53ef\u4ee5\u901a\u8fc7\u68c0\u67e5\u8be5 <code>Port LDS</code> \u4e2d <code>filter</code> \u7684\u7c7b\u578b\u6765\u5b9a\u4f4d\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#1-1","title":"1-1 \u539f\u56e0","text":"<p><code>Kubernetes</code> \u7684\u7f51\u7edc\u5bf9\u5e94\u7528\u5c42\u662f\u65e0\u611f\u77e5\u7684\uff0c<code>Kubernetes</code> \u7684\u4e3b\u8981\u6d41\u91cf\u8f6c\u53d1\u903b\u8f91\u53d1\u751f\u5728 <code>Node</code> \u4e0a\uff0c\u7531 <code>iptables/IPVS</code> \u6765\u5b9e\u73b0\uff0c\u8fd9\u4e9b\u89c4\u5219\u5e76\u4e0d\u5173\u5fc3\u5e94\u7528\u5c42\u91cc\u662f\u4ec0\u4e48\u534f\u8bae\u3002</p> <p><code>Istio</code> \u7684\u6838\u5fc3\u80fd\u529b\u662f\u5bf9 <code>7</code>\u5c42\u6d41\u91cf\u8fdb\u884c\u7ba1\u63a7\uff0c\u4f46\u524d\u63d0\u6761\u4ef6\u662f <code>Istio</code> \u5fc5\u987b\u77e5\u9053\u6bcf\u4e2a\u53d7\u7ba1\u63a7\u7684\u670d\u52a1\u662f\u4ec0\u4e48\u534f\u8bae\uff0c<code>Istio</code> \u4f1a\u6839\u636e\u7aef\u53e3\u534f\u8bae\u7684\u4e0d\u540c\uff0c\u4e0b\u53d1\u4e0d\u540c\u7684\u6d41\u63a7\u529f\u80fd\uff08<code>Envoy filter</code>\uff09\uff0c\u800c <code>Kubernetes</code>\u8d44\u6e90\u5b9a\u4e49\u91cc\u5e76\u4e0d\u5305\u62ec\u4e03\u5c42\u534f\u8bae\u4fe1\u606f\uff0c\u6240\u4ee5 <code>Istio</code> \u9700\u8981\u7528\u6237\u663e\u5f0f\u63d0\u4f9b\u3002</p> <p></p> <p>Istio \u7684\u89e3\u51b3\u65b9\u6848\uff1aProtocol Sniffing</p> <p>\u534f\u8bae\u55c5\u63a2\u6982\u8981\uff1a</p> <ul> <li>\u68c0\u6d4b <code>TLS CLIENT_HELLO</code> \u63d0\u53d6 SNI\u3001ALPN\u3001NPN \u7b49\u4fe1\u606f</li> <li>\u57fa\u4e8e\u5e38\u89c1\u534f\u8bae\u7684\u5df2\u77e5\u5178\u578b\u7ed3\u6784\uff0c\u5c1d\u8bd5\u68c0\u6d4b\u5e94\u7528\u5c42 <code>Plaintext</code> \u5185\u5bb9\uff1a<ul> <li>\u57fa\u4e8e<code>HTTP2 spec: Connection Preface</code>\uff0c\u5224\u65ad\u662f\u5426\u4e3a <code>HTTP/2</code></li> <li>\u57fa\u4e8e <code>HTTP header</code> \u7ed3\u6784\uff0c\u5224\u65ad\u662f\u5426\u662f <code>HTTP/1.x</code></li> </ul> </li> <li>\u8fc7\u7a0b\u4e2d\u4f1a\u8bbe\u7f6e\u8d85\u65f6\u63a7\u5236\u548c\u68c0\u6d4b\u5305\u5927\u5c0f\u9650\u5236\uff0c \u9ed8\u8ba4\u6309\u7167\u534f\u8bae <code>TCP</code> \u5904\u7406</li> </ul>"},{"location":"chap9/24Istio_troubleshoot/#1-2","title":"1-2 \u6700\u4f73\u5b9e\u8df5","text":"<p><code>Protocol Sniffing</code>\u51cf\u5c11\u4e86\u65b0\u624b\u4f7f\u7528 <code>Istio</code> \u6240\u9700\u7684\u914d\u7f6e\uff0c\u4f46\u662f\u53ef\u80fd\u4f1a\u5e26\u6765\u4e0d\u786e\u5b9a\u7684\u884c\u4e3a\u3002\u4e0d\u786e\u5b9a\u7684\u884c\u4e3a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u662f\u5e94\u8be5\u5c3d\u91cf\u907f\u514d\u7684\u3002</p> <p>\u4e00\u4e9b\u55c5\u63a2\u5931\u6548\u7684\u4f8b\u5b50\uff1a</p> <ul> <li>\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4f7f\u7528\u7740\u67d0\u7c7b\u975e\u6807\u51c6\u7684\u4e03\u5c42\u534f\u8bae\uff0c\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u53ef\u4ee5\u6b63\u786e\u89e3\u6790\uff0c\u4f46\u662f\u4e0d\u80fd\u786e\u4fdd Istio \u81ea\u52a8\u55c5\u63a2\u903b\u8f91\u8ba4\u53ef\u8fd9\u7c7b\u975e\u6807\u51c6\u534f\u8bae\u3002\u6bd4\u5982\u5bf9\u4e8e <code>HTTP</code> \u534f\u8bae\uff0c\u6807\u51c6\u7684\u6362\u884c\u5206\u9694\u662f\u7528 <code>CRLF \uff080x0d 0x0a</code>, \u4f46\u662f\u5927\u90e8\u5206 <code>HTTP</code> \u7c7b\u5e93\u4f1a\u4f7f\u7528\u5e76\u8ba4\u53ef <code>LF\uff080x0a\uff09</code>\u4f5c\u4e3a\u5206\u9694\u3002</li> <li>\u67d0\u4e9b\u81ea\u5b9a\u4e49\u79c1\u6709\u534f\u8bae\uff0c\u6570\u636e\u6d41\u7684\u8d77\u59cb\u683c\u5f0f\u548c HTTP \u62a5\u6587\u683c\u5f0f\u7c7b\u4f3c\uff0c\u4f46\u662f\u540e\u7eed\u6570\u636e\u6d41\u662f\u81ea\u5b9a\u4e49\u683c\u5f0f\uff1a<ul> <li>\u672a\u5f00\u542f\u55c5\u63a2\u65f6\uff1a\u6570\u636e\u6d41\u6309\u7167 <code>L4 TCP</code> \u8fdb\u884c\u8def\u7531\uff0c\u7b26\u5408\u7528\u6237\u671f\u671b</li> <li>\u5982\u679c\u5f00\u542f\u55c5\u63a2\uff1a\u6570\u636e\u6d41\u6700\u5f00\u59cb\u4f1a\u88ab\u8ba4\u5b9a\u4e3a<code>L7 http</code> \u534f\u8bae\uff0c\u4f46\u662f\u540e\u7eed\u6570\u636e\u4e0d\u7b26\u5408 <code>HTTP</code> \u683c\u5f0f\uff0c\u6d41\u91cf\u5c06\u88ab\u4e2d\u65ad</li> </ul> </li> </ul> <p>\u5efa\u8bae\u751f\u4ea7\u73af\u5883\u4e0d\u4f7f\u7528\u534f\u8bae\u55c5\u63a2\uff0c\u63a5\u5165 <code>Mesh</code> \u7684 <code>Service</code> \u5e94\u8be5\u6309\u7167\u7ea6\u5b9a\u4f7f\u7528\u534f\u8bae\u524d\u7f00\u8fdb\u884c\u547d\u540d\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#2","title":"2\u3001\u6d41\u63a7\u89c4\u5219\u4e0b\u53d1\u987a\u5e8f\u95ee\u9898","text":""},{"location":"chap9/24Istio_troubleshoot/#2-1","title":"2-1 \u5f02\u5e38\u63cf\u8ff0","text":"<p>\u5728\u6279\u91cf\u66f4\u65b0\u6d41\u91cf\u89c4\u5219\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5076\u5c14\u4f1a\u51fa\u73b0\u6d41\u91cf\u5f02\u5e38\uff08<code>503</code>\uff09\uff0c<code>Envoy</code> \u65e5\u5fd7\u4e2d <code>RESPONSE_FLAGS</code> \u5305\u542b<code>\u300cNR\u300d</code>\u6807\u5fd7\uff08<code>No route configured</code>\uff09\uff0c\u6301\u7eed\u65f6\u95f4\u4e0d\u957f\uff0c\u4f1a\u81ea\u52a8\u6062\u590d\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#2-2","title":"2-2 \u539f\u56e0\u5206\u6790","text":"<p>\u5f53\u7528\u6237\u4f7f\u7528 <code>kubectl apply -f multiple-virtualservice-destinationrule.yaml</code> \u65f6</p> <p>\u8fd9\u4e9b\u5bf9\u8c61\u7684\u4f20\u64ad\u548c\u751f\u6548\u5148\u540e\u987a\u5e8f\u662f\u4e0d\u4fdd\u8bc1\u7684\uff0c\u6240\u8c13\u6700\u7ec8\u4e00\u81f4\u6027\uff0c\u6bd4\u5982 <code>VirtualService</code> \u4e2d\u5f15\u7528\u4e86\u67d0\u4e00\u4e2a <code>DestinationRule</code> \u5b9a\u4e49\u7684\u5b50\u7248\u672c\uff0c\u4f46\u662f\u8fd9\u4e2a <code>DestinationRule</code> \u8d44\u6e90\u7684\u4f20\u64ad\u548c\u751f\u6548\u53ef\u80fd\u5728\u65f6\u95f4\u4e0a\u843d\u540e\u4e8e\u8be5 <code>VirtualService</code> \u8d44\u6e90\u3002</p> <p></p> <p>\u6700\u4f73\u5b9e\u8df5\uff1aMake Before Break</p> <p>\u5c06\u66f4\u65b0\u8fc7\u7a0b\u4ece\u6279\u91cf\u5355\u6b65\u62c6\u5206\u4e3a\u591a\u6b65\u9aa4\uff0c\u786e\u4fdd\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u5f15\u7528\u4e0d\u5b58\u5728\u7684 subset\uff1a</p> <ul> <li>\u5f53\u65b0\u589e <code>DestinationRule subset</code> \u65f6\uff0c\u5e94\u8be5\u5148 <code>apply DestinationRule subset</code>\uff0c\u7b49\u5f85 <code>subset</code> \u751f\u6548\u540e\uff0c\u518d <code>apply</code>\u5f15\u7528\u4e86\u8be5 <code>subset</code> \u7684 <code>VirtualService</code>\u3002</li> <li>\u5f53\u5220\u9664 <code>DestinationRule subset</code> \u65f6\uff0c\u5e94\u8be5\u5148 \u5220\u9664 <code>VirtualService</code> \u4e2d\u5bf9\u8be5 <code>subset</code> \u7684\u5f15\u7528\uff0c\u7b49\u5f85 <code>VirtualService</code> \u7684\u4fee\u6539\u751f\u6548\u540e\uff0c\u5728\u6267\u884c\u5220\u9664 <code>DestinationRule subset</code>\u3002</li> </ul>"},{"location":"chap9/24Istio_troubleshoot/#3","title":"3. \u8bf7\u6c42\u4e2d\u65ad\u5206\u6790","text":"<p>\u8bf7\u6c42\u5f02\u5e38\uff0c\u5230\u5e95\u662f Istio \u6d41\u63a7\u89c4\u5219\u5bfc\u81f4\uff0c\u8fd8\u662f\u4e1a\u52a1\u5e94\u7528\u7684\u8fd4\u56de\uff0c\u6d41\u91cf\u65ad\u70b9\u51fa\u73b0\u5728\u54ea\u4e2a\u5177\u4f53\u7684 Pod\uff1f</p> <p>\u8fd9\u662f\u4f7f\u7528<code>Mesh</code> \u6700\u5e38\u89c1\u7684\u56f0\u5883\uff0c\u5728\u5fae\u670d\u52a1\u4e2d\u5f15\u5165 <code>Envoy</code>\u4f5c\u4e3a\u4ee3\u7406\u540e\uff0c\u5f53\u6d41\u91cf\u8bbf\u95ee\u548c\u9884\u671f\u884c\u4e3a\u4e0d\u7b26\u65f6\uff0c\u7528\u6237\u5f88\u96be\u5feb\u901f\u786e\u5b9a\u95ee\u9898\u662f\u51fa\u5728\u54ea\u4e2a\u73af\u8282\u3002\u5ba2\u6237\u7aef\u6536\u5230\u7684\u5f02\u5e38\u54cd\u5e94\uff0c\u8bf8\u5982 <code>403</code>\u3001<code>404</code>\u3001<code>503</code> \u6216\u8005\u8fde\u63a5\u4e2d\u65ad\u7b49\uff0c\u53ef\u80fd\u662f\u94fe\u8def\u4e2d\u4efb\u4e00 <code>Sidecar</code> \u6267\u884c\u6d41\u91cf\u7ba1\u63a7\u7684\u7ed3\u679c\uff0c \u4f46\u4e5f\u6709\u53ef\u80fd\u662f\u6765\u81ea\u67d0\u4e2a\u670d\u52a1\u7684\u5408\u7406\u903b\u8f91\u54cd\u5e94\u3002</p> <p>Envoy \u6d41\u91cf\u6a21\u578b</p> <p>Envoy \u63a5\u53d7\u8bf7\u6c42\u6d41\u91cf\u53eb\u505a <code>Downstream</code>\uff0c<code>Envoy</code> \u53d1\u51fa\u8bf7\u6c42\u6d41\u91cf\u53eb\u505a<code>Upstream</code>\u3002\u5728\u5904\u7406 <code>Downstream</code> \u548c <code>Upstream</code> \u8fc7\u7a0b\u4e2d\uff0c\u5206\u522b\u4f1a\u6d89\u53ca <code>2</code> \u4e2a\u6d41\u91cf\u7aef\u70b9\uff0c\u5373\u8bf7\u6c42\u7684\u53d1\u8d77\u7aef\u548c\u63a5\u6536\u7aef\uff1a</p> <p></p> <p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c<code>Envoy</code> \u4f1a\u6839\u636e\u7528\u6237\u89c4\u5219\uff0c\u8ba1\u7b97\u51fa\u7b26\u5408\u6761\u4ef6\u7684\u8f6c\u53d1\u76ee\u7684\u4e3b\u673a\u96c6\u5408\uff0c\u8fd9\u4e2a\u96c6\u5408\u53eb\u505a <code>UPSTREAM_CLUSTER</code>\uff0c\u5e76\u6839\u636e\u8d1f\u8f7d\u5747\u8861\u89c4\u5219\uff0c\u4ece\u8fd9\u4e2a\u96c6\u5408\u4e2d\u9009\u62e9\u4e00\u4e2a <code>host</code> \u4f5c\u4e3a\u6d41\u91cf\u8f6c\u53d1\u7684\u63a5\u6536\u7aef\u70b9\uff0c\u8fd9\u4e2a <code>host</code> \u5c31\u662f <code>UPSTREAM_HOST</code>\u3002</p> <p>\u4ee5\u4e0a\u5c31\u662f <code>Envoy</code> \u8bf7\u6c42\u5904\u7406\u7684\u6d41\u91cf\u4e94\u5143\u7ec4\u4fe1\u606f\uff0c \u8fd9\u662f <code>Envoy</code> \u65e5\u5fd7\u91cc\u6700\u91cd\u8981\u7684\u90e8\u5206\uff0c\u901a\u8fc7\u8fd9\u4e2a\u4e94\u5143\u7ec4\u6211\u4eec\u53ef\u4ee5\u51c6\u786e\u7684\u89c2\u6d4b\u6d41\u91cf\u300c\u4ece\u54ea\u91cc\u6765\u300d\u548c\u300c\u5230\u54ea\u91cc\u53bb\u300d\u3002</p> <ul> <li><code>UPSTREAM_CLUSTER</code></li> <li><code>DOWNSTREAM_REMOTE_ADDRESS</code></li> <li><code>DOWNSTREAM_LOCAL_ADDRESS</code></li> <li><code>UPSTREAM_LOCAL_ADDRESS</code></li> <li><code>UPSTREAM_HOST</code></li> </ul> <p>\u65e5\u5fd7\u5206\u6790\u793a\u4f8b</p> <p></p> <p>\u901a\u8fc7\u65e5\u5fd7\u91cd\u70b9\u89c2\u6d4b 2 \u4e2a\u4fe1\u606f\uff1a</p> <ul> <li> <p>\u65ad\u70b9\u662f\u5728\u54ea\u91cc \uff1f</p> </li> <li> <p>\u539f\u56e0\u662f\u4ec0\u4e48\uff1f</p> </li> </ul>"},{"location":"chap9/24Istio_troubleshoot/#client-server","title":"\u793a\u4f8b\u4e00\uff1a\u4e00\u6b21\u6b63\u5e38\u7684 <code>client-server</code> \u8bf7\u6c42\u3002","text":"<p>\u53ef\u4ee5\u770b\u5230 <code>2</code> \u7aef\u65e5\u5fd7\u5305\u542b\u76f8\u540c\u7684 <code>request ID</code>\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06\u6d41\u91cf\u5206\u6790\u4e32\u8054\u8d77\u6765\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#no-healthy-upstream-deployment-0","title":"\u793a\u4f8b\u4e8c\uff1a<code>no healthy upstream</code>\uff0c\u6bd4\u5982\u76ee\u6807 <code>deployment</code> \u5065\u5eb7\u526f\u672c\u6570\u4e3a <code>0</code>\u3002","text":"<p>\u65e5\u5fd7\u4e2d <code>flag\u300cUH\u300d</code>\u8868\u793a <code>upstream cluster</code> \u4e2d\u6ca1\u6709\u5065\u5eb7\u7684<code>host</code>\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#no-route-configured-destinationrule-subset","title":"\u793a\u4f8b\u4e09\uff1a<code>No route configured</code>\uff0c\u6bd4\u5982 <code>DestinationRule</code> \u7f3a\u4e4f\u5bf9\u5e94\u7684 <code>subset</code>","text":"<p>\u65e5\u5fd7\u4e2d <code>flag\u300cNR\u300d</code>\u8868\u793a\u627e\u4e0d\u5230\u8def\u7531\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#upstream-connection-failure","title":"\u793a\u4f8b\u56db\uff1a<code>Upstream connection failure</code>\uff0c\u6bd4\u5982\u670d\u52a1\u672a\u6b63\u5e38\u76d1\u542c\u7aef\u53e3\u3002","text":"<p>\u65e5\u5fd7\u4e2d <code>flag\u300cUF\u300d</code>\u8868\u793a <code>Upstream</code>\u8fde\u63a5\u5931\u8d25\uff0c\u636e\u6b64\u53ef\u4ee5\u5224\u65ad\u51fa\u6d41\u91cf\u65ad\u70b9\u4f4d\u7f6e\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#4-sidecar-user-container","title":"4\u3001 <code>Sidecar</code> \u548c <code>User Container</code> \u542f\u52a8\u987a\u5e8f","text":""},{"location":"chap9/24Istio_troubleshoot/#4-1","title":"** 4-1 \u5f02\u5e38\u63cf\u8ff0**","text":"<p><code>Sidecar</code> \u6a21\u5f0f\u5728 <code>Kubernetes</code> \u4e16\u754c\u5f88\u6d41\u884c\uff0c\u4f46\u5bf9\u76ee\u524d\u7684 <code>Kubernetes\uff08V1.17\uff09</code>\u6765\u8bf4\uff0c\u5e76\u6ca1\u6709 <code>Sidecar</code> \u7684\u6982\u5ff5\uff0c<code>Sidecar</code> \u5bb9\u5668\u7684\u89d2\u8272\u662f\u7528\u6237\u4e3b\u89c2\u8d4b\u4e88\u7684\u3002</p> <p>\u5bf9 <code>Istio</code>\u7528\u6237\u6765\u8bf4\uff0c\u4e00\u4e2a\u5e38\u89c1\u7684\u56f0\u6270\u662f\uff1a<code>Sidecar</code>\u548c\u7528\u6237\u5bb9\u5668\u7684\u542f\u52a8\u987a\u5e8f\uff1a</p> <p><code>Sidecar\uff08Envoy\uff09</code> \u548c\u7528\u6237\u5bb9\u5668\u7684\u542f\u52a8\u987a\u5e8f\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u5982\u679c\u7528\u6237\u5bb9\u5668\u5148\u542f\u52a8\u4e86\uff0c<code>Envoy</code> \u8fd8\u672a\u5b8c\u6210\u542f\u52a8\uff0c\u8fd9\u65f6\u5019\u7528\u6237\u5bb9\u5668\u5f80\u5916\u53d1\u9001\u8bf7\u6c42\uff0c\u8bf7\u6c42\u4ecd\u7136\u4f1a\u88ab\u62e6\u622a\uff0c\u53d1\u5f80\u672a\u542f\u52a8\u7684 <code>Envoy</code>\uff0c\u8bf7\u6c42\u5f02\u5e38\u3002</p> <p>\u5728 <code>Pod</code>\u7ec8\u6b62\u9636\u6bb5\uff0c\u4e5f\u4f1a\u6709\u7c7b\u4f3c\u7684\u5f02\u5e38\uff0c\u6839\u6e90\u4ecd\u7136\u662f <code>Sidecar</code>\u548c\u666e\u901a\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u7684\u4e0d\u786e\u5b9a\u6027\u3002</p> <p></p>"},{"location":"chap9/24Istio_troubleshoot/#4-2","title":"4-2 \u89e3\u51b3\u65b9\u6848","text":"<p>\u76ee\u524d\u5e38\u89c4\u7684\u89c4\u907f\u65b9\u6848\u4e3b\u8981\u662f\u6709\u8fd9\u6837\u51e0\u79cd\uff1a</p> <ul> <li>\u4e1a\u52a1\u5bb9\u5668\u5ef6\u8fdf\u51e0\u79d2\u542f\u52a8\uff0c\u6216\u8005\u5931\u8d25\u91cd\u8bd5</li> <li>\u542f\u52a8\u811a\u672c\u4e2d\u4e3b\u52a8\u63a2\u6d4b <code>Envoy</code> \u662f\u5426 <code>ready</code>\uff0c\u5982 <code>127.0.0.1:15020/healthz/ready</code></li> </ul> <p>\u65e0\u8bba\u54ea\u79cd\u65b9\u6848\u90fd\u663e\u5f97\u5f88\u8e69\u811a\uff0c\u4e3a\u4e86\u5f7b\u5e95\u89e3\u51b3\u4e0a\u8ff0\u75db\u70b9\uff0c\u4ece <code>Kubernetes 1.18</code> \u7248\u672c\u5f00\u59cb\uff0c<code>Kubernetes</code> \u5185\u7f6e\u7684 <code>Sidecar</code> \u529f\u80fd\u5c06\u786e\u4fdd <code>Sidecar</code> \u5728\u6b63\u5e38\u4e1a\u52a1\u6d41\u7a0b\u5f00\u59cb\u4e4b\u524d\u5c31\u542f\u52a8\u5e76\u8fd0\u884c\uff0c\u5373\u901a\u8fc7\u66f4\u6539 <code>Pod</code> \u7684\u542f\u52a8\u751f\u547d\u5468\u671f\uff0c\u5728<code>init</code> \u5bb9\u5668\u5b8c\u6210\u540e\u542f\u52a8 <code>Sidecar</code> \u5bb9\u5668\uff0c\u5728 <code>Sidecar</code> \u5bb9\u5668\u5c31\u7eea\u540e\u542f\u52a8\u4e1a\u52a1\u5bb9\u5668\uff0c\u4ece\u542f\u52a8\u6d41\u7a0b\u4e0a\u4fdd\u8bc1\u987a\u5e8f\u6027\u3002</p> <p><code>init</code> \u5bb9\u5668 =&gt;  <code>Sidecar</code> \u5bb9\u5668 =&gt; \u4e1a\u52a1\u5bb9\u5668</p> <p>\u800c Pod \u7ec8\u6b62\u9636\u6bb5\uff0c\u53ea\u6709\u5f53\u6240\u6709\u666e\u901a\u5bb9\u5668\u90fd\u5df2\u5230\u8fbe\u7ec8\u6b62\u72b6\u6001\uff08<code>Succeeded for restartPolicy=OnFailure</code> \u6216 <code>Succeeded/Failed for restartPolicy=Never</code>\uff09\uff0c\u624d\u4f1a\u5411 <code>Sidecar</code> \u5bb9\u5668\u53d1\u9001 <code>SIGTERM</code> \u4fe1\u53f7\u3002</p> <p></p>"},{"location":"chap9/24Istio_troubleshoot/#5-ingress-gateway-service","title":"5\u3001 Ingress Gateway \u548c Service \u7aef\u53e3\u8054\u52a8","text":"<p><code>Ingress Gateway</code> \u89c4\u5219\u4e0d\u751f\u6548\u7684\u4e00\u4e2a\u5e38\u89c1\u539f\u56e0\u662f\uff1a<code>Gateway</code> \u7684\u76d1\u542c\u7aef\u53e3\u5728\u5bf9\u5e94\u7684 <code>Kubernetes Service</code> \u4e0a\u6ca1\u6709\u5f00\u542f\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u7406\u89e3 <code>Istio Ingress Gateway</code> \u548c <code>Kubernetes Service</code> \u7684\u5173\u7cfb\uff1a</p> <p></p> <p>\u4e0a\u56fe\u4e2d\uff0c\u867d\u7136 <code>Gateway</code> \u5b9a\u4e49\u671f\u671b\u7ba1\u63a7\u7aef\u53e3 <code>b</code> \u548c <code>c</code>\uff0c\u4f46\u662f\u5b83\u5bf9\u5e94\u7684 <code>Service</code> \uff08\u901a\u8fc7\u817e\u8baf\u4e91 CLB\uff09\u53ea\u5f00\u542f\u4e86\u7aef\u53e3 <code>a</code> \u548c<code>b</code>\uff0c\u56e0\u6b64\u6700\u7ec8\u4ece <code>LB</code> \u7aef\u53e3 <code>b</code> \u8fdb\u6765\u7684\u6d41\u91cf\u624d\u80fd\u88ab <code>Istio Gateway</code>\u7ba1\u63a7\u3002</p> <ul> <li><code>Istio Gateway</code> \u548c <code>Kubernetes Service</code> \u6ca1\u6709\u76f4\u63a5\u7684\u5173\u8054\uff0c\u4e8c\u8005\u90fd\u662f\u901a\u8fc7 <code>selector</code> \u53bb\u7ed1\u5b9a <code>Pod</code>\uff0c\u5b9e\u73b0\u95f4\u63a5\u5173\u8054\u3002</li> <li><code>Istio CRD Gateway</code> \u53ea\u5b9e\u73b0\u4e86\u5c06\u7528\u6237\u6d41\u63a7\u89c4\u5219\u4e0b\u53d1\u5230\u7f51\u683c\u8fb9\u7f18\u8282\u70b9\uff0c\u6d41\u91cf\u4ecd\u9700\u8981\u901a\u8fc7<code>LB</code> \u63a7\u5236\u624d\u80fd\u8fdb\u5165\u7f51\u683c\u3002</li> <li>\u817e\u8baf\u4e91 <code>TKE Mesh</code> \u5b9e\u73b0\u4e86 <code>Gateway-Service</code> \u5b9a\u4e49\u4e2d\u7684 <code>Port</code>\u52a8\u6001\u8054\u52a8\uff0c\u8ba9\u7528\u6237\u805a\u7126\u5728\u7f51\u683c\u5185\u7684\u914d\u7f6e\u3002</li> </ul>"},{"location":"chap9/24Istio_troubleshoot/#6-virtualservice","title":"6\u3001 VirtualService \u4f5c\u7528\u57df","text":"<p><code>VirtualService</code> \u5305\u542b\u4e86\u5927\u90e8\u5206 <code>outbound</code>\u7aef\u7684\u6d41\u91cf\u89c4\u5219\uff0c\u5b83\u65e2\u53ef\u4ee5\u5e94\u7528\u5230\u7f51\u683c\u5185\u90e8\u6570\u636e\u9762\u4ee3\u7406\u4e2d\uff0c \u4e5f\u53ef\u4ee5\u5e94\u7528\u5230\u7f51\u683c\u8fb9\u7f18\u7684\u4ee3\u7406\u4e2d\u3002</p> <p><code>VirtualService</code> \u7684\u5c5e\u6027 <code>Gateways</code> \u7528\u4e8e\u6307\u5b9a <code>VirtualService</code> \u7684\u751f\u6548\u8303\u56f4\uff1a</p> <ul> <li>\u5982\u679c <code>VirtualService.gateways</code> \u4e3a\u7a7a\uff0c\u5219 <code>Istio</code> \u4e3a\u5176\u8d4b\u9ed8\u8ba4\u503c <code>Mesh</code>\uff0c\u4ee3\u8868\u751f\u6548\u8303\u56f4\u4e3a\u7f51\u683c\u5185\u90e8</li> <li>\u5982\u679c\u5e0c\u671b <code>VirtualService</code> \u5e94\u7528\u5230\u5177\u4f53\u8fb9\u7f18\u7f51\u5173\u4e0a\uff0c\u5219\u9700\u8981\u663e\u793a\u4e3a\u5176\u8d4b\u503c\uff1a<code>gateway-name1</code>\uff0c<code>gateway-name2</code></li> <li>\u5982\u679c\u5e0c\u671b <code>VirtualService</code> \u540c\u65f6\u5e94\u7528\u5230\u7f51\u683c\u5185\u90e8\u548c\u8fb9\u7f18\u7f51\u5173\u4e0a\uff0c\u5219\u9700\u8981\u663e\u793a\u5730\u628a <code>Mesh</code>\u503c\u52a0\u5165 <code>VirtualService.gateways</code>\uff0c\u5982 <code>Mesh</code>\uff0c<code>gateway-name1</code>\uff0c<code>gateway-name2</code></li> </ul> <p>\u4e00\u4e2a\u5e38\u89c1\u7684\u95ee\u9898\u662f\u4ee5\u4e0a\u7684\u7b2c\u4e09\u79cd\u60c5\u51b5\uff0c<code>VirtualService</code> \u6700\u5f00\u59cb\u4f5c\u7528\u4e8e\u7f51\u5173\u5185\u90e8\uff0c\u540e\u7eed\u8981\u5c06\u5176\u89c4\u5219\u6269\u5c55\u5230\u8fb9\u7f18\u7f51\u5173\u4e0a\uff0c\u7528\u6237\u5f80\u5f80\u53ea\u4f1a\u6dfb\u52a0\u5177\u4f53 <code>Gateway Name</code>\uff0c\u800c\u9057\u6f0f <code>Mesh</code>\uff1a</p> <p></p> <p><code>Istio</code> \u81ea\u52a8\u7ed9 <code>VirtualService.gateways</code>\u8bbe\u7f6e\u9ed8\u8ba4\u503c\uff0c\u672c\u610f\u662f\u4e3a\u4e86\u7b80\u5316\u7528\u6237\u7684\u914d\u7f6e\uff0c\u4f46\u662f\u5f80\u5f80\u4f1a\u5bfc\u81f4\u7528\u6237\u5e94\u7528\u4e0d\u5f53\uff0c\u4e00\u4e2a <code>feature</code> \u4e00\u4e0d\u5c0f\u5fc3\u4f1a\u88ab\u7528\u6210\u4e86<code>bug</code>\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#7-virtualservice-host-fragment","title":"7\u3001 <code>VirtualService</code> \u4e0d\u652f\u6301 <code>Host Fragment</code>","text":""},{"location":"chap9/24Istio_troubleshoot/#7-1","title":"7-1 \u5f02\u5e38\u6848\u4f8b","text":"<p>\u5bf9\u67d0\u4e00<code>host</code>\u65b0\u589e\u3001\u4fee\u6539 <code>VirtualService</code>\uff0c\u53d1\u73b0\u89c4\u5219\u59cb\u7ec8\u65e0\u6cd5\u751f\u6548\uff0c\u6392\u67e5\u53d1\u73b0\u5b58\u5728\u5176\u4ed6 <code>VirtualService</code> \u4e5f\u5bf9\u8be5 <code>host</code> \u5e94\u7528\u4e86\u5176\u4ed6\u89c4\u5219\uff0c\u89c4\u5219\u5185\u5bb9\u53ef\u80fd\u4e0d\u51b2\u7a81\uff0c\u4f46\u8fd8\u662f\u53ef\u80fd\u51fa\u73b0\u5176\u4e2d\u4e00\u4e9b\u89c4\u5219\u65e0\u6cd5\u751f\u6548\u7684\u60c5\u51b5\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#7-2","title":"7-2 \u80cc\u666f","text":"<ul> <li><code>VirtualService</code> \u91cc\u7684\u89c4\u5219\uff0c\u6309\u7167 <code>host</code> \u8fdb\u884c\u805a\u5408</li> <li>\u968f\u7740\u4e1a\u52a1\u7684\u589e\u957f\uff0c<code>VirtualService</code> \u7684\u5185\u5bb9\u4f1a\u5feb\u901f\u589e\u957f\uff0c\u4e00\u4e2a <code>host</code> \u7684\u6d41\u63a7\u89c4\u5219\uff0c\u53ef\u80fd\u4f1a\u7531\u4e0d\u540c\u7684\u56e2\u961f\u5206\u5e03\u7ef4\u62a4\u3002\u5982\u5b89\u5168\u89c4\u5219\u548c\u4e1a\u52a1\u89c4\u5219\u5206\u5f00\uff0c\u4e0d\u540c\u4e1a\u52a1\u6309\u7167\u5b50 <code>path</code>\u5206\u5f00</li> </ul> <p>\u76ee\u524d <code>Istio</code> \u5bf9 <code>cross-resource VirtualService</code> \u7684\u652f\u6301\u60c5\u51b5\uff1a</p> <ul> <li>\u5728\u7f51\u683c\u8fb9\u7f18\uff08<code>Gateway</code>\uff09\uff0c\u540c\u4e00\u4e2a <code>host</code> \u7684\u6d41\u63a7\u89c4\u5219\uff0c\u652f\u6301\u5206\u5e03\u5230\u591a\u4e2a <code>VirtualService</code> \u5bf9\u8c61\u4e2d\uff0c<code>Istio</code> \u81ea\u52a8\u805a\u5408\uff0c\u4f46\u4f9d\u8d56\u5b9a\u4e49\u987a\u5e8f\u4ee5\u53ca\u7528\u6237\u81ea\u884c\u907f\u514d\u51b2\u7a81\u3002</li> <li>\u5728\u7f51\u683c\u5185\u90e8\uff08<code>for Sidecar</code>\uff09\uff0c\u540c\u4e00\u4e2a <code>host</code> \u7684\u6d41\u63a7\u89c4\u5219\uff0c\u4e0d\u652f\u6301\u5206\u5e03\u5230\u591a\u4e2a <code>VirtualService</code> \u5bf9\u8c61\u4e2d\uff0c\u5982\u679c\u540c\u4e00\u4e2a <code>host</code> \u5b58\u5728\u591a\u4e2a <code>VirtualService</code>\uff0c\u53ea\u6709\u7b2c\u4e00\u4e2a <code>VirtualService</code> \u751f\u6548\uff0c\u4e14\u6ca1\u6709\u51b2\u7a81\u68c0\u6d4b\u3002</li> </ul> <p><code>VirtualService</code> \u4e0d\u80fd\u5f88\u597d\u652f\u6301 <code>host</code> \u89c4\u5219\u5206\u7247\uff0c\u4f7f\u5f97\u56e2\u961f\u7684\u7ef4\u62a4\u804c\u8d23\u4e0d\u80fd\u5f88\u597d\u7684\u89e3\u8026\uff0c\u914d\u7f6e\u4eba\u5458\u9700\u8981\u77e5\u6089\u76ee\u6807 <code>host</code> \u7684\u6240\u6709\u6d41\u63a7\u89c4\u5219\uff0c\u624d\u6709\u4fe1\u5fc3\u53bb\u4fee\u6539 <code>VirtualService</code>\u3002</p> <p><code>Istio</code> \u89e3\u51b3\u65b9\u6848\uff1a<code>Virtual Service chaining\uff08plan in 1.6\uff09</code></p> <p></p> <p>Istio \u8ba1\u5212\u5728 1.6 \u4e2d\u652f\u6301 Virtual Service \u4ee3\u7406\u94fe\uff1a</p> <ul> <li><code>Virtual Service</code> \u652f\u6301\u5206\u7247\u5b9a\u4e49 + \u4ee3\u7406\u94fe</li> <li>\u652f\u6301\u56e2\u961f\u5bf9\u540c\u4e00 host \u7684 <code>Virtual Service</code> \u8fdb\u884c\u7075\u6d3b\u5206\u7247\uff0c\u6bd4\u5982\u6309\u7167 <code>SecOps/Netops/Business</code> \u7279\u6027\u5206\u79bb\uff0c\u5404\u56e2\u961f\u7ef4\u62a4\u5404\u79cd\u72ec\u7acb\u7684 <code>Virtual Service</code></li> </ul>"},{"location":"chap9/24Istio_troubleshoot/#8","title":"8\u3001\u5168\u94fe\u8def\u8ddf\u8e2a\u5e76\u975e\u5b8c\u5168\u900f\u660e\u63a5\u5165","text":""},{"location":"chap9/24Istio_troubleshoot/#8-1","title":"8-1 \u5f02\u5e38\u6848\u4f8b","text":"<p>\u5fae\u670d\u52a1\u63a5\u5165 Service Mesh \u540e\uff0c\u94fe\u8def\u8ddf\u8e2a\u6570\u636e\u6ca1\u6709\u5f62\u6210\u4e32\u8054\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#8-2","title":"8-2 \u539f\u56e0","text":"<p><code>Service Mesh</code>\u9065\u6d4b\u7cfb\u7edf\u4e2d\uff0c\u5bf9\u8c03\u7528\u94fe\u8ddf\u8e2a\u7684\u5b9e\u73b0\uff0c\u5e76\u975e\u5b8c\u5168\u7684\u96f6\u5165\u4fb5\uff0c\u9700\u8981\u7528\u6237\u4e1a\u52a1\u4f5c\u51fa\u5c11\u91cf\u7684\u4fee\u6539\u624d\u80fd\u652f\u6301\uff0c\u5177\u4f53\u5730\uff0c\u5728\u7528\u6237\u53d1\u51fa\uff08<code>HTTP/gRPC</code>\uff09<code>RPC</code> \u65f6\uff0c \u9700\u8981\u4e3b\u52a8\u5c06\u4e0a\u6e38\u8bf7\u6c42\u4e2d\u5b58\u5728\u7684 <code>B3 trace headers\u5199</code>\u5165\u4e0b\u6e38 <code>RPC</code> \u8bf7\u6c42\u5934\u4e2d\uff0c\u8fd9\u4e9b <code>headers</code> \u5305\u62ec\uff1a</p> <p></p> <p>\u6709\u90e8\u5206\u7528\u6237\u96be\u4ee5\u7406\u89e3\uff1a\u65e2\u7136 <code>inbound</code> \u6d41\u91cf\u548c <code>outbound</code> \u6d41\u91cf\u5df2\u7ecf\u5b8c\u5168\u88ab\u62e6\u622a\u5230<code>Envoy</code>\uff0c<code>Envoy</code>\u53ef\u4ee5\u5b9e\u73b0\u5b8c\u5168\u7684\u6d41\u91cf\u7ba1\u63a7\u548c\u4fee\u6539\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981\u5e94\u7528\u663e\u793a\u7b2c\u4f20\u9012<code>headers</code>\uff1f</p> <p></p> <p>\u5bf9\u4e8e Envoy \u6765\u8bf4\uff0c<code>inbound</code>\u8bf7\u6c42\u548c <code>outbound</code> \u8bf7\u6c42\u5b8c\u5168\u662f\u72ec\u7acb\u7684\uff0c<code>Envoy</code> \u65e0\u6cd5\u611f\u77e5\u8bf7\u6c42\u4e4b\u95f4\u7684\u5173\u8054\u3002\u5b9e\u9645\u4e0a\u8fd9\u4e9b\u8bf7\u6c42\u5230\u5e95\u6709\u65e0\u4e0a\u4e0b\u7ea7\u5173\u8054\uff0c\u5b8c\u5168\u7531\u5e94\u7528\u81ea\u5df1\u51b3\u5b9a\u3002</p> <p>\u4e3e\u4e00\u4e2a\u7279\u6b8a\u7684\u4e1a\u52a1\u573a\u666f\uff0c\u5982\u679c <code>Pod X</code> \u63a5\u6536\u5230 \u8bf7\u6c42 <code>A</code>\uff0c\u89e6\u53d1\u7684\u4e1a\u52a1\u903b\u8f91\u662f\uff1a\u6bcf\u9694<code>10</code>\u79d2 \u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\u5230 <code>Pod Y</code>\uff0c\u5982 <code>B1</code>\uff0c<code>B2</code>\uff0c<code>B3</code>\uff0c\u90a3\u4e48\u8fd9\u4e9b\u6247\u51fa\u7684\u8bf7\u6c42<code>Bx\uff08x=1\uff0c2\uff0c3\u2026\u2026\uff09</code>\uff0c\u548c\u8bf7\u6c42<code>A</code>\u662f\u4ec0\u4e48\u5173\u7cfb\uff1f\u4e1a\u52a1\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u51b3\u7b56\uff1a\u8ba4\u4e3a<code>A</code> \u662f<code>Bx</code> \u7684\u7236\u8bf7\u6c42\uff0c\u6216\u8005\u8ba4\u4e3a <code>Bx</code> \u662f\u72ec\u7acb\u7684\u9876\u5c42\u8bf7\u6c42\u3002</p> <p></p>"},{"location":"chap9/24Istio_troubleshoot/#9-mtls","title":"9\u3001 mTLS \u5bfc\u81f4\u8fde\u63a5\u4e2d\u65ad","text":"<p>\u5728\u5f00\u542f <code>Istio mTLS</code> \u7684\u7528\u6237\u573a\u666f\u4e2d\uff0c\u8bbf\u95ee\u51fa\u73b0 <code>connection termination</code> \u662f\u4e00\u4e2a\u9ad8\u9891\u7684\u5f02\u5e38\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u5f02\u5e38\u7684\u539f\u56e0\u548c <code>DestinationRule</code> \u4e2d\u7684 <code>mTLS</code> \u914d\u7f6e\u6709\u5173\uff0c\u662f <code>Istio</code> \u4e2d\u4e00\u4e2a\u4e0d\u5065\u58ee\u7684\u63a5\u53e3\u8bbe\u8ba1\u3002</p> <ul> <li> <p>\u5f53\u901a\u8fc7 <code>MeshPolicy</code> \u5f00\u542f\u5168\u5c40 <code>mTLS</code>\uff0c \u5982\u679c\u7f51\u683c\u4e2d\u6ca1\u6709\u5b9a\u4e49\u5176\u4ed6\u7684 <code>DestinationRule</code>\uff0c<code>mTLS</code> \u6b63\u5e38\u8fd0\u884c</p> </li> <li> <p>\u5982\u679c\u540e\u7eed\u7f51\u683c\u4e2d\u65b0\u589e\u4e86 <code>DestinationRule</code>\uff0c\u800c <code>DestinationRule</code> \u4e2d\u53ef\u4ee5\u8986\u76d6\u5b50\u7248\u672c\u7684 <code>mTLS</code> \u503c\uff08\u9ed8\u8ba4\u662f\u4e0d\u5f00\u542f\uff01\uff09\uff0c\u7528\u6237\u5728\u4f7f\u7528 <code>DestinationRule</code> \u65f6\uff0c\u5f80\u5f80\u5f88\u5c11\u53bb\u5173\u6ce8 <code>mTLS</code>\u5c5e\u6027\uff08\u7559\u7a7a\uff09\u3002\u6700\u7ec8\u5bfc\u81f4\u589e <code>DestinationRule</code> \u540e <code>mTLS</code>\u53d8\u6210\u4e86\u4e0d\u5f00\u542f\uff0c\u5bfc\u81f4 c<code>onnection termination</code></p> </li> <li> <p>\u4e3a\u4e86\u4fee\u590d\u4ee5\u4e0a\u95ee\u9898\uff0c\u7528\u6237\u4e0d\u5f97\u4e0d\u5728\u6240\u6709 <code>DestinationRule</code> \u4e2d\u589e\u52a0 <code>mTLS</code> \u5c5e\u6027\u5e76\u8bbe\u7f6e\u4e3a\u5f00\u542f</p> </li> </ul> <p></p> <p>\u8fd9\u79cd <code>Istio mTLS</code> \u7528\u6237\u63a5\u53e3\u6781\u5ea6\u4e0d\u53cb\u597d\uff0c\u867d\u7136 <code>mTLS</code> \u9ed8\u8ba4\u505a\u5230\u4e86\u5168\u5c40\u900f\u660e\uff0c\u4e1a\u52a1\u611f\u77e5\u4e0d\u5230 <code>mTLS</code> \u7684\u5b58\u5728\uff0c\u4f46\u662f\u4e00\u65e6\u4e1a\u52a1\u5b9a\u4e49\u4e86 <code>DestinationRule</code>\uff0c<code>DestinationRule</code> \u5c31\u5fc5\u987b\u8981\u77e5\u9053\u5f53\u524d <code>mTLS</code>\u662f\u5426\u5f00\u542f\uff0c\u5e76\u4f5c\u51fa\u8c03\u6574\u3002\u8bd5\u60f3 <code>mTLS</code> \u914d\u7f6e\u4ea4\u7531\u5b89\u5168\u56e2\u961f\u8d1f\u8d23\uff0c\u800c\u4e1a\u52a1\u56e2\u961f\u8d1f\u8d23\u5404\u81ea\u7684 <code>DestinationRule</code>\uff0c\u56e2\u961f\u95f4\u7684\u8026\u5408\u4f1a\u975e\u5e38\u4e25\u91cd\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#10","title":"10\u3001 \u7528\u6237\u670d\u52a1\u76d1\u542c\u5730\u5740\u9650\u5236","text":""},{"location":"chap9/24Istio_troubleshoot/#10-1","title":"10-1 \u5f02\u5e38\u63cf\u8ff0","text":"<p>\u5982\u679c\u7528\u6237\u5bb9\u5668\u4e2d\u4e1a\u52a1\u8fdb\u7a0b\u76d1\u542c\u7684\u5730\u5740\u662f\u5177\u4f53IP\uff08Pod IP\uff09\uff0c\u800c\u4e0d\u662f <code>0.0.0.0</code>\uff0c\u8be5\u7528\u6237\u5bb9\u5668\u65e0\u6cd5\u6b63\u5e38\u63a5\u5165 Istio\uff0c\u6d41\u91cf\u8def\u7531\u5931\u8d25\u3002</p> <p>\u8fd9\u662f\u53c8\u4e00\u4e2a\u6311\u6218 <code>Istio</code> \u6700\u5927\u900f\u660e\u5316\uff08<code>Maximize Transparency</code>\uff09\u8bbe\u8ba1\u76ee\u6807 \u7684\u573a\u666f\u3002</p>"},{"location":"chap9/24Istio_troubleshoot/#10-2","title":"10-2 \u539f\u56e0\u5206\u6790","text":"<p><code>Istio-proxy</code> \u4e2d\u7684\u4e00\u6bb5<code>iptables</code>\uff1a</p> <p></p> <p>\u5176\u4e2d\uff0c<code>ISTIO_IN_REDIRECT</code> \u662f <code>virtualInbound</code>\uff0c\u7aef\u53e3 <code>15006\uff1bISTIO_REDIRECT</code> \u662f <code>virtualOutbound</code>\uff0c\u7aef\u53e3 <code>15001</code>\u3002</p> <p>\u5173\u952e\u70b9\u662f\u89c4\u5219\u4e8c\uff1a\u5982\u679c <code>destination</code> \u4e0d\u662f <code>127.0.0.1/32</code>\uff0c\u8f6c\u7ed9 <code>15006</code>\uff08<code>virtualInbound</code>\uff0c<code>Envoy</code>\u76d1\u542c\uff09\uff0c\u8fd9\u91cc\u5bfc\u81f4\u4e86\u5bf9 <code>Pod IP</code> \u7684\u6d41\u91cf\u59cb\u7ec8\u4f1a\u56de\u5230 <code>Envoy</code>\u3002</p> <p>\u5bf9\u8be5\u89c4\u5219\u7684\u89e3\u91ca\uff1a</p> <pre><code># Redirect app calls back to itself via Envoy when using the service VIP or endpoint\n\n# address, e.g. appN =&gt; Envoy (client) =&gt; Envoy (server) =&gt; appN.\n</code></pre> <p>\u8be5\u89c4\u5219\u662f\u5e0c\u671b\u5728\u8fd9\u91cc\u8d77\u4f5c\u7528\uff1a\u5047\u8bbe\u5f53\u524d <code>Pod a</code>\u5c5e\u4e8e <code>service A</code>\uff0c<code>Pod</code> \u4e2d\u7528\u6237\u5bb9\u5668\u901a\u8fc7\u670d\u52a1\u540d\u8bbf\u95ee\u670d\u52a1<code>A</code>\uff0c<code>Envoy</code> \u4e2d\u8d1f\u8f7d\u5747\u8861\u903b\u8f91\u5c06\u8fd9\u6b21\u8bbf\u95ee\u8f6c\u53d1\u5230\u4e86\u5f53\u524d\u7684 <code>Pod IP</code>\uff0c<code>Istio</code> \u5e0c\u671b\u8fd9\u79cd\u573a\u666f\u670d\u52a1\u7aef\u4ecd\u7136\u6709\u6d41\u91cf\u7ba1\u63a7\u80fd\u529b\u3002\u5982\u56fe\u793a\uff1a</p> <p></p>"},{"location":"chap9/24Istio_troubleshoot/#10-3","title":"10-3 \u6539\u9020\u5efa\u8bae","text":"<p>\u5efa\u8bae\u5e94\u7528\u5728\u63a5\u5165 Istio \u4e4b\u524d\uff0c\u8c03\u6574\u670d\u52a1\u76d1\u542c\u5730\u5740\uff0c\u4f7f\u7528 <code>0.0.0.0</code> \u800c\u4e0d\u662f\u5177\u4f53 <code>IP</code>\u3002</p>"},{"location":"chap9/2Istio_security/","title":"\u7b2c\u4e8c\u8282 Istio \u5b89\u5168\u6700\u4f73\u5b9e\u8df5","text":"<p>Istio \u7684\u5b89\u5168\u529f\u80fd\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u8eab\u4efd\u3001\u7b56\u7565\u3001\u900f\u660e\u7684 TLS \u52a0\u5bc6\u4ee5\u53ca\u8ba4\u8bc1\u3001\u6388\u6743\u548c\u5ba1\u8ba1\uff08AAA\uff09\u5de5\u5177\u6765\u4fdd\u62a4\u4f60\u7684\u670d\u52a1\u548c\u6570\u636e\u3002\u7136\u800c\uff0c\u4e3a\u4e86\u5145\u5206\u5b89\u5168\u5730\u5229\u7528\u8fd9\u4e9b\u529f\u80fd\uff0c\u5fc5\u987b\u6ce8\u610f\u9075\u5faa\u6700\u4f73\u5b9e\u8df5</p>"},{"location":"chap9/2Istio_security/#1-tls","title":"1\u3001\u53cc\u5411 TLS","text":"<p>Istio \u5c06\u5c3d\u53ef\u80fd\u4f7f\u7528 \u53cc\u5411TLS \u5bf9\u6d41\u91cf\u8fdb\u884c\u81ea\u52a8\u52a0\u5bc6\u3002\u7136\u800c\uff0c\u4ee3\u7406\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u88ab\u914d\u7f6e\u4e3a\u8bb8\u53ef\u6a21\u5f0f\uff08<code>Permissive Mode</code>\uff09\uff0c\u8fd9\u610f\u5473\u7740\u4ed6\u4eec\u5c06\u63a5\u53d7\u53cc\u5411 TLS \u548c\u660e\u6587\u6d41\u91cf\u3002</p> <p>\u7136\u800c\uff0c\u4ec5\u9760\u53cc\u5411 TLS \u5e76\u4e0d\u8db3\u4ee5\u4fdd\u8bc1\u6d41\u91cf\u7684\u5b89\u5168\uff0c\u56e0\u4e3a\u5b83\u53ea\u63d0\u4f9b\u8ba4\u8bc1\uff0c\u800c\u4e0d\u662f\u6388\u6743\u3002\u8fd9\u610f\u5473\u7740\uff0c\u4efb\u4f55\u62e5\u6709\u6709\u6548\u8bc1\u4e66\u7684\u4eba\u4ecd\u7136\u53ef\u4ee5\u8bbf\u95ee\u4e00\u4e2a\u670d\u52a1\u3002</p> <p>\u4e3a\u4e86\u5b8c\u5168\u9501\u5b9a\u6d41\u91cf\uff0c\u5efa\u8bae\u914d\u7f6e\u6388\u6743\u7b56\u7565\u3002\u8fd9\u5141\u8bb8\u521b\u5efa\u7ec6\u7c92\u5ea6\u7684\u7b56\u7565\u6765\u5141\u8bb8\u6216\u62d2\u7edd\u6d41\u91cf\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u53ea\u5141\u8bb8\u6765\u81ea app \u547d\u540d\u7a7a\u95f4\u7684\u8bf7\u6c42\u8bbf\u95ee <code>hello-world</code> \u670d\u52a1\u3002</p>"},{"location":"chap9/2Istio_security/#2","title":"2\u3001\u6388\u6743\u7b56\u7565","text":"<p>Istio \u6388\u6743\u5728 Istio \u5b89\u5168\u4e2d\u8d77\u7740\u5173\u952e\u4f5c\u7528\u3002\u5b83\u9700\u8981\u52aa\u529b\u914d\u7f6e\u6b63\u786e\u7684\u6388\u6743\u7b56\u7565\uff0c\u4ee5\u6700\u597d\u5730\u4fdd\u62a4\u4f60\u7684\u96c6\u7fa4\u3002\u4e86\u89e3\u8fd9\u4e9b\u914d\u7f6e\u7684\u5f71\u54cd\u662f\u5f88\u91cd\u8981\u7684\uff0c\u56e0\u4e3a Istio \u65e0\u6cd5\u786e\u5b9a\u6240\u6709\u7528\u6237\u7684\u6b63\u786e\u6388\u6743\u3002\u8bf7\u5168\u7a0b\u5173\u6ce8\u672c\u8282\u5185\u5bb9\u3002</p>"},{"location":"chap9/2Istio_security/#2-1","title":"2-1 \u5e94\u7528\u9ed8\u8ba4\u62d2\u7edd\u7684\u6388\u6743\u7b56\u7565","text":"<p>\u6211\u4eec\u5efa\u8bae\u4f60\u6309\u7167 <code>default-deny</code> \u6a21\u5f0f\u5b9a\u4e49\u4f60\u7684 Istio \u6388\u6743\u7b56\u7565\uff0c\u4ee5\u589e\u5f3a\u96c6\u7fa4\u7684\u5b89\u5168\u6001\u52bf\u3002</p> <p>\u9ed8\u8ba4\u62d2\u7edd\u6388\u6743\u6a21\u5f0f\u610f\u5473\u7740\u4f60\u7684\u7cfb\u7edf\u9ed8\u8ba4\u62d2\u7edd\u6240\u6709\u8bf7\u6c42\uff0c\u800c\u4f60\u5b9a\u4e49\u4e86\u5141\u8bb8\u8bf7\u6c42\u7684\u6761\u4ef6\u3002\u5982\u679c\u4f60\u9519\u8fc7\u4e86\u4e00\u4e9b\u6761\u4ef6\uff0c\u6d41\u91cf\u5c06\u88ab\u610f\u5916\u5730\u62d2\u7edd\uff0c\u800c\u4e0d\u662f\u6d41\u91cf\u88ab\u610f\u5916\u5730\u5141\u8bb8\u3002\u540e\u8005\u901a\u5e38\u662f\u4e00\u4e2a\u5b89\u5168\u4e8b\u4ef6\uff0c\u800c\u524d\u8005\u53ef\u80fd\u4f1a\u5bfc\u81f4\u7cdf\u7cd5\u7684\u7528\u6237\u4f53\u9a8c\u3001\u670d\u52a1\u4e2d\u65ad\u6216\u4e0d\u7b26\u5408\u4f60\u7684 SLO/SLA\u3002</p> <p>\u4f8b\u5982\uff0c\u5728 HTTP \u6d41\u91cf\u7684\u6388\u6743\u4efb\u52a1\u4e2d\uff0c\u540d\u4e3a <code>allow-nothing</code> \u7684\u6388\u6743\u7b56\u7565\u786e\u4fdd\u6240\u6709\u6d41\u91cf\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u88ab\u62d2\u7edd\u3002\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c\u5176\u4ed6\u6388\u6743\u7b56\u7565\u6839\u636e\u7279\u5b9a\u6761\u4ef6\u5141\u8bb8\u6d41\u91cf\u3002</p>"},{"location":"chap9/2Istio_security/#2-2","title":"2-2 \u5728\u8def\u5f84\u89c4\u8303\u5316\u4e0a\u5b9a\u5236\u4f60\u7684\u7cfb\u7edf","text":"<p>Istio \u6388\u6743\u7b56\u7565\u53ef\u4ee5\u57fa\u4e8e HTTP \u8bf7\u6c42\u4e2d\u7684 URL \u8def\u5f84\u3002\u8def\u5f84\u89c4\u8303\u5316\uff08\u53c8\u79f0 URI \u89c4\u8303\u5316\uff09\u5bf9\u4f20\u5165\u8bf7\u6c42\u7684\u8def\u5f84\u8fdb\u884c\u4fee\u6539\u548c\u6807\u51c6\u5316\uff0c\u4ece\u800c\u4f7f\u89c4\u8303\u5316\u540e\u7684\u8def\u5f84\u80fd\u591f\u4ee5\u6807\u51c6\u65b9\u5f0f\u8fdb\u884c\u5904\u7406\u3002\u8bed\u6cd5\u4e0a\u4e0d\u540c\u7684\u8def\u5f84\u5728\u8def\u5f84\u89c4\u8303\u5316\u540e\u53ef\u80fd\u662f\u7b49\u540c\u7684\u3002</p> <p>Istio \u652f\u6301\u4ee5\u4e0b\u8bf7\u6c42\u8def\u5f84\u7684\u89c4\u8303\u5316\u65b9\u6848\uff0c\u7136\u540e\u518d\u6839\u636e\u6388\u6743\u7b56\u7565\u8fdb\u884c\u8bc4\u4f30\u548c\u8def\u7531\u8bf7\u6c42\uff1a</p> <p> </p> <p>\u8be5\u914d\u7f6e\u662f\u901a\u8fc7 mesh \u914d\u7f6e\u4e2d\u7684 <code>pathNormalization</code> \u5b57\u6bb5\u6307\u5b9a\u7684\u3002</p> <p>\u4e3a\u4e86\u5f3a\u8c03\u8fd9\u4e00\u70b9\uff0c\u89c4\u8303\u5316\u7b97\u6cd5\u662f\u6309\u7167\u4ee5\u4e0b\u987a\u5e8f\u8fdb\u884c\u7684\uff1a</p> <ul> <li>\u767e\u5206\u6bd4\u89e3\u7801 <code>%2F</code>\u3001<code>%2f</code>\u3001<code>%5C</code> \u548c <code>%5c</code></li> <li>\u5408\u5e76\u659c\u7ebf</li> </ul>"},{"location":"chap9/2Istio_security/#2-3","title":"2-3 \u914d\u7f6e\u7684\u4f8b\u5b50","text":"<p>\u786e\u4fdd Envoy \u89c4\u8303\u5316\u8bf7\u6c42\u8def\u5f84\u4ee5\u7b26\u5408\u4f60\u7684\u540e\u7aef\u670d\u52a1\u7684\u671f\u671b\uff0c\u5bf9\u4f60\u7684\u7cfb\u7edf\u5b89\u5168\u81f3\u5173\u91cd\u8981\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u53ef\u4ee5\u4f5c\u4e3a\u4f60\u914d\u7f6e\u7cfb\u7edf\u7684\u53c2\u8003\u3002\u89c4\u8303\u5316\u7684 URL \u8def\u5f84\uff0c\u5982\u679c\u9009\u62e9\u4e86<code>NONE</code>\uff0c\u5219\u662f\u539f\u59cb\u7684 URL \u8def\u5f84\u5c06\uff1a</p> <ul> <li>\u7528\u6765\u5bf9\u7167\u6388\u6743\u7b56\u7565\u8fdb\u884c\u68c0\u67e5</li> <li>\u8f6c\u53d1\u5230\u540e\u7aef\u5e94\u7528\u7a0b\u5e8f</li> </ul> <p> </p>"},{"location":"chap9/2Istio_security/#2-4","title":"2-4 \u5982\u4f55\u914d\u7f6e","text":"<p>\u4f60\u53ef\u4ee5\u4f7f\u7528 istioctl \u6765\u66f4\u65b0 mesh \u914d\u7f6e</p> <pre><code>$ istioctl upgrade --set meshConfig.pathNormalization.normalization=DECODE_AND_MERGE_SLASHES\n</code></pre> <p>\u6216\u901a\u8fc7\u6539\u53d8\u4f60\u7684 Operator \u91cd\u5199\u6587\u4ef6</p> <pre><code>$ cat &lt;&lt;EOF &gt; iop.yaml\napiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nspec:\n  meshConfig:\n    pathNormalization:\n      normalization: DECODE_AND_MERGE_SLASHES\nEOF\n$ istioctl install -f iop.yaml\n</code></pre> <p>\u53e6\u5916\uff0c\u5982\u679c\u4f60\u60f3\u76f4\u63a5\u7f16\u8f91 Mesh \u914d\u7f6e\uff0c\u4f60\u53ef\u4ee5\u5c06 <code>pathNormalization</code> \u6dfb\u52a0\u5230 <code>mesh</code> \u914d\u7f6e\u4e2d\uff0c\u8be5\u914d\u7f6e\u662f <code>istio-&lt;REVISION_ID&gt;</code>\u7684 <code>CongfigMap</code>\uff0c\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u9009\u62e9 <code>DECODE_AND_MERGE_SLASHES</code> \u9009\u9879\uff0c\u4f60\u4fee\u6539 mesh \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\n  data:\n    mesh: |-\n      ...\n      pathNormalization:\n        normalization: DECODE_AND_MERGE_SLASHES\n      ...     \n</code></pre>"},{"location":"chap9/2Istio_security/#2-5","title":"2-5 \u4e0d\u592a\u5e38\u89c1\u7684\u89c4\u8303\u5316\u914d\u7f6e","text":"<p>\u5927\u5c0f\u5199\u89c4\u8303\u5316</p> <p>\u5728\u67d0\u4e9b\u73af\u5883\u4e2d\uff0c\u4ee5\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u7684\u65b9\u5f0f\u6bd4\u8f83\u6388\u6743\u7b56\u7565\u4e2d\u7684\u8def\u5f84\u53ef\u80fd\u662f\u6709\u7528\u7684\u3002\u4f8b\u5982\uff0c\u5c06 <code>https://myurl/get</code> \u548c <code>https://myurl/GeT</code> \u7b49\u540c\u5bf9\u5f85\u3002</p> <p>\u5728\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 <code>EnvoyFilter\u3002</code>\u8fd9\u4e2a\u8fc7\u6ee4\u5668\u5c06\u6539\u53d8\u7528\u4e8e\u6bd4\u8f83\u7684\u8def\u5f84\u548c\u5448\u73b0\u7ed9\u5e94\u7528\u7a0b\u5e8f\u7684\u8def\u5f84\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  name: ingress-case-insensitive\n  namespace: istio-system\nspec:\n  configPatches:\n  - applyTo: HTTP_FILTER\n    match:\n      context: GATEWAY\n      listener:\n        filterChain:\n          filter:\n            name: \"envoy.filters.network.http_connection_manager\"\n            subFilter:\n              name: \"envoy.filters.http.router\"\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: envoy.lua\n        typed_config:\n            \"@type\": \"type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua\"\n            inlineCode: |\n              function envoy_on_request(request_handle)\n                local path = request_handle:headers():get(\":path\")\n                request_handle:headers():replace(\":path\", string.lower(path))\n              end              \n</code></pre>"},{"location":"chap9/2Istio_security/#3","title":"3\u3001\u4e86\u89e3\u6d41\u91cf\u91c7\u96c6\u7684\u9650\u5236","text":"<p>Istio sidecar \u7684\u5de5\u4f5c\u539f\u7406\u662f\u6355\u83b7\u5165\u7ad9\u6d41\u91cf\u548c\u51fa\u7ad9\u6d41\u91cf\uff0c\u5e76\u901a\u8fc7 sidecar \u4ee3\u7406\u5f15\u5bfc\u5b83\u4eec\u3002</p> <p>\u7136\u800c\uff0c\u5e76\u4e0d\u662f\u6240\u6709\u7684\u6d41\u91cf\u90fd\u88ab\u6355\u83b7\uff1a</p> <ul> <li>\u91cd\u5b9a\u5411\u53ea\u5904\u7406\u57fa\u4e8e TCP \u7684\u6d41\u91cf\u3002\u4efb\u4f55 UDP \u6216 ICMP \u6570\u636e\u5305\u90fd\u4e0d\u4f1a\u88ab\u6355\u83b7\u6216\u4fee\u6539\u3002</li> <li>Sidecar \u4f7f\u7528\u7684\u8bb8\u591a\u7aef\u53e3\u4ee5\u53ca <code>22</code> \u53f7\u7aef\u53e3\u7684\u5165\u7ad9\u6355\u83b7\u88ab\u7981\u7528\u3002\u8fd9\u4e2a\u5217\u8868\u53ef\u4ee5\u901a\u8fc7 <code>traffic.sidecar.istio.io/excludeInboundPorts</code> \u7b49\u9009\u9879\u6765\u6269\u5c55\u3002</li> <li>\u51fa\u7ad9\u6355\u83b7\u540c\u6837\u53ef\u4ee5\u901a\u8fc7 <code>traffic.sidecar.istio.io/excludeOutboundPorts</code> \u7b49\u8bbe\u7f6e\u6216\u5176\u4ed6\u65b9\u5f0f\u51cf\u5c11\u3002</li> </ul> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u7528\u7a0b\u5e8f\u548c\u5176 sidecar \u4ee3\u7406\u4e4b\u95f4\u7684\u5b89\u5168\u8fb9\u754c\u6700\u5c0f\u3002</p> <p>\u5bf9 sidecar \u7684\u914d\u7f6e\u662f\u4ee5\u6bcf\u4e2a\u6a21\u5757\u4e3a\u57fa\u7840\u7684\uff0c\u5e76\u4e14\u4e24\u8005\u90fd\u5728\u540c\u4e00\u4e2a\u7f51\u7edc / \u8fdb\u7a0b\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u3002\u56e0\u6b64\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u6709\u80fd\u529b\u5220\u9664\u91cd\u5b9a\u5411\u89c4\u5219\uff0c\u5e76\u5220\u9664\u3001\u6539\u53d8\u3001\u7ec8\u6b62\u6216\u66ff\u6362 sidecar \u4ee3\u7406\u3002</p> <p>\u8fd9\u5141\u8bb8\u4e00\u4e2a pod \u6545\u610f\u7ed5\u8fc7\u5b83\u7684 sidecar \u7684\u51fa\u7ad9\u6d41\u91cf\u6216\u6545\u610f\u8ba9\u5165\u7ad9\u6d41\u91cf\u7ed5\u8fc7\u5b83\u7684 sidecar\u3002</p> <p>\u56e0\u6b64\uff0c\u4f9d\u9760 Istio \u65e0\u6761\u4ef6\u5730\u6355\u83b7\u6240\u6709\u6d41\u91cf\u662f\u4e0d\u5b89\u5168\u7684\u3002\u76f8\u53cd\uff0c\u5b89\u5168\u8fb9\u754c\u662f\u5ba2\u6237\u7aef\u4e0d\u80fd\u7ed5\u8fc7\u53e6\u4e00\u4e2a pod \u7684 sidecar\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u6211\u5728 9080 \u7aef\u53e3\u8fd0\u884c review \u5e94\u7528\u7a0b\u5e8f\uff0c\u6211\u53ef\u4ee5\u5047\u8bbe\u6765\u81ea productpage \u5e94\u7528\u7a0b\u5e8f\u7684\u6240\u6709\u6d41\u91cf\u5c06\u88ab sidecar \u4ee3\u7406\u6355\u83b7\uff0c\u5176\u4e2d Istio \u8ba4\u8bc1\u548c\u6388\u6743\u7b56\u7565\u53ef\u80fd\u9002\u7528\u3002</p>"},{"location":"chap9/2Istio_security/#3-1-networkpolicy","title":"3-1 \u5229\u7528 NetworkPolicy \u8fdb\u884c\u6df1\u5ea6\u9632\u5fa1","text":"<p>\u4e3a\u4e86\u8fdb\u4e00\u6b65\u786e\u4fdd\u6d41\u91cf\u5b89\u5168\uff0cIstio \u7b56\u7565\u53ef\u4ee5\u4e0e Kubernetes \u7f51\u7edc\u7b56\u7565\u5206\u5c42\u3002\u8fd9\u5b9e\u73b0\u4e86\u4e00\u4e2a\u5f3a\u5927\u7684\u6df1\u5ea6\u9632\u5fa1\u7b56\u7565\uff0c\u53ef\u4ee5\u7528\u6765\u8fdb\u4e00\u6b65\u52a0\u5f3a\u4f60\u7684\u7f51\u683c\u7684\u5b89\u5168\u6027\u3002</p> <p>\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u53ea\u5141\u8bb8\u6d41\u91cf\u5230\u6211\u4eec review \u5e94\u7528\u7a0b\u5e8f\u7684 9080 \u7aef\u53e3\u3002\u5982\u679c\u96c6\u7fa4\u4e2d\u7684 Pod \u88ab\u7834\u574f\u6216\u5b58\u5728\u5b89\u5168\u6f0f\u6d1e\uff0c\u8fd9\u53ef\u80fd\u4f1a\u9650\u5236\u6216\u963b\u6b62\u653b\u51fb\u8005\u7684\u8fdb\u5c55\u3002</p>"},{"location":"chap9/2Istio_security/#3-2","title":"3-2 \u786e\u4fdd\u51fa\u53e3\u6d41\u91cf\u7684\u5b89\u5168","text":"<p>\u4e00\u4e2a\u5e38\u89c1\u7684\u8bef\u89e3\u662f\uff0c\u50cf <code>outboundTrafficPolicy: REGISTRY_ONLY</code> \u4f5c\u4e3a\u4e00\u4e2a\u5b89\u5168\u7b56\u7565\uff0c\u9632\u6b62\u6240\u6709\u5bf9\u672a\u7533\u62a5\u670d\u52a1\u7684\u8bbf\u95ee\u3002\u7136\u800c\uff0c\u5982\u4e0a\u6240\u8ff0\uff0c\u8fd9\u5e76\u4e0d\u662f\u4e00\u4e2a\u5f3a\u5927\u7684\u5b89\u5168\u8fb9\u754c\uff0c\u5e94\u8be5\u88ab\u8ba4\u4e3a\u662f\u5c3d\u529b\u800c\u4e3a\u3002</p> <p>\u867d\u7136\u8fd9\u5bf9\u9632\u6b62\u610f\u5916\u7684\u4f9d\u8d56\u6027\u5f88\u6709\u7528\uff0c\u4f46\u5982\u679c\u4f60\u60f3\u4fdd\u8bc1\u51fa\u53e3\u6d41\u91cf\u7684\u5b89\u5168\uff0c\u5e76\u5f3a\u5236\u8981\u6c42\u6240\u6709\u51fa\u7ad9\u6d41\u91cf\u901a\u8fc7\u4ee3\u7406\uff0c\u4f60\u5e94\u8be5\u4f9d\u9760 Egress Gateway\u3002</p> <p>\u5f53\u4e0e\u7f51\u7edc\u7b56\u7565\u76f8\u7ed3\u5408\u65f6\uff0c\u4f60\u53ef\u4ee5\u5f3a\u5236\u6240\u6709\u7684\u6d41\u91cf\uff0c\u6216\u4e00\u4e9b\u5b50\u96c6\uff0c\u901a\u8fc7\u51fa\u53e3\u7f51\u5173\u3002\u8fd9\u786e\u4fdd\u4e86\u5373\u4f7f\u5ba2\u6237\u610f\u5916\u5730\u6216\u6076\u610f\u5730\u7ed5\u8fc7\u4ed6\u4eec\u7684 sidecar\uff0c\u8be5\u8bf7\u6c42\u4e5f\u4f1a\u88ab\u963b\u6b62\u3002</p>"},{"location":"chap9/2Istio_security/#4-tls-tls","title":"4\u3001\u5f53\u4f7f\u7528 TLS \u53d1\u8d77\u65f6\uff0c\u5728\u76ee\u7684\u5730\u89c4\u5219\u4e2d\u914d\u7f6e TLS \u9a8c\u8bc1","text":"<p>Istio \u63d0\u4f9b\u4e86\u4ece\u4e00\u4e2a sidecar \u4ee3\u7406\u6216\u7f51\u5173\u53d1\u8d77 TLS \u7684\u80fd\u529b\u3002\u8fd9\u4f7f\u5f97\u53d1\u9001\u7eaf\u6587\u672c HTTP \u6d41\u91cf\u7684\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u900f\u660e\u5730 \u201c\u5347\u7ea7 \u201c\u5230 HTTPS\u3002</p> <p>\u5728\u914d\u7f6e <code>DestinationRule</code> \u7684<code>tls</code> \u8bbe\u7f6e\u65f6\uff0c\u5fc5\u987b\u6ce8\u610f\u6307\u5b9a <code>caCertificates</code> \u5b57\u6bb5\u3002\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\uff0c\u670d\u52a1\u5668\u7684\u8bc1\u4e66\u5c06\u4e0d\u4f1a\u88ab\u9a8c\u8bc1\u3002</p> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: DestinationRule\nmetadata:\n  name: google-tls\nspec:\n  host: google.com\n  trafficPolicy:\n    tls:\n      mode: SIMPLE\n      caCertificates: /etc/ssl/certs/ca-certificates.crt\n</code></pre>"},{"location":"chap9/2Istio_security/#5","title":"5\u3001\u7f51\u5173","text":"<p>\u5728\u8fd0\u884c Istio \u7f51\u5173\u65f6\uff0c\u6d89\u53ca\u4e00\u4e9b\u8d44\u6e90\uff1a</p> <ul> <li>Gateways\uff0c\u5b83\u63a7\u5236\u7f51\u5173\u7684\u7aef\u53e3\u548c TLS \u8bbe\u7f6e\u3002</li> <li>VirtualServices\uff0c\u63a7\u5236\u8def\u7531\u903b\u8f91\u3002\u8fd9\u4e9b\u90fd\u662f\u901a\u8fc7\u5728\u7f51\u5173\u5b57\u6bb5\u4e2d\u7684\u76f4\u63a5\u5f15\u7528\u548c\u5728\u7f51\u5173\u548cVirtualService \u7684 hosts \u5b57\u6bb5\u4e2d\u7684\u76f8\u4e92\u7ea6\u5b9a\u4e0e Gateway \u76f8\u5173\u8054\u7684\u3002</li> </ul>"},{"location":"chap9/2Istio_security/#5-1-gateway","title":"5-1 \u9650\u5236 Gateway \u521b\u5efa\u6743\u9650","text":"<p>\u5efa\u8bae\u5c06 Gateway \u8d44\u6e90\u7684\u521b\u5efa\u9650\u5236\u5728\u53d7\u4fe1\u4efb\u7684\u96c6\u7fa4\u7ba1\u7406\u5458\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7 Kubernetes RBAC \u7b56\u7565\u6216 Open Policy Agent\u7b49\u5de5\u5177\u5b9e\u73b0\u3002</p>"},{"location":"chap9/2Istio_security/#5-2-hosts","title":"5-2 \u907f\u514d\u8fc7\u4e8e\u5bbd\u6cdb\u7684 hosts \u914d\u7f6e","text":"<p>\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u907f\u514d\u5728 Gateway \u4e2d\u8fdb\u884c\u8fc7\u4e8e\u5e7f\u6cdb\u7684 hosts \u8bbe\u7f6e\u3002</p> <p>\u4f8b\u5982\uff0c\u8fd9\u79cd\u914d\u7f6e\u5c06\u5141\u8bb8\u4efb\u4f55 VirtualService \u7ed1\u5b9a\u5230 Gateway\uff0c\u53ef\u80fd\u4f1a\u66b4\u9732\u51fa\u610f\u5916\u7684\u57df\uff1a</p> <pre><code>servers:\n- port:\n    number: 80\n    name: http\n    protocol: HTTP\n  hosts:\n  - \"*\"\n</code></pre> <p>\u8fd9\u5e94\u8be5\u88ab\u9501\u5b9a\uff0c\u53ea\u5141\u8bb8\u7279\u5b9a\u57df\u6216\u7279\u5b9a\u547d\u540d\u7a7a\u95f4\u3002</p> <pre><code>servers:\n- port:\n    number: 80\n    name: http\n    protocol: HTTP\n  hosts:\n  - \"foo.example.com\" # \u53ea\u5141\u8bb8 foo.example.com \u7684 VirtualServices\n  - \"default/bar.example.com\" # \u53ea\u5141\u8bb8 default \u547d\u540d\u7a7a\u95f4 bar.example.com \u7684 VirtualServices\n  - \"route-namespace/*\" # \u53ea\u5141\u8bb8 route-namespace \u547d\u540d\u7a7a\u95f4\u7684 VirtualServices\n</code></pre>"},{"location":"chap9/2Istio_security/#5-3","title":"5-3 \u9694\u79bb\u654f\u611f\u670d\u52a1","text":"<p>\u53ef\u80fd\u9700\u8981\u5bf9\u654f\u611f\u670d\u52a1\u5b9e\u65bd\u66f4\u4e25\u683c\u7684\u7269\u7406\u9694\u79bb\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u80fd\u60f3\u4e3a\u654f\u611f\u7684 <code>payment.example.com</code> \u8fd0\u884c\u4e00\u4e2a\u4e13\u7528\u7684\u7f51\u5173\u5b9e\u4f8b\uff0c\u800c\u4e3a\u4e0d\u592a\u654f\u611f\u7684\u57df\u540d\u5982 <code>blog.example.com</code> \u548c <code>store.example.com</code>\u4f7f\u7528\u4e00\u4e2a\u5355\u4e00\u7684\u5171\u4eab\u7f51\u5173\u5b9e\u4f8b\u3002</p> <p>\u8fd9\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u66f4\u5f3a\u5927\u7684\u6df1\u5ea6\u9632\u5fa1\uff0c\u5e76\u6709\u52a9\u4e8e\u6ee1\u8db3\u67d0\u4e9b\u76d1\u7ba1\u5408\u89c4\u51c6\u5219\u3002</p>"},{"location":"chap9/2Istio_security/#5-4-sni-http","title":"5-4 \u5728\u653e\u5bbd\u7684 SNI \u4e3b\u673a\u5339\u914d\u4e0b\uff0c\u660e\u786e\u5730\u7981\u7528\u6240\u6709\u654f\u611f\u7684 http \u4e3b\u673a","text":"<p>\u5728\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a\u4f7f\u7528\u591a\u4e2a <code>Gateways</code> \u6765\u5b9a\u4e49\u53cc\u5411 TLS \u548c\u7b80\u5355 TLS \u662f\u5408\u7406\u7684\u3002\u4f8b\u5982\uff0c\u5bf9 SNI \u4e3b\u673a <code>admin.example.com</code> \u4f7f\u7528\u53cc\u5411 TLS\uff0c\u5bf9 SNI \u4e3b\u673a <code>*.example.com</code> \u4f7f\u7528\u7b80\u5355 <code>TLS</code>\u3002</p> <pre><code>kind: Gateway\nmetadata:\n  name: guestgateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    hosts:\n    - \"*.example.com\"\n    tls:\n      mode: SIMPLE\n---\nkind: Gateway\nmetadata:\n  name: admingateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    hosts:\n    - admin.example.com\n    tls:\n      mode: MUTUAL\n</code></pre> <p>\u5982\u679c\u6709\u5fc5\u8981\u8fdb\u884c\u4e0a\u8ff0\u64cd\u4f5c\uff0c\u5f3a\u70c8\u5efa\u8bae\u5728\u9644\u52a0\u5230 <code>*.example.com</code> \u7684 <code>VirtualService</code>\u4e2d\u660e\u786e\u7981\u7528 <code>http</code> \u4e3b\u673a <code>admin.example.com</code>\u3002</p> <p>\u539f\u56e0\u662f\u76ee\u524d\u5e95\u5c42\u7684 <code>envoy</code>\u4ee3\u7406\u4e0d\u9700\u8981 <code>http 1</code>\u5934 <code>Host</code> \u6216 <code>http 2</code> \u4f2a\u5934<code>:authority</code> \u7684 <code>SNI</code> \u7ea6\u675f\u540e\uff0c\u653b\u51fb\u8005\u53ef\u4ee5\u91cd\u65b0\u4f7f\u7528 <code>guest-SNI TLS</code> \u8fde\u63a5\u6765\u8bbf\u95ee <code>admin VirtualService</code>\u3002</p> <p>http \u54cd\u5e94\u4ee3\u7801 421 \u662f\u4e3a\u8fd9\u79cd <code>Host SNI</code> \u4e0d\u5339\u914d\u800c\u8bbe\u8ba1\u7684\uff0c\u53ef\u4ee5\u7528\u6765\u5b9e\u73b0\u7981\u7528\u3002</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: disable-sensitive\nspec:\n  hosts:\n  - \"admin.example.com\"\n  gateways:\n  - guestgateway\n  http:\n  - match:\n    - uri:\n        prefix: /\n    fault:\n      abort:\n        percentage:\n          value: 100\n        httpStatus: 421\n    route:\n    - destination:\n        port:\n          number: 8000\n        host: dest.default.cluster.local\n</code></pre>"},{"location":"chap9/2Istio_security/#6","title":"6\u3001\u534f\u8bae\u68c0\u6d4b","text":"<p>Istio \u4f1a\u81ea\u52a8\u786e\u5b9a\u5b83\u6240\u770b\u5230\u7684\u6d41\u91cf\u7684\u534f\u8bae\u3002\u4e3a\u4e86\u907f\u514d\u610f\u5916\u6216\u6545\u610f\u7684\u6f0f\u68c0\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u610f\u5916\u7684\u6d41\u91cf\u884c\u4e3a\uff0c\u5efa\u8bae\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\u660e\u786e\u58f0\u660e\u534f\u8bae\u3002</p>"},{"location":"chap9/2Istio_security/#7cni","title":"7\u3001CNI","text":"<p>\u4e3a\u4e86\u900f\u660e\u5730\u6355\u83b7\u6240\u6709\u6d41\u91cf\uff0cIstio \u4f9d\u8d56\u4e8e <code>istio-init initContainer</code>\u6240\u914d\u7f6e\u7684 <code>iptables</code> \u89c4\u5219\u3002\u8fd9\u589e\u52a0\u4e86\u4e00\u4e2a\u8981\u6c42\uff0c\u5373 <code>NET_ADMIN</code> \u548c <code>NET_RAW</code>\u7684\u80fd\u529b\u5fc5\u987b\u5bf9 pod \u53ef\u7528\u3002</p> <p>\u4e3a\u4e86\u51cf\u5c11\u6388\u4e88 pod \u7684\u6743\u9650\uff0cIstio \u63d0\u4f9b\u4e86\u4e00\u4e2a CNI \u63d2\u4ef6\uff0c\u5b83\u6d88\u9664\u4e86\u8fd9\u4e2a\u8981\u6c42\u3002</p> <p>Istio CNI \u63d2\u4ef6\u76ee\u524d\u662f\u4e00\u4e2a alpha \u529f\u80fd\u3002</p>"},{"location":"chap9/2Istio_security/#8-docker","title":"8\u3001\u4f7f\u7528\u52a0\u56fa\u7684 docker \u955c\u50cf","text":"<p>Istio \u7684\u9ed8\u8ba4 docker \u955c\u50cf\uff0c\u5305\u62ec\u90a3\u4e9b\u7531\u63a7\u5236\u5e73\u9762\u3001\u7f51\u5173\u548c sidecar \u4ee3\u7406\u8fd0\u884c\u7684\u955c\u50cf\uff0c\u90fd\u662f\u57fa\u4e8e ubuntu \u7684\u3002\u8fd9\u63d0\u4f9b\u4e86\u5404\u79cd\u5de5\u5177\uff0c\u5982 bash \u548c curl\uff0c\u8fd9\u4ee5\u65b9\u4fbf\u4e3a\u4ee3\u4ef7\uff0c\u589e\u52a0\u4e86\u653b\u51fb\u9762\u3002</p> <p>Istio \u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e\u65e0\u53d1\u884c\u7248\u955c\u50cf\u7684\u5c0f\u578b\u955c\u50cf\uff0c\u51cf\u5c11\u4e86\u955c\u50cf\u4e2d\u7684\u4f9d\u8d56\u6027\u3002</p> <p>\u65e0\u53d1\u884c\u7248\u7684\u955c\u50cf\u76ee\u524d\u662f\u4e00\u4e2a alpha \u529f\u80fd\u3002</p>"},{"location":"chap9/2Istio_security/#9","title":"9\u3001\u53d1\u5e03\u548c\u5b89\u5168\u7b56\u7565","text":"<p>\u4e3a\u4e86\u786e\u4fdd\u4f60\u7684\u96c6\u7fa4\u6709\u6700\u65b0\u7684\u5df2\u77e5\u6f0f\u6d1e\u7684\u5b89\u5168\u8865\u4e01\uff0c\u91cd\u8981\u7684\u662f\u4fdd\u6301\u5728 Istio \u7684\u6700\u65b0\u8865\u4e01\u7248\u672c\u4e0a\uff0c\u5e76\u786e\u4fdd\u4f60\u5728\u4e00\u4e2a\u652f\u6301\u7684\u7248\u672c\u4e0a\uff0c\u4ecd\u5728\u63a5\u6536\u5b89\u5168\u8865\u4e01\u3002</p>"},{"location":"chap9/2Istio_security/#10","title":"10\u3001\u68c0\u6d4b\u65e0\u6548\u914d\u7f6e","text":"<p>\u867d\u7136 Istio \u5728\u521b\u5efa\u8d44\u6e90\u65f6\u63d0\u4f9b\u4e86\u9a8c\u8bc1\uff0c\u4f46\u8fd9\u4e9b\u68c0\u67e5\u4e0d\u80fd\u6293\u4f4f\u6240\u6709\u963b\u6b62\u914d\u7f6e\u5728\u7f51\u683c\u4e2d\u5206\u5e03\u7684\u95ee\u9898\u3002\u8fd9\u53ef\u80fd\u5bfc\u81f4\u5e94\u7528\u7684\u7b56\u7565\u88ab\u610f\u5916\u5730\u5ffd\u7565\uff0c\u4ece\u800c\u5bfc\u81f4\u610f\u5916\u7684\u7ed3\u679c\u3002</p> <ul> <li>\u5728\u5e94\u7528\u914d\u7f6e\u4e4b\u524d\u6216\u4e4b\u540e\u8fd0\u884c <code>istioctl analyze</code>\uff0c\u4ee5\u786e\u4fdd\u914d\u7f6e\u6709\u6548\u3002</li> <li>\u76d1\u63a7\u63a7\u5236\u5e73\u9762\u7684\u62d2\u7edd\u914d\u7f6e\u3002\u9664\u4e86\u65e5\u5fd7\u4e4b\u5916\uff0c\u8fd9\u4e9b\u90fd\u662f\u901a\u8fc7 <code>pilot_total_xds_rejects</code> \u6307\u6807\u6765\u663e\u793a\u7684\u3002</li> <li>\u6d4b\u8bd5\u4f60\u7684\u914d\u7f6e\uff0c\u4ee5\u786e\u4fdd\u5b83\u7ed9\u51fa\u9884\u671f\u7684\u7ed3\u679c\u3002\u5bf9\u4e8e\u5b89\u5168\u7b56\u7565\u6765\u8bf4\uff0c\u8fd0\u884c\u6b63\u9762\u548c\u8d1f\u9762\u7684\u6d4b\u8bd5\u662f\u6709\u7528\u7684\uff0c\u4ee5\u786e\u4fdd\u4f60\u4e0d\u4f1a\u610f\u5916\u5730\u9650\u5236\u8fc7\u591a\u6216\u8fc7\u5c11\u7684\u6d41\u91cf\u3002</li> </ul>"},{"location":"chap9/2Istio_security/#11","title":"11\u3001\u9501\u5b9a\u7aef\u53e3","text":"<p>Istio \u914d\u7f6e\u4e86\u5404\u79cd\u53ef\u80fd\u88ab\u9501\u5b9a\u7684\u7aef\u53e3\uff0c\u4ee5\u63d0\u9ad8\u5b89\u5168\u6027\u3002</p>"},{"location":"chap9/2Istio_security/#11-1","title":"11-1 \u63a7\u5236\u5e73\u9762","text":"<p>Istiod \u4e3a\u65b9\u4fbf\u8d77\u89c1\uff0c\u9ed8\u8ba4\u66b4\u9732\u4e86\u51e0\u4e2a\u672a\u7ecf\u8ba4\u8bc1\u7684\u660e\u6587\u7aef\u53e3\u3002\u5982\u679c\u9700\u8981\uff0c\u8fd9\u4e9b\u7aef\u53e3\u53ef\u4ee5\u88ab\u5173\u95ed\u3002</p> <ul> <li><code>8080</code> \u7aef\u53e3\u66b4\u9732\u4e86\u8c03\u8bd5\u63a5\u53e3\uff0c\u5b83\u63d0\u4f9b\u4e86\u5bf9\u96c6\u7fa4\u72b6\u6001\u7684\u5404\u79cd\u7ec6\u8282\u7684\u8bfb\u53d6\u6743\u9650\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u5728 Istiod \u4e0a\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf <code>ENABLE_DEBUG_ON_HTTP=false</code> \u6765\u7981\u7528\u3002\u8b66\u544a\uff1a\u8bb8\u591a istioctl \u547d\u4ee4\u90fd\u4f9d\u8d56\u4e8e\u8fd9\u4e2a\u63a5\u53e3\uff0c\u5982\u679c\u5b83\u88ab\u7981\u7528\uff0c\u5c06\u65e0\u6cd5\u8fd0\u884c\u3002</li> <li><code>15010</code> \u7aef\u53e3\u901a\u8fc7\u660e\u6587\u66b4\u9732 <code>XDS</code> \u670d\u52a1\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u5728 Istiod \u90e8\u7f72\u4e2d\u6dfb\u52a0 <code>--grpcAddr=\"\"</code> \u6807\u5fd7\u6765\u7981\u7528\u3002\u6ce8\u610f\uff1a\u9ad8\u5ea6\u654f\u611f\u7684\u670d\u52a1\uff0c\u5982\u8bc1\u4e66\u7b7e\u7f72\u548c\u5206\u53d1\u670d\u52a1\uff0c\u7edd\u4e0d\u901a\u8fc7\u660e\u6587\u63d0\u4f9b\u3002</li> </ul>"},{"location":"chap9/2Istio_security/#11-2","title":"11-2 \u6570\u636e\u5e73\u9762","text":"<p>\u8be5\u4ee3\u7406\u66b4\u9732\u4e86\u5404\u79cd\u7aef\u53e3\u3002\u5bf9\u5916\u66b4\u9732\u7684\u662f <code>15090</code> \u7aef\u53e3\uff08\u9065\u6d4b\uff09\u548c <code>15021</code> \u7aef\u53e3\uff08\u5065\u5eb7\u68c0\u67e5\uff09\u3002</p> <p>\u7aef\u53e3 15020 \u548c 15000 \u63d0\u4f9b\u8c03\u8bd5\u7aef\u70b9\u3002\u8fd9\u4e9b\u7aef\u53e3\u53ea\u5728\u672c\u5730\u4e3b\u673a\u4e0a\u66b4\u9732\u3002\u56e0\u6b64\uff0c\u8fd0\u884c\u5728\u4e0e\u4ee3\u7406\u76f8\u540c\u7684 pod \u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u8bbf\u95ee\uff1b\u5728 <code>sidecar</code> \u548c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u6ca1\u6709\u4fe1\u4efb\u8fb9\u754c\u3002</p>"},{"location":"chap9/2Istio_security/#12","title":"12 \u914d\u7f6e\u7b2c\u4e09\u65b9\u670d\u52a1\u8d26\u6237\u4ee4\u724c","text":"<p>\u4e3a\u4e86\u4e0e Istio \u63a7\u5236\u5e73\u9762\u8fdb\u884c\u8ba4\u8bc1\uff0cIstio \u4ee3\u7406\u5c06\u4f7f\u7528\u670d\u52a1\u8d26\u6237\u4ee4\u724c\u3002Kubernetes \u652f\u6301\u8fd9\u79cd\u4ee4\u724c\u7684\u4e24\u79cd\u5f62\u5f0f\uff1a</p> <ul> <li>\u7b2c\u4e09\u65b9\u4ee4\u724c\uff0c\u6709\u4e00\u4e2a\u8303\u56f4\u5185\u7684\u53d7\u4f17\u548c\u5230\u671f\u65f6\u95f4\u3002</li> <li>\u7b2c\u4e00\u65b9\u4ee4\u724c\uff0c\u6ca1\u6709\u8fc7\u671f\uff0c\u5e76\u88ab\u5b89\u88c5\u5230\u6240\u6709\u7684 Pod \u4e2d\u3002</li> </ul> <p>\u7531\u4e8e\u7b2c\u4e00\u65b9\u4ee4\u724c\u7684\u5c5e\u6027\u4e0d\u592a\u5b89\u5168\uff0cIstio \u5c06\u9ed8\u8ba4\u4f7f\u7528\u7b2c\u4e09\u65b9\u4ee4\u724c\u3002\u7136\u800c\uff0c\u8fd9\u4e2a\u529f\u80fd\u5e76\u4e0d\u662f\u5728\u6240\u6709\u7684 Kubernetes \u5e73\u53f0\u4e0a\u90fd\u542f\u7528\u7684\u3002</p> <p>\u5982\u679c\u4f60\u4f7f\u7528 <code>istioctl</code> \u6765\u5b89\u88c5\uff0c\u5c06\u4f1a\u81ea\u52a8\u68c0\u6d4b\u5230\u652f\u6301\u3002\u8fd9\u4e5f\u53ef\u4ee5\u624b\u52a8\u5b8c\u6210\uff0c\u901a\u8fc7\u4f20\u9012 <code>--set values.global.jwtPolicy=third-party-jwt</code> \u6216 <code>--set values.global.jwtPolicy=first-party-jwt</code>\u8fdb\u884c\u914d\u7f6e\u3002</p> <p>\u8981\u786e\u5b9a\u4f60\u7684\u96c6\u7fa4\u662f\u5426\u652f\u6301\u7b2c\u4e09\u65b9\u4ee4\u724c\uff0c\u5bfb\u627e <code>TokenRequest API</code>\u3002\u5982\u679c\u8fd9\u6ca1\u6709\u8fd4\u56de\u54cd\u5e94\uff0c\u90a3\u4e48\u8be5\u529f\u80fd\u5c31\u4e0d\u88ab\u652f\u6301\u3002</p> <pre><code>$ kubectl get --raw /api/v1 | jq '.resources[] | select(.name | index(\"serviceaccounts/token\"))'\n{\n    \"name\": \"serviceaccounts/token\",\n    \"singularName\": \"\",\n    \"namespaced\": true,\n    \"group\": \"authentication.k8s.io\",\n    \"version\": \"v1\",\n    \"kind\": \"TokenRequest\",\n    \"verbs\": [\n        \"create\"\n    ]\n}\n</code></pre>"},{"location":"chap9/2Istio_security/#13","title":"13 \u914d\u7f6e\u4e0b\u6e38\u8fde\u63a5\u7684\u9650\u5236","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\uff08\u548c Envoy\uff09\u5bf9\u4e0b\u6e38\u8fde\u63a5\u7684\u6570\u91cf\u6ca1\u6709\u9650\u5236\u3002\u8fd9\u53ef\u80fd\u88ab\u6076\u610f\u884c\u4e3a\u8005\u5229\u7528\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f60\u5fc5\u987b\u4e3a\u4f60\u7684\u73af\u5883\u914d\u7f6e\u4e00\u4e2a\u9002\u5f53\u7684\u8fde\u63a5\u9650\u5236\u3002</p> <ul> <li>\u901a\u8fc7\u4e0b\u8f7d <code>custom-bootstrap-runtime.yaml</code> \u521b\u5efa\u4e00\u4e2a ConfigMap\u3002\u6839\u636e\u4f60\u7684\u90e8\u7f72\u4e2d\u5404\u4e2a\u7f51\u5173\u5b9e\u4f8b\u6240\u9700\u7684\u5e76\u53d1\u8fde\u63a5\u6570\uff0c\u66f4\u65b0 <code>ConfigMap</code> \u4e2d\u7684 <code>global_downstream_max_connections</code>\u3002\u4e00\u65e6\u8fbe\u5230\u9650\u5236\uff0cEnvoy \u5c06\u5f00\u59cb\u62d2\u7edd tcp \u8fde\u63a5\u3002</li> </ul> <pre><code>$ kubectl -n istio-system apply -f custom-bootstrap-runtime.yaml\n</code></pre> <ul> <li>\u5165\u53e3\u7f51\u5173\u90e8\u7f72\u6253\u8865\u4e01\uff0c\u4ee5\u4f7f\u7528\u4e0a\u8ff0\u914d\u7f6e\u3002\u4e0b\u8f7d <code>gateway-patch.yaml</code>\u5e76\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5e94\u7528\u5b83\u3002</li> </ul> <pre><code>$ kubectl --namespace istio-system patch deployment istio-ingressgateway --patch \"$(cat gateway-patch.yaml)\"\n</code></pre> <ul> <li>\u786e\u8ba4\u65b0\u7684\u9650\u5236\u5df2\u7ecf\u5230\u4f4d\u3002</li> </ul> <p> </p>"},{"location":"chap9/3Istio_service_entry/","title":"\u7b2c\u4e09\u8282 \u8bb0\u4e00\u6b21 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def","text":""},{"location":"chap9/3Istio_service_entry/#1","title":"1\u3001\u80cc\u666f","text":"<p>\u6700\u8fd1\u5728\u5f00\u59cb\u7814\u7a76 istio \u4f7f\u7528\uff0c\u5df2\u7ecf\u5728\u4e00\u4e2a\u672a\u5b89\u88c5 istio \u96c6\u7fa4\u7684\u73af\u5883\u4e2d\u6210\u529f\u641e\u5b9a istio \u5b89\u88c5\u914d\u7f6e\u4e14\u80fd\u6b63\u5e38\u4f7f\u7528\u3002</p> <p>\u4f46\u662f\u6700\u8fd1\u5728\u4e00\u4e2a\u65b0\u5347\u7ea7\u7684 istio \u7248\u672c(1.11.0)\u7684\u96c6\u7fa4\u4e2d\uff0c\u6240\u6709\u88ab\u6ce8\u5165 istio sidecar \u7684 pod \u5747\u65e0\u6cd5\u5bf9\u5916\u8bbf\u95ee https\u3002\u5bfc\u81f4\u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u3002\u5177\u4f53\u8868\u73b0\u4e3a IP \u80fd\u901a\uff0c\u4f46\u662f\u65e0\u6cd5 tls \u63e1\u624b\u6210\u529f\u3002</p> <ul> <li>\u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u7684\u521d\u671f\u8868\u73b0\u4e3a\u83b7\u53d6\u914d\u7f6e\u65f6\u63d0\u793a 404\u3002</li> <li>\u5728\u4e00\u6bb5\u65f6\u95f4\u540e\u7a81\u7136\u8868\u73b0\u4e3a\u65e0\u6cd5\u5efa\u7acb tls \uff0c\u8fd4\u56de 000\u3002</li> <li>\u6240\u6709\u5bf9\u5916\u7684 https \u670d\u52a1\u5747\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u3002</li> </ul> <p>\u5728\u521d\u671f debug \u540e\uff0c\u8868\u73b0\u66f4\u4e3a\u8be1\u5f02\uff0c\u5728\u4e0d\u540c\u7684 pod \u4e2d\u6709\u4e0d\u540c\u7684\u8868\u73b0\uff1a</p> <p>\u7531\u4e8e\u5df2\u7ecf\u65e0\u6cd5\u83b7\u5f97\u6848\u53d1\u65f6\u7684 shell \u8f93\u51fa\uff0c\u5c31\u4ec5\u6587\u5b57\u53d9\u8ff0\u3002</p> <ul> <li>\u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u7a81\u7136\u62d2\u7edd\u8fde\u63a5\u3002</li> <li>\u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u8fd4\u56de\u4e0e\u670d\u52a1\u7aef\u672c\u8eab\u4e0d\u7b26\u5408\u7684\u8bc1\u4e66\u3002\u4f8b\u5982\uff1a<code>curl https://baidu.com</code> \u63d0\u793a\u670d\u52a1\u7aef\u8bc1\u4e66\u4e3a <code>*.example.com</code>\u3002</li> <li>\u5728\u8df3\u8fc7\u8bc1\u4e66\u9a8c\u8bc1\u540e\uff0c\u670d\u52a1\u7aef\u54cd\u5e94\u4e86\u975e\u9884\u671f\u7684\u5185\u5bb9\u3002</li> </ul>"},{"location":"chap9/3Istio_service_entry/#2","title":"2\u3001\u521d\u6b65\u5206\u6790","text":"<p>\u7531\u4e8e\u65e0\u6cd5\u8bbf\u95ee\u5916\u90e8 https \uff0c\u521d\u671f\u731c\u60f3\u53ef\u80fd\u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u8bbf\u95ee\u7b56\u7565\u6216\u8005\u5176\u4ed6\u5b89\u5168\u76f8\u5173\u914d\u7f6e\uff0c\u6216\u8005\u5728 https \u4ee3\u7406\u4e0a\u51fa\u73b0\u4e86\u67d0\u4e9b\u914d\u7f6e\u9519\u8bef\u3002</p> <p>\u5728\u95ee\u9898\u51fa\u73b0\u540e\u7684\u4e00\u6bb5\u65f6\u95f4\u4e2d\uff0c\u6211\u4eec\u5bf9\u6bd4\u4e86\u6b63\u5e38\u4f7f\u7528 istio \u96c6\u7fa4\u548c\u95ee\u9898\u96c6\u7fa4\u7684 istio \u914d\u7f6e\uff0c\u6240\u6709 crd\u3002\u5747\u672a\u53d1\u73b0\u7279\u6b8a\u914d\u7f6e\u3002</p> <p>\u4f46\u662f\u989d\u5916\u7684\uff0c\u8be5\u96c6\u7fa4\u6709\u51e0\u4e2a\u6bd4\u8f83\u7279\u6b8a\u7684\u5730\u65b9\uff1a</p> <p>1\u3001\u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u5bf9\u5916\uff08\u516c\u7f51\u670d\u52a1\uff09\u8bbf\u95ee\u7684 serviceentry\uff0c\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl -n default get serviceentries.networking.istio.io\nNAME HOSTS LOCATION RESOLUTION AGE\nexternal-svc-https-qqapi [baike.baidu.com www.baidu.com www.bing.com apis.baidu.com nlp.xiaoi.com api.map.baidu.com music.baidu.com api.spotify.com api.cognitive.microsoft.com dict.baidu.com baike.baidu.com www.baidu.com sina.com.cn apistore.baidu.com api.heweather.com api.openweathermap.org ...] MESH_EXTERNAL 72m\n</code></pre> <p>\u90e8\u5206\u9690\u79c1\u57df\u540d\u5df2\u7ecf\u5220\u9664\uff0c\u8fd9\u6761\u914d\u7f6e\u91cc\u9762\u7684\u57df\u540d\u603b\u6570\u591a\u8fbe\u51e0\u5341\u6761\u3002</p> <p>\u7ecf\u8fc7\u8be2\u95ee\uff0c\u5f97\u5230\u7684\u7b54\u590d\u4e3a\uff1a\u9700\u8981\u5728 serviceentry \u4e2d\u52a0\u4e0a\u8fd9\u4e9b\u57df\u540d\u624d\u80fd\u4f7f mesh \u4e2d\u7684\u670d\u52a1\u6b63\u5e38\u5bf9\u5916\u8bbf\u95ee\u3002</p> <p>2\u3001\u96c6\u7fa4\u4e2d\u8fd8\u8fd0\u884c\u4e86\u4e00\u4e2a <code>dns-controller</code>,\u662f\u4e00\u4e2a\u548c <code>istio</code> \u6709\u5173\u7684\u63a7\u5236\u5668\u3002</p> <p>\u7528\u4e8e\u8de8\u96c6\u7fa4\u7684 <code>dns</code> \u53d1\u73b0\u7b49\u3002\u5728\u8fd9\u91cc\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u5bf9 <code>mesh</code> \u7684\u57df\u540d\u505a\u4e86 <code>CNAME</code> \u7c7b\u4f3c\u7684\u64cd\u4f5c\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5728\u547d\u540d\u7a7a\u95f4 abc \u4e2d\u8fd0\u884c\u7740\u670d\u52a1 <code>service-api</code>, \u9ed8\u8ba4\u8bbf\u95ee\u57df\u540d\u4e3a <code>service-api.abc</code>,\u5728 istio \u4e2d\u9700\u8981\u5b9e\u73b0\u80fd\u591f\u901a\u8fc7 <code>service-api.hello</code> \u8bbf\u95ee\u3002\u4e8e\u662f\u8be5 controller \u5728\u7a7a\u95f4\u5185\u751f\u6210\u4e86\u670d\u52a1\u5bf9\u5e94\u7684 <code>serviceentry</code> \u7528\u4e8e <code>\u201cCNAME\u201d</code>\u3002</p> <p>\u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f</p> <p>\u56e0\u4e3a istio \u9ed8\u8ba4\u4e0d\u9650\u5236 mesh \u5bf9\u516c\u7f51\u7684\u8bbf\u95ee\uff0c\u800c\u4e14\u5728\u6b63\u5e38\u7684\u96c6\u7fa4\u4e2d\u4e5f\u65e0\u9700\u8fd9\u4e2a\u914d\u7f6e\u3002</p> <p>\u5728\u8fd9\u4e4b\u524d\uff0c\u7531\u4e8e\u9ed8\u8ba4 <code>sidecar</code> \u83b7\u53d6\u5168\u5c40\u7684 <code>mesh</code> \u914d\u7f6e\u5bfc\u81f4 <code>sidecar</code> \u5185\u5b58\u5360\u7528\u8d85 1GB\u3002\u6211\u4eec\u8fd8\u4f7f\u7528\u4e86 <code>sidecar</code> \u5c06\u914d\u7f6e\u9650\u5236\u5728\u5f53\u524d\u4e00\u4e2a\u7a7a\u95f4\u5185\u4ee5\u51cf\u5c11 <code>sidecar</code> \u5360\u7528\u3002</p> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: Sidecar\nspec:\n  egress:\n    - hosts:\n        - ./*\n</code></pre>"},{"location":"chap9/3Istio_service_entry/#3","title":"3\u3001\u5c1d\u8bd5\u89e3\u51b3","text":"<p>\u5728\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u51e0\u4e2a\u65b9\u5411\uff1a</p> <ul> <li>\u6709\u53cd\u9988\u8bf4 serviceentry \u6ca1\u6709\u52a0\u4e0a\u3002\u4e5f\u5c31\u662f\u4e0a\u9762\u8bf4\u7684\u5bf9\u516c\u7f51\u8bbf\u95ee\u7684 <code>serviceentry</code>\u3002\u4e5f\u5c1d\u8bd5\u589e\u52a0\u4e86\u5bf9\u5e94\u57df\u540d\u7684 <code>serviceentry</code>\uff0c\u95ee\u9898\u4f9d\u7136\u5b58\u5728\u3002\u4f46\u8fd9\u6bd4\u4e4b\u524d\u597d\u4e00\u70b9\uff0c\u88ab\u6dfb\u52a0\u7684\u57df\u540d\u80fd\u591f\u6210\u529f\u8bbf\u95ee\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761\u8def\u6709\u6548\uff0c\u4f46\u53c8\u4e0d\u5b8c\u5168\u6709\u6548\u3002\u7b2c\u4e00\u4e2a\u95ee\u9898\u4f9d\u65e7\u6ca1\u6709\u88ab\u89e3\u7b54\u3002</li> <li>\u65b0\u5f00\u4e86\u4e00\u4e2a\u7a7a\u95f4 <code>istio-demo</code> \u5e76\u90e8\u7f72\u4e86 <code>book-info</code> \u793a\u4f8b\u7a0b\u5e8f\u3002\u5728\u90e8\u7f72\u6210\u529f\u7684\u793a\u4f8b\u7a0b\u5e8f\u4e2d\uff0c\u4e5f\u5b58\u5728\u4e0a\u8ff0\u95ee\u9898\u3002</li> </ul> <p>\u5728\u540e\u6765\u7684 debug \u4e2d\uff0c\u6211\u4eec\u5728 pod \u4e2d\u5c1d\u8bd5\u5efa\u7acb tls \u8fde\u63a5\uff1a</p> <p>\u9664\u4e86\u76f4\u63a5\u5728\u63e1\u624b\u9636\u6bb5\u5c31\u88ab\u670d\u52a1\u7aef\u5173\u95ed\u8fde\u63a5\u7684\u60c5\u51b5\u5916\uff0c\u8fd8\u9047\u5230\u4e86\uff1a</p> <pre><code>$ curl https://baidu.com\nSSL: certificate subject name '*.example.com' does not match target host name 'baidu.com'\n</code></pre> <p>\u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff1a<code>'*.example.com'</code>\u662f\u54ea\u91cc\u6765\u7684\uff1f\u6709\u4e2d\u95f4\u4eba\u5417\uff1f\u4e2d\u95f4\u4eba\u662f\u8c01\uff0c\u8bc1\u4e66\u5728\u54ea\u91cc\u914d\u7f6e\u7684\uff1f</p>"},{"location":"chap9/3Istio_service_entry/#4","title":"4\u3001\u8f6c\u6298\u70b9","text":"<p>\u56e0\u4e3a\u95ee\u9898\u51fa\u73b0\u4e8e https \u65e0\u6cd5\u5efa\u7acb\u8fde\u63a5\uff0c\u6240\u4ee5\u65b9\u5411\u4e00\u76f4\u88ab\u5f15\u5411\u4e86 tls \u4ee3\u7406\u4e4b\u7c7b\u7684\u95ee\u9898\u3002</p> <p>\u76f4\u5230\uff1a</p> <pre><code>$ curl -k  https://baidu.com\n404 page not found\n</code></pre> <p>\u8fd9\u91cc\u662f\u8bbf\u95ee\u7684\u4f17\u6240\u5468\u77e5\u7684\u57df\u540d\uff0c\u4e3a\u4ec0\u4e48\u8fd4\u56de\u4e86 \"404 page not found\"\uff1f\u8fd9\u4e2a\u54cd\u5e94\u8bf4\u660e\u4e86\u8be5\u54cd\u5e94\u5e94\u8be5\u6765\u81ea\u4e8e\u67d0\u4e2a\u5185\u90e8 golang \u8bed\u8a00\u7f16\u5199\u7684\u670d\u52a1\u3002</p> <p>\u5728\u8bbf\u95ee\u5176\u4ed6 https \u57df\u540d\u4e5f\u6709\u540c\u6837\u7684\u6548\u679c\uff0c\u4f3c\u4e4e\u6240\u6709 https \u8bbf\u95ee\u90fd\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u5185\u90e8\u7684\u670d\u52a1\u3002</p> <p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u90fd\u662f\u4f7f\u7528\u5230\u7684 istio proxy-status \u547d\u4ee4\u6765\u67e5\u770b sidecar \u914d\u7f6e\u6ce8\u5165\u72b6\u6001\uff0c\u4e5f\u672a\u89c1\u660e\u663e\u5f02\u5e38\u3002</p> <p>\u65e0\u5948\u4e4b\u4e0b\uff0c\u6211\u5c1d\u8bd5\u4f7f\u7528\u4e86 <code>istioctl proxy-config</code> \u67e5\u770b <code>sidecar</code> \u914d\u7f6e\uff0c\u4e5f\u5c31\u662f <code>envoy</code> \u7684\u914d\u7f6e\u3002</p> <pre><code>$istioctl proxy-config all sample-c59f744df-8kq7m.istio-demo\n...\n0.0.0.0        443   SNI: music.baidu.com             Cluster: outbound|443||music.baidu.com\n0.0.0.0        443   SNI: i.xiaoi.com                 Cluster: outbound|443||i.xiaoi.com\n0.0.0.0        443   ALL                              Cluster: outbound|443||traefik.cutom-name\n0.0.0.0        443   SNI: dict.baidu.com              Cluster: outbound|443||dict.baidu.com\n0.0.0.0        443   SNI: datarobotapi.bdia.com.cn    Cluster: outbound|443||datarobotapi.bdia.com.cn\n...\n</code></pre> <p>\u5728\u8fd9\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u4e2d\uff0c\u5728\u4e0a\u5343\u4e2a\u89c4\u5219\u4e2d\u53d1\u73b0\u4e86\u8fd9\u4e48\u4e00\u6761 <code>0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name</code>.</p> <p>\u76f4\u89c9\u5c31\u662f\u8fd9\u4e2a\u89c4\u5219\u6709\u95ee\u9898\u3002\u731c\u6d4b\u8fd9\u4e2a\u89c4\u5219\u7684\u5b58\u5728\u5c06\u5176\u5339\u914d\u7684 <code>443</code> \u7aef\u53e3 <code>ALL</code> \u7684\u6d41\u91cf\u8f6c\u53d1\u81f3\u4e86 <code>traefik.cutom-name</code>,\u8fd9\u4e2a <code>traefik.cutom-name</code> \u662f \u4e0a\u9762\u8bf4\u5230\u7684 <code>dns-controller</code>\u751f\u6210\u7684\u7528\u4e8e CNAME \u7684 <code>serviceentry</code>\u3002</p> <p>\u5982\u679c\u80fd\u591f\u8bc1\u660e<code>\"404 page not found\"</code>\u662f\u6765\u81ea <code>traefik</code> \u7684\uff0c\u90a3\u4e48\u5c31\u662f\u8fd9\u91cc\u7684\u95ee\u9898\u4e86\u3002\u4e8e\u662f\uff1a</p> <pre><code>$ curl -k -vvv https://baidu.com\n...\n* Server certificate:\n*   subject: ...=traefik...\n...\n404 page not found\n</code></pre> <p>\u5728 curl \u7ed9\u51fa\u7684 debug \u4fe1\u606f\u4e2d\u53d1\u73b0\u4e86\u670d\u52a1\u7aef\u4f7f\u7528\u7684 tls \u8bc1\u4e66\uff0csubject \u4e2d\u5305\u542b\u4e86 traefik \u7b49\u5b57\u6bb5\u3002\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e2a\u8bc1\u4e66\u662f traefik \u81ea\u7b7e\u53d1\u7684\u3002\u5b9e\u9524\u4e86\u8fd9\u4e2a\u540e\u7aef\u670d\u52a1\u5c31\u662f traefik\u3002</p> <p>\u53ef\u4ee5\u65ad\u5b9a\uff0c\u67d0\u4e2a\u9519\u8bef\u7684\u914d\u7f6e\u5bfc\u81f4\u751f\u6210\u4e86 <code>0.0.0.0:433 -&gt; traefik.cutom-name</code> \u7684\u6620\u5c04\u3002</p> <p>\u540e\u6765\u5728\u9605\u8bfb\u4e86 envoy \u7684\u6587\u6863LDS\u540e\uff0c\u89e3\u91ca\u4e86\u8fd9\u4e9b\u89c4\u5219\u7684\u7528\u9014\u3002</p> <p><code>0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name</code>\u8868\u793a\u5339\u914d\u6240\u6709 IP \u5730\u5740 &amp; 443 \u7aef\u53e3 &amp; \u6240\u6709 SNI \u7684\u6d41\u91cf\u5747 mesh \u5230\u76ee\u7684\u670d\u52a1 <code>traefik.cutom-name</code></p>"},{"location":"chap9/3Istio_service_entry/#5","title":"5\u3001\u9010\u6e10\u6e05\u6670","text":"<p>\u65e2\u7136\u548c <code>traefik.cutom-name</code> \u6709\u5173\uff0c\u4e5f\u5c31\u662f\u548c\u4e0a\u9762\u8bf4\u5230\u7684 <code>dns-controller</code> \u6709\u5173\uff0c\u548c\u5176\u751f\u6210\u7684 serviceentry \u6709\u5173\u3002\u4ee5\u5176\u4e2d\u4e00\u6761\u4e3e\u4f8b\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: ServiceEntry\nmetadata:\n  namespace: abc\n  name: traefik-cutom-name\nspec:\n  hosts:\n    - traefik.cutom-name\n  location: MESH_INTERNAL\n  ports:\n    - name: https-443\n      number: 443\n      protocol: TLS\n  resolution: DNS  \n</code></pre> <p><code>dns-controller</code> \u751f\u6210\u4e86\u4e0a\u8ff0\u7684 serviceentry\u3002\u4e4d\u770b\u8fd8\u672a\u5bdf\u89c9\u5230\u95ee\u9898\uff0c\u4f46\u80af\u5b9a\u6709\u95ee\u9898\u3002</p> <p>\u5728\u7ffb\u9605 ServiceEntry \u6587\u6863 \u540e\u3002\u6700\u7ec8\u53d1\u73b0\u95ee\u9898\uff1a</p> <p>\u6ca1\u6709\u8bbe\u7f6e <code>spec.addresses</code>\u3002</p> <p>\u5176\u8bbe\u7f6e\u4e3a <code>MESH_INTERNAL</code> \u4f46\u662f\u6ca1\u6709\u6307\u5b9a\u8be5 <code>service</code> \u7684\u540e\u7aef\u3002\u65e2\u6ca1\u6709\u6307\u5b9a\u5230\u671f\u671b\u670d\u52a1 DNS \u4e5f\u6ca1\u6709\u6307\u5b9a IP\u3002\u90a3\u4e48\u6b64\u65f6\u9ed8\u8ba4\u884c\u4e3a\u662f\uff0c\u5c06 <code>dns traefik.cutom-name</code> \u4f5c\u4e3a\u4e0a\u6e38\uff0c\u901a\u8fc7\u8be5 dns \u53bb\u53d1\u73b0\u670d\u52a1\u7684 <code>endpoint</code>\u3002</p> <p>\u7531\u4e8e\u66f4\u6539\u4e86 coredns \u7684\u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u6682\u65f6\u6ca1\u6709\u95ee\u9898\u3002</p> <p><code>envoy</code> \u6839\u636e\u8fd9\u90e8\u5206\u751f\u6210 <code>cluster</code> \u5e76\u914d\u7f6e\u4f7f\u7528 <code>DNS</code> \u4f5c\u4e3a <code>EDS</code>\u3002</p> <p>\u4f46\u5728\u6ca1\u6709\u8bbe\u7f6e <code>spec.addresses</code> \u65f6,\u8fd9\u4e2a <code>addresses</code> \u53ef\u4ee5\u586b\u5199 IP \u4e5f\u53ef\u586b\u5199 <code>endpoint</code> \u6240\u5728\u7684 <code>CIDR</code>\u3002envoy \u6839\u636e\u6b64\u90e8\u5206\u751f\u6210\u7684 <code>listene</code>r \u5219\u4f1a\u4f7f\u7528 <code>0.0.0.0</code> \u4f5c\u4e3a IP \u5730\u5740\u3002\u90a3\u8fd9\u4f1a\u4ea7\u751f\u4ec0\u4e48\u95ee\u9898\u5462\uff1f</p> <p>\u4e3e\u4e2a \ud83c\udf30 \u6817\u5b50\uff1a</p> <p>\u5982\u679c serviceentry A \u672a\u8bbe\u7f6e addresses \u5e76\u914d\u7f6e 443 \u7aef\u53e3\u670d\u52a1\uff0c\u90a3\u4e48\u5728 envoy \u751f\u6210 listener \u4e3a\uff1a<code>0.0.0.0:443 -&gt; service A</code>\u3002</p> <p>\u6b64\u65f6\u8bbf\u95ee <code>https://baidu.com</code> \u65f6\u5219\u4f1a\u5339\u914d\u5230\u8be5 <code>listener</code>\uff0c<code>envoy</code>\u5219\u5c06\u6570\u636e\u5305\u53d1\u5f80\u8be5\u670d\u52a1\u3002\u4e5f</p> <p>\u5c31\u4f1a\u6536\u5230 tls \u8bc1\u4e66\u4e0e\u9884\u671f\u4e0d\u4e00\u81f4\u7684\u7ed3\u679c\u3002\u540c\u7406\u6240\u6709\u4f7f\u7528 443 \u7aef\u53e3\u7684\u670d\u52a1\u4e5f\u4f1a\u5982\u6b64\u3002\u5982\u679c\u6709\u591a\u4e2a serviceentry \u90fd\u4f7f\u7528 443 \u7aef\u53e3\uff0c\u5219\u5728\u751f\u6210 listener \u65f6\u4f1a\u968f\u673a\u9009\u62e9\u4e86\u4e00\u4e2a\u670d\u52a1(\u8be5\u903b\u8f91\u7531 listio \u63a7\u5236)\u3002</p> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <ul> <li>\u6307\u5b9a address \u5230 k8s service clusterIP</li> <li>\u6307\u5b9a address \u5230 k8s service CIDR</li> </ul> <p>\u7531\u4e8e\u53ef\u4ee5\u76f4\u63a5\u62ff\u5230 service IP \u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u586b\u5199 service IP\u3002</p>"},{"location":"chap9/3Istio_service_entry/#6","title":"6\u3001\u89e3\u51b3","text":"<p>\u5728\u66f4\u6539\u63a7\u5236\u5668\u903b\u8f91\u540e\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: ServiceEntry\nmetadata:\n  name: traefik-cutom-name\n  namespace: abc\nspec:\n  addresses:\n    - &lt;service cluster IP&gt; # \u6307\u5b9a\u4e86 addresses,\u8be6\u60c5\u53c2\u770bistio\u6587\u6863\u3002\n  endpoints:\n    - address: traefik.abc\n  hosts:\n    - traefik.cutom-name\n  location: MESH_INTERNAL\n  ports:\n    - name: https-443\n      number: 443\n      protocol: TLS\n  resolution: DNS\n</code></pre> <p>\u518d\u6b21\u67e5\u770b config-dump</p> <pre><code>$istioctl proxy-config all sample-55c7969547-z92zk.istio-demo\n0.0.0.0        80    ALL                       PassthroughCluster\n0.0.0.0        443   ALL                       PassthroughCluster\n0.0.0.0        443   SNI: traefik.custom-name  Cluster: outbound|443||traefik.custom-name\n</code></pre> <p>\u89c4\u5219\u4e00\u5207\u6b63\u5e38\u3002<code>PassthroughCluster</code> \u662f\u4e00\u6761\u7279\u6b8a\u89c4\u5219\uff0c\u8868\u793a\u6d41\u91cf\u4e0d\u7ecf\u8fc7\u4fee\u6539\u76f4\u63a5\u51fa istio\u3002</p>"},{"location":"chap9/3Istio_service_entry/#7","title":"7\u3001\u590d\u76d8","text":"<p>\u597d\u7684\uff0c\u73b0\u5728 debug \u7684\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u51e0\u4e2a\u95ee\u9898\u4e5f\u5f97\u5230\u89e3\u51b3\u3002</p> <ul> <li>\u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 <code>serviceentry</code> \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f</li> </ul> <p>\u5728\u4e4b\u524d\u7684\u4f7f\u7528\u4e2d\uff0c\u7531\u4e8e\u8be5 bug \u7684\u5b58\u5728\uff0c\u4f7f\u5f97\u8bbf\u95ee\u5411\u516c\u7f51\u7684 https \u670d\u52a1\u5747\u88ab\u8f6c\u53d1\u5230\u4e86\u5185\u90e8\u67d0\u4e2a\u670d\u52a1\u3002\u6240\u4ee5\u65e0\u6cd5\u8bbf\u95ee\uff0c\u5728\u8fd9\u6837\u7684\u60c5\u51b5\u4e0b\u589e\u52a0 <code>MESH_EXTERNAL serviceentry</code> \u76f8\u5f53\u4e8e\u5728\u89c4\u5219\u4e2d\u589e\u52a0\u4e86\u7279\u6b8a\u5339\u914d\u7684\u89c4\u5219,\u4f7f\u5f97\u80fd\u591f\u5339\u914d\u6210\u529f\uff0c\u6d41\u91cf\u5f97\u4ee5\u51fa istio\u3002\u4e3e\u4f8b: <code>0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com</code></p> <p>\u5728\u8be5 bug \u4fee\u590d\u540e\uff0c\u4e0d\u518d\u9700\u8981\u5bf9\u516c\u7f51\u7684\u670d\u52a1\u505a\u914d\u7f6e\u4e86\u3002</p> <ul> <li><code>*.example.com'</code>\u662f\u54ea\u91cc\u6765\u7684\uff1f</li> </ul> <p><code>*.example.com</code> \u5b9e\u9645\u662f\u540e\u7aef\u67d0\u4e2a\u670d\u52a1\u4e0a\u4f7f\u7528\u7684\u8bc1\u4e66\uff0c\u7531\u4e8e\u9519\u8bef\u7684\u914d\u7f6e,\u6570\u636e\u5305\u9519\u8bef\u5206\u53d1\u3002\u5b9e\u9645\u6240\u6709\u7684 https \u5747\u8fde\u5230\u4e86\u8fd9\u4e2a\u9519\u8bef\u7684\u540e\u7aef\u3002</p> <ul> <li>\u4e3a\u4ec0\u4e48\u4e0d\u540c\u7684 pod \u4e0b\u8868\u73b0\u4e0d\u4e00\u81f4\uff0c\u6709\u7684\u63e1\u624b\u5931\u8d25\uff0c\u6709\u7684\u63d0\u793a\u8bc1\u4e66\u9519\u8bef\uff1f</li> </ul> <p>\u5728 sidecar \u914d\u7f6e\u7684\u8fc7\u7a0b\u4e2d\uff0c<code>0.0.0.0 443 ALL</code>\u8fd9\u6837\u7684\u89c4\u5219(<code>serviceentry</code>)\u4f1a\u6709\u591a\u4e2a\uff0c\u5728\u751f\u6210\u89c4\u5219\u7684\u65f6\u5019\uff0c\u4f1a\u5e76\u53d1\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u540e\u7aef\u4f5c\u4e3a\u8be5\u5730\u5740\u4e0a\u7684\u670d\u52a1\u3002\u5982\u679c\u8fde\u63a5\u5230\u4e86 mysql \u8fd9\u7c7b\u7684\u670d\u52a1\uff0c\u5219\u65e0\u6cd5\u63e1\u624b\u6210\u529f\u3002</p> <ul> <li>\u4e3a\u4ec0\u4e48\u672a\u6307\u5b9a address \u7684 serviceentry \u4f1a\u88ab\u5339\u914d\u5230 <code>0.0.0.0</code> \uff1f</li> </ul> <p>\u8fd9\u662f istio \u7684\u8003\u8651\uff0c\u5728\u7ffb\u770b\u6e90\u7801<code>conversion.go#L57</code>\u540e\u53d1\u73b0 <code>0.0.0.0</code> \u662f\u5176\u9ed8\u8ba4\u503c\u3002</p> <ul> <li>\u4e3a\u4ec0\u4e48\u5728\u6b64\u6b21\u5347\u7ea7\u540e\u624d\u53d1\u73b0\u95ee\u9898\uff1f * \u56e0\u4e3a sidecar \u914d\u7f6e\u7684\u5b58\u5728\u3002\u5728\u4e4b\u524d\u7684 istio \u4e5f\u5b58\u5728\u8be5\u95ee\u9898\uff0c\u53ea\u662f\u901a\u8fc7\u4e3a\u5916\u90e8 https \u8bbe\u7f6e serviceentry \u5f97\u4ee5\u89c4\u907f\u3002\u800c\u4e14\u8be5\u89c4\u5219\u5b58\u5728 default \u547d\u540d\u7a7a\u95f4\u5185\u3002\u5728\u5347\u7ea7\u540e\uff0c\u6211\u4eec\u5bf9\u7a7a\u95f4\u8bbe\u7f6e\u4e86 sidecar \u3002\u4f7f\u5f97 default \u7a7a\u95f4\u7684 serviceentry \u65e0\u6cd5\u4f20\u64ad\u5230\u5176\u4ed6\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5176\u4ed6\u7a7a\u95f4\u7684 https \u5747\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u540e\u7aef\u670d\u52a1\u3002</li> </ul>"},{"location":"chap9/4Istio_istio_skill/","title":"\u7b2c\u56db\u8282 \u4f7f\u7528 Istio \u7684\u5341\u4e2a\u6280\u5de7","text":""},{"location":"chap9/4Istio_istio_skill/#1-kubectl-sniff-wireshark","title":"1\u3001\u4f7f\u7528 Kubectl Sniff \u548c Wireshark","text":"<p>\u4e0d\u77e5\u9053\u5927\u5bb6\u6709\u6ca1\u6709\u542c\u8bf4\u8fc7 Wireshark\u3002Sniff \u63d0\u4f9b\u4e86\u4e00\u79cd\u62bd\u8c61\u6982\u5ff5\uff0c\u8ba9\u6211\u4eec\u53ef\u4ee5\u4fa6\u542c\u90a3\u4e9b\u901a\u8fc7 Wireshark \u8fdb\u5165\u79bb\u5f00 Istio \u4ee3\u7406\u7684\u6570\u636e\u5305\u3002</p> <p><code>Sniff</code> \u975e\u5e38\u9002\u5408\u4e8e\u5e95\u5c42\u5206\u6790\uff0c\u5b83\u53ef\u4ee5\u5c06\u95ee\u9898\u7684\u6839\u672c\u539f\u56e0\u9694\u79bb\u5230\u5e94\u7528\u7a0b\u5e8f\u7ea7\u548c Envoy \u7ea7\u3002</p> <p>\u9996\u5148\u901a\u8fc7 <code>global.proxy.privileged=true</code> \u5728 <code>IstioOperator CRD</code> \u4e0a\u542f\u7528\u7279\u6743\u6a21\u5f0f\uff0c\u7136\u540e\u5c06\u4ee5\u4e0b\u6ce8\u91ca\u6dfb\u52a0\u5230 <code>Deployment</code>\u3002</p> <p> </p> <p>\u5728 Wireshark \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6355\u6349 GRPC \u8bf7\u6c42\u5e76\u8fdb\u884c\u8fc7\u6ee4\uff0c\u7136\u540e\u901a\u8fc7\u8bf7\u6c42\u7684\u751f\u547d\u5468\u671f\u6765\u786e\u5b9a ingress \u548c egress\uff0c\u6700\u540e\u79fb\u690d\u672c\u5730\u670d\u52a1\uff0c\u4f7f\u7528 BloomRPC \u6216 Postman \u9694\u79bb\u8fde\u63a5\u95ee\u9898\u3002</p> <p> </p>"},{"location":"chap9/4Istio_istio_skill/#1-1-envoy","title":"1-1 \u9996\u5148\u4f7f\u7528 Envoy","text":"<p>\u901a\u8fc7\u5728 docker-compose \u6587\u4ef6\u4e2d\u8fd0\u884c Envoy \u4e86\u89e3\u5982\u4f55\u914d\u7f6e Envoy \u8fc7\u6ee4\u5668\u94fe\uff08filter chain\uff09\uff0c\u53ef\u4ee5\u66f4\u5bb9\u6613\u5730\u5bf9\u8bf7\u6c42\u955c\u50cf\u548c WASM \u7b49\u66f4\u6539\u8fdb\u884c\u539f\u578b\u6539\u53d8\uff08prototype change\uff09\u3002\u5728\u5c06 Envoy \u8f6c\u6362\u4e3a Istio \u914d\u7f6e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5bf9 Envoy \u8db3\u591f\u4e86\u89e3\u53ef\u4ee5\u63d0\u4f9b\u5f88\u591a\u5e2e\u52a9\u3002</p>"},{"location":"chap9/4Istio_istio_skill/#1-2","title":"1-2 \u8ba4\u771f\u9605\u8bfb\u53d1\u884c\u8bf4\u660e","text":"<p>\u5728\u4e4b\u524d\u7684 Istio \u5347\u7ea7\u8fc7\u7a0b\u4e2d\uff0c\u5f88\u591a\u4eba\u4e0d\u5c0f\u5fc3\u9519\u8fc7\u4e86\u4e00\u4e2a\u66f4\u6539\uff0c\u5373 Envoy \u72b6\u6001\u7aef\u53e3\u4fee\u6539\uff08<code>15020-&gt;15021</code>\uff09\u3002</p> <p> </p>"},{"location":"chap9/4Istio_istio_skill/#2-istio-operator-istioctl","title":"2\u3001\u5728 Istio Operator \u4e0a\u4f7f\u7528 Istioctl \u751f\u6210\u58f0\u660e\u6587\u4ef6","text":"<p>\u6700\u8fd1\u6709\u4eba\u4ece v1.6 \u5230 v1.7 \u8fdb\u884c\u4e86\u5347\u7ea7\uff0c\u5e76\u6ce8\u610f\u5230 Operator \u7531\u4e8e\u7ed3\u6784\uff08\u6807\u7b7e-&gt;\u5b9e\u7269\u6807\u7b7e\uff1aEnvoyFilter\uff09\u7684\u66f4\u6539\u800c\u65e0\u6cd5\u5b8c\u6210\u8c03\u534f\uff08reconciliation loop\uff09\uff0c\u5e0c\u671b Operator \u80fd\u591f\u4ee5\u5411\u540e\u517c\u5bb9\u7684\u65b9\u5f0f\u5904\u7406\u6b64\u5347\u7ea7\u3002\u751f\u6210\u7684\u58f0\u660e\u6587\u4ef6\u5f88\u5bb9\u6613\u901a\u8fc7 Istio Overlay API \u6216 Kustomize \u6765\u5904\u7406\u672a\u901a\u8fc7 Operator CRD \u516c\u5f00\u7684\u5b57\u6bb5\u3002</p> <p> </p> <p>\u627e\u5230\u793a\u4f8b\u58f0\u660e\u6587\u4ef6\u540e\uff0c\u786e\u8ba4\u793a\u4f8b\u4e0e\u4ee3\u7406\u5bb9\u5668\u4e2d\u7684 Envoy API/Protobuf \u7248\u672c\u5bf9\u9f50\u3002</p> <p> </p> <p>\u5982\u679c\u5c06 Istio Ingress Gateway \u7528\u4f5c GKE \u4e0a\u96c6\u7fa4\u7684 Ingress\uff0c\u5e76\u8981\u542f\u7528 HTTPS\uff0c\u8bf7\u5728 Istio Ingress Gateway \u670d\u52a1\u7684\u5355\u4e2a\u4e0a\u6e38\u8bbe\u7f6e\u4e00\u4e2a Ingress \u5bf9\u8c61\u3002</p> <p>\u6dfb\u52a0\u9759\u6001 IP \u8ba1\u7b97\u5730\u5740\uff08Static IP Compute Address\uff09\u3001\u8bc1\u4e66\u7ba1\u7406\uff08Managed Certificate\uff09\u548c BackendConfig\uff08\u8bbe\u7f6e\u8fd0\u884c\u72b6\u51b5\u68c0\u67e5\uff09\uff0c\u53ef\u4ee5\u65b9\u4fbf\u6211\u4eec\u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u5668\u63d0\u4f9b\u5b89\u5168\u8bbf\u95ee\u3002</p> <p>\u8bf7\u6c42\u955c\u50cf\u662f\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u8fdb\u884c\u6d4b\u8bd5\u7684\u6709\u529b\u624b\u6bb5\u3002</p> <p>\u5982\u679c\u5728\u5b89\u88c5\u4e2d\u542f\u7528\u4e86\u6b64\u529f\u80fd\uff0c\u4f46\u51fa\u73b0\u4e0b\u6e38\u670d\u52a1\u62d2\u7edd\u8bf7\u6c42\u7684\u60c5\u51b5\uff0c\u6ce8\u610f\u67e5\u770b\u4e3b\u673a\u5934\uff08Host Header\uff09\u3002Envoy \u5c06 <code>\u201c-shadow\u201d</code> \u9644\u52a0\u5230\u4e3b\u673a\u5934\u3002</p> <p>\u5982\u679c\u4f7f\u7528\u7684\u662f Vanilla Envoy\uff0c\u90a3\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u4fa6\u542c\u5668\u6765\u89e3\u51b3\u8be5\u95ee\u9898\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Istio \u6dfb\u52a0\u4e00\u4e2a\u5355\u72ec\u7684 Envoy \u90e8\u7f72\u6765\u91cd\u5199\u6807\u5934\u3002</p> <p>\u540c\u6837\uff0c\u5982\u679c\u8981\u4f7f\u7528<code>istio-ingressgateway</code> \u96c6\u7fa4\u955c\u50cf\u5728\u8fb9\u7f18\u5b9e\u73b0\u8bf7\u6c42\u955c\u50cf\uff0c\u8981\u5728 mesh \u865a\u62df\u670d\u52a1\u4e2d\u6dfb\u52a0\u672c\u5730\u670d\u52a1\u540d\u79f0\u548c\u5173\u952e\u5b57\u3002</p> <p> </p> <p>JWT \u9a8c\u8bc1\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6709\u8da3\u7684\u62bd\u8c61\u6982\u5ff5\uff0c\u5b83\u5141\u8bb8 service \u77e5\u9053\u5b83\u662f\u5426\u901a\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u3002</p> <p>\u4e0e\u201c\u9000\u51fa\uff08opt out\uff09\u201d\u57fa\u4e8e\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u6807\u7b7e\u65b9\u6848\u76f8\u6bd4\uff0c\u201c\u52a0\u5165\uff08opt in\uff09\u201d\u53ef\u80fd\u4f1a\u66b4\u9732\u7684\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684 service\u3002</p> <p>\u4f7f\u7528 <code>Open Policy Agent</code> \u4e4b\u7c7b\u7684\u5de5\u5177\u53ef\u4ee5\u5728\u5de5\u4f5c\u8d1f\u8f7d\u4e0a\u5f3a\u5236\u4f7f\u7528\u5fc5\u9700\u7684\u6807\u7b7e\uff0c\u4ee5\u786e\u4fdd\u6240\u6709 service \u4e0a\u90fd\u5e26\u6709\u8eab\u4efd\u9a8c\u8bc1\u6807\u7b7e\u3002</p> <p>GRPC JSON \u8f6c\u7801\u5668\u53ef\u4ee5\u5e2e\u52a9\u5de5\u7a0b\u5e08\u5c06\u7a0b\u5e8f\u4ee3\u7801\u4ece JSON \u8f6c\u7801\u4e3a GRPC\u3002</p> <p>\u4e0d\u8fc7\uff0c\u5c06\u90e8\u7f72\u66f4\u6539\u5230 proto descriptor \u7684\u8fc7\u7a0b\u6709\u4e9b\u7b28\u91cd\u3002\u6709\u79cd\u89e3\u51b3\u65b9\u6cd5\u662f\u7528 base64 \u7f16\u7801 proto descriptor \u5e76\u5c06\u5176\u4f5c\u4e3a secret \u5b89\u88c5\uff0c\u4f46\u7531\u4e8e\u5728 Protobuf \u5b9a\u4e49\u66f4\u6539\u65f6\uff0c\u9700\u8981\u5bf9\u4e8c\u8fdb\u5236\u6587\u4ef6\u8fdb\u884c base64 \u7f16\u7801\uff0c\u8fd9\u975e\u5e38\u9ebb\u70e6\uff0c\u56e0\u6b64\u8fd9\u79cd\u65b9\u6cd5\u4e0d\u592a\u597d\u3002\u6709\u79cd\u7a0d\u5fae\u597d\u4e00\u70b9\u7684\u65b9\u6cd5\u662f\u4f7f\u7528\u63cf\u8ff0\u7b26\uff08descriptor\uff09\u6784\u5efa\u5bb9\u5668\u955c\u50cf\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u5177\u6709\u5171\u4eab\u5185\u5b58\u91cf\u7684 initContainer \u8fd0\u884c\u3002\u5728 pod \u542f\u52a8\u540e\uff0cinitContainer \u4f1a\u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u5230\u5171\u4eab\u5377\u7a7a\u95f4\u4e2d\uff0c\u5e76\u4e14 Istio \u4ee3\u7406\u5bb9\u5668\u53ef\u4ee5\u8fdb\u884c\u8bbf\u95ee\u3002</p> <p> </p> <p>Envoy \u4e3a\u8fc7\u6ee4\u5668\uff08filter\uff09\u63d0\u4f9b\u4e86\u4e00\u79cd\u4fee\u6539\u865a\u62df\u4e3b\u673a\u7279\u5b9a\u914d\u7f6e\u7684\u65b9\u6cd5\u3002</p> <p>\u4ece Istio \u6765\u8bf4\uff0c\u8fd9\u610f\u5473\u7740\u53ef\u4ee5\u66f4\u6539\u7279\u5b9a\u865a\u62df\u4e3b\u673a\u8def\u5f84\u4e0a\u73b0\u6709\u8fc7\u6ee4\u5668\u529f\u80fd\u3002\u6b64\u529f\u80fd\u9002\u7528\u4e8e\u7279\u5b9a\u8fc7\u6ee4\u5668\uff0c\u4f46\u4e0d\u9002\u7528\u4e8e WASM \u7b49\u8fc7\u6ee4\u5668\u3002</p>"},{"location":"chap9/5istio_interview/","title":"\u7b2c\u4e94\u8282 Istio\u9762\u8bd5","text":""},{"location":"chap9/5istio_interview/#_1","title":"\u4f20\u7edf\u6846\u67b6\u7ec4\u4ef6\u5b58\u5728\u7684\u95ee\u9898","text":"<ul> <li>\u5404\u79cd\u57fa\u7840\u7ec4\u4ef6\u7ef4\u62a4\u6210\u672c\u6bd4\u8f83\u9ad8\uff0c\u5355\u70b9\u98ce\u9669\u5b58\u5728\u3002</li> <li>\u5404\u8bed\u8a00\u5ba2\u6237\u7aef\u7279\u6027\u96be\u4ee5\u7edf\u4e00\uff0c\u7194\u65ad\u3001\u91cd\u8bd5\u7b49\u7279\u6027\u5b9e\u73b0\u9887\u6709\u4e0d\u540c\uff0c\u4e14\u4e0d\u80fd\u505a\u5230\u52a8\u6001\u7ebf\u4e0a\u8fdb\u884c\u8c03\u6574\u3002</li> <li>\u5ba2\u6237\u7aef\u7248\u672c\u8fed\u4ee3\u96be\u4ee5\u63a8\u52a8\u3002</li> <li>\u5fae\u670d\u52a1\u67d0\u4e9b\u80fd\u529b\u4e0a\u8ddf\u5176\u4ed6\u5927\u5382\u8fd8\u6709\u5dee\u8ddd\u3002</li> <li>\u4e0e\u793e\u533a\u3001\u4e91\u539f\u751f\u8ddd\u79bb\u8f83\u8fdc\uff0c\u914d\u5408\u5e38\u89c1\u7684\u5f00\u6e90\u9879\u76ee\u7d27\u5bc6\u5ea6\u8f83\u5dee\u3002</li> </ul>"},{"location":"chap9/5istio_interview/#service-mesh","title":"Service Mesh \u53ef\u4ee5\u5f88\u597d\u7684\u89e3\u51b3\u4e0a\u9762\u7684\u8fd9\u4e9b\u95ee\u9898\uff1a","text":"<ul> <li>\u63d0\u5347\u5fae\u670d\u52a1\u6cbb\u7406\u80fd\u529b\uff0c\u89c4\u8303\u7684\u5f15\u5165\u7cbe\u51c6\u7684\u7194\u65ad\u3001\u9650\u6d41\u3001\u6d41\u91cf\u7ba1\u7406\u7b49\u624b\u6bb5\u3002</li> <li>\u51cf\u5c11\u5ba2\u6237\u7aef\u7ef4\u62a4\u3001\u8fed\u4ee3\u7684\u6295\u5165\u3002</li> <li>\u63d0\u5347\u670d\u52a1\u95f4\u901a\u4fe1\u901f\u5ea6\u3002</li> <li>\u5177\u5907\u6545\u969c\u6ce8\u5165\u80fd\u529b\u3002</li> <li>\u5177\u5907\u52a8\u6001\u670d\u52a1\u8def\u7531\u8c03\u6574\u7684\u80fd\u529b\u3002</li> </ul>"},{"location":"chap9/5istio_interview/#istio_1","title":"\u8fc1\u79fb\u5230Istio\u7684\u57fa\u672c\u8981\u6c42","text":"<ul> <li>\u4fdd\u8bc1\u4e1a\u52a1\u65e0\u611f\u77e5\u8fc1\u79fb\uff0c\u4e0d\u53d8\u66f4\u4ee3\u7801</li> <li>\u4fdd\u8bc1\u53ef\u56de\u6eda</li> <li>\u4fdd\u8bc1\u9ad8\u53ef\u7528</li> <li>\u4fdd\u8bc1\u6027\u80fd\u65e0\u660e\u663e\u4e0b\u6ed1</li> <li>\u4fdd\u8bc1 Mesh \u5185\u7684\u670d\u52a1\u548c\u539f\u670d\u52a1\u53ef\u4ee5\u4e92\u76f8\u8bbf\u95ee</li> </ul>"},{"location":"chap9/5istio_interview/#istio_2","title":"\u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8","text":"<ul> <li>\u670d\u52a1\u7f51\u683c\u5982\u4f55\u5e2e\u52a9\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u903b\u8f91: \u5c06\u903b\u8f91\u5206\u79bb\u5230\u57fa\u7840\u5b9e\u65bd\u5c42</li> <li>\u4ece\u5b8f\u89c2\u4e0a\u770b\uff0cIstio\u670d\u52a1\u7f51\u683c\u7531\u54ea\u4e24\u90e8\u5206\u7ec4\u6210: \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762</li> <li>\u670d\u52a1\u7f51\u683c\u7684\u4ee3\u7406\u4e5f\u53eb\u505a\u4ec0\u4e48: Sidecar</li> <li>Istio\u4e2d\u7684\u54ea\u4e2a\u7ec4\u4ef6\u53ef\u4ee5\u5c06YAML\u89c4\u5219\u8f6c\u6362\u4e3aEnvoy\u914d\u7f6e: Istiod</li> <li>\u4ece\u4e0b\u9762\u7684\u5217\u8868\u4e2d\u9009\u51fa\u5fae\u670d\u52a1\u67b6\u6784\u7684\u4e24\u4e2a\u597d\u5904\uff1f: \u53ef\u4f38\u7f29\u6027 &amp; \u66f4\u5c0f\u7684\u56e2\u961f</li> </ul>"},{"location":"chap9/5istio_interview/#_2","title":"\u4e3a\u4ec0\u4e48\u9700\u8981\u670d\u52a1\u7f51\u683c","text":"<ul> <li>\u4f7f\u7528\u6307\u6807\u8bc6\u522b\uff0c\u6027\u80fd\u548c\u53ef\u9760\u6027\u95ee\u9898</li> <li>\u5728Grafana\u7b49\u5de5\u5177\u4e2d\u5b9e\u73b0\u6307\u6807\u7684\u53ef\u89c6\u5316\uff1b\u8fd9\u8fdb\u4e00\u6b65\u5141\u8bb8\u6539\u53d8\u5e76\u4e0ePagerDuty\u6574\u5408</li> <li>\u4f7f\u7528Jaeger\u6216Zipkin\u5bf9\u670d\u52a1\u8fdb\u884c\u8c03\u8bd5\u548c\u8ffd\u8e2a</li> <li>\u57fa\u4e8e\u6743\u91cd\u548c\u8bf7\u6c42\u7684\u6d41\u91cf\u8def\u7531\uff0c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0cA/B\u6d4b\u8bd5</li> <li>\u6d41\u91cf\u955c\u50cf</li> <li>\u901a\u8fc7\u8d85\u65f6\u548c\u91cd\u8bd5\u63d0\u9ad8\u670d\u52a1\u7684\u5f39\u6027</li> <li>\u901a\u8fc7\u5728\u670d\u52a1\u4e4b\u95f4\u6ce8\u5165\u6545\u969c\u548c\u5ef6\u8fdf\u6765\u8fdb\u884c\u6df7\u6c8c\u6d4b\u8bd5</li> <li>\u68c0\u6d4b\u548c\u5f39\u51fa\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u5b9e\u4f8b\u7684\u65ad\u8def\u5668\u3002</li> </ul>"},{"location":"chap9/5istio_interview/#istlo","title":"Istlo\u7b80\u4ecb","text":"<p>Istio\u662f\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\u7684\u5f00\u6e90\u5b9e\u73b0\u3002\u4ece\u5b8f\u89c2\u4e0a\u6765\u770bIstio\u652f\u6301\u4ee5\u4e0b\u529f\u80fd\u3002</p> <ul> <li>\u6d41\u91cf\u7ba1\u7406</li> <li>\u53ef\u89c2\u5bdf\u6027</li> <li>\u5b89\u5168\u6027</li> </ul>"},{"location":"chap9/5istio_interview/#istio_3","title":"Istio\u7ec4\u4ef6","text":"<p>\u6570\u636e\u5e73\u9762\uff1a</p> <p>\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531\u8d1f\u8d23\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u53d1\u73b0\u3001\u5065\u5eb7\u68c0\u67e5\u548c\u6388\u6743/\u8ba4\u8bc1\u7684Envoy\u4ee3\u7406\u3002\u8fd9\u4e9b\u4ee3\u7406\u6bcf\u4e2a\u5b9e\u4f8b\u670d\u52a1\u5b9e\u4f8b\u8981\u8fb9\u8fd0\u884c\uff0c\u62e6\u622a\u6240\u6709\u4f20\u5165\u548c\u4f20\u51fa\u7684\u7528\u6237\u6d41\u91cf</p> <p>Envoy (data plane)</p> <ul> <li>High-performance proxy (C++)</li> <li>Injected next to application containers</li> <li>Intercepts all traffic for the service</li> <li>Pluggable extension model based on WebAssembly</li> </ul> <p>\u63a7\u5236\u5e73\u9762\uff1a</p> <p>\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\u914d\u7f6e\u5e76\u63a7\u5236\u6570\u636e\u5e73\u9762\u3002</p> <p>\u5b83\u7531API\u548c\u5de5\u5177\u7ec4\u6210\u7528\u4e8e\u7ba1\u7406\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002</p> <p>\u670d\u52a1\u7f51\u683c\u8fd0\u7ef4\u53ef\u4ee5\u8bbf\u95ee\u63a7\u5236\u5e73\u9762\u4ee5\u914d\u7f6e\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002\u4f8b\u5982\uff0c\u5c06\u6d41\u91cf\u914d\u7f6e\u5e94\u7528\u4e8e\u63a7\u5236\u5e73\u9762\u7ffb\u8bd1\u914d\u7f6e\u5e76\u5c06\u5176\u63a8\u9001\u5230\u6570\u636e\u5e73\u9762</p> <p>Istiod (control plane)</p> <ul> <li>Service discovery</li> <li>Configuration</li> <li>Certificate management</li> <li>Converts YAML to Envoy-readable configuration<ul> <li>propagates it to all sidecars in the mesh</li> </ul> </li> </ul> <p>Envoy\uff1a</p> <p>Envoy\u4ee3\u7406\u662f\u4e2a\u73b0\u4ee3\u7684\u3001\u9ad8\u6027\u80fd\u8fb9\u7f18\u7684\u3001\u5c0f\u578b\u7684L7\u4ee3\u7406\u3002Envoy\u662f\u4e3a\u5927\u578b\u73b0\u4ee3\u9762\u5411\u670d\u52a1\u67b6\u6784\u8bbe\u8ba1\u7684\u3002\u5b83\u53ef\u4ee5\u4e0eNginx\u548cHAproxy\u7b49\u8f6f\u4ef6\u8d1f\u622a\u5747\u8857\u5668\u76f8\u5ab2\u7f8e\u3002</p>"},{"location":"chap9/5istio_interview/#_3","title":"\u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7","text":"<p>Istio\u751f\u6210\u4e09\u79cd\u7c7b\u578b\u7684\u9065\u6d4b\u6570\u636e\uff0c\u4e3a\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b\u53ef\u89c2\u5bdf\u6027\uff1a</p> <ul> <li>\u6307\u6807\u5ea6\u91cf\uff08Metric)</li> <li>\u5206\u5e03\u5f0f\u8ffd\u8e2a</li> <li>\u8bbf\u95ee\u65e5\u5fd7</li> </ul> <p>\u6307\u6807</p> <p>Istlo\u57fa\u4e8e\u56db\u4e2a\u9ec4\u91d1\u4fe1\u53f7\u751f\u6210\u6307\u6807\uff1a\u5ef6\u8fdf\u3001\u6d41\u91cf\u3001\u9519\u8bef\u548c\u9971\u548c\u5ea6\u3002</p> <ul> <li>Latency: the time it takes to service a request</li> <li>Traffic: how much demand is placed on the system</li> <li>Errors: rate of failed requests</li> <li>Saturation: how full the most constrained resources of service are</li> </ul> <p>Zipkin\uff1a Trace and spans</p> <ul> <li>Trace: collection of spans</li> <li>Span: name, start/finish timestamp, tags, context</li> <li>Tags: applied to all spans, used for querying/filtering</li> <li>Spans are sent to the collector to validate, index &amp; store the data</li> </ul> <p>Distributed Tracing with Zipkin</p> <ul> <li>Zipkin = distributed tracing system</li> <li>Discover latency and performance issues</li> <li>Requirements: propagate HTTP headers (B3 and Envoy request ID)<ul> <li>Traces captured at service boundaries</li> </ul> </li> <li> <p>Instrument your applications</p> </li> <li> <p>Prometheus\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684\uff1a\u8bb0\u5f55\u6307\u6807\uff0c\u8ddf\u8e2aIstio\u548c\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5</p> </li> <li>\u4ec0\u4e48\u662fZipkin\uff1a \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf</li> <li>\u4ec0\u4e48\u662fKiali\uff1a Istio\u53ef\u89c2\u6d4b\u6027\u9762\u677f</li> <li>Istio\u4f9d\u9760\u54ea\u4e9b\u5934\u4fe1\u606f\u6765\u8fdb\u884c\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1a B3 header\u548cEnvoy requestID</li> <li>\u4ec0\u4e48\u662fGrafana\uff1a Prometheus\u548c\u5176\u4ed6\u6765\u6e90\u7684\u6570\u636e\u7684\u53ef\u89c6\u5316\u5e73\u53f0</li> </ul>"},{"location":"chap9/5istio_interview/#_4","title":"\u6d41\u91cf\u7ba1\u7406","text":""},{"location":"chap9/5istio_interview/#gateway","title":"\u4f7f\u7528Gateway","text":"<ul> <li>\u4f7f\u7528\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u8fdb\u5165\u96c6\u7fa4\u7684\u6d41\u91cf\u5e94\u7528\u8def\u7531\u89c4\u5219\u3002\u6211\u4eec\u53ef\u4ee5\u6709\u4e00\u4e2a\u6307\u5411\u5165\u53e3\u7f51\u5173\u7684\u5355\u4e00\u5916\u90e8IP\u5730\u5740\uff0c\u5e76\u6839\u636e\u4e3b\u673a\u5934\u5c06\u6d41\u91cf\u8def\u7531\u5230\u96c6\u7fa4\u5185\u7684\u4e0d\u540c\u670d\u52a1\u3002</li> <li>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528Gateway\u8d44\u6e90\u6765\u914d\u7f6e\u7f51\u5173\u3002\u7f51\u5173\u8d44\u6e90\u63cf\u8ff0\u4e86\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u66b4\u9732\u7aef\u53e3\u3001\u534f\u8bae\u3001SNI \uff08\u670d\u52a1\u5668\u540d\u79f0\u6307\u793a\uff09\u914d\u7f6e\u7b49\u3002</li> </ul> <p><code>kind: Gateway</code></p>"},{"location":"chap9/5istio_interview/#_5","title":"\u7b80\u5355\u8def\u7531","text":"<ul> <li>\u4f7f\u7528VirtualService\u8d44\u6e90\u5728Istio\u670d\u52a1\u7f51\u683c\u4e2d\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002</li> <li>\u76ee\u7684\u5730\u6307\u7684\u662f\u4e0d\u540c\u7684\u5b50\u96c6\uff08subset\uff09\u6216\u670d\u52a1\u7248\u672c\u3002\u901a\u8fc7\u5b50\u96c6\uff0c\u6211\u4eec\u53ef\u4ee5\u8bc6\u522b\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u53d8\u4f53\u3002</li> <li> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u540d\u4e3aDestinationRule\u7684\u8d44\u6e90\u7c7b\u578b\u4e2d\u58f0\u660e\u5b50\u96c6,  Destination Rule\u4e2d\u7684\u6d41\u91cf\u7b56\u7565\u3002</p> <ul> <li>\u6211\u4eec\u53ef\u4ee5\u5728<code>trafficPolicy</code>\u5b57\u6bb5\u4e0b\u8bbe\u7f6e\u6d41\u91cf\u7b56\u7565\u8bbe\u7f6e: <code>kind: DestinationRule</code><ul> <li>Load balancer settings</li> <li>Connection pool settings</li> <li>Outlier detection</li> <li>Client TLS settings</li> <li>Port traffic policy</li> </ul> </li> </ul> </li> <li> <p>Load balancer settings</p> </li> </ul> <pre><code>trafficPolicy:\n   loadBalancer:\n    simple: ROUND_ROBIN\n</code></pre> <ul> <li>Connection pool settings</li> </ul> <pre><code>trafficPolicy:\n   connectionPool:\n    http:\n     http2MaxRequests: 50\n</code></pre> <ul> <li>\u5f02\u5e38\u70b9\u68c0\u6d4b</li> </ul> <p>\u5982\u679c\u4e00\u4e2a\u4e3b\u673a\u5f00\u59cb\u8fd4\u56de5xx HTTP\u9519\u8bef\uff0c\u5b83\u5c31\u4f1a\u5728\u9884\u5b9a\u7684\u65f6\u95f4\u5185\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\u3002\u5bf9\u4e8eTCP\u670d\u52a1\uff0cEnvoy\u5c06\u8fde\u63a5\u8d85\u65f6\u6216\u5931\u8d25\u8ba1\u7b97\u4e3a\u9519\u8bef\u3002</p> <ul> <li>\u5ba2\u6237\u7aefTLS\u8bbe\u7f6e<ul> <li>\u5176\u4ed6\u652f\u6301\u7684TLS\u6a21\u5f0f\u6709DISABLE\uff08\u6ca1\u6709TLS\u8fde\u63a5\uff09,</li> <li>SIMPLE\uff08\u5728\u4e0a\u6e38\u7aef\u70b9\u53d1\u8d77TLS\u8fde\u63a5,\uff09</li> <li><code>ISTIO_MUTUAL</code>\uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09</li> </ul> </li> </ul> <pre><code>trafficPolicy:\n  tls:\n   mode: MUTUAL\n   clientCertificate: /etc/certs/cert.pem\n   privateKey: /etc/certs/key.pem\n   caCertificates: /etc/certs/ca.pem\n</code></pre> <ul> <li>\u7aef\u53e3\u6d41\u91cf\u7b56\u7565</li> </ul> <pre><code>trafficPolicy:\n  portLevelSettings:\n  - port:\n    number: 80\n   loadBalancer:\n    simple: LEAST_CONN\n</code></pre> <ul> <li>\u5f39\u6027</li> </ul> <p>\u8fd9\u4e0d\u662f\u4e3a\u4e86\u907f\u514d\u6545\u969c\uff0c\u800c\u662f\u4ee5\u4e00\u79cd\u6ca1\u6709\u505c\u673a\u6216\u6570\u636e\u4e22\u5931\u7684\u65b9\u5f0f\u6765\u5e94\u5bf9\u6545\u969c\u3002\u5f39\u6027\u7684\u76ee\u6807 \u662f\u5728\u6545\u969c\u53d1\u751f\u540e\u5c06\u670d\u52a1\u6062\u590d\u5230\u4e00\u4e2a\u5b8c\u5168\u6b63\u5e38\u7684\u72b6\u6001</p> <ul> <li>Timeouts</li> <li>Retry policies</li> <li>Configurable on VirtualService</li> <li>Retries<ul> <li>Number of retries</li> <li>Timeout per try</li> <li>Conditions to retry o</li> </ul> </li> </ul> <p>\u4f7f\u670d\u52a1\u53ef\u7528\u7684\u4e00\u4e2a\u5173\u952e\u56e0\u7d20\u662f\u5728\u63d0\u51fa\u670d\u52a1\u8bf7\u6c42\u65f6\u4f7f\u7528\u8d85\u65f6\uff08timeout\uff09\u548c\u91cd\u8bd5\uff08retry\uff09\u7b56\u7565\u3002 \u6211\u4eec\u53ef\u4ee5\u5728Istio\u7684VirtualService\u4e0a\u914d\u7f6e\u8fd9\u4e24\u8005\u3002</p> <pre><code>...\n- route:\n  - destination:\n    host: customers.default.svc.cluster.local\n    subset: v1\n  timeout: 10s\n</code></pre> <p>\u91cd\u8bd5\u7b56\u7565</p> <pre><code>...\n- route:\n  - destination:\n    host: customers.default.svc.cluster.local\n    subset: v1\n  retries:\n   attempts: 10\n   perTryTimeout: 2s\n   retryOn: connect-failure,reset\n...\n</code></pre> <p>\u4e0a\u8ff0\u91cd\u8bd5\u7b56\u7565\u5c06\u5c1d\u8bd5\u91cd\u8bd5\u4efb\u4f55\u8fde\u63a5\u8d85\u65f6\uff08connect-failure)\u6216\u670d\u52a1\u5668\u5b8c\u5168\u4e0d\u54cd\u5e94 (reset)\u7684\u5931\u8d25\u8bf7\u6c42\u3002\u6211\u4eec\u5c06\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a2\u79d2\uff0c\u5c1d\u8bd5\u7684\u6b21\u6570\u8bbe\u7f6e\u4e3a10\u6b21\u3002</p> <ul> <li> <p>\u6545\u969c\u6ce8\u5165</p> <ul> <li>\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u6545\u969c\u6ce8\u5165\u3002<ul> <li>\u6211\u4eec\u53ef\u4ee5\u5728\u8f6c\u53d1\u524d\u5ef6\u8fdf\uff08delay\uff09\u8bf7\u6c42\uff0c\u6a21\u62df\u7f13\u6162\u7684\u7f51\u7edc\u6216\u8fc7\u8f7d\u7684\u670d\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u4e2d\u6b62\uff08abort) HTTP\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u7279\u5b9a\u7684HTTP\u9519\u8bef\u4ee3\u7801\u7ed9\u8c03\u7528\u8005\u3002</li> <li>\u53ef\u9009\u7684\u5ef6\u8fdf</li> </ul> </li> </ul> </li> </ul> <pre><code>- route:\n  - destination:\n    host: customers.default.svc.cluster.local\n    subset: v1\n  fault:\n   abort:\n    percentage:\n     value: 30\n    httpStatus: 404\n</code></pre> <pre><code> fault:\n   delay:\n    percentage:\n     value: 5\n    fixedDelay: 3s\n</code></pre>"},{"location":"chap9/5istio_interview/#_6","title":"\u9ad8\u7ea7\u8def\u7531","text":"<p>Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528\u4f20\u5165\u8bf7\u6c42\u7684\u4e00\u90e8\u5206\uff0c\u5e76\u5c06\u5176\u4e0e\u5b9a\u4e49\u7684\u503c\u76f8\u5339\u914d\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u5339\u914d\u4f20\u5165\u8bf7\u6c42\u7684URI\u524d\u7f00\uff0c\u5e76\u57fa\u4e8e\u6b64\u8def\u7531\u6d41\u91cf\u3002</p> <ul> <li>\u91cd\u5b9a\u5411\u548c\u91cd\u5199\u8bf7\u6c42</li> </ul> <pre><code>...\nhttp:\n  - match:\n   - headers:\n     my-header:\n      exact: hello\n   redirect:\n    uri: /hello\n    authority: my-service.default.svc.cluster.local:8000\n...\n</code></pre>"},{"location":"chap9/5istio_interview/#serviceentry","title":"ServiceEntry","text":"<p>\u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002</p> <ul> <li>Add entries to Istio's service registry</li> <li>Use traffic routing, failure injection, and other features against external services</li> </ul> <p><code>kind: ServiceEntry</code></p> <pre><code>hosts:\n   - api.external-svc.com\n  ports:\n   - number: 443\n    name: https\n    protocol: TLS\n  resolution: DNS\n  location: MESH_EXTERNAL\n</code></pre>"},{"location":"chap9/5istio_interview/#workloadentry","title":"WorkloadEntry","text":"<ul> <li>Handle migration of VM workloads to Kubernetes</li> <li>Specify VM workloads and make them part of Istio's service registry</li> </ul> <p>\u5728<code>Workload Entry</code>\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ec6\u8282\uff08\u540d\u79f0\u3001\u5730\u5740\u3001\u6807\u7b7e\uff09\uff0c\u7136\u540e\u4f7f\u7528<code>ServiceEntry</code>\u4e2d\u7684<code>workloadSelector</code>\u5b57\u6bb5\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206\u3002</p>"},{"location":"chap9/5istio_interview/#sidecar","title":"Sidecar","text":"<p>Sidecar\u8d44\u6e90\u7531\u4e09\u90e8\u5206\u7ec4\u6210\uff0c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u3001\u4e00\u4e2a\u5165\u53e3\uff08ingress)\u76d1\u542c\u5668\u548c\u4e00\u4e2a\u51fa\u53e3 (egress)\u76d1\u542c\u5668\u3002</p> <p>Sidecar Resource</p> <ul> <li>Proxies accept traffic on all ports</li> <li>Configure Sidecar to specific ports/services</li> <li>Three parts:<ul> <li>Workload selector</li> <li>Ingress listener</li> <li>Egress listener</li> </ul> </li> </ul> <p>\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u51b3\u5b9a\u4e86\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u4f1a\u53d7\u5230sidecar\u914d\u7f6e\u7684\u5f71\u54cd\u3002</p>"},{"location":"chap9/5istio_interview/#envoy-filter","title":"Envoy Filter","text":"<p>EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531Istio Pilot\u751f\u6210\u7684Envoy\u914d\u7f6e\u3002\u4f7f\u7528\u8be5\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u66f4\u65b0\u6570\u503c\uff0c\u6dfb\u52a0\u7279\u5b9a\u7684\u8fc7\u6ee4\u5668\uff0c\u751a\u81f3\u6dfb\u52a0\u65b0\u7684\u76d1\u542c\u5668\u3001\u96c6\u7fa4\u7b49\u7b49\u3002\u5c0f\u5fc3\u4f7f\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u56e0\u4e3a\u4e0d\u6b63\u786e\u7684 \u5b9a\u5236\u53ef\u80fd\u4f1a\u7834\u574f\u6574\u4e2a\u7f51\u683c\u7684\u7a33\u5b9a\u6027\u3002</p> <p><code>kind: EnvoyFilter</code></p>"},{"location":"chap9/5istio_interview/#_7","title":"\u6d4b\u8bd5","text":"<ul> <li>\u6211\u4eec\u53ef\u4ee5\u7528\u4ec0\u4e48\u8d44\u6e90\u914d\u7f6eIstlo ingress gateway?  Gateway : istio: ingressgateway</li> <li>\u4f7f\u7528VirtualService\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u5c06\u6d41\u91cf\u8def\u7531\u5230Kubernetes\u5185\u90e8\u7684\u4e00\u4e2a\u7279\u5b9a\u670d\u52a1\u3002</li> <li>Istio ingress \u7f51\u5173\u662f\u4f5c\u4e3a\u54ea\u79cd\u670d\u52a1\u7c7b\u578b\u90e8\u7f72\u7684\uff1f: Loadbalancer</li> <li>\u4f60\u53ef\u4ee5\u5728\u54ea\u4e2a\u8d44\u6e90\u4e2d\u4e3aHTTP\u6d41\u91cf\u6307\u5b9a\u8def\u7531\u89c4\u5219\uff1f: VirtuaLService</li> <li>\u5982\u4f55\u5b9a\u4e49\u591a\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u4ee5\u4fbf\u80fd\u591f\u5728\u5b83\u4eec\u4e4b\u95f4\u8fdb\u884c\u6d41\u91cf\u8def\u7531\uff1f\u4f7f\u7528Destination Rule\u548csubset</li> <li>\u5f53\u4f7f\u7528\u79bb\u7fa4\u68c0\u6d4b\u65f6\uff0c\u4e3b\u673a\u4f55\u65f6\u4f1a\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\uff1f \u5f53\u8fd4\u56deHTTP 5xx\u9519\u8bef\u65f6</li> <li>\u5728\u79bb\u7fa4\u68c0\u6d4b\u914d\u7f6e\u4e2d\uff0c\u95f4\u9694\u8bbe\u7f6e\u6307\u7684\u662f\u4ec0\u4e48  \u626b\u63cf\u4e0a\u6e38\u4e3b\u673a\u65f6\u95f4\u7684\u95f4\u9694</li> <li>\u80fd\u5c06\u6d41\u91cf\u7b56\u7565\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u7aef\u53e3\u5417\uff1f: \u80fd <code>trafficPolicy: portLevelSettings: port</code></li> <li><code>ISTIO_MUTUAL</code>\u548c<code>MUTUAL TLS</code>\u6a21\u5f0f\u4e4b\u95f4\u6709\u4ec0\u4e48\u533a\u522b\uff1f <code>ISTIO_MUTUAL</code>\u5728mTLS\u4e2d\u4f7f\u7528Istio\u7684\u8bc1\u4e66\uff0c\u800c\u5728MUTUAL TLS\u4e2d\u4f60\u53ef\u4ee5\u7528\u4f60\u81ea\u5df1\u7684\u8bc1\u4e66<ul> <li><code>ISTIO_MUTUAL</code>\uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09</li> </ul> </li> <li>\u6211\u4eec\u53ef\u4ee5\u53ea\u5728\u4e0a\u6e38\u670d\u52a1\u5668\u8fd4\u56de5xx\u54cd\u5e94\u4ee3\u7801\u65f6\u91cd\u8bd5\u8bf7\u6c42\uff0c\u6216\u8005\u53ea\u5728\u7f51\u5173\u9519\u8bef\uff08HTTP 5O2\u3001 503\u6216504\uff09\u65f6\u91cd\u8bd5\uff0c\u6216\u8005\u751a\u81f3\u5728\u8bf7\u6c42\u5934\u4e2d\u6307\u5b9a\u53ef\u91cd\u8bd5\u7684\u72b6\u6001\u4ee3\u7801\u3002</li> <li>\u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48: \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 \u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\u3002\u5f53Envoy\u91cd\u8bd5\u4e00\u4e2a\u5931\u8d25\u7684\u8bf7\u6c42\u65f6\uff0c\u6700\u521d\u5931\u8d25\u5e76\u5bfc\u81f4\u91cd\u8bd5\u7684\u7aef\u70b9\u5c31\u4e0d\u518d\u5305\u542b\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u4e86\u3002\u5047\u8bbeKubernetes\u670d\u52a1\u67093\u4e2a\u7aef\u70b9\uff08Pod)\uff0c\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u4e86\uff0c \u5e76\u51fa\u73b0\u4e86\u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u4ee3\u7801</li> <li>\u4f60\u80fd\u4e3a\u540c\u4e00\u4e2a\u8bf7\u6c42\u540c\u65f6\u6ce8\u5165\u5ef6\u8fdf\u548c\u4e2d\u6b62\u5417. \u662f</li> <li>\u8003\u8651\u5230\u4e0b\u9762\u7684\u7247\u6bb5\uff0c\u6709\u591a\u5c11\u767e\u5206\u6bd4\u7684\u8bf7\u6c42\u4f1a\u88ab\u4e2d\u6b62\uff1f \u5982\u679c\u6211\u4eec\u4e0d\u6307\u5b9a\u767e\u5206\u6bd4\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u4e2d\u6b62</li> <li>\u6545\u969c\u6ce8\u5165\u662f\u5426\u89e6\u53d1\u91cd\u8bd5\u7b56\u7565\uff1f\u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u5c06\u4e0d\u4f1a\u89e6\u53d1\u6211\u4eec\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u6ce8\u5165\u4e86\u4e00\u4e2aHTTP 500\u7684\u9519\u8bef\uff0c\u914d\u7f6e\u4e3aHTTP 500\u4e0a\u7684\u91cd\u8bd5\u7b56\u7565\u5c06\u4e0d\u4f1a\u88ab\u89e6\u53d1\u3002</li> <li>\u4f60\u53ef\u4ee5\u4f7f\u7528VirtualService\u4e2d\u7684\u54ea\u4e2a\u5b57\u6bb5\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230Kubernetes\u4e2d\u4e00\u4e2a\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\uff1f redirect</li> <li>\u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u4f7f\u5916\u90e8\u670d\u52a1\u6210\u4e3a\u4f60\u7684\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206 ServiceEntry <ul> <li>\u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206</li> </ul> </li> <li>Envoy sidecar\u68c0\u67e5ServiceEntry\u8d44\u6e90\u4e2d\u7684hosts\u5b57\u6bb5\u7684\u987a\u5e8f\u662f\u4ec0\u4e48.  HTTP\u3001 SNI\u3001 IP\u5730\u5740\u3001\u7aef\u53e3</li> <li>ServiceEntry\u8d44\u6e90\u4e2d\u7684workloadSelector\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f\u8981\u9009\u62e9WorkloadEntry\u8d44\u6e90\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206</li> <li>\u5982\u4f55\u914d\u7f6esidecar\u4ee3\u7406\uff0c\u4f7f\u5176\u53ea\u5bf9\u67d0\u4e9b\u670d\u52a1\u4f7f\u7528\u7279\u5b9a\u7684\u7aef\u53e3  \u4f7f\u7528Sidecar\u8d44\u6e90</li> <li>Sidecar\u8d44\u6e90\u4e2d\u7684Ingress\u548cegress\u76d1\u542c\u5668\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48   \u5b9a\u4e49\u54ea\u4e9b\u5165\u7ad9\uff0f\u51fa\u7ad9\u6d41\u91cf\u88absidecar\u63a5\u53d7<ul> <li>Workload selector </li> <li>Ingress listener </li> <li>Egress listener </li> </ul> </li> <li>EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531Istio Pilot\u751f\u6210\u7684Envoy\u914d\u7f6e</li> <li>\u5f53\u6709\u591a\u4e2aEnvoyFilter\u90e8\u7f72\u65f6\uff0c\u54ea\u4e9b\u8fc7\u6ee4\u5668\u4f1a\u5148\u88ab\u5e94\u7528  \u6839\uff08\u5982istio-system)\u547d\u540d\u7a7a\u95f4\u7684\u8fc7\u6ee4\u5668 \u6839\u547d\u540d\u7a7a\u95f4\uff08\u4f8b\u5982istio-system)\u4e2d\u7684\u8fc7\u6ee4\u5668\u9996\u5148\u88ab\u5e94\u7528\uff0c\u7136\u540e\u662f\u5de5\u4f5c\u8d1f\u8f7d\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u5339\u914d\u8fc7\u6ee4\u5668\u3002</li> <li>\u5982\u4f55\u5c06VirtualService\u4e0eGateway\u7ed1\u5b9a  \u4f7f\u7528gateways\u5b57\u6bb5</li> </ul> <pre><code>...\nkind: VirtualService\n...\nspec:\n  hosts:\n    - \"*\"\n  gateways:\n    - gateway\n</code></pre> <ul> <li>Destination Rule\u914d\u7f6e\u6d41\u91cf\u7b56\u7565</li> <li>\u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48  \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664</li> <li>\u4f60\u53ef\u4ee5\u7528Workload Entry\u8d44\u6e90\u505a\u4ec0\u4e48\uff1f\u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5411Kubernetes\u7684\u8fc1\u79fb</li> </ul>"},{"location":"chap9/5istio_interview/#istio-secuirty","title":"Istio Secuirty","text":""},{"location":"chap9/5istio_interview/#authentication","title":"\u8ba4\u8bc1(Authentication)","text":"<p>Authentication</p> <ul> <li>Principal = Kubernetes service</li> <li>Action = HTTP request methods (e.g. GET, POST, DELETE, ...)</li> <li>Object = Kubernetes service</li> <li>All about the principal (service identity)</li> <li>\"Validating a credential and ensuring it's both valid and trusted\"</li> </ul> <p>Identity</p> <ul> <li>Unique identity in Kubernetes = Kubernetes service account</li> <li>X.509 certificate (from SA) + SPIFFE spec = Identity<ul> <li>Naming scheme (spiffe://cluster.localinsidefault/sa/my-sa)</li> <li>Encoding names into X.509</li> <li>Validating the X.509 to authenticate the SPIFFE identity</li> </ul> </li> </ul>"},{"location":"chap9/5istio_interview/#_8","title":"\u8bc1\u4e66\u521b\u5efa\u548c\u8f6e\u6362","text":"<p>\u5bf9\u4e8e\u7f51\u683c\u4e2d\u7684\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\uff0cIstio\u63d0\u4f9b\u4e00\u4e2a<code>X.509</code>\u8bc1\u4e66\u3002</p> <p>\u4e00\u4e2a\u540d\u4e3a<code>pilot-agent</code>\u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08istiod\uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c\u3002</p> <p>Certificate creation</p> <ul> <li>Istio Agent</li> <li>Envoy's Secret Discovery Service(SDS)</li> <li>Citadel(part of the control plane)</li> </ul> <p>Istio Agent\u4e0eEnvoy sidecar\u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c\u3002\u5373\u4fbfIstio\u4ee3\u7406\u5728\u6bcf\u4e2apod\u4e2d\u8fd0\u884c\u6211\u4eec\u4e5f\u8ba4\u4e3a\u5b83\u662f\u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u79d8\u94a5\u53d1\u73b0\u670d\u52a1(SDS)\u7b80\u5316\u4e86\u8bc1\u4e66\u7ba1\u7406\u3002\u5982\u679c\u6ca1\u6709SDS\u8bc1\u4e66\u5fc5\u987b\u4f5c\u4e3a\u79d8\u5bc6(Secret) \u521b\u5efa\uff0c\u7136\u540e\u88c5\u5165\u4ee3\u7406\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002</p> <p>\u6bcf\u5f53\u8bc1\u4e66\u8fc7\u671f\u65f6SDS\u4f1a\u63a8\u9001\u66f4\u65b0\u7684\u8bc1\u4e66Envoy\u53ef\u4ee5\u7acb\u5373\u4fbf\u7528\u5b83\u4eec\u3002\u4e0d\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u670d\u52a1\u5668\u4e5f\u4e0d\u9700\u8981\u4e2d\u65ad\u6d41\u91cf\u3002</p>"},{"location":"chap9/5istio_interview/#peer-and-request-authentication","title":"Peer and Request Authentication(\u5bf9\u7b49\u8ba4\u8bc1\u548c\u8bf7\u6c42\u8ba4\u8bc1)","text":"<ul> <li>Peer authentication<ul> <li>Peer authentication</li> <li>service-to-service</li> </ul> </li> <li>All mTLS about the communication between services</li> <li>Request authentication<ul> <li>end user authentication</li> <li>uses JWTs</li> </ul> </li> </ul>"},{"location":"chap9/5istio_interview/#tls","title":"\u53cc\u5411TLS","text":"<p>Mutual TLS(mTLS)</p> <ul> <li>Traffic is re-routed through proxies</li> <li>Envoy starts an mTLS handshake<ul> <li>Secure naming check is done</li> </ul> </li> <li>Once mTLS connection is established:<ul> <li>Request is forwarded to server-side proxy</li> <li>Server-side forwards traffic to the workload</li> </ul> </li> </ul> <p>mTLS Behavior</p> <ul> <li>DISABLE: no TLS connection</li> <li>SIMPLE: originate to the upstream</li> <li>MUTUAL: uses mTLS and certs for auth</li> <li><code>ISTIO_MUTUAL</code>: like MUTUAL; but uses Istlo's certs for mTLS</li> </ul> <p>Permissive mode</p> <ul> <li>Allows services to accpet both plaintext and mTLS</li> <li>Improves mTLS onboarding experience</li> <li>Gradually Install/configure sidecars for mTLS</li> </ul>"},{"location":"chap9/5istio_interview/#_9","title":"\u6388\u6743","text":"<p>Authorization</p> <ul> <li>Can user A send a GET request to /hello on service B?</li> <li>Authn without authz (and vice-versa) is useless</li> <li>Control authenticated principals with AuthorizationPolicy</li> </ul> <p>Authorization policy</p> <ul> <li>Make use of identities extracted from PeerAuthentication and RequestAuthentication:<ul> <li>requestPrincipals (users)</li> <li>principals (service/peer)</li> </ul> </li> <li>Defined at mesh, namespace, and workload level</li> </ul> <p>Authorization policy</p> <ul> <li>Workloads policy applies to</li> <li>Action to take (deny, allow, or audit)</li> <li>Rules when to take action</li> </ul> <p>Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528<code>AuthorizationPolicy</code>\u8d44\u6e90\u5728\u7f51\u683c\u3001\u547d\u540d\u7a7a\u95f4\u548c\u5de5\u4f5c\u8d1f\u8f7d\u5c42\u9762\u5b9a\u4e49\u8bbf\u95ee\u63a7\u5236\u3002<code>AuthorizationPolicy</code>\u652f\u6301DENY\u3001ALLOW\u3001 AUDIT\u548cCUSTOM\u64cd\u4f5c\u3002</p> <p><code>kind: AuthorizationPolicy</code></p>"},{"location":"chap9/5istio_interview/#_10","title":"\u5b89\u5168\u6d4b\u8bd5","text":"<ul> <li>\u5728\u901a\u4fe1\u65f6\uff0cEnvoy\u4ee3\u7406\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u51ed\u8bc1:  X509\u8bc1\u4e66<ul> <li>Validating the X.509 to authenticate the SPIFFE identity</li> </ul> </li> <li>\u54ea\u4e2a\u7ec4\u4ef6\u4e3a\u4e00\u4e2a\u670d\u52a1\u8d26\u6237\u521b\u5efaSPIFFE\u8eab\u4efd\uff1f Citadel<ul> <li>\u6bcf\u6b21\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u8d26\u6237\u65f6, Citadel\u90fd\u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2aSPIFFE\u8eab\u4efd\u3002</li> </ul> </li> <li>\u4f60\u4f1a\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u542f\u7528\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4e25\u683cmTLS\u6a21\u5f0f\uff1f PeerAuthentication</li> <li>AuthorizationPolicy\u8d44\u6e90\u4e2d\u4f7f\u7528\u54ea\u4e24\u4e2a\u52a8\u4f5c\uff1f DENY\u548cALLOW<ul> <li>\u6bcf\u4e2aEnvoy\u4ee3\u7406\u5b9e\u4f8b\u90fd\u8fd0\u884c\u4e00\u4e2a\u6388\u6743\u5f15\u64ce\uff0c\u5728\u8fd0\u884c\u65f6\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6388\u6743\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe\u4ee3\u7406\u65f6\uff0c\u5f15\u64ce\u4f1a\u6839\u636e\u6388\u6743\u7b56\u7565\u8bc4\u4f30\u8bf7\u6c42\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u8fd4\u56deALLOW\u6216DENY</li> </ul> </li> <li>\u5f53\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\uff08SDS)\u66f4\u65b0\u8bc1\u4e66\u65f6\uff0c\u662f\u5426\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u4ee5\u4f7f\u7528\u65b0\u8bc1\u4e66\u3002 \u5426</li> <li>AUDIT\u52a8\u4f5c\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f \u8bb0\u5f55\u8bf7\u6c42<ul> <li>AUDIT\u52a8\u4f5c\u51b3\u5b9a\u662f\u5426\u8bb0\u5f55\u7b26\u5408\u89c4\u5219\u7684\u8bf7\u6c42\u3002\u6ce8\u610fAUDIT\u7b56\u7565\u5e76\u4e0d\u5f71\u54cd\u8bf7\u6c42\u88ab\u5141\u8bb8\u6216\u62d2\u7edd\u3002</li> </ul> </li> <li>\u4ec0\u4e48\u662f\u5141\u8bb8\u6a21\u5f0f\uff08permissive mode)?  \u4e00\u4e2a\u5141\u8bb8\u670d\u52a1\u540c\u65f6\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u6700\u548cmTLS\u6d41\u91cf\u7684\u9009\u9879</li> <li>\u662f\u5426\u53ef\u4ee5\u5728Istio\u4e2d\u4f7f\u7528JSON Web Tokens (JWTs)? \u662f</li> <li>\u9009\u62e9\u4e09\u4e2a\u8d1f\u8d35\u5728\u8fd0\u884c\u65f6\u521b\u5efa\u8eab\u4efd\u7684\u7ec4\u4ef6  Citedel \u3001 lstio Agent \u3001Envoys Secret Discovery Service</li> <li>Istlo Agent\u7684\u5de5\u4f5c\u662f\u4ec0\u4e48\uff1f  \u4e0eEnvoy sidecar\u5408\u4f5c\uff0c\u901a\u8fc7\u4e13\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\uff0c\u5e2e\u52a9\u4ed6\u4eec\u94fe\u63a5\u5230Service mesh Istio Agent\u4e0eEnvoy sidecar\u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c</li> <li>Istlo\u63d0\u4f9b\u54ea\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1f  \u5bf9\u7b49\u548c\u8bf7\u6c42\u8ba4\u8bc1</li> <li>Istlo\u4ee3\u7406\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u5b58\u50a8\u5728\u54ea\u91cc\uff1f\u5185\u5b58  \u5c06\u5bc6\u94a5\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u6bd4\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u66f4\u5b89\u5168\uff1b<ul> <li>\u5728\u4f7f\u7528SDS\u65f6\uff0c\u7edd\u4e0d\u4f1a\u5c06\u4efb\u4f55\u5bc6\u94a5\u5199\u5165\u78c1\u76d8\u3002Istio\u4ee3\u7406\u8fd8\u5b9a\u671f\u5237\u65b0\u51ed\u8bc1\uff0c \u5728\u5f53\u524d\u51ed\u8bc1\u8fc7\u670b\u524d\u4eceCitadel\u68c0\u7d22\u4efb\u4f55\u65b0\u7684SVID(SPIFFE\u53ef\u9a8c\u8bc1\u8eab\u4efd\u6587\u4ef6\uff09</li> </ul> </li> <li>\u54ea\u79cd\u4ee3\u7406\u4e0eistiod\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u5b9e\u73b0\u94a5\u5319\u548c\u8bc1\u4e66\u8f6e\u6362\u7684\u81ea\u52a8\u5316  pilot-agent<ul> <li>\u4e00\u4e2a\u540d\u4e3a<code>pilot-agent</code>\u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08istiod\uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c\u3002</li> </ul> </li> <li>\u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u54ea\u4e9b\u5185\u5bb9\uff1f \u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04</li> <li>\u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c\u54ea\u4e9b\u7b56\u7565\u4f1a\u5148\u88ab\u8bc4\u4f30\uff1f Deny \u7b56\u7565</li> <li>\u4f60\u5982\u4f55\u5728Istio\u4e2d\u542f\u7528\u6388\u6743\u529f\u80fd\uff1f  \u4e0d\u9700\u8981\u660e\u786e\u5730\u542f\u7528\u8be5\u529f\u80fd<ul> <li>\u6ca1\u6709\u5fc5\u8981\u660e\u786e\u5730\u542f\u7528\u6388\u6743\u529f\u80fd\u3002\u4e3a\u4e86\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u6765\u5e94\u7528\u4e8e\u6211\u4eec\u7684\u5de5\u4f5c\u8d1f\u8f7d <code>AuthorizationPolicy</code>\u8d44\u6e90\u662f\u6211\u4eec\u53ef\u4ee5\u5229\u7528<code>PeerAuthentication</code>\u7b56\u7565\u548c<code>RequestAuthentication</code>\u7b56\u7565\u4e2d\u7684\u4e3b\u4f53\u7684\u5730\u65b9\u3002</li> </ul> </li> <li>Istio\u5982\u4f55\u9a8c\u8bc1\u7528\u6237\uff0f\u8fdb\u7a0b\u7684\u8eab\u4efd  \u901a\u8fc7\u4ece\u8bf7\u6c42\u4e2d\u63d0\u53d6\u51ed\u8bc1</li> <li>\u4f60\u5982\u4f55\u5728\u6574\u4e2a\u7f51\u683c\u4e2d\u5f3a\u5236\u6267\u884c\u4e25\u683c\u7684mTLS\u6a21\u5f0f \u901a\u8fc7\u5c06PeerAuthentication\u8d44\u6e90\u90e8\u7f72\u5230\u6839\u547d\u540d\u7a7a\u95f4(Istlo system\uff09\u4e2d<ul> <li>\u6211\u4eec\u53ef\u4ee5\u521b\u5efaPeerAuthentication\u8d44\u6e90\uff0c\u9996\u5148\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5206\u522b\u6267\u884c\u4e25\u683c\u6a21\u5f0f\u3002\u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u547d\u540d\u7a7a\u95f4\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662fistio-system)\u521b\u5efa\u4e00\u4e2a\u7b56\u7565\uff0c\u5728\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u4e2d\u6267\u884c\u8be5\u7b56\u7565\uff1a</li> </ul> </li> <li>\u5bf9\u7b49\u8ba4\u8bc1\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684:  \u670d\u52a1\u95f4\u8ba4\u8bc1</li> <li>\u679cKubernetes\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709Envoy\u4ee3\u7406\uff0cIstio\u662f\u5426\u4f1a\u53d1\u9001mTLS\u6d41\u91cf \u5426</li> <li>Authorization Policy\u8d44\u6e90\u4e2d\u7684selector\u548cmatchLabel\u5b57 \u6bb5\u6709\u4ec0\u4e48\u7528\u9014  \u8981\u9009\u62e9\u7b56\u7565\u9002\u7528\u7684\u5de5\u4f5c\u8d1f\u8f7d</li> </ul>"},{"location":"chap9/5istio_interview/#_11","title":"\u9ad8\u7ea7\u529f\u80fd\u6d4b\u8bd5","text":"<ul> <li>Istio\u5728\u7f51\u683c\u4e2d\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u79df\u6237\u5355\u4f4d: Namespace</li> <li>\u4f60\u4f7f\u7528\u54ea\u4e9b\u8d44\u6e90\u5c06\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c\uff1fWorkloadGroup \u548c WorkloadEntry<ul> <li>\u5de5\u4f5c\u8d1f\u8f7d\u7ec4(WorkloadGroup\u8d44\u6e90\uff09\u7c7b\u4f3c\u4e8eKubernetes \u4e2d\u7684\u90e8\u7f72(Deployments)\u5b83\u4ee3\u8868\u4e86\u5171\u4eab\u5171\u540c\u5c5e\u6027\u7684\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u903b\u8f91\u7ec4</li> <li>\u63cf\u8ff0\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee(WorkloadEntry\u8d44\u6e90\uff09\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee\u7c7b\u4f3c\u4e8ePod\u5b83\u4ee3\u8868\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5355\u4e00\u5b9e\u4f8b</li> </ul> </li> <li>\u4f60\u662f\u5426\u53ef\u4ee5\u901a\u8fc7\u5c06\u6240\u6709\u96c6\u7fa4\u4f5c\u4e3a\u8fdc\u7a0b\u96c6\u7fa4\u6765\u5b9e\u73b0\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u7684\u5b8c\u5168\u5206\u79bb\uff1f\u662f<ul> <li>\u53e6\u4e00\u79cd\u90e8\u7f72\u6a21\u5f0f\u662f\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684\u96c6\u7fa4\u90fd\u89c6\u4e3a\u7531\u5916\u90e8\u63a7\u5236\u5e73\u9762\u63a7\u5236\u7684\u8fdc\u7a0b\u96c6\u7fa4\u3002\u8fd9\u4f7f\u6211\u4eec\u5728\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u6709\u4e86\u5b8c\u5168\u7684\u5206\u79bb\u3002</li> </ul> </li> <li>Istio\u662f\u5982\u4f55\u89e3\u51b3\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u914d\u7f6e\u9694\u79bb\u7684: \u4e0d\u53ef\u884c<ul> <li>\u79df\u6237\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u662f\u9694\u79bb\u4e0d\u540c\u79df\u6237\u7684\u914d\u7f6e\u3002\u76ee\u524d\uff0cIstio\u5e76\u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u8fc7\uff0c\u5b83\u901a\u8fc7\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u7684\u8303\u56f4\u914d\u7f6e\u6765\u5c1d\u8bd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898</li> </ul> </li> <li>\u591a\u96c6\u7fa4\u90e8\u7f72\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f  \u4e3a\u4e86\u83b7\u5f97\u66f4\u5927\u7a0b\u5ea6\u7684\u9694\u79bb\u548c\u53ef\u7528\u6027\uff0e \u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\u662f\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762\u3002\u5bf9\u4e8e\u6b63\u5e38\u7684\u670d\u52a1\u7f51\u683c\u90e8\u7f72\u89c4\u6a21\u5efa\u8bae\u4f60\u4f7f\u7528\u591a\u7f51\u683c\u90e8\u7f72\uff0c\u5e76\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u7cfb\u7edf\u5728\u5916\u90e8\u534f\u8c03\u7f51\u683c\u3002</li> <li>\u4ec0\u4e48\u662f\u79df\u6237\uff1f \u79df\u6237\u662f\u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650\u7684\u7528\u6237\u3002\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u901a\u8fc7\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565\u5b8c\u6210\u7684\u3002</li> <li>What does the shared control plane model involve?  \u591a\u4e2a\u96c6\u7fa4\u63a7\u5236\u5e73\u9762\u53ea\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff08\u4e3b\u96c6\u7fa4\uff09</li> <li>\u4ec0\u4e48\u88ab\u8ba4\u4e3a\u662f\u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\uff1f \u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762</li> <li>\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1f \u4f7f\u7528\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565</li> <li>\u5de5\u4f5c\u8d1f\u8f7d\u5e94\u8be5\u5982\u4f55\u5728\u96c6\u7fa4\u4e4b\u95f4\u8fdb\u884c\u901a\u4fe1\uff1f \u901a\u8fc7ingress gateway</li> </ul>"},{"location":"chap9/5istio_interview/#istio_4","title":"Istio \u95ee\u9898\u6392\u67e5","text":"<ul> <li><code>istioctl proxy-config</code>\u5217\u51fa\u76d1\u542c\u5668</li> <li>\u914d\u7f6e <code>istioctl validate -f myresource.yaml</code></li> <li>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u53e6\u4e00\u4e2a\u547d\u4ee4<code>istioctl analyze</code></li> <li><code>istioctl proxy-status</code></li> <li><code>istioctl dashboard controlz</code></li> <li>\u5982\u679c\u865a\u62df\u76d1\u542c\u5668\u627e\u4e0d\u5230\u8bf7\u6c42\u7684\u76ee\u7684\u5730\u4f1a\u600e\u6837  \u6839\u636eOutboundTrafficPolicy\u53d1\u9001\u6d41\u91cf</li> <li>\u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e2aIstio CLI\u547d\u4ee4\u6765\u5217\u51fa\u6240\u6709\u76d1\u542c\u5668  <code>istiocti proxy-config listeners</code></li> <li>\u76d1\u542c\u5668\u4f7f\u7528\u54ea\u4e2a\u670d\u52a1\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e  RDS(route discovery service)</li> <li>Envoy\u7684\u57fa\u672c\u6982\u5ff5\u662f\u4ec0\u4e48\uff1f  listener\u3001route\u3001cluster\u548cendpoint</li> <li>\u6bcf\u4e2asidecar\u90fd\u6709\u591a\u4e2a\u76d1\u542c\u5668\u751f\u6210\u3002\u6bcf\u4e2asidecar\u90fd\u6709\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u5b83\u88ab\u7ed1\u5b9a\u5230 0.0.0.0:15006</li> <li>Where are the circuit breakers defined In clusters configuration</li> <li>\u4ec0\u4e48\u7c7b\u578b\u7684\u6d41\u91cf\u4f1a\u88ab\u8def\u7531\u523015006\u7aef\u53e3 \u5165\u7ad9Pod\u6d41\u91cf</li> </ul>"},{"location":"chap9/6k8s_mtls/","title":"6 Kubernetes \u7684 mTLS \u6307\u5357","text":""},{"location":"chap9/6k8s_mtls/#_1","title":"\u7b80\u4ecb","text":"<p>Mutual TLS\uff08\u53cc\u5411 TLS\uff09\uff0c\u6216\u79f0 mTLS\uff0c\u662f Kubernetes \u4e2d\u7684\u4e00\u4e2a\u70ed\u95e8\u8bdd\u9898\uff0c\u5c24\u5176\u662f\u5bf9\u4e8e\u90a3\u4e9b\u8d1f\u8d23\u4e3a\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u4f20\u8f93\u5c42\u52a0\u5bc6\u7684\u4eba\u6765\u8bf4\u3002\u4f46\u662f\uff0c\u4f60\u6709\u6ca1\u6709\u8003\u8651\u8fc7\uff0c\u4ec0\u4e48\u662f mTLS\uff0c\u5b83\u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u5b89\u5168\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981 mTLS\uff1f</p>"},{"location":"chap9/6k8s_mtls/#mtls","title":"\u4ec0\u4e48\u662f mTLS\uff1f","text":"<p>\u5bf9\u4e8e\u5e38\u89c4 TLS\uff0c\u53ea\u9700\u8981\u670d\u52a1\u7aef\u8ba4\u8bc1\uff0cmTLS \u76f8\u5bf9\u6765\u8bf4\u6709\u4e00\u4e2a\u989d\u5916\u7684\u89c4\u5b9a\uff1a\u5ba2\u6237\u7aef\u4e5f\u8981\u7ecf\u8fc7\u8ba4\u8bc1\u3002\u4f46\u8fd9\u610f\u5473\u7740\u4ec0\u4e48\uff0c\u4e3a\u4ec0\u4e48\u8981\u8fd9\u6837\u505a\u5462\uff1f</p> <p>\u5728\u56de\u7b54\u8fd9\u4e9b\u95ee\u9898\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u5bf9 TLS \u6709\u4e00\u4e2a\u57fa\u672c\u7684\u4e86\u89e3\u3002</p> <p>TLS \u662f\u4e00\u4e2a\u4f20\u8f93\u5c42\u534f\u8bae\uff0c\u65e8\u5728\u4e3a TCP \u8fde\u63a5\u63d0\u4f9b\u5b89\u5168\u4fdd\u969c\uff08\u6211\u4eec\u5c06\u5728\u4e0b\u9762\u770b\u5230\u5b89\u5168\u7684\u786e\u5207\u542b\u4e49\uff09\u3002TLS \u5728\u4f20\u8f93\u5c42\u5de5\u4f5c\uff0c\u53ef\u4ee5\u4e0e\u4efb\u4f55\u4f7f\u7528 TCP \u7684\u5e94\u7528\u5c42\u534f\u8bae\u7ed3\u5408\u4f7f\u7528\u3002</p> <p>\u4f8b\u5982\uff0cHTTPS \u662f HTTP \u4e0e TLS \u7684\u7ed3\u5408\uff08HTTPS \u4e2d\u7684 S \u6307\u7684\u662f SSL\uff0c\u5373 TLS \u7684\u524d\u8eab\uff09\uff0cHTTP \u4e0d\u9700\u8981\u505a\u4efb\u4f55\u6539\u53d8\u6765\u9002\u5e94 TLS\uff08\u81f3\u5c11\uff0c\u5728\u534f\u8bae\u5c42\u9762\u3002</p> <p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u968f\u7740 HTTPS \u7684\u5f15\u5165\uff0cHTTP \u7684\u4f7f\u7528\u65b9\u5f0f\u80af\u5b9a\u5df2\u7ecf\u53d1\u751f\u4e86\u53d8\u5316\u3002\u4f8b\u5982\uff0c\u50cf HSTS \u8fd9\u6837\u7684\u529f\u80fd\u73b0\u5728\u88ab\u7528\u6765\u9632\u6b62 HTTPS \u53ef\u80fd\u53d1\u751f\u7684\u67d0\u4e9b\u7c7b\u578b\u7684\u653b\u51fb\uff09\u3002</p> <p>\u56e0\u4e3a TLS \u4e2d\u5b58\u5728\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u4f7f\u5f97\u5176\u4ece\u5b89\u5168\u7684\u89d2\u5ea6\u6765\u770b\u662f\u4e0d\u7406\u60f3\u7684\u3002TLS \u89c4\u8303\u590d\u6742\uff0c\u800c\u4e14\u6ca1\u6709\u5f97\u5230\u5145\u5206\u7684\u8bf4\u660e\uff0c\u6709\u4e9b\u5730\u65b9\u5e76\u6ca1\u6709\u771f\u6b63\u7684\u610f\u4e49\uff0c\u800c\u4e14\u4e0d\u7ba1\u600e\u6837\uff0c\u5b9e\u73b0\u8d77\u6765\u4e5f\u4e0d\u4f1a 100% \u7b26\u5408 TLS \u89c4\u8303\u3002</p>"},{"location":"chap9/6k8s_mtls/#tls","title":"TLS \u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u5b89\u5168\u6027\uff1f","text":"<p>\u5927\u591a\u6570\u4eba\u628a TLS \u4e0e\u52a0\u5bc6\u8054\u7cfb\u8d77\u6765\u3002\u4f46 TLS \u4e0d\u4ec5\u4ec5\u662f\u8fd9\u6837\u3002TLS \u4e3a\u8fde\u63a5\u63d0\u4f9b\u4e86\u4e09\u79cd\u5b89\u5168\u4fdd\u8bc1\uff1a</p> <ul> <li>\u771f\u5b9e\u6027\uff1a\u4efb\u4f55\u4e00\u65b9\u90fd\u80fd\u8bc1\u660e\u4ed6\u4eec\u662f\u81ea\u5df1\u6240\u58f0\u79f0\u7684\u8eab\u4efd\u3002</li> <li>\u4fdd\u5bc6\u6027\uff1a\u5176\u4ed6\u4eba\u65e0\u6cd5\u770b\u5230\u6b63\u5728\u4ea4\u6362\u7684\u6570\u636e\u3002</li> <li>\u5b8c\u6574\u6027\uff1a\u6536\u5230\u7684\u6570\u636e\u4e0e\u53d1\u9001\u7684\u6570\u636e\u76f8\u540c\u3002</li> </ul> <p>\u56e0\u6b64\uff0c\u867d\u7136 TLS \u786e\u5b9e\u7ed9\u4f60\u63d0\u4f9b\u4e86\u52a0\u5bc6 \u2014\u2014 \u8fd9\u5c31\u662f\u5b83\u5b9e\u73b0\u4fdd\u5bc6\u7684\u65b9\u5f0f \u2014\u2014 \u4f46\u4ece TLS \u7684\u89d2\u5ea6\u6765\u770b\uff0c\u8fd9\u5bf9\u5b89\u5168\u901a\u4fe1\u6765\u8bf4\u662f\u4e0d\u591f\u7684\uff1a</p> <p>\u4f60\u9700\u8981\u6240\u6709\u8fd9\u4e09\u79cd\u5c5e\u6027\u3002\u5982\u679c\u4f60\u6ca1\u6709\u771f\u5b9e\u6027\uff0c\u90a3\u4e48\u6709\u4eba\u5c31\u53ef\u4ee5\u5728\u8fde\u63a5\u7684\u53e6\u4e00\u7aef\u8fdb\u884c\u6b3a\u9a97\u3002\u5982\u679c\u4f60\u6ca1\u6709\u5b8c\u6574\u6027\uff0c\u90a3\u4e48\u6709\u4eba\u53ef\u4ee5\u4fee\u6539\u901a\u4fe1\u4e2d\u7684\u5173\u952e\u4fe1\u606f\u3002\u5982\u679c\u4f60\u6ca1\u6709\u4fdd\u5bc6\u6027\uff0c\u90a3\u4e48\u4efb\u4f55\u4eba\u90fd\u53ef\u4ee5\u76d1\u542c\u3002</p>"},{"location":"chap9/6k8s_mtls/#mtls_1","title":"mTLS \u4ec0\u4e48\u65f6\u5019\u6709\u7528\uff1f","text":"<p>\u56de\u5230\u6211\u4eec\u6700\u521d\u7684\u5b9a\u4e49\uff1amTLS \u662f\u7b80\u5355\u7684\u5e38\u89c4 TLS\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u989d\u5916\u7684\u89c4\u5b9a\uff0c\u5373\u5ba2\u6237\u7aef\u4e5f\u8981\u7ecf\u8fc7\u8ba4\u8bc1\u3002\u6709\u4e86\u5bf9 TLS \u7684\u57fa\u672c\u4e86\u89e3\uff0c\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u89e3\u6790\u8fd9\u4e2a\u58f0\u660e\u4e86\u3002TLS \u4fdd\u8bc1\u4e86\u771f\u5b9e\u6027\uff0c\u4f46\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8fd9\u53ea\u53d1\u751f\u5728\u4e00\u4e2a\u65b9\u5411\u4e0a\uff1a\u5ba2\u6237\u7aef\u5bf9\u670d\u52a1\u5668\u8fdb\u884c\u8ba4\u8bc1\uff0c\u4f46\u670d\u52a1\u5668\u5e76\u4e0d\u5bf9\u5ba2\u6237\u7aef\u8fdb\u884c\u8ba4\u8bc1\u3002</p> <p>\u4e3a\u4ec0\u4e48 TLS \u7684\u9ed8\u8ba4\u53ea\u5728\u4e00\u4e2a\u65b9\u5411\u8fdb\u884c\u8ba4\u8bc1\uff1f\u56e0\u4e3a\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u5f80\u5f80\u662f\u4e0d\u76f8\u5173\u7684\u3002\u4f8b\u5982\uff0c\u5728\u52a0\u8f7d\u8fd9\u4e2a\u9875\u9762\u65f6\uff0c\u4f60\u7684\u6d4f\u89c8\u5668\u5df2\u7ecf\u9a8c\u8bc1\u4e86\u8981\u8bbf\u95ee\u7684\u7f51\u7ad9\u670d\u52a1\u7aef\u7684\u8eab\u4efd\uff0c\u4f46\u670d\u52a1\u7aef\u5e76\u6ca1\u6709\u9a8c\u8bc1\u4f60\u7684\u6d4f\u89c8\u5668\u7684\u8eab\u4efd\u3002\u5b83\u5b9e\u9645\u4e0a\u5e76\u4e0d\u5173\u5fc3\u4f60\u7684\u6d4f\u89c8\u5668\u7684\u8eab\u4efd\u3002</p> <p>\u5f53\u7136\uff0c\u4e0d\u9a8c\u8bc1\u5ba2\u6237\u7aef\u8eab\u4efd\u5bf9\u4e8e\u63d0\u4f9b\u7f51\u9875\u670d\u52a1\u662f\u6709\u610f\u4e49\u7684\uff0c\u4f46\u6709\u5f88\u591a\u7c7b\u578b\u7684\u901a\u4fe1\uff0c\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u4e5f\u5f88\u91cd\u8981\u3002\u4f8b\u5982 API \u8c03\u7528\uff1a\u5982\u679c\u4f60\u8c03\u7528\u50cf GitHub \u8fd9\u6837\u7684\u670d\u52a1\uff0c\u90a3\u4e48 GitHub \u9700\u8981\u77e5\u9053\u4f60\u662f\u8c01 \u2014\u2014 \u9664\u5176\u4ed6\u539f\u56e0\u5916\uff0c\u8fd9\u6837\u4ed6\u4eec\u5c31\u53ef\u4ee5\u7ed9\u4f60\u53d1\u9001\u8d26\u5355\u3002\u5982\u679c\u4e0d\u5411 GitHub \u63d0\u4f9b\u67d0\u79cd\u5ba2\u6237\u7aef\u8eab\u4efd\uff0c\u4f60\u5c31\u4e0d\u80fd\u5bf9 GitHub \u7684 API \u8fdb\u884c\u8c03\u7528\u3002</p> <p>\u4f46 GitHub \u5e76\u4e0d\u4f7f\u7528 mTLS\u3002\u76f8\u53cd\uff0c\u4f60\u901a\u8fc7\u7ed9 GitHub \u4e00\u4e2a\u79d8\u5bc6\u7684\u8ba4\u8bc1\u4ee4\u724c\uff08token\uff09\u6765\u8ba4\u8bc1\u81ea\u5df1\uff0c\u8fd9\u4e2a\u4ee4\u724c\u662f\u521b\u5efa\u8d26\u6237\u65f6\u5206\u914d\u7ed9\u4f60\u7684\u3002\u5766\u7387\u5730\u8bf4\uff0cmTLS \u8bbe\u7f6e\u8d77\u6765\u5f88\u70e6\u4eba\uff08\u540e\u9762\u4f1a\u6709\u5f88\u591a\u8fd9\u65b9\u9762\u7684\u5185\u5bb9\uff09\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u63d0\u4f9b\u50cf GitHub \u8fd9\u6837\u7684\u516c\u5171 API\uff0c\u4f60\u53ef\u80fd\u4f1a\u53ea\u4f7f\u7528 auth token\u3002</p> <p>\u7136\u800c\uff0c\u4f7f\u7528 mTLS \u7684\u8ba4\u8bc1\u6709\u4e00\u4e9b\u975e\u5e38\u5f3a\u5927\u7684 auth token \u65b9\u6cd5\u6ca1\u6709\u7684\u4f18\u52bf\u3002</p> <ul> <li>\u9996\u5148\uff0cmTLS \u8ba4\u8bc1\u53ef\u4ee5\u5b8c\u5168\u5728\u5e94\u7528\u7a0b\u5e8f\u4e4b\u5916\u5b8c\u6210\uff0c\u4e0d\u9700\u8981\u4efb\u4f55\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u529f\u80fd\u6765\u521b\u5efa\u3001\u6ce8\u518c\u6216\u7ba1\u7406\u8eab\u4efd\u3002<ul> <li>\u4f7f\u7528 auth token \u65f6\uff0c\u5728\u4f60\u8fdb\u884c\u7b2c\u4e00\u6b21 GitHub API \u8c03\u7528\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u767b\u5f55\u7f51\u7ad9\uff0c\u521b\u5efa\u4e00\u4e2a\u8d26\u6237\uff0c\u83b7\u5f97\u4ee4\u724c\uff08\u5c3d\u7ba1\u8fd9\u4e2a\u5ba2\u6237\u7aef\u4ee4\u724c\u6d41\u7a0b\u6ca1\u6709\u4f7f\u7528 TLS \u5ba2\u6237\u7aef\u8ba4\u8bc1\uff0c\u4f46\u5b83\u4ecd\u7136\u4f9d\u9760 TLS \u670d\u52a1\u5668\u8ba4\u8bc1\u6765\u4fdd\u8bc1\u5b89\u5168\u3002TLS \u786e\u4fdd\u4ee4\u724c\u6765\u81ea GitHub \u800c\u4e0d\u662f\u4e00\u4e2a\u4f2a\u88c5\u8005\uff09\u3002</li> <li>GitHub \u7684 API \u5fc5\u987b\u77e5\u9053\u8fd9\u4e2a auth token\uff0c\u5e76\u63d0\u4f9b\u5c06\u5176\u4f20\u9012\u7ed9 API \u8c03\u7528\u548c\u7ba1\u7406\u5b83\u7684\u65b9\u6cd5\u3002</li> </ul> </li> <li>\u4f46\u6709\u4e86 mTLS\uff0c\u4e00\u4e2a\u5168\u65b0\u7684\u5ba2\u6237\u7aef\u5c31\u53ef\u4ee5\u76f4\u63a5\u8ba4\u8bc1\u81ea\u5df1\uff0c\u5373\u4f7f\u4ece\u6ca1\u6709\u4eba\u89c1\u8fc7\u5b83\u3002\u800c\u5e94\u7528\u7a0b\u5e8f\u4e0d\u9700\u8981\u77e5\u9053\u4efb\u4f55\u5173\u4e8e\u8ba4\u8bc1\u7684\u4e8b\u60c5\uff0c\u4e5f\u4e0d\u9700\u8981\u63d0\u4f9b\u7aef\u70b9\u6765\u7ba1\u7406\u8ba4\u8bc1\u3002</li> </ul> <p>\u7efc\u4e0a\u6240\u8ff0\uff0c\u6211\u4eec\u770b\u5230 mTLS \u975e\u5e38\u9002\u5408\u4ee5\u4e0b\u60c5\u51b5\uff1a</p> <ol> <li> <p>\u4f60\u9700\u8981\u5b89\u5168\u901a\u4fe1\uff1b</p> </li> <li> <p>\u4f60\u5173\u5fc3\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\uff1b</p> </li> <li> <p>\u4e0d\u60f3\u4e3a\u7ba1\u7406\u8eab\u4efd\u5efa\u7acb\u5e94\u7528\u7ea7\u6d41\u7a0b\uff1b</p> </li> <li> <p>\u4f60\u53ef\u4ee5\u7ba1\u7406\u5b9e\u9645\u5b9e\u65bd\u7684\u590d\u6742\u6027\u3002</p> </li> </ol> <p>\u6709\u79cd\u573a\u666f\u5177\u6709\u6240\u6709\u8fd9\u4e9b\u7279\u5f81\uff0c\u90a3\u5c31\u662f\u5fae\u670d\u52a1\uff01</p>"},{"location":"chap9/6k8s_mtls/#mtls_2","title":"\u4f7f\u7528 mTLS \u6765\u4fdd\u62a4\u5fae\u670d\u52a1\u7684\u5b89\u5168","text":"<p>mTLS \u662f\u4fdd\u8bc1\u5fae\u670d\u52a1\u4e4b\u95f4\u8de8\u670d\u52a1\u901a\u4fe1\u5b89\u5168\u7684\u597d\u65b9\u6cd5\uff0c\u539f\u56e0\u5c31\u5728\u4e0a\u9762\u3002</p> <p>\u9996\u5148\uff0c\u4f60\u60f3\u8981\u5b89\u5168\u7684\u901a\u4fe1\u3002\u5f53\u6211\u4eec\u628a\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u62c6\u5206\u4e3a\u591a\u4e2a\u670d\u52a1\u65f6\uff0c\u6211\u4eec\u6700\u7ec8\u4f1a\u5728\u8fd9\u4e9b\u670d\u52a1\u4e4b\u95f4\u7684\u7f51\u7edc\u4e0a\u53d1\u9001\u654f\u611f\u6570\u636e\u3002\u4efb\u4f55\u80fd\u591f\u8fdb\u5165\u7f51\u7edc\u7684\u4eba\u90fd\u6709\u53ef\u80fd\u8bfb\u53d6\u8fd9\u4e9b\u654f\u611f\u6570\u636e\u5e76\u4f2a\u9020\u8bf7\u6c42\u3002</p> <p>\u7b2c\u4e8c\uff0c\u4f60\u5173\u5fc3\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u3002\u9996\u5148\uff0c\u4f60\u8981\u786e\u4fdd\u4f60\u80fd\u77e5\u9053\u8c03\u7528\u662f\u4ec0\u4e48\u65f6\u5019\u53d1\u751f\u7684\uff0c\u4ee5\u4fbf\u8fdb\u884c\u8bca\u65ad\uff0c\u5e76\u6b63\u786e\u8bb0\u5f55\u6307\u6807\u7b49\u4e8b\u9879\u3002\u6b64\u5916\uff0c\u4f60\u53ef\u80fd\u60f3\u5bf9\u8fd9\u4e9b\u8eab\u4efd\u8fdb\u884c\u6388\u6743\uff08\u5141\u8bb8 A \u8c03\u7528 B \u5417\uff09\u3002\u6211\u4eec\u5c06\u5728\u540e\u9762\u8ba8\u8bba\u66f4\u591a\u5173\u4e8e\u6388\u6743\u7684\u95ee\u9898\u3002</p> <p>\u7b2c\u4e09\uff0c\u4f60\u5e76\u4e0d\u771f\u7684\u60f3\u4e3a\u7ba1\u7406\u670d\u52a1\u8eab\u4efd\u5efa\u7acb\u5e94\u7528\u7ea7\u7684\u6d41\u7a0b\u3002\u8fd9\u4e0d\u662f\u4e1a\u52a1\u903b\u8f91\uff0c\u5f00\u53d1\u4eba\u5458\u7684\u65f6\u95f4\u6700\u597d\u7528\u5728\u5176\u4ed6\u5730\u65b9\u3002</p> <p>\u6700\u540e\uff0c\u5982\u679c\u4f60\u63a7\u5236\u4e86\u5e73\u53f0\uff0c\u4f60\u5b9e\u9645\u4e0a\u53ef\u4ee5\u7ba1\u7406\u5b9e\u65bd mTLS \u7684\u590d\u6742\u6027\u3002\u6216\u8005\u81f3\u5c11\uff0c\u6bd4 GitHub \u505a\u5f97\u66f4\u597d\u3002\u5728\u6211\u4eec\u7684 GitHub \u4f8b\u5b50\u4e2d\uff0c\u6bcf\u4e2a\u7528\u6237\u90fd\u5fc5\u987b\u89e3\u51b3\u5bf9 GitHub \u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u7684\u96be\u9898\u3002\u8fd9\u4e2a\u6311\u6218\u8d8a\u96be\uff0c\u5bf9\u7528\u6237\u5c31\u8d8a\u4e0d\u5229\uff08\u5bf9 GitHub \u7684\u5e95\u7ebf\u4e5f\u8d8a\u4e0d\u5229\uff09\u3002\u4f46\u662f\uff0c\u5982\u679c\u6211\u4eec\u80fd\u5728\u5e73\u53f0\u5c42\u9762\u4e0a\u5b9e\u73b0 mTLS\uff0c\u6211\u4eec\u5c31\u80fd\u4e00\u6b21\u6027\u652f\u4ed8\u6210\u672c\uff0c\u800c\u4e0d\u662f\u4e3a\u6bcf\u4e2a\u670d\u52a1\u6216\u6bcf\u4e2a\u7528\u6237\u652f\u4ed8\u3002</p> <p>\u7efc\u4e0a\u6240\u8ff0\uff0cmTLS \u975e\u5e38\u9002\u7528\u4e8e\u786e\u4fdd\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u5b89\u5168\u3002\u4f46\u662f\u6709\u4e00\u4e2a\u95ee\u9898\u3002</p>"},{"location":"chap9/6k8s_mtls/#tls_1","title":"\u5b9e\u65bd TLS \u7684\u96be\u70b9\uff1a\u8bc1\u4e66\u7ba1\u7406","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u4e3a mTLS \u63cf\u7ed8\u4e86\u4e00\u5e45\u7f8e\u597d\u7684\u56fe\u666f\u3002\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u6109\u5feb\u5730\u76f8\u4e92\u8ba4\u8bc1\uff0c\u7136\u540e\u5b83\u4eec\u4e4b\u95f4\u7684\u901a\u4fe1\u5c31\u5b89\u5168\u4e86\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c\u963b\u788d mTLS \u5de5\u4f5c\u7684\u6700\u5927\u6311\u6218\u662f\u8bc1\u4e66\u7ba1\u7406\u3002</p> <p>TLS \u4e2d\u7684\u8ba4\u8bc1\u662f\u901a\u8fc7 \u516c\u94a5\u5bc6\u7801\u5b66\u548c\u516c\u94a5\u57fa\u7840\u8bbe\u65bd\uff08PKI\uff09\u8fdb\u884c\u7684 \u3002\u8fd9\u4e24\u8005\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u5de8\u5927\u7684\u8bdd\u9898\uff0c\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u6211\u4eec\u4e0d\u4f1a\u53bb\u8ba8\u8bba\u8fd9\u4e9b\u7ec6\u8282\u3002\u4f46\u7b80\u800c\u8a00\u4e4b\uff0c\u5b83\u4eec\u6d89\u53ca\u5927\u91cf\u7684\u8bc1\u4e66\u3002</p> <p>TLS \u8ba4\u8bc1\u57fa\u4e8e X.509 \u8bc1\u4e66\u3002X.509 \u8bc1\u4e66\u4e2d\u5305\u542b\u8eab\u4efd\u548c\u516c\u94a5\u3002\u516c\u94a5\u6709\u4e00\u4e2a\u76f8\u5e94\u7684\u79c1\u94a5\uff0c\u5b83\u4e0d\u662f\u8bc1\u4e66\u7684\u4e00\u90e8\u5206\u3002TLS \u8ba4\u8bc1\u5206\u4e24\u6b65\uff0c</p> <ul> <li>\u7b2c\u4e00\u6b65\u662f\u5411\u5bf9\u65b9\u5c55\u793a\u4f60\u7684\u8bc1\u4e66\uff0c\u7136\u540e\u7528\u79c1\u94a5\u6765\u8bc1\u660e\u8bc1\u4e66\u4e2d\u5305\u542b\u7684\u8eab\u4efd\u5c5e\u4e8e\u4f60\uff08\u516c\u94a5\u5bc6\u7801\u5b66\u7684\u795e\u5947\u4e4b\u5904\u5728\u4e8e\uff0c\u4efb\u4f55\u590d\u5236\u8bc1\u4e66\u7684\u4eba\u90fd\u65e0\u6cd5\u8fdb\u884c\u8fd9\u79cd\u8bc1\u660e\uff0c\u56e0\u4e3a\u4ed6\u4eec\u6ca1\u6709\u79c1\u94a5\u3002\u56e0\u6b64\uff0c\u4f60\u53ef\u4ee5\u975e\u5e38\u81ea\u7531\u5730\u4f7f\u7528\u8bc1\u4e66\uff0c\u5305\u62ec\u901a\u8fc7\u660e\u6587\u6e20\u9053\u53d1\u9001\u8bc1\u4e66\u6216\u5c06\u5176\u5b58\u50a8\u5728\u516c\u5f00\u573a\u5408\uff09\u3002</li> </ul> <p>X.509 \u8bc1\u4e66\u662f\u7531\u4e00\u4e2a \u8bc1\u4e66\u6388\u6743\u673a\u6784\uff08Certificate Authority\uff0c\u7b80\u79f0 CA\uff09 \u7b7e\u7f72\uff0c\u5176\u4e2d\u5305\u62ec\u53d7 CA \u4fe1\u4efb\u8be5\u7684\u8eab\u4efd\u3002</p> <ul> <li>\u8bc1\u4e66\u7528\u4e8e TLS \u8ba4\u8bc1\u7684\u7b2c\u4e8c\u6b65\uff1a\u5982\u679c\u6709\u4eba\u5411\u4f60\u5c55\u793a\u4ed6\u4eec\u7684\u8eab\u4efd\u5e76\u8bc1\u660e\u4ed6\u4eec\u62e5\u6709\u8be5\u8eab\u4efd\uff0c\u4f60\u73b0\u5728\u5fc5\u987b\u51b3\u5b9a\u662f\u5426\u4fe1\u4efb\u8be5\u8eab\u4efd\u3002</li> <li>TLS \u5728\u8fd9\u91cc\u4f7f\u7528\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u89c4\u5219\uff1a\u5982\u679c\u8bc1\u4e66\u662f\u7531 CA \u7b7e\u7f72\u7684\uff0c\u4e14\u4f60\u4fe1\u4efb\u8be5 CA\uff0c\u90a3\u4e48\u4f60\u5c31\u5e94\u8be5\u4fe1\u4efb\u8be5\u8eab\u4efd\u3002\u5982\u4f55\u9a8c\u8bc1 CA \u5bf9\u8bc1\u4e66\u7684\u7b7e\u540d\uff1f\u901a\u8fc7\u4f7f\u7528\u8be5 CA \u672c\u8eab\u7684 X.509 \u8bc1\u4e66\u3002\u600e\u4e48\u77e5\u9053\u662f\u5426\u5e94\u8be5\u4fe1\u4efb\u8be5 CA\uff1f</li> </ul> <p>\u55ef\uff0c\u8fd9\u4e2a\u5c31\u4e0e TLS \u534f\u8bae\u672c\u8eab\u65e0\u5173\uff0c\u4f60\u4f1a\u88ab\u5916\u754c\u544a\u77e5\u5e94\u8be5\u4fe1\u4efb\u5b83\uff08\u4f8b\u5982\uff0c\u4f60\u7684\u6d4f\u89c8\u5668\u5e26\u6709\u77e5\u540d\u516c\u5171 CA \u7684\u8bc1\u4e66\uff0c\u5982 Verisign\u3001Digicert \u7b49\uff0c\u8fd9\u4e9b\u8bc1\u4e66\u5728\u53d1\u5e03\u65f6\u88ab\u6253\u5305\u5728\u4e00\u8d77\u3002\u5f53\u4f60\u4e0b\u8f7d Firefox \u65f6\uff0c\u4f60\u76f8\u4fe1 Mozilla \u5df2\u7ecf\u628a\u6b63\u786e\u7684\u8bc1\u4e66\u653e\u8fdb\u4e86\u6d4f\u89c8\u5668\u3002\u5bf9\u4e8e\u96c6\u7fa4\u5185\u7684\u901a\u4fe1\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u6211\u4eec\u81ea\u5df1\u7684 CA\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u4e5f\u5fc5\u987b\u4ee5\u4e00\u79cd\u5b89\u5168\u7684\u65b9\u5f0f\uff0c\u5c06\u8fd9\u4e2a CA \u7684\u8bc1\u4e66\u5206\u53d1\u7ed9\u96c6\u7fa4\u7684\u6bcf\u4e2a\u90e8\u5206\uff0c\u8fd9\u4e9b\u90e8\u5206\u9700\u8981\u505a\u51fa\u4fe1\u4efb\u51b3\u5b9a\uff09\u3002</p> <p>CA \u4e5f\u7b7e\u53d1\u8bc1\u4e66\u3002\u8981\u83b7\u5f97\u8bc1\u4e66\uff0c\u4f60\u9996\u5148\u8981\u521b\u5efa\u516c\u94a5\u548c\u79c1\u94a5\u5bf9\u3002\u4f60\u4fdd\u7559\u79c1\u94a5\uff0c\u55ef\uff0c\u79c1\u94a5 \u2014\u2014 \u5343\u4e07\u4e0d\u8981\u5728\u7f51\u7edc\u4e0a\u53d1\u9001\u79c1\u94a5 \u2014\u2014 \u4f60\u5411 CA \u53d1\u9001\u4e00\u4e2a\u5305\u542b\u516c\u94a5\u548c\u4f60\u8eab\u4efd\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff08Certificate Signing Request\uff0c\u7b80\u79f0 CSR\uff09\u3002\u5982\u679c CA \u6279\u51c6\u4e86\u8fd9\u4e2a\u8bf7\u6c42\uff0c\u5b83\u5c31\u4f1a\u521b\u5efa\u548c\u7b7e\u7f72\u8bc1\u4e66\uff0c\u5e76\u628a\u8bc1\u4e66\u53d1\u9001\u7ed9\u4f60\u3002</p> <p>\u6240\u4ee5\uff0c\u8bc1\u4e66\u7ba1\u7406\u5c31\u662f\u5c31\u6210\u4e86\u8bc1\u4e66\u521b\u5efa\u548c\u5206\u53d1\u6d41\u7a0b\u4e2d\u7684\u6311\u6218\u3002\u6211\u4eec\u9700\u8981\u786e\u4fdd\u6709\u4e00\u4e2a CA\uff0c\u6bcf\u4e2a\u670d\u52a1\u90fd\u53ef\u4ee5\u5411\u5176\u53d1\u9001 CSR\uff0c\u800c\u4e14 CA \u53ef\u4ee5\u628a\u8bc1\u4e66\u53d1\u9001\u7ed9\u670d\u52a1\u3002\u6211\u4eec\u8fd8\u9700\u8981\u786e\u4fdd CA \u7684\u5b89\u5168\uff0c\u6ca1\u6709\u4eba\u80fd\u591f\u8bbf\u95ee\u4efb\u4f55\u670d\u52a1\u7684\u79c1\u94a5\uff0c\u800c\u4e14\u6bcf\u4e2a\u670d\u52a1\u90fd\u77e5\u9053\u81ea\u5df1\u7684\u8eab\u4efd\uff0c\u800c\u4e14\u4e0d\u80fd\u88ab\u6539\u53d8\u3002</p> <p>\u5728 Kubernetes \u8fd9\u6837\u7684\u73af\u5883\u4e2d\uff0c\u670d\u52a1\u5b9e\u9645\u4e0a\u662f\u4e00\u7ec4\u4e0d\u65ad\u53d8\u5316\u7684\u526f\u672c\uff0c\u53ef\u4ee5\u968f\u65f6\u521b\u5efa\u6216\u9500\u6bc1\uff0c\u6bcf\u4e2a\u526f\u672c\u90fd\u9700\u8981\u81ea\u5df1\u7684\u8bc1\u4e66\uff0c\u8fd9\u4f7f\u5f97\u8bc1\u4e66\u5206\u53d1\u7684\u6311\u6218\u66f4\u52a0\u4e25\u5cfb\u3002</p> <p>\u800c\u4e14 \uff0c \u7531\u4e8e\u5728\u5b9e\u8df5\u4e2d\uff0c\u51cf\u5c11\u8bc1\u4e66\u66b4\u9732\u635f\u5931\uff08\u5373\u5f53\u6709\u4eba\u672a\u7ecf\u6388\u6743\u83b7\u5f97\u79d8\u94a5\u65f6\uff09\u7684\u6700\u597d\u65b9\u6cd5\u662f\u8bc1\u4e66\u8f6e\u6362\uff1a\u7f29\u77ed\u8bc1\u4e66\u7684\u5bff\u547d\uff0c\u5728\u8bc1\u4e66\u8fc7\u671f\u524d\u91cd\u65b0\u9881\u53d1\u3002\u8fd9\u610f\u5473\u7740\u6211\u4eec\u9700\u8981\u6bcf\u9694 n \u5c0f\u65f6\u4e3a\u6bcf\u4e2a\u526f\u672c\u91cd\u590d\u6574\u4e2a\u8bc1\u4e66\u8bf7\u6c42\u548c\u7b7e\u540d\u7684\u6d41\u7a0b\u3002</p> <p>\u5982\u679c\u6211\u4eec\u60f3\u5728\u591a\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u6269\u5c55\u5b89\u5168\u901a\u4fe1\uff0c\u9700\u8981\u4e00\u79cd\u65b9\u6cd5\u6765\u786e\u4fdd\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u4ea7\u751f\u7684\u8eab\u4efd\u53ef\u4ee5\u88ab\u5176\u4ed6\u96c6\u7fa4\u6240\u4f7f\u7528\uff0c\u800c\u4e14\u5982\u679c\u67d0\u4e2a\u96c6\u7fa4\u88ab\u7834\u574f\uff0c\u6211\u4eec\u53ef\u4ee5\u7981\u7528\u8be5\u96c6\u7fa4\u800c\u4e0d\u7981\u7528\u5176\u4ed6\u96c6\u7fa4\uff0c\u8fd9\u5c31\u8fdb\u4e00\u6b65\u589e\u52a0\u4e86\u8bc1\u4e66\u7ba1\u7406\u7684\u590d\u6742\u6027\uff0c\u56e0\u4e3a\u8fd9\u5c06\u4ea7\u751f\u66f4\u591a\u7684\u8bc1\u4e66\u3002</p> <p>\u603b\u4e4b\uff0c\u5b9e\u65bd mTLS \u6d89\u53ca\u5230\u7ba1\u7406\u5927\u91cf\u7684\u8bc1\u4e66\uff0c\u6d88\u8017\u5927\u91cf\u7684\u65f6\u95f4\u3002\u8fd9\u4e00\u6311\u6218\u7684\u590d\u6742\u6027\u4ee4\u4eba\u751f\u754f\u3002\u4f46\u5c3d\u7ba1\u5982\u6b64\uff0cmTLS \u5728 Kubernetes \u7684\u4e16\u754c\u91cc\u5df2\u7ecf\u770b\u5230\u4e86\u4e00\u4e9b\u590d\u5174\u7684\u8d8b\u52bf\u3002\u8fd9\u662f\u56e0\u4e3a\u6709\u4e00\u95e8\u6280\u672f\u4f7f mTLS \u53d8\u5f97\u53ef\u884c\uff1a\u670d\u52a1\u7f51\u683c\u3002</p>"},{"location":"chap9/6k8s_mtls/#kubernetesmtls","title":"Kubernetes\u3001mTLS \u548c\u670d\u52a1\u7f51\u683c","text":"<p>\u670d\u52a1\u7f51\u683c\u662f\u4e3a\u96c6\u7fa4\u5f00\u542f mTLS \u7684\u4e00\u4e2a\u7edd\u4f73\u7684\u673a\u5236\u3002\u5b83\u4e0d\u4ec5\u53ef\u4ee5\u5904\u7406\u8bc1\u4e66\u7ba1\u7406\u7684\u6311\u6218\uff0c\u8fd8\u53ef\u4ee5\u5904\u7406\u5efa\u7acb\u548c\u63a5\u6536 TLS \u8fde\u63a5\u672c\u8eab\u3002\u5b83\u4f7f\u5f97\u4e3a\u96c6\u7fa4\u6dfb\u52a0 mTLS \u6210\u4e3a\u4e00\u4e2a\u96f6\u914d\u7f6e\u7684\u64cd\u4f5c\uff1a\u5f53\u4f60\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88c5\u670d\u52a1\u7f51\u683c\u7684\u65f6\u5019\uff0c\u7f51\u683c\u5316\u7684 pod \u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u90fd\u81ea\u52a8\u88ab mTLS \u5316\u3002\u5bf9\u4e8e\u50cf mTLS \u8fd9\u6837\u590d\u6742\u7684\u4e1c\u897f\u6765\u8bf4\uff0c\u8fd9\u662f\u5f88\u4e0d\u53ef\u601d\u8bae\u7684\u3002</p> <p>\u8fd9\u4e00\u5207\u4e4b\u6240\u4ee5\u80fd\u591f\u5b9e\u73b0\uff0c\u662f\u56e0\u4e3a Kubernetes \u4f7f\u4e00\u4e9b\u672c\u6765\u975e\u5e38\u590d\u6742\u7684\u4e8b\u60c5\uff0c\u5982 sidecar \u6a21\u5f0f\uff0c\u53d8\u5f97\u7b80\u5355\u6613\u884c\u3002\u5f97\u76ca\u4e8e Kubernetes\uff0c\u670d\u52a1\u7f51\u683c\u53ef\u4ee5\uff1a</p> <ul> <li>\u900f\u660e\u5730\u5c06\u4e00\u4e2a sidecar \u4ee3\u7406\u6ce8\u5165\u5230\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684 pod \u4e2d\uff0c\u5e76\u901a\u8fc7\u8be5\u4ee3\u7406\u8def\u7531\u6240\u6709\u8fdb\u51fa pod \u7684 TCP \u901a\u4fe1\u3002</li> <li>\u5c06\u4e00\u4e2a\u5185\u90e8 CA \u4f5c\u4e3a\u5176\u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\uff0c\u7b7e\u53d1 TLS \u8bc1\u4e66\uff0c\u5e76\u5c06\u8be5 CA \u7684\u8bc1\u4e66\u5b89\u5168\u5730\u5206\u914d\u7ed9\u6240\u6709\u4ee3\u7406\u3002</li> <li>\u4f7f\u7528\u8fd9\u4e2a CA \u5411\u6bcf\u4e2a\u4ee3\u7406\u53d1\u653e\u77ed\u671f\u7684\u8bc1\u4e66\uff0c\u4e0e pod \u7684 Kubernetes ServiceAccount \u8eab\u4efd\u76f8\u8054\u7cfb\u3002</li> <li>\u6bcf\u9694 N \u5c0f\u65f6\u91cd\u65b0\u7b7e\u53d1\u8fd9\u4e9b\u8bc1\u4e66\u3002</li> <li>\u8ba9\u6bcf\u4e2a\u4ee3\u7406\u5bf9\u6240\u6709\u4f7f\u7528\u8fd9\u4e9b\u8bc1\u4e66\u7684 pod \u7684\u8fde\u63a5\u6267\u884c mTLS\uff0c\u786e\u4fdd\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u53cc\u65b9\u90fd\u6709\u6709\u6548\u7684\u8eab\u4efd\u3002</li> <li>\u5728\u8fde\u63a5\u8fdb\u5165\u5e94\u7528\u7a0b\u5e8f\u4e4b\u524d\uff0c\u4f7f\u7528\u8fd9\u4e9b\u8eab\u4efd\u5e94\u7528\u6388\u6743\u7b56\u7565\u3002</li> </ul> <p>\u5f53\u7136\uff0c\u8fd9\u53ea\u662f\u4e00\u79cd\u7b80\u5316\u7684\u63cf\u8ff0\u3002\u4f8b\u5982\uff0cLinkerd \u5b9e\u9645\u4e0a\u4f7f\u7528\u4e86\u4e24\u7ea7 CA\uff0c\u4e00\u4e2a\u5728\u96c6\u7fa4\u5c42\u9762\uff0c\u4e00\u4e2a\u5728\u5168\u5c40\u5c42\u9762\uff0c\u4ee5\u4fbf\u5141\u8bb8\u8de8\u96c6\u7fa4\u901a\u4fe1\u3002Linkerd \u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a\u4fe1\u4efb\u6839\uff0c\u6240\u4ee5\u4f60\u4e5f\u53ef\u4ee5\u8f6e\u6d41\u4f7f\u7528 CA\u3002</p>"},{"location":"chap9/6k8s_mtls/#mtls_3","title":"\u5e38\u89c1\u95ee\u9898\uff1amTLS \u5b9e\u9645\u4e0a\u80fd\u4fdd\u62a4\u4ec0\u4e48\uff1f","text":"<p>\u4e8b\u5b9e\u4e0a\uff0cmTLS \u53ea\u80fd\u7528\u4e8e\u9632\u6b62\u7279\u5b9a\u7684\u653b\u51fb\uff1a\u672a\u7ecf\u6388\u6743\u7684\u7f51\u7edc\u8bbf\u95ee\u3002\u963b\u6b62\u5165\u4fb5\u8005\u55c5\u63a2\u7f51\u7edc\u8bf7\u6c42\u4e2d\u7684\u5185\u5bb9\uff0c\u963b\u6b62\u5192\u5145\u670d\u52a1\u8fdb\u884c\u8bbf\u95ee\u3002</p> <p>\u4f46\u662f\u6709\u5f88\u591a\u4e1c\u897f\u662f mTLS \u4e0d\u80fd\u4fdd\u62a4\u7684\uff0c\u4f8b\u5982\u672a\u7ecf\u6388\u6743\u4e3b\u673a\u8bbf\u95ee\u3002\u5982\u679c\u9ed1\u5ba2\u5165\u4fb5\u8fdb\u4e86\u4e3b\u673a\uff0cmTLS \u4fdd\u62a4\u5c31\u65e0\u6d4e\u4e8e\u4e8b\u4e86\uff1a\u5165\u4fb5\u8005\u53ef\u4ee5\u8bfb\u53d6\u5bc6\u5319\uff0c\u55c5\u63a2\u6216\u6b3a\u9a97\u8fde\u63a5\uff0c\u98a0\u8986 CA \u5e76\u9020\u6210\u7834\u574f\uff0c\u6216\u4efb\u4f55\u5176\u4ed6\u6076\u610f\u6d3b\u52a8\u3002</p> <p>\u786e\u4fdd Kubernetes \u7684\u5b89\u5168\u5e76\u4e0d\u5bb9\u6613\uff0c\u5b9e\u9645\u4e0a mTLS \u53ea\u89e3\u51b3\u4e86 Kubernetes \u7684\u4e00\u5c0f\u90e8\u5206\u5b89\u5168\u6f0f\u6d1e\u3002</p>"},{"location":"chap9/6k8s_mtls/#mtls-ipsec-wireguard","title":"mTLS \u4e0e IPSec \u6216 Wireguard \u7b49\u7f51\u7edc\u5c42\u52a0\u5bc6\u76f8\u6bd4\u600e\u4e48\u6837\uff1f","text":"<p>\u5728 Kubernetes \u4e2d\uff0c\u4e00\u4e9b CNI \u63d2\u4ef6\u5982 Calico \u548c Cilium \u53ef\u4ee5\u901a\u8fc7 IPSec \u6216 Wireguard \u7b49\u534f\u8bae\u63d0\u4f9b\u7f51\u7edc\u5c42\u52a0\u5bc6\u3002\u50cf\u670d\u52a1\u7f51\u683c\u4e00\u6837\uff0c\u8fd9\u79cd\u7f51\u7edc\u5c42\u52a0\u5bc6\u53ef\u4ee5\u63d0\u4f9b\u4f20\u8f93\u5c42\u52a0\u5bc6\uff0c\u800c\u5e94\u7528\u7a0b\u5e8f\u672c\u8eab\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u4e8b\u60c5\u3002</p> <p>\u867d\u7136\u7f51\u7edc\u5c42\u52a0\u5bc6\u53ef\u4ee5\u4e0e mTLS \u7ed3\u5408\u4f7f\u7528\uff0c\u4f5c\u4e3a\u4e00\u79cd\u6df1\u5ea6\u9632\u5fa1\u7684\u5f62\u5f0f\uff0c\u4f46\u6709\u51e0\u4e2a\u539f\u56e0\u53ef\u4ee5\u8bf4\u660e\u7f51\u7edc\u5c42\u52a0\u5bc6\u4e0d\u8db3\u4ee5\u66ff\u4ee3 mTLS\u3002</p> <p>\u5982\u4f60\u6240\u6599\uff0c\u7f51\u7edc\u5c42\u52a0\u5bc6\u7684\u6700\u5927\u7f3a\u70b9\u662f\u56f4\u7ed5\u8eab\u4efd\u7684\u3002\u56e0\u4e3a\u5b83\u4eec\u5728\u7f51\u7edc\u5c42\u5de5\u4f5c\uff0cWireguard \u548c IPSec \u53ea\u80fd\u63d0\u4f9b\u7f51\u7edc\u8eab\u4efd\uff0c\u800c\u4e0d\u662f\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u5b83\u4eec\u4e0d\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u672c\u8eab\u56fa\u6709\u7684\u8eab\u4efd\uff08\u6bd4\u5982 SPIFFE \u6216\u8005 Kubernetes \u7684 ServiceAccount\uff09\uff0c\u800c\u662f\u4f7f\u7528\u8be5\u5de5\u4f5c\u8d1f\u8f7d\u8fd0\u884c\u7684 IP \u5730\u5740\u3002</p> <p>\u4f9d\u9760\u7f51\u7edc\u8eab\u4efd\u6709\u4e00\u7cfb\u5217\u7684\u95ee\u9898\uff0c\u5305\u62ec\uff1a</p> <ol> <li>\u8eab\u4efd\u7ec8\u6b62\u5728\u96c6\u7fa4\u8fb9\u754c\u3002Kubernetes \u4e2d\u7684 IP \u5730\u5740\u662f\u4ee5\u96c6\u7fa4\u4e3a\u8303\u56f4\u7684\uff0c\u5f53\u8de8\u8d8a\u96c6\u7fa4\u8fb9\u754c\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u5fc5\u987b\u60f3\u51fa\u53e6\u4e00\u79cd\u8eab\u4efd\u673a\u5236\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u6b63\u5728\u8fdb\u884c\u8de8\u96c6\u7fa4\u901a\u4fe1\uff0c\u6216\u8005\u60f3\u8981\u4e00\u4e2a\u6db5\u76d6\u975e Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u7684\u8eab\u4efd\u7cfb\u7edf\uff0cIP \u5730\u5740\u5c31\u4f1a\u843d\u7a7a\u3002</li> <li>\u6ca1\u6709\u76f4\u63a5\u7684\u673a\u5236\u8fdb\u884c\u7ec6\u7c92\u5ea6\u7684\u6388\u6743\u3002\u7f51\u7edc\u5c42\u65b9\u6cd5\u4e0d\u80fd\u8bbf\u95ee\u4e03\u5c42\u4fe1\u606f\uff0c\u5982 HTTP \u8def\u7531\u3001\u52a8\u8bcd\u4ee5\u53ca gRPC \u65b9\u6cd5\uff08\u6709\u4e9b\u590d\u6742\u7684 CNI \u901a\u8fc7\u542f\u52a8\u4e00\u4e2a\u4e03\u5c42\u4ee3\u7406\u6765\u89e3\u6790\u6570\u636e\uff0c\u4ee5\u670d\u52a1\u7f51\u683c\u6a21\u5f0f\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff09\u3002</li> <li>\u8fd9\u4e0d\u662f\u96f6\u4fe1\u4efb\u3002\u96f6\u4fe1\u4efb\u7684\u5b89\u5168\u6a21\u5f0f\u8981\u6c42\u6211\u4eec\u5c06\u5b89\u5168\u8fb9\u754c\u8f6c\u79fb\u5230\u5c3d\u53ef\u80fd\u7ec6\u7684\u5c42\u6b21\u3002\u5728 Kubernetes \u4e2d\uff0c\u8fd9\u4e2a\u5355\u4f4d\u5c31\u662f pod\u3002\u6709\u4e86\u670d\u52a1\u7f51\u683c\u7684 mTLS\uff0c\u4f60\u7684\u5b89\u5168\u8fb9\u754c\u5c31\u5728 pod \u5c42\u9762\uff0c\u4f46\u5bf9\u4e8e\u7f51\u7edc\u5c42\u7684\u52a0\u5bc6\uff0c\u4f60\u7684\u5b89\u5168\u8fb9\u754c\u6700\u591a\u53ea\u80fd\u5728\u4e3b\u673a\u5c42\u9762\u6267\u884c\uff1b\u4f60\u5fc5\u987b\u4fe1\u4efb\u7f51\u7edc\uff0c\u7b49\u7b49\u3002</li> </ol>"},{"location":"chap9/8istio_mtls/","title":"\u7b2c\u4e03\u8282 \u5982\u4f55\u7406\u89e3 Istio \u4e2d\u7684 mTLS \u6d41\u91cf\u52a0\u5bc6\uff1f","text":"<p>Istio \u670d\u52a1\u7f51\u683c\u53ef\u4ee5\u5e2e\u52a9\u4e91\u539f\u751f\u5e94\u7528\u5b9e\u73b0\u81ea\u52a8 mTLS\uff0c\u5b8c\u6210\u7f51\u683c\u5185\u7684\u6d41\u91cf\u52a0\u5bc6\uff0c\u6709\u52a9\u4e8e\u7f29\u5c0f\u4e91\u539f\u751f\u90e8\u7f72\u7684\u653b\u51fb\u9762\uff0c\u662f\u6784\u5efa\u96f6\u4fe1\u4efb\u5e94\u7528\u7f51\u7edc\u7684\u5173\u952e\u6846\u67b6\u3002\u4e3a\u4e86\u7406\u89e3 Istio \u4e2d\u7684 mTLS \u6d41\u91cf\u52a0\u5bc6\uff0c\u672c\u6587\u5c06\u5305\u62ec\u4ee5\u4e0b\u5185\u5bb9\uff1a</p>"},{"location":"chap9/8istio_mtls/#tls-mtls","title":"\u4ec0\u4e48\u662f TLS \u548c mTLS\uff1f","text":"<p>TLS\uff08Transport Layer Security\uff0c\u4f20\u8f93\u5c42\u5b89\u5168\u6027\uff09\u662f\u4e00\u79cd\u5e7f\u6cdb\u91c7\u7528\u7684\u5b89\u5168\u534f\u8bae\uff0c\u7528\u4e8e\u5728\u8054\u7f51\u8ba1\u7b97\u673a\u4e4b\u95f4\u5efa\u7acb\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u548c\u52a0\u5bc6\u7684\u94fe\u63a5\uff0c\u65e8\u5728\u4fc3\u8fdb\u4e92\u8054\u7f51\u901a\u4fe1\u7684\u79c1\u5bc6\u6027\u548c\u6570\u636e\u5b89\u5168\u6027\u3002</p> <p>TLS \u4f5c\u4e3a SSL\uff08Secure Socket Layer\uff0c\u5b89\u5168\u5957\u63a5\u5b57\u5c42\uff09\u7684\u7ee7\u4efb\u8005\uff0c\u5b9e\u9645\u4e0a\u662f\u7531 SSL \u6539\u540d\u800c\u6765\uff0c\u56e0\u6b64\u4eba\u4eec\u7ecf\u5e38\u5c06 TLS/SSL \u6df7\u7528\uff0c\u5728\u672c\u6587\u4e2d\u6211\u4eec\u5c06\u7edf\u79f0\u4e3a TLS\u3002</p> <p>TLS 1.0 \u53d1\u5e03\u4e8e 1999 \u5e74\uff0c\u6700\u65b0\u7248\u672c\u4e3a 1.3\uff08\u53d1\u5e03\u4e8e 2018 \u5e74 8 \u6708\uff09\uff0c1.0 \u548c 1.1 \u7248\u672c\u5df2\u5f03\u7528\u3002</p> <p>\u6211\u4eec\u5728\u6d4f\u89c8\u7f51\u9875\u65f6\u770b\u5230\u7684 HTTPS \u5b9e\u9645\u4e0a\u5c31\u4f7f\u7528\u4e86 TLS\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002TLS \u662f\u5efa\u7acb\u5728 TCP \u4e4b\u4e0a\u7684\uff0c\u4f5c\u4e3a OSI \u6a21\u578b\u4e2d\u7684\u4f1a\u8bdd\u5c42\u3002\u4e3a\u4e86\u4fdd\u8bc1\u517c\u5bb9\u6027\uff0cTLS \u901a\u5e38\u4f7f\u7528 443 \u7aef\u53e3\uff0c\u4f46\u662f\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4efb\u610f\u7aef\u53e3\u3002</p> <p> </p> <p>\u5f53\u5ba2\u6237\u7aef\u9700\u8981\u9a8c\u8bc1\u670d\u52a1\u7aef\u8eab\u4efd\uff0c\u4ee5\u9632\u4e2d\u95f4\u4eba\u653b\u51fb\u540c\u65f6\u4fdd\u8bc1\u901a\u4fe1\u5b89\u5168\u7684\u60c5\u51b5\u4e0b\uff0c\u5728\u548c\u670d\u52a1\u7aef\u901a\u4fe1\u65f6\u4f1a\u8981\u6c42 TLS \u52a0\u5bc6\u3002\u4e0b\u56fe\u5c55\u793a\u4e86\u7684\u662f TLS \u52a0\u5bc6\u901a\u4fe1\u7684\u6d41\u7a0b\u3002</p> <p> </p> <ol> <li>\u670d\u52a1\u5668\u5411\u53d7\u4fe1\u4efb\u7684 CA\uff08\u8bc1\u4e66\u7ba1\u7406\u673a\u6784\uff09\u7533\u8bf7\u5e76\u83b7\u5f97\u8bc1\u4e66\uff08X.509 \u8bc1\u4e66\uff09\uff1b</li> <li>\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u7aef\u53d1\u8d77\u8bf7\u6c42\uff0c\u5176\u4e2d\u5305\u542b\u5ba2\u6237\u7aef\u652f\u6301\u7684 TLS \u7248\u672c\u548c\u5bc6\u7801\u7ec4\u5408\u7b49\u4fe1\u606f\uff1b</li> <li>\u670d\u52a1\u5668\u56de\u5e94\u5ba2\u6237\u7aef\u8bf7\u6c42\u5e76\u9644\u4e0a\u6570\u5b57\u8bc1\u4e66\uff1b</li> <li>\u5ba2\u6237\u7aef\u9a8c\u8bc1\u8bc1\u4e66\u7684\u72b6\u6001\u3001\u6709\u6548\u671f\u548c\u6570\u5b57\u7b7e\u540d\u7b49\u4fe1\u606f\uff0c\u786e\u8ba4\u670d\u52a1\u5668\u7684\u8eab\u4efd\uff1b</li> <li>\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4f7f\u7528\u5171\u4eab\u79d8\u94a5\u5b9e\u73b0\u52a0\u5bc6\u901a\u4fe1\uff1b</li> </ol> <p>\u4ece\u4ee5\u4e0a\u8fc7\u7a0b\u4e2d\u4f60\u4f1a\u53d1\u73b0\uff0c\u8bc1\u4e66\u662f\u4ee3\u8868\u670d\u52a1\u5668\u8eab\u4efd\u7684\u5173\u952e\u8981\u7d20\uff0c\u5bf9\u4e8e\u4e92\u8054\u7f51\u516c\u5f00\u670d\u52a1\uff0c\u670d\u52a1\u5668\u9700\u8981\u4f7f\u7528\u6743\u5a01\u8ba4\u8bc1\u7684 CA \u9881\u53d1\u7684\u8bc1\u4e66\uff0c\u800c\u5bf9\u4e8e\u79c1\u6709\u73af\u5883\u5185\u90e8\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u4f7f\u7528 PKI\uff08Private Key Infrastructure\uff0c\u79c1\u94a5\u57fa\u7840\u8bbe\u65bd\uff09\u6765\u7ba1\u7406\u8bc1\u4e66\u3002</p>"},{"location":"chap9/8istio_mtls/#tls","title":"\u4ec0\u4e48\u662f TLS \u7ec8\u6b62\uff1f","text":"<p>TLS \u7ec8\u6b62\uff08TLS Termination\uff09\u6307\u7684\u662f\u5728\u5c06 TLS \u52a0\u5bc6\u6d41\u91cf\u4f20\u9012\u7ed9 Web \u670d\u52a1\u5668\u4e4b\u524d\u5bf9\u5176\u8fdb\u884c\u89e3\u5bc6\u7684\u8fc7\u7a0b\u3002</p> <p>\u5c06 TLS \u6d41\u91cf\u5378\u8f7d\u5230\u5165\u53e3\u7f51\u5173\u6216\u4e13\u7528\u8bbe\u5907\u4e0a\uff0c\u53ef\u4ee5\u63d0\u9ad8 Web \u5e94\u7528\u7684\u6027\u80fd\uff0c\u540c\u65f6\u786e\u4fdd\u52a0\u5bc6\u6d41\u91cf\u7684\u5b89\u5168\u6027\u3002</p> <p>\u4e00\u822c\u8fd0\u884c\u5728\u96c6\u7fa4\u5165\u53e3\u5904\uff0c\u5f53\u6d41\u91cf\u5230\u8fbe\u5165\u53e3\u5904\u65f6\u5b9e\u65bd TLS \u7ec8\u6b62\uff0c\u5165\u53e3\u4e0e\u96c6\u7fa4\u5185\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u901a\u4fe1\u5c06\u76f4\u63a5\u4f7f\u7528 HTTP \u660e\u6587\uff0c\u8fd9\u6837\u53ef\u4ee5\u63d0\u9ad8\u670d\u52a1\u6027\u80fd\u3002</p> <p> </p> <p>Istio \u9ed8\u8ba4\u5728\u5165\u53e3\u7f51\u5173\u5904\u7ec8\u6b62 TLS\uff0c\u7136\u540e\u518d\u4e3a\u7f51\u683c\u5185\u7684\u670d\u52a1\u5f00\u542f mTLS\u3002</p> <p>\u4f60\u4e5f\u53ef\u4ee5\u8ba9\u6d41\u91cf\u76f4\u901a\uff08passthrough\uff09\u5230\u540e\u7aef\u670d\u52a1\u5904\u7406\uff0c\u4f8b\u5982\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: Gateway\nmetadata:\n  name: sample-gateway\nspec:\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    tls:\n      mode: PASSTHROUGH\n</code></pre>"},{"location":"chap9/8istio_mtls/#istio-mtls_1","title":"Istio \u4e2d\u5982\u4f55\u5b9e\u73b0\u81ea\u52a8 mTLS\uff1f","text":"<p>\u4e0b\u56fe\u4e2d\u5c55\u793a\u7684\u662f Istio \u5b89\u5168\u67b6\u6784\u56fe\uff0c\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\u5728\u5165\u53e3\u5904\u4f7f\u7528 JWS + TLS \u8ba4\u8bc1\u548c\u52a0\u5bc6\uff0c\u5728 Istio \u7f51\u683c\u5185\u90e8\u7684\u6240\u6709\u670d\u52a1\u95f4\u90fd\u5f00\u542f\u4e86 mTLS\u3002</p> <p> </p> <p>Istio \u4e2d\u5185\u7f6e\u4e86 CA\uff0c\u4f7f\u7528 xDS \u4e2d\u7684 SDS\uff08Secret Discovery Service\uff0c\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\uff09\u5b9e\u73b0 SVID \u8bc1\u4e66\u7684\u7b7e\u53d1\u548c\u8f6e\u6362\u3002Istio \u7f51\u683c\u5185\u7684 mTLS \u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>Sidecar \u4ee3\u66ff\u5de5\u4f5c\u8d1f\u8f7d\u5411 Istiod \u7533\u8bf7\u8bc1\u4e66\uff0cIstiod \u7b7e\u53d1 SVID \u8bc1\u4e66</li> <li>\u5ba2\u6237\u7aef\u8bf7\u6c42\u88ab Pod \u5185\u7684 sidecar \u62e6\u622a\uff1b</li> <li>\u5ba2\u6237\u7aef sidecar \u4e0e\u670d\u52a1\u7aef sidecar \u5f00\u59cb mTLS \u63e1\u624b\u3002<ul> <li>\u5728\u63e1\u624b\u7684\u540c\u65f6\uff0c\u5ba2\u6237\u7aef sidecar \u4e2d\u7684 JWT \u548c\u8ba4\u8bc1\u8fc7\u6ee4\u5668\u5c06\u5bf9\u8bf7\u6c42\u7684\u8eab\u4efd\u8fdb\u884c\u8ba4\u8bc1\uff0c\u8ba4\u8bc1\u901a\u8fc7\u540e\u5c06\u8eab\u4efd\u5b58\u50a8\u5728\u8fc7\u6ee4\u5668\u5143\u6570\u636e\u4e2d\uff0c\u7136\u540e\u8bf7\u6c42\u7ecf\u8fc7\u6388\u6743\u8fc7\u6ee4\u5668\uff0c\u5224\u65ad\u8bf7\u6c42\u6743\u9650\u3002</li> </ul> </li> <li>\u82e5\u8bf7\u6c42\u901a\u8fc7\u4e86\u8ba4\u8bc1\u4e0e\u6388\u6743\uff0c\u5219\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u5f00\u59cb\u5efa\u7acb\u8fde\u63a5\u8fdb\u884c\u901a\u4fe1\u3002</li> </ol> <p>Istio \u4e2d\u6709\u4e09\u4e2a\u8d44\u6e90\u5bf9\u8c61\u53ef\u7528\u4e8e\u914d\u7f6e\u670d\u52a1\u95f4\u7684\u8ba4\u8bc1\u4e0e\u6388\u6743\uff1a</p> <ul> <li>RequestAuthentication\uff1a\u7528\u4e8e\u5b9a\u4e49\u670d\u52a1\u652f\u6301\u7684\u8bf7\u6c42\u7ea7\u8ba4\u8bc1\u65b9\u5f0f\uff0c\u76ee\u524d\u53ea\u652f\u6301 JWT\uff1b</li> <li>PeerAuthentication\uff1a\u914d\u7f6e\u670d\u52a1\u95f4\u7684\u4f20\u8f93\u8ba4\u8bc1\u6a21\u5f0f\uff0c\u5982 STRICT\u3001PERMISSIVE \u6216 DISABLE \u7b49\uff0c\u4ee5\u5f00\u542f mTLS \u6216\u660e\u6587\u8bf7\u6c42\uff1b</li> <li>AuthorizationPolicy\uff1a\u7528\u4e8e\u6388\u6743\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5b9a\u4e49\u8c01\u53ef\u4ee5\u505a\u4ec0\u4e48\uff1f\u4f8b\u5982\u4e3b\u4f53 A \u5141\u8bb8\uff08ALLOW\uff09\u6216\u62d2\u7edd\uff08DENY\uff09\u6765\u81ea\u4e3b\u4f53 B \u7684\u6d41\u91cf\uff1b</li> </ul>"},{"location":"chap9/8istio_mtls/#istio-mtls_2","title":"\u5982\u4f55\u4f7f\u7528 Istio \u4e3a\u670d\u52a1\u5f00\u542f\u81ea\u52a8 mTLS\uff1f","text":"<p>\u4f60\u53ef\u4ee5\u5728 PeerAuthentication \u4e2d\u6307\u5b9a\u5bf9\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u65bd\u7684 mTLS \u6a21\u5f0f\u3002\u5bf9\u7b49\u8ba4\u8bc1\u652f\u6301\u4ee5\u4e0b\u6a21\u5f0f\uff1a</p> <ul> <li>PERMISSIVE\uff1a\u9ed8\u8ba4\u503c\uff0c\u5de5\u4f5c\u8d1f\u8f7d\u53ef\u63a5\u53d7\u53cc\u5411 TLS \u6216\u7eaf\u6587\u672c\u6d41\u91cf\uff1b</li> <li>STRICT\uff1a\u5de5\u4f5c\u8d1f\u8f7d\u4ec5\u63a5\u53d7 mTLS \u6d41\u91cf\uff1b</li> <li>DISABLE\uff1a\u7981\u7528 mTLS\u3002\u4ece\u5b89\u5168\u89d2\u5ea6\u6765\u770b\uff0c\u9664\u975e\u4f60\u6709\u81ea\u5df1\u7684\u5b89\u5168\u89e3\u51b3\u65b9\u6848\uff0c\u5426\u5219\u4e0d\u5e94\u7981\u7528 mTLS\uff1b</li> <li>UNSET\uff1a\u4ece\u7236\u7ea7\u7ee7\u627f\uff0c\u4f18\u5148\u7ea7\u4e3a\u670d\u52a1\u7279\u5b9a &gt; \u547d\u540d\u7a7a\u95f4\u8303\u56f4 &gt; \u7f51\u683c\u8303\u56f4\u7684\u8bbe\u7f6e\uff1b</li> </ul> <p>Istio \u7684\u5bf9\u7b49\u8ba4\u8bc1\u9ed8\u8ba4\u4f7f\u7528 PERMISSIVE \u6a21\u5f0f\uff0c\u81ea\u52a8\u5c06 mTLS \u6d41\u91cf\u53d1\u9001\u5230\u8fd9\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5c06\u7eaf\u6587\u672c\u6d41\u91cf\u53d1\u9001\u5230\u6ca1\u6709 sidecar \u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002</p> <p>\u5728\u5c06 Kubernetes \u670d\u52a1\u7eb3\u5165 Istio \u7f51\u683c\u540e\uff0c\u4e3a\u4e86\u9632\u6b62\u670d\u52a1\u65e0\u6cd5\u901a\u8fc7 mTLS\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u4f7f\u7528 PERMISSIVE \u6a21\u5f0f\u3002\u5f53\u6211\u60f3\u4e3a\u67d0\u4e9b\u670d\u52a1\u5f00\u542f\u4e25\u683c\u7684 mTLS \u6a21\u5f0f\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u4e24\u79cd\u65b9\u5f0f\u4e4b\u4e00\uff1a</p> <ul> <li>\u4f7f\u7528 PeerAuthentication \u5b9a\u4e49\u6d41\u91cf\u5982\u4f55\u5728 sidecar \u4e4b\u95f4\u4f20\u8f93\uff1b</li> <li>\u4f7f\u7528 DestinationRule \u5b9a\u4e49\u6d41\u91cf\u8def\u7531\u7b56\u7565\u4e2d\u7684 TLS \u8bbe\u7f6e\uff1b</li> </ul> <p>\u4e0b\u9762\u4ee5\u4e3a default \u547d\u540d\u7a7a\u95f4\u4e0b\u7684 reviews \u670d\u52a1\u8bbe\u7f6e mTLS \u4e3a\u4f8b\u8bf4\u660e\u3002</p>"},{"location":"chap9/8istio_mtls/#peerauthentication-mtls","title":"\u4f7f\u7528 PeerAuthentication \u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u8bbe\u7f6e mTLS","text":"<p>\u4f60\u53ef\u4ee5\u4f7f\u7528 namespace \u548c selector \u6307\u5b9a\u67d0\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u67d0\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u5f00\u542f\u4e25\u683c\u7684 mTLS\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\uff1a</p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: PeerAuthentication\nmetadata:\n  name: foo-peer-policy\n  namespace: default\nspec:\n  selector:\n    matchLabels:\n      app: reviews\n  mtls:\n    mode: STRICT\n</code></pre> <p>\u4f60\u4e5f\u53ef\u4ee5\u7ed9\u5b89\u88c5 Istio \u7684\u547d\u540d\u7a7a\u95f4 istio-system \u8bbe\u7f6e\u4e25\u683c\u7684 mTLS\uff0c\u90a3\u6837\u4f1a\u4e3a\u7f51\u683c\u4e2d\u7684\u6240\u6709\u670d\u52a1\u5f00\u542f\u4e25\u683c\u7684 mTLS</p>"},{"location":"chap9/8istio_mtls/#destinationrule-mtls","title":"\u4f7f\u7528 DestinationRule \u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u8bbe\u7f6e mTLS","text":"<p>DestinationRule \u7528\u4e8e\u8bbe\u7f6e\u6d41\u91cf\u8def\u7531\u7b56\u7565\uff0c\u4f8b\u5982\u8d1f\u8f7d\u5747\u8861\u3001\u5f02\u5e38\u70b9\u68c0\u6d4b\u3001TLS \u8bbe\u7f6e\u7b49\u3002\u5176\u4e2d TLS \u8bbe\u7f6e\u4e2d\u5305\u542b\u591a\u79cd\u6a21\u5f0f\uff0c\u4f7f\u7528 <code>ISTIO_MUTUAL</code> \u6a21\u5f0f\u53ef\u4ee5\u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u5f00\u542f Istio \u7684\u81ea\u52a8 TLS\uff0c\u5982\u4e0b\u6240\u793a\u3002</p> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: DestinationRule\nmetadata:\n  name: reviews\n  namespace: default\nspec:\n  host: reviews\n  trafficPolicy:\n    tls:\n      mode: ISTIO_MUTUAL\n</code></pre>"},{"location":"chap9/8istio_mtls/#mtls","title":"\u4ec0\u4e48\u65f6\u5019\u7528 mTLS\uff1f","text":"<p>\u4e92\u8054\u7f51\u5ba2\u6237\u7aef\u5bf9 Web \u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4e00\u822c\u4f7f\u7528\u5355\u5411 TLS\uff0c\u5373\u53ea\u9700\u8981\u670d\u52a1\u7aef\u63d0\u4f9b\u8eab\u4efd\u8bc1\u660e\uff0c\u800c\u4e0d\u5173\u5fc3\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u3002</p> <p>\u5f53\u4f60\u9700\u8981\u9a8c\u8bc1\u5ba2\u6237\u7aef\u8eab\u4efd\u65f6\uff0c\u4f7f\u7528\u5355\u5411 TLS \u53ef\u4ee5\u4f7f\u7528\u5bc6\u7801\u3001token\u3001\u53cc\u56e0\u5b50\u8ba4\u8bc1\u7b49\u65b9\u5f0f\u3002\u4e0d\u8fc7\u8fd9\u6837\u7684\u8ba4\u8bc1\u65b9\u5f0f\u9700\u8981\u5e94\u7528\u7a0b\u5e8f\u5185\u90e8\u652f\u6301\uff0c\u800c\u53cc\u5411 TLS \u662f\u8fd0\u884c\u5728\u5e94\u7528\u7a0b\u5e8f\u4e4b\u5916\u7684\uff0c\u4e0d\u9700\u8981\u591a\u5e94\u7528\u903b\u8f91\u8fdb\u884c\u4fee\u6539\u3002</p> <p>\u5f53\u4f60\u9700\u8981\u6b63\u5982\u4f60\u5728\u4e0a\u6587\u4e2d\u770b\u5230\u7684\uff0c\u5b9e\u65bd mTLS \u7684\u670d\u52a1\u95f4\u9700\u8981\u4ea4\u6362\u8bc1\u4e66\uff0c\u5f53\u670d\u52a1\u6570\u91cf\u53d8\u5927\u65f6\uff0c\u5c31\u9700\u8981\u7ba1\u7406\u5927\u91cf\u7684\u8bc1\u4e66\uff0c\u8fd9\u9700\u8981\u6d88\u8017\u5927\u91cf\u7684\u7cbe\u529b\uff0c\u4f7f\u7528\u670d\u52a1\u7f51\u683c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u5b9e\u73b0\u81ea\u52a8 mTLS\uff0c\u5f7b\u5e95\u89e3\u51b3\u8bc1\u4e66\u7ba1\u7406\u7684\u96be\u9898\u3002</p>"},{"location":"chap9/8istio_mtls/#mtls_1","title":"\u4ec0\u4e48\u65f6\u5019\u4e0d\u7528 mTLS\uff1f","text":"<p>\u867d\u7136 mTLS \u662f\u786e\u4fdd\u4e91\u539f\u751f\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u95f4\u901a\u4fe1\u5b89\u5168\u7684\u9996\u9009\u534f\u8bae\uff0c\u4f46\u662f\u5e94\u7528 mTLS \u9700\u8981\u5b8c\u6210\u590d\u6742\u7684\u5bf9\u79f0\u52a0\u5bc6\u3001\u89e3\u5bc6\u8fc7\u7a0b\uff0c\u8fd9\u5c06\u975e\u5e38\u8017\u65f6\u4e14\u6d88\u8017\u5927\u91cf\u7684 CPU \u8d44\u6e90</p> <p>\u5bf9\u4e8e\u67d0\u4e9b\u5b89\u5168\u7ea7\u522b\u4e0d\u9ad8\u7684\u6d41\u91cf\uff0c\u5982\u679c\u6211\u4eec\u5728\u6d41\u91cf\u5165\u53e3\u5904\u7ec8\u6b62 TLS\uff0c\u5e76\u7f51\u683c\u5185\u90e8\u4ec5\u5bf9\u9488\u5bf9\u6027\u7684\u670d\u52a1\u5f00\u542f mTLS\uff0c\u5c31\u53ef\u4ee5\u52a0\u5feb\u8bf7\u6c42\u54cd\u5e94\u548c\u51cf\u5c11\u8ba1\u7b97\u8d44\u6e90\u6d88\u8017\u3002</p> <p>\u53e6\u5916\u5f53\u6709\u7684\u670d\u52a1\u65e0\u6cd5\u83b7\u53d6\u8bc1\u4e66\uff0c\u4f8b\u5982 Kubelet \u4e0a\u4f7f\u7528 HTTP \u7684\u5065\u5eb7\u68c0\u67e5\uff0c\u65e0\u6cd5\u901a\u8fc7 TLS \u8bbf\u95ee\u670d\u52a1\u5185\u7684\u5065\u5eb7\u68c0\u67e5\u7aef\u70b9\uff0c\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u4e3a Pod \u7981\u7528\u63a2\u9488\u91cd\u5199</p> <p>\u6700\u540e\u5f53\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u8bbf\u95ee\u4e00\u4e9b\u5916\u90e8\u670d\u52a1\u65f6\uff0c\u4e5f\u4e0d\u9700\u8981 mTLS\u3002</p>"},{"location":"chap9/8istio_mtls/#_1","title":"\u603b\u7ed3","text":"<p>mTLS \u5b9e\u73b0\u4e86\u7f51\u683c\u5185\u6d41\u91cf\u7684\u52a0\u5bc6\uff0c\u662f\u6784\u5efa\u96f6\u4fe1\u4efb\u5e94\u7528\u7f51\u7edc\u7684\u5173\u952e\u4e00\u6b65\u3002\u501f\u52a9 Istio \u6211\u4eec\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u4e3a Kubernetes \u4e2d\u7684\u670d\u52a1\u5f00\u542f\u81ea\u52a8 mTLS\uff0c\u7701\u53bb\u7ba1\u7406\u8bc1\u4e66\u7684\u9ebb\u70e6\u3002\u540c\u65f6\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u9488\u5bf9\u6027\u7684\u4e3a\u7f51\u683c\u5185\u7684\u90e8\u5206\u670d\u52a1\u5f00\u542f mTLS\uff0c\u4fbf\u4e8e\u6211\u4eec\u5c06 Kubernetes \u4e2d\u7684\u670d\u52a1\u8fc1\u79fb\u5230\u7f51\u683c\u5185\u3002\u5173\u4e8e Istio \u4e2d\u7684\u8bc1\u4e66\u7ba1\u7406\uff0c\u6211\u4eec\u5c06\u5728\u4eca\u540e\u7684\u535a\u5ba2\u4e2d\u518d\u505a\u8bf4\u660e\u3002</p>"},{"location":"extra/mk_book/","title":"GitHub+Travis+Mkdocs\u81ea\u52a8\u5316\u6784\u5efa\u6587\u6863\u5e93(Istio)","text":"<pre><code>mkdocs new jxistiobook\ncd jxistiobook\nls\ndocs        mkdocs.yml\n\necho \"# jxawscsaabook\" &gt;&gt; README.md\ngit init\n\ngit remote add origin https://github.com/Chao-Xi/jxistiobook.git\n# pip3 install mkdocs-awesome-pages-plugin\n\n\n\n\n</code></pre> <ul> <li>https://travis-ci.com</li> <li> <p>https://app.travis-ci.com/github/Chao-Xi/jxistiobook</p> </li> <li> <p><code>GITHUB_NAME</code>: github password</p> </li> <li><code>GITHUB_EMAIL</code>: xichao2015@outlook.com</li> <li><code>GITHUB_API_KEY</code>: <code>ghp...jxhzd</code></li> </ul> <p> </p>"}]}