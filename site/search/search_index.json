{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Istio & Service Mesh \u6218\u672f\u6559\u7a0b Started at Augest 2021 By Jacob Xi About this tutorial This books is my 7th tech books published in almost 5 months. And this book is my most exhausted and hardworking book so far. The weather is getting cooler and cooler\ud83e\udd76 and double eleven is around the corner. Totally no idea what should I buy. Really appricate our team colleagues and friends' support and instruction. Description istio \u662f\u7531 Google\u3001IBM\u3001Lyft \u7b49\u5171\u540c\u5f00\u6e90\u7684 Service Mesh \uff08\u670d\u52a1\u7f51\u683c\uff09\u6846\u67b6\uff0c\u4e8e2017\u5e74\u521d\u5f00\u59cb\u8fdb\u5165\u5927\u4f17\u89c6\u91ce\u3002 Kubernetes \u89e3\u51b3\u4e86\u4e91\u539f\u751f\u5e94\u7528\u7684\u90e8\u7f72\u95ee\u9898\uff0c istio \u89e3\u51b3\u7684\u662f\u5e94\u7528\u7684\u670d\u52a1\uff08\u6d41\u91cf\uff09\u6cbb\u7406\u95ee\u9898 \u3002\u968f\u7740 2018\u5e747\u670831\u65e5 istio 1.0 \u53d1\u5e03\uff0cistio \u672c\u8eab\u5df2\u7ecf\u65e5\u8d8b\u7a33\u5b9a\u3002 \u4e3b\u9898\u6709\u4ee5\u4e0b\u5185\u5bb9\uff1a \u5fae\u670d\u52a1\u548c Service Mesh \u6838\u5fc3\u7ec4\u4ef6 \uff08Service Mesh \u67b6\u6784\u5206\u6790\uff0c\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\uff0c\u8d1f\u8f7d\u5747\u8861\u5668\uff0c \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565\uff0c \u8fde\u63a5\u6c60\uff0c\u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff09 Service Mesh \u5b9e\u6218 VirtualService \u5728 Istio \u670d\u52a1\u7f51\u683c\u4e2d \u5b9a\u4e49\u8def\u7531\u89c4\u5219 \uff0c \u63a7\u5236\u8def\u7531\u5982\u4f55\u8def\u7531\u5230\u670d\u52a1\u4e0a \u3002 DestinationRule \u662f VirtualService \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6 \u3002 ServiceEntry \u662f\u901a\u5e38\u7528\u4e8e\u5728 Istio \u670d\u52a1\u7f51\u683c\u4e4b\u5916\u542f\u7528\u5bf9\u670d\u52a1\u7684\u8bf7\u6c42 \u3002 Gateway \u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c\u6700\u5e38\u89c1\u7684\u662f\u5728 \u7f51\u683c\u7684\u8fb9\u7f18\u7684\u64cd\u4f5c \uff0c\u4ee5 \u542f\u7528\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\u6d41\u91cf\u3002 Istio\u57fa\u7840\u6559\u5b66 Istio\u9ad8\u7ea7\u6559\u5b66 (1.10.3)-Bookinfo \u6d41\u91cf\u7ba1\u7406 Istio \u9ad8\u7ea7\u6559\u5b66\u4e0e\u5b9e\u8df5 \u5b9e\u9a8c\u4e0e\u6559\u5b66bookinfo(istio-1.3)-old JenkinsX + Istio\u6e10\u8fdb\u5f0f\u4ea4\u4ed8 Tetrate Istio\u57fa\u7840\u57f9\u8bad\u4e0e\u5b9e\u9a8c\u6d4b\u8bd5 Istio\u65e5\u5e38\u64cd\u4f5c\u4e0e\u6280\u5de7 Envoy \u5165\u95e8\u6559\u7a0b https://tetrate-academy.thinkific.com/certificates/5b9sjc8qmc Previous on my Technolog book \u624b\u6478\u624b Jenkins \u6218\u672f\u6559\u7a0b (\u5927\u5e08\u7248\uff09 \u624b\u6478\u624b Elasticsearch7 \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b \u624b\u6478\u624b Redis \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b \u624b\u6478\u624b Chef & Ansible \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b \u624b\u6478\u624b \u5206\u5e03\u5f0f\u4e0e\u6d41\u5f0f\u7cfb\u7edf (In progress) Azure 103&900 Tutorial (In progress) \u624b\u6478\u624b Linux Performance & \u9762\u8bd5\u5b9e\u6218\u6559\u7a0b \u624b\u6478\u624b Databases \u5168\u6559\u7a0b AWS Certified Data Analytics Tutorial Salut! C'est Moi petite a petit l'oiseau fait son nid Hello, this is me, Jacob. Currently, I'm working as DevOps and Cloud Engineer in SAP, and I'm the certified AWS Solution Architect and Certified Azure Administrator, Kubernetes Specialist, Jenkins CI/CD and ElasticStack enthusiast. I was working as Backend Engineer in New York City and achieved my CS master degree in SIT, America. Believe it or not, I'll keep writing, more and more books will come out at such dramatic and unprecedented 2021. If you have anything want to talk to me directly, you can reach out for via email xichao2015@outlook.com\u3002 Salute, c'est moi, Jacob. Actuellement, je travaille en tant qu'ing\u00e9nieur DevOps et Cloud dans SAP, et je suis architecte de solution AWS certifi\u00e9 et administrateur Azure certifi\u00e9, sp\u00e9cialiste Kubernetes et passionn\u00e9 de CI/CD. Je travaillais en tant qu'ing\u00e9nieur backend \u00e0 New York et j'ai obtenu mon master CS \u00e0 SIT, en Am\u00e9rique. Croyez-le ou non, je continuerai \u00e0 \u00e9crire, de plus en plus de livres sortiront cette ann\u00e9e. Tutorial content \u7b2c\u4e00\u7ae0: \u5fae\u670d\u52a1\u548c Service Mesh \u6838\u5fc3\u7ec4\u4ef6 \u7b2c\u4e00\u8282 Service Mesh \u5b66\u4e60\u4e0e\u67b6\u6784\u5206\u6790 \u7b2c\u4e8c\u8282 \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3 \u7b2c\u4e09\u8282 \u8d1f\u8f7d\u5747\u8861\u5668 \u7b2c\u56db\u8282 \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565 \u7b2c\u4e94\u8282 \u8fde\u63a5\u6c60\uff1a\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u5f02 \u7b2c\u516d\u8282 \u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff1a\u7f51\u5173\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u4f5c\u7528 \u7b2c\u4e03\u8282 \u5fae\u670d\u52a1\u6cbb\u7406\u7684\u914d\u7f6e\u4e2d\u5fc3 \u7b2c\u516b\u8282 Trace \u66f4\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898 \u7b2c\u4e5d\u8282 \u5229\u7528 Prometheus \u548c Grafana \u6536\u96c6\u76d1\u63a7\u6570\u636e \u7b2c\u4e8c\u7ae0: Service Mesh \u5b9e\u6218 \u7b2c\u4e00\u8282 Service Mesh \u5f00\u6e90\u4ea7\u54c1\u4e2d\u7684\u6280\u672f\u9009\u578b \u7b2c\u4e8c\u8282 \u6700\u5e38\u7528\u7684\u6570\u636e\u9762 Envoy\u4ecb\u7ecd \u7b2c\u4e09\u8282 Istio \u5165\u95e8\uff1a\u57fa\u4e8e\u6700\u65b0 1.7 \u7248\u672c\u7684\u73af\u5883\u642d\u5efa\u548c\u4ecb\u7ecd \u7b2c\u56db\u8282 xDS\uff1a\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u901a\u4fe1\u6865\u6881 \u7b2c\u4e94\u8282 Ingress \u548c Egress\uff1a\u5165\u53e3\u6d41\u91cf\u548c\u51fa\u53e3\u6d41\u91cf\u63a7\u5236 \u7b2c\u516d\u8282 \u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u7248\u672c\u63a7\u5236 \u7b2c\u4e03\u8282 \u5982\u4f55\u5229\u7528\u7ec4\u4ef6\u505a\u5230\u670d\u52a1\u7684\u53ef\u89c2\u6d4b\u6027 \u7b2c\u516b\u8282 Proj\u9879\u76ee\u843d\u5730: Go \u5b9e\u73b0 Service Mesh \u7b2c\u4e5d\u8282 Service Mesh \u843d\u5730\u548c\u5c55\u671b \u7b2c\u5341\u8282 Mesh\u7684\u672a\u6765\u53d1\u5c55\u4e0e\u53ef\u884c\u6027\u65b9\u5411 \u7b2c\u4e09\u7ae0: Istio\u57fa\u7840\u6559\u5b66 \u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c(Service Mesh)\u662f\u4ec0\u4e48? \u7b2c\u4e8c\u8282 Istio \u67b6\u6784\u4e0e\u6280\u672f \u7b2c\u4e09\u8282 Istio \u670d\u52a1\u53d1\u73b0\u548c Pilot\u7684\u67b6\u6784\u673a\u5236 \u7b2c\u56db\u8282 Gateway \u8bbe\u8ba1\u4e0e\u5b9e\u73b0 \u7b2c\u4e94\u8282 Istio \u7070\u5ea6\u53d1\u5e03\u4e0e\u6280\u672f\u5b9e\u73b0 \u7b2c\u516d\u8282 xDS\u534f\u8bae\u89e3\u6790 \u7b2c\u4e03\u8282 Mixer\u57fa\u7840\u4e0e\u5b9e\u73b0 \u7b2c\u56db\u7ae0: Istio(1.10.3)-Bookinfo \u6d41\u91cf\u7ba1\u7406 \u7b2c\u4e00\u8282 2021 Service Mesh & Istio \u4ecb\u7ecd/\u5b89\u88c5(1.10.3) \u7b2c\u4e8c\u8282 \u4f7f\u7528 Istio \u5b9e\u73b0\u975e\u4fb5\u5165\u6d41\u91cf\u6cbb\u7406 \u7b2c\u4e09\u8282 Istio \u6d41\u91cf\u7ba1\u7406\u4e4b\u6545\u969c\u6ce8\u5165 \u7b2c\u56db\u8282 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def \u7b2c\u4e94\u7ae0: Istio(1.10.3)-Bookinfo \u6d41\u91cf\u7ba1\u7406 \u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u7684\u57fa\u672c\u7279\u5f81 \u7b2c\u4e8c\u8282 Istio \u57fa\u672c\u4ecb\u7ecd \u7b2c\u4e09\u8282 Istio, Service Mesh \u5feb\u901f\u5165\u95e8Istio 1.1.16 \u7b2c\u56db\u8282 \u7528Helm\u90e8\u7f72Istio \u7b2c\u4e94\u8282 Istio \u5e38\u7528\u529f\u80fd \uff08\u81ea\u52a8/\u624b\u52a8\u90e8\u7f72Istio\u5e94\u7528\uff09 \u7b2c\u516d\u8282 \u4f7f\u7528 Istio Dashboard Grafana / Prometheus \u7b2c\u4e03\u8282 \u4f7f\u7528 Istio Dashboard \u7b2c\u516b\u8282 \u4f7f\u7528Kiali \u7b2c\u4e5d\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u76ee\u6807\u89c4\u5219/\u9ed8\u8ba4\u8def\u7531/\u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb) \u7b2c\u5341\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u91d1\u4e1d\u96c0\u90e8\u7f72/\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531/URI\u8fdb\u884c\u91cd\u5b9a\u5411) \u7b2c\u5341\u4e00\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u901a\u4fe1\u8d85\u65f6/\u6545\u969c\u91cd\u8bd5/\u5165\u53e3~\u51fa\u53e3\u6d41\u91cf\u7ba1\u7406) \u7b2c\u5341\u4e8c\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u670d\u52a1\u7194\u65ad/\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5/\u6ce8\u5165\u4e2d\u65ad/\u6d41\u91cf\u590d\u5236) \u7b2c\u5341\u4e09\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(\u7b80\u4ecb/Denier\u8bbf\u95ee\u63a7\u5236/Listchecker\u8bbf\u95ee\u63a7\u5236) \u7b2c\u5341\u56db\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(MemQuota\u670d\u52a1\u9650\u6d41/Mixer\u5bf9\u8c61\u7684\u5b9a\u4e49/RedisQuota\u670d\u52a1\u9650\u6d41) \u7b2c\u5341\u4e94\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528 - \u4e3aPrometheus\u5b9a\u4e49\u76d1\u63a7\u6307\u6807 \u7b2c\u5341\u516d\u8282 \u4f7f\u7528stdio\u8f93\u51fa\u81ea\u5b9a\u4e49\u65e5\u5fd7 \u7b2c\u5341\u4e03\u8282 \u4f7f\u7528Fluentd\u8f93\u51fa\u65e5\u5fd7 \u7b2c\u5341\u516b\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa\uff08\u542f\u7528mTLS\\\u52a0\u56fa\u6982\u8ff0) \u7b2c\u5341\u4e5d\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa(RBAC\u8bbe\u7f6e\\\u62cd\u9519)) \u7b2c\u4e8c\u5341\u8282 Istio\u7684\u8bd5\u7528\u5efa\u8bae \u7b2c\u516d\u7ae0: \u5b9e\u9a8c\u4e0e\u6559\u5b66bookinfo(istio-1.3)-old L1 Docker for Mac\u5b89\u88c5istio(k8s-1.10/istio-1.3) L2 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u670d\u52a1\u7248\u672c/\u57fa\u4e8e\u6743\u91cd/\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9) L3 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u5ef6\u8fdf\u8bbf\u95ee/\u4e2d\u65ad\u8bbf\u95ee/\u4e0d\u540c\u73af\u5883/\u670d\u52a1\u7f51\u683c\u5916) \u7b2c\u4e03\u7ae0: JenkinsX + Istio\u6e10\u8fdb\u5f0f\u4ea4\u4ed8 L1 Kubernetes \u4e2d\u7684\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u84dd\u7eff\u90e8\u7f72\u548c\u91d1\u4e1d\u96c0\u90e8\u7f72, shipper, Istio, Flagger L2 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8 L3 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u90e8\u7f72 \u7b2c\u516b\u7ae0: Tetrate Istio\u57fa\u7840\u57f9\u8bad\u4e0e\u5b9e\u9a8c\u6d4b\u8bd5 \u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8 \u7b2c\u4e8c\u8282 \u5b89\u88c5 Istio \u7b2c\u4e09\u8282 \u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7 \u7b2c\u56db\u8282 \u6d41\u91cf\u7ba1\u7406 \u7b2c\u4e94\u8282 \u6d41\u91cf\u7ba1\u7406\u5b9e\u9a8c\u4e0e\u6d4b\u8bd5 \u7b2c\u516d\u8282 Istio Secuirty \u7b2c\u4e03\u8282 Istio\u9ad8\u7ea7\u529f\u80fd \u7b2c\u516b\u8282 Istio \u95ee\u9898\u6392\u67e5 \u7b2c\u4e5d\u8282 \u5b9e\u9645\u6848\u4f8b \u7b2c\u5341\u8282 \u672f\u8bed\u8868 \u7b2c\u4e5d\u7ae0: Istio\u65e5\u5e38\u64cd\u4f5c\u4e0e\u6280\u5de7 \u7b2c\u4e00\u8282 istio\u6d45\u6790 (Slide\u5907\u6848\uff09 \u7b2c\u4e8c\u8282 Istio \u5b89\u5168\u6700\u4f73\u5b9e\u8df5 \u7b2c\u4e09\u8282 \u8bb0\u4e00\u6b21 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def \u7b2c\u56db\u8282 \u4f7f\u7528 Istio \u7684\u5341\u4e2a\u6280\u5de7 To be continue I will put more effort do finish \"Azure 103&900 Tutorial book\" and \"Distributed Message System Book\" this month hopefully. And starting working on \"AWS Solution Arcitect\" and \"Prometheus & APM monitoring\", please waiting for it.\ud83d\ude42","title":"Welcome"},{"location":"#istio-service-mesh","text":"Started at Augest 2021 By Jacob Xi","title":"Istio &amp; Service Mesh \u6218\u672f\u6559\u7a0b"},{"location":"#about-this-tutorial","text":"This books is my 7th tech books published in almost 5 months. And this book is my most exhausted and hardworking book so far. The weather is getting cooler and cooler\ud83e\udd76 and double eleven is around the corner. Totally no idea what should I buy. Really appricate our team colleagues and friends' support and instruction.","title":"About this tutorial"},{"location":"#description","text":"istio \u662f\u7531 Google\u3001IBM\u3001Lyft \u7b49\u5171\u540c\u5f00\u6e90\u7684 Service Mesh \uff08\u670d\u52a1\u7f51\u683c\uff09\u6846\u67b6\uff0c\u4e8e2017\u5e74\u521d\u5f00\u59cb\u8fdb\u5165\u5927\u4f17\u89c6\u91ce\u3002 Kubernetes \u89e3\u51b3\u4e86\u4e91\u539f\u751f\u5e94\u7528\u7684\u90e8\u7f72\u95ee\u9898\uff0c istio \u89e3\u51b3\u7684\u662f\u5e94\u7528\u7684\u670d\u52a1\uff08\u6d41\u91cf\uff09\u6cbb\u7406\u95ee\u9898 \u3002\u968f\u7740 2018\u5e747\u670831\u65e5 istio 1.0 \u53d1\u5e03\uff0cistio \u672c\u8eab\u5df2\u7ecf\u65e5\u8d8b\u7a33\u5b9a\u3002 \u4e3b\u9898\u6709\u4ee5\u4e0b\u5185\u5bb9\uff1a \u5fae\u670d\u52a1\u548c Service Mesh \u6838\u5fc3\u7ec4\u4ef6 \uff08Service Mesh \u67b6\u6784\u5206\u6790\uff0c\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\uff0c\u8d1f\u8f7d\u5747\u8861\u5668\uff0c \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565\uff0c \u8fde\u63a5\u6c60\uff0c\u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff09 Service Mesh \u5b9e\u6218 VirtualService \u5728 Istio \u670d\u52a1\u7f51\u683c\u4e2d \u5b9a\u4e49\u8def\u7531\u89c4\u5219 \uff0c \u63a7\u5236\u8def\u7531\u5982\u4f55\u8def\u7531\u5230\u670d\u52a1\u4e0a \u3002 DestinationRule \u662f VirtualService \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6 \u3002 ServiceEntry \u662f\u901a\u5e38\u7528\u4e8e\u5728 Istio \u670d\u52a1\u7f51\u683c\u4e4b\u5916\u542f\u7528\u5bf9\u670d\u52a1\u7684\u8bf7\u6c42 \u3002 Gateway \u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c\u6700\u5e38\u89c1\u7684\u662f\u5728 \u7f51\u683c\u7684\u8fb9\u7f18\u7684\u64cd\u4f5c \uff0c\u4ee5 \u542f\u7528\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\u6d41\u91cf\u3002 Istio\u57fa\u7840\u6559\u5b66 Istio\u9ad8\u7ea7\u6559\u5b66 (1.10.3)-Bookinfo \u6d41\u91cf\u7ba1\u7406 Istio \u9ad8\u7ea7\u6559\u5b66\u4e0e\u5b9e\u8df5 \u5b9e\u9a8c\u4e0e\u6559\u5b66bookinfo(istio-1.3)-old JenkinsX + Istio\u6e10\u8fdb\u5f0f\u4ea4\u4ed8 Tetrate Istio\u57fa\u7840\u57f9\u8bad\u4e0e\u5b9e\u9a8c\u6d4b\u8bd5 Istio\u65e5\u5e38\u64cd\u4f5c\u4e0e\u6280\u5de7 Envoy \u5165\u95e8\u6559\u7a0b https://tetrate-academy.thinkific.com/certificates/5b9sjc8qmc","title":"Description"},{"location":"#previous-on-my-technolog-book","text":"\u624b\u6478\u624b Jenkins \u6218\u672f\u6559\u7a0b (\u5927\u5e08\u7248\uff09 \u624b\u6478\u624b Elasticsearch7 \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b \u624b\u6478\u624b Redis \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b \u624b\u6478\u624b Chef & Ansible \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b \u624b\u6478\u624b \u5206\u5e03\u5f0f\u4e0e\u6d41\u5f0f\u7cfb\u7edf (In progress) Azure 103&900 Tutorial (In progress) \u624b\u6478\u624b Linux Performance & \u9762\u8bd5\u5b9e\u6218\u6559\u7a0b \u624b\u6478\u624b Databases \u5168\u6559\u7a0b AWS Certified Data Analytics Tutorial","title":"Previous on my Technolog book"},{"location":"#salut-cest-moi","text":"petite a petit l'oiseau fait son nid Hello, this is me, Jacob. Currently, I'm working as DevOps and Cloud Engineer in SAP, and I'm the certified AWS Solution Architect and Certified Azure Administrator, Kubernetes Specialist, Jenkins CI/CD and ElasticStack enthusiast. I was working as Backend Engineer in New York City and achieved my CS master degree in SIT, America. Believe it or not, I'll keep writing, more and more books will come out at such dramatic and unprecedented 2021. If you have anything want to talk to me directly, you can reach out for via email xichao2015@outlook.com\u3002 Salute, c'est moi, Jacob. Actuellement, je travaille en tant qu'ing\u00e9nieur DevOps et Cloud dans SAP, et je suis architecte de solution AWS certifi\u00e9 et administrateur Azure certifi\u00e9, sp\u00e9cialiste Kubernetes et passionn\u00e9 de CI/CD. Je travaillais en tant qu'ing\u00e9nieur backend \u00e0 New York et j'ai obtenu mon master CS \u00e0 SIT, en Am\u00e9rique. Croyez-le ou non, je continuerai \u00e0 \u00e9crire, de plus en plus de livres sortiront cette ann\u00e9e.","title":"Salut! C'est Moi"},{"location":"#tutorial-content","text":"\u7b2c\u4e00\u7ae0: \u5fae\u670d\u52a1\u548c Service Mesh \u6838\u5fc3\u7ec4\u4ef6 \u7b2c\u4e00\u8282 Service Mesh \u5b66\u4e60\u4e0e\u67b6\u6784\u5206\u6790 \u7b2c\u4e8c\u8282 \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3 \u7b2c\u4e09\u8282 \u8d1f\u8f7d\u5747\u8861\u5668 \u7b2c\u56db\u8282 \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565 \u7b2c\u4e94\u8282 \u8fde\u63a5\u6c60\uff1a\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u5f02 \u7b2c\u516d\u8282 \u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff1a\u7f51\u5173\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u4f5c\u7528 \u7b2c\u4e03\u8282 \u5fae\u670d\u52a1\u6cbb\u7406\u7684\u914d\u7f6e\u4e2d\u5fc3 \u7b2c\u516b\u8282 Trace \u66f4\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898 \u7b2c\u4e5d\u8282 \u5229\u7528 Prometheus \u548c Grafana \u6536\u96c6\u76d1\u63a7\u6570\u636e \u7b2c\u4e8c\u7ae0: Service Mesh \u5b9e\u6218 \u7b2c\u4e00\u8282 Service Mesh \u5f00\u6e90\u4ea7\u54c1\u4e2d\u7684\u6280\u672f\u9009\u578b \u7b2c\u4e8c\u8282 \u6700\u5e38\u7528\u7684\u6570\u636e\u9762 Envoy\u4ecb\u7ecd \u7b2c\u4e09\u8282 Istio \u5165\u95e8\uff1a\u57fa\u4e8e\u6700\u65b0 1.7 \u7248\u672c\u7684\u73af\u5883\u642d\u5efa\u548c\u4ecb\u7ecd \u7b2c\u56db\u8282 xDS\uff1a\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u901a\u4fe1\u6865\u6881 \u7b2c\u4e94\u8282 Ingress \u548c Egress\uff1a\u5165\u53e3\u6d41\u91cf\u548c\u51fa\u53e3\u6d41\u91cf\u63a7\u5236 \u7b2c\u516d\u8282 \u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u7248\u672c\u63a7\u5236 \u7b2c\u4e03\u8282 \u5982\u4f55\u5229\u7528\u7ec4\u4ef6\u505a\u5230\u670d\u52a1\u7684\u53ef\u89c2\u6d4b\u6027 \u7b2c\u516b\u8282 Proj\u9879\u76ee\u843d\u5730: Go \u5b9e\u73b0 Service Mesh \u7b2c\u4e5d\u8282 Service Mesh \u843d\u5730\u548c\u5c55\u671b \u7b2c\u5341\u8282 Mesh\u7684\u672a\u6765\u53d1\u5c55\u4e0e\u53ef\u884c\u6027\u65b9\u5411 \u7b2c\u4e09\u7ae0: Istio\u57fa\u7840\u6559\u5b66 \u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c(Service Mesh)\u662f\u4ec0\u4e48? \u7b2c\u4e8c\u8282 Istio \u67b6\u6784\u4e0e\u6280\u672f \u7b2c\u4e09\u8282 Istio \u670d\u52a1\u53d1\u73b0\u548c Pilot\u7684\u67b6\u6784\u673a\u5236 \u7b2c\u56db\u8282 Gateway \u8bbe\u8ba1\u4e0e\u5b9e\u73b0 \u7b2c\u4e94\u8282 Istio \u7070\u5ea6\u53d1\u5e03\u4e0e\u6280\u672f\u5b9e\u73b0 \u7b2c\u516d\u8282 xDS\u534f\u8bae\u89e3\u6790 \u7b2c\u4e03\u8282 Mixer\u57fa\u7840\u4e0e\u5b9e\u73b0 \u7b2c\u56db\u7ae0: Istio(1.10.3)-Bookinfo \u6d41\u91cf\u7ba1\u7406 \u7b2c\u4e00\u8282 2021 Service Mesh & Istio \u4ecb\u7ecd/\u5b89\u88c5(1.10.3) \u7b2c\u4e8c\u8282 \u4f7f\u7528 Istio \u5b9e\u73b0\u975e\u4fb5\u5165\u6d41\u91cf\u6cbb\u7406 \u7b2c\u4e09\u8282 Istio \u6d41\u91cf\u7ba1\u7406\u4e4b\u6545\u969c\u6ce8\u5165 \u7b2c\u56db\u8282 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def \u7b2c\u4e94\u7ae0: Istio(1.10.3)-Bookinfo \u6d41\u91cf\u7ba1\u7406 \u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u7684\u57fa\u672c\u7279\u5f81 \u7b2c\u4e8c\u8282 Istio \u57fa\u672c\u4ecb\u7ecd \u7b2c\u4e09\u8282 Istio, Service Mesh \u5feb\u901f\u5165\u95e8Istio 1.1.16 \u7b2c\u56db\u8282 \u7528Helm\u90e8\u7f72Istio \u7b2c\u4e94\u8282 Istio \u5e38\u7528\u529f\u80fd \uff08\u81ea\u52a8/\u624b\u52a8\u90e8\u7f72Istio\u5e94\u7528\uff09 \u7b2c\u516d\u8282 \u4f7f\u7528 Istio Dashboard Grafana / Prometheus \u7b2c\u4e03\u8282 \u4f7f\u7528 Istio Dashboard \u7b2c\u516b\u8282 \u4f7f\u7528Kiali \u7b2c\u4e5d\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u76ee\u6807\u89c4\u5219/\u9ed8\u8ba4\u8def\u7531/\u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb) \u7b2c\u5341\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u91d1\u4e1d\u96c0\u90e8\u7f72/\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531/URI\u8fdb\u884c\u91cd\u5b9a\u5411) \u7b2c\u5341\u4e00\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u901a\u4fe1\u8d85\u65f6/\u6545\u969c\u91cd\u8bd5/\u5165\u53e3~\u51fa\u53e3\u6d41\u91cf\u7ba1\u7406) \u7b2c\u5341\u4e8c\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u670d\u52a1\u7194\u65ad/\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5/\u6ce8\u5165\u4e2d\u65ad/\u6d41\u91cf\u590d\u5236) \u7b2c\u5341\u4e09\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(\u7b80\u4ecb/Denier\u8bbf\u95ee\u63a7\u5236/Listchecker\u8bbf\u95ee\u63a7\u5236) \u7b2c\u5341\u56db\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(MemQuota\u670d\u52a1\u9650\u6d41/Mixer\u5bf9\u8c61\u7684\u5b9a\u4e49/RedisQuota\u670d\u52a1\u9650\u6d41) \u7b2c\u5341\u4e94\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528 - \u4e3aPrometheus\u5b9a\u4e49\u76d1\u63a7\u6307\u6807 \u7b2c\u5341\u516d\u8282 \u4f7f\u7528stdio\u8f93\u51fa\u81ea\u5b9a\u4e49\u65e5\u5fd7 \u7b2c\u5341\u4e03\u8282 \u4f7f\u7528Fluentd\u8f93\u51fa\u65e5\u5fd7 \u7b2c\u5341\u516b\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa\uff08\u542f\u7528mTLS\\\u52a0\u56fa\u6982\u8ff0) \u7b2c\u5341\u4e5d\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa(RBAC\u8bbe\u7f6e\\\u62cd\u9519)) \u7b2c\u4e8c\u5341\u8282 Istio\u7684\u8bd5\u7528\u5efa\u8bae \u7b2c\u516d\u7ae0: \u5b9e\u9a8c\u4e0e\u6559\u5b66bookinfo(istio-1.3)-old L1 Docker for Mac\u5b89\u88c5istio(k8s-1.10/istio-1.3) L2 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u670d\u52a1\u7248\u672c/\u57fa\u4e8e\u6743\u91cd/\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9) L3 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u5ef6\u8fdf\u8bbf\u95ee/\u4e2d\u65ad\u8bbf\u95ee/\u4e0d\u540c\u73af\u5883/\u670d\u52a1\u7f51\u683c\u5916) \u7b2c\u4e03\u7ae0: JenkinsX + Istio\u6e10\u8fdb\u5f0f\u4ea4\u4ed8 L1 Kubernetes \u4e2d\u7684\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u84dd\u7eff\u90e8\u7f72\u548c\u91d1\u4e1d\u96c0\u90e8\u7f72, shipper, Istio, Flagger L2 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8 L3 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u90e8\u7f72 \u7b2c\u516b\u7ae0: Tetrate Istio\u57fa\u7840\u57f9\u8bad\u4e0e\u5b9e\u9a8c\u6d4b\u8bd5 \u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8 \u7b2c\u4e8c\u8282 \u5b89\u88c5 Istio \u7b2c\u4e09\u8282 \u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7 \u7b2c\u56db\u8282 \u6d41\u91cf\u7ba1\u7406 \u7b2c\u4e94\u8282 \u6d41\u91cf\u7ba1\u7406\u5b9e\u9a8c\u4e0e\u6d4b\u8bd5 \u7b2c\u516d\u8282 Istio Secuirty \u7b2c\u4e03\u8282 Istio\u9ad8\u7ea7\u529f\u80fd \u7b2c\u516b\u8282 Istio \u95ee\u9898\u6392\u67e5 \u7b2c\u4e5d\u8282 \u5b9e\u9645\u6848\u4f8b \u7b2c\u5341\u8282 \u672f\u8bed\u8868 \u7b2c\u4e5d\u7ae0: Istio\u65e5\u5e38\u64cd\u4f5c\u4e0e\u6280\u5de7 \u7b2c\u4e00\u8282 istio\u6d45\u6790 (Slide\u5907\u6848\uff09 \u7b2c\u4e8c\u8282 Istio \u5b89\u5168\u6700\u4f73\u5b9e\u8df5 \u7b2c\u4e09\u8282 \u8bb0\u4e00\u6b21 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def \u7b2c\u56db\u8282 \u4f7f\u7528 Istio \u7684\u5341\u4e2a\u6280\u5de7","title":"Tutorial content"},{"location":"#to-be-continue","text":"I will put more effort do finish \"Azure 103&900 Tutorial book\" and \"Distributed Message System Book\" this month hopefully. And starting working on \"AWS Solution Arcitect\" and \"Prometheus & APM monitoring\", please waiting for it.\ud83d\ude42","title":"To be continue"},{"location":"chap1/1chap1_learn_SM/","text":"\u7b2c\u4e00\u8282 Service Mesh \u5b66\u4e60\u4e0e\u67b6\u6784\u5206\u6790 1\u3001\u4e3a\u4ec0\u4e48\u8981\u5b66\u4e60 Service Mesh\uff1f \u5fae\u670d\u52a1\u5728\u4e1a\u5185\u7684\u5b9e\u8df5\u5df2\u7ecf\u4ece\u6d41\u884c\u8d70\u5411\u6210\u719f \u5fae\u670d\u52a1\u67b6\u6784\u4f7f\u5e94\u7528\u7a0b\u5e8f\u66f4\u6613\u4e8e\u6269\u5c55\u3001\u66f4\u5feb\u5f00\u53d1\uff0c\u4ece\u800c\u52a0\u901f\u521b\u65b0\u5e76\u7f29\u77ed\u65b0\u529f\u80fd\u7684\u4e0a\u5e02\u65f6\u95f4 \u4e0e\u5355\u4f53\u5e94\u7528\u76f8\u6bd4\uff0c\u5fae\u670d\u52a1\u80fd\u591f\u66f4\u597d\u5730\u6ee1\u8db3\u4e92\u8054\u7f51\u65f6\u4ee3\u4e1a\u52a1\u5feb\u901f\u53d8\u5316\u7684\u9700\u8981 1-1 \u5fae\u670d\u52a1\u67b6\u6784\u4e5f\u4e0d\u662f\u94f6\u5f39 Service Mesh \uff08\u670d\u52a1\u7f51\u683c\uff09\u662f\u4e00\u4e2a\u7528\u4e8e\u5904\u7406\u670d\u52a1\u548c\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff1a \u901a\u8fc7 sidecar \u6a21\u5f0f\u5c06\u539f\u672c\u5728 SDK \u4e2d\u7684\u4ee3\u7801\u72ec\u7acb\u51fa\u6765\uff0c\u7528\u63a7\u5236\u9762\u4ee3\u66ff\u914d\u7f6e\u4e2d\u5fc3\u7684\u90e8\u5206\u529f\u80fd\uff0c\u4ee5\u900f\u660e\u4ee3\u7406\u7684\u5f62\u5f0f\u63d0\u4f9b\u5b89\u5168\u3001\u5feb\u901f\u3001\u53ef\u9760\u7684\u670d\u52a1\u95f4\u901a\u4fe1\uff0c\u540c\u65f6\u4e5f\u80fd\u5b9e\u73b0\u5fae\u670d\u52a1\u6240\u9700\u7684\u57fa\u672c\u7ec4\u4ef6\u529f\u80fd \u3002 \u4f60\u53ef\u4ee5\u628a Service Mesh \u770b\u4f5c\u662f\u5206\u5e03\u5f0f\u7684\u5fae\u670d\u52a1\u4ee3\u7406\u3002 2\u3001Service Mesh\uff1a\u4ece\u5355\u4f53\u670d\u52a1\u51fa\u53d1\uff0c\u72ec\u7acb\u4e8e\u4e1a\u52a1\u6f14\u8fdb\u7684\u5fae\u670d\u52a1\u67b6\u6784 2-1 \u5355\u4f53\u670d\u52a1\u67b6\u6784\u6709\u54ea\u4e9b\u95ee\u9898 \u6240\u6709\u7684\u529f\u80fd\u6a21\u5757\u90fd\u5728\u4e00\u4e2a\u4ee3\u7801\u4ed3\u5e93\uff0c\u5e76\u4e14\u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u8fdb\u7a0b\u5185\uff0c\u662f\u4e00\u4e2a\u5178\u578b\u7684\u5355\u4f53\u67b6\u6784\u3002 \u5927\u91cf\u590d\u6742\u7684\u4e1a\u52a1\u5197\u6742\u5728\u4e00\u4e2a\u5355\u4f53\u5e94\u7528\u4e2d\uff0c\u9020\u6210\u4e86\u4eba\u5458\u6c9f\u901a\u6210\u672c\u548c\u53d1\u5e03\u8fed\u4ee3\u6210\u672c\u7684\u6025\u5267\u4e0a\u5347\u3002 2-2 \u5355\u4f53\u670d\u52a1\u7684\u95ee\u9898 \u4eba\u5458\u534f\u4f5c\u95ee\u9898 \u90e8\u7f72\u95ee\u9898 \u67b6\u6784\u6f14\u8fdb\u95ee\u9898 \u7a0b\u5e8f\u7a33\u5b9a\u6027\u95ee\u9898 \u5728\u5355\u4f53\u5e94\u7528\u4e2d\uff0c\u67d0\u4e2a\u6a21\u5757\u51fa\u73b0 Bug \u65f6\uff0c\u6bd4\u5982\u56e0\u4e3a\u758f\u5ffd\u9020\u6210\u4e86 OOM (\u7a0b\u5e8f\u5185\u5b58\u4e0d\u8db3)\uff0c\u5bfc\u81f4\u7a0b\u5e8f panic\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u6574\u4e2a\u7f51\u7ad9\u6216\u8005 App \u4e0d\u53ef\u7528\u3002\u4e00\u4e2a\u6a21\u5757\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u4e86\u6574\u4e2a\u5e94\u7528\u6302\u6389\uff0c\u8fd9\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u662f\u65e0\u6cd5\u63a5\u53d7\u7684\u3002 \u968f\u7740\u4e92\u8054\u7f51\u4e1a\u52a1\u7684\u53d1\u5c55\uff0c\u6574\u4f53\u4e1a\u52a1\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u4ee5\u4e0a\u95ee\u9898\u8d8a\u6765\u8d8a\u660e\u663e\uff0c\u5355\u4f53\u670d\u52a1\u5df2\u7ecf\u65e0\u6cd5\u5e94\u5bf9\u5982\u6b64\u590d\u6742\u7684\u4e1a\u52a1\u573a\u666f\u4e86\u3002 \u4e92\u8054\u7f51\u884c\u4e1a\u4e5f\u4ece\u67b6\u6784\u4e0a\u9010\u6b65\u5f00\u59cb\u4e86\u670d\u52a1\u62c6\u5206\uff0c\u8fdb\u5165\u4e86 SOA \uff08Service-Oriented Architecture \u9762\u5411\u670d\u52a1\u7684\u67b6\u6784\uff09\u65f6\u4ee3 \u3002 2-3 \u5fae\u670d\u52a1\u6709\u54ea\u4e9b\u4f18\u52bf \u5fae\u670d\u52a1\u662f\u4e00\u79cd\u5f00\u53d1\u8f6f\u4ef6\u7684\u67b6\u6784\u548c\u7ec4\u7ec7\u65b9\u6cd5\uff0c\u5176\u4e2d\u8f6f\u4ef6\u7531\u901a\u8fc7\u660e\u786e\u5b9a\u4e49\u7684 API \u8fdb\u884c\u901a\u4fe1\u7684\u5c0f\u578b\u72ec\u7acb\u670d\u52a1\u7ec4\u6210\uff0c\u8fd9\u4e9b\u670d\u52a1\u7531\u5404\u4e2a\u5c0f\u578b\u72ec\u7acb\u56e2\u961f\u8d1f\u8d23\u3002 \u5fae\u670d\u52a1\u67b6\u6784\u4f7f\u5e94\u7528\u7a0b\u5e8f\u66f4\u6613\u4e8e\u6269\u5c55\u3001\u66f4\u5feb\u5f00\u53d1\uff0c\u4ece\u800c\u52a0\u901f\u521b\u65b0\u5e76\u7f29\u77ed\u65b0\u529f\u80fd\u7684\u4e0a\u5e02\u65f6\u95f4 1.\u654f\u6377\u5f00\u53d1 2.\u6280\u672f\u81ea\u7531 3.\u5f39\u6027\u6269\u7f29\u5bb9 4.\u7ec4\u7ec7\u5339\u914d \u5fae\u670d\u52a1\u67b6\u6784\u53ef\u4ee5\u975e\u5e38\u597d\u5730\u4e0e\u7ec4\u7ec7\u67b6\u6784\u76f8\u5339\u914d \uff0c\u6bd4\u5982\u4e00\u4e2a\u77ed\u89c6\u9891\u4e1a\u52a1\uff0c\u5728\u4e1a\u52a1\u53d1\u5c55\u5230\u4e00\u5b9a\u9636\u6bb5\uff0c\u5f88\u81ea\u7136\u5730\u4f1a\u62c6\u5206\u51fa\u7528\u6237\u589e\u957f\u90e8\u95e8\u548c\u5185\u5bb9\u90e8\u95e8\u3002 2-4 Service Mesh\uff0c\u4e2d\u6587\u540d\u53eb\u4f5c\u670d\u52a1\u7f51\u683c \u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5c06\u53ef\u4ee5\u914d\u7f6e\u7684\u4ee3\u7406\u5c42\u548c\u670d\u52a1\u90e8\u7f72\u5728\u4e00\u8d77\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u57fa\u7840\u8bbe\u65bd\u5c42\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5e76\u63d0\u4f9b\u901a\u7528\u7684\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u8eab\u4efd\u9a8c\u8bc1\u3001\u7cbe\u51c6\u8def\u7531\u3001\u670d\u52a1\u9274\u6743\u7b49\u57fa\u7840\u529f\u80fd\u3002 2-5 Service Mesh \u7684\u6f14\u8fdb\u5386\u7a0b sidecar \u65f6\u4ee3 \u5b9e\u9645\u4e0a\u65e9\u57282013\u5e74\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u67b6\u6784\u7684\u5927\u89c4\u6a21\u5e94\u7528\u65b9 Netflix\uff0c \u5c31\u53d1\u73b0\u4e86\u5fae\u670d\u52a1\u67b6\u6784\u5728\u8de8\u8bed\u8a00\u4e0a\u7684\u95ee\u9898\u3002Netflix \u5927\u91cf\u4f7f\u7528 Java \u6280\u672f\u6808\uff0c\u4f46\u56e0\u4e3a\u516c\u53f8\u7684\u4e1a\u52a1\u53d1\u5c55\uff0c\u4f7f\u7528\u5355\u4e00\u6280\u672f\u6808\u662f\u4e0d\u73b0\u5b9e\u7684 \u628a SDK \u91cc\u7684\u529f\u80fd\u8f6c\u79fb\u5230 sidecar \u4e2d\u3002 \u6240\u8c13 sidecar\uff0c \u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u90e8\u7f72\u5728\u672c\u5730\u7684\u4ee3\u7406\u670d\u52a1\u5668\uff0c\u5b83\u65e2\u63a5\u7ba1\u4e86\u5165\u53e3\u6d41\u91cf\uff0c\u4e5f\u63a5\u7ba1\u4e86\u51fa\u53e3\u6d41\u91cf\u3002 \u5176\u5b9e\u8fd9\u79cd\u6a21\u5f0f\u8981\u8ffd\u6eaf\u5230 Web Server \u7684\u65f6\u4ee3\uff0c\u6bd4\u5982 Nginx + Php-fpm \u8fd9\u79cd\u6a21\u5f0f\uff0c\u5b9e\u9645\u4e0a Nginx \u4e5f\u662f\u5145\u5f53\u4e86 sidecar \u7684\u89d2\u8272\uff0c\u53ea\u662f\u901a\u4fe1\u534f\u8bae\u7531\u6bd4\u8f83\u5e38\u89c1\u7684 HTTP \uff0c\u53d8\u6210\u4e86 FastCGI \uff0c\u53e6\u5916 Nginx \u53ea\u662f\u4ee3\u7406\u4e86\u5165\u53e3\u6d41\u91cf\uff0c\u5e76\u672a\u4ee3\u7406\u51fa\u53e3\u6d41\u91cf\u3002 \u521d\u4ee3 Service Mesh \u7b2c\u4e00\u4ee3 Service Mesh\uff0c\u5176\u4e2d\u6bd4\u8f83\u51fa\u540d\u7684\u662f Linkerd \u548c Envoy\u3002 \u5728\u8fd9\u4e00\u4ee3 Service Mesh \u4e2d\uff0c\u5df2\u7ecf\u4e0d\u518d\u4f9d\u8d56\u7279\u5b9a\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u6700\u91cd\u8981\u7684\u662f\u5b83\u7684\u51fa\u53d1\u70b9\u5df2\u7ecf\u4e0d\u662f\u89e3\u51b3\u591a\u8bed\u8a00\u7684\u95ee\u9898\uff0c\u800c\u662f\u4ece\u7edf\u4e00\u6d41\u91cf\u5904\u7406\u6a21\u578b\u7684\u89d2\u5ea6\uff0c\u5f62\u6210\u4e86\u4e00\u5957\u7edf\u4e00\u7684\u6d41\u91cf\u63a7\u5236\u7684\u89e3\u51b3\u65b9\u6848\u3002 \u4f46\u662f\u521d\u4ee3 Service Mesh \u6709\u4e00\u4e2a\u81f4\u547d\u7684\u95ee\u9898\uff08\u5176\u5b9e\u4e5f\u4e00\u76f4\u5b58\u5728\u4e8e\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff09\uff0c\u5c31\u662f\u7f3a\u4e4f\u7edf\u4e00\u7684\u7ba1\u63a7\u624b\u6bb5\uff0c\u6bd4\u5982 sidecar \u7684\u670d\u52a1\u6cbb\u7406\u76f8\u5173\u914d\u7f6e\u6587\u4ef6\u7684\u7ef4\u62a4\uff0c\u53ef\u80fd\u9700\u8981\u8fd0\u7ef4\u624b\u52a8\u7ef4\u62a4\u3001\u65e0\u6cd5\u96c6\u4e2d\u7ba1\u7406\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u539f\u56e0\uff0c\u63a7\u5236\u9762\u8bde\u751f\u4e86\u3002 \u65b0\u4e00\u4ee3 Service Mesh \u65b0\u4e00\u4ee3 Service Mesh\uff0c\u5c31\u662f\u5927\u5bb6\u719f\u77e5\u7684 Istio \u4e86\u3002\u5b83\u5f15\u5165\u4e86\u63a7\u5236\u9762\u7684\u6982\u5ff5\uff0c\u8ba9 Service Mesh \u6210\u4e3a\u5b8c\u5168\u4f53\u3002 Istio \u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u63a7\u5236\u9762\u548c Kubernetes \u6df1\u5ea6\u7ed1\u5b9a\uff0c\u65e9\u671f\u7248\u672c\u5c06\u6d41\u91cf\u6cbb\u7406\u7684\u529f\u80fd\u653e\u5728 mixer \u4e2d\uff0c\u5f62\u6210\u4e86\u4e00\u5957\u5b8c\u6574\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\u3002 \u63a7\u5236\u9762\u8d1f\u8d23\u4e86\u8d44\u6e90\u7ba1\u7406\u3001\u914d\u7f6e\u4e0b\u53d1\u3001\u8bc1\u4e66\u7ba1\u7406\u7b49\u529f\u80fd\uff0c\u89e3\u51b3\u4e86\u6570\u636e\u9762\u914d\u7f6e\u96be\u4ee5\u7ba1\u7406\u7684\u95ee\u9898\u3002 2-6 Service Mesh \u7684\u4f18\u52bf 1.\u8bed\u8a00\u65e0\u5173 Service Mesh \u505a\u5230\u4e86\u771f\u6b63\u7684\u8bed\u8a00\u65e0\u5173\uff1a\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u67b6\u6784\u8981\u4e3a\u5404\u79cd\u8bed\u8a00\u5f00\u53d1 SDK \uff0c\u800c Service Mesh \u5c06 SDK \u7684\u529f\u80fd\u96c6\u6210\u5230 sidecar \u4e2d\uff0c\u5b9e\u73b0\u4e86\u771f\u6b63\u7684\u8bed\u8a00\u65e0\u5173\u6027\u3002 2.\u57fa\u7840\u8bbe\u65bd\u72ec\u7acb\u6f14\u8fdb Service Mesh \u67b6\u6784\u5c06\u6846\u67b6\u4e2d\u548c\u4e1a\u52a1\u65e0\u5173\u7684\u901a\u7528\u529f\u80fd\u653e\u5728 sidecar \u4e2d\uff0c\u5347\u7ea7\u65f6\u53ea\u8981\u5347\u7ea7 sidecar \u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u6837\u505a\u5230\u4e86\u57fa\u7840\u8bbe\u65bd\u7684\u72ec\u7acb\u6f14\u8fdb\u3002 \u5b9e\u9645\u4e0a\u8fd9\u79cd\u505a\u6cd5\u4e5f\u5e26\u6765\u4e86\u53e6\u5916\u4e00\u4e2a\u597d\u5904\uff1a\u5199\u6846\u67b6\u7684\u65f6\u5019\u4e0d\u7528\u518d\u8003\u8651\u592a\u591a\u7684\u5411\u540e\u517c\u5bb9\u6027\uff0c\u964d\u4f4e\u4e86\u7f16\u5199\u4ee3\u7801\u7684\u5fc3\u667a\u8d1f\u62c5\u3002 3.\u53ef\u89c2\u6d4b\u6027 \u53ef\u89c2\u6d4b\u6027\u4e00\u822c\u5305\u542b\u4e24\u4e2a\u90e8\u5206\uff1a \u76d1\u63a7\u62a5\u8b66\u548c\u94fe\u8def\u8ffd\u8e2a \u3002 \u76d1\u63a7\u62a5\u8b66\u53ef\u4ee5\u901a\u8fc7\u6570\u636e\u9762\u7684 Metrics \u96c6\u6210\uff0c\u65e0\u611f\u77e5\u5730\u505a\u5230\u7cfb\u7edf\u76d1\u63a7\u62a5\u8b66\uff0c\u51cf\u5c11\u4e86\u4e1a\u52a1\u548c\u6846\u67b6\u7684\u91cd\u590d\u5de5\u4f5c\u3002 \u81f3\u4e8e\u94fe\u8def\u8ffd\u8e2a\uff0c\u56e0\u4e3a\u9700\u8981\u901a\u8fc7 header \u5c06 traceid \u4f20\u9012\u4e0b\u53bb\uff0c\u6240\u4ee5\u8fd8\u662f\u9700\u8981\u5ba2\u6237\u7aef\u7684 SDK \u5c06 traceid \u901a\u8fc7 header \u4f20\u9012\u3002\u4e0d\u8fc7\u8fd9\u4e2a\u505a\u6cd5\u4e5f\u7b80\u5316\u4e86 Trace SDK \u7684\u5c01\u88c5\u3002 4.\u8fb9\u7f18\u7f51\u5173\u7edf\u4e00 \u5b9e\u9645\u4e0a sidecar \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u7f51\u5173/\u53cd\u5411\u4ee3\u7406\uff0c\u81ea\u7136\u53ef\u4ee5\u5c06\u4ee5\u524d Nginx/Kong \u4e4b\u7c7b\u7684\u7cfb\u7edf\u7f51\u5173\u8fc1\u79fb\u5230 sidecar \u4e0a\u6765\uff0c \u8fd9\u6837\u5c31\u53ef\u4ee5\u7ef4\u62a4\u4e00\u5957\u7edf\u4e00\u7684\u4ee3\u7801 \u3002 \u66f4\u8fdb\u4e00\u6b65\uff0c\u53ef\u4ee5\u5c06\u4ee5\u524d\u8fb9\u7f18\u7f51\u5173\u7684\u5de5\u4f5c\uff0c\u6bd4\u5982\u9274\u6743\u3001 trace \u521d\u59cb\u5316\u7b49\u5de5\u4f5c\u4e0b\u6c89\u5230 sidecar \u4e0a\uff0c\u8fdb\u4e00\u6b65\u7b80\u5316\u7cfb\u7edf\u7f51\u5173\u7684\u529f\u80fd\u3002 2-6 Service Mesh \u7684\u57fa\u7840\u7ec4\u4ef6\u53ca\u5e38\u89c1\u540d\u8bcd Service Mesh \u4e00\u4e2a\u6700\u91cd\u8981\u7684\u53d8\u9769\uff0c\u5c31\u662f\u5f15\u5165\u4e86 \u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u7684\u6982\u5ff5 \uff0c\u8fd9\u4e2a\u6982\u5ff5\u4e5f\u5e76\u975e Service Mesh \u65b0\u521b\u7684\u6982\u5ff5\uff0c\u5b9e\u9645\u4e0a\u5728 SDN (\u8f6f\u4ef6\u5b9a\u4e49\u7f51\u7edc)\u4e2d\u5c31\u6709\u4e86\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u6982\u5ff5\u3002 1 \u6570\u636e\u9762(Data Plane) \u8d1f\u8d23\u6570\u636e\u7684\u8f6c\u53d1 \uff0c\u4e00\u822c\u6211\u4eec\u5e38\u89c1\u7684 \u901a\u7528\u7f51\u5173\u3001Web Server\uff0c\u6bd4\u5982 Nginx\u3001Traefik \u90fd\u53ef\u4ee5\u8ba4\u4e3a\u662f\u6570\u636e\u9762\u7684\u4e00\u79cd\u3002\u5728 Service Mesh \u7684\u5f00\u6e90\u4e16\u754c\u4e2d\uff0cEnvoy \u53ef\u4ee5\u8bf4\u662f\u6700\u77e5\u540d\u7684\u6570\u636e\u9762\u4e86 \u3002 \u53e6\u5916\u6570\u636e\u9762 \u5e76\u975e\u5c40\u9650\u4e8e\u7f51\u5173\u7c7b\u4ea7\u54c1\uff0c\u5b9e\u9645\u4e0a\u67d0\u4e9b RPC \u6846\u67b6\u4e5f\u53ef\u4ee5\u5145\u5f53\u6570\u636e\u9762 \uff0c\u6bd4\u5982 gRPC \u5c31\u5df2\u7ecf\u652f\u6301\u5b8c\u6574\u7684 xDS(\u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u7684\u4ea4\u4e92\u534f\u8bae)\uff0c\u4e5f\u53ef\u4ee5\u5f53\u4f5c\u6570\u636e\u9762\u4f7f\u7528\u3002 \u4e00\u822c\u6211\u4eec\u628a\u8d1f\u8d23\u6570\u636e\u8f6c\u53d1\u7684\u6570\u636e\u9762\u79f0\u4e3a sidecar\uff08\u8fb9\u8f66\uff09 \u3002 2 \u63a7\u5236\u9762(Control Plane) \u901a\u8fc7 xDS \u534f\u8bae\u5bf9\u6570\u636e\u9762\u8fdb\u884c\u914d\u7f6e\u4e0b\u53d1\uff0c\u4ee5\u63a7\u5236\u6570\u636e\u9762\u7684\u884c\u4e3a\uff0c\u6bd4\u5982\u8def\u7531\u8f6c\u53d1\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u6cbb\u7406\u7b49\u914d\u7f6e\u4e0b\u53d1\u3002 \u63a7\u5236\u9762\u7684\u51fa\u73b0\u89e3\u51b3\u4e86\u65e0\u8bba\u662f\u6846\u67b6\u8fd8\u662f\u6570\u636e\u9762\u3001sidecar \u90fd\u7f3a\u4e4f\u63a7\u5236\u80fd\u529b\u7684\u5f0a\u7aef\uff0c\u800c\u4e14\u4e4b\u524d\u53ea\u80fd\u901a\u8fc7\u8fd0\u7ef4\u6279\u91cf\u4fee\u6539 CONF \u6765\u63a7\u5236\u6570\u636e\u9762\u3001\u5bfc\u81f4\u89c4\u6a21\u4e0a\u5347\u65f6\u7eaf\u4eba\u5de5\u7ef4\u62a4\u6210\u672c\u4ee5\u53ca\u5927\u5e45\u5ea6\u4e0a\u5347\u7684\u9519\u8bef\u6982\u7387\u7b49\u95ee\u9898\u4e5f\u5f97\u5230\u4e86\u5f88\u597d\u7684\u89e3\u51b3\u3002 \u5b9e\u9645\u4e0a Service Mesh \u9700\u8981\u7684\u57fa\u7840\u7ec4\u4ef6\u548c\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u6ca1\u6709\u592a\u5927\u7684\u5dee\u522b\uff0c\u5f88\u591a\u516c\u53f8\u9009\u62e9\u81ea\u7814\u63a7\u5236\u9762\u5c31\u662f\u4e3a\u4e86\u517c\u5bb9\u8001\u7248\u672c\u5fae\u670d\u52a1\u7684\u57fa\u7840\u7ec4\u4ef6\u3002 2-8 Service Mesh \u7684\u57fa\u7840\u7ec4\u4ef6 \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3 \uff1a\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u7ec4\u4ef6\u3002\u670d\u52a1\u901a\u8fc7\u6ce8\u518c\u81ea\u8eab\u8282\u70b9\uff0c\u8ba9\u8c03\u7528\u65b9\u670d\u52a1\u53d1\u73b0\u88ab\u8c03\u65b9\u670d\u52a1\u8282\u70b9\uff0c\u4ee5\u8fbe\u5230\u670d\u52a1\u95f4\u70b9\u5bf9\u70b9\u901a\u4fe1\u7684\u76ee\u7684\u3002 \u914d\u7f6e\u4e2d\u5fc3 \uff1a\u7528\u4e8e\u670d\u52a1\u7684\u57fa\u7840\u914d\u7f6e\u66f4\u65b0\uff0c\u4ee5\u8fbe\u5230\u4ee3\u7801\u548c\u914d\u7f6e\u5206\u79bb\u7684\u76ee\u7684\u3002\u51cf\u5c11\u670d\u52a1\u7684\u53d1\u5e03\u6b21\u6570\uff0c\u914d\u7f6e\u53d1\u5e03\u53ef\u4ee5\u66f4\u5feb\u66f4\u53ca\u65f6\u5730\u53d8\u66f4\u670d\u52a1\u3002 API \u7f51\u5173 \uff1a\u901a\u8fc7\u7edf\u4e00\u7684\u7f51\u5173\u5c42\uff0c\u6536\u655b\u670d\u52a1\u7684\u7edf\u4e00\u9274\u6743\u5c42\u3001\u94fe\u8def ID \u751f\u6210\u7b49\u57fa\u7840\u670d\u52a1\uff0c\u5e76\u805a\u5408\u540e\u7aef\u670d\u52a1\u4e3a\u5ba2\u6237\u7aef\u63d0\u4f9b RESTful \u63a5\u53e3\u3002\u53e6\u5916 API \u7f51\u5173\u4e5f\u8d1f\u8d23\u5357\u5317\u5411\u6d41\u91cf(\u5916\u7f51\u5165\u53e3\u6d41\u91cf)\u7684\u6d41\u91cf\u6cbb\u7406\u3002 \u670d\u52a1\u6cbb\u7406 \uff1a\u901a\u8fc7\u9650\u6d41\u3001\u7194\u65ad\u7b49\u57fa\u7840\u7ec4\u4ef6\uff0c\u675c\u7edd\u5fae\u670d\u52a1\u67b6\u6784\u51fa\u73b0\u96ea\u5d29\u7684\u9690\u60a3\u3002 \u94fe\u8def\u8ffd\u8e2a \uff1a\u901a\u8fc7 trace \u5c06\u6574\u4e2a\u5fae\u670d\u52a1\u94fe\u8def\u6e05\u6670\u5730\u7ed8\u5236\u51fa\u6765\uff0c\u5e76\u8fdb\u884c\u7cbe\u51c6\u7684\u6545\u969c\u6392\u67e5\uff0c\u6781\u5927\u5730\u964d\u4f4e\u4e86\u6545\u969c\u6392\u67e5\u7684\u96be\u5ea6\u3002 \u76d1\u63a7\u544a\u8b66 \uff1a\u901a\u8fc7 Prometheus \u548c Grafana \u8fd9\u6837\u7684\u57fa\u7840\u7ec4\u4ef6\uff0c\u7ed8\u5236\u670d\u52a1\u72b6\u6001\u76d1\u63a7\u5927\u76d8\uff0c\u9488\u5bf9\u8d44\u6e90\u3001\u670d\u52a1\u3001\u4e1a\u52a1\u5404\u9879\u6307\u6807\uff0c\u505a\u7cbe\u51c6\u7684\u76d1\u63a7\u62a5\u8b66\u3002 2-9 Service Mesh \u540d\u8bcd\u89e3\u91ca Upstream : \u4e0a\u6e38\u670d\u52a1\uff0c\u5982\u679c A \u670d\u52a1\u8c03\u7528 B \u670d\u52a1\uff0c\u5728 A \u670d\u52a1\u7684\u89c6\u89d2\u6765\u770b\uff0cB \u670d\u52a1\u5c31\u662f\u4e0a\u6e38\u670d\u52a1\uff0c\u4f46\u662f\u5728\u4e2d\u6587\u7684\u8bed\u5883\u4e2d\uff0c\u7ecf\u5e38\u88ab\u53eb\u4f5c\u201c\u4e0b\u6e38\u670d\u52a1\u201d\u3002\u6240\u4ee5\u5728\u6574\u4e2a\u8bfe\u7a0b\u4e2d\uff0c\u4e3a\u4e86\u907f\u514d\u8bed\u8a00\u4e0a\u7684\u6b67\u4e49\uff0c\u6211\u4f1a\u76f4\u63a5\u4f7f\u7528upstream\uff0c\u800c\u4e0d\u662f\u4e2d\u6587\u7ffb\u8bd1\u3002\u5728\u4e2d\u6587\u7684\u8bed\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b22\u79f0\u5b83\u4e3a\u670d\u52a1\u7aef\u6216\u8005\u88ab\u8c03\u7528\u65b9\u3002 Downstream : \u4e0b\u6e38\u670d\u52a1\uff0c\u5982\u679c A \u670d\u52a1\u8c03\u7528 B \u670d\u52a1\uff0c\u5728 B \u670d\u52a1\u7684\u89c6\u89d2\u4e2d\uff0cA \u670d\u52a1\u5c31\u662f\u4e0b\u6e38\u670d\u52a1\u3002\u5728\u4e2d\u6587\u7684\u8bed\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b22\u53eb\u5ba2\u6237\u7aef\u6216\u8005\u8c03\u7528\u65b9\u3002 Endpoint \uff1a\u6307\u7684\u662f\u670d\u52a1\u8282\u70b9\uff0c\u6bd4\u5982 A \u670d\u52a1\u6709 192.168.2.11 \u548c 192.168.2.12 \u4e24\u4e2a\u670d\u52a1\u8282\u70b9\u3002 Cluster \uff1a\u6307\u7684\u662f\u670d\u52a1\u96c6\u7fa4\uff0c\u6bd4\u5982 A \u670d\u52a1\u6709 192.168.2.11 \u548c 92.168.2.12 \u4e24\u4e2a\u670d\u52a1\u8282\u70b9\uff0c\u90a3\u4e48A\u670d\u52a1\u5c31\u662f Cluster\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7406\u89e3\u4e3a Service Node \uff1a\u5728 Kubernetes \u8bed\u5883\u4e2d\uff0c\u6307\u7684\u662f\u627f\u8f7d pod \u7684\u670d\u52a1\u5668\uff0c\u4f46\u5728\u5fae\u670d\u52a1\u7684\u8bed\u5883\u4e2d\uff0c\u66f4\u591a\u7684\u7b49\u540c\u4e8eEndpoint\u3002 Route \uff1a\u6307\u7684\u662f Service Mesh \u4e2d\u7684\u8def\u7531\u914d\u7f6e\uff0c\u6bd4\u5982 A \u670d\u52a1\u8bbf\u95ee B \u670d\u52a1\uff0c\u8981\u5339\u914d\u5230\u4e00\u5b9a\u7684\u89c4\u5219\uff0c\u6bd4\u5982 header \u4e2d\u8981\u5e26\u6709\u670d\u52a1\u540d( -H servicename:B )\uff0c\u624d\u80fd\u591f\u62ff\u5230 B \u670d\u52a1\u7684\u8bbf\u95ee\u65b9\u5f0f\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u6216\u8005\u9759\u6001\u5217\u8868\u8bbf\u95ee\u5230 B \u670d\u52a1\u7684\u8282\u70b9\u3002 Listener \uff1a\u6307\u7684\u662f Service Mesh \u7684\u76d1\u542c\u7aef\u53e3\uff0c\u901a\u5e38\u6211\u4eec\u8bbf\u95ee Service Mesh \u7684\u6570\u636e\u9762\uff0c\u9700\u8981\u77e5\u9053\u6570\u636e\u9762\u7684\u76d1\u542c\u7aef\u53e3\u3002","title":"\u7b2c\u4e00\u8282 Service Mesh \u5b66\u4e60\u4e0e\u67b6\u6784\u5206\u6790"},{"location":"chap1/1chap1_learn_SM/#service-mesh","text":"","title":"\u7b2c\u4e00\u8282 Service Mesh \u5b66\u4e60\u4e0e\u67b6\u6784\u5206\u6790"},{"location":"chap1/1chap1_learn_SM/#1-service-mesh","text":"\u5fae\u670d\u52a1\u5728\u4e1a\u5185\u7684\u5b9e\u8df5\u5df2\u7ecf\u4ece\u6d41\u884c\u8d70\u5411\u6210\u719f \u5fae\u670d\u52a1\u67b6\u6784\u4f7f\u5e94\u7528\u7a0b\u5e8f\u66f4\u6613\u4e8e\u6269\u5c55\u3001\u66f4\u5feb\u5f00\u53d1\uff0c\u4ece\u800c\u52a0\u901f\u521b\u65b0\u5e76\u7f29\u77ed\u65b0\u529f\u80fd\u7684\u4e0a\u5e02\u65f6\u95f4 \u4e0e\u5355\u4f53\u5e94\u7528\u76f8\u6bd4\uff0c\u5fae\u670d\u52a1\u80fd\u591f\u66f4\u597d\u5730\u6ee1\u8db3\u4e92\u8054\u7f51\u65f6\u4ee3\u4e1a\u52a1\u5feb\u901f\u53d8\u5316\u7684\u9700\u8981","title":"1\u3001\u4e3a\u4ec0\u4e48\u8981\u5b66\u4e60 Service Mesh\uff1f"},{"location":"chap1/1chap1_learn_SM/#1-1","text":"Service Mesh \uff08\u670d\u52a1\u7f51\u683c\uff09\u662f\u4e00\u4e2a\u7528\u4e8e\u5904\u7406\u670d\u52a1\u548c\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff1a \u901a\u8fc7 sidecar \u6a21\u5f0f\u5c06\u539f\u672c\u5728 SDK \u4e2d\u7684\u4ee3\u7801\u72ec\u7acb\u51fa\u6765\uff0c\u7528\u63a7\u5236\u9762\u4ee3\u66ff\u914d\u7f6e\u4e2d\u5fc3\u7684\u90e8\u5206\u529f\u80fd\uff0c\u4ee5\u900f\u660e\u4ee3\u7406\u7684\u5f62\u5f0f\u63d0\u4f9b\u5b89\u5168\u3001\u5feb\u901f\u3001\u53ef\u9760\u7684\u670d\u52a1\u95f4\u901a\u4fe1\uff0c\u540c\u65f6\u4e5f\u80fd\u5b9e\u73b0\u5fae\u670d\u52a1\u6240\u9700\u7684\u57fa\u672c\u7ec4\u4ef6\u529f\u80fd \u3002 \u4f60\u53ef\u4ee5\u628a Service Mesh \u770b\u4f5c\u662f\u5206\u5e03\u5f0f\u7684\u5fae\u670d\u52a1\u4ee3\u7406\u3002","title":"1-1 \u5fae\u670d\u52a1\u67b6\u6784\u4e5f\u4e0d\u662f\u94f6\u5f39"},{"location":"chap1/1chap1_learn_SM/#2service-mesh","text":"","title":"2\u3001Service Mesh\uff1a\u4ece\u5355\u4f53\u670d\u52a1\u51fa\u53d1\uff0c\u72ec\u7acb\u4e8e\u4e1a\u52a1\u6f14\u8fdb\u7684\u5fae\u670d\u52a1\u67b6\u6784"},{"location":"chap1/1chap1_learn_SM/#2-1","text":"\u6240\u6709\u7684\u529f\u80fd\u6a21\u5757\u90fd\u5728\u4e00\u4e2a\u4ee3\u7801\u4ed3\u5e93\uff0c\u5e76\u4e14\u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u8fdb\u7a0b\u5185\uff0c\u662f\u4e00\u4e2a\u5178\u578b\u7684\u5355\u4f53\u67b6\u6784\u3002 \u5927\u91cf\u590d\u6742\u7684\u4e1a\u52a1\u5197\u6742\u5728\u4e00\u4e2a\u5355\u4f53\u5e94\u7528\u4e2d\uff0c\u9020\u6210\u4e86\u4eba\u5458\u6c9f\u901a\u6210\u672c\u548c\u53d1\u5e03\u8fed\u4ee3\u6210\u672c\u7684\u6025\u5267\u4e0a\u5347\u3002","title":"2-1 \u5355\u4f53\u670d\u52a1\u67b6\u6784\u6709\u54ea\u4e9b\u95ee\u9898"},{"location":"chap1/1chap1_learn_SM/#2-2","text":"\u4eba\u5458\u534f\u4f5c\u95ee\u9898 \u90e8\u7f72\u95ee\u9898 \u67b6\u6784\u6f14\u8fdb\u95ee\u9898 \u7a0b\u5e8f\u7a33\u5b9a\u6027\u95ee\u9898 \u5728\u5355\u4f53\u5e94\u7528\u4e2d\uff0c\u67d0\u4e2a\u6a21\u5757\u51fa\u73b0 Bug \u65f6\uff0c\u6bd4\u5982\u56e0\u4e3a\u758f\u5ffd\u9020\u6210\u4e86 OOM (\u7a0b\u5e8f\u5185\u5b58\u4e0d\u8db3)\uff0c\u5bfc\u81f4\u7a0b\u5e8f panic\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u6574\u4e2a\u7f51\u7ad9\u6216\u8005 App \u4e0d\u53ef\u7528\u3002\u4e00\u4e2a\u6a21\u5757\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u4e86\u6574\u4e2a\u5e94\u7528\u6302\u6389\uff0c\u8fd9\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u662f\u65e0\u6cd5\u63a5\u53d7\u7684\u3002 \u968f\u7740\u4e92\u8054\u7f51\u4e1a\u52a1\u7684\u53d1\u5c55\uff0c\u6574\u4f53\u4e1a\u52a1\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u4ee5\u4e0a\u95ee\u9898\u8d8a\u6765\u8d8a\u660e\u663e\uff0c\u5355\u4f53\u670d\u52a1\u5df2\u7ecf\u65e0\u6cd5\u5e94\u5bf9\u5982\u6b64\u590d\u6742\u7684\u4e1a\u52a1\u573a\u666f\u4e86\u3002 \u4e92\u8054\u7f51\u884c\u4e1a\u4e5f\u4ece\u67b6\u6784\u4e0a\u9010\u6b65\u5f00\u59cb\u4e86\u670d\u52a1\u62c6\u5206\uff0c\u8fdb\u5165\u4e86 SOA \uff08Service-Oriented Architecture \u9762\u5411\u670d\u52a1\u7684\u67b6\u6784\uff09\u65f6\u4ee3 \u3002","title":"2-2 \u5355\u4f53\u670d\u52a1\u7684\u95ee\u9898"},{"location":"chap1/1chap1_learn_SM/#2-3","text":"\u5fae\u670d\u52a1\u662f\u4e00\u79cd\u5f00\u53d1\u8f6f\u4ef6\u7684\u67b6\u6784\u548c\u7ec4\u7ec7\u65b9\u6cd5\uff0c\u5176\u4e2d\u8f6f\u4ef6\u7531\u901a\u8fc7\u660e\u786e\u5b9a\u4e49\u7684 API \u8fdb\u884c\u901a\u4fe1\u7684\u5c0f\u578b\u72ec\u7acb\u670d\u52a1\u7ec4\u6210\uff0c\u8fd9\u4e9b\u670d\u52a1\u7531\u5404\u4e2a\u5c0f\u578b\u72ec\u7acb\u56e2\u961f\u8d1f\u8d23\u3002 \u5fae\u670d\u52a1\u67b6\u6784\u4f7f\u5e94\u7528\u7a0b\u5e8f\u66f4\u6613\u4e8e\u6269\u5c55\u3001\u66f4\u5feb\u5f00\u53d1\uff0c\u4ece\u800c\u52a0\u901f\u521b\u65b0\u5e76\u7f29\u77ed\u65b0\u529f\u80fd\u7684\u4e0a\u5e02\u65f6\u95f4 1.\u654f\u6377\u5f00\u53d1 2.\u6280\u672f\u81ea\u7531 3.\u5f39\u6027\u6269\u7f29\u5bb9 4.\u7ec4\u7ec7\u5339\u914d \u5fae\u670d\u52a1\u67b6\u6784\u53ef\u4ee5\u975e\u5e38\u597d\u5730\u4e0e\u7ec4\u7ec7\u67b6\u6784\u76f8\u5339\u914d \uff0c\u6bd4\u5982\u4e00\u4e2a\u77ed\u89c6\u9891\u4e1a\u52a1\uff0c\u5728\u4e1a\u52a1\u53d1\u5c55\u5230\u4e00\u5b9a\u9636\u6bb5\uff0c\u5f88\u81ea\u7136\u5730\u4f1a\u62c6\u5206\u51fa\u7528\u6237\u589e\u957f\u90e8\u95e8\u548c\u5185\u5bb9\u90e8\u95e8\u3002","title":"2-3 \u5fae\u670d\u52a1\u6709\u54ea\u4e9b\u4f18\u52bf"},{"location":"chap1/1chap1_learn_SM/#2-4-service-mesh","text":"\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5c06\u53ef\u4ee5\u914d\u7f6e\u7684\u4ee3\u7406\u5c42\u548c\u670d\u52a1\u90e8\u7f72\u5728\u4e00\u8d77\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u57fa\u7840\u8bbe\u65bd\u5c42\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5e76\u63d0\u4f9b\u901a\u7528\u7684\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u8eab\u4efd\u9a8c\u8bc1\u3001\u7cbe\u51c6\u8def\u7531\u3001\u670d\u52a1\u9274\u6743\u7b49\u57fa\u7840\u529f\u80fd\u3002","title":"2-4 Service Mesh\uff0c\u4e2d\u6587\u540d\u53eb\u4f5c\u670d\u52a1\u7f51\u683c"},{"location":"chap1/1chap1_learn_SM/#2-5-service-mesh","text":"sidecar \u65f6\u4ee3 \u5b9e\u9645\u4e0a\u65e9\u57282013\u5e74\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u67b6\u6784\u7684\u5927\u89c4\u6a21\u5e94\u7528\u65b9 Netflix\uff0c \u5c31\u53d1\u73b0\u4e86\u5fae\u670d\u52a1\u67b6\u6784\u5728\u8de8\u8bed\u8a00\u4e0a\u7684\u95ee\u9898\u3002Netflix \u5927\u91cf\u4f7f\u7528 Java \u6280\u672f\u6808\uff0c\u4f46\u56e0\u4e3a\u516c\u53f8\u7684\u4e1a\u52a1\u53d1\u5c55\uff0c\u4f7f\u7528\u5355\u4e00\u6280\u672f\u6808\u662f\u4e0d\u73b0\u5b9e\u7684 \u628a SDK \u91cc\u7684\u529f\u80fd\u8f6c\u79fb\u5230 sidecar \u4e2d\u3002 \u6240\u8c13 sidecar\uff0c \u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u90e8\u7f72\u5728\u672c\u5730\u7684\u4ee3\u7406\u670d\u52a1\u5668\uff0c\u5b83\u65e2\u63a5\u7ba1\u4e86\u5165\u53e3\u6d41\u91cf\uff0c\u4e5f\u63a5\u7ba1\u4e86\u51fa\u53e3\u6d41\u91cf\u3002 \u5176\u5b9e\u8fd9\u79cd\u6a21\u5f0f\u8981\u8ffd\u6eaf\u5230 Web Server \u7684\u65f6\u4ee3\uff0c\u6bd4\u5982 Nginx + Php-fpm \u8fd9\u79cd\u6a21\u5f0f\uff0c\u5b9e\u9645\u4e0a Nginx \u4e5f\u662f\u5145\u5f53\u4e86 sidecar \u7684\u89d2\u8272\uff0c\u53ea\u662f\u901a\u4fe1\u534f\u8bae\u7531\u6bd4\u8f83\u5e38\u89c1\u7684 HTTP \uff0c\u53d8\u6210\u4e86 FastCGI \uff0c\u53e6\u5916 Nginx \u53ea\u662f\u4ee3\u7406\u4e86\u5165\u53e3\u6d41\u91cf\uff0c\u5e76\u672a\u4ee3\u7406\u51fa\u53e3\u6d41\u91cf\u3002 \u521d\u4ee3 Service Mesh \u7b2c\u4e00\u4ee3 Service Mesh\uff0c\u5176\u4e2d\u6bd4\u8f83\u51fa\u540d\u7684\u662f Linkerd \u548c Envoy\u3002 \u5728\u8fd9\u4e00\u4ee3 Service Mesh \u4e2d\uff0c\u5df2\u7ecf\u4e0d\u518d\u4f9d\u8d56\u7279\u5b9a\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u6700\u91cd\u8981\u7684\u662f\u5b83\u7684\u51fa\u53d1\u70b9\u5df2\u7ecf\u4e0d\u662f\u89e3\u51b3\u591a\u8bed\u8a00\u7684\u95ee\u9898\uff0c\u800c\u662f\u4ece\u7edf\u4e00\u6d41\u91cf\u5904\u7406\u6a21\u578b\u7684\u89d2\u5ea6\uff0c\u5f62\u6210\u4e86\u4e00\u5957\u7edf\u4e00\u7684\u6d41\u91cf\u63a7\u5236\u7684\u89e3\u51b3\u65b9\u6848\u3002 \u4f46\u662f\u521d\u4ee3 Service Mesh \u6709\u4e00\u4e2a\u81f4\u547d\u7684\u95ee\u9898\uff08\u5176\u5b9e\u4e5f\u4e00\u76f4\u5b58\u5728\u4e8e\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff09\uff0c\u5c31\u662f\u7f3a\u4e4f\u7edf\u4e00\u7684\u7ba1\u63a7\u624b\u6bb5\uff0c\u6bd4\u5982 sidecar \u7684\u670d\u52a1\u6cbb\u7406\u76f8\u5173\u914d\u7f6e\u6587\u4ef6\u7684\u7ef4\u62a4\uff0c\u53ef\u80fd\u9700\u8981\u8fd0\u7ef4\u624b\u52a8\u7ef4\u62a4\u3001\u65e0\u6cd5\u96c6\u4e2d\u7ba1\u7406\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u539f\u56e0\uff0c\u63a7\u5236\u9762\u8bde\u751f\u4e86\u3002 \u65b0\u4e00\u4ee3 Service Mesh \u65b0\u4e00\u4ee3 Service Mesh\uff0c\u5c31\u662f\u5927\u5bb6\u719f\u77e5\u7684 Istio \u4e86\u3002\u5b83\u5f15\u5165\u4e86\u63a7\u5236\u9762\u7684\u6982\u5ff5\uff0c\u8ba9 Service Mesh \u6210\u4e3a\u5b8c\u5168\u4f53\u3002 Istio \u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u63a7\u5236\u9762\u548c Kubernetes \u6df1\u5ea6\u7ed1\u5b9a\uff0c\u65e9\u671f\u7248\u672c\u5c06\u6d41\u91cf\u6cbb\u7406\u7684\u529f\u80fd\u653e\u5728 mixer \u4e2d\uff0c\u5f62\u6210\u4e86\u4e00\u5957\u5b8c\u6574\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\u3002 \u63a7\u5236\u9762\u8d1f\u8d23\u4e86\u8d44\u6e90\u7ba1\u7406\u3001\u914d\u7f6e\u4e0b\u53d1\u3001\u8bc1\u4e66\u7ba1\u7406\u7b49\u529f\u80fd\uff0c\u89e3\u51b3\u4e86\u6570\u636e\u9762\u914d\u7f6e\u96be\u4ee5\u7ba1\u7406\u7684\u95ee\u9898\u3002","title":"2-5 Service Mesh \u7684\u6f14\u8fdb\u5386\u7a0b"},{"location":"chap1/1chap1_learn_SM/#2-6-service-mesh","text":"1.\u8bed\u8a00\u65e0\u5173 Service Mesh \u505a\u5230\u4e86\u771f\u6b63\u7684\u8bed\u8a00\u65e0\u5173\uff1a\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u67b6\u6784\u8981\u4e3a\u5404\u79cd\u8bed\u8a00\u5f00\u53d1 SDK \uff0c\u800c Service Mesh \u5c06 SDK \u7684\u529f\u80fd\u96c6\u6210\u5230 sidecar \u4e2d\uff0c\u5b9e\u73b0\u4e86\u771f\u6b63\u7684\u8bed\u8a00\u65e0\u5173\u6027\u3002 2.\u57fa\u7840\u8bbe\u65bd\u72ec\u7acb\u6f14\u8fdb Service Mesh \u67b6\u6784\u5c06\u6846\u67b6\u4e2d\u548c\u4e1a\u52a1\u65e0\u5173\u7684\u901a\u7528\u529f\u80fd\u653e\u5728 sidecar \u4e2d\uff0c\u5347\u7ea7\u65f6\u53ea\u8981\u5347\u7ea7 sidecar \u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u6837\u505a\u5230\u4e86\u57fa\u7840\u8bbe\u65bd\u7684\u72ec\u7acb\u6f14\u8fdb\u3002 \u5b9e\u9645\u4e0a\u8fd9\u79cd\u505a\u6cd5\u4e5f\u5e26\u6765\u4e86\u53e6\u5916\u4e00\u4e2a\u597d\u5904\uff1a\u5199\u6846\u67b6\u7684\u65f6\u5019\u4e0d\u7528\u518d\u8003\u8651\u592a\u591a\u7684\u5411\u540e\u517c\u5bb9\u6027\uff0c\u964d\u4f4e\u4e86\u7f16\u5199\u4ee3\u7801\u7684\u5fc3\u667a\u8d1f\u62c5\u3002 3.\u53ef\u89c2\u6d4b\u6027 \u53ef\u89c2\u6d4b\u6027\u4e00\u822c\u5305\u542b\u4e24\u4e2a\u90e8\u5206\uff1a \u76d1\u63a7\u62a5\u8b66\u548c\u94fe\u8def\u8ffd\u8e2a \u3002 \u76d1\u63a7\u62a5\u8b66\u53ef\u4ee5\u901a\u8fc7\u6570\u636e\u9762\u7684 Metrics \u96c6\u6210\uff0c\u65e0\u611f\u77e5\u5730\u505a\u5230\u7cfb\u7edf\u76d1\u63a7\u62a5\u8b66\uff0c\u51cf\u5c11\u4e86\u4e1a\u52a1\u548c\u6846\u67b6\u7684\u91cd\u590d\u5de5\u4f5c\u3002 \u81f3\u4e8e\u94fe\u8def\u8ffd\u8e2a\uff0c\u56e0\u4e3a\u9700\u8981\u901a\u8fc7 header \u5c06 traceid \u4f20\u9012\u4e0b\u53bb\uff0c\u6240\u4ee5\u8fd8\u662f\u9700\u8981\u5ba2\u6237\u7aef\u7684 SDK \u5c06 traceid \u901a\u8fc7 header \u4f20\u9012\u3002\u4e0d\u8fc7\u8fd9\u4e2a\u505a\u6cd5\u4e5f\u7b80\u5316\u4e86 Trace SDK \u7684\u5c01\u88c5\u3002 4.\u8fb9\u7f18\u7f51\u5173\u7edf\u4e00 \u5b9e\u9645\u4e0a sidecar \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u7f51\u5173/\u53cd\u5411\u4ee3\u7406\uff0c\u81ea\u7136\u53ef\u4ee5\u5c06\u4ee5\u524d Nginx/Kong \u4e4b\u7c7b\u7684\u7cfb\u7edf\u7f51\u5173\u8fc1\u79fb\u5230 sidecar \u4e0a\u6765\uff0c \u8fd9\u6837\u5c31\u53ef\u4ee5\u7ef4\u62a4\u4e00\u5957\u7edf\u4e00\u7684\u4ee3\u7801 \u3002 \u66f4\u8fdb\u4e00\u6b65\uff0c\u53ef\u4ee5\u5c06\u4ee5\u524d\u8fb9\u7f18\u7f51\u5173\u7684\u5de5\u4f5c\uff0c\u6bd4\u5982\u9274\u6743\u3001 trace \u521d\u59cb\u5316\u7b49\u5de5\u4f5c\u4e0b\u6c89\u5230 sidecar \u4e0a\uff0c\u8fdb\u4e00\u6b65\u7b80\u5316\u7cfb\u7edf\u7f51\u5173\u7684\u529f\u80fd\u3002","title":"2-6 Service Mesh \u7684\u4f18\u52bf"},{"location":"chap1/1chap1_learn_SM/#2-6-service-mesh_1","text":"Service Mesh \u4e00\u4e2a\u6700\u91cd\u8981\u7684\u53d8\u9769\uff0c\u5c31\u662f\u5f15\u5165\u4e86 \u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u7684\u6982\u5ff5 \uff0c\u8fd9\u4e2a\u6982\u5ff5\u4e5f\u5e76\u975e Service Mesh \u65b0\u521b\u7684\u6982\u5ff5\uff0c\u5b9e\u9645\u4e0a\u5728 SDN (\u8f6f\u4ef6\u5b9a\u4e49\u7f51\u7edc)\u4e2d\u5c31\u6709\u4e86\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u6982\u5ff5\u3002 1 \u6570\u636e\u9762(Data Plane) \u8d1f\u8d23\u6570\u636e\u7684\u8f6c\u53d1 \uff0c\u4e00\u822c\u6211\u4eec\u5e38\u89c1\u7684 \u901a\u7528\u7f51\u5173\u3001Web Server\uff0c\u6bd4\u5982 Nginx\u3001Traefik \u90fd\u53ef\u4ee5\u8ba4\u4e3a\u662f\u6570\u636e\u9762\u7684\u4e00\u79cd\u3002\u5728 Service Mesh \u7684\u5f00\u6e90\u4e16\u754c\u4e2d\uff0cEnvoy \u53ef\u4ee5\u8bf4\u662f\u6700\u77e5\u540d\u7684\u6570\u636e\u9762\u4e86 \u3002 \u53e6\u5916\u6570\u636e\u9762 \u5e76\u975e\u5c40\u9650\u4e8e\u7f51\u5173\u7c7b\u4ea7\u54c1\uff0c\u5b9e\u9645\u4e0a\u67d0\u4e9b RPC \u6846\u67b6\u4e5f\u53ef\u4ee5\u5145\u5f53\u6570\u636e\u9762 \uff0c\u6bd4\u5982 gRPC \u5c31\u5df2\u7ecf\u652f\u6301\u5b8c\u6574\u7684 xDS(\u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u7684\u4ea4\u4e92\u534f\u8bae)\uff0c\u4e5f\u53ef\u4ee5\u5f53\u4f5c\u6570\u636e\u9762\u4f7f\u7528\u3002 \u4e00\u822c\u6211\u4eec\u628a\u8d1f\u8d23\u6570\u636e\u8f6c\u53d1\u7684\u6570\u636e\u9762\u79f0\u4e3a sidecar\uff08\u8fb9\u8f66\uff09 \u3002 2 \u63a7\u5236\u9762(Control Plane) \u901a\u8fc7 xDS \u534f\u8bae\u5bf9\u6570\u636e\u9762\u8fdb\u884c\u914d\u7f6e\u4e0b\u53d1\uff0c\u4ee5\u63a7\u5236\u6570\u636e\u9762\u7684\u884c\u4e3a\uff0c\u6bd4\u5982\u8def\u7531\u8f6c\u53d1\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u6cbb\u7406\u7b49\u914d\u7f6e\u4e0b\u53d1\u3002 \u63a7\u5236\u9762\u7684\u51fa\u73b0\u89e3\u51b3\u4e86\u65e0\u8bba\u662f\u6846\u67b6\u8fd8\u662f\u6570\u636e\u9762\u3001sidecar \u90fd\u7f3a\u4e4f\u63a7\u5236\u80fd\u529b\u7684\u5f0a\u7aef\uff0c\u800c\u4e14\u4e4b\u524d\u53ea\u80fd\u901a\u8fc7\u8fd0\u7ef4\u6279\u91cf\u4fee\u6539 CONF \u6765\u63a7\u5236\u6570\u636e\u9762\u3001\u5bfc\u81f4\u89c4\u6a21\u4e0a\u5347\u65f6\u7eaf\u4eba\u5de5\u7ef4\u62a4\u6210\u672c\u4ee5\u53ca\u5927\u5e45\u5ea6\u4e0a\u5347\u7684\u9519\u8bef\u6982\u7387\u7b49\u95ee\u9898\u4e5f\u5f97\u5230\u4e86\u5f88\u597d\u7684\u89e3\u51b3\u3002 \u5b9e\u9645\u4e0a Service Mesh \u9700\u8981\u7684\u57fa\u7840\u7ec4\u4ef6\u548c\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u6ca1\u6709\u592a\u5927\u7684\u5dee\u522b\uff0c\u5f88\u591a\u516c\u53f8\u9009\u62e9\u81ea\u7814\u63a7\u5236\u9762\u5c31\u662f\u4e3a\u4e86\u517c\u5bb9\u8001\u7248\u672c\u5fae\u670d\u52a1\u7684\u57fa\u7840\u7ec4\u4ef6\u3002","title":"2-6 Service Mesh \u7684\u57fa\u7840\u7ec4\u4ef6\u53ca\u5e38\u89c1\u540d\u8bcd"},{"location":"chap1/1chap1_learn_SM/#2-8-service-mesh","text":"\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3 \uff1a\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u7ec4\u4ef6\u3002\u670d\u52a1\u901a\u8fc7\u6ce8\u518c\u81ea\u8eab\u8282\u70b9\uff0c\u8ba9\u8c03\u7528\u65b9\u670d\u52a1\u53d1\u73b0\u88ab\u8c03\u65b9\u670d\u52a1\u8282\u70b9\uff0c\u4ee5\u8fbe\u5230\u670d\u52a1\u95f4\u70b9\u5bf9\u70b9\u901a\u4fe1\u7684\u76ee\u7684\u3002 \u914d\u7f6e\u4e2d\u5fc3 \uff1a\u7528\u4e8e\u670d\u52a1\u7684\u57fa\u7840\u914d\u7f6e\u66f4\u65b0\uff0c\u4ee5\u8fbe\u5230\u4ee3\u7801\u548c\u914d\u7f6e\u5206\u79bb\u7684\u76ee\u7684\u3002\u51cf\u5c11\u670d\u52a1\u7684\u53d1\u5e03\u6b21\u6570\uff0c\u914d\u7f6e\u53d1\u5e03\u53ef\u4ee5\u66f4\u5feb\u66f4\u53ca\u65f6\u5730\u53d8\u66f4\u670d\u52a1\u3002 API \u7f51\u5173 \uff1a\u901a\u8fc7\u7edf\u4e00\u7684\u7f51\u5173\u5c42\uff0c\u6536\u655b\u670d\u52a1\u7684\u7edf\u4e00\u9274\u6743\u5c42\u3001\u94fe\u8def ID \u751f\u6210\u7b49\u57fa\u7840\u670d\u52a1\uff0c\u5e76\u805a\u5408\u540e\u7aef\u670d\u52a1\u4e3a\u5ba2\u6237\u7aef\u63d0\u4f9b RESTful \u63a5\u53e3\u3002\u53e6\u5916 API \u7f51\u5173\u4e5f\u8d1f\u8d23\u5357\u5317\u5411\u6d41\u91cf(\u5916\u7f51\u5165\u53e3\u6d41\u91cf)\u7684\u6d41\u91cf\u6cbb\u7406\u3002 \u670d\u52a1\u6cbb\u7406 \uff1a\u901a\u8fc7\u9650\u6d41\u3001\u7194\u65ad\u7b49\u57fa\u7840\u7ec4\u4ef6\uff0c\u675c\u7edd\u5fae\u670d\u52a1\u67b6\u6784\u51fa\u73b0\u96ea\u5d29\u7684\u9690\u60a3\u3002 \u94fe\u8def\u8ffd\u8e2a \uff1a\u901a\u8fc7 trace \u5c06\u6574\u4e2a\u5fae\u670d\u52a1\u94fe\u8def\u6e05\u6670\u5730\u7ed8\u5236\u51fa\u6765\uff0c\u5e76\u8fdb\u884c\u7cbe\u51c6\u7684\u6545\u969c\u6392\u67e5\uff0c\u6781\u5927\u5730\u964d\u4f4e\u4e86\u6545\u969c\u6392\u67e5\u7684\u96be\u5ea6\u3002 \u76d1\u63a7\u544a\u8b66 \uff1a\u901a\u8fc7 Prometheus \u548c Grafana \u8fd9\u6837\u7684\u57fa\u7840\u7ec4\u4ef6\uff0c\u7ed8\u5236\u670d\u52a1\u72b6\u6001\u76d1\u63a7\u5927\u76d8\uff0c\u9488\u5bf9\u8d44\u6e90\u3001\u670d\u52a1\u3001\u4e1a\u52a1\u5404\u9879\u6307\u6807\uff0c\u505a\u7cbe\u51c6\u7684\u76d1\u63a7\u62a5\u8b66\u3002","title":"2-8 Service Mesh \u7684\u57fa\u7840\u7ec4\u4ef6"},{"location":"chap1/1chap1_learn_SM/#2-9-service-mesh","text":"Upstream : \u4e0a\u6e38\u670d\u52a1\uff0c\u5982\u679c A \u670d\u52a1\u8c03\u7528 B \u670d\u52a1\uff0c\u5728 A \u670d\u52a1\u7684\u89c6\u89d2\u6765\u770b\uff0cB \u670d\u52a1\u5c31\u662f\u4e0a\u6e38\u670d\u52a1\uff0c\u4f46\u662f\u5728\u4e2d\u6587\u7684\u8bed\u5883\u4e2d\uff0c\u7ecf\u5e38\u88ab\u53eb\u4f5c\u201c\u4e0b\u6e38\u670d\u52a1\u201d\u3002\u6240\u4ee5\u5728\u6574\u4e2a\u8bfe\u7a0b\u4e2d\uff0c\u4e3a\u4e86\u907f\u514d\u8bed\u8a00\u4e0a\u7684\u6b67\u4e49\uff0c\u6211\u4f1a\u76f4\u63a5\u4f7f\u7528upstream\uff0c\u800c\u4e0d\u662f\u4e2d\u6587\u7ffb\u8bd1\u3002\u5728\u4e2d\u6587\u7684\u8bed\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b22\u79f0\u5b83\u4e3a\u670d\u52a1\u7aef\u6216\u8005\u88ab\u8c03\u7528\u65b9\u3002 Downstream : \u4e0b\u6e38\u670d\u52a1\uff0c\u5982\u679c A \u670d\u52a1\u8c03\u7528 B \u670d\u52a1\uff0c\u5728 B \u670d\u52a1\u7684\u89c6\u89d2\u4e2d\uff0cA \u670d\u52a1\u5c31\u662f\u4e0b\u6e38\u670d\u52a1\u3002\u5728\u4e2d\u6587\u7684\u8bed\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b22\u53eb\u5ba2\u6237\u7aef\u6216\u8005\u8c03\u7528\u65b9\u3002 Endpoint \uff1a\u6307\u7684\u662f\u670d\u52a1\u8282\u70b9\uff0c\u6bd4\u5982 A \u670d\u52a1\u6709 192.168.2.11 \u548c 192.168.2.12 \u4e24\u4e2a\u670d\u52a1\u8282\u70b9\u3002 Cluster \uff1a\u6307\u7684\u662f\u670d\u52a1\u96c6\u7fa4\uff0c\u6bd4\u5982 A \u670d\u52a1\u6709 192.168.2.11 \u548c 92.168.2.12 \u4e24\u4e2a\u670d\u52a1\u8282\u70b9\uff0c\u90a3\u4e48A\u670d\u52a1\u5c31\u662f Cluster\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7406\u89e3\u4e3a Service Node \uff1a\u5728 Kubernetes \u8bed\u5883\u4e2d\uff0c\u6307\u7684\u662f\u627f\u8f7d pod \u7684\u670d\u52a1\u5668\uff0c\u4f46\u5728\u5fae\u670d\u52a1\u7684\u8bed\u5883\u4e2d\uff0c\u66f4\u591a\u7684\u7b49\u540c\u4e8eEndpoint\u3002 Route \uff1a\u6307\u7684\u662f Service Mesh \u4e2d\u7684\u8def\u7531\u914d\u7f6e\uff0c\u6bd4\u5982 A \u670d\u52a1\u8bbf\u95ee B \u670d\u52a1\uff0c\u8981\u5339\u914d\u5230\u4e00\u5b9a\u7684\u89c4\u5219\uff0c\u6bd4\u5982 header \u4e2d\u8981\u5e26\u6709\u670d\u52a1\u540d( -H servicename:B )\uff0c\u624d\u80fd\u591f\u62ff\u5230 B \u670d\u52a1\u7684\u8bbf\u95ee\u65b9\u5f0f\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u6216\u8005\u9759\u6001\u5217\u8868\u8bbf\u95ee\u5230 B \u670d\u52a1\u7684\u8282\u70b9\u3002 Listener \uff1a\u6307\u7684\u662f Service Mesh \u7684\u76d1\u542c\u7aef\u53e3\uff0c\u901a\u5e38\u6211\u4eec\u8bbf\u95ee Service Mesh \u7684\u6570\u636e\u9762\uff0c\u9700\u8981\u77e5\u9053\u6570\u636e\u9762\u7684\u76d1\u542c\u7aef\u53e3\u3002","title":"2-9 Service Mesh \u540d\u8bcd\u89e3\u91ca"},{"location":"chap1/2chap1_service_register/","text":"\u7b2c\u4e8c\u8282 \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3 \u5fae\u670d\u52a1\u5176\u4e2d\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\uff0c\u662f\u6700\u5148\u9700\u8981\u89e3\u51b3\u7684\u95ee\u9898\u3002\u7b80\u5355\u6765\u8bf4\uff0c \u670d\u52a1\u6ce8\u518c\u4e0e\u53d1\u73b0\u5c31\u662f\u4fdd\u8bc1\u5f53\u670d\u52a1\u4e0a\u4e0b\u7ebf\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u670d\u52a1\u6d88\u8d39\u8005\u548c\u670d\u52a1\u63d0\u4f9b\u8005\u80fd\u591f\u4fdd\u6301\u6b63\u5e38\u901a\u4fe1\u3002 \u800c\u5728\u5206\u5e03\u5f0f\u67b6\u6784\u4e2d\uff0c\u670d\u52a1\u4f1a\u6ce8\u518c\u5230\u6ce8\u518c\u4e2d\u5fc3\uff0c\u5f53\u670d\u52a1\u9700\u8981\u8c03\u7528\u5176\u4ed6\u670d\u52a1\u65f6\uff0c\u5c31\u5230\u8fd9\u91cc\u627e\u5230\u670d\u52a1\u7684\u5730\u5740\uff0c\u8fdb\u884c\u8c03\u7528\u3002 \u6ce8\u518c\u4e2d\u5fc3\u662f\u5fae\u670d\u52a1\u4e2d\u6700\u91cd\u8981\u7684\u5185\u5bb9\uff0c\u4e5f\u662f\u548c SOA \u67b6\u6784\u4e2d\u7684\u96c6\u4e2d\u603b\u7ebf\u901a\u4fe1\u6700\u5927\u7684\u533a\u522b\u70b9 \u3002 1\u3001\u670d\u52a1\u6ce8\u518c\u53d1\u73b0 \u5047\u8bbe\u5728\u5355\u4f53\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u670d\u52a1\uff0c\u8fd9\u4e2a\u670d\u52a1\u524d\u9762\u5c31\u662f\u50cf Nginx \u8fd9\u6837\u7684\u7f51\u5173\u7cfb\u7edf\uff0c\u8d1f\u8d23\u8d1f\u8f7d\u5747\u8861\uff0c\u800c\u540e\u7aef\u7684\u673a\u5668\u8282\u70b9\u4e5f\u662f\u6211\u4eec\u624b\u52a8\u914d\u7f6e\u4e0a\u53bb\u7684\uff0c\u6bd4\u5982 upstream backend { server 10.0.0.1:80; server 10.0.0.2:80; } \u5982\u679c\u673a\u5668\u4e0d\u591f\u7528\u4e86\uff0c\u589e\u52a0\u4e00\u4e2a\u8282\u70b9\uff0c\u7136\u540e reload \u4e00\u4e0b Nginx \u5c31\u597d\u4e86\u3002 \u8fd9\u6837\u7684\u914d\u7f6e\uff0c\u67b6\u6784\u8fd0\u884c\u5f97\u8fd8\u7b97\u7a33\u5b9a\uff0c\u7ef4\u62a4\u6210\u672c\u516c\u53f8\u4e5f\u8fd8\u53ef\u4ee5\u63a5\u53d7 \u3002 \u968f\u7740\u9879\u76ee\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u4fee\u6b63 Bug \u548c\u6b63\u786e\u5730\u6dfb\u52a0\u65b0\u529f\u80fd\u53d8\u5f97\u66f4\u52a0\u56f0\u96be\uff0c\u4f60\u9009\u62e9\u7ee7\u7eed\u62c6\u5206\u670d\u52a1\u3002\u6162\u6162\u5730\uff0c\u4f60\u62c6\u5206\u7684\u670d\u52a1\u6570\u91cf\u4e0a\u5347\u5230\u4e86\u4e24\u4f4d\u6570\uff0c \u4f46\u662f\u4f60\u53d1\u73b0\u6bcf\u6b21\u56e0\u4e3a\u673a\u5668\u8d1f\u8f7d\u74f6\u9888\u800c\u589e\u52a0\u673a\u5668\u65f6\uff0c\u9700\u8981\u4fee\u6539\u5f88\u591a\u4efd\u5185\u7f51\u7f51\u5173\u914d\u7f6e \uff0c \u8fd9\u65e0\u5f62\u4e2d\u53ef\u4ee5\u9884\u6599\u5230\uff0c\u4fee\u6539\u914d\u7f6e\u5e26\u6765\u7684\u7ef4\u62a4\u6210\u672c\u548c\u51fa\u9519\u7684\u6982\u7387\u90fd\u4f1a\u5448\u6307\u6570\u7ea7\u589e\u52a0\u3002 \u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u7684\u529e\u6cd5\uff1a\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u3002 \u670d\u52a1\u5728\u542f\u52a8\u65f6\uff0c\u5c06\u81ea\u5df1\u7684\u4fe1\u606f\u6ce8\u518c\u5230\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u4e2d\uff0c\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u4f1a\u5b58\u50a8\u8fd9\u4e9b\u4fe1\u606f\u3002 \u670d\u52a1\u6d88\u8d39\u8005\u53ef\u4ece\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u67e5\u8be2\u670d\u52a1\u63d0\u4f9b\u8005\u7684\u7f51\u7edc\u5730\u5740\uff0c\u5e76\u4f7f\u7528\u8be5\u5730\u5740\u8c03\u7528\u670d\u52a1\u63d0\u4f9b\u8005\u63a5\u53e3 \u3002 \u800c\u5f53\u670d\u52a1\u63d0\u4f9b\u8005\u7f51\u7edc\u5730\u5740\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u4f1a\u91cd\u65b0\u6ce8\u518c\u5230\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6 \u3002 \u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u670d\u52a1\u6d88\u8d39\u8005\u5c31\u65e0\u987b\u4eba\u5de5\u4fee\u6539\u63d0\u4f9b\u8005\u7684\u7f51\u7edc\u5730\u5740\u4e86\u3002 2\u3001\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3 \u5177\u4f53\u600e\u6837\u5229\u7528\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u89e3\u51b3\u591a\u4e2a\u670d\u52a1\u95f4\u7684\u901a\u4fe1\u95ee\u9898\u5462\uff1f \u89e3\u51b3\u591a\u4e2a\u670d\u52a1\u95f4\u901a\u4fe1\u95ee\u9898\u7684\u5de5\u5177\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3 \u6240\u4ee5\u6709\u4e9b\u4eba\u4e5f\u4f1a\u628a\u6ce8\u518c\u4e2d\u5fc3\u53eb\u4f5c\u540d\u5b57\u670d\u52a1\uff0c\u987e\u540d\u601d\u4e49\uff0c \u4e5f\u5c31\u662f\u901a\u8fc7 \u670d\u52a1\u540d\u67e5\u627e\u5bf9\u5e94\u7684\u670d\u52a1\u5730\u5740\u7684\u670d\u52a1\uff0c\u5728\u5206\u5e03\u5f0f\u67b6\u6784\u4e2d\uff0c\u6ce8\u518c\u4e2d\u5fc3\u627f\u63a5\u4e86\u670d\u52a1\u7684\u5730\u5740\u5f55\u5165\u548c\u67e5\u627e\u529f\u80fd 3\u3001\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u5eb7\u68c0\u67e5\u8bbe\u8ba1 3-1 \u670d\u52a1\u4e3b\u52a8\u63a2\u6d3b \u670d\u52a1\u901a\u8fc7\u5b9a\u65f6\u53d1\u9001\u7eed\u79df\u4fe1\u606f\u5230\u6ce8\u518c\u4e2d\u5fc3\uff0c\u4ee5\u8868\u660e\u81ea\u5df1\u8282\u70b9\u7684\u5b58\u6d3b \u3002 \u4e3b\u52a8\u63a2\u6d3b\u7684\u65b9\u5f0f\u5176\u5b9e\u662f\u6211\u4eec\u5728\u4f7f\u7528\u6ce8\u518c\u4e2d\u5fc3\u65f6\u7528\u5f97\u6700\u591a\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c \u5982\u679c\u4f60\u7684\u670d\u52a1\u96c6\u7fa4\u89c4\u6a21\u4e0d\u5927\uff0c\u6216\u8005\u9009\u7528\u4e86\u7c7b\u4f3c Eureka \u8fd9\u6837\u7684\u6700\u7ec8\u4e00\u81f4\u6027\u7684\u6ce8\u518c\u4e2d\u5fc3\uff0c\u670d\u52a1\u4e3b\u52a8\u63a2\u6d3b\u7edd\u5bf9\u662f\u4f60\u7684\u6700\u4f18\u7684\u9009\u62e9 \u8fd9\u79cd\u65b9\u5f0f\u6700\u5927\u7a0b\u5ea6\u907f\u514d\u4e86\u5728Kubernetes\u73af\u5883\u4e2d\uff0c\u56e0\u4e3a IP \u91cd\u7528\u5bfc\u81f4\u8282\u70b9\u5728\u65e7\u7684\u670d\u52a1\u4e0a\u4f9d\u7136\u5b58\u6d3b\u7684\u95ee\u9898\uff0c\u6bd5\u7adf\u7eed\u79df\u4fe1\u606f\u90fd\u662f\u5e26\u7740\u670d\u52a1\u4fe1\u606f\u4e0a\u62a5\u5230\u6ce8\u518c\u4e2d\u5fc3\u7684\u3002 \u4e3b\u52a8\u63a2\u6d3b\u7684\u6700\u5927\u95ee\u9898\uff1a \u9020\u6210\u6ce8\u518c\u4e2d\u5fc3\u7684\u5199\u64cd\u4f5c\u53d8\u591a \u5728\u670d\u52a1\u53d1\u5e03\u65f6\uff0c\u8282\u70b9\u4f1a\u4ea7\u751f\u6bd4\u8f83\u5927\u7684\u53d8\u52a8\uff0c\u6ce8\u518c\u4e2d\u5fc3\u7684\u5199\u538b\u529b\u4e5f\u5c31\u4f1a\u53d8\u5927\u3002 \u800c\u4e14\u5f3a\u4e00\u81f4\u6027\u7684\u6ce8\u518c\u4e2d\u5fc3\uff0c\u8282\u70b9\u53d8\u5316\u4e00\u5b9a\u8981\u4e3b\u8282\u70b9\u786e\u8ba4\uff0c\u5982\u679c\u6ca1\u6709\u505a\u6ce8\u518c\u4e2d\u5fc3\u7684\u8bfb\u5199\u5206\u79bb\uff0c\u5c31\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u901a\u77e5\u4e8b\u4ef6\uff0c\u5bf9\u5e26\u5bbd\u3001CPU \u6765\u8bf4\u90fd\u662f\u707e\u96be\u6027\u7684\u95ee\u9898\uff0c\u8fd9\u4e2a\u65f6\u5019\u6ce8\u518c\u4e2d\u5fc3\u5df2\u7ecf\u5b8c\u5168\u6ca1\u6709\u529e\u6cd5\u54cd\u5e94 TTL \u7684\u79df\u7ea6\u8bf7\u6c42\uff0c\u4e5f\u4f1a\u5bfc\u81f4\u5927\u91cf\u7684\u8282\u70b9\u5931\u6548 \u4e3b\u52a8\u79df\u7ea6\uff0c\u5176\u5b9e\u5e76\u4e0d\u8db3\u4ee5\u8bf4\u660e\u670d\u52a1\u662f\u5065\u5eb7\u7684\uff0c\u6bd5\u7adf\u6709\u4e9b\u60c5\u51b5\u4e0b\uff0c\u670d\u52a1\u867d\u7136\u65e0\u6cd5\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u4e86\uff0c\u4f46\u8fd8\u662f\u53ef\u4ee5\u5bf9\u5916\u53d1\u9001\u79df\u7ea6\u8bf7\u6c42\u7684\u3002 3-2 \u6ce8\u518c\u4e2d\u5fc3\u4e3b\u52a8\u53d1\u8d77\u5065\u5eb7\u68c0\u67e5 \u670d\u52a1\u5728\u8fdb\u884c\u670d\u52a1\u6ce8\u518c\u65f6\uff0c\u5411\u6ce8\u518c\u4e2d\u5fc3\u8868\u660e\u81ea\u5df1\u7684\u5065\u5eb7\u68c0\u67e5\u63a5\u53e3\uff0c\u6bd4\u5982 /ping \u6216\u8005 TCP \u7aef\u53e3\uff0c\u6ce8\u518c\u4e2d\u5fc3\u901a\u8fc7\u5b9a\u65f6\u8bbf\u95ee\u7684\u65b9\u5f0f\uff0c\u63a2\u660e\u8282\u70b9\u662f\u5426\u5b58\u6d3b\u3002 \u7b2c\u4e8c\u79cd\u65b9\u6848\u5728 \u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u89e3\u51b3\u4e86\u670d\u52a1\u4e3b\u52a8\u63a2\u6d3b\u5e76\u4e0d\u80fd\u8bf4\u660e\u670d\u52a1\u5065\u5eb7\u7684\u95ee\u9898 \uff0c\u6bd5\u7adf\u901a\u8fc7 /ping \u8fd9\u79cd\u5065\u5eb7\u68c0\u67e5\u63a5\u53e3\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53ef\u4ee5\u8bf4\u660e\u670d\u52a1\u7684\u5065\u5eb7\u5ea6\u3002\u5728Kubernetes\u73af\u5883\u4e2d\uff0c\u4e5f\u662f\u901a\u8fc7\u5bf9 Pod \u8fdb\u884c\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6765\u5224\u5b9a Pod \u7684\u5065\u5eb7\u5ea6\u7684\u3002 \u4f46\u8fd9\u4e2a\u65b9\u6848\u4e5f\u6709\u4e00\u4e9b\u95ee\u9898\uff1a \u6bd4\u5982\u4e0a\u9762\u63d0\u5230\u7684 IP \u91cd\u7528\u95ee\u9898\uff0c\u5982\u679c\u4e24\u4e2a\u670d\u52a1\u90fd\u7528\u4e86 /ping \u63a5\u53e3\u505a\u5065\u5eb7\u68c0\u67e5\uff0c\u5e76\u4e14\u7aef\u53e3\u4e00\u81f4\uff0c\u5c31\u5f88\u5bb9\u6613\u53d1\u751f\u8282\u70b9\u5728\u65e7\u670d\u52a1\u88ab\u91cd\u65b0\u6fc0\u6d3b\u7684\u95ee\u9898\u3002\u5f53\u7136\u4e5f\u6709\u76f8\u5e94\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u5c31\u662f\u53c2\u8003 Envoy \u505a\u670d\u52a1\u540d\u79f0\u7684 check \u3002 3-3 \u6ce8\u518c\u4e2d\u5fc3\u4e0d\u8fdb\u884c\u4efb\u4f55\u5065\u5eb7\u68c0\u67e5\uff0c\u7531\u8c03\u7528\u65b9\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5 \u6ce8\u518c\u4e2d\u5fc3\u4e0d\u8fdb\u884c\u4efb\u4f55\u63a2\u6d3b\u673a\u5236\uff0c\u5168\u90e8\u7531\u8c03\u7528\u65b9\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u4e3b\u52a8\u548c\u88ab\u52a8\u63a2\u6d3b\u3002 \u7b2c\u4e09\u79cd\u65b9\u6848\u5c31\u6bd4\u8f83\u6781\u7aef\u4e86\uff0c\u4e0d\u505a\u4efb\u4f55\u5065\u5eb7\u68c0\u67e5\uff0c\u5b8c\u5168\u9760\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u80fd\u529b\u3002 \u8fd9\u79cd\u65b9\u5f0f\u4e5f\u662f\u6709\u5e94\u7528\u573a\u666f\u7684\uff0c\u5982\u679c\u4f7f\u7528\u4e86 gRPC \u8fd9\u6837\u6bd4\u8f83\u5b8c\u5584\u7684 RPC \u5e93\uff0c\u4e00\u822c\u90fd\u6709\u81ea\u52a8\u6458\u9664\u8282\u70b9\u7684\u80fd\u529b\u3002\u4f46\u6211\u4eec\u4e5f\u8981\u8003\u8651\u5230\u8fd9\u4e2a\u65b9\u6848\u7684\u4e0d\u8db3\uff0c\u5982\u679c IP \u88ab\u91cd\u7528\uff0c\u8282\u70b9\u5f88\u5927\u6982\u7387\u4f1a\u4e00\u76f4\u5b58\u5728\u5728\u65e7\u670d\u52a1\u4e2d\uff0c\u8fd9\u6837\u7684\u810f\u6570\u636e\u968f\u65f6\u90fd\u662f\u98ce\u9669\u70b9\u3002 \u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u7ed3\u5408\u524d\u9762\u4e24\u4e2a\u65b9\u6848\uff0c\u4f18\u5316\u6b64\u65b9\u6848\u3002 \u4f60\u53ef\u4ee5\u5728\u505a\u5065\u5eb7\u68c0\u67e5\u7684\u540c\u65f6\uff0c\u6ce8\u518c\u4e2d\u5fc3\u4e0b\u53d1\u5305\u542b\u5065\u5eb7\u8282\u70b9\u548c\u975e\u5065\u5eb7\u8282\u70b9\u7684\u6570\u636e\u5230\u670d\u52a1\u8282\u70b9\uff0c\u5e76\u9488\u5bf9\u5065\u5eb7\u68c0\u67e5\u672a\u901a\u8fc7\u7684\u5220\u9664\u8282\u70b9\u8bbe\u7f6e\u4e00\u4e2a\u8f83\u957f\u7684\u8fc7\u671f\u65f6\u95f4\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u89e3\u51b3 IP \u91cd\u7528\u4ea7\u751f\u810f\u6570\u636e\u7684\u95ee\u9898\u4e86\u3002 4\u3001\u6ce8\u518c\u4e2d\u5fc3\u9009\u578b \u6211\u6765\u7b80\u5355\u89e3\u91ca\u4e00\u4e0b CAP \u7406\u8bba\uff0c\u4e00\u81f4\u6027\uff08Consistency\uff09\u3001\u53ef\u7528\u6027\uff08Availability\uff09\u3001\u5206\u533a\u5bb9\u9519\u6027\uff08Partition tolerance\uff09\uff0cCAP \u4e0d\u53ef\u80fd\u90fd\u53d6\uff0c\u53ea\u80fd\u53d6\u5176\u4e2d2\u4e2a\u3002 \u6240\u4ee5\u5728\u9009\u578b\u7684\u65f6\u5019\uff0c\u4f18\u5148\u9009\u62e9 AP \u7684\u7cfb\u7edf\u3002\u5982\u679c\u6280\u672f\u6808\u662f Go \uff0c\u4f46\u53c8\u62c5\u5fc3 Java \u7684\u7ec4\u4ef6\u4e0d\u597d\u7ef4\u62a4\uff0c\u4f60\u4e5f\u53ef\u4ee5\u8003\u8651\u81ea\u7814\u6ce8\u518c\u4e2d\u5fc3\uff0c\u5f53\u7136 CP \u7684\u6ce8\u518c\u4e2d\u5fc3\u5e76\u975e\u4e0d\u53ef\u7528\uff0c\u5728\u670d\u52a1\u96c6\u7fa4\u89c4\u6a21\u6bd4\u8f83\u5c0f\u7684\u60c5\u51b5\u4e0b\uff0c\u4e5f\u662f\u53ef\u4ee5\u9009\u62e9\u7684\u3002 5\u3001\u642d\u5efa\u4e00\u4e2a\u9ad8\u53ef\u7528\u3001\u5065\u58ee\u7684\u6ce8\u518c\u4e2d\u5fc3 5-1 \u5728\u5f15\u5165\u6ce8\u518c\u4e2d\u5fc3\u53ef\u80fd\u4f1a\u9047\u7684\u95ee\u9898 \u6ce8\u518c\u4e2d\u5fc3\u5b8c\u5168\u6545\u969c\u4e86\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f \u6ce8\u518c\u4e2d\u5fc3\u56e0\u4e3a\u9ad8\u8d1f\u8f7d\uff0c\u63a8\u9001\u4e86\u5f02\u5e38\u7684\u6570\u636e\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f \u65b0\u52a0\u5165\u7684\u673a\u5668\uff0c\u51fa\u73b0\u4e86\u7f51\u7edc\u8fde\u901a\u6027\u95ee\u9898\uff08\u6ce8\u518c\u4e2d\u5fc3\u548c\u673a\u5668\u7f51\u7edc\u6b63\u5e38\uff0c\u4f46\u670d\u52a1\u673a\u5668\u4e4b\u95f4\u7f51\u7edc\u5f02\u5e38\uff09\uff0c\u5e94\u8be5\u600e\u6837\u5e94\u5bf9\uff1f \u670d\u52a1\u662f\u5426\u5e94\u8be5\u5b8c\u5168\u4fe1\u4efb\u6ce8\u518c\u4e2d\u5fc3\u63a8\u9001\u7684\u6570\u636e\uff1f \u670d\u52a1\u53d1\u5e03\u540e\uff0c\u8282\u9891\u7e41\u53d8\u66f4\u9020\u6210 N\u00d7M \u6b21\u4e8b\u4ef6\u901a\u77e5\uff0c\u5f62\u6210\u5e7f\u64ad\u98ce\u66b4\uff0c\u8be5\u5982\u4f55\u89e3\u51b3\uff1f \u7b2c\u4e09\u65b9\u57fa\u7840\u8bbe\u65bd\uff0c\u6bd4\u5982 MySQL \u3001Redis \uff0c\u8fd9\u79cd\u6570\u636e\u5c42\u7684\u4e2d\u95f4\u4ef6\uff0c\u6211\u4eec\u80af\u5b9a\u662f\u8981\u5b8c\u5168\u4fe1\u4efb\u5176\u4e2d\u7684\u6570\u636e\u7684\u3002\u4f46\u5bf9\u4e8e\u6ce8\u518c\u4e2d\u5fc3\uff0c\u4fe1\u4efb\u63a8\u9001\u6570\u636e\u7684\u98ce\u9669\u975e\u5e38\u5927\u3002 1. \u6ce8\u518c\u4e2d\u5fc3\u5b8c\u5168\u6545\u969c\u4e86\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f \u6240\u4ee5\u53ea\u8981\u5728\u8fdb\u7a0b\u4e2d\u7f13\u5b58\u670d\u52a1\u7684\u8282\u70b9\uff0c\u5f71\u54cd\u9762\u5c31\u53ef\u63a7\u3002 \u5f53\u6ce8\u518c\u4e2d\u5fc3\u5b8c\u5168\u6545\u969c\u7684\u65f6\u5019\uff0c\u670d\u52a1\u6ce8\u518c\u529f\u80fd\u662f\u5931\u6548\u7684\uff0c\u6b64\u65f6\u7684\u6269\u5bb9\u64cd\u4f5c\u65e0\u6cd5\u8fdb\u884c \u3002 \u5982\u679c\u5728\u5bb9\u5668\u4e2d\uff0c\u56e0\u4e3a Pod \u6eda\u52a8\u5347\u7ea7\u7684\u539f\u56e0\u9020\u6210\u4f1a\u5148\u542f\u52a8\u65b0\u7684 Pod\uff0c\u4e00\u5b9a\u8981\u5728\u7a0b\u5e8f\u542f\u52a8\u6ce8\u518c\u5931\u8d25\u65f6\u629b\u51fa\u5f02\u5e38\uff0c\u4f7f\u7a0b\u5e8f\u65e0\u6cd5\u542f\u52a8\uff0c\u5426\u5219\u5bb9\u5668 IP \u7684\u53d8\u5316\u4e5f\u4f1a\u5bfc\u81f4\u670d\u52a1\u7684\u8bbf\u95ee\u5f02\u5e38\u3002 2. \u6ce8\u518c\u4e2d\u5fc3\u56e0\u4e3a\u9ad8\u8d1f\u8f7d\uff0c\u63a8\u9001\u4e86\u5f02\u5e38\u7684\u6570\u636e\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f \u4f46\u968f\u7740\u5fae\u670d\u52a1\u89c4\u6a21\u7684\u589e\u5927\uff0c\u6ce8\u518c\u4e2d\u5fc3\u5f88\u6709\u53ef\u80fd\u9047\u5230\u74f6\u9888\u3002\u4e00\u65e6\u51fa\u73b0\u9ad8\u8d1f\u8f7d\uff0c\u4f1a\u4f7f\u670d\u52a1\u548c\u6ce8\u518c\u4e2d\u5fc3\u4e4b\u95f4\u7684\u5065\u5eb7\u68c0\u67e5\u6216\u4fdd\u6d3b\u51fa\u73b0\u95ee\u9898\uff0c\u6ce8\u518c\u4e2d\u5fc3\u4f7f\u8282\u70b9\u5f02\u5e38\u4e0b\u7ebf\uff0c\u53ea\u63a8\u9001\u90e8\u5206\u8282\u70b9\u6570\u636e\u5230\u8ba2\u9605\u7684\u670d\u52a1\u3002 \u8fd9\u4e2a\u95ee\u9898\u770b\u4f3c\u4e0d\u4e25\u91cd\uff0c\u4f46\u4e00\u65e6\u63a8\u9001\u4e86\u8fc7\u5c11\u7684\u8282\u70b9\u5230\u670d\u52a1\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u8c03\u670d\u52a1\u6253\u6302\u88ab\u8c03\u670d\u52a1\uff0c\u957f\u65f6\u95f4\u4e0d\u80fd\u6062\u590d\uff0c\u751a\u81f3\u4f1a\u5bfc\u81f4\u6574\u4e2a\u5fae\u670d\u52a1\u96c6\u7fa4\u96ea\u5d29\u3002 \u89e3\u51b3\u6b64\u7c7b\u95ee\u9898\uff0c \u6211\u4eec\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u7684\u670d\u52a1\u53d1\u73b0 SDK \u4e2d\u52a0\u5165\u81ea\u6211\u4fdd\u62a4\u673a\u5236 \uff1a \u4e00\u65e6\u670d\u52a1\u7684\u8282\u70b9\u6570\u91cf\u4e0b\u964d\u8d85\u8fc7\u4e00\u5b9a\u9608\u503c\uff0c\u5c31\u8fdb\u5165\u81ea\u6211\u4fdd\u62a4\u72b6\u6001\uff0c\u653e\u5f03\u4f7f\u7528\u65b0\u63a8\u9001\u8fc7\u6765\u7684\u670d\u52a1\u6ce8\u518c\u4fe1\u606f \u3002 3. \u65b0\u52a0\u5165\u7684\u673a\u5668\uff0c\u51fa\u73b0\u4e86\u7f51\u7edc\u8fde\u901a\u6027\u95ee\u9898\uff08\u6ce8\u518c\u4e2d\u5fc3\u548c\u673a\u5668\u7f51\u7edc\u6b63\u5e38\uff0c\u4f46\u670d\u52a1\u673a\u5668\u4e4b\u95f4\u7f51\u7edc\u5f02\u5e38\uff09\uff0c\u5e94\u8be5\u600e\u6837\u5e94\u5bf9\uff1f \u5b9e\u9645\u4e0a\u7f51\u7edc\u8fde\u901a\u6027\u95ee\u9898\u662f\u6bd4\u8f83\u5bb9\u6613\u53d1\u751f\u7684\uff0c\u5f80\u5f80\u51fa\u4e8e\u5b89\u5168\u8003\u8651\uff0c\u5404\u4e2a\u90e8\u95e8\u4e4b\u95f4\u53ef\u80fd\u4f1a\u5904\u5728\u4e0d\u540c\u7684 VPC \uff0c\u4f46\u73b0\u5b9e\u4e2d\u53c8\u6709\u4e92\u76f8\u8bbf\u95ee\u7684\u60c5\u51b5\uff0c \u4e00\u65e6\u7f51\u7edc\u89c4\u5219\u7ef4\u62a4\u4e0d\u597d\uff0c\u5f88\u5bb9\u6613\u51fa\u73b0\u65b0\u6dfb\u52a0\u7684\u673a\u5668\u6ce8\u518c\u4e2d\u5fc3\u7684\u7f51\u6bb5\u53ef\u4ee5\u8bbf\u95ee\uff0c\u4f46\u662f\u670d\u52a1\u4e4b\u95f4\u5374\u65e0\u6cd5\u8bbf\u95ee\u7684\u60c5\u51b5 \u3002 \u5728\u6ce8\u518c\u4e2d\u5fc3\u7684\u4f7f\u7528\u573a\u666f\u4e2d\uff0c\u7f51\u7edc\u6545\u969c\u662f\u6211\u4eec\u6700\u4f18\u5148\u8003\u8651\u7684\u95ee\u9898\uff0c\u5982\u679c\u53d1\u751f\u4e86\u5206\u533a\u6545\u969c\uff0c\u95ee\u9898 2 \u63cf\u8ff0\u7684\u60c5\u51b5\u4e5f\u4f1a\u53d1\u751f\u3002 \u89e3\u51b3\u6b64\u7c7b\u95ee\u9898\u5462\uff0c\u8fd9\u4e2a\u5c31\u8981\u53d1\u6325\u8d1f\u8f7d\u5747\u8861\u5668\u6a21\u5757\u7684\u4f5c\u7528\u4e86\uff1a \u5728\u8d1f\u8f7d\u5747\u8861\u4e2d\u6211\u4eec\u53ef\u4ee5\u52a0\u5165\u88ab\u52a8\u5065\u5eb7\u68c0\u67e5\uff08\u8282\u70b9\u7194\u65ad\uff09\u548c\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6765\u5728\u5ba2\u6237\u7aef\u4e3b\u52a8\u5254\u9664\u5931\u6548\u7684\u8282\u70b9 \u3002 4. \u670d\u52a1\u662f\u5426\u5e94\u8be5\u5b8c\u5168\u4fe1\u4efb\u6ce8\u518c\u4e2d\u5fc3\u63a8\u9001\u7684\u6570\u636e\uff1f Service Mesh \u6570\u636e\u9762\u4e4b\u4e00 Envoy \u7684\u505a\u6cd5\uff1a \u76f8\u6bd4\u6ce8\u518c\u4e2d\u5fc3\u7684\u6570\u636e \u66f4\u4fe1\u4efb\u672c\u5730\u6570\u636e \u6240\u4ee5 Envoy \u8bbe\u8ba1\u4e86 2\u00d72 \u77e9\u9635\u6765\u51b3\u5b9a\u8282\u70b9\u662f\u5426\u5e94\u8be5\u8def\u7531\u3002 \u53ea\u6709\u5728\u5065\u5eb7\u68c0\u67e5\u5931\u8d25\u548c\u6ce8\u518c\u4e2d\u5fc3\u672a\u53d1\u73b0\u7684\u60c5\u51b5\u624d\u4f1a\u5220\u9664\u8282\u70b9\uff0c\u53ea\u8981\u5065\u5eb7\u68c0\u67e5\u6210\u529f\uff0c\u65e0\u8bba\u662f\u5426\u53d1\u73b0\u6b64\u8282\u70b9\uff0c\u90fd\u4f1a\u8def\u7531\u3002 5. \u670d\u52a1\u53d1\u5e03\u540e\uff0c\u8282\u70b9\u9891\u7e41\u53d8\u66f4\u9020\u6210 N\u00d7M \u6b21\u4e8b\u4ef6\u901a\u77e5\uff0c\u5f62\u6210\u5e7f\u64ad\u98ce\u66b4\uff0c\u8be5\u5982\u4f55\u89e3\u51b3\uff1f \u53ef\u80fd\u5bfc\u81f4\u95ee\u9898 2 \u7684\u53d1\u751f\u3002 \u5927\u91cf\u5e7f\u64ad\u4e8b\u4ef6\u7684\u53d1\u751f\uff0c\u6324\u5360\u7f51\u7edc\u5e26\u5bbd\uff0c\u751a\u81f3\u4f1a\u5bfc\u81f4\u7f51\u7edc\u5e26\u5bbd\u5360\u6ee1\uff0c\u6b64\u65f6\u6ce8\u518c\u4e2d\u5fc3\u548c\u670d\u52a1\u95f4\u7684\u5065\u5eb7\u68c0\u67e5\u6216\u4fdd\u6d3b\uff0c\u90fd\u4f1a\u56e0\u4e3a\u5e26\u5bbd\u4e0d\u8db3\u9020\u6210\u4fe1\u606f\u4e22\u5931\uff0c\u4f7f\u6ce8\u518c\u4e2d\u5fc3\u63a8\u9001\u9519\u8bef\u7684\u6570\u636e\u3002 \u5982\u4f55\u89e3\u51b3\u5462\uff1f \u5176\u5b9e\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4e8b\u4ef6\u6d88\u606f\u5408\u5e76\u63a8\u9001\u3002 \u5728 Istio \u7684 Pilot \u7684\u6a21\u5757\u4e2d\uff0c\u5b9e\u73b0\u4e86\u4e00\u79cd\u5408\u5e76\u673a\u5236\uff0c100ms \u5185\u6709\u65b0\u7684\u4e8b\u4ef6\u6d88\u606f\u65f6\uff0c\u4fbf\u4f1a\u7ee7\u7eed\u7b49\u5f85\u4e0b\u4e00\u6761\uff0c\u6700\u591a\u7b49\u5f85 1s\uff0c\u5f53\u7136\u65f6\u95f4\u7684\u53c2\u6570\u662f\u53ef\u4ee5\u914d\u7f6e\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u8bf4\u7684\u662f\u9ed8\u8ba4\u53c2\u6570\u3002 6\u3001Service Mesh \u4e2d\u7684\u6ce8\u518c\u4e2d\u5fc3 \u5b9e\u9645\u4e0a\u5728 Service Mesh \u65b9\u6848\u4e2d\uff0c\u670d\u52a1\u8282\u70b9\u53d1\u73b0\u7684\u95ee\u9898\u7528\u4f20\u7edf\u7684\u6ce8\u518c\u4e2d\u5fc3\u65b9\u6848\u4e5f\u662f\u53ef\u4ee5\u89e3\u51b3\u7684\uff0c\u4f46\u5982\u679c\u6d89\u53ca Kubernetes \u548c ECS \u8de8\u96c6\u7fa4\u8bbf\u95ee\uff0c \u6700\u597d\u8fd8\u662f\u652f\u6301 Envoy \u5b9a\u4e49\u7684 xDS \u534f\u8bae\u4e2d\u7684 EDS \u534f\u8bae \u3002 EDS\u662f endpoint discovery service \u7684\u7f29\u5199\uff0c\u65e0\u8bba\u662f Istio\uff0c\u8fd8\u662f\u6700\u65b0\u7248\u672c\u7684 gRPC\uff0c\u90fd\u5df2\u7ecf\u9ed8\u8ba4\u652f\u6301\u4e86 EDS \u534f\u8bae\uff0c\u53ef\u4ee5\u8bf4 EDS \u5b9e\u9645\u4e0a\u5df2\u7ecf\u662f\u670d\u52a1\u53d1\u73b0\u7684\u89c4\u8303\u4e86 \u3002 \u5728 Service Mesh \u65b9\u6848\u4e2d\uff0c\u56e0\u4e3a\u5927\u591a\u662f\u548c Kubernetes \u96c6\u7fa4\u7ed3\u5408\u7684\u65b9\u6848\uff0c \u6240\u4ee5\u4f60\u8981\u7279\u522b\u6ce8\u610f\u53d1\u7248\u6216\u8005\u81ea\u52a8\u6269\u7f29\u5bb9\u5f15\u8d77\u7684\u8282\u70b9 IP \u53d8\u5316\u7684\u95ee\u9898 \u3002\u8282\u70b9\u7684\u9891\u7e41\u53d8\u5316\uff0c\u5bf9\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u58ee\u6027\u63d0\u51fa\u4e86\u66f4\u9ad8\u7684\u8981\u6c42 \u9664\u4e86\u7528\u4f20\u7edf\u7684\u6ce8\u518c\u4e2d\u5fc3\u7ec4\u4ef6\u5916\uff0cKubernetes \u5185\u90e8\u7684\u53d1\u73b0\u673a\u5236\u5728 Service Mesh \u4e2d\u4e5f\u5f97\u5230\u4e86\u5e7f\u6cdb\u5e94\u7528\uff0c\u4f8b\u5982 Istio\u901a\u8fc7\u76d1\u542c Kubernetes Pod \u7684\u53d8\u5316\uff0c\u5b9e\u73b0\u670d\u52a1\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u670d\u52a1\u81ea\u8eab\u6765\u505a\u670d\u52a1\u6ce8\u518c\u4e86\u3002 7\u3001Service Mesh \u4e2d\u5b9e\u73b0\u7684\u6ce8\u518c\u53d1\u73b0\u529f\u80fd\u4f18\u52bf 7-1 \u65e0\u987b\u670d\u52a1\u81ea\u8eab\u6ce8\u518c\uff0c\u7531 sidecar \u4ee3\u7406\u6ce8\u518c sidecar \u901a\u8fc7\u63a5\u53d7\u63a7\u5236\u9762\u4e0b\u53d1\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u8fdb\u884c\u670d\u52a1\u6ce8\u518c\u3002 \u76f8\u5bf9\u4e8e\u670d\u52a1\u81ea\u8eab\u6ce8\u518c\uff0c\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11\u670d\u52a1\u81ea\u8eab\u5f00\u53d1\u7684\u5de5\u4f5c\u91cf\uff0c\u540c\u65f6\u4e5f\u5f88\u5bb9\u6613\u505a\u5230\u6ce8\u518c\u7684\u914d\u7f6e\u4fe1\u606f\u4e00\u81f4\u5316\u3002 \u6bd4\u5982\u5982\u679c\u670d\u52a1\u81ea\u5df1\u6ce8\u518c\uff0c\u5176\u5b9e\u5f88\u96be\u63a7\u5236\u670d\u52a1\u6ce8\u518c\u7684 metadata \u4fe1\u606f\uff0c\u5728 SDK \u4e2d\u5f88\u96be\u7ea6\u675f\u548c\u5347\u7ea7\uff0c\u6bd4\u5982\u8fd0\u884c\u73af\u5883\u3001\u5730\u57df\u3001\u5065\u5eb7\u68c0\u67e5\u65b9\u5f0f\u7b49\u3002 sidecar \u4ee3\u7406\u8fd8\u5e26\u6765\u4e86\u53ef\u4ee5\u968f\u65f6\u66f4\u65b0 meta \u4fe1\u606f\u7684\u597d\u5904 \u5728\u4f20\u7edf\u7684 SDK \u6a21\u5f0f\u4e2d\uff0c\u4f60\u60f3\u8981\u52a8\u6001\u8c03\u6574\u670d\u52a1\u7684\u6743\u91cd\u3001metadata \u7b49\u4fe1\u606f\u7684\u65f6\u5019\uff0c\u9700\u8981\u91cd\u65b0\u53d1\u5e03\u7248\u672c\uff0c\u6216\u8005\u4f9d\u9760\u914d\u7f6e\u4e2d\u5fc3\u7684\u80fd\u529b\uff0c\u4f46\u8fd9\u4e9b\u63a7\u5236\u4fe1\u606f\u5f80\u5f80\u6563\u843d\u5728\u5404\u4e2a\u670d\u52a1\u4e2d\uff0c\u4e0d\u65b9\u4fbf\u7ba1\u7406\uff0c\u5728 Service Mesh \u4e2d\u4f60\u53ea\u9700\u8981\u4f9d\u9760\u63a7\u5236\u9762\u7684\u80fd\u529b\uff0c\u5c31\u53ef\u4ee5\u8f7b\u677e\u505a\u5230\u4e86\u3002 7-2 \u901a\u8fc7\u63a7\u5236\u9762\u805a\u5408\u591a\u79cd\u3001\u591a\u4e2a\u6ce8\u518c\u4e2d\u5fc3\u6570\u636e \u50cf Istio \u7684 pilot \u6a21\u5757\uff0c\u5728 1.1 \u7248\u672c\u5c31\u652f\u6301\u4e86\u5355\u63a7\u5236\u9762\u591a\u96c6\u7fa4\u7684\u529f\u80fd\uff0c\u901a\u8fc7 pilot \u5c06\u591a\u4e2a\u6ce8\u518c\u4e2d\u5fc3\u7684\u6570\u636e\u805a\u5408\uff0c \u53ef\u4ee5\u6709\u6548\u964d\u4f4e\u5355\u4e00\u6ce8\u518c\u4e2d\u5fc3\u7684\u8bfb\u5199\u538b\u529b\uff0c\u4f7f\u6ce8\u518c\u4e2d\u5fc3\u66f4\u5bb9\u6613\u6c34\u5e73\u6269\u5c55 \u3002 \u6bd4\u5982\u5728\u5b9e\u8df5\u4e2d\uff0c\u6211\u5c31\u5c06\u591a\u4e2a Consul \u6570\u636e\u4e2d\u5fc3\u7684\u6570\u636e\u901a\u8fc7 pilot \u6a21\u5757\u805a\u5408\uff0c\u7136\u540e\u63d0\u4f9b xDS \u534f\u8bae\uff0c\u4f9b\u670d\u52a1\u53d1\u73b0\u4f7f\u7528\uff0c\u5b9e\u73b0\u4e86\u865a\u62df\u673a\u5230 Kubernetes \u73af\u5883\u7684\u65e0\u7f1d\u8fc1\u79fb\u3002 7-3 \u901a\u8fc7 sidecar \u63d0\u4f9b\u670d\u52a1\u6b63\u786e\u6027 check \u529f\u80fd \u9645\u4e0a\u5982\u679c\u670d\u52a1 IP \u53d1\u751f\u53d8\u5316\uff0c\u53c8\u7528\u4e86\u540c\u6837\u7684 ping \u63a5\u53e3\u65f6\uff0c\u5065\u5eb7\u68c0\u67e5\u4f1a\u51fa\u73b0\u9519\u8bef\u3002\u800c\u901a\u8fc7 sidecar \u6a21\u5f0f\uff0c \u5f53\u53d1\u73b0\u670d\u52a1 ping \u63a5\u53e3\u8fc7\u6765\u7684\u6d41\u91cf\u65f6\uff0c\u8fdb\u884c\u670d\u52a1\u540d\u79f0\u7684\u68c0\u6d4b\uff0c\u901a\u8fc7 header \u4e2d\u589e\u52a0\u670d\u52a1\u540d\u79f0\u4e0e\u672c\u5730\u670d\u52a1\u540d\u79f0\u505a\u6821\u9a8c\u7684\u65b9\u5f0f\u8fdb\u884c\u68c0\u6d4b\uff0c\u53ef\u4ee5\u6709\u6548\u907f\u514d\u8fd9\u6837\u7684\u9519\u8bef \u3002","title":"\u7b2c\u4e8c\u8282 \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3"},{"location":"chap1/2chap1_service_register/#_1","text":"\u5fae\u670d\u52a1\u5176\u4e2d\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\uff0c\u662f\u6700\u5148\u9700\u8981\u89e3\u51b3\u7684\u95ee\u9898\u3002\u7b80\u5355\u6765\u8bf4\uff0c \u670d\u52a1\u6ce8\u518c\u4e0e\u53d1\u73b0\u5c31\u662f\u4fdd\u8bc1\u5f53\u670d\u52a1\u4e0a\u4e0b\u7ebf\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u670d\u52a1\u6d88\u8d39\u8005\u548c\u670d\u52a1\u63d0\u4f9b\u8005\u80fd\u591f\u4fdd\u6301\u6b63\u5e38\u901a\u4fe1\u3002 \u800c\u5728\u5206\u5e03\u5f0f\u67b6\u6784\u4e2d\uff0c\u670d\u52a1\u4f1a\u6ce8\u518c\u5230\u6ce8\u518c\u4e2d\u5fc3\uff0c\u5f53\u670d\u52a1\u9700\u8981\u8c03\u7528\u5176\u4ed6\u670d\u52a1\u65f6\uff0c\u5c31\u5230\u8fd9\u91cc\u627e\u5230\u670d\u52a1\u7684\u5730\u5740\uff0c\u8fdb\u884c\u8c03\u7528\u3002 \u6ce8\u518c\u4e2d\u5fc3\u662f\u5fae\u670d\u52a1\u4e2d\u6700\u91cd\u8981\u7684\u5185\u5bb9\uff0c\u4e5f\u662f\u548c SOA \u67b6\u6784\u4e2d\u7684\u96c6\u4e2d\u603b\u7ebf\u901a\u4fe1\u6700\u5927\u7684\u533a\u522b\u70b9 \u3002","title":"\u7b2c\u4e8c\u8282 \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3"},{"location":"chap1/2chap1_service_register/#1","text":"\u5047\u8bbe\u5728\u5355\u4f53\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u670d\u52a1\uff0c\u8fd9\u4e2a\u670d\u52a1\u524d\u9762\u5c31\u662f\u50cf Nginx \u8fd9\u6837\u7684\u7f51\u5173\u7cfb\u7edf\uff0c\u8d1f\u8d23\u8d1f\u8f7d\u5747\u8861\uff0c\u800c\u540e\u7aef\u7684\u673a\u5668\u8282\u70b9\u4e5f\u662f\u6211\u4eec\u624b\u52a8\u914d\u7f6e\u4e0a\u53bb\u7684\uff0c\u6bd4\u5982 upstream backend { server 10.0.0.1:80; server 10.0.0.2:80; } \u5982\u679c\u673a\u5668\u4e0d\u591f\u7528\u4e86\uff0c\u589e\u52a0\u4e00\u4e2a\u8282\u70b9\uff0c\u7136\u540e reload \u4e00\u4e0b Nginx \u5c31\u597d\u4e86\u3002 \u8fd9\u6837\u7684\u914d\u7f6e\uff0c\u67b6\u6784\u8fd0\u884c\u5f97\u8fd8\u7b97\u7a33\u5b9a\uff0c\u7ef4\u62a4\u6210\u672c\u516c\u53f8\u4e5f\u8fd8\u53ef\u4ee5\u63a5\u53d7 \u3002 \u968f\u7740\u9879\u76ee\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u4fee\u6b63 Bug \u548c\u6b63\u786e\u5730\u6dfb\u52a0\u65b0\u529f\u80fd\u53d8\u5f97\u66f4\u52a0\u56f0\u96be\uff0c\u4f60\u9009\u62e9\u7ee7\u7eed\u62c6\u5206\u670d\u52a1\u3002\u6162\u6162\u5730\uff0c\u4f60\u62c6\u5206\u7684\u670d\u52a1\u6570\u91cf\u4e0a\u5347\u5230\u4e86\u4e24\u4f4d\u6570\uff0c \u4f46\u662f\u4f60\u53d1\u73b0\u6bcf\u6b21\u56e0\u4e3a\u673a\u5668\u8d1f\u8f7d\u74f6\u9888\u800c\u589e\u52a0\u673a\u5668\u65f6\uff0c\u9700\u8981\u4fee\u6539\u5f88\u591a\u4efd\u5185\u7f51\u7f51\u5173\u914d\u7f6e \uff0c \u8fd9\u65e0\u5f62\u4e2d\u53ef\u4ee5\u9884\u6599\u5230\uff0c\u4fee\u6539\u914d\u7f6e\u5e26\u6765\u7684\u7ef4\u62a4\u6210\u672c\u548c\u51fa\u9519\u7684\u6982\u7387\u90fd\u4f1a\u5448\u6307\u6570\u7ea7\u589e\u52a0\u3002 \u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u7684\u529e\u6cd5\uff1a\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u3002 \u670d\u52a1\u5728\u542f\u52a8\u65f6\uff0c\u5c06\u81ea\u5df1\u7684\u4fe1\u606f\u6ce8\u518c\u5230\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u4e2d\uff0c\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u4f1a\u5b58\u50a8\u8fd9\u4e9b\u4fe1\u606f\u3002 \u670d\u52a1\u6d88\u8d39\u8005\u53ef\u4ece\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u67e5\u8be2\u670d\u52a1\u63d0\u4f9b\u8005\u7684\u7f51\u7edc\u5730\u5740\uff0c\u5e76\u4f7f\u7528\u8be5\u5730\u5740\u8c03\u7528\u670d\u52a1\u63d0\u4f9b\u8005\u63a5\u53e3 \u3002 \u800c\u5f53\u670d\u52a1\u63d0\u4f9b\u8005\u7f51\u7edc\u5730\u5740\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u4f1a\u91cd\u65b0\u6ce8\u518c\u5230\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6 \u3002 \u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u670d\u52a1\u6d88\u8d39\u8005\u5c31\u65e0\u987b\u4eba\u5de5\u4fee\u6539\u63d0\u4f9b\u8005\u7684\u7f51\u7edc\u5730\u5740\u4e86\u3002","title":"1\u3001\u670d\u52a1\u6ce8\u518c\u53d1\u73b0"},{"location":"chap1/2chap1_service_register/#2","text":"\u5177\u4f53\u600e\u6837\u5229\u7528\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u89e3\u51b3\u591a\u4e2a\u670d\u52a1\u95f4\u7684\u901a\u4fe1\u95ee\u9898\u5462\uff1f \u89e3\u51b3\u591a\u4e2a\u670d\u52a1\u95f4\u901a\u4fe1\u95ee\u9898\u7684\u5de5\u5177\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3 \u6240\u4ee5\u6709\u4e9b\u4eba\u4e5f\u4f1a\u628a\u6ce8\u518c\u4e2d\u5fc3\u53eb\u4f5c\u540d\u5b57\u670d\u52a1\uff0c\u987e\u540d\u601d\u4e49\uff0c \u4e5f\u5c31\u662f\u901a\u8fc7 \u670d\u52a1\u540d\u67e5\u627e\u5bf9\u5e94\u7684\u670d\u52a1\u5730\u5740\u7684\u670d\u52a1\uff0c\u5728\u5206\u5e03\u5f0f\u67b6\u6784\u4e2d\uff0c\u6ce8\u518c\u4e2d\u5fc3\u627f\u63a5\u4e86\u670d\u52a1\u7684\u5730\u5740\u5f55\u5165\u548c\u67e5\u627e\u529f\u80fd","title":"2\u3001\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3"},{"location":"chap1/2chap1_service_register/#3","text":"","title":"3\u3001\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u5eb7\u68c0\u67e5\u8bbe\u8ba1"},{"location":"chap1/2chap1_service_register/#3-1","text":"\u670d\u52a1\u901a\u8fc7\u5b9a\u65f6\u53d1\u9001\u7eed\u79df\u4fe1\u606f\u5230\u6ce8\u518c\u4e2d\u5fc3\uff0c\u4ee5\u8868\u660e\u81ea\u5df1\u8282\u70b9\u7684\u5b58\u6d3b \u3002 \u4e3b\u52a8\u63a2\u6d3b\u7684\u65b9\u5f0f\u5176\u5b9e\u662f\u6211\u4eec\u5728\u4f7f\u7528\u6ce8\u518c\u4e2d\u5fc3\u65f6\u7528\u5f97\u6700\u591a\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c \u5982\u679c\u4f60\u7684\u670d\u52a1\u96c6\u7fa4\u89c4\u6a21\u4e0d\u5927\uff0c\u6216\u8005\u9009\u7528\u4e86\u7c7b\u4f3c Eureka \u8fd9\u6837\u7684\u6700\u7ec8\u4e00\u81f4\u6027\u7684\u6ce8\u518c\u4e2d\u5fc3\uff0c\u670d\u52a1\u4e3b\u52a8\u63a2\u6d3b\u7edd\u5bf9\u662f\u4f60\u7684\u6700\u4f18\u7684\u9009\u62e9 \u8fd9\u79cd\u65b9\u5f0f\u6700\u5927\u7a0b\u5ea6\u907f\u514d\u4e86\u5728Kubernetes\u73af\u5883\u4e2d\uff0c\u56e0\u4e3a IP \u91cd\u7528\u5bfc\u81f4\u8282\u70b9\u5728\u65e7\u7684\u670d\u52a1\u4e0a\u4f9d\u7136\u5b58\u6d3b\u7684\u95ee\u9898\uff0c\u6bd5\u7adf\u7eed\u79df\u4fe1\u606f\u90fd\u662f\u5e26\u7740\u670d\u52a1\u4fe1\u606f\u4e0a\u62a5\u5230\u6ce8\u518c\u4e2d\u5fc3\u7684\u3002 \u4e3b\u52a8\u63a2\u6d3b\u7684\u6700\u5927\u95ee\u9898\uff1a \u9020\u6210\u6ce8\u518c\u4e2d\u5fc3\u7684\u5199\u64cd\u4f5c\u53d8\u591a \u5728\u670d\u52a1\u53d1\u5e03\u65f6\uff0c\u8282\u70b9\u4f1a\u4ea7\u751f\u6bd4\u8f83\u5927\u7684\u53d8\u52a8\uff0c\u6ce8\u518c\u4e2d\u5fc3\u7684\u5199\u538b\u529b\u4e5f\u5c31\u4f1a\u53d8\u5927\u3002 \u800c\u4e14\u5f3a\u4e00\u81f4\u6027\u7684\u6ce8\u518c\u4e2d\u5fc3\uff0c\u8282\u70b9\u53d8\u5316\u4e00\u5b9a\u8981\u4e3b\u8282\u70b9\u786e\u8ba4\uff0c\u5982\u679c\u6ca1\u6709\u505a\u6ce8\u518c\u4e2d\u5fc3\u7684\u8bfb\u5199\u5206\u79bb\uff0c\u5c31\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u901a\u77e5\u4e8b\u4ef6\uff0c\u5bf9\u5e26\u5bbd\u3001CPU \u6765\u8bf4\u90fd\u662f\u707e\u96be\u6027\u7684\u95ee\u9898\uff0c\u8fd9\u4e2a\u65f6\u5019\u6ce8\u518c\u4e2d\u5fc3\u5df2\u7ecf\u5b8c\u5168\u6ca1\u6709\u529e\u6cd5\u54cd\u5e94 TTL \u7684\u79df\u7ea6\u8bf7\u6c42\uff0c\u4e5f\u4f1a\u5bfc\u81f4\u5927\u91cf\u7684\u8282\u70b9\u5931\u6548 \u4e3b\u52a8\u79df\u7ea6\uff0c\u5176\u5b9e\u5e76\u4e0d\u8db3\u4ee5\u8bf4\u660e\u670d\u52a1\u662f\u5065\u5eb7\u7684\uff0c\u6bd5\u7adf\u6709\u4e9b\u60c5\u51b5\u4e0b\uff0c\u670d\u52a1\u867d\u7136\u65e0\u6cd5\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u4e86\uff0c\u4f46\u8fd8\u662f\u53ef\u4ee5\u5bf9\u5916\u53d1\u9001\u79df\u7ea6\u8bf7\u6c42\u7684\u3002","title":"3-1 \u670d\u52a1\u4e3b\u52a8\u63a2\u6d3b"},{"location":"chap1/2chap1_service_register/#3-2","text":"\u670d\u52a1\u5728\u8fdb\u884c\u670d\u52a1\u6ce8\u518c\u65f6\uff0c\u5411\u6ce8\u518c\u4e2d\u5fc3\u8868\u660e\u81ea\u5df1\u7684\u5065\u5eb7\u68c0\u67e5\u63a5\u53e3\uff0c\u6bd4\u5982 /ping \u6216\u8005 TCP \u7aef\u53e3\uff0c\u6ce8\u518c\u4e2d\u5fc3\u901a\u8fc7\u5b9a\u65f6\u8bbf\u95ee\u7684\u65b9\u5f0f\uff0c\u63a2\u660e\u8282\u70b9\u662f\u5426\u5b58\u6d3b\u3002 \u7b2c\u4e8c\u79cd\u65b9\u6848\u5728 \u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u89e3\u51b3\u4e86\u670d\u52a1\u4e3b\u52a8\u63a2\u6d3b\u5e76\u4e0d\u80fd\u8bf4\u660e\u670d\u52a1\u5065\u5eb7\u7684\u95ee\u9898 \uff0c\u6bd5\u7adf\u901a\u8fc7 /ping \u8fd9\u79cd\u5065\u5eb7\u68c0\u67e5\u63a5\u53e3\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53ef\u4ee5\u8bf4\u660e\u670d\u52a1\u7684\u5065\u5eb7\u5ea6\u3002\u5728Kubernetes\u73af\u5883\u4e2d\uff0c\u4e5f\u662f\u901a\u8fc7\u5bf9 Pod \u8fdb\u884c\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6765\u5224\u5b9a Pod \u7684\u5065\u5eb7\u5ea6\u7684\u3002 \u4f46\u8fd9\u4e2a\u65b9\u6848\u4e5f\u6709\u4e00\u4e9b\u95ee\u9898\uff1a \u6bd4\u5982\u4e0a\u9762\u63d0\u5230\u7684 IP \u91cd\u7528\u95ee\u9898\uff0c\u5982\u679c\u4e24\u4e2a\u670d\u52a1\u90fd\u7528\u4e86 /ping \u63a5\u53e3\u505a\u5065\u5eb7\u68c0\u67e5\uff0c\u5e76\u4e14\u7aef\u53e3\u4e00\u81f4\uff0c\u5c31\u5f88\u5bb9\u6613\u53d1\u751f\u8282\u70b9\u5728\u65e7\u670d\u52a1\u88ab\u91cd\u65b0\u6fc0\u6d3b\u7684\u95ee\u9898\u3002\u5f53\u7136\u4e5f\u6709\u76f8\u5e94\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u5c31\u662f\u53c2\u8003 Envoy \u505a\u670d\u52a1\u540d\u79f0\u7684 check \u3002","title":"3-2 \u6ce8\u518c\u4e2d\u5fc3\u4e3b\u52a8\u53d1\u8d77\u5065\u5eb7\u68c0\u67e5"},{"location":"chap1/2chap1_service_register/#3-3","text":"\u6ce8\u518c\u4e2d\u5fc3\u4e0d\u8fdb\u884c\u4efb\u4f55\u63a2\u6d3b\u673a\u5236\uff0c\u5168\u90e8\u7531\u8c03\u7528\u65b9\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u4e3b\u52a8\u548c\u88ab\u52a8\u63a2\u6d3b\u3002 \u7b2c\u4e09\u79cd\u65b9\u6848\u5c31\u6bd4\u8f83\u6781\u7aef\u4e86\uff0c\u4e0d\u505a\u4efb\u4f55\u5065\u5eb7\u68c0\u67e5\uff0c\u5b8c\u5168\u9760\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u80fd\u529b\u3002 \u8fd9\u79cd\u65b9\u5f0f\u4e5f\u662f\u6709\u5e94\u7528\u573a\u666f\u7684\uff0c\u5982\u679c\u4f7f\u7528\u4e86 gRPC \u8fd9\u6837\u6bd4\u8f83\u5b8c\u5584\u7684 RPC \u5e93\uff0c\u4e00\u822c\u90fd\u6709\u81ea\u52a8\u6458\u9664\u8282\u70b9\u7684\u80fd\u529b\u3002\u4f46\u6211\u4eec\u4e5f\u8981\u8003\u8651\u5230\u8fd9\u4e2a\u65b9\u6848\u7684\u4e0d\u8db3\uff0c\u5982\u679c IP \u88ab\u91cd\u7528\uff0c\u8282\u70b9\u5f88\u5927\u6982\u7387\u4f1a\u4e00\u76f4\u5b58\u5728\u5728\u65e7\u670d\u52a1\u4e2d\uff0c\u8fd9\u6837\u7684\u810f\u6570\u636e\u968f\u65f6\u90fd\u662f\u98ce\u9669\u70b9\u3002 \u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u7ed3\u5408\u524d\u9762\u4e24\u4e2a\u65b9\u6848\uff0c\u4f18\u5316\u6b64\u65b9\u6848\u3002 \u4f60\u53ef\u4ee5\u5728\u505a\u5065\u5eb7\u68c0\u67e5\u7684\u540c\u65f6\uff0c\u6ce8\u518c\u4e2d\u5fc3\u4e0b\u53d1\u5305\u542b\u5065\u5eb7\u8282\u70b9\u548c\u975e\u5065\u5eb7\u8282\u70b9\u7684\u6570\u636e\u5230\u670d\u52a1\u8282\u70b9\uff0c\u5e76\u9488\u5bf9\u5065\u5eb7\u68c0\u67e5\u672a\u901a\u8fc7\u7684\u5220\u9664\u8282\u70b9\u8bbe\u7f6e\u4e00\u4e2a\u8f83\u957f\u7684\u8fc7\u671f\u65f6\u95f4\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u89e3\u51b3 IP \u91cd\u7528\u4ea7\u751f\u810f\u6570\u636e\u7684\u95ee\u9898\u4e86\u3002","title":"3-3 \u6ce8\u518c\u4e2d\u5fc3\u4e0d\u8fdb\u884c\u4efb\u4f55\u5065\u5eb7\u68c0\u67e5\uff0c\u7531\u8c03\u7528\u65b9\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5"},{"location":"chap1/2chap1_service_register/#4","text":"\u6211\u6765\u7b80\u5355\u89e3\u91ca\u4e00\u4e0b CAP \u7406\u8bba\uff0c\u4e00\u81f4\u6027\uff08Consistency\uff09\u3001\u53ef\u7528\u6027\uff08Availability\uff09\u3001\u5206\u533a\u5bb9\u9519\u6027\uff08Partition tolerance\uff09\uff0cCAP \u4e0d\u53ef\u80fd\u90fd\u53d6\uff0c\u53ea\u80fd\u53d6\u5176\u4e2d2\u4e2a\u3002 \u6240\u4ee5\u5728\u9009\u578b\u7684\u65f6\u5019\uff0c\u4f18\u5148\u9009\u62e9 AP \u7684\u7cfb\u7edf\u3002\u5982\u679c\u6280\u672f\u6808\u662f Go \uff0c\u4f46\u53c8\u62c5\u5fc3 Java \u7684\u7ec4\u4ef6\u4e0d\u597d\u7ef4\u62a4\uff0c\u4f60\u4e5f\u53ef\u4ee5\u8003\u8651\u81ea\u7814\u6ce8\u518c\u4e2d\u5fc3\uff0c\u5f53\u7136 CP \u7684\u6ce8\u518c\u4e2d\u5fc3\u5e76\u975e\u4e0d\u53ef\u7528\uff0c\u5728\u670d\u52a1\u96c6\u7fa4\u89c4\u6a21\u6bd4\u8f83\u5c0f\u7684\u60c5\u51b5\u4e0b\uff0c\u4e5f\u662f\u53ef\u4ee5\u9009\u62e9\u7684\u3002","title":"4\u3001\u6ce8\u518c\u4e2d\u5fc3\u9009\u578b"},{"location":"chap1/2chap1_service_register/#5","text":"","title":"5\u3001\u642d\u5efa\u4e00\u4e2a\u9ad8\u53ef\u7528\u3001\u5065\u58ee\u7684\u6ce8\u518c\u4e2d\u5fc3"},{"location":"chap1/2chap1_service_register/#5-1","text":"\u6ce8\u518c\u4e2d\u5fc3\u5b8c\u5168\u6545\u969c\u4e86\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f \u6ce8\u518c\u4e2d\u5fc3\u56e0\u4e3a\u9ad8\u8d1f\u8f7d\uff0c\u63a8\u9001\u4e86\u5f02\u5e38\u7684\u6570\u636e\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f \u65b0\u52a0\u5165\u7684\u673a\u5668\uff0c\u51fa\u73b0\u4e86\u7f51\u7edc\u8fde\u901a\u6027\u95ee\u9898\uff08\u6ce8\u518c\u4e2d\u5fc3\u548c\u673a\u5668\u7f51\u7edc\u6b63\u5e38\uff0c\u4f46\u670d\u52a1\u673a\u5668\u4e4b\u95f4\u7f51\u7edc\u5f02\u5e38\uff09\uff0c\u5e94\u8be5\u600e\u6837\u5e94\u5bf9\uff1f \u670d\u52a1\u662f\u5426\u5e94\u8be5\u5b8c\u5168\u4fe1\u4efb\u6ce8\u518c\u4e2d\u5fc3\u63a8\u9001\u7684\u6570\u636e\uff1f \u670d\u52a1\u53d1\u5e03\u540e\uff0c\u8282\u9891\u7e41\u53d8\u66f4\u9020\u6210 N\u00d7M \u6b21\u4e8b\u4ef6\u901a\u77e5\uff0c\u5f62\u6210\u5e7f\u64ad\u98ce\u66b4\uff0c\u8be5\u5982\u4f55\u89e3\u51b3\uff1f \u7b2c\u4e09\u65b9\u57fa\u7840\u8bbe\u65bd\uff0c\u6bd4\u5982 MySQL \u3001Redis \uff0c\u8fd9\u79cd\u6570\u636e\u5c42\u7684\u4e2d\u95f4\u4ef6\uff0c\u6211\u4eec\u80af\u5b9a\u662f\u8981\u5b8c\u5168\u4fe1\u4efb\u5176\u4e2d\u7684\u6570\u636e\u7684\u3002\u4f46\u5bf9\u4e8e\u6ce8\u518c\u4e2d\u5fc3\uff0c\u4fe1\u4efb\u63a8\u9001\u6570\u636e\u7684\u98ce\u9669\u975e\u5e38\u5927\u3002 1. \u6ce8\u518c\u4e2d\u5fc3\u5b8c\u5168\u6545\u969c\u4e86\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f \u6240\u4ee5\u53ea\u8981\u5728\u8fdb\u7a0b\u4e2d\u7f13\u5b58\u670d\u52a1\u7684\u8282\u70b9\uff0c\u5f71\u54cd\u9762\u5c31\u53ef\u63a7\u3002 \u5f53\u6ce8\u518c\u4e2d\u5fc3\u5b8c\u5168\u6545\u969c\u7684\u65f6\u5019\uff0c\u670d\u52a1\u6ce8\u518c\u529f\u80fd\u662f\u5931\u6548\u7684\uff0c\u6b64\u65f6\u7684\u6269\u5bb9\u64cd\u4f5c\u65e0\u6cd5\u8fdb\u884c \u3002 \u5982\u679c\u5728\u5bb9\u5668\u4e2d\uff0c\u56e0\u4e3a Pod \u6eda\u52a8\u5347\u7ea7\u7684\u539f\u56e0\u9020\u6210\u4f1a\u5148\u542f\u52a8\u65b0\u7684 Pod\uff0c\u4e00\u5b9a\u8981\u5728\u7a0b\u5e8f\u542f\u52a8\u6ce8\u518c\u5931\u8d25\u65f6\u629b\u51fa\u5f02\u5e38\uff0c\u4f7f\u7a0b\u5e8f\u65e0\u6cd5\u542f\u52a8\uff0c\u5426\u5219\u5bb9\u5668 IP \u7684\u53d8\u5316\u4e5f\u4f1a\u5bfc\u81f4\u670d\u52a1\u7684\u8bbf\u95ee\u5f02\u5e38\u3002 2. \u6ce8\u518c\u4e2d\u5fc3\u56e0\u4e3a\u9ad8\u8d1f\u8f7d\uff0c\u63a8\u9001\u4e86\u5f02\u5e38\u7684\u6570\u636e\uff0c\u670d\u52a1\u662f\u5426\u8fd8\u80fd\u6b63\u5e38\u8bbf\u95ee\uff1f \u4f46\u968f\u7740\u5fae\u670d\u52a1\u89c4\u6a21\u7684\u589e\u5927\uff0c\u6ce8\u518c\u4e2d\u5fc3\u5f88\u6709\u53ef\u80fd\u9047\u5230\u74f6\u9888\u3002\u4e00\u65e6\u51fa\u73b0\u9ad8\u8d1f\u8f7d\uff0c\u4f1a\u4f7f\u670d\u52a1\u548c\u6ce8\u518c\u4e2d\u5fc3\u4e4b\u95f4\u7684\u5065\u5eb7\u68c0\u67e5\u6216\u4fdd\u6d3b\u51fa\u73b0\u95ee\u9898\uff0c\u6ce8\u518c\u4e2d\u5fc3\u4f7f\u8282\u70b9\u5f02\u5e38\u4e0b\u7ebf\uff0c\u53ea\u63a8\u9001\u90e8\u5206\u8282\u70b9\u6570\u636e\u5230\u8ba2\u9605\u7684\u670d\u52a1\u3002 \u8fd9\u4e2a\u95ee\u9898\u770b\u4f3c\u4e0d\u4e25\u91cd\uff0c\u4f46\u4e00\u65e6\u63a8\u9001\u4e86\u8fc7\u5c11\u7684\u8282\u70b9\u5230\u670d\u52a1\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u8c03\u670d\u52a1\u6253\u6302\u88ab\u8c03\u670d\u52a1\uff0c\u957f\u65f6\u95f4\u4e0d\u80fd\u6062\u590d\uff0c\u751a\u81f3\u4f1a\u5bfc\u81f4\u6574\u4e2a\u5fae\u670d\u52a1\u96c6\u7fa4\u96ea\u5d29\u3002 \u89e3\u51b3\u6b64\u7c7b\u95ee\u9898\uff0c \u6211\u4eec\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u7684\u670d\u52a1\u53d1\u73b0 SDK \u4e2d\u52a0\u5165\u81ea\u6211\u4fdd\u62a4\u673a\u5236 \uff1a \u4e00\u65e6\u670d\u52a1\u7684\u8282\u70b9\u6570\u91cf\u4e0b\u964d\u8d85\u8fc7\u4e00\u5b9a\u9608\u503c\uff0c\u5c31\u8fdb\u5165\u81ea\u6211\u4fdd\u62a4\u72b6\u6001\uff0c\u653e\u5f03\u4f7f\u7528\u65b0\u63a8\u9001\u8fc7\u6765\u7684\u670d\u52a1\u6ce8\u518c\u4fe1\u606f \u3002 3. \u65b0\u52a0\u5165\u7684\u673a\u5668\uff0c\u51fa\u73b0\u4e86\u7f51\u7edc\u8fde\u901a\u6027\u95ee\u9898\uff08\u6ce8\u518c\u4e2d\u5fc3\u548c\u673a\u5668\u7f51\u7edc\u6b63\u5e38\uff0c\u4f46\u670d\u52a1\u673a\u5668\u4e4b\u95f4\u7f51\u7edc\u5f02\u5e38\uff09\uff0c\u5e94\u8be5\u600e\u6837\u5e94\u5bf9\uff1f \u5b9e\u9645\u4e0a\u7f51\u7edc\u8fde\u901a\u6027\u95ee\u9898\u662f\u6bd4\u8f83\u5bb9\u6613\u53d1\u751f\u7684\uff0c\u5f80\u5f80\u51fa\u4e8e\u5b89\u5168\u8003\u8651\uff0c\u5404\u4e2a\u90e8\u95e8\u4e4b\u95f4\u53ef\u80fd\u4f1a\u5904\u5728\u4e0d\u540c\u7684 VPC \uff0c\u4f46\u73b0\u5b9e\u4e2d\u53c8\u6709\u4e92\u76f8\u8bbf\u95ee\u7684\u60c5\u51b5\uff0c \u4e00\u65e6\u7f51\u7edc\u89c4\u5219\u7ef4\u62a4\u4e0d\u597d\uff0c\u5f88\u5bb9\u6613\u51fa\u73b0\u65b0\u6dfb\u52a0\u7684\u673a\u5668\u6ce8\u518c\u4e2d\u5fc3\u7684\u7f51\u6bb5\u53ef\u4ee5\u8bbf\u95ee\uff0c\u4f46\u662f\u670d\u52a1\u4e4b\u95f4\u5374\u65e0\u6cd5\u8bbf\u95ee\u7684\u60c5\u51b5 \u3002 \u5728\u6ce8\u518c\u4e2d\u5fc3\u7684\u4f7f\u7528\u573a\u666f\u4e2d\uff0c\u7f51\u7edc\u6545\u969c\u662f\u6211\u4eec\u6700\u4f18\u5148\u8003\u8651\u7684\u95ee\u9898\uff0c\u5982\u679c\u53d1\u751f\u4e86\u5206\u533a\u6545\u969c\uff0c\u95ee\u9898 2 \u63cf\u8ff0\u7684\u60c5\u51b5\u4e5f\u4f1a\u53d1\u751f\u3002 \u89e3\u51b3\u6b64\u7c7b\u95ee\u9898\u5462\uff0c\u8fd9\u4e2a\u5c31\u8981\u53d1\u6325\u8d1f\u8f7d\u5747\u8861\u5668\u6a21\u5757\u7684\u4f5c\u7528\u4e86\uff1a \u5728\u8d1f\u8f7d\u5747\u8861\u4e2d\u6211\u4eec\u53ef\u4ee5\u52a0\u5165\u88ab\u52a8\u5065\u5eb7\u68c0\u67e5\uff08\u8282\u70b9\u7194\u65ad\uff09\u548c\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6765\u5728\u5ba2\u6237\u7aef\u4e3b\u52a8\u5254\u9664\u5931\u6548\u7684\u8282\u70b9 \u3002 4. \u670d\u52a1\u662f\u5426\u5e94\u8be5\u5b8c\u5168\u4fe1\u4efb\u6ce8\u518c\u4e2d\u5fc3\u63a8\u9001\u7684\u6570\u636e\uff1f Service Mesh \u6570\u636e\u9762\u4e4b\u4e00 Envoy \u7684\u505a\u6cd5\uff1a \u76f8\u6bd4\u6ce8\u518c\u4e2d\u5fc3\u7684\u6570\u636e \u66f4\u4fe1\u4efb\u672c\u5730\u6570\u636e \u6240\u4ee5 Envoy \u8bbe\u8ba1\u4e86 2\u00d72 \u77e9\u9635\u6765\u51b3\u5b9a\u8282\u70b9\u662f\u5426\u5e94\u8be5\u8def\u7531\u3002 \u53ea\u6709\u5728\u5065\u5eb7\u68c0\u67e5\u5931\u8d25\u548c\u6ce8\u518c\u4e2d\u5fc3\u672a\u53d1\u73b0\u7684\u60c5\u51b5\u624d\u4f1a\u5220\u9664\u8282\u70b9\uff0c\u53ea\u8981\u5065\u5eb7\u68c0\u67e5\u6210\u529f\uff0c\u65e0\u8bba\u662f\u5426\u53d1\u73b0\u6b64\u8282\u70b9\uff0c\u90fd\u4f1a\u8def\u7531\u3002 5. \u670d\u52a1\u53d1\u5e03\u540e\uff0c\u8282\u70b9\u9891\u7e41\u53d8\u66f4\u9020\u6210 N\u00d7M \u6b21\u4e8b\u4ef6\u901a\u77e5\uff0c\u5f62\u6210\u5e7f\u64ad\u98ce\u66b4\uff0c\u8be5\u5982\u4f55\u89e3\u51b3\uff1f \u53ef\u80fd\u5bfc\u81f4\u95ee\u9898 2 \u7684\u53d1\u751f\u3002 \u5927\u91cf\u5e7f\u64ad\u4e8b\u4ef6\u7684\u53d1\u751f\uff0c\u6324\u5360\u7f51\u7edc\u5e26\u5bbd\uff0c\u751a\u81f3\u4f1a\u5bfc\u81f4\u7f51\u7edc\u5e26\u5bbd\u5360\u6ee1\uff0c\u6b64\u65f6\u6ce8\u518c\u4e2d\u5fc3\u548c\u670d\u52a1\u95f4\u7684\u5065\u5eb7\u68c0\u67e5\u6216\u4fdd\u6d3b\uff0c\u90fd\u4f1a\u56e0\u4e3a\u5e26\u5bbd\u4e0d\u8db3\u9020\u6210\u4fe1\u606f\u4e22\u5931\uff0c\u4f7f\u6ce8\u518c\u4e2d\u5fc3\u63a8\u9001\u9519\u8bef\u7684\u6570\u636e\u3002 \u5982\u4f55\u89e3\u51b3\u5462\uff1f \u5176\u5b9e\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4e8b\u4ef6\u6d88\u606f\u5408\u5e76\u63a8\u9001\u3002 \u5728 Istio \u7684 Pilot \u7684\u6a21\u5757\u4e2d\uff0c\u5b9e\u73b0\u4e86\u4e00\u79cd\u5408\u5e76\u673a\u5236\uff0c100ms \u5185\u6709\u65b0\u7684\u4e8b\u4ef6\u6d88\u606f\u65f6\uff0c\u4fbf\u4f1a\u7ee7\u7eed\u7b49\u5f85\u4e0b\u4e00\u6761\uff0c\u6700\u591a\u7b49\u5f85 1s\uff0c\u5f53\u7136\u65f6\u95f4\u7684\u53c2\u6570\u662f\u53ef\u4ee5\u914d\u7f6e\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u8bf4\u7684\u662f\u9ed8\u8ba4\u53c2\u6570\u3002","title":"5-1 \u5728\u5f15\u5165\u6ce8\u518c\u4e2d\u5fc3\u53ef\u80fd\u4f1a\u9047\u7684\u95ee\u9898"},{"location":"chap1/2chap1_service_register/#6service-mesh","text":"\u5b9e\u9645\u4e0a\u5728 Service Mesh \u65b9\u6848\u4e2d\uff0c\u670d\u52a1\u8282\u70b9\u53d1\u73b0\u7684\u95ee\u9898\u7528\u4f20\u7edf\u7684\u6ce8\u518c\u4e2d\u5fc3\u65b9\u6848\u4e5f\u662f\u53ef\u4ee5\u89e3\u51b3\u7684\uff0c\u4f46\u5982\u679c\u6d89\u53ca Kubernetes \u548c ECS \u8de8\u96c6\u7fa4\u8bbf\u95ee\uff0c \u6700\u597d\u8fd8\u662f\u652f\u6301 Envoy \u5b9a\u4e49\u7684 xDS \u534f\u8bae\u4e2d\u7684 EDS \u534f\u8bae \u3002 EDS\u662f endpoint discovery service \u7684\u7f29\u5199\uff0c\u65e0\u8bba\u662f Istio\uff0c\u8fd8\u662f\u6700\u65b0\u7248\u672c\u7684 gRPC\uff0c\u90fd\u5df2\u7ecf\u9ed8\u8ba4\u652f\u6301\u4e86 EDS \u534f\u8bae\uff0c\u53ef\u4ee5\u8bf4 EDS \u5b9e\u9645\u4e0a\u5df2\u7ecf\u662f\u670d\u52a1\u53d1\u73b0\u7684\u89c4\u8303\u4e86 \u3002 \u5728 Service Mesh \u65b9\u6848\u4e2d\uff0c\u56e0\u4e3a\u5927\u591a\u662f\u548c Kubernetes \u96c6\u7fa4\u7ed3\u5408\u7684\u65b9\u6848\uff0c \u6240\u4ee5\u4f60\u8981\u7279\u522b\u6ce8\u610f\u53d1\u7248\u6216\u8005\u81ea\u52a8\u6269\u7f29\u5bb9\u5f15\u8d77\u7684\u8282\u70b9 IP \u53d8\u5316\u7684\u95ee\u9898 \u3002\u8282\u70b9\u7684\u9891\u7e41\u53d8\u5316\uff0c\u5bf9\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u58ee\u6027\u63d0\u51fa\u4e86\u66f4\u9ad8\u7684\u8981\u6c42 \u9664\u4e86\u7528\u4f20\u7edf\u7684\u6ce8\u518c\u4e2d\u5fc3\u7ec4\u4ef6\u5916\uff0cKubernetes \u5185\u90e8\u7684\u53d1\u73b0\u673a\u5236\u5728 Service Mesh \u4e2d\u4e5f\u5f97\u5230\u4e86\u5e7f\u6cdb\u5e94\u7528\uff0c\u4f8b\u5982 Istio\u901a\u8fc7\u76d1\u542c Kubernetes Pod \u7684\u53d8\u5316\uff0c\u5b9e\u73b0\u670d\u52a1\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u670d\u52a1\u81ea\u8eab\u6765\u505a\u670d\u52a1\u6ce8\u518c\u4e86\u3002","title":"6\u3001Service Mesh \u4e2d\u7684\u6ce8\u518c\u4e2d\u5fc3"},{"location":"chap1/2chap1_service_register/#7service-mesh","text":"","title":"7\u3001Service Mesh \u4e2d\u5b9e\u73b0\u7684\u6ce8\u518c\u53d1\u73b0\u529f\u80fd\u4f18\u52bf"},{"location":"chap1/2chap1_service_register/#7-1-sidecar","text":"sidecar \u901a\u8fc7\u63a5\u53d7\u63a7\u5236\u9762\u4e0b\u53d1\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u8fdb\u884c\u670d\u52a1\u6ce8\u518c\u3002 \u76f8\u5bf9\u4e8e\u670d\u52a1\u81ea\u8eab\u6ce8\u518c\uff0c\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11\u670d\u52a1\u81ea\u8eab\u5f00\u53d1\u7684\u5de5\u4f5c\u91cf\uff0c\u540c\u65f6\u4e5f\u5f88\u5bb9\u6613\u505a\u5230\u6ce8\u518c\u7684\u914d\u7f6e\u4fe1\u606f\u4e00\u81f4\u5316\u3002 \u6bd4\u5982\u5982\u679c\u670d\u52a1\u81ea\u5df1\u6ce8\u518c\uff0c\u5176\u5b9e\u5f88\u96be\u63a7\u5236\u670d\u52a1\u6ce8\u518c\u7684 metadata \u4fe1\u606f\uff0c\u5728 SDK \u4e2d\u5f88\u96be\u7ea6\u675f\u548c\u5347\u7ea7\uff0c\u6bd4\u5982\u8fd0\u884c\u73af\u5883\u3001\u5730\u57df\u3001\u5065\u5eb7\u68c0\u67e5\u65b9\u5f0f\u7b49\u3002 sidecar \u4ee3\u7406\u8fd8\u5e26\u6765\u4e86\u53ef\u4ee5\u968f\u65f6\u66f4\u65b0 meta \u4fe1\u606f\u7684\u597d\u5904 \u5728\u4f20\u7edf\u7684 SDK \u6a21\u5f0f\u4e2d\uff0c\u4f60\u60f3\u8981\u52a8\u6001\u8c03\u6574\u670d\u52a1\u7684\u6743\u91cd\u3001metadata \u7b49\u4fe1\u606f\u7684\u65f6\u5019\uff0c\u9700\u8981\u91cd\u65b0\u53d1\u5e03\u7248\u672c\uff0c\u6216\u8005\u4f9d\u9760\u914d\u7f6e\u4e2d\u5fc3\u7684\u80fd\u529b\uff0c\u4f46\u8fd9\u4e9b\u63a7\u5236\u4fe1\u606f\u5f80\u5f80\u6563\u843d\u5728\u5404\u4e2a\u670d\u52a1\u4e2d\uff0c\u4e0d\u65b9\u4fbf\u7ba1\u7406\uff0c\u5728 Service Mesh \u4e2d\u4f60\u53ea\u9700\u8981\u4f9d\u9760\u63a7\u5236\u9762\u7684\u80fd\u529b\uff0c\u5c31\u53ef\u4ee5\u8f7b\u677e\u505a\u5230\u4e86\u3002","title":"7-1 \u65e0\u987b\u670d\u52a1\u81ea\u8eab\u6ce8\u518c\uff0c\u7531 sidecar \u4ee3\u7406\u6ce8\u518c"},{"location":"chap1/2chap1_service_register/#7-2","text":"\u50cf Istio \u7684 pilot \u6a21\u5757\uff0c\u5728 1.1 \u7248\u672c\u5c31\u652f\u6301\u4e86\u5355\u63a7\u5236\u9762\u591a\u96c6\u7fa4\u7684\u529f\u80fd\uff0c\u901a\u8fc7 pilot \u5c06\u591a\u4e2a\u6ce8\u518c\u4e2d\u5fc3\u7684\u6570\u636e\u805a\u5408\uff0c \u53ef\u4ee5\u6709\u6548\u964d\u4f4e\u5355\u4e00\u6ce8\u518c\u4e2d\u5fc3\u7684\u8bfb\u5199\u538b\u529b\uff0c\u4f7f\u6ce8\u518c\u4e2d\u5fc3\u66f4\u5bb9\u6613\u6c34\u5e73\u6269\u5c55 \u3002 \u6bd4\u5982\u5728\u5b9e\u8df5\u4e2d\uff0c\u6211\u5c31\u5c06\u591a\u4e2a Consul \u6570\u636e\u4e2d\u5fc3\u7684\u6570\u636e\u901a\u8fc7 pilot \u6a21\u5757\u805a\u5408\uff0c\u7136\u540e\u63d0\u4f9b xDS \u534f\u8bae\uff0c\u4f9b\u670d\u52a1\u53d1\u73b0\u4f7f\u7528\uff0c\u5b9e\u73b0\u4e86\u865a\u62df\u673a\u5230 Kubernetes \u73af\u5883\u7684\u65e0\u7f1d\u8fc1\u79fb\u3002","title":"7-2 \u901a\u8fc7\u63a7\u5236\u9762\u805a\u5408\u591a\u79cd\u3001\u591a\u4e2a\u6ce8\u518c\u4e2d\u5fc3\u6570\u636e"},{"location":"chap1/2chap1_service_register/#7-3-sidecar-check","text":"\u9645\u4e0a\u5982\u679c\u670d\u52a1 IP \u53d1\u751f\u53d8\u5316\uff0c\u53c8\u7528\u4e86\u540c\u6837\u7684 ping \u63a5\u53e3\u65f6\uff0c\u5065\u5eb7\u68c0\u67e5\u4f1a\u51fa\u73b0\u9519\u8bef\u3002\u800c\u901a\u8fc7 sidecar \u6a21\u5f0f\uff0c \u5f53\u53d1\u73b0\u670d\u52a1 ping \u63a5\u53e3\u8fc7\u6765\u7684\u6d41\u91cf\u65f6\uff0c\u8fdb\u884c\u670d\u52a1\u540d\u79f0\u7684\u68c0\u6d4b\uff0c\u901a\u8fc7 header \u4e2d\u589e\u52a0\u670d\u52a1\u540d\u79f0\u4e0e\u672c\u5730\u670d\u52a1\u540d\u79f0\u505a\u6821\u9a8c\u7684\u65b9\u5f0f\u8fdb\u884c\u68c0\u6d4b\uff0c\u53ef\u4ee5\u6709\u6548\u907f\u514d\u8fd9\u6837\u7684\u9519\u8bef \u3002","title":"7-3 \u901a\u8fc7 sidecar \u63d0\u4f9b\u670d\u52a1\u6b63\u786e\u6027 check \u529f\u80fd"},{"location":"chap1/3chap1_load_balancer/","text":"\u7b2c\u4e09\u8282 \u8d1f\u8f7d\u5747\u8861\u5668 1\u3001\u670d\u52a1\u53d1\u73b0\u540e\u5982\u4f55\u5b9e\u73b0\u8282\u70b9\u4fdd\u62a4 1-1 \u670d\u52a1\u53d1\u73b0\u540e\u5982\u4f55\u5b9e\u73b0\u8282\u70b9\u4fdd\u62a4 \u8d1f\u8f7d\u5747\u8861\uff08Load Balance\uff09\uff0c\u662f\u4e00\u79cd\u7f51\u7edc\u6d41\u91cf\u5206\u914d\u6280\u672f\uff0c\u7528\u4e8e\u89e3\u51b3\u5355\u53f0\u673a\u5668\u6027\u80fd\u51fa\u73b0\u74f6\u9888\u65f6\uff0c\u9700\u8981\u591a\u53f0\u673a\u5668\u5206\u644a\u5904\u7406\u6d41\u91cf\u7684\u60c5\u51b5 load \u5728\u4e2d\u6587\u91cc\u4e5f\u6709\u201c\u91cf\u201d\u7684\u610f\u601d\uff0c\u5728\u8fd9\u91cc\u53ef\u4ee5\u7406\u89e3\u4e3a\u673a\u5668\u7684\u5de5\u4f5c\u91cf\uff0c\u90a3\u4e48 Load Balance \u5c31\u662f\u8ba9\u6bcf\u53f0\u673a\u5668\u5e73\u644a\u5904\u7406\u7684\u5de5\u4f5c\u91cf\uff08\u8bf7\u6c42\u91cf\uff09\u3002 \u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u5b9e\u73b0\u65b9\u5f0f\u3002 \u786c\u4ef6\u8d1f\u8f7d\u5747\u8861 \uff1a\u6bd4\u8f83\u5e38\u89c1\u7684\u786c\u4ef6\u8d1f\u8f7d\u5747\u8861\u5668\u6709NetScaler\u3001F5\u3001Radware\uff0cArray \u7b49\uff0c\u7531\u4e13\u4e1a\u7684\u786c\u4ef6\u516c\u53f8\u751f\u4ea7\uff0c\u4e00\u822c\u5728\u4e92\u8054\u7f51\u516c\u53f8\u7684\u65e9\u671f\u9636\u6bb5\u8fdb\u884c\u4f7f\u7528\uff0c\u4f46\u662f\u7531\u4e8e\u4ef7\u683c\u6602\u8d35\uff0c\u73b0\u5728\u4e92\u8054\u7f51\u516c\u53f8\u5f88\u5c11\u4f7f\u7528\u4e86\u3002 DNS \u8d1f\u8f7d\u5747\u8861 \uff1a \u901a\u8fc7\u57df\u540d\u8fd4\u56de\u540e\u7aef\u8282\u70b9 IP \u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u540e\u7aef IP \u8bbe\u7f6e\u6743\u91cd \u3002\u56e0\u4e3a DNS \u89e3\u6790\u5b58\u5728\u7f13\u5b58\u5ef6\u65f6\u7684\u95ee\u9898\uff0c\u6240\u4ee5\u5728\u5185\u7f51\u8f83\u5c11\u4f7f\u7528\u3002\u4f46\u5bf9\u4e8e\u5927\u6d41\u91cf\u7684 Web \u548c App\uff0c\u5165\u53e3\u5c42\u4e00\u822c\u4f1a\u4f7f\u7528\u6b64\u79cd\u65b9\u5f0f\u505a\u8d1f\u8f7d\u5747\u8861\uff0c\u540e\u7aef\u591a\u7ec4\u56db\u5c42 LB \u505a\u8d1f\u8f7d\u5747\u8861\u3002 \u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861 \uff1a\u6bd4\u8f83\u6d41\u884c\u7684\u662f Nginx\u3001HAproxy\u3001LVS \u7b49\uff0c \u50cf LVS \u662f\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c\u6027\u80fd\u8f83\u9ad8\uff1b Nginx\u3001HAproxy \u4e3b\u8981\u7528\u4e8e\u4e03\u5c42\u7684\u8d1f\u8f7d\u5747\u8861 \uff0c\u6709\u8f83\u591a\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u540c\u65f6\u6d41\u91cf\u76f8\u5bf9\u4e8e\u56db\u5c42\u4f1a\u66f4\u52a0\u5747\u8861\u3002 \u50cf\u6211\u4eec\u5e38\u7528\u7684\u4e91\u5382\u5546\uff0c\u6bd4\u5982\u963f\u91cc\u4e91\u7684 SLB \u540c\u65f6\u63d0\u4f9b\u4e86\u57fa\u4e8e LVS \u7684\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u548c\u57fa\u4e8e\u4e03\u5c42\u7684 Tengine \u8d1f\u8f7d\u5747\u8861\u5668\u4f9b\u5927\u5bb6\u9009\u62e9\u3002 \u7a0b\u5e8f\u5185\u8d1f\u8f7d\u5747\u8861 \uff1a\u4e25\u683c\u6765\u8bf4\u5b83\u5c5e\u4e8e\u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861\u7684\u4e00\u79cd\uff0c\u53ea\u662f \u628a\u8d1f\u8f7d\u5747\u8861\u7684\u7b56\u7565\u653e\u5728\u4e86\u670d\u52a1\u5185\u90e8\u3002 \u5bf9\u4e8e\u5fae\u670d\u52a1\u67b6\u6784\u6765\u8bf4\uff0c\u670d\u52a1\u5185\u90e8\u505a\u8d1f\u8f7d\u5747\u8861\u66f4\u5408\u9002\uff0c\u56e0\u4e3a\u5fae\u670d\u52a1\u5c31\u662f\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u53d1\u73b0\u670d\u52a1\u8282\u70b9\u7684\uff0c\u5728\u7a0b\u5e8f\u5185\u90e8\u9009\u53d6\u5408\u9002\u7684\u6d41\u91cf\u8282\u70b9\u81ea\u7136\u66f4\u52a0\u5408\u7406\u3002 Serivce Mesh \u8d1f\u8f7d\u5747\u8861 \uff1a\u5229\u7528 sidecar \u505a\u7a0b\u5e8f\u5185\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5c5e\u4e8e\u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861\u7684\u4e00\u79cd\uff0c\u76f8\u6bd4 SDK \u5185\u8d1f\u8f7d\u5747\u8861\uff0c\u53ef\u4ee5\u968f\u65f6\u66f4\u65b0\u5404\u79cd\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3002 1-2 \u5e38\u7528\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5 Round Robin \uff1a\u7b80\u5355\u8f6e\u8be2\u7b97\u6cd5\uff0c\u9002\u5408\u540e\u7aef\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\u3002\u5e94\u7528\u573a\u666f\u8f83\u5c11\uff0c\u4f46\u7b97\u6cd5\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a O(1) \uff0c \u53ef\u4ee5\u5728\u9884\u5148\u5224\u65ad\u540e\u7aef\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528\u3002 Weighted Round Robin \uff1a\u901a\u8fc7\u53d6\u6700\u5927\u516c\u7ea6\u6570\u7684\u65b9\u5f0f\uff0c\u505a\u7b80\u5355\u8f6e\u8be2\u3002\u56e0\u4e3a\u6743\u91cd\u591a\u7684\u8282\u70b9\u4f1a\u6bd4\u8f83\u96c6\u4e2d\uff0cNginx\u53d1\u660e\u4e86\u4e00\u79cd\u5e73\u6ed1\u52a0\u6743\u8f6e\u8be2\uff0c\u901a\u8fc7\u7b97\u6cd5\u5c06\u6743\u91cd\u5927\u7684\u8282\u70b9\u5206\u6563\u5f00\uff0c\u4f46\u5728\u670d\u52a1\u91cd\u542f\u65f6\u4f9d\u7136\u4f1a\u51fa\u73b0\u8282\u70b9\u8bf7\u6c42\u8f83\u4e3a\u96c6\u4e2d\u7684\u60c5\u51b5\u3002 Weighted Random \uff1a\u901a\u8fc7\u968f\u673a\u7684\u65b9\u5f0f\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u914d\u5408\u4e8c\u5206\u67e5\u627e\uff0c\u53ef\u4ee5\u5c06\u65f6\u95f4\u590d\u6742\u5ea6\u964d\u5230 O(log^n) \u3002\u8be5\u7b97\u6cd5\u5bf9\u4e8e\u540e\u7aef\u8282\u70b9\u975e\u5e38\u5747\u8861\uff0c\u4e0d\u4f1a\u51fa\u73b0\u52a0\u6743\u8f6e\u8be2\u5bfc\u81f4\u7684\u91cd\u542f\u65f6\u8282\u70b9\u8bf7\u6c42\u8f83\u4e3a\u96c6\u4e2d\u7684\u60c5\u51b5\u3002 Two Random Choices \uff1a\u76ee\u524d\u6bd4\u8f83\u6d41\u884c\u7684\u7b97\u6cd5\uff0c\u9002\u5408\u540e\u7aef\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\uff0c \u901a\u8fc7\u4e24\u6b21\u968f\u673a\u7b97\u6cd5\uff0c\u83b7\u53d6\u5230\u4e24\u4e2a\u8282\u70b9\uff0c\u7136\u540e\u5bf9\u6bd4\u8282\u70b9\u7684 CPU \u8d1f\u8f7d\uff0c\u5ef6\u65f6\u60c5\u51b5\u7b49\u4fe1\u606f\uff0c\u83b7\u53d6\u4e00\u4e2a\u6700\u4f18\u7684\u8282\u70b9\uff0c\u597d\u5904\u662f\u540e\u7aef\u8282\u70b9\u7684 CPU \u6216\u8005\u5ef6\u65f6\u4f1a\u6bd4\u8f83\u5747\u8861 \uff0c\u56e0\u4e3a\u5206\u533a\u548c\u865a\u62df\u673a\u786c\u4ef6\u914d\u7f6e\u7684\u539f\u56e0\uff0c\u6b64\u79cd\u505a\u6cd5\u53ef\u4ee5\u52a8\u6001\u8c03\u8282\u540e\u7aef\u8282\u70b9\u8d1f\u8f7d\uff0c\u5728\u751f\u4ea7\u4e2d\u662f\u975e\u5e38\u597d\u7684\u9009\u62e9\u3002 Sticky Session\uff08\u4f1a\u8bdd\u4fdd\u6301\uff09 \uff1a\u6839\u636e\u5ba2\u6237\u7aef IP \u6216\u8005 Cookie \u8fdb\u884c\u4f1a\u8bdd\u4fdd\u6301\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u540c\u4e00\u4e2a\u5ba2\u6237\u7aef\uff0c\u6bcf\u6b21\u9009\u53d6\u7684\u540e\u7aef\u8282\u70b9 IP \u4fdd\u6301\u4e00\u81f4\uff0c\u4e3b\u8981\u662f\u7528\u4e8e\u767b\u5f55\u9a8c\u8bc1\u7684\u4f1a\u8bdd\u4fdd\u6301\u3002 \u5b9e\u9645\u4e0a\u6b64\u79cd\u7b97\u6cd5\u8ba9\u670d\u52a1\u53d8\u6210\u4e86\u6709\u72b6\u6001\u670d\u52a1\uff0c\u53e6\u5916\u5bf9\u4e8e\u540e\u7aef\u8d1f\u8f7d\u4e5f\u4f1a\u4e0d\u5747\u8861\uff0c\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u5df2\u7ecf\u8f83\u5c11\u4f7f\u7528 \u3002\u5982\u679c\u60f3\u8981\u8fdb\u884c Session \u7684\u4fdd\u6301\uff0c\u5927\u591a\u662f\u5c06 Session \u5b58\u50a8\u5728\u5916\u90e8\u5b58\u50a8\u4e2d\uff0c\u6bd4\u5982 Redis \u7b49\u3002 1-3 \u670d\u52a1\u53d1\u73b0\u540e\u7684\u8282\u70b9\u4fdd\u62a4 1-3-1 \u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5 \u53d7\u6ce8\u518c\u4e2d\u5fc3\u7684\u7f51\u7edc\u5206\u533a\u6545\u969c\u7b49\u539f\u56e0\u5f71\u54cd\uff0c \u5728\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u8fdb\u884c\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5 \uff0c\u662f\u907f\u514d\u6b64\u7c7b\u60c5\u51b5\u53d1\u751f\u7684\u6700\u4f73\u6a21\u5f0f\uff0c\u4f46\u957f\u65f6\u95f4\u7684\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u4f1a\u4ea7\u751f\u5927\u91cf\u65e0\u7528\u7684 ping \u64cd\u4f5c\uff0c\u9020\u6210\u4e0d\u5fc5\u8981\u7684\u673a\u5668\u8d1f\u8f7d\u635f\u5931\u3002 \u6240\u4ee5\u5728\u5b9e\u8df5\u4e2d\uff0c\u5efa\u8bae\u9009\u62e9\u83b7\u53d6\u8fc7\u5c11\u7684\u8282\u70b9\u65f6\u624d\u89e6\u53d1\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6a21\u5f0f \u3002 \u5f53\u83b7\u53d6\u8282\u70b9\u8fc7\u5c11\u3001\u8fdb\u5165\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u7684\u6a21\u5f0f\u65f6\u4f1a\u89e6\u53d1\u5bf9\u540e\u7aef\u8282\u70b9\u7684 ping \u64cd\u4f5c\uff0c\u8fd9\u4e2a\u8fc7\u5c11\u7684\u9608\u503c\u53ef\u4ee5\u6839\u636e\u516c\u53f8\u8d1f\u8f7d\u60c5\u51b5\u786e\u5b9a\u3002\u6bd4\u5982\u5728\u5b9e\u9645\u64cd\u4f5c\u4e2d\uff0c\u5982\u679c\u673a\u5668\u8d1f\u8f7d\u957f\u671f\u5904\u4e8e\u6bd4\u8f83\u9ad8\u7684\u6c34\u4f4d\uff0c\u4f60\u53ef\u4ee5\u91c7\u7528\u4e00\u4e2a\u6bd4\u8f83\u4fdd\u5b88\u7684\u6570\u503c\uff0c\u6bd4\u5982\u5c0f\u4e8e 80% \u7684\u65f6\u5019\u89e6\u53d1\u3002 \u4e3a\u4e86\u80fd\u591f\u4fdd\u8bc1\u4e24\u53f0\u673a\u5668\u81f3\u5c11\u80fd\u591f\u4e0b\u6389\u4e00\u53f0\uff0c\u91c7\u7528\u4e86 (currentNodeNum+1)/nodeCount < 80% \u4ee5\u4fdd\u8bc1\u81f3\u5c11\u4e0b\u6389\u4e00\u4e2a\u8282\u70b9\u3002\u5176\u4e2d nodeCount \u4e3a 15 \u5206\u949f\u524d\u7684\u670d\u52a1\u8282\u70b9\u603b\u6570\uff0c\u5f53\u7136\u8fd9\u6837\u662f\u4e00\u4e2a\u7ecf\u9a8c\u503c\uff0c\u4f60\u4e5f\u53ef\u4ee5\u6839\u636e\u516c\u53f8\u7684\u5b9e\u9645\u60c5\u51b5\u9002\u5f53\u8c03\u6574\u3002 \u5728\u5bb9\u5668\u73af\u5883\u4e2d\uff0c\u6269\u7f29\u5bb9\u65f6\u53ef\u80fd\u4f1a\u89e6\u53d1\u8282\u70b9\u7684\u81ea\u6211\u4fdd\u62a4\u6a21\u5f0f\uff0c\u9020\u6210\u4e00\u5b9a\u7684\u77ed\u65f6\u95f4\u6d41\u91cf\u635f\u5931\uff0c\u4f46\u76f8\u5bf9\u4e8e\u56e0\u4e3a\u6d41\u91cf\u6253\u5230\u4e86\u9519\u8bef\u7684\u8282\u70b9\u4e0a\u5f15\u53d1\u7684\u96ea\u5d29\uff0c\u6211\u8ba4\u4e3a\u6b64\u79cd\u60c5\u51b5\u8fd8\u662f\u53ef\u4ee5\u63a5\u53d7\u7684\u3002 1-3-2 \u6050\u614c\u9608\u503c \u4f9d\u636e\u5065\u5eb7\u68c0\u67e5\u7684\u7ed3\u679c\u5224\u65ad\u540e\u7aef\u8282\u70b9\u662f\u5426\u6b63\u5e38\uff0c\u8fd9\u79cd\u65b9\u5f0f\u867d\u7136\u53ef\u4ee5\u4fdd\u8bc1\u7f51\u7edc\u5206\u533a\u5f02\u5e38\u60c5\u51b5\u4e0b\u8282\u70b9\u95f4\u7684\u8fde\u901a\u6027 \u4f46\u5982\u679c\u540e\u7aef\u8282\u70b9\u5927\u91cf\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709\u5c11\u6570\u8282\u70b9\u80fd\u591f\u901a\u8fc7\u5065\u5eb7\u68c0\u67e5\u3002\u6b64\u79cd\u60c5\u51b5\u4e0b\uff0c\u5c11\u91cf\u7684\u8282\u70b9\u663e\u7136\u662f\u65e0\u6cd5\u63d0\u4f9b\u6b63\u5e38\u670d\u52a1\u7684\u3002 \u56de\u6eda: \u56e0\u4e3a\u670d\u52a1\u53d1\u7248\u5bfc\u81f4\u7684\u670d\u52a1\u8282\u70b9\u591a\u6570\u6216\u8005\u5168\u90e8\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\u4e5f\u5f88\u5bb9\u6613\u51fa\u73b0\uff0c\u6b64\u65f6\u4f60\u7684\u9996\u9009\u64cd\u4f5c\u4e00\u5b9a\u662f\u56de\u6eda\u3002 \u56de\u6eda\u671f\u95f4\uff0c\u8282\u70b9\u7684\u53ef\u7528\u662f\u6709\u5148\u540e\u987a\u5e8f\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u5b8c\u5168\u4fe1\u4efb\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u7684\u7ed3\u679c\uff0c\u4f1a\u5bfc\u81f4\u6d41\u91cf\u5168\u90e8\u8def\u7531\u5230\u65b0\u56de\u6eda\u6210\u529f\u7684\u8282\u70b9\u4e0a\uff0c\u9020\u6210\u65b0\u542f\u52a8\u7684\u8282\u70b9\u4f1a\u7acb\u5373\u88ab\u6253\u6302 \u3002 \u89e3\u51b3\u4e0a\u9762\u4e24\u79cd\u95ee\u9898\u7684\u529e\u6cd5\u4e00\u79cd\u662f\u670d\u52a1\u6cbb\u7406\u4e2d\u7684\u9650\u6d41 \uff0c \u53e6\u5916\u4e00\u79cd\u529e\u6cd5\u5c31\u662f\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u7684\u6050\u614c\u9608\u503c \u3002 \u5f53\u5065\u5eb7\u68c0\u67e5\u540e\u8282\u70b9\u4f9d\u7136\u5c11\u4e8e\u8bbe\u5b9a\u7684\u9608\u503c\uff0c\u5219\u5ffd\u7565\u5065\u5eb7\u68c0\u67e5\u7ed3\u679c\uff0c\u5c06\u6d41\u91cf\u8def\u7531\u5230\u5168\u90e8\u7684\u8282\u70b9\uff0c\u5305\u62ec\u4e0d\u5065\u5eb7\u7684\u8282\u70b9\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u8d1f\u8f7d\u7684\u5747\u8861\uff0c\u4e5f\u4e0d\u4f1a\u628a\u6d41\u91cf\u96c6\u4e2d\u5230\u8fc7\u5c11\u7684\u8282\u70b9\uff0c\u5bfc\u81f4\u670d\u52a1\u5904\u4e8e\u201c\u96ea\u5d29\u201d\u7684\u72b6\u6001\u3002 \u8fd9\u4e2a\u9608\u503c\u7684\u8bbe\u7f6e\u4e5f\u662f\u6bd4\u8f83\u8bb2\u7a76\u7684\uff0c\u867d\u7136 Envoy \u5b98\u65b9\u9ed8\u8ba4\u503c\u662f 50%\uff0c\u4f46\u6211\u89c9\u5f97\u8fd9\u5e76\u4e0d\u662f\u6700\u5408\u9002\u7684\u8bbe\u7f6e\uff1a 50% \u7684\u9608\u503c\u592a\u8fc7\u6fc0\u8fdb\uff0c\u5f88\u5bb9\u6613\u8fbe\u5230\u89e6\u53d1\u6761\u4ef6 \u3002 \u800c\u5f53\u4f60\u7406\u89e3\u4e86\u8fd9\u4e2a\u9608\u503c\u7684\u4f5c\u7528\uff0c\u5c31\u4f1a\u660e\u767d\u5f53\u7ebf\u4e0a\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u8282\u70b9\u662f\u4f1a\u8d8b\u4e8e\u5168\u90e8\u4e0d\u53ef\u7528\u7684\uff0c\u6240\u4ee5\u7ebf\u4e0a\u6211\u628a\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u4e3a 10%\u3002 \u56e0\u4e3a\u968f\u7740\u6545\u969c\u8282\u70b9\u53d8\u591a\uff0c\u5269\u4e0b\u7684\u5c11\u91cf\u8282\u70b9\u4e5f\u625b\u4e0d\u4f4f\u8c03\u7528\u65b9\u7684\u6240\u6709\u6d41\u91cf\uff0c\u5269\u4f59\u7684\u8282\u70b9\u4f1a\u6162\u6162\u8d8b\u8fd1\u6211\u4eec\u8bbe\u7f6e\u7684\u9608\u503c\uff0c\u4e00\u6837\u53ef\u4ee5\u8fbe\u5230\u6050\u614c\u9608\u503c\u8bbe\u7f6e\u7684\u76ee\u7684 \uff0c\u800c\u4e14\u4e5f\u4e0d\u4f1a\u56e0\u4e3a\u53ea\u662f\u5c11\u91cf\u8282\u70b9\u6545\u969c\uff0c\u89e6\u53d1\u9608\u503c\u5bfc\u81f4\u7684\u9519\u8bef\u6d41\u91cf\u3002 1-3-3 \u88ab\u52a8\u5065\u5eb7\u68c0\u67e5 \u6709\u4e9b\u65f6\u5019\u5355\u7eaf\u9760\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u4f9d\u7136\u65e0\u6cd5\u907f\u514d\u9519\u8bef\u7684\u6d41\u91cf\uff0c\u6bd5\u7adf\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u53ea\u662f\u901a\u8fc7\u7279\u5b9a\u7684 ping \u63a5\u53e3\u6216\u8005 TCP \u63a2\u6d3b\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5\u7684\uff0c\u8fd9\u4e9b\u5e76\u4e0d\u662f\u670d\u52a1\u7684\u771f\u5b9e\u6d41\u91cf\uff0c\u7279\u522b\u662f\u5728\u4f7f\u7528 TCP \u63a2\u6d3b\u7684\u65f6\u5019\uff0c\u66f4\u5bb9\u6613\u51fa\u73b0\u95ee\u9898\u3002 \u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u88ab\u52a8\u5065\u5eb7\u68c0\u67e5\u4e86\uff0c\u901a\u8fc7\u771f\u5b9e\u6d41\u91cf\u6765\u5224\u65ad\u8282\u70b9\u662f\u5426\u6b63\u5e38\uff0c\u4e5f\u5c31\u662f\u5229\u7528\u8282\u70b9\u7194\u65ad\u5668\u3002 \u548c\u670d\u52a1\u7ea7\u522b\u7684\u7194\u65ad\u5668\u4e00\u6837\uff0c\u8282\u70b9\u7194\u65ad\u5668\u4e5f\u662f\u901a\u8fc7\u72b6\u6001\u7801\u5224\u65ad\u670d\u52a1\u662f\u5426\u6b63\u5e38\uff0c\u5047\u5982\u540e\u7aef\u662f HTTP \u670d\u52a1\uff0c\u6211\u4eec\u901a\u5e38\u4f1a\u5c06 499 \u4ee5\u4e0a\u7684\u9519\u8bef\u7801\u8ba4\u4e3a\u662f\u540e\u7aef\u670d\u52a1\u9519\u8bef\u3002 \u901a\u8fc7\u8bb0\u5f55 10s \u7684\u6ed1\u52a8\u7a97\u53e3\u5185\u7684\u9519\u8bef\u7801\u6bd4\u4f8b\uff0c\u5f53\u540e\u7aef\u8282\u70b9\u7684\u9519\u8bef\u6bd4\u4f8b\u8fbe\u5230\u6211\u4eec\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\uff0c\u4fbf\u5c06\u540e\u7aef\u8282\u70b9\u4ece\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u79fb\u9664\u3002\u5f53\u7136\u4f60\u4e5f\u8981\u8003\u8651\u4e0d\u80fd\u6458\u9664\u8fc7\u591a\u7684\u8282\u70b9\uff0c\u6240\u4ee5\u7194\u65ad\u5668\u9700\u8981\u8bbe\u7f6e\u548c\u81ea\u6211\u4fdd\u62a4\u76f8\u540c\u7684\u89e6\u53d1\u9608\u503c\uff0c\u4ee5\u907f\u514d\u8fc7\u591a\u7684\u8282\u70b9\u88ab\u79fb\u51fa\u5f15\u53d1\u201c\u96ea\u5d29\u201d\u3002 2\u3001\u5982\u4f55\u5b9e\u73b0\u67d3\u8272\u548c\u5730\u57df\u4f18\u5148 2-1 \u8282\u70b9\u67d3\u8272 \u8282\u70b9\u67d3\u8272\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u628a\u67d0\u4e00\u7c7b\u8282\u70b9\u6253\u4e0a\u76f8\u540c\u7684\u6807\u7b7e\uff0c\u7136\u540e\u8d1f\u8f7d\u5747\u8861\u5668\u6839\u636e\u6807\u7b7e\u6765\u5206\u53d1\u6d41\u91cf\u3002 \u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u67d3\u8272\u6709\u5f88\u591a\u4f5c\u7528\uff0c\u6bd4\u5982\u91d1\u4e1d\u96c0\u53d1\u5e03\u3001A/B\u6d4b\u8bd5\u3001\u6545\u969c\u6f14\u7ec3\u3001\u6d41\u91cf\u533a\u5206\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u67d3\u8272\u6765\u5b9e\u73b0 \u3002 2-1-1 \u5982\u4f55\u64cd\u4f5c\u5462 \u9996\u5148\u6211\u4eec\u9700\u8981\u5728\u7f51\u5173\u5c42\uff0c\u6839\u636e header \u4fe1\u606f\u6216\u8005\u6743\u91cd\u5bf9\u6d41\u91cf\u8fdb\u884c\u67d3\u8272 \u3002 \u6bd4\u5982\u5728\u5ba2\u6237\u7aef\u7684\u67d0\u4e9b\u7248\u672c\u4e2d\u5199\u5165\u67d3\u8272\u7684 header\uff0c\u5c31\u50cf X-TAG=canary \uff1b\u4e5f\u53ef\u4ee5\u5728\u7f51\u5173\u5c42\u5bf9\u6d41\u91cf\u6309\u7167\u6bd4\u4f8b\u5206\u6d41\uff0c\u6bd4\u5982 1% \u7684\u6d41\u91cf\u6253\u4e0a\u91d1\u4e1d\u96c0\u7684\u6807\u7b7e\u8fdb\u884c\u7070\u5ea6\u6d4b\u8bd5\u3002 \u5728\u6ce8\u518c\u4e2d\u5fc3\u4e5f\u9700\u8981\u5199\u5165\u5bf9\u5e94\u7684 MetaData \u4fe1\u606f\uff0c\u7528\u4e8e\u5728\u8d1f\u8f7d\u5747\u8861\u5c42\u8fdb\u884c\u6d41\u91cf\u7684\u8fc7\u6ee4 \u6bd4\u5982\u5728\u6ce8\u518c\u4e2d\u5fc3\u7684 MetaData \u4fe1\u606f\u4e2d\u5b9a\u4e49 lb_tags \u7684\u5b57\u6bb5\uff0c\u6570\u636e\u4e3a [stage:canary, v:1.2] \uff0c\u5728 LB \u8fdb\u884c\u5339\u914d\u7684\u65f6\u5019\uff0c\u5e26\u6709\u91d1\u4e1d\u96c0 header \u7684\u8bf7\u6c42\uff0c\u5c31\u4f1a\u8bf7\u6c42\u5230 lb_tags \u5305\u542b canary \u7684\u8282\u70b9\u4e0a\u9762\u3002 \u53e6\u5916\u6211\u4eec\u4e5f\u9700\u8981\u8003\u8651\u6ca1\u6709\u5339\u914d\u5230\u5bf9\u5e94\u8282\u70b9\u65f6\u7684\u964d\u7ea7\u7b56\u7565\uff0c\u53c2\u8003 Envoy \u4e2d\u7684\u914d\u7f6e\uff0c\u4e00\u822c\u6709\u5982\u4e0b\u51e0\u79cd\uff1a \u6bd4\u5982\u5728\u91d1\u4e1d\u96c0\u8fd9\u79cd\u7b56\u7565\u4e2d\uff0c\u6211\u4eec\u5c06\u6807\u6ce8 canary \u7684 tag \u7684\u8282\u70b9\uff0c\u914d\u7f6e DEFAULT_SUBSET \uff0c\u8fd9\u6837\u5982\u679c\u91d1\u4e1d\u96c0\u7684\u8282\u70b9\u4e0d\u5b58\u5728\u7684\u8bdd\uff0c\u5c31\u4f1a\u8bbf\u95ee prod \u7684\u8282\u70b9\uff0c \u5c06\u6807\u6ce8 prod \u7684\u8282\u70b9\u914d\u7f6e NO_ENDPOINT \uff0c\u8fd9\u6837 prod \u7684\u8282\u70b9\u5c31\u4e0d\u4f1a\u6709\u67d3\u8272\u7684\u964d\u7ea7\u7b56\u7565\uff0c\u800c\u662f\u4f7f\u7528\u6211\u4eec\u4e4b\u524d\u914d\u7f6e\u7684\u81ea\u6211\u4fdd\u62a4\u7b56\u7565\u4e86\u3002 \u67d3\u8272\u662f\u8d1f\u8f7d\u5747\u8861\u5668\u5229\u7528\u8282\u70b9\u4e0a\u7684\u6807\u7b7e\u8fdb\u884c\u6d41\u91cf\u8def\u7531\uff0c\u540c\u6837\u5730\u57df\u4f18\u5148\u8bbf\u95ee\u4e5f\u9700\u8981\u5229\u7528\u5728\u8282\u70b9\u4e0a\u6253\u4e0a\u5730\u57df\u6807\u7b7e\uff0c\u8ba9\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u5730\u57df\u4f18\u5148\u3002 2-2 \u5730\u57df\u4f18\u5148\u8bbf\u95ee 2-2-1 \u5730\u57df\u4f18\u5148\u8bbf\u95ee \u5728 Envoy \u4e2d\u4e5f\u88ab\u79f0\u4e3a zone \u611f\u77e5\u8def\u7531 \u59cb\u53d1\u96c6\u7fa4\uff1a\u8c03\u7528\u65b9\uff0c\u4e5f\u5c31\u662f Client \u7aef\u7684\u670d\u52a1\u8282\u70b9\u96c6\u5408 \u3002 \u4e0a\u6e38\u96c6\u7fa4\uff1a\u88ab\u8c03\u7528\u65b9\uff0c\u4e5f\u5c31\u662f Server \u7aef\u7684\u670d\u52a1\u8282\u70b9\u96c6\u5408 \u3002 zone: \u533a\u57df\uff08Region\uff09\u548c\u53ef\u7528\u533a\uff08Availability Zone\uff0cAZ \uff09 zone \u611f\u77e5\u8def\u7531\uff0c\u4f1a\u6839\u636e\u59cb\u53d1\u96c6\u7fa4\u7684\u6240\u5728\u533a\u8282\u70b9\u6570\u91cf\u548c\u76ee\u6807\u96c6\u7fa4\u7684\u6240\u5728\u533a\u8282\u70b9\u6570\u91cf\uff0c\u52a8\u6001\u8ba1\u7b97\u51fa\u4e00\u4e2a\u5bf9\u5e94\u7684\u6bd4\u4f8b\u3002 2-2-2 \u5730\u57df\u6240\u5728\u533a\u9759\u6001\u52a0\u6743 \u8fd9\u79cd\u7b97\u6cd5\u6700\u5927\u7684\u95ee\u9898\uff0c\u662f\u5f88\u96be\u4fdd\u8bc1\u59cb\u53d1\u96c6\u7fa4\u548c\u4e0a\u6e38\u96c6\u7fa4\u7684\u6240\u5728\u533a\u662f\u4e00\u4e00\u5bf9\u5e94\u4e14\u6bd4\u4f8b\u76f8\u540c\u7684\uff0c \u6bd4\u5982\u59cb\u53d1\u96c6\u7fa4 A \u6240\u5728\u7684 c \u533a\u662f 50%\uff0c\u800c\u4e0a\u6e38\u96c6\u7fa4 B \u6240\u5728\u7684 c \u533a\u53ea\u6709 20%\uff0c\u8fd9\u6837\u5982\u679c\u53ea\u662f\u7b80\u5355\u7684\u9759\u6001\u52a0\u6743\uff0c\u5c31\u4f1a\u5bfc\u81f4\u59cb\u53d1\u96c6\u7fa4 c \u533a\u7684\u6d41\u91cf\u5c06\u4e0a\u6e38\u96c6\u7fa4 c \u533a\u6253\u6302\u3002 \u5b9e\u9645\u4e0a\u5728\u5fae\u670d\u52a1\u6846\u67b6 Dubbo \u4e2d\u4e5f\u91c7\u7528\u4e86\u7c7b\u4f3c\u7684\u7b97\u6cd5\uff0c \u4f46\u8fd9\u79cd\u7b97\u6cd5\u5bf9\u8fd0\u7ef4\u73af\u5883\u8981\u6c42\u6bd4\u8f83\u9ad8\uff0c\u5e76\u4e0d\u9002\u5408\u7528\u5728\u771f\u5b9e\u7684\u73af\u5883\u4e2d\u3002 zone \u611f\u77e5\u8def\u7531\u89e3\u51b3\u7684\u6700\u5927\u7684\u95ee\u9898\uff0c \u5c31\u662f\u5bf9\u8fd0\u7ef4\u73af\u5883\u7684\u4f9d\u8d56 \u3002\u901a\u8fc7\u52a8\u6001\u8ba1\u7b97\u4e0a\u4e0b\u6e38\u7684\u8282\u70b9\u6570\uff0c\u5c06\u6d41\u91cf\u6b63\u786e\u5730\u8def\u7531\u5230\u5404\u4e2a\u5206\u533a\u3002\u867d\u7136\u4f1a\u4ea7\u751f\u4e00\u4e9b\u56e0\u73af\u5883\u5e26\u6765\u7684\u5ef6\u65f6\u95ee\u9898\uff0c\u4f46\u907f\u514d\u4e86\u6253\u6302\u4e0a\u6e38\u96c6\u7fa4\u7684\u98ce\u9669\u3002 \u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\uff1a 1.\u59cb\u53d1\u96c6\u7fa4\u7684\u672c\u5730 zone \u8282\u70b9\u6570\u91cf\u5c0f\u4e8e\u6216\u8005\u7b49\u4e8e\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u8282\u70b9\u6570\u91cf \u53ea\u9700\u5c06\u6d41\u91cf\u5168\u90e8\u6253\u5230\u5bf9\u5e94\u7684\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u7684\u8282\u70b9\u5c31\u53ef\u4ee5\u4e86\uff0c\u53e6\u5916\u8ba1\u7b97\u51fa\u7684\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728\u533a\u5269\u4f59\u7684\u6d41\u91cf\u6bd4\u4f8b\uff0c\u7528\u4e8e\u670d\u52a1\u5176\u4ed6\u6240\u5728\u533a\u96c6\u7fa4\u7684\u6d41\u91cf\u3002 2. \u59cb\u53d1\u96c6\u7fa4\u7684\u672c\u5730 zone \u8282\u70b9\u6570\u91cf\u5927\u4e8e\u6216\u8005\u7b49\u4e8e\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u8282\u70b9\u6570\u91cf \u8fd9\u4e2a\u65f6\u5019\u5c31\u6ca1\u529e\u6cd5\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u4e86\uff0c\u56e0\u4e3a\u6b64\u79cd\u505a\u6cd5\u5f88\u660e\u663e\u4f1a\u5bfc\u81f4\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728\u533a\u7684\u6d41\u91cf\u4e0d\u5747\u8861\u3002\u8fd9\u65f6\u6211\u4eec\u5c31\u9700\u8981\u5c06\u5269\u4f59\u7684\u6d41\u91cf\u8def\u7531\u5230\u5176\u4ed6 zone \u7684\u4e0a\u6e38\u96c6\u7fa4\u4e86\u3002 zone \u611f\u77e5\u8def\u7531\u5bf9\u4e8e\u964d\u4f4e\u56e0\u4e3a\u8de8\u5730\u57df\u8de8\u533a\u7684\u8bf7\u6c42\u5f15\u8d77\u7684\u5ef6\u65f6\u589e\u9ad8\u95ee\u9898\uff0c\u6709\u660e\u663e\u7684\u6548\u679c\uff0c\u4f46\u4f9d\u8d56\u4e8e\u83b7\u53d6\u672c\u5730\u6240\u5728 zone \u7684\u59cb\u53d1\u96c6\u7fa4\u8282\u70b9\u6570\u91cf\u3002 \u5728\u5206\u5e03\u5f0f\u573a\u666f\u4e2d\uff0c \u5982\u679c\u8282\u70b9\u6570\u91cf\u53d1\u751f\u53d8\u5316\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u77ac\u95f4\u7684\u6d41\u91cf\u4e0d\u5747\u8861 \uff0c\u6b64\u65f6\u6211\u4eec\u8981\u53ca\u65f6\u9000\u51fa\u6b64\u79cd\u6a21\u5f0f\u4ee5\u907f\u514d\u5f15\u53d1\u96ea\u5d29\uff0c\u4e5f\u56e0\u4e3a\u8fd9\u79cd\u95ee\u9898\uff0c \u6211\u4eec\u5f15\u5165\u4e86\u57fa\u4e8e P2C \u6280\u672f\uff08Pick of two choices\uff0c\u4e24\u79cd\u968f\u673a\u9009\u62e9\uff09\u7684\u52a8\u6001\u52a0\u6743\u8d1f\u8f7d\u5747\u8861\u6a21\u5f0f \u3002 2-3 \u5ef6\u65f6\u3001\u8d1f\u8f7d\u52a0\u6743\uff08EWMA\uff09 \u5b9e\u9645\u4e0a\u57fa\u4e8e P2C \u7b97\u6cd5\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u662f\u8fd1\u5e74\u6765\u6700\u6d41\u884c\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff0c\u6211\u4eec\u5e38\u89c1\u7684 Service Mesh \u63a7\u5236\u9762\uff0c\u6bd4\u5982 Envoy\u3001Linkerd\uff0c\u9ed8\u8ba4\u90fd\u63d0\u4f9b\u57fa\u4e8e P2C \u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff0c\u53e6\u5916\u6700\u5e38\u7528\u7684\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u5668 Nginx\uff0c\u5728\u5176\u6536\u8d39\u7248\u672c NGINX plus \u4e2d\uff0c\u540c\u6837\u63d0\u4f9b\u4e86 P2C \u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5 \u3002 \u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684\u52a8\u6001\u52a0\u6743\u8d1f\u8f7d\u5747\u8861\uff0cP2C \u89e3\u51b3\u7684\u6700\u5927\u95ee\u9898\uff0c\u5c31\u662f\u201c\u7f8a\u7fa4\u6548\u5e94\u201d\u3002 \u7f8a\u7fa4\u6548\u5e94\uff1a\u5f53\u67d0\u4e00\u8282\u70b9\u51fa\u73b0\u5ef6\u65f6\u6216\u8005 CPU \u8d1f\u8f7d\u8fc7\u9ad8\u65f6\uff0c\u59cb\u53d1\u96c6\u7fa4\u7684\u591a\u4e2a\u8282\u70b9\u90fd\u53d1\u73b0\u4e86\u8fd9\u4e2a\u8282\u70b9\u5ef6\u65f6/CPU \u8d1f\u8f7d\u8fc7\u9ad8\u7684\u95ee\u9898\uff0c\u5f88\u5bb9\u6613\u9020\u6210\u8fc7\u591a\u7684\u6d41\u91cf\u8def\u7531\u5230\u540c\u4e00\u8282\u70b9\uff0c\u9020\u6210\u8d1f\u8f7d\u4e0d\u5747\u8861\u3002 \u56e0\u4e3a P2C \u662f\u968f\u673a\u83b7\u53d6\u4e24\u4e2a\u8282\u70b9\uff0c\u7136\u540e\u83b7\u5f97\u52a0\u6743\u503c\u7b97\u6cd5\u540e\u6700\u5927\u7684\u8282\u70b9\uff0c\u6240\u4ee5\u9700\u8981\u4e00\u4e2a\u52a0\u6743\u7b97\u6cd5\u7528\u6765\u5224\u65ad\u54ea\u4e2a\u8282\u70b9\u7684\u52a0\u6743\u503c\u66f4\u5927\u3002\u8d1f\u8f7d\u7387\u7684\u7b97\u6cd5\u5982\u4e0b\uff1a client_success / server_cpumath.Sqrt(latency+1)(inflight+1) \u4e0b\u9762\u7b80\u5355\u89e3\u91ca\u4e00\u4e0b\u5404\u53c2\u6570\u7684\u610f\u4e49\u3002 client_success : \u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u6210\u529f\u7387 server_cpu : \u901a\u8fc7\u6bcf\u6b21\u8bf7\u6c42 response \u7684 header \u8fd4\u56de\uff0c\u670d\u52a1\u7aef\u7684 CPU \u77ac\u65f6\u503c latency\uff1a\u5ba2\u6237\u7aef\u8ba1\u7b97\u7684\u5ef6\u65f6 inflight\uff1a \u6b63\u5728\u53d1\u9001\u4e2d\u7684\u8bf7\u6c42\u6570\u91cf \u5728\u8fd9\u91cc\u7684\u516c\u5f0f\u4e2d\uff0c \u6211\u4eec\u5e76\u6ca1\u6709\u52a0\u4e0a\u8282\u70b9\u7684\u9759\u6001\u6743\u91cd \u3002\u548c Envoy \u4e00\u6837\uff0c\u6211\u4eec\u53ea\u5728\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\u91c7\u7528\u6b64\u79cd\u7b97\u6cd5\uff0c \u56e0\u4e3aP2C \u7b97\u6cd5\u4f1a\u5bfc\u81f4\u540e\u7aef\u8282\u70b9\u7684\u5b9e\u9645\u6743\u91cd\u548c\u914d\u7f6e\u7684\u6743\u91cd\u76f8\u5dee\u6bd4\u8f83\u5927\uff0c\u7ed9\u8fd0\u7ef4\u4e2d\u7684\u4e34\u65f6\u8c03\u6574\u8282\u70b9\u6743\u91cd\u548c\u91d1\u4e1d\u96c0\u53d1\u5e03\u5e26\u6765\u4e00\u5b9a\u7684\u56f0\u6270 \u3002 2-4 EWMA \u8ba1\u7b97\u5ef6\u65f6\u548c\u5ba2\u6237\u7aef\u6210\u529f\u7387 \u53ef\u4ee5\u901a\u8fc7\u6ed1\u52a8\u7a97\u53e3\u7684\u65b9\u5f0f\u8ba1\u7b97 10s \u5185\u7684\u5ef6\u65f6\u5e73\u5747\u503c\u548c\u5ba2\u6237\u7aef\u6210\u529f\u7387\uff0c\u4f46\u8fd9\u79cd\u65b9\u5f0f\u6d88\u8017\u7684\u5185\u5b58\u6bd4\u8f83\u5927\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u9009\u62e9 EWMA\uff08Exponentially Weighted Averages\uff0c\u6307\u6570\u79fb\u52a8\u52a0\u6743\u5e73\u5747\uff09\u7684\u7b97\u6cd5\u6765\u8ba1\u7b97\u5ef6\u65f6\u548c\u5ba2\u6237\u7aef\u6210\u529f\u7387\u3002 Vt \u4ee3\u8868\u7b2c t \u6b21\u8bf7\u6c42\u65f6\u7684 EWMA \u503c\uff0cVt-1 \u4ee3\u8868\u7b2c t-1 \u6b21\u8bf7\u6c42\u7684 EWMA \u503c\uff1b \u03b8t \u4ee3\u8868\u7b2c t \u6b21\u8bf7\u6c42\u7684\u5b9e\u9645\u8017\u65f6\uff0c\u6240\u4ee5\u03b2\u8d8a\u5c0f\uff0cVt \u8d8a\u63a5\u8fd1\u672c\u6b21\u8bf7\u6c42\u8017\u65f6\u3002 \u5728\u5b9e\u9645\u4e2d\u03b2\u503c\u7684\u516c\u5f0f\uff1a \u03b2= math.Exp(float64(-td) / float64(tau)) \uff0c \u5176\u4e2d td \u4e3a\u5f53\u524d\u65f6\u95f4\u548c\u4e0a\u6b21\u54cd\u5e94\u540e\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee\uff0ctau \u4e3a\u8870\u51cf\u7cfb\u6570\u3002 2-5 \u8d1f\u8f7d\u5747\u8861\u4e2d\u7684\u5e38\u89c1\u95ee\u9898 2-5-1 \u4e3a\u4ec0\u4e48\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u4e2d\u6d41\u91cf\u4f1a\u4e0d\u5747\u8861\uff1f Nginx \u8fd9\u6837\u7684\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u6d88\u8017\u6bd4\u8f83\u5927\uff0c\u7406\u8bba\u4e0a\u4e00\u53f0\u9ad8\u914d\u7f6e\u7684\u670d\u52a1\u5668\u5927\u6982\u80fd\u627f\u53d7 10w \u7ea7\u522b QPS \u7684\u8d1f\u8f7d\uff0c\u8ba9\u6211\u4eec\u8fc7\u65e9\u5730\u9047\u5230\u4e86\u5355\u673a\u74f6\u9888\u3002 \u6240\u4ee5\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u901a\u5e38\u6211\u4eec\u4f1a\u9009\u53d6\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u4f46\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u6700\u5927\u7684\u95ee\u9898\u5c31\u662f\u6d41\u91cf\u4e0d\u5747\u8861\u3002 \u56e0\u4e3a\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u57fa\u4e8e\u8fde\u63a5\u505a\u8d1f\u8f7d\u5747\u8861\uff0c \u5f53\u6211\u4eec\u6458\u6389\u67d0\u4e00\u4e2a\u8282\u70b9\uff0c\u4e5f\u5c31\u662f\u628a\u67d0\u4e2a\u8282\u70b9\u7684\u6743\u91cd\u8bbe\u7f6e\u4e3a 0 \u7684\u65f6\u5019\uff0c\u7531\u4e8e\u8fde\u63a5\u8fd8\u662f\u4fdd\u6301\u7684\uff0c\u6d41\u91cf\u4f9d\u7136\u4f1a\u6253\u5230\u8fd9\u4e2a\u8282\u70b9 \uff0c\u6240\u4ee5\u4f7f\u7528\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u5f88\u591a\u65f6\u5019\u8981\u7b49\u5f85\u4e00\u6574\u5929\u624d\u80fd\u5c06\u8282\u70b9\u65e0\u635f\u5730\u6458\u6389\u3002\u8fd9\u5728\u5916\u7f51\u7f51\u5173\u7684\u6458\u53d6\u4e2d\u4e5f\u7279\u522b\u5e38\u89c1\u3002 \u4e5f\u6b63\u662f\u8fd9\u79cd\u57fa\u4e8e\u8fde\u63a5\u7684\u673a\u5236\uff0c\u5bfc\u81f4\u67d0\u4e9b\u8fde\u63a5\u8bf7\u6c42 QPS \u9ad8\u3001\u67d0\u4e9b\u8fde\u63a5\u8bf7\u6c42 QPS \u4f4e\u7684\u60c5\u51b5\u4e5f\u5f88\u5bb9\u6613\u51fa\u73b0\u3002 \u53e6\u5916\u5f53\u6211\u4eec\u505a\u670d\u52a1\u53d1\u5e03\u65f6\uff0c\u67d0\u4e2a\u8282\u70b9\u91cd\u542f\u540e\u4f1a\u51fa\u73b0\u6d41\u91cf\u5f88\u4f4e\u7684\u60c5\u51b5\uff0c\u4e5f\u662f\u56e0\u4e3a\u56db\u5c42\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u5df2\u7ecf\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u5efa\u7acb\u4e86\u8fde\u63a5\uff0c\u65b0\u52a0\u5165\u7684\u8282\u70b9\u5f80\u5f80\u9700\u8981\u8f83\u957f\u65f6\u95f4\u624d\u4f1a\u8d1f\u8f7d\u8d8b\u4e8e\u5747\u8861\u3002 2-5-2 \u8d1f\u8f7d\u5747\u8861\u540e\u5404\u8282\u70b9\u6d41\u91cf\u5747\u8861\uff0c\u540e\u7aef\u670d\u52a1\u7684\u8d1f\u8f7d\u5c31\u4e00\u5b9a\u4e00\u81f4\u5417\uff1f \u5b9e\u9645\u4e0a\uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u786c\u4ef6\u7684\u5dee\u5f02\uff0c\u7279\u522b\u662f\u865a\u62df\u673a\u5b58\u5728\u8d85\u5356\u7b49\u73b0\u8c61\uff0c\u5f88\u96be\u4fdd\u8bc1\u540c\u89c4\u683c\u7684\u670d\u52a1\u5668\u80fd\u591f\u5904\u7406\u540c\u6837\u7684 QPS \u91cf\u7ea7\uff0c\u6240\u4ee5\u540e\u7aef\u670d\u52a1\u5668\u7684\u8d1f\u8f7d\u5f88\u96be\u4e00\u81f4\uff0c \u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u6839\u636e\u5ef6\u65f6\u548c CPU \u60c5\u51b5\u7684\u4e00\u4e9b\u52a0\u6743\u7b56\u7565\u505a\u5904\u7406\u4e86\u3002 2-5-3 \u8282\u70b9\u4e0b\u7ebf\u540e\u5982\u4f55\u53ca\u65f6\u6458\u6389\u8282\u70b9\uff1f \u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u7b49\u5f85\u6ce8\u518c\u4e2d\u5fc3\u7684\u901a\u77e5\uff0c\u4f46\u56e0\u4e3a\u6ce8\u518c\u4e2d\u5fc3\u7684\u4e2d\u5fc3\u5316\u5f02\u6b65\u63a8\u9001\u673a\u5236\uff0c\u5f80\u5f80\u6536\u5230\u4fe1\u606f\u4e0d\u591f\u53ca\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7 upsteam \u8282\u70b9\u8fd4\u56de\u670d\u52a1\u5065\u5eb7\u68c0\u67e5\u5931\u8d25\u7684\u5934\u4fe1\u606f\uff0c\u8ba9\u5ba2\u6237\u7aef\u53ef\u4ee5\u5feb\u901f\u6458\u6389\u4e0d\u5065\u5eb7\u7684\u8282\u70b9\u3002","title":"\u7b2c\u4e09\u8282 \u8d1f\u8f7d\u5747\u8861\u5668"},{"location":"chap1/3chap1_load_balancer/#_1","text":"","title":"\u7b2c\u4e09\u8282 \u8d1f\u8f7d\u5747\u8861\u5668"},{"location":"chap1/3chap1_load_balancer/#1","text":"","title":"1\u3001\u670d\u52a1\u53d1\u73b0\u540e\u5982\u4f55\u5b9e\u73b0\u8282\u70b9\u4fdd\u62a4"},{"location":"chap1/3chap1_load_balancer/#1-1","text":"\u8d1f\u8f7d\u5747\u8861\uff08Load Balance\uff09\uff0c\u662f\u4e00\u79cd\u7f51\u7edc\u6d41\u91cf\u5206\u914d\u6280\u672f\uff0c\u7528\u4e8e\u89e3\u51b3\u5355\u53f0\u673a\u5668\u6027\u80fd\u51fa\u73b0\u74f6\u9888\u65f6\uff0c\u9700\u8981\u591a\u53f0\u673a\u5668\u5206\u644a\u5904\u7406\u6d41\u91cf\u7684\u60c5\u51b5 load \u5728\u4e2d\u6587\u91cc\u4e5f\u6709\u201c\u91cf\u201d\u7684\u610f\u601d\uff0c\u5728\u8fd9\u91cc\u53ef\u4ee5\u7406\u89e3\u4e3a\u673a\u5668\u7684\u5de5\u4f5c\u91cf\uff0c\u90a3\u4e48 Load Balance \u5c31\u662f\u8ba9\u6bcf\u53f0\u673a\u5668\u5e73\u644a\u5904\u7406\u7684\u5de5\u4f5c\u91cf\uff08\u8bf7\u6c42\u91cf\uff09\u3002 \u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u5b9e\u73b0\u65b9\u5f0f\u3002 \u786c\u4ef6\u8d1f\u8f7d\u5747\u8861 \uff1a\u6bd4\u8f83\u5e38\u89c1\u7684\u786c\u4ef6\u8d1f\u8f7d\u5747\u8861\u5668\u6709NetScaler\u3001F5\u3001Radware\uff0cArray \u7b49\uff0c\u7531\u4e13\u4e1a\u7684\u786c\u4ef6\u516c\u53f8\u751f\u4ea7\uff0c\u4e00\u822c\u5728\u4e92\u8054\u7f51\u516c\u53f8\u7684\u65e9\u671f\u9636\u6bb5\u8fdb\u884c\u4f7f\u7528\uff0c\u4f46\u662f\u7531\u4e8e\u4ef7\u683c\u6602\u8d35\uff0c\u73b0\u5728\u4e92\u8054\u7f51\u516c\u53f8\u5f88\u5c11\u4f7f\u7528\u4e86\u3002 DNS \u8d1f\u8f7d\u5747\u8861 \uff1a \u901a\u8fc7\u57df\u540d\u8fd4\u56de\u540e\u7aef\u8282\u70b9 IP \u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u540e\u7aef IP \u8bbe\u7f6e\u6743\u91cd \u3002\u56e0\u4e3a DNS \u89e3\u6790\u5b58\u5728\u7f13\u5b58\u5ef6\u65f6\u7684\u95ee\u9898\uff0c\u6240\u4ee5\u5728\u5185\u7f51\u8f83\u5c11\u4f7f\u7528\u3002\u4f46\u5bf9\u4e8e\u5927\u6d41\u91cf\u7684 Web \u548c App\uff0c\u5165\u53e3\u5c42\u4e00\u822c\u4f1a\u4f7f\u7528\u6b64\u79cd\u65b9\u5f0f\u505a\u8d1f\u8f7d\u5747\u8861\uff0c\u540e\u7aef\u591a\u7ec4\u56db\u5c42 LB \u505a\u8d1f\u8f7d\u5747\u8861\u3002 \u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861 \uff1a\u6bd4\u8f83\u6d41\u884c\u7684\u662f Nginx\u3001HAproxy\u3001LVS \u7b49\uff0c \u50cf LVS \u662f\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c\u6027\u80fd\u8f83\u9ad8\uff1b Nginx\u3001HAproxy \u4e3b\u8981\u7528\u4e8e\u4e03\u5c42\u7684\u8d1f\u8f7d\u5747\u8861 \uff0c\u6709\u8f83\u591a\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u540c\u65f6\u6d41\u91cf\u76f8\u5bf9\u4e8e\u56db\u5c42\u4f1a\u66f4\u52a0\u5747\u8861\u3002 \u50cf\u6211\u4eec\u5e38\u7528\u7684\u4e91\u5382\u5546\uff0c\u6bd4\u5982\u963f\u91cc\u4e91\u7684 SLB \u540c\u65f6\u63d0\u4f9b\u4e86\u57fa\u4e8e LVS \u7684\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u548c\u57fa\u4e8e\u4e03\u5c42\u7684 Tengine \u8d1f\u8f7d\u5747\u8861\u5668\u4f9b\u5927\u5bb6\u9009\u62e9\u3002 \u7a0b\u5e8f\u5185\u8d1f\u8f7d\u5747\u8861 \uff1a\u4e25\u683c\u6765\u8bf4\u5b83\u5c5e\u4e8e\u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861\u7684\u4e00\u79cd\uff0c\u53ea\u662f \u628a\u8d1f\u8f7d\u5747\u8861\u7684\u7b56\u7565\u653e\u5728\u4e86\u670d\u52a1\u5185\u90e8\u3002 \u5bf9\u4e8e\u5fae\u670d\u52a1\u67b6\u6784\u6765\u8bf4\uff0c\u670d\u52a1\u5185\u90e8\u505a\u8d1f\u8f7d\u5747\u8861\u66f4\u5408\u9002\uff0c\u56e0\u4e3a\u5fae\u670d\u52a1\u5c31\u662f\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u53d1\u73b0\u670d\u52a1\u8282\u70b9\u7684\uff0c\u5728\u7a0b\u5e8f\u5185\u90e8\u9009\u53d6\u5408\u9002\u7684\u6d41\u91cf\u8282\u70b9\u81ea\u7136\u66f4\u52a0\u5408\u7406\u3002 Serivce Mesh \u8d1f\u8f7d\u5747\u8861 \uff1a\u5229\u7528 sidecar \u505a\u7a0b\u5e8f\u5185\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5c5e\u4e8e\u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861\u7684\u4e00\u79cd\uff0c\u76f8\u6bd4 SDK \u5185\u8d1f\u8f7d\u5747\u8861\uff0c\u53ef\u4ee5\u968f\u65f6\u66f4\u65b0\u5404\u79cd\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3002","title":"1-1 \u670d\u52a1\u53d1\u73b0\u540e\u5982\u4f55\u5b9e\u73b0\u8282\u70b9\u4fdd\u62a4"},{"location":"chap1/3chap1_load_balancer/#1-2","text":"Round Robin \uff1a\u7b80\u5355\u8f6e\u8be2\u7b97\u6cd5\uff0c\u9002\u5408\u540e\u7aef\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\u3002\u5e94\u7528\u573a\u666f\u8f83\u5c11\uff0c\u4f46\u7b97\u6cd5\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a O(1) \uff0c \u53ef\u4ee5\u5728\u9884\u5148\u5224\u65ad\u540e\u7aef\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528\u3002 Weighted Round Robin \uff1a\u901a\u8fc7\u53d6\u6700\u5927\u516c\u7ea6\u6570\u7684\u65b9\u5f0f\uff0c\u505a\u7b80\u5355\u8f6e\u8be2\u3002\u56e0\u4e3a\u6743\u91cd\u591a\u7684\u8282\u70b9\u4f1a\u6bd4\u8f83\u96c6\u4e2d\uff0cNginx\u53d1\u660e\u4e86\u4e00\u79cd\u5e73\u6ed1\u52a0\u6743\u8f6e\u8be2\uff0c\u901a\u8fc7\u7b97\u6cd5\u5c06\u6743\u91cd\u5927\u7684\u8282\u70b9\u5206\u6563\u5f00\uff0c\u4f46\u5728\u670d\u52a1\u91cd\u542f\u65f6\u4f9d\u7136\u4f1a\u51fa\u73b0\u8282\u70b9\u8bf7\u6c42\u8f83\u4e3a\u96c6\u4e2d\u7684\u60c5\u51b5\u3002 Weighted Random \uff1a\u901a\u8fc7\u968f\u673a\u7684\u65b9\u5f0f\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u914d\u5408\u4e8c\u5206\u67e5\u627e\uff0c\u53ef\u4ee5\u5c06\u65f6\u95f4\u590d\u6742\u5ea6\u964d\u5230 O(log^n) \u3002\u8be5\u7b97\u6cd5\u5bf9\u4e8e\u540e\u7aef\u8282\u70b9\u975e\u5e38\u5747\u8861\uff0c\u4e0d\u4f1a\u51fa\u73b0\u52a0\u6743\u8f6e\u8be2\u5bfc\u81f4\u7684\u91cd\u542f\u65f6\u8282\u70b9\u8bf7\u6c42\u8f83\u4e3a\u96c6\u4e2d\u7684\u60c5\u51b5\u3002 Two Random Choices \uff1a\u76ee\u524d\u6bd4\u8f83\u6d41\u884c\u7684\u7b97\u6cd5\uff0c\u9002\u5408\u540e\u7aef\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\uff0c \u901a\u8fc7\u4e24\u6b21\u968f\u673a\u7b97\u6cd5\uff0c\u83b7\u53d6\u5230\u4e24\u4e2a\u8282\u70b9\uff0c\u7136\u540e\u5bf9\u6bd4\u8282\u70b9\u7684 CPU \u8d1f\u8f7d\uff0c\u5ef6\u65f6\u60c5\u51b5\u7b49\u4fe1\u606f\uff0c\u83b7\u53d6\u4e00\u4e2a\u6700\u4f18\u7684\u8282\u70b9\uff0c\u597d\u5904\u662f\u540e\u7aef\u8282\u70b9\u7684 CPU \u6216\u8005\u5ef6\u65f6\u4f1a\u6bd4\u8f83\u5747\u8861 \uff0c\u56e0\u4e3a\u5206\u533a\u548c\u865a\u62df\u673a\u786c\u4ef6\u914d\u7f6e\u7684\u539f\u56e0\uff0c\u6b64\u79cd\u505a\u6cd5\u53ef\u4ee5\u52a8\u6001\u8c03\u8282\u540e\u7aef\u8282\u70b9\u8d1f\u8f7d\uff0c\u5728\u751f\u4ea7\u4e2d\u662f\u975e\u5e38\u597d\u7684\u9009\u62e9\u3002 Sticky Session\uff08\u4f1a\u8bdd\u4fdd\u6301\uff09 \uff1a\u6839\u636e\u5ba2\u6237\u7aef IP \u6216\u8005 Cookie \u8fdb\u884c\u4f1a\u8bdd\u4fdd\u6301\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u540c\u4e00\u4e2a\u5ba2\u6237\u7aef\uff0c\u6bcf\u6b21\u9009\u53d6\u7684\u540e\u7aef\u8282\u70b9 IP \u4fdd\u6301\u4e00\u81f4\uff0c\u4e3b\u8981\u662f\u7528\u4e8e\u767b\u5f55\u9a8c\u8bc1\u7684\u4f1a\u8bdd\u4fdd\u6301\u3002 \u5b9e\u9645\u4e0a\u6b64\u79cd\u7b97\u6cd5\u8ba9\u670d\u52a1\u53d8\u6210\u4e86\u6709\u72b6\u6001\u670d\u52a1\uff0c\u53e6\u5916\u5bf9\u4e8e\u540e\u7aef\u8d1f\u8f7d\u4e5f\u4f1a\u4e0d\u5747\u8861\uff0c\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u5df2\u7ecf\u8f83\u5c11\u4f7f\u7528 \u3002\u5982\u679c\u60f3\u8981\u8fdb\u884c Session \u7684\u4fdd\u6301\uff0c\u5927\u591a\u662f\u5c06 Session \u5b58\u50a8\u5728\u5916\u90e8\u5b58\u50a8\u4e2d\uff0c\u6bd4\u5982 Redis \u7b49\u3002","title":"1-2 \u5e38\u7528\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5"},{"location":"chap1/3chap1_load_balancer/#1-3","text":"","title":"1-3 \u670d\u52a1\u53d1\u73b0\u540e\u7684\u8282\u70b9\u4fdd\u62a4"},{"location":"chap1/3chap1_load_balancer/#1-3-1","text":"\u53d7\u6ce8\u518c\u4e2d\u5fc3\u7684\u7f51\u7edc\u5206\u533a\u6545\u969c\u7b49\u539f\u56e0\u5f71\u54cd\uff0c \u5728\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u8fdb\u884c\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5 \uff0c\u662f\u907f\u514d\u6b64\u7c7b\u60c5\u51b5\u53d1\u751f\u7684\u6700\u4f73\u6a21\u5f0f\uff0c\u4f46\u957f\u65f6\u95f4\u7684\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u4f1a\u4ea7\u751f\u5927\u91cf\u65e0\u7528\u7684 ping \u64cd\u4f5c\uff0c\u9020\u6210\u4e0d\u5fc5\u8981\u7684\u673a\u5668\u8d1f\u8f7d\u635f\u5931\u3002 \u6240\u4ee5\u5728\u5b9e\u8df5\u4e2d\uff0c\u5efa\u8bae\u9009\u62e9\u83b7\u53d6\u8fc7\u5c11\u7684\u8282\u70b9\u65f6\u624d\u89e6\u53d1\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6a21\u5f0f \u3002 \u5f53\u83b7\u53d6\u8282\u70b9\u8fc7\u5c11\u3001\u8fdb\u5165\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u7684\u6a21\u5f0f\u65f6\u4f1a\u89e6\u53d1\u5bf9\u540e\u7aef\u8282\u70b9\u7684 ping \u64cd\u4f5c\uff0c\u8fd9\u4e2a\u8fc7\u5c11\u7684\u9608\u503c\u53ef\u4ee5\u6839\u636e\u516c\u53f8\u8d1f\u8f7d\u60c5\u51b5\u786e\u5b9a\u3002\u6bd4\u5982\u5728\u5b9e\u9645\u64cd\u4f5c\u4e2d\uff0c\u5982\u679c\u673a\u5668\u8d1f\u8f7d\u957f\u671f\u5904\u4e8e\u6bd4\u8f83\u9ad8\u7684\u6c34\u4f4d\uff0c\u4f60\u53ef\u4ee5\u91c7\u7528\u4e00\u4e2a\u6bd4\u8f83\u4fdd\u5b88\u7684\u6570\u503c\uff0c\u6bd4\u5982\u5c0f\u4e8e 80% \u7684\u65f6\u5019\u89e6\u53d1\u3002 \u4e3a\u4e86\u80fd\u591f\u4fdd\u8bc1\u4e24\u53f0\u673a\u5668\u81f3\u5c11\u80fd\u591f\u4e0b\u6389\u4e00\u53f0\uff0c\u91c7\u7528\u4e86 (currentNodeNum+1)/nodeCount < 80% \u4ee5\u4fdd\u8bc1\u81f3\u5c11\u4e0b\u6389\u4e00\u4e2a\u8282\u70b9\u3002\u5176\u4e2d nodeCount \u4e3a 15 \u5206\u949f\u524d\u7684\u670d\u52a1\u8282\u70b9\u603b\u6570\uff0c\u5f53\u7136\u8fd9\u6837\u662f\u4e00\u4e2a\u7ecf\u9a8c\u503c\uff0c\u4f60\u4e5f\u53ef\u4ee5\u6839\u636e\u516c\u53f8\u7684\u5b9e\u9645\u60c5\u51b5\u9002\u5f53\u8c03\u6574\u3002 \u5728\u5bb9\u5668\u73af\u5883\u4e2d\uff0c\u6269\u7f29\u5bb9\u65f6\u53ef\u80fd\u4f1a\u89e6\u53d1\u8282\u70b9\u7684\u81ea\u6211\u4fdd\u62a4\u6a21\u5f0f\uff0c\u9020\u6210\u4e00\u5b9a\u7684\u77ed\u65f6\u95f4\u6d41\u91cf\u635f\u5931\uff0c\u4f46\u76f8\u5bf9\u4e8e\u56e0\u4e3a\u6d41\u91cf\u6253\u5230\u4e86\u9519\u8bef\u7684\u8282\u70b9\u4e0a\u5f15\u53d1\u7684\u96ea\u5d29\uff0c\u6211\u8ba4\u4e3a\u6b64\u79cd\u60c5\u51b5\u8fd8\u662f\u53ef\u4ee5\u63a5\u53d7\u7684\u3002","title":"1-3-1 \u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5"},{"location":"chap1/3chap1_load_balancer/#1-3-2","text":"\u4f9d\u636e\u5065\u5eb7\u68c0\u67e5\u7684\u7ed3\u679c\u5224\u65ad\u540e\u7aef\u8282\u70b9\u662f\u5426\u6b63\u5e38\uff0c\u8fd9\u79cd\u65b9\u5f0f\u867d\u7136\u53ef\u4ee5\u4fdd\u8bc1\u7f51\u7edc\u5206\u533a\u5f02\u5e38\u60c5\u51b5\u4e0b\u8282\u70b9\u95f4\u7684\u8fde\u901a\u6027 \u4f46\u5982\u679c\u540e\u7aef\u8282\u70b9\u5927\u91cf\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709\u5c11\u6570\u8282\u70b9\u80fd\u591f\u901a\u8fc7\u5065\u5eb7\u68c0\u67e5\u3002\u6b64\u79cd\u60c5\u51b5\u4e0b\uff0c\u5c11\u91cf\u7684\u8282\u70b9\u663e\u7136\u662f\u65e0\u6cd5\u63d0\u4f9b\u6b63\u5e38\u670d\u52a1\u7684\u3002 \u56de\u6eda: \u56e0\u4e3a\u670d\u52a1\u53d1\u7248\u5bfc\u81f4\u7684\u670d\u52a1\u8282\u70b9\u591a\u6570\u6216\u8005\u5168\u90e8\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\u4e5f\u5f88\u5bb9\u6613\u51fa\u73b0\uff0c\u6b64\u65f6\u4f60\u7684\u9996\u9009\u64cd\u4f5c\u4e00\u5b9a\u662f\u56de\u6eda\u3002 \u56de\u6eda\u671f\u95f4\uff0c\u8282\u70b9\u7684\u53ef\u7528\u662f\u6709\u5148\u540e\u987a\u5e8f\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u5b8c\u5168\u4fe1\u4efb\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u7684\u7ed3\u679c\uff0c\u4f1a\u5bfc\u81f4\u6d41\u91cf\u5168\u90e8\u8def\u7531\u5230\u65b0\u56de\u6eda\u6210\u529f\u7684\u8282\u70b9\u4e0a\uff0c\u9020\u6210\u65b0\u542f\u52a8\u7684\u8282\u70b9\u4f1a\u7acb\u5373\u88ab\u6253\u6302 \u3002 \u89e3\u51b3\u4e0a\u9762\u4e24\u79cd\u95ee\u9898\u7684\u529e\u6cd5\u4e00\u79cd\u662f\u670d\u52a1\u6cbb\u7406\u4e2d\u7684\u9650\u6d41 \uff0c \u53e6\u5916\u4e00\u79cd\u529e\u6cd5\u5c31\u662f\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u7684\u6050\u614c\u9608\u503c \u3002 \u5f53\u5065\u5eb7\u68c0\u67e5\u540e\u8282\u70b9\u4f9d\u7136\u5c11\u4e8e\u8bbe\u5b9a\u7684\u9608\u503c\uff0c\u5219\u5ffd\u7565\u5065\u5eb7\u68c0\u67e5\u7ed3\u679c\uff0c\u5c06\u6d41\u91cf\u8def\u7531\u5230\u5168\u90e8\u7684\u8282\u70b9\uff0c\u5305\u62ec\u4e0d\u5065\u5eb7\u7684\u8282\u70b9\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u8d1f\u8f7d\u7684\u5747\u8861\uff0c\u4e5f\u4e0d\u4f1a\u628a\u6d41\u91cf\u96c6\u4e2d\u5230\u8fc7\u5c11\u7684\u8282\u70b9\uff0c\u5bfc\u81f4\u670d\u52a1\u5904\u4e8e\u201c\u96ea\u5d29\u201d\u7684\u72b6\u6001\u3002 \u8fd9\u4e2a\u9608\u503c\u7684\u8bbe\u7f6e\u4e5f\u662f\u6bd4\u8f83\u8bb2\u7a76\u7684\uff0c\u867d\u7136 Envoy \u5b98\u65b9\u9ed8\u8ba4\u503c\u662f 50%\uff0c\u4f46\u6211\u89c9\u5f97\u8fd9\u5e76\u4e0d\u662f\u6700\u5408\u9002\u7684\u8bbe\u7f6e\uff1a 50% \u7684\u9608\u503c\u592a\u8fc7\u6fc0\u8fdb\uff0c\u5f88\u5bb9\u6613\u8fbe\u5230\u89e6\u53d1\u6761\u4ef6 \u3002 \u800c\u5f53\u4f60\u7406\u89e3\u4e86\u8fd9\u4e2a\u9608\u503c\u7684\u4f5c\u7528\uff0c\u5c31\u4f1a\u660e\u767d\u5f53\u7ebf\u4e0a\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u8282\u70b9\u662f\u4f1a\u8d8b\u4e8e\u5168\u90e8\u4e0d\u53ef\u7528\u7684\uff0c\u6240\u4ee5\u7ebf\u4e0a\u6211\u628a\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u4e3a 10%\u3002 \u56e0\u4e3a\u968f\u7740\u6545\u969c\u8282\u70b9\u53d8\u591a\uff0c\u5269\u4e0b\u7684\u5c11\u91cf\u8282\u70b9\u4e5f\u625b\u4e0d\u4f4f\u8c03\u7528\u65b9\u7684\u6240\u6709\u6d41\u91cf\uff0c\u5269\u4f59\u7684\u8282\u70b9\u4f1a\u6162\u6162\u8d8b\u8fd1\u6211\u4eec\u8bbe\u7f6e\u7684\u9608\u503c\uff0c\u4e00\u6837\u53ef\u4ee5\u8fbe\u5230\u6050\u614c\u9608\u503c\u8bbe\u7f6e\u7684\u76ee\u7684 \uff0c\u800c\u4e14\u4e5f\u4e0d\u4f1a\u56e0\u4e3a\u53ea\u662f\u5c11\u91cf\u8282\u70b9\u6545\u969c\uff0c\u89e6\u53d1\u9608\u503c\u5bfc\u81f4\u7684\u9519\u8bef\u6d41\u91cf\u3002","title":"1-3-2 \u6050\u614c\u9608\u503c"},{"location":"chap1/3chap1_load_balancer/#1-3-3","text":"\u6709\u4e9b\u65f6\u5019\u5355\u7eaf\u9760\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u4f9d\u7136\u65e0\u6cd5\u907f\u514d\u9519\u8bef\u7684\u6d41\u91cf\uff0c\u6bd5\u7adf\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u53ea\u662f\u901a\u8fc7\u7279\u5b9a\u7684 ping \u63a5\u53e3\u6216\u8005 TCP \u63a2\u6d3b\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5\u7684\uff0c\u8fd9\u4e9b\u5e76\u4e0d\u662f\u670d\u52a1\u7684\u771f\u5b9e\u6d41\u91cf\uff0c\u7279\u522b\u662f\u5728\u4f7f\u7528 TCP \u63a2\u6d3b\u7684\u65f6\u5019\uff0c\u66f4\u5bb9\u6613\u51fa\u73b0\u95ee\u9898\u3002 \u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u88ab\u52a8\u5065\u5eb7\u68c0\u67e5\u4e86\uff0c\u901a\u8fc7\u771f\u5b9e\u6d41\u91cf\u6765\u5224\u65ad\u8282\u70b9\u662f\u5426\u6b63\u5e38\uff0c\u4e5f\u5c31\u662f\u5229\u7528\u8282\u70b9\u7194\u65ad\u5668\u3002 \u548c\u670d\u52a1\u7ea7\u522b\u7684\u7194\u65ad\u5668\u4e00\u6837\uff0c\u8282\u70b9\u7194\u65ad\u5668\u4e5f\u662f\u901a\u8fc7\u72b6\u6001\u7801\u5224\u65ad\u670d\u52a1\u662f\u5426\u6b63\u5e38\uff0c\u5047\u5982\u540e\u7aef\u662f HTTP \u670d\u52a1\uff0c\u6211\u4eec\u901a\u5e38\u4f1a\u5c06 499 \u4ee5\u4e0a\u7684\u9519\u8bef\u7801\u8ba4\u4e3a\u662f\u540e\u7aef\u670d\u52a1\u9519\u8bef\u3002 \u901a\u8fc7\u8bb0\u5f55 10s \u7684\u6ed1\u52a8\u7a97\u53e3\u5185\u7684\u9519\u8bef\u7801\u6bd4\u4f8b\uff0c\u5f53\u540e\u7aef\u8282\u70b9\u7684\u9519\u8bef\u6bd4\u4f8b\u8fbe\u5230\u6211\u4eec\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\uff0c\u4fbf\u5c06\u540e\u7aef\u8282\u70b9\u4ece\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u79fb\u9664\u3002\u5f53\u7136\u4f60\u4e5f\u8981\u8003\u8651\u4e0d\u80fd\u6458\u9664\u8fc7\u591a\u7684\u8282\u70b9\uff0c\u6240\u4ee5\u7194\u65ad\u5668\u9700\u8981\u8bbe\u7f6e\u548c\u81ea\u6211\u4fdd\u62a4\u76f8\u540c\u7684\u89e6\u53d1\u9608\u503c\uff0c\u4ee5\u907f\u514d\u8fc7\u591a\u7684\u8282\u70b9\u88ab\u79fb\u51fa\u5f15\u53d1\u201c\u96ea\u5d29\u201d\u3002","title":"1-3-3 \u88ab\u52a8\u5065\u5eb7\u68c0\u67e5"},{"location":"chap1/3chap1_load_balancer/#2","text":"","title":"2\u3001\u5982\u4f55\u5b9e\u73b0\u67d3\u8272\u548c\u5730\u57df\u4f18\u5148"},{"location":"chap1/3chap1_load_balancer/#2-1","text":"\u8282\u70b9\u67d3\u8272\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u628a\u67d0\u4e00\u7c7b\u8282\u70b9\u6253\u4e0a\u76f8\u540c\u7684\u6807\u7b7e\uff0c\u7136\u540e\u8d1f\u8f7d\u5747\u8861\u5668\u6839\u636e\u6807\u7b7e\u6765\u5206\u53d1\u6d41\u91cf\u3002 \u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u67d3\u8272\u6709\u5f88\u591a\u4f5c\u7528\uff0c\u6bd4\u5982\u91d1\u4e1d\u96c0\u53d1\u5e03\u3001A/B\u6d4b\u8bd5\u3001\u6545\u969c\u6f14\u7ec3\u3001\u6d41\u91cf\u533a\u5206\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u67d3\u8272\u6765\u5b9e\u73b0 \u3002","title":"2-1 \u8282\u70b9\u67d3\u8272"},{"location":"chap1/3chap1_load_balancer/#2-1-1","text":"\u9996\u5148\u6211\u4eec\u9700\u8981\u5728\u7f51\u5173\u5c42\uff0c\u6839\u636e header \u4fe1\u606f\u6216\u8005\u6743\u91cd\u5bf9\u6d41\u91cf\u8fdb\u884c\u67d3\u8272 \u3002 \u6bd4\u5982\u5728\u5ba2\u6237\u7aef\u7684\u67d0\u4e9b\u7248\u672c\u4e2d\u5199\u5165\u67d3\u8272\u7684 header\uff0c\u5c31\u50cf X-TAG=canary \uff1b\u4e5f\u53ef\u4ee5\u5728\u7f51\u5173\u5c42\u5bf9\u6d41\u91cf\u6309\u7167\u6bd4\u4f8b\u5206\u6d41\uff0c\u6bd4\u5982 1% \u7684\u6d41\u91cf\u6253\u4e0a\u91d1\u4e1d\u96c0\u7684\u6807\u7b7e\u8fdb\u884c\u7070\u5ea6\u6d4b\u8bd5\u3002 \u5728\u6ce8\u518c\u4e2d\u5fc3\u4e5f\u9700\u8981\u5199\u5165\u5bf9\u5e94\u7684 MetaData \u4fe1\u606f\uff0c\u7528\u4e8e\u5728\u8d1f\u8f7d\u5747\u8861\u5c42\u8fdb\u884c\u6d41\u91cf\u7684\u8fc7\u6ee4 \u6bd4\u5982\u5728\u6ce8\u518c\u4e2d\u5fc3\u7684 MetaData \u4fe1\u606f\u4e2d\u5b9a\u4e49 lb_tags \u7684\u5b57\u6bb5\uff0c\u6570\u636e\u4e3a [stage:canary, v:1.2] \uff0c\u5728 LB \u8fdb\u884c\u5339\u914d\u7684\u65f6\u5019\uff0c\u5e26\u6709\u91d1\u4e1d\u96c0 header \u7684\u8bf7\u6c42\uff0c\u5c31\u4f1a\u8bf7\u6c42\u5230 lb_tags \u5305\u542b canary \u7684\u8282\u70b9\u4e0a\u9762\u3002 \u53e6\u5916\u6211\u4eec\u4e5f\u9700\u8981\u8003\u8651\u6ca1\u6709\u5339\u914d\u5230\u5bf9\u5e94\u8282\u70b9\u65f6\u7684\u964d\u7ea7\u7b56\u7565\uff0c\u53c2\u8003 Envoy \u4e2d\u7684\u914d\u7f6e\uff0c\u4e00\u822c\u6709\u5982\u4e0b\u51e0\u79cd\uff1a \u6bd4\u5982\u5728\u91d1\u4e1d\u96c0\u8fd9\u79cd\u7b56\u7565\u4e2d\uff0c\u6211\u4eec\u5c06\u6807\u6ce8 canary \u7684 tag \u7684\u8282\u70b9\uff0c\u914d\u7f6e DEFAULT_SUBSET \uff0c\u8fd9\u6837\u5982\u679c\u91d1\u4e1d\u96c0\u7684\u8282\u70b9\u4e0d\u5b58\u5728\u7684\u8bdd\uff0c\u5c31\u4f1a\u8bbf\u95ee prod \u7684\u8282\u70b9\uff0c \u5c06\u6807\u6ce8 prod \u7684\u8282\u70b9\u914d\u7f6e NO_ENDPOINT \uff0c\u8fd9\u6837 prod \u7684\u8282\u70b9\u5c31\u4e0d\u4f1a\u6709\u67d3\u8272\u7684\u964d\u7ea7\u7b56\u7565\uff0c\u800c\u662f\u4f7f\u7528\u6211\u4eec\u4e4b\u524d\u914d\u7f6e\u7684\u81ea\u6211\u4fdd\u62a4\u7b56\u7565\u4e86\u3002 \u67d3\u8272\u662f\u8d1f\u8f7d\u5747\u8861\u5668\u5229\u7528\u8282\u70b9\u4e0a\u7684\u6807\u7b7e\u8fdb\u884c\u6d41\u91cf\u8def\u7531\uff0c\u540c\u6837\u5730\u57df\u4f18\u5148\u8bbf\u95ee\u4e5f\u9700\u8981\u5229\u7528\u5728\u8282\u70b9\u4e0a\u6253\u4e0a\u5730\u57df\u6807\u7b7e\uff0c\u8ba9\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u5730\u57df\u4f18\u5148\u3002","title":"2-1-1 \u5982\u4f55\u64cd\u4f5c\u5462"},{"location":"chap1/3chap1_load_balancer/#2-2","text":"","title":"2-2 \u5730\u57df\u4f18\u5148\u8bbf\u95ee"},{"location":"chap1/3chap1_load_balancer/#2-2-1","text":"\u5728 Envoy \u4e2d\u4e5f\u88ab\u79f0\u4e3a zone \u611f\u77e5\u8def\u7531 \u59cb\u53d1\u96c6\u7fa4\uff1a\u8c03\u7528\u65b9\uff0c\u4e5f\u5c31\u662f Client \u7aef\u7684\u670d\u52a1\u8282\u70b9\u96c6\u5408 \u3002 \u4e0a\u6e38\u96c6\u7fa4\uff1a\u88ab\u8c03\u7528\u65b9\uff0c\u4e5f\u5c31\u662f Server \u7aef\u7684\u670d\u52a1\u8282\u70b9\u96c6\u5408 \u3002 zone: \u533a\u57df\uff08Region\uff09\u548c\u53ef\u7528\u533a\uff08Availability Zone\uff0cAZ \uff09 zone \u611f\u77e5\u8def\u7531\uff0c\u4f1a\u6839\u636e\u59cb\u53d1\u96c6\u7fa4\u7684\u6240\u5728\u533a\u8282\u70b9\u6570\u91cf\u548c\u76ee\u6807\u96c6\u7fa4\u7684\u6240\u5728\u533a\u8282\u70b9\u6570\u91cf\uff0c\u52a8\u6001\u8ba1\u7b97\u51fa\u4e00\u4e2a\u5bf9\u5e94\u7684\u6bd4\u4f8b\u3002","title":"2-2-1 \u5730\u57df\u4f18\u5148\u8bbf\u95ee"},{"location":"chap1/3chap1_load_balancer/#2-2-2","text":"\u8fd9\u79cd\u7b97\u6cd5\u6700\u5927\u7684\u95ee\u9898\uff0c\u662f\u5f88\u96be\u4fdd\u8bc1\u59cb\u53d1\u96c6\u7fa4\u548c\u4e0a\u6e38\u96c6\u7fa4\u7684\u6240\u5728\u533a\u662f\u4e00\u4e00\u5bf9\u5e94\u4e14\u6bd4\u4f8b\u76f8\u540c\u7684\uff0c \u6bd4\u5982\u59cb\u53d1\u96c6\u7fa4 A \u6240\u5728\u7684 c \u533a\u662f 50%\uff0c\u800c\u4e0a\u6e38\u96c6\u7fa4 B \u6240\u5728\u7684 c \u533a\u53ea\u6709 20%\uff0c\u8fd9\u6837\u5982\u679c\u53ea\u662f\u7b80\u5355\u7684\u9759\u6001\u52a0\u6743\uff0c\u5c31\u4f1a\u5bfc\u81f4\u59cb\u53d1\u96c6\u7fa4 c \u533a\u7684\u6d41\u91cf\u5c06\u4e0a\u6e38\u96c6\u7fa4 c \u533a\u6253\u6302\u3002 \u5b9e\u9645\u4e0a\u5728\u5fae\u670d\u52a1\u6846\u67b6 Dubbo \u4e2d\u4e5f\u91c7\u7528\u4e86\u7c7b\u4f3c\u7684\u7b97\u6cd5\uff0c \u4f46\u8fd9\u79cd\u7b97\u6cd5\u5bf9\u8fd0\u7ef4\u73af\u5883\u8981\u6c42\u6bd4\u8f83\u9ad8\uff0c\u5e76\u4e0d\u9002\u5408\u7528\u5728\u771f\u5b9e\u7684\u73af\u5883\u4e2d\u3002 zone \u611f\u77e5\u8def\u7531\u89e3\u51b3\u7684\u6700\u5927\u7684\u95ee\u9898\uff0c \u5c31\u662f\u5bf9\u8fd0\u7ef4\u73af\u5883\u7684\u4f9d\u8d56 \u3002\u901a\u8fc7\u52a8\u6001\u8ba1\u7b97\u4e0a\u4e0b\u6e38\u7684\u8282\u70b9\u6570\uff0c\u5c06\u6d41\u91cf\u6b63\u786e\u5730\u8def\u7531\u5230\u5404\u4e2a\u5206\u533a\u3002\u867d\u7136\u4f1a\u4ea7\u751f\u4e00\u4e9b\u56e0\u73af\u5883\u5e26\u6765\u7684\u5ef6\u65f6\u95ee\u9898\uff0c\u4f46\u907f\u514d\u4e86\u6253\u6302\u4e0a\u6e38\u96c6\u7fa4\u7684\u98ce\u9669\u3002 \u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\uff1a 1.\u59cb\u53d1\u96c6\u7fa4\u7684\u672c\u5730 zone \u8282\u70b9\u6570\u91cf\u5c0f\u4e8e\u6216\u8005\u7b49\u4e8e\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u8282\u70b9\u6570\u91cf \u53ea\u9700\u5c06\u6d41\u91cf\u5168\u90e8\u6253\u5230\u5bf9\u5e94\u7684\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u7684\u8282\u70b9\u5c31\u53ef\u4ee5\u4e86\uff0c\u53e6\u5916\u8ba1\u7b97\u51fa\u7684\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728\u533a\u5269\u4f59\u7684\u6d41\u91cf\u6bd4\u4f8b\uff0c\u7528\u4e8e\u670d\u52a1\u5176\u4ed6\u6240\u5728\u533a\u96c6\u7fa4\u7684\u6d41\u91cf\u3002 2. \u59cb\u53d1\u96c6\u7fa4\u7684\u672c\u5730 zone \u8282\u70b9\u6570\u91cf\u5927\u4e8e\u6216\u8005\u7b49\u4e8e\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u8282\u70b9\u6570\u91cf \u8fd9\u4e2a\u65f6\u5019\u5c31\u6ca1\u529e\u6cd5\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728 zone \u4e86\uff0c\u56e0\u4e3a\u6b64\u79cd\u505a\u6cd5\u5f88\u660e\u663e\u4f1a\u5bfc\u81f4\u4e0a\u6e38\u96c6\u7fa4\u6240\u5728\u533a\u7684\u6d41\u91cf\u4e0d\u5747\u8861\u3002\u8fd9\u65f6\u6211\u4eec\u5c31\u9700\u8981\u5c06\u5269\u4f59\u7684\u6d41\u91cf\u8def\u7531\u5230\u5176\u4ed6 zone \u7684\u4e0a\u6e38\u96c6\u7fa4\u4e86\u3002 zone \u611f\u77e5\u8def\u7531\u5bf9\u4e8e\u964d\u4f4e\u56e0\u4e3a\u8de8\u5730\u57df\u8de8\u533a\u7684\u8bf7\u6c42\u5f15\u8d77\u7684\u5ef6\u65f6\u589e\u9ad8\u95ee\u9898\uff0c\u6709\u660e\u663e\u7684\u6548\u679c\uff0c\u4f46\u4f9d\u8d56\u4e8e\u83b7\u53d6\u672c\u5730\u6240\u5728 zone \u7684\u59cb\u53d1\u96c6\u7fa4\u8282\u70b9\u6570\u91cf\u3002 \u5728\u5206\u5e03\u5f0f\u573a\u666f\u4e2d\uff0c \u5982\u679c\u8282\u70b9\u6570\u91cf\u53d1\u751f\u53d8\u5316\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u77ac\u95f4\u7684\u6d41\u91cf\u4e0d\u5747\u8861 \uff0c\u6b64\u65f6\u6211\u4eec\u8981\u53ca\u65f6\u9000\u51fa\u6b64\u79cd\u6a21\u5f0f\u4ee5\u907f\u514d\u5f15\u53d1\u96ea\u5d29\uff0c\u4e5f\u56e0\u4e3a\u8fd9\u79cd\u95ee\u9898\uff0c \u6211\u4eec\u5f15\u5165\u4e86\u57fa\u4e8e P2C \u6280\u672f\uff08Pick of two choices\uff0c\u4e24\u79cd\u968f\u673a\u9009\u62e9\uff09\u7684\u52a8\u6001\u52a0\u6743\u8d1f\u8f7d\u5747\u8861\u6a21\u5f0f \u3002","title":"2-2-2 \u5730\u57df\u6240\u5728\u533a\u9759\u6001\u52a0\u6743"},{"location":"chap1/3chap1_load_balancer/#2-3-ewma","text":"\u5b9e\u9645\u4e0a\u57fa\u4e8e P2C \u7b97\u6cd5\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u662f\u8fd1\u5e74\u6765\u6700\u6d41\u884c\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff0c\u6211\u4eec\u5e38\u89c1\u7684 Service Mesh \u63a7\u5236\u9762\uff0c\u6bd4\u5982 Envoy\u3001Linkerd\uff0c\u9ed8\u8ba4\u90fd\u63d0\u4f9b\u57fa\u4e8e P2C \u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff0c\u53e6\u5916\u6700\u5e38\u7528\u7684\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u5668 Nginx\uff0c\u5728\u5176\u6536\u8d39\u7248\u672c NGINX plus \u4e2d\uff0c\u540c\u6837\u63d0\u4f9b\u4e86 P2C \u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5 \u3002 \u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684\u52a8\u6001\u52a0\u6743\u8d1f\u8f7d\u5747\u8861\uff0cP2C \u89e3\u51b3\u7684\u6700\u5927\u95ee\u9898\uff0c\u5c31\u662f\u201c\u7f8a\u7fa4\u6548\u5e94\u201d\u3002 \u7f8a\u7fa4\u6548\u5e94\uff1a\u5f53\u67d0\u4e00\u8282\u70b9\u51fa\u73b0\u5ef6\u65f6\u6216\u8005 CPU \u8d1f\u8f7d\u8fc7\u9ad8\u65f6\uff0c\u59cb\u53d1\u96c6\u7fa4\u7684\u591a\u4e2a\u8282\u70b9\u90fd\u53d1\u73b0\u4e86\u8fd9\u4e2a\u8282\u70b9\u5ef6\u65f6/CPU \u8d1f\u8f7d\u8fc7\u9ad8\u7684\u95ee\u9898\uff0c\u5f88\u5bb9\u6613\u9020\u6210\u8fc7\u591a\u7684\u6d41\u91cf\u8def\u7531\u5230\u540c\u4e00\u8282\u70b9\uff0c\u9020\u6210\u8d1f\u8f7d\u4e0d\u5747\u8861\u3002 \u56e0\u4e3a P2C \u662f\u968f\u673a\u83b7\u53d6\u4e24\u4e2a\u8282\u70b9\uff0c\u7136\u540e\u83b7\u5f97\u52a0\u6743\u503c\u7b97\u6cd5\u540e\u6700\u5927\u7684\u8282\u70b9\uff0c\u6240\u4ee5\u9700\u8981\u4e00\u4e2a\u52a0\u6743\u7b97\u6cd5\u7528\u6765\u5224\u65ad\u54ea\u4e2a\u8282\u70b9\u7684\u52a0\u6743\u503c\u66f4\u5927\u3002\u8d1f\u8f7d\u7387\u7684\u7b97\u6cd5\u5982\u4e0b\uff1a client_success / server_cpumath.Sqrt(latency+1)(inflight+1) \u4e0b\u9762\u7b80\u5355\u89e3\u91ca\u4e00\u4e0b\u5404\u53c2\u6570\u7684\u610f\u4e49\u3002 client_success : \u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u6210\u529f\u7387 server_cpu : \u901a\u8fc7\u6bcf\u6b21\u8bf7\u6c42 response \u7684 header \u8fd4\u56de\uff0c\u670d\u52a1\u7aef\u7684 CPU \u77ac\u65f6\u503c latency\uff1a\u5ba2\u6237\u7aef\u8ba1\u7b97\u7684\u5ef6\u65f6 inflight\uff1a \u6b63\u5728\u53d1\u9001\u4e2d\u7684\u8bf7\u6c42\u6570\u91cf \u5728\u8fd9\u91cc\u7684\u516c\u5f0f\u4e2d\uff0c \u6211\u4eec\u5e76\u6ca1\u6709\u52a0\u4e0a\u8282\u70b9\u7684\u9759\u6001\u6743\u91cd \u3002\u548c Envoy \u4e00\u6837\uff0c\u6211\u4eec\u53ea\u5728\u8282\u70b9\u6743\u91cd\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\u91c7\u7528\u6b64\u79cd\u7b97\u6cd5\uff0c \u56e0\u4e3aP2C \u7b97\u6cd5\u4f1a\u5bfc\u81f4\u540e\u7aef\u8282\u70b9\u7684\u5b9e\u9645\u6743\u91cd\u548c\u914d\u7f6e\u7684\u6743\u91cd\u76f8\u5dee\u6bd4\u8f83\u5927\uff0c\u7ed9\u8fd0\u7ef4\u4e2d\u7684\u4e34\u65f6\u8c03\u6574\u8282\u70b9\u6743\u91cd\u548c\u91d1\u4e1d\u96c0\u53d1\u5e03\u5e26\u6765\u4e00\u5b9a\u7684\u56f0\u6270 \u3002","title":"2-3 \u5ef6\u65f6\u3001\u8d1f\u8f7d\u52a0\u6743\uff08EWMA\uff09"},{"location":"chap1/3chap1_load_balancer/#2-4-ewma","text":"\u53ef\u4ee5\u901a\u8fc7\u6ed1\u52a8\u7a97\u53e3\u7684\u65b9\u5f0f\u8ba1\u7b97 10s \u5185\u7684\u5ef6\u65f6\u5e73\u5747\u503c\u548c\u5ba2\u6237\u7aef\u6210\u529f\u7387\uff0c\u4f46\u8fd9\u79cd\u65b9\u5f0f\u6d88\u8017\u7684\u5185\u5b58\u6bd4\u8f83\u5927\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u9009\u62e9 EWMA\uff08Exponentially Weighted Averages\uff0c\u6307\u6570\u79fb\u52a8\u52a0\u6743\u5e73\u5747\uff09\u7684\u7b97\u6cd5\u6765\u8ba1\u7b97\u5ef6\u65f6\u548c\u5ba2\u6237\u7aef\u6210\u529f\u7387\u3002 Vt \u4ee3\u8868\u7b2c t \u6b21\u8bf7\u6c42\u65f6\u7684 EWMA \u503c\uff0cVt-1 \u4ee3\u8868\u7b2c t-1 \u6b21\u8bf7\u6c42\u7684 EWMA \u503c\uff1b \u03b8t \u4ee3\u8868\u7b2c t \u6b21\u8bf7\u6c42\u7684\u5b9e\u9645\u8017\u65f6\uff0c\u6240\u4ee5\u03b2\u8d8a\u5c0f\uff0cVt \u8d8a\u63a5\u8fd1\u672c\u6b21\u8bf7\u6c42\u8017\u65f6\u3002 \u5728\u5b9e\u9645\u4e2d\u03b2\u503c\u7684\u516c\u5f0f\uff1a \u03b2= math.Exp(float64(-td) / float64(tau)) \uff0c \u5176\u4e2d td \u4e3a\u5f53\u524d\u65f6\u95f4\u548c\u4e0a\u6b21\u54cd\u5e94\u540e\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee\uff0ctau \u4e3a\u8870\u51cf\u7cfb\u6570\u3002","title":"2-4 EWMA \u8ba1\u7b97\u5ef6\u65f6\u548c\u5ba2\u6237\u7aef\u6210\u529f\u7387"},{"location":"chap1/3chap1_load_balancer/#2-5","text":"","title":"2-5 \u8d1f\u8f7d\u5747\u8861\u4e2d\u7684\u5e38\u89c1\u95ee\u9898"},{"location":"chap1/3chap1_load_balancer/#2-5-1","text":"Nginx \u8fd9\u6837\u7684\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u6d88\u8017\u6bd4\u8f83\u5927\uff0c\u7406\u8bba\u4e0a\u4e00\u53f0\u9ad8\u914d\u7f6e\u7684\u670d\u52a1\u5668\u5927\u6982\u80fd\u627f\u53d7 10w \u7ea7\u522b QPS \u7684\u8d1f\u8f7d\uff0c\u8ba9\u6211\u4eec\u8fc7\u65e9\u5730\u9047\u5230\u4e86\u5355\u673a\u74f6\u9888\u3002 \u6240\u4ee5\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u901a\u5e38\u6211\u4eec\u4f1a\u9009\u53d6\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u4f46\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u6700\u5927\u7684\u95ee\u9898\u5c31\u662f\u6d41\u91cf\u4e0d\u5747\u8861\u3002 \u56e0\u4e3a\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u57fa\u4e8e\u8fde\u63a5\u505a\u8d1f\u8f7d\u5747\u8861\uff0c \u5f53\u6211\u4eec\u6458\u6389\u67d0\u4e00\u4e2a\u8282\u70b9\uff0c\u4e5f\u5c31\u662f\u628a\u67d0\u4e2a\u8282\u70b9\u7684\u6743\u91cd\u8bbe\u7f6e\u4e3a 0 \u7684\u65f6\u5019\uff0c\u7531\u4e8e\u8fde\u63a5\u8fd8\u662f\u4fdd\u6301\u7684\uff0c\u6d41\u91cf\u4f9d\u7136\u4f1a\u6253\u5230\u8fd9\u4e2a\u8282\u70b9 \uff0c\u6240\u4ee5\u4f7f\u7528\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\u5f88\u591a\u65f6\u5019\u8981\u7b49\u5f85\u4e00\u6574\u5929\u624d\u80fd\u5c06\u8282\u70b9\u65e0\u635f\u5730\u6458\u6389\u3002\u8fd9\u5728\u5916\u7f51\u7f51\u5173\u7684\u6458\u53d6\u4e2d\u4e5f\u7279\u522b\u5e38\u89c1\u3002 \u4e5f\u6b63\u662f\u8fd9\u79cd\u57fa\u4e8e\u8fde\u63a5\u7684\u673a\u5236\uff0c\u5bfc\u81f4\u67d0\u4e9b\u8fde\u63a5\u8bf7\u6c42 QPS \u9ad8\u3001\u67d0\u4e9b\u8fde\u63a5\u8bf7\u6c42 QPS \u4f4e\u7684\u60c5\u51b5\u4e5f\u5f88\u5bb9\u6613\u51fa\u73b0\u3002 \u53e6\u5916\u5f53\u6211\u4eec\u505a\u670d\u52a1\u53d1\u5e03\u65f6\uff0c\u67d0\u4e2a\u8282\u70b9\u91cd\u542f\u540e\u4f1a\u51fa\u73b0\u6d41\u91cf\u5f88\u4f4e\u7684\u60c5\u51b5\uff0c\u4e5f\u662f\u56e0\u4e3a\u56db\u5c42\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u5df2\u7ecf\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u5efa\u7acb\u4e86\u8fde\u63a5\uff0c\u65b0\u52a0\u5165\u7684\u8282\u70b9\u5f80\u5f80\u9700\u8981\u8f83\u957f\u65f6\u95f4\u624d\u4f1a\u8d1f\u8f7d\u8d8b\u4e8e\u5747\u8861\u3002","title":"2-5-1 \u4e3a\u4ec0\u4e48\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u4e2d\u6d41\u91cf\u4f1a\u4e0d\u5747\u8861\uff1f"},{"location":"chap1/3chap1_load_balancer/#2-5-2","text":"\u5b9e\u9645\u4e0a\uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u786c\u4ef6\u7684\u5dee\u5f02\uff0c\u7279\u522b\u662f\u865a\u62df\u673a\u5b58\u5728\u8d85\u5356\u7b49\u73b0\u8c61\uff0c\u5f88\u96be\u4fdd\u8bc1\u540c\u89c4\u683c\u7684\u670d\u52a1\u5668\u80fd\u591f\u5904\u7406\u540c\u6837\u7684 QPS \u91cf\u7ea7\uff0c\u6240\u4ee5\u540e\u7aef\u670d\u52a1\u5668\u7684\u8d1f\u8f7d\u5f88\u96be\u4e00\u81f4\uff0c \u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u6839\u636e\u5ef6\u65f6\u548c CPU \u60c5\u51b5\u7684\u4e00\u4e9b\u52a0\u6743\u7b56\u7565\u505a\u5904\u7406\u4e86\u3002","title":"2-5-2 \u8d1f\u8f7d\u5747\u8861\u540e\u5404\u8282\u70b9\u6d41\u91cf\u5747\u8861\uff0c\u540e\u7aef\u670d\u52a1\u7684\u8d1f\u8f7d\u5c31\u4e00\u5b9a\u4e00\u81f4\u5417\uff1f"},{"location":"chap1/3chap1_load_balancer/#2-5-3","text":"\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u7b49\u5f85\u6ce8\u518c\u4e2d\u5fc3\u7684\u901a\u77e5\uff0c\u4f46\u56e0\u4e3a\u6ce8\u518c\u4e2d\u5fc3\u7684\u4e2d\u5fc3\u5316\u5f02\u6b65\u63a8\u9001\u673a\u5236\uff0c\u5f80\u5f80\u6536\u5230\u4fe1\u606f\u4e0d\u591f\u53ca\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7 upsteam \u8282\u70b9\u8fd4\u56de\u670d\u52a1\u5065\u5eb7\u68c0\u67e5\u5931\u8d25\u7684\u5934\u4fe1\u606f\uff0c\u8ba9\u5ba2\u6237\u7aef\u53ef\u4ee5\u5feb\u901f\u6458\u6389\u4e0d\u5065\u5eb7\u7684\u8282\u70b9\u3002","title":"2-5-3 \u8282\u70b9\u4e0b\u7ebf\u540e\u5982\u4f55\u53ca\u65f6\u6458\u6389\u8282\u70b9\uff1f"},{"location":"chap1/4chap1_router/","text":"\u7b2c\u56db\u8282 \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565 1\u3001\u9488\u5bf9\u4e0d\u540c\u7684\u6d41\u91cf\u5b9e\u73b0\u591a\u79cd\u8def\u7531\u7b56\u7565 \u8def\u7531\u5668: \u6839\u636e\u4e0d\u540c\u89c4\u5219\u8fdb\u884c\u6d41\u91cf\u63a7\u5236\u548c\u8f6c\u53d1 \u5b9e\u9645\u4e0a\u8def\u7531\u8fd9\u4e2a\u62bd\u8c61\u7684\u6982\u5ff5\u88ab\u63d0\u53ca\uff0c\u751a\u81f3\u8fbe\u5230\u6838\u5fc3\u7684\u4f4d\u7f6e\uff0c\u66f4\u591a\u7684\u662f\u5728 Service Mesh \u67b6\u6784\u4e2d\u3002\u5728\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u8def\u7531\u867d\u7136\u4e5f\u5b58\u5728\uff0c\u4f46\u56e0\u4e3a\u4e0d\u9700\u8981\u8fdb\u884c\u4e3b\u52a8\u914d\u7f6e\uff0c\u5b58\u5728\u611f\u5e76\u4e0d\u662f\u5f88\u5f3a\u3002 \u800c\u5728 Service Mesh \u67b6\u6784\u4e2d\uff0c \u6570\u636e\u9762\u90fd\u662f\u901a\u8fc7\u63a7\u5236\u9762\u7684\u914d\u7f6e\u4e0b\u53d1\u9a71\u52a8\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u5fc5\u987b\u5f3a\u884c\u58f0\u660e\u8def\u7531\u914d\u7f6e\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u8c03\u7528\u51fa\u73b0 404 \u7684\u9519\u8bef \u3002 \u8fd9\u79cd\u58f0\u660e\u5f0f\u7684\u67b6\u6784\u65b9\u5f0f\u4e5f\u8bb8\u56e0\u4e3a\u914d\u7f6e\u5e26\u6765\u4e86\u4e00\u4e9b\u4e0d\u4fbf\uff0c\u5374\u63d0\u9ad8\u4e86\u67b6\u6784\u7684\u53ef\u63a7\u6027\uff0c\u4e0d\u4f1a\u51fa\u73b0\u4f20\u7edf\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u65e0\u6cd5\u77e5\u9053\u8c03\u7528\u4e86\u51e0\u4e2a\u670d\u52a1\u7684\u95ee\u9898\u3002 1-1 Envoy \u4e2d\u7684\u8def\u7531\u914d\u7f6e { \"version_info\": \"2020-12-07T01:38:20Z\", \"route_config\": { \"name\": \"9080\", \"virtual_hosts\": [{ \"name\": \"details.default.svc.cluster:9080\", \"domains\": [ \"details.default.svc.cluster:9080\", ], \"routes\": [{ \"match\": { \"prefix\": \"/\" }, \"route\": { \"cluster\": \"outbound|9080||details.default.svc.cluster\", \"timeout\": \"10s\", \"max_grpc_timeout\": \"10s\" }, \"per_filter_config\": { \"mixer\": { } } }] }] } } name\uff1a\u4e3b\u8981\u662f\u5bf9\u5e94 listener\uff08\u76d1\u542c\u5668\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a sidecar \u7684\u76d1\u542c\u7aef\u53e3\uff09\u7684\u540d\u79f0\uff0c\u8fd9\u91cc\u7528\u7aef\u53e3\u4f5c\u4e3a\u540d\u5b57\uff0c\u5df2\u7ecf\u786e\u4fdd\u4e86\u552f\u4e00\u6027\u3002\u901a\u5e38\u6211\u4eec\u7684\u8def\u7531\u914d\u7f6e\u9488\u5bf9\u6bcf\u79cd\u534f\u8bae\u4f1a\u6709\u4e24\u4efd\uff08Client \u7aef\u8def\u7531\u548c Server \u7aef\u8def\u7531\uff09\uff0c\u8fd9\u4e00\u8bb2\uff0c\u6211\u4eec\u4e3b\u8981\u8bb2\u89e3 Client \u7aef\uff0c\u4e5f\u5c31\u662f\u8c03\u7528\u65b9\u7684\u8def\u7531\u914d\u7f6e \u3002\u56e0\u4e3a\u8c03\u7528\u65b9\u7684\u8def\u7531\u914d\u7f6e\u76f8\u5bf9\u6bd4\u8f83\u590d\u6742\uff0c\u7406\u89e3\u4e86\u8c03\u7528\u65b9\u914d\u7f6e\uff0c\u88ab\u8c03\u7528\u7aef\u5c31\u5f88\u5bb9\u6613\u7406\u89e3\u4e86\u3002 domains\uff1a\u5728 Envoy \u4e2d\u4f1a\u5148\u505a\u4e00\u5c42\u521d\u6b65\u7684\u8fc7\u6ee4\uff0c\u8fd9\u5c42\u8fc7\u6ee4\u5c31\u662f\u670d\u52a1\u57df\u540d\uff08\u540d\u79f0\uff09\uff0c\u8fd9\u5c42\u5339\u914d\u975e\u5e38\u7b80\u5355 \uff0c\u57fa\u672c\u4e0a\u5c31\u662f\u5b57\u7b26\u4e32\u7684\u5bf9\u6bd4\uff0c\u6240\u4ee5\u901f\u5ea6\u4f1a\u5f88\u5feb\uff0c\u8fd9\u6837\u5c31\u907f\u514d\u4e86\u76f4\u63a5\u904d\u5386\u6240\u6709\u8def\u7531\u5e26\u6765\u7684\u4e0d\u5fc5\u8981\u7684\u6027\u80fd\u6d88\u8017\u3002 routes\uff1a\u670d\u52a1\u7684\u8def\u7531\u914d\u7f6e\uff0c\u53ef\u4ee5\u6ce8\u610f\u5230\u8fd9\u662f\u4e00\u4e2a\u6570\u7ec4 \uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u8981\u8bbf\u95ee\u7684\u670d\u52a1\u8bbe\u7f6e\u591a\u6761\u8def\u7531\u914d\u7f6e\u3002\u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u7684\u8def\u7531\u89c4\u5219\uff0c\u8fdb\u884c\u4e0d\u540c\u7684 filter \u914d\u7f6e\u3002 routes\uff1a\u670d\u52a1\u7684\u8def\u7531\u914d\u7f6e\uff0c\u53ef\u4ee5\u6ce8\u610f\u5230\u8fd9\u662f\u4e00\u4e2a\u6570\u7ec4 \uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u8981\u8bbf\u95ee\u7684\u670d\u52a1\u8bbe\u7f6e\u591a\u6761\u8def\u7531\u914d\u7f6e\u3002\u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u7684\u8def\u7531\u89c4\u5219\uff0c\u8fdb\u884c\u4e0d\u540c\u7684 filter \u914d\u7f6e\u3002 routers \u6570\u7ec4\u7ed3\u6784 match\uff1a \u7528\u4e8e\u8def\u7531\u5339\u914d\uff0c\u7a0b\u5e8f\u4f1a\u904d\u5386\u5339\u914d\u6b64\u5b57\u6bb5\u5230\u5bf9\u5e94\u7684\u8def\u7531\u8bbe\u7f6e \uff0c\u53ef\u4ee5\u914d\u7f6e header\u3001path\u3001pathPrefix \u7b49\u3002 route\uff1a \u4e3b\u8981\u662f\u5339\u914d\u5230\u8fd9\u6761\u8def\u7531\u7684\u57fa\u672c\u89c4\u5219\u8bbe\u7f6e\u3002\u6bd4\u5982 Cluster \u5b57\u6bb5\u662f\u8fd9\u6761\u8def\u7531\u5bf9\u5e94\u7684\u670d\u52a1\u540d\uff0c\u8fd9\u4e5f\u662f\u8def\u7531\u6a21\u5757\u6700\u6838\u5fc3\u7684\u4f5c\u7528\uff0c\u901a\u8fc7\u8def\u7531\u89c4\u5219\u5339\u914d\u5230\u5408\u9002\u7684\u670d\u52a1\u540d\uff0c\u7136\u540e\u8fdb\u884c\u8f6c\u53d1 \u3002 \u6bd4\u5982\u5728\u6b64\u914d\u7f6e\u5b9e\u4f8b\u4e2d \"details.default.svc.cluster:9080\" \u7684\u670d\u52a1\u4f1a\u88ab\u8f6c\u53d1\u5230 \"outbound|9080||details.default.svc.cluster\" \u5bf9\u5e94\u7684\u670d\u52a1\u8282\u70b9\u4e0a\u9762\u3002\u53e6\u5916\u4e24\u4e2a\u5b57\u6bb5\u5219\u662f\u670d\u52a1\u8f6c\u53d1\u7684\u8d85\u65f6\u65f6\u95f4\u3002 per_filter_config \uff1a \u8def\u7531\u5bf9\u5e94\u7684\u4e2d\u95f4\u4ef6\u914d\u7f6e\uff0c\u7528\u4e8e\u670d\u52a1\u6cbb\u7406\u7684\u9650\u6d41\u3001\u7194\u65ad\u7b49 \u3002 1-2 \u7cbe\u51c6\u6d41\u91cf\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03 \u91d1\u4e1d\u96c0\u53d1\u5e03\u4e5f\u53eb\u7070\u5ea6\u53d1\u5e03\uff0c \u5b9e\u9645\u4e0a\u5c31\u662f\u5c06\u5c11\u91cf\u7684\u751f\u4ea7\u6d41\u91cf\u8def\u7531\u5230\u7ebf\u4e0a\u670d\u52a1\u7684\u65b0\u7248\u672c\u4e2d\uff0c\u4ee5\u9a8c\u8bc1\u65b0\u7248\u672c\u7684\u51c6\u786e\u6027\u548c\u7a33\u5b9a\u6027 \u3002 { \"route_config\": { \"virtual_hosts\": [ { \"name\": \"helloworld\", \"domains\": [\"*\"], \"routes\": [ { \"prefix\": \"/\", \"weighted_clusters\": { \"clusters\" : [ { \"name\" : \"helloworld|stage=canary\", \"weight\" : 1}, { \"name\" : \"helloworld|stage=prod\", \"weight\" : 99 }, ] } } ] } ] } } \u76f8\u5bf9\u4e8e\u524d\u9762\u7684 Cluster \u7684\u914d\u7f6e\uff0c\u8fd9\u91cc\u591a\u51fa\u4e86 weighted_clusters \u7684\u914d\u7f6e\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0cEnvoy \u4f1a\u6309\u7167\u6743\u91cd\u5c06\u6d41\u91cf\u8def\u7531\u5230 HelloWorld \u8fd9\u4e2a\u670d\u52a1\u4e0d\u540c\u7684\u7248\u672c\u4e2d\uff0cname \u4e2d\u7684 stage=canary \u53ef\u4ee5\u7406\u89e3\u4e3a\u6ce8\u518c\u4e2d\u5fc3\u7684\u9488\u5bf9\u4e0d\u540c\u8282\u70b9\u7684 tag\uff0c\u5728 Pilot \u4e2d\u4f1a\u88ab\u5f53\u4f5c\u670d\u52a1\u540d\u7684\u4e00\u90e8\u5206\u62fc\u5728\u670d\u52a1\u540d\u4e2d\u3002 \u5f53\u7136\uff0c\u548c\u4e4b\u524d\u5728\u8d1f\u8f7d\u5747\u8861\u6a21\u5757\u4e2d\u8bb2\u5230\u7684\u67d3\u8272\u4e00\u6837\uff0c\u6211\u4eec\u9700\u8981\u9488\u5bf9\u673a\u5668\u6216\u8005 Pod \u6253\u4e0a\u6807\u7b7e\uff0c\u6bd4\u5982\u5728\u8fdb\u884c CD \u53d1\u5e03\u7684\u65f6\u5019\uff0c\u5c06\u7528\u4e8e\u91d1\u4e1d\u96c0\u7684 Pod \u6253\u4e0a stage=canary \u7684\u6807\u7b7e\uff0c\u8fd9\u6837\u6211\u4eec\u518d\u66f4\u65b0\u5ba2\u6237\u7aef\u7684\u8def\u7531\u914d\u7f6e\uff0c\u5c31\u4f1a\u6709 1% \u7684\u6d41\u91cf\u8def\u7531\u5230\u91d1\u4e1d\u96c0\u7684 Pod \u4e0a\u4e86 \u5176\u5b9e\uff0c\u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684 Kubernetes \u6216\u8005 ECS \u7070\u5ea6\u53d1\u5e03\u53ea\u80fd\u8fdb\u884c\u8282\u70b9\u7ef4\u5ea6\u7684\u7070\u5ea6\uff0c\u8fd9\u91cc\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03\u5c06\u6d41\u91cf\u53d8\u5f97\u66f4\u52a0\u7cbe\u51c6\u53ef\u63a7 \u3002 \u6211\u4eec\u5728\u5165\u53e3\u7f51\u5173\u5c42\uff0c\u8fdb\u884c\u8def\u7531\u6d41\u91cf\u5206\u914d\uff0c\u8fd9\u4e2a\u65f6\u5019\u5212\u51fa\u4e00\u90e8\u5206\u6d41\u91cf\u7528\u4f5c canary \u7684\u7070\u5ea6\uff0c\u5269\u4f59\u7684\u66f4\u591a\u6d41\u91cf\u7528\u4e8e\u6b63\u5f0f\u7248\u672c\uff0c\u8fd9\u6837\u5c31\u65e0\u987b\u5728 CD \u53d1\u5e03\u65f6\u505a\u6539\u53d8\u8c03\u7528\u65b9\u914d\u7f6e\u7684\u64cd\u4f5c\u4e86\uff0c\u53ea\u9700\u8981\u542f\u52a8\u4e00\u4e2a\u5e26\u6709\u91d1\u4e1d\u96c0 stage=canary \u6807\u7b7e\u7684 Pod\uff0c\u5c31\u53ef\u4ee5\u4ee5\u6700\u5c0f\u5316\u7684\u4ee3\u4ef7\u5b8c\u6210\u7070\u5ea6\u670d\u52a1\u4e86\u3002 1-3 \u8def\u7531\u4e2d\u95f4\u4ef6 \u4e3a\u4e86\u914d\u7f6e\u7684\u7075\u6d3b\u6027\uff0c \u4e00\u822c\u6211\u4eec\u4f1a\u628a\u5404\u79cd\u4e2d\u95f4\u4ef6\u653e\u5728\u8def\u7531\u5c42\uff0c\u8fd9\u6837\u5c31\u80fd\u6839\u636e path \u6216\u8005 header \u8def\u7531\u5339\u914d\u540e\u8fdb\u884c\u7075\u6d3b\u7684\u4e2d\u95f4\u4ef6\u914d\u7f6e \u3002 \u6bd4\u5982\u6211\u4eec\u9700\u8981\u5bf9\u670d\u52a1 A \u7684 \"/test\" \u7684 path \u8fdb\u884c\u5355\u72ec\u7684\u9650\u6d41\u914d\u7f6e\uff0c\u5c31\u53ef\u4ee5\u5efa\u7acb\u4e00\u4e2a route \u7684match \u8bbe\u7f6e\u4e3a path:/test \uff0c\u8fd9\u6837\u5c31\u505a\u5230\u9488\u5bf9\u67d0\u4e00\u4e2a path \u8fdb\u884c\u9650\u6d41\uff0c\u800c\u8fd9\u4e2a\u914d\u7f6e\u4e0d\u4f1a\u5f71\u54cd\u5176\u4ed6\u7684\u8def\u7531\u89c4\u5219\u3002 \u867d\u7136\u8fd9\u91cc\u53ea\u4e3e\u4f8b\u4e86\u9650\u6d41\uff0c\u4f46\u5176\u4ed6\u7684\u4e2d\u95f4\u4ef6\uff0c\u6bd4\u5982\u7194\u65ad\u3001\u6545\u969c\u6ce8\u5165\u3001\u65e5\u5fd7\uff0c\u90fd\u662f\u4e00\u6837\u7684\u9053\u7406\u3002 1-4 \u670d\u52a1\u91cd\u5199 Cluster \u7684\u914d\u7f6e\u653e\u5728\u4e86\u8def\u7531\u91cc\uff0c\u4e5f\u5c31\u662f\u6839\u636e\u4e0d\u540c\u7684\u8def\u7531\u53ef\u4ee5\u914d\u7f6e\u4e0d\u540c\u7684 Cluster\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u80fd\u6839\u636e\u4e0d\u540c\u7684 path \u5c06\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684 upstream \u670d\u52a1\u4e86\u3002 1-5 RDS \u8def\u7531\u53d1\u73b0\u670d\u52a1 \u548c\u670d\u52a1\u8282\u70b9\u53d1\u73b0\u4e00\u6837\uff0c\u5f15\u5165\u8def\u7531\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u901a\u8fc7\u52a8\u6001\u53d1\u73b0\u8def\u7531\u7684\u53d8\u5316\uff0c \u505a\u5230\u52a8\u6001\u66f4\u65b0\u8c03\u7528\u7aef\u8def\u7531\u914d\u7f6e\uff0c\u4ee5\u8fbe\u5230\u8def\u7531\u4e2d\u95f4\u4ef6\u7b49\u914d\u7f6e\u66f4\u65b0\u7684\u529f\u80fd\u3002\u8fd9\u79cd\u505a\u6cd5\u4e5f\u8ba9\u8def\u7531\u8fd9\u4e2a\u529f\u80fd\u5728 Service Mesh \u67b6\u6784\u4e2d\u53d1\u6325\u66f4\u5927\u7684\u4ef7\u503c\u3002 2\u3001\u670d\u52a1\u6cbb\u7406\u4e4b\u9650\u6d41\u7194\u65ad \u5fae\u670d\u52a1\u9700\u8981\u6cbb\u7406\u662f\u56e0\u4e3a\u5f71\u54cd\u4e86\u5fae\u670d\u52a1\u96c6\u7fa4\u7684\u7a33\u5b9a\u6027\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u624b\u6bb5\u8fdb\u884c\u5e72\u9884\uff0c\u6bd4\u5982\u9650\u6d41\u3001\u7194\u65ad\u3001\u964d\u7ea7\u7b49\uff0c\u786e\u4fdd\u5fae\u670d\u52a1\u96c6\u7fa4\u7684\u7a33\u5b9a\u6027\u3002 2-1 \u9650\u6d41 \u9650\u6d41\u662f\u6307\u5f53\u6d41\u91cf\u8d85\u51fa\u670d\u52a1\u8bbe\u8ba1\u4e4b\u521d\u7684\u627f\u8f7d\u91cf\u65f6\uff0c\u901a\u8fc7\u4e00\u5b9a\u7684\u7b97\u6cd5\uff0c\u5c06\u65e0\u6cd5\u5904\u7406\u7684\u6d41\u91cf\u4e22\u5f03\uff0c\u4ee5\u4fdd\u8bc1\u670d\u52a1\u7684\u7a33\u5b9a\u6027\u3002 2-1-1 \u5e38\u7528\u7684\u9650\u6d41\u7b97\u6cd5 \u8ba1\u6570\u5668 : \u8ba1\u6570\u5668\u662f\u6700\u5bb9\u6613\u5b9e\u73b0\u7684\u9650\u6d41\u7b97\u6cd5 \uff0c\u5176\u5b9e\u5b83\u7684\u539f\u7406\u975e\u5e38\u7b80\u5355\uff1a\u8bb0\u5f55\u4e00\u5b9a\u65f6\u95f4\u5185\u7684\u8bf7\u6c42\u6570\u91cf\uff0c\u5c06\u8d85\u8fc7\u9608\u503c\u7684\u8bf7\u6c42\u62e6\u622a\u6389\u3002 \u8fd9\u79cd\u7b97\u6cd5\u5bf9\u4e8e\u5fae\u670d\u52a1\u9650\u6d41\u8fd9\u4e2a\u573a\u666f\u6765\u8bf4\u5176\u5b9e\u4e5f\u591f\u7528\u4e86\uff0c \u4f46\u8ba1\u6570\u5668\u7b97\u6cd5\u6709\u4e2a\u5f88\u660e\u663e\u7684\u95ee\u9898\uff1a\u5728\u4e34\u754c\u533a\u95f4\u5bb9\u6613\u4fc3\u53d1\u9519\u8bef\u7684\u9650\u6d41\u5224\u5b9a \u3002 \u5047\u5982\u8bbe\u5b9a\u8bf7\u6c42\u8bb0\u5f55\u65f6\u95f4\u4e3a 1s\uff0c\u9650\u6d41\u89e6\u53d1\u9608\u503c\u4e3a 100\uff0c\u5728\u4e0a\u4e00\u4e2a\u8bb0\u5f55\u533a\u95f4\u7684\u6700\u540e 100ms \u548c\u5f53\u524d\u8bb0\u5f55\u533a\u95f4\u7684\u524d 100ms \u90fd\u53d1\u751f\u4e86\u63a5\u8fd1\u9608\u503c\u7684\u8bf7\u6c42\u91cf 90\uff0c\u5f88\u660e\u663e\u8fd9\u6837\u5c31\u65e0\u6cd5\u89e6\u53d1\u9650\u6d41\u9608\u503c\uff0c\u4f46\u5374\u8d85\u8fc7\u4e86\u7cfb\u7edf\u7684\u6700\u5927\u8d1f\u8f7d\u3002 2-1-2 \u6ed1\u52a8\u7a97\u53e3 \u6ed1\u52a8\u7a97\u53e3\u5c31\u662f\u4e3a\u4e86\u89e3\u51b3\u7b80\u5355\u8ba1\u6570\u5668\u7684\u95ee\u9898\u3002 \u5047\u5b9a\u8bbe\u7f6e 100ms \u4e3a\u4e00\u4e2a\u7a97\u53e3\uff0c\u90a3\u4e48 1s \u5185\u4f1a\u6709 10 \u4e2a\u7a97\u53e3\uff0c\u8fd9\u6837\u5373\u4fbf\u4e24\u4e2a\u4e34\u8fd1\u7684\u7a97\u53e3\u90fd\u53d1\u751f\u4e86\u63a5\u8fd1\u9608\u503c\u7684\u8bf7\u6c42\u91cf\uff0c\u4e5f\u80fd\u591f\u901a\u8fc7\u8ba1\u7b97\u524d 10 \u4e2a\u7a97\u53e3\u7684\u603b\u91cf\uff0c\u89e6\u53d1\u9650\u6d41\u9608\u503c\u3002 \u6309\u7167\u8ba1\u6570\u5668\u4e2d\u7684\u60c5\u51b5\uff0c\u4e24\u4e2a\u4e34\u8fd1\u7a97\u53e3\u7684\u8bf7\u6c42\u91cf\u5171\u8ba1 180\uff0c\u663e\u7136\u4f1a\u89e6\u53d1\u9608\u503c\u3002 2-1-3 \u6f0f\u6876 \u6f0f\u6876\u662f\u4e00\u79cd\u975e\u5e38\u5e73\u6ed1\u7684\u9650\u6d41\u7b97\u6cd5\u3002 \u5b83\u5728\u4e00\u5b9a\u65f6\u95f4\u5185\u5141\u8bb8\u901a\u8fc7\u6052\u5b9a\u6570\u91cf\u8bf7\u6c42\uff0c\u5982\u679c\u8fd9\u4e2a\u65f6\u95f4\u5185\u8bf7\u6c42\u6570\u91cf\u8d85\u8fc7\u8fd9\u4e2a\u91cf\uff0c\u5c31\u4f1a\u89e6\u53d1\u9650\u6d41\u3002\u4e3e\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u6bd4\u5982 1s \u5185\u8bbe\u7f6e\u5141\u8bb8 1000 \u4e2a\u8bf7\u6c42\u7684\u9608\u503c\uff0c\u90a3\u4e48\u6bcf 1ms \u5c31\u4f1a\u4ea7\u751f\u4e00\u4e2a\u5141\u8bb8\u901a\u8fc7\u7684\u8bf7\u6c42\u3002\u5982\u679c\u8d85\u8fc7\u8fd9\u4e2a\u503c\uff0c\u5c31\u4f1a\u88ab\u9650\u5236\u6389\u3002 \u8fd9\u79cd\u7b97\u6cd5\u867d\u7136\u975e\u5e38\u5e73\u6ed1\uff0c\u4f46\u5374\u5e26\u6765\u4e86\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\uff1a \u9650\u6d41\u8fc7\u4e8e\u4e25\u683c \u3002 \u867d\u7136\u6211\u4eec\u8bbe\u7f6e\u4e86\u6bcf\u79d2 1000 \u4e2a\u8bf7\u6c42\uff0c\u4f46\u5982\u679c\u8fd9 1s \u5185\u7684\u8bf7\u6c42\u4e0d\u5747\u5300\u4e5f\u4f1a\u89e6\u53d1\u9650\u6d41\u3002\u5b9e\u9645\u4e0a\uff0c \u8fd9\u79cd\u7b97\u6cd5\u5e76\u4e0d\u592a\u9002\u5408\u5fae\u670d\u52a1\u573a\u666f\uff0c\u5b83\u66f4\u9002\u5408\u9650\u5236\u6211\u4eec\u8bf7\u6c42\u5916\u90e8\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u60c5\u51b5 \uff0c\u6bd4\u5982\u67d0\u4e2a\u7b2c\u4e09\u65b9\u63a8\u9001\u7684\u63a5\u53e3\u9650\u5236\u4e86\u6211\u4eec\u6bcf\u79d2\u7684\u8bf7\u6c42\u91cf\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u7528\u6f0f\u6876\u7b97\u6cd5\u53ef\u4ee5\u9650\u5236\u81ea\u8eab\u7684\u5bf9\u5916\u8bf7\u6c42\u91cf\u3002 2-1-4 \u4ee4\u724c\u6876 \u4ee4\u724c\u6876\uff08Token Bucket\uff09\u662f\u6f0f\u6876\u9650\u6d41\u7684\u4e00\u79cd\u4f18\u5316\u65b9\u6848\u3002\u5728\u5fae\u670d\u52a1\u573a\u666f\u4e2d\uff0c\u57fa\u672c\u4e0a\u90fd\u9009\u62e9\u4e86\u6b64\u79cd\u65b9\u6cd5\uff0c\u56e0\u4e3a\u8fd9\u79cd\u65b9\u5f0f\u9650\u6d41\u6bd4\u8f83\u5e73\u6ed1\uff0c\u4e5f\u4e0d\u4f1a\u4ea7\u751f\u6f0f\u6876\u9519\u6740\u8bf7\u6c42\u7684\u95ee\u9898\u3002\u4ee4\u724c\u6876\u5141\u8bb8\u4e00\u5b9a\u7684\u7a81\u53d1\u6d41\u91cf\uff0c\u6240\u4ee5\u975e\u5e38\u9002\u5408\u5fae\u670d\u52a1\u573a\u666f\u3002 \u4ee4\u724c\u6876\u548c\u6f0f\u6876\u5728\u57fa\u672c\u5b9e\u73b0\u539f\u7406\u4e0a\u5dee\u4e0d\u591a\uff0c\u6700\u5927\u7684\u533a\u522b\u662f\u9650\u5236\u89d2\u5ea6\u4e0d\u540c\uff0c \u6f0f\u6876\u662f\u9650\u5236\u6d41\u51fa\u7684\u901f\u5ea6\uff0c\u800c\u4ee4\u724c\u6876\u662f\u9650\u5236\u4ee4\u724c\u6d41\u5165\u7684\u901f\u5ea6 \u3002 \u4ee4\u724c\u6876\u4f1a\u5355\u72ec\u7ef4\u62a4\u4e00\u4e2a\u4ee4\u724c\u7684\u5b58\u50a8\u6876\uff0c\u8fd9\u4e2a\u6876\u4f1a\u6301\u7eed\u653e\u5165\u4ee4\u724c\uff0c\u5e76\u4e14\u914d\u5408\u8bbe\u7f6e\u4e00\u4e2a burst \u7684\u53c2\u6570\uff0c\u4f5c\u4e3a\u4ee4\u724c\u7684\u5b58\u50a8\u4e0a\u9650\uff1b\u800c\u653e\u5165\u4ee4\u724c\u7684\u6bcf\u79d2\u901f\u5ea6\u4e3a\u6bcf\u79d2 limit \u4e2a\uff0c\u7528\u6237\u8bf7\u6c42\u4f1a\u6e90\u6e90\u4e0d\u65ad\u5730\u6d88\u8017\u6876\u4e2d\u7684\u4ee4\u724c\u3002\u5f53\u4ee4\u724c\u6876\u5185\u7684\u4ee4\u724c\u8017\u5149\uff0c\u5c31\u4f1a\u89e6\u53d1\u9650\u6d41 limit\uff1a\u6bcf\u79d2\u5f80\u6876\u4e2d\u653e\u5165\u7684\u4ee4\u724c\u6570\u91cf\u3002\u56e0\u4e3a\u540d\u79f0\u7684\u539f\u56e0\uff0c\u8fd9\u4e2a\u503c\u5f88\u5bb9\u6613\u88ab\u7406\u89e3\u4e3a\u9650\u6d41\u503c\uff0c\u8fd9\u6837\u7684\u7406\u89e3\u5b9e\u9645\u4e0a\u662f\u9519\u8bef\u7684\uff0c\u4ee4\u724c\u6876\u7684\u9650\u6d41\u503c\u9700\u8981\u7ed3\u5408 burst \u4e00\u8d77\u786e\u5b9a\u3002 burst\uff1a\u5b57\u9762\u4e0a\u770b\u662f\u7a81\u53d1\u7684\u610f\u601d\uff0c\u867d\u7136\u5b83\u80fd\u8d77\u5230\u7a81\u53d1\u7684\u4f5c\u7528\uff0c\u4f46\u5b9e\u9645\u610f\u601d\u662f\u4ee4\u724c\u6876\u7684\u5bb9\u91cf\u5927\u5c0f\u3002 \u5728\u67d0\u4e2a\u65f6\u95f4\u7247\u5185\uff0c\u6d88\u8017\u7684\u901f\u5ea6\u5927\u4e8e\u4e86\u4ee4\u724c\u7684\u751f\u6210\u901f\u5ea6\uff0c\u53c8\u6ca1\u6709\u5b58\u91cf\uff0c\u5c31\u4f1a\u89e6\u53d1\u9650\u6d41\u4e86\u3002 2-1-5 \u5355\u673a\u9650\u6d41\u548c\u5168\u5c40\u9650\u6d41 \u5168\u5c40\u9650\u6d41\uff1a\u6307\u7684\u662f\u4e00\u7ec4\u5fae\u670d\u52a1\u96c6\u7fa4 \uff0c\u901a\u8fc7\u5916\u90e8\u5b58\u50a8\u5bf9\u96c6\u7fa4\u6574\u4f53\u6d41\u91cf\u505a\u9650\u6d41\u3002 \u8fd9\u79cd\u60c5\u51b5\u56e0\u4e3a\u9700\u8981\u4f9d\u8d56\u5916\u90e8\u5b58\u50a8\u6240\u4ee5\u6bd4\u8f83\u96be\u5b9e\u73b0\uff0c\u6bd5\u7adf\u548c\u5916\u90e8\u5b58\u50a8\u7684\u4ea4\u4e92\u9700\u8981\u589e\u52a0\u989d\u5916\u5ef6\u65f6\u3002 \u5168\u5c40\u9650\u6d41\u6bd4\u8f83\u9002\u5408\u540e\u7aef DB \u6709\u541e\u5410\u91cf\u9650\u5236\u7684\u60c5\u51b5 \uff0c\u6709\u4e9b\u573a\u666f\u9700\u8981\u6269\u5bb9 Web \u673a\u5668\uff0c\u8fd9\u4e2a\u65f6\u5019\u8bf7\u6c42\u91cf\u53ef\u80fd\u4f1a\u589e\u52a0\uff0c\u4f1a\u9020\u6210\u5bf9 DB \u8bf7\u6c42\u91cf\u7684\u589e\u52a0\uff0c\u6240\u4ee5\u9700\u8981\u8bbe\u7f6e\u4e00\u4e2a\u5168\u5c40\u9650\u6d41\u503c\u9632\u6b62\u5bf9 DB \u7684\u51b2\u51fb\u3002 \u5355\u673a\u9650\u6d41\uff1a\u6307\u7684\u662f\u4e00\u7ec4\u5fae\u670d\u52a1\u96c6\u7fa4\uff0c\u901a\u8fc7\u5bf9\u5355\u4e2a\u673a\u5668\u7684\u9650\u6d41\uff0c\u8fbe\u5230\u670d\u52a1\u6574\u4f53\u9650\u6d41\u7684\u76ee\u7684\u3002 \u5728\u5fae\u670d\u52a1\u573a\u666f\u4e2d\uff0c\u56e0\u4e3a\u5168\u5c40\u9650\u6d41\u6bd4\u8f83\u96be\u505a\u5230\uff0c\u6240\u4ee5\u5355\u673a\u9650\u6d41\u5e94\u7528\u5f97\u6bd4\u8f83\u591a \u3002\u5355\u673a\u9650\u6d41\u53ef\u4ee5\u9002\u5e94\u5927\u90e8\u5206\u573a\u666f\uff0c\u6bd5\u7adf\u5728\u5206\u5e03\u5f0f\u573a\u666f\u4e2d\uff0c \u5355\u4e00\u673a\u5668\u8d1f\u8f7d\u63a7\u5236\u4f4f\uff0c\u5927\u591a\u6570\u573a\u666f\u4e5f\u5c31\u80fd\u63a7\u5236\u4f4f\u6574\u4e2a\u96c6\u7fa4\u7684\u8d1f\u8f7d \u3002 \u8fd9\u79cd\u9650\u6d41\u4e5f\u4e0d\u5f71\u54cd\u6269\u7f29\u5bb9\uff0cWeb \u673a\u5668\u56e0\u4e3a\u8d1f\u8f7d\u4e0d\u8db3\u53ef\u4ee5\u968f\u65f6\u6a2a\u5411\u6269\u5bb9\uff0c\u6b64\u65f6\u5355\u673a\u9650\u6d41\u503c\u4e0d\u9700\u8981\u6539\u52a8\uff1b \u800c\u5728\u5168\u5c40\u9650\u6d41\u4e2d\uff0c\u5f53 Web \u673a\u5668\u6269\u5bb9\u65f6\uff0c\u4e5f\u9700\u8981\u9650\u6d41\u503c\u968f\u4e4b\u6539\u52a8\uff0c\u4e3a\u6269\u7f29\u5bb9\u5e26\u6765\u4e86\u4e0d\u4fbf\u3002 2-2 \u7194\u65ad \u7194\u65ad\u4e5f\u53eb\u65ad\u8def\u5668\uff0c\u65ad\u8def\u5668\u662f\u4e00\u79cd\u5f00\u5173\u6a21\u5f0f\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u53c2\u8003\u7535\u8def\u7cfb\u7edf\u4e2d\u7684\u8fc7\u8f7d\u4fdd\u62a4\u673a\u5236\u3002 \u5f53\u7ebf\u8def\u53d1\u751f\u77ed\u8def\u6216\u8005\u8fc7\u8f7d\u65f6\uff0c\u65ad\u8def\u5668\u80fd\u591f\u53ca\u65f6\u5207\u65ad\u7535\u8def\uff0c\u9632\u6b62\u53d1\u751f\u8fc7\u70ed\u3001\u8d77\u706b\u7b49\u6545\u969c \u7194\u65ad\u7ec4\u4ef6\u6709\u4e09\u79cd\u72b6\u6001 Closed\uff08\u5173\u95ed\uff09\uff1a\u9ed8\u8ba4\u521d\u59cb\u72b6\u6001\u4e3a\u5173\u95ed\u3002 Open\uff08\u5f00\u542f\uff09\uff1a\u5047\u5b9a\u6211\u4eec\u8bbe\u7f6e 10s \u7684\u6ed1\u52a8\u7a97\u53e3\uff0c\u5f53 10s \u5185\u7684\u9519\u8bef\u6bd4\u4f8b\u8fbe\u5230\u6211\u4eec\u8bbe\u5b9a\u9608\u503c\u7684 90% \uff0c\u6b64\u65f6\u72b6\u6001\u4f1a\u4ece Closed \u6539\u53d8\u4e3a Open\u3002 HalfOpen\uff08\u534a\u5f00\uff09\uff1a\u518d\u7ecf\u8fc7\u4e00\u4e2a 10s \u7684\u7a97\u53e3\u671f\uff0c\u6b64\u65f6\u7194\u65ad\u5668\u4f1a\u81ea\u52a8\u4ece Open \u8f6c\u79fb\u5230 HalfOpen \u72b6\u6001\u3002\u5728\u8fd9\u4e2a\u72b6\u6001\u4e0b\uff0c\u6211\u4eec\u4f1a\u6309\u7167\u7ebf\u6027\u7684\u65b9\u5f0f\u6765\u653e\u884c\u6d41\u91cf\uff0c\u516c\u5f0f\u5982\u4e0b\uff1a 0.5 * (Now() - Start())/Duration \u76f4\u5230 10s \u7684\u6ed1\u52a8\u7a97\u53e3\u5185\u63a5\u53e3\u6210\u529f\u7387\u91cd\u65b0\u6062\u590d\u5230 90% \u624d\u4f1a\u8f6c\u79fb\u5230 Closed \u72b6\u6001\uff0c\u53cd\u4e4b\u7ee7\u7eed\u53d8\u66f4\u4e3a Open \u72b6\u6001\u3002 \u7194\u65ad\u7684\u539f\u7406\u548c\u5b9e\u73b0\u90fd\u6bd4\u8f83\u7b80\u5355\uff0c\u4f46\u6ce8\u610f\u4ee5\u4e0b\u53c2\u6570\u8981\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8bbe\u7f6e\u3002 \u6ed1\u52a8\u7a97\u53e3\u65f6\u95f4 \uff1a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u6211\u4e00\u822c\u8bbe\u7f6e\u4e3a 10s\uff0c \u6ce8\u610f\u8fd9\u4e2a\u503c\u4e0d\u80fd\u592a\u957f\uff0c\u5426\u5219\u7194\u65ad\u7684\u6062\u590d\u65f6\u95f4\u4e5f\u4f1a\u968f\u4e4b\u53d8\u957f \u3002 \u89e6\u53d1\u6761\u4ef6 \uff1a\u5047\u5982\u662f HTTP \u670d\u52a1\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e0b\uff0c\u8fd9\u4e2a\u503c\u6211\u8bbe\u7f6e\u4e3a 499-600 \u4e4b\u95f4\u7684\u9519\u8bef\u7801\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a 499 \u9519\u8bef\u7801\u548c 5xx \u7684\u9519\u8bef\u7801\uff08499 \u9519\u8bef\u7801\u4ee3\u8868\u5ba2\u6237\u7aef\u4e3b\u52a8\u65ad\u5f00\uff0c\u4e00\u822c\u662f\u8d85\u65f6\u5f15\u8d77\u7684\uff0c\u800c 5xx \u9519\u8bef\u7801\u5728 HTTP \u4e2d\u662f\u670d\u52a1\u7aef\u9519\u8bef\uff09\u3002 \u5982\u679c\u662f\u975e HTTP \u670d\u52a1\uff0c\u5728 Service Mesh \u4f53\u7cfb\u4e0b\uff0c\u6211\u4f1a\u628a gRPC \u6216\u8005 Dubbo \u7684\u9519\u8bef\u7801\u8f6c\u6210\u5bf9\u5e94\u7684 HTTP \u9519\u8bef\u7801\u8fdb\u884c\u7edf\u4e00\u7684\u5904\u7406\u3002\u5177\u4f53\u7684\u8f6c\u6362\u89c4\u5219\uff0c\u5c31\u9700\u8981\u4f60\u6839\u636e\u81ea\u5df1\u7684\u7406\u89e3\u8fdb\u884c\u8bbe\u7f6e\u4e86\u3002 \u6ce8\u610f\u4e00\u822c Service Mesh \u4e2d\u7684\u7194\u65ad\u4e0d\u4f1a\u7edf\u8ba1\u4e1a\u52a1\u7684\u9519\u8bef\u7801\u505a\u7194\u65ad\u5904\u7406\uff0c\u53ea\u7edf\u8ba1\u7cfb\u7edf\u5c42\u9762\u7684\u9519\u8bef\u3002","title":"\u7b2c\u56db\u8282 \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565"},{"location":"chap1/4chap1_router/#_1","text":"","title":"\u7b2c\u56db\u8282 \u8def\u7531\u5668\u53ca\u5176\u9650\u6d41\u7194\u65ad\u8def\u7531\u7b56\u7565"},{"location":"chap1/4chap1_router/#1","text":"\u8def\u7531\u5668: \u6839\u636e\u4e0d\u540c\u89c4\u5219\u8fdb\u884c\u6d41\u91cf\u63a7\u5236\u548c\u8f6c\u53d1 \u5b9e\u9645\u4e0a\u8def\u7531\u8fd9\u4e2a\u62bd\u8c61\u7684\u6982\u5ff5\u88ab\u63d0\u53ca\uff0c\u751a\u81f3\u8fbe\u5230\u6838\u5fc3\u7684\u4f4d\u7f6e\uff0c\u66f4\u591a\u7684\u662f\u5728 Service Mesh \u67b6\u6784\u4e2d\u3002\u5728\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u8def\u7531\u867d\u7136\u4e5f\u5b58\u5728\uff0c\u4f46\u56e0\u4e3a\u4e0d\u9700\u8981\u8fdb\u884c\u4e3b\u52a8\u914d\u7f6e\uff0c\u5b58\u5728\u611f\u5e76\u4e0d\u662f\u5f88\u5f3a\u3002 \u800c\u5728 Service Mesh \u67b6\u6784\u4e2d\uff0c \u6570\u636e\u9762\u90fd\u662f\u901a\u8fc7\u63a7\u5236\u9762\u7684\u914d\u7f6e\u4e0b\u53d1\u9a71\u52a8\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u5fc5\u987b\u5f3a\u884c\u58f0\u660e\u8def\u7531\u914d\u7f6e\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u8c03\u7528\u51fa\u73b0 404 \u7684\u9519\u8bef \u3002 \u8fd9\u79cd\u58f0\u660e\u5f0f\u7684\u67b6\u6784\u65b9\u5f0f\u4e5f\u8bb8\u56e0\u4e3a\u914d\u7f6e\u5e26\u6765\u4e86\u4e00\u4e9b\u4e0d\u4fbf\uff0c\u5374\u63d0\u9ad8\u4e86\u67b6\u6784\u7684\u53ef\u63a7\u6027\uff0c\u4e0d\u4f1a\u51fa\u73b0\u4f20\u7edf\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u65e0\u6cd5\u77e5\u9053\u8c03\u7528\u4e86\u51e0\u4e2a\u670d\u52a1\u7684\u95ee\u9898\u3002","title":"1\u3001\u9488\u5bf9\u4e0d\u540c\u7684\u6d41\u91cf\u5b9e\u73b0\u591a\u79cd\u8def\u7531\u7b56\u7565"},{"location":"chap1/4chap1_router/#1-1-envoy","text":"{ \"version_info\": \"2020-12-07T01:38:20Z\", \"route_config\": { \"name\": \"9080\", \"virtual_hosts\": [{ \"name\": \"details.default.svc.cluster:9080\", \"domains\": [ \"details.default.svc.cluster:9080\", ], \"routes\": [{ \"match\": { \"prefix\": \"/\" }, \"route\": { \"cluster\": \"outbound|9080||details.default.svc.cluster\", \"timeout\": \"10s\", \"max_grpc_timeout\": \"10s\" }, \"per_filter_config\": { \"mixer\": { } } }] }] } } name\uff1a\u4e3b\u8981\u662f\u5bf9\u5e94 listener\uff08\u76d1\u542c\u5668\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a sidecar \u7684\u76d1\u542c\u7aef\u53e3\uff09\u7684\u540d\u79f0\uff0c\u8fd9\u91cc\u7528\u7aef\u53e3\u4f5c\u4e3a\u540d\u5b57\uff0c\u5df2\u7ecf\u786e\u4fdd\u4e86\u552f\u4e00\u6027\u3002\u901a\u5e38\u6211\u4eec\u7684\u8def\u7531\u914d\u7f6e\u9488\u5bf9\u6bcf\u79cd\u534f\u8bae\u4f1a\u6709\u4e24\u4efd\uff08Client \u7aef\u8def\u7531\u548c Server \u7aef\u8def\u7531\uff09\uff0c\u8fd9\u4e00\u8bb2\uff0c\u6211\u4eec\u4e3b\u8981\u8bb2\u89e3 Client \u7aef\uff0c\u4e5f\u5c31\u662f\u8c03\u7528\u65b9\u7684\u8def\u7531\u914d\u7f6e \u3002\u56e0\u4e3a\u8c03\u7528\u65b9\u7684\u8def\u7531\u914d\u7f6e\u76f8\u5bf9\u6bd4\u8f83\u590d\u6742\uff0c\u7406\u89e3\u4e86\u8c03\u7528\u65b9\u914d\u7f6e\uff0c\u88ab\u8c03\u7528\u7aef\u5c31\u5f88\u5bb9\u6613\u7406\u89e3\u4e86\u3002 domains\uff1a\u5728 Envoy \u4e2d\u4f1a\u5148\u505a\u4e00\u5c42\u521d\u6b65\u7684\u8fc7\u6ee4\uff0c\u8fd9\u5c42\u8fc7\u6ee4\u5c31\u662f\u670d\u52a1\u57df\u540d\uff08\u540d\u79f0\uff09\uff0c\u8fd9\u5c42\u5339\u914d\u975e\u5e38\u7b80\u5355 \uff0c\u57fa\u672c\u4e0a\u5c31\u662f\u5b57\u7b26\u4e32\u7684\u5bf9\u6bd4\uff0c\u6240\u4ee5\u901f\u5ea6\u4f1a\u5f88\u5feb\uff0c\u8fd9\u6837\u5c31\u907f\u514d\u4e86\u76f4\u63a5\u904d\u5386\u6240\u6709\u8def\u7531\u5e26\u6765\u7684\u4e0d\u5fc5\u8981\u7684\u6027\u80fd\u6d88\u8017\u3002 routes\uff1a\u670d\u52a1\u7684\u8def\u7531\u914d\u7f6e\uff0c\u53ef\u4ee5\u6ce8\u610f\u5230\u8fd9\u662f\u4e00\u4e2a\u6570\u7ec4 \uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u8981\u8bbf\u95ee\u7684\u670d\u52a1\u8bbe\u7f6e\u591a\u6761\u8def\u7531\u914d\u7f6e\u3002\u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u7684\u8def\u7531\u89c4\u5219\uff0c\u8fdb\u884c\u4e0d\u540c\u7684 filter \u914d\u7f6e\u3002 routes\uff1a\u670d\u52a1\u7684\u8def\u7531\u914d\u7f6e\uff0c\u53ef\u4ee5\u6ce8\u610f\u5230\u8fd9\u662f\u4e00\u4e2a\u6570\u7ec4 \uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u8981\u8bbf\u95ee\u7684\u670d\u52a1\u8bbe\u7f6e\u591a\u6761\u8def\u7531\u914d\u7f6e\u3002\u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u7684\u8def\u7531\u89c4\u5219\uff0c\u8fdb\u884c\u4e0d\u540c\u7684 filter \u914d\u7f6e\u3002 routers \u6570\u7ec4\u7ed3\u6784 match\uff1a \u7528\u4e8e\u8def\u7531\u5339\u914d\uff0c\u7a0b\u5e8f\u4f1a\u904d\u5386\u5339\u914d\u6b64\u5b57\u6bb5\u5230\u5bf9\u5e94\u7684\u8def\u7531\u8bbe\u7f6e \uff0c\u53ef\u4ee5\u914d\u7f6e header\u3001path\u3001pathPrefix \u7b49\u3002 route\uff1a \u4e3b\u8981\u662f\u5339\u914d\u5230\u8fd9\u6761\u8def\u7531\u7684\u57fa\u672c\u89c4\u5219\u8bbe\u7f6e\u3002\u6bd4\u5982 Cluster \u5b57\u6bb5\u662f\u8fd9\u6761\u8def\u7531\u5bf9\u5e94\u7684\u670d\u52a1\u540d\uff0c\u8fd9\u4e5f\u662f\u8def\u7531\u6a21\u5757\u6700\u6838\u5fc3\u7684\u4f5c\u7528\uff0c\u901a\u8fc7\u8def\u7531\u89c4\u5219\u5339\u914d\u5230\u5408\u9002\u7684\u670d\u52a1\u540d\uff0c\u7136\u540e\u8fdb\u884c\u8f6c\u53d1 \u3002 \u6bd4\u5982\u5728\u6b64\u914d\u7f6e\u5b9e\u4f8b\u4e2d \"details.default.svc.cluster:9080\" \u7684\u670d\u52a1\u4f1a\u88ab\u8f6c\u53d1\u5230 \"outbound|9080||details.default.svc.cluster\" \u5bf9\u5e94\u7684\u670d\u52a1\u8282\u70b9\u4e0a\u9762\u3002\u53e6\u5916\u4e24\u4e2a\u5b57\u6bb5\u5219\u662f\u670d\u52a1\u8f6c\u53d1\u7684\u8d85\u65f6\u65f6\u95f4\u3002 per_filter_config \uff1a \u8def\u7531\u5bf9\u5e94\u7684\u4e2d\u95f4\u4ef6\u914d\u7f6e\uff0c\u7528\u4e8e\u670d\u52a1\u6cbb\u7406\u7684\u9650\u6d41\u3001\u7194\u65ad\u7b49 \u3002","title":"1-1 Envoy \u4e2d\u7684\u8def\u7531\u914d\u7f6e"},{"location":"chap1/4chap1_router/#1-2","text":"\u91d1\u4e1d\u96c0\u53d1\u5e03\u4e5f\u53eb\u7070\u5ea6\u53d1\u5e03\uff0c \u5b9e\u9645\u4e0a\u5c31\u662f\u5c06\u5c11\u91cf\u7684\u751f\u4ea7\u6d41\u91cf\u8def\u7531\u5230\u7ebf\u4e0a\u670d\u52a1\u7684\u65b0\u7248\u672c\u4e2d\uff0c\u4ee5\u9a8c\u8bc1\u65b0\u7248\u672c\u7684\u51c6\u786e\u6027\u548c\u7a33\u5b9a\u6027 \u3002 { \"route_config\": { \"virtual_hosts\": [ { \"name\": \"helloworld\", \"domains\": [\"*\"], \"routes\": [ { \"prefix\": \"/\", \"weighted_clusters\": { \"clusters\" : [ { \"name\" : \"helloworld|stage=canary\", \"weight\" : 1}, { \"name\" : \"helloworld|stage=prod\", \"weight\" : 99 }, ] } } ] } ] } } \u76f8\u5bf9\u4e8e\u524d\u9762\u7684 Cluster \u7684\u914d\u7f6e\uff0c\u8fd9\u91cc\u591a\u51fa\u4e86 weighted_clusters \u7684\u914d\u7f6e\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0cEnvoy \u4f1a\u6309\u7167\u6743\u91cd\u5c06\u6d41\u91cf\u8def\u7531\u5230 HelloWorld \u8fd9\u4e2a\u670d\u52a1\u4e0d\u540c\u7684\u7248\u672c\u4e2d\uff0cname \u4e2d\u7684 stage=canary \u53ef\u4ee5\u7406\u89e3\u4e3a\u6ce8\u518c\u4e2d\u5fc3\u7684\u9488\u5bf9\u4e0d\u540c\u8282\u70b9\u7684 tag\uff0c\u5728 Pilot \u4e2d\u4f1a\u88ab\u5f53\u4f5c\u670d\u52a1\u540d\u7684\u4e00\u90e8\u5206\u62fc\u5728\u670d\u52a1\u540d\u4e2d\u3002 \u5f53\u7136\uff0c\u548c\u4e4b\u524d\u5728\u8d1f\u8f7d\u5747\u8861\u6a21\u5757\u4e2d\u8bb2\u5230\u7684\u67d3\u8272\u4e00\u6837\uff0c\u6211\u4eec\u9700\u8981\u9488\u5bf9\u673a\u5668\u6216\u8005 Pod \u6253\u4e0a\u6807\u7b7e\uff0c\u6bd4\u5982\u5728\u8fdb\u884c CD \u53d1\u5e03\u7684\u65f6\u5019\uff0c\u5c06\u7528\u4e8e\u91d1\u4e1d\u96c0\u7684 Pod \u6253\u4e0a stage=canary \u7684\u6807\u7b7e\uff0c\u8fd9\u6837\u6211\u4eec\u518d\u66f4\u65b0\u5ba2\u6237\u7aef\u7684\u8def\u7531\u914d\u7f6e\uff0c\u5c31\u4f1a\u6709 1% \u7684\u6d41\u91cf\u8def\u7531\u5230\u91d1\u4e1d\u96c0\u7684 Pod \u4e0a\u4e86 \u5176\u5b9e\uff0c\u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684 Kubernetes \u6216\u8005 ECS \u7070\u5ea6\u53d1\u5e03\u53ea\u80fd\u8fdb\u884c\u8282\u70b9\u7ef4\u5ea6\u7684\u7070\u5ea6\uff0c\u8fd9\u91cc\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03\u5c06\u6d41\u91cf\u53d8\u5f97\u66f4\u52a0\u7cbe\u51c6\u53ef\u63a7 \u3002 \u6211\u4eec\u5728\u5165\u53e3\u7f51\u5173\u5c42\uff0c\u8fdb\u884c\u8def\u7531\u6d41\u91cf\u5206\u914d\uff0c\u8fd9\u4e2a\u65f6\u5019\u5212\u51fa\u4e00\u90e8\u5206\u6d41\u91cf\u7528\u4f5c canary \u7684\u7070\u5ea6\uff0c\u5269\u4f59\u7684\u66f4\u591a\u6d41\u91cf\u7528\u4e8e\u6b63\u5f0f\u7248\u672c\uff0c\u8fd9\u6837\u5c31\u65e0\u987b\u5728 CD \u53d1\u5e03\u65f6\u505a\u6539\u53d8\u8c03\u7528\u65b9\u914d\u7f6e\u7684\u64cd\u4f5c\u4e86\uff0c\u53ea\u9700\u8981\u542f\u52a8\u4e00\u4e2a\u5e26\u6709\u91d1\u4e1d\u96c0 stage=canary \u6807\u7b7e\u7684 Pod\uff0c\u5c31\u53ef\u4ee5\u4ee5\u6700\u5c0f\u5316\u7684\u4ee3\u4ef7\u5b8c\u6210\u7070\u5ea6\u670d\u52a1\u4e86\u3002","title":"1-2 \u7cbe\u51c6\u6d41\u91cf\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03"},{"location":"chap1/4chap1_router/#1-3","text":"\u4e3a\u4e86\u914d\u7f6e\u7684\u7075\u6d3b\u6027\uff0c \u4e00\u822c\u6211\u4eec\u4f1a\u628a\u5404\u79cd\u4e2d\u95f4\u4ef6\u653e\u5728\u8def\u7531\u5c42\uff0c\u8fd9\u6837\u5c31\u80fd\u6839\u636e path \u6216\u8005 header \u8def\u7531\u5339\u914d\u540e\u8fdb\u884c\u7075\u6d3b\u7684\u4e2d\u95f4\u4ef6\u914d\u7f6e \u3002 \u6bd4\u5982\u6211\u4eec\u9700\u8981\u5bf9\u670d\u52a1 A \u7684 \"/test\" \u7684 path \u8fdb\u884c\u5355\u72ec\u7684\u9650\u6d41\u914d\u7f6e\uff0c\u5c31\u53ef\u4ee5\u5efa\u7acb\u4e00\u4e2a route \u7684match \u8bbe\u7f6e\u4e3a path:/test \uff0c\u8fd9\u6837\u5c31\u505a\u5230\u9488\u5bf9\u67d0\u4e00\u4e2a path \u8fdb\u884c\u9650\u6d41\uff0c\u800c\u8fd9\u4e2a\u914d\u7f6e\u4e0d\u4f1a\u5f71\u54cd\u5176\u4ed6\u7684\u8def\u7531\u89c4\u5219\u3002 \u867d\u7136\u8fd9\u91cc\u53ea\u4e3e\u4f8b\u4e86\u9650\u6d41\uff0c\u4f46\u5176\u4ed6\u7684\u4e2d\u95f4\u4ef6\uff0c\u6bd4\u5982\u7194\u65ad\u3001\u6545\u969c\u6ce8\u5165\u3001\u65e5\u5fd7\uff0c\u90fd\u662f\u4e00\u6837\u7684\u9053\u7406\u3002","title":"1-3 \u8def\u7531\u4e2d\u95f4\u4ef6"},{"location":"chap1/4chap1_router/#1-4","text":"Cluster \u7684\u914d\u7f6e\u653e\u5728\u4e86\u8def\u7531\u91cc\uff0c\u4e5f\u5c31\u662f\u6839\u636e\u4e0d\u540c\u7684\u8def\u7531\u53ef\u4ee5\u914d\u7f6e\u4e0d\u540c\u7684 Cluster\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u80fd\u6839\u636e\u4e0d\u540c\u7684 path \u5c06\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684 upstream \u670d\u52a1\u4e86\u3002","title":"1-4 \u670d\u52a1\u91cd\u5199"},{"location":"chap1/4chap1_router/#1-5-rds","text":"\u548c\u670d\u52a1\u8282\u70b9\u53d1\u73b0\u4e00\u6837\uff0c\u5f15\u5165\u8def\u7531\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u901a\u8fc7\u52a8\u6001\u53d1\u73b0\u8def\u7531\u7684\u53d8\u5316\uff0c \u505a\u5230\u52a8\u6001\u66f4\u65b0\u8c03\u7528\u7aef\u8def\u7531\u914d\u7f6e\uff0c\u4ee5\u8fbe\u5230\u8def\u7531\u4e2d\u95f4\u4ef6\u7b49\u914d\u7f6e\u66f4\u65b0\u7684\u529f\u80fd\u3002\u8fd9\u79cd\u505a\u6cd5\u4e5f\u8ba9\u8def\u7531\u8fd9\u4e2a\u529f\u80fd\u5728 Service Mesh \u67b6\u6784\u4e2d\u53d1\u6325\u66f4\u5927\u7684\u4ef7\u503c\u3002","title":"1-5 RDS \u8def\u7531\u53d1\u73b0\u670d\u52a1"},{"location":"chap1/4chap1_router/#2","text":"\u5fae\u670d\u52a1\u9700\u8981\u6cbb\u7406\u662f\u56e0\u4e3a\u5f71\u54cd\u4e86\u5fae\u670d\u52a1\u96c6\u7fa4\u7684\u7a33\u5b9a\u6027\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u624b\u6bb5\u8fdb\u884c\u5e72\u9884\uff0c\u6bd4\u5982\u9650\u6d41\u3001\u7194\u65ad\u3001\u964d\u7ea7\u7b49\uff0c\u786e\u4fdd\u5fae\u670d\u52a1\u96c6\u7fa4\u7684\u7a33\u5b9a\u6027\u3002","title":"2\u3001\u670d\u52a1\u6cbb\u7406\u4e4b\u9650\u6d41\u7194\u65ad"},{"location":"chap1/4chap1_router/#2-1","text":"\u9650\u6d41\u662f\u6307\u5f53\u6d41\u91cf\u8d85\u51fa\u670d\u52a1\u8bbe\u8ba1\u4e4b\u521d\u7684\u627f\u8f7d\u91cf\u65f6\uff0c\u901a\u8fc7\u4e00\u5b9a\u7684\u7b97\u6cd5\uff0c\u5c06\u65e0\u6cd5\u5904\u7406\u7684\u6d41\u91cf\u4e22\u5f03\uff0c\u4ee5\u4fdd\u8bc1\u670d\u52a1\u7684\u7a33\u5b9a\u6027\u3002","title":"2-1 \u9650\u6d41"},{"location":"chap1/4chap1_router/#2-1-1","text":"\u8ba1\u6570\u5668 : \u8ba1\u6570\u5668\u662f\u6700\u5bb9\u6613\u5b9e\u73b0\u7684\u9650\u6d41\u7b97\u6cd5 \uff0c\u5176\u5b9e\u5b83\u7684\u539f\u7406\u975e\u5e38\u7b80\u5355\uff1a\u8bb0\u5f55\u4e00\u5b9a\u65f6\u95f4\u5185\u7684\u8bf7\u6c42\u6570\u91cf\uff0c\u5c06\u8d85\u8fc7\u9608\u503c\u7684\u8bf7\u6c42\u62e6\u622a\u6389\u3002 \u8fd9\u79cd\u7b97\u6cd5\u5bf9\u4e8e\u5fae\u670d\u52a1\u9650\u6d41\u8fd9\u4e2a\u573a\u666f\u6765\u8bf4\u5176\u5b9e\u4e5f\u591f\u7528\u4e86\uff0c \u4f46\u8ba1\u6570\u5668\u7b97\u6cd5\u6709\u4e2a\u5f88\u660e\u663e\u7684\u95ee\u9898\uff1a\u5728\u4e34\u754c\u533a\u95f4\u5bb9\u6613\u4fc3\u53d1\u9519\u8bef\u7684\u9650\u6d41\u5224\u5b9a \u3002 \u5047\u5982\u8bbe\u5b9a\u8bf7\u6c42\u8bb0\u5f55\u65f6\u95f4\u4e3a 1s\uff0c\u9650\u6d41\u89e6\u53d1\u9608\u503c\u4e3a 100\uff0c\u5728\u4e0a\u4e00\u4e2a\u8bb0\u5f55\u533a\u95f4\u7684\u6700\u540e 100ms \u548c\u5f53\u524d\u8bb0\u5f55\u533a\u95f4\u7684\u524d 100ms \u90fd\u53d1\u751f\u4e86\u63a5\u8fd1\u9608\u503c\u7684\u8bf7\u6c42\u91cf 90\uff0c\u5f88\u660e\u663e\u8fd9\u6837\u5c31\u65e0\u6cd5\u89e6\u53d1\u9650\u6d41\u9608\u503c\uff0c\u4f46\u5374\u8d85\u8fc7\u4e86\u7cfb\u7edf\u7684\u6700\u5927\u8d1f\u8f7d\u3002","title":"2-1-1 \u5e38\u7528\u7684\u9650\u6d41\u7b97\u6cd5"},{"location":"chap1/4chap1_router/#2-1-2","text":"\u6ed1\u52a8\u7a97\u53e3\u5c31\u662f\u4e3a\u4e86\u89e3\u51b3\u7b80\u5355\u8ba1\u6570\u5668\u7684\u95ee\u9898\u3002 \u5047\u5b9a\u8bbe\u7f6e 100ms \u4e3a\u4e00\u4e2a\u7a97\u53e3\uff0c\u90a3\u4e48 1s \u5185\u4f1a\u6709 10 \u4e2a\u7a97\u53e3\uff0c\u8fd9\u6837\u5373\u4fbf\u4e24\u4e2a\u4e34\u8fd1\u7684\u7a97\u53e3\u90fd\u53d1\u751f\u4e86\u63a5\u8fd1\u9608\u503c\u7684\u8bf7\u6c42\u91cf\uff0c\u4e5f\u80fd\u591f\u901a\u8fc7\u8ba1\u7b97\u524d 10 \u4e2a\u7a97\u53e3\u7684\u603b\u91cf\uff0c\u89e6\u53d1\u9650\u6d41\u9608\u503c\u3002 \u6309\u7167\u8ba1\u6570\u5668\u4e2d\u7684\u60c5\u51b5\uff0c\u4e24\u4e2a\u4e34\u8fd1\u7a97\u53e3\u7684\u8bf7\u6c42\u91cf\u5171\u8ba1 180\uff0c\u663e\u7136\u4f1a\u89e6\u53d1\u9608\u503c\u3002","title":"2-1-2 \u6ed1\u52a8\u7a97\u53e3"},{"location":"chap1/4chap1_router/#2-1-3","text":"\u6f0f\u6876\u662f\u4e00\u79cd\u975e\u5e38\u5e73\u6ed1\u7684\u9650\u6d41\u7b97\u6cd5\u3002 \u5b83\u5728\u4e00\u5b9a\u65f6\u95f4\u5185\u5141\u8bb8\u901a\u8fc7\u6052\u5b9a\u6570\u91cf\u8bf7\u6c42\uff0c\u5982\u679c\u8fd9\u4e2a\u65f6\u95f4\u5185\u8bf7\u6c42\u6570\u91cf\u8d85\u8fc7\u8fd9\u4e2a\u91cf\uff0c\u5c31\u4f1a\u89e6\u53d1\u9650\u6d41\u3002\u4e3e\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u6bd4\u5982 1s \u5185\u8bbe\u7f6e\u5141\u8bb8 1000 \u4e2a\u8bf7\u6c42\u7684\u9608\u503c\uff0c\u90a3\u4e48\u6bcf 1ms \u5c31\u4f1a\u4ea7\u751f\u4e00\u4e2a\u5141\u8bb8\u901a\u8fc7\u7684\u8bf7\u6c42\u3002\u5982\u679c\u8d85\u8fc7\u8fd9\u4e2a\u503c\uff0c\u5c31\u4f1a\u88ab\u9650\u5236\u6389\u3002 \u8fd9\u79cd\u7b97\u6cd5\u867d\u7136\u975e\u5e38\u5e73\u6ed1\uff0c\u4f46\u5374\u5e26\u6765\u4e86\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\uff1a \u9650\u6d41\u8fc7\u4e8e\u4e25\u683c \u3002 \u867d\u7136\u6211\u4eec\u8bbe\u7f6e\u4e86\u6bcf\u79d2 1000 \u4e2a\u8bf7\u6c42\uff0c\u4f46\u5982\u679c\u8fd9 1s \u5185\u7684\u8bf7\u6c42\u4e0d\u5747\u5300\u4e5f\u4f1a\u89e6\u53d1\u9650\u6d41\u3002\u5b9e\u9645\u4e0a\uff0c \u8fd9\u79cd\u7b97\u6cd5\u5e76\u4e0d\u592a\u9002\u5408\u5fae\u670d\u52a1\u573a\u666f\uff0c\u5b83\u66f4\u9002\u5408\u9650\u5236\u6211\u4eec\u8bf7\u6c42\u5916\u90e8\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u60c5\u51b5 \uff0c\u6bd4\u5982\u67d0\u4e2a\u7b2c\u4e09\u65b9\u63a8\u9001\u7684\u63a5\u53e3\u9650\u5236\u4e86\u6211\u4eec\u6bcf\u79d2\u7684\u8bf7\u6c42\u91cf\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u7528\u6f0f\u6876\u7b97\u6cd5\u53ef\u4ee5\u9650\u5236\u81ea\u8eab\u7684\u5bf9\u5916\u8bf7\u6c42\u91cf\u3002","title":"2-1-3 \u6f0f\u6876"},{"location":"chap1/4chap1_router/#2-1-4","text":"\u4ee4\u724c\u6876\uff08Token Bucket\uff09\u662f\u6f0f\u6876\u9650\u6d41\u7684\u4e00\u79cd\u4f18\u5316\u65b9\u6848\u3002\u5728\u5fae\u670d\u52a1\u573a\u666f\u4e2d\uff0c\u57fa\u672c\u4e0a\u90fd\u9009\u62e9\u4e86\u6b64\u79cd\u65b9\u6cd5\uff0c\u56e0\u4e3a\u8fd9\u79cd\u65b9\u5f0f\u9650\u6d41\u6bd4\u8f83\u5e73\u6ed1\uff0c\u4e5f\u4e0d\u4f1a\u4ea7\u751f\u6f0f\u6876\u9519\u6740\u8bf7\u6c42\u7684\u95ee\u9898\u3002\u4ee4\u724c\u6876\u5141\u8bb8\u4e00\u5b9a\u7684\u7a81\u53d1\u6d41\u91cf\uff0c\u6240\u4ee5\u975e\u5e38\u9002\u5408\u5fae\u670d\u52a1\u573a\u666f\u3002 \u4ee4\u724c\u6876\u548c\u6f0f\u6876\u5728\u57fa\u672c\u5b9e\u73b0\u539f\u7406\u4e0a\u5dee\u4e0d\u591a\uff0c\u6700\u5927\u7684\u533a\u522b\u662f\u9650\u5236\u89d2\u5ea6\u4e0d\u540c\uff0c \u6f0f\u6876\u662f\u9650\u5236\u6d41\u51fa\u7684\u901f\u5ea6\uff0c\u800c\u4ee4\u724c\u6876\u662f\u9650\u5236\u4ee4\u724c\u6d41\u5165\u7684\u901f\u5ea6 \u3002 \u4ee4\u724c\u6876\u4f1a\u5355\u72ec\u7ef4\u62a4\u4e00\u4e2a\u4ee4\u724c\u7684\u5b58\u50a8\u6876\uff0c\u8fd9\u4e2a\u6876\u4f1a\u6301\u7eed\u653e\u5165\u4ee4\u724c\uff0c\u5e76\u4e14\u914d\u5408\u8bbe\u7f6e\u4e00\u4e2a burst \u7684\u53c2\u6570\uff0c\u4f5c\u4e3a\u4ee4\u724c\u7684\u5b58\u50a8\u4e0a\u9650\uff1b\u800c\u653e\u5165\u4ee4\u724c\u7684\u6bcf\u79d2\u901f\u5ea6\u4e3a\u6bcf\u79d2 limit \u4e2a\uff0c\u7528\u6237\u8bf7\u6c42\u4f1a\u6e90\u6e90\u4e0d\u65ad\u5730\u6d88\u8017\u6876\u4e2d\u7684\u4ee4\u724c\u3002\u5f53\u4ee4\u724c\u6876\u5185\u7684\u4ee4\u724c\u8017\u5149\uff0c\u5c31\u4f1a\u89e6\u53d1\u9650\u6d41 limit\uff1a\u6bcf\u79d2\u5f80\u6876\u4e2d\u653e\u5165\u7684\u4ee4\u724c\u6570\u91cf\u3002\u56e0\u4e3a\u540d\u79f0\u7684\u539f\u56e0\uff0c\u8fd9\u4e2a\u503c\u5f88\u5bb9\u6613\u88ab\u7406\u89e3\u4e3a\u9650\u6d41\u503c\uff0c\u8fd9\u6837\u7684\u7406\u89e3\u5b9e\u9645\u4e0a\u662f\u9519\u8bef\u7684\uff0c\u4ee4\u724c\u6876\u7684\u9650\u6d41\u503c\u9700\u8981\u7ed3\u5408 burst \u4e00\u8d77\u786e\u5b9a\u3002 burst\uff1a\u5b57\u9762\u4e0a\u770b\u662f\u7a81\u53d1\u7684\u610f\u601d\uff0c\u867d\u7136\u5b83\u80fd\u8d77\u5230\u7a81\u53d1\u7684\u4f5c\u7528\uff0c\u4f46\u5b9e\u9645\u610f\u601d\u662f\u4ee4\u724c\u6876\u7684\u5bb9\u91cf\u5927\u5c0f\u3002 \u5728\u67d0\u4e2a\u65f6\u95f4\u7247\u5185\uff0c\u6d88\u8017\u7684\u901f\u5ea6\u5927\u4e8e\u4e86\u4ee4\u724c\u7684\u751f\u6210\u901f\u5ea6\uff0c\u53c8\u6ca1\u6709\u5b58\u91cf\uff0c\u5c31\u4f1a\u89e6\u53d1\u9650\u6d41\u4e86\u3002","title":"2-1-4 \u4ee4\u724c\u6876"},{"location":"chap1/4chap1_router/#2-1-5","text":"\u5168\u5c40\u9650\u6d41\uff1a\u6307\u7684\u662f\u4e00\u7ec4\u5fae\u670d\u52a1\u96c6\u7fa4 \uff0c\u901a\u8fc7\u5916\u90e8\u5b58\u50a8\u5bf9\u96c6\u7fa4\u6574\u4f53\u6d41\u91cf\u505a\u9650\u6d41\u3002 \u8fd9\u79cd\u60c5\u51b5\u56e0\u4e3a\u9700\u8981\u4f9d\u8d56\u5916\u90e8\u5b58\u50a8\u6240\u4ee5\u6bd4\u8f83\u96be\u5b9e\u73b0\uff0c\u6bd5\u7adf\u548c\u5916\u90e8\u5b58\u50a8\u7684\u4ea4\u4e92\u9700\u8981\u589e\u52a0\u989d\u5916\u5ef6\u65f6\u3002 \u5168\u5c40\u9650\u6d41\u6bd4\u8f83\u9002\u5408\u540e\u7aef DB \u6709\u541e\u5410\u91cf\u9650\u5236\u7684\u60c5\u51b5 \uff0c\u6709\u4e9b\u573a\u666f\u9700\u8981\u6269\u5bb9 Web \u673a\u5668\uff0c\u8fd9\u4e2a\u65f6\u5019\u8bf7\u6c42\u91cf\u53ef\u80fd\u4f1a\u589e\u52a0\uff0c\u4f1a\u9020\u6210\u5bf9 DB \u8bf7\u6c42\u91cf\u7684\u589e\u52a0\uff0c\u6240\u4ee5\u9700\u8981\u8bbe\u7f6e\u4e00\u4e2a\u5168\u5c40\u9650\u6d41\u503c\u9632\u6b62\u5bf9 DB \u7684\u51b2\u51fb\u3002 \u5355\u673a\u9650\u6d41\uff1a\u6307\u7684\u662f\u4e00\u7ec4\u5fae\u670d\u52a1\u96c6\u7fa4\uff0c\u901a\u8fc7\u5bf9\u5355\u4e2a\u673a\u5668\u7684\u9650\u6d41\uff0c\u8fbe\u5230\u670d\u52a1\u6574\u4f53\u9650\u6d41\u7684\u76ee\u7684\u3002 \u5728\u5fae\u670d\u52a1\u573a\u666f\u4e2d\uff0c\u56e0\u4e3a\u5168\u5c40\u9650\u6d41\u6bd4\u8f83\u96be\u505a\u5230\uff0c\u6240\u4ee5\u5355\u673a\u9650\u6d41\u5e94\u7528\u5f97\u6bd4\u8f83\u591a \u3002\u5355\u673a\u9650\u6d41\u53ef\u4ee5\u9002\u5e94\u5927\u90e8\u5206\u573a\u666f\uff0c\u6bd5\u7adf\u5728\u5206\u5e03\u5f0f\u573a\u666f\u4e2d\uff0c \u5355\u4e00\u673a\u5668\u8d1f\u8f7d\u63a7\u5236\u4f4f\uff0c\u5927\u591a\u6570\u573a\u666f\u4e5f\u5c31\u80fd\u63a7\u5236\u4f4f\u6574\u4e2a\u96c6\u7fa4\u7684\u8d1f\u8f7d \u3002 \u8fd9\u79cd\u9650\u6d41\u4e5f\u4e0d\u5f71\u54cd\u6269\u7f29\u5bb9\uff0cWeb \u673a\u5668\u56e0\u4e3a\u8d1f\u8f7d\u4e0d\u8db3\u53ef\u4ee5\u968f\u65f6\u6a2a\u5411\u6269\u5bb9\uff0c\u6b64\u65f6\u5355\u673a\u9650\u6d41\u503c\u4e0d\u9700\u8981\u6539\u52a8\uff1b \u800c\u5728\u5168\u5c40\u9650\u6d41\u4e2d\uff0c\u5f53 Web \u673a\u5668\u6269\u5bb9\u65f6\uff0c\u4e5f\u9700\u8981\u9650\u6d41\u503c\u968f\u4e4b\u6539\u52a8\uff0c\u4e3a\u6269\u7f29\u5bb9\u5e26\u6765\u4e86\u4e0d\u4fbf\u3002","title":"2-1-5 \u5355\u673a\u9650\u6d41\u548c\u5168\u5c40\u9650\u6d41"},{"location":"chap1/4chap1_router/#2-2","text":"\u7194\u65ad\u4e5f\u53eb\u65ad\u8def\u5668\uff0c\u65ad\u8def\u5668\u662f\u4e00\u79cd\u5f00\u5173\u6a21\u5f0f\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u53c2\u8003\u7535\u8def\u7cfb\u7edf\u4e2d\u7684\u8fc7\u8f7d\u4fdd\u62a4\u673a\u5236\u3002 \u5f53\u7ebf\u8def\u53d1\u751f\u77ed\u8def\u6216\u8005\u8fc7\u8f7d\u65f6\uff0c\u65ad\u8def\u5668\u80fd\u591f\u53ca\u65f6\u5207\u65ad\u7535\u8def\uff0c\u9632\u6b62\u53d1\u751f\u8fc7\u70ed\u3001\u8d77\u706b\u7b49\u6545\u969c \u7194\u65ad\u7ec4\u4ef6\u6709\u4e09\u79cd\u72b6\u6001 Closed\uff08\u5173\u95ed\uff09\uff1a\u9ed8\u8ba4\u521d\u59cb\u72b6\u6001\u4e3a\u5173\u95ed\u3002 Open\uff08\u5f00\u542f\uff09\uff1a\u5047\u5b9a\u6211\u4eec\u8bbe\u7f6e 10s \u7684\u6ed1\u52a8\u7a97\u53e3\uff0c\u5f53 10s \u5185\u7684\u9519\u8bef\u6bd4\u4f8b\u8fbe\u5230\u6211\u4eec\u8bbe\u5b9a\u9608\u503c\u7684 90% \uff0c\u6b64\u65f6\u72b6\u6001\u4f1a\u4ece Closed \u6539\u53d8\u4e3a Open\u3002 HalfOpen\uff08\u534a\u5f00\uff09\uff1a\u518d\u7ecf\u8fc7\u4e00\u4e2a 10s \u7684\u7a97\u53e3\u671f\uff0c\u6b64\u65f6\u7194\u65ad\u5668\u4f1a\u81ea\u52a8\u4ece Open \u8f6c\u79fb\u5230 HalfOpen \u72b6\u6001\u3002\u5728\u8fd9\u4e2a\u72b6\u6001\u4e0b\uff0c\u6211\u4eec\u4f1a\u6309\u7167\u7ebf\u6027\u7684\u65b9\u5f0f\u6765\u653e\u884c\u6d41\u91cf\uff0c\u516c\u5f0f\u5982\u4e0b\uff1a 0.5 * (Now() - Start())/Duration \u76f4\u5230 10s \u7684\u6ed1\u52a8\u7a97\u53e3\u5185\u63a5\u53e3\u6210\u529f\u7387\u91cd\u65b0\u6062\u590d\u5230 90% \u624d\u4f1a\u8f6c\u79fb\u5230 Closed \u72b6\u6001\uff0c\u53cd\u4e4b\u7ee7\u7eed\u53d8\u66f4\u4e3a Open \u72b6\u6001\u3002 \u7194\u65ad\u7684\u539f\u7406\u548c\u5b9e\u73b0\u90fd\u6bd4\u8f83\u7b80\u5355\uff0c\u4f46\u6ce8\u610f\u4ee5\u4e0b\u53c2\u6570\u8981\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8bbe\u7f6e\u3002 \u6ed1\u52a8\u7a97\u53e3\u65f6\u95f4 \uff1a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u6211\u4e00\u822c\u8bbe\u7f6e\u4e3a 10s\uff0c \u6ce8\u610f\u8fd9\u4e2a\u503c\u4e0d\u80fd\u592a\u957f\uff0c\u5426\u5219\u7194\u65ad\u7684\u6062\u590d\u65f6\u95f4\u4e5f\u4f1a\u968f\u4e4b\u53d8\u957f \u3002 \u89e6\u53d1\u6761\u4ef6 \uff1a\u5047\u5982\u662f HTTP \u670d\u52a1\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e0b\uff0c\u8fd9\u4e2a\u503c\u6211\u8bbe\u7f6e\u4e3a 499-600 \u4e4b\u95f4\u7684\u9519\u8bef\u7801\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a 499 \u9519\u8bef\u7801\u548c 5xx \u7684\u9519\u8bef\u7801\uff08499 \u9519\u8bef\u7801\u4ee3\u8868\u5ba2\u6237\u7aef\u4e3b\u52a8\u65ad\u5f00\uff0c\u4e00\u822c\u662f\u8d85\u65f6\u5f15\u8d77\u7684\uff0c\u800c 5xx \u9519\u8bef\u7801\u5728 HTTP \u4e2d\u662f\u670d\u52a1\u7aef\u9519\u8bef\uff09\u3002 \u5982\u679c\u662f\u975e HTTP \u670d\u52a1\uff0c\u5728 Service Mesh \u4f53\u7cfb\u4e0b\uff0c\u6211\u4f1a\u628a gRPC \u6216\u8005 Dubbo \u7684\u9519\u8bef\u7801\u8f6c\u6210\u5bf9\u5e94\u7684 HTTP \u9519\u8bef\u7801\u8fdb\u884c\u7edf\u4e00\u7684\u5904\u7406\u3002\u5177\u4f53\u7684\u8f6c\u6362\u89c4\u5219\uff0c\u5c31\u9700\u8981\u4f60\u6839\u636e\u81ea\u5df1\u7684\u7406\u89e3\u8fdb\u884c\u8bbe\u7f6e\u4e86\u3002 \u6ce8\u610f\u4e00\u822c Service Mesh \u4e2d\u7684\u7194\u65ad\u4e0d\u4f1a\u7edf\u8ba1\u4e1a\u52a1\u7684\u9519\u8bef\u7801\u505a\u7194\u65ad\u5904\u7406\uff0c\u53ea\u7edf\u8ba1\u7cfb\u7edf\u5c42\u9762\u7684\u9519\u8bef\u3002","title":"2-2 \u7194\u65ad"},{"location":"chap1/5chap1_conn_pool/","text":"\u7b2c\u4e94\u8282 \u8fde\u63a5\u6c60\uff1a\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u5f02 \u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u522b\uff0cHTTP \u8fde\u63a5\u6c60\u548c HTTP/2 \u8fde\u63a5\u6c60\u7684\u5dee\u522b\u3002\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u534f\u8bae\u6b63\u597d\u7b26\u5408\u8fd9\u91cc\u7684\u4e24\u4e2a\u7279\u6027\uff1a HTTP \u8fde\u63a5\u662f\u963b\u585e\u7684\u3001\u65e0\u6cd5\u590d\u7528\u7684\uff0cHTTP/2 \u7684\u8fde\u63a5\u662f\u975e\u963b\u585e\u7684\u3001\u591a\u8def\u590d\u7528\u7684\u3002 1\u3001\u8fde\u63a5 Connection TCP \u8fde\u63a5\u7684\u82f1\u8bed\u662f Transmission Control Protocol Connection\u3002 \u5728\u8ba1\u7b97\u673a\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u63d0\u5230\u6709\u72b6\u6001\u548c\u65e0\u72b6\u6001\uff1b \u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u6211\u4eec\u4e5f\u7ecf\u5e38\u4f1a\u63d0\u5230\u6709\u72b6\u6001\u670d\u52a1\u548c\u65e0\u72b6\u6001\u670d\u52a1\u3002 1-1 \u65e0\u72b6\u6001\u670d\u52a1 \u5176\u5b9e\u662f\u6307\u670d\u52a1\u5185\u5b58\u6216\u8005\u672c\u5730\u4e0d\u4fdd\u5b58\u4efb\u4f55\u8282\u70b9\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u505a\u5230\u670d\u52a1\u6269\u7f29\u5bb9\u3001\u8fc1\u79fb\u7684\u673a\u5668\u65e0\u5173\u6027 1-2 \u6709\u72b6\u6001\u670d\u52a1 \u670d\u52a1\u6240\u5728\u7684\u673a\u5668\u4e0a\u5b58\u6709\u8282\u70b9\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\u548c\u67d0\u4e2a\u5ba2\u6237\u7aef\u5efa\u7acb\u4e86 session \u8fde\u63a5 \u3002\u5728\u8d1f\u8f7d\u5747\u8861\u6a21\u5757\u6211\u4eec\u63d0\u5230\u4e86\u4e00\u79cd\u4f1a\u8bdd\u4fdd\u6301\uff08Sticky Sessions\uff09\u7684\u6280\u672f\uff0c\u8fd9\u79cd\u5c31\u5c5e\u4e8e\u6709\u72b6\u6001\u7684\u670d\u52a1\u3002 HTTP \u670d\u52a1\u662f\u65e0\u72b6\u6001\u7684\uff0c\u56e0\u4e3a\u5927\u591a\u6570\u60c5\u51b5 HTTP \u662f\u77ed\u8fde\u63a5\u7684\u3002\u76f8\u5bf9\u800c\u8a00\u5728\u4e00\u4e9b\u9700\u8981\u957f\u8fde\u63a5\u7684\u573a\u666f\uff0c\u56e0\u4e3a\u8fde\u63a5\u672c\u8eab\u7684\u6709\u72b6\u6001\u7684\u7279\u6027\uff0c \u7ecf\u5e38\u4f1a\u5728\u8fde\u63a5\u4e0a\u5b58\u50a8\u4e00\u4e9b\u8fde\u63a5\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u8fd9\u6837\u670d\u52a1\u4e5f\u6210\u4e86\u6709\u72b6\u6001\u670d\u52a1\u3002 TCP \u8fde\u63a5\u5b9a\u4e49 The reliability and flow control mechanisms described above require that TCPs initialize and maintain certain status information for each data stream. The combination of this information, including sockets, sequence numbers, and window sizes, is called a connection. 2\u3001HTTP 2-1 \u77ed\u8fde\u63a5\u548c\u957f\u8fde\u63a5 \u5b9e\u9645\u4e0a\u8fde\u63a5\u5e76\u6ca1\u6709\u957f\u77ed\u4e4b\u5206\uff0c\u53ea\u662f\u53d6\u51b3\u4e8e\u4f20\u8f93\u5b8c\u6570\u636e\u540e\u662f\u5426\u65ad\u5f00\uff0c\u6bd5\u7adf HTTP \u534f\u8bae\u4e5f\u662f\u57fa\u4e8e TCP \u534f\u8bae\u5b9e\u73b0\u7684 \u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u957f\u77ed\u8fde\u63a5\u7684\u53eb\u6cd5\u5462\uff1f \u8fd9\u662f\u56e0\u4e3a HTTP \u534f\u8bae\u591a\u7528\u4e8e Web \u4e2d\uff0cWeb \u7684\u4ea4\u4e92\u65b9\u5f0f\u591a\u662f\u4e00\u6765\u4e00\u56de\u7684\u6a21\u5f0f\uff0c\u8fd9\u6837\u7684\u5e94\u7528\u573a\u666f\u4e0b\uff0c\u4e0d\u9700\u8981\u670d\u52a1\u7aef\u63a8\u6570\u636e\uff0c\u6240\u4ee5\u5efa\u7acb\u8fde\u63a5\u540e\u7acb\u5373\u91ca\u653e\u4e5f\u662f\u5b8c\u5168\u53ef\u4ee5\u7684\u3002 \u5b9e\u9645\u4e0a\u968f\u7740\u4e92\u8054\u7f51\u7684\u53d1\u5c55\uff0c\u8bf7\u6c42\u91cf\u8d8a\u6765\u8d8a\u5927\uff0c\u4ee5\u5f80\u7684\u77ed\u8fde\u63a5\u6a21\u5f0f\u9891\u7e41\u7684\u5efa\u7acb\u2014\u91ca\u653e\u8fde\u63a5\uff0c\u9020\u6210\u670d\u52a1\u5668\u8d44\u6e90\u4ea7\u751f\u4e0d\u5fc5\u8981\u7684\u6d88\u8017\uff0c \u4f46\u73b0\u5728 HTTP \u534f\u8bae\u5f80\u5f80\u4f1a\u5229\u7528 Connection: Keep-alive \u8ba9\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4fdd\u6301\u957f\u8fde\u63a5\uff0c\u4f7f\u8fde\u63a5\u53ef\u4ee5\u91cd\u7528\uff1b \u5f53\u9700\u8981\u4e3b\u52a8\u65ad\u5f00\u8fde\u63a5\u7684\u65f6\u5019\uff0c\u53d1\u9001 Connection: close \u5c31\u53ef\u4ee5\u4e86\u3002 3\u3001\u8fde\u63a5\u6c60\u7684\u5b9e\u73b0 \u8fde\u63a5\u6c60\u5c31\u662f\u5c06\u5e94\u7528\u6240\u9700\u7684\u8fde\u63a5\u5bf9\u8c61\u653e\u5728\u6c60\u4e2d\uff0c\u6bcf\u6b21\u8bbf\u95ee\u65f6\u4ece\u6c60\u4e2d\u83b7\u53d6\uff0c\u4f7f\u7528\u5b8c\u6bd5\u518d\u653e\u56de\u6c60\u4e2d\uff0c\u4ee5\u8fbe\u5230\u8fde\u63a5\u590d\u7528\u7684\u76ee\u7684\uff0c \u51cf\u5c11\u521b\u5efa\u3001\u9500\u6bc1\u8fde\u63a5\u8fc7\u7a0b\u4e2d\u4e0d\u5fc5\u8981\u6d88\u8017\u7684\u8d44\u6e90 \u3002 HTTP \u662f\u4e00\u79cd\u963b\u585e\u5f0f\u534f\u8bae\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f ping-pong \u8fd9\u79cd\u4e00\u6765\u4e00\u56de\u7684\u6a21\u5f0f\uff0c\u5047\u8bbe\u4e00\u4e2a ping \u8bf7\u6c42\u4ece\u5ba2\u6237\u7aef\u53d1\u5230\u670d\u52a1\u5668\u7aef\uff0c\u90a3\u4e48\u8fd9\u6761\u8fde\u63a5\u4e00\u5b9a\u8981\u7b49\u5230\u670d\u52a1\u7aef\u8fd4\u56de\u4e86 pong \u4fe1\u606f\uff0c\u624d\u80fd\u7ee7\u7eed\u53d1\u9001\u4e0b\u4e00\u6761 ping \u4fe1\u606f\u3002 HTTP \u65e0\u6cd5\u590d\u7528\u8fde\u63a5\uff0c\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u8bf7\u6c42\u6bd4\u8f83\u591a\uff0c\u4f1a\u9020\u6210\u8bf7\u6c42\u7684\u963b\u585e\uff0c\u6240\u4ee5HTTP \u9700\u8981\u8fde\u63a5\u6c60\u8fd9\u6837\u7684\u6570\u636e\u7ed3\u6784\u505a\u5e76\u884c\u8bf7\u6c42 \u3002 \u7b80\u5355\u6765\u8bf4\uff0c\u6211\u4eec\u53ea\u8981\u5efa\u7acb\u591a\u6761\u8fde\u63a5\uff0c\u7528\u4e00\u4e2a\u6570\u7ec4\u7ef4\u62a4\u591a\u6761\u8fde\u63a5\u5c31\u884c\u4e86\uff1b \u5982\u679c\u4f7f\u7528\u4e00\u6761\u8fde\u63a5\uff0c\u90a3\u4e48\u4ece\u6570\u7ec4\u91cc\u62ff\u51fa\u8fd9\u6761\u8fde\u63a5\uff0c\u4f7f\u7528\u5b8c\u518d\u653e\u5165\u6570\u7ec4\u5373\u53ef\u3002 \u5f53\u6570\u7ec4\u4e3a\u7a7a\u65f6\uff0c\u53ea\u8981\u5efa\u7acb\u65b0\u7684\u8fde\u63a5\u5c31\u53ef\u4ee5\u4e86\u3002 \u5177\u4f53\u7684\u5b9e\u73b0\u4f60\u53ef\u4ee5\u53c2\u8003 go-micro \u7684\u901a\u7528\u8fde\u63a5\u6c60\u8bbe\u8ba1 \uff1a package pool import ( \"sync\" \"time\" \"github.com/google/uuid\" \"github.com/micro/go-micro/v2/transport\" ) type pool struct { size int // \u8fde\u63a5\u6c60\u5927\u5c0f\uff0c\u5f88\u591a\u7c7b\u5e93\u4e5f\u53eb\u4f5c maxIdleConns\uff0c\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570 // \u591a\u4e45\u540e\u8fde\u63a5\u4f1a\u65ad\u5f00\uff0c\u5f88\u591a\u8fde\u63a5\u6c60\u4f1a\u5728\u4e00\u5b9a\u65f6\u95f4\u540e\u65ad\u5f00\u8fde\u63a5\uff0c\u7136\u540e\u5c06\u65b0\u9c9c\u7684\u8fde\u63a5\u653e\u5165\u8fde\u63a5\u6c60 // \u6bd4\u5982 HTTP \u4e2d\u56e0\u4e3a\u670d\u52a1\u5668\u7aef\u56e0\u4e3a keepalive \u8fc7\u671f\uff0c\u4f1a\u4e3b\u52a8\u65ad\u5f00\u8fde\u63a5\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u8bbe\u7f6e\u4e00\u4e2a\u6bd4 keepalive \u65f6\u95f4\u77ed\u7684 TTL // \u786e\u4fdd\u8fde\u63a5\u5148\u88ab\u79fb\u51fa\uff0c\u5c31\u4e0d\u4f1a\u62ff\u5230\u5df2\u65ad\u5f00\u7684\u8fde\u63a5\u4e86 ttl time.Duration // go-micro \u8fde\u63a5\u5c42\u62bd\u8c61\u7c7b\uff0c\u5f53\u4f5c\u8fde\u63a5\u5bf9\u8c61\u7c7b\u5373\u53ef tr transport.Transport sync.Mutex // \u4e92\u65a5\u9501 conns map[string][]*poolConn // \u5b58\u50a8\u8fde\u63a5\u5bf9\u8c61\u7684\u6570\u7ec4 } type poolConn struct { transport.Client // go-micro \u62bd\u8c61\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u5c42\u5bf9\u8c61 id string // \u552f\u4e00 ID created time.Time // \u8fde\u63a5\u521b\u5efa\u65f6\u95f4 } // \u521b\u5efa\u8fde\u63a5\u6c60\u5bf9\u8c61 func newPool(options Options) *pool { return &pool{ size: options.Size, tr: options.Transport, ttl: options.TTL, conns: make(map[string][]*poolConn), } } // \u5173\u95ed\u8fde\u63a5\u6c60\uff0c\u91ca\u653e\u6240\u6709\u8fde\u63a5 func (p *pool) Close() error { p.Lock() for k, c := range p.conns { for _, conn := range c { conn.Client.Close() } delete(p.conns, k) } p.Unlock() return nil } // \u83b7\u53d6\u4e00\u4e2a\u8fde\u63a5\u5bf9\u8c61 func (p *pool) Get(addr string, opts ...transport.DialOption) (Conn, error) { p.Lock() conns := p.conns[addr] //\u6839\u636e\u5730\u5740\u83b7\u53d6\u8fde\u63a5\u6c60\u6570\u7ec4 // \u5faa\u73af\u76f4\u5230\u62ff\u5230\u4e00\u4e2a\u53ef\u7528\u7684\u8fde\u63a5 // \u5426\u5219\u521b\u5efa\u4e00\u4e2a\u65b0\u8fde\u63a5\u8fd4\u56de for len(conns) > 0 { // \u83b7\u53d6\u4e00\u4e2a\u8fde\u63a5 conn := conns[len(conns)-1] conns = conns[:len(conns)-1] p.conns[addr] = conns // \u5982\u679c\u8d85\u65f6\u5219\u4e3b\u52a8\u5173\u95ed\u8fde\u63a5 if d := time.Since(conn.Created()); d > p.ttl { conn.Client.Close() continue } // \u83b7\u5f97\u4e86\u53ef\u7528\u7684\u8fde\u63a5\uff0c\u8fd4\u56de\u65b0\u8fde\u63a5 p.Unlock() return conn, nil } p.Unlock() // \u521b\u5efa\u65b0\u8fde\u63a5 c, err := p.tr.Dial(addr, opts...) if err != nil { return nil, err } return &poolConn{ Client: c, id: uuid.New().String(), created: time.Now(), }, nil } // \u4f7f\u7528\u5b8c\u5c06\u8fde\u63a5\u653e\u56de\u8fde\u63a5\u6c60 func (p *pool) Release(conn Conn, err error) error { // \u5982\u679c\u4e0a\u5c42\u53d1\u751f\u9519\u8bef\uff0c\u5219\u4e0d\u653e\u56de\u8fde\u63a5\u6c60 if err != nil { return conn.(*poolConn).Client.Close() } // \u653e\u5165\u6ca1\u6709\u9519\u8bef\u7684\u8fde\u63a5 p.Lock() conns := p.conns[conn.Remote()] if len(conns) >= p.size { p.Unlock() return conn.(*poolConn).Client.Close() } p.conns[conn.Remote()] = append(conns, conn.(*poolConn)) p.Unlock() return nil } \u5b9e\u9645\u4e0a\u50cf DB \u5c42\u7684\u534f\u8bae\uff0c\u6bd4\u5982 Redis\u3001MySQL \u4e5f\u7c7b\u4f3c HTTP \u7684\u4e00\u6765\u4e00\u56de\u7684\u534f\u8bae\uff0c\u6240\u4ee5\u8fd9\u5957\u8fde\u63a5\u6c60\u7684\u8bbe\u8ba1\u4e5f\u53ef\u4ee5\u5e94\u7528\u5728 Redis \u548c MySQL \u4e0a\u9762\uff0c\u53ef\u4ee5\u8bf4\u5e94\u7528\u975e\u5e38\u5e7f\u6cdb\u3002 MaxIdleConns \u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570 \u8fd9\u4e2a\u503c\u7ecf\u5e38\u4f1a\u548c MaxConns \u641e\u6df7\uff0c\u4f46\u4f60\u8981\u6ce8\u610f\u8fd9\u4e2a\u503c\u4e0d\u662f\u6700\u5927\u8fde\u63a5\u6570\uff0c\u800c\u662f\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\uff0c\u7ed3\u5408\u6211\u4eec\u4e0a\u9762\u8bb2\u7684\u8fde\u63a5\u6c60\u5b9e\u73b0\u539f\u7406\uff0c \u8fd9\u4e2a\u503c\u53ef\u4ee5\u7406\u89e3\u4e3a\u8fde\u63a5\u6c60\u7684\u5927\u5c0f \u3002 \u8fd9\u4e2a\u503c\u7684\u8bbe\u7f6e\u5f88\u6709\u8bb2\u7a76\uff0c \u9700\u8981\u7ed3\u5408\u540e\u7aef\u670d\u52a1\u7684\u8fde\u63a5\u627f\u8f7d\u80fd\u529b\u8bbe\u7f6e \u3002\u5982\u679c\u8bbe\u7f6e\u5f97\u592a\u5927\uff0c\u5047\u5982\u8bbe\u7f6e 1000\uff0c\u59cb\u53d1\u96c6\u7fa4\u6709 100 \u53f0\u673a\u5668\uff0c\u90a3\u4e48\u5c31\u4f1a\u5efa\u7acb 10w \u7684\u6301\u4e45\u8fde\u63a5\uff0c\u8fd9\u5bf9\u540e\u7aef\u670d\u52a1\u7684\u538b\u529b\u53ef\u60f3\u800c\u77e5\u3002\u4f46\u4e5f\u4e0d\u80fd\u8bbe\u7f6e\u5f97\u592a\u5c0f\uff0c\u4e3e\u4e2a\u6781\u7aef\u7684\u4f8b\u5b50\uff0c\u5047\u5982\u8bbe\u7f6e 1\uff0c\u5f53\u5e76\u53d1\u6570\u91cf\u4e0a\u53bb\u65f6\uff0c\u4f1a\u51fa\u73b0\u4e24\u79cd\u60c5\u51b5\uff1a \u5982\u679c\u8fde\u63a5\u6c60\u6ee1\u4e86\uff0c\u5c31\u4f1a\u5efa\u7acb\u65b0\u7684\u8fde\u63a5\uff0c\u4e0d\u65ad\u5efa\u7acb\u7684\u65b0\u8fde\u63a5\u4f1a\u8017\u5149\u540e\u7aef\u670d\u52a1\u7684\u8d44\u6e90\uff1b \u65b0\u5efa\u7acb\u7684\u8fde\u63a5\u5728\u7528\u5b8c\u4e4b\u540e\uff0c\u6709\u4e24\u79cd\u9009\u62e9\u2014\u2014\u8fde\u63a5\u6c60\u6709\u4f59\u91cf\u7684\u60c5\u51b5\u4f1a\u653e\u5165\u8fde\u63a5\u6c60\uff0c\u53cd\u4e4b\u4f1a\u76f4\u63a5\u4e22\u5f03\uff0c\u8fd9\u79cd\u60c5\u51b5\u5728\u77ac\u95f4\u5f88\u5bb9\u6613\u51fa\u73b0\uff0c\u8fde\u63a5\u6c60\u6301\u7eed\u77ac\u95f4\u88ab\u7a7a\u95f2\u8fde\u63a5\u5360\u6ee1\uff08\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\u7684\u53eb\u6cd5\u4e5f\u7531\u6b64\u5f97\u6765\uff09\uff0c\u5bfc\u81f4\u65b0\u8fde\u63a5\u65e0\u6cd5\u653e\u56de\u8fde\u63a5\u6c60\uff0c\u8fdb\u800c\u4e22\u5f03\uff0c\u8fd9\u6837\u5c31\u4f1a\u5f62\u6210\u5efa\u7acb\u8fde\u63a5\u2014\u7528\u5b8c\u4e22\u5f03\u7684\u6076\u6027\u5faa\u73af\uff0c\u8fde\u63a5\u6c60\u7684\u4f5c\u7528\u4e5f\u5c31\u6d88\u5931\u4e86\uff0c\u9000\u5316\u6210\u4e86\u77ed\u8fde\u63a5\u3002 \u7ecf\u9a8c\u503c\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u8fde\u63a5\u6c60\u5bb9\u91cf\u8bbe\u7f6e\u5728 10-100 \u7684\u533a\u95f4\u5185\u662f\u6bd4\u8f83\u5408\u7406\u7684 \u3002 4\u3001HTTP/2 HTTP/2 \u8bbe\u8ba1\u7684\u6700\u5927\u76ee\u7684\u5c31\u662f\u89e3\u51b3 HTTP \u8fde\u63a5\u963b\u585e\u7684\u95ee\u9898 \u3002\u5f53\u7136\u4e5f\u6709\u5f88\u591a\u5176\u4ed6\u5185\u5bb9\u7684\u4f18\u5316\uff0c\u6bd4\u5982 header \u5934\u90e8\u538b\u7f29\u3001\u57fa\u4e8e\u4e8c\u8fdb\u5236\u7684\u4f20\u8f93\u534f\u8bae\u7b49\u3002\u4f46\u6211\u4eec\u8fd8\u662f\u628a\u5173\u6ce8\u70b9\u96c6\u4e2d\u5230\u8fde\u63a5\u5c42\u9762\u3002 4-1 \u5176\u4ed6\u5185\u5bb9\u7684\u4f18\u5316 \u6bd4\u5982 header \u5934\u90e8\u538b\u7f29\u3001\u57fa\u4e8e\u4e8c\u8fdb\u5236\u7684\u4f20\u8f93\u534f\u8bae\u7b49\u3002\u4f46\u6211\u4eec\u8fd8\u662f\u628a\u5173\u6ce8\u70b9\u96c6\u4e2d\u5230\u8fde\u63a5\u5c42\u9762\u3002 4-2 \u591a\u8def\u590d\u7528\uff08Multiplexing\uff09 HTTP/2 \u4e2d\u7684\u591a\u8def\u590d\u7528\uff0c\u6307\u7684\u662f\u5728 \u4e00\u6761\u8fde\u63a5\u4e2d\u53ef\u4ee5\u540c\u65f6\u5904\u7406\u591a\u4e2a\u8bf7\u6c42 \uff0c\u8fd9\u6b63\u662f\u89e3\u51b3\u4e86 HTTP \u4e2d\u4e00\u4e2a\u8fde\u63a5\u540c\u65f6\u53ea\u80fd\u5904\u7406\u4e00\u4e2a\u8bf7\u6c42\u7684\u95ee\u9898\u3002\u8fd9\u548c Linux IO \u591a\u8def\u590d\u7528\u662f\u4e0d\u662f\u4e5f\u6709\u4e9b\u7c7b\u4f3c\uff1f\u4e4b\u6240\u4ee5\u90fd\u53eb\u591a\u8def\u590d\u7528\uff0c\u5c31\u662f\u56e0\u4e3a\u5b83\u4eec\u57fa\u672c\u4e0a\u90fd\u590d\u7528\u4e86\u67d0\u4e2a\u901a\u9053\uff0c\u6bd4\u5982 HTTP/2 \u590d\u7528\u4e86\u8fde\u63a5\uff0cLinux IO \u590d\u7528\u4e86\u8fdb\u7a0b \u3002 HTTP/2 \u62bd\u8c61\u51fa\u4e86\u4e00\u79cd\u6d41\uff08stream\uff09\u7684\u6982\u5ff5\uff0c \u5ba2\u6237\u7aef\u5728\u5df2\u7ecf\u5efa\u7acb\u7684\u8fde\u63a5\u4e0a\u53d1\u9001\u6d41\uff0c\u800c\u4e0d\u662f\u50cf HTTP 1.0 \u4e00\u6837\u76f4\u63a5\u53d1\u9001\u6570\u636e\u5305\uff0c\u6bcf\u4e2a\u6d41\u90fd\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bc6\u53f7 \uff0c\u8fd9\u6837\u5ba2\u6237\u7aef\u5c31\u53ef\u4ee5\u4e0d\u7ba1\u670d\u52a1\u7aef\u662f\u5426\u5df2\u7ecf\u8fd4\u56de\u6570\u636e\u800c\u4e0d\u65ad\u5f80\u670d\u52a1\u7aef\u53d1\u9001\u65b0\u7684\u6d41\u3002 \u56e0\u4e3a\u6bcf\u4e2a\u6d41\u6709\u72ec\u7acb\u7684 ID\uff0c\u5728\u670d\u52a1\u7aef\u8fd4\u56de\u5904\u7406\u6d41\u7684\u6570\u636e\u5305\u65f6\uff0c\u53ea\u8981\u6839\u636e\u8fd9\u4e2a\u6d41\u7684 ID \u627e\u5230\u53d1\u9001\u7684\u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u4e00\u4e00\u5bf9\u5e94 \u3002 \u8fd9\u4e2a\u6d41\u6211\u4eec\u53ef\u4ee5\u7406\u89e3\u6210\u4e00\u4e2a\u865a\u62df\u8fde\u63a5 \u5728\u4ee3\u7801\u5b9e\u73b0\u65f6\uff0c\u4e5f\u53ef\u4ee5\u770b\u5230 stream \u5176\u5b9e\u5c31\u662f\u7528\u865a\u62df\u8fde\u63a5\u7684\u65b9\u5f0f\u5b9e\u73b0\u7684\u3002\u6211\u4eec\u5728\u4e00\u6761 TCP \u8fde\u63a5\u4e0a\uff0c\u5efa\u7acb\u4e86\u5f88\u591a\u865a\u62df\u8fde\u63a5\uff0c\u8fd9\u4e9b\u865a\u62df\u8fde\u63a5\uff08\u4e5f\u5c31\u662f\u6d41\uff09\u7684\u521b\u5efa\u51e0\u4e4e\u6ca1\u6709\u6210\u672c\uff0c\u5728\u6bcf\u6b21\u53d1\u9001\u65b0\u7684\u8bf7\u6c42\u524d\uff0c\u76f4\u63a5 new stream() \u8fd4\u56de\u65b0\u7684\u6570\u636e\u6d41\uff08\u865a\u62df\u8fde\u63a5\uff09\uff0c\u7136\u540e\u53d1\u9001\u6570\u636e\u5373\u53ef\u3002 4-3 HTTP/2 \u5230\u5e95\u9700\u4e0d\u9700\u8981\u8fde\u63a5\u6c60\uff1f \u9700\u8981\uff0c\u4f46\u548c\u4f20\u7edf\u7684\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u4e5f\u5c31\u662f HTTP 1.0 \u7684\u8fde\u63a5\u6c60\u6709\u4e00\u4e9b\u533a\u522b\u3002\u5b9e\u9645\u4e0aHTTP/2 \u5df2\u7ecf\u590d\u7528\u4e86\u8fde\u63a5\uff0c\u4ece\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u8bb2\u5b9e\u73b0\u8fde\u63a5\u6c60\u5df2\u7ecf\u6ca1\u6709\u592a\u591a\u610f\u4e49\u4e86\uff0c\u591a\u8def\u590d\u7528\u505a\u5230\u4e00\u6761\u8fde\u63a5\u5c31\u53ef\u4ee5\u4e86\uff0c\u4f46\u56e0\u4e3a HTTP 2 .0 \u8fd8\u662f\u57fa\u4e8e TCP \u8fde\u63a5\u7684\uff0c\u800c TCP \u5b58\u5728\u961f\u5934\u963b\u585e\u7684\u95ee\u9898\uff0c \u6bd4\u5982\u67d0\u6761\u8fde\u63a5\u7a81\u7136\u9047\u5230\u4e86\u7f51\u7edc\u91cd\u4f20\uff0c\u6b64\u65f6\u4f1a\u963b\u585e\u8fde\u63a5 \u3002\u53e6\u5916\u5728\u4e00\u4e9b\u9ad8\u5e76\u53d1\u573a\u666f\uff0c\u4e00\u6761\u8fde\u63a5\u96be\u4ee5\u8dd1\u6ee1\u5e26\u5bbd\uff0c\u4e5f\u9700\u8981\u521b\u5efa\u591a\u6761\u8fde\u63a5\u3002 \u6240\u4ee5 HTTP/2 \u7684\u8fde\u63a5\u6c60\u5b9e\u73b0\u6709\u6240\u4e0d\u540c\uff0c \u65b0\u8fde\u63a5\u7684\u521b\u5efa\u6761\u4ef6\u5f80\u5f80\u662f\u4f9d\u636e maxConcurrentStreams \u7684\u53c2\u6570\uff0c\u5f53\u540c\u65f6\u8bf7\u6c42\u4e2d\u7684 stream \u7684\u6570\u91cf\u8d85\u8fc7\u4e0a\u9650\u65f6\uff0c\u624d\u521b\u5efa\u65b0\u7684\u8fde\u63a5\u3002 \u6240\u4ee5\u5728 gRPC \u548c HTTP/2 \u4e2d\u8fd9\u4e2a\u53c2\u6570\u7684\u8bbe\u7f6e\u975e\u5e38\u91cd\u8981\uff0c\u5b83\u7684\u91cd\u8981\u6027\u53ef\u4ee5\u7b49\u540c\u4e8e\u4e0a\u9762\u8bb2\u7684 MaxIdleConns \u53c2\u6570\u3002\u8fd9\u6837\u7684\u8bbe\u8ba1\u4e5f\u5f88\u597d\u7406\u89e3\uff0c\u56e0\u4e3a HTTP/2 \u5df2\u7ecf\u53ef\u4ee5\u590d\u7528\u540c\u4e00\u6761\u8fde\u63a5\u53d1\u9001\u591a\u4e2a\u8bf7\u6c42\u4e86\uff0c\u81ea\u7136\u6ca1\u6709\u5fc5\u8981\u4e00\u4e2a\u8bf7\u6c42\u521b\u5efa\u4e00\u4e2a\u8fde\u63a5\uff0c\u53ea\u9700\u7b49\u8fd9\u4e2a\u8fde\u63a5\u65e0\u6cd5\u6ee1\u8db3\u8bbe\u7f6e\u7684\u6700\u5927 stream \u7684\u6761\u4ef6\u65f6\u624d\u5efa\u7acb\u65b0\u7684\u8fde\u63a5\u3002","title":"\u7b2c\u4e94\u8282 \u8fde\u63a5\u6c60\uff1a\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u5f02"},{"location":"chap1/5chap1_conn_pool/#_1","text":"\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u522b\uff0cHTTP \u8fde\u63a5\u6c60\u548c HTTP/2 \u8fde\u63a5\u6c60\u7684\u5dee\u522b\u3002\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u534f\u8bae\u6b63\u597d\u7b26\u5408\u8fd9\u91cc\u7684\u4e24\u4e2a\u7279\u6027\uff1a HTTP \u8fde\u63a5\u662f\u963b\u585e\u7684\u3001\u65e0\u6cd5\u590d\u7528\u7684\uff0cHTTP/2 \u7684\u8fde\u63a5\u662f\u975e\u963b\u585e\u7684\u3001\u591a\u8def\u590d\u7528\u7684\u3002","title":"\u7b2c\u4e94\u8282 \u8fde\u63a5\u6c60\uff1a\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u548c\u591a\u8def\u590d\u7528\u8fde\u63a5\u6c60\u7684\u5dee\u5f02"},{"location":"chap1/5chap1_conn_pool/#1-connection","text":"TCP \u8fde\u63a5\u7684\u82f1\u8bed\u662f Transmission Control Protocol Connection\u3002 \u5728\u8ba1\u7b97\u673a\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u63d0\u5230\u6709\u72b6\u6001\u548c\u65e0\u72b6\u6001\uff1b \u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u6211\u4eec\u4e5f\u7ecf\u5e38\u4f1a\u63d0\u5230\u6709\u72b6\u6001\u670d\u52a1\u548c\u65e0\u72b6\u6001\u670d\u52a1\u3002","title":"1\u3001\u8fde\u63a5 Connection"},{"location":"chap1/5chap1_conn_pool/#1-1","text":"\u5176\u5b9e\u662f\u6307\u670d\u52a1\u5185\u5b58\u6216\u8005\u672c\u5730\u4e0d\u4fdd\u5b58\u4efb\u4f55\u8282\u70b9\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u505a\u5230\u670d\u52a1\u6269\u7f29\u5bb9\u3001\u8fc1\u79fb\u7684\u673a\u5668\u65e0\u5173\u6027","title":"1-1 \u65e0\u72b6\u6001\u670d\u52a1"},{"location":"chap1/5chap1_conn_pool/#1-2","text":"\u670d\u52a1\u6240\u5728\u7684\u673a\u5668\u4e0a\u5b58\u6709\u8282\u70b9\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\u548c\u67d0\u4e2a\u5ba2\u6237\u7aef\u5efa\u7acb\u4e86 session \u8fde\u63a5 \u3002\u5728\u8d1f\u8f7d\u5747\u8861\u6a21\u5757\u6211\u4eec\u63d0\u5230\u4e86\u4e00\u79cd\u4f1a\u8bdd\u4fdd\u6301\uff08Sticky Sessions\uff09\u7684\u6280\u672f\uff0c\u8fd9\u79cd\u5c31\u5c5e\u4e8e\u6709\u72b6\u6001\u7684\u670d\u52a1\u3002 HTTP \u670d\u52a1\u662f\u65e0\u72b6\u6001\u7684\uff0c\u56e0\u4e3a\u5927\u591a\u6570\u60c5\u51b5 HTTP \u662f\u77ed\u8fde\u63a5\u7684\u3002\u76f8\u5bf9\u800c\u8a00\u5728\u4e00\u4e9b\u9700\u8981\u957f\u8fde\u63a5\u7684\u573a\u666f\uff0c\u56e0\u4e3a\u8fde\u63a5\u672c\u8eab\u7684\u6709\u72b6\u6001\u7684\u7279\u6027\uff0c \u7ecf\u5e38\u4f1a\u5728\u8fde\u63a5\u4e0a\u5b58\u50a8\u4e00\u4e9b\u8fde\u63a5\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u8fd9\u6837\u670d\u52a1\u4e5f\u6210\u4e86\u6709\u72b6\u6001\u670d\u52a1\u3002 TCP \u8fde\u63a5\u5b9a\u4e49 The reliability and flow control mechanisms described above require that TCPs initialize and maintain certain status information for each data stream. The combination of this information, including sockets, sequence numbers, and window sizes, is called a connection.","title":"1-2 \u6709\u72b6\u6001\u670d\u52a1"},{"location":"chap1/5chap1_conn_pool/#2http","text":"","title":"2\u3001HTTP"},{"location":"chap1/5chap1_conn_pool/#2-1","text":"\u5b9e\u9645\u4e0a\u8fde\u63a5\u5e76\u6ca1\u6709\u957f\u77ed\u4e4b\u5206\uff0c\u53ea\u662f\u53d6\u51b3\u4e8e\u4f20\u8f93\u5b8c\u6570\u636e\u540e\u662f\u5426\u65ad\u5f00\uff0c\u6bd5\u7adf HTTP \u534f\u8bae\u4e5f\u662f\u57fa\u4e8e TCP \u534f\u8bae\u5b9e\u73b0\u7684 \u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u957f\u77ed\u8fde\u63a5\u7684\u53eb\u6cd5\u5462\uff1f \u8fd9\u662f\u56e0\u4e3a HTTP \u534f\u8bae\u591a\u7528\u4e8e Web \u4e2d\uff0cWeb \u7684\u4ea4\u4e92\u65b9\u5f0f\u591a\u662f\u4e00\u6765\u4e00\u56de\u7684\u6a21\u5f0f\uff0c\u8fd9\u6837\u7684\u5e94\u7528\u573a\u666f\u4e0b\uff0c\u4e0d\u9700\u8981\u670d\u52a1\u7aef\u63a8\u6570\u636e\uff0c\u6240\u4ee5\u5efa\u7acb\u8fde\u63a5\u540e\u7acb\u5373\u91ca\u653e\u4e5f\u662f\u5b8c\u5168\u53ef\u4ee5\u7684\u3002 \u5b9e\u9645\u4e0a\u968f\u7740\u4e92\u8054\u7f51\u7684\u53d1\u5c55\uff0c\u8bf7\u6c42\u91cf\u8d8a\u6765\u8d8a\u5927\uff0c\u4ee5\u5f80\u7684\u77ed\u8fde\u63a5\u6a21\u5f0f\u9891\u7e41\u7684\u5efa\u7acb\u2014\u91ca\u653e\u8fde\u63a5\uff0c\u9020\u6210\u670d\u52a1\u5668\u8d44\u6e90\u4ea7\u751f\u4e0d\u5fc5\u8981\u7684\u6d88\u8017\uff0c \u4f46\u73b0\u5728 HTTP \u534f\u8bae\u5f80\u5f80\u4f1a\u5229\u7528 Connection: Keep-alive \u8ba9\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4fdd\u6301\u957f\u8fde\u63a5\uff0c\u4f7f\u8fde\u63a5\u53ef\u4ee5\u91cd\u7528\uff1b \u5f53\u9700\u8981\u4e3b\u52a8\u65ad\u5f00\u8fde\u63a5\u7684\u65f6\u5019\uff0c\u53d1\u9001 Connection: close \u5c31\u53ef\u4ee5\u4e86\u3002","title":"2-1 \u77ed\u8fde\u63a5\u548c\u957f\u8fde\u63a5"},{"location":"chap1/5chap1_conn_pool/#3","text":"\u8fde\u63a5\u6c60\u5c31\u662f\u5c06\u5e94\u7528\u6240\u9700\u7684\u8fde\u63a5\u5bf9\u8c61\u653e\u5728\u6c60\u4e2d\uff0c\u6bcf\u6b21\u8bbf\u95ee\u65f6\u4ece\u6c60\u4e2d\u83b7\u53d6\uff0c\u4f7f\u7528\u5b8c\u6bd5\u518d\u653e\u56de\u6c60\u4e2d\uff0c\u4ee5\u8fbe\u5230\u8fde\u63a5\u590d\u7528\u7684\u76ee\u7684\uff0c \u51cf\u5c11\u521b\u5efa\u3001\u9500\u6bc1\u8fde\u63a5\u8fc7\u7a0b\u4e2d\u4e0d\u5fc5\u8981\u6d88\u8017\u7684\u8d44\u6e90 \u3002 HTTP \u662f\u4e00\u79cd\u963b\u585e\u5f0f\u534f\u8bae\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f ping-pong \u8fd9\u79cd\u4e00\u6765\u4e00\u56de\u7684\u6a21\u5f0f\uff0c\u5047\u8bbe\u4e00\u4e2a ping \u8bf7\u6c42\u4ece\u5ba2\u6237\u7aef\u53d1\u5230\u670d\u52a1\u5668\u7aef\uff0c\u90a3\u4e48\u8fd9\u6761\u8fde\u63a5\u4e00\u5b9a\u8981\u7b49\u5230\u670d\u52a1\u7aef\u8fd4\u56de\u4e86 pong \u4fe1\u606f\uff0c\u624d\u80fd\u7ee7\u7eed\u53d1\u9001\u4e0b\u4e00\u6761 ping \u4fe1\u606f\u3002 HTTP \u65e0\u6cd5\u590d\u7528\u8fde\u63a5\uff0c\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u8bf7\u6c42\u6bd4\u8f83\u591a\uff0c\u4f1a\u9020\u6210\u8bf7\u6c42\u7684\u963b\u585e\uff0c\u6240\u4ee5HTTP \u9700\u8981\u8fde\u63a5\u6c60\u8fd9\u6837\u7684\u6570\u636e\u7ed3\u6784\u505a\u5e76\u884c\u8bf7\u6c42 \u3002 \u7b80\u5355\u6765\u8bf4\uff0c\u6211\u4eec\u53ea\u8981\u5efa\u7acb\u591a\u6761\u8fde\u63a5\uff0c\u7528\u4e00\u4e2a\u6570\u7ec4\u7ef4\u62a4\u591a\u6761\u8fde\u63a5\u5c31\u884c\u4e86\uff1b \u5982\u679c\u4f7f\u7528\u4e00\u6761\u8fde\u63a5\uff0c\u90a3\u4e48\u4ece\u6570\u7ec4\u91cc\u62ff\u51fa\u8fd9\u6761\u8fde\u63a5\uff0c\u4f7f\u7528\u5b8c\u518d\u653e\u5165\u6570\u7ec4\u5373\u53ef\u3002 \u5f53\u6570\u7ec4\u4e3a\u7a7a\u65f6\uff0c\u53ea\u8981\u5efa\u7acb\u65b0\u7684\u8fde\u63a5\u5c31\u53ef\u4ee5\u4e86\u3002 \u5177\u4f53\u7684\u5b9e\u73b0\u4f60\u53ef\u4ee5\u53c2\u8003 go-micro \u7684\u901a\u7528\u8fde\u63a5\u6c60\u8bbe\u8ba1 \uff1a package pool import ( \"sync\" \"time\" \"github.com/google/uuid\" \"github.com/micro/go-micro/v2/transport\" ) type pool struct { size int // \u8fde\u63a5\u6c60\u5927\u5c0f\uff0c\u5f88\u591a\u7c7b\u5e93\u4e5f\u53eb\u4f5c maxIdleConns\uff0c\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570 // \u591a\u4e45\u540e\u8fde\u63a5\u4f1a\u65ad\u5f00\uff0c\u5f88\u591a\u8fde\u63a5\u6c60\u4f1a\u5728\u4e00\u5b9a\u65f6\u95f4\u540e\u65ad\u5f00\u8fde\u63a5\uff0c\u7136\u540e\u5c06\u65b0\u9c9c\u7684\u8fde\u63a5\u653e\u5165\u8fde\u63a5\u6c60 // \u6bd4\u5982 HTTP \u4e2d\u56e0\u4e3a\u670d\u52a1\u5668\u7aef\u56e0\u4e3a keepalive \u8fc7\u671f\uff0c\u4f1a\u4e3b\u52a8\u65ad\u5f00\u8fde\u63a5\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u8bbe\u7f6e\u4e00\u4e2a\u6bd4 keepalive \u65f6\u95f4\u77ed\u7684 TTL // \u786e\u4fdd\u8fde\u63a5\u5148\u88ab\u79fb\u51fa\uff0c\u5c31\u4e0d\u4f1a\u62ff\u5230\u5df2\u65ad\u5f00\u7684\u8fde\u63a5\u4e86 ttl time.Duration // go-micro \u8fde\u63a5\u5c42\u62bd\u8c61\u7c7b\uff0c\u5f53\u4f5c\u8fde\u63a5\u5bf9\u8c61\u7c7b\u5373\u53ef tr transport.Transport sync.Mutex // \u4e92\u65a5\u9501 conns map[string][]*poolConn // \u5b58\u50a8\u8fde\u63a5\u5bf9\u8c61\u7684\u6570\u7ec4 } type poolConn struct { transport.Client // go-micro \u62bd\u8c61\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u5c42\u5bf9\u8c61 id string // \u552f\u4e00 ID created time.Time // \u8fde\u63a5\u521b\u5efa\u65f6\u95f4 } // \u521b\u5efa\u8fde\u63a5\u6c60\u5bf9\u8c61 func newPool(options Options) *pool { return &pool{ size: options.Size, tr: options.Transport, ttl: options.TTL, conns: make(map[string][]*poolConn), } } // \u5173\u95ed\u8fde\u63a5\u6c60\uff0c\u91ca\u653e\u6240\u6709\u8fde\u63a5 func (p *pool) Close() error { p.Lock() for k, c := range p.conns { for _, conn := range c { conn.Client.Close() } delete(p.conns, k) } p.Unlock() return nil } // \u83b7\u53d6\u4e00\u4e2a\u8fde\u63a5\u5bf9\u8c61 func (p *pool) Get(addr string, opts ...transport.DialOption) (Conn, error) { p.Lock() conns := p.conns[addr] //\u6839\u636e\u5730\u5740\u83b7\u53d6\u8fde\u63a5\u6c60\u6570\u7ec4 // \u5faa\u73af\u76f4\u5230\u62ff\u5230\u4e00\u4e2a\u53ef\u7528\u7684\u8fde\u63a5 // \u5426\u5219\u521b\u5efa\u4e00\u4e2a\u65b0\u8fde\u63a5\u8fd4\u56de for len(conns) > 0 { // \u83b7\u53d6\u4e00\u4e2a\u8fde\u63a5 conn := conns[len(conns)-1] conns = conns[:len(conns)-1] p.conns[addr] = conns // \u5982\u679c\u8d85\u65f6\u5219\u4e3b\u52a8\u5173\u95ed\u8fde\u63a5 if d := time.Since(conn.Created()); d > p.ttl { conn.Client.Close() continue } // \u83b7\u5f97\u4e86\u53ef\u7528\u7684\u8fde\u63a5\uff0c\u8fd4\u56de\u65b0\u8fde\u63a5 p.Unlock() return conn, nil } p.Unlock() // \u521b\u5efa\u65b0\u8fde\u63a5 c, err := p.tr.Dial(addr, opts...) if err != nil { return nil, err } return &poolConn{ Client: c, id: uuid.New().String(), created: time.Now(), }, nil } // \u4f7f\u7528\u5b8c\u5c06\u8fde\u63a5\u653e\u56de\u8fde\u63a5\u6c60 func (p *pool) Release(conn Conn, err error) error { // \u5982\u679c\u4e0a\u5c42\u53d1\u751f\u9519\u8bef\uff0c\u5219\u4e0d\u653e\u56de\u8fde\u63a5\u6c60 if err != nil { return conn.(*poolConn).Client.Close() } // \u653e\u5165\u6ca1\u6709\u9519\u8bef\u7684\u8fde\u63a5 p.Lock() conns := p.conns[conn.Remote()] if len(conns) >= p.size { p.Unlock() return conn.(*poolConn).Client.Close() } p.conns[conn.Remote()] = append(conns, conn.(*poolConn)) p.Unlock() return nil } \u5b9e\u9645\u4e0a\u50cf DB \u5c42\u7684\u534f\u8bae\uff0c\u6bd4\u5982 Redis\u3001MySQL \u4e5f\u7c7b\u4f3c HTTP \u7684\u4e00\u6765\u4e00\u56de\u7684\u534f\u8bae\uff0c\u6240\u4ee5\u8fd9\u5957\u8fde\u63a5\u6c60\u7684\u8bbe\u8ba1\u4e5f\u53ef\u4ee5\u5e94\u7528\u5728 Redis \u548c MySQL \u4e0a\u9762\uff0c\u53ef\u4ee5\u8bf4\u5e94\u7528\u975e\u5e38\u5e7f\u6cdb\u3002","title":"3\u3001\u8fde\u63a5\u6c60\u7684\u5b9e\u73b0"},{"location":"chap1/5chap1_conn_pool/#maxidleconns","text":"\u8fd9\u4e2a\u503c\u7ecf\u5e38\u4f1a\u548c MaxConns \u641e\u6df7\uff0c\u4f46\u4f60\u8981\u6ce8\u610f\u8fd9\u4e2a\u503c\u4e0d\u662f\u6700\u5927\u8fde\u63a5\u6570\uff0c\u800c\u662f\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\uff0c\u7ed3\u5408\u6211\u4eec\u4e0a\u9762\u8bb2\u7684\u8fde\u63a5\u6c60\u5b9e\u73b0\u539f\u7406\uff0c \u8fd9\u4e2a\u503c\u53ef\u4ee5\u7406\u89e3\u4e3a\u8fde\u63a5\u6c60\u7684\u5927\u5c0f \u3002 \u8fd9\u4e2a\u503c\u7684\u8bbe\u7f6e\u5f88\u6709\u8bb2\u7a76\uff0c \u9700\u8981\u7ed3\u5408\u540e\u7aef\u670d\u52a1\u7684\u8fde\u63a5\u627f\u8f7d\u80fd\u529b\u8bbe\u7f6e \u3002\u5982\u679c\u8bbe\u7f6e\u5f97\u592a\u5927\uff0c\u5047\u5982\u8bbe\u7f6e 1000\uff0c\u59cb\u53d1\u96c6\u7fa4\u6709 100 \u53f0\u673a\u5668\uff0c\u90a3\u4e48\u5c31\u4f1a\u5efa\u7acb 10w \u7684\u6301\u4e45\u8fde\u63a5\uff0c\u8fd9\u5bf9\u540e\u7aef\u670d\u52a1\u7684\u538b\u529b\u53ef\u60f3\u800c\u77e5\u3002\u4f46\u4e5f\u4e0d\u80fd\u8bbe\u7f6e\u5f97\u592a\u5c0f\uff0c\u4e3e\u4e2a\u6781\u7aef\u7684\u4f8b\u5b50\uff0c\u5047\u5982\u8bbe\u7f6e 1\uff0c\u5f53\u5e76\u53d1\u6570\u91cf\u4e0a\u53bb\u65f6\uff0c\u4f1a\u51fa\u73b0\u4e24\u79cd\u60c5\u51b5\uff1a \u5982\u679c\u8fde\u63a5\u6c60\u6ee1\u4e86\uff0c\u5c31\u4f1a\u5efa\u7acb\u65b0\u7684\u8fde\u63a5\uff0c\u4e0d\u65ad\u5efa\u7acb\u7684\u65b0\u8fde\u63a5\u4f1a\u8017\u5149\u540e\u7aef\u670d\u52a1\u7684\u8d44\u6e90\uff1b \u65b0\u5efa\u7acb\u7684\u8fde\u63a5\u5728\u7528\u5b8c\u4e4b\u540e\uff0c\u6709\u4e24\u79cd\u9009\u62e9\u2014\u2014\u8fde\u63a5\u6c60\u6709\u4f59\u91cf\u7684\u60c5\u51b5\u4f1a\u653e\u5165\u8fde\u63a5\u6c60\uff0c\u53cd\u4e4b\u4f1a\u76f4\u63a5\u4e22\u5f03\uff0c\u8fd9\u79cd\u60c5\u51b5\u5728\u77ac\u95f4\u5f88\u5bb9\u6613\u51fa\u73b0\uff0c\u8fde\u63a5\u6c60\u6301\u7eed\u77ac\u95f4\u88ab\u7a7a\u95f2\u8fde\u63a5\u5360\u6ee1\uff08\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\u7684\u53eb\u6cd5\u4e5f\u7531\u6b64\u5f97\u6765\uff09\uff0c\u5bfc\u81f4\u65b0\u8fde\u63a5\u65e0\u6cd5\u653e\u56de\u8fde\u63a5\u6c60\uff0c\u8fdb\u800c\u4e22\u5f03\uff0c\u8fd9\u6837\u5c31\u4f1a\u5f62\u6210\u5efa\u7acb\u8fde\u63a5\u2014\u7528\u5b8c\u4e22\u5f03\u7684\u6076\u6027\u5faa\u73af\uff0c\u8fde\u63a5\u6c60\u7684\u4f5c\u7528\u4e5f\u5c31\u6d88\u5931\u4e86\uff0c\u9000\u5316\u6210\u4e86\u77ed\u8fde\u63a5\u3002 \u7ecf\u9a8c\u503c\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u8fde\u63a5\u6c60\u5bb9\u91cf\u8bbe\u7f6e\u5728 10-100 \u7684\u533a\u95f4\u5185\u662f\u6bd4\u8f83\u5408\u7406\u7684 \u3002","title":"MaxIdleConns \u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570"},{"location":"chap1/5chap1_conn_pool/#4http2","text":"HTTP/2 \u8bbe\u8ba1\u7684\u6700\u5927\u76ee\u7684\u5c31\u662f\u89e3\u51b3 HTTP \u8fde\u63a5\u963b\u585e\u7684\u95ee\u9898 \u3002\u5f53\u7136\u4e5f\u6709\u5f88\u591a\u5176\u4ed6\u5185\u5bb9\u7684\u4f18\u5316\uff0c\u6bd4\u5982 header \u5934\u90e8\u538b\u7f29\u3001\u57fa\u4e8e\u4e8c\u8fdb\u5236\u7684\u4f20\u8f93\u534f\u8bae\u7b49\u3002\u4f46\u6211\u4eec\u8fd8\u662f\u628a\u5173\u6ce8\u70b9\u96c6\u4e2d\u5230\u8fde\u63a5\u5c42\u9762\u3002","title":"4\u3001HTTP/2"},{"location":"chap1/5chap1_conn_pool/#4-1","text":"\u6bd4\u5982 header \u5934\u90e8\u538b\u7f29\u3001\u57fa\u4e8e\u4e8c\u8fdb\u5236\u7684\u4f20\u8f93\u534f\u8bae\u7b49\u3002\u4f46\u6211\u4eec\u8fd8\u662f\u628a\u5173\u6ce8\u70b9\u96c6\u4e2d\u5230\u8fde\u63a5\u5c42\u9762\u3002","title":"4-1 \u5176\u4ed6\u5185\u5bb9\u7684\u4f18\u5316"},{"location":"chap1/5chap1_conn_pool/#4-2-multiplexing","text":"HTTP/2 \u4e2d\u7684\u591a\u8def\u590d\u7528\uff0c\u6307\u7684\u662f\u5728 \u4e00\u6761\u8fde\u63a5\u4e2d\u53ef\u4ee5\u540c\u65f6\u5904\u7406\u591a\u4e2a\u8bf7\u6c42 \uff0c\u8fd9\u6b63\u662f\u89e3\u51b3\u4e86 HTTP \u4e2d\u4e00\u4e2a\u8fde\u63a5\u540c\u65f6\u53ea\u80fd\u5904\u7406\u4e00\u4e2a\u8bf7\u6c42\u7684\u95ee\u9898\u3002\u8fd9\u548c Linux IO \u591a\u8def\u590d\u7528\u662f\u4e0d\u662f\u4e5f\u6709\u4e9b\u7c7b\u4f3c\uff1f\u4e4b\u6240\u4ee5\u90fd\u53eb\u591a\u8def\u590d\u7528\uff0c\u5c31\u662f\u56e0\u4e3a\u5b83\u4eec\u57fa\u672c\u4e0a\u90fd\u590d\u7528\u4e86\u67d0\u4e2a\u901a\u9053\uff0c\u6bd4\u5982 HTTP/2 \u590d\u7528\u4e86\u8fde\u63a5\uff0cLinux IO \u590d\u7528\u4e86\u8fdb\u7a0b \u3002 HTTP/2 \u62bd\u8c61\u51fa\u4e86\u4e00\u79cd\u6d41\uff08stream\uff09\u7684\u6982\u5ff5\uff0c \u5ba2\u6237\u7aef\u5728\u5df2\u7ecf\u5efa\u7acb\u7684\u8fde\u63a5\u4e0a\u53d1\u9001\u6d41\uff0c\u800c\u4e0d\u662f\u50cf HTTP 1.0 \u4e00\u6837\u76f4\u63a5\u53d1\u9001\u6570\u636e\u5305\uff0c\u6bcf\u4e2a\u6d41\u90fd\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bc6\u53f7 \uff0c\u8fd9\u6837\u5ba2\u6237\u7aef\u5c31\u53ef\u4ee5\u4e0d\u7ba1\u670d\u52a1\u7aef\u662f\u5426\u5df2\u7ecf\u8fd4\u56de\u6570\u636e\u800c\u4e0d\u65ad\u5f80\u670d\u52a1\u7aef\u53d1\u9001\u65b0\u7684\u6d41\u3002 \u56e0\u4e3a\u6bcf\u4e2a\u6d41\u6709\u72ec\u7acb\u7684 ID\uff0c\u5728\u670d\u52a1\u7aef\u8fd4\u56de\u5904\u7406\u6d41\u7684\u6570\u636e\u5305\u65f6\uff0c\u53ea\u8981\u6839\u636e\u8fd9\u4e2a\u6d41\u7684 ID \u627e\u5230\u53d1\u9001\u7684\u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u4e00\u4e00\u5bf9\u5e94 \u3002 \u8fd9\u4e2a\u6d41\u6211\u4eec\u53ef\u4ee5\u7406\u89e3\u6210\u4e00\u4e2a\u865a\u62df\u8fde\u63a5 \u5728\u4ee3\u7801\u5b9e\u73b0\u65f6\uff0c\u4e5f\u53ef\u4ee5\u770b\u5230 stream \u5176\u5b9e\u5c31\u662f\u7528\u865a\u62df\u8fde\u63a5\u7684\u65b9\u5f0f\u5b9e\u73b0\u7684\u3002\u6211\u4eec\u5728\u4e00\u6761 TCP \u8fde\u63a5\u4e0a\uff0c\u5efa\u7acb\u4e86\u5f88\u591a\u865a\u62df\u8fde\u63a5\uff0c\u8fd9\u4e9b\u865a\u62df\u8fde\u63a5\uff08\u4e5f\u5c31\u662f\u6d41\uff09\u7684\u521b\u5efa\u51e0\u4e4e\u6ca1\u6709\u6210\u672c\uff0c\u5728\u6bcf\u6b21\u53d1\u9001\u65b0\u7684\u8bf7\u6c42\u524d\uff0c\u76f4\u63a5 new stream() \u8fd4\u56de\u65b0\u7684\u6570\u636e\u6d41\uff08\u865a\u62df\u8fde\u63a5\uff09\uff0c\u7136\u540e\u53d1\u9001\u6570\u636e\u5373\u53ef\u3002","title":"4-2 \u591a\u8def\u590d\u7528\uff08Multiplexing\uff09"},{"location":"chap1/5chap1_conn_pool/#4-3-http2","text":"\u9700\u8981\uff0c\u4f46\u548c\u4f20\u7edf\u7684\u963b\u585e\u5f0f\u8fde\u63a5\u6c60\u4e5f\u5c31\u662f HTTP 1.0 \u7684\u8fde\u63a5\u6c60\u6709\u4e00\u4e9b\u533a\u522b\u3002\u5b9e\u9645\u4e0aHTTP/2 \u5df2\u7ecf\u590d\u7528\u4e86\u8fde\u63a5\uff0c\u4ece\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u8bb2\u5b9e\u73b0\u8fde\u63a5\u6c60\u5df2\u7ecf\u6ca1\u6709\u592a\u591a\u610f\u4e49\u4e86\uff0c\u591a\u8def\u590d\u7528\u505a\u5230\u4e00\u6761\u8fde\u63a5\u5c31\u53ef\u4ee5\u4e86\uff0c\u4f46\u56e0\u4e3a HTTP 2 .0 \u8fd8\u662f\u57fa\u4e8e TCP \u8fde\u63a5\u7684\uff0c\u800c TCP \u5b58\u5728\u961f\u5934\u963b\u585e\u7684\u95ee\u9898\uff0c \u6bd4\u5982\u67d0\u6761\u8fde\u63a5\u7a81\u7136\u9047\u5230\u4e86\u7f51\u7edc\u91cd\u4f20\uff0c\u6b64\u65f6\u4f1a\u963b\u585e\u8fde\u63a5 \u3002\u53e6\u5916\u5728\u4e00\u4e9b\u9ad8\u5e76\u53d1\u573a\u666f\uff0c\u4e00\u6761\u8fde\u63a5\u96be\u4ee5\u8dd1\u6ee1\u5e26\u5bbd\uff0c\u4e5f\u9700\u8981\u521b\u5efa\u591a\u6761\u8fde\u63a5\u3002 \u6240\u4ee5 HTTP/2 \u7684\u8fde\u63a5\u6c60\u5b9e\u73b0\u6709\u6240\u4e0d\u540c\uff0c \u65b0\u8fde\u63a5\u7684\u521b\u5efa\u6761\u4ef6\u5f80\u5f80\u662f\u4f9d\u636e maxConcurrentStreams \u7684\u53c2\u6570\uff0c\u5f53\u540c\u65f6\u8bf7\u6c42\u4e2d\u7684 stream \u7684\u6570\u91cf\u8d85\u8fc7\u4e0a\u9650\u65f6\uff0c\u624d\u521b\u5efa\u65b0\u7684\u8fde\u63a5\u3002 \u6240\u4ee5\u5728 gRPC \u548c HTTP/2 \u4e2d\u8fd9\u4e2a\u53c2\u6570\u7684\u8bbe\u7f6e\u975e\u5e38\u91cd\u8981\uff0c\u5b83\u7684\u91cd\u8981\u6027\u53ef\u4ee5\u7b49\u540c\u4e8e\u4e0a\u9762\u8bb2\u7684 MaxIdleConns \u53c2\u6570\u3002\u8fd9\u6837\u7684\u8bbe\u8ba1\u4e5f\u5f88\u597d\u7406\u89e3\uff0c\u56e0\u4e3a HTTP/2 \u5df2\u7ecf\u53ef\u4ee5\u590d\u7528\u540c\u4e00\u6761\u8fde\u63a5\u53d1\u9001\u591a\u4e2a\u8bf7\u6c42\u4e86\uff0c\u81ea\u7136\u6ca1\u6709\u5fc5\u8981\u4e00\u4e2a\u8bf7\u6c42\u521b\u5efa\u4e00\u4e2a\u8fde\u63a5\uff0c\u53ea\u9700\u7b49\u8fd9\u4e2a\u8fde\u63a5\u65e0\u6cd5\u6ee1\u8db3\u8bbe\u7f6e\u7684\u6700\u5927 stream \u7684\u6761\u4ef6\u65f6\u624d\u5efa\u7acb\u65b0\u7684\u8fde\u63a5\u3002","title":"4-3 HTTP/2 \u5230\u5e95\u9700\u4e0d\u9700\u8981\u8fde\u63a5\u6c60\uff1f"},{"location":"chap1/6chap1_apigateway_kong/","text":"\u7b2c\u516d\u8282 \u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff1a\u7f51\u5173\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u4f5c\u7528 1\u3001API Gateway \u5b9e\u9645\u4e0a API Gateway \u53ef\u4ee5\u7b49\u540c\u4e8e\u5fae\u670d\u52a1\u7f51\u5173\u3002 \u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u968f\u7740\u5fae\u670d\u52a1\u7684\u62c6\u5206\uff0c \u8fd9\u4e9b\u5fae\u670d\u52a1\u4e0d\u53ef\u80fd\u540c\u65f6\u63d0\u4f9b\u5bf9\u5916\u670d\u52a1\uff0c\u8fd9\u6837\u5c31\u9700\u8981\u4e00\u4e2a\u7f51\u5173\u7cfb\u7edf\uff0c\u627f\u63a5\u5916\u7f51\u7684\u6d41\u91cf \u3002 \u6709\u4e86API \u7f51\u5173\uff0c\u5404\u4e2a API \u670d\u52a1\u63d0\u4f9b\u56e2\u961f\u53ef\u4ee5\u4e13\u6ce8\u81ea\u5df1\u7684\u4e1a\u52a1\u903b\u8f91\u5904\u7406\uff0c\u800c API \u7f51\u5173\u5219\u66f4\u4e13\u6ce8\u4e8e\u5b89\u5168\u3001\u6d41\u91cf\u3001\u8def\u7531\u7b49\u95ee\u9898\u3002 1-1 \u5fae\u670d\u52a1\u7f51\u5173\u4e3b\u8981\u63d0\u4f9b\u54ea\u4e9b\u529f\u80fd \u7edf\u4e00\u6d41\u91cf\u63a5\u5165 \uff1a\u63d0\u4f9b\u7edf\u4e00\u7684\u6d41\u91cf\u5165\u53e3\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7531\u7edf\u4e00\u7684\u5165\u53e3\u7ba1\u7406\u6d41\u91cf\uff0c\u8bbe\u7f6e\u5404\u79cd\u7b56\u7565\uff0c\u6bd4\u5982\u7edf\u4e00\u7684 Token \u8ba4\u8bc1\u7b49\u3002 \u4e1a\u52a1\u805a\u5408 \uff1a\u5728\u5177\u4f53\u7684\u4e1a\u52a1\u4e2d\uff0c\u7ecf\u5e38\u9700\u8981\u805a\u5408\u591a\u4e2a\u670d\u52a1\u7684\u7ed3\u679c\u96c6\uff0c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ef\u4ee5\u7531 API \u7f51\u5173\u805a\u5408\u6570\u636e\u7136\u540e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002 \u534f\u8bae\u8f6c\u6362 \uff1a\u4e00\u822c\u5165\u53e3\u5c42\uff0c\u591a\u4f7f\u7528 HTTP \u534f\u8bae\u7684 RESTful \u63a5\u53e3\uff0c\u800c\u540e\u7aef\u670d\u52a1\u7684\u534f\u8bae\u53ef\u80fd\u6709\u591a\u79cd\uff0c\u6bd4\u5982 gRPC\u3001Thrift \u7b49\u3002 \u4e2d\u95f4\u4ef6\u7b56\u7565 \uff1a\u8bbe\u7f6e\u7edf\u4e00\u7684\u4e2d\u95f4\u4ef6\u7b56\u7565\u5c42\uff0c\u53ef\u4ee5\u5728\u8fd9\u4e00\u5c42\u505a\u4e00\u4e9b\u9650\u6d41\u7194\u65ad\u3001\u5357\u5317\u5411\u6d41\u91cf\u7684\u670d\u52a1\u6cbb\u7406\u529f\u80fd\u3002 \u5b89\u5168\u8ba4\u8bc1 \uff1a\u4e00\u4e9b Token \u8ba4\u8bc1\u529f\u80fd\uff0c\u6bd4\u5982\u6570\u636e\u662f\u5426\u88ab\u7be1\u6539\u7684\u8ba4\u8bc1\uff0c\u53ef\u4ee5\u5728 API \u7f51\u5173\u4e2d\u505a\uff0c\u8fd9\u4e5f\u662f\u7ecf\u5e38\u7528\u5230\u7684\u529f\u80fd\u3002 \u8bc1\u4e66\u7ba1\u7406 \uff1a\u968f\u7740\u5bf9\u5916\u7f51\u5b89\u5168\u6027\u80fd\u8981\u6c42\u7684\u589e\u9ad8\uff0c\u73b0\u5728\u57fa\u672c\u4e0a\u90fd\u8981\u5bf9\u5916\u63d0\u4f9b HTTPS \u7684\u670d\u52a1\uff0c\u4ee5\u4fdd\u8bc1\u6570\u636e\u4e0d\u4f1a\u88ab\u52ab\u6301\u3001\u7be1\u6539\u7b49\u95ee\u9898\uff0c\u5728\u8fd9\u4e00\u5c42\u505a\u8bc1\u4e66\u5bf9\u5185\u7f51\u7684\u62c6\u5378\u975e\u5e38\u5408\u9002\u3002\u7531\u4e00\u4e2a\u7edf\u4e00\u7684\u5165\u53e3\u7ba1\u7406\u63a5\u53e3\uff0c\u964d\u4f4e\u4e86\u8bc1\u4e66\u66f4\u6362\u65f6\u7684\u590d\u6742\u5ea6\u3002 1-2 \u5e38\u7528\u5fae\u670d\u52a1\u7f51\u5173\u4ecb\u7ecd Kong \uff1a\u51e0\u4e4e\u662f\u76ee\u524d\u6700\u6d41\u884c\u7684\u5fae\u670d\u52a1\u7f51\u5173\uff0c\u5185\u7f6e\u4e86\u591a\u79cd\u7f51\u5173\u6240\u9700\u8981\u7684\u529f\u80fd\uff0c\u540e\u9762\u6211\u4eec\u5c06\u8be6\u7ec6\u4ecb\u7ecd\u3002 Spring Cloud Zuul \uff1a\u4f5c\u4e3a Spring Cloud \u7684\u4e00\u90e8\u5206\uff0c\u63d0\u4f9b\u4e86\u5fae\u670d\u52a1\u6240\u9700\u8981\u7684\u7f51\u5173\u7684\u5927\u90e8\u5206\u529f\u80fd\uff0c\u6700\u5927\u7684\u4f18\u52bf\u662f\u5bf9 Java \u7cfb\u7edf\u53cb\u597d\u3002\u4e25\u683c\u6765\u8bf4 Zuul \u66f4\u50cf\u662f\u4e00\u4e2a\u5fae\u670d\u52a1\u7f51\u5173\u7684\u6846\u67b6\uff0c\u800c\u4e0d\u662f\u72ec\u7acb\u7684\u4ea7\u54c1 \u3002 Traefik\uff1a\u57fa\u4e8e Go \u8bed\u8a00\u5b9e\u73b0\u7684\u5fae\u670d\u52a1\u7f51\u5173\uff0c\u4ee3\u7801\u7ed3\u6784\u6e05\u6670\u7b80\u5355\uff0c\u9002\u5408\u505a\u4e8c\u6b21\u5f00\u53d1 \uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u72ec\u7acb\u7684\u4ea7\u54c1\u4f7f\u7528\uff0c\u5bf9\u4e91\u539f\u751f\u652f\u6301\u53cb\u597d\u3002\u5982\u679c\u6280\u672f\u6808\u662f Go \u8bed\u8a00\uff0c\u503c\u5f97\u4e00\u8bd5\u3002 1-3\u3001\u53cc\u91cd\u7f51\u5173\uff08\u7cfb\u7edf\u7f51\u5173\u548c\u4e1a\u52a1\u7f51\u5173\uff09 \u5355\u4e00\u7684\u7f51\u5173\u7cfb\u7edf\u5df2\u7ecf\u4e0d\u80fd\u6ee1\u8db3\u7ec4\u7ec7\u67b6\u6784\u548c\u4e1a\u52a1\u7684\u53d1\u5c55\u4e86\uff0c\u6240\u4ee5\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u591a\u91c7\u7528\u53cc\u91cd\u7f51\u5173\u7ed3\u6784\u3002 \u8fd9\u79cd\u7ed3\u6784\u7531\u591a\u4e2a\u7cfb\u7edf\u7f51\u5173\u548c\u591a\u4e2a\u4e1a\u52a1\u805a\u5408\u7f51\u5173\u7ec4\u6210 \u8fd9\u6837\u914d\u5408\u662f\u56e0\u4e3a\u7cfb\u7edf\u7f51\u5173\u591a\u7531\u5e38\u89c1\u7684 Nginx \u7cfb\u7f51\u5173\u6784\u6210\uff0c\u4f7f\u7528 Nginx \u7cfb\u7684\u7f51\u5173\u5bf9\u8fd0\u7ef4\u53cb\u597d\uff0c\u65b9\u4fbf\u8fd0\u7ef4\u505a\u4e00\u4e9b\u76d1\u63a7\u3001\u65e5\u5fd7\u3001\u5b89\u5168\u7b56\u7565\uff1b\u4f46\u5f80\u5f80\u5bf9\u7814\u53d1\u4eba\u5458\u4e0d\u592a\u53cb\u597d\uff0c\u4e0d\u65b9\u4fbf\u6269\u5c55\u3002\u6240\u4ee5\u540e\u6765\u589e\u52a0\u4e86\u4e1a\u52a1\u7f51\u5173\uff0c\u7528\u4e8e\u670d\u52a1\u7684\u805a\u5408\uff0c\u8fd9\u5c42\u7f51\u5173\u56e0\u4e3a\u9700\u8981\u505a\u4e00\u4e9b\u4e1a\u52a1\u7684\u805a\u5408\u7b56\u7565\uff0c\u5e73\u65f6\u6539\u52a8\u4f1a\u6bd4\u8f83\u591a\u3002 \u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4e24\u4e2a\u7f51\u5173\u76f8\u4e92\u914d\u5408\uff0c\u65e2\u65b9\u4fbf\u4e86\u8fd0\u7ef4\u7ef4\u62a4\uff0c\u4e5f\u65b9\u4fbf\u4e86\u7814\u53d1\u4eba\u5458\u6269\u5c55\uff0c\u8fbe\u5230\u67d0\u79cd\u5e73\u8861\u3002 \u8fd9\u4e9b\u7f51\u5173\u4f1a\u6839\u636e\u4e1a\u52a1\u7ef4\u5ea6\u62c6\u5206\uff0c\u6bd4\u5982\u5206\u4e3a\u7528\u6237\u7cfb\u7edf\u7f51\u5173\u548c\u5185\u5bb9\u7cfb\u7edf\u7f51\u5173\u3002\u8fd9\u6837\u62c6\u5206\u7684\u76ee\u7684\uff0c\u662f\u9632\u6b62\u7531\u5355\u4e00\u7f51\u5173\u7684\u6545\u969c\u5e26\u6765\u5168\u7ad9\u7684\u4e0d\u53ef\u7528\uff0c\u4ece\u800c\u8fbe\u5230\u964d\u4f4e\u6545\u969c\u5f71\u54cd\u9762\u7684\u6548\u679c\u3002 2\u3001\u5fae\u670d\u52a1\u7f51\u5173 Kong https://codechina.csdn.net/mirrors/Kong/kong?utm_source=csdn_github_accelerator \u5f00\u6e90\u7f51\u5173 Kong\u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684 API \u7f51\u5173\uff0c\u57fa\u4e8e OpenResty + Lua \u5f00\u53d1\uff0c\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u529f\u80fd\u4ee5\u53ca\u9ad8\u5ea6\u7075\u6d3b\u7684\u6269\u5c55\u6027\uff0c\u53ef\u4ee5\u901a\u8fc7\u63d2\u4ef6\u7684\u65b9\u5f0f\u6269\u5c55 Kong \u7684\u529f\u80fd\u3002 Kong \u4f5c\u4e3a\u5fae\u670d\u52a1\u7f51\u5173\uff0c\u6700\u5927\u7684\u4f18\u52bf\u5c31\u662f \u62bd\u8c61\u51fa\u4e86\u5fae\u670d\u52a1\u7f51\u5173\u7684\u4e00\u5957\u6a21\u578b\uff0c\u800c\u4e0d\u9700\u8981\u50cf OpenResty \u90a3\u6837\u624b\u52a8\u914d\u7f6e \u3002 2-1 \u5fae\u670d\u52a1\u7f51\u5173\u7684\u4e00\u5957\u6a21\u578b service \uff1a\u670d\u52a1\u5bf9\u5e94\u7684\u540e\u7aef\u7684\u5fae\u670d\u52a1\u548c API\u3002\u4e00\u822c\u60c5\u51b5\u4e0b\u628a\u4e00\u7ec4 API \u96c6\u5408\u6210\u4e3a\u4e00\u4e2a\u670d\u52a1\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u540e\u7aef\u7684\u5fae\u670d\u52a1\u3002 router \uff1a\u8def\u7531\u6307\u7684\u662f\u6d41\u91cf\u5230\u8fbe API \u7f51\u5173\u540e\uff0c\u5982\u4f55\u627e\u5230\u540e\u7aef\u5bf9\u5e94\u7684\u670d\u52a1\u3002 Admin API \uff1a Kong \u4e2d\u7684 RESTful \u7684\u5185\u90e8 API \u63a5\u53e3 \u3002 API \u63a5\u53e3\u53ef\u4ee5\u5728\u96c6\u7fa4\u7684\u4efb\u610f\u8282\u70b9\u8fd0\u884c\uff0c\u6700\u7ec8\u540c\u6b65\u5230\u6240\u6709\u96c6\u7fa4\u7684\u8282\u70b9\u3002\u7528\u4e8e\u7ba1\u7406 Kong \u7684\u5404\u79cd\u884c\u4e3a\uff0c\u6bd4\u5982\u6dfb\u52a0 service\u3001router \u7b49\u3002 Plugins\uff1aKong \u7684\u63d2\u4ef6\u7cfb\u7edf \u3002\u5229\u7528\u63d2\u4ef6\u7cfb\u7edf\uff0c\u6211\u4eec\u6dfb\u52a0\u65b0\u529f\u80fd\u5c31\u4e0d\u9700\u8981\u6539\u52a8 Kong \u7684\u6838\u5fc3\u4ee3\u7801\u3002\u63d2\u4ef6\u7cfb\u7edf\u81ea\u5e26\u8db3\u591f\u591a\u7684\u529f\u80fd\uff0c\u6bd4\u5982\u8ba4\u8bc1\u3001\u9650\u6d41\u3001\u65e5\u5fd7\u3001Metrics \u7b49\u3002 Load Balancing \uff1aKong\u63d0\u4f9b\u4e86\u4e24\u79cd\u8d1f\u8f7d\u5747\u8861\u65b9\u5f0f\uff0cDNS \u548c\u5185\u7f6e\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u3002\u5229\u7528 DNS \u6a21\u5f0f\uff0c \u53ef\u4ee5\u548c Consul \u7ed3\u5408\uff0c\u5b9e\u73b0\u670d\u52a1\u53d1\u73b0 \u3002\u5185\u7f6e\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5219\u9700\u8981\u81ea\u5df1\u624b\u52a8\u7ef4\u62a4\u540e\u7aef\u8282\u70b9\u3002 2-2 Konga Kong \u5b98\u65b9\u5e76\u6ca1\u6709\u4e3a\u5f00\u6e90\u7248\u672c\u63d0\u4f9b\u56fe\u5f62\u754c\u9762\uff0chttps://github.com/PGBI/kong-dashboard DB Mode\uff080.x-1.0\uff09\u2192 DB-less Mode(1.1-1.5)\u2192 Hybird Mode(2.0+) DB Mode \uff1a\u6700\u65e9\u7684 Kong \u7248\u672c\u5c31\u662f\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6bcf\u4e2a Kong \u90fd\u8fde\u63a5\u4e86\u540e\u7aef DB\uff0c\u8fd9\u4e2a DB \u53ef\u9009\u4e3a PostgreSQL \u6216\u8005 Cassandra\u3002\u4f46\u662f\u8fd9\u4e2a\u6a21\u5f0f\u4e4b\u524d\u6709\u4e2a\u5f88\u4e25\u91cd\u7684 Bug\uff0c \u5c31\u662f\u5728\u6d41\u91cf\u5927\u7684\u65f6\u5019\u66f4\u65b0\u8def\u7531\u914d\u7f6e\uff0c\u4f1a\u5bfc\u81f4 Kong \u4ea7\u751f\u5267\u70c8\u7684\u6296\u52a8 \u3002 DB-less Mode \uff1a\u65e0\u6570\u636e\u5e93\u6a21\u5f0f\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7\u58f0\u660e\u5f0f\u7684\u914d\u7f6e\u65b9\u5f0f\u6765\u8fd0\u884c Kong\u3002\u8fd9\u79cd\u65b9\u5f0f\u4ece\u67d0\u79cd\u610f\u4e49\u6765\u8bf4\u662f\u4e00\u79cd\u5012\u9000\uff0c\u56e0\u4e3a\u5b83 \u8ba9 Kong \u65e0\u6cd5\u901a\u8fc7 API \u63a7\u5236\uff0c\u4e5f\u5c31\u662f\u56de\u5230\u4e86\u539f\u59cb\u7684 Nginx \u914d\u7f6e\u6a21\u5f0f\uff0c\u76f8\u5f53\u4e8e Service Mesh \u5931\u53bb\u4e86\u63a7\u5236\u9762 \u3002\u4f46\u4e5f\u56e0\u4e3a\u56de\u5f52\u4e86\u539f\u59cb\u7684\u65b9\u5f0f\uff0c\u4e0d\u4f1a\u51fa\u73b0 DB Mode \u66f4\u65b0\u914d\u7f6e\u65f6\u5bfc\u81f4\u7684\u4e00\u4e9b\u6296\u52a8\u95ee\u9898\u3002 Hybird Mode \uff1a\u5176\u5b9e\u4e5f\u5c31\u662f\u5f15\u5165\u4e86 Service Mesh \u4e2d\u7684\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u6a21\u5f0f\u3002\u76f8\u5bf9\u4e8e\u4e0a\u9762\u4e24\u79cd\u6a21\u5f0f\u6709\u5de8\u5927\u7684\u67b6\u6784\u4f18\u52bf\uff0c Hybird Mode \u901a\u8fc7\u63a7\u5236\u9762\u6536\u655b\u4e86\u6570\u636e\u5e93\u7684\u64cd\u4f5c\u884c\u4e3a\uff0cKong \u7684\u6570\u636e\u8282\u70b9\u4e0d\u9700\u8981\u518d\u76f4\u63a5\u8fde\u63a5\u5230 DB \u5c42 \u3002\u8fd9\u79cd\u6a21\u5f0f\u6709\u4ee5\u4e0b\u4e24\u79cd\u4f18\u52bf\u3002 \u4ec5\u63a7\u5236\u9762\u8282\u70b9\u9700\u8981\u8fde\u63a5\u5230 DB\uff0c\u800c\u4e0d\u662f\u6240\u6709\u6570\u636e\u8282\u70b9\u8fde\u63a5\u5230 DB\uff0c\u5bf9 DB \u7684\u538b\u529b\u5927\u5927\u51cf\u5c11\uff0c\u4e5f\u5c31\u964d\u4f4e\u4e86\u6570\u636e\u9762\u51fa\u73b0\u6296\u52a8\u7684\u6982\u7387\u3002 \u6613\u4e8e\u7ba1\u7406\uff0c\u4e0d\u7528\u50cf\u4e4b\u524d\u7684 API \u8c03\u7528 Kong \u7684\u6570\u636e\u8282\u70b9\u65f6\u518d\u64cd\u4f5c Admin API \u53d8\u66f4\uff0c\u53ea\u9700\u4e0e\u63a7\u5236\u9762\u4ea4\u4e92\u5373\u53ef\u3002 2-3 \u56fe\u5f62\u5316\u805a\u5408\u5c42 \u7edf\u7f51\u5173\u548c\u4e1a\u52a1\u7f51\u5173\u7684\u67b6\u6784\uff0c\u5b9e\u9645\u4e0a\u8fd9\u6837\u505a\u589e\u52a0\u4e86\u4e00\u6761\u8bf7\u6c42\u94fe\u8def\u3002\u6211\u4eec\u8fd9\u6837\u505a\u662f\u56e0\u4e3a\u4e1a\u52a1\u7f51\u5173\u9891\u7e41\u66f4\u65b0\uff0c\u90a3\u4e48\u6709\u6ca1\u6709\u529e\u6cd5\u51cf\u5c11\u8fd9\u79cd\u66f4\u65b0\u9891\u7387\u5462\uff1f \u5b9e\u9645\u4e0a Uber \u5df2\u7ecf\u5728\u67d0\u65b9\u9762\u505a\u51fa\u4e86\u52a8\u4f5c\uff0c\u90a3\u5c31\u662f\u901a\u8fc7\u56fe\u5f62\u5316\u754c\u9762\u7684\u65b9\u5f0f\uff0c\u805a\u5408\u540e\u7aef API\u3002 2-4 \u957f\u8fde\u7f51\u5173 \u8fd9\u91cc\u7684\u957f\u8fde\u7f51\u5173\uff0c\u6307\u7684\u662f\u901a\u8fc7\u79c1\u6709\u534f\u8bae\u6216\u8005 gRPC\u3001HTTP/2 \u7b49\u534f\u8bae\u4ee3\u66ff HTTP \u534f\u8bae\u3002 \u901a\u8fc7\u957f\u8fde\u63a5\u901a\u9053\uff0c\u51cf\u5c11\u5ba2\u6237\u7aef\u548c\u7f51\u5173\u7684\u5efa\u8fde\u6b21\u6570\uff0c\u540c\u65f6\u901a\u8fc7\u538b\u7f29 header \u7b49\u65b9\u5f0f\uff0c\u51cf\u5c11\u901a\u4fe1\u4e2d\u4ea7\u751f\u7684\u6d41\u91cf\uff0c\u4ee5\u8fbe\u5230\u63d0\u9ad8\u5ba2\u6237\u7aef\u54cd\u5e94\u901f\u5ea6\u7684\u76ee\u7684\uff0c\u8ba9\u7528\u6237\u5728 App \u7684\u4f7f\u7528\u4f53\u9a8c\u4e0a\u66f4\u4e0a\u4e00\u4e2a\u53f0\u9636\u3002 2-5 Service Mesh \u5316 \u5176\u5b9e\u5728 Service Mesh \u65f6\u4ee3\uff0c\u5fae\u670d\u52a1\u7f51\u5173\u4e2d\u7684\u67d0\u4e9b\u529f\u80fd\uff0c\u6bd4\u5982\u9650\u6d41\u3001\u8ba4\u8bc1\u3001\u9274\u6743\u7b49\u901a\u7528\u529f\u80fd\uff0c\u5b8c\u5168\u53ef\u4ee5\u8ba9\u672c\u5730\u7684 Sidecar \u5b8c\u6210\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u51cf\u5c11\u5fae\u670d\u52a1\u94fe\u8def\u4e2d\u7684\u4e00\u73af\uff0c\u63d0\u9ad8\u670d\u52a1\u7684\u541e\u5410\u53ca\u6574\u4f53\u67b6\u6784\u7684\u53ef\u7ef4\u62a4\u6027\u3002","title":"\u7b2c\u516d\u8282 \u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff1a\u7f51\u5173\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u4f5c\u7528"},{"location":"chap1/6chap1_apigateway_kong/#kong","text":"","title":"\u7b2c\u516d\u8282 \u5fae\u670d\u52a1\u7f51\u5173\uff08Kong\uff09\uff1a\u7f51\u5173\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u4f5c\u7528"},{"location":"chap1/6chap1_apigateway_kong/#1api-gateway","text":"\u5b9e\u9645\u4e0a API Gateway \u53ef\u4ee5\u7b49\u540c\u4e8e\u5fae\u670d\u52a1\u7f51\u5173\u3002 \u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u968f\u7740\u5fae\u670d\u52a1\u7684\u62c6\u5206\uff0c \u8fd9\u4e9b\u5fae\u670d\u52a1\u4e0d\u53ef\u80fd\u540c\u65f6\u63d0\u4f9b\u5bf9\u5916\u670d\u52a1\uff0c\u8fd9\u6837\u5c31\u9700\u8981\u4e00\u4e2a\u7f51\u5173\u7cfb\u7edf\uff0c\u627f\u63a5\u5916\u7f51\u7684\u6d41\u91cf \u3002 \u6709\u4e86API \u7f51\u5173\uff0c\u5404\u4e2a API \u670d\u52a1\u63d0\u4f9b\u56e2\u961f\u53ef\u4ee5\u4e13\u6ce8\u81ea\u5df1\u7684\u4e1a\u52a1\u903b\u8f91\u5904\u7406\uff0c\u800c API \u7f51\u5173\u5219\u66f4\u4e13\u6ce8\u4e8e\u5b89\u5168\u3001\u6d41\u91cf\u3001\u8def\u7531\u7b49\u95ee\u9898\u3002","title":"1\u3001API Gateway"},{"location":"chap1/6chap1_apigateway_kong/#1-1","text":"\u7edf\u4e00\u6d41\u91cf\u63a5\u5165 \uff1a\u63d0\u4f9b\u7edf\u4e00\u7684\u6d41\u91cf\u5165\u53e3\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7531\u7edf\u4e00\u7684\u5165\u53e3\u7ba1\u7406\u6d41\u91cf\uff0c\u8bbe\u7f6e\u5404\u79cd\u7b56\u7565\uff0c\u6bd4\u5982\u7edf\u4e00\u7684 Token \u8ba4\u8bc1\u7b49\u3002 \u4e1a\u52a1\u805a\u5408 \uff1a\u5728\u5177\u4f53\u7684\u4e1a\u52a1\u4e2d\uff0c\u7ecf\u5e38\u9700\u8981\u805a\u5408\u591a\u4e2a\u670d\u52a1\u7684\u7ed3\u679c\u96c6\uff0c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ef\u4ee5\u7531 API \u7f51\u5173\u805a\u5408\u6570\u636e\u7136\u540e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002 \u534f\u8bae\u8f6c\u6362 \uff1a\u4e00\u822c\u5165\u53e3\u5c42\uff0c\u591a\u4f7f\u7528 HTTP \u534f\u8bae\u7684 RESTful \u63a5\u53e3\uff0c\u800c\u540e\u7aef\u670d\u52a1\u7684\u534f\u8bae\u53ef\u80fd\u6709\u591a\u79cd\uff0c\u6bd4\u5982 gRPC\u3001Thrift \u7b49\u3002 \u4e2d\u95f4\u4ef6\u7b56\u7565 \uff1a\u8bbe\u7f6e\u7edf\u4e00\u7684\u4e2d\u95f4\u4ef6\u7b56\u7565\u5c42\uff0c\u53ef\u4ee5\u5728\u8fd9\u4e00\u5c42\u505a\u4e00\u4e9b\u9650\u6d41\u7194\u65ad\u3001\u5357\u5317\u5411\u6d41\u91cf\u7684\u670d\u52a1\u6cbb\u7406\u529f\u80fd\u3002 \u5b89\u5168\u8ba4\u8bc1 \uff1a\u4e00\u4e9b Token \u8ba4\u8bc1\u529f\u80fd\uff0c\u6bd4\u5982\u6570\u636e\u662f\u5426\u88ab\u7be1\u6539\u7684\u8ba4\u8bc1\uff0c\u53ef\u4ee5\u5728 API \u7f51\u5173\u4e2d\u505a\uff0c\u8fd9\u4e5f\u662f\u7ecf\u5e38\u7528\u5230\u7684\u529f\u80fd\u3002 \u8bc1\u4e66\u7ba1\u7406 \uff1a\u968f\u7740\u5bf9\u5916\u7f51\u5b89\u5168\u6027\u80fd\u8981\u6c42\u7684\u589e\u9ad8\uff0c\u73b0\u5728\u57fa\u672c\u4e0a\u90fd\u8981\u5bf9\u5916\u63d0\u4f9b HTTPS \u7684\u670d\u52a1\uff0c\u4ee5\u4fdd\u8bc1\u6570\u636e\u4e0d\u4f1a\u88ab\u52ab\u6301\u3001\u7be1\u6539\u7b49\u95ee\u9898\uff0c\u5728\u8fd9\u4e00\u5c42\u505a\u8bc1\u4e66\u5bf9\u5185\u7f51\u7684\u62c6\u5378\u975e\u5e38\u5408\u9002\u3002\u7531\u4e00\u4e2a\u7edf\u4e00\u7684\u5165\u53e3\u7ba1\u7406\u63a5\u53e3\uff0c\u964d\u4f4e\u4e86\u8bc1\u4e66\u66f4\u6362\u65f6\u7684\u590d\u6742\u5ea6\u3002","title":"1-1 \u5fae\u670d\u52a1\u7f51\u5173\u4e3b\u8981\u63d0\u4f9b\u54ea\u4e9b\u529f\u80fd"},{"location":"chap1/6chap1_apigateway_kong/#1-2","text":"Kong \uff1a\u51e0\u4e4e\u662f\u76ee\u524d\u6700\u6d41\u884c\u7684\u5fae\u670d\u52a1\u7f51\u5173\uff0c\u5185\u7f6e\u4e86\u591a\u79cd\u7f51\u5173\u6240\u9700\u8981\u7684\u529f\u80fd\uff0c\u540e\u9762\u6211\u4eec\u5c06\u8be6\u7ec6\u4ecb\u7ecd\u3002 Spring Cloud Zuul \uff1a\u4f5c\u4e3a Spring Cloud \u7684\u4e00\u90e8\u5206\uff0c\u63d0\u4f9b\u4e86\u5fae\u670d\u52a1\u6240\u9700\u8981\u7684\u7f51\u5173\u7684\u5927\u90e8\u5206\u529f\u80fd\uff0c\u6700\u5927\u7684\u4f18\u52bf\u662f\u5bf9 Java \u7cfb\u7edf\u53cb\u597d\u3002\u4e25\u683c\u6765\u8bf4 Zuul \u66f4\u50cf\u662f\u4e00\u4e2a\u5fae\u670d\u52a1\u7f51\u5173\u7684\u6846\u67b6\uff0c\u800c\u4e0d\u662f\u72ec\u7acb\u7684\u4ea7\u54c1 \u3002 Traefik\uff1a\u57fa\u4e8e Go \u8bed\u8a00\u5b9e\u73b0\u7684\u5fae\u670d\u52a1\u7f51\u5173\uff0c\u4ee3\u7801\u7ed3\u6784\u6e05\u6670\u7b80\u5355\uff0c\u9002\u5408\u505a\u4e8c\u6b21\u5f00\u53d1 \uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u72ec\u7acb\u7684\u4ea7\u54c1\u4f7f\u7528\uff0c\u5bf9\u4e91\u539f\u751f\u652f\u6301\u53cb\u597d\u3002\u5982\u679c\u6280\u672f\u6808\u662f Go \u8bed\u8a00\uff0c\u503c\u5f97\u4e00\u8bd5\u3002","title":"1-2 \u5e38\u7528\u5fae\u670d\u52a1\u7f51\u5173\u4ecb\u7ecd"},{"location":"chap1/6chap1_apigateway_kong/#1-3","text":"\u5355\u4e00\u7684\u7f51\u5173\u7cfb\u7edf\u5df2\u7ecf\u4e0d\u80fd\u6ee1\u8db3\u7ec4\u7ec7\u67b6\u6784\u548c\u4e1a\u52a1\u7684\u53d1\u5c55\u4e86\uff0c\u6240\u4ee5\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u591a\u91c7\u7528\u53cc\u91cd\u7f51\u5173\u7ed3\u6784\u3002 \u8fd9\u79cd\u7ed3\u6784\u7531\u591a\u4e2a\u7cfb\u7edf\u7f51\u5173\u548c\u591a\u4e2a\u4e1a\u52a1\u805a\u5408\u7f51\u5173\u7ec4\u6210 \u8fd9\u6837\u914d\u5408\u662f\u56e0\u4e3a\u7cfb\u7edf\u7f51\u5173\u591a\u7531\u5e38\u89c1\u7684 Nginx \u7cfb\u7f51\u5173\u6784\u6210\uff0c\u4f7f\u7528 Nginx \u7cfb\u7684\u7f51\u5173\u5bf9\u8fd0\u7ef4\u53cb\u597d\uff0c\u65b9\u4fbf\u8fd0\u7ef4\u505a\u4e00\u4e9b\u76d1\u63a7\u3001\u65e5\u5fd7\u3001\u5b89\u5168\u7b56\u7565\uff1b\u4f46\u5f80\u5f80\u5bf9\u7814\u53d1\u4eba\u5458\u4e0d\u592a\u53cb\u597d\uff0c\u4e0d\u65b9\u4fbf\u6269\u5c55\u3002\u6240\u4ee5\u540e\u6765\u589e\u52a0\u4e86\u4e1a\u52a1\u7f51\u5173\uff0c\u7528\u4e8e\u670d\u52a1\u7684\u805a\u5408\uff0c\u8fd9\u5c42\u7f51\u5173\u56e0\u4e3a\u9700\u8981\u505a\u4e00\u4e9b\u4e1a\u52a1\u7684\u805a\u5408\u7b56\u7565\uff0c\u5e73\u65f6\u6539\u52a8\u4f1a\u6bd4\u8f83\u591a\u3002 \u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4e24\u4e2a\u7f51\u5173\u76f8\u4e92\u914d\u5408\uff0c\u65e2\u65b9\u4fbf\u4e86\u8fd0\u7ef4\u7ef4\u62a4\uff0c\u4e5f\u65b9\u4fbf\u4e86\u7814\u53d1\u4eba\u5458\u6269\u5c55\uff0c\u8fbe\u5230\u67d0\u79cd\u5e73\u8861\u3002 \u8fd9\u4e9b\u7f51\u5173\u4f1a\u6839\u636e\u4e1a\u52a1\u7ef4\u5ea6\u62c6\u5206\uff0c\u6bd4\u5982\u5206\u4e3a\u7528\u6237\u7cfb\u7edf\u7f51\u5173\u548c\u5185\u5bb9\u7cfb\u7edf\u7f51\u5173\u3002\u8fd9\u6837\u62c6\u5206\u7684\u76ee\u7684\uff0c\u662f\u9632\u6b62\u7531\u5355\u4e00\u7f51\u5173\u7684\u6545\u969c\u5e26\u6765\u5168\u7ad9\u7684\u4e0d\u53ef\u7528\uff0c\u4ece\u800c\u8fbe\u5230\u964d\u4f4e\u6545\u969c\u5f71\u54cd\u9762\u7684\u6548\u679c\u3002","title":"1-3\u3001\u53cc\u91cd\u7f51\u5173\uff08\u7cfb\u7edf\u7f51\u5173\u548c\u4e1a\u52a1\u7f51\u5173\uff09"},{"location":"chap1/6chap1_apigateway_kong/#2-kong","text":"https://codechina.csdn.net/mirrors/Kong/kong?utm_source=csdn_github_accelerator \u5f00\u6e90\u7f51\u5173 Kong\u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684 API \u7f51\u5173\uff0c\u57fa\u4e8e OpenResty + Lua \u5f00\u53d1\uff0c\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u529f\u80fd\u4ee5\u53ca\u9ad8\u5ea6\u7075\u6d3b\u7684\u6269\u5c55\u6027\uff0c\u53ef\u4ee5\u901a\u8fc7\u63d2\u4ef6\u7684\u65b9\u5f0f\u6269\u5c55 Kong \u7684\u529f\u80fd\u3002 Kong \u4f5c\u4e3a\u5fae\u670d\u52a1\u7f51\u5173\uff0c\u6700\u5927\u7684\u4f18\u52bf\u5c31\u662f \u62bd\u8c61\u51fa\u4e86\u5fae\u670d\u52a1\u7f51\u5173\u7684\u4e00\u5957\u6a21\u578b\uff0c\u800c\u4e0d\u9700\u8981\u50cf OpenResty \u90a3\u6837\u624b\u52a8\u914d\u7f6e \u3002","title":"2\u3001\u5fae\u670d\u52a1\u7f51\u5173 Kong"},{"location":"chap1/6chap1_apigateway_kong/#2-1","text":"service \uff1a\u670d\u52a1\u5bf9\u5e94\u7684\u540e\u7aef\u7684\u5fae\u670d\u52a1\u548c API\u3002\u4e00\u822c\u60c5\u51b5\u4e0b\u628a\u4e00\u7ec4 API \u96c6\u5408\u6210\u4e3a\u4e00\u4e2a\u670d\u52a1\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u540e\u7aef\u7684\u5fae\u670d\u52a1\u3002 router \uff1a\u8def\u7531\u6307\u7684\u662f\u6d41\u91cf\u5230\u8fbe API \u7f51\u5173\u540e\uff0c\u5982\u4f55\u627e\u5230\u540e\u7aef\u5bf9\u5e94\u7684\u670d\u52a1\u3002 Admin API \uff1a Kong \u4e2d\u7684 RESTful \u7684\u5185\u90e8 API \u63a5\u53e3 \u3002 API \u63a5\u53e3\u53ef\u4ee5\u5728\u96c6\u7fa4\u7684\u4efb\u610f\u8282\u70b9\u8fd0\u884c\uff0c\u6700\u7ec8\u540c\u6b65\u5230\u6240\u6709\u96c6\u7fa4\u7684\u8282\u70b9\u3002\u7528\u4e8e\u7ba1\u7406 Kong \u7684\u5404\u79cd\u884c\u4e3a\uff0c\u6bd4\u5982\u6dfb\u52a0 service\u3001router \u7b49\u3002 Plugins\uff1aKong \u7684\u63d2\u4ef6\u7cfb\u7edf \u3002\u5229\u7528\u63d2\u4ef6\u7cfb\u7edf\uff0c\u6211\u4eec\u6dfb\u52a0\u65b0\u529f\u80fd\u5c31\u4e0d\u9700\u8981\u6539\u52a8 Kong \u7684\u6838\u5fc3\u4ee3\u7801\u3002\u63d2\u4ef6\u7cfb\u7edf\u81ea\u5e26\u8db3\u591f\u591a\u7684\u529f\u80fd\uff0c\u6bd4\u5982\u8ba4\u8bc1\u3001\u9650\u6d41\u3001\u65e5\u5fd7\u3001Metrics \u7b49\u3002 Load Balancing \uff1aKong\u63d0\u4f9b\u4e86\u4e24\u79cd\u8d1f\u8f7d\u5747\u8861\u65b9\u5f0f\uff0cDNS \u548c\u5185\u7f6e\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u3002\u5229\u7528 DNS \u6a21\u5f0f\uff0c \u53ef\u4ee5\u548c Consul \u7ed3\u5408\uff0c\u5b9e\u73b0\u670d\u52a1\u53d1\u73b0 \u3002\u5185\u7f6e\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5219\u9700\u8981\u81ea\u5df1\u624b\u52a8\u7ef4\u62a4\u540e\u7aef\u8282\u70b9\u3002","title":"2-1 \u5fae\u670d\u52a1\u7f51\u5173\u7684\u4e00\u5957\u6a21\u578b"},{"location":"chap1/6chap1_apigateway_kong/#2-2-konga","text":"Kong \u5b98\u65b9\u5e76\u6ca1\u6709\u4e3a\u5f00\u6e90\u7248\u672c\u63d0\u4f9b\u56fe\u5f62\u754c\u9762\uff0chttps://github.com/PGBI/kong-dashboard DB Mode\uff080.x-1.0\uff09\u2192 DB-less Mode(1.1-1.5)\u2192 Hybird Mode(2.0+) DB Mode \uff1a\u6700\u65e9\u7684 Kong \u7248\u672c\u5c31\u662f\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6bcf\u4e2a Kong \u90fd\u8fde\u63a5\u4e86\u540e\u7aef DB\uff0c\u8fd9\u4e2a DB \u53ef\u9009\u4e3a PostgreSQL \u6216\u8005 Cassandra\u3002\u4f46\u662f\u8fd9\u4e2a\u6a21\u5f0f\u4e4b\u524d\u6709\u4e2a\u5f88\u4e25\u91cd\u7684 Bug\uff0c \u5c31\u662f\u5728\u6d41\u91cf\u5927\u7684\u65f6\u5019\u66f4\u65b0\u8def\u7531\u914d\u7f6e\uff0c\u4f1a\u5bfc\u81f4 Kong \u4ea7\u751f\u5267\u70c8\u7684\u6296\u52a8 \u3002 DB-less Mode \uff1a\u65e0\u6570\u636e\u5e93\u6a21\u5f0f\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7\u58f0\u660e\u5f0f\u7684\u914d\u7f6e\u65b9\u5f0f\u6765\u8fd0\u884c Kong\u3002\u8fd9\u79cd\u65b9\u5f0f\u4ece\u67d0\u79cd\u610f\u4e49\u6765\u8bf4\u662f\u4e00\u79cd\u5012\u9000\uff0c\u56e0\u4e3a\u5b83 \u8ba9 Kong \u65e0\u6cd5\u901a\u8fc7 API \u63a7\u5236\uff0c\u4e5f\u5c31\u662f\u56de\u5230\u4e86\u539f\u59cb\u7684 Nginx \u914d\u7f6e\u6a21\u5f0f\uff0c\u76f8\u5f53\u4e8e Service Mesh \u5931\u53bb\u4e86\u63a7\u5236\u9762 \u3002\u4f46\u4e5f\u56e0\u4e3a\u56de\u5f52\u4e86\u539f\u59cb\u7684\u65b9\u5f0f\uff0c\u4e0d\u4f1a\u51fa\u73b0 DB Mode \u66f4\u65b0\u914d\u7f6e\u65f6\u5bfc\u81f4\u7684\u4e00\u4e9b\u6296\u52a8\u95ee\u9898\u3002 Hybird Mode \uff1a\u5176\u5b9e\u4e5f\u5c31\u662f\u5f15\u5165\u4e86 Service Mesh \u4e2d\u7684\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u6a21\u5f0f\u3002\u76f8\u5bf9\u4e8e\u4e0a\u9762\u4e24\u79cd\u6a21\u5f0f\u6709\u5de8\u5927\u7684\u67b6\u6784\u4f18\u52bf\uff0c Hybird Mode \u901a\u8fc7\u63a7\u5236\u9762\u6536\u655b\u4e86\u6570\u636e\u5e93\u7684\u64cd\u4f5c\u884c\u4e3a\uff0cKong \u7684\u6570\u636e\u8282\u70b9\u4e0d\u9700\u8981\u518d\u76f4\u63a5\u8fde\u63a5\u5230 DB \u5c42 \u3002\u8fd9\u79cd\u6a21\u5f0f\u6709\u4ee5\u4e0b\u4e24\u79cd\u4f18\u52bf\u3002 \u4ec5\u63a7\u5236\u9762\u8282\u70b9\u9700\u8981\u8fde\u63a5\u5230 DB\uff0c\u800c\u4e0d\u662f\u6240\u6709\u6570\u636e\u8282\u70b9\u8fde\u63a5\u5230 DB\uff0c\u5bf9 DB \u7684\u538b\u529b\u5927\u5927\u51cf\u5c11\uff0c\u4e5f\u5c31\u964d\u4f4e\u4e86\u6570\u636e\u9762\u51fa\u73b0\u6296\u52a8\u7684\u6982\u7387\u3002 \u6613\u4e8e\u7ba1\u7406\uff0c\u4e0d\u7528\u50cf\u4e4b\u524d\u7684 API \u8c03\u7528 Kong \u7684\u6570\u636e\u8282\u70b9\u65f6\u518d\u64cd\u4f5c Admin API \u53d8\u66f4\uff0c\u53ea\u9700\u4e0e\u63a7\u5236\u9762\u4ea4\u4e92\u5373\u53ef\u3002","title":"2-2 Konga"},{"location":"chap1/6chap1_apigateway_kong/#2-3","text":"\u7edf\u7f51\u5173\u548c\u4e1a\u52a1\u7f51\u5173\u7684\u67b6\u6784\uff0c\u5b9e\u9645\u4e0a\u8fd9\u6837\u505a\u589e\u52a0\u4e86\u4e00\u6761\u8bf7\u6c42\u94fe\u8def\u3002\u6211\u4eec\u8fd9\u6837\u505a\u662f\u56e0\u4e3a\u4e1a\u52a1\u7f51\u5173\u9891\u7e41\u66f4\u65b0\uff0c\u90a3\u4e48\u6709\u6ca1\u6709\u529e\u6cd5\u51cf\u5c11\u8fd9\u79cd\u66f4\u65b0\u9891\u7387\u5462\uff1f \u5b9e\u9645\u4e0a Uber \u5df2\u7ecf\u5728\u67d0\u65b9\u9762\u505a\u51fa\u4e86\u52a8\u4f5c\uff0c\u90a3\u5c31\u662f\u901a\u8fc7\u56fe\u5f62\u5316\u754c\u9762\u7684\u65b9\u5f0f\uff0c\u805a\u5408\u540e\u7aef API\u3002","title":"2-3 \u56fe\u5f62\u5316\u805a\u5408\u5c42"},{"location":"chap1/6chap1_apigateway_kong/#2-4","text":"\u8fd9\u91cc\u7684\u957f\u8fde\u7f51\u5173\uff0c\u6307\u7684\u662f\u901a\u8fc7\u79c1\u6709\u534f\u8bae\u6216\u8005 gRPC\u3001HTTP/2 \u7b49\u534f\u8bae\u4ee3\u66ff HTTP \u534f\u8bae\u3002 \u901a\u8fc7\u957f\u8fde\u63a5\u901a\u9053\uff0c\u51cf\u5c11\u5ba2\u6237\u7aef\u548c\u7f51\u5173\u7684\u5efa\u8fde\u6b21\u6570\uff0c\u540c\u65f6\u901a\u8fc7\u538b\u7f29 header \u7b49\u65b9\u5f0f\uff0c\u51cf\u5c11\u901a\u4fe1\u4e2d\u4ea7\u751f\u7684\u6d41\u91cf\uff0c\u4ee5\u8fbe\u5230\u63d0\u9ad8\u5ba2\u6237\u7aef\u54cd\u5e94\u901f\u5ea6\u7684\u76ee\u7684\uff0c\u8ba9\u7528\u6237\u5728 App \u7684\u4f7f\u7528\u4f53\u9a8c\u4e0a\u66f4\u4e0a\u4e00\u4e2a\u53f0\u9636\u3002","title":"2-4 \u957f\u8fde\u7f51\u5173"},{"location":"chap1/6chap1_apigateway_kong/#2-5-service-mesh","text":"\u5176\u5b9e\u5728 Service Mesh \u65f6\u4ee3\uff0c\u5fae\u670d\u52a1\u7f51\u5173\u4e2d\u7684\u67d0\u4e9b\u529f\u80fd\uff0c\u6bd4\u5982\u9650\u6d41\u3001\u8ba4\u8bc1\u3001\u9274\u6743\u7b49\u901a\u7528\u529f\u80fd\uff0c\u5b8c\u5168\u53ef\u4ee5\u8ba9\u672c\u5730\u7684 Sidecar \u5b8c\u6210\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u51cf\u5c11\u5fae\u670d\u52a1\u94fe\u8def\u4e2d\u7684\u4e00\u73af\uff0c\u63d0\u9ad8\u670d\u52a1\u7684\u541e\u5410\u53ca\u6574\u4f53\u67b6\u6784\u7684\u53ef\u7ef4\u62a4\u6027\u3002","title":"2-5 Service Mesh \u5316"},{"location":"chap1/7chap1_config_center/","text":"\u7b2c\u4e03\u8282 \u5fae\u670d\u52a1\u6cbb\u7406\u7684\u914d\u7f6e\u4e2d\u5fc3 \u53ef\u80fd\u4f1a\u5c06\u6ce8\u518c\u4e2d\u5fc3\u548c\u914d\u7f6e\u4e2d\u5fc3\u6df7\u4e3a\u4e00\u8c08\uff0c \u7279\u522b\u662f\u5f88\u591a\u5206\u5e03\u5f0f\u5b58\u50a8\u7ec4\u4ef6\u4e5f\u7ecf\u5e38\u88ab\u63a8\u8350\u540c\u65f6\u7528\u4f5c\u6ce8\u518c\u4e2d\u5fc3\u548c\u914d\u7f6e\u4e2d\u5fc3 \u3002\u8fd9\u91cc\u9762\u5b58\u5728\u4e00\u5b9a\u7684\u8bef\u89e3 1\u3001\u4e3a\u4ec0\u4e48\u9700\u8981\u914d\u7f6e\u4e2d\u5fc3 \u914d\u7f6e\u4e2d\u5fc3\uff0c\u4ece\u540d\u5b57\u4e0a\u770b\uff0c\u5c31\u662f\u7528\u6765\u7edf\u4e00\u7ba1\u7406\u9879\u76ee\u4e2d\u6240\u6709\u914d\u7f6e\u7684\u7cfb\u7edf\u3002 \u800c\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u914d\u7f6e\u4e2d\u5fc3\u662f\u7528\u6765\u52a8\u6001\u66f4\u65b0\u670d\u52a1\u914d\u7f6e\uff0c\u800c\u4e0d\u9700\u8981\u8fdb\u884c\u670d\u52a1\u90e8\u7f72\u7684\u7ec4\u4ef6\u3002 1-1 \u51cf\u5c11\u53d1\u7248\u6b21\u6570 \u51cf\u5c11\u53d1\u7248\u6b21\u6570\u662f\u914d\u7f6e\u4e2d\u5fc3\u5e26\u6765\u7684\u6700\u5927\u4f18\u52bf \u4ee5\u5f80\u914d\u7f6e\u6587\u4ef6\u90fd\u662f\u653e\u5728\u4ee3\u7801\u4e2d\uff0c\u5982\u679c\u60f3\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u53ea\u80fd\u4fee\u6539\u4ee3\u7801\u7136\u540e\u901a\u8fc7\u53d1\u5e03\u7cfb\u7edf\u53d1\u5e03\u65b0\u7684\u4ee3\u7801\u7248\u672c\u3002\u8fd9\u79cd\u65b9\u5f0f\u4f1a\u9020\u6210\u9891\u7e41\u53d1\u7248\uff0c\u6bd4\u5982\u4fee\u6539\u65e5\u5fd7\u7684\u7b49\u7ea7\uff0c\u5c31\u8981\u91cd\u65b0\u53d1\u7248\u3002 \u53d1\u7248\u4e0d\u4ec5\u4f1a\u5e26\u6765\u4e00\u5b9a\u7684\u98ce\u9669\uff0c\u800c\u4e14\u53d1\u7248\u7684\u65f6\u95f4\u5468\u671f\u5f80\u5f80\u6bd4\u8f83\u957f\uff0c\u76f8\u5bf9\u6765\u8bf4\uff0c \u901a\u8fc7\u914d\u7f6e\u4e2d\u5fc3\u66f4\u65b0\u914d\u7f6e \uff0c\u65f6\u95f4\u4f1a\u77ed\u5f88\u591a \u4f20\u7edf\u7684\u53d1\u7248 \u4fee\u6539\u4ee3\u7801\u2192\u63d0\u4ea4\u4ee3\u7801\u2192\u5408\u5e76\u4ee3\u7801\u2192 CI/CD \u53d1\u5e03\u2192\u89c2\u5bdf\u76d1\u63a7 \u914d\u7f6e\u4e2d\u5fc3 \u53ef\u4ee5\u8ba9\u5de5\u7a0b\u5e08\u4ece\u70e6\u7410\u7684\u91cd\u590d\u5de5\u4f5c\u4e2d\u89e3\u8131\u51fa\u6765\uff0c\u63d0\u9ad8\u5f00\u53d1\u6548\u7387\u3002 1-2 \u63d0\u5347\u5b89\u5168\u6027 \u5982\u679c\u901a\u8fc7\u4ee3\u7801\u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\u7ef4\u62a4\u914d\u7f6e\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u3001Redis \u7b49\u4e2d\u95f4\u4ef6\u7684\u8ba4\u8bc1\u4fe1\u606f\u90fd\u4f1a\u660e\u6587\u5b58\u50a8\u5728\u4ee3\u7801\u4e2d\uff0c\u8fd9\u6837\u7684\u5b89\u5168\u6027\u5c31\u4f1a\u6bd4\u8f83\u4f4e\u3002 \u800c\u901a\u8fc7\u914d\u7f6e\u4e2d\u5fc3\uff0c\u53ef\u4ee5\u5c06\u654f\u611f\u4fe1\u606f\u6536\u655b\u5230\u914d\u7f6e\u4e2d\u5fc3\u7684\u5b58\u50a8\u4e2d\uff0c\u5e76\u901a\u8fc7\u4e00\u5b9a\u7684\u52a0\u89e3\u5bc6\u7b97\u6cd5\u52a0\u5bc6\u4fdd\u62a4\u3002 2\u3001\u914d\u7f6e\u4e2d\u5fc3\u7279\u6027 2-1 \u5b9e\u65f6\u611f\u77e5\u53d8\u66f4 \u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\u6765\u8bf4\uff0c \u5b9e\u65f6\u611f\u77e5\u914d\u7f6e\u7684\u53d8\u5316\u662f\u6700\u57fa\u672c\u7684\u529f\u80fd\uff0c\u8fd9\u70b9\u548c\u6ce8\u518c\u4e2d\u5fc3\u7684\u9700\u6c42\u57fa\u672c\u4e00\u81f4\uff0c\u8fd9\u4e5f\u662f\u4e24\u4e2a\u7ec4\u4ef6\u7ecf\u5e38\u88ab\u6df7\u7528\u7684\u4e3b\u8981\u539f\u56e0 \u3002 \u6ce8\u518c\u4e2d\u5fc3\u5bf9\u5b9e\u65f6\u6027\u8981\u6c42\u975e\u5e38\u9ad8 \uff0c\u5728\u4fdd\u8bc1\u7a33\u5b9a\u6027\u7684\u524d\u63d0\u4e0b\u5c3d\u53ef\u80fd\u5730\u5feb\u901f\u6536\u5230\u8282\u70b9\u7684\u53d8\u66f4\uff0c\u4ee5\u4fdd\u8bc1\u8d1f\u8f7d\u5747\u8861\u5668\u6570\u636e\u6e90\u7684\u51c6\u786e\u6027\uff1b \u4f46\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\u6765\u8bf4\uff0c\u5b9e\u65f6\u6027\u8981\u6c42\u5e76\u4e0d\u662f\u90a3\u4e48\u9ad8\uff0c\u53ea\u8981\u4fdd\u8bc1\u6700\u7ec8\u4e00\u81f4\u5c31\u53ef\u4ee5\u4e86 \uff0c\u81f3\u4e8e\u65f6\u95f4\u662f 1s \u8fd8\u662f 1min\uff0c\u90fd\u53ef\u4ee5\u63a5\u53d7\u3002 2-2 \u5b89\u5168\u6027\u8981\u6c42\u9ad8 \u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\uff0c\u56e0\u4e3a\u7ecf\u5e38\u8981\u5b58\u50a8\u6570\u636e\u5e93\u5bc6\u7801\u3001\u7b2c\u4e09\u65b9\u4e1a\u52a1\u5bc6\u94a5\u7b49\u4fe1\u606f\uff0c \u6240\u4ee5\u5bf9\u5b89\u5168\u6027\u8981\u6c42\u6bd4\u8f83\u9ad8 \uff0c\u5bf9\u7279\u6b8a\u7684\u5b57\u6bb5\u8981\u52a0\u5bc6\u3002 \u53e6\u5916\u914d\u7f6e\u4e2d\u5fc3\u5728\u901a\u4fe1\u4e0a\u9700\u8981\u91c7\u7528\u53cc\u5411 TLS \u8ba4\u8bc1\uff0c\u4ee5\u4fdd\u8bc1\u4f20\u8f93\u7684\u5b89\u5168\u6027 \u3002 \u76f8\u5bf9\u800c\u8a00\uff0c\u6ce8\u518c\u4e2d\u5fc3\u5bf9\u5b89\u5168\u6027\u7684\u8981\u6c42\u6bd4\u8f83\u4f4e 2-3 \u53d8\u66f4\u5ba1\u8ba1 \u6bcf\u4e00\u9879\u914d\u7f6e\u7684\u53d8\u66f4\u90fd\u8981\u6709\u53ef\u8ffd\u8e2a\u7684\u5ba1\u8ba1\u65e5\u5fd7\uff0c\u4ee5\u65b9\u4fbf\u56de\u6eaf\u95ee\u9898\u53d1\u751f\u7684\u539f\u56e0\u3002\u4e00 \u822c\u6ce8\u518c\u4e2d\u5fc3\u7684\u7ec4\u4ef6\u4e0d\u4f1a\u63d0\u4f9b\u8fd9\u6837\u7684\u529f\u80fd\uff0c\u4f46\u662f\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c \u5982\u679c\u662f\u4e3b\u52a8\u7684\u53d1\u7248\u6216\u8005\u4fee\u6539\u6743\u91cd\u7b49\u4fe1\u606f\u4e5f\u9700\u8981\u989d\u5916\u6dfb\u52a0\u53ef\u5ba1\u8ba1\u7684\u65e5\u5fd7 \u3002 2-4 \u7070\u5ea6\u53d1\u5e03 \u914d\u7f6e\u4e2d\u5fc3\u548c CD \u53d1\u5e03\u7cfb\u7edf\u4e00\u6837\uff0c\u90fd\u9700\u8981\u652f\u6301\u5b8c\u5907\u7684\u7070\u5ea6\u7cfb\u7edf\u3002\u4e00\u822c\u5728\u5b8c\u6574\u7684\u53d1\u5e03\u914d\u7f6e\u524d\uff0c\u90fd\u9700\u8981\u5148\u7070\u5ea6\u4e00\u53f0\u673a\u5668\uff0c\u7136\u540e\u67e5\u770b\u76d1\u63a7\u7cfb\u7edf\u662f\u5426\u6709\u95ee\u9898\u53d1\u751f\uff0c\u518d\u8fdb\u884c\u5168\u91cf\u53d1\u5e03\u3002 2-5 \u53d8\u66f4\u56de\u6eda \u8fd9\u70b9\u4e5f\u548c CD \u7cfb\u7edf\u4e00\u6837\uff0c\u8981\u5177\u5907\u53d8\u66f4\u56de\u6eda\u80fd\u529b\u3002\u5982\u679c\u6ca1\u6709\u56de\u6eda\u80fd\u529b\uff0c\u4e00\u65e6\u53d8\u66f4\u51fa\u9519\uff0c\u53c8\u6ca1\u6709\u624b\u52a8\u5907\u4efd\u4e0a\u4e00\u4efd\u914d\u7f6e\uff0c\u5c31\u4f1a\u5f15\u53d1\u751f\u4ea7\u4e8b\u6545\u3002 \u800c\u5177\u5907\u4e86\u4e00\u952e\u56de\u6eda\u529f\u80fd\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c \u53ef\u4ee5\u907f\u514d\u8fd9\u79cd\u95ee\u9898\u7684\u53d1\u751f\u3002 2-6 \u5f31\u4f9d\u8d56 \u4e00\u822c\u800c\u8a00\uff0c\u901a\u8fc7\u5065\u58ee\u7684 SDK \u8bbe\u8ba1\uff0c\u90fd\u53ef\u4ee5\u505a\u5230\u914d\u7f6e\u4e2d\u5fc3\u7684\u5f31\u4f9d\u8d56\uff0c\u6bd4\u5982\u901a\u8fc7\u6587\u4ef6\u7f13\u5b58\u914d\u7f6e\uff0c\u5373\u4fbf\u914d\u7f6e\u4e2d\u5fc3\u51fa\u73b0\u6545\u969c\uff0c\u4e5f\u4e0d\u5f71\u54cd\u7a0b\u5e8f\u7684\u6b63\u5e38\u542f\u52a8\u548c\u8fd0\u884c\u3002\u4f46\u662f\u5bf9\u4e8e\u6ce8\u518c\u4e2d\u5fc3\u800c\u8a00\u5c31\u6bd4\u8f83\u56f0\u96be\u4e86\uff0c\u5373\u4fbf\u9632\u707e\u96be\u8bbe\u8ba1\u5f97\u518d\u5145\u5206\uff0c\u4e00\u65e6\u53d1\u751f\u6545\u969c\uff0c\u5bf9\u4e1a\u52a1\u4e5f\u4f1a\u6709\u6bd4\u8f83\u5927\u7684\u5f71\u54cd\u3002 2-7 \u6613\u7528\u7684\u56fe\u5f62\u754c\u9762 \u56e0\u4e3a\u914d\u7f6e\u4e2d\u5fc3\u63d0\u4f9b\u4e86\u7070\u5ea6\u53d1\u5e03\u3001\u53d8\u66f4\u56de\u6eda\u7b49\u591a\u79cd\u529f\u80fd\uff0c\u6240\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u6613\u7528\u7684\u56fe\u5f62\u754c\u9762\u662f\u5fc5\u987b\u7684\uff1b\u800c\u6ce8\u518c\u4e2d\u5fc3\u5bf9\u4e8e\u754c\u9762\u7684\u8981\u6c42\u4e00\u822c\u6ca1\u6709\u8fd9\u4e48\u9ad8\u3002 3\u3001\u914d\u7f6e\u4e2d\u5fc3\u9009\u578b 3-1 etcd etcd \u7ecf\u5e38\u88ab\u63a8\u8350\u4f5c\u4e3a\u914d\u7f6e\u4e2d\u5fc3\uff0c\u4f46\u5b9e\u9645\u4e0a\u5b83\u5e76\u4e0d\u9002\u5408\u3002 \u9996\u5148\uff0cetcd \u9ed8\u8ba4\u6709 2G \u7684\u5b58\u50a8\u4e0a\u9650\uff0c\u6570\u636e\u8fbe\u5230\u4e0a\u9650\u540e\u4f1a\u65e0\u6cd5\u5199\u5165\u6570\u636e\uff1b \u53e6\u5916\uff0cetcd \u8bb0\u5f55\u4e86\u6bcf\u6761\u6570\u636e\u591a\u4e2a\u7248\u672c\u7684\u4fe1\u606f\uff0c\u4e5f\u4f1a\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\u3002 \u5b9e\u9645\u4e0a\u968f\u7740\u670d\u52a1\u6570\u91cf\u7684\u589e\u591a\uff0c\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\u8fd9\u4e2a\u573a\u666f\uff0c\u5b58\u50a8\u7684\u914d\u7f6e\u91cf\u662f\u6bd4\u8f83\u5927\u7684\u3002 etcd \u9664\u4e86\u80fd\u591f\u505a\u5230\u914d\u7f6e\u5b9e\u65f6\u53d8\u66f4\uff0c\u5e76\u6ca1\u6709\u592a\u5927\u7684\u4f18\u52bf\uff0c\u53cd\u800c\u4f1a\u8ba9\u7ef4\u62a4\u6210\u672c\u589e\u52a0\u3002 3-2 Apollo Apollo \u662f\u643a\u7a0b\u7814\u53d1\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c\u63d0\u4f9b\u4e86\u5305\u62ec Java\u3001.Net\u3001PHP\u3001Go \u7b49\u591a\u79cd\u8bed\u8a00\u7684 SDK\u3002\u800c\u4e14\u63d0\u4f9b\u4e86\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u914d\u7f6e\u4e2d\u5fc3\u6240\u9700\u8981\u7684\u591a\u79cd\u529f\u80fd\uff0c\u6bd4\u5982\u591a\u73af\u5883\u3001\u7070\u5ea6\u53d1\u5e03\u3001\u5b9e\u65f6\u63a8\u9001\u3001\u53d8\u66f4\u56de\u6eda\u7b49\u3002 \u76f8\u5bf9\u4e8e etcd\uff0cApollo \u662f\u66f4\u5408\u9002\u7684\u914d\u7f6e\u4e2d\u5fc3\u9009\u578b\uff0c Apollo \u7684\u540e\u7aef\u5b58\u50a8\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u76f4\u63a5\u7528 MySQL \u4f5c\u4e3a\u540e\u7aef\u5b58\u50a8\uff0c\u5bf9\u4e8e\u8fd0\u7ef4\u6765\u8bf4\uff0c\u4e5f\u66f4\u7b80\u5355\u53ef\u9760 \u3002 3-3 Confd Golang \u5f00\u53d1\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c \u7279\u522b\u4ee5 Agent \u7684\u65b9\u5f0f\u90e8\u7f72\u5728\u673a\u5668\u4e0a\uff0c\u901a\u8fc7\u670d\u52a1\u8fdb\u7a0b\u76d1\u542c\u6587\u4ef6\u53d8\u5316\u4ee5\u8fbe\u5230\u66f4\u65b0\u914d\u7f6e\u7684\u76ee\u7684 \u3002 \u8fd9\u79cd\u65b9\u5f0f\u6613\u4e8e\u63a8\u5e7f\uff0c\u5982\u679c\u5728\u5fae\u670d\u52a1\u7684\u521d\u671f\u6ca1\u6709\u5f15\u5165\u914d\u7f6e\u4e2d\u5fc3\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u6b64\u79cd\u65b9\u5f0f\uff0c\u65e0\u987b\u670d\u52a1\u66f4\u65b0 SDK\uff0c\u53ea\u8981\u5728\u5bbf\u4e3b\u673a\u4e0a\u90e8\u7f72 Agent \u76d1\u542c\u6587\u4ef6\u53d8\u5316\u5c31\u53ef\u4ee5\u4e86\u3002\u53e6\u5916\u5b83\u4e5f\u5f88\u9002\u5408\u5404\u79cd\u5f00\u6e90\u7ec4\u4ef6\uff0c\u6bd4\u5982 Nginx \u7684\u52a8\u6001\u914d\u7f6e\u66f4\u65b0\uff08Ningx \u53ef\u4ee5\u901a\u8fc7 reload \u6216\u8005 kill -HUP \u7684\u65b9\u5f0f\u52a8\u6001\u66f4\u65b0\u914d\u7f6e\uff09\u3002 \u53e6\u5916 Confd \u63d0\u4f9b\u4e86\u591a\u79cd\u914d\u7f6e\u5b58\u50a8\u65b9\u6848\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u573a\u666f\u8fdb\u884c\u9009\u62e9\u3002\u4f46 Confd \u5e76\u6ca1\u6709\u63d0\u4f9b\u56fe\u5f62\u754c\u9762\uff0c\u5982\u679c\u8981\u4f7f\u7528\uff0c\u8fd8\u662f\u9700\u8981\u4e8c\u6b21\u5f00\u53d1\u7684\u3002 3-4 \u81ea\u7814 \u914d\u7f6e\u4e2d\u5fc3\u4f5c\u4e3a\u5fae\u670d\u52a1\u7684\u7ec4\u4ef6\uff0c\u5b9e\u9645\u4e0a\u9700\u6c42\u53d8\u5316\u5e76\u4e0d\u662f\u7279\u522b\u591a\uff0c\u57fa\u672c\u4e0a KV \u7684\u7b80\u5355\u5b58\u50a8\u3001\u5b9e\u65f6\u53d8\u66f4\u5c31\u53ef\u4ee5\u6ee1\u8db3\u9700\u6c42\u4e86\uff0c\u6240\u4ee5\u5efa\u8bae\u9009\u7528\u5f00\u6e90\u7684\u914d\u7f6e\u4e2d\u5fc3\u65b9\u6848\uff0c\u5982\u679c\u6709\u7279\u6b8a\u9700\u6c42\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\u5373\u53ef\u3002 4\u3001\u914d\u7f6e\u4e2d\u5fc3\u4e2d\u7684\u5b9e\u65f6\u53d8\u66f4 \u914d\u7f6e\u4e2d\u5fc3\u4e2d\u7684\u5b9e\u65f6\u53d8\u66f4\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002 4-1 \u957f\u8fde\u63a5 watch \u4f7f\u7528\u539f\u751f TCP \u81ea\u5b9a\u4e49\u534f\u8bae\uff0c\u6216\u8005\u76f4\u63a5\u91c7\u7528 gRPC \u534f\u8bae\uff0c\u90fd\u53ef\u4ee5\u5b9e\u73b0 watch \u7684\u529f\u80fd\u3002\u5f53\u914d\u7f6e\u6570\u636e\u53d1\u751f\u53d8\u5316\u7684\u65f6\u5019\uff0c\u4e3b\u52a8\u63a8\u9001\u6d88\u606f\u5230 SDK\u3002\u6bd4\u5982 etcd \u5c31\u662f\u91c7\u7528\u4e86 gRPC watch \u7684\u65b9\u5f0f\u3002 4-2 HTTP \u957f\u8f6e\u8be2 \u56e0\u4e3a HTTP \u534f\u8bae\u7684\u901a\u7528\u6027\u8f83\u597d\uff0c\u800c\u4e14\u5927\u5bb6\u5bf9 HTTP \u534f\u8bae\u4e5f\u76f8\u5bf9\u719f\u6089\uff0c\u6240\u4ee5\u5f88\u591a\u5f00\u6e90\u7ec4\u4ef6\u5728\u5b9e\u73b0\u63a8\u9001\u529f\u80fd\u7684\u65f6\u5019\uff0c \u90fd\u4f1a\u9009\u62e9\u957f\u8f6e\u8be2\uff0c\u4e5f\u5c31\u662f Long Polling\u3002\u50cf Apollo\u3001Consul \u90fd\u91c7\u7528\u4e86\u957f\u8f6e\u8be2\u7684\u65b9\u6848\u6765\u5b9e\u73b0\u63a8\u9001\u529f\u80fd \u3002 \u957f\u8f6e\u8be2\u7684\u5b9e\u73b0\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c \u5ba2\u6237\u7aef\u901a\u8fc7 KeepAlive \u7684\u65b9\u5f0f\u8fde\u63a5\u670d\u52a1\u5668\u7aef\uff0c\u670d\u52a1\u7aef\u963b\u585e\u8fde\u63a5\u76f4\u5230\u6709\u53d8\u5316\u6216\u8005\u8d85\u65f6(\u9ed8\u8ba4\u4e00\u822c 60s)\u624d\u8fd4\u56de\u6570\u636e \uff0c\u901a\u8fc7\u6b64\u79cd\u65b9\u5f0f\u5b9e\u73b0\u7c7b\u4f3c\u957f\u8fde\u63a5\u7684 watch \u65b9\u5f0f\u3002 4-3 \u5b9a\u65f6\u540c\u6b65 \u5b9a\u65f6\u540c\u6b65\u7684\u65b9\u5f0f\u5219\u66f4\u52a0\u7b80\u5355\uff0c\u901a\u8fc7 HTTP \u65b9\u5f0f\u5b9a\u65f6\u8bf7\u6c42\u540e\u7aef\u63a5\u53e3\uff0c\u5bf9\u6bd4\u4e24\u6b21\u6570\u636e\u662f\u5426\u4ea7\u751f\u53d8\u5316\uff0c\u5982\u679c\u4ea7\u751f\u53d8\u5316\u5219\u66f4\u65b0\u914d\u7f6e\u3002 4-4 watch+\u5b9a\u65f6\u8f6e\u8be2 \u4e3a\u4e86\u9632\u6b62 watch \u6570\u636e\u56e0\u4e3a\u5f02\u5e38\u6f0f\u6389\u4e86\u63a8\u9001\u7684\u6570\u636e\u53d8\u5316\uff0c\u901a\u5e38\u4f1a\u91c7\u7528\u63a8\u62c9\u7ed3\u5408\u7684\u65b9\u5f0f\uff0c\u4e5f\u662fwatch+\u5b9a\u65f6\u8f6e\u8be2\u7684\u65b9\u5f0f\u3002\u5b9e\u73b0\u65b9\u5f0f\u5176\u5b9e\u5c31\u662f\u4e0a\u9762\u8bb2\u5230\u7684\u957f\u8fde\u63a5 watch \u548c\u5b9a\u65f6\u540c\u6b65\u76f8\u7ed3\u5408\u3002 5\u3001Service Mesh \u65f6\u4ee3\u7684\u914d\u7f6e\u4e2d\u5fc3 \u5fae\u670d\u52a1\u67b6\u6784\u7684\u53d1\u5c55\uff0c\u5bf9\u914d\u7f6e\u4e2d\u5fc3\u63d0\u51fa\u4e86\u66f4\u9ad8\u7684\u8981\u6c42\uff0c\u9664\u4e86\u4f20\u7edf\u7684\u63d0\u4f9b\u670d\u52a1\u914d\u7f6e\u7684\u4fee\u6539\uff0c\u4e5f\u5e0c\u671b\u914d\u7f6e\u4e2d\u5fc3\u80fd\u591f\u63d0\u4f9b Service Mesh \u4e2d\u63a7\u5236\u9762\u7684\u6570\u636e\u7ba1\u7406\u529f\u80fd 5-1 \u670d\u52a1\u6cbb\u7406\u96c6\u4e2d\u914d\u7f6e \u5bf9\u4e8e\u4f20\u7edf\u7684\u914d\u7f6e\u4e2d\u5fc3\u6765\u8bf4\uff0c\u8fd8\u662f\u6bcf\u4e2a\u670d\u52a1\u7ba1\u63a7\u81ea\u5df1\u7684\u914d\u7f6e\uff0c\u8fd9\u4e9b\u914d\u7f6e\u6587\u4ef6\u7684\u5b9a\u4e49\u53ef\u80fd\u5343\u5947\u767e\u602a\uff0c\u6bd4\u5982 a \u670d\u52a1\u7684\u9650\u6d41\u914d\u7f6e\u53ef\u80fd\u53eb\u4f5c Limit\uff0cb \u670d\u52a1\u53eb\u4f5c RateLimit\uff0c\u8fd9\u4e9b\u914d\u7f6e\u5747\u7531\u6bcf\u4e2a\u670d\u52a1\u72ec\u81ea\u8d1f\u8d23\uff0c\u5e76\u4e0d\u5173\u5fc3\u5176\u4ed6\u670d\u52a1\u3002\u4f46\u662f\u5bf9\u4e8e\u670d\u52a1\u6cbb\u7406\u6765\u8bf4\uff0c\u5f88\u591a\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u96c6\u4e2d\u7ba1\u63a7\u8fd9\u4e9b\u6570\u636e\uff0c\u6240\u4ee5\u8981\u628a\u7cfb\u7edf\u5c42\u9762\u7684\u914d\u7f6e\u62bd\u8c61\u51fa\u6765\uff0c\u5f62\u6210\u7edf\u4e00\u7684\u6570\u636e\u7ed3\u6784\u63d0\u4f9b\u63a7\u5236\u9762\u4f7f\u7528\u3002 \u914d\u7f6e\u4e2d\u5fc3\u4e0d\u4ec5\u9700\u8981\u611f\u77e5\u81ea\u8eab\u914d\u7f6e\u7684\u53d8\u5316\uff0c\u4e5f\u9700\u8981\u611f\u77e5\u88ab\u8c03\u670d\u52a1\u7684\u53d8\u5316\u3002 5-2 \u5e73\u53f0\u5316 \u968f\u7740\u670d\u52a1\u6570\u91cf\u8d8a\u6765\u8d8a\u591a\uff0c\u670d\u52a1\u6cbb\u7406\u529f\u80fd\u88ab\u62bd\u8c61\u51fa\u6765\uff0c\u56e0\u6b64\u9700\u8981\u4e00\u4e2a\u5fae\u670d\u52a1\u6cbb\u7406\u5e73\u53f0\u7ba1\u7406\u6240\u6709\u670d\u52a1\u7684\u670d\u52a1\u6cbb\u7406\u914d\u7f6e\uff0c\u800c\u4e0d\u662f\u50cf\u4ee5\u524d\u4e00\u6837\u628a\u914d\u7f6e\u6563\u843d\u5728\u5404\u4e2a\u670d\u52a1\u4e2d\u3002 \u6709\u4e86\u8fd9\u6837\u4e00\u4e2a\u5e73\u53f0\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba9 SRE \u4ecb\u5165\u670d\u52a1\u7684\u7ef4\u62a4\u4e2d\u5fc3\uff0c\u5728\u670d\u52a1\u51fa\u73b0\u95ee\u9898\u7684\u65f6\u5019\uff0c\u901a\u8fc7\u670d\u52a1\u6cbb\u7406\u624b\u6bb5\uff0c\u6bd4\u5982\u9650\u6d41\u3001\u7194\u65ad\u3001\u964d\u7ea7\uff0cSRE \u53ef\u4ee5\u901a\u8fc7\u5e73\u53f0\u76f4\u63a5\u64cd\u4f5c\uff0c\u4ee5\u964d\u4f4e\u6545\u969c\u7684\u5f71\u54cd\u9762\u548c\u4e8b\u6545\u7b49\u7ea7\u3002","title":"\u7b2c\u4e03\u8282 \u5fae\u670d\u52a1\u6cbb\u7406\u7684\u914d\u7f6e\u4e2d\u5fc3"},{"location":"chap1/7chap1_config_center/#_1","text":"\u53ef\u80fd\u4f1a\u5c06\u6ce8\u518c\u4e2d\u5fc3\u548c\u914d\u7f6e\u4e2d\u5fc3\u6df7\u4e3a\u4e00\u8c08\uff0c \u7279\u522b\u662f\u5f88\u591a\u5206\u5e03\u5f0f\u5b58\u50a8\u7ec4\u4ef6\u4e5f\u7ecf\u5e38\u88ab\u63a8\u8350\u540c\u65f6\u7528\u4f5c\u6ce8\u518c\u4e2d\u5fc3\u548c\u914d\u7f6e\u4e2d\u5fc3 \u3002\u8fd9\u91cc\u9762\u5b58\u5728\u4e00\u5b9a\u7684\u8bef\u89e3","title":"\u7b2c\u4e03\u8282 \u5fae\u670d\u52a1\u6cbb\u7406\u7684\u914d\u7f6e\u4e2d\u5fc3"},{"location":"chap1/7chap1_config_center/#1","text":"\u914d\u7f6e\u4e2d\u5fc3\uff0c\u4ece\u540d\u5b57\u4e0a\u770b\uff0c\u5c31\u662f\u7528\u6765\u7edf\u4e00\u7ba1\u7406\u9879\u76ee\u4e2d\u6240\u6709\u914d\u7f6e\u7684\u7cfb\u7edf\u3002 \u800c\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u914d\u7f6e\u4e2d\u5fc3\u662f\u7528\u6765\u52a8\u6001\u66f4\u65b0\u670d\u52a1\u914d\u7f6e\uff0c\u800c\u4e0d\u9700\u8981\u8fdb\u884c\u670d\u52a1\u90e8\u7f72\u7684\u7ec4\u4ef6\u3002","title":"1\u3001\u4e3a\u4ec0\u4e48\u9700\u8981\u914d\u7f6e\u4e2d\u5fc3"},{"location":"chap1/7chap1_config_center/#1-1","text":"\u51cf\u5c11\u53d1\u7248\u6b21\u6570\u662f\u914d\u7f6e\u4e2d\u5fc3\u5e26\u6765\u7684\u6700\u5927\u4f18\u52bf \u4ee5\u5f80\u914d\u7f6e\u6587\u4ef6\u90fd\u662f\u653e\u5728\u4ee3\u7801\u4e2d\uff0c\u5982\u679c\u60f3\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u53ea\u80fd\u4fee\u6539\u4ee3\u7801\u7136\u540e\u901a\u8fc7\u53d1\u5e03\u7cfb\u7edf\u53d1\u5e03\u65b0\u7684\u4ee3\u7801\u7248\u672c\u3002\u8fd9\u79cd\u65b9\u5f0f\u4f1a\u9020\u6210\u9891\u7e41\u53d1\u7248\uff0c\u6bd4\u5982\u4fee\u6539\u65e5\u5fd7\u7684\u7b49\u7ea7\uff0c\u5c31\u8981\u91cd\u65b0\u53d1\u7248\u3002 \u53d1\u7248\u4e0d\u4ec5\u4f1a\u5e26\u6765\u4e00\u5b9a\u7684\u98ce\u9669\uff0c\u800c\u4e14\u53d1\u7248\u7684\u65f6\u95f4\u5468\u671f\u5f80\u5f80\u6bd4\u8f83\u957f\uff0c\u76f8\u5bf9\u6765\u8bf4\uff0c \u901a\u8fc7\u914d\u7f6e\u4e2d\u5fc3\u66f4\u65b0\u914d\u7f6e \uff0c\u65f6\u95f4\u4f1a\u77ed\u5f88\u591a \u4f20\u7edf\u7684\u53d1\u7248 \u4fee\u6539\u4ee3\u7801\u2192\u63d0\u4ea4\u4ee3\u7801\u2192\u5408\u5e76\u4ee3\u7801\u2192 CI/CD \u53d1\u5e03\u2192\u89c2\u5bdf\u76d1\u63a7 \u914d\u7f6e\u4e2d\u5fc3 \u53ef\u4ee5\u8ba9\u5de5\u7a0b\u5e08\u4ece\u70e6\u7410\u7684\u91cd\u590d\u5de5\u4f5c\u4e2d\u89e3\u8131\u51fa\u6765\uff0c\u63d0\u9ad8\u5f00\u53d1\u6548\u7387\u3002","title":"1-1 \u51cf\u5c11\u53d1\u7248\u6b21\u6570"},{"location":"chap1/7chap1_config_center/#1-2","text":"\u5982\u679c\u901a\u8fc7\u4ee3\u7801\u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\u7ef4\u62a4\u914d\u7f6e\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u3001Redis \u7b49\u4e2d\u95f4\u4ef6\u7684\u8ba4\u8bc1\u4fe1\u606f\u90fd\u4f1a\u660e\u6587\u5b58\u50a8\u5728\u4ee3\u7801\u4e2d\uff0c\u8fd9\u6837\u7684\u5b89\u5168\u6027\u5c31\u4f1a\u6bd4\u8f83\u4f4e\u3002 \u800c\u901a\u8fc7\u914d\u7f6e\u4e2d\u5fc3\uff0c\u53ef\u4ee5\u5c06\u654f\u611f\u4fe1\u606f\u6536\u655b\u5230\u914d\u7f6e\u4e2d\u5fc3\u7684\u5b58\u50a8\u4e2d\uff0c\u5e76\u901a\u8fc7\u4e00\u5b9a\u7684\u52a0\u89e3\u5bc6\u7b97\u6cd5\u52a0\u5bc6\u4fdd\u62a4\u3002","title":"1-2 \u63d0\u5347\u5b89\u5168\u6027"},{"location":"chap1/7chap1_config_center/#2","text":"","title":"2\u3001\u914d\u7f6e\u4e2d\u5fc3\u7279\u6027"},{"location":"chap1/7chap1_config_center/#2-1","text":"\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\u6765\u8bf4\uff0c \u5b9e\u65f6\u611f\u77e5\u914d\u7f6e\u7684\u53d8\u5316\u662f\u6700\u57fa\u672c\u7684\u529f\u80fd\uff0c\u8fd9\u70b9\u548c\u6ce8\u518c\u4e2d\u5fc3\u7684\u9700\u6c42\u57fa\u672c\u4e00\u81f4\uff0c\u8fd9\u4e5f\u662f\u4e24\u4e2a\u7ec4\u4ef6\u7ecf\u5e38\u88ab\u6df7\u7528\u7684\u4e3b\u8981\u539f\u56e0 \u3002 \u6ce8\u518c\u4e2d\u5fc3\u5bf9\u5b9e\u65f6\u6027\u8981\u6c42\u975e\u5e38\u9ad8 \uff0c\u5728\u4fdd\u8bc1\u7a33\u5b9a\u6027\u7684\u524d\u63d0\u4e0b\u5c3d\u53ef\u80fd\u5730\u5feb\u901f\u6536\u5230\u8282\u70b9\u7684\u53d8\u66f4\uff0c\u4ee5\u4fdd\u8bc1\u8d1f\u8f7d\u5747\u8861\u5668\u6570\u636e\u6e90\u7684\u51c6\u786e\u6027\uff1b \u4f46\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\u6765\u8bf4\uff0c\u5b9e\u65f6\u6027\u8981\u6c42\u5e76\u4e0d\u662f\u90a3\u4e48\u9ad8\uff0c\u53ea\u8981\u4fdd\u8bc1\u6700\u7ec8\u4e00\u81f4\u5c31\u53ef\u4ee5\u4e86 \uff0c\u81f3\u4e8e\u65f6\u95f4\u662f 1s \u8fd8\u662f 1min\uff0c\u90fd\u53ef\u4ee5\u63a5\u53d7\u3002","title":"2-1 \u5b9e\u65f6\u611f\u77e5\u53d8\u66f4"},{"location":"chap1/7chap1_config_center/#2-2","text":"\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\uff0c\u56e0\u4e3a\u7ecf\u5e38\u8981\u5b58\u50a8\u6570\u636e\u5e93\u5bc6\u7801\u3001\u7b2c\u4e09\u65b9\u4e1a\u52a1\u5bc6\u94a5\u7b49\u4fe1\u606f\uff0c \u6240\u4ee5\u5bf9\u5b89\u5168\u6027\u8981\u6c42\u6bd4\u8f83\u9ad8 \uff0c\u5bf9\u7279\u6b8a\u7684\u5b57\u6bb5\u8981\u52a0\u5bc6\u3002 \u53e6\u5916\u914d\u7f6e\u4e2d\u5fc3\u5728\u901a\u4fe1\u4e0a\u9700\u8981\u91c7\u7528\u53cc\u5411 TLS \u8ba4\u8bc1\uff0c\u4ee5\u4fdd\u8bc1\u4f20\u8f93\u7684\u5b89\u5168\u6027 \u3002 \u76f8\u5bf9\u800c\u8a00\uff0c\u6ce8\u518c\u4e2d\u5fc3\u5bf9\u5b89\u5168\u6027\u7684\u8981\u6c42\u6bd4\u8f83\u4f4e","title":"2-2 \u5b89\u5168\u6027\u8981\u6c42\u9ad8"},{"location":"chap1/7chap1_config_center/#2-3","text":"\u6bcf\u4e00\u9879\u914d\u7f6e\u7684\u53d8\u66f4\u90fd\u8981\u6709\u53ef\u8ffd\u8e2a\u7684\u5ba1\u8ba1\u65e5\u5fd7\uff0c\u4ee5\u65b9\u4fbf\u56de\u6eaf\u95ee\u9898\u53d1\u751f\u7684\u539f\u56e0\u3002\u4e00 \u822c\u6ce8\u518c\u4e2d\u5fc3\u7684\u7ec4\u4ef6\u4e0d\u4f1a\u63d0\u4f9b\u8fd9\u6837\u7684\u529f\u80fd\uff0c\u4f46\u662f\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c \u5982\u679c\u662f\u4e3b\u52a8\u7684\u53d1\u7248\u6216\u8005\u4fee\u6539\u6743\u91cd\u7b49\u4fe1\u606f\u4e5f\u9700\u8981\u989d\u5916\u6dfb\u52a0\u53ef\u5ba1\u8ba1\u7684\u65e5\u5fd7 \u3002","title":"2-3 \u53d8\u66f4\u5ba1\u8ba1"},{"location":"chap1/7chap1_config_center/#2-4","text":"\u914d\u7f6e\u4e2d\u5fc3\u548c CD \u53d1\u5e03\u7cfb\u7edf\u4e00\u6837\uff0c\u90fd\u9700\u8981\u652f\u6301\u5b8c\u5907\u7684\u7070\u5ea6\u7cfb\u7edf\u3002\u4e00\u822c\u5728\u5b8c\u6574\u7684\u53d1\u5e03\u914d\u7f6e\u524d\uff0c\u90fd\u9700\u8981\u5148\u7070\u5ea6\u4e00\u53f0\u673a\u5668\uff0c\u7136\u540e\u67e5\u770b\u76d1\u63a7\u7cfb\u7edf\u662f\u5426\u6709\u95ee\u9898\u53d1\u751f\uff0c\u518d\u8fdb\u884c\u5168\u91cf\u53d1\u5e03\u3002","title":"2-4 \u7070\u5ea6\u53d1\u5e03"},{"location":"chap1/7chap1_config_center/#2-5","text":"\u8fd9\u70b9\u4e5f\u548c CD \u7cfb\u7edf\u4e00\u6837\uff0c\u8981\u5177\u5907\u53d8\u66f4\u56de\u6eda\u80fd\u529b\u3002\u5982\u679c\u6ca1\u6709\u56de\u6eda\u80fd\u529b\uff0c\u4e00\u65e6\u53d8\u66f4\u51fa\u9519\uff0c\u53c8\u6ca1\u6709\u624b\u52a8\u5907\u4efd\u4e0a\u4e00\u4efd\u914d\u7f6e\uff0c\u5c31\u4f1a\u5f15\u53d1\u751f\u4ea7\u4e8b\u6545\u3002 \u800c\u5177\u5907\u4e86\u4e00\u952e\u56de\u6eda\u529f\u80fd\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c \u53ef\u4ee5\u907f\u514d\u8fd9\u79cd\u95ee\u9898\u7684\u53d1\u751f\u3002","title":"2-5 \u53d8\u66f4\u56de\u6eda"},{"location":"chap1/7chap1_config_center/#2-6","text":"\u4e00\u822c\u800c\u8a00\uff0c\u901a\u8fc7\u5065\u58ee\u7684 SDK \u8bbe\u8ba1\uff0c\u90fd\u53ef\u4ee5\u505a\u5230\u914d\u7f6e\u4e2d\u5fc3\u7684\u5f31\u4f9d\u8d56\uff0c\u6bd4\u5982\u901a\u8fc7\u6587\u4ef6\u7f13\u5b58\u914d\u7f6e\uff0c\u5373\u4fbf\u914d\u7f6e\u4e2d\u5fc3\u51fa\u73b0\u6545\u969c\uff0c\u4e5f\u4e0d\u5f71\u54cd\u7a0b\u5e8f\u7684\u6b63\u5e38\u542f\u52a8\u548c\u8fd0\u884c\u3002\u4f46\u662f\u5bf9\u4e8e\u6ce8\u518c\u4e2d\u5fc3\u800c\u8a00\u5c31\u6bd4\u8f83\u56f0\u96be\u4e86\uff0c\u5373\u4fbf\u9632\u707e\u96be\u8bbe\u8ba1\u5f97\u518d\u5145\u5206\uff0c\u4e00\u65e6\u53d1\u751f\u6545\u969c\uff0c\u5bf9\u4e1a\u52a1\u4e5f\u4f1a\u6709\u6bd4\u8f83\u5927\u7684\u5f71\u54cd\u3002","title":"2-6 \u5f31\u4f9d\u8d56"},{"location":"chap1/7chap1_config_center/#2-7","text":"\u56e0\u4e3a\u914d\u7f6e\u4e2d\u5fc3\u63d0\u4f9b\u4e86\u7070\u5ea6\u53d1\u5e03\u3001\u53d8\u66f4\u56de\u6eda\u7b49\u591a\u79cd\u529f\u80fd\uff0c\u6240\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u6613\u7528\u7684\u56fe\u5f62\u754c\u9762\u662f\u5fc5\u987b\u7684\uff1b\u800c\u6ce8\u518c\u4e2d\u5fc3\u5bf9\u4e8e\u754c\u9762\u7684\u8981\u6c42\u4e00\u822c\u6ca1\u6709\u8fd9\u4e48\u9ad8\u3002","title":"2-7 \u6613\u7528\u7684\u56fe\u5f62\u754c\u9762"},{"location":"chap1/7chap1_config_center/#3","text":"","title":"3\u3001\u914d\u7f6e\u4e2d\u5fc3\u9009\u578b"},{"location":"chap1/7chap1_config_center/#3-1-etcd","text":"etcd \u7ecf\u5e38\u88ab\u63a8\u8350\u4f5c\u4e3a\u914d\u7f6e\u4e2d\u5fc3\uff0c\u4f46\u5b9e\u9645\u4e0a\u5b83\u5e76\u4e0d\u9002\u5408\u3002 \u9996\u5148\uff0cetcd \u9ed8\u8ba4\u6709 2G \u7684\u5b58\u50a8\u4e0a\u9650\uff0c\u6570\u636e\u8fbe\u5230\u4e0a\u9650\u540e\u4f1a\u65e0\u6cd5\u5199\u5165\u6570\u636e\uff1b \u53e6\u5916\uff0cetcd \u8bb0\u5f55\u4e86\u6bcf\u6761\u6570\u636e\u591a\u4e2a\u7248\u672c\u7684\u4fe1\u606f\uff0c\u4e5f\u4f1a\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\u3002 \u5b9e\u9645\u4e0a\u968f\u7740\u670d\u52a1\u6570\u91cf\u7684\u589e\u591a\uff0c\u5bf9\u4e8e\u914d\u7f6e\u4e2d\u5fc3\u8fd9\u4e2a\u573a\u666f\uff0c\u5b58\u50a8\u7684\u914d\u7f6e\u91cf\u662f\u6bd4\u8f83\u5927\u7684\u3002 etcd \u9664\u4e86\u80fd\u591f\u505a\u5230\u914d\u7f6e\u5b9e\u65f6\u53d8\u66f4\uff0c\u5e76\u6ca1\u6709\u592a\u5927\u7684\u4f18\u52bf\uff0c\u53cd\u800c\u4f1a\u8ba9\u7ef4\u62a4\u6210\u672c\u589e\u52a0\u3002","title":"3-1 etcd"},{"location":"chap1/7chap1_config_center/#3-2-apollo","text":"Apollo \u662f\u643a\u7a0b\u7814\u53d1\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c\u63d0\u4f9b\u4e86\u5305\u62ec Java\u3001.Net\u3001PHP\u3001Go \u7b49\u591a\u79cd\u8bed\u8a00\u7684 SDK\u3002\u800c\u4e14\u63d0\u4f9b\u4e86\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u914d\u7f6e\u4e2d\u5fc3\u6240\u9700\u8981\u7684\u591a\u79cd\u529f\u80fd\uff0c\u6bd4\u5982\u591a\u73af\u5883\u3001\u7070\u5ea6\u53d1\u5e03\u3001\u5b9e\u65f6\u63a8\u9001\u3001\u53d8\u66f4\u56de\u6eda\u7b49\u3002 \u76f8\u5bf9\u4e8e etcd\uff0cApollo \u662f\u66f4\u5408\u9002\u7684\u914d\u7f6e\u4e2d\u5fc3\u9009\u578b\uff0c Apollo \u7684\u540e\u7aef\u5b58\u50a8\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u76f4\u63a5\u7528 MySQL \u4f5c\u4e3a\u540e\u7aef\u5b58\u50a8\uff0c\u5bf9\u4e8e\u8fd0\u7ef4\u6765\u8bf4\uff0c\u4e5f\u66f4\u7b80\u5355\u53ef\u9760 \u3002","title":"3-2 Apollo"},{"location":"chap1/7chap1_config_center/#3-3-confd","text":"Golang \u5f00\u53d1\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c \u7279\u522b\u4ee5 Agent \u7684\u65b9\u5f0f\u90e8\u7f72\u5728\u673a\u5668\u4e0a\uff0c\u901a\u8fc7\u670d\u52a1\u8fdb\u7a0b\u76d1\u542c\u6587\u4ef6\u53d8\u5316\u4ee5\u8fbe\u5230\u66f4\u65b0\u914d\u7f6e\u7684\u76ee\u7684 \u3002 \u8fd9\u79cd\u65b9\u5f0f\u6613\u4e8e\u63a8\u5e7f\uff0c\u5982\u679c\u5728\u5fae\u670d\u52a1\u7684\u521d\u671f\u6ca1\u6709\u5f15\u5165\u914d\u7f6e\u4e2d\u5fc3\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u6b64\u79cd\u65b9\u5f0f\uff0c\u65e0\u987b\u670d\u52a1\u66f4\u65b0 SDK\uff0c\u53ea\u8981\u5728\u5bbf\u4e3b\u673a\u4e0a\u90e8\u7f72 Agent \u76d1\u542c\u6587\u4ef6\u53d8\u5316\u5c31\u53ef\u4ee5\u4e86\u3002\u53e6\u5916\u5b83\u4e5f\u5f88\u9002\u5408\u5404\u79cd\u5f00\u6e90\u7ec4\u4ef6\uff0c\u6bd4\u5982 Nginx \u7684\u52a8\u6001\u914d\u7f6e\u66f4\u65b0\uff08Ningx \u53ef\u4ee5\u901a\u8fc7 reload \u6216\u8005 kill -HUP \u7684\u65b9\u5f0f\u52a8\u6001\u66f4\u65b0\u914d\u7f6e\uff09\u3002 \u53e6\u5916 Confd \u63d0\u4f9b\u4e86\u591a\u79cd\u914d\u7f6e\u5b58\u50a8\u65b9\u6848\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u573a\u666f\u8fdb\u884c\u9009\u62e9\u3002\u4f46 Confd \u5e76\u6ca1\u6709\u63d0\u4f9b\u56fe\u5f62\u754c\u9762\uff0c\u5982\u679c\u8981\u4f7f\u7528\uff0c\u8fd8\u662f\u9700\u8981\u4e8c\u6b21\u5f00\u53d1\u7684\u3002","title":"3-3 Confd"},{"location":"chap1/7chap1_config_center/#3-4","text":"\u914d\u7f6e\u4e2d\u5fc3\u4f5c\u4e3a\u5fae\u670d\u52a1\u7684\u7ec4\u4ef6\uff0c\u5b9e\u9645\u4e0a\u9700\u6c42\u53d8\u5316\u5e76\u4e0d\u662f\u7279\u522b\u591a\uff0c\u57fa\u672c\u4e0a KV \u7684\u7b80\u5355\u5b58\u50a8\u3001\u5b9e\u65f6\u53d8\u66f4\u5c31\u53ef\u4ee5\u6ee1\u8db3\u9700\u6c42\u4e86\uff0c\u6240\u4ee5\u5efa\u8bae\u9009\u7528\u5f00\u6e90\u7684\u914d\u7f6e\u4e2d\u5fc3\u65b9\u6848\uff0c\u5982\u679c\u6709\u7279\u6b8a\u9700\u6c42\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\u5373\u53ef\u3002","title":"3-4 \u81ea\u7814"},{"location":"chap1/7chap1_config_center/#4","text":"\u914d\u7f6e\u4e2d\u5fc3\u4e2d\u7684\u5b9e\u65f6\u53d8\u66f4\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002","title":"4\u3001\u914d\u7f6e\u4e2d\u5fc3\u4e2d\u7684\u5b9e\u65f6\u53d8\u66f4"},{"location":"chap1/7chap1_config_center/#4-1-watch","text":"\u4f7f\u7528\u539f\u751f TCP \u81ea\u5b9a\u4e49\u534f\u8bae\uff0c\u6216\u8005\u76f4\u63a5\u91c7\u7528 gRPC \u534f\u8bae\uff0c\u90fd\u53ef\u4ee5\u5b9e\u73b0 watch \u7684\u529f\u80fd\u3002\u5f53\u914d\u7f6e\u6570\u636e\u53d1\u751f\u53d8\u5316\u7684\u65f6\u5019\uff0c\u4e3b\u52a8\u63a8\u9001\u6d88\u606f\u5230 SDK\u3002\u6bd4\u5982 etcd \u5c31\u662f\u91c7\u7528\u4e86 gRPC watch \u7684\u65b9\u5f0f\u3002","title":"4-1 \u957f\u8fde\u63a5 watch"},{"location":"chap1/7chap1_config_center/#4-2-http","text":"\u56e0\u4e3a HTTP \u534f\u8bae\u7684\u901a\u7528\u6027\u8f83\u597d\uff0c\u800c\u4e14\u5927\u5bb6\u5bf9 HTTP \u534f\u8bae\u4e5f\u76f8\u5bf9\u719f\u6089\uff0c\u6240\u4ee5\u5f88\u591a\u5f00\u6e90\u7ec4\u4ef6\u5728\u5b9e\u73b0\u63a8\u9001\u529f\u80fd\u7684\u65f6\u5019\uff0c \u90fd\u4f1a\u9009\u62e9\u957f\u8f6e\u8be2\uff0c\u4e5f\u5c31\u662f Long Polling\u3002\u50cf Apollo\u3001Consul \u90fd\u91c7\u7528\u4e86\u957f\u8f6e\u8be2\u7684\u65b9\u6848\u6765\u5b9e\u73b0\u63a8\u9001\u529f\u80fd \u3002 \u957f\u8f6e\u8be2\u7684\u5b9e\u73b0\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c \u5ba2\u6237\u7aef\u901a\u8fc7 KeepAlive \u7684\u65b9\u5f0f\u8fde\u63a5\u670d\u52a1\u5668\u7aef\uff0c\u670d\u52a1\u7aef\u963b\u585e\u8fde\u63a5\u76f4\u5230\u6709\u53d8\u5316\u6216\u8005\u8d85\u65f6(\u9ed8\u8ba4\u4e00\u822c 60s)\u624d\u8fd4\u56de\u6570\u636e \uff0c\u901a\u8fc7\u6b64\u79cd\u65b9\u5f0f\u5b9e\u73b0\u7c7b\u4f3c\u957f\u8fde\u63a5\u7684 watch \u65b9\u5f0f\u3002","title":"4-2 HTTP \u957f\u8f6e\u8be2"},{"location":"chap1/7chap1_config_center/#4-3","text":"\u5b9a\u65f6\u540c\u6b65\u7684\u65b9\u5f0f\u5219\u66f4\u52a0\u7b80\u5355\uff0c\u901a\u8fc7 HTTP \u65b9\u5f0f\u5b9a\u65f6\u8bf7\u6c42\u540e\u7aef\u63a5\u53e3\uff0c\u5bf9\u6bd4\u4e24\u6b21\u6570\u636e\u662f\u5426\u4ea7\u751f\u53d8\u5316\uff0c\u5982\u679c\u4ea7\u751f\u53d8\u5316\u5219\u66f4\u65b0\u914d\u7f6e\u3002","title":"4-3 \u5b9a\u65f6\u540c\u6b65"},{"location":"chap1/7chap1_config_center/#4-4-watch","text":"\u4e3a\u4e86\u9632\u6b62 watch \u6570\u636e\u56e0\u4e3a\u5f02\u5e38\u6f0f\u6389\u4e86\u63a8\u9001\u7684\u6570\u636e\u53d8\u5316\uff0c\u901a\u5e38\u4f1a\u91c7\u7528\u63a8\u62c9\u7ed3\u5408\u7684\u65b9\u5f0f\uff0c\u4e5f\u662fwatch+\u5b9a\u65f6\u8f6e\u8be2\u7684\u65b9\u5f0f\u3002\u5b9e\u73b0\u65b9\u5f0f\u5176\u5b9e\u5c31\u662f\u4e0a\u9762\u8bb2\u5230\u7684\u957f\u8fde\u63a5 watch \u548c\u5b9a\u65f6\u540c\u6b65\u76f8\u7ed3\u5408\u3002","title":"4-4 watch+\u5b9a\u65f6\u8f6e\u8be2"},{"location":"chap1/7chap1_config_center/#5service-mesh","text":"\u5fae\u670d\u52a1\u67b6\u6784\u7684\u53d1\u5c55\uff0c\u5bf9\u914d\u7f6e\u4e2d\u5fc3\u63d0\u51fa\u4e86\u66f4\u9ad8\u7684\u8981\u6c42\uff0c\u9664\u4e86\u4f20\u7edf\u7684\u63d0\u4f9b\u670d\u52a1\u914d\u7f6e\u7684\u4fee\u6539\uff0c\u4e5f\u5e0c\u671b\u914d\u7f6e\u4e2d\u5fc3\u80fd\u591f\u63d0\u4f9b Service Mesh \u4e2d\u63a7\u5236\u9762\u7684\u6570\u636e\u7ba1\u7406\u529f\u80fd","title":"5\u3001Service Mesh \u65f6\u4ee3\u7684\u914d\u7f6e\u4e2d\u5fc3"},{"location":"chap1/7chap1_config_center/#5-1","text":"\u5bf9\u4e8e\u4f20\u7edf\u7684\u914d\u7f6e\u4e2d\u5fc3\u6765\u8bf4\uff0c\u8fd8\u662f\u6bcf\u4e2a\u670d\u52a1\u7ba1\u63a7\u81ea\u5df1\u7684\u914d\u7f6e\uff0c\u8fd9\u4e9b\u914d\u7f6e\u6587\u4ef6\u7684\u5b9a\u4e49\u53ef\u80fd\u5343\u5947\u767e\u602a\uff0c\u6bd4\u5982 a \u670d\u52a1\u7684\u9650\u6d41\u914d\u7f6e\u53ef\u80fd\u53eb\u4f5c Limit\uff0cb \u670d\u52a1\u53eb\u4f5c RateLimit\uff0c\u8fd9\u4e9b\u914d\u7f6e\u5747\u7531\u6bcf\u4e2a\u670d\u52a1\u72ec\u81ea\u8d1f\u8d23\uff0c\u5e76\u4e0d\u5173\u5fc3\u5176\u4ed6\u670d\u52a1\u3002\u4f46\u662f\u5bf9\u4e8e\u670d\u52a1\u6cbb\u7406\u6765\u8bf4\uff0c\u5f88\u591a\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u96c6\u4e2d\u7ba1\u63a7\u8fd9\u4e9b\u6570\u636e\uff0c\u6240\u4ee5\u8981\u628a\u7cfb\u7edf\u5c42\u9762\u7684\u914d\u7f6e\u62bd\u8c61\u51fa\u6765\uff0c\u5f62\u6210\u7edf\u4e00\u7684\u6570\u636e\u7ed3\u6784\u63d0\u4f9b\u63a7\u5236\u9762\u4f7f\u7528\u3002 \u914d\u7f6e\u4e2d\u5fc3\u4e0d\u4ec5\u9700\u8981\u611f\u77e5\u81ea\u8eab\u914d\u7f6e\u7684\u53d8\u5316\uff0c\u4e5f\u9700\u8981\u611f\u77e5\u88ab\u8c03\u670d\u52a1\u7684\u53d8\u5316\u3002","title":"5-1 \u670d\u52a1\u6cbb\u7406\u96c6\u4e2d\u914d\u7f6e"},{"location":"chap1/7chap1_config_center/#5-2","text":"\u968f\u7740\u670d\u52a1\u6570\u91cf\u8d8a\u6765\u8d8a\u591a\uff0c\u670d\u52a1\u6cbb\u7406\u529f\u80fd\u88ab\u62bd\u8c61\u51fa\u6765\uff0c\u56e0\u6b64\u9700\u8981\u4e00\u4e2a\u5fae\u670d\u52a1\u6cbb\u7406\u5e73\u53f0\u7ba1\u7406\u6240\u6709\u670d\u52a1\u7684\u670d\u52a1\u6cbb\u7406\u914d\u7f6e\uff0c\u800c\u4e0d\u662f\u50cf\u4ee5\u524d\u4e00\u6837\u628a\u914d\u7f6e\u6563\u843d\u5728\u5404\u4e2a\u670d\u52a1\u4e2d\u3002 \u6709\u4e86\u8fd9\u6837\u4e00\u4e2a\u5e73\u53f0\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba9 SRE \u4ecb\u5165\u670d\u52a1\u7684\u7ef4\u62a4\u4e2d\u5fc3\uff0c\u5728\u670d\u52a1\u51fa\u73b0\u95ee\u9898\u7684\u65f6\u5019\uff0c\u901a\u8fc7\u670d\u52a1\u6cbb\u7406\u624b\u6bb5\uff0c\u6bd4\u5982\u9650\u6d41\u3001\u7194\u65ad\u3001\u964d\u7ea7\uff0cSRE \u53ef\u4ee5\u901a\u8fc7\u5e73\u53f0\u76f4\u63a5\u64cd\u4f5c\uff0c\u4ee5\u964d\u4f4e\u6545\u969c\u7684\u5f71\u54cd\u9762\u548c\u4e8b\u6545\u7b49\u7ea7\u3002","title":"5-2 \u5e73\u53f0\u5316"},{"location":"chap1/8chap1_trace/","text":"\u7b2c\u516b\u8282 Trace \u66f4\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898 1\u3001\u53ef\u89c2\u6d4b\u6027 \u63d0\u4f9b\u53ef\u89c2\u6d4b\u6027\u529f\u80fd\u7684\u7ec4\u4ef6 Trace\u3002 \u65e9\u671f\u7cfb\u7edf\u67b6\u6784\u57fa\u672c\u662f\u901a\u8fc7\u65e5\u5fd7\u7ec4\u4ef6\u6765\u89c2\u5bdf\u670d\u52a1\u7684\u5f02\u5e38\u60c5\u51b5\uff0c\u800c\u5728\u4e91\u539f\u751f\u6a21\u5f0f\u4e0b\uff0c\u94fe\u8def\u8ffd\u8e2a\u3001Metrics \u548c\u65e5\u5fd7\u4e09\u8005\u7ec4\u6210\u4e86\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u3002 \u5728\u5fae\u670d\u52a1\u548c Service Mesh \u67b6\u6784\u4e2d\uff0c\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u7684\u4f4d\u7f6e\u53d8\u5f97\u8d8a\u6765\u8d8a\u91cd\u8981\uff0c\u4e00\u822c\u4f5c\u4e3a\u9ed8\u8ba4\u7ec4\u4ef6\u96c6\u6210\u5728\u65b9\u6848\u4e2d\u3002 \u53ef\u89c2\u6d4b\u6027\u662f\u901a\u8fc7\u7cfb\u7edf\u8f93\u51fa\u4fe1\u606f\u5230\u5916\u90e8\uff0c\u4ee5\u68c0\u6d4b\u7cfb\u7edf\u5185\u90e8\u7684\u8fd0\u884c\u72b6\u6001\u3002\u6bd4\u5982\u6211\u4eec\u8fd9\u4e00\u8bb2\u4e2d\u7684Trace\uff0c\u901a\u8fc7\u5185\u90e8\u6253\u70b9\u7684\u65b9\u5f0f\u4e32\u8054\u8d77\u5fae\u670d\u52a1\u7684\u5404\u4e2a\u7ec4\u4ef6\u3002Metrics\uff0c\u901a\u8fc7\u8f93\u51fa\u670d\u52a1\u7684 Metrics \u4fe1\u606f\uff0c\u8fbe\u5230\u5916\u90e8\u76d1\u6d4b\u7684\u76ee\u7684\u3002 \u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u4e3b\u8981\u6709\u5982\u4e0b\u4e09\u79cd\uff1a \u94fe\u8def\u8ffd\u8e2a\u3001\u76d1\u63a7\u6307\u6807\u3001\u65e5\u5fd7 \u3002 \u94fe\u8def\u8ffd\u8e2a \uff1a\u901a\u8fc7\u5728\u7a0b\u5e8f\u5185\u6253\u70b9\u8bb0\u5f55\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u8bb0\u5f55\u6bcf\u6b21\u8bf7\u6c42\u7684\u8c03\u7528\u94fe\u8def\u4fe1\u606f\u3002\u7279\u70b9\u662f \u6570\u636e\u7cbe\u51c6\u3001\u7ec6\u81f4\uff0c\u9002\u5408\u67e5\u770b\u67d0\u4e00\u6b21\u8bf7\u6c42\u7684\u8c03\u7528\u94fe\u8def\uff0c\u4e00\u822c\u7528\u4e8e\u67e5\u770b\u67d0\u4e9b\u54cd\u5e94\u8f83\u6162\u7684\u63a5\u53e3\u74f6\u9888 \u3002 \u76d1\u63a7\u6307\u6807 \uff1a\u4e3b\u8981\u662f\u7528\u65f6\u5e8f\u6027\u6570\u636e\u5e93\u8bb0\u5f55\u6bcf\u4e2a\u65f6\u95f4\u70b9\u7684\u76d1\u63a7\u6570\u636e\uff0c \u4e00\u822c\u901a\u8fc7\u4e3b\u52a8\u62c9\u53d6\u670d\u52a1 Metrics \u6570\u636e\u7684\u65b9\u5f0f\u8bb0\u5f55\uff0c\u7136\u540e\u5b9e\u65f6\u8ba1\u7b97\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e \uff0c\u5e76\u901a\u8fc7\u56fe\u5f62\u754c\u9762\u7684\u65b9\u5f0f\u5c55\u73b0\u51fa\u6765\u3002\u5b83\u7684 \u7279\u70b9\u662f\u5b9e\u65f6\u6027\u5f3a\u3001\u53ef\u89c2\u6d4b\u6307\u6807\u4e30\u5bcc\uff0c\u9002\u5408\u67e5\u770b\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6307\u6807\u8d8b\u52bf\u3002 \u65e5\u5fd7 \uff1a\u65e5\u5fd7\u662f\u6bd4\u8f83\u4f20\u7edf\u7684\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u4e86\u3002 \u65e5\u5fd7\u7684\u7279\u70b9\u662f\u6570\u636e\u6bd4\u8f83\u79bb\u6563\uff0c\u4e4b\u95f4\u6ca1\u6709\u5173\u8054\u3002\u5f53\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u65e5\u5fd7\u4e2d\u6253\u5370 TraceId \u548c\u94fe\u8def\u8ffd\u8e2a\u5173\u8054\u8d77\u6765\u3002\u4e00\u822c\u65e5\u5fd7\u8981\u901a\u8fc7\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\u4f7f\u7528\uff0c\u6bd4\u5982\u5e38\u89c1\u7684 ELK \u65e5\u5fd7\u7cfb\u7edf\u3002 2\u3001\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u7684\u91cd\u8981\u6027 \u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u968f\u7740\u670d\u52a1\u548c\u4e2d\u95f4\u4ef6\u6570\u91cf\u53d8\u591a\uff0c\u5f80\u5f80\u4e00\u4e2a\u63a5\u53e3\u8981\u8bf7\u6c42\u51e0\u5341\u6b21\u670d\u52a1\u548c\u4e0a\u767e\u6b21 DB \u624d\u80fd\u8fd4\u56de\u6570\u636e\uff0c\u94fe\u8def\u8fc7\u957f\uff0c\u5f88\u96be\u5b9a\u4f4d\u5230\u5e95\u662f\u54ea\u4e2a\u73af\u8282\u51fa\u4e86\u95ee\u9898\uff1b \u53c8\u6216\u8005\u67d0\u4e2a\u63a5\u53e3\u5ef6\u65f6\u8fc7\u9ad8\uff0c\u4e5f\u5f88\u96be\u6392\u67e5\u5230\u5e95\u662f\u94fe\u8def\u4e2d\u7684\u54ea\u4e2a\u73af\u8282\u51fa\u4e86\u95ee\u9898\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u5e2e\u5fd9\u4e86\u3002 3\u3001Trace \u94fe\u8def\u8ffd\u8e2a\u539f\u7406 \u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u57fa\u672c\u6e90\u4e8e Google \u7684\u4e00\u7bc7 Dapper \u8bba\u6587\uff0c\u8fd9\u7bc7\u8bba\u6587\u8be6\u7ec6\u89e3\u91ca\u4e86\u94fe\u8def\u8ffd\u8e2a\u7684\u5b9e\u73b0\u539f\u7406\u3002 Dapper \u901a\u8fc7\u4e00\u4e2a\u5168\u5c40\u552f\u4e00\u7684 TraceId \u8868\u793a\u8bf7\u6c42\u8c03\u7528\u94fe\uff0c\u5e76\u5b9a\u4e49\u4e86 span\uff0c span \u8868\u793a\u4e00\u6b21\u8c03\u7528\uff08\u53ef\u4ee5\u662f\u8fdc\u7a0b\u8c03\u7528\uff0c\u4e5f\u53ef\u4ee5\u7a0b\u5e8f\u5185\u7684\u51fd\u6570\u8c03\u7528\uff09 \u3002 \u6bcf\u4e2a span \u5305\u542b\u4e86\u4e24\u4e2a\u91cd\u8981\u4fe1\u606f\uff0c \u4e00\u4e2a\u662f\u5f53\u524d SpanId\uff0c\u53e6\u5916\u4e00\u4e2a\u5c31\u662f ParentSpanId \u3002 3-1 Trace \u6240\u9700\u7684\u4fe1\u606f\u4f20\u9012\u7ed9\u88ab\u8c03\u65b9\u670d\u52a1 \u901a\u8fc7 HTTP \u7684 header \u5934\u4f20\u9012\u4e0b\u53bb\uff0c\u5f53\u7136\u5982\u679c\u662f\u5176\u4ed6\u534f\u8bae\uff0c\u6bd4\u5982 Dubbo\uff0c\u5c31\u8981\u60f3\u5176\u4ed6\u529e\u6cd5\u4e86\u3002\u4f46 gRPC \u548c HTTP \u76f8\u5bf9\u7b80\u5355\uff0c\u53ea\u8981\u901a\u8fc7 header \u4f20\u9012\u5c31\u53ef\u4ee5\u4e86\u3002 \u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b\u8fd9\u4e9b header \u503c\u7684\u542b\u4e49\u3002 X-Request-ID \uff1a \u8bf7\u6c42 ID \uff0c\u4e00\u822c Sidecar \u4f1a\u5728\u5165\u53e3\u5c42\u751f\u6210\u7edf\u4e00\u7684\u8bf7\u6c42 ID\uff0c\u7528\u4e8e\u4e00\u6b21\u8bf7\u6c42\u5728\u5185\u90e8\u670d\u52a1\u4e4b\u95f4\u4f20\u9012\uff0c\u65b9\u4fbf\u901a\u8fc7\u8bf7\u6c42 ID \u67e5\u8be2\u4e00\u6b21\u8bf7\u6c42\u7684\u6240\u6709\u65e5\u5fd7\u3002 X-B3-TraceId \uff1a \u94fe\u8def\u8ffd\u8e2a\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u957f\u5ea6\u4e3a 64 \u4f4d \u3002\u7531\u7f51\u5173\u5c42\u751f\u6210\uff0c\u4e00\u6b21\u5916\u90e8\u8bf7\u6c42\u4f7f\u7528\u552f\u4e00\u7684 TraceId \u3002 X-B3-SpanId \uff1a SpanId \u7684\u957f\u5ea6\u662f 64 \u4f4d\uff0c\u8868\u793a\u5f53\u524d\u64cd\u4f5c\u5728\u8ddf\u8e2a\u6811\u4e2d\u7684\u4f4d\u7f6e \u3002 X-B3-ParentSpanId \uff1a \u7236 SpanId \uff0c\u5982\u679c\u8be5\u503c\u4e0d\u5b58\u5728\uff0c\u8868\u793a\u662f\u6839\u8282\u70b9\u3002 X-B3-Sampled \uff1a \u91c7\u6837\u7387\uff0c\u5f53\u8bbe\u7f6e\u4e3a 1 \u65f6\uff0c\u8868\u793a\u91c7\u6837 \u3002 \u4e00\u4e2a Trace \u7684\u771f\u5b9e\u6570\u636e {\"duration\":2065,\"operationName\":\"/ping\",\"parentSpanID\":\"0\",\"process.serviceName\":\"negri.sidecarserverlistener.myapp\",\"process.tags.hostname\":\"MacBook-Pro-3.local\",\"process.tags.ip\":\"192.168.1.88\",\"spanID\":\"5f1db306ef459b2f\",\"startTime\":1609241265147010,\"tags.http.method\":\"GET\",\"tags.http.status_code\":\"200\",\"tags.http.url\":\"/ping\",\"tags.peer.address\":\"http://127.0.0.1:8888\",\"tags.span.kind\":\"server\",\"traceID\":\"5f1db306ef459b2f\"} \u63a5\u53e3\u7684\u8fd0\u884c\u65f6\u95f4 duration\uff0c\u8bb0\u5f55\u4e86\u670d\u52a1\u540d\u3001TraceId\u3001SpanId\u3001ParentSpanId \u7b49\u4e0a\u9762\u6211\u4eec\u804a\u5230\u7684\u5e38\u7528\u6570\u636e\uff0c\u53e6\u5916\u8fd8\u8bb0\u5f55\u4e86\u6211\u4eec\u6240\u9700\u8981\u7684\u4e00\u4e9b\u81ea\u5b9a\u4e49\u6570\u636e\uff0c\u653e\u5728\u4e86 Tags \u5b57\u6bb5\u4e2d\u3002 \u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u901a\u8fc7\u6536\u96c6\u7a0b\u5e8f\u4e2d\u7684\u6253\u70b9\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u901a\u5e38\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u529f\u80fd\u3002 \u6392\u67e5\u6839\u56e0 \uff1a\u5206\u6790\u5355\u6b21\u8bf7\u6c42\u7684\u8c03\u7528\u94fe\u8def\uff0c\u6392\u67e5\u95ee\u9898\u6839\u56e0\u3002 \u8c03\u7528\u5173\u7cfb\u56fe \uff1a\u901a\u8fc7 Trace \u4e2d\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u7ed8\u5236\u670d\u52a1\u8c03\u7528\u5173\u7cfb\u56fe\u3002 \u65e5\u5fd7\u8ffd\u8e2a \uff1a\u901a\u8fc7\u5173\u8054\u65e5\u5fd7 RequestId\uff0c\u53ef\u4ee5\u94fe\u63a5\u5230\u65e5\u5fd7\u7cfb\u7edf\uff0c\u67e5\u770b\u66f4\u8be6\u7ec6\u7684\u65e5\u5fd7\u4fe1\u606f\u3002 4\u3001\u5e38\u89c1\u7684\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf 4-1 Zipkin Zipkin\u662f Twitter \u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u5c5e\u4e8e\u6bd4\u8f83\u65e9\u7684 Trace \u7cfb\u7edf\uff0c\u5bf9 PHP\u3001Golang\u3001Java \u90fd\u6709\u4e0d\u9519\u7684\u652f\u6301\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u5957 Web \u56fe\u5f62\u5316\u754c\u9762\uff0c\u4f9b\u7528\u6237\u67e5\u770b\u5355\u6761\u94fe\u8def\u4fe1\u606f\uff0c\u4e5f\u63d0\u4f9b\u4e86\u67e5\u770b\u8c03\u7528\u5173\u7cfb\u56fe\u7684\u529f\u80fd\u3002 4-2 Jaeger Jaeger \u662f Uber \u516c\u53f8\u5f00\u6e90\u7684\u3001\u91c7\u7528 Go \u8bed\u8a00\u5f00\u53d1\u7684\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u7531\u4ee5\u4e0b\u51e0\u4e2a\u6a21\u5757\u7ec4\u6210\u3002 jaeger-client\uff1aJaeger \u63d0\u4f9b\u7684\u7b26\u5408 OpenTracing \u6807\u51c6\u7684\u5404\u79cd\u8bed\u8a00\u7684 SDK\uff0c\u5305\u62ec Java\u3001Go\u3001Node.js \u7b49\u3002Client \u8d1f\u8d23\u6536\u96c6 Trace \u6570\u636e\u53d1\u9001\u5230 Agent\u3002 jaeger-agent\uff1ajaeger-client \u7684\u4ee3\u7406\u7a0b\u5e8f\uff0c\u90e8\u7f72\u5728\u6240\u6709\u5bbf\u4e3b\u673a\u4e0a\uff0c\u8fd9\u6837\u7684\u76ee\u7684\u548c Sidecar \u7c7b\u4f3c\uff0c\u5c4f\u853d\u4e86\u4e00\u4e9b\u8def\u7531\u548c Collector \u8282\u70b9\u53d1\u73b0\u7684\u7ec6\u8282\uff0c\u8ba9 Client \u66f4\u52a0\u8f7b\u91cf\u5316\u3002Client \u901a\u8fc7 UDP \u534f\u8bae\u548c Agent \u901a\u4fe1\uff0c\u4e5f\u907f\u514d\u4e86\u65e5\u5fd7\u843d\u76d8\u518d\u91c7\u96c6\u5bfc\u81f4\u7684\u4e00\u4e9b\u6027\u80fd\u95ee\u9898\u3002 jaeger-collector\uff1a\u8d1f\u8d23\u6536\u96c6 Agent \u4e0a\u62a5\u7684\u94fe\u8def\u8ffd\u8e2a\u6570\u636e\uff0c\u5e76\u505a\u4e00\u4e9b\u6570\u636e\u9a8c\u8bc1\u5de5\u4f5c\uff0c\u4ee5\u53ca\u5bf9\u6570\u636e\u505a\u4e00\u4e9b\u5904\u7406\u7136\u540e\u4e0a\u62a5\u5230\u5b58\u50a8\u7cfb\u7edf \u3002 jaeger-db\uff1a\u540e\u7aef\u5b58\u50a8\u7cfb\u7edf\uff0c\u652f\u6301 Cassandra \u548c ElasticSearch\u3002 jaeger-query\uff1a\u4e13\u95e8\u8d1f\u8d23\u8c03\u7528\u94fe\u67e5\u8be2\u7684\u4e00\u4e2a\u670d\u52a1\uff0c\u63d0\u4f9b\u4e00\u5957\u72ec\u7acb\u7684 UI \u754c\u9762\uff0c\u7528\u4e8e\u7ed8\u5236\u8c03\u7528\u5173\u7cfb\u548c\u5c55\u793a\u670d\u52a1\u94fe\u8def \u3002 spark-job\uff1a\u57fa\u4e8e Spark \u7684\u8fd0\u7b97\u4efb\u52a1\uff0c\u53ef\u4ee5\u8ba1\u7b97\u670d\u52a1\u7684\u4f9d\u8d56\u5173\u7cfb\u3001\u8c03\u7528\u6b21\u6570\u7b49\u3002 5\u3001Trace \u7cfb\u7edf\u4e2d\u7684\u5e38\u89c1\u95ee\u9898 5-1 TraceId \u5982\u4f55\u8bbe\u8ba1 TraceId \u53ea\u8981\u5168\u5c40\u552f\u4e00\u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u53c2\u8003 SOFATrace \u4e2d\u7684\u8bbe\u8ba1\uff0c\u901a\u8fc7 8 \u4f4d\u7684 IP \u5730\u5740\u548c 13 \u4f4d\u7684\u65f6\u95f4\u6233\uff0c\u4ee5\u53ca\u56db\u4f4d\u7684\u81ea\u589e\u5e8f\u5217\uff0c\u52a0\u4e0a\u672c\u8eab\u8fdb\u7a0b\u7684 PID \u53f7\uff0c\u8fd9\u6837\u7ec4\u6210\u7684\u5b57\u7b26\u4e32\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u5168\u5c40\u552f\u4e00\u4e86\u3002 5-2 Trace \u65e5\u5fd7\u843d\u76d8 \u963f\u91cc\u4e91\u63d0\u4f9b\u7684 sls \u4f5c\u4e3a\u94fe\u8def\u8ffd\u8e2a\u7684\u5b58\u50a8\u7cfb\u7edf \u7528 SDK \u5c06\u6570\u636e\u76f4\u63a5\u843d\u76d8\uff0c\u4ee5\u65e5\u5fd7\u7684\u65b9\u5f0f\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\uff0c\u7136\u540e\u7531 Logtail \u5c06\u65e5\u5fd7\u6536\u96c6\u5230 sls\uff0c\u4f46\u662f\u8fd9\u6837\u5c31\u4ea7\u751f\u4e86\u65e5\u5fd7\u5199\u76d8\u7684\u6027\u80fd\u95ee\u9898\u3002 \u5982\u679c\u6bcf\u6761\u65e5\u5fd7\u90fd\u76f4\u63a5\u843d\u76d8\uff0c\u90a3\u4e48\u7cfb\u7edf\u7684 IO \u6d88\u8017\u4f1a\u975e\u5e38\u5927\uff0c\u6240\u4ee5\u5b9e\u8df5\u4e2d\u6211\u91c7\u7528\u4e86 \u5f02\u6b65\u843d\u76d8 \u7684\u673a\u5236\uff0c\u51cf\u5c11\u5bf9\u4e1a\u52a1\u8bf7\u6c42\u7684\u5f71\u54cd\uff0c\u4e5f\u540c\u65f6\u51cf\u5c11\u4e86\u7cfb\u7edf\u8c03\u7528\u548c\u7cfb\u7edf IO \u7684\u6d88\u8017\u3002 5-3 Service Mesh \u4e2d\u53ef\u4ee5\u65e0\u611f\u77e5\u63a5\u5165 Trace \u5417\uff1f \u5b9e\u9645\u4e0a\u56e0\u4e3a Service Mesh \u7ecf\u5e38\u5ba3\u4f20\u65e0\u4fb5\u5165\u7684\u63a5\u5165\u65b9\u5f0f\uff0c\u8fd9\u5757\u9020\u6210\u4e86\u4e00\u5b9a\u7684\u8bef\u89e3\uff0c\u65e9\u671f Istio \u6587\u6863\u63cf\u8ff0\u5f97\u4e5f\u4e0d\u662f\u5f88\u6e05\u695a\uff0c\u4f46\u540e\u9762\u7684 Istio \u6587\u6863\u505a\u4e86\u66f4\u6b63\uff0c \u5728 Service Mesh \u4e2d\u53ea\u8981\u5c11\u91cf\u4ee3\u7801\u5c31\u53ef\u4ee5\u63a5\u5165 Trace \u4e86 \u3002 Sidecar \u4f9d\u7136\u4f9d\u8d56\u5e94\u7528\u7a0b\u5e8f\u4f20\u9012 Trace \u6240\u9700\u8981\u7684 header\uff0c\u4f46\u901a\u8fc7 Sidecar \u53ef\u4ee5\u7b80\u5316 Trace \u7684\u63a5\u5165\uff0cTrace SDK \u53ea\u8981\u4fdd\u8bc1\u80fd\u591f\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684 Trace header \u5728\u6bcf\u6b21\u8bf7\u6c42\u4e2d\u4f20\u9012\u4e0b\u53bb\u5c31\u53ef\u4ee5\u4e86\uff0c\u800c\u4e0d\u7528\u8d1f\u8d23\u7e41\u91cd\u7684\u6570\u636e\u4e0a\u62a5\u5de5\u4f5c\u3002\u4f46\u5982\u679c\u9664\u4e86\u670d\u52a1\u7684\u94fe\u8def\u4fe1\u606f\uff0c\u8fd8\u5e0c\u671b\u6536\u96c6\u4e00\u4e9b DB \u4e2d\u95f4\u4ef6\u7684\u8c03\u7528\u4fe1\u606f\uff0c\u6570\u636e\u4e0a\u62a5\u7684\u5de5\u4f5c\u8fd8\u662f\u65e0\u6cd5\u907f\u514d\u7684\u3002 5-4 Trace \u7ec4\u4ef6\u5982\u4f55\u5728\u9879\u76ee\u4e2d\u843d\u5730\uff1f \u5bf9\u4e00\u4e9b\u8bed\u8a00\u6765\u8bf4\uff0c\u4fb5\u5165\u6027\u6bd4\u8f83\u5f3a\u662f\u6700\u5927\u7684\u75db\u70b9\u3002\u5bf9\u4e8e Java \u76f8\u5bf9\u6765\u8bf4\u6bd4\u8f83\u5bb9\u6613\uff0c\u53ef\u4ee5\u901a\u8fc7 Java Agent \u65e0\u611f\u77e5\u5730\u63a5\u5165\uff0c\u4f46\u5bf9\u4e8e\u5176\u4ed6\u8bed\u8a00\u5c31\u6ca1\u90a3\u4e48\u5bb9\u6613\u4e86\u3002 \u6bd4\u5982 PHP\u3001Go\u3001Node.js \u7b49\u8bed\u8a00\uff0c\u90fd\u9700\u8981\u901a\u8fc7 SDK \u7684\u65b9\u5f0f\u63a5\u5165\u3002\u5982\u679c\u662f \u5728\u5fae\u670d\u52a1\u62c6\u5206\u7684\u4e2d\u540e\u671f\uff0c\u60f3\u8981\u518d\u589e\u52a0 Trace \u7cfb\u7edf\u5c31\u5341\u5206\u56f0\u96be\u4e86\uff0c\u6240\u4ee5\u8fd9\u91cc\u5efa\u8bae\u5728\u51b3\u5b9a\u4f7f\u7528\u5fae\u670d\u52a1\u67b6\u6784\u7684\u521d\u671f\uff0c\u5728\u6846\u67b6\u5185\u96c6\u6210 Trace SDK\uff0c\u5e76\u9ed8\u8ba4\u5f00\u542f\uff0c\u514d\u53bb\u540e\u7eed\u7684\u9ebb\u70e6 \u3002 5-5 \u91c7\u6837\u7387\u5982\u4f55\u8bbe\u7f6e\uff1f \u5728 Jaeger \u4e2d\u63d0\u4f9b\u4e86\u52a8\u6001\u91c7\u6837\u7387\u7684\u529f\u80fd \uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u540c\u4e00\u4e2a\u670d\u52a1\u4e2d\uff0c\u4f4e QPS \u7684\u63a5\u53e3\u53ef\u4ee5\u88ab\u6709\u6548\u91c7\u96c6\uff0c\u800c\u9ad8 QPS \u7684\u63a5\u53e3\u6709\u8f83\u4f4e\u7684\u91c7\u6837\u7387\u3002 5-6 Trace \u94fe\u8def\u7684\u8fde\u7eed\u6027 \u7f51\u5173\u4e2d\u751f\u6210\u521d\u59cb\u7684 TraceId \u548c\u6700\u4e0a\u5c42\u7684 SpanId\uff0c\u540e\u7eed\u7684\u670d\u52a1\u53ea\u8981\u62ff\u5230 downstream \u96c6\u7fa4\uff0c\u901a\u8fc7 header \u4f20\u9012\u4e0b\u6765\u7684 Trace \u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u7ee7\u7eed\u751f\u6210\u672c\u670d\u52a1\u7684 Trace \u6570\u636e\u4e86 \u50cf Jaeger \u4e4b\u7c7b\u7684\u7ec4\u4ef6\uff0c\u5728\u6ca1\u6709\u62ff\u5230 Trace \u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u9ed8\u8ba4\u751f\u6210\u65b0\u7684 TraceId \u3002 \u5b9e\u9645\u4e0a\uff0c\u6211\u5e76\u4e0d\u5efa\u8bae\u8fd9\u6837\u7684\u505a\u6cd5\uff0c\u4e00\u662f\u589e\u52a0\u4e86 SDK \u7684\u590d\u6742\u5ea6\uff0c\u9020\u6210\u7ef4\u62a4\u56f0\u96be\uff1b\u4e8c\u662f\u94fe\u8def\u4e00\u65e6\u65ad\u6389\uff0c\u5bf9\u4e8e\u6392\u67e5\u95ee\u9898\u7684\u5e2e\u52a9\u5c31\u4e0d\u662f\u5f88\u5927\u4e86\u3002 6\u3001\u5173\u4e8e\u94fe\u8def\u8ffd\u8e2a\u7684\u4e00\u4e9b\u601d\u8003 6-1 \u5ba2\u6237\u7aef\u94fe\u8def\u8ffd\u8e2a \u94fe\u8def\u8ffd\u8e2a\uff0c\u4e3b\u8981\u8fd8\u662f\u7528\u4e8e\u5185\u90e8\u670d\u52a1\uff0c\u4ee5\u5c55\u793a\u5fae\u670d\u52a1\u7684\u8c03\u7528\u5173\u7cfb\u548c\u6392\u67e5\u5fae\u670d\u52a1\u5bfc\u81f4\u7684\u94fe\u8def\u590d\u6742\u6027\u95ee\u9898\u3002 \u4f46\u5b9e\u9645\u4e0a\u53ef\u4ee5\u8003\u8651\u5728\u5ba2\u6237\u7aef\u5c31\u751f\u6210 client-traceid\uff0c\u7136\u540e\u5c06 client-traceid \u548c\u5185\u90e8 TraceId \u5173\u8054\u8d77\u6765\uff0c\u8fd9\u6837\u5c31\u80fd\u591f\u5c55\u793a\u6574\u4e2a\u94fe\u8def\u8ffd\u8e2a\u4e2d\u5ba2\u6237\u7aef\u8017\u65f6\u5360\u6bd4 \u3002 6-2 RPC SDK \u7684\u8bbe\u8ba1 \u5b9e\u9645\u4e0a Trace \u7cfb\u7edf\u9700\u8981\u5c06 Trace header \u7684\u4fe1\u606f\u4e00\u5c42\u5c42\u4f20\u9012\u4e0b\u53bb\uff0c\u6240\u4ee5 RPC \u7684 Client SDK \u9700\u8981\u5177\u5907\u201c\u5728\u8bf7\u6c42\u7684\u65f6\u5019\u5e26\u4e0a Trace \u6240\u9700\u4fe1\u606f\u201d\u7684\u80fd\u529b\u3002 \u5176\u5b9e\u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u6709\u5f88\u591a\u573a\u666f\u9700\u8981\u6211\u4eec\u5c06\u6700\u9876\u5c42\u7684\u7f51\u5173\u5c42\u7684\u6570\u636e\u4f20\u9012\u4e0b\u53bb\uff0c\u4ee5\u4fdd\u8bc1\u4e0a\u6e38\uff08upstream\uff09\u7684\u5fae\u670d\u52a1\u80fd\u591f\u83b7\u53d6\u8fd9\u4e9b\u4fe1\u606f\u3002\u6bd4\u5982\u5ba2\u6237\u7aef IP\u3001\u7070\u5ea6\u6d41\u91cf\u6807\u7b7e\u7b49\u3002\u6240\u4ee5\u5728\u5fae\u670d\u52a1 SDK \u8bbe\u8ba1\u7684\u65f6\u5019\u6700\u597d\u5b9a\u4e49\u4e00\u7ec4 header\uff0c\u65b9\u4fbf\u6211\u4eec\u89e3\u6790\u5e76\u5411\u4e0a\u6e38\u4f20\u9012\uff0c\u6bd4\u5982 X-Mesh-Xxx \u3002","title":"\u7b2c\u516b\u8282 Trace \u66f4\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898"},{"location":"chap1/8chap1_trace/#trace","text":"","title":"\u7b2c\u516b\u8282 Trace \u66f4\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898"},{"location":"chap1/8chap1_trace/#1","text":"\u63d0\u4f9b\u53ef\u89c2\u6d4b\u6027\u529f\u80fd\u7684\u7ec4\u4ef6 Trace\u3002 \u65e9\u671f\u7cfb\u7edf\u67b6\u6784\u57fa\u672c\u662f\u901a\u8fc7\u65e5\u5fd7\u7ec4\u4ef6\u6765\u89c2\u5bdf\u670d\u52a1\u7684\u5f02\u5e38\u60c5\u51b5\uff0c\u800c\u5728\u4e91\u539f\u751f\u6a21\u5f0f\u4e0b\uff0c\u94fe\u8def\u8ffd\u8e2a\u3001Metrics \u548c\u65e5\u5fd7\u4e09\u8005\u7ec4\u6210\u4e86\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u3002 \u5728\u5fae\u670d\u52a1\u548c Service Mesh \u67b6\u6784\u4e2d\uff0c\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u7684\u4f4d\u7f6e\u53d8\u5f97\u8d8a\u6765\u8d8a\u91cd\u8981\uff0c\u4e00\u822c\u4f5c\u4e3a\u9ed8\u8ba4\u7ec4\u4ef6\u96c6\u6210\u5728\u65b9\u6848\u4e2d\u3002 \u53ef\u89c2\u6d4b\u6027\u662f\u901a\u8fc7\u7cfb\u7edf\u8f93\u51fa\u4fe1\u606f\u5230\u5916\u90e8\uff0c\u4ee5\u68c0\u6d4b\u7cfb\u7edf\u5185\u90e8\u7684\u8fd0\u884c\u72b6\u6001\u3002\u6bd4\u5982\u6211\u4eec\u8fd9\u4e00\u8bb2\u4e2d\u7684Trace\uff0c\u901a\u8fc7\u5185\u90e8\u6253\u70b9\u7684\u65b9\u5f0f\u4e32\u8054\u8d77\u5fae\u670d\u52a1\u7684\u5404\u4e2a\u7ec4\u4ef6\u3002Metrics\uff0c\u901a\u8fc7\u8f93\u51fa\u670d\u52a1\u7684 Metrics \u4fe1\u606f\uff0c\u8fbe\u5230\u5916\u90e8\u76d1\u6d4b\u7684\u76ee\u7684\u3002 \u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u4e3b\u8981\u6709\u5982\u4e0b\u4e09\u79cd\uff1a \u94fe\u8def\u8ffd\u8e2a\u3001\u76d1\u63a7\u6307\u6807\u3001\u65e5\u5fd7 \u3002 \u94fe\u8def\u8ffd\u8e2a \uff1a\u901a\u8fc7\u5728\u7a0b\u5e8f\u5185\u6253\u70b9\u8bb0\u5f55\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u8bb0\u5f55\u6bcf\u6b21\u8bf7\u6c42\u7684\u8c03\u7528\u94fe\u8def\u4fe1\u606f\u3002\u7279\u70b9\u662f \u6570\u636e\u7cbe\u51c6\u3001\u7ec6\u81f4\uff0c\u9002\u5408\u67e5\u770b\u67d0\u4e00\u6b21\u8bf7\u6c42\u7684\u8c03\u7528\u94fe\u8def\uff0c\u4e00\u822c\u7528\u4e8e\u67e5\u770b\u67d0\u4e9b\u54cd\u5e94\u8f83\u6162\u7684\u63a5\u53e3\u74f6\u9888 \u3002 \u76d1\u63a7\u6307\u6807 \uff1a\u4e3b\u8981\u662f\u7528\u65f6\u5e8f\u6027\u6570\u636e\u5e93\u8bb0\u5f55\u6bcf\u4e2a\u65f6\u95f4\u70b9\u7684\u76d1\u63a7\u6570\u636e\uff0c \u4e00\u822c\u901a\u8fc7\u4e3b\u52a8\u62c9\u53d6\u670d\u52a1 Metrics \u6570\u636e\u7684\u65b9\u5f0f\u8bb0\u5f55\uff0c\u7136\u540e\u5b9e\u65f6\u8ba1\u7b97\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e \uff0c\u5e76\u901a\u8fc7\u56fe\u5f62\u754c\u9762\u7684\u65b9\u5f0f\u5c55\u73b0\u51fa\u6765\u3002\u5b83\u7684 \u7279\u70b9\u662f\u5b9e\u65f6\u6027\u5f3a\u3001\u53ef\u89c2\u6d4b\u6307\u6807\u4e30\u5bcc\uff0c\u9002\u5408\u67e5\u770b\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6307\u6807\u8d8b\u52bf\u3002 \u65e5\u5fd7 \uff1a\u65e5\u5fd7\u662f\u6bd4\u8f83\u4f20\u7edf\u7684\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u4e86\u3002 \u65e5\u5fd7\u7684\u7279\u70b9\u662f\u6570\u636e\u6bd4\u8f83\u79bb\u6563\uff0c\u4e4b\u95f4\u6ca1\u6709\u5173\u8054\u3002\u5f53\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u65e5\u5fd7\u4e2d\u6253\u5370 TraceId \u548c\u94fe\u8def\u8ffd\u8e2a\u5173\u8054\u8d77\u6765\u3002\u4e00\u822c\u65e5\u5fd7\u8981\u901a\u8fc7\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\u4f7f\u7528\uff0c\u6bd4\u5982\u5e38\u89c1\u7684 ELK \u65e5\u5fd7\u7cfb\u7edf\u3002","title":"1\u3001\u53ef\u89c2\u6d4b\u6027"},{"location":"chap1/8chap1_trace/#2","text":"\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u968f\u7740\u670d\u52a1\u548c\u4e2d\u95f4\u4ef6\u6570\u91cf\u53d8\u591a\uff0c\u5f80\u5f80\u4e00\u4e2a\u63a5\u53e3\u8981\u8bf7\u6c42\u51e0\u5341\u6b21\u670d\u52a1\u548c\u4e0a\u767e\u6b21 DB \u624d\u80fd\u8fd4\u56de\u6570\u636e\uff0c\u94fe\u8def\u8fc7\u957f\uff0c\u5f88\u96be\u5b9a\u4f4d\u5230\u5e95\u662f\u54ea\u4e2a\u73af\u8282\u51fa\u4e86\u95ee\u9898\uff1b \u53c8\u6216\u8005\u67d0\u4e2a\u63a5\u53e3\u5ef6\u65f6\u8fc7\u9ad8\uff0c\u4e5f\u5f88\u96be\u6392\u67e5\u5230\u5e95\u662f\u94fe\u8def\u4e2d\u7684\u54ea\u4e2a\u73af\u8282\u51fa\u4e86\u95ee\u9898\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u5e2e\u5fd9\u4e86\u3002","title":"2\u3001\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u7684\u91cd\u8981\u6027"},{"location":"chap1/8chap1_trace/#3trace","text":"\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u57fa\u672c\u6e90\u4e8e Google \u7684\u4e00\u7bc7 Dapper \u8bba\u6587\uff0c\u8fd9\u7bc7\u8bba\u6587\u8be6\u7ec6\u89e3\u91ca\u4e86\u94fe\u8def\u8ffd\u8e2a\u7684\u5b9e\u73b0\u539f\u7406\u3002 Dapper \u901a\u8fc7\u4e00\u4e2a\u5168\u5c40\u552f\u4e00\u7684 TraceId \u8868\u793a\u8bf7\u6c42\u8c03\u7528\u94fe\uff0c\u5e76\u5b9a\u4e49\u4e86 span\uff0c span \u8868\u793a\u4e00\u6b21\u8c03\u7528\uff08\u53ef\u4ee5\u662f\u8fdc\u7a0b\u8c03\u7528\uff0c\u4e5f\u53ef\u4ee5\u7a0b\u5e8f\u5185\u7684\u51fd\u6570\u8c03\u7528\uff09 \u3002 \u6bcf\u4e2a span \u5305\u542b\u4e86\u4e24\u4e2a\u91cd\u8981\u4fe1\u606f\uff0c \u4e00\u4e2a\u662f\u5f53\u524d SpanId\uff0c\u53e6\u5916\u4e00\u4e2a\u5c31\u662f ParentSpanId \u3002","title":"3\u3001Trace \u94fe\u8def\u8ffd\u8e2a\u539f\u7406"},{"location":"chap1/8chap1_trace/#3-1-trace","text":"\u901a\u8fc7 HTTP \u7684 header \u5934\u4f20\u9012\u4e0b\u53bb\uff0c\u5f53\u7136\u5982\u679c\u662f\u5176\u4ed6\u534f\u8bae\uff0c\u6bd4\u5982 Dubbo\uff0c\u5c31\u8981\u60f3\u5176\u4ed6\u529e\u6cd5\u4e86\u3002\u4f46 gRPC \u548c HTTP \u76f8\u5bf9\u7b80\u5355\uff0c\u53ea\u8981\u901a\u8fc7 header \u4f20\u9012\u5c31\u53ef\u4ee5\u4e86\u3002 \u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b\u8fd9\u4e9b header \u503c\u7684\u542b\u4e49\u3002 X-Request-ID \uff1a \u8bf7\u6c42 ID \uff0c\u4e00\u822c Sidecar \u4f1a\u5728\u5165\u53e3\u5c42\u751f\u6210\u7edf\u4e00\u7684\u8bf7\u6c42 ID\uff0c\u7528\u4e8e\u4e00\u6b21\u8bf7\u6c42\u5728\u5185\u90e8\u670d\u52a1\u4e4b\u95f4\u4f20\u9012\uff0c\u65b9\u4fbf\u901a\u8fc7\u8bf7\u6c42 ID \u67e5\u8be2\u4e00\u6b21\u8bf7\u6c42\u7684\u6240\u6709\u65e5\u5fd7\u3002 X-B3-TraceId \uff1a \u94fe\u8def\u8ffd\u8e2a\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u957f\u5ea6\u4e3a 64 \u4f4d \u3002\u7531\u7f51\u5173\u5c42\u751f\u6210\uff0c\u4e00\u6b21\u5916\u90e8\u8bf7\u6c42\u4f7f\u7528\u552f\u4e00\u7684 TraceId \u3002 X-B3-SpanId \uff1a SpanId \u7684\u957f\u5ea6\u662f 64 \u4f4d\uff0c\u8868\u793a\u5f53\u524d\u64cd\u4f5c\u5728\u8ddf\u8e2a\u6811\u4e2d\u7684\u4f4d\u7f6e \u3002 X-B3-ParentSpanId \uff1a \u7236 SpanId \uff0c\u5982\u679c\u8be5\u503c\u4e0d\u5b58\u5728\uff0c\u8868\u793a\u662f\u6839\u8282\u70b9\u3002 X-B3-Sampled \uff1a \u91c7\u6837\u7387\uff0c\u5f53\u8bbe\u7f6e\u4e3a 1 \u65f6\uff0c\u8868\u793a\u91c7\u6837 \u3002 \u4e00\u4e2a Trace \u7684\u771f\u5b9e\u6570\u636e {\"duration\":2065,\"operationName\":\"/ping\",\"parentSpanID\":\"0\",\"process.serviceName\":\"negri.sidecarserverlistener.myapp\",\"process.tags.hostname\":\"MacBook-Pro-3.local\",\"process.tags.ip\":\"192.168.1.88\",\"spanID\":\"5f1db306ef459b2f\",\"startTime\":1609241265147010,\"tags.http.method\":\"GET\",\"tags.http.status_code\":\"200\",\"tags.http.url\":\"/ping\",\"tags.peer.address\":\"http://127.0.0.1:8888\",\"tags.span.kind\":\"server\",\"traceID\":\"5f1db306ef459b2f\"} \u63a5\u53e3\u7684\u8fd0\u884c\u65f6\u95f4 duration\uff0c\u8bb0\u5f55\u4e86\u670d\u52a1\u540d\u3001TraceId\u3001SpanId\u3001ParentSpanId \u7b49\u4e0a\u9762\u6211\u4eec\u804a\u5230\u7684\u5e38\u7528\u6570\u636e\uff0c\u53e6\u5916\u8fd8\u8bb0\u5f55\u4e86\u6211\u4eec\u6240\u9700\u8981\u7684\u4e00\u4e9b\u81ea\u5b9a\u4e49\u6570\u636e\uff0c\u653e\u5728\u4e86 Tags \u5b57\u6bb5\u4e2d\u3002 \u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u901a\u8fc7\u6536\u96c6\u7a0b\u5e8f\u4e2d\u7684\u6253\u70b9\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u901a\u5e38\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u529f\u80fd\u3002 \u6392\u67e5\u6839\u56e0 \uff1a\u5206\u6790\u5355\u6b21\u8bf7\u6c42\u7684\u8c03\u7528\u94fe\u8def\uff0c\u6392\u67e5\u95ee\u9898\u6839\u56e0\u3002 \u8c03\u7528\u5173\u7cfb\u56fe \uff1a\u901a\u8fc7 Trace \u4e2d\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u7ed8\u5236\u670d\u52a1\u8c03\u7528\u5173\u7cfb\u56fe\u3002 \u65e5\u5fd7\u8ffd\u8e2a \uff1a\u901a\u8fc7\u5173\u8054\u65e5\u5fd7 RequestId\uff0c\u53ef\u4ee5\u94fe\u63a5\u5230\u65e5\u5fd7\u7cfb\u7edf\uff0c\u67e5\u770b\u66f4\u8be6\u7ec6\u7684\u65e5\u5fd7\u4fe1\u606f\u3002","title":"3-1 Trace \u6240\u9700\u7684\u4fe1\u606f\u4f20\u9012\u7ed9\u88ab\u8c03\u65b9\u670d\u52a1"},{"location":"chap1/8chap1_trace/#4","text":"","title":"4\u3001\u5e38\u89c1\u7684\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf"},{"location":"chap1/8chap1_trace/#4-1-zipkin","text":"Zipkin\u662f Twitter \u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u5c5e\u4e8e\u6bd4\u8f83\u65e9\u7684 Trace \u7cfb\u7edf\uff0c\u5bf9 PHP\u3001Golang\u3001Java \u90fd\u6709\u4e0d\u9519\u7684\u652f\u6301\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u5957 Web \u56fe\u5f62\u5316\u754c\u9762\uff0c\u4f9b\u7528\u6237\u67e5\u770b\u5355\u6761\u94fe\u8def\u4fe1\u606f\uff0c\u4e5f\u63d0\u4f9b\u4e86\u67e5\u770b\u8c03\u7528\u5173\u7cfb\u56fe\u7684\u529f\u80fd\u3002","title":"4-1 Zipkin"},{"location":"chap1/8chap1_trace/#4-2-jaeger","text":"Jaeger \u662f Uber \u516c\u53f8\u5f00\u6e90\u7684\u3001\u91c7\u7528 Go \u8bed\u8a00\u5f00\u53d1\u7684\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u7531\u4ee5\u4e0b\u51e0\u4e2a\u6a21\u5757\u7ec4\u6210\u3002 jaeger-client\uff1aJaeger \u63d0\u4f9b\u7684\u7b26\u5408 OpenTracing \u6807\u51c6\u7684\u5404\u79cd\u8bed\u8a00\u7684 SDK\uff0c\u5305\u62ec Java\u3001Go\u3001Node.js \u7b49\u3002Client \u8d1f\u8d23\u6536\u96c6 Trace \u6570\u636e\u53d1\u9001\u5230 Agent\u3002 jaeger-agent\uff1ajaeger-client \u7684\u4ee3\u7406\u7a0b\u5e8f\uff0c\u90e8\u7f72\u5728\u6240\u6709\u5bbf\u4e3b\u673a\u4e0a\uff0c\u8fd9\u6837\u7684\u76ee\u7684\u548c Sidecar \u7c7b\u4f3c\uff0c\u5c4f\u853d\u4e86\u4e00\u4e9b\u8def\u7531\u548c Collector \u8282\u70b9\u53d1\u73b0\u7684\u7ec6\u8282\uff0c\u8ba9 Client \u66f4\u52a0\u8f7b\u91cf\u5316\u3002Client \u901a\u8fc7 UDP \u534f\u8bae\u548c Agent \u901a\u4fe1\uff0c\u4e5f\u907f\u514d\u4e86\u65e5\u5fd7\u843d\u76d8\u518d\u91c7\u96c6\u5bfc\u81f4\u7684\u4e00\u4e9b\u6027\u80fd\u95ee\u9898\u3002 jaeger-collector\uff1a\u8d1f\u8d23\u6536\u96c6 Agent \u4e0a\u62a5\u7684\u94fe\u8def\u8ffd\u8e2a\u6570\u636e\uff0c\u5e76\u505a\u4e00\u4e9b\u6570\u636e\u9a8c\u8bc1\u5de5\u4f5c\uff0c\u4ee5\u53ca\u5bf9\u6570\u636e\u505a\u4e00\u4e9b\u5904\u7406\u7136\u540e\u4e0a\u62a5\u5230\u5b58\u50a8\u7cfb\u7edf \u3002 jaeger-db\uff1a\u540e\u7aef\u5b58\u50a8\u7cfb\u7edf\uff0c\u652f\u6301 Cassandra \u548c ElasticSearch\u3002 jaeger-query\uff1a\u4e13\u95e8\u8d1f\u8d23\u8c03\u7528\u94fe\u67e5\u8be2\u7684\u4e00\u4e2a\u670d\u52a1\uff0c\u63d0\u4f9b\u4e00\u5957\u72ec\u7acb\u7684 UI \u754c\u9762\uff0c\u7528\u4e8e\u7ed8\u5236\u8c03\u7528\u5173\u7cfb\u548c\u5c55\u793a\u670d\u52a1\u94fe\u8def \u3002 spark-job\uff1a\u57fa\u4e8e Spark \u7684\u8fd0\u7b97\u4efb\u52a1\uff0c\u53ef\u4ee5\u8ba1\u7b97\u670d\u52a1\u7684\u4f9d\u8d56\u5173\u7cfb\u3001\u8c03\u7528\u6b21\u6570\u7b49\u3002","title":"4-2 Jaeger"},{"location":"chap1/8chap1_trace/#5trace","text":"","title":"5\u3001Trace \u7cfb\u7edf\u4e2d\u7684\u5e38\u89c1\u95ee\u9898"},{"location":"chap1/8chap1_trace/#5-1-traceid","text":"TraceId \u53ea\u8981\u5168\u5c40\u552f\u4e00\u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u53c2\u8003 SOFATrace \u4e2d\u7684\u8bbe\u8ba1\uff0c\u901a\u8fc7 8 \u4f4d\u7684 IP \u5730\u5740\u548c 13 \u4f4d\u7684\u65f6\u95f4\u6233\uff0c\u4ee5\u53ca\u56db\u4f4d\u7684\u81ea\u589e\u5e8f\u5217\uff0c\u52a0\u4e0a\u672c\u8eab\u8fdb\u7a0b\u7684 PID \u53f7\uff0c\u8fd9\u6837\u7ec4\u6210\u7684\u5b57\u7b26\u4e32\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u5168\u5c40\u552f\u4e00\u4e86\u3002","title":"5-1 TraceId \u5982\u4f55\u8bbe\u8ba1"},{"location":"chap1/8chap1_trace/#5-2-trace","text":"\u963f\u91cc\u4e91\u63d0\u4f9b\u7684 sls \u4f5c\u4e3a\u94fe\u8def\u8ffd\u8e2a\u7684\u5b58\u50a8\u7cfb\u7edf \u7528 SDK \u5c06\u6570\u636e\u76f4\u63a5\u843d\u76d8\uff0c\u4ee5\u65e5\u5fd7\u7684\u65b9\u5f0f\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\uff0c\u7136\u540e\u7531 Logtail \u5c06\u65e5\u5fd7\u6536\u96c6\u5230 sls\uff0c\u4f46\u662f\u8fd9\u6837\u5c31\u4ea7\u751f\u4e86\u65e5\u5fd7\u5199\u76d8\u7684\u6027\u80fd\u95ee\u9898\u3002 \u5982\u679c\u6bcf\u6761\u65e5\u5fd7\u90fd\u76f4\u63a5\u843d\u76d8\uff0c\u90a3\u4e48\u7cfb\u7edf\u7684 IO \u6d88\u8017\u4f1a\u975e\u5e38\u5927\uff0c\u6240\u4ee5\u5b9e\u8df5\u4e2d\u6211\u91c7\u7528\u4e86 \u5f02\u6b65\u843d\u76d8 \u7684\u673a\u5236\uff0c\u51cf\u5c11\u5bf9\u4e1a\u52a1\u8bf7\u6c42\u7684\u5f71\u54cd\uff0c\u4e5f\u540c\u65f6\u51cf\u5c11\u4e86\u7cfb\u7edf\u8c03\u7528\u548c\u7cfb\u7edf IO \u7684\u6d88\u8017\u3002","title":"5-2 Trace \u65e5\u5fd7\u843d\u76d8"},{"location":"chap1/8chap1_trace/#5-3-service-mesh-trace","text":"\u5b9e\u9645\u4e0a\u56e0\u4e3a Service Mesh \u7ecf\u5e38\u5ba3\u4f20\u65e0\u4fb5\u5165\u7684\u63a5\u5165\u65b9\u5f0f\uff0c\u8fd9\u5757\u9020\u6210\u4e86\u4e00\u5b9a\u7684\u8bef\u89e3\uff0c\u65e9\u671f Istio \u6587\u6863\u63cf\u8ff0\u5f97\u4e5f\u4e0d\u662f\u5f88\u6e05\u695a\uff0c\u4f46\u540e\u9762\u7684 Istio \u6587\u6863\u505a\u4e86\u66f4\u6b63\uff0c \u5728 Service Mesh \u4e2d\u53ea\u8981\u5c11\u91cf\u4ee3\u7801\u5c31\u53ef\u4ee5\u63a5\u5165 Trace \u4e86 \u3002 Sidecar \u4f9d\u7136\u4f9d\u8d56\u5e94\u7528\u7a0b\u5e8f\u4f20\u9012 Trace \u6240\u9700\u8981\u7684 header\uff0c\u4f46\u901a\u8fc7 Sidecar \u53ef\u4ee5\u7b80\u5316 Trace \u7684\u63a5\u5165\uff0cTrace SDK \u53ea\u8981\u4fdd\u8bc1\u80fd\u591f\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684 Trace header \u5728\u6bcf\u6b21\u8bf7\u6c42\u4e2d\u4f20\u9012\u4e0b\u53bb\u5c31\u53ef\u4ee5\u4e86\uff0c\u800c\u4e0d\u7528\u8d1f\u8d23\u7e41\u91cd\u7684\u6570\u636e\u4e0a\u62a5\u5de5\u4f5c\u3002\u4f46\u5982\u679c\u9664\u4e86\u670d\u52a1\u7684\u94fe\u8def\u4fe1\u606f\uff0c\u8fd8\u5e0c\u671b\u6536\u96c6\u4e00\u4e9b DB \u4e2d\u95f4\u4ef6\u7684\u8c03\u7528\u4fe1\u606f\uff0c\u6570\u636e\u4e0a\u62a5\u7684\u5de5\u4f5c\u8fd8\u662f\u65e0\u6cd5\u907f\u514d\u7684\u3002","title":"5-3 Service Mesh \u4e2d\u53ef\u4ee5\u65e0\u611f\u77e5\u63a5\u5165 Trace \u5417\uff1f"},{"location":"chap1/8chap1_trace/#5-4-trace","text":"\u5bf9\u4e00\u4e9b\u8bed\u8a00\u6765\u8bf4\uff0c\u4fb5\u5165\u6027\u6bd4\u8f83\u5f3a\u662f\u6700\u5927\u7684\u75db\u70b9\u3002\u5bf9\u4e8e Java \u76f8\u5bf9\u6765\u8bf4\u6bd4\u8f83\u5bb9\u6613\uff0c\u53ef\u4ee5\u901a\u8fc7 Java Agent \u65e0\u611f\u77e5\u5730\u63a5\u5165\uff0c\u4f46\u5bf9\u4e8e\u5176\u4ed6\u8bed\u8a00\u5c31\u6ca1\u90a3\u4e48\u5bb9\u6613\u4e86\u3002 \u6bd4\u5982 PHP\u3001Go\u3001Node.js \u7b49\u8bed\u8a00\uff0c\u90fd\u9700\u8981\u901a\u8fc7 SDK \u7684\u65b9\u5f0f\u63a5\u5165\u3002\u5982\u679c\u662f \u5728\u5fae\u670d\u52a1\u62c6\u5206\u7684\u4e2d\u540e\u671f\uff0c\u60f3\u8981\u518d\u589e\u52a0 Trace \u7cfb\u7edf\u5c31\u5341\u5206\u56f0\u96be\u4e86\uff0c\u6240\u4ee5\u8fd9\u91cc\u5efa\u8bae\u5728\u51b3\u5b9a\u4f7f\u7528\u5fae\u670d\u52a1\u67b6\u6784\u7684\u521d\u671f\uff0c\u5728\u6846\u67b6\u5185\u96c6\u6210 Trace SDK\uff0c\u5e76\u9ed8\u8ba4\u5f00\u542f\uff0c\u514d\u53bb\u540e\u7eed\u7684\u9ebb\u70e6 \u3002","title":"5-4 Trace \u7ec4\u4ef6\u5982\u4f55\u5728\u9879\u76ee\u4e2d\u843d\u5730\uff1f"},{"location":"chap1/8chap1_trace/#5-5","text":"\u5728 Jaeger \u4e2d\u63d0\u4f9b\u4e86\u52a8\u6001\u91c7\u6837\u7387\u7684\u529f\u80fd \uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u540c\u4e00\u4e2a\u670d\u52a1\u4e2d\uff0c\u4f4e QPS \u7684\u63a5\u53e3\u53ef\u4ee5\u88ab\u6709\u6548\u91c7\u96c6\uff0c\u800c\u9ad8 QPS \u7684\u63a5\u53e3\u6709\u8f83\u4f4e\u7684\u91c7\u6837\u7387\u3002","title":"5-5 \u91c7\u6837\u7387\u5982\u4f55\u8bbe\u7f6e\uff1f"},{"location":"chap1/8chap1_trace/#5-6-trace","text":"\u7f51\u5173\u4e2d\u751f\u6210\u521d\u59cb\u7684 TraceId \u548c\u6700\u4e0a\u5c42\u7684 SpanId\uff0c\u540e\u7eed\u7684\u670d\u52a1\u53ea\u8981\u62ff\u5230 downstream \u96c6\u7fa4\uff0c\u901a\u8fc7 header \u4f20\u9012\u4e0b\u6765\u7684 Trace \u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u7ee7\u7eed\u751f\u6210\u672c\u670d\u52a1\u7684 Trace \u6570\u636e\u4e86 \u50cf Jaeger \u4e4b\u7c7b\u7684\u7ec4\u4ef6\uff0c\u5728\u6ca1\u6709\u62ff\u5230 Trace \u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u9ed8\u8ba4\u751f\u6210\u65b0\u7684 TraceId \u3002 \u5b9e\u9645\u4e0a\uff0c\u6211\u5e76\u4e0d\u5efa\u8bae\u8fd9\u6837\u7684\u505a\u6cd5\uff0c\u4e00\u662f\u589e\u52a0\u4e86 SDK \u7684\u590d\u6742\u5ea6\uff0c\u9020\u6210\u7ef4\u62a4\u56f0\u96be\uff1b\u4e8c\u662f\u94fe\u8def\u4e00\u65e6\u65ad\u6389\uff0c\u5bf9\u4e8e\u6392\u67e5\u95ee\u9898\u7684\u5e2e\u52a9\u5c31\u4e0d\u662f\u5f88\u5927\u4e86\u3002","title":"5-6 Trace \u94fe\u8def\u7684\u8fde\u7eed\u6027"},{"location":"chap1/8chap1_trace/#6","text":"","title":"6\u3001\u5173\u4e8e\u94fe\u8def\u8ffd\u8e2a\u7684\u4e00\u4e9b\u601d\u8003"},{"location":"chap1/8chap1_trace/#6-1","text":"\u94fe\u8def\u8ffd\u8e2a\uff0c\u4e3b\u8981\u8fd8\u662f\u7528\u4e8e\u5185\u90e8\u670d\u52a1\uff0c\u4ee5\u5c55\u793a\u5fae\u670d\u52a1\u7684\u8c03\u7528\u5173\u7cfb\u548c\u6392\u67e5\u5fae\u670d\u52a1\u5bfc\u81f4\u7684\u94fe\u8def\u590d\u6742\u6027\u95ee\u9898\u3002 \u4f46\u5b9e\u9645\u4e0a\u53ef\u4ee5\u8003\u8651\u5728\u5ba2\u6237\u7aef\u5c31\u751f\u6210 client-traceid\uff0c\u7136\u540e\u5c06 client-traceid \u548c\u5185\u90e8 TraceId \u5173\u8054\u8d77\u6765\uff0c\u8fd9\u6837\u5c31\u80fd\u591f\u5c55\u793a\u6574\u4e2a\u94fe\u8def\u8ffd\u8e2a\u4e2d\u5ba2\u6237\u7aef\u8017\u65f6\u5360\u6bd4 \u3002","title":"6-1 \u5ba2\u6237\u7aef\u94fe\u8def\u8ffd\u8e2a"},{"location":"chap1/8chap1_trace/#6-2-rpc-sdk","text":"\u5b9e\u9645\u4e0a Trace \u7cfb\u7edf\u9700\u8981\u5c06 Trace header \u7684\u4fe1\u606f\u4e00\u5c42\u5c42\u4f20\u9012\u4e0b\u53bb\uff0c\u6240\u4ee5 RPC \u7684 Client SDK \u9700\u8981\u5177\u5907\u201c\u5728\u8bf7\u6c42\u7684\u65f6\u5019\u5e26\u4e0a Trace \u6240\u9700\u4fe1\u606f\u201d\u7684\u80fd\u529b\u3002 \u5176\u5b9e\u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u6709\u5f88\u591a\u573a\u666f\u9700\u8981\u6211\u4eec\u5c06\u6700\u9876\u5c42\u7684\u7f51\u5173\u5c42\u7684\u6570\u636e\u4f20\u9012\u4e0b\u53bb\uff0c\u4ee5\u4fdd\u8bc1\u4e0a\u6e38\uff08upstream\uff09\u7684\u5fae\u670d\u52a1\u80fd\u591f\u83b7\u53d6\u8fd9\u4e9b\u4fe1\u606f\u3002\u6bd4\u5982\u5ba2\u6237\u7aef IP\u3001\u7070\u5ea6\u6d41\u91cf\u6807\u7b7e\u7b49\u3002\u6240\u4ee5\u5728\u5fae\u670d\u52a1 SDK \u8bbe\u8ba1\u7684\u65f6\u5019\u6700\u597d\u5b9a\u4e49\u4e00\u7ec4 header\uff0c\u65b9\u4fbf\u6211\u4eec\u89e3\u6790\u5e76\u5411\u4e0a\u6e38\u4f20\u9012\uff0c\u6bd4\u5982 X-Mesh-Xxx \u3002","title":"6-2 RPC SDK \u7684\u8bbe\u8ba1"},{"location":"chap1/9chap1_monitor/","text":"\u7b2c\u4e5d\u8282 \u5229\u7528 Prometheus \u548c Grafana \u6536\u96c6\u76d1\u63a7\u6570\u636e 1\u3001\u4f20\u7edf\u76d1\u63a7\u7cfb\u7edf \u76d1\u63a7\u7cfb\u7edf\u901a\u5e38\u7531\u6307\u6807\u91c7\u96c6\u5b50\u7cfb\u7edf\u548c\u6570\u636e\u5904\u7406\u5b50\u7cfb\u7edf\u7ec4\u6210\u3002 \u6307\u6807\u91c7\u96c6\u5b50\u7cfb\u7edf\u4e3b\u8981\u8d1f\u8d23\u4fe1\u606f\u91c7\u96c6\u3001\u8fc7\u6ee4\u3001\u6c47\u603b\u548c\u5b58\u50a8\uff1b \u6570\u636e\u5904\u7406\u5b50\u7cfb\u7edf\u4e3b\u8981\u8d1f\u8d23\u6570\u636e\u5206\u6790\u3001\u5c55\u73b0\u3001\u9884\u8b66\u548c\u544a\u8b66\u7b49\u3002\u4f20\u7edf\u7684\u76d1\u63a7\u7cfb\u7edf\u4e00\u822c\u6709ELK \u548c Nagios & Zabbix\u3002 1-1 ELK ELK \u662f Elastic \u516c\u53f8\u63a8\u51fa\u7684\u76d1\u63a7\u7cfb\u7edf\uff0c\u5305\u542b\u4e86 Elasticsearch\u3001Logstash \u548c Kibana\uff0c\u5206\u522b\u4f5c\u4e3a\u5b58\u50a8\u5f15\u64ce\u3001\u65e5\u5fd7\u6536\u96c6\u548c\u524d\u7aef\u5c55\u793a\u7cfb\u7edf\u3002 \u5176\u4e2dElasticsearch \u662f\u6838\u5fc3\uff0c\u5176\u4ed6\u4e24\u4e2a\u90fd\u53ef\u4ee5\u66ff\u6362\uff0c\u8f83\u5e38\u89c1\u7684\u66ff\u6362\u65b9\u6848\u662f Filebeat \u548c Graylog\u3002 Filebeat \u662f\u7531 Go \u8bed\u8a00\u7f16\u5199\u7684\u8f7b\u91cf\u7ea7\u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u3002\u65e5\u5fd7\u53ef\u4ee5\u76f4\u63a5\u4f20\u8f93\u5230 Elasticsearch \u4e2d\uff0c\u53ef\u4ee5\u4f20\u8f93\u5230 Logstash \u8fdb\u884c\u4e00\u4e9b\u6570\u636e\u5904\u7406\u3002 \u800cGraylog \u662f\u4e00\u5957\u4ee3\u66ff ELK \u7684\u65e5\u5fd7\u6536\u96c6\u5206\u6790\u7cfb\u7edf\uff0c\u5176\u4e2d\u4fdd\u7559\u4e86 Elasticsearch \u7684\u5b58\u50a8\u90e8\u5206\uff0c\u63d0\u4f9b\u4e86 collector-sidecar \u7528\u4e8e\u65e5\u5fd7\u6536\u96c6\uff0c\u5e76\u7ee7\u627f\u4e86 Web \u56fe\u5f62\u754c\u9762\uff0c\u7528\u4e8e\u641c\u7d22\u548c\u56fe\u5f62\u5316\u5c55\u793a\u3002 \u603b\u4f53\u6765\u8bf4\uff0cELK \u662f\u4e00\u5957\u4f20\u7edf\u7684\u53ef\u89c2\u6d4b\u6027\u7cfb\u7edf\uff0c\u4e3b\u8981\u5229\u7528\u6211\u4eec\u4e4b\u524d\u63d0\u5230\u7684\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u4e4b\u4e00\u2014\u2014\u65e5\u5fd7\u6765\u63d0\u4f9b\u76d1\u63a7\u529f\u80fd\uff0c\u4f18\u70b9\u662f\u6570\u636e\u51c6\u786e\u6027\u9ad8\uff0c\u4f46\u7531\u4e8e\u65e5\u5fd7\u9700\u8981\u5b58\u50a8\u548c\u5efa\u7acb\u7d22\u5f15\uff0c\u6210\u672c\u4f1a\u6bd4\u8f83\u9ad8 1-2 Nagios & Zabbix Nagios \u548c Zabbix \u90fd\u662f\u4f20\u7edf\u7684\u8fd0\u7ef4\u76d1\u63a7\u5de5\u5177\uff0c\u4e3b\u8981\u76d1\u63a7\u4e3b\u673a\u3001\u7f51\u7edc\uff0c\u4ee5\u53ca\u4e1a\u52a1\u8fdb\u7a0b\u7aef\u53e3\u7684\u4fe1\u606f\u548c\u72b6\u6001\u3002\u4e3b\u8981\u4ee5\u63d2\u4ef6\u7684\u65b9\u5f0f\u8fdb\u884c\u6269\u5c55\uff0c\u901a\u8fc7\u63d2\u4ef6\u6269\u5c55\u53ef\u4ee5\u68c0\u6d4b\u4e3b\u673a\u7684 CPU\u3001\u5185\u5b58\u3001\u786c\u76d8\u7b49\u4fe1\u606f\uff0c\u4e5f\u53ef\u4ee5\u68c0\u6d4b\u5404\u79cd\u4e0d\u540c\u7684\u7f51\u7edc\u534f\u8bae\uff0c \u4f46\u5bf9\u4e8e\u68c0\u6d4b\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u5185\u7684\u4fe1\u606f\u51e0\u4e4e\u662f\u65e0\u80fd\u4e3a\u529b\u7684 \u3002 \u5e94\u7528\u81ea\u8eab\u7684\u9ec4\u91d1\u6307\u6807\uff08\u5ef6\u65f6\u3001\u901a\u4fe1\u91cf\u3001\u9971\u548c\u5ea6\u3001\u9519\u8bef\u7387\uff09\u548c\u4e00\u4e9b\u4e1a\u52a1\u7ea7\u522b\u7684\u6307\u6807\u90fd\u9700\u8981\u5b9e\u65f6\u7684\u53ef\u89c2\u6d4b\u3002 2\u3001\u73b0\u4ee3\u5316\u5e38\u7528\u7684 Metrics \u7cfb\u7edf Metrics \u4e3b\u8981\u662f\u7528\u65f6\u5e8f\u6027\u6570\u636e\u5e93\u8bb0\u5f55\u6bcf\u4e2a\u65f6\u95f4\u70b9\u7684\u76d1\u63a7\u6570\u636e\uff0c\u901a\u8fc7\u4e3b\u52a8\u62c9\u53d6\u6216\u8005\u7a0b\u5e8f\u4e0a\u62a5\u7684\u65b9\u5f0f\u8bb0\u5f55\uff0c\u7136\u540e\u5b9e\u65f6\u8ba1\u7b97\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e\uff0c\u5e76\u901a\u8fc7\u56fe\u5f62\u754c\u9762\u7684\u65b9\u5f0f\u5c55\u73b0\u51fa\u6765\u3002\u5b83\u7684\u7279\u70b9\u662f\u5b9e\u65f6\u6027\u5f3a\u3001\u53ef\u89c2\u6d4b\u6307\u6807\u4e30\u5bcc\uff0c\u9002\u5408\u67e5\u770b\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6307\u6807\u8d8b\u52bf\u3002 2-1 StatsD+Graphite StatsD \u662f Node.js \u7f16\u5199\u7684\u4e00\u4e2aMetrics \u6307\u6807\u91c7\u96c6\u7cfb\u7edf\uff0c\u901a\u8fc7 UDP \u534f\u8bae\u5c06\u4fe1\u606f\u4f20\u8f93\u5230\u540e\u7aef\u7a0b\u5e8f\uff0c\u805a\u5408\u540e\u5b58\u50a8\u5230 Graphite\u3002 StatsD \u5305\u542b\u4e09\u4e2a\u7ec4\u6210\u90e8\u5206\uff0c\u5206\u522b\u662f\uff1a Client\uff0c\u5404\u79cd\u8bed\u8a00\u4f7f\u7528\u7684 SDK\uff0c\u7528\u4e8e\u5c06 Metrics \u4fe1\u606f\u901a\u8fc7 UDP \u7684\u65b9\u5f0f\u4f20\u9001\u5230 Server\u3002 Server\uff0c\u6536\u96c6\u5ba2\u6237\u7aef\u4f20\u8f93\u7684 Metrics \u4fe1\u606f\uff0c\u805a\u5408\u540e\u53d1\u9001\u5230 Backend\uff0c\u4e5f\u5c31\u662f Graphite\u3002 Backend\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684 Graphite\uff0cGraphite \u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u8d1f\u8d23\u5b58\u50a8 Metrics \u4fe1\u606f\u3002 2-2 InfluxDB+Telegraf InfluxDB \u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u8d1f\u8d23 Metrics \u4fe1\u606f\u7684\u5b58\u50a8 \uff1b Telegraf \u662f\u4e00\u5957 Metrics \u6536\u96c6\u7cfb\u7edf\uff0c\u9ed8\u8ba4\u81ea\u5e26\u975e\u5e38\u4e30\u5bcc\u7684\u63d2\u4ef6\uff0c\u7528\u4e8e\u91c7\u96c6\u7cfb\u7edf\u7ea7\u522b\u7684\u4fe1\u606f\uff0c\u5982\u679c\u8981\u91c7\u96c6\u5e94\u7528\u7ef4\u5ea6\u7684\u4fe1\u606f\uff0c\u5219\u9700\u8981\u7f16\u5199\u63d2\u4ef6\u3002 2-3 Prometheus Prometheus \u662f Cloud Native Computing Foundation\uff08\u7b80\u79f0\uff1aCNCF\uff09\u751f\u6001\u5708\u7684\u4e00\u5458\uff0c\u4e5f\u662f\u6574\u4e2a Kubernetes \u751f\u6001\u4e2d\u91cd\u8981\u7684\u4e00\u73af\uff0c\u73b0\u5df2\u7ecf\u5e7f\u6cdb\u7528\u4e8e Kubernetes \u96c6\u7fa4\u76d1\u63a7\u4e2d\u3002 Prometheus \u4e0e\u4e0a\u9762\u7684\u4e24\u4e2a Metrics \u7cfb\u7edf\u6700\u5927\u7684\u4e0d\u540c\uff0c\u662f\u63d0\u4f9b\u4e86\u4e00\u6574\u5957\u5b8c\u6574\u7684\u76d1\u63a7\u544a\u8b66\u89e3\u51b3\u65b9\u6848\uff0c\u5305\u542b\u4e86\u6570\u636e\u91c7\u96c6\u3001\u6570\u636e\u5b58\u50a8\u548c\u544a\u8b66\u3002 \u53e6\u5916\u8fd8\u6709\u4e24\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u4e5f\u662f\u73b0\u4ee3\u5316\u76d1\u63a7\u7cfb\u7edf\u7684\u5fc5\u8981\u6807\u5fd7\uff1a \u91c7\u7528\u4e86 pull \u62c9\u53d6\u7684\u6a21\u578b\u91c7\u96c6\u6570\u636e\uff0c\u7b80\u5316\u4e86\u5ba2\u6237\u7aef\u7684\u4ee3\u7801\u7f16\u5199\u6210\u672c\uff0c\u5e76\u4e14 HTTP \u534f\u8bae\u975e\u5e38\u5229\u4e8e\u8c03\u8bd5\u3002 \u652f\u6301\u670d\u52a1\u53d1\u73b0\uff0c \u9ed8\u8ba4\u652f\u6301\u4e86 Consul \u548c Kubernetes \u539f\u751f\u53d1\u73b0\u7cfb\u7edf\uff0c\u907f\u514d\u4e86\u7e41\u6742\u7684\u673a\u5668\u4fe1\u606f\u914d\u7f6e \u3002 3\u3001Prometheus \u7ec4\u6210\u548c\u67b6\u6784 3-1 Prometheus \u67b6\u6784\u6a21\u5757\u6784\u6210 Prometheus Server \uff1a\u7528\u4e8e\u6536\u96c6\u548c\u5b58\u50a8 Metrics \u6570\u636e\u3002 Service Disvovery \uff1a\u7528\u4e8e\u670d\u52a1\u53d1\u73b0\uff0c\u83b7\u53d6\u670d\u52a1\u5bf9\u5e94\u7684 EndPoint \u7528\u4e8e\u6570\u636e\u91c7\u96c6\uff0c\u9ed8\u8ba4\u652f\u6301 DNS\u3001Consul\u3001Kubernestes \u7b49\u591a\u79cd\u53d1\u73b0\u65b9\u6848\u3002 PushGateway \uff1a\u63d0\u4f9b\u63a8\u9001\u7684\u65b9\u5f0f\u91c7\u96c6\u6570\u636e\uff0c\u4e3b\u8981\u7528\u4e8e Job \u7c7b\uff0cJob \u7c7b\u7a0b\u5e8f\u53ef\u80fd\u5b58\u6d3b\u65f6\u95f4\u6bd4\u8f83\u77ed\uff0c\u4e0d\u9002\u5408\u91c7\u7528\u62c9\u53d6\u7684\u65b9\u5f0f\u3002\u53e6\u5916\u4e00\u4e9b\u975e\u5e38\u9a7b\u8fdb\u7a0b\u7684\u811a\u672c\u8bed\u8a00\uff0c\u6bd4\u5982 PHP\uff0c\u4e5f\u9700\u8981\u4f7f\u7528\u6b64\u79cd\u65b9\u5f0f\u3002 Exporters \uff1a\u7528\u4e8e\u4e00\u4e9b\u7b2c\u4e09\u65b9\u670d\u52a1\uff0c\u901a\u8fc7\u8f6c\u6362\u63d0\u4f9b\u7b26\u5408 Prometheus \u89c4\u8303\u7684 Metrics \u4fe1\u606f\uff0c\u6bd4\u5982 Node Exporter \u63d0\u4f9b\u8282\u70b9\u76f8\u5173\u7684\u4fe1\u606f\u3002BlackBox \u65b9\u4fbf\u7528\u6237\u4f7f\u7528 HTTP\u3001TCP \u7b49\u65b9\u5f0f\u5bf9\u5e94\u7528\u8fdb\u7a0b\u63a2\u6d3b\uff0c\u4ee5\u76d1\u63a7\u5e94\u7528\u72b6\u6001\u3002 Client Library \uff1a\u4e3a\u5404\u79cd\u8bed\u8a00\u63d0\u4f9b\u7684\u5ba2\u6237\u7aef\u5e93\uff0c\u63d0\u4f9b HTTP \u670d\u52a1\u7684 Metrics \u63a5\u53e3\uff0c\u5f53 Prometheus Server \u62c9\u53d6\u65f6\uff0c\u63d0\u4f9b\u5b9e\u65f6\u7684 Metrics \u6570\u636e\u3002 Alertmanager \uff1a\u544a\u8b66\u7ba1\u7406\u5668\uff0c\u63a5\u6536 Prometheus Server \u53d1\u6765\u7684\u544a\u8b66\u4fe1\u606f\uff0c\u53bb\u9664\u91cd\u590d\u4fe1\u606f\uff0c\u5206\u7ec4\u540e\u53d1\u9001\u7ed9\u76f8\u5e94\u7684\u4eba\u5458\u3002\u901a\u77e5\u65b9\u5f0f\u652f\u6301 Email \u548c WebHook \u81ea\u5b9a\u4e49\u7b49\uff0c\u4e00\u822c\u4f1a\u901a\u8fc7 WebHook \u63a5\u5165\u9489\u9489\u6216\u8005\u4f01\u4e1a\u5fae\u4fe1\u4ee5\u8fbe\u5230\u5b9e\u65f6\u62a5\u8b66\u7684\u76ee\u7684\u3002 3-2 Prometheus \u6570\u636e\u6a21\u578b negri_http_request_total{client=\"serviceA\",code=\"200\",exported_service=\"serviceB\",path=\"/ping\"} Metrics \u540d\u5b57\uff1a\u9996\u5148\u662f Metrics \u7684\u540d\u79f0\uff0cMetrics \u7684\u540d\u79f0\u8868\u660e\u4e86\u8fd9\u6761\u6570\u636e\u7684\u7528\u9014\uff0c\u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a\u6570\u636e\u662f Negri Sidecar \u7edf\u8ba1\u7684\u603b\u7684\u8bf7\u6c42\u6570\u91cf\u3002 Label \u6807\u7b7e\uff1a\u8fd9\u6761\u6570\u636e\u4e2d\u7684 client\u3001code\u3001 exported_service \u548c path \u90fd\u662f\u6807\u7b7e\uff0c\u901a\u8fc7\u6807\u7b7e\u53ef\u4ee5\u7ec4\u6210\u4e0d\u540c\u7684\u67e5\u8be2\u8bed\u53e5\uff0c\u4ece\u4e0d\u540c\u7ef4\u5ea6\u83b7\u53d6\u6570\u636e\u3002 3-3 Prometheus \u7684 Metrics \u7c7b\u578b Counter \u7d2f\u52a0\u503c\uff0c\u975e\u5e38\u9002\u5408\u7edf\u8ba1 QPS\u3002 \u8fd9\u4e2a\u6570\u636e\u4ece\u670d\u52a1\u5f00\u59cb\u5c31\u4e0d\u505c\u5730\u7d2f\u52a0\uff0c\u6bd4\u5982\u4e0a\u9762\u63d0\u5230\u7684 negri_http_request_total \u5c31\u662f\u4e00\u79cd Counter \u7c7b\u578b\u3002 \u5b83\u7edf\u8ba1\u4e86\u670d\u52a1\u542f\u52a8\u81f3\u76ee\u524d\u6240\u6709\u8bf7\u6c42\u7684\u6570\u636e\uff0c\u901a\u8fc7 rate \u6216\u8005 irate \u5c31\u53ef\u4ee5\u8ba1\u7b97\u51fa\u4e00\u6bb5\u65f6\u95f4\u5185\u7684 QPS\u3002 Counter \u7c7b\u578b\u662f Prometheus Server \u7aef\u8ba1\u7b97\u7684\uff0c\u76f8\u5bf9\u4e8e\u4e0b\u9762\u8bb2\u5230\u7684 Gauge\uff0c \u5360\u7528\u670d\u52a1\u81ea\u8eab\u66f4\u5c11 \uff0c\u5efa\u8bae\u9ad8\u6027\u80fd\u7684\u5fae\u670d\u52a1\u9996\u9009\u6b64\u79cd\u7c7b\u578b\u3002 Gauge \u9002\u5408\u8bb0\u5f55\u77ac\u65f6\u503c \uff0c \u6bd4\u5982\u7edf\u8ba1\u4e00\u4e9b\u7a81\u53d1\u4e8b\u4ef6\uff0c\u4f8b\u5982\u662f\u5426\u4ea7\u751f\u4e86\u7194\u65ad\u3001\u9650\u6d41\u7b49\u4e8b\u4ef6 \u3002 \u56e0\u4e3a\u662f\u5ba2\u6237\u7aef SDK \u8ba1\u7b97\u7684\uff0c\u4e0d\u592a\u9002\u5408\u4e00\u4e9b\u7ecf\u5e38\u53d8\u5316\u7684\u6570\u636e\u3002 \u5982\u679c\u6570\u636e\u662f\u4e00\u76f4\u589e\u52a0\u7684\uff0c\u5efa\u8bae\u4f7f\u7528 Counter \uff1b\u5f53\u7136\u5982\u679c\u6570\u636e\u6709\u589e\u6709\u51cf\uff0c\u4e5f\u6bd4\u8f83\u9002\u5408\uff0c\u56e0\u4e3a\u76d1\u63a7\u4e2d\u5f88\u5c11\u9047\u5230\u589e\u51cf\u6bd4\u8f83\u9891\u7e41\u7684\u6570\u636e\u3002 degrade_events{event=\"eventBreakerOpenStatus\",service=\"serviceB\"} Histogram \u67f1\u72b6\u56fe\uff0c\u9002\u5408\u7edf\u8ba1\u670d\u52a1\u7684 99 \u5ef6\u65f6\u7b49\u4fe1\u606f\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c31\u662f\u7528\u4e8e\u7edf\u8ba1\u670d\u52a1\u7684\u5ef6\u65f6\u72b6\u51b5\uff1a negri_http_response_time_us_bucket{client=\"serviceA\",exported_service=\"serviceB\",le=\"0.5\",path=\"/ping\"} \u5982\u4e0a\u8ff0\u5185\u5bb9\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2\u8bed\u53e5\u7ed8\u5236\u51fa 90 \u5ef6\u65f6\u300195 \u5ef6\u65f6\u300199 \u5ef6\u65f6\u7b49\u6307\u6807\uff0c Histogram \u548c Counter \u7c7b\u578b\u4e00\u6837\uff0c\u90fd\u662f Prometheus Server \u7aef\u8ba1\u7b97\u7684\uff0c \u6240\u4ee5\u975e\u5e38\u9002\u5408\u9ad8\u6027\u80fd\u7684\u573a\u666f\u4f7f\u7528 \uff0c\u76f8\u5bf9\u4e8e\u4e0b\u9762\u8bb2\u89e3\u7684 Summary \u6709\u66f4\u5c0f\u7684\u635f\u8017\u3002 Summary \u7c7b\u4f3c\u4e8e Histogram\uff0c\u9002\u5408\u7edf\u8ba1\u670d\u52a1\u7684 99 \u5ef6\u65f6\u4fe1\u606f \u3002 Summary \u548c Gauge \u7c7b\u578b\u4e00\u6837\uff0c\u90fd\u662f\u5728\u7a0b\u5e8f\u5185\u8ba1\u7b97\u7684\uff0c\u6240\u4ee5\u5e76\u4e0d\u80fd\u50cf Histogram \u4e00\u6837\uff0c\u5728\u7ed8\u5236\u56fe\u5f62\u7684\u65f6\u5019\u7075\u6d3b\u7684\u8bbe\u7f6e\u767e\u5206\u4f4d\uff0c \u4f46\u76f8\u5bf9\u6765\u8bf4\uff0cSummary \u7684\u6570\u636e\u4e5f\u66f4\u52a0\u7cbe\u51c6 \u3002 2-4 Grafana \u56fe\u5f62\u5316\u5c55\u793a Grafana \u662f\u4e00\u5957\u53ef\u89c6\u5316\u76d1\u63a7\u6307\u6807\u5de5\u5177\uff0c\u4e3b\u8981\u7528\u4e8e\u65f6\u5e8f\u6570\u636e\u7684\u5c55\u793a\uff0c\u5305\u62ec Graphite\u3001Elasticsearch\u3001InfluxDB\u3001Prometheus\u3001CloudWatch\u3001MySQL \u548c OpenTSDB\u3002\u8fd9\u4e9b\u6570\u636e\u6e90\u5927\u591a\u6570\u6211\u4eec\u5728\u524d\u9762\u505a\u8fc7\u4ecb\u7ecd\u3002\u5176\u4e2d\u6700\u5e38\u89c1\u7684\u5c31\u662f Prometheus+Grafana \u7684\u7ec4\u5408\u3002 \u901a\u8fc7 Grafana \u5c55\u793a\u670d\u52a1\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u5305\u62ec\u5e38\u89c1\u7684 QPS\u3001\u5ef6\u65f6\u7b49\u4fe1\u606f\u3002 2-5 \u5e38\u89c1\u95ee\u9898 Prometheus \u9002\u5408\u4ec0\u4e48\u6837\u7684\u76d1\u63a7\u573a\u666f\uff1f Metrics \u6570\u636e\u76d1\u63a7\uff0c\u5e76\u4e0d\u9002\u5408\u8981\u6c42\u6570\u636e 100% \u51c6\u786e\u7684\u573a\u666f\uff0c \u66f4\u591a\u7684\u662f\u53cd\u6620\u4e00\u6bb5\u65f6\u95f4\u5185\u67d0\u4e2a\u6570\u636e\u6307\u6807\u7684\u8d8b\u52bf\u548c\u5927\u6982\u503c \u3002\u91c7\u96c6\u6570\u636e\u662f\u5b58\u5728\u95f4\u9694\u7684\uff0c\u8ba1\u7b97\u6570\u636e\u4e5f\u662f\u6709\u65f6\u95f4\u533a\u95f4\u7684\uff0c\u6240\u4ee5\u5f88\u96be\u53cd\u6620\u67d0\u4e00\u65f6\u523b\u7684\u51c6\u786e\u503c\uff0c\u6bd4\u5982 CPU \u7684\u5cf0\u503c\uff0c\u5927\u6982\u7387\u4f1a\u88ab\u5e73\u5747\u6389\u3002 \u5982\u679c\u8981\u67e5\u770b\u7cbe\u51c6\u6570\u636e\uff0c\u6700\u597d\u901a\u8fc7\u65e5\u5fd7\u7684\u65b9\u5f0f\u6536\u96c6\u540e\u68c0\u7d22\u67e5\u770b \u3002 \u5355\u4e2a\u670d\u52a1\u8282\u70b9 Metrics \u6570\u91cf\u9650\u5236 Prometheus \u867d\u7136\u6027\u80fd\u5f3a\u5927\uff0c\u4f46\u5982\u679c\u65e0\u89c4\u8303\u7684\u4f7f\u7528\uff0c\u968f\u7740\u91c7\u96c6\u6570\u636e\u8282\u70b9\u589e\u591a\uff0c\u4f9d\u7136\u96be\u4ee5\u4fdd\u8bc1\u5176\u7a33\u5b9a\u6027\u3002\u6bd4\u5982\u4e00\u4e9b RESTful \u89c4\u8303\u7684 path\uff08\u6bd4\u5982 /test/123\uff0c\u5176\u4e2d 123 \u4e3a\u53d8\u91cf\uff09\uff0c\u5982\u679c\u4e0d\u91c7\u53d6\u4e00\u4e9b\u63aa\u65bd\u805a\u5408\uff0c\u4f1a\u9020\u6210 Metrics \u7206\u70b8\u3002Metrics \u7684\u7206\u70b8\u4e0d\u4ec5\u4f1a\u5bfc\u81f4\u670d\u52a1 OOM\uff0c\u4e5f\u4f1a\u5bfc\u81f4 Prometheus \u7684\u5185\u5b58\u4f7f\u7528\u91cf\u589e\u5927\u548c\u68c0\u7d22\u53d8\u6162\u3002 \u53e6\u5916\u8fc7\u591a\u7684\u6807\u7b7e\u53d8\u91cf\u3001\u8fc7\u591a\u7684 Histogram bucket\uff0c\u90fd\u4f1a\u5bfc\u81f4 Metrics \u6570\u91cf\u7684\u589e\u52a0\u3002\u6bd4\u5982\u4e0d\u5408\u7406\u5730\u8bb0\u5f55\u4e86\u8c03\u7528\u7aef\u7684\u6765\u6e90 IP\uff0c\u540c\u65f6\u4e5f\u8bb0\u5f55\u4e86\u670d\u52a1\u81ea\u8eab\u7684 IP\uff0c\u4e24\u8005\u7684 Metrics \u6570\u91cf\u5c31\u4f1a\u53d8\u6210\u4e58\u79ef\u5173\u7cfb\u3002\u8fd9\u4e9b\u4e0d\u5408\u7406\u7684\u6307\u6807\u4e0d\u5149\u4f1a\u5f71\u54cd\u670d\u52a1\u81ea\u8eab\uff0c\u4e5f\u4f1a\u5f71\u54cd Prometheus \u7684\u7a33\u5b9a\u6027\uff0c\u6240\u4ee5\u5728\u8f93\u51fa Metrics \u4fe1\u606f\u7684\u65f6\u5019\u4e00\u5b9a\u8981\u6ce8\u610f\uff0c\u5e94\u8be5\u9650\u5236\u7a0b\u5e8f Metrics \u6570\u91cf\uff0c\u52a0\u4e00\u4e2a\u9ed8\u8ba4\u7684\u4e0a\u9650\u6761\u4ef6\u3002 RESTful path \u5982\u4f55\u5904\u7406\uff1f \u65e0\u8bba\u662f\u5728 Metrics \u7cfb\u7edf\u4e2d\uff0c\u8fd8\u662f Trace \u7cfb\u7edf\u4e2d\uff0c\u90fd\u4f1a\u9047\u5230\u6b64\u7c7b\u95ee\u9898\u3002RESTful \u683c\u5f0f\u7684 path \u5728\u67d0\u4e00\u9636\u6bb5\u975e\u5e38\u6d41\u884c\uff0c\u7279\u522b\u662f\u5728 PC \u4e92\u8054\u7f51\u65f6\u4ee3\u975e\u5e38\u9002\u5408\u641c\u7d22\u5f15\u64ce\u7684 SEO\uff0c\u800c\u4e14\u770b\u8d77\u6765\u7f8e\u89c2\uff0c\u6240\u4ee5\u88ab\u5e7f\u6cdb\u4f7f\u7528\u3002 \u5982\u679c\u8bf4\u5728 Web \u5ba2\u6237\u7aef\u4f7f\u7528\u8fd8\u6709\u56e0\u53ef\u5faa\uff0c\u4f46\u5728\u5fae\u670d\u52a1\u67b6\u6784\u7684\u5185\u7f51\u4f7f\u7528\u5c31\u5b8c\u5168\u4e0d\u53ef\u7406\u89e3\u4e86\uff0c\u6bd5\u7adf\u5185\u7f51\u65e0\u6cd5\u88ab\u641c\u7d22\u5f15\u64ce\u641c\u7d22\u5230\u3002 \u6240\u4ee5\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u5982\u679c\u4f7f\u7528 HTTP \u534f\u8bae\u4f5c\u4e3a\u901a\u4fe1\u534f\u8bae\uff0c\u5efa\u8bae\u629b\u5f03 RESTful \u7684\u505a\u6cd5 \u3002","title":"\u7b2c\u4e5d\u8282 \u5229\u7528 Prometheus \u548c Grafana \u6536\u96c6\u76d1\u63a7\u6570\u636e"},{"location":"chap1/9chap1_monitor/#prometheus-grafana","text":"","title":"\u7b2c\u4e5d\u8282 \u5229\u7528 Prometheus \u548c Grafana \u6536\u96c6\u76d1\u63a7\u6570\u636e"},{"location":"chap1/9chap1_monitor/#1","text":"\u76d1\u63a7\u7cfb\u7edf\u901a\u5e38\u7531\u6307\u6807\u91c7\u96c6\u5b50\u7cfb\u7edf\u548c\u6570\u636e\u5904\u7406\u5b50\u7cfb\u7edf\u7ec4\u6210\u3002 \u6307\u6807\u91c7\u96c6\u5b50\u7cfb\u7edf\u4e3b\u8981\u8d1f\u8d23\u4fe1\u606f\u91c7\u96c6\u3001\u8fc7\u6ee4\u3001\u6c47\u603b\u548c\u5b58\u50a8\uff1b \u6570\u636e\u5904\u7406\u5b50\u7cfb\u7edf\u4e3b\u8981\u8d1f\u8d23\u6570\u636e\u5206\u6790\u3001\u5c55\u73b0\u3001\u9884\u8b66\u548c\u544a\u8b66\u7b49\u3002\u4f20\u7edf\u7684\u76d1\u63a7\u7cfb\u7edf\u4e00\u822c\u6709ELK \u548c Nagios & Zabbix\u3002","title":"1\u3001\u4f20\u7edf\u76d1\u63a7\u7cfb\u7edf"},{"location":"chap1/9chap1_monitor/#1-1-elk","text":"ELK \u662f Elastic \u516c\u53f8\u63a8\u51fa\u7684\u76d1\u63a7\u7cfb\u7edf\uff0c\u5305\u542b\u4e86 Elasticsearch\u3001Logstash \u548c Kibana\uff0c\u5206\u522b\u4f5c\u4e3a\u5b58\u50a8\u5f15\u64ce\u3001\u65e5\u5fd7\u6536\u96c6\u548c\u524d\u7aef\u5c55\u793a\u7cfb\u7edf\u3002 \u5176\u4e2dElasticsearch \u662f\u6838\u5fc3\uff0c\u5176\u4ed6\u4e24\u4e2a\u90fd\u53ef\u4ee5\u66ff\u6362\uff0c\u8f83\u5e38\u89c1\u7684\u66ff\u6362\u65b9\u6848\u662f Filebeat \u548c Graylog\u3002 Filebeat \u662f\u7531 Go \u8bed\u8a00\u7f16\u5199\u7684\u8f7b\u91cf\u7ea7\u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u3002\u65e5\u5fd7\u53ef\u4ee5\u76f4\u63a5\u4f20\u8f93\u5230 Elasticsearch \u4e2d\uff0c\u53ef\u4ee5\u4f20\u8f93\u5230 Logstash \u8fdb\u884c\u4e00\u4e9b\u6570\u636e\u5904\u7406\u3002 \u800cGraylog \u662f\u4e00\u5957\u4ee3\u66ff ELK \u7684\u65e5\u5fd7\u6536\u96c6\u5206\u6790\u7cfb\u7edf\uff0c\u5176\u4e2d\u4fdd\u7559\u4e86 Elasticsearch \u7684\u5b58\u50a8\u90e8\u5206\uff0c\u63d0\u4f9b\u4e86 collector-sidecar \u7528\u4e8e\u65e5\u5fd7\u6536\u96c6\uff0c\u5e76\u7ee7\u627f\u4e86 Web \u56fe\u5f62\u754c\u9762\uff0c\u7528\u4e8e\u641c\u7d22\u548c\u56fe\u5f62\u5316\u5c55\u793a\u3002 \u603b\u4f53\u6765\u8bf4\uff0cELK \u662f\u4e00\u5957\u4f20\u7edf\u7684\u53ef\u89c2\u6d4b\u6027\u7cfb\u7edf\uff0c\u4e3b\u8981\u5229\u7528\u6211\u4eec\u4e4b\u524d\u63d0\u5230\u7684\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\u4e4b\u4e00\u2014\u2014\u65e5\u5fd7\u6765\u63d0\u4f9b\u76d1\u63a7\u529f\u80fd\uff0c\u4f18\u70b9\u662f\u6570\u636e\u51c6\u786e\u6027\u9ad8\uff0c\u4f46\u7531\u4e8e\u65e5\u5fd7\u9700\u8981\u5b58\u50a8\u548c\u5efa\u7acb\u7d22\u5f15\uff0c\u6210\u672c\u4f1a\u6bd4\u8f83\u9ad8","title":"1-1 ELK"},{"location":"chap1/9chap1_monitor/#1-2-nagios-zabbix","text":"Nagios \u548c Zabbix \u90fd\u662f\u4f20\u7edf\u7684\u8fd0\u7ef4\u76d1\u63a7\u5de5\u5177\uff0c\u4e3b\u8981\u76d1\u63a7\u4e3b\u673a\u3001\u7f51\u7edc\uff0c\u4ee5\u53ca\u4e1a\u52a1\u8fdb\u7a0b\u7aef\u53e3\u7684\u4fe1\u606f\u548c\u72b6\u6001\u3002\u4e3b\u8981\u4ee5\u63d2\u4ef6\u7684\u65b9\u5f0f\u8fdb\u884c\u6269\u5c55\uff0c\u901a\u8fc7\u63d2\u4ef6\u6269\u5c55\u53ef\u4ee5\u68c0\u6d4b\u4e3b\u673a\u7684 CPU\u3001\u5185\u5b58\u3001\u786c\u76d8\u7b49\u4fe1\u606f\uff0c\u4e5f\u53ef\u4ee5\u68c0\u6d4b\u5404\u79cd\u4e0d\u540c\u7684\u7f51\u7edc\u534f\u8bae\uff0c \u4f46\u5bf9\u4e8e\u68c0\u6d4b\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u5185\u7684\u4fe1\u606f\u51e0\u4e4e\u662f\u65e0\u80fd\u4e3a\u529b\u7684 \u3002 \u5e94\u7528\u81ea\u8eab\u7684\u9ec4\u91d1\u6307\u6807\uff08\u5ef6\u65f6\u3001\u901a\u4fe1\u91cf\u3001\u9971\u548c\u5ea6\u3001\u9519\u8bef\u7387\uff09\u548c\u4e00\u4e9b\u4e1a\u52a1\u7ea7\u522b\u7684\u6307\u6807\u90fd\u9700\u8981\u5b9e\u65f6\u7684\u53ef\u89c2\u6d4b\u3002","title":"1-2 Nagios &amp; Zabbix"},{"location":"chap1/9chap1_monitor/#2-metrics","text":"Metrics \u4e3b\u8981\u662f\u7528\u65f6\u5e8f\u6027\u6570\u636e\u5e93\u8bb0\u5f55\u6bcf\u4e2a\u65f6\u95f4\u70b9\u7684\u76d1\u63a7\u6570\u636e\uff0c\u901a\u8fc7\u4e3b\u52a8\u62c9\u53d6\u6216\u8005\u7a0b\u5e8f\u4e0a\u62a5\u7684\u65b9\u5f0f\u8bb0\u5f55\uff0c\u7136\u540e\u5b9e\u65f6\u8ba1\u7b97\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e\uff0c\u5e76\u901a\u8fc7\u56fe\u5f62\u754c\u9762\u7684\u65b9\u5f0f\u5c55\u73b0\u51fa\u6765\u3002\u5b83\u7684\u7279\u70b9\u662f\u5b9e\u65f6\u6027\u5f3a\u3001\u53ef\u89c2\u6d4b\u6307\u6807\u4e30\u5bcc\uff0c\u9002\u5408\u67e5\u770b\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6307\u6807\u8d8b\u52bf\u3002","title":"2\u3001\u73b0\u4ee3\u5316\u5e38\u7528\u7684 Metrics \u7cfb\u7edf"},{"location":"chap1/9chap1_monitor/#2-1-statsdgraphite","text":"StatsD \u662f Node.js \u7f16\u5199\u7684\u4e00\u4e2aMetrics \u6307\u6807\u91c7\u96c6\u7cfb\u7edf\uff0c\u901a\u8fc7 UDP \u534f\u8bae\u5c06\u4fe1\u606f\u4f20\u8f93\u5230\u540e\u7aef\u7a0b\u5e8f\uff0c\u805a\u5408\u540e\u5b58\u50a8\u5230 Graphite\u3002 StatsD \u5305\u542b\u4e09\u4e2a\u7ec4\u6210\u90e8\u5206\uff0c\u5206\u522b\u662f\uff1a Client\uff0c\u5404\u79cd\u8bed\u8a00\u4f7f\u7528\u7684 SDK\uff0c\u7528\u4e8e\u5c06 Metrics \u4fe1\u606f\u901a\u8fc7 UDP \u7684\u65b9\u5f0f\u4f20\u9001\u5230 Server\u3002 Server\uff0c\u6536\u96c6\u5ba2\u6237\u7aef\u4f20\u8f93\u7684 Metrics \u4fe1\u606f\uff0c\u805a\u5408\u540e\u53d1\u9001\u5230 Backend\uff0c\u4e5f\u5c31\u662f Graphite\u3002 Backend\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684 Graphite\uff0cGraphite \u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u8d1f\u8d23\u5b58\u50a8 Metrics \u4fe1\u606f\u3002","title":"2-1 StatsD+Graphite"},{"location":"chap1/9chap1_monitor/#2-2-influxdbtelegraf","text":"InfluxDB \u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u8d1f\u8d23 Metrics \u4fe1\u606f\u7684\u5b58\u50a8 \uff1b Telegraf \u662f\u4e00\u5957 Metrics \u6536\u96c6\u7cfb\u7edf\uff0c\u9ed8\u8ba4\u81ea\u5e26\u975e\u5e38\u4e30\u5bcc\u7684\u63d2\u4ef6\uff0c\u7528\u4e8e\u91c7\u96c6\u7cfb\u7edf\u7ea7\u522b\u7684\u4fe1\u606f\uff0c\u5982\u679c\u8981\u91c7\u96c6\u5e94\u7528\u7ef4\u5ea6\u7684\u4fe1\u606f\uff0c\u5219\u9700\u8981\u7f16\u5199\u63d2\u4ef6\u3002","title":"2-2 InfluxDB+Telegraf"},{"location":"chap1/9chap1_monitor/#2-3-prometheus","text":"Prometheus \u662f Cloud Native Computing Foundation\uff08\u7b80\u79f0\uff1aCNCF\uff09\u751f\u6001\u5708\u7684\u4e00\u5458\uff0c\u4e5f\u662f\u6574\u4e2a Kubernetes \u751f\u6001\u4e2d\u91cd\u8981\u7684\u4e00\u73af\uff0c\u73b0\u5df2\u7ecf\u5e7f\u6cdb\u7528\u4e8e Kubernetes \u96c6\u7fa4\u76d1\u63a7\u4e2d\u3002 Prometheus \u4e0e\u4e0a\u9762\u7684\u4e24\u4e2a Metrics \u7cfb\u7edf\u6700\u5927\u7684\u4e0d\u540c\uff0c\u662f\u63d0\u4f9b\u4e86\u4e00\u6574\u5957\u5b8c\u6574\u7684\u76d1\u63a7\u544a\u8b66\u89e3\u51b3\u65b9\u6848\uff0c\u5305\u542b\u4e86\u6570\u636e\u91c7\u96c6\u3001\u6570\u636e\u5b58\u50a8\u548c\u544a\u8b66\u3002 \u53e6\u5916\u8fd8\u6709\u4e24\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u4e5f\u662f\u73b0\u4ee3\u5316\u76d1\u63a7\u7cfb\u7edf\u7684\u5fc5\u8981\u6807\u5fd7\uff1a \u91c7\u7528\u4e86 pull \u62c9\u53d6\u7684\u6a21\u578b\u91c7\u96c6\u6570\u636e\uff0c\u7b80\u5316\u4e86\u5ba2\u6237\u7aef\u7684\u4ee3\u7801\u7f16\u5199\u6210\u672c\uff0c\u5e76\u4e14 HTTP \u534f\u8bae\u975e\u5e38\u5229\u4e8e\u8c03\u8bd5\u3002 \u652f\u6301\u670d\u52a1\u53d1\u73b0\uff0c \u9ed8\u8ba4\u652f\u6301\u4e86 Consul \u548c Kubernetes \u539f\u751f\u53d1\u73b0\u7cfb\u7edf\uff0c\u907f\u514d\u4e86\u7e41\u6742\u7684\u673a\u5668\u4fe1\u606f\u914d\u7f6e \u3002","title":"2-3 Prometheus"},{"location":"chap1/9chap1_monitor/#3prometheus","text":"","title":"3\u3001Prometheus \u7ec4\u6210\u548c\u67b6\u6784"},{"location":"chap1/9chap1_monitor/#3-1-prometheus","text":"Prometheus Server \uff1a\u7528\u4e8e\u6536\u96c6\u548c\u5b58\u50a8 Metrics \u6570\u636e\u3002 Service Disvovery \uff1a\u7528\u4e8e\u670d\u52a1\u53d1\u73b0\uff0c\u83b7\u53d6\u670d\u52a1\u5bf9\u5e94\u7684 EndPoint \u7528\u4e8e\u6570\u636e\u91c7\u96c6\uff0c\u9ed8\u8ba4\u652f\u6301 DNS\u3001Consul\u3001Kubernestes \u7b49\u591a\u79cd\u53d1\u73b0\u65b9\u6848\u3002 PushGateway \uff1a\u63d0\u4f9b\u63a8\u9001\u7684\u65b9\u5f0f\u91c7\u96c6\u6570\u636e\uff0c\u4e3b\u8981\u7528\u4e8e Job \u7c7b\uff0cJob \u7c7b\u7a0b\u5e8f\u53ef\u80fd\u5b58\u6d3b\u65f6\u95f4\u6bd4\u8f83\u77ed\uff0c\u4e0d\u9002\u5408\u91c7\u7528\u62c9\u53d6\u7684\u65b9\u5f0f\u3002\u53e6\u5916\u4e00\u4e9b\u975e\u5e38\u9a7b\u8fdb\u7a0b\u7684\u811a\u672c\u8bed\u8a00\uff0c\u6bd4\u5982 PHP\uff0c\u4e5f\u9700\u8981\u4f7f\u7528\u6b64\u79cd\u65b9\u5f0f\u3002 Exporters \uff1a\u7528\u4e8e\u4e00\u4e9b\u7b2c\u4e09\u65b9\u670d\u52a1\uff0c\u901a\u8fc7\u8f6c\u6362\u63d0\u4f9b\u7b26\u5408 Prometheus \u89c4\u8303\u7684 Metrics \u4fe1\u606f\uff0c\u6bd4\u5982 Node Exporter \u63d0\u4f9b\u8282\u70b9\u76f8\u5173\u7684\u4fe1\u606f\u3002BlackBox \u65b9\u4fbf\u7528\u6237\u4f7f\u7528 HTTP\u3001TCP \u7b49\u65b9\u5f0f\u5bf9\u5e94\u7528\u8fdb\u7a0b\u63a2\u6d3b\uff0c\u4ee5\u76d1\u63a7\u5e94\u7528\u72b6\u6001\u3002 Client Library \uff1a\u4e3a\u5404\u79cd\u8bed\u8a00\u63d0\u4f9b\u7684\u5ba2\u6237\u7aef\u5e93\uff0c\u63d0\u4f9b HTTP \u670d\u52a1\u7684 Metrics \u63a5\u53e3\uff0c\u5f53 Prometheus Server \u62c9\u53d6\u65f6\uff0c\u63d0\u4f9b\u5b9e\u65f6\u7684 Metrics \u6570\u636e\u3002 Alertmanager \uff1a\u544a\u8b66\u7ba1\u7406\u5668\uff0c\u63a5\u6536 Prometheus Server \u53d1\u6765\u7684\u544a\u8b66\u4fe1\u606f\uff0c\u53bb\u9664\u91cd\u590d\u4fe1\u606f\uff0c\u5206\u7ec4\u540e\u53d1\u9001\u7ed9\u76f8\u5e94\u7684\u4eba\u5458\u3002\u901a\u77e5\u65b9\u5f0f\u652f\u6301 Email \u548c WebHook \u81ea\u5b9a\u4e49\u7b49\uff0c\u4e00\u822c\u4f1a\u901a\u8fc7 WebHook \u63a5\u5165\u9489\u9489\u6216\u8005\u4f01\u4e1a\u5fae\u4fe1\u4ee5\u8fbe\u5230\u5b9e\u65f6\u62a5\u8b66\u7684\u76ee\u7684\u3002","title":"3-1 Prometheus \u67b6\u6784\u6a21\u5757\u6784\u6210"},{"location":"chap1/9chap1_monitor/#3-2-prometheus","text":"negri_http_request_total{client=\"serviceA\",code=\"200\",exported_service=\"serviceB\",path=\"/ping\"} Metrics \u540d\u5b57\uff1a\u9996\u5148\u662f Metrics \u7684\u540d\u79f0\uff0cMetrics \u7684\u540d\u79f0\u8868\u660e\u4e86\u8fd9\u6761\u6570\u636e\u7684\u7528\u9014\uff0c\u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a\u6570\u636e\u662f Negri Sidecar \u7edf\u8ba1\u7684\u603b\u7684\u8bf7\u6c42\u6570\u91cf\u3002 Label \u6807\u7b7e\uff1a\u8fd9\u6761\u6570\u636e\u4e2d\u7684 client\u3001code\u3001 exported_service \u548c path \u90fd\u662f\u6807\u7b7e\uff0c\u901a\u8fc7\u6807\u7b7e\u53ef\u4ee5\u7ec4\u6210\u4e0d\u540c\u7684\u67e5\u8be2\u8bed\u53e5\uff0c\u4ece\u4e0d\u540c\u7ef4\u5ea6\u83b7\u53d6\u6570\u636e\u3002","title":"3-2 Prometheus \u6570\u636e\u6a21\u578b"},{"location":"chap1/9chap1_monitor/#3-3-prometheus-metrics","text":"","title":"3-3 Prometheus \u7684 Metrics \u7c7b\u578b"},{"location":"chap1/9chap1_monitor/#counter","text":"\u7d2f\u52a0\u503c\uff0c\u975e\u5e38\u9002\u5408\u7edf\u8ba1 QPS\u3002 \u8fd9\u4e2a\u6570\u636e\u4ece\u670d\u52a1\u5f00\u59cb\u5c31\u4e0d\u505c\u5730\u7d2f\u52a0\uff0c\u6bd4\u5982\u4e0a\u9762\u63d0\u5230\u7684 negri_http_request_total \u5c31\u662f\u4e00\u79cd Counter \u7c7b\u578b\u3002 \u5b83\u7edf\u8ba1\u4e86\u670d\u52a1\u542f\u52a8\u81f3\u76ee\u524d\u6240\u6709\u8bf7\u6c42\u7684\u6570\u636e\uff0c\u901a\u8fc7 rate \u6216\u8005 irate \u5c31\u53ef\u4ee5\u8ba1\u7b97\u51fa\u4e00\u6bb5\u65f6\u95f4\u5185\u7684 QPS\u3002 Counter \u7c7b\u578b\u662f Prometheus Server \u7aef\u8ba1\u7b97\u7684\uff0c\u76f8\u5bf9\u4e8e\u4e0b\u9762\u8bb2\u5230\u7684 Gauge\uff0c \u5360\u7528\u670d\u52a1\u81ea\u8eab\u66f4\u5c11 \uff0c\u5efa\u8bae\u9ad8\u6027\u80fd\u7684\u5fae\u670d\u52a1\u9996\u9009\u6b64\u79cd\u7c7b\u578b\u3002","title":"Counter"},{"location":"chap1/9chap1_monitor/#gauge","text":"\u9002\u5408\u8bb0\u5f55\u77ac\u65f6\u503c \uff0c \u6bd4\u5982\u7edf\u8ba1\u4e00\u4e9b\u7a81\u53d1\u4e8b\u4ef6\uff0c\u4f8b\u5982\u662f\u5426\u4ea7\u751f\u4e86\u7194\u65ad\u3001\u9650\u6d41\u7b49\u4e8b\u4ef6 \u3002 \u56e0\u4e3a\u662f\u5ba2\u6237\u7aef SDK \u8ba1\u7b97\u7684\uff0c\u4e0d\u592a\u9002\u5408\u4e00\u4e9b\u7ecf\u5e38\u53d8\u5316\u7684\u6570\u636e\u3002 \u5982\u679c\u6570\u636e\u662f\u4e00\u76f4\u589e\u52a0\u7684\uff0c\u5efa\u8bae\u4f7f\u7528 Counter \uff1b\u5f53\u7136\u5982\u679c\u6570\u636e\u6709\u589e\u6709\u51cf\uff0c\u4e5f\u6bd4\u8f83\u9002\u5408\uff0c\u56e0\u4e3a\u76d1\u63a7\u4e2d\u5f88\u5c11\u9047\u5230\u589e\u51cf\u6bd4\u8f83\u9891\u7e41\u7684\u6570\u636e\u3002 degrade_events{event=\"eventBreakerOpenStatus\",service=\"serviceB\"}","title":"Gauge"},{"location":"chap1/9chap1_monitor/#histogram","text":"\u67f1\u72b6\u56fe\uff0c\u9002\u5408\u7edf\u8ba1\u670d\u52a1\u7684 99 \u5ef6\u65f6\u7b49\u4fe1\u606f\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c31\u662f\u7528\u4e8e\u7edf\u8ba1\u670d\u52a1\u7684\u5ef6\u65f6\u72b6\u51b5\uff1a negri_http_response_time_us_bucket{client=\"serviceA\",exported_service=\"serviceB\",le=\"0.5\",path=\"/ping\"} \u5982\u4e0a\u8ff0\u5185\u5bb9\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2\u8bed\u53e5\u7ed8\u5236\u51fa 90 \u5ef6\u65f6\u300195 \u5ef6\u65f6\u300199 \u5ef6\u65f6\u7b49\u6307\u6807\uff0c Histogram \u548c Counter \u7c7b\u578b\u4e00\u6837\uff0c\u90fd\u662f Prometheus Server \u7aef\u8ba1\u7b97\u7684\uff0c \u6240\u4ee5\u975e\u5e38\u9002\u5408\u9ad8\u6027\u80fd\u7684\u573a\u666f\u4f7f\u7528 \uff0c\u76f8\u5bf9\u4e8e\u4e0b\u9762\u8bb2\u89e3\u7684 Summary \u6709\u66f4\u5c0f\u7684\u635f\u8017\u3002","title":"Histogram"},{"location":"chap1/9chap1_monitor/#summary","text":"\u7c7b\u4f3c\u4e8e Histogram\uff0c\u9002\u5408\u7edf\u8ba1\u670d\u52a1\u7684 99 \u5ef6\u65f6\u4fe1\u606f \u3002 Summary \u548c Gauge \u7c7b\u578b\u4e00\u6837\uff0c\u90fd\u662f\u5728\u7a0b\u5e8f\u5185\u8ba1\u7b97\u7684\uff0c\u6240\u4ee5\u5e76\u4e0d\u80fd\u50cf Histogram \u4e00\u6837\uff0c\u5728\u7ed8\u5236\u56fe\u5f62\u7684\u65f6\u5019\u7075\u6d3b\u7684\u8bbe\u7f6e\u767e\u5206\u4f4d\uff0c \u4f46\u76f8\u5bf9\u6765\u8bf4\uff0cSummary \u7684\u6570\u636e\u4e5f\u66f4\u52a0\u7cbe\u51c6 \u3002","title":"Summary"},{"location":"chap1/9chap1_monitor/#2-4-grafana","text":"Grafana \u662f\u4e00\u5957\u53ef\u89c6\u5316\u76d1\u63a7\u6307\u6807\u5de5\u5177\uff0c\u4e3b\u8981\u7528\u4e8e\u65f6\u5e8f\u6570\u636e\u7684\u5c55\u793a\uff0c\u5305\u62ec Graphite\u3001Elasticsearch\u3001InfluxDB\u3001Prometheus\u3001CloudWatch\u3001MySQL \u548c OpenTSDB\u3002\u8fd9\u4e9b\u6570\u636e\u6e90\u5927\u591a\u6570\u6211\u4eec\u5728\u524d\u9762\u505a\u8fc7\u4ecb\u7ecd\u3002\u5176\u4e2d\u6700\u5e38\u89c1\u7684\u5c31\u662f Prometheus+Grafana \u7684\u7ec4\u5408\u3002 \u901a\u8fc7 Grafana \u5c55\u793a\u670d\u52a1\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u5305\u62ec\u5e38\u89c1\u7684 QPS\u3001\u5ef6\u65f6\u7b49\u4fe1\u606f\u3002","title":"2-4 Grafana \u56fe\u5f62\u5316\u5c55\u793a"},{"location":"chap1/9chap1_monitor/#2-5","text":"","title":"2-5 \u5e38\u89c1\u95ee\u9898"},{"location":"chap1/9chap1_monitor/#prometheus","text":"Metrics \u6570\u636e\u76d1\u63a7\uff0c\u5e76\u4e0d\u9002\u5408\u8981\u6c42\u6570\u636e 100% \u51c6\u786e\u7684\u573a\u666f\uff0c \u66f4\u591a\u7684\u662f\u53cd\u6620\u4e00\u6bb5\u65f6\u95f4\u5185\u67d0\u4e2a\u6570\u636e\u6307\u6807\u7684\u8d8b\u52bf\u548c\u5927\u6982\u503c \u3002\u91c7\u96c6\u6570\u636e\u662f\u5b58\u5728\u95f4\u9694\u7684\uff0c\u8ba1\u7b97\u6570\u636e\u4e5f\u662f\u6709\u65f6\u95f4\u533a\u95f4\u7684\uff0c\u6240\u4ee5\u5f88\u96be\u53cd\u6620\u67d0\u4e00\u65f6\u523b\u7684\u51c6\u786e\u503c\uff0c\u6bd4\u5982 CPU \u7684\u5cf0\u503c\uff0c\u5927\u6982\u7387\u4f1a\u88ab\u5e73\u5747\u6389\u3002 \u5982\u679c\u8981\u67e5\u770b\u7cbe\u51c6\u6570\u636e\uff0c\u6700\u597d\u901a\u8fc7\u65e5\u5fd7\u7684\u65b9\u5f0f\u6536\u96c6\u540e\u68c0\u7d22\u67e5\u770b \u3002","title":"Prometheus \u9002\u5408\u4ec0\u4e48\u6837\u7684\u76d1\u63a7\u573a\u666f\uff1f"},{"location":"chap1/9chap1_monitor/#metrics","text":"Prometheus \u867d\u7136\u6027\u80fd\u5f3a\u5927\uff0c\u4f46\u5982\u679c\u65e0\u89c4\u8303\u7684\u4f7f\u7528\uff0c\u968f\u7740\u91c7\u96c6\u6570\u636e\u8282\u70b9\u589e\u591a\uff0c\u4f9d\u7136\u96be\u4ee5\u4fdd\u8bc1\u5176\u7a33\u5b9a\u6027\u3002\u6bd4\u5982\u4e00\u4e9b RESTful \u89c4\u8303\u7684 path\uff08\u6bd4\u5982 /test/123\uff0c\u5176\u4e2d 123 \u4e3a\u53d8\u91cf\uff09\uff0c\u5982\u679c\u4e0d\u91c7\u53d6\u4e00\u4e9b\u63aa\u65bd\u805a\u5408\uff0c\u4f1a\u9020\u6210 Metrics \u7206\u70b8\u3002Metrics \u7684\u7206\u70b8\u4e0d\u4ec5\u4f1a\u5bfc\u81f4\u670d\u52a1 OOM\uff0c\u4e5f\u4f1a\u5bfc\u81f4 Prometheus \u7684\u5185\u5b58\u4f7f\u7528\u91cf\u589e\u5927\u548c\u68c0\u7d22\u53d8\u6162\u3002 \u53e6\u5916\u8fc7\u591a\u7684\u6807\u7b7e\u53d8\u91cf\u3001\u8fc7\u591a\u7684 Histogram bucket\uff0c\u90fd\u4f1a\u5bfc\u81f4 Metrics \u6570\u91cf\u7684\u589e\u52a0\u3002\u6bd4\u5982\u4e0d\u5408\u7406\u5730\u8bb0\u5f55\u4e86\u8c03\u7528\u7aef\u7684\u6765\u6e90 IP\uff0c\u540c\u65f6\u4e5f\u8bb0\u5f55\u4e86\u670d\u52a1\u81ea\u8eab\u7684 IP\uff0c\u4e24\u8005\u7684 Metrics \u6570\u91cf\u5c31\u4f1a\u53d8\u6210\u4e58\u79ef\u5173\u7cfb\u3002\u8fd9\u4e9b\u4e0d\u5408\u7406\u7684\u6307\u6807\u4e0d\u5149\u4f1a\u5f71\u54cd\u670d\u52a1\u81ea\u8eab\uff0c\u4e5f\u4f1a\u5f71\u54cd Prometheus \u7684\u7a33\u5b9a\u6027\uff0c\u6240\u4ee5\u5728\u8f93\u51fa Metrics \u4fe1\u606f\u7684\u65f6\u5019\u4e00\u5b9a\u8981\u6ce8\u610f\uff0c\u5e94\u8be5\u9650\u5236\u7a0b\u5e8f Metrics \u6570\u91cf\uff0c\u52a0\u4e00\u4e2a\u9ed8\u8ba4\u7684\u4e0a\u9650\u6761\u4ef6\u3002","title":"\u5355\u4e2a\u670d\u52a1\u8282\u70b9 Metrics \u6570\u91cf\u9650\u5236"},{"location":"chap1/9chap1_monitor/#restful-path","text":"\u65e0\u8bba\u662f\u5728 Metrics \u7cfb\u7edf\u4e2d\uff0c\u8fd8\u662f Trace \u7cfb\u7edf\u4e2d\uff0c\u90fd\u4f1a\u9047\u5230\u6b64\u7c7b\u95ee\u9898\u3002RESTful \u683c\u5f0f\u7684 path \u5728\u67d0\u4e00\u9636\u6bb5\u975e\u5e38\u6d41\u884c\uff0c\u7279\u522b\u662f\u5728 PC \u4e92\u8054\u7f51\u65f6\u4ee3\u975e\u5e38\u9002\u5408\u641c\u7d22\u5f15\u64ce\u7684 SEO\uff0c\u800c\u4e14\u770b\u8d77\u6765\u7f8e\u89c2\uff0c\u6240\u4ee5\u88ab\u5e7f\u6cdb\u4f7f\u7528\u3002 \u5982\u679c\u8bf4\u5728 Web \u5ba2\u6237\u7aef\u4f7f\u7528\u8fd8\u6709\u56e0\u53ef\u5faa\uff0c\u4f46\u5728\u5fae\u670d\u52a1\u67b6\u6784\u7684\u5185\u7f51\u4f7f\u7528\u5c31\u5b8c\u5168\u4e0d\u53ef\u7406\u89e3\u4e86\uff0c\u6bd5\u7adf\u5185\u7f51\u65e0\u6cd5\u88ab\u641c\u7d22\u5f15\u64ce\u641c\u7d22\u5230\u3002 \u6240\u4ee5\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u5982\u679c\u4f7f\u7528 HTTP \u534f\u8bae\u4f5c\u4e3a\u901a\u4fe1\u534f\u8bae\uff0c\u5efa\u8bae\u629b\u5f03 RESTful \u7684\u505a\u6cd5 \u3002","title":"RESTful path \u5982\u4f55\u5904\u7406\uff1f"},{"location":"chap10/1istio_linked_consul/","text":"1 Istio vs. Linkerd vs. Consul\uff1a\u670d\u52a1\u7f51\u683c\u8be5\u600e\u4e48\u9009\u62e9 \uff1f 1 \u670d\u52a1\u7f51\u683c\u7b80\u4ecb \u670d\u52a1\u7f51\u683c\u662f\u5e94\u7528\u7a0b\u5e8f\u7ec4\u4ef6\u548c\u7f51\u7edc\u4e4b\u95f4\u901a\u8fc7\u4ee3\u7406\u8fde\u63a5\u7684\u57fa\u7840\u8bbe\u65bd\u5c42 \u3002\u8fd9\u4e9b\u5e94\u7528\u7a0b\u5e8f\u7ec4\u4ef6\u901a\u5e38\u662f\u5fae\u670d\u52a1\uff0c\u4f46\u4ece\u65e0\u670d\u52a1\u5668\u5bb9\u5668\u5230\u865a\u62df\u673a\u6216\u88f8\u673a\u4e0a\u7684\u4f20\u7edf\u5e94\u7528\u7a0b\u5e8f\u7684\u4efb\u4f55\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u53ef\u4ee5\u53c2\u4e0e\u670d\u52a1\u7f51\u683c\u3002\u6bcf\u4e2a\u7ec4\u4ef6\u4e4b\u95f4\u4e0d\u662f\u901a\u8fc7\u7f51\u7edc\u76f4\u63a5\u901a\u4fe1\uff0c\u800c\u662f\u901a\u8fc7\u4ee3\u7406\u6765\u901a\u4fe1\u3002\u8fd9\u4e9b\u4ee3\u7406\u6784\u6210\u4e86\u6570\u636e\u5e73\u9762\uff0c\u63d0\u4f9b\u4e86\u8bb8\u591a\u529f\u80fd\uff0c\u7528\u4e8e\u5b9e\u73b0\u5b89\u5168\u548c\u6d41\u91cf\u7b56\u7565\uff0c\u5e76\u5bf9\u4ee3\u7406\u90e8\u7f72\u7684\u670d\u52a1\u8fdb\u884c\u9065\u6d4b\u3002 \u670d\u52a1\u7f51\u683c\u7684\u529f\u80fd\u5305\u62ec\uff1a \u670d\u52a1\u53d1\u73b0 \u5f39\u6027\uff1a\u91cd\u8bd5\u3001\u5f02\u5e38\u68c0\u6d4b\u3001\u65ad\u8def\u3001\u8d85\u65f6\u7b49 \u5ba2\u6237\u7aef\u8d1f\u8f7d\u5e73\u8861 L7 \u7ec6\u7c92\u5ea6\u6d41\u91cf\u63a7\u5236\uff1a\u6309\u6807\u9898\u3001\u76ee\u7684\u5730\u6216\u6e90\u4ee5\u53ca\u5176\u4ed6\u8fd0\u884c\u65f6\u4fe1\u606f\u8fdb\u884c\u8def\u7531 \u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u8bbe\u7f6e\u5b89\u5168\u7b56\u7565\uff0c\u800c\u4e0d\u662f\u6bcf\u4e2a\u8fde\u63a5 \u57fa\u4e8e L7 \u5143\u6570\u636e\u7684\u8eab\u4efd\u9a8c\u8bc1\u3001\u901f\u7387\u9650\u5236\u3001\u4efb\u610f\u7b56\u7565 \u5f3a\uff08L7\uff09\u5de5\u4f5c\u8d1f\u8f7d\u6807\u8bc6 \u670d\u52a1\u5230\u670d\u52a1\u6388\u6743 \u6307\u6807\u3001\u65e5\u5fd7\u548c\u8ddf\u8e2a \u901a\u8fc7\u5bf9\u6bd4\u663e\u793a\uff0cIstio \u662f\u6700\u6709\u80fd\u529b\u3001\u6700\u7075\u6d3b\u3001\u5e94\u7528\u6700\u5e7f\u6cdb\u7684\u670d\u52a1\u7f51\u683c\uff0c\u4e5f\u662f\u6700\u53d7\u793e\u533a\u652f\u6301\u7684\u670d\u52a1\u7f51\u683c \u3002 \u56e0\u6b64\uff0cIstio \u5728\u5404\u4e2a\u9886\u57df\u90fd\u5728\u7a33\u6b65\u6539\u8fdb\u3002Consul \u548c Linkerd \u5c5e\u4e8e\u8f7b\u91cf\u7ea7\u8bbe\u8ba1\uff0c\u793e\u533a\u5e76\u4e0d\u5e7f\u6cdb\u652f\u6301\u3002\u56e0\u6b64\uff0c\u5b83\u4eec\u5728\u6700\u521d\u53ef\u80fd\u66f4\u5bb9\u6613\u5b9e\u73b0\uff0c\u5e76\u4e14\u5728\u8fc7\u53bb\u5177\u6709\u6027\u80fd\u4f18\u52bf\uff0c\u4f46\u5b83\u4eec\u53ef\u80fd\u4e0d\u592a\u9002\u5408\u8981\u6c42\u82db\u523b\u7684\u7528\u4f8b\u548c\u957f\u671f\u4f7f\u7528\u3002 2 \u670d\u52a1\u7f51\u683c\u7684\u5de5\u4f5c\u6a21\u578b \u670d\u52a1\u7f51\u683c\u9075\u5faa\u201c\u4e2d\u5fc3\u8f90\u5c04\u201d\u6a21\u5f0f\uff0c\u5373\u4f7f\u7528\u4ee3\u7406\u6216\u5de5\u4f5c\u8282\u70b9\u5b9e\u73b0\u7279\u5b9a\u89c4\u5219\uff0c\u5e76\u4f7f\u7528\u4e2d\u592e\u670d\u52a1\u5668\u7ba1\u7406\u4ee3\u7406\u3002 Istio \u548c Consul \u4f7f\u7528 Envoy \u4ee3\u7406\uff0c\u800c Linkerd \u4f7f\u7528\u5176\u5b9a\u5236\u7684\u4ee3\u7406\u3002\u8fd9\u4e9b\u4ee3\u7406\u5728\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u6570\u636e\u5e73\u9762\u4e2d\u5de5\u4f5c \u3002 \u4ed6\u4eec\u8d1f\u8d23\u7e41\u91cd\u7684\u4efb\u52a1\uff0c\u5982\u5904\u7406\u4f20\u5165\u6d41\u91cf\u3001\u8fde\u63a5\u670d\u52a1\u548c\u7ec6\u7c92\u5ea6\u5b89\u5168\u7b56\u7565\u3002\u7f51\u7edc\u901a\u4fe1\u548c\u5b89\u5168\u7ba1\u7406\u5728\u96c6\u4e2d\u63a7\u5236\u5e73\u9762\u5b8c\u6210 3 \u670d\u52a1\u7f51\u683c\u6bd4\u8f83 \u5b9e\u73b0\u670d\u52a1\u7f51\u683c\u6700\u8457\u540d\u7684\u5f00\u6e90\u5de5\u5177\u6709\uff1aIstio\u3001Linkerd \u548c Consul\u3002 Istio \u548c Consul \u90fd\u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u4ee3\u7406\u3002Linkerd \u6709\u81ea\u5df1\u7684\u5f00\u6e90\u4ee3\u7406 \u3002\u6211\u4eec\u5c06\u5728\u672c\u6587\u4e2d\u6bd4\u8f83\u8fd9\u4e09\u4e2a\u8457\u540d\u7684\u670d\u52a1\u7f51\u683c\u9879\u76ee\u3002 \u6211\u4eec\u57fa\u4e8e\u4ee5\u4e0b\u516d\u4e2a\u6807\u51c6\u6bd4\u8f83\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\uff1a\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u7ba1\u7406\u3001\u53ef\u4f38\u7f29\u6027\u3001\u53ef\u89c1\u6027\u548c\u53ef\u89c2\u5bdf\u6027\u3001\u5b89\u88c5\u548c\u5b9e\u73b0\u3001\u53ef\u6269\u5c55\u6027\u3002\u5e76\u5206\u4eab\u4e86\u6211\u4eec\u7684\u89c2\u70b9\u3002 \u6d41\u91cf\u7ba1\u7406 Istio\u3001Consul \u548c Linkerd \u90fd\u63d0\u4f9b\u57fa\u672c\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff0c\u5982\u8d1f\u8f7d\u5e73\u8861\u3001\u8def\u7531\u548c\u670d\u52a1\u53d1\u73b0\uff0c\u5e76\u4e14\u652f\u6301 HTTP\u3001gRPC \u4ee3\u7406\u3001TCP \u4ee3\u7406\u548c\u534f\u8bae\u68c0\u6d4b\u3002 Istio \u548c Consul \u4f7f\u7528\u7684 Envoy \u4ee3\u7406\u5b9e\u73b0\u4e86\u6bd4 Linkerd \u66f4\u591a\u7684 HTTP \u7279\u5b9a\u529f\u80fd\u3002 Envoy \u7684 HTTP connection manager \u63d0\u4f9b\u4e86\u5bf9 HTTP/1.1\u3001WebSocket\u3001HTTP/2 \u548c HTTP/3 \u7684\u652f\u6301\uff0c\u800c Linkerd \u6682\u4e0d\u652f\u6301HTTP/3\u3002 \u76f8\u8f83\u4e8e Linkerd\uff0c\u56e0\u4e3a Istio \u548c Consul \u90fd\u4f7f\u7528\u4e86 Envoy\uff0c \u5b83\u4eec\u8fd8\u5177\u6709\u66f4\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff0c\u5982\u65ad\u8def\u3001\u91cd\u8bd5\u3001\u8d85\u65f6\u3001\u6545\u969c\u6ce8\u5165\u3001\u5ef6\u8fdf\u6ce8\u5165\u7b49\u529f\u80fd \u3002 Istio \u662f\u552f\u4e00\u4e00\u6b3e\u652f\u6301 Kubernetes \u7684\u8f6f\u4ef6\u3002 \u65e0\u8bba\u662f\u90e8\u7f72\u5728\u516c\u6709\u4e91\uff08\u4f8b\u5982 AWS\u3001GCP\u3001Azure\uff09\u7684 Kubernetes \u8fd8\u662f\u79c1\u6709\u4e91\u7684 Kubernetes\uff0c\u8fd9\u4f7f\u5f97 Istio \u6210\u4e3a\u8bb8\u591a\u5927\u578b\u4f01\u4e1a\u7684\u9996\u9009\u8f6f\u4ef6\uff0c\u56e0\u4e3a\u5927\u578b\u4f01\u4e1a\u65e2\u6709\u652f\u6301\u4e91\u539f\u751f\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e5f\u6709\u8bb8\u591a\u5355\u4f53\u5e94\u7528\u7a0b\u5e8f\u3002 \u67b6\u6784\u5e08\u548c\u5de5\u7a0b\u5e08\u559c\u6b22 Istio \u7684\u7406\u7531\uff1a \u524d\u7aef/\u8fb9\u7f18\u4ee3\u7406\uff1aIstio \u53ef\u4ee5\u6839\u636e\u8fd0\u884c\u65f6\u7684\u503c\u91cd\u5b9a\u5411\u8bf7\u6c42\uff0c\u4f7f\u91d1\u4e1d\u96c0\u548c\u84dd/\u7eff\u7b49\u90e8\u7f72\u7b56\u7565\u7684\u5b9e\u73b0\u53d8\u5f97\u5bb9\u6613\u3002 \u652f\u6301\u5165\u53e3\u7f51\u5173\uff1aIstio \u63d0\u4f9b Istio \u5165\u53e3\u7f51\u5173\uff0c\u5e76\u652f\u6301\u7b2c\u4e09\u65b9 ingress controllers \u7ba1\u7406 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u3002 \u591a\u96c6\u7fa4\u901a\u4fe1\uff1a\u6613\u4e8e\u4f7f\u7528 Istio \u670d\u52a1\u7f51\u683c\u8fde\u63a5\u8de8\u96c6\u7fa4\u6216\u533a\u57df\u7684 Kubernetes \u670d\u52a1\u3002 \u591a\u7ad9\u70b9\u6545\u969c\u5207\u6362\uff1a\u7531\u4e8e\u652f\u6301\u6240\u6709\u516c\u5171\u4e91\uff0cIstio \u53ef\u7528\u4e8e\u81ea\u52a8\u6545\u969c\u5207\u6362\uff0c\u4ee5\u652f\u6301\u57fa\u4e8e\u4e91\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u9ad8\u53ef\u7528\u6027\u548c\u66f4\u5927\u7684\u5f39\u6027\u3002 \u5b89\u5168\u7ba1\u7406 Istio\u3001Consul \u548c Linkerd \u90fd\u652f\u6301\u8eab\u4efd\u9a8c\u8bc1\u548c\u6388\u6743\u529f\u80fd\uff0c\u4f8b\u5982\uff1a \u57fa\u4e8e mTLS \u7684\u8eab\u4efd\u9a8c\u8bc1\uff0c\u786e\u4fdd\u7f51\u7edc\u901a\u4fe1\u7684\u5b89\u5168\u6027 \u57fa\u4e8e JWT \u7684\u8eab\u4efd\u9a8c\u8bc1\u53ef\u4fdd\u62a4\u6765\u81ea\u5916\u90e8\u548c\u5185\u90e8\u7528\u6237\u7684\u5e94\u7528\u7a0b\u5e8f \u5b9a\u4e49\u7ec6\u7c92\u5ea6\u7684\u5b89\u5168\u7b56\u7565\uff0c\u4f8b\u5982\u5de5\u4f5c\u8d1f\u8f7d\u5230\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6700\u7ec8\u7528\u6237\u5230\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6388\u6743\u548c\u8bbf\u95ee\u63a7\u5236 \u7136\u800c\uff0c \u7531\u4e8e Istio \u63d0\u4f9b\u4e86\u4e0e\u4e91\u5e73\u53f0\u548c\u865a\u62df\u673a\u7684\u96c6\u6210\uff0c\u53ef\u4ee5\u4f7f\u7528 Istio \u7684 mTLS\u7684\u8eab\u4efd\u9a8c\u8bc1\uff0c\u6784\u5efa\u5e94\u7528\u4e0e\u5916\u90e8\u5ba2\u6237\u673a\u6216\u5176\u4ed6 Kubernetes \u96c6\u7fa4\u6216\u865a\u62df\u673a\u4e4b\u95f4\u7684\u901a\u4fe1 \u3002\u4ee5\u4e0b\u662f\u4e3a\u4ec0\u4e48\u5b89\u5168\u7ecf\u7406\u66f4\u559c\u6b22 Istio \u4ee5\u786e\u4fdd\u96f6\u4fe1\u4efb\u5b89\u5168\u6a21\u578b\u7684\u539f\u56e0\uff1a FIPS \u517c\u5bb9\uff1aIstio \u7684\u8bb8\u591a\u5b9e\u73b0\u90fd\u662f FIPS \u517c\u5bb9\u7684\uff0c\u5c5e\u4e8e FIPS \u9075\u5b88\u7684\u4e2d\u7b49\u6c34\u5e73\uff0c\u800c Tetrate \u7684\u5b9e\u73b0\u4e5f\u662f FIPS \u8ba4\u8bc1\u7684\uff0c\u4e14\u5c5e\u4e8e FIPS \u7684\u6700\u9ad8\u6c34\u5e73\u3002\u8fd9\u4f7f\u5f97 Istio \u6210\u4e3a\u9075\u5b88 2014\u5e74\u300a\u8054\u90a6\u4fe1\u606f\u5b89\u5168\u73b0\u4ee3\u5316\u6cd5\u6848\u300b\u7684\u7ec4\u7ec7\u7684\u6700\u4f73\u9009\u62e9\u3002 CVEs \u7684\u900f\u660e\u5ea6\uff1aIstio \u4e0e\u56fd\u5bb6 CVE \u6570\u636e\u5e93\u5171\u4eab\u6f0f\u6d1e\uff0c\u7f51\u7edc\u5b89\u5168\u7ba1\u7406\u4eba\u5458\u53ef\u4ee5\u76f4\u63a5\u53c2\u8003\u56fd\u5bb6 CVE \u6570\u636e\u5e93\u4e2d\u7684\u6700\u65b0\u5b89\u5168\u7f3a\u9677\u548c\u95ee\u9898\uff0c\u5df2\u77e5\u6653 Istio \u5b58\u5728\u7684\u5b89\u5168\u95ee\u9898\u3002\u6b64\u5916\uff0cIstio \u4f1a\u53ca\u65f6\u5b9e\u65bd\u5b89\u5168\u8865\u4e01\uff0c\u5e76\u53ca\u65f6\u901a\u77e5 Istio \u7528\u6237\u3002 \u7075\u6d3b\u6027\uff1aIstio \u53ef\u4ee5\u548c\u4efb\u4f55\u7684\u8eab\u4efd\u9a8c\u8bc1\u63d0\u4f9b\u5546\u96c6\u6210\uff0c\u5982 OpenID \u8fde\u63a5\u63d0\u4f9b\u5546\uff0c\u4f8b\u5982 KeyClope\u3001OAuth 2.0\u3001Google Auth\u3001Firebase Auth\u7b49\u3002 \u7f8e\u56fd\u56fd\u5bb6\u6807\u51c6\u4e0e\u6280\u672f\u7814\u7a76\u6240\uff08NIST\uff09\u4f7f\u7528 Istio \u4f5c\u4e3a\u53c2\u8003\u67b6\u6784\uff0c\u4e3a\u8054\u90a6\u673a\u6784\u5b9e\u65bd\u5b89\u5168\u6807\u51c6\uff0c\u5b9e\u73b0\u96f6\u4fe1\u4efb\u3002 \u5b89\u88c5\u548c\u4f7f\u7528 \u65e0\u9700\u66f4\u6539\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\uff0c\u5c31\u53ef\u4ee5\u5b89\u88c5\u548c\u4f7f\u7528\u670d\u52a1\u7f51\u683c\u3002\u4f46\u4e00\u822c\u6765\u8bf4\uff0c\u670d\u52a1\u7f51\u683c\u7684\u8bbe\u7f6e\u548c\u7ef4\u62a4\u662f\u4e00\u4e2a\u96be\u9898\u3002\u5e76\u4e14\u8fd0\u7ef4\u56e2\u961f\u7279\u522b\u5173\u6ce8\u8f6f\u4ef6\u7684\u5b89\u88c5\u3001\u4f7f\u7528\u548c\u6027\u80fd\u95ee\u9898\u3002 Istio\u3001Consul \u548c Linkerd \u90fd\u53ef\u4ee5\u4f7f\u7528 Helm charts \u6216 Operators \u5728 Kubernetes \u73af\u5883\u4e2d\u8f7b\u677e\u5b8c\u6210\u5b89\u88c5\u3002 \u7531\u4e8e Linkerd \u662f\u8f7b\u91cf\u7ea7\u7684\uff0c\u5177\u6709\u8f83\u5c11\u7684\u529f\u80fd\u548c\u7b80\u5355\u7684\u67b6\u6784\uff0c\u56e0\u6b64\u5b83\u6bd4 Istio \u548c Consul \u66f4\u6613\u4e8e\u7ef4\u62a4\u548c\u6267\u884c \u3002 Istio \u901a\u5e38\u88ab\u8ba4\u4e3a\u662f\u201c\u91cd\u91cf\u7ea7\u201d\u7684\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u5b83\u652f\u6301\u66f4\u591a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3001\u516c\u5171\u4e91\u548c\u865a\u62df\u673a\u3002 \u4f46\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0cIstio \u5df2\u7ecf\u63d0\u9ad8\u4e86\u6027\u80fd\uff0c\u5e76\u52aa\u529b\u4ee5\u6700\u5c0f\u7684\u8d44\u6e90\u5f00\u9500\u63d0\u4f9b\u66f4\u591a\u7684\u7f51\u7edc\u7ba1\u7406\u548c\u5b89\u5168\u4f18\u52bf\u3002\u8be5\u9879\u76ee\u8fd8\u65e8\u5728\u652f\u6301\u5177\u6709\u9ad8\u8bf7\u6c42\u7387\u7684\u5927\u578b\u670d\u52a1\u7f51\u683c\uff0c\u540c\u65f6\u589e\u52a0\u6700\u5c0f\u5ef6\u8fdf\u3002 \u53ef\u4f38\u7f29\u6027 \u5728\u6309\u9700\u6269\u5c55\u65b9\u9762\uff0c\u6bcf\u79cd\u670d\u52a1\u7f51\u683c\u90fd\u5177\u6709\u72ec\u7279\u7684\u4f18\u52bf\u3002 \u5173\u4e8e\u6570\u636e\u5e73\u9762\u7684\u53ef\u6269\u5c55\u6027\uff0cLinkerd \u7684\u6269\u5c55\u901f\u5ea6\u6bd4 Istio \u548c Consul \u5feb \u3002\u4e3b\u8981\u539f\u56e0\u662f Linkerd \u7684\u8f7b\u91cf\u7ea7\u67b6\u6784\uff0c\u5b83\u4e0d\u652f\u6301\u9ad8\u7ea7\u6d41\u91cf\u7ba1\u7406\u548c\u7ec6\u7c92\u5ea6\u5b89\u5168\u7ba1\u7406\u529f\u80fd\u3002 \u4ece\u6570\u636e\u5e73\u9762\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5728\u8d44\u6e90\u53d7\u9650\u7684\u73af\u5883\u4e2d\uff0cEnvoy \u53ef\u80fd\u4f1a\u6bd4 Linkerd \u6d88\u8017\u66f4\u591a\u7684 CPU \u3002\u7136\u800c\uff0cEnvoy \u9075\u5faa\u4e00\u79cd\u5b9e\u7528\u7684\u8bbe\u8ba1\uff0c\u9002\u5408\u5728\u771f\u5b9e\u7684 IT \u73af\u5883\u4e2d\u5b9e\u73b0\u66f4\u5feb\u7684\u6027\u80fd\u3002 Envoy \u7684\u7ef4\u62a4\u4eba\u5458\u5728\u5173\u952e\u8def\u5f84\u7684\u4ee3\u7406\u6027\u80fd\u8c03\u4f18\u65b9\u9762\u505a\u4e86\u51fa\u8272\u7684\u5de5\u4f5c\u3002\u6027\u80fd\u5c06\u56e0\u6240\u4f7f\u7528\u7684\u529f\u80fd\u3001Envoy \u8fd0\u884c\u7684\u73af\u5883\u548c\u53ef\u7528\u7684\u8ba1\u7b97\u673a\u8d44\u6e90\u800c\u5927\u4e0d\u76f8\u540c \u3002 \u6b64\u5916\uff0c\u8bf7\u6ce8\u610f\uff0c\u6027\u80fd\u4ec5\u505a\u4e86\u6a2a\u5411\u5bf9\u6bd4\u3002\u5982\u679c\u6b64\u8f6f\u4ef6\u4e0d\u80fd\u6ee1\u8db3\u4f60\u7684\u6240\u6709\u9700\u6c42\uff0c\u4e5f\u4e0d\u80fd\u8fbe\u5230\u4e0e\u7ade\u4e89\u5bf9\u624b\u76f8\u540c\u7684\u6027\u80fd\u6807\u51c6\uff0c\u90a3\u4e48\u5b83\u5c31\u4e0d\u4f1a\u4ee5\u4e00\u79cd\u6709\u7528\u7684\u65b9\u5f0f\u66f4\u5feb\u6216\u66f4\u8f7b\u3002\u5982\u679c\u4f60\u7684\u7528\u4f8b\uff08\u73b0\u5728\u548c\u5c06\u6765\uff09\u5b8c\u5168\u7531\u5176\u529f\u80fd\u96c6\u6ee1\u8db3\uff0c\u90a3\u4e48\u4f60\u53ea\u80fd\u8003\u8651\u91cd\u91cf\u66f4\u8f7b\u3001\u529f\u80fd\u66f4\u5c11\u7684\u66ff\u4ee3\u65b9\u6848\u3002\u5728\u4f01\u4e1a\u5b9e\u65bd\u6216\u6280\u672f\u8981\u6c42\u82db\u523b\u7684\u73af\u5883\u4e2d\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0d\u592a\u53ef\u80fd\u53d1\u751f\u3002 \u540c\u65f6\uff0c\u8bf7\u6ce8\u610f\uff0c\u9700\u5728\u7c7b\u4f3c\u4ea7\u54c1\u7684\u57fa\u7840\u4e0a\u505a\u6027\u80fd\u6bd4\u8f83\u3002 \u4e00\u6b3e\u8f6f\u4ef6\u4e0d\u53ef\u80fd\u65e2\u8f7b\u91cf\u7ea7\u3001\u6027\u80fd\u9ad8\u4e14\u529f\u80fd\u5168\u3002 Istio \u8d1f\u8f7d\u6d4b\u8bd5\uff0c\u8003\u8651\u4e86\u7531 1000 \u4e2a\u5fae\u670d\u52a1\u548c 2000 \u4e2a sidecars \u7ec4\u6210\u7684\u670d\u52a1\u7f51\u683c\u3002\u6bcf\u79d2\u5411\u7f51\u683c\u53d1\u9001 70000 \u4e2a\u8bf7\u6c42\uff0c\u5e76\u6d4b\u91cf\u54cd\u5e94\u65f6\u95f4\u3002\u4f7f\u7528 Istio 1.14.1 \u8fd0\u884c\u6d4b\u8bd5\u540e\uff0c\u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762\u7684\u89c2\u5bdf\u7ed3\u679c\u5982\u4e0b\uff1a \u6570\u636e\u5e73\u9762\u6027\u80fd\uff1aEnvoy \u4ee3\u7406\u6bcf\u79d2\u5904\u7406 1000 \u4e2a\u8bf7\u6c42\uff0c\u4f7f\u7528\u4e86 0.35 \u4e2a vCPU \u548c 40 MB \u5185\u5b58\u3002\u8fd8\u89c2\u5bdf\u5230 Envoy \u4ee3\u7406\uff0c\u540e 10% \u7684\u8bf7\u6c42\u5ef6\u8fdf\u589e\u52a0\u4e86 2.65\u6beb\u79d2\u3002 \u63a7\u5236\u5e73\u9762\u6027\u80fd\uff1aIstiod \u4f7f\u7528 1 \u4e2a vCPU \u548c 1.5 GB \u5185\u5b58\u3002 \u53ef\u89c1\u6027\u548c\u53ef\u89c2\u6d4b\u6027 \u5206\u5e03\u5f0f\u670d\u52a1\u7684\u7aef\u5230\u7aef\u53ef\u89c1\u6027\u548c\u53ef\u89c2\u5bdf\u6027\u5bf9\u4e8e\u8fd0\u7ef4\u56e2\u961f\u6765\u8bf4\u81f3\u5173\u91cd\u8981\u3002SRE \u548c Ops \u56e2\u961f\u9700\u8981\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u7ea7\u522b\u53ef\u89c1\u6027\u3001\u8ddf\u8e2a\u548c\u76d1\u63a7\u80fd\u529b\u3002 Istio\u3001Consul \u548c Linkerd \u90fd\u63d0\u4f9b\u4e86\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u5065\u5eb7\u72b6\u51b5\u7684\u53ef\u89c1\u6027\uff0c\u6d4b\u91cf\u7f51\u7edc\u884c\u4e3a\u5e76\u5411\u5229\u76ca\u76f8\u5173\u8005\u51fa\u5177\u62a5\u544a\u3002 Istio\u3001Consul \u548c Linkerd \u751f\u6210\u76d1\u63a7\u6240\u9700\u7684\u5173\u952e\u6307\u6807\uff0c\u5982 HTTP\u3001HTTP/2 \u548c gRPC \u6d41\u91cf\u7684\u5ef6\u8fdf\u3001\u9519\u8bef\u548c\u9971\u548c\u5ea6\u3002\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\u63d0\u4f9b\u7684\u6307\u6807\u53ef\u4ee5\u76f4\u63a5\u4ece\u547d\u4ee4\u884c\u754c\u9762\uff08CLI\uff09\u6216 Grafana \u4eea\u8868\u677f\u67e5\u770b\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Prometheus \u6765\u67e5\u770b\u3002 \u4e0e Linkerd \u76f8\u6bd4\uff0cIstio \u548c Consul \u90fd\u63d0\u4f9b\u4e86\u66f4\u8be6\u7ec6\u7684\u7f51\u7edc\u6307\u6807\u3002 Envoy \u4ee3\u7406\u5728 Istio \u548c Consul \u4e2d\u5f62\u6210\u6570\u636e\u5e73\u9762\uff0c\u4e3a Ops \u56e2\u961f\u63d0\u4f9b\u8db3\u591f\u7684\u670d\u52a1\u7ea7\u522b\u6307\u6807\u3001\u4ee3\u7406\u7ea7\u522b\u6307\u6807\u548c\u5206\u5e03\u5f0f\u8ddf\u8e2a\uff0c\u66f4\u5feb\u5730\u8bca\u65ad\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e\u95ee\u9898\u3002\u7531\u4e8e Envoy \u4e5f\u662f\u4e00\u4e2a\u5e7f\u6cdb\u4f7f\u7528\u7684\u6570\u636e\u5e73\u9762\uff0cOps \u56e2\u961f\u66f4\u5bb9\u6613\u4ece\u793e\u533a\u4e2d\u627e\u5230\u914d\u7f6e\u6216\u6027\u80fd\u5f02\u5e38\u7684\u89e3\u51b3\u65b9\u6848\u3002 \u4eba\u6c14 Istio \u662f\u793e\u533a\u5185\u5916\u6700\u6d41\u884c\u7684\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\u3002\u8fd9\u610f\u5473\u7740\u66f4\u591a\u7684\u521b\u65b0\u548c\u66f4\u79ef\u6781\u7684\u529f\u80fd\u5f00\u53d1\u3002\u6709\u8bc1\u636e\u8868\u660e\uff0c\u4e0e\u4efb\u4f55\u5176\u4ed6\u670d\u52a1\u7f51\u683c\u76f8\u6bd4\uff0cIstio \u662f\u5168\u7403\u67b6\u6784\u5e08\u3001DevOps \u56e2\u961f\u548c\u5b89\u5168\u4e13\u4e1a\u4eba\u5458\u6700\u5e7f\u6cdb\u4f7f\u7528\u7684\u3002\u867d\u7136\u4f7f\u7528\u60c5\u51b5\u53ef\u80fd\u56e0\u884c\u4e1a\u6709\u6240\u4e0d\u540c\uff0c\u4f46 Istio \u76ee\u524d\u5df2\u5728\u91d1\u878d\u670d\u52a1\u884c\u4e1a\u548c\u7f8e\u56fd\u653f\u5e9c\u4f7f\u7528\uff0c\u5e76\u5728\u5173\u952e\u9886\u57df\u53d6\u5f97\u6210\u529f\u3002\u56e0\u6b64\uff0cIstio \u53ef\u80fd\u4f1a\u5168\u9762\u4fdd\u6301\u6216\u589e\u52a0\u5176\u9886\u5bfc\u5730\u4f4d 1\u3001\u8c37\u6b4c\u8d8b\u52bf\uff08Google Trending\uff09 2\u3001\u8d21\u732e\u8005\u7684\u591a\u6837\u6027 4\u3001\u6350\u6b3e\u7ba1\u7406 \u53ef\u6269\u5c55\u6027 \u6240\u6709\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\u90fd\u662f\u6a21\u5757\u5316\u548c\u53ef\u6269\u5c55\u7684\u3002\u4f46\u7531\u4e8e Istio \u6bd4\u5176\u4ed6\u670d\u52a1\u7f51\u683c\u66f4\u53d7\u6b22\u8fce\uff0c\u8bb8\u591a\u5f00\u6e90\u9879\u76ee\u90fd\u662f\u901a\u8fc7 Istio \u5b9e\u73b0\u7684\u3002\u4e00\u4e9b\u503c\u5f97\u6ce8\u610f\u7684\u9879\u76ee\u5305\u62ec\uff1a Slime\uff0c\u4f7f\u7528 Istio \u548c Envoy \u7684\u667a\u80fd\u670d\u52a1\u7ba1\u7406\u5668 MOSN\uff0c\u63d0\u4f9b\u4e91\u672c\u5730\u8fb9\u7f18\u7f51\u5173\u548c\u4ee3\u7406 Aeraki\uff0c\u4e3a\u9664 HTTPs \u548c gRPC \u4e4b\u5916\u7684\u6240\u6709 L7 \u534f\u8bae\u63d0\u4f9b\u652f\u6301 WASM\uff0c\u5f00\u53d1 WebAssembly \u63d2\u4ef6\u5e76\u589e\u5f3a\u670d\u52a1\u7f51\u683c\u529f\u80fd \u603b\u7ed3 \u5728\u4ed4\u7ec6\u8bc4\u4f30\u4e86\u4e09\u79cd\u6d41\u884c\u7684\u670d\u52a1\u7f51\u683c\u7684\u5404\u79cd\u529f\u80fd\u540e\uff0c\u6211\u4eec\u8ba4\u4e3a Istio \u63d0\u4f9b\u4e86\u6bd4\u5176\u540c\u7c7b\u4ea7\u54c1\u66f4\u4e30\u5bcc\u7684\u529f\u80fd\u96c6\u3002 \u5982\u679c\u4f60\u662f\u4e00\u4e2a\u5c0f\u578b\u7684 IT \u521d\u521b\u516c\u53f8\uff0c\u53ea\u6709\u4e00\u4e2a\u5c0f\u578b\u7684 DevOps \u548c\u5b89\u5168\u56e2\u961f\uff0c\u5e76\u4e14\u6ca1\u6709\u5728\u4e00\u4e2a\u7279\u522b\u5177\u6709\u6311\u6218\u6027\u7684\u5b89\u5168\u73af\u5883\u4e2d\u8fd0\u884c\uff0c\u800c\u4e14\u5728\u53ef\u9884\u89c1\u7684\u672a\u6765\u4f60\u80fd\u591f\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u8fd0\u884c\uff0c\u90a3\u4e48\u8f7b\u91cf\u7ea7\u7684 Linkerd \u6216 Consul \u53ef\u80fd\u662f\u66f4\u4f18\u9009\u62e9\u3002 \u4f46\u5982\u679c\u4f60\u6709\u4e00\u4e2a\u5927\u89c4\u6a21\u7684 IT \u7cfb\u7edf\u548c\u4e00\u4e2a\u5e9e\u5927\u7684\u56e2\u961f\uff0c\u6216\u8005\u4f60\u8ba4\u4e3a\u5b89\u5168\u662f\u9996\u8981\u4efb\u52a1\uff0c\u90a3\u4e48 Istio \u662f\u66f4\u5b89\u5168\u7684\u9009\u62e9\u3002","title":"1 Istiovs.Linkerdvs.Consul\uff1a\u670d\u52a1\u7f51\u683c\u8be5\u600e\u4e48\u9009\u62e9\uff1f"},{"location":"chap10/1istio_linked_consul/#1-istio-vs-linkerd-vs-consul","text":"","title":"1 Istio vs. Linkerd vs. Consul\uff1a\u670d\u52a1\u7f51\u683c\u8be5\u600e\u4e48\u9009\u62e9\uff1f"},{"location":"chap10/1istio_linked_consul/#1","text":"\u670d\u52a1\u7f51\u683c\u662f\u5e94\u7528\u7a0b\u5e8f\u7ec4\u4ef6\u548c\u7f51\u7edc\u4e4b\u95f4\u901a\u8fc7\u4ee3\u7406\u8fde\u63a5\u7684\u57fa\u7840\u8bbe\u65bd\u5c42 \u3002\u8fd9\u4e9b\u5e94\u7528\u7a0b\u5e8f\u7ec4\u4ef6\u901a\u5e38\u662f\u5fae\u670d\u52a1\uff0c\u4f46\u4ece\u65e0\u670d\u52a1\u5668\u5bb9\u5668\u5230\u865a\u62df\u673a\u6216\u88f8\u673a\u4e0a\u7684\u4f20\u7edf\u5e94\u7528\u7a0b\u5e8f\u7684\u4efb\u4f55\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u53ef\u4ee5\u53c2\u4e0e\u670d\u52a1\u7f51\u683c\u3002\u6bcf\u4e2a\u7ec4\u4ef6\u4e4b\u95f4\u4e0d\u662f\u901a\u8fc7\u7f51\u7edc\u76f4\u63a5\u901a\u4fe1\uff0c\u800c\u662f\u901a\u8fc7\u4ee3\u7406\u6765\u901a\u4fe1\u3002\u8fd9\u4e9b\u4ee3\u7406\u6784\u6210\u4e86\u6570\u636e\u5e73\u9762\uff0c\u63d0\u4f9b\u4e86\u8bb8\u591a\u529f\u80fd\uff0c\u7528\u4e8e\u5b9e\u73b0\u5b89\u5168\u548c\u6d41\u91cf\u7b56\u7565\uff0c\u5e76\u5bf9\u4ee3\u7406\u90e8\u7f72\u7684\u670d\u52a1\u8fdb\u884c\u9065\u6d4b\u3002 \u670d\u52a1\u7f51\u683c\u7684\u529f\u80fd\u5305\u62ec\uff1a \u670d\u52a1\u53d1\u73b0 \u5f39\u6027\uff1a\u91cd\u8bd5\u3001\u5f02\u5e38\u68c0\u6d4b\u3001\u65ad\u8def\u3001\u8d85\u65f6\u7b49 \u5ba2\u6237\u7aef\u8d1f\u8f7d\u5e73\u8861 L7 \u7ec6\u7c92\u5ea6\u6d41\u91cf\u63a7\u5236\uff1a\u6309\u6807\u9898\u3001\u76ee\u7684\u5730\u6216\u6e90\u4ee5\u53ca\u5176\u4ed6\u8fd0\u884c\u65f6\u4fe1\u606f\u8fdb\u884c\u8def\u7531 \u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u8bbe\u7f6e\u5b89\u5168\u7b56\u7565\uff0c\u800c\u4e0d\u662f\u6bcf\u4e2a\u8fde\u63a5 \u57fa\u4e8e L7 \u5143\u6570\u636e\u7684\u8eab\u4efd\u9a8c\u8bc1\u3001\u901f\u7387\u9650\u5236\u3001\u4efb\u610f\u7b56\u7565 \u5f3a\uff08L7\uff09\u5de5\u4f5c\u8d1f\u8f7d\u6807\u8bc6 \u670d\u52a1\u5230\u670d\u52a1\u6388\u6743 \u6307\u6807\u3001\u65e5\u5fd7\u548c\u8ddf\u8e2a \u901a\u8fc7\u5bf9\u6bd4\u663e\u793a\uff0cIstio \u662f\u6700\u6709\u80fd\u529b\u3001\u6700\u7075\u6d3b\u3001\u5e94\u7528\u6700\u5e7f\u6cdb\u7684\u670d\u52a1\u7f51\u683c\uff0c\u4e5f\u662f\u6700\u53d7\u793e\u533a\u652f\u6301\u7684\u670d\u52a1\u7f51\u683c \u3002 \u56e0\u6b64\uff0cIstio \u5728\u5404\u4e2a\u9886\u57df\u90fd\u5728\u7a33\u6b65\u6539\u8fdb\u3002Consul \u548c Linkerd \u5c5e\u4e8e\u8f7b\u91cf\u7ea7\u8bbe\u8ba1\uff0c\u793e\u533a\u5e76\u4e0d\u5e7f\u6cdb\u652f\u6301\u3002\u56e0\u6b64\uff0c\u5b83\u4eec\u5728\u6700\u521d\u53ef\u80fd\u66f4\u5bb9\u6613\u5b9e\u73b0\uff0c\u5e76\u4e14\u5728\u8fc7\u53bb\u5177\u6709\u6027\u80fd\u4f18\u52bf\uff0c\u4f46\u5b83\u4eec\u53ef\u80fd\u4e0d\u592a\u9002\u5408\u8981\u6c42\u82db\u523b\u7684\u7528\u4f8b\u548c\u957f\u671f\u4f7f\u7528\u3002","title":"1 \u670d\u52a1\u7f51\u683c\u7b80\u4ecb"},{"location":"chap10/1istio_linked_consul/#2","text":"\u670d\u52a1\u7f51\u683c\u9075\u5faa\u201c\u4e2d\u5fc3\u8f90\u5c04\u201d\u6a21\u5f0f\uff0c\u5373\u4f7f\u7528\u4ee3\u7406\u6216\u5de5\u4f5c\u8282\u70b9\u5b9e\u73b0\u7279\u5b9a\u89c4\u5219\uff0c\u5e76\u4f7f\u7528\u4e2d\u592e\u670d\u52a1\u5668\u7ba1\u7406\u4ee3\u7406\u3002 Istio \u548c Consul \u4f7f\u7528 Envoy \u4ee3\u7406\uff0c\u800c Linkerd \u4f7f\u7528\u5176\u5b9a\u5236\u7684\u4ee3\u7406\u3002\u8fd9\u4e9b\u4ee3\u7406\u5728\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u6570\u636e\u5e73\u9762\u4e2d\u5de5\u4f5c \u3002 \u4ed6\u4eec\u8d1f\u8d23\u7e41\u91cd\u7684\u4efb\u52a1\uff0c\u5982\u5904\u7406\u4f20\u5165\u6d41\u91cf\u3001\u8fde\u63a5\u670d\u52a1\u548c\u7ec6\u7c92\u5ea6\u5b89\u5168\u7b56\u7565\u3002\u7f51\u7edc\u901a\u4fe1\u548c\u5b89\u5168\u7ba1\u7406\u5728\u96c6\u4e2d\u63a7\u5236\u5e73\u9762\u5b8c\u6210","title":"2  \u670d\u52a1\u7f51\u683c\u7684\u5de5\u4f5c\u6a21\u578b"},{"location":"chap10/1istio_linked_consul/#3","text":"\u5b9e\u73b0\u670d\u52a1\u7f51\u683c\u6700\u8457\u540d\u7684\u5f00\u6e90\u5de5\u5177\u6709\uff1aIstio\u3001Linkerd \u548c Consul\u3002 Istio \u548c Consul \u90fd\u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u4ee3\u7406\u3002Linkerd \u6709\u81ea\u5df1\u7684\u5f00\u6e90\u4ee3\u7406 \u3002\u6211\u4eec\u5c06\u5728\u672c\u6587\u4e2d\u6bd4\u8f83\u8fd9\u4e09\u4e2a\u8457\u540d\u7684\u670d\u52a1\u7f51\u683c\u9879\u76ee\u3002 \u6211\u4eec\u57fa\u4e8e\u4ee5\u4e0b\u516d\u4e2a\u6807\u51c6\u6bd4\u8f83\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\uff1a\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u7ba1\u7406\u3001\u53ef\u4f38\u7f29\u6027\u3001\u53ef\u89c1\u6027\u548c\u53ef\u89c2\u5bdf\u6027\u3001\u5b89\u88c5\u548c\u5b9e\u73b0\u3001\u53ef\u6269\u5c55\u6027\u3002\u5e76\u5206\u4eab\u4e86\u6211\u4eec\u7684\u89c2\u70b9\u3002","title":"3 \u670d\u52a1\u7f51\u683c\u6bd4\u8f83"},{"location":"chap10/1istio_linked_consul/#_1","text":"Istio\u3001Consul \u548c Linkerd \u90fd\u63d0\u4f9b\u57fa\u672c\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff0c\u5982\u8d1f\u8f7d\u5e73\u8861\u3001\u8def\u7531\u548c\u670d\u52a1\u53d1\u73b0\uff0c\u5e76\u4e14\u652f\u6301 HTTP\u3001gRPC \u4ee3\u7406\u3001TCP \u4ee3\u7406\u548c\u534f\u8bae\u68c0\u6d4b\u3002 Istio \u548c Consul \u4f7f\u7528\u7684 Envoy \u4ee3\u7406\u5b9e\u73b0\u4e86\u6bd4 Linkerd \u66f4\u591a\u7684 HTTP \u7279\u5b9a\u529f\u80fd\u3002 Envoy \u7684 HTTP connection manager \u63d0\u4f9b\u4e86\u5bf9 HTTP/1.1\u3001WebSocket\u3001HTTP/2 \u548c HTTP/3 \u7684\u652f\u6301\uff0c\u800c Linkerd \u6682\u4e0d\u652f\u6301HTTP/3\u3002 \u76f8\u8f83\u4e8e Linkerd\uff0c\u56e0\u4e3a Istio \u548c Consul \u90fd\u4f7f\u7528\u4e86 Envoy\uff0c \u5b83\u4eec\u8fd8\u5177\u6709\u66f4\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff0c\u5982\u65ad\u8def\u3001\u91cd\u8bd5\u3001\u8d85\u65f6\u3001\u6545\u969c\u6ce8\u5165\u3001\u5ef6\u8fdf\u6ce8\u5165\u7b49\u529f\u80fd \u3002 Istio \u662f\u552f\u4e00\u4e00\u6b3e\u652f\u6301 Kubernetes \u7684\u8f6f\u4ef6\u3002 \u65e0\u8bba\u662f\u90e8\u7f72\u5728\u516c\u6709\u4e91\uff08\u4f8b\u5982 AWS\u3001GCP\u3001Azure\uff09\u7684 Kubernetes \u8fd8\u662f\u79c1\u6709\u4e91\u7684 Kubernetes\uff0c\u8fd9\u4f7f\u5f97 Istio \u6210\u4e3a\u8bb8\u591a\u5927\u578b\u4f01\u4e1a\u7684\u9996\u9009\u8f6f\u4ef6\uff0c\u56e0\u4e3a\u5927\u578b\u4f01\u4e1a\u65e2\u6709\u652f\u6301\u4e91\u539f\u751f\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e5f\u6709\u8bb8\u591a\u5355\u4f53\u5e94\u7528\u7a0b\u5e8f\u3002 \u67b6\u6784\u5e08\u548c\u5de5\u7a0b\u5e08\u559c\u6b22 Istio \u7684\u7406\u7531\uff1a \u524d\u7aef/\u8fb9\u7f18\u4ee3\u7406\uff1aIstio \u53ef\u4ee5\u6839\u636e\u8fd0\u884c\u65f6\u7684\u503c\u91cd\u5b9a\u5411\u8bf7\u6c42\uff0c\u4f7f\u91d1\u4e1d\u96c0\u548c\u84dd/\u7eff\u7b49\u90e8\u7f72\u7b56\u7565\u7684\u5b9e\u73b0\u53d8\u5f97\u5bb9\u6613\u3002 \u652f\u6301\u5165\u53e3\u7f51\u5173\uff1aIstio \u63d0\u4f9b Istio \u5165\u53e3\u7f51\u5173\uff0c\u5e76\u652f\u6301\u7b2c\u4e09\u65b9 ingress controllers \u7ba1\u7406 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u3002 \u591a\u96c6\u7fa4\u901a\u4fe1\uff1a\u6613\u4e8e\u4f7f\u7528 Istio \u670d\u52a1\u7f51\u683c\u8fde\u63a5\u8de8\u96c6\u7fa4\u6216\u533a\u57df\u7684 Kubernetes \u670d\u52a1\u3002 \u591a\u7ad9\u70b9\u6545\u969c\u5207\u6362\uff1a\u7531\u4e8e\u652f\u6301\u6240\u6709\u516c\u5171\u4e91\uff0cIstio \u53ef\u7528\u4e8e\u81ea\u52a8\u6545\u969c\u5207\u6362\uff0c\u4ee5\u652f\u6301\u57fa\u4e8e\u4e91\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u9ad8\u53ef\u7528\u6027\u548c\u66f4\u5927\u7684\u5f39\u6027\u3002","title":"\u6d41\u91cf\u7ba1\u7406"},{"location":"chap10/1istio_linked_consul/#_2","text":"Istio\u3001Consul \u548c Linkerd \u90fd\u652f\u6301\u8eab\u4efd\u9a8c\u8bc1\u548c\u6388\u6743\u529f\u80fd\uff0c\u4f8b\u5982\uff1a \u57fa\u4e8e mTLS \u7684\u8eab\u4efd\u9a8c\u8bc1\uff0c\u786e\u4fdd\u7f51\u7edc\u901a\u4fe1\u7684\u5b89\u5168\u6027 \u57fa\u4e8e JWT \u7684\u8eab\u4efd\u9a8c\u8bc1\u53ef\u4fdd\u62a4\u6765\u81ea\u5916\u90e8\u548c\u5185\u90e8\u7528\u6237\u7684\u5e94\u7528\u7a0b\u5e8f \u5b9a\u4e49\u7ec6\u7c92\u5ea6\u7684\u5b89\u5168\u7b56\u7565\uff0c\u4f8b\u5982\u5de5\u4f5c\u8d1f\u8f7d\u5230\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6700\u7ec8\u7528\u6237\u5230\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6388\u6743\u548c\u8bbf\u95ee\u63a7\u5236 \u7136\u800c\uff0c \u7531\u4e8e Istio \u63d0\u4f9b\u4e86\u4e0e\u4e91\u5e73\u53f0\u548c\u865a\u62df\u673a\u7684\u96c6\u6210\uff0c\u53ef\u4ee5\u4f7f\u7528 Istio \u7684 mTLS\u7684\u8eab\u4efd\u9a8c\u8bc1\uff0c\u6784\u5efa\u5e94\u7528\u4e0e\u5916\u90e8\u5ba2\u6237\u673a\u6216\u5176\u4ed6 Kubernetes \u96c6\u7fa4\u6216\u865a\u62df\u673a\u4e4b\u95f4\u7684\u901a\u4fe1 \u3002\u4ee5\u4e0b\u662f\u4e3a\u4ec0\u4e48\u5b89\u5168\u7ecf\u7406\u66f4\u559c\u6b22 Istio \u4ee5\u786e\u4fdd\u96f6\u4fe1\u4efb\u5b89\u5168\u6a21\u578b\u7684\u539f\u56e0\uff1a FIPS \u517c\u5bb9\uff1aIstio \u7684\u8bb8\u591a\u5b9e\u73b0\u90fd\u662f FIPS \u517c\u5bb9\u7684\uff0c\u5c5e\u4e8e FIPS \u9075\u5b88\u7684\u4e2d\u7b49\u6c34\u5e73\uff0c\u800c Tetrate \u7684\u5b9e\u73b0\u4e5f\u662f FIPS \u8ba4\u8bc1\u7684\uff0c\u4e14\u5c5e\u4e8e FIPS \u7684\u6700\u9ad8\u6c34\u5e73\u3002\u8fd9\u4f7f\u5f97 Istio \u6210\u4e3a\u9075\u5b88 2014\u5e74\u300a\u8054\u90a6\u4fe1\u606f\u5b89\u5168\u73b0\u4ee3\u5316\u6cd5\u6848\u300b\u7684\u7ec4\u7ec7\u7684\u6700\u4f73\u9009\u62e9\u3002 CVEs \u7684\u900f\u660e\u5ea6\uff1aIstio \u4e0e\u56fd\u5bb6 CVE \u6570\u636e\u5e93\u5171\u4eab\u6f0f\u6d1e\uff0c\u7f51\u7edc\u5b89\u5168\u7ba1\u7406\u4eba\u5458\u53ef\u4ee5\u76f4\u63a5\u53c2\u8003\u56fd\u5bb6 CVE \u6570\u636e\u5e93\u4e2d\u7684\u6700\u65b0\u5b89\u5168\u7f3a\u9677\u548c\u95ee\u9898\uff0c\u5df2\u77e5\u6653 Istio \u5b58\u5728\u7684\u5b89\u5168\u95ee\u9898\u3002\u6b64\u5916\uff0cIstio \u4f1a\u53ca\u65f6\u5b9e\u65bd\u5b89\u5168\u8865\u4e01\uff0c\u5e76\u53ca\u65f6\u901a\u77e5 Istio \u7528\u6237\u3002 \u7075\u6d3b\u6027\uff1aIstio \u53ef\u4ee5\u548c\u4efb\u4f55\u7684\u8eab\u4efd\u9a8c\u8bc1\u63d0\u4f9b\u5546\u96c6\u6210\uff0c\u5982 OpenID \u8fde\u63a5\u63d0\u4f9b\u5546\uff0c\u4f8b\u5982 KeyClope\u3001OAuth 2.0\u3001Google Auth\u3001Firebase Auth\u7b49\u3002 \u7f8e\u56fd\u56fd\u5bb6\u6807\u51c6\u4e0e\u6280\u672f\u7814\u7a76\u6240\uff08NIST\uff09\u4f7f\u7528 Istio \u4f5c\u4e3a\u53c2\u8003\u67b6\u6784\uff0c\u4e3a\u8054\u90a6\u673a\u6784\u5b9e\u65bd\u5b89\u5168\u6807\u51c6\uff0c\u5b9e\u73b0\u96f6\u4fe1\u4efb\u3002","title":"\u5b89\u5168\u7ba1\u7406"},{"location":"chap10/1istio_linked_consul/#_3","text":"\u65e0\u9700\u66f4\u6539\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\uff0c\u5c31\u53ef\u4ee5\u5b89\u88c5\u548c\u4f7f\u7528\u670d\u52a1\u7f51\u683c\u3002\u4f46\u4e00\u822c\u6765\u8bf4\uff0c\u670d\u52a1\u7f51\u683c\u7684\u8bbe\u7f6e\u548c\u7ef4\u62a4\u662f\u4e00\u4e2a\u96be\u9898\u3002\u5e76\u4e14\u8fd0\u7ef4\u56e2\u961f\u7279\u522b\u5173\u6ce8\u8f6f\u4ef6\u7684\u5b89\u88c5\u3001\u4f7f\u7528\u548c\u6027\u80fd\u95ee\u9898\u3002 Istio\u3001Consul \u548c Linkerd \u90fd\u53ef\u4ee5\u4f7f\u7528 Helm charts \u6216 Operators \u5728 Kubernetes \u73af\u5883\u4e2d\u8f7b\u677e\u5b8c\u6210\u5b89\u88c5\u3002 \u7531\u4e8e Linkerd \u662f\u8f7b\u91cf\u7ea7\u7684\uff0c\u5177\u6709\u8f83\u5c11\u7684\u529f\u80fd\u548c\u7b80\u5355\u7684\u67b6\u6784\uff0c\u56e0\u6b64\u5b83\u6bd4 Istio \u548c Consul \u66f4\u6613\u4e8e\u7ef4\u62a4\u548c\u6267\u884c \u3002 Istio \u901a\u5e38\u88ab\u8ba4\u4e3a\u662f\u201c\u91cd\u91cf\u7ea7\u201d\u7684\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u5b83\u652f\u6301\u66f4\u591a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3001\u516c\u5171\u4e91\u548c\u865a\u62df\u673a\u3002 \u4f46\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0cIstio \u5df2\u7ecf\u63d0\u9ad8\u4e86\u6027\u80fd\uff0c\u5e76\u52aa\u529b\u4ee5\u6700\u5c0f\u7684\u8d44\u6e90\u5f00\u9500\u63d0\u4f9b\u66f4\u591a\u7684\u7f51\u7edc\u7ba1\u7406\u548c\u5b89\u5168\u4f18\u52bf\u3002\u8be5\u9879\u76ee\u8fd8\u65e8\u5728\u652f\u6301\u5177\u6709\u9ad8\u8bf7\u6c42\u7387\u7684\u5927\u578b\u670d\u52a1\u7f51\u683c\uff0c\u540c\u65f6\u589e\u52a0\u6700\u5c0f\u5ef6\u8fdf\u3002","title":"\u5b89\u88c5\u548c\u4f7f\u7528"},{"location":"chap10/1istio_linked_consul/#_4","text":"\u5728\u6309\u9700\u6269\u5c55\u65b9\u9762\uff0c\u6bcf\u79cd\u670d\u52a1\u7f51\u683c\u90fd\u5177\u6709\u72ec\u7279\u7684\u4f18\u52bf\u3002 \u5173\u4e8e\u6570\u636e\u5e73\u9762\u7684\u53ef\u6269\u5c55\u6027\uff0cLinkerd \u7684\u6269\u5c55\u901f\u5ea6\u6bd4 Istio \u548c Consul \u5feb \u3002\u4e3b\u8981\u539f\u56e0\u662f Linkerd \u7684\u8f7b\u91cf\u7ea7\u67b6\u6784\uff0c\u5b83\u4e0d\u652f\u6301\u9ad8\u7ea7\u6d41\u91cf\u7ba1\u7406\u548c\u7ec6\u7c92\u5ea6\u5b89\u5168\u7ba1\u7406\u529f\u80fd\u3002 \u4ece\u6570\u636e\u5e73\u9762\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5728\u8d44\u6e90\u53d7\u9650\u7684\u73af\u5883\u4e2d\uff0cEnvoy \u53ef\u80fd\u4f1a\u6bd4 Linkerd \u6d88\u8017\u66f4\u591a\u7684 CPU \u3002\u7136\u800c\uff0cEnvoy \u9075\u5faa\u4e00\u79cd\u5b9e\u7528\u7684\u8bbe\u8ba1\uff0c\u9002\u5408\u5728\u771f\u5b9e\u7684 IT \u73af\u5883\u4e2d\u5b9e\u73b0\u66f4\u5feb\u7684\u6027\u80fd\u3002 Envoy \u7684\u7ef4\u62a4\u4eba\u5458\u5728\u5173\u952e\u8def\u5f84\u7684\u4ee3\u7406\u6027\u80fd\u8c03\u4f18\u65b9\u9762\u505a\u4e86\u51fa\u8272\u7684\u5de5\u4f5c\u3002\u6027\u80fd\u5c06\u56e0\u6240\u4f7f\u7528\u7684\u529f\u80fd\u3001Envoy \u8fd0\u884c\u7684\u73af\u5883\u548c\u53ef\u7528\u7684\u8ba1\u7b97\u673a\u8d44\u6e90\u800c\u5927\u4e0d\u76f8\u540c \u3002 \u6b64\u5916\uff0c\u8bf7\u6ce8\u610f\uff0c\u6027\u80fd\u4ec5\u505a\u4e86\u6a2a\u5411\u5bf9\u6bd4\u3002\u5982\u679c\u6b64\u8f6f\u4ef6\u4e0d\u80fd\u6ee1\u8db3\u4f60\u7684\u6240\u6709\u9700\u6c42\uff0c\u4e5f\u4e0d\u80fd\u8fbe\u5230\u4e0e\u7ade\u4e89\u5bf9\u624b\u76f8\u540c\u7684\u6027\u80fd\u6807\u51c6\uff0c\u90a3\u4e48\u5b83\u5c31\u4e0d\u4f1a\u4ee5\u4e00\u79cd\u6709\u7528\u7684\u65b9\u5f0f\u66f4\u5feb\u6216\u66f4\u8f7b\u3002\u5982\u679c\u4f60\u7684\u7528\u4f8b\uff08\u73b0\u5728\u548c\u5c06\u6765\uff09\u5b8c\u5168\u7531\u5176\u529f\u80fd\u96c6\u6ee1\u8db3\uff0c\u90a3\u4e48\u4f60\u53ea\u80fd\u8003\u8651\u91cd\u91cf\u66f4\u8f7b\u3001\u529f\u80fd\u66f4\u5c11\u7684\u66ff\u4ee3\u65b9\u6848\u3002\u5728\u4f01\u4e1a\u5b9e\u65bd\u6216\u6280\u672f\u8981\u6c42\u82db\u523b\u7684\u73af\u5883\u4e2d\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0d\u592a\u53ef\u80fd\u53d1\u751f\u3002 \u540c\u65f6\uff0c\u8bf7\u6ce8\u610f\uff0c\u9700\u5728\u7c7b\u4f3c\u4ea7\u54c1\u7684\u57fa\u7840\u4e0a\u505a\u6027\u80fd\u6bd4\u8f83\u3002 \u4e00\u6b3e\u8f6f\u4ef6\u4e0d\u53ef\u80fd\u65e2\u8f7b\u91cf\u7ea7\u3001\u6027\u80fd\u9ad8\u4e14\u529f\u80fd\u5168\u3002 Istio \u8d1f\u8f7d\u6d4b\u8bd5\uff0c\u8003\u8651\u4e86\u7531 1000 \u4e2a\u5fae\u670d\u52a1\u548c 2000 \u4e2a sidecars \u7ec4\u6210\u7684\u670d\u52a1\u7f51\u683c\u3002\u6bcf\u79d2\u5411\u7f51\u683c\u53d1\u9001 70000 \u4e2a\u8bf7\u6c42\uff0c\u5e76\u6d4b\u91cf\u54cd\u5e94\u65f6\u95f4\u3002\u4f7f\u7528 Istio 1.14.1 \u8fd0\u884c\u6d4b\u8bd5\u540e\uff0c\u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762\u7684\u89c2\u5bdf\u7ed3\u679c\u5982\u4e0b\uff1a \u6570\u636e\u5e73\u9762\u6027\u80fd\uff1aEnvoy \u4ee3\u7406\u6bcf\u79d2\u5904\u7406 1000 \u4e2a\u8bf7\u6c42\uff0c\u4f7f\u7528\u4e86 0.35 \u4e2a vCPU \u548c 40 MB \u5185\u5b58\u3002\u8fd8\u89c2\u5bdf\u5230 Envoy \u4ee3\u7406\uff0c\u540e 10% \u7684\u8bf7\u6c42\u5ef6\u8fdf\u589e\u52a0\u4e86 2.65\u6beb\u79d2\u3002 \u63a7\u5236\u5e73\u9762\u6027\u80fd\uff1aIstiod \u4f7f\u7528 1 \u4e2a vCPU \u548c 1.5 GB \u5185\u5b58\u3002","title":"\u53ef\u4f38\u7f29\u6027"},{"location":"chap10/1istio_linked_consul/#_5","text":"\u5206\u5e03\u5f0f\u670d\u52a1\u7684\u7aef\u5230\u7aef\u53ef\u89c1\u6027\u548c\u53ef\u89c2\u5bdf\u6027\u5bf9\u4e8e\u8fd0\u7ef4\u56e2\u961f\u6765\u8bf4\u81f3\u5173\u91cd\u8981\u3002SRE \u548c Ops \u56e2\u961f\u9700\u8981\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u7ea7\u522b\u53ef\u89c1\u6027\u3001\u8ddf\u8e2a\u548c\u76d1\u63a7\u80fd\u529b\u3002 Istio\u3001Consul \u548c Linkerd \u90fd\u63d0\u4f9b\u4e86\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u5065\u5eb7\u72b6\u51b5\u7684\u53ef\u89c1\u6027\uff0c\u6d4b\u91cf\u7f51\u7edc\u884c\u4e3a\u5e76\u5411\u5229\u76ca\u76f8\u5173\u8005\u51fa\u5177\u62a5\u544a\u3002 Istio\u3001Consul \u548c Linkerd \u751f\u6210\u76d1\u63a7\u6240\u9700\u7684\u5173\u952e\u6307\u6807\uff0c\u5982 HTTP\u3001HTTP/2 \u548c gRPC \u6d41\u91cf\u7684\u5ef6\u8fdf\u3001\u9519\u8bef\u548c\u9971\u548c\u5ea6\u3002\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\u63d0\u4f9b\u7684\u6307\u6807\u53ef\u4ee5\u76f4\u63a5\u4ece\u547d\u4ee4\u884c\u754c\u9762\uff08CLI\uff09\u6216 Grafana \u4eea\u8868\u677f\u67e5\u770b\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Prometheus \u6765\u67e5\u770b\u3002 \u4e0e Linkerd \u76f8\u6bd4\uff0cIstio \u548c Consul \u90fd\u63d0\u4f9b\u4e86\u66f4\u8be6\u7ec6\u7684\u7f51\u7edc\u6307\u6807\u3002 Envoy \u4ee3\u7406\u5728 Istio \u548c Consul \u4e2d\u5f62\u6210\u6570\u636e\u5e73\u9762\uff0c\u4e3a Ops \u56e2\u961f\u63d0\u4f9b\u8db3\u591f\u7684\u670d\u52a1\u7ea7\u522b\u6307\u6807\u3001\u4ee3\u7406\u7ea7\u522b\u6307\u6807\u548c\u5206\u5e03\u5f0f\u8ddf\u8e2a\uff0c\u66f4\u5feb\u5730\u8bca\u65ad\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e\u95ee\u9898\u3002\u7531\u4e8e Envoy \u4e5f\u662f\u4e00\u4e2a\u5e7f\u6cdb\u4f7f\u7528\u7684\u6570\u636e\u5e73\u9762\uff0cOps \u56e2\u961f\u66f4\u5bb9\u6613\u4ece\u793e\u533a\u4e2d\u627e\u5230\u914d\u7f6e\u6216\u6027\u80fd\u5f02\u5e38\u7684\u89e3\u51b3\u65b9\u6848\u3002 \u4eba\u6c14 Istio \u662f\u793e\u533a\u5185\u5916\u6700\u6d41\u884c\u7684\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\u3002\u8fd9\u610f\u5473\u7740\u66f4\u591a\u7684\u521b\u65b0\u548c\u66f4\u79ef\u6781\u7684\u529f\u80fd\u5f00\u53d1\u3002\u6709\u8bc1\u636e\u8868\u660e\uff0c\u4e0e\u4efb\u4f55\u5176\u4ed6\u670d\u52a1\u7f51\u683c\u76f8\u6bd4\uff0cIstio \u662f\u5168\u7403\u67b6\u6784\u5e08\u3001DevOps \u56e2\u961f\u548c\u5b89\u5168\u4e13\u4e1a\u4eba\u5458\u6700\u5e7f\u6cdb\u4f7f\u7528\u7684\u3002\u867d\u7136\u4f7f\u7528\u60c5\u51b5\u53ef\u80fd\u56e0\u884c\u4e1a\u6709\u6240\u4e0d\u540c\uff0c\u4f46 Istio \u76ee\u524d\u5df2\u5728\u91d1\u878d\u670d\u52a1\u884c\u4e1a\u548c\u7f8e\u56fd\u653f\u5e9c\u4f7f\u7528\uff0c\u5e76\u5728\u5173\u952e\u9886\u57df\u53d6\u5f97\u6210\u529f\u3002\u56e0\u6b64\uff0cIstio \u53ef\u80fd\u4f1a\u5168\u9762\u4fdd\u6301\u6216\u589e\u52a0\u5176\u9886\u5bfc\u5730\u4f4d 1\u3001\u8c37\u6b4c\u8d8b\u52bf\uff08Google Trending\uff09 2\u3001\u8d21\u732e\u8005\u7684\u591a\u6837\u6027 4\u3001\u6350\u6b3e\u7ba1\u7406 \u53ef\u6269\u5c55\u6027 \u6240\u6709\u670d\u52a1\u7f51\u683c\u8f6f\u4ef6\u90fd\u662f\u6a21\u5757\u5316\u548c\u53ef\u6269\u5c55\u7684\u3002\u4f46\u7531\u4e8e Istio \u6bd4\u5176\u4ed6\u670d\u52a1\u7f51\u683c\u66f4\u53d7\u6b22\u8fce\uff0c\u8bb8\u591a\u5f00\u6e90\u9879\u76ee\u90fd\u662f\u901a\u8fc7 Istio \u5b9e\u73b0\u7684\u3002\u4e00\u4e9b\u503c\u5f97\u6ce8\u610f\u7684\u9879\u76ee\u5305\u62ec\uff1a Slime\uff0c\u4f7f\u7528 Istio \u548c Envoy \u7684\u667a\u80fd\u670d\u52a1\u7ba1\u7406\u5668 MOSN\uff0c\u63d0\u4f9b\u4e91\u672c\u5730\u8fb9\u7f18\u7f51\u5173\u548c\u4ee3\u7406 Aeraki\uff0c\u4e3a\u9664 HTTPs \u548c gRPC \u4e4b\u5916\u7684\u6240\u6709 L7 \u534f\u8bae\u63d0\u4f9b\u652f\u6301 WASM\uff0c\u5f00\u53d1 WebAssembly \u63d2\u4ef6\u5e76\u589e\u5f3a\u670d\u52a1\u7f51\u683c\u529f\u80fd","title":"\u53ef\u89c1\u6027\u548c\u53ef\u89c2\u6d4b\u6027"},{"location":"chap10/1istio_linked_consul/#_6","text":"\u5728\u4ed4\u7ec6\u8bc4\u4f30\u4e86\u4e09\u79cd\u6d41\u884c\u7684\u670d\u52a1\u7f51\u683c\u7684\u5404\u79cd\u529f\u80fd\u540e\uff0c\u6211\u4eec\u8ba4\u4e3a Istio \u63d0\u4f9b\u4e86\u6bd4\u5176\u540c\u7c7b\u4ea7\u54c1\u66f4\u4e30\u5bcc\u7684\u529f\u80fd\u96c6\u3002 \u5982\u679c\u4f60\u662f\u4e00\u4e2a\u5c0f\u578b\u7684 IT \u521d\u521b\u516c\u53f8\uff0c\u53ea\u6709\u4e00\u4e2a\u5c0f\u578b\u7684 DevOps \u548c\u5b89\u5168\u56e2\u961f\uff0c\u5e76\u4e14\u6ca1\u6709\u5728\u4e00\u4e2a\u7279\u522b\u5177\u6709\u6311\u6218\u6027\u7684\u5b89\u5168\u73af\u5883\u4e2d\u8fd0\u884c\uff0c\u800c\u4e14\u5728\u53ef\u9884\u89c1\u7684\u672a\u6765\u4f60\u80fd\u591f\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u8fd0\u884c\uff0c\u90a3\u4e48\u8f7b\u91cf\u7ea7\u7684 Linkerd \u6216 Consul \u53ef\u80fd\u662f\u66f4\u4f18\u9009\u62e9\u3002 \u4f46\u5982\u679c\u4f60\u6709\u4e00\u4e2a\u5927\u89c4\u6a21\u7684 IT \u7cfb\u7edf\u548c\u4e00\u4e2a\u5e9e\u5927\u7684\u56e2\u961f\uff0c\u6216\u8005\u4f60\u8ba4\u4e3a\u5b89\u5168\u662f\u9996\u8981\u4efb\u52a1\uff0c\u90a3\u4e48 Istio \u662f\u66f4\u5b89\u5168\u7684\u9009\u62e9\u3002","title":"\u603b\u7ed3"},{"location":"chap10/2istio_ambient/","text":"2 Istio Ambient Mesh \u4ecb\u7ecd 1 Ambient Mesh \u4ecb\u7ecd Istio \u7684\u4f20\u7edf\u6a21\u5f0f\u662f\u5c06 Envoy proxy \u4f5c\u4e3a sidecar \u90e8\u7f72\u5728\u5de5\u4f5c\u8d1f\u8f7d\u7684 pod \u4e2d\uff0c\u867d\u7136\u4e0e\u91cd\u6784\u5e94\u7528\u7a0b\u5e8f\u76f8\u6bd4\uff0csidecar \u5177\u6709\u663e\u8457\u7684\u4f18\u52bf\uff0c\u4f46\u662f\u4ecd\u7136\u4f1a\u4ea7\u751f\u4e00\u4e9b\u9650\u5236\uff1a \u4fb5\u5165\u6027 \uff1asidecar \u5fc5\u987b\u901a\u8fc7\u4fee\u6539 Kubernetes Pod \u7684\u914d\u7f6e\u548c\u91cd\u5b9a\u5411\u6d41\u91cf\u6765\u201c\u6ce8\u5165\u201d\u5e94\u7528\u7a0b\u5e8f\u3002\u56e0\u6b64\uff0c\u5b89\u88c5\u548c\u5347\u7ea7 sidecar \u9700\u8981\u91cd\u65b0\u542f\u52a8 Pod\uff0c\u8fd9\u5c06\u4f1a\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u4ea7\u751f\u5f71\u54cd\u3002 \u8d44\u6e90\u5229\u7528\u7387\u4f4e \uff1a\u7531\u4e8e\u5728\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d Pod \u90fd\u6ce8\u5165\u4e86 sidecar \u4ee3\u7406 \uff0c\u56e0\u6b64 Pod \u5fc5\u987b\u4e3a sidecar \u9884\u7559\u8db3\u591f\u7684 CPU \u548c\u5185\u5b58\u8d44\u6e90\uff0c\u4ece\u800c\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u7684\u8d44\u6e90\u5229\u7528\u7387\u4e0d\u8db3\u3002 \u6d41\u91cf\u4e2d\u65ad \uff1a\u6d41\u91cf\u6355\u83b7\u548c HTTP \u5904\u7406\u901a\u5e38\u662f\u7531 Istio \u7684 sidecar \u5b8c\u6210\u7684\uff0c\u8ba1\u7b97\u9700\u8981\u6d88\u8017\u5927\u91cf\u7684\u8d44\u6e90\uff0c\u5e76\u4e14\u53ef\u80fd\u4f1a\u7834\u574f\u4e00\u4e9b\u4e0d\u7b26\u5408 HTTP \u5b9e\u73b0\u7684\u5e94\u7528\u7a0b\u5e8f\u3002 Istio ambient mesh \u662f Istio \u7684\u4e00\u4e2a\u65e0 sidecar \u7684\u6570\u636e\u5e73\u9762 \uff0c\u65e8\u5728\u964d\u4f4e\u57fa\u7840\u8bbe\u65bd\u6210\u672c\u548c\u63d0\u9ad8\u6027\u80fd\u3002 \u5b83\u7684\u672c\u8d28\u662f\u5206\u79bb sidecar proxy\uff08Envoy\uff09\u4e2d\u7684 L4 \u548c L7 \u529f\u80fd\uff0c\u8ba9\u4e00\u90e8\u5206\u4ec5\u9700\u8981\u5b89\u5168\u529f\u80fd\u7684\u7528\u6237\u53ef\u4ee5\u6700\u5c0f\u963b\u529b\uff08\u4f4e\u8d44\u6e90\u6d88\u8017\u3001\u8fd0\u7ef4\u6210\u672c\uff09\u5730\u4f7f\u7528 Istio service mesh \u3002 ambient mesh \u5c06 Istio \u7684\u529f\u80fd\u62c6\u5206\u4e3a 2 \u4e2a\u4e0d\u540c\u7684\u5c42\u6b21\uff1a L4 \u5b89\u5168\u8986\u76d6\u5c42\uff1a\u7528\u6237\u53ef\u4ee5\u4f7f\u7528 TCP \u8def\u7531\uff0cmTLS \u548c\u6709\u9650\u7684\u53ef\u89c2\u6d4b\u6027\u7b49\u529f\u80fd\u3002 L7 \u5904\u7406\u5c42\uff1a\u7528\u6237\u53ef\u4ee5\u6309\u9700\u542f\u7528 L7 \u529f\u80fd\uff0c\u4ee5\u83b7\u5f97 Istio \u7684\u5168\u90e8\u529f\u80fd\uff0c\u4f8b\u5982\u9650\u901f\uff0c\u6545\u969c\u6ce8\u5165\uff0c\u8d1f\u8f7d\u5747\u8861\uff0c\u7194\u65ad\u7b49\u7b49\u3002 ztunnel \u662f ambient mesh \u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u5171\u4eab\u4ee3\u7406\uff0c\u4ee5 DaemonSet \u7684\u65b9\u5f0f\u90e8\u7f72\uff0c\u5904\u4e8e\u7c7b\u4f3c\u4e8e CNI \u7684\u7f51\u683c\u5e95\u5c42 \u3002 ztunnel \u5728\u8282\u70b9\u95f4\u6784\u5efa\u96f6\u4fe1\u4efb\u7684\u96a7\u9053\uff08zero-trust tunnel, ztunnel\uff09\uff0c\u8d1f\u8d23\u5b89\u5168\u5730\u8fde\u63a5\u548c\u9a8c\u8bc1\u7f51\u683c\u5185\u7684\u5143\u7d20\u3002 \u5728 ambient mesh \u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6240\u6709\u6d41\u91cf\u4f1a\u91cd\u5b9a\u5411\u5230\u672c\u5730\u7684 ztunnel \u8fdb\u884c\u5904\u7406\uff0cztunnel \u8bc6\u522b\u6d41\u91cf\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5e76\u4e3a\u5176\u9009\u62e9\u6b63\u786e\u7684\u8bc1\u4e66\u4ee5\u5efa\u7acb mTLS \u8fde\u63a5\u3002 ztunnel \u5b9e\u73b0\u4e86\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6838\u5fc3\u529f\u80fd\uff1a \u96f6\u4fe1\u4efb\uff0c\u5b83\u4f1a\u4e3a\u542f\u7528\u4e86 ambient mesh \u7684 Namespace \u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u4e00\u4e2a\u5b89\u5168\u8986\u76d6\u5c42\uff0c\u63d0\u4f9b mTLS\uff0c\u9065\u6d4b\uff0c\u8ba4\u8bc1\u548c L4 \u6388\u6743\u7b49\u529f\u80fd\uff0c\u800c\u65e0\u9700\u7ec8\u6b62\u6216\u89e3\u6790 HTTP \u3002 \u5728\u542f\u7528 ambient mesh \u548c\u521b\u5efa\u5b89\u5168\u8986\u76d6\u5c42\u4e4b\u540e\uff0c\u53ef\u4ee5\u9009\u62e9\u6027\u5730\u4e3a namespace \u542f\u7528 L7 \u529f\u80fd\uff0c\u8fd9\u5141\u8bb8\u547d\u540d\u7a7a\u95f4\u5b9e\u73b0\u5168\u5957\u7684 Istio \u529f\u80fd\uff0c\u5305\u62ec Virtual Service\u3001L7 \u9065\u6d4b \u548c L7 \u6388\u6743\u7b56\u7565 \u3002 waypoint proxy \u53ef\u4ee5\u6839\u636e\u6240\u670d\u52a1\u7684 Namespace \u7684\u5b9e\u65f6\u6d41\u91cf\u81ea\u52a8\u6269\u7f29\u5bb9\uff0c\u8fd9\u5c06\u4e3a\u7528\u6237\u8282\u7701\u5927\u91cf\u7684\u8d44\u6e90\u3002 Istio \u4f1a\u4e3a\u6839\u636e\u670d\u52a1\u7684 service account \u521b\u5efa\u76f8\u5e94\u7684 waypoint proxy \uff0c\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u5728\u51cf\u5c11\u8d44\u6e90\u6d88\u8017\u7684\u60c5\u51b5\u4e0b\u540c\u65f6\u5c3d\u53ef\u80fd\u5730\u7f29\u5c0f\u6545\u969c\u57df\uff0c\u53c2\u89c1\u4e0b\u56fe Model III\u3002 2 Ambient Mesh \u652f\u6301\u7684\u73af\u5883\u548c\u9650\u5236 \u76ee\u524d\u5df2\u77e5 ambient mesh \u4ec5\u652f\u6301\u4ee5\u4e0b\u73af\u5883\uff0c\u5176\u4ed6\u73af\u5883\u76ee\u524d\u5c1a\u672a\u7ecf\u8fc7\u6d4b\u8bd5\u3002 GKE (without Calico or Dataplane V2) EKS kind \u5e76\u4e14 ambient mesh \u8fd8\u6709\u8bb8\u591a\u9650\u5236\uff0c\u4f8b\u5982\uff1a AuthorizationPolicy \u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u6ca1\u6709\u9884\u671f\u7684\u90a3\u4e48\u4e25\u683c\uff0c\u6216\u8005\u6839\u672c\u65e0\u6548\u3002 \u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u76f4\u63a5\u8bbf\u95ee Pod IP \u800c\u4e0d\u662f Service \u7684\u8bf7\u6c42\u5c06\u65e0\u6548 \u3002 ambient mesh \u4e0b\u7684\u670d\u52a1\u65e0\u6cd5\u901a\u8fc7 LoadBalancer \u548c NodePort \u7684\u65b9\u5f0f\u8bbf\u95ee\uff0c\u4e0d\u8fc7\u4f60\u53ef\u4ee5\u90e8\u7f72\u4e00\u4e2a\u5165\u53e3\u7f51\u5173\uff08\u672a\u542f\u7528 ambient mesh\uff09\u4ee5\u4ece\u5916\u90e8\u8bbf\u95ee\u670d\u52a1\uff1b STRICT mTLS \u4e0d\u80fd\u5b8c\u5168\u963b\u6b62\u660e\u6587\u6d41\u91cf \u3002 \u4e0d\u652f\u6301 EnvoyFilter \u3002 \u8be6\u7ec6\u8bf4\u660e\u8bf7\u53c2\u89c1 Ambient Mesh \u3002 3 \u4f7f\u7528 Eksctl \u5728 AWS \u4e0a\u521b\u5efa Kubernetes \u96c6\u7fa4 \u5728\u672c\u793a\u4f8b\u4e2d\uff0c\u5c06\u4f7f\u7528 eksctl \u5728 AWS \u4e0a\u521b\u5efa EKS \u96c6\u7fa4\u6765\u6d4b\u8bd5 Istio ambient mesh\u3002 eksctl \u662f\u4e00\u4e2a\u7528\u4e8e\u7ba1\u7406 EKS\uff08Amazon \u6258\u7ba1 Kubernetes \u670d\u52a1\uff09\u7684 CLI \u5de5\u5177\u3002\u6709\u5173 eksctl \u7684\u5b89\u88c5\u548c\u4f7f\u7528\u53c2\u89c1 eksctl Getting started \u521b\u5efa\u96c6\u7fa4\u914d\u7f6e\u6587\u4ef6 cluster.yaml\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a 2 \u4e2a Worker \u8282\u70b9\u7684 EKS \u96c6\u7fa4\uff0c\u6bcf\u4e2a\u8282\u70b9\u8d44\u6e90\u4e3a 2C8G\uff0c\u96c6\u7fa4\u7248\u672c\u4e3a 1.23\u3002 apiVersion: eksctl.io/v1alpha5 kind: ClusterConfig metadata: name: aws-demo-cluster01 region: us-east-1 version: '1.23' nodeGroups: - name: ng-1 instanceType: m5.large desiredCapacity: 2 volumeSize: 100 ssh: allow: true # will use ~/.ssh/id_rsa.pub as the default ssh key \u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u521b\u5efa EKS \u96c6\u7fa4\u3002 eksctl create cluster -f cluster.yaml \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b EKS \u96c6\u7fa4\u3002 > eksctl get cluster NAME REGION EKSCTL CREATED aws-demo-cluster01 us-east-1 True \u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5c06 aws-demo-cluster01 \u96c6\u7fa4\u7684 kubeconfig \u6587\u4ef6\u66f4\u65b0\u5230 ~/.kube/config \u6587\u4ef6\u4e2d\uff0c\u8ba9\u6211\u4eec\u672c\u5730\u7684 kubectl \u5de5\u5177\u53ef\u4ee5\u8bbf\u95ee\u5230 aws-demo-cluster01 \u96c6\u7fa4\u3002 aws eks update-kubeconfig --region us-east-1 --name aws-demo-cluster01 \u6709\u5173 aws CLI \u5de5\u5177\u7684\u5b89\u88c5\u53c2\u89c1 Installing or updating the latest version of the AWS CLI \uff0caws CLI \u7684\u8ba4\u8bc1\u53c2\u89c1 Configuration basics \u3002 4 \u4e0b\u8f7d Istio \u6839\u636e\u5bf9\u5e94\u64cd\u4f5c\u7cfb\u7edf\u4e0b\u8f7d\u652f\u6301 ambient mesh \u7684 istioctl \u4e8c\u8fdb\u5236\u6587\u4ef6\u548c\u793a\u4f8b\u8d44\u6e90\u6587\u4ef6\uff0c\u53c2\u89c1 Istio \u4e0b\u8f7d \u3002\u5176\u4e2d istioctl \u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u53ef\u4ee5\u5728 bin \u76ee\u5f55\u4e2d\u627e\u5230\uff0c\u793a\u4f8b\u8d44\u6e90\u6587\u4ef6\u53ef\u4ee5\u5728 samples \u76ee\u5f55\u4e2d\u627e\u5230\u3002 5 \u90e8\u7f72\u793a\u4f8b\u5e94\u7528 \u90e8\u7f72 Istio \u793a\u4f8b\u7684 Bookinfo \u5e94\u7528\u7a0b\u5e8f\uff0c\u4ee5\u53ca sleep \u548c notsleep \u4e24\u4e2a\u5ba2\u6237\u7aef\u3002sleep \u548c notsleep \u53ef\u4ee5\u6267\u884c curl \u547d\u4ee4\u6765\u53d1\u8d77 HTTP \u8bf7\u6c42\u3002 kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml kubectl apply -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/sleep.yaml kubectl apply -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/notsleep.yaml \u5f53\u524d\u6211\u4eec\u90e8\u7f72\u7684 istio \u548c\u5e94\u7528\u7684 Pod \u548c Service \u5982\u4e0b\u6240\u793a\u3002 6 \u90e8\u7f72 Istio \u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5b89\u88c5 Istio\uff0c\u5e76\u6307\u5b9a profile=ambient \u53c2\u6570\u90e8\u7f72 ambient mesh \u76f8\u5173\u7684\u7ec4\u4ef6\u3002 istioctl install --set profile=ambient \u5982\u679c\u5b89\u88c5\u6210\u529f\u5c06\u4f1a\u8f93\u51fa\u4ee5\u4e0b\u7ed3\u679c\u3002 \u2714 Istio core installed \u2714 Istiod installed \u2714 Ingress gateways installed \u2714 CNI installed \u2714 Installation complete \u5b89\u88c5\u5b8c\u6210\u4ee5\u540e\u6211\u4eec\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u5185\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u7ec4\u4ef6\uff1a istiod\uff1aIstio \u7684\u6838\u5fc3\u7ec4\u4ef6\u3002 istio-ingressgateway \uff1a\u7ba1\u7406\u8fdb\u51fa\u96c6\u7fa4\u7684\u5357\u5317\u5411\u6d41\u91cf\uff0c\u5728\u672c\u793a\u4f8b\u4e2d\u6211\u4eec\u4e0d\u4f1a\u7528\u5230 istio-ingressgateway \u3002 istio-cni \uff1a\u4e3a\u52a0\u5165 ambient mesh \u7684 Pod \u914d\u7f6e\u6d41\u91cf\u91cd\u5b9a\u5411\uff0c\u5c06 Pod \u7684\u8fdb\u51fa\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u76f8\u540c\u8282\u70b9\u7684 ztunnel \u4e0a\u3002 ztunnel \uff1aztunnel \u5728\u8282\u70b9\u95f4\u6784\u5efa\u96f6\u4fe1\u4efb\u7684\u96a7\u9053\uff0c\u63d0\u4f9b mTLS\uff0c\u9065\u6d4b\uff0c\u8ba4\u8bc1\u548c L4 \u6388\u6743\u7b49\u529f\u80fd\u3002 > kubectl get pod -n istio-system NAME READY STATUS RESTARTS AGE istio-cni-node-gfmqp 1/1 Running 0 100s istio-cni-node-t2flv 1/1 Running 0 100s istio-ingressgateway-f6d95c86b-mfk4t 1/1 Running 0 101s istiod-6c99d96db7-4ckbm 1/1 Running 0 2m23s ztunnel-fnjg2 1/1 Running 0 2m24s ztunnel-k4jhb 1/1 Running 0 2m24s 7 \u6293\u5305\u8bbe\u7f6e \u4e3a\u4e86\u66f4\u76f4\u89c2\u5730\u89c2\u5bdf\u6d41\u91cf\u7684\u8bbf\u95ee\u60c5\u51b5 \uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9 Pod \u8fdb\u884c\u6293\u5305\uff0c\u4f46\u662f\u5e94\u7528 Pod \u5e76\u6ca1\u6709\u5b89\u88c5\u76f8\u5173\u7684\u6293\u5305\u5de5\u5177\uff0c\u8fd9\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 kubectl debug \u5de5\u5177\u521b\u5efa\u4e00\u4e2a ephemeral \u4e34\u65f6\u5bb9\u5668\u5171\u4eab\u5bb9\u5668\u7684\u547d\u540d\u7a7a\u95f4\u6765\u8fdb\u884c\u8c03\u8bd5\u3002\u6709\u5173 kubectl debug \u8be6\u60c5\u8bf7\u53c2\u89c1\u8c03\u8bd5\u8fd0\u884c\u4e2d\u7684 Pod\u3002 \u5728 4 \u4e2a\u7ec8\u7aef\u5206\u522b\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5bf9 sleep \u548c productpage \u4ee5\u53ca\u4e24\u4e2a\u8282\u70b9\u4e0a\u7684 ztunnel Pod \u8fdb\u884c\u6293\u5305\u3002 --image \u53c2\u6570\u6307\u5b9a\u4e34\u65f6\u5bb9\u5668\u7684\u955c\u50cf\uff0c\u8fd9\u91cc\u4f7f\u7528\u7684 nicolaka/netshoot \u955c\u50cf\u4e2d\u9884\u88c5\u4e86 tcpdump , tshark , termshark \u7b49\u5e38\u7528\u7684\u7f51\u7edc\u6293\u5305\u5de5\u5177\u3002 kubectl debug -it sleep-55697f8897-n2ldz --image=nicolaka/netshoot kubectl debug -it productpage-v1-5586c4d4ff-z8jbb --image=nicolaka/netshoot kubectl debug -it -n istio-system ztunnel-fnjg2 --image=nicolaka/netshoot kubectl debug -it -n istio-system ztunnel-k4jhb --image=nicolaka/netshoot \u5728 4 \u4e2a\u7ec8\u7aef\u5206\u522b\u6267\u884c termshark -i eth0 \u547d\u4ee4\uff0c\u5bf9 Pod \u7684 eth0 \u7f51\u5361\u8fdb\u884c\u6293\u5305\u3002 \u7531\u4e8e istio-cni \u4f1a\u6301\u7eed\u5bf9 ztunnel \u53d1\u8d77\u8def\u5f84\u4e3a /healthz/ready \u7684HTTP \u5065\u5eb7\u63a2\u6d4b\uff0c\u4e3a\u4e86\u907f\u514d\u8be5\u6d41\u91cf\u5f71\u54cd\u6211\u4eec\u7684\u89c2\u5bdf\uff0c\u5728 2 \u4e2a ztunnel Pod \u4e2d\u7684 termshark Filter \u6846\u4e2d\u8bbe\u7f6e\u4ee5\u4e0b\u8fc7\u6ee4\u6761\u4ef6\u3002 # ztunnel-fnjg2\uff0csleep \u6240\u5728\u8282\u70b9\u7684 ztunnel ip.addr==192.168.58.148 || ip.addr==192.168.13.108 # ztunnel-k4jhb\uff0cproductpage \u6240\u5728\u8282\u70b9\u7684 ztunnel ip.addr==192.168.13.108 8 \u672a\u4f7f\u7528 Ambient Mesh \u7ba1\u7406\u6d41\u91cf \u7531\u4e8e\u5f53\u524d default Namespace \u8fd8\u6ca1\u6709\u52a0\u5165 ambient mesh\uff0c\u6b64\u65f6\u5e94\u7528\u7684\u6d41\u91cf\u5e76\u4e0d\u4f1a\u7ecf\u8fc7 ztunnel \uff0cPod \u4e4b\u95f4\u901a\u8fc7 kubernetes \u7684 Service \u8fdb\u5236\u8fdb\u884c\u901a\u4fe1\uff0cPod \u4e4b\u95f4\u7684\u6d41\u91cf\u4e5f\u4e0d\u4f1a\u8fdb\u884c mTLS \u52a0\u5bc6\uff0c\u800c\u662f\u4ee5\u660e\u6587\u7684\u65b9\u5f0f\u8fdb\u884c\u4f20\u64ad\u3002 \u4f7f\u7528 sleep \u5411 productpage \u53d1\u8d77\u4e00\u6b21\u8bf7\u6c42\u3002 kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 # \u8fd4\u56de\u7ed3\u679c\uff0c\u54cd\u5e94\u7ed3\u679c\u7684\u7b2c\u4e00\u884c\u5185\u5bb9 <!DOCTYPE html> \u67e5\u770b sleep \u548c productpage \u7684\u6293\u5305\u7ed3\u679c\u53ef\u4ee5\u770b\u5230\uff0csleep \uff08192.168.58.148\uff09 \u8bbf\u95ee productpage Service \u540d\u79f0 DNS \u89e3\u6790\u540e\u7684 service IP\uff0810.100.171.143\uff09\uff0c\u7ecf\u8fc7 kubernetes Service \u7684\u8f6c\u53d1\u540e\uff0c\u6700\u7ec8\u8bbf\u95ee\u5230 productpage \u7684\u5b9e\u9645 Pod IP \uff08192.168.13.108\uff09\u3002 \u6b64\u65f6 ambient mesh \u8fd8\u672a\u63a5\u7ba1 default Namespace \u7684\u6d41\u91cf\uff0c\u56e0\u6b64\u5728 ztunnel \u4e0a\u4e0d\u4f1a\u6293\u5230\u76f8\u5173\u7684\u6570\u636e\u5305\u3002 9 \u5c06 Default Namespace \u52a0\u5165 Ambient Mesh\uff08L4 \u529f\u80fd\uff09 \u4e3a default Namespace \u6dfb\u52a0 istio.io/dataplane-mode=ambient \u6807\u7b7e\uff0c\u8868\u793a\u5c06\u8be5 Namespace \u52a0\u5165\u5230 ambient mesh \u4e2d\u3002 kubectl label namespace default istio.io/dataplane-mode=ambient \u4e00\u65e6 Namespace \u52a0\u5165 ambient mesh \uff0c istio-cni DaemonSet \u5c31\u4f1a\u4e3a\u8be5 Namespace \u4e2d\u7684 Pod \u8bbe\u7f6e iptables \u91cd\u5b9a\u5411\u89c4\u5219\uff0c\u5c06 Pod \u7684\u6240\u6709\u51fa\u5165\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u8fd0\u884c\u5728\u76f8\u540c\u8282\u70b9\u7684 ztunnel \u4e0a \u3002 9.1 MTLS \u6d41\u91cf\u52a0\u5bc6 ztunnel \u4f1a\u4e3a\u542f\u7528\u4e86 ambient mesh \u7684 Namespace \u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u4e00\u4e2a\u5b89\u5168\u8986\u76d6\u5c42\uff0c\u63d0\u4f9b mTLS\uff0c\u9065\u6d4b\uff0c\u8ba4\u8bc1\u548c L4 \u6388\u6743\u7b49\u529f\u80fd \u3002 \u4e3a\u4e86\u65b9\u4fbf\u67e5\u770b\uff0c\u53ef\u4ee5\u5148\u6e05\u9664\u5148\u524d\u5728 sleep \u548c productpage \u4e0a\u6293\u5230\u7684\u62a5\u6587\u3002 \u7136\u540e\u4f7f\u7528 sleep \u5411 productpage \u53d1\u8d77\u4e00\u6b21\u8bf7\u6c42\u3002 kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 \u5728 sleep \u548c productpage \u4e0a\u4f9d\u7136\u53ef\u4ee5\u6293\u5230\u660e\u6587\u7684\u6570\u636e\u5305\uff0c\u53ea\u662f\u8fd9\u56de\u5728 productpage \u4e0a\u6293\u5230\u7684\u6570\u636e\u5305\u7684\u6e90 IP \u53d8\u4e3a\u7684 sleep \u6240\u5728\u8282\u70b9\u7684 ztunnel \u7684 IP \u5730\u5740\u3002 \u5728 sleep \u8282\u70b9\u6240\u5728\u7684 ztunnel \u4e0a\u6211\u4eec\u53ef\u4ee5\u6293\u5230 sleep \u53d1\u8fc7\u6765\u7684\u660e\u6587\u7684\u6570\u636e\u5305\uff0cztunnel \u4f1a\u5bf9\u6570\u636e\u5305\u8fdb\u884c\u52a0\u5bc6\u4ee5\u540e\u53d1\u9001\u7ed9 productpage \u8282\u70b9\u4e0a\u7684 ztunnel\u3002 productpage \u8282\u70b9\u4e0a\u7684 ztunnel \u6536\u5230\u52a0\u5bc6\u7684\u6570\u636e\u5305\u540e\uff0c\u8fdb\u884c\u89e3\u5bc6\uff0c\u7136\u540e\u53d1\u9001\u7ed9 productpage\u3002 kubectl logs -n istio-system ztunnel-fnjg2 -f \u6211\u4eec\u53ef\u4ee5\u770b\u5230 outbound \u6d41\u91cf\u7684\u65e5\u5fd7\u4e2d\u6709\uff08no waypoint proxy\uff09\u7684\u5b57\u6837\uff0cambient mesh \u9ed8\u8ba4\u53ea\u8fdb\u884c L4 \u5904\u7406\uff0c\u4e0d\u4f1a\u8fdb\u884c L7 \u5904\u7406\u3002\u56e0\u6b64\u6b64\u65f6\u6d41\u91cf\u53ea\u4f1a\u901a\u8fc7 ztunnel \uff0c\u4e0d\u4f1a\u7ecf\u8fc7 waypoint proxy\u3002 \u67e5\u770b inbound \u65b9\u5411\u7684\u6d41\u91cf\u65e5\u5fd7\uff08productpage \u4e0a\u7684 ztunnel -> productpage\uff09\u3002 kubectl logs -n istio-system ztunnel-k4jhb -f 9.2 L4 \u6388\u6743\u7b56\u7565 \u5b89\u5168\u8986\u76d6\u5c42\u53ef\u4ee5\u5b9e\u73b0\u7b80\u5355\u7684 L4 \u6388\u6743\u7b56\u7565\uff0c\u5982\u4e0b\u6240\u793a\u521b\u5efa\u4e00\u4e2a AuthorizationPolicy \uff0c\u53ea\u5141\u8bb8 Service Account \u662f sleep \u7684\u7528\u6237\u8bbf\u95ee\u6807\u7b7e\u662f app=productpage \u5e94\u7528\u3002 kubectl apply -f - <<EOF apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: productpage-viewer namespace: default spec: selector: matchLabels: app: productpage action: ALLOW rules: - from: - source: principals: [\"cluster.local/ns/default/sa/sleep\"] EOF \u5206\u522b\u5728 sleep \u548c notsleep \u4e0a\u6267\u884c\u4ee5\u4e0b\u8bf7\u6c42\uff0c\u7531\u4e8e\u5f53\u524d\u8fd8\u6ca1\u6709\u542f\u7528 L7 \u5904\u7406\uff0c\u56e0\u6b64\u8fd8\u65e0\u6cd5\u9488\u5bf9 HTTP \u8bf7\u6c42\u65b9\u6cd5\uff0c\u8def\u5f84\u7b49\u6761\u4ef6\u8fdb\u884c\u9650\u5236\u3002 # \u6210\u529f kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 # \u6210\u529f kubectl exec deploy/sleep -- curl -XDELETE -s http://productpage:9080/ | head -n1 # \u5931\u8d25\uff0c\u53ea\u5141\u8bb8 sa \u662f sleep \u7684\u7528\u6237 kubectl exec deploy/notsleep -- curl -s http://productpage:9080/ | head -n1 10 \u542f\u7528 L7 \u529f\u80fd \u8981\u4e3a\u670d\u52a1\u542f\u7528 L7 \u7f51\u683c\u80fd\u529b\uff0c\u9700\u8981\u663e\u5f0f\u521b\u5efa\u4e00\u4e2a Gateway\uff0c\u6ce8\u610f\u521b\u5efa\u7684 Gateway \u8d44\u6e90\u4e2d\u7684 gatewayClassName \u5fc5\u987b\u8bbe\u7f6e\u4e3a istio-mesh \uff0c\u8fd9\u6837 Istio \u624d\u4f1a\u4e3a productpage \u521b\u5efa\u5bf9\u5e94\u7684 waypoint proxy\u3002 \u4efb\u4f55\u53d1\u5f80 productpage \u670d\u52a1\u7684\u6d41\u91cf\u90fd\u5c06\u7ecf\u8fc7 waypoint proxy \u8fd9\u4e2a L7 \u4ee3\u7406\u8fdb\u884c\u5904\u7406\u3002 kubectl apply -f - <<EOF apiVersion: gateway.networking.k8s.io/v1alpha2 kind: Gateway metadata: name: productpage annotations: istio.io/service-account: bookinfo-productpage spec: gatewayClassName: istio-mesh EOF \u67e5\u770b Istio \u4e3a productpage \u521b\u5efa\u7684 waypoint proxy\u3002 \u4ece sleep \u8bbf\u95ee productpage\u3002 kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 \u67e5\u770b outbound \u65b9\u5411\u7684\u6d41\u91cf\u65e5\u5fd7\uff08sleep -> sleep node \u4e0a\u7684 ztunnel -> waypoint proxy\uff09\u3002 kubectl logs -n istio-system ztunnel-fnjg2 -f \u4ece\u4e0b\u9762\u7684\u65e5\u5fd7\u4e2d\u53ef\u4ee5\u770b\u5230\uff08to server waypoint proxy\uff09\u7684\u5b57\u6837\uff0c\u8bf4\u660e\u8bf7\u6c42\u53d1\u5f80 waypoint proxy \u8fdb\u884c\u5904\u7406\u3002 10.1 L7 \u6388\u6743\u7b56\u7565 \u63a5\u4e0b\u6765\u66f4\u65b0 AuthorizationPolicy \u53ea\u5141\u8bb8 Service Account \u662f sleep \u7684\u7528\u6237\u901a\u8fc7 GET \u7684\u65b9\u5f0f\u8bbf\u95ee\u6807\u7b7e\u662f app=productpage \u5e94\u7528\u3002 kubectl apply -f - <<EOF apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: productpage-viewer namespace: default spec: selector: matchLabels: app: productpage action: ALLOW rules: - from: - source: principals: [\"cluster.local/ns/default/sa/sleep\"] to: - operation: methods: [\"GET\"] EOF \u5206\u522b\u5728 sleep \u548c notsleep \u4e0a\u6267\u884c\u4ee5\u4e0b\u8bf7\u6c42\uff0c\u8fd9\u6b21\u5728 sleep \u4e0a\u6267\u884c HTTP DELETE \u8bf7\u6c42\u4e5f\u4f1a\u88ab\u62d2\u7edd\u4e86\u3002 # \u6210\u529f kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 # \u5931\u8d25\uff0cRBAC \u9519\u8bef\uff0c\u56e0\u4e3a\u4e0d\u662f GET \u8bf7\u6c42 kubectl exec deploy/sleep -- curl -X DELETE -s http://productpage:9080/ | head -n1 # \u5931\u8d25\uff0cRBAC \u9519\u8bef\uff0c\u53ea\u5141\u8bb8 sa \u662f sleep \u7684\u7528\u6237 kubectl exec deploy/notsleep -- curl -s http://productpage:9080/ | head -n1 10.2 \u53ef\u89c2\u6d4b\u6027 \u5728 productpage waypoint proxy \u4e0a\u53ef\u4ee5\u67e5\u770b\u6240\u6709\u5bf9 productpage \u670d\u52a1\u8bf7\u6c42\u7684 L7 \u6307\u6807\u3002 kubectl exec deploy/bookinfo-productpage-waypoint-proxy -- curl -s http://localhost:15020/stats/prometheus | grep istio_requests_total 10.3 \u6d41\u91cf\u63a7\u5236 \u9996\u5148\u4e3a reviews \u670d\u52a1\u521b\u5efa\u4e00\u4e2a gateway\uff0c\u542f\u7528 L7 \u80fd\u529b\u3002 kubectl apply -f - <<EOF apiVersion: gateway.networking.k8s.io/v1alpha2 kind: Gateway metadata: name: reviews annotations: istio.io/service-account: bookinfo-reviews spec: gatewayClassName: istio-mesh EOF \u7136\u540e\u5206\u522b\u521b\u5efa VirtualService \u548c DestinationRule \u6765\u63a7\u5236\u6d41\u91cf\u4ee5 90/10 \u7684\u6bd4\u4f8b\u53d1\u5f80 v1 \u7248\u672c\u548c v2 \u7248\u672c\u7684 reviews \u670d\u52a1\u3002 kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 weight: 90 - destination: host: reviews subset: v2 weight: 10 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews trafficPolicy: loadBalancer: simple: RANDOM subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 EOF \u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u4ece sleep \u5f80 productpage \u53d1\u9001 10 \u4e2a\u8bf7\u6c42\uff0c\u53ef\u4ee5\u770b\u5230\u5927\u7ea6\u6709 10% \u7684\u6d41\u91cf\u6d41\u5411\u4e86 reviews-v2 \u3002 # \u6ce8\u610f\u8bbf\u95ee\u8def\u5f84\u662f http://productpage:9080/productpage\uff0c\u4f1a\u8c03\u7528 reviews \u670d\u52a1 kubectl exec -it deploy/sleep -- sh -c 'for i in $(seq 1 10); do curl -s http://productpage:9080/productpage | grep reviews-v.-; done' # \u8fd4\u56de\u7ed3\u679c <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v2-6bdd859457-7lxhc</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v2-6bdd859457-7lxhc</u> 10.4 \u6545\u969c\u6ce8\u5165 \u4e3a productpage \u670d\u52a1\u521b\u5efa\u4e00\u4e2a VirtualService\uff0c\u5728\u8bf7\u6c42\u4e2d\u6ce8\u5165 5s \u7684\u5ef6\u65f6\u3002 kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: productpage spec: hosts: - productpage http: - route: - destination: host: productpage fault: delay: percentage: value: 100.0 fixedDelay: 5s EOF \u4ece sleep \u8bbf\u95ee productpage\uff0c\u53ef\u4ee5\u770b\u5230\u8bf7\u6c42\u6d88\u8017\u7684\u65f6\u95f4\u5927\u7ea6\u5728 5s \u5de6\u53f3\u3002 > kubectl exec deploy/sleep -- time curl -s http://productpage:9080 | head -n 1 # \u8fd4\u56de\u7ed3\u679c <!DOCTYPE html> real 0m 5.04s user 0m 0.00s sys 0m 0.00s 11 \u6e05\u7406\u73af\u5883 # \u5378\u8f7d Istio istioctl uninstall -y --purge && istioctl delete ns istio-system # \u5220\u9664\u793a\u4f8b\u5e94\u7528 kubectl delete -f samples/bookinfo/platform/kube/bookinfo.yaml kubectl delete -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/sleep.yaml kubectl delete -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/notsleep.yaml # \u5220\u9664\u96c6\u7fa4 eksctl delete cluster aws-demo-cluster01 12 \u4f53\u9a8c Demo \u60f3\u8981\u5feb\u901f\u4f53\u9a8c ambient mesh \u7684\u670b\u53cb\u4e5f\u53ef\u4ee5\u5728 solo.io \u5b98\u7f51 \u4e0a\u5c1d\u8bd5\u4e0a\u624b\u6559\u7a0b\u3002 Istio \u65e0 sidecar \u4ee3\u7406\u6570\u636e\u5e73\u9762 ambient \u6a21\u5f0f\u7b80\u4ecb: https://lib.jimmysong.io/blog/introducing-ambient-mesh/ \u8bd1\u6587\uff1aIstio Ambient \u6a21\u5f0f\u5b89\u5168\u67b6\u6784\u6df1\u5ea6\u89e3\u6790: https://www.zhaohuabing.com/post/2022-09-09-ambient-mesh-security-deep-dive/ \u5982\u4f55\u8bc4\u4ef7 Istio \u65b0\u63a8\u51fa\u7684 Ambient \u6a21\u5f0f\uff1f: https://mp.weixin.qq.com/s/98wXMdeutx0wHqcJUIFl8A \u521d\u63a2 Istio Ambient \u6a21\u5f0f: https://mp.weixin.qq.com/s/YA2My5PSHXIwovWLRKmsgA Istio Ambient \u6a21\u5f0f HBONE \u96a7\u9053\u539f\u7406\u8be6\u89e3 - \u4e0a: https://mp.weixin.qq.com/s/ksiYJEJKnit65KfIIGoN8Q Create a kubeconfig for Amazon EKS: https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html Beyond Istio OSS \u2014\u2014 Istio \u670d\u52a1\u7f51\u683c\u7684\u73b0\u72b6\u4e0e\u672a\u6765: https://jimmysong.io/blog/beyond-istio-oss/#sidecar-management","title":"2 Istio Ambient Mesh \u4ecb\u7ecd"},{"location":"chap10/2istio_ambient/#2-istio-ambient-mesh","text":"","title":"2 Istio Ambient Mesh \u4ecb\u7ecd"},{"location":"chap10/2istio_ambient/#1-ambient-mesh","text":"Istio \u7684\u4f20\u7edf\u6a21\u5f0f\u662f\u5c06 Envoy proxy \u4f5c\u4e3a sidecar \u90e8\u7f72\u5728\u5de5\u4f5c\u8d1f\u8f7d\u7684 pod \u4e2d\uff0c\u867d\u7136\u4e0e\u91cd\u6784\u5e94\u7528\u7a0b\u5e8f\u76f8\u6bd4\uff0csidecar \u5177\u6709\u663e\u8457\u7684\u4f18\u52bf\uff0c\u4f46\u662f\u4ecd\u7136\u4f1a\u4ea7\u751f\u4e00\u4e9b\u9650\u5236\uff1a \u4fb5\u5165\u6027 \uff1asidecar \u5fc5\u987b\u901a\u8fc7\u4fee\u6539 Kubernetes Pod \u7684\u914d\u7f6e\u548c\u91cd\u5b9a\u5411\u6d41\u91cf\u6765\u201c\u6ce8\u5165\u201d\u5e94\u7528\u7a0b\u5e8f\u3002\u56e0\u6b64\uff0c\u5b89\u88c5\u548c\u5347\u7ea7 sidecar \u9700\u8981\u91cd\u65b0\u542f\u52a8 Pod\uff0c\u8fd9\u5c06\u4f1a\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u4ea7\u751f\u5f71\u54cd\u3002 \u8d44\u6e90\u5229\u7528\u7387\u4f4e \uff1a\u7531\u4e8e\u5728\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d Pod \u90fd\u6ce8\u5165\u4e86 sidecar \u4ee3\u7406 \uff0c\u56e0\u6b64 Pod \u5fc5\u987b\u4e3a sidecar \u9884\u7559\u8db3\u591f\u7684 CPU \u548c\u5185\u5b58\u8d44\u6e90\uff0c\u4ece\u800c\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u7684\u8d44\u6e90\u5229\u7528\u7387\u4e0d\u8db3\u3002 \u6d41\u91cf\u4e2d\u65ad \uff1a\u6d41\u91cf\u6355\u83b7\u548c HTTP \u5904\u7406\u901a\u5e38\u662f\u7531 Istio \u7684 sidecar \u5b8c\u6210\u7684\uff0c\u8ba1\u7b97\u9700\u8981\u6d88\u8017\u5927\u91cf\u7684\u8d44\u6e90\uff0c\u5e76\u4e14\u53ef\u80fd\u4f1a\u7834\u574f\u4e00\u4e9b\u4e0d\u7b26\u5408 HTTP \u5b9e\u73b0\u7684\u5e94\u7528\u7a0b\u5e8f\u3002 Istio ambient mesh \u662f Istio \u7684\u4e00\u4e2a\u65e0 sidecar \u7684\u6570\u636e\u5e73\u9762 \uff0c\u65e8\u5728\u964d\u4f4e\u57fa\u7840\u8bbe\u65bd\u6210\u672c\u548c\u63d0\u9ad8\u6027\u80fd\u3002 \u5b83\u7684\u672c\u8d28\u662f\u5206\u79bb sidecar proxy\uff08Envoy\uff09\u4e2d\u7684 L4 \u548c L7 \u529f\u80fd\uff0c\u8ba9\u4e00\u90e8\u5206\u4ec5\u9700\u8981\u5b89\u5168\u529f\u80fd\u7684\u7528\u6237\u53ef\u4ee5\u6700\u5c0f\u963b\u529b\uff08\u4f4e\u8d44\u6e90\u6d88\u8017\u3001\u8fd0\u7ef4\u6210\u672c\uff09\u5730\u4f7f\u7528 Istio service mesh \u3002 ambient mesh \u5c06 Istio \u7684\u529f\u80fd\u62c6\u5206\u4e3a 2 \u4e2a\u4e0d\u540c\u7684\u5c42\u6b21\uff1a L4 \u5b89\u5168\u8986\u76d6\u5c42\uff1a\u7528\u6237\u53ef\u4ee5\u4f7f\u7528 TCP \u8def\u7531\uff0cmTLS \u548c\u6709\u9650\u7684\u53ef\u89c2\u6d4b\u6027\u7b49\u529f\u80fd\u3002 L7 \u5904\u7406\u5c42\uff1a\u7528\u6237\u53ef\u4ee5\u6309\u9700\u542f\u7528 L7 \u529f\u80fd\uff0c\u4ee5\u83b7\u5f97 Istio \u7684\u5168\u90e8\u529f\u80fd\uff0c\u4f8b\u5982\u9650\u901f\uff0c\u6545\u969c\u6ce8\u5165\uff0c\u8d1f\u8f7d\u5747\u8861\uff0c\u7194\u65ad\u7b49\u7b49\u3002 ztunnel \u662f ambient mesh \u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u5171\u4eab\u4ee3\u7406\uff0c\u4ee5 DaemonSet \u7684\u65b9\u5f0f\u90e8\u7f72\uff0c\u5904\u4e8e\u7c7b\u4f3c\u4e8e CNI \u7684\u7f51\u683c\u5e95\u5c42 \u3002 ztunnel \u5728\u8282\u70b9\u95f4\u6784\u5efa\u96f6\u4fe1\u4efb\u7684\u96a7\u9053\uff08zero-trust tunnel, ztunnel\uff09\uff0c\u8d1f\u8d23\u5b89\u5168\u5730\u8fde\u63a5\u548c\u9a8c\u8bc1\u7f51\u683c\u5185\u7684\u5143\u7d20\u3002 \u5728 ambient mesh \u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6240\u6709\u6d41\u91cf\u4f1a\u91cd\u5b9a\u5411\u5230\u672c\u5730\u7684 ztunnel \u8fdb\u884c\u5904\u7406\uff0cztunnel \u8bc6\u522b\u6d41\u91cf\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5e76\u4e3a\u5176\u9009\u62e9\u6b63\u786e\u7684\u8bc1\u4e66\u4ee5\u5efa\u7acb mTLS \u8fde\u63a5\u3002 ztunnel \u5b9e\u73b0\u4e86\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6838\u5fc3\u529f\u80fd\uff1a \u96f6\u4fe1\u4efb\uff0c\u5b83\u4f1a\u4e3a\u542f\u7528\u4e86 ambient mesh \u7684 Namespace \u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u4e00\u4e2a\u5b89\u5168\u8986\u76d6\u5c42\uff0c\u63d0\u4f9b mTLS\uff0c\u9065\u6d4b\uff0c\u8ba4\u8bc1\u548c L4 \u6388\u6743\u7b49\u529f\u80fd\uff0c\u800c\u65e0\u9700\u7ec8\u6b62\u6216\u89e3\u6790 HTTP \u3002 \u5728\u542f\u7528 ambient mesh \u548c\u521b\u5efa\u5b89\u5168\u8986\u76d6\u5c42\u4e4b\u540e\uff0c\u53ef\u4ee5\u9009\u62e9\u6027\u5730\u4e3a namespace \u542f\u7528 L7 \u529f\u80fd\uff0c\u8fd9\u5141\u8bb8\u547d\u540d\u7a7a\u95f4\u5b9e\u73b0\u5168\u5957\u7684 Istio \u529f\u80fd\uff0c\u5305\u62ec Virtual Service\u3001L7 \u9065\u6d4b \u548c L7 \u6388\u6743\u7b56\u7565 \u3002 waypoint proxy \u53ef\u4ee5\u6839\u636e\u6240\u670d\u52a1\u7684 Namespace \u7684\u5b9e\u65f6\u6d41\u91cf\u81ea\u52a8\u6269\u7f29\u5bb9\uff0c\u8fd9\u5c06\u4e3a\u7528\u6237\u8282\u7701\u5927\u91cf\u7684\u8d44\u6e90\u3002 Istio \u4f1a\u4e3a\u6839\u636e\u670d\u52a1\u7684 service account \u521b\u5efa\u76f8\u5e94\u7684 waypoint proxy \uff0c\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u5728\u51cf\u5c11\u8d44\u6e90\u6d88\u8017\u7684\u60c5\u51b5\u4e0b\u540c\u65f6\u5c3d\u53ef\u80fd\u5730\u7f29\u5c0f\u6545\u969c\u57df\uff0c\u53c2\u89c1\u4e0b\u56fe Model III\u3002","title":"1 Ambient Mesh \u4ecb\u7ecd"},{"location":"chap10/2istio_ambient/#2-ambient-mesh","text":"\u76ee\u524d\u5df2\u77e5 ambient mesh \u4ec5\u652f\u6301\u4ee5\u4e0b\u73af\u5883\uff0c\u5176\u4ed6\u73af\u5883\u76ee\u524d\u5c1a\u672a\u7ecf\u8fc7\u6d4b\u8bd5\u3002 GKE (without Calico or Dataplane V2) EKS kind \u5e76\u4e14 ambient mesh \u8fd8\u6709\u8bb8\u591a\u9650\u5236\uff0c\u4f8b\u5982\uff1a AuthorizationPolicy \u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u6ca1\u6709\u9884\u671f\u7684\u90a3\u4e48\u4e25\u683c\uff0c\u6216\u8005\u6839\u672c\u65e0\u6548\u3002 \u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u76f4\u63a5\u8bbf\u95ee Pod IP \u800c\u4e0d\u662f Service \u7684\u8bf7\u6c42\u5c06\u65e0\u6548 \u3002 ambient mesh \u4e0b\u7684\u670d\u52a1\u65e0\u6cd5\u901a\u8fc7 LoadBalancer \u548c NodePort \u7684\u65b9\u5f0f\u8bbf\u95ee\uff0c\u4e0d\u8fc7\u4f60\u53ef\u4ee5\u90e8\u7f72\u4e00\u4e2a\u5165\u53e3\u7f51\u5173\uff08\u672a\u542f\u7528 ambient mesh\uff09\u4ee5\u4ece\u5916\u90e8\u8bbf\u95ee\u670d\u52a1\uff1b STRICT mTLS \u4e0d\u80fd\u5b8c\u5168\u963b\u6b62\u660e\u6587\u6d41\u91cf \u3002 \u4e0d\u652f\u6301 EnvoyFilter \u3002 \u8be6\u7ec6\u8bf4\u660e\u8bf7\u53c2\u89c1 Ambient Mesh \u3002","title":"2 Ambient Mesh \u652f\u6301\u7684\u73af\u5883\u548c\u9650\u5236"},{"location":"chap10/2istio_ambient/#3-eksctl-aws-kubernetes","text":"\u5728\u672c\u793a\u4f8b\u4e2d\uff0c\u5c06\u4f7f\u7528 eksctl \u5728 AWS \u4e0a\u521b\u5efa EKS \u96c6\u7fa4\u6765\u6d4b\u8bd5 Istio ambient mesh\u3002 eksctl \u662f\u4e00\u4e2a\u7528\u4e8e\u7ba1\u7406 EKS\uff08Amazon \u6258\u7ba1 Kubernetes \u670d\u52a1\uff09\u7684 CLI \u5de5\u5177\u3002\u6709\u5173 eksctl \u7684\u5b89\u88c5\u548c\u4f7f\u7528\u53c2\u89c1 eksctl Getting started \u521b\u5efa\u96c6\u7fa4\u914d\u7f6e\u6587\u4ef6 cluster.yaml\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a 2 \u4e2a Worker \u8282\u70b9\u7684 EKS \u96c6\u7fa4\uff0c\u6bcf\u4e2a\u8282\u70b9\u8d44\u6e90\u4e3a 2C8G\uff0c\u96c6\u7fa4\u7248\u672c\u4e3a 1.23\u3002 apiVersion: eksctl.io/v1alpha5 kind: ClusterConfig metadata: name: aws-demo-cluster01 region: us-east-1 version: '1.23' nodeGroups: - name: ng-1 instanceType: m5.large desiredCapacity: 2 volumeSize: 100 ssh: allow: true # will use ~/.ssh/id_rsa.pub as the default ssh key \u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u521b\u5efa EKS \u96c6\u7fa4\u3002 eksctl create cluster -f cluster.yaml \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b EKS \u96c6\u7fa4\u3002 > eksctl get cluster NAME REGION EKSCTL CREATED aws-demo-cluster01 us-east-1 True \u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5c06 aws-demo-cluster01 \u96c6\u7fa4\u7684 kubeconfig \u6587\u4ef6\u66f4\u65b0\u5230 ~/.kube/config \u6587\u4ef6\u4e2d\uff0c\u8ba9\u6211\u4eec\u672c\u5730\u7684 kubectl \u5de5\u5177\u53ef\u4ee5\u8bbf\u95ee\u5230 aws-demo-cluster01 \u96c6\u7fa4\u3002 aws eks update-kubeconfig --region us-east-1 --name aws-demo-cluster01 \u6709\u5173 aws CLI \u5de5\u5177\u7684\u5b89\u88c5\u53c2\u89c1 Installing or updating the latest version of the AWS CLI \uff0caws CLI \u7684\u8ba4\u8bc1\u53c2\u89c1 Configuration basics \u3002","title":"3 \u4f7f\u7528 Eksctl \u5728 AWS \u4e0a\u521b\u5efa Kubernetes \u96c6\u7fa4"},{"location":"chap10/2istio_ambient/#4-istio","text":"\u6839\u636e\u5bf9\u5e94\u64cd\u4f5c\u7cfb\u7edf\u4e0b\u8f7d\u652f\u6301 ambient mesh \u7684 istioctl \u4e8c\u8fdb\u5236\u6587\u4ef6\u548c\u793a\u4f8b\u8d44\u6e90\u6587\u4ef6\uff0c\u53c2\u89c1 Istio \u4e0b\u8f7d \u3002\u5176\u4e2d istioctl \u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u53ef\u4ee5\u5728 bin \u76ee\u5f55\u4e2d\u627e\u5230\uff0c\u793a\u4f8b\u8d44\u6e90\u6587\u4ef6\u53ef\u4ee5\u5728 samples \u76ee\u5f55\u4e2d\u627e\u5230\u3002","title":"4 \u4e0b\u8f7d Istio"},{"location":"chap10/2istio_ambient/#5","text":"\u90e8\u7f72 Istio \u793a\u4f8b\u7684 Bookinfo \u5e94\u7528\u7a0b\u5e8f\uff0c\u4ee5\u53ca sleep \u548c notsleep \u4e24\u4e2a\u5ba2\u6237\u7aef\u3002sleep \u548c notsleep \u53ef\u4ee5\u6267\u884c curl \u547d\u4ee4\u6765\u53d1\u8d77 HTTP \u8bf7\u6c42\u3002 kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml kubectl apply -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/sleep.yaml kubectl apply -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/notsleep.yaml \u5f53\u524d\u6211\u4eec\u90e8\u7f72\u7684 istio \u548c\u5e94\u7528\u7684 Pod \u548c Service \u5982\u4e0b\u6240\u793a\u3002","title":"5 \u90e8\u7f72\u793a\u4f8b\u5e94\u7528"},{"location":"chap10/2istio_ambient/#6-istio","text":"\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5b89\u88c5 Istio\uff0c\u5e76\u6307\u5b9a profile=ambient \u53c2\u6570\u90e8\u7f72 ambient mesh \u76f8\u5173\u7684\u7ec4\u4ef6\u3002 istioctl install --set profile=ambient \u5982\u679c\u5b89\u88c5\u6210\u529f\u5c06\u4f1a\u8f93\u51fa\u4ee5\u4e0b\u7ed3\u679c\u3002 \u2714 Istio core installed \u2714 Istiod installed \u2714 Ingress gateways installed \u2714 CNI installed \u2714 Installation complete \u5b89\u88c5\u5b8c\u6210\u4ee5\u540e\u6211\u4eec\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u5185\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u7ec4\u4ef6\uff1a istiod\uff1aIstio \u7684\u6838\u5fc3\u7ec4\u4ef6\u3002 istio-ingressgateway \uff1a\u7ba1\u7406\u8fdb\u51fa\u96c6\u7fa4\u7684\u5357\u5317\u5411\u6d41\u91cf\uff0c\u5728\u672c\u793a\u4f8b\u4e2d\u6211\u4eec\u4e0d\u4f1a\u7528\u5230 istio-ingressgateway \u3002 istio-cni \uff1a\u4e3a\u52a0\u5165 ambient mesh \u7684 Pod \u914d\u7f6e\u6d41\u91cf\u91cd\u5b9a\u5411\uff0c\u5c06 Pod \u7684\u8fdb\u51fa\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u76f8\u540c\u8282\u70b9\u7684 ztunnel \u4e0a\u3002 ztunnel \uff1aztunnel \u5728\u8282\u70b9\u95f4\u6784\u5efa\u96f6\u4fe1\u4efb\u7684\u96a7\u9053\uff0c\u63d0\u4f9b mTLS\uff0c\u9065\u6d4b\uff0c\u8ba4\u8bc1\u548c L4 \u6388\u6743\u7b49\u529f\u80fd\u3002 > kubectl get pod -n istio-system NAME READY STATUS RESTARTS AGE istio-cni-node-gfmqp 1/1 Running 0 100s istio-cni-node-t2flv 1/1 Running 0 100s istio-ingressgateway-f6d95c86b-mfk4t 1/1 Running 0 101s istiod-6c99d96db7-4ckbm 1/1 Running 0 2m23s ztunnel-fnjg2 1/1 Running 0 2m24s ztunnel-k4jhb 1/1 Running 0 2m24s","title":"6 \u90e8\u7f72 Istio"},{"location":"chap10/2istio_ambient/#7","text":"\u4e3a\u4e86\u66f4\u76f4\u89c2\u5730\u89c2\u5bdf\u6d41\u91cf\u7684\u8bbf\u95ee\u60c5\u51b5 \uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9 Pod \u8fdb\u884c\u6293\u5305\uff0c\u4f46\u662f\u5e94\u7528 Pod \u5e76\u6ca1\u6709\u5b89\u88c5\u76f8\u5173\u7684\u6293\u5305\u5de5\u5177\uff0c\u8fd9\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 kubectl debug \u5de5\u5177\u521b\u5efa\u4e00\u4e2a ephemeral \u4e34\u65f6\u5bb9\u5668\u5171\u4eab\u5bb9\u5668\u7684\u547d\u540d\u7a7a\u95f4\u6765\u8fdb\u884c\u8c03\u8bd5\u3002\u6709\u5173 kubectl debug \u8be6\u60c5\u8bf7\u53c2\u89c1\u8c03\u8bd5\u8fd0\u884c\u4e2d\u7684 Pod\u3002 \u5728 4 \u4e2a\u7ec8\u7aef\u5206\u522b\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5bf9 sleep \u548c productpage \u4ee5\u53ca\u4e24\u4e2a\u8282\u70b9\u4e0a\u7684 ztunnel Pod \u8fdb\u884c\u6293\u5305\u3002 --image \u53c2\u6570\u6307\u5b9a\u4e34\u65f6\u5bb9\u5668\u7684\u955c\u50cf\uff0c\u8fd9\u91cc\u4f7f\u7528\u7684 nicolaka/netshoot \u955c\u50cf\u4e2d\u9884\u88c5\u4e86 tcpdump , tshark , termshark \u7b49\u5e38\u7528\u7684\u7f51\u7edc\u6293\u5305\u5de5\u5177\u3002 kubectl debug -it sleep-55697f8897-n2ldz --image=nicolaka/netshoot kubectl debug -it productpage-v1-5586c4d4ff-z8jbb --image=nicolaka/netshoot kubectl debug -it -n istio-system ztunnel-fnjg2 --image=nicolaka/netshoot kubectl debug -it -n istio-system ztunnel-k4jhb --image=nicolaka/netshoot \u5728 4 \u4e2a\u7ec8\u7aef\u5206\u522b\u6267\u884c termshark -i eth0 \u547d\u4ee4\uff0c\u5bf9 Pod \u7684 eth0 \u7f51\u5361\u8fdb\u884c\u6293\u5305\u3002 \u7531\u4e8e istio-cni \u4f1a\u6301\u7eed\u5bf9 ztunnel \u53d1\u8d77\u8def\u5f84\u4e3a /healthz/ready \u7684HTTP \u5065\u5eb7\u63a2\u6d4b\uff0c\u4e3a\u4e86\u907f\u514d\u8be5\u6d41\u91cf\u5f71\u54cd\u6211\u4eec\u7684\u89c2\u5bdf\uff0c\u5728 2 \u4e2a ztunnel Pod \u4e2d\u7684 termshark Filter \u6846\u4e2d\u8bbe\u7f6e\u4ee5\u4e0b\u8fc7\u6ee4\u6761\u4ef6\u3002 # ztunnel-fnjg2\uff0csleep \u6240\u5728\u8282\u70b9\u7684 ztunnel ip.addr==192.168.58.148 || ip.addr==192.168.13.108 # ztunnel-k4jhb\uff0cproductpage \u6240\u5728\u8282\u70b9\u7684 ztunnel ip.addr==192.168.13.108","title":"7 \u6293\u5305\u8bbe\u7f6e"},{"location":"chap10/2istio_ambient/#8-ambient-mesh","text":"\u7531\u4e8e\u5f53\u524d default Namespace \u8fd8\u6ca1\u6709\u52a0\u5165 ambient mesh\uff0c\u6b64\u65f6\u5e94\u7528\u7684\u6d41\u91cf\u5e76\u4e0d\u4f1a\u7ecf\u8fc7 ztunnel \uff0cPod \u4e4b\u95f4\u901a\u8fc7 kubernetes \u7684 Service \u8fdb\u5236\u8fdb\u884c\u901a\u4fe1\uff0cPod \u4e4b\u95f4\u7684\u6d41\u91cf\u4e5f\u4e0d\u4f1a\u8fdb\u884c mTLS \u52a0\u5bc6\uff0c\u800c\u662f\u4ee5\u660e\u6587\u7684\u65b9\u5f0f\u8fdb\u884c\u4f20\u64ad\u3002 \u4f7f\u7528 sleep \u5411 productpage \u53d1\u8d77\u4e00\u6b21\u8bf7\u6c42\u3002 kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 # \u8fd4\u56de\u7ed3\u679c\uff0c\u54cd\u5e94\u7ed3\u679c\u7684\u7b2c\u4e00\u884c\u5185\u5bb9 <!DOCTYPE html> \u67e5\u770b sleep \u548c productpage \u7684\u6293\u5305\u7ed3\u679c\u53ef\u4ee5\u770b\u5230\uff0csleep \uff08192.168.58.148\uff09 \u8bbf\u95ee productpage Service \u540d\u79f0 DNS \u89e3\u6790\u540e\u7684 service IP\uff0810.100.171.143\uff09\uff0c\u7ecf\u8fc7 kubernetes Service \u7684\u8f6c\u53d1\u540e\uff0c\u6700\u7ec8\u8bbf\u95ee\u5230 productpage \u7684\u5b9e\u9645 Pod IP \uff08192.168.13.108\uff09\u3002 \u6b64\u65f6 ambient mesh \u8fd8\u672a\u63a5\u7ba1 default Namespace \u7684\u6d41\u91cf\uff0c\u56e0\u6b64\u5728 ztunnel \u4e0a\u4e0d\u4f1a\u6293\u5230\u76f8\u5173\u7684\u6570\u636e\u5305\u3002","title":"8 \u672a\u4f7f\u7528 Ambient Mesh \u7ba1\u7406\u6d41\u91cf"},{"location":"chap10/2istio_ambient/#9-default-namespace-ambient-meshl4","text":"\u4e3a default Namespace \u6dfb\u52a0 istio.io/dataplane-mode=ambient \u6807\u7b7e\uff0c\u8868\u793a\u5c06\u8be5 Namespace \u52a0\u5165\u5230 ambient mesh \u4e2d\u3002 kubectl label namespace default istio.io/dataplane-mode=ambient \u4e00\u65e6 Namespace \u52a0\u5165 ambient mesh \uff0c istio-cni DaemonSet \u5c31\u4f1a\u4e3a\u8be5 Namespace \u4e2d\u7684 Pod \u8bbe\u7f6e iptables \u91cd\u5b9a\u5411\u89c4\u5219\uff0c\u5c06 Pod \u7684\u6240\u6709\u51fa\u5165\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u8fd0\u884c\u5728\u76f8\u540c\u8282\u70b9\u7684 ztunnel \u4e0a \u3002","title":"9 \u5c06 Default Namespace \u52a0\u5165 Ambient Mesh\uff08L4 \u529f\u80fd\uff09"},{"location":"chap10/2istio_ambient/#91-mtls","text":"ztunnel \u4f1a\u4e3a\u542f\u7528\u4e86 ambient mesh \u7684 Namespace \u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u4e00\u4e2a\u5b89\u5168\u8986\u76d6\u5c42\uff0c\u63d0\u4f9b mTLS\uff0c\u9065\u6d4b\uff0c\u8ba4\u8bc1\u548c L4 \u6388\u6743\u7b49\u529f\u80fd \u3002 \u4e3a\u4e86\u65b9\u4fbf\u67e5\u770b\uff0c\u53ef\u4ee5\u5148\u6e05\u9664\u5148\u524d\u5728 sleep \u548c productpage \u4e0a\u6293\u5230\u7684\u62a5\u6587\u3002 \u7136\u540e\u4f7f\u7528 sleep \u5411 productpage \u53d1\u8d77\u4e00\u6b21\u8bf7\u6c42\u3002 kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 \u5728 sleep \u548c productpage \u4e0a\u4f9d\u7136\u53ef\u4ee5\u6293\u5230\u660e\u6587\u7684\u6570\u636e\u5305\uff0c\u53ea\u662f\u8fd9\u56de\u5728 productpage \u4e0a\u6293\u5230\u7684\u6570\u636e\u5305\u7684\u6e90 IP \u53d8\u4e3a\u7684 sleep \u6240\u5728\u8282\u70b9\u7684 ztunnel \u7684 IP \u5730\u5740\u3002 \u5728 sleep \u8282\u70b9\u6240\u5728\u7684 ztunnel \u4e0a\u6211\u4eec\u53ef\u4ee5\u6293\u5230 sleep \u53d1\u8fc7\u6765\u7684\u660e\u6587\u7684\u6570\u636e\u5305\uff0cztunnel \u4f1a\u5bf9\u6570\u636e\u5305\u8fdb\u884c\u52a0\u5bc6\u4ee5\u540e\u53d1\u9001\u7ed9 productpage \u8282\u70b9\u4e0a\u7684 ztunnel\u3002 productpage \u8282\u70b9\u4e0a\u7684 ztunnel \u6536\u5230\u52a0\u5bc6\u7684\u6570\u636e\u5305\u540e\uff0c\u8fdb\u884c\u89e3\u5bc6\uff0c\u7136\u540e\u53d1\u9001\u7ed9 productpage\u3002 kubectl logs -n istio-system ztunnel-fnjg2 -f \u6211\u4eec\u53ef\u4ee5\u770b\u5230 outbound \u6d41\u91cf\u7684\u65e5\u5fd7\u4e2d\u6709\uff08no waypoint proxy\uff09\u7684\u5b57\u6837\uff0cambient mesh \u9ed8\u8ba4\u53ea\u8fdb\u884c L4 \u5904\u7406\uff0c\u4e0d\u4f1a\u8fdb\u884c L7 \u5904\u7406\u3002\u56e0\u6b64\u6b64\u65f6\u6d41\u91cf\u53ea\u4f1a\u901a\u8fc7 ztunnel \uff0c\u4e0d\u4f1a\u7ecf\u8fc7 waypoint proxy\u3002 \u67e5\u770b inbound \u65b9\u5411\u7684\u6d41\u91cf\u65e5\u5fd7\uff08productpage \u4e0a\u7684 ztunnel -> productpage\uff09\u3002 kubectl logs -n istio-system ztunnel-k4jhb -f","title":"9.1 MTLS \u6d41\u91cf\u52a0\u5bc6"},{"location":"chap10/2istio_ambient/#92-l4","text":"\u5b89\u5168\u8986\u76d6\u5c42\u53ef\u4ee5\u5b9e\u73b0\u7b80\u5355\u7684 L4 \u6388\u6743\u7b56\u7565\uff0c\u5982\u4e0b\u6240\u793a\u521b\u5efa\u4e00\u4e2a AuthorizationPolicy \uff0c\u53ea\u5141\u8bb8 Service Account \u662f sleep \u7684\u7528\u6237\u8bbf\u95ee\u6807\u7b7e\u662f app=productpage \u5e94\u7528\u3002 kubectl apply -f - <<EOF apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: productpage-viewer namespace: default spec: selector: matchLabels: app: productpage action: ALLOW rules: - from: - source: principals: [\"cluster.local/ns/default/sa/sleep\"] EOF \u5206\u522b\u5728 sleep \u548c notsleep \u4e0a\u6267\u884c\u4ee5\u4e0b\u8bf7\u6c42\uff0c\u7531\u4e8e\u5f53\u524d\u8fd8\u6ca1\u6709\u542f\u7528 L7 \u5904\u7406\uff0c\u56e0\u6b64\u8fd8\u65e0\u6cd5\u9488\u5bf9 HTTP \u8bf7\u6c42\u65b9\u6cd5\uff0c\u8def\u5f84\u7b49\u6761\u4ef6\u8fdb\u884c\u9650\u5236\u3002 # \u6210\u529f kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 # \u6210\u529f kubectl exec deploy/sleep -- curl -XDELETE -s http://productpage:9080/ | head -n1 # \u5931\u8d25\uff0c\u53ea\u5141\u8bb8 sa \u662f sleep \u7684\u7528\u6237 kubectl exec deploy/notsleep -- curl -s http://productpage:9080/ | head -n1","title":"9.2 L4 \u6388\u6743\u7b56\u7565"},{"location":"chap10/2istio_ambient/#10-l7","text":"\u8981\u4e3a\u670d\u52a1\u542f\u7528 L7 \u7f51\u683c\u80fd\u529b\uff0c\u9700\u8981\u663e\u5f0f\u521b\u5efa\u4e00\u4e2a Gateway\uff0c\u6ce8\u610f\u521b\u5efa\u7684 Gateway \u8d44\u6e90\u4e2d\u7684 gatewayClassName \u5fc5\u987b\u8bbe\u7f6e\u4e3a istio-mesh \uff0c\u8fd9\u6837 Istio \u624d\u4f1a\u4e3a productpage \u521b\u5efa\u5bf9\u5e94\u7684 waypoint proxy\u3002 \u4efb\u4f55\u53d1\u5f80 productpage \u670d\u52a1\u7684\u6d41\u91cf\u90fd\u5c06\u7ecf\u8fc7 waypoint proxy \u8fd9\u4e2a L7 \u4ee3\u7406\u8fdb\u884c\u5904\u7406\u3002 kubectl apply -f - <<EOF apiVersion: gateway.networking.k8s.io/v1alpha2 kind: Gateway metadata: name: productpage annotations: istio.io/service-account: bookinfo-productpage spec: gatewayClassName: istio-mesh EOF \u67e5\u770b Istio \u4e3a productpage \u521b\u5efa\u7684 waypoint proxy\u3002 \u4ece sleep \u8bbf\u95ee productpage\u3002 kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 \u67e5\u770b outbound \u65b9\u5411\u7684\u6d41\u91cf\u65e5\u5fd7\uff08sleep -> sleep node \u4e0a\u7684 ztunnel -> waypoint proxy\uff09\u3002 kubectl logs -n istio-system ztunnel-fnjg2 -f \u4ece\u4e0b\u9762\u7684\u65e5\u5fd7\u4e2d\u53ef\u4ee5\u770b\u5230\uff08to server waypoint proxy\uff09\u7684\u5b57\u6837\uff0c\u8bf4\u660e\u8bf7\u6c42\u53d1\u5f80 waypoint proxy \u8fdb\u884c\u5904\u7406\u3002","title":"10 \u542f\u7528 L7 \u529f\u80fd"},{"location":"chap10/2istio_ambient/#101-l7","text":"\u63a5\u4e0b\u6765\u66f4\u65b0 AuthorizationPolicy \u53ea\u5141\u8bb8 Service Account \u662f sleep \u7684\u7528\u6237\u901a\u8fc7 GET \u7684\u65b9\u5f0f\u8bbf\u95ee\u6807\u7b7e\u662f app=productpage \u5e94\u7528\u3002 kubectl apply -f - <<EOF apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: productpage-viewer namespace: default spec: selector: matchLabels: app: productpage action: ALLOW rules: - from: - source: principals: [\"cluster.local/ns/default/sa/sleep\"] to: - operation: methods: [\"GET\"] EOF \u5206\u522b\u5728 sleep \u548c notsleep \u4e0a\u6267\u884c\u4ee5\u4e0b\u8bf7\u6c42\uff0c\u8fd9\u6b21\u5728 sleep \u4e0a\u6267\u884c HTTP DELETE \u8bf7\u6c42\u4e5f\u4f1a\u88ab\u62d2\u7edd\u4e86\u3002 # \u6210\u529f kubectl exec deploy/sleep -- curl -s http://productpage:9080/ | head -n1 # \u5931\u8d25\uff0cRBAC \u9519\u8bef\uff0c\u56e0\u4e3a\u4e0d\u662f GET \u8bf7\u6c42 kubectl exec deploy/sleep -- curl -X DELETE -s http://productpage:9080/ | head -n1 # \u5931\u8d25\uff0cRBAC \u9519\u8bef\uff0c\u53ea\u5141\u8bb8 sa \u662f sleep \u7684\u7528\u6237 kubectl exec deploy/notsleep -- curl -s http://productpage:9080/ | head -n1","title":"10.1 L7 \u6388\u6743\u7b56\u7565"},{"location":"chap10/2istio_ambient/#102","text":"\u5728 productpage waypoint proxy \u4e0a\u53ef\u4ee5\u67e5\u770b\u6240\u6709\u5bf9 productpage \u670d\u52a1\u8bf7\u6c42\u7684 L7 \u6307\u6807\u3002 kubectl exec deploy/bookinfo-productpage-waypoint-proxy -- curl -s http://localhost:15020/stats/prometheus | grep istio_requests_total","title":"10.2 \u53ef\u89c2\u6d4b\u6027"},{"location":"chap10/2istio_ambient/#103","text":"\u9996\u5148\u4e3a reviews \u670d\u52a1\u521b\u5efa\u4e00\u4e2a gateway\uff0c\u542f\u7528 L7 \u80fd\u529b\u3002 kubectl apply -f - <<EOF apiVersion: gateway.networking.k8s.io/v1alpha2 kind: Gateway metadata: name: reviews annotations: istio.io/service-account: bookinfo-reviews spec: gatewayClassName: istio-mesh EOF \u7136\u540e\u5206\u522b\u521b\u5efa VirtualService \u548c DestinationRule \u6765\u63a7\u5236\u6d41\u91cf\u4ee5 90/10 \u7684\u6bd4\u4f8b\u53d1\u5f80 v1 \u7248\u672c\u548c v2 \u7248\u672c\u7684 reviews \u670d\u52a1\u3002 kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 weight: 90 - destination: host: reviews subset: v2 weight: 10 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews trafficPolicy: loadBalancer: simple: RANDOM subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 EOF \u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u4ece sleep \u5f80 productpage \u53d1\u9001 10 \u4e2a\u8bf7\u6c42\uff0c\u53ef\u4ee5\u770b\u5230\u5927\u7ea6\u6709 10% \u7684\u6d41\u91cf\u6d41\u5411\u4e86 reviews-v2 \u3002 # \u6ce8\u610f\u8bbf\u95ee\u8def\u5f84\u662f http://productpage:9080/productpage\uff0c\u4f1a\u8c03\u7528 reviews \u670d\u52a1 kubectl exec -it deploy/sleep -- sh -c 'for i in $(seq 1 10); do curl -s http://productpage:9080/productpage | grep reviews-v.-; done' # \u8fd4\u56de\u7ed3\u679c <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v2-6bdd859457-7lxhc</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v1-7598cc9867-dh7hp</u> <u>reviews-v2-6bdd859457-7lxhc</u>","title":"10.3 \u6d41\u91cf\u63a7\u5236"},{"location":"chap10/2istio_ambient/#104","text":"\u4e3a productpage \u670d\u52a1\u521b\u5efa\u4e00\u4e2a VirtualService\uff0c\u5728\u8bf7\u6c42\u4e2d\u6ce8\u5165 5s \u7684\u5ef6\u65f6\u3002 kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: productpage spec: hosts: - productpage http: - route: - destination: host: productpage fault: delay: percentage: value: 100.0 fixedDelay: 5s EOF \u4ece sleep \u8bbf\u95ee productpage\uff0c\u53ef\u4ee5\u770b\u5230\u8bf7\u6c42\u6d88\u8017\u7684\u65f6\u95f4\u5927\u7ea6\u5728 5s \u5de6\u53f3\u3002 > kubectl exec deploy/sleep -- time curl -s http://productpage:9080 | head -n 1 # \u8fd4\u56de\u7ed3\u679c <!DOCTYPE html> real 0m 5.04s user 0m 0.00s sys 0m 0.00s","title":"10.4 \u6545\u969c\u6ce8\u5165"},{"location":"chap10/2istio_ambient/#11","text":"# \u5378\u8f7d Istio istioctl uninstall -y --purge && istioctl delete ns istio-system # \u5220\u9664\u793a\u4f8b\u5e94\u7528 kubectl delete -f samples/bookinfo/platform/kube/bookinfo.yaml kubectl delete -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/sleep.yaml kubectl delete -f https://raw.githubusercontent.com/linsun/sample-apps/main/sleep/notsleep.yaml # \u5220\u9664\u96c6\u7fa4 eksctl delete cluster aws-demo-cluster01","title":"11 \u6e05\u7406\u73af\u5883"},{"location":"chap10/2istio_ambient/#12-demo","text":"\u60f3\u8981\u5feb\u901f\u4f53\u9a8c ambient mesh \u7684\u670b\u53cb\u4e5f\u53ef\u4ee5\u5728 solo.io \u5b98\u7f51 \u4e0a\u5c1d\u8bd5\u4e0a\u624b\u6559\u7a0b\u3002 Istio \u65e0 sidecar \u4ee3\u7406\u6570\u636e\u5e73\u9762 ambient \u6a21\u5f0f\u7b80\u4ecb: https://lib.jimmysong.io/blog/introducing-ambient-mesh/ \u8bd1\u6587\uff1aIstio Ambient \u6a21\u5f0f\u5b89\u5168\u67b6\u6784\u6df1\u5ea6\u89e3\u6790: https://www.zhaohuabing.com/post/2022-09-09-ambient-mesh-security-deep-dive/ \u5982\u4f55\u8bc4\u4ef7 Istio \u65b0\u63a8\u51fa\u7684 Ambient \u6a21\u5f0f\uff1f: https://mp.weixin.qq.com/s/98wXMdeutx0wHqcJUIFl8A \u521d\u63a2 Istio Ambient \u6a21\u5f0f: https://mp.weixin.qq.com/s/YA2My5PSHXIwovWLRKmsgA Istio Ambient \u6a21\u5f0f HBONE \u96a7\u9053\u539f\u7406\u8be6\u89e3 - \u4e0a: https://mp.weixin.qq.com/s/ksiYJEJKnit65KfIIGoN8Q Create a kubeconfig for Amazon EKS: https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html Beyond Istio OSS \u2014\u2014 Istio \u670d\u52a1\u7f51\u683c\u7684\u73b0\u72b6\u4e0e\u672a\u6765: https://jimmysong.io/blog/beyond-istio-oss/#sidecar-management","title":"12 \u4f53\u9a8c Demo"},{"location":"chap11/1linkered_sm/","text":"1 Linkerd Service Mesh \u5feb\u901f\u4e0a\u624b Linkerd \u662f Kubernetes \u7684\u4e00\u4e2a\u5b8c\u5168\u5f00\u6e90\u7684\u670d\u52a1\u7f51\u683c\u5b9e\u73b0\u3002\u5b83\u901a\u8fc7\u4e3a\u4f60\u63d0\u4f9b\u8fd0\u884c\u65f6\u8c03\u8bd5\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u53ef\u9760\u6027\u548c\u5b89\u5168\u6027\uff0c\u4f7f\u8fd0\u884c\u670d\u52a1\u66f4\u8f7b\u677e\u3001\u66f4\u5b89\u5168\uff0c\u6240\u6709\u8fd9\u4e9b\u90fd\u4e0d\u9700\u8981\u5bf9\u4f60\u7684\u4ee3\u7801\u8fdb\u884c\u4efb\u4f55\u66f4\u6539\u3002 Linkerd \u901a\u8fc7\u5728\u6bcf\u4e2a\u670d\u52a1\u5b9e\u4f8b\u65c1\u8fb9\u5b89\u88c5\u4e00\u7ec4\u8d85\u8f7b\u3001\u900f\u660e\u7684\u4ee3\u7406\u6765\u5de5\u4f5c \u3002 \u8fd9\u4e9b\u4ee3\u7406\u4f1a\u81ea\u52a8\u5904\u7406\u8fdb\u51fa\u670d\u52a1\u7684\u6240\u6709\u6d41\u91cf\u3002\u7531\u4e8e\u5b83\u4eec\u662f\u900f\u660e\u7684\uff0c\u8fd9\u4e9b\u4ee3\u7406\u5145\u5f53\u9ad8\u5ea6\u4eea\u8868\u5316\u7684\u8fdb\u7a0b\u5916\u7f51\u7edc\u5806\u6808\uff0c\u5411\u63a7\u5236\u5e73\u9762\u53d1\u9001\u9065\u6d4b\u6570\u636e\u5e76\u4ece\u63a7\u5236\u5e73\u9762\u63a5\u6536\u63a7\u5236\u4fe1\u53f7\u3002 \u8fd9\u79cd\u8bbe\u8ba1\u5141\u8bb8 Linkerd \u6d4b\u91cf\u548c\u64cd\u7eb5\u8fdb\u51fa\u4f60\u7684\u670d\u52a1\u7684\u6d41\u91cf\uff0c\u800c\u4e0d\u4f1a\u5f15\u5165\u8fc7\u591a\u7684\u5ef6\u8fdf\u3002\u4e3a\u4e86\u5c3d\u53ef\u80fd\u5c0f\u3001\u8f7b\u548c\u5b89\u5168\uff0cLinkerd \u7684\u4ee3\u7406\u91c7\u7528 Rust \u7f16\u5199\u3002 \u529f\u80fd\u6982\u8ff0 \u81ea\u52a8 mTLS \uff1aLinkerd \u81ea\u52a8\u4e3a\u7f51\u683c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u542f\u7528\u76f8\u4e92\u4f20\u8f93\u5c42\u5b89\u5168\u6027 (TLS)\u3002 \u81ea\u52a8\u4ee3\u7406\u6ce8\u5165 \uff1aLinkerd \u4f1a\u81ea\u52a8\u5c06\u6570\u636e\u5e73\u9762\u4ee3\u7406\u6ce8\u5165\u5230\u57fa\u4e8e annotations \u7684 pod \u4e2d\u3002 \u5bb9\u5668\u7f51\u7edc\u63a5\u53e3\u63d2\u4ef6 \uff1aLinkerd \u80fd\u88ab\u914d\u7f6e\u53bb\u8fd0\u884c\u4e00\u4e2a CNI \u63d2\u4ef6\uff0c\u8be5\u63d2\u4ef6\u81ea\u52a8\u91cd\u5199\u6bcf\u4e2a pod \u7684 iptables \u89c4\u5219\u3002 \u4eea\u8868\u677f\u548c Grafana \uff1aLinkerd \u63d0\u4f9b\u4e86\u4e00\u4e2a Web \u4eea\u8868\u677f\uff0c\u4ee5\u53ca\u9884\u914d\u7f6e\u7684 Grafana \u4eea\u8868\u677f\u3002 \u5206\u5e03\u5f0f\u8ffd\u8e2a \uff1a\u60a8\u53ef\u4ee5\u5728 Linkerd \u4e2d\u542f\u7528\u5206\u5e03\u5f0f\u8ddf\u8e2a\u652f\u6301\u3002 \u6545\u969c\u6ce8\u5165 \uff1aLinkerd \u63d0\u4f9b\u4e86\u4ee5\u7f16\u7a0b\u65b9\u5f0f\u5c06\u6545\u969c\u6ce8\u5165\u670d\u52a1\u7684\u673a\u5236\u3002 \u9ad8\u53ef\u7528\u6027 \uff1aLinkerd \u63a7\u5236\u5e73\u9762\u53ef\u4ee5\u5728\u9ad8\u53ef\u7528\u6027 (HA) \u6a21\u5f0f\u4e0b\u8fd0\u884c\u3002 HTTP\u3001HTTP/2 \u548c gRPC \u4ee3\u7406 \uff1aLinkerd \u5c06\u81ea\u52a8\u4e3a HTTP\u3001HTTP/2 \u548c gRPC \u8fde\u63a5\u542f\u7528\u9ad8\u7ea7\u529f\u80fd\uff08\u5305\u62ec\u6307\u6807\u3001\u8d1f\u8f7d\u5e73\u8861\u3001\u91cd\u8bd5\u7b49\uff09\u3002 Ingress \uff1aLinkerd \u53ef\u4ee5\u4e0e\u60a8\u9009\u62e9\u7684 ingress controller \u4e00\u8d77\u5de5\u4f5c\u3002 \u8d1f\u8f7d\u5747\u8861 \uff1aLinkerd \u4f1a\u81ea\u52a8\u5bf9 HTTP\u3001HTTP/2 \u548c gRPC \u8fde\u63a5\u4e0a\u6240\u6709\u76ee\u6807\u7aef\u70b9\u7684\u8bf7\u6c42\u8fdb\u884c\u8d1f\u8f7d\u5e73\u8861\u3002 \u591a\u96c6\u7fa4\u901a\u4fe1 \uff1aLinkerd \u53ef\u4ee5\u900f\u660e\u4e14\u5b89\u5168\u5730\u8fde\u63a5\u8fd0\u884c\u5728\u4e0d\u540c\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u3002 \u91cd\u8bd5\u548c\u8d85\u65f6 \uff1aLinkerd \u53ef\u4ee5\u6267\u884c\u7279\u5b9a\u4e8e\u670d\u52a1\u7684\u91cd\u8bd5\u548c\u8d85\u65f6\u3002 \u670d\u52a1\u914d\u7f6e\u6587\u4ef6 \uff1aLinkerd \u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u652f\u6301\u6bcf\u6761\u8def\u7531\u6307\u6807\u4ee5\u53ca\u91cd\u8bd5\u548c\u8d85\u65f6\u3002 TCP \u4ee3\u7406\u548c\u534f\u8bae\u68c0\u6d4b \uff1aLinkerd \u80fd\u591f\u4ee3\u7406\u6240\u6709 TCP \u6d41\u91cf\uff0c\u5305\u62ec TLS \u8fde\u63a5\u3001WebSockets \u548c HTTP \u96a7\u9053\u3002 \u9065\u6d4b\u548c\u76d1\u63a7 \uff1aLinkerd \u4f1a\u81ea\u52a8\u4ece\u6240\u6709\u901a\u8fc7\u5b83\u53d1\u9001\u6d41\u91cf\u7684\u670d\u52a1\u6536\u96c6\u6307\u6807\u3002 \u6d41\u91cf\u62c6\u5206(\u91d1\u4e1d\u96c0\u3001\u84dd/\u7eff\u90e8\u7f72) \uff1aLinkerd \u53ef\u4ee5\u52a8\u6001\u5730\u5c06\u4e00\u90e8\u5206\u6d41\u91cf\u53d1\u9001\u5230\u4e0d\u540c\u7684\u670d\u52a1\u3002 \u5b89\u88c5 \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u672c\u5730\u5b89\u88c5\u4e00\u4e2a Linkerd \u7684 CLI \u547d\u4ee4\u884c\u5de5\u5177\uff0c\u901a\u8fc7\u8be5 CLI \u53ef\u4ee5\u5c06 Linkerd \u7684\u63a7\u5236\u5e73\u9762\u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u4e0a\u3002 \u6240\u4ee5\u9996\u5148\u9700\u8981\u5728\u672c\u5730\u8fd0\u884c kubectl \u547d\u4ee4\uff0c\u786e\u4fdd\u53ef\u4ee5\u8bbf\u95ee\u4e00\u4e2a\u53ef\u7528\u7684 Kubernetes \u96c6\u7fa4\uff0c\u5982\u679c\u6ca1\u6709\u96c6\u7fa4\uff0c\u53ef\u4ee5\u4f7f\u7528 KinD \u5728\u672c\u5730\u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u3002 $ kubectl version --short Client Version: v1.23.5 Server Version: v1.22.8 \u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5728\u672c\u5730\u5b89\u88c5 Linkerd \u7684 CLI \u5de5\u5177\uff1a $ curl --proto '=https' --tlsv1.2 -sSfL https://run.linkerd.io/install | sh \u5982\u679c\u662f Mac \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u53ef\u4ee5\u4f7f\u7528 Homebrew \u5de5\u5177\u4e00\u952e\u5b89\u88c5\uff1a $ brew install linkerd \u540c\u6837\u76f4\u63a5\u524d\u5f80 Linkerd Release \u9875\u9762 https://github.com/linkerd/linkerd2/releases/ \u4e0b\u8f7d\u5b89\u88c5\u5373\u53ef\u3002 \u5b89\u88c5\u540e\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u9a8c\u8bc1 CLI \u5de5\u5177\u662f\u5426\u5b89\u88c5\u6210\u529f\uff1a $ linkerd version Client version: stable-2.11.1 Server version: unavailable \u6b63\u5e38\u6211\u4eec\u53ef\u4ee5\u770b\u5230 CLI \u7684\u7248\u672c\u4fe1\u606f\uff0c\u4f46\u662f\u4f1a\u51fa\u73b0 Server version: unavailable \u4fe1\u606f\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88c5\u63a7\u5236\u5e73\u9762\u9020\u6210\u7684\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b89\u88c5 Server \u7aef\u3002 Kubernetes \u96c6\u7fa4\u53ef\u4ee5\u901a\u8fc7\u591a\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u8fdb\u884c\u914d\u7f6e\uff0c\u5728\u5b89\u88c5 Linkerd \u63a7\u5236\u5e73\u9762\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u68c0\u67e5\u5e76\u9a8c\u8bc1\u6240\u6709\u914d\u7f6e\u662f\u5426\u6b63\u786e\uff0c\u8981\u68c0\u67e5\u96c6\u7fa4\u662f\u5426\u5df2\u51c6\u5907\u597d\u5b89\u88c5 Linkerd\uff0c\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a $ linkerd check --pre Linkerd core checks =================== kubernetes-api -------------- \u221a can initialize the client \u221a can query the Kubernetes API kubernetes-version ------------------ \u221a is running the minimum Kubernetes API version \u221a is running the minimum kubectl version pre-kubernetes-setup -------------------- \u221a control plane namespace does not already exist \u221a can create non-namespaced resources \u221a can create ServiceAccounts \u221a can create Services \u221a can create Deployments \u221a can create CronJobs \u221a can create ConfigMaps \u221a can create Secrets \u221a can read Secrets \u221a can read extension-apiserver-authentication configmap \u221a no clock skew detected linkerd-version --------------- \u221a can determine the latest version \u221a cli is up-to-date Status check results are \u221a \u5982\u679c\u4e00\u5207\u68c0\u67e5\u90fd OK \u5219\u53ef\u4ee5\u5f00\u59cb\u5b89\u88c5 Linkerd \u7684\u63a7\u5236\u5e73\u9762\u4e86\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u4e00\u952e\u5b89\u88c5\uff1a \u5148\u6309\u7167CRD\u6587\u4ef6 $ linkerd install --crds \u5728\u6b64\u547d\u4ee4\u4e2d\uff0clinkerd install \u4f1a\u751f\u6210\u4e00\u4e2a Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u6240\u6709\u5fc5\u8981\u7684\u63a7\u5236\u5e73\u9762\u8d44\u6e90\uff0c\u7136\u540e\u4f7f\u7528 kubectl apply \u547d\u4ee4\u5373\u53ef\u5c06\u5176\u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u3002 $ linkerd install --set proxyInit.runAsRoot=true | kubectl apply -f - namespace/linkerd created clusterrole.rbac.authorization.k8s.io/linkerd-linkerd-identity created clusterrolebinding.rbac.authorization.k8s.io/linkerd-linkerd-identity created serviceaccount/linkerd-identity created clusterrole.rbac.authorization.k8s.io/linkerd-linkerd-destination created ... \u53ef\u4ee5\u770b\u5230\u4f1a\u5c06 Linkerd \u63a7\u5236\u9762\u5b89\u88c5\u5230\u4e00\u4e2a\u540d\u4e3a linkerd \u7684\u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u6709\u5982\u4e0b\u51e0\u4e2a Pod \u8fd0\u884c\uff1a $ kubectl get pods -n linkerd NAME READY STATUS RESTARTS AGE linkerd-destination-5756d47547-hr5jf 4/4 Running 0 14m linkerd-identity-76b6469bc-qhv6b 2/2 Running 0 31m linkerd-proxy-injector-6d97596bd5-r6tgw 2/2 Running 8 (8m5s ago) 31m \u5b89\u88c5\u5b8c\u6210\u540e\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u7b49\u5f85\u63a7\u5236\u5e73\u9762\u51c6\u5907\u5c31\u7eea\uff0c\u5e76\u53ef\u4ee5\u9a8c\u8bc1\u5b89\u88c5\u7ed3\u679c\u662f\u5426\u6b63\u5e38\uff1a $ linkerd check Linkerd core checks =================== kubernetes-api -------------- \u221a can initialize the client \u221a can query the Kubernetes API kubernetes-version ------------------ \u221a is running the minimum Kubernetes API version \u221a is running the minimum kubectl version linkerd-existence ----------------- \u221a 'linkerd-config' config map exists \u221a heartbeat ServiceAccount exist \u221a control plane replica sets are ready \u221a no unschedulable pods \u221a control plane pods are ready \u221a cluster networks contains all pods linkerd-config -------------- \u221a control plane Namespace exists \u221a control plane ClusterRoles exist \u221a control plane ClusterRoleBindings exist \u221a control plane ServiceAccounts exist \u221a control plane CustomResourceDefinitions exist \u221a control plane MutatingWebhookConfigurations exist \u221a control plane ValidatingWebhookConfigurations exist \u221a proxy-init container runs as root user if docker container runtime is used linkerd-identity ---------------- \u221a certificate config is valid \u221a trust anchors are using supported crypto algorithm \u221a trust anchors are within their validity period \u221a trust anchors are valid for at least 60 days \u221a issuer cert is using supported crypto algorithm \u221a issuer cert is within its validity period \u221a issuer cert is valid for at least 60 days \u221a issuer cert is issued by the trust anchor linkerd-webhooks-and-apisvc-tls ------------------------------- \u221a proxy-injector webhook has valid cert \u221a proxy-injector cert is valid for at least 60 days \u221a sp-validator webhook has valid cert \u221a sp-validator cert is valid for at least 60 days \u221a policy-validator webhook has valid cert \u221a policy-validator cert is valid for at least 60 days linkerd-version --------------- \u221a can determine the latest version \u221a cli is up-to-date control-plane-version --------------------- \u221a can retrieve the control plane version \u221a control plane is up-to-date \u221a control plane and cli versions match linkerd-control-plane-proxy --------------------------- \u221a control plane proxies are healthy \u221a control plane proxies are up-to-date \u221a control plane proxies and cli versions match Status check results are \u221a \u5f53\u51fa\u73b0\u4e0a\u9762\u7684 Status check results are \u221a \u4fe1\u606f\u540e\u8868\u793a Linkerd \u7684\u63a7\u5236\u5e73\u9762\u5b89\u88c5\u6210\u529f\u4e86 \u3002 \u9664\u4e86\u4f7f\u7528 CLI \u5de5\u5177\u7684\u65b9\u5f0f\u5b89\u88c5\u63a7\u5236\u5e73\u9762\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Helm Chart \u7684\u65b9\u5f0f\u6765\u5b89\u88c5\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ helm repo add linkerd https://helm.linkerd.io/stable # set expiry date one year from now, in Mac: $ exp=$(date -v+8760H +\"%Y-%m-%dT%H:%M:%SZ\") # in Linux: $ exp=$(date -d '+8760 hour' +\"%Y-%m-%dT%H:%M:%SZ\") $ helm install linkerd2 \\ --set-file identityTrustAnchorsPEM=ca.crt \\ --set-file identity.issuer.tls.crtPEM=issuer.crt \\ --set-file identity.issuer.tls.keyPEM=issuer.key \\ --set identity.issuer.crtExpiry=$exp \\ linkerd/linkerd2 \u6b64\u5916\u8be5 chart \u5305\u542b\u4e00\u4e2a values-ha.yaml \u6587\u4ef6\uff0c \u5b83\u8986\u76d6\u4e86\u4e00\u4e9b\u9ed8\u8ba4\u503c\uff0c\u4ee5\u4fbf\u5728\u9ad8\u53ef\u7528\u6027\u573a\u666f\u4e0b\u8fdb\u884c\u8bbe\u7f6e\uff0c \u7c7b\u4f3c\u4e8e linkerd install \u4e2d\u7684 --ha \u9009\u9879\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6 chart \u6587\u4ef6\u6765\u83b7\u5f97 values-ha.yaml \uff1a $ helm fetch --untar linkerd/linkerd2 \u7136\u540e\u4f7f\u7528 -f flag \u63d0\u4f9b\u8986\u76d6\u6587\u4ef6\uff0c\u4f8b\u5982\uff1a ## see above on how to set $exp helm install linkerd2 \\ --set-file identityTrustAnchorsPEM=ca.crt \\ --set-file identity.issuer.tls.crtPEM=issuer.crt \\ --set-file identity.issuer.tls.keyPEM=issuer.key \\ --set identity.issuer.crtExpiry=$exp \\ -f linkerd2/values-ha.yaml \\ linkerd/linkerd2 \u91c7\u7528\u54ea\u79cd\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\u5747\u53ef\uff0c\u5230\u8fd9\u91cc\u6211\u4eec\u73b0\u5728\u5c31\u5b8c\u6210\u4e86 Linkerd \u7684\u5b89\u88c5\uff0c\u91cd\u65b0\u6267\u884c linkerd version \u547d\u4ee4\u5c31\u53ef\u4ee5\u770b\u5230 Server \u7aef\u7248\u672c\u4fe1\u606f\u4e86\uff1a linkerd version Client version: stable-2.12.0 Server version: stable-2.12.0 \u793a\u4f8b \u63a5\u4e0b\u6765\u6211\u4eec\u5b89\u88c5\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u5e94\u7528 Emojivoto\uff0c \u8be5\u5e94\u7528\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u72ec\u7acb Kubernetes \u5e94\u7528\u7a0b\u5e8f\uff0c\u5b83\u6df7\u5408\u4f7f\u7528 gRPC \u548c HTTP \u8c03\u7528\uff0c\u5141\u8bb8\u7528\u6237\u5bf9\u4ed6\u4eec\u6700\u559c\u6b22\u7684\u8868\u60c5\u7b26\u53f7\u8fdb\u884c\u6295\u7968 \u3002 \u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u5c06 Emojivoto \u5b89\u88c5\u5230 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\uff1a $ curl -fsL https://run.linkerd.io/emojivoto.yml emojivoto.yml apiVersion: v1 kind: Namespace metadata: name: emojivoto --- apiVersion: v1 kind: ServiceAccount metadata: name: emoji namespace: emojivoto --- apiVersion: v1 kind: ServiceAccount metadata: name: voting namespace: emojivoto --- apiVersion: v1 kind: ServiceAccount metadata: name: web namespace: emojivoto --- apiVersion: v1 kind: Service metadata: name: emoji-svc namespace: emojivoto spec: ports: - name: grpc port: 8080 targetPort: 8080 - name: prom port: 8801 targetPort: 8801 selector: app: emoji-svc --- apiVersion: v1 kind: Service metadata: name: voting-svc namespace: emojivoto spec: ports: - name: grpc port: 8080 targetPort: 8080 - name: prom port: 8801 targetPort: 8801 selector: app: voting-svc --- apiVersion: v1 kind: Service metadata: name: web-svc namespace: emojivoto spec: ports: - name: http port: 80 targetPort: 8080 selector: app: web-svc type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: emoji app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: v9 name: emoji namespace: emojivoto spec: replicas: 1 selector: matchLabels: app: emoji-svc version: v9 template: metadata: labels: app: emoji-svc version: v9 spec: containers: - env: - name: GRPC_PORT value: \"8080\" - name: PROM_PORT value: \"8801\" image: buoyantio/emojivoto-emoji-svc:v9 name: emoji-svc ports: - containerPort: 8080 name: grpc - containerPort: 8801 name: prom resources: requests: cpu: 100m serviceAccountName: emoji --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: vote-bot app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: v9 name: vote-bot namespace: emojivoto spec: replicas: 1 selector: matchLabels: app: vote-bot version: v9 template: metadata: labels: app: vote-bot version: v9 spec: containers: - command: - emojivoto-vote-bot env: - name: WEB_HOST value: web-svc.emojivoto:80 image: buoyantio/emojivoto-web:v9 name: vote-bot resources: requests: cpu: 10m --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: voting app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: v9 name: voting namespace: emojivoto spec: replicas: 1 selector: matchLabels: app: voting-svc version: v9 template: metadata: labels: app: voting-svc version: v9 spec: containers: - env: - name: GRPC_PORT value: \"8080\" - name: PROM_PORT value: \"8801\" image: buoyantio/emojivoto-voting-svc:v9 name: voting-svc ports: - containerPort: 8080 name: grpc - containerPort: 8801 name: prom resources: requests: cpu: 100m serviceAccountName: voting --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: web app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: v9 name: web namespace: emojivoto spec: replicas: 1 selector: matchLabels: app: web-svc version: v9 template: metadata: labels: app: web-svc version: v9 spec: containers: - env: - name: WEB_PORT value: \"8080\" - name: EMOJISVC_HOST value: emoji-svc.emojivoto:8080 - name: VOTINGSVC_HOST value: voting-svc.emojivoto:8080 - name: INDEX_BUNDLE value: dist/index_bundle.js image: buoyantio/emojivoto-web:v9 name: web-svc ports: - containerPort: 8080 name: http resources: requests: cpu: 100m serviceAccountName: web \u8be5\u5e94\u7528\u4e0b\u53ef\u4ee5\u770b\u5230\u4e00\u5171\u5305\u542b 4 \u4e2a Pod \u670d\u52a1\u3002 $ kubectl get pod -n emojivoto NAME READY STATUS RESTARTS AGE emoji-79b7665b88-4j96m 1/1 Running 0 8s vote-bot-86d4645dc7-mm4ct 1/1 Running 0 8s voting-f86cc8d89-cct2t 1/1 Running 0 8s web-8578749657-hb57h 1/1 Running 0 8s $ kubectl get svc -n emojivoto NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE emoji-svc ClusterIP 10.105.148.26 <none> 8080/TCP,8801/TCP 2m26s voting-svc ClusterIP 10.100.203.107 <none> 8080/TCP,8801/TCP 2m26s web-svc ClusterIP 10.106.94.83 <none> 80/TCP 2m26s \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 port-forward \u6765\u66b4\u9732 web-svc \u670d\u52a1\uff0c\u7136\u540e\u4fbf\u53ef\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\u8be5\u5e94\u7528\u3002 $ kubectl -n emojivoto port-forward svc/web-svc 8080:80 Forwarding from 127.0.0.1:8080 -> 8080 Forwarding from [::1]:8080 -> 8080 Handling connection for 8080 \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u901a\u8fc7 http://localhost:8080 \u8bbf\u95ee Emojivoto \u5e94\u7528\u4e86\u3002 \u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u9875\u9762\u4e2d\u559c\u6b22\u7684\u8868\u60c5\u8fdb\u884c\u6295\u7968\uff0c\u4f46\u662f\u9009\u62e9\u67d0\u4e9b\u8868\u60c5\u540e\u4f1a\u51fa\u73b0\u4e00\u4e9b\u9519\u8bef\uff0c\u6bd4\u5982\u5f53\u6211\u4eec\u70b9\u51fb\u751c\u751c\u5708\u8868\u60c5\u7b26\u53f7\u7684\u65f6\u5019\u4f1a\u5f97\u5230\u4e00\u4e2a 404 \u9875\u9762\u3002 \u4e0d\u8fc7\u4e0d\u7528\u62c5\u5fc3\uff0c\u8fd9\u662f\u5e94\u7528\u4e2d\u6545\u610f\u7559\u4e0b\u7684\u9519\u8bef\uff0c\u4e3a\u7684\u662f\u540e\u9762\u4f7f\u7528 Linkerd \u6765\u8bc6\u522b\u8be5\u95ee\u9898\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684\u793a\u4f8b\u5e94\u7528\u52a0\u5165\u5230 Service Mesh \u4e2d\u6765\uff0c\u5411\u5176\u6dfb\u52a0 Linkerd \u7684\u6570\u636e\u5e73\u9762\u4ee3\u7406\uff0c\u76f4\u63a5\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u5c06 Emojivoto \u5e94\u7528\u7f51\u683c\u5316\uff1a $ kubectl get -n emojivoto deploy -o yaml \\ > | linkerd inject - \\ > | kubectl apply -f - deployment \"emoji\" injected deployment \"vote-bot\" injected deployment \"voting\" injected deployment \"web\" injected deployment.apps/emoji configured deployment.apps/vote-bot configured deployment.apps/voting configured deployment.apps/web configured \u4e0a\u9762\u7684\u547d\u4ee4\u9996\u5148\u83b7\u53d6\u5728 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u7684\u6240\u6709 Deployments\uff0c\u7136\u540e\u901a\u8fc7 linkerd inject \u8fd0\u884c\u5b83\u4eec\u7684\u6e05\u5355\uff0c\u7136\u540e\u5c06\u5176\u91cd\u65b0\u5e94\u7528\u5230\u96c6\u7fa4\u3002 \u6ce8\u610f linkerd inject \u547d\u4ee4\u53ea\u662f\u5728 Pod \u89c4\u8303\u4e2d\u6dfb\u52a0\u4e00\u4e2a linkerd.io/inject: enabled \u7684\u6ce8\u89e3\uff0c\u5e76\u4e0d\u4f1a\u76f4\u63a5\u6ce8\u5165\u4e00\u4e2a Sidecar \u5bb9\u5668\uff0c\u8be5\u6ce8\u89e3\u5373\u53ef\u6307\u793a Linkerd \u5728\u521b\u5efa Pod \u65f6\u5c06\u4ee3\u7406\u6ce8\u5165\u5230\u5176\u4e2d\uff0c\u6240\u4ee5\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u540e\u5e94\u7528 Pod \u4e2d\u4f1a\u65b0\u589e\u4e00\u4e2a sidecar \u7684\u4ee3\u7406\u5bb9\u5668\u3002 $ kubectl get pods -n emojivoto NAME READY STATUS RESTARTS AGE emoji-6fd4b555c7-pbnck 2/2 Running 0 2m51s vote-bot-7bf6bc7c5b-5j66j 2/2 Running 0 2m51s voting-5db96b44c4-wk7bb 2/2 Running 0 2m51s web-5fdb59bc88-76g2t 2/2 Running 0 2m51s \u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a Pod \u73b0\u5728\u90fd\u6709 2 \u4e2a\u5bb9\u5668\uff0c\u76f8\u8f83\u4e8e\u4e4b\u524d\u591a\u4e86\u4e00\u4e2a Linkerd \u7684 sidecar \u4ee3\u7406\u5bb9\u5668\u3002 \u5f53\u5e94\u7528\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u6210\u529f\u5c06\u5e94\u7528\u5f15\u5165\u5230 Linkerd \u7684\u7f51\u683c\u670d\u52a1\u4e2d\u6765\u4e86\uff0c\u65b0\u589e\u7684\u4ee3\u7406\u5bb9\u5668\u7ec4\u6210\u4e86\u6570\u636e\u5e73\u9762\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u68c0\u67e5\u6570\u636e\u5e73\u9762\u72b6\u6001\uff1a $ linkerd -n emojivoto check --proxy Linkerd core checks =================== kubernetes-api -------------- \u221a can initialize the client \u221a can query the Kubernetes API kubernetes-version ------------------ \u221a is running the minimum Kubernetes API version \u221a is running the minimum kubectl version linkerd-existence ----------------- \u221a 'linkerd-config' config map exists \u221a heartbeat ServiceAccount exist \u221a control plane replica sets are ready \u221a no unschedulable pods \u221a control plane pods are ready \u221a cluster networks contains all pods linkerd-config -------------- \u221a control plane Namespace exists \u221a control plane ClusterRoles exist \u221a control plane ClusterRoleBindings exist \u221a control plane ServiceAccounts exist \u221a control plane CustomResourceDefinitions exist \u221a control plane MutatingWebhookConfigurations exist \u221a control plane ValidatingWebhookConfigurations exist \u221a proxy-init container runs as root user if docker container runtime is used linkerd-identity ---------------- \u221a certificate config is valid \u221a trust anchors are using supported crypto algorithm \u221a trust anchors are within their validity period \u221a trust anchors are valid for at least 60 days \u221a issuer cert is using supported crypto algorithm \u221a issuer cert is within its validity period \u221a issuer cert is valid for at least 60 days \u221a issuer cert is issued by the trust anchor linkerd-webhooks-and-apisvc-tls ------------------------------- \u221a proxy-injector webhook has valid cert \u221a proxy-injector cert is valid for at least 60 days \u221a sp-validator webhook has valid cert \u221a sp-validator cert is valid for at least 60 days \u221a policy-validator webhook has valid cert \u221a policy-validator cert is valid for at least 60 days linkerd-identity-data-plane --------------------------- \u221a data plane proxies certificate match CA linkerd-version --------------- \u221a can determine the latest version \u221a cli is up-to-date linkerd-control-plane-proxy --------------------------- \u221a control plane proxies are healthy \u221a control plane proxies are up-to-date \u221a control plane proxies and cli versions match linkerd-data-plane ------------------ \u221a data plane namespace exists \u221a data plane proxies are ready \u221a data plane is up-to-date \u221a data plane and cli versions match \u221a data plane pod labels are configured correctly \u221a data plane service labels are configured correctly \u221a data plane service annotations are configured correctly \u221a opaque ports are properly annotated Status check results are \u221a \u5f53\u7136\uff0c\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u901a\u8fc7 http://localhost:8080 \u8bbf\u95ee\u5e94\u7528\uff0c\u5f53\u7136\u5728\u4f7f\u7528\u4e0a\u548c\u4e4b\u524d\u6ca1\u4ec0\u4e48\u533a\u522b\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Linkerd \u53bb\u67e5\u770b\u5e94\u7528\u5b9e\u9645\u4e0a\u505a\u4e86\u54ea\u4e9b\u4e8b\u60c5\uff0c\u4f46\u662f\u6211\u4eec\u9700\u8981\u53bb\u5355\u72ec\u5b89\u88c5\u4e00\u4e2a\u63d2\u4ef6\uff0c \u7531\u4e8e Linkerd \u7684\u6838\u5fc3\u63a7\u5236\u5e73\u9762\u975e\u5e38\u8f7b\u91cf\u7ea7\uff0c \u6240\u4ee5 Linkerd \u9644\u5e26\u4e86\u4e00\u4e9b\u63d2\u4ef6\uff0c\u8fd9\u4e9b\u63d2\u4ef6\u4e3a Linkerd \u6dfb\u52a0\u4e86\u4e00\u4e9b\u975e\u5173\u952e\u4f46\u901a\u5e38\u6709\u7528\u7684\u529f\u80fd\uff0c\u5305\u62ec\u5404\u79cd\u4eea\u8868\u677f\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e2a viz \u63d2\u4ef6\uff0cLinkerd-Viz \u63d2\u4ef6\u5305\u542b Linkerd \u7684\u53ef\u89c2\u5bdf\u6027\u548c\u53ef\u89c6\u5316\u7ec4\u4ef6\u3002\u5b89\u88c5\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz install | kubectl apply -f - .... namespace/linkerd-viz created clusterrole.rbac.authorization.k8s.io/linkerd-linkerd-viz-metrics-api created clusterrolebinding.rbac.authorization.k8s.io/linkerd- \u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a linkerd-viz \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u4f1a\u5728\u8be5\u547d\u540d\u7a7a\u95f4\u4e2d\u5b89\u88c5\u76d1\u63a7\u76f8\u5173\u7684\u5e94\u7528\uff0c\u6bd4\u5982 Prometheus\u3001Grafana \u7b49\u3002 $ kubectl get pods -n linkerd-viz NAME READY STATUS RESTARTS AGE metrics-api-568596fbbb-dsgb8 2/2 Running 0 34m prometheus-75c46f88b5-lzhxf 2/2 Running 0 34m tap-756c88b45f-wtbrf 2/2 Running 0 34m tap-injector-69c7d96674-h86w5 2/2 Running 0 34m web-65557589c8-svb9k 2/2 Running 0 34m \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6253\u5f00\u4e00\u4e2a dashboard \u9875\u9762\uff1a $ linkerd viz dashboard & [1] 68487 $ Linkerd dashboard available at: http://localhost:50750 Grafana dashboard available at: http://localhost:50750/grafana Opening Linkerd dashboard in the default browser \u5f53 viz \u63d2\u4ef6\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u540e\u4f1a\u81ea\u52a8\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u4e00\u4e2a Linkerd \u7684\u53ef\u89c2\u5bdf\u6027\u7684 Dashboard\u3002 \u6b64\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Ingress \u6765\u66b4\u9732 viz \u670d\u52a1\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: web-ingress namespace: linkerd-viz annotations: nginx.ingress.kubernetes.io/upstream-vhost: $service_name.$namespace.svc.cluster.local:8084 nginx.ingress.kubernetes.io/configuration-snippet: | proxy_set_header Origin \"\"; proxy_hide_header l5d-remote-ip; proxy_hide_header l5d-server-id; spec: ingressClassName: nginx rules: - host: linkerd.k8s.local http: paths: - path: / pathType: Prefix backend: service: name: web port: number: 8084 \u5e94\u7528\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7 linkerd.k8s.local \u8bbf\u95ee viz \u4e86\u3002 \u8fd8\u53ef\u4ee5\u663e\u793a\u81ea\u52a8\u751f\u6210\u7684\u62d3\u6251\u56fe\u3002 \u5728\u9875\u9762\u4e0a\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u6bcf\u4e2a Emojivoto \u7ec4\u4ef6\u7684\u5b9e\u65f6\u6307\u6807\uff0c\u5c31\u53ef\u4ee5\u786e\u5b9a\u54ea\u4e2a\u7ec4\u4ef6\u51fa\u73b0\u4e86\u90e8\u5206\u6545\u969c\u4e86\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u6709\u9488\u5bf9\u6027\u7684\u53bb\u89e3\u51b3\u95ee\u9898\u4e86\u3002 \u5728\u5bf9\u5e94\u7684\u8d44\u6e90\u540e\u9762\u5305\u542b\u4e00\u4e2a Grafana \u7684\u56fe\u6807\uff0c\u70b9\u51fb\u53ef\u4ee5\u81ea\u52a8\u8df3\u8f6c\u5230 Grafana \u7684\u76d1\u63a7\u9875\u9762\u3002","title":"1 Linkerd Service Mesh \u5feb\u901f\u4e0a\u624b"},{"location":"chap11/1linkered_sm/#1-linkerd-service-mesh","text":"Linkerd \u662f Kubernetes \u7684\u4e00\u4e2a\u5b8c\u5168\u5f00\u6e90\u7684\u670d\u52a1\u7f51\u683c\u5b9e\u73b0\u3002\u5b83\u901a\u8fc7\u4e3a\u4f60\u63d0\u4f9b\u8fd0\u884c\u65f6\u8c03\u8bd5\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u53ef\u9760\u6027\u548c\u5b89\u5168\u6027\uff0c\u4f7f\u8fd0\u884c\u670d\u52a1\u66f4\u8f7b\u677e\u3001\u66f4\u5b89\u5168\uff0c\u6240\u6709\u8fd9\u4e9b\u90fd\u4e0d\u9700\u8981\u5bf9\u4f60\u7684\u4ee3\u7801\u8fdb\u884c\u4efb\u4f55\u66f4\u6539\u3002 Linkerd \u901a\u8fc7\u5728\u6bcf\u4e2a\u670d\u52a1\u5b9e\u4f8b\u65c1\u8fb9\u5b89\u88c5\u4e00\u7ec4\u8d85\u8f7b\u3001\u900f\u660e\u7684\u4ee3\u7406\u6765\u5de5\u4f5c \u3002 \u8fd9\u4e9b\u4ee3\u7406\u4f1a\u81ea\u52a8\u5904\u7406\u8fdb\u51fa\u670d\u52a1\u7684\u6240\u6709\u6d41\u91cf\u3002\u7531\u4e8e\u5b83\u4eec\u662f\u900f\u660e\u7684\uff0c\u8fd9\u4e9b\u4ee3\u7406\u5145\u5f53\u9ad8\u5ea6\u4eea\u8868\u5316\u7684\u8fdb\u7a0b\u5916\u7f51\u7edc\u5806\u6808\uff0c\u5411\u63a7\u5236\u5e73\u9762\u53d1\u9001\u9065\u6d4b\u6570\u636e\u5e76\u4ece\u63a7\u5236\u5e73\u9762\u63a5\u6536\u63a7\u5236\u4fe1\u53f7\u3002 \u8fd9\u79cd\u8bbe\u8ba1\u5141\u8bb8 Linkerd \u6d4b\u91cf\u548c\u64cd\u7eb5\u8fdb\u51fa\u4f60\u7684\u670d\u52a1\u7684\u6d41\u91cf\uff0c\u800c\u4e0d\u4f1a\u5f15\u5165\u8fc7\u591a\u7684\u5ef6\u8fdf\u3002\u4e3a\u4e86\u5c3d\u53ef\u80fd\u5c0f\u3001\u8f7b\u548c\u5b89\u5168\uff0cLinkerd \u7684\u4ee3\u7406\u91c7\u7528 Rust \u7f16\u5199\u3002","title":"1 Linkerd Service Mesh \u5feb\u901f\u4e0a\u624b"},{"location":"chap11/1linkered_sm/#_1","text":"\u81ea\u52a8 mTLS \uff1aLinkerd \u81ea\u52a8\u4e3a\u7f51\u683c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u542f\u7528\u76f8\u4e92\u4f20\u8f93\u5c42\u5b89\u5168\u6027 (TLS)\u3002 \u81ea\u52a8\u4ee3\u7406\u6ce8\u5165 \uff1aLinkerd \u4f1a\u81ea\u52a8\u5c06\u6570\u636e\u5e73\u9762\u4ee3\u7406\u6ce8\u5165\u5230\u57fa\u4e8e annotations \u7684 pod \u4e2d\u3002 \u5bb9\u5668\u7f51\u7edc\u63a5\u53e3\u63d2\u4ef6 \uff1aLinkerd \u80fd\u88ab\u914d\u7f6e\u53bb\u8fd0\u884c\u4e00\u4e2a CNI \u63d2\u4ef6\uff0c\u8be5\u63d2\u4ef6\u81ea\u52a8\u91cd\u5199\u6bcf\u4e2a pod \u7684 iptables \u89c4\u5219\u3002 \u4eea\u8868\u677f\u548c Grafana \uff1aLinkerd \u63d0\u4f9b\u4e86\u4e00\u4e2a Web \u4eea\u8868\u677f\uff0c\u4ee5\u53ca\u9884\u914d\u7f6e\u7684 Grafana \u4eea\u8868\u677f\u3002 \u5206\u5e03\u5f0f\u8ffd\u8e2a \uff1a\u60a8\u53ef\u4ee5\u5728 Linkerd \u4e2d\u542f\u7528\u5206\u5e03\u5f0f\u8ddf\u8e2a\u652f\u6301\u3002 \u6545\u969c\u6ce8\u5165 \uff1aLinkerd \u63d0\u4f9b\u4e86\u4ee5\u7f16\u7a0b\u65b9\u5f0f\u5c06\u6545\u969c\u6ce8\u5165\u670d\u52a1\u7684\u673a\u5236\u3002 \u9ad8\u53ef\u7528\u6027 \uff1aLinkerd \u63a7\u5236\u5e73\u9762\u53ef\u4ee5\u5728\u9ad8\u53ef\u7528\u6027 (HA) \u6a21\u5f0f\u4e0b\u8fd0\u884c\u3002 HTTP\u3001HTTP/2 \u548c gRPC \u4ee3\u7406 \uff1aLinkerd \u5c06\u81ea\u52a8\u4e3a HTTP\u3001HTTP/2 \u548c gRPC \u8fde\u63a5\u542f\u7528\u9ad8\u7ea7\u529f\u80fd\uff08\u5305\u62ec\u6307\u6807\u3001\u8d1f\u8f7d\u5e73\u8861\u3001\u91cd\u8bd5\u7b49\uff09\u3002 Ingress \uff1aLinkerd \u53ef\u4ee5\u4e0e\u60a8\u9009\u62e9\u7684 ingress controller \u4e00\u8d77\u5de5\u4f5c\u3002 \u8d1f\u8f7d\u5747\u8861 \uff1aLinkerd \u4f1a\u81ea\u52a8\u5bf9 HTTP\u3001HTTP/2 \u548c gRPC \u8fde\u63a5\u4e0a\u6240\u6709\u76ee\u6807\u7aef\u70b9\u7684\u8bf7\u6c42\u8fdb\u884c\u8d1f\u8f7d\u5e73\u8861\u3002 \u591a\u96c6\u7fa4\u901a\u4fe1 \uff1aLinkerd \u53ef\u4ee5\u900f\u660e\u4e14\u5b89\u5168\u5730\u8fde\u63a5\u8fd0\u884c\u5728\u4e0d\u540c\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u3002 \u91cd\u8bd5\u548c\u8d85\u65f6 \uff1aLinkerd \u53ef\u4ee5\u6267\u884c\u7279\u5b9a\u4e8e\u670d\u52a1\u7684\u91cd\u8bd5\u548c\u8d85\u65f6\u3002 \u670d\u52a1\u914d\u7f6e\u6587\u4ef6 \uff1aLinkerd \u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u652f\u6301\u6bcf\u6761\u8def\u7531\u6307\u6807\u4ee5\u53ca\u91cd\u8bd5\u548c\u8d85\u65f6\u3002 TCP \u4ee3\u7406\u548c\u534f\u8bae\u68c0\u6d4b \uff1aLinkerd \u80fd\u591f\u4ee3\u7406\u6240\u6709 TCP \u6d41\u91cf\uff0c\u5305\u62ec TLS \u8fde\u63a5\u3001WebSockets \u548c HTTP \u96a7\u9053\u3002 \u9065\u6d4b\u548c\u76d1\u63a7 \uff1aLinkerd \u4f1a\u81ea\u52a8\u4ece\u6240\u6709\u901a\u8fc7\u5b83\u53d1\u9001\u6d41\u91cf\u7684\u670d\u52a1\u6536\u96c6\u6307\u6807\u3002 \u6d41\u91cf\u62c6\u5206(\u91d1\u4e1d\u96c0\u3001\u84dd/\u7eff\u90e8\u7f72) \uff1aLinkerd \u53ef\u4ee5\u52a8\u6001\u5730\u5c06\u4e00\u90e8\u5206\u6d41\u91cf\u53d1\u9001\u5230\u4e0d\u540c\u7684\u670d\u52a1\u3002","title":"\u529f\u80fd\u6982\u8ff0"},{"location":"chap11/1linkered_sm/#_2","text":"\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u672c\u5730\u5b89\u88c5\u4e00\u4e2a Linkerd \u7684 CLI \u547d\u4ee4\u884c\u5de5\u5177\uff0c\u901a\u8fc7\u8be5 CLI \u53ef\u4ee5\u5c06 Linkerd \u7684\u63a7\u5236\u5e73\u9762\u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u4e0a\u3002 \u6240\u4ee5\u9996\u5148\u9700\u8981\u5728\u672c\u5730\u8fd0\u884c kubectl \u547d\u4ee4\uff0c\u786e\u4fdd\u53ef\u4ee5\u8bbf\u95ee\u4e00\u4e2a\u53ef\u7528\u7684 Kubernetes \u96c6\u7fa4\uff0c\u5982\u679c\u6ca1\u6709\u96c6\u7fa4\uff0c\u53ef\u4ee5\u4f7f\u7528 KinD \u5728\u672c\u5730\u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u3002 $ kubectl version --short Client Version: v1.23.5 Server Version: v1.22.8 \u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5728\u672c\u5730\u5b89\u88c5 Linkerd \u7684 CLI \u5de5\u5177\uff1a $ curl --proto '=https' --tlsv1.2 -sSfL https://run.linkerd.io/install | sh \u5982\u679c\u662f Mac \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u53ef\u4ee5\u4f7f\u7528 Homebrew \u5de5\u5177\u4e00\u952e\u5b89\u88c5\uff1a $ brew install linkerd \u540c\u6837\u76f4\u63a5\u524d\u5f80 Linkerd Release \u9875\u9762 https://github.com/linkerd/linkerd2/releases/ \u4e0b\u8f7d\u5b89\u88c5\u5373\u53ef\u3002 \u5b89\u88c5\u540e\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u9a8c\u8bc1 CLI \u5de5\u5177\u662f\u5426\u5b89\u88c5\u6210\u529f\uff1a $ linkerd version Client version: stable-2.11.1 Server version: unavailable \u6b63\u5e38\u6211\u4eec\u53ef\u4ee5\u770b\u5230 CLI \u7684\u7248\u672c\u4fe1\u606f\uff0c\u4f46\u662f\u4f1a\u51fa\u73b0 Server version: unavailable \u4fe1\u606f\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88c5\u63a7\u5236\u5e73\u9762\u9020\u6210\u7684\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b89\u88c5 Server \u7aef\u3002 Kubernetes \u96c6\u7fa4\u53ef\u4ee5\u901a\u8fc7\u591a\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u8fdb\u884c\u914d\u7f6e\uff0c\u5728\u5b89\u88c5 Linkerd \u63a7\u5236\u5e73\u9762\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u68c0\u67e5\u5e76\u9a8c\u8bc1\u6240\u6709\u914d\u7f6e\u662f\u5426\u6b63\u786e\uff0c\u8981\u68c0\u67e5\u96c6\u7fa4\u662f\u5426\u5df2\u51c6\u5907\u597d\u5b89\u88c5 Linkerd\uff0c\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a $ linkerd check --pre Linkerd core checks =================== kubernetes-api -------------- \u221a can initialize the client \u221a can query the Kubernetes API kubernetes-version ------------------ \u221a is running the minimum Kubernetes API version \u221a is running the minimum kubectl version pre-kubernetes-setup -------------------- \u221a control plane namespace does not already exist \u221a can create non-namespaced resources \u221a can create ServiceAccounts \u221a can create Services \u221a can create Deployments \u221a can create CronJobs \u221a can create ConfigMaps \u221a can create Secrets \u221a can read Secrets \u221a can read extension-apiserver-authentication configmap \u221a no clock skew detected linkerd-version --------------- \u221a can determine the latest version \u221a cli is up-to-date Status check results are \u221a \u5982\u679c\u4e00\u5207\u68c0\u67e5\u90fd OK \u5219\u53ef\u4ee5\u5f00\u59cb\u5b89\u88c5 Linkerd \u7684\u63a7\u5236\u5e73\u9762\u4e86\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u4e00\u952e\u5b89\u88c5\uff1a \u5148\u6309\u7167CRD\u6587\u4ef6 $ linkerd install --crds \u5728\u6b64\u547d\u4ee4\u4e2d\uff0clinkerd install \u4f1a\u751f\u6210\u4e00\u4e2a Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u6240\u6709\u5fc5\u8981\u7684\u63a7\u5236\u5e73\u9762\u8d44\u6e90\uff0c\u7136\u540e\u4f7f\u7528 kubectl apply \u547d\u4ee4\u5373\u53ef\u5c06\u5176\u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u3002 $ linkerd install --set proxyInit.runAsRoot=true | kubectl apply -f - namespace/linkerd created clusterrole.rbac.authorization.k8s.io/linkerd-linkerd-identity created clusterrolebinding.rbac.authorization.k8s.io/linkerd-linkerd-identity created serviceaccount/linkerd-identity created clusterrole.rbac.authorization.k8s.io/linkerd-linkerd-destination created ... \u53ef\u4ee5\u770b\u5230\u4f1a\u5c06 Linkerd \u63a7\u5236\u9762\u5b89\u88c5\u5230\u4e00\u4e2a\u540d\u4e3a linkerd \u7684\u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u6709\u5982\u4e0b\u51e0\u4e2a Pod \u8fd0\u884c\uff1a $ kubectl get pods -n linkerd NAME READY STATUS RESTARTS AGE linkerd-destination-5756d47547-hr5jf 4/4 Running 0 14m linkerd-identity-76b6469bc-qhv6b 2/2 Running 0 31m linkerd-proxy-injector-6d97596bd5-r6tgw 2/2 Running 8 (8m5s ago) 31m \u5b89\u88c5\u5b8c\u6210\u540e\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u7b49\u5f85\u63a7\u5236\u5e73\u9762\u51c6\u5907\u5c31\u7eea\uff0c\u5e76\u53ef\u4ee5\u9a8c\u8bc1\u5b89\u88c5\u7ed3\u679c\u662f\u5426\u6b63\u5e38\uff1a $ linkerd check Linkerd core checks =================== kubernetes-api -------------- \u221a can initialize the client \u221a can query the Kubernetes API kubernetes-version ------------------ \u221a is running the minimum Kubernetes API version \u221a is running the minimum kubectl version linkerd-existence ----------------- \u221a 'linkerd-config' config map exists \u221a heartbeat ServiceAccount exist \u221a control plane replica sets are ready \u221a no unschedulable pods \u221a control plane pods are ready \u221a cluster networks contains all pods linkerd-config -------------- \u221a control plane Namespace exists \u221a control plane ClusterRoles exist \u221a control plane ClusterRoleBindings exist \u221a control plane ServiceAccounts exist \u221a control plane CustomResourceDefinitions exist \u221a control plane MutatingWebhookConfigurations exist \u221a control plane ValidatingWebhookConfigurations exist \u221a proxy-init container runs as root user if docker container runtime is used linkerd-identity ---------------- \u221a certificate config is valid \u221a trust anchors are using supported crypto algorithm \u221a trust anchors are within their validity period \u221a trust anchors are valid for at least 60 days \u221a issuer cert is using supported crypto algorithm \u221a issuer cert is within its validity period \u221a issuer cert is valid for at least 60 days \u221a issuer cert is issued by the trust anchor linkerd-webhooks-and-apisvc-tls ------------------------------- \u221a proxy-injector webhook has valid cert \u221a proxy-injector cert is valid for at least 60 days \u221a sp-validator webhook has valid cert \u221a sp-validator cert is valid for at least 60 days \u221a policy-validator webhook has valid cert \u221a policy-validator cert is valid for at least 60 days linkerd-version --------------- \u221a can determine the latest version \u221a cli is up-to-date control-plane-version --------------------- \u221a can retrieve the control plane version \u221a control plane is up-to-date \u221a control plane and cli versions match linkerd-control-plane-proxy --------------------------- \u221a control plane proxies are healthy \u221a control plane proxies are up-to-date \u221a control plane proxies and cli versions match Status check results are \u221a \u5f53\u51fa\u73b0\u4e0a\u9762\u7684 Status check results are \u221a \u4fe1\u606f\u540e\u8868\u793a Linkerd \u7684\u63a7\u5236\u5e73\u9762\u5b89\u88c5\u6210\u529f\u4e86 \u3002 \u9664\u4e86\u4f7f\u7528 CLI \u5de5\u5177\u7684\u65b9\u5f0f\u5b89\u88c5\u63a7\u5236\u5e73\u9762\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Helm Chart \u7684\u65b9\u5f0f\u6765\u5b89\u88c5\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ helm repo add linkerd https://helm.linkerd.io/stable # set expiry date one year from now, in Mac: $ exp=$(date -v+8760H +\"%Y-%m-%dT%H:%M:%SZ\") # in Linux: $ exp=$(date -d '+8760 hour' +\"%Y-%m-%dT%H:%M:%SZ\") $ helm install linkerd2 \\ --set-file identityTrustAnchorsPEM=ca.crt \\ --set-file identity.issuer.tls.crtPEM=issuer.crt \\ --set-file identity.issuer.tls.keyPEM=issuer.key \\ --set identity.issuer.crtExpiry=$exp \\ linkerd/linkerd2 \u6b64\u5916\u8be5 chart \u5305\u542b\u4e00\u4e2a values-ha.yaml \u6587\u4ef6\uff0c \u5b83\u8986\u76d6\u4e86\u4e00\u4e9b\u9ed8\u8ba4\u503c\uff0c\u4ee5\u4fbf\u5728\u9ad8\u53ef\u7528\u6027\u573a\u666f\u4e0b\u8fdb\u884c\u8bbe\u7f6e\uff0c \u7c7b\u4f3c\u4e8e linkerd install \u4e2d\u7684 --ha \u9009\u9879\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6 chart \u6587\u4ef6\u6765\u83b7\u5f97 values-ha.yaml \uff1a $ helm fetch --untar linkerd/linkerd2 \u7136\u540e\u4f7f\u7528 -f flag \u63d0\u4f9b\u8986\u76d6\u6587\u4ef6\uff0c\u4f8b\u5982\uff1a ## see above on how to set $exp helm install linkerd2 \\ --set-file identityTrustAnchorsPEM=ca.crt \\ --set-file identity.issuer.tls.crtPEM=issuer.crt \\ --set-file identity.issuer.tls.keyPEM=issuer.key \\ --set identity.issuer.crtExpiry=$exp \\ -f linkerd2/values-ha.yaml \\ linkerd/linkerd2 \u91c7\u7528\u54ea\u79cd\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\u5747\u53ef\uff0c\u5230\u8fd9\u91cc\u6211\u4eec\u73b0\u5728\u5c31\u5b8c\u6210\u4e86 Linkerd \u7684\u5b89\u88c5\uff0c\u91cd\u65b0\u6267\u884c linkerd version \u547d\u4ee4\u5c31\u53ef\u4ee5\u770b\u5230 Server \u7aef\u7248\u672c\u4fe1\u606f\u4e86\uff1a linkerd version Client version: stable-2.12.0 Server version: stable-2.12.0","title":"\u5b89\u88c5"},{"location":"chap11/1linkered_sm/#_3","text":"\u63a5\u4e0b\u6765\u6211\u4eec\u5b89\u88c5\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u5e94\u7528 Emojivoto\uff0c \u8be5\u5e94\u7528\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u72ec\u7acb Kubernetes \u5e94\u7528\u7a0b\u5e8f\uff0c\u5b83\u6df7\u5408\u4f7f\u7528 gRPC \u548c HTTP \u8c03\u7528\uff0c\u5141\u8bb8\u7528\u6237\u5bf9\u4ed6\u4eec\u6700\u559c\u6b22\u7684\u8868\u60c5\u7b26\u53f7\u8fdb\u884c\u6295\u7968 \u3002 \u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u5c06 Emojivoto \u5b89\u88c5\u5230 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\uff1a $ curl -fsL https://run.linkerd.io/emojivoto.yml emojivoto.yml apiVersion: v1 kind: Namespace metadata: name: emojivoto --- apiVersion: v1 kind: ServiceAccount metadata: name: emoji namespace: emojivoto --- apiVersion: v1 kind: ServiceAccount metadata: name: voting namespace: emojivoto --- apiVersion: v1 kind: ServiceAccount metadata: name: web namespace: emojivoto --- apiVersion: v1 kind: Service metadata: name: emoji-svc namespace: emojivoto spec: ports: - name: grpc port: 8080 targetPort: 8080 - name: prom port: 8801 targetPort: 8801 selector: app: emoji-svc --- apiVersion: v1 kind: Service metadata: name: voting-svc namespace: emojivoto spec: ports: - name: grpc port: 8080 targetPort: 8080 - name: prom port: 8801 targetPort: 8801 selector: app: voting-svc --- apiVersion: v1 kind: Service metadata: name: web-svc namespace: emojivoto spec: ports: - name: http port: 80 targetPort: 8080 selector: app: web-svc type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: emoji app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: v9 name: emoji namespace: emojivoto spec: replicas: 1 selector: matchLabels: app: emoji-svc version: v9 template: metadata: labels: app: emoji-svc version: v9 spec: containers: - env: - name: GRPC_PORT value: \"8080\" - name: PROM_PORT value: \"8801\" image: buoyantio/emojivoto-emoji-svc:v9 name: emoji-svc ports: - containerPort: 8080 name: grpc - containerPort: 8801 name: prom resources: requests: cpu: 100m serviceAccountName: emoji --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: vote-bot app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: v9 name: vote-bot namespace: emojivoto spec: replicas: 1 selector: matchLabels: app: vote-bot version: v9 template: metadata: labels: app: vote-bot version: v9 spec: containers: - command: - emojivoto-vote-bot env: - name: WEB_HOST value: web-svc.emojivoto:80 image: buoyantio/emojivoto-web:v9 name: vote-bot resources: requests: cpu: 10m --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: voting app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: v9 name: voting namespace: emojivoto spec: replicas: 1 selector: matchLabels: app: voting-svc version: v9 template: metadata: labels: app: voting-svc version: v9 spec: containers: - env: - name: GRPC_PORT value: \"8080\" - name: PROM_PORT value: \"8801\" image: buoyantio/emojivoto-voting-svc:v9 name: voting-svc ports: - containerPort: 8080 name: grpc - containerPort: 8801 name: prom resources: requests: cpu: 100m serviceAccountName: voting --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: web app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: v9 name: web namespace: emojivoto spec: replicas: 1 selector: matchLabels: app: web-svc version: v9 template: metadata: labels: app: web-svc version: v9 spec: containers: - env: - name: WEB_PORT value: \"8080\" - name: EMOJISVC_HOST value: emoji-svc.emojivoto:8080 - name: VOTINGSVC_HOST value: voting-svc.emojivoto:8080 - name: INDEX_BUNDLE value: dist/index_bundle.js image: buoyantio/emojivoto-web:v9 name: web-svc ports: - containerPort: 8080 name: http resources: requests: cpu: 100m serviceAccountName: web \u8be5\u5e94\u7528\u4e0b\u53ef\u4ee5\u770b\u5230\u4e00\u5171\u5305\u542b 4 \u4e2a Pod \u670d\u52a1\u3002 $ kubectl get pod -n emojivoto NAME READY STATUS RESTARTS AGE emoji-79b7665b88-4j96m 1/1 Running 0 8s vote-bot-86d4645dc7-mm4ct 1/1 Running 0 8s voting-f86cc8d89-cct2t 1/1 Running 0 8s web-8578749657-hb57h 1/1 Running 0 8s $ kubectl get svc -n emojivoto NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE emoji-svc ClusterIP 10.105.148.26 <none> 8080/TCP,8801/TCP 2m26s voting-svc ClusterIP 10.100.203.107 <none> 8080/TCP,8801/TCP 2m26s web-svc ClusterIP 10.106.94.83 <none> 80/TCP 2m26s \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 port-forward \u6765\u66b4\u9732 web-svc \u670d\u52a1\uff0c\u7136\u540e\u4fbf\u53ef\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\u8be5\u5e94\u7528\u3002 $ kubectl -n emojivoto port-forward svc/web-svc 8080:80 Forwarding from 127.0.0.1:8080 -> 8080 Forwarding from [::1]:8080 -> 8080 Handling connection for 8080 \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u901a\u8fc7 http://localhost:8080 \u8bbf\u95ee Emojivoto \u5e94\u7528\u4e86\u3002 \u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u9875\u9762\u4e2d\u559c\u6b22\u7684\u8868\u60c5\u8fdb\u884c\u6295\u7968\uff0c\u4f46\u662f\u9009\u62e9\u67d0\u4e9b\u8868\u60c5\u540e\u4f1a\u51fa\u73b0\u4e00\u4e9b\u9519\u8bef\uff0c\u6bd4\u5982\u5f53\u6211\u4eec\u70b9\u51fb\u751c\u751c\u5708\u8868\u60c5\u7b26\u53f7\u7684\u65f6\u5019\u4f1a\u5f97\u5230\u4e00\u4e2a 404 \u9875\u9762\u3002 \u4e0d\u8fc7\u4e0d\u7528\u62c5\u5fc3\uff0c\u8fd9\u662f\u5e94\u7528\u4e2d\u6545\u610f\u7559\u4e0b\u7684\u9519\u8bef\uff0c\u4e3a\u7684\u662f\u540e\u9762\u4f7f\u7528 Linkerd \u6765\u8bc6\u522b\u8be5\u95ee\u9898\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684\u793a\u4f8b\u5e94\u7528\u52a0\u5165\u5230 Service Mesh \u4e2d\u6765\uff0c\u5411\u5176\u6dfb\u52a0 Linkerd \u7684\u6570\u636e\u5e73\u9762\u4ee3\u7406\uff0c\u76f4\u63a5\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u5c06 Emojivoto \u5e94\u7528\u7f51\u683c\u5316\uff1a $ kubectl get -n emojivoto deploy -o yaml \\ > | linkerd inject - \\ > | kubectl apply -f - deployment \"emoji\" injected deployment \"vote-bot\" injected deployment \"voting\" injected deployment \"web\" injected deployment.apps/emoji configured deployment.apps/vote-bot configured deployment.apps/voting configured deployment.apps/web configured \u4e0a\u9762\u7684\u547d\u4ee4\u9996\u5148\u83b7\u53d6\u5728 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u7684\u6240\u6709 Deployments\uff0c\u7136\u540e\u901a\u8fc7 linkerd inject \u8fd0\u884c\u5b83\u4eec\u7684\u6e05\u5355\uff0c\u7136\u540e\u5c06\u5176\u91cd\u65b0\u5e94\u7528\u5230\u96c6\u7fa4\u3002 \u6ce8\u610f linkerd inject \u547d\u4ee4\u53ea\u662f\u5728 Pod \u89c4\u8303\u4e2d\u6dfb\u52a0\u4e00\u4e2a linkerd.io/inject: enabled \u7684\u6ce8\u89e3\uff0c\u5e76\u4e0d\u4f1a\u76f4\u63a5\u6ce8\u5165\u4e00\u4e2a Sidecar \u5bb9\u5668\uff0c\u8be5\u6ce8\u89e3\u5373\u53ef\u6307\u793a Linkerd \u5728\u521b\u5efa Pod \u65f6\u5c06\u4ee3\u7406\u6ce8\u5165\u5230\u5176\u4e2d\uff0c\u6240\u4ee5\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u540e\u5e94\u7528 Pod \u4e2d\u4f1a\u65b0\u589e\u4e00\u4e2a sidecar \u7684\u4ee3\u7406\u5bb9\u5668\u3002 $ kubectl get pods -n emojivoto NAME READY STATUS RESTARTS AGE emoji-6fd4b555c7-pbnck 2/2 Running 0 2m51s vote-bot-7bf6bc7c5b-5j66j 2/2 Running 0 2m51s voting-5db96b44c4-wk7bb 2/2 Running 0 2m51s web-5fdb59bc88-76g2t 2/2 Running 0 2m51s \u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a Pod \u73b0\u5728\u90fd\u6709 2 \u4e2a\u5bb9\u5668\uff0c\u76f8\u8f83\u4e8e\u4e4b\u524d\u591a\u4e86\u4e00\u4e2a Linkerd \u7684 sidecar \u4ee3\u7406\u5bb9\u5668\u3002 \u5f53\u5e94\u7528\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u6210\u529f\u5c06\u5e94\u7528\u5f15\u5165\u5230 Linkerd \u7684\u7f51\u683c\u670d\u52a1\u4e2d\u6765\u4e86\uff0c\u65b0\u589e\u7684\u4ee3\u7406\u5bb9\u5668\u7ec4\u6210\u4e86\u6570\u636e\u5e73\u9762\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u68c0\u67e5\u6570\u636e\u5e73\u9762\u72b6\u6001\uff1a $ linkerd -n emojivoto check --proxy Linkerd core checks =================== kubernetes-api -------------- \u221a can initialize the client \u221a can query the Kubernetes API kubernetes-version ------------------ \u221a is running the minimum Kubernetes API version \u221a is running the minimum kubectl version linkerd-existence ----------------- \u221a 'linkerd-config' config map exists \u221a heartbeat ServiceAccount exist \u221a control plane replica sets are ready \u221a no unschedulable pods \u221a control plane pods are ready \u221a cluster networks contains all pods linkerd-config -------------- \u221a control plane Namespace exists \u221a control plane ClusterRoles exist \u221a control plane ClusterRoleBindings exist \u221a control plane ServiceAccounts exist \u221a control plane CustomResourceDefinitions exist \u221a control plane MutatingWebhookConfigurations exist \u221a control plane ValidatingWebhookConfigurations exist \u221a proxy-init container runs as root user if docker container runtime is used linkerd-identity ---------------- \u221a certificate config is valid \u221a trust anchors are using supported crypto algorithm \u221a trust anchors are within their validity period \u221a trust anchors are valid for at least 60 days \u221a issuer cert is using supported crypto algorithm \u221a issuer cert is within its validity period \u221a issuer cert is valid for at least 60 days \u221a issuer cert is issued by the trust anchor linkerd-webhooks-and-apisvc-tls ------------------------------- \u221a proxy-injector webhook has valid cert \u221a proxy-injector cert is valid for at least 60 days \u221a sp-validator webhook has valid cert \u221a sp-validator cert is valid for at least 60 days \u221a policy-validator webhook has valid cert \u221a policy-validator cert is valid for at least 60 days linkerd-identity-data-plane --------------------------- \u221a data plane proxies certificate match CA linkerd-version --------------- \u221a can determine the latest version \u221a cli is up-to-date linkerd-control-plane-proxy --------------------------- \u221a control plane proxies are healthy \u221a control plane proxies are up-to-date \u221a control plane proxies and cli versions match linkerd-data-plane ------------------ \u221a data plane namespace exists \u221a data plane proxies are ready \u221a data plane is up-to-date \u221a data plane and cli versions match \u221a data plane pod labels are configured correctly \u221a data plane service labels are configured correctly \u221a data plane service annotations are configured correctly \u221a opaque ports are properly annotated Status check results are \u221a \u5f53\u7136\uff0c\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u901a\u8fc7 http://localhost:8080 \u8bbf\u95ee\u5e94\u7528\uff0c\u5f53\u7136\u5728\u4f7f\u7528\u4e0a\u548c\u4e4b\u524d\u6ca1\u4ec0\u4e48\u533a\u522b\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Linkerd \u53bb\u67e5\u770b\u5e94\u7528\u5b9e\u9645\u4e0a\u505a\u4e86\u54ea\u4e9b\u4e8b\u60c5\uff0c\u4f46\u662f\u6211\u4eec\u9700\u8981\u53bb\u5355\u72ec\u5b89\u88c5\u4e00\u4e2a\u63d2\u4ef6\uff0c \u7531\u4e8e Linkerd \u7684\u6838\u5fc3\u63a7\u5236\u5e73\u9762\u975e\u5e38\u8f7b\u91cf\u7ea7\uff0c \u6240\u4ee5 Linkerd \u9644\u5e26\u4e86\u4e00\u4e9b\u63d2\u4ef6\uff0c\u8fd9\u4e9b\u63d2\u4ef6\u4e3a Linkerd \u6dfb\u52a0\u4e86\u4e00\u4e9b\u975e\u5173\u952e\u4f46\u901a\u5e38\u6709\u7528\u7684\u529f\u80fd\uff0c\u5305\u62ec\u5404\u79cd\u4eea\u8868\u677f\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e2a viz \u63d2\u4ef6\uff0cLinkerd-Viz \u63d2\u4ef6\u5305\u542b Linkerd \u7684\u53ef\u89c2\u5bdf\u6027\u548c\u53ef\u89c6\u5316\u7ec4\u4ef6\u3002\u5b89\u88c5\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz install | kubectl apply -f - .... namespace/linkerd-viz created clusterrole.rbac.authorization.k8s.io/linkerd-linkerd-viz-metrics-api created clusterrolebinding.rbac.authorization.k8s.io/linkerd- \u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a linkerd-viz \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u4f1a\u5728\u8be5\u547d\u540d\u7a7a\u95f4\u4e2d\u5b89\u88c5\u76d1\u63a7\u76f8\u5173\u7684\u5e94\u7528\uff0c\u6bd4\u5982 Prometheus\u3001Grafana \u7b49\u3002 $ kubectl get pods -n linkerd-viz NAME READY STATUS RESTARTS AGE metrics-api-568596fbbb-dsgb8 2/2 Running 0 34m prometheus-75c46f88b5-lzhxf 2/2 Running 0 34m tap-756c88b45f-wtbrf 2/2 Running 0 34m tap-injector-69c7d96674-h86w5 2/2 Running 0 34m web-65557589c8-svb9k 2/2 Running 0 34m \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6253\u5f00\u4e00\u4e2a dashboard \u9875\u9762\uff1a $ linkerd viz dashboard & [1] 68487 $ Linkerd dashboard available at: http://localhost:50750 Grafana dashboard available at: http://localhost:50750/grafana Opening Linkerd dashboard in the default browser \u5f53 viz \u63d2\u4ef6\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u540e\u4f1a\u81ea\u52a8\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u4e00\u4e2a Linkerd \u7684\u53ef\u89c2\u5bdf\u6027\u7684 Dashboard\u3002 \u6b64\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Ingress \u6765\u66b4\u9732 viz \u670d\u52a1\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: web-ingress namespace: linkerd-viz annotations: nginx.ingress.kubernetes.io/upstream-vhost: $service_name.$namespace.svc.cluster.local:8084 nginx.ingress.kubernetes.io/configuration-snippet: | proxy_set_header Origin \"\"; proxy_hide_header l5d-remote-ip; proxy_hide_header l5d-server-id; spec: ingressClassName: nginx rules: - host: linkerd.k8s.local http: paths: - path: / pathType: Prefix backend: service: name: web port: number: 8084 \u5e94\u7528\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7 linkerd.k8s.local \u8bbf\u95ee viz \u4e86\u3002 \u8fd8\u53ef\u4ee5\u663e\u793a\u81ea\u52a8\u751f\u6210\u7684\u62d3\u6251\u56fe\u3002 \u5728\u9875\u9762\u4e0a\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u6bcf\u4e2a Emojivoto \u7ec4\u4ef6\u7684\u5b9e\u65f6\u6307\u6807\uff0c\u5c31\u53ef\u4ee5\u786e\u5b9a\u54ea\u4e2a\u7ec4\u4ef6\u51fa\u73b0\u4e86\u90e8\u5206\u6545\u969c\u4e86\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u6709\u9488\u5bf9\u6027\u7684\u53bb\u89e3\u51b3\u95ee\u9898\u4e86\u3002 \u5728\u5bf9\u5e94\u7684\u8d44\u6e90\u540e\u9762\u5305\u542b\u4e00\u4e2a Grafana \u7684\u56fe\u6807\uff0c\u70b9\u51fb\u53ef\u4ee5\u81ea\u52a8\u8df3\u8f6c\u5230 Grafana \u7684\u76d1\u63a7\u9875\u9762\u3002","title":"\u793a\u4f8b"},{"location":"chap11/2linkered_index/","text":"2 \u5728 Linkerd \u4e2d\u83b7\u53d6\u5e94\u7528\u7684\u9ec4\u91d1\u6307\u6807 kubectl get ns linkerd-viz -o json > linkerd-viz.json kubectl proxy curl -k -H \"Content-Type: application/json\" -X PUT --data-binary @linkerd-viz.json http://127.0.0.1:8001/api/v1/namespaces/linkerd-viz/finalize \u6211\u4eec\u5c06\u8be6\u7ec6\u4e86\u89e3\u8fd9\u4e9b\u6307\u6807\uff0c\u5e76\u4f7f\u7528 Emojivoto \u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\u4e86\u89e3\u5b83\u4eec\u7684\u542b\u4e49\u3002 \u6211\u4eec\u5148\u7b80\u5355\u4e86\u89e3\u4e0b\u670d\u52a1\u5065\u5eb7\u9ec4\u91d1\u6307\u6807\u7684\u7ecf\u5178\u5b9a\u4e49\uff1a Latency\uff08\u5ef6\u8fdf\uff09 Error rate\uff08\u9519\u8bef\u7387\uff09 Traffic volume\uff08\u6d41\u91cf\uff09 Saturation\uff08\u9971\u548c\u5ea6\uff09 Linkerd \u7684\u4ef7\u503c\u4e0d\u4ec5\u4ec5\u5728\u4e8e\u5b83\u53ef\u4ee5\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\uff0c\u6bd5\u7adf\uff0c\u6211\u4eec\u53ef\u4ee5\u975e\u5e38\u7b80\u5355\u5730\u76f4\u63a5\u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u3002\u76f8\u53cd\uff0cLinkerd \u7684\u4ef7\u503c\u5728\u4e8e\u5b83\u53ef\u4ee5\u5728\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4ee5\u7edf\u4e00\u7684\u65b9\u5f0f\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\uff0c\u5e76\u4e14\u4e0d\u9700\u8981\u66f4\u6539\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u65e0\u8bba\u662f\u8c01\u7f16\u5199\u7684\uff0c\u5b83\u4f7f\u7528\u4ec0\u4e48\u6846\u67b6\uff0c\u5b83\u662f\u7528\u4ec0\u4e48\u8bed\u8a00\u7f16\u5199\u7684\uff0c\u4ee5\u53ca\u5b83\u505a\u4ec0\u4e48\uff0cLinkerd \u90fd\u53ef\u4ee5\u4e3a\u4f60\u7684\u670d\u52a1\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\u3002 Latency \u5ef6\u8fdf\u662f\u54cd\u5e94\u8bf7\u6c42\u6240\u9700\u7684\u65f6\u95f4\uff0c\u5bf9\u4e8e Linkerd\uff0c\u662f\u901a\u8fc7 Linkerd \u4ee3\u7406\u5411\u5e94\u7528\u7a0b\u5e8f\u53d1\u9001\u8bf7\u6c42\u548c\u63a5\u6536\u54cd\u5e94\u4e4b\u95f4\u7ecf\u8fc7\u7684\u65f6\u95f4\u6765\u8fdb\u884c\u8861\u91cf\u7684\uff0c\u56e0\u4e3a\u5b83\u5728\u8bf7\u6c42\u4e4b\u95f4\u53ef\u80fd\u4f1a\u6709\u5f88\u5927\u5dee\u5f02\uff0c\u6240\u4ee5\u6307\u5b9a\u65f6\u95f4\u6bb5\u7684\u5ef6\u8fdf\u901a\u5e38\u4f5c\u4e3a\u7edf\u8ba1\u5206\u5e03\u6765\u8861\u91cf\uff0c\u5e76\u62a5\u544a\u4e3a\u6b64\u5206\u5e03\u7684\u767e\u5206\u4f4d\u6570\u3002 Linkerd \u80fd\u591f\u62a5\u544a\u5e38\u7528\u7684\u5ef6\u8fdf\u6307\u6807\u4f8b\u5982 p50\u3001p95\u3001p99 \u548c p999\uff0c\u5bf9\u5e94\u4e8e 50\u300195\u300199 \u548c 99.9 \u7684\u767e\u5206\u4f4d\u6570\u3002\u8bf7\u6c42\u7684\u5ef6\u8fdf\u5206\u5e03\uff0c\u8fd9\u4e9b\u88ab\u79f0\u4e3a\u201c\u5c3e\u90e8\u5ef6\u8fdf\u201d\uff0c\u901a\u5e38\u662f\u62a5\u544a\u5927\u89c4\u6a21\u7cfb\u7edf\u884c\u4e3a\u7684\u91cd\u8981\u6307\u6807\u3002 Error rate \u9519\u8bef\u7387\u662f\u88ab\u89c6\u4e3a\u9519\u8bef\u54cd\u5e94\u7684\u767e\u5206\u6bd4\uff0c\u5bf9\u4e8e Linkerd\uff0c\u662f\u901a\u8fc7 HTTP \u72b6\u6001\u7801\u6765\u8861\u91cf\u7684\uff1a 2xx \u548c 4xx \u54cd\u5e94\u88ab\u8ba4\u4e3a\u662f\u6210\u529f\u7684\uff0c5xx \u54cd\u5e94\u88ab\u8ba4\u4e3a\u662f\u5931\u8d25\u7684\uff0c\u5f53\u7136\u53cd\u8fc7\u6765\u6211\u4eec\u4e5f\u53ef\u4ee5\u8bf4 Linkerd \u62a5\u544a\u7684\u662f\u6210\u529f\u7387\u800c\u4e0d\u662f\u9519\u8bef\u7387 \u3002 \u9700\u8981\u6ce8\u610f\u867d\u7136 4xx HTTP \u54cd\u5e94\u7801\u5bf9\u5e94\u4e8e\u5404\u79cd\u5f62\u5f0f\u7684\u201c\u672a\u627e\u5230\u60a8\u8bf7\u6c42\u7684\u8d44\u6e90\u201d\uff0c\u4f46\u8fd9\u4e9b\u662f\u670d\u52a1\u5668\u65b9\u9762\u7684\u6b63\u786e\u54cd\u5e94\uff0c\u800c\u4e0d\u662f\u9519\u8bef\u54cd\u5e94\u3002 \u56e0\u6b64\uff0cLinkerd \u8ba4\u4e3a\u8fd9\u4e9b\u8bf7\u6c42\u662f\u6210\u529f\u7684\uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u6309\u7167\u5b83\u7684\u8981\u6c42\u505a\u4e86\u3002 Traffic volume \u6d41\u91cf\u662f\u5bf9\u7cfb\u7edf\u7684\u9700\u6c42\u91cf\u5ea6\uff0c\u5728 Linkerd \u7684\u4e0a\u4e0b\u6587\u4e2d\uff0c\u8fd9\u88ab\u6d4b\u91cf\u4e3a\u8bf7\u6c42\u7387\uff0c\u4f8b\u5982\u6bcf\u79d2\u8bf7\u6c42\u6570 (RPS)\u3002Linkerd \u7b80\u5355\u5730\u901a\u8fc7\u8ba1\u7b97\u5b83\u4ee3\u7406\u5230\u5e94\u7528\u7a0b\u5e8f\u7684\u8bf7\u6c42\u6765\u8ba1\u7b97\u8fd9\u4e00\u70b9\u3002 \u53e6\u5916\u4e5f\u9700\u8981\u6ce8\u610f\u7531\u4e8e Linkerd \u53ef\u4ee5\u81ea\u52a8\u91cd\u8bd5\u8bf7\u6c42\uff0c\u56e0\u6b64\u5b83\u63d0\u4f9b\u4e86\u4e24\u79cd\u6d41\u91cf\u5ea6\u91cf\uff1a \u5b9e\u9645\uff08\u5bf9\u5e94\u8bf7\u6c42\uff0c\u5305\u62ec\u91cd\u8bd5\uff09\u548c\u6709\u6548\uff08\u5bf9\u5e94\u4e0d\u91cd\u8bd5\u7684\u8bf7\u6c42\uff09 \u3002 \u5982\u679c\u5ba2\u6237\u7aef\u5411\u4e2d\u95f4\u6709 Linkerd \u7684\u670d\u52a1\u5668\u53d1\u51fa\u8bf7\u6c42\uff0c\u5219\u6709\u6548\u8ba1\u6570\u5c06\u662f\u5ba2\u6237\u7aef\u53d1\u51fa\u7684\u8bf7\u6c42\u6570\uff1b\u5b9e\u9645\u8ba1\u6570\u5c06\u662f\u670d\u52a1\u5668\u6536\u5230\u7684\u8bf7\u6c42\u6570\u3002 Saturation \u9971\u548c\u5ea6\u662f\u5bf9\u670d\u52a1\u53ef\u7528\u7684\u603b\u8d44\u6e90\u6d88\u8017\u7684\u5ea6\u91cf\uff0c\u4f8b\u5982 CPU\u3001\u5185\u5b58\u3002\u4e0e\u5176\u4ed6\u670d\u52a1\u7f51\u683c\u4e00\u6837\uff0cLinkerd \u6ca1\u6709\u76f4\u63a5\u7684\u673a\u5236\u6765\u8861\u91cf\u9971\u548c\u5ea6\uff0c\u4f46\u662f\uff0c\u5ef6\u8fdf\u901a\u5e38\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u8fd1\u4f3c\u503c\u3002 \u8c37\u6b4c SRE \u4e66\u7c4d\u8bf4\uff1a \u5ef6\u8fdf\u589e\u52a0\u901a\u5e38\u662f\u9971\u548c\u7684\u4e3b\u8981\u6307\u6807\uff0c\u5728\u67d0\u4e2a\u5c0f\u7a97\u53e3\uff08\u4f8b\u5982\u4e00\u5206\u949f\uff09\u5185\u6d4b\u91cf\u4f60\u7684\u7b2c 99 \u4e2a\u767e\u5206\u4f4d\u54cd\u5e94\u65f6\u95f4\u53ef\u4ee5\u7ed9\u51fa\u975e\u5e38\u65e9\u671f\u7684\u9971\u548c\u4fe1\u53f7\u3002 \u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e3b\u8981\u4f7f\u7528\u53e6\u5916\u4e09\u4e2a\u9ec4\u91d1\u6307\u6807\uff1a\u6210\u529f\u7387\u3001\u8bf7\u6c42\u7387\u548c\u5ef6\u8fdf\u3002 \u6700\u540e\u4e00\u70b9\u662f\uff0c\u867d\u7136 Linkerd \u53ef\u4ee5\u4ee3\u7406\u4efb\u4f55 TCP \u6d41\u91cf\uff0c\u4f46\u8fd9\u4e9b\u9ec4\u91d1\u6307\u6807\u4ec5\u9002\u7528\u4e8e\u4f7f\u7528 HTTP \u6216 gRPC \u7684\u670d\u52a1\u3002 \u8fd9\u662f\u56e0\u4e3a\u8fd9\u4e9b\u6307\u6807\u9700\u8981\u7b2c 7 \u5c42\u6216\u534f\u8bae\u7ea7\u522b\u7684\u7406\u89e3\u624d\u80fd\u8ba1\u7b97\u3002\u4e00\u4e2a HTTP \u8bf7\u6c42\u5177\u6709\u6210\u529f\u548c\u4e0d\u6210\u529f\u8bf7\u6c42\u7684\u6982\u5ff5\uff0c\u4efb\u610f\u7684 TCP \u5b57\u8282\u6d41\u4e0d\u4f1a\u3002 Linkerd Dashboard \u4e2d\u67e5\u770b\u6307\u6807 \u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u8fd9\u4e9b\u6307\u6807\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u770b\u770b\u524d\u9762\u90e8\u7f72\u7684 Emojivoto \u5e94\u7528\u3002 $ kubectl get pods -n emojivoto NAME READY STATUS RESTARTS AGE emoji-696d9d8f95-5vn9w 2/2 Running 2 (5h11m ago) 41h vote-bot-6d7677bb68-jvxsg 2/2 Running 2 (5h11m ago) 41h voting-ff4c54b8d-jjpkm 2/2 Running 2 (5h11m ago) 41h web-5f86686c4d-58p7k 2/2 Running 2 (5h11m ago) 41h Emojivoto \u5e94\u7528\u662f\u4e00\u4e2a gRPC \u670d\u52a1\uff0c\u4e00\u5171\u5305\u542b\u4e09\u4e2a\u5fae\u670d\u52a1\uff1a web\uff1a\u7528\u6237\u4e0e\u4e4b\u4ea4\u4e92\u7684\u524d\u7aef\u670d\u52a1 emoji\uff1a\u63d0\u4f9b\u8868\u60c5\u5217\u8868\u7684 API \u670d\u52a1 voting\uff1a\u63d0\u4f9b\u4e3a\u8868\u60c5\u6295\u7968\u7684 API \u670d\u52a1 \u6211\u4eec\u5df2\u7ecf\u5c06\u8be5\u5e94\u7528\u5f15\u5165\u5230\u7f51\u683c\u4e2d\u6765\u4e86\uff0c\u80fd\u591f\u5728 Linkerd \u4eea\u8868\u677f\u4e2d\u67e5\u770b Emojivoto \u5e94\u7528\u7684\u6307\u6807\u4e86\uff0c\u5f53\u6211\u4eec\u6253\u5f00 Viz \u7684\u4eea\u8868\u677f\u7684\u65f6\u5019\uff0c\u9ed8\u8ba4\u4f1a\u663e\u793a\u96c6\u7fa4\u7684\u6240\u6709\u547d\u540d\u7a7a\u95f4\u5217\u8868\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u975e\u5e38\u5927\u7684\u533a\u522b\u662f\u547d\u540d\u7a7a\u95f4\u5217\u8868\u4e2d\u7684 emojivoto \u9879\u76ee\u73b0\u5728\u5728 Meshed \u5217\u4e0b\u663e\u793a\u4e3a 4/4\u3002 \u5355\u51fb emojivoto \u94fe\u63a5\u53ef\u67e5\u770b\u547d\u540d\u7a7a\u95f4\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5305\u62ec\u201c\u7ae0\u9c7c\u201d\u56fe\uff0c\u663e\u793a\u670d\u52a1\u5982\u4f55\u901a\u8fc7\u7f51\u7edc\u8fde\u63a5\u76f8\u4e92\u5173\u8054\u7684\u3002\u8bf7\u8bb0\u4f4f\u8fd9\u5f20\u56fe\u7247\uff0c\u56e0\u4e3a\u6211\u4eec\u5c06\u4f7f\u7528 CLI \u5de5\u5177\u67e5\u770b\u76f8\u540c\u7684\u4fe1\u606f\u3002 \u6b64\u5916\u8fd8\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4e0a\u9762\u8ba8\u8bba\u8fc7\u7684\u9ec4\u91d1\u6307\u6807\uff1ap50\u3001p95 \u548c p99 \u5ef6\u8fdf\u3001\u670d\u52a1\u7684\u6210\u529f/\u9519\u8bef\u7387\u4ee5\u53ca\u8bf7\u6c42\u91cf\uff0c \u5373\u6bcf\u79d2\u8bf7\u6c42\u6570(RPS)\u3002\u4ece\u6210\u529f\u7387\u4e00\u5217\u53ef\u4ee5\u770b\u51fa\u5176\u4e2d\u4e00\u9879\u670d\u52a1\u6709\u4e00\u4e9b\u9519\u8bef \u3002 \u8be5 Deployment \u7ea7\u522b\u4fe1\u606f\u662f\u5904\u7406\u5e94\u7528\u7a0b\u5e8f\u8bf7\u6c42\u7684\u6240\u6709 Pod \u7684\u6307\u6807\u7684\u805a\u5408\uff0c\u6211\u4eec\u5411\u4e0b\u6eda\u52a8\u9875\u9762\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a Pod \u5bf9\u5e94\u7684\u6307\u6807\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0 web \u670d\u52a1\u7684\u526f\u672c\u6570\u6765\u8fdb\u884c\u9a8c\u8bc1\u3002 \u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5c06 web \u670d\u52a1\u589e\u52a0\u5230\u4e24\u4e2a\u526f\u672c\uff1a $ kubectl scale deploy/web -n emojivoto --replicas=2 \u6267\u884c\u6b64\u547d\u4ee4\u540e\uff0c\u4eea\u8868\u677f\u5c06\u81ea\u884c\u66f4\u65b0\uff0cWeb \u5e94\u7528\u5c06\u5728 Meshed \u5217\u4e0b\u663e\u793a\u4e3a 2/2\uff0c\u6b64\u5916\uff0c\u4f60\u5c06\u5728 Pod \u90e8\u5206\u4e0b\u770b\u5230\u53e6\u4e00\u4e2a Web pod\u3002 \u901a\u8fc7\u89c2\u5bdf Deployments \u548c Pods \u90e8\u5206\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u770b\u5230 Deployments \u4e2d\u7684\u6307\u6807\u6570\u636e\u7684\u786e\u5c31\u662f Pods \u7684\u6307\u6807\u805a\u5408\u6570\u636e\u3002\u6700\u540e\u6211\u4eec\u518d\u6765\u770b\u770b Linkerd \u63d0\u4f9b\u7684 TCP \u7ea7\u522b\u7684\u6307\u6807\uff0c\u5728 emojivoto \u547d\u540d\u7a7a\u95f4\u7684\u9875\u9762\u5e95\u90e8\uff0c\u4f1a\u663e\u793a TCP \u8fde\u63a5\u6570\u4ee5\u53ca\u6bcf\u4e2a Pod \u8bfb\u53d6\u548c\u5199\u5165\u7684\u5b57\u8282\u6570 TCP \u7684\u6307\u6807\u6bd4 7 \u5c42\u7684\u6307\u6807\u4f1a\u66f4\u5c11\uff0c\u4f8b\u5982\u5728\u4efb\u610f TCP \u5b57\u8282\u6d41\u4e2d\u6ca1\u6709\u8bf7\u6c42\u7684\u6982\u5ff5\u3002\u5c3d\u7ba1\u5982\u6b64\uff0c\u8fd9\u4e9b\u6307\u6807\u5728\u8c03\u8bd5\u5e94\u7528\u7a0b\u5e8f\u7684\u8fde\u63a5\u7ea7\u522b\u95ee\u9898\u65f6\u4ecd\u7136\u5f88\u6709\u7528\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u7ee7\u7eed\u63a2\u7d22\u4eea\u8868\u677f\u5e76\u67e5\u770b\u8ba9\u6211\u4eec\u5b9e\u65f6\u67e5\u770b\u6d41\u91cf\u7684 Tap \u529f\u80fd\u3002 \u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u4f7f\u7528\u4eea\u8868\u677f\u6765\u83b7\u53d6 Emojivoto \u5e94\u7528\u7a0b\u5e8f\u4e2d\u670d\u52a1\u7684\u805a\u5408\u6027\u80fd\u6307\u6807\u4e86\u3002\u73b0\u5728\u8ba9\u6211\u4eec\u4f7f\u7528\u4eea\u8868\u677f\u901a\u8fc7 Linkerd \u63d0\u4f9b\u7684 tap \u529f\u80fd\u5b9e\u65f6\u67e5\u770b\u6d41\u91cf\u3002 \u5728\u4eea\u8868\u677f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 voting \u670d\u52a1\u7684\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u8ba9\u6211\u4eec\u4f7f\u7528 tap \u529f\u80fd\u6765\u67e5\u770b\u5bf9\u670d\u52a1\u7684\u8bf7\u6c42\uff0c\u6765\u5c1d\u8bd5\u5f04\u6e05\u695a\u53d1\u751f\u4e86\u4ec0\u4e48\u3002 \u5355\u51fb emojivoto \u5e94\u7528\u7684 voting \u94fe\u63a5\u53ef\u4ee5\u6df1\u5165\u4e86\u89e3\u8be6\u7ec6\u4fe1\u606f\uff0c\u6211\u4eec\u5c06\u770b\u5230\u7684\u7b2c\u4e00\u4ef6\u4e8b\u662f\u663e\u793a voting \u5fae\u670d\u52a1\u4e0e\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5176\u4ed6\u5fae\u670d\u52a1\u4e4b\u95f4\u5173\u7cfb\u7684\u56fe\u8868\u3002 \u5728\u56fe\u8868\u4e0b\u65b9\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a LIVE CALLS \u7684\u9009\u9879\u5361\uff0c \u5176\u4e2d\u663e\u793a\u4e86\u5bf9 voting \u670d\u52a1\u7684\u5b9e\u65f6\u8c03\u7528\uff01\u6bcf\u6b21\u8c03\u7528\u65f6\uff0c\u8868\u4e2d\u7684\u884c\u90fd\u4f1a\u66f4\u65b0\u6709\u5173\u8bf7\u6c42\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u5305\u62ec\u54cd\u5e94\u7684 HTTP \u72b6\u6001 \u3002 \u5728\u6211\u4eec\u8be6\u7ec6\u4e86\u89e3\u8fd9\u4e9b\u5b9e\u65f6\u8c03\u7528\u4e4b\u524d\uff0c \u6211\u4eec\u53ef\u4ee5\u70b9\u51fb Route Metrics \u9009\u9879\u5361\u6765\u67e5\u770b voting \u670d\u52a1\u7684\u8def\u7531\u8868\u4ee5\u53ca\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\uff0c\u5728\u6211\u4eec\u8fd9\u91cc\u53ea\u6709\u4e00\u4e2a\u540d\u4e3a Default \u7684\u8def\u7531\uff0c\u5b83\u662f\u4e3a\u6bcf\u4e2a\u670d\u52a1\u521b\u5efa\u7684 \u3002 \u73b0\u5728\u6211\u4eec\u77e5\u9053\u4e86\u5982\u4f55\u5728\u4eea\u8868\u677f\u4e2d\u67e5\u627e\u5b9e\u65f6\u8c03\u7528\uff0c\u73b0\u5728\u6211\u4eec\u6765\u5c1d\u8bd5\u4e0b\u770b\u770b\u662f\u5426\u53ef\u4ee5\u627e\u5230\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u7684\u8c03\u7528\u5e76\u4f7f\u7528\u4eea\u8868\u677f\u4e2d\u7684 tap \u529f\u80fd\u3002\u5f53\u6211\u4eec\u770b\u5230\u5bf9\u8def\u5f84 /emojivoto/v1.VotingService/VoteDoughnut \u7684\u8bf7\u6c42\uff0c\u8bf7\u5355\u51fb\u5176\u53f3\u4fa7\u7684\u663e\u5fae\u955c\u56fe\u6807\u8df3\u8f6c\u5230 Tap \u9875\u9762\u3002 \u5176\u5b9e\u901a\u8fc7\u67e5\u770b\u6210\u529f\u7387\u8fd9\u4e00\u5217\u7684\u6570\u636e\u5f88\u5bb9\u6613\u53d1\u73b0\u8be5\u8def\u5f84\u8bf7\u6c42\u6709\u9519\u8bef\u3002 Tap \u9875\u9762\u5305\u542b\u4e00\u4e2a\u591a\u4e2a\u5b57\u6bb5\u7684\u8868\u5355\uff0c\u8fd9\u4e9b\u5b57\u6bb5\u5df2\u6839\u636e\u6211\u4eec\u70b9\u51fb\u7684\u7279\u5b9a\u8bf7\u6c42\u7684\u94fe\u63a5\u9884\u5148\u586b\u5145\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc Path\u3001Namespace\u3001Resource \u7b49\u5b57\u6bb5\u90fd\u5df2\u7ecf\u88ab\u81ea\u52a8\u586b\u5145\u4e0a\u4e86\uff0c\u4e0b\u9762\u8fd8\u6709\u4e00\u4e2a\u8f93\u51fa\u663e\u793a\u6b63\u5728\u8fd0\u884c\u7684\u5f53\u524d Tap \u67e5\u8be2\u3002 \u73b0\u5728\u6211\u4eec\u70b9\u51fb Tap \u9875\u9762\u9876\u90e8\u7684 START \u6309\u94ae\uff0c\u5f00\u59cb\u5bf9\u6295\u7968\u670d\u52a1\u7684 / emojivoto.v1.VotingService/VoteDougNut \u8def\u5f84\u7684\u8bf7\u6c42\uff0c\u51e0\u79d2\u949f\u540e\uff0c\u4e0b\u65b9\u7684\u5217\u8868\u5c06\u5f00\u59cb\u586b\u5145 VoteDougNut \u8def\u5f84\u7684\u4f20\u5165\u8bf7\u6c42\u3002 \u6211\u4eec\u53ef\u4ee5\u5355\u51fb\u5de6\u4fa7\u7684\u7bad\u5934\u6765\u67e5\u770b\u5305\u542b\u8bf7\u6c42\u4fe1\u606f\u7684\u5bf9\u8bdd\u6846\u3002 \u8fd9\u5c31\u662f\u901a\u8fc7 Linkerd \u4eea\u8868\u677f\u4e2d\u4f7f\u7528 Tap \u7684\u65b9\u5f0f\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u66f4\u6539\u8868\u5355\u5b57\u6bb5\u4e2d\u7684\u503c\u5e76\u4f7f\u7528\u4e0d\u540c\u7684\u67e5\u8be2\u6765\u67e5\u770b\u4e0d\u540c\u7684\u8bf7\u6c42\uff0c\u4f8b\u5982\u6211\u4eec\u53ef\u4ee5\u5c06 Path \u5b57\u6bb5\u4e2d\u7684 /emojivoto.v1.VotingService/VoteDoughnut \u503c\u5220\u6389\uff0c\u5e76\u5c06 To Resource \u8bbe\u7f6e\u4e3a Deployment \uff0c\u5f53\u6211\u4eec\u70b9\u51fb\u5f00\u59cb\u6309\u94ae\u540e\uff0c\u6211\u4eec\u5c06\u53ef\u4ee5\u770b\u5230\u4ece Web \u670d\u52a1\u53d1\u9001\u7684\u6240\u6709\u6d41\u91cf\u3002 \u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u5982\u4f55\u4f7f\u7528 Tap \u67e5\u770b\u670d\u52a1\u7684\u6d41\u91cf\u6307\u6807\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u901a\u8fc7\u67e5\u770b Linkerd \u7684 Grafana \u4eea\u8868\u677f\u6765\u4e86\u89e3\u8fd9\u4e9b\u6307\u6807\u662f\u5982\u4f55\u4f7f\u7528\u7684\u3002 Grafana \u4e2d\u5c55\u793a\u6307\u6807 Linkerd \u7684 Viz \u63d2\u4ef6\u5185\u7f6e\u4e86 Grafana\uff0cLinkerd \u4f7f\u7528 Grafana \u4e3a\u90e8\u7f72\u5230 Kubernetes \u7684\u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u4e86\u989d\u5916\u7684\u53ef\u89c2\u5bdf\u6027\u6570\u636e\u3002 \u5728\u6d4f\u89c8\u4eea\u8868\u677f\u65f6\uff0c\u4f60\u53ef\u80fd\u5df2\u7ecf\u6ce8\u610f\u5230\u4e86 Grafana \u56fe\u6807\uff0c\u8fd9\u91cc\u6211\u4eec\u4ee5 emoji \u5fae\u670d\u52a1\u4e3a\u4f8b\u5bf9 Grafana \u56fe\u8868\u8fdb\u884c\u8bf4\u660e \u5728 Linkerd \u4eea\u8868\u677f\u7684 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u5355\u51fb emoji \u884c\u6700\u53f3\u4fa7\u5217\u4e2d\u7684 Grafana \u56fe\u6807\uff0c\u4f1a\u6253\u5f00 Grafana \u4eea\u8868\u677f\u4ee5\u663e\u793a emoji \u5fae\u670d\u52a1\u7684\u76f8\u5173\u56fe\u8868\uff0c\u8fd9\u4e9b\u9875\u9762\u4e0a\u7684\u56fe\u8868\u663e\u793a\u4e86 Linkerd \u4eea\u8868\u677f\u4e2d\u663e\u793a\u7684\u6307\u6807\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0c\u8fd9\u91cc\u6211\u4eec\u770b\u5230\u7684\u5c31\u662f emoji \u670d\u52a1\u968f\u7740\u65f6\u95f4\u63a8\u79fb\u7684\u670d\u52a1\u6027\u80fd\u53d8\u5316\u3002 Grafana \u4eea\u8868\u677f\u4e0a\u7684\u56fe\u8868\u5305\u62ec\u6211\u4eec\u7684\u6807\u51c6\u9ec4\u91d1\u6307\u6807\u96c6\uff1a Success rate Request rate Latencies \u968f\u65f6\u95f4\u67e5\u770b\u9ec4\u91d1\u6307\u6807\u56fe\u8868\u7684\u80fd\u529b\u662f\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u7684\u975e\u5e38\u5f3a\u5927\u7684\u5de5\u5177\u3002\u4ee5\u65f6\u95f4\u5e8f\u5217\u7684\u5f62\u5f0f\u67e5\u770b\u8fd9\u4e9b\u6307\u6807\u53ef\u4ee5\u8ba9\u4f60\u4e86\u89e3\uff0c\u4f8b\u5982\uff0c\u5f53\u6d41\u91cf\u8d1f\u8f7d\u589e\u52a0\u65f6\u670d\u52a1\u7684\u6267\u884c\u60c5\u51b5\uff0c\u6216\u8005\u5728\u8fdb\u884c\u66f4\u65b0\u4ee5\u6dfb\u52a0\u529f\u80fd\u6216\u4fee\u590d\u9519\u8bef\u65f6\uff0c\u670d\u52a1\u7684\u4e00\u4e2a\u7248\u672c\u4e0e\u53e6\u4e00\u4e2a\u7248\u672c\u7684\u6bd4\u8f83\u60c5\u51b5\u3002 Grafana \u4eea\u8868\u677f\u7684\u4f18\u70b9\u5728\u4e8e\u4f60\u65e0\u9700\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u5373\u53ef\u521b\u5efa\u5b83\u4eec\uff0cLinkerd \u4f7f\u7528\u52a8\u6001\u6a21\u677f\u4e3a\u6bcf\u4e2a\u6ce8\u5165 Linkerd \u4ee3\u7406\u548c\u90e8\u5206\u670d\u52a1\u7f51\u683c\u7684 Kubernetes \u8d44\u6e90\u751f\u6210\u4eea\u8868\u677f\u548c\u56fe\u8868\u3002\u6211\u4eec\u53ef\u4ee5\u5728 Grafana \u4eea\u8868\u677f\u7684\u5de6\u4e0a\u89d2\uff0c\u5355\u51fb Linkerd Deployment \u94fe\u63a5\u4ee5\u6253\u5f00\u53ef\u7528\u4eea\u8868\u677f\u5217\u8868\u3002 \u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb Linkerd Pod \u4eea\u8868\u76d8\uff0c\u67e5\u770b\u4e0e emoji \u670d\u52a1\u76f8\u5173\u7684\u4e00\u4e2a Pod \u7684\u56fe\u8868\uff0c\u4eea\u8868\u677f\u4e2d\u663e\u793a\u4e86\u5355\u4e2a Pod \u7684\u76f8\u540c\u7684\u9ec4\u91d1\u6307\u6807\uff0c\u8fd9\u4e0e Deployment \u4eea\u8868\u677f\u4e0d\u540c\uff0c\u56e0\u4e3a Deployment \u4eea\u8868\u677f\u663e\u793a\u4e86\u4e0e Deployment \u76f8\u5173\u7684\u6240\u6709 Pod \u7684\u6c47\u603b\u6307\u6807\u3002 Linkerd CLI \u547d\u4ee4\u67e5\u770b\u6307\u6807 Linkerd \u4eea\u8868\u677f\u529f\u80fd\u5f88\u5f3a\u5927\uff0c\u56e0\u4e3a\u5b83\u5728\u57fa\u4e8e\u6d4f\u89c8\u5668\u7684\u754c\u9762\u4e2d\u663e\u793a\u4e86\u5927\u91cf\u6307\u6807\uff0c\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528\u6d4f\u89c8\u5668\u7684\u8bdd\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Linkerd CLI \u547d\u4ee4\u884c\u5de5\u5177\uff0cCLI \u5728\u7ec8\u7aef\u4e2d\u63d0\u4f9b\u4e86\u4eea\u8868\u677f\u76f8\u540c\u7684\u529f\u80fd\u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u663e\u793a emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u4ece Web \u670d\u52a1\u901a\u8fc7 /emojivoto.v1.VotingService/VoteDoughnut \u8def\u5f84\u5230\u6295\u7968\u670d\u52a1\u7684\u6240\u6709\u6d41\u91cf \uff1a $ linkerd viz tap deployment/web --namespace emojivoto --to deployment/voting --path /emojivoto.v1.VotingService/VoteDoughnut req id=3:0 proxy=out src=10.244.2.71:41226 dst=10.244.1.95:8080 tls=true :method=POST :authority=voting-svc.emojivoto:8080 :path=/emojivoto.v1.VotingService/VoteDoughnut rsp id=3:0 proxy=out src=10.244.2.71:41226 dst=10.244.1.95:8080 tls=true :status=200 latency=1128\u00b5s end id=3:0 proxy=out src=10.244.2.71:41226 dst=10.244.1.95:8080 tls=true grpc-status=Unknown duration=183\u00b5s response-length=0B \u6b64\u5916\u6211\u4eec\u8fd8\u901a\u8fc7\u4f7f\u7528 -o json \u6807\u5fd7\u6307\u5b9a\u8f93\u51fa\u6570\u636e\u4e3a JSON \u683c\u5f0f\uff0c\u4ee5\u83b7\u53d6\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz tap deployment/web --namespace emojivoto --to deployment/voting --path /emojivoto.v1.VotingService/VoteDoughnut -o json { \"source\": { \"ip\": \"10.244.1.108\", \"port\": 59370, \"metadata\": { \"control_plane_ns\": \"linkerd\", \"deployment\": \"web\", \"namespace\": \"emojivoto\", \"pod\": \"web-5f86686c4d-58p7k\", \"pod_template_hash\": \"5f86686c4d\", \"serviceaccount\": \"web\", \"tls\": \"loopback\" } }, \"destination\": { \"ip\": \"10.244.1.95\", \"port\": 8080, \"metadata\": { \"control_plane_ns\": \"linkerd\", \"deployment\": \"voting\", \"namespace\": \"emojivoto\", \"pod\": \"voting-ff4c54b8d-jjpkm\", \"pod_template_hash\": \"ff4c54b8d\", \"server_id\": \"voting.emojivoto.serviceaccount.identity.linkerd.cluster.local\", \"service\": \"voting-svc\", \"serviceaccount\": \"voting\", \"tls\": \"true\" } }, \"routeMeta\": null, \"proxyDirection\": \"OUTBOUND\", \"responseInitEvent\": { \"id\": { \"base\": 6, \"stream\": 6 }, \"sinceRequestInit\": { \"nanos\": 686968 }, \"httpStatus\": 200, \"headers\": [ { \"name\": \":status\", \"valueStr\": \"200\" }, { \"name\": \"content-type\", \"valueStr\": \"application/grpc\" }, { \"name\": \"grpc-status\", \"valueStr\": \"2\" }, { \"name\": \"grpc-message\", \"valueStr\": \"ERROR\" }, { \"name\": \"date\", \"valueStr\": \"Thu, 25 Aug 2022 08:52:05 GMT\" } ] } } \u53ef\u4ee5\u770b\u5230 JSON \u8f93\u51fa\u7684\u4fe1\u606f\u8981\u8be6\u7ec6\u5f97\u591a\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u4f1a\u6253\u5370\u6709\u5173\u7684\u591a\u884c\u4fe1\u606f\uff0c\u5305\u62ec\uff1a HTTP \u65b9\u6cd5 \u6d41\u91cf\u7684\u65b9\u5411 HTTP Header \u8ba9\u6211\u4eec\u518d\u8fd0\u884c\u4e00\u4e2a \u66f4\u7c97\u7c92\u5ea6\u7684 Tap \u67e5\u8be2 \uff0c\u5c31\u50cf\u6211\u4eec\u5728\u4eea\u8868\u677f\u4e2d\u8fd0\u884c\u7684\u67e5\u8be2\u4e00\u6837\u3002\u6bd4\u5982\u83b7\u53d6 Web \u670d\u52a1\u7684\u6240\u6709\u6d41\u91cf\uff1a $ linkerd viz tap deploy/web -n emojivoto req id=7:13 proxy=out src=10.244.1.108:33416 dst=10.244.1.88:8080 tls=true :method=POST :authority=emoji-svc.emojivoto:8080 :path=/emojivoto.v1.EmojiService/FindByShortcode rsp id=7:13 proxy=out src=10.244.1.108:33416 dst=10.244.1.88:8080 tls=true :status=200 latency=708\u00b5s end id=7:13 proxy=out src=10.244.1.108:33416 dst=10.244.1.88:8080 tls=true grpc-status=OK duration=35\u00b5s response-length=20B req id=7:14 proxy=out src=10.244.1.108:59370 dst=10.244.1.95:8080 tls=true :method=POST :authority=voting-svc.emojivoto:8080 :path=/emojivoto.v1.VotingService/VoteMan rsp id=7:14 proxy=out src=10.244.1.108:59370 dst=10.244.1.95:8080 tls=true :status=200 latency=809\u00b5s end id=7:14 proxy=out src=10.244.1.108:59370 dst=10.244.1.95:8080 tls=true grpc-status=OK duration=65\u00b5s response-length=5B # ...... \u4e0a\u9762\u7684\u547d\u4ee4\u6211\u4eec\u5220\u9664\u4e86 --to \u548c --path \u8fd9\u4e9b\u53c2\u6570\uff0c\u7c92\u5ea6\u66f4\u7c97\u4e86\uff0c\u6574\u4e2a\u8f93\u51fa\u5c06\u663e\u793a\u6240\u6709\u8fdb\u51fa Web \u670d\u52a1\u7684\u6d41\u91cf\uff0c\u5305\u62ec web \u548c emoji \u670d\u52a1\u4ee5\u53ca web \u548c voting \u670d\u52a1\u4e4b\u95f4\u7684\u6d41\u91cf \u3002 \u6211\u4eec\u53ef\u4ee5\u6839\u636e\u6bcf\u884c\u8f93\u51fa\u4e2d\u7684 src \u548c dst \u5b57\u6bb5\u67e5\u770b\u6d41\u91cf\u7684\u65b9\u5411\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528 -o json \u6807\u5fd7\u518d\u6b21\u8fd0\u884c\u67e5\u8be2\u4ee5\u67e5\u770b JSON \u683c\u5f0f\u7684\u8f93\u51fa\uff0c\u5e76\u67e5\u770b\u662f\u5426\u53ef\u4ee5\u53d1\u73b0\u7ed9\u5b9a\u8bf7\u6c42\u7684\u6d41\u91cf\u65b9\u5411\u3002 \u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u5728\u7ec8\u7aef\u4e2d \u4f7f\u7528 tap \u547d\u4ee4\u5b9e\u65f6\u663e\u793a\u6d41\u91cf \uff0c \u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u53e6\u5916\u4e00\u4e2a linkerd viz top \u547d\u4ee4\uff0c\u8be5\u547d\u4ee4\u548c tap \u547d\u4ee4\u63d0\u4f9b\u76f8\u540c\u7684\u4fe1\u606f\uff0c\u4f46\u683c\u5f0f\u4e0e\u57fa\u4e8e Unix \u7684 top \u547d\u4ee4\u76f8\u540c \u3002 \u6362\u53e5\u8bdd\u8bf4\uff0c linkerd viz top \u663e\u793a\u4e86\u6309\u6700\u53d7\u6b22\u8fce\u7684\u8def\u5f84\u6392\u5e8f\u7684\u6d41\u91cf\u8def\u7ebf \uff0c\u6211\u4eec\u6765\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u8fdb\u884c\u67e5\u770b\uff1a \u540c\u6837\u73b0\u5728\u6211\u4eec\u60f3\u5728\u7ec8\u7aef\u4e2d\u67e5\u770b\u4eea\u8868\u677f\u4e2d \u770b\u5230\u7684\u5ef6\u8fdf\u3001\u6210\u529f/\u9519\u8bef\u7387\u548c\u6bcf\u79d2\u8bf7\u6c42\u6570\u6307\u6807 \uff0c\u53c8\u5e94\u8be5\u600e\u4e48\u64cd\u4f5c\u5462\uff1f \u540c\u6837 Linkerd CLI \u63d0\u4f9b\u4e86\u4e00\u4e2a stat \u547d\u4ee4\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u6765\u6267\u884c\u8be5\u64cd\u4f5c\u3002\u8ba9\u6211\u4eec\u901a\u8fc7\u83b7\u53d6 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u6240\u6709\u670d\u52a1\u7684\u6307\u6807\u6765\u5c1d\u8bd5\u4e00\u4e0b\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz stat deploy -n emojivoto NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji 1/1 100.00% 2.3rps 1ms 1ms 1ms 4 vote-bot 1/1 100.00% 0.3rps 1ms 1ms 1ms 1 voting 1/1 89.74% 1.3rps 1ms 1ms 1ms 4 web 2/2 93.51% 2.6rps 1ms 7ms 9ms 6 linkerd viz stat \u547d\u4ee4\u53ef\u4ee5\u83b7\u53d6\u5230\u5e94\u7528\u670d\u52a1\u6027\u80fd\u7684\u6700\u65b0\u6307\u6807\u6570\u636e\uff0c\u5982\u679c\u4f60\u60f3\u8981\u83b7\u53d6\u66f4\u591a\u6570\u636e\uff0c\u53ef\u4ee5\u6dfb\u52a0 -o wide \u6807\u5fd7\u6765\u83b7\u53d6\u8fd9\u4e9b TCP \u7ea7\u522b\u7684\u8be6\u7ec6\u4fe1\u606f \u3002 \u4efb\u4f55\u65f6\u5019\u60a8\u60f3\u8981\u83b7\u5f97\u5e94\u7528\u7a0b\u5e8f\u4e2d\u670d\u52a1\u6027\u80fd\u7684\u6700\u65b0\u5feb\u7167\uff0c \u60a8\u90fd\u53ef\u4ee5\u4f7f\u7528 linkerd viz stat \u6765\u83b7\u53d6\u8fd9\u4e9b\u6307\u6807\u3002\u5982\u679c\u60a8\u60f3\u66f4\u6df1\u5165\u5730\u83b7\u53d6\u5199\u5165\u548c\u8bfb\u53d6\u7684\u5b57\u8282\u6570\uff0c\u53ef\u4ee5\u6dfb\u52a0 -o Wide \u6807\u5fd7\u6765\u83b7\u53d6\u8fd9\u4e9b TCP \u7ea7\u522b\u7684\u8be6\u7ec6\u4fe1\u606f \u3002\u65e0\u8bba\u662f\u5426\u4f7f\u7528 -o wide \u6807\u5fd7\uff0c\u90fd\u5c06\u59cb\u7ec8\u663e\u793a TCP \u8fde\u63a5\u3002 $ linkerd viz stat deploy -n emojivoto -o wide NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN READ_BYTES/SEC WRITE_BYTES/SEC emoji 1/1 100.00% 2.3rps 1ms 1ms 1ms 4 229.0B/s 2680.8B/s vote-bot 1/1 100.00% 0.3rps 1ms 3ms 3ms 1 24.3B/s 585.0B/s voting 1/1 89.74% 1.3rps 1ms 1ms 1ms 4 121.4B/s 481.0B/s web 2/2 92.95% 2.6rps 1ms 4ms 4ms 6 205.0B/s 5949.4B/s \u540c\u6837 stat \u547d\u4ee4\u4e5f\u53ef\u4ee5\u901a\u8fc7 --to \u53c2\u6570\u6765\u7f29\u5c0f\u67e5\u8be2\u8303\u56f4\uff0c\u6bd4\u5982\u6211\u4eec\u60f3\u8981\u67e5\u8be2\u4ece web \u670d\u52a1\u5230 voting \u670d\u52a1\u7684\u6d41\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a $ linkerd viz stat -n emojivoto deploy/web --to deploy/voting NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN web 2/2 86.67% 1.0rps 1ms 4ms 4ms 2 \u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u7684\u6570\u636e\u548c\u524d\u9762\u4e00\u6837\uff0c\u53ea\u662f\u53ea\u6709\u4e00\u884c\u6570\u636e\u8f93\u51fa\uff0c\u5176\u4e2d\u6700\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u6210\u529f\u7387\u8fd9\u4e00\u5217\u4f4e\u4e8e 100% \u4e86\u3002\u4ece\u8fd9\u4e2a\u8f93\u51fa\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u63a8\u65ad\u51fa\uff0c\u5f53\u6211\u4eec\u67e5\u770b emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u670d\u52a1\u65f6\uff0cweb \u670d\u52a1\u7684\u6210\u529f\u7387\u662f\u6765\u81ea voting \u548c emoji \u670d\u52a1\u54cd\u5e94\u7684\u603b\u548c\u3002 \u4e3a\u4e86\u9a8c\u8bc1\u8fd9\u4e2a\u5047\u8bbe\uff0c\u8ba9\u6211\u4eec\u518d\u8fd0\u884c\u4e00 \u4e2a\u67e5\u8be2\uff0c\u4ee5\u4ec5\u67e5\u770b\u4ece web \u670d\u52a1\u5230\u547d\u540d\u7a7a\u95f4\u4e2d\u6240\u6709\u5176\u4ed6\u670d\u52a1\u7684\u6d41\u91cf\u3002 $ linkerd viz stat -n emojivoto deploy --from deploy/web NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji 1/1 100.00% 1.9rps 1ms 1ms 2ms 2 voting 1/1 83.05% 1.0rps 1ms 1ms 2ms 2 \u5728\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u5b9e\u9645\u4e0a\uff0cvoting \u670d\u52a1\u5b58\u5728\u9519\u8bef\uff0c\u800c emoji \u670d\u52a1\u5219\u6ca1\u6709\u3002 stat \u547d\u4ee4\u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u5177\u6709\u8bb8\u591a\u914d\u7f6e\u9009\u9879\u3002\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c linkerd viz stat -h \u4ee5\u67e5\u770b\u53ef\u4ee5\u8fd0\u884c stat \u7684\u6240\u6709\u53ef\u7528\u65b9\u5f0f\u3002 \u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86\u51e0\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u6765\u67e5\u770b\u88ab Linkerd \u7f51\u683c\u5316\u7684\u5e94\u7528\u7684\u9ec4\u91d1\u6307\u6807\u6570\u636e\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u83b7\u53d6\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\uff0c\u901a\u8fc7\u4e3a Kubernetes \u670d\u52a1\u521b\u5efa ServiceProfile \u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u670d\u52a1\u53ef\u7528\u7684\u8def\u7531\u5e76\u4e3a\u6bcf\u4e2a\u8def\u7531\u6536\u96c6\u5355\u72ec\u7684\u6307\u6807\u3002 \u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u53ea\u80fd\u770b\u5230 default \u8def\u7531\u4e0a\u5bf9\u670d\u52a1\u7684\u6240\u6709\u8bf7\u6c42\u7684\u6307\u6807\u3002\u4e3a emojivoto \u670d\u52a1\u914d\u7f6e ServiceProfiles \u540e\uff0c\u6211\u4eec\u5c06\u80fd\u591f\u770b\u5230\u6bcf\u6761\u8def\u7531\u7684\u6307\u6807\uff01","title":"2 \u5728 Linkerd \u4e2d\u83b7\u53d6\u5e94\u7528\u7684\u9ec4\u91d1\u6307\u6807"},{"location":"chap11/2linkered_index/#2-linkerd","text":"kubectl get ns linkerd-viz -o json > linkerd-viz.json kubectl proxy curl -k -H \"Content-Type: application/json\" -X PUT --data-binary @linkerd-viz.json http://127.0.0.1:8001/api/v1/namespaces/linkerd-viz/finalize \u6211\u4eec\u5c06\u8be6\u7ec6\u4e86\u89e3\u8fd9\u4e9b\u6307\u6807\uff0c\u5e76\u4f7f\u7528 Emojivoto \u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\u4e86\u89e3\u5b83\u4eec\u7684\u542b\u4e49\u3002 \u6211\u4eec\u5148\u7b80\u5355\u4e86\u89e3\u4e0b\u670d\u52a1\u5065\u5eb7\u9ec4\u91d1\u6307\u6807\u7684\u7ecf\u5178\u5b9a\u4e49\uff1a Latency\uff08\u5ef6\u8fdf\uff09 Error rate\uff08\u9519\u8bef\u7387\uff09 Traffic volume\uff08\u6d41\u91cf\uff09 Saturation\uff08\u9971\u548c\u5ea6\uff09 Linkerd \u7684\u4ef7\u503c\u4e0d\u4ec5\u4ec5\u5728\u4e8e\u5b83\u53ef\u4ee5\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\uff0c\u6bd5\u7adf\uff0c\u6211\u4eec\u53ef\u4ee5\u975e\u5e38\u7b80\u5355\u5730\u76f4\u63a5\u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u3002\u76f8\u53cd\uff0cLinkerd \u7684\u4ef7\u503c\u5728\u4e8e\u5b83\u53ef\u4ee5\u5728\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4ee5\u7edf\u4e00\u7684\u65b9\u5f0f\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\uff0c\u5e76\u4e14\u4e0d\u9700\u8981\u66f4\u6539\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u65e0\u8bba\u662f\u8c01\u7f16\u5199\u7684\uff0c\u5b83\u4f7f\u7528\u4ec0\u4e48\u6846\u67b6\uff0c\u5b83\u662f\u7528\u4ec0\u4e48\u8bed\u8a00\u7f16\u5199\u7684\uff0c\u4ee5\u53ca\u5b83\u505a\u4ec0\u4e48\uff0cLinkerd \u90fd\u53ef\u4ee5\u4e3a\u4f60\u7684\u670d\u52a1\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\u3002","title":"2 \u5728 Linkerd \u4e2d\u83b7\u53d6\u5e94\u7528\u7684\u9ec4\u91d1\u6307\u6807"},{"location":"chap11/2linkered_index/#latency","text":"\u5ef6\u8fdf\u662f\u54cd\u5e94\u8bf7\u6c42\u6240\u9700\u7684\u65f6\u95f4\uff0c\u5bf9\u4e8e Linkerd\uff0c\u662f\u901a\u8fc7 Linkerd \u4ee3\u7406\u5411\u5e94\u7528\u7a0b\u5e8f\u53d1\u9001\u8bf7\u6c42\u548c\u63a5\u6536\u54cd\u5e94\u4e4b\u95f4\u7ecf\u8fc7\u7684\u65f6\u95f4\u6765\u8fdb\u884c\u8861\u91cf\u7684\uff0c\u56e0\u4e3a\u5b83\u5728\u8bf7\u6c42\u4e4b\u95f4\u53ef\u80fd\u4f1a\u6709\u5f88\u5927\u5dee\u5f02\uff0c\u6240\u4ee5\u6307\u5b9a\u65f6\u95f4\u6bb5\u7684\u5ef6\u8fdf\u901a\u5e38\u4f5c\u4e3a\u7edf\u8ba1\u5206\u5e03\u6765\u8861\u91cf\uff0c\u5e76\u62a5\u544a\u4e3a\u6b64\u5206\u5e03\u7684\u767e\u5206\u4f4d\u6570\u3002 Linkerd \u80fd\u591f\u62a5\u544a\u5e38\u7528\u7684\u5ef6\u8fdf\u6307\u6807\u4f8b\u5982 p50\u3001p95\u3001p99 \u548c p999\uff0c\u5bf9\u5e94\u4e8e 50\u300195\u300199 \u548c 99.9 \u7684\u767e\u5206\u4f4d\u6570\u3002\u8bf7\u6c42\u7684\u5ef6\u8fdf\u5206\u5e03\uff0c\u8fd9\u4e9b\u88ab\u79f0\u4e3a\u201c\u5c3e\u90e8\u5ef6\u8fdf\u201d\uff0c\u901a\u5e38\u662f\u62a5\u544a\u5927\u89c4\u6a21\u7cfb\u7edf\u884c\u4e3a\u7684\u91cd\u8981\u6307\u6807\u3002","title":"Latency"},{"location":"chap11/2linkered_index/#error-rate","text":"\u9519\u8bef\u7387\u662f\u88ab\u89c6\u4e3a\u9519\u8bef\u54cd\u5e94\u7684\u767e\u5206\u6bd4\uff0c\u5bf9\u4e8e Linkerd\uff0c\u662f\u901a\u8fc7 HTTP \u72b6\u6001\u7801\u6765\u8861\u91cf\u7684\uff1a 2xx \u548c 4xx \u54cd\u5e94\u88ab\u8ba4\u4e3a\u662f\u6210\u529f\u7684\uff0c5xx \u54cd\u5e94\u88ab\u8ba4\u4e3a\u662f\u5931\u8d25\u7684\uff0c\u5f53\u7136\u53cd\u8fc7\u6765\u6211\u4eec\u4e5f\u53ef\u4ee5\u8bf4 Linkerd \u62a5\u544a\u7684\u662f\u6210\u529f\u7387\u800c\u4e0d\u662f\u9519\u8bef\u7387 \u3002 \u9700\u8981\u6ce8\u610f\u867d\u7136 4xx HTTP \u54cd\u5e94\u7801\u5bf9\u5e94\u4e8e\u5404\u79cd\u5f62\u5f0f\u7684\u201c\u672a\u627e\u5230\u60a8\u8bf7\u6c42\u7684\u8d44\u6e90\u201d\uff0c\u4f46\u8fd9\u4e9b\u662f\u670d\u52a1\u5668\u65b9\u9762\u7684\u6b63\u786e\u54cd\u5e94\uff0c\u800c\u4e0d\u662f\u9519\u8bef\u54cd\u5e94\u3002 \u56e0\u6b64\uff0cLinkerd \u8ba4\u4e3a\u8fd9\u4e9b\u8bf7\u6c42\u662f\u6210\u529f\u7684\uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u6309\u7167\u5b83\u7684\u8981\u6c42\u505a\u4e86\u3002","title":"Error rate"},{"location":"chap11/2linkered_index/#traffic-volume","text":"\u6d41\u91cf\u662f\u5bf9\u7cfb\u7edf\u7684\u9700\u6c42\u91cf\u5ea6\uff0c\u5728 Linkerd \u7684\u4e0a\u4e0b\u6587\u4e2d\uff0c\u8fd9\u88ab\u6d4b\u91cf\u4e3a\u8bf7\u6c42\u7387\uff0c\u4f8b\u5982\u6bcf\u79d2\u8bf7\u6c42\u6570 (RPS)\u3002Linkerd \u7b80\u5355\u5730\u901a\u8fc7\u8ba1\u7b97\u5b83\u4ee3\u7406\u5230\u5e94\u7528\u7a0b\u5e8f\u7684\u8bf7\u6c42\u6765\u8ba1\u7b97\u8fd9\u4e00\u70b9\u3002 \u53e6\u5916\u4e5f\u9700\u8981\u6ce8\u610f\u7531\u4e8e Linkerd \u53ef\u4ee5\u81ea\u52a8\u91cd\u8bd5\u8bf7\u6c42\uff0c\u56e0\u6b64\u5b83\u63d0\u4f9b\u4e86\u4e24\u79cd\u6d41\u91cf\u5ea6\u91cf\uff1a \u5b9e\u9645\uff08\u5bf9\u5e94\u8bf7\u6c42\uff0c\u5305\u62ec\u91cd\u8bd5\uff09\u548c\u6709\u6548\uff08\u5bf9\u5e94\u4e0d\u91cd\u8bd5\u7684\u8bf7\u6c42\uff09 \u3002 \u5982\u679c\u5ba2\u6237\u7aef\u5411\u4e2d\u95f4\u6709 Linkerd \u7684\u670d\u52a1\u5668\u53d1\u51fa\u8bf7\u6c42\uff0c\u5219\u6709\u6548\u8ba1\u6570\u5c06\u662f\u5ba2\u6237\u7aef\u53d1\u51fa\u7684\u8bf7\u6c42\u6570\uff1b\u5b9e\u9645\u8ba1\u6570\u5c06\u662f\u670d\u52a1\u5668\u6536\u5230\u7684\u8bf7\u6c42\u6570\u3002","title":"Traffic volume"},{"location":"chap11/2linkered_index/#saturation","text":"\u9971\u548c\u5ea6\u662f\u5bf9\u670d\u52a1\u53ef\u7528\u7684\u603b\u8d44\u6e90\u6d88\u8017\u7684\u5ea6\u91cf\uff0c\u4f8b\u5982 CPU\u3001\u5185\u5b58\u3002\u4e0e\u5176\u4ed6\u670d\u52a1\u7f51\u683c\u4e00\u6837\uff0cLinkerd \u6ca1\u6709\u76f4\u63a5\u7684\u673a\u5236\u6765\u8861\u91cf\u9971\u548c\u5ea6\uff0c\u4f46\u662f\uff0c\u5ef6\u8fdf\u901a\u5e38\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u8fd1\u4f3c\u503c\u3002 \u8c37\u6b4c SRE \u4e66\u7c4d\u8bf4\uff1a \u5ef6\u8fdf\u589e\u52a0\u901a\u5e38\u662f\u9971\u548c\u7684\u4e3b\u8981\u6307\u6807\uff0c\u5728\u67d0\u4e2a\u5c0f\u7a97\u53e3\uff08\u4f8b\u5982\u4e00\u5206\u949f\uff09\u5185\u6d4b\u91cf\u4f60\u7684\u7b2c 99 \u4e2a\u767e\u5206\u4f4d\u54cd\u5e94\u65f6\u95f4\u53ef\u4ee5\u7ed9\u51fa\u975e\u5e38\u65e9\u671f\u7684\u9971\u548c\u4fe1\u53f7\u3002 \u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e3b\u8981\u4f7f\u7528\u53e6\u5916\u4e09\u4e2a\u9ec4\u91d1\u6307\u6807\uff1a\u6210\u529f\u7387\u3001\u8bf7\u6c42\u7387\u548c\u5ef6\u8fdf\u3002 \u6700\u540e\u4e00\u70b9\u662f\uff0c\u867d\u7136 Linkerd \u53ef\u4ee5\u4ee3\u7406\u4efb\u4f55 TCP \u6d41\u91cf\uff0c\u4f46\u8fd9\u4e9b\u9ec4\u91d1\u6307\u6807\u4ec5\u9002\u7528\u4e8e\u4f7f\u7528 HTTP \u6216 gRPC \u7684\u670d\u52a1\u3002 \u8fd9\u662f\u56e0\u4e3a\u8fd9\u4e9b\u6307\u6807\u9700\u8981\u7b2c 7 \u5c42\u6216\u534f\u8bae\u7ea7\u522b\u7684\u7406\u89e3\u624d\u80fd\u8ba1\u7b97\u3002\u4e00\u4e2a HTTP \u8bf7\u6c42\u5177\u6709\u6210\u529f\u548c\u4e0d\u6210\u529f\u8bf7\u6c42\u7684\u6982\u5ff5\uff0c\u4efb\u610f\u7684 TCP \u5b57\u8282\u6d41\u4e0d\u4f1a\u3002","title":"Saturation"},{"location":"chap11/2linkered_index/#linkerd-dashboard","text":"\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u8fd9\u4e9b\u6307\u6807\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u770b\u770b\u524d\u9762\u90e8\u7f72\u7684 Emojivoto \u5e94\u7528\u3002 $ kubectl get pods -n emojivoto NAME READY STATUS RESTARTS AGE emoji-696d9d8f95-5vn9w 2/2 Running 2 (5h11m ago) 41h vote-bot-6d7677bb68-jvxsg 2/2 Running 2 (5h11m ago) 41h voting-ff4c54b8d-jjpkm 2/2 Running 2 (5h11m ago) 41h web-5f86686c4d-58p7k 2/2 Running 2 (5h11m ago) 41h Emojivoto \u5e94\u7528\u662f\u4e00\u4e2a gRPC \u670d\u52a1\uff0c\u4e00\u5171\u5305\u542b\u4e09\u4e2a\u5fae\u670d\u52a1\uff1a web\uff1a\u7528\u6237\u4e0e\u4e4b\u4ea4\u4e92\u7684\u524d\u7aef\u670d\u52a1 emoji\uff1a\u63d0\u4f9b\u8868\u60c5\u5217\u8868\u7684 API \u670d\u52a1 voting\uff1a\u63d0\u4f9b\u4e3a\u8868\u60c5\u6295\u7968\u7684 API \u670d\u52a1 \u6211\u4eec\u5df2\u7ecf\u5c06\u8be5\u5e94\u7528\u5f15\u5165\u5230\u7f51\u683c\u4e2d\u6765\u4e86\uff0c\u80fd\u591f\u5728 Linkerd \u4eea\u8868\u677f\u4e2d\u67e5\u770b Emojivoto \u5e94\u7528\u7684\u6307\u6807\u4e86\uff0c\u5f53\u6211\u4eec\u6253\u5f00 Viz \u7684\u4eea\u8868\u677f\u7684\u65f6\u5019\uff0c\u9ed8\u8ba4\u4f1a\u663e\u793a\u96c6\u7fa4\u7684\u6240\u6709\u547d\u540d\u7a7a\u95f4\u5217\u8868\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u975e\u5e38\u5927\u7684\u533a\u522b\u662f\u547d\u540d\u7a7a\u95f4\u5217\u8868\u4e2d\u7684 emojivoto \u9879\u76ee\u73b0\u5728\u5728 Meshed \u5217\u4e0b\u663e\u793a\u4e3a 4/4\u3002 \u5355\u51fb emojivoto \u94fe\u63a5\u53ef\u67e5\u770b\u547d\u540d\u7a7a\u95f4\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5305\u62ec\u201c\u7ae0\u9c7c\u201d\u56fe\uff0c\u663e\u793a\u670d\u52a1\u5982\u4f55\u901a\u8fc7\u7f51\u7edc\u8fde\u63a5\u76f8\u4e92\u5173\u8054\u7684\u3002\u8bf7\u8bb0\u4f4f\u8fd9\u5f20\u56fe\u7247\uff0c\u56e0\u4e3a\u6211\u4eec\u5c06\u4f7f\u7528 CLI \u5de5\u5177\u67e5\u770b\u76f8\u540c\u7684\u4fe1\u606f\u3002 \u6b64\u5916\u8fd8\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4e0a\u9762\u8ba8\u8bba\u8fc7\u7684\u9ec4\u91d1\u6307\u6807\uff1ap50\u3001p95 \u548c p99 \u5ef6\u8fdf\u3001\u670d\u52a1\u7684\u6210\u529f/\u9519\u8bef\u7387\u4ee5\u53ca\u8bf7\u6c42\u91cf\uff0c \u5373\u6bcf\u79d2\u8bf7\u6c42\u6570(RPS)\u3002\u4ece\u6210\u529f\u7387\u4e00\u5217\u53ef\u4ee5\u770b\u51fa\u5176\u4e2d\u4e00\u9879\u670d\u52a1\u6709\u4e00\u4e9b\u9519\u8bef \u3002 \u8be5 Deployment \u7ea7\u522b\u4fe1\u606f\u662f\u5904\u7406\u5e94\u7528\u7a0b\u5e8f\u8bf7\u6c42\u7684\u6240\u6709 Pod \u7684\u6307\u6807\u7684\u805a\u5408\uff0c\u6211\u4eec\u5411\u4e0b\u6eda\u52a8\u9875\u9762\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a Pod \u5bf9\u5e94\u7684\u6307\u6807\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0 web \u670d\u52a1\u7684\u526f\u672c\u6570\u6765\u8fdb\u884c\u9a8c\u8bc1\u3002 \u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5c06 web \u670d\u52a1\u589e\u52a0\u5230\u4e24\u4e2a\u526f\u672c\uff1a $ kubectl scale deploy/web -n emojivoto --replicas=2 \u6267\u884c\u6b64\u547d\u4ee4\u540e\uff0c\u4eea\u8868\u677f\u5c06\u81ea\u884c\u66f4\u65b0\uff0cWeb \u5e94\u7528\u5c06\u5728 Meshed \u5217\u4e0b\u663e\u793a\u4e3a 2/2\uff0c\u6b64\u5916\uff0c\u4f60\u5c06\u5728 Pod \u90e8\u5206\u4e0b\u770b\u5230\u53e6\u4e00\u4e2a Web pod\u3002 \u901a\u8fc7\u89c2\u5bdf Deployments \u548c Pods \u90e8\u5206\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u770b\u5230 Deployments \u4e2d\u7684\u6307\u6807\u6570\u636e\u7684\u786e\u5c31\u662f Pods \u7684\u6307\u6807\u805a\u5408\u6570\u636e\u3002\u6700\u540e\u6211\u4eec\u518d\u6765\u770b\u770b Linkerd \u63d0\u4f9b\u7684 TCP \u7ea7\u522b\u7684\u6307\u6807\uff0c\u5728 emojivoto \u547d\u540d\u7a7a\u95f4\u7684\u9875\u9762\u5e95\u90e8\uff0c\u4f1a\u663e\u793a TCP \u8fde\u63a5\u6570\u4ee5\u53ca\u6bcf\u4e2a Pod \u8bfb\u53d6\u548c\u5199\u5165\u7684\u5b57\u8282\u6570 TCP \u7684\u6307\u6807\u6bd4 7 \u5c42\u7684\u6307\u6807\u4f1a\u66f4\u5c11\uff0c\u4f8b\u5982\u5728\u4efb\u610f TCP \u5b57\u8282\u6d41\u4e2d\u6ca1\u6709\u8bf7\u6c42\u7684\u6982\u5ff5\u3002\u5c3d\u7ba1\u5982\u6b64\uff0c\u8fd9\u4e9b\u6307\u6807\u5728\u8c03\u8bd5\u5e94\u7528\u7a0b\u5e8f\u7684\u8fde\u63a5\u7ea7\u522b\u95ee\u9898\u65f6\u4ecd\u7136\u5f88\u6709\u7528\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u7ee7\u7eed\u63a2\u7d22\u4eea\u8868\u677f\u5e76\u67e5\u770b\u8ba9\u6211\u4eec\u5b9e\u65f6\u67e5\u770b\u6d41\u91cf\u7684 Tap \u529f\u80fd\u3002 \u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u4f7f\u7528\u4eea\u8868\u677f\u6765\u83b7\u53d6 Emojivoto \u5e94\u7528\u7a0b\u5e8f\u4e2d\u670d\u52a1\u7684\u805a\u5408\u6027\u80fd\u6307\u6807\u4e86\u3002\u73b0\u5728\u8ba9\u6211\u4eec\u4f7f\u7528\u4eea\u8868\u677f\u901a\u8fc7 Linkerd \u63d0\u4f9b\u7684 tap \u529f\u80fd\u5b9e\u65f6\u67e5\u770b\u6d41\u91cf\u3002 \u5728\u4eea\u8868\u677f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 voting \u670d\u52a1\u7684\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u8ba9\u6211\u4eec\u4f7f\u7528 tap \u529f\u80fd\u6765\u67e5\u770b\u5bf9\u670d\u52a1\u7684\u8bf7\u6c42\uff0c\u6765\u5c1d\u8bd5\u5f04\u6e05\u695a\u53d1\u751f\u4e86\u4ec0\u4e48\u3002 \u5355\u51fb emojivoto \u5e94\u7528\u7684 voting \u94fe\u63a5\u53ef\u4ee5\u6df1\u5165\u4e86\u89e3\u8be6\u7ec6\u4fe1\u606f\uff0c\u6211\u4eec\u5c06\u770b\u5230\u7684\u7b2c\u4e00\u4ef6\u4e8b\u662f\u663e\u793a voting \u5fae\u670d\u52a1\u4e0e\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5176\u4ed6\u5fae\u670d\u52a1\u4e4b\u95f4\u5173\u7cfb\u7684\u56fe\u8868\u3002 \u5728\u56fe\u8868\u4e0b\u65b9\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a LIVE CALLS \u7684\u9009\u9879\u5361\uff0c \u5176\u4e2d\u663e\u793a\u4e86\u5bf9 voting \u670d\u52a1\u7684\u5b9e\u65f6\u8c03\u7528\uff01\u6bcf\u6b21\u8c03\u7528\u65f6\uff0c\u8868\u4e2d\u7684\u884c\u90fd\u4f1a\u66f4\u65b0\u6709\u5173\u8bf7\u6c42\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u5305\u62ec\u54cd\u5e94\u7684 HTTP \u72b6\u6001 \u3002 \u5728\u6211\u4eec\u8be6\u7ec6\u4e86\u89e3\u8fd9\u4e9b\u5b9e\u65f6\u8c03\u7528\u4e4b\u524d\uff0c \u6211\u4eec\u53ef\u4ee5\u70b9\u51fb Route Metrics \u9009\u9879\u5361\u6765\u67e5\u770b voting \u670d\u52a1\u7684\u8def\u7531\u8868\u4ee5\u53ca\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\uff0c\u5728\u6211\u4eec\u8fd9\u91cc\u53ea\u6709\u4e00\u4e2a\u540d\u4e3a Default \u7684\u8def\u7531\uff0c\u5b83\u662f\u4e3a\u6bcf\u4e2a\u670d\u52a1\u521b\u5efa\u7684 \u3002 \u73b0\u5728\u6211\u4eec\u77e5\u9053\u4e86\u5982\u4f55\u5728\u4eea\u8868\u677f\u4e2d\u67e5\u627e\u5b9e\u65f6\u8c03\u7528\uff0c\u73b0\u5728\u6211\u4eec\u6765\u5c1d\u8bd5\u4e0b\u770b\u770b\u662f\u5426\u53ef\u4ee5\u627e\u5230\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u7684\u8c03\u7528\u5e76\u4f7f\u7528\u4eea\u8868\u677f\u4e2d\u7684 tap \u529f\u80fd\u3002\u5f53\u6211\u4eec\u770b\u5230\u5bf9\u8def\u5f84 /emojivoto/v1.VotingService/VoteDoughnut \u7684\u8bf7\u6c42\uff0c\u8bf7\u5355\u51fb\u5176\u53f3\u4fa7\u7684\u663e\u5fae\u955c\u56fe\u6807\u8df3\u8f6c\u5230 Tap \u9875\u9762\u3002 \u5176\u5b9e\u901a\u8fc7\u67e5\u770b\u6210\u529f\u7387\u8fd9\u4e00\u5217\u7684\u6570\u636e\u5f88\u5bb9\u6613\u53d1\u73b0\u8be5\u8def\u5f84\u8bf7\u6c42\u6709\u9519\u8bef\u3002 Tap \u9875\u9762\u5305\u542b\u4e00\u4e2a\u591a\u4e2a\u5b57\u6bb5\u7684\u8868\u5355\uff0c\u8fd9\u4e9b\u5b57\u6bb5\u5df2\u6839\u636e\u6211\u4eec\u70b9\u51fb\u7684\u7279\u5b9a\u8bf7\u6c42\u7684\u94fe\u63a5\u9884\u5148\u586b\u5145\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc Path\u3001Namespace\u3001Resource \u7b49\u5b57\u6bb5\u90fd\u5df2\u7ecf\u88ab\u81ea\u52a8\u586b\u5145\u4e0a\u4e86\uff0c\u4e0b\u9762\u8fd8\u6709\u4e00\u4e2a\u8f93\u51fa\u663e\u793a\u6b63\u5728\u8fd0\u884c\u7684\u5f53\u524d Tap \u67e5\u8be2\u3002 \u73b0\u5728\u6211\u4eec\u70b9\u51fb Tap \u9875\u9762\u9876\u90e8\u7684 START \u6309\u94ae\uff0c\u5f00\u59cb\u5bf9\u6295\u7968\u670d\u52a1\u7684 / emojivoto.v1.VotingService/VoteDougNut \u8def\u5f84\u7684\u8bf7\u6c42\uff0c\u51e0\u79d2\u949f\u540e\uff0c\u4e0b\u65b9\u7684\u5217\u8868\u5c06\u5f00\u59cb\u586b\u5145 VoteDougNut \u8def\u5f84\u7684\u4f20\u5165\u8bf7\u6c42\u3002 \u6211\u4eec\u53ef\u4ee5\u5355\u51fb\u5de6\u4fa7\u7684\u7bad\u5934\u6765\u67e5\u770b\u5305\u542b\u8bf7\u6c42\u4fe1\u606f\u7684\u5bf9\u8bdd\u6846\u3002 \u8fd9\u5c31\u662f\u901a\u8fc7 Linkerd \u4eea\u8868\u677f\u4e2d\u4f7f\u7528 Tap \u7684\u65b9\u5f0f\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u66f4\u6539\u8868\u5355\u5b57\u6bb5\u4e2d\u7684\u503c\u5e76\u4f7f\u7528\u4e0d\u540c\u7684\u67e5\u8be2\u6765\u67e5\u770b\u4e0d\u540c\u7684\u8bf7\u6c42\uff0c\u4f8b\u5982\u6211\u4eec\u53ef\u4ee5\u5c06 Path \u5b57\u6bb5\u4e2d\u7684 /emojivoto.v1.VotingService/VoteDoughnut \u503c\u5220\u6389\uff0c\u5e76\u5c06 To Resource \u8bbe\u7f6e\u4e3a Deployment \uff0c\u5f53\u6211\u4eec\u70b9\u51fb\u5f00\u59cb\u6309\u94ae\u540e\uff0c\u6211\u4eec\u5c06\u53ef\u4ee5\u770b\u5230\u4ece Web \u670d\u52a1\u53d1\u9001\u7684\u6240\u6709\u6d41\u91cf\u3002 \u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u5982\u4f55\u4f7f\u7528 Tap \u67e5\u770b\u670d\u52a1\u7684\u6d41\u91cf\u6307\u6807\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u901a\u8fc7\u67e5\u770b Linkerd \u7684 Grafana \u4eea\u8868\u677f\u6765\u4e86\u89e3\u8fd9\u4e9b\u6307\u6807\u662f\u5982\u4f55\u4f7f\u7528\u7684\u3002","title":"Linkerd Dashboard \u4e2d\u67e5\u770b\u6307\u6807"},{"location":"chap11/2linkered_index/#grafana","text":"Linkerd \u7684 Viz \u63d2\u4ef6\u5185\u7f6e\u4e86 Grafana\uff0cLinkerd \u4f7f\u7528 Grafana \u4e3a\u90e8\u7f72\u5230 Kubernetes \u7684\u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u4e86\u989d\u5916\u7684\u53ef\u89c2\u5bdf\u6027\u6570\u636e\u3002 \u5728\u6d4f\u89c8\u4eea\u8868\u677f\u65f6\uff0c\u4f60\u53ef\u80fd\u5df2\u7ecf\u6ce8\u610f\u5230\u4e86 Grafana \u56fe\u6807\uff0c\u8fd9\u91cc\u6211\u4eec\u4ee5 emoji \u5fae\u670d\u52a1\u4e3a\u4f8b\u5bf9 Grafana \u56fe\u8868\u8fdb\u884c\u8bf4\u660e \u5728 Linkerd \u4eea\u8868\u677f\u7684 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u5355\u51fb emoji \u884c\u6700\u53f3\u4fa7\u5217\u4e2d\u7684 Grafana \u56fe\u6807\uff0c\u4f1a\u6253\u5f00 Grafana \u4eea\u8868\u677f\u4ee5\u663e\u793a emoji \u5fae\u670d\u52a1\u7684\u76f8\u5173\u56fe\u8868\uff0c\u8fd9\u4e9b\u9875\u9762\u4e0a\u7684\u56fe\u8868\u663e\u793a\u4e86 Linkerd \u4eea\u8868\u677f\u4e2d\u663e\u793a\u7684\u6307\u6807\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0c\u8fd9\u91cc\u6211\u4eec\u770b\u5230\u7684\u5c31\u662f emoji \u670d\u52a1\u968f\u7740\u65f6\u95f4\u63a8\u79fb\u7684\u670d\u52a1\u6027\u80fd\u53d8\u5316\u3002 Grafana \u4eea\u8868\u677f\u4e0a\u7684\u56fe\u8868\u5305\u62ec\u6211\u4eec\u7684\u6807\u51c6\u9ec4\u91d1\u6307\u6807\u96c6\uff1a Success rate Request rate Latencies \u968f\u65f6\u95f4\u67e5\u770b\u9ec4\u91d1\u6307\u6807\u56fe\u8868\u7684\u80fd\u529b\u662f\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u7684\u975e\u5e38\u5f3a\u5927\u7684\u5de5\u5177\u3002\u4ee5\u65f6\u95f4\u5e8f\u5217\u7684\u5f62\u5f0f\u67e5\u770b\u8fd9\u4e9b\u6307\u6807\u53ef\u4ee5\u8ba9\u4f60\u4e86\u89e3\uff0c\u4f8b\u5982\uff0c\u5f53\u6d41\u91cf\u8d1f\u8f7d\u589e\u52a0\u65f6\u670d\u52a1\u7684\u6267\u884c\u60c5\u51b5\uff0c\u6216\u8005\u5728\u8fdb\u884c\u66f4\u65b0\u4ee5\u6dfb\u52a0\u529f\u80fd\u6216\u4fee\u590d\u9519\u8bef\u65f6\uff0c\u670d\u52a1\u7684\u4e00\u4e2a\u7248\u672c\u4e0e\u53e6\u4e00\u4e2a\u7248\u672c\u7684\u6bd4\u8f83\u60c5\u51b5\u3002 Grafana \u4eea\u8868\u677f\u7684\u4f18\u70b9\u5728\u4e8e\u4f60\u65e0\u9700\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u5373\u53ef\u521b\u5efa\u5b83\u4eec\uff0cLinkerd \u4f7f\u7528\u52a8\u6001\u6a21\u677f\u4e3a\u6bcf\u4e2a\u6ce8\u5165 Linkerd \u4ee3\u7406\u548c\u90e8\u5206\u670d\u52a1\u7f51\u683c\u7684 Kubernetes \u8d44\u6e90\u751f\u6210\u4eea\u8868\u677f\u548c\u56fe\u8868\u3002\u6211\u4eec\u53ef\u4ee5\u5728 Grafana \u4eea\u8868\u677f\u7684\u5de6\u4e0a\u89d2\uff0c\u5355\u51fb Linkerd Deployment \u94fe\u63a5\u4ee5\u6253\u5f00\u53ef\u7528\u4eea\u8868\u677f\u5217\u8868\u3002 \u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb Linkerd Pod \u4eea\u8868\u76d8\uff0c\u67e5\u770b\u4e0e emoji \u670d\u52a1\u76f8\u5173\u7684\u4e00\u4e2a Pod \u7684\u56fe\u8868\uff0c\u4eea\u8868\u677f\u4e2d\u663e\u793a\u4e86\u5355\u4e2a Pod \u7684\u76f8\u540c\u7684\u9ec4\u91d1\u6307\u6807\uff0c\u8fd9\u4e0e Deployment \u4eea\u8868\u677f\u4e0d\u540c\uff0c\u56e0\u4e3a Deployment \u4eea\u8868\u677f\u663e\u793a\u4e86\u4e0e Deployment \u76f8\u5173\u7684\u6240\u6709 Pod \u7684\u6c47\u603b\u6307\u6807\u3002","title":"Grafana \u4e2d\u5c55\u793a\u6307\u6807"},{"location":"chap11/2linkered_index/#linkerd-cli","text":"Linkerd \u4eea\u8868\u677f\u529f\u80fd\u5f88\u5f3a\u5927\uff0c\u56e0\u4e3a\u5b83\u5728\u57fa\u4e8e\u6d4f\u89c8\u5668\u7684\u754c\u9762\u4e2d\u663e\u793a\u4e86\u5927\u91cf\u6307\u6807\uff0c\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528\u6d4f\u89c8\u5668\u7684\u8bdd\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Linkerd CLI \u547d\u4ee4\u884c\u5de5\u5177\uff0cCLI \u5728\u7ec8\u7aef\u4e2d\u63d0\u4f9b\u4e86\u4eea\u8868\u677f\u76f8\u540c\u7684\u529f\u80fd\u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u663e\u793a emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u4ece Web \u670d\u52a1\u901a\u8fc7 /emojivoto.v1.VotingService/VoteDoughnut \u8def\u5f84\u5230\u6295\u7968\u670d\u52a1\u7684\u6240\u6709\u6d41\u91cf \uff1a $ linkerd viz tap deployment/web --namespace emojivoto --to deployment/voting --path /emojivoto.v1.VotingService/VoteDoughnut req id=3:0 proxy=out src=10.244.2.71:41226 dst=10.244.1.95:8080 tls=true :method=POST :authority=voting-svc.emojivoto:8080 :path=/emojivoto.v1.VotingService/VoteDoughnut rsp id=3:0 proxy=out src=10.244.2.71:41226 dst=10.244.1.95:8080 tls=true :status=200 latency=1128\u00b5s end id=3:0 proxy=out src=10.244.2.71:41226 dst=10.244.1.95:8080 tls=true grpc-status=Unknown duration=183\u00b5s response-length=0B \u6b64\u5916\u6211\u4eec\u8fd8\u901a\u8fc7\u4f7f\u7528 -o json \u6807\u5fd7\u6307\u5b9a\u8f93\u51fa\u6570\u636e\u4e3a JSON \u683c\u5f0f\uff0c\u4ee5\u83b7\u53d6\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz tap deployment/web --namespace emojivoto --to deployment/voting --path /emojivoto.v1.VotingService/VoteDoughnut -o json { \"source\": { \"ip\": \"10.244.1.108\", \"port\": 59370, \"metadata\": { \"control_plane_ns\": \"linkerd\", \"deployment\": \"web\", \"namespace\": \"emojivoto\", \"pod\": \"web-5f86686c4d-58p7k\", \"pod_template_hash\": \"5f86686c4d\", \"serviceaccount\": \"web\", \"tls\": \"loopback\" } }, \"destination\": { \"ip\": \"10.244.1.95\", \"port\": 8080, \"metadata\": { \"control_plane_ns\": \"linkerd\", \"deployment\": \"voting\", \"namespace\": \"emojivoto\", \"pod\": \"voting-ff4c54b8d-jjpkm\", \"pod_template_hash\": \"ff4c54b8d\", \"server_id\": \"voting.emojivoto.serviceaccount.identity.linkerd.cluster.local\", \"service\": \"voting-svc\", \"serviceaccount\": \"voting\", \"tls\": \"true\" } }, \"routeMeta\": null, \"proxyDirection\": \"OUTBOUND\", \"responseInitEvent\": { \"id\": { \"base\": 6, \"stream\": 6 }, \"sinceRequestInit\": { \"nanos\": 686968 }, \"httpStatus\": 200, \"headers\": [ { \"name\": \":status\", \"valueStr\": \"200\" }, { \"name\": \"content-type\", \"valueStr\": \"application/grpc\" }, { \"name\": \"grpc-status\", \"valueStr\": \"2\" }, { \"name\": \"grpc-message\", \"valueStr\": \"ERROR\" }, { \"name\": \"date\", \"valueStr\": \"Thu, 25 Aug 2022 08:52:05 GMT\" } ] } } \u53ef\u4ee5\u770b\u5230 JSON \u8f93\u51fa\u7684\u4fe1\u606f\u8981\u8be6\u7ec6\u5f97\u591a\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u4f1a\u6253\u5370\u6709\u5173\u7684\u591a\u884c\u4fe1\u606f\uff0c\u5305\u62ec\uff1a HTTP \u65b9\u6cd5 \u6d41\u91cf\u7684\u65b9\u5411 HTTP Header \u8ba9\u6211\u4eec\u518d\u8fd0\u884c\u4e00\u4e2a \u66f4\u7c97\u7c92\u5ea6\u7684 Tap \u67e5\u8be2 \uff0c\u5c31\u50cf\u6211\u4eec\u5728\u4eea\u8868\u677f\u4e2d\u8fd0\u884c\u7684\u67e5\u8be2\u4e00\u6837\u3002\u6bd4\u5982\u83b7\u53d6 Web \u670d\u52a1\u7684\u6240\u6709\u6d41\u91cf\uff1a $ linkerd viz tap deploy/web -n emojivoto req id=7:13 proxy=out src=10.244.1.108:33416 dst=10.244.1.88:8080 tls=true :method=POST :authority=emoji-svc.emojivoto:8080 :path=/emojivoto.v1.EmojiService/FindByShortcode rsp id=7:13 proxy=out src=10.244.1.108:33416 dst=10.244.1.88:8080 tls=true :status=200 latency=708\u00b5s end id=7:13 proxy=out src=10.244.1.108:33416 dst=10.244.1.88:8080 tls=true grpc-status=OK duration=35\u00b5s response-length=20B req id=7:14 proxy=out src=10.244.1.108:59370 dst=10.244.1.95:8080 tls=true :method=POST :authority=voting-svc.emojivoto:8080 :path=/emojivoto.v1.VotingService/VoteMan rsp id=7:14 proxy=out src=10.244.1.108:59370 dst=10.244.1.95:8080 tls=true :status=200 latency=809\u00b5s end id=7:14 proxy=out src=10.244.1.108:59370 dst=10.244.1.95:8080 tls=true grpc-status=OK duration=65\u00b5s response-length=5B # ...... \u4e0a\u9762\u7684\u547d\u4ee4\u6211\u4eec\u5220\u9664\u4e86 --to \u548c --path \u8fd9\u4e9b\u53c2\u6570\uff0c\u7c92\u5ea6\u66f4\u7c97\u4e86\uff0c\u6574\u4e2a\u8f93\u51fa\u5c06\u663e\u793a\u6240\u6709\u8fdb\u51fa Web \u670d\u52a1\u7684\u6d41\u91cf\uff0c\u5305\u62ec web \u548c emoji \u670d\u52a1\u4ee5\u53ca web \u548c voting \u670d\u52a1\u4e4b\u95f4\u7684\u6d41\u91cf \u3002 \u6211\u4eec\u53ef\u4ee5\u6839\u636e\u6bcf\u884c\u8f93\u51fa\u4e2d\u7684 src \u548c dst \u5b57\u6bb5\u67e5\u770b\u6d41\u91cf\u7684\u65b9\u5411\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528 -o json \u6807\u5fd7\u518d\u6b21\u8fd0\u884c\u67e5\u8be2\u4ee5\u67e5\u770b JSON \u683c\u5f0f\u7684\u8f93\u51fa\uff0c\u5e76\u67e5\u770b\u662f\u5426\u53ef\u4ee5\u53d1\u73b0\u7ed9\u5b9a\u8bf7\u6c42\u7684\u6d41\u91cf\u65b9\u5411\u3002 \u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u5728\u7ec8\u7aef\u4e2d \u4f7f\u7528 tap \u547d\u4ee4\u5b9e\u65f6\u663e\u793a\u6d41\u91cf \uff0c \u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u53e6\u5916\u4e00\u4e2a linkerd viz top \u547d\u4ee4\uff0c\u8be5\u547d\u4ee4\u548c tap \u547d\u4ee4\u63d0\u4f9b\u76f8\u540c\u7684\u4fe1\u606f\uff0c\u4f46\u683c\u5f0f\u4e0e\u57fa\u4e8e Unix \u7684 top \u547d\u4ee4\u76f8\u540c \u3002 \u6362\u53e5\u8bdd\u8bf4\uff0c linkerd viz top \u663e\u793a\u4e86\u6309\u6700\u53d7\u6b22\u8fce\u7684\u8def\u5f84\u6392\u5e8f\u7684\u6d41\u91cf\u8def\u7ebf \uff0c\u6211\u4eec\u6765\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u8fdb\u884c\u67e5\u770b\uff1a \u540c\u6837\u73b0\u5728\u6211\u4eec\u60f3\u5728\u7ec8\u7aef\u4e2d\u67e5\u770b\u4eea\u8868\u677f\u4e2d \u770b\u5230\u7684\u5ef6\u8fdf\u3001\u6210\u529f/\u9519\u8bef\u7387\u548c\u6bcf\u79d2\u8bf7\u6c42\u6570\u6307\u6807 \uff0c\u53c8\u5e94\u8be5\u600e\u4e48\u64cd\u4f5c\u5462\uff1f \u540c\u6837 Linkerd CLI \u63d0\u4f9b\u4e86\u4e00\u4e2a stat \u547d\u4ee4\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u6765\u6267\u884c\u8be5\u64cd\u4f5c\u3002\u8ba9\u6211\u4eec\u901a\u8fc7\u83b7\u53d6 emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u6240\u6709\u670d\u52a1\u7684\u6307\u6807\u6765\u5c1d\u8bd5\u4e00\u4e0b\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz stat deploy -n emojivoto NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji 1/1 100.00% 2.3rps 1ms 1ms 1ms 4 vote-bot 1/1 100.00% 0.3rps 1ms 1ms 1ms 1 voting 1/1 89.74% 1.3rps 1ms 1ms 1ms 4 web 2/2 93.51% 2.6rps 1ms 7ms 9ms 6 linkerd viz stat \u547d\u4ee4\u53ef\u4ee5\u83b7\u53d6\u5230\u5e94\u7528\u670d\u52a1\u6027\u80fd\u7684\u6700\u65b0\u6307\u6807\u6570\u636e\uff0c\u5982\u679c\u4f60\u60f3\u8981\u83b7\u53d6\u66f4\u591a\u6570\u636e\uff0c\u53ef\u4ee5\u6dfb\u52a0 -o wide \u6807\u5fd7\u6765\u83b7\u53d6\u8fd9\u4e9b TCP \u7ea7\u522b\u7684\u8be6\u7ec6\u4fe1\u606f \u3002 \u4efb\u4f55\u65f6\u5019\u60a8\u60f3\u8981\u83b7\u5f97\u5e94\u7528\u7a0b\u5e8f\u4e2d\u670d\u52a1\u6027\u80fd\u7684\u6700\u65b0\u5feb\u7167\uff0c \u60a8\u90fd\u53ef\u4ee5\u4f7f\u7528 linkerd viz stat \u6765\u83b7\u53d6\u8fd9\u4e9b\u6307\u6807\u3002\u5982\u679c\u60a8\u60f3\u66f4\u6df1\u5165\u5730\u83b7\u53d6\u5199\u5165\u548c\u8bfb\u53d6\u7684\u5b57\u8282\u6570\uff0c\u53ef\u4ee5\u6dfb\u52a0 -o Wide \u6807\u5fd7\u6765\u83b7\u53d6\u8fd9\u4e9b TCP \u7ea7\u522b\u7684\u8be6\u7ec6\u4fe1\u606f \u3002\u65e0\u8bba\u662f\u5426\u4f7f\u7528 -o wide \u6807\u5fd7\uff0c\u90fd\u5c06\u59cb\u7ec8\u663e\u793a TCP \u8fde\u63a5\u3002 $ linkerd viz stat deploy -n emojivoto -o wide NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN READ_BYTES/SEC WRITE_BYTES/SEC emoji 1/1 100.00% 2.3rps 1ms 1ms 1ms 4 229.0B/s 2680.8B/s vote-bot 1/1 100.00% 0.3rps 1ms 3ms 3ms 1 24.3B/s 585.0B/s voting 1/1 89.74% 1.3rps 1ms 1ms 1ms 4 121.4B/s 481.0B/s web 2/2 92.95% 2.6rps 1ms 4ms 4ms 6 205.0B/s 5949.4B/s \u540c\u6837 stat \u547d\u4ee4\u4e5f\u53ef\u4ee5\u901a\u8fc7 --to \u53c2\u6570\u6765\u7f29\u5c0f\u67e5\u8be2\u8303\u56f4\uff0c\u6bd4\u5982\u6211\u4eec\u60f3\u8981\u67e5\u8be2\u4ece web \u670d\u52a1\u5230 voting \u670d\u52a1\u7684\u6d41\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a $ linkerd viz stat -n emojivoto deploy/web --to deploy/voting NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN web 2/2 86.67% 1.0rps 1ms 4ms 4ms 2 \u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u7684\u6570\u636e\u548c\u524d\u9762\u4e00\u6837\uff0c\u53ea\u662f\u53ea\u6709\u4e00\u884c\u6570\u636e\u8f93\u51fa\uff0c\u5176\u4e2d\u6700\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u6210\u529f\u7387\u8fd9\u4e00\u5217\u4f4e\u4e8e 100% \u4e86\u3002\u4ece\u8fd9\u4e2a\u8f93\u51fa\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u63a8\u65ad\u51fa\uff0c\u5f53\u6211\u4eec\u67e5\u770b emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u670d\u52a1\u65f6\uff0cweb \u670d\u52a1\u7684\u6210\u529f\u7387\u662f\u6765\u81ea voting \u548c emoji \u670d\u52a1\u54cd\u5e94\u7684\u603b\u548c\u3002 \u4e3a\u4e86\u9a8c\u8bc1\u8fd9\u4e2a\u5047\u8bbe\uff0c\u8ba9\u6211\u4eec\u518d\u8fd0\u884c\u4e00 \u4e2a\u67e5\u8be2\uff0c\u4ee5\u4ec5\u67e5\u770b\u4ece web \u670d\u52a1\u5230\u547d\u540d\u7a7a\u95f4\u4e2d\u6240\u6709\u5176\u4ed6\u670d\u52a1\u7684\u6d41\u91cf\u3002 $ linkerd viz stat -n emojivoto deploy --from deploy/web NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji 1/1 100.00% 1.9rps 1ms 1ms 2ms 2 voting 1/1 83.05% 1.0rps 1ms 1ms 2ms 2 \u5728\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u5b9e\u9645\u4e0a\uff0cvoting \u670d\u52a1\u5b58\u5728\u9519\u8bef\uff0c\u800c emoji \u670d\u52a1\u5219\u6ca1\u6709\u3002 stat \u547d\u4ee4\u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u5177\u6709\u8bb8\u591a\u914d\u7f6e\u9009\u9879\u3002\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c linkerd viz stat -h \u4ee5\u67e5\u770b\u53ef\u4ee5\u8fd0\u884c stat \u7684\u6240\u6709\u53ef\u7528\u65b9\u5f0f\u3002 \u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86\u51e0\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u6765\u67e5\u770b\u88ab Linkerd \u7f51\u683c\u5316\u7684\u5e94\u7528\u7684\u9ec4\u91d1\u6307\u6807\u6570\u636e\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u83b7\u53d6\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\uff0c\u901a\u8fc7\u4e3a Kubernetes \u670d\u52a1\u521b\u5efa ServiceProfile \u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u670d\u52a1\u53ef\u7528\u7684\u8def\u7531\u5e76\u4e3a\u6bcf\u4e2a\u8def\u7531\u6536\u96c6\u5355\u72ec\u7684\u6307\u6807\u3002 \u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u53ea\u80fd\u770b\u5230 default \u8def\u7531\u4e0a\u5bf9\u670d\u52a1\u7684\u6240\u6709\u8bf7\u6c42\u7684\u6307\u6807\u3002\u4e3a emojivoto \u670d\u52a1\u914d\u7f6e ServiceProfiles \u540e\uff0c\u6211\u4eec\u5c06\u80fd\u591f\u770b\u5230\u6bcf\u6761\u8def\u7531\u7684\u6307\u6807\uff01","title":"Linkerd CLI \u547d\u4ee4\u67e5\u770b\u6307\u6807"},{"location":"chap11/3linkered_ServiceProfile/","text":"3 Linkerd \u901a\u8fc7 ServiceProfile \u5b9e\u73b0\u8d85\u65f6\u548c\u91cd\u8bd5 Linkerd \u670d\u52a1\u7f51\u683c\u89e3\u51b3\u7684\u6700\u91cd\u8981\u95ee\u9898\u4e4b\u4e00\u662f\u53ef\u89c2\u5bdf\u6027\uff1a\u63d0\u4f9b\u670d\u52a1\u884c\u4e3a\u7684\u8be6\u7ec6\u89c6\u56fe\uff0c Linkerd \u5bf9\u53ef\u89c2\u5bdf\u6027\u7684\u4ef7\u503c\u4e3b\u5f20\u662f\uff0c\u5b83\u53ef\u4ee5\u4e3a\u4f60\u7684 HTTP \u548c gRPC \u670d\u52a1\u63d0\u4f9b\u9ec4\u91d1\u6307\u6807\uff0c\u8fd9\u4e9b\u90fd\u662f\u81ea\u52a8\u6267\u884c\uff0c\u65e0\u9700\u66f4\u6539\u4ee3\u7801\u6216\u5f00\u53d1\u4eba\u5458\u53c2\u4e0e\u7684 \u3002 \u5f00\u7bb1\u5373\u7528\uff0cLinkerd \u5728\u6bcf\u4e2a\u670d\u52a1\u7684\u57fa\u7840\u4e0a\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\uff1a \u8de8\u8d8a\u670d\u52a1\u7684\u6240\u6709\u8bf7\u6c42\uff0c\u65e0\u8bba\u8fd9\u4e9b\u8bf7\u6c42\u662f\u4ec0\u4e48 \u3002\u7136\u800c\uff0c\u6709\u65f6\u9700\u8981\u83b7\u5f97\u66f4\u7ec6\u7c92\u5ea6\u7684\u6307\u6807\u3002 \u4f8b\u5982\u524d\u9762\u7684 Emojivoto \u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684 Emoji \u5fae\u670d\u52a1\uff0c\u524d\u9762\u7ae0\u8282\u4e2d\u770b\u5230\u7684 Linkerd \u62a5\u544a\u7684\u6307\u6807\u662f\u5728\u8be5\u670d\u52a1\u7684\u6240\u6709\u7aef\u70b9\u4e0a\u805a\u5408\u7684\u3002\u5728\u5b9e\u9645\u573a\u666f\u4e0b\u9762\uff0c\u6211\u4eec\u53ef\u80fd\u8fd8\u5e0c\u671b\u770b\u5230 \u7279\u5b9a\u7aef\u70b9\u7684\u6210\u529f\u7387\u6216\u5ef6\u8fdf \uff0c\u4f8b\u5982\uff0c\u4e00\u4e2a\u7aef\u70b9\u53ef\u80fd\u5bf9\u670d\u52a1\u7279\u522b\u5173\u952e\uff0c\u6216\u8005\u7279\u522b\u6162\u3002 \u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c Linkerd \u4f7f\u7528\u4e86\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff08service profile\uff09\u7684\u6982\u5ff5\uff0c\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u662f\u4e00\u4e2a\u53ef\u9009\u7684\u914d\u7f6e\uff0c\u5b83\u901a\u77e5 Linkerd \u5bf9\u670d\u52a1\u7684\u4e0d\u540c\u7c7b\u578b\u7684\u8bf7\u6c42\uff0c\u6309\u5176\u8def\u7531\u8fdb\u884c\u5206\u7c7b \u3002\u8def\u7531\u53ea\u662f\u4e00\u4e2a\u7aef\u70b9\uff08\u5bf9\u4e8e gRPC\uff09\u6216\u4e00\u4e2a HTTP verb \u548c\u7aef\u70b9\uff08\u5bf9\u4e8e HTTP\uff09\u3002 \u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u5141\u8bb8 Linkerd \u4e3a\u670d\u52a1\u63d0\u4f9b\u6bcf\u4e2a\u8def\u7531\uff08pre-route\uff09\u800c\u4e0d\u662f\u6bcf\u4e2a\u670d\u52a1\u6307\u6807\uff0c\u5728\u540e\u9762\u7684\u7ae0\u8282\u4e2d\uff0c\u6211\u4eec\u8fd8\u5c06\u770b\u5230\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u5141\u8bb8 Linkerd \u5bf9\u670d\u52a1\u6267\u884c\u91cd\u8bd5\u548c\u8d85\u65f6\u7b49\u914d\u7f6e\uff0c\u4f46\u662f\u73b0\u5728\u6211\u4eec\u5148\u53ea\u5173\u6ce8\u6307\u6807\u3002 \u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u5e76\u4e0d\u662f\u7b80\u5355\u7684\u670d\u52a1\u4e0e Linkerd \u4e00\u8d77\u8fd0\u884c\u6240\u5fc5\u9700\u7684\uff0c\u5b83\u4eec\u662f\u53ef\u9009\u7684\u914d\u7f6e\u4f4d\uff0c\u53ef\u4ee5\u5b9e\u73b0 Linkerd \u7684\u66f4\u9ad8\u7ea7\u884c\u4e3a\uff0c\u5b83\u4eec\u4e5f\u662f Linkerd \u4f7f\u7528 Kubernetes CRD \u7684\u5c11\u6570\u793a\u4f8b\u4e4b\u4e00\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u4ecd\u7136\u901a\u8fc7 Emojivoto \u5e94\u7528\u8bf4\u660e\u4e0b\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u7684\u4f7f\u7528\u3002 \u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6 Linkerd \u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u662f\u901a\u8fc7\u5b9e\u4f8b\u5316\u4e00\u4e2a\u540d\u4e3a ServiceProfile \u7684 Kubernetes CRD \u6765\u5b9e\u73b0\u7684\u3002 ServiceProfile \u4f1a\u679a\u4e3e Linkerd \u4e3a\u8be5\u670d\u52a1\u671f\u671b\u7684\u8def\u7531 \u3002 \u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u521b\u5efa ServiceProfile\uff0c\u4f46\u4e5f\u53ef\u4ee5\u81ea\u52a8\u751f\u6210\u5b83\u4eec\u3002 Linkerd CLI \u6709\u4e00\u4e2a profile \u547d\u4ee4\uff0c\u53ef\u4ee5\u901a\u8fc7\u51e0\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u6765\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6 \u3002\u6700\u5e38\u89c1\u7684\u65b9\u6cd5\u4e4b\u4e00\u662f\u4ece\u670d\u52a1\u7684\u73b0\u6709\u8d44\u6e90\uff08\u5982 OpenAPI/Swagger \u89c4\u8303\u6216 protobuf \u6587\u4ef6\uff09\u751f\u6210\u5b83\u4eec\u3002 $ linkerd profile -h Output service profile config for Kubernetes. Usage: linkerd profile [flags] (--template | --open-api file | --proto file) (SERVICE) Examples: # Output a basic template to apply after modification. linkerd profile -n emojivoto --template web-svc # Generate a profile from an OpenAPI specification. linkerd profile -n emojivoto --open-api web-svc.swagger web-svc # Generate a profile from a protobuf definition. linkerd profile -n emojivoto --proto Voting.proto vote-svc Flags: -h, --help help for profile --ignore-cluster Output a service profile through offline generation -n, --namespace string Namespace of the service --open-api string Output a service profile based on the given OpenAPI spec file --proto string Output a service profile based on the given Protobuf spec file --template Output a service profile template Global Flags: --api-addr string Override kubeconfig and communicate directly with the control plane at host:port (mostly for testing) --as string Username to impersonate for Kubernetes operations --as-group stringArray Group to impersonate for Kubernetes operations --cni-namespace string Namespace in which the Linkerd CNI plugin is installed (default \"linkerd-cni\") --context string Name of the kubeconfig context to use --kubeconfig string Path to the kubeconfig file to use for CLI requests -L, --linkerd-namespace string Namespace in which Linkerd is installed ($LINKERD_NAMESPACE) (default \"linkerd\") --verbose Turn on debug logging \u4e0a\u9762\u7684\u5e2e\u52a9\u547d\u4ee4\u8f93\u51fa\u5217\u51fa\u4e86\u53ef\u7528\u4e8e\u4e3a ServiceProfile \u8d44\u6e90\u751f\u6210 YAML \u7684\u6807\u5fd7\uff0c\u53ef\u4ee5\u770b\u5230 \u5176\u4e2d\u5c31\u6709\u4e00\u4e2a --open-api \u6807\u5fd7\uff0c\u7528\u4e8e\u6307\u793a ServiceProfile \u8d44\u6e90\u5c06\u4ece\u6307\u5b9a\u7684 OpenAPI \u6216 Swagger \u6587\u6863\u6765\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c\u901a\u8fc7 --proto \u6807\u5fd7\u53ef\u4ee5\u6307\u793a\u4ece\u6307\u5b9a\u7684 Protobuf \u6587\u4ef6\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u3002 Emojivoto \u7684 web \u670d\u52a1\u6709\u4e00\u4e2a\u7b80\u5355\u7684 Swagger \u89c4\u8303\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a # web.swagger openapi: 3.0.1 version: v10 paths: /api/list: get: {} /api/vote: get: {} \u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528\u4e0a\u9762\u7684\u89c4\u8303\u6587\u4ef6\u6765\u751f\u6210\u4e00\u4e2a ServiceProfile \u5bf9\u8c61\uff0c\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a $ linkerd profile -n emojivoto --open-api web.swagger web-svc > web-sp.yaml \u4e0a\u8ff0\u547d\u4ee4\u5c06\u8f93\u51fa\u670d\u52a1 web-svc \u7684 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u3002\u8bf7\u6ce8\u610f\uff0c\u5c31\u50cf linkerd install \u547d\u4ee4\u4e00\u6837\uff0c linkerd profile \u547d\u4ee4\u4e5f\u53ea\u751f\u6210 YAML\uff0c\u5b83\u4e0d\u4f1a\u5c06 YAML \u5e94\u7528\u5230\u96c6\u7fa4\uff0c\u6240\u4ee5\u6211\u4eec\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230 web-sp.yaml \u6587\u4ef6\uff0c\u5bf9\u5e94\u751f\u6210\u7684\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: creationTimestamp: null name: web-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: routes: - condition: method: GET pathRegex: /api/list name: GET /api/list - condition: method: GET pathRegex: /api/vote name: GET /api/vote \u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684 ServiceProfile \u5bf9\u8c61\u7684\u58f0\u660e\u65b9\u5f0f\uff0c spec.routes \u7528\u6765\u58f0\u660e\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff0c\u6bcf\u6761\u8def\u7531\u4e2d\u5305\u542b\u4e00\u4e2a name \u548c condition \u5c5e\u6027 \uff1a name \u7528\u6765\u8868\u793a\u8def\u7531\u7684\u540d\u79f0\uff0c\u7528\u4e8e\u663e\u793a\u4f7f\u7528\u3002 condition \u7528\u6765\u63cf\u8ff0\u8def\u7531\u7684\u89c4\u8303\u3002\u4e0a\u4f8b\u4e2d\u751f\u6210\u7684 condition \u6709\u4e24\u4e2a\u5b57\u6bb5\uff1a method\uff1a\u4e0e\u8bf7\u6c42\u5339\u914d\u7684 HTTP \u65b9\u6cd5\u3002 pathRegex\uff1a\u7528\u4e8e\u5339\u914d\u8def\u5f84\u7684\u6b63\u5219\u8868\u8fbe\u5f0f \u3002\u5728\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\uff0c\u8fd9\u4e9b\u662f\u5b8c\u5168\u5339\u914d\u7684\u89c4\u5219\uff0c\u4f46\u901a\u5e38\u8fd9\u4e9b\u662f\u6b63\u5219\u8868\u8fbe\u5f0f\u3002 \u9664\u4e86\u901a\u8fc7 OpenAPI \u53ef\u4ee5\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e4b\u5916\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 Protobuf \u6765\u751f\u6210\uff0cgRPC \u534f\u8bae\u4f7f\u7528 protobuf \u5bf9\u8bf7\u6c42\u548c\u54cd\u5e94\u8fdb\u884c\u7f16\u7801\u548c\u89e3\u7801\uff0c\u8fd9\u610f\u5473\u7740\u6bcf\u4e2a gRPC \u670d\u52a1\u4e5f\u6709\u4e00\u4e2a protobuf \u5b9a\u4e49\u3002 Emojivoto \u5e94\u7528\u7684 Voting \u5fae\u670d\u52a1\u5c31\u5305\u542b\u6709 protobuf \u5b9a\u4e49\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a syntax = \"proto3\"; option go_package = \"github.com/buoyantio/emojivoto/proto\"; package emojivoto.v1; message VotingResult { string Shortcode = 1; int32 Votes = 2; } message VoteRequest { } message VoteResponse { } message ResultsRequest { } message ResultsResponse { repeated VotingResult results = 1; } service VotingService { rpc VotePoop (VoteRequest) returns (VoteResponse); rpc VoteJoy (VoteRequest) returns (VoteResponse); rpc VoteSunglasses (VoteRequest) returns (VoteResponse); ......\u7701\u7565\u90e8\u5206\u5185\u5bb9 } \u540c\u6837\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd profile \u547d\u4ee4\u6765\u751f\u6210\u5bf9\u5e94\u7684 ServiceProfile \u5bf9\u8c61\uff1a $ linkerd profile -n emojivoto --proto Voting.proto voting-svc > voting-sp.yaml \u6b64\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u5c06\u6bd4\u4e0a\u4e00\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u591a\u5f88\u591a\uff0c\u56e0\u4e3a Voting.proto \u6587\u4ef6\u5b9a\u4e49\u4e86\u66f4\u591a\u8def\u7531\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b voting-sp.yaml \u6587\u4ef6\uff0c\u5e76\u5c06\u5176\u4e0e\u4e0a\u9762\u521b\u5efa\u7684 ServiceProfile \u8d44\u6e90\u8fdb\u884c\u6bd4\u8f83\u3002 \u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u7528\u53e6\u5916\u4e00\u79cd\u65b9\u6cd5\u6765\u52a8\u6001\u751f\u6210 ServiceProfile\uff0cLinkerd \u53ef\u4ee5\u76d1\u63a7\u5728\u6307\u5b9a\u65f6\u95f4\u6bb5\u5185\u8fdb\u5165\u7684\u5b9e\u65f6\u8bf7\u6c42\uff0c\u5e76\u4ece\u4e2d\u6536\u96c6\u8def\u7531\u6570\u636e\u3002 \u5bf9\u4e8e\u4e0d\u4e86\u89e3\u670d\u52a1\u63d0\u4f9b\u7684\u5185\u90e8\u8def\u7531\u7684\u96c6\u7fa4\u7ba1\u7406\u5458\u6765\u8bf4\uff0c\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u529f\u80fd\uff0c\u56e0\u4e3a Linkerd \u4f1a\u8d1f\u8d23\u5904\u7406\u8bf7\u6c42\u5e76\u5c06\u5b83\u4eec\u5199\u5165\u6587\u4ef6\uff0c\u8be5\u7279\u6027\u7684\u5e95\u5c42\u539f\u7406\u662f\u4e0a\u4e00\u8282\u4e2d\u63d0\u5230\u7684\u5b9e\u65f6\u89c2\u5bdf\u8bf7\u6c42\u7684 Tap \u529f\u80fd\u3002 \u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u4f7f\u7528 linkerd profile \u547d\u4ee4\u76d1\u63a7 emoji \u670d\u52a1 10 \u79d2\u5e76\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\uff0c\u4e0e\u524d\u9762\u5b66\u4e60\u7684\u6240\u6709\u547d\u4ee4\u4e00\u6837\uff0c\u8f93\u51fa\u4f1a\u6253\u5370\u5230\u7ec8\u7aef\uff0c\u5e76\u4e14\u6b64\u547d\u4ee4\u4f1a\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8fd0\u884c\u8be5\u547d\u4ee4\uff08\u5e76\u7b49\u5f85 10 \u79d2\uff09\u4e00\u6b21\u3002 Linkerd Viz \u6269\u5c55\u4e5f\u6709\u81ea\u5df1\u7684\u914d\u7f6e\u6587\u4ef6\u5b50\u547d\u4ee4\uff0c\u53ef\u4ee5\u4e0e Tap \u529f\u80fd\u4e00\u8d77\u4f7f\u7528\uff0c\u4ece\u5b9e\u65f6\u6d41\u91cf\u4e2d\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff01\u5982\u4e0b\u547d\u4ee4\u6240\u793a\uff1a $ linkerd viz profile emoji-svc --tap deploy/emoji --tap-duration 10s -n emojivoto > emoji-sp.yaml \u5f53\u8bf7\u6c42\u53d1\u9001\u5230 emoji \u670d\u52a1\u65f6\uff0c\u8fd9\u4e9b\u8def\u7531\u901a\u8fc7 Tap \u529f\u80fd\u6536\u96c6\u3002\u6211 \u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 Emoji.proto \u6587\u4ef6\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u540e\u53bb\u6bd4\u8f83\u4f7f\u7528 --proto \u548c --tap \u6807\u5fd7\u521b\u5efa\u7684 ServiceProfile \u8d44\u6e90\u7684\u5b9a\u4e49 \u3002 \u751f\u6210\u7684 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a # emoji-sp.yaml apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: creationTimestamp: null name: emoji-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: routes: - condition: method: POST pathRegex: /emojivoto\\.v1\\.EmojiService/FindByShortcode name: POST /emojivoto.v1.EmojiService/FindByShortcode - condition: method: POST pathRegex: /emojivoto\\.v1\\.EmojiService/ListAll name: POST /emojivoto.v1.EmojiService/ListAll \u5982\u679c\u4f60\u9700\u8981\u624b\u52a8\u7f16\u5199\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c linkerd profile \u547d\u4ee4\u6709\u4e00\u4e2a --template \u6807\u5fd7\uff0c\u53ef\u4ee5\u751f\u6210 ServiceProfile \u8d44\u6e90\u7684\u811a\u624b\u67b6\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528\u4f60\u7684\u670d\u52a1\u7684\u8be6\u7ec6\u4fe1\u606f\u5bf9\u5176\u8fdb\u884c\u66f4\u65b0 \u3002 $ linkerd profile --template -n emojivoto emoji-svc ### ServiceProfile for emoji-svc.emojivoto ### apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: name: emoji-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: # A service profile defines a list of routes. Linkerd can aggregate metrics # like request volume, latency, and success rate by route. routes: - name: '/authors/{id}' # Each route must define a condition. All requests that match the # condition will be counted as belonging to that route. If a request # matches more than one route, the first match wins. condition: # The simplest condition is a path regular expression. pathRegex: '/authors/\\d+' # This is a condition that checks the request method. method: POST # If more than one condition field is set, all of them must be satisfied. # This is equivalent to using the 'all' condition: # all: # - pathRegex: '/authors/\\d+' # - method: POST # Conditions can be combined using 'all', 'any', and 'not'. # any: # - all: # - method: POST # - pathRegex: '/authors/\\d+' # - all: # - not: # method: DELETE # - pathRegex: /info.txt # A route may be marked as retryable. This indicates that requests to this # route are always safe to retry and will cause the proxy to retry failed # requests on this route whenever possible. # isRetryable: true # A route may optionally define a list of response classes which describe # how responses from this route will be classified. responseClasses: # Each response class must define a condition. All responses from this # route that match the condition will be classified as this response class. - condition: # The simplest condition is a HTTP status code range. status: min: 500 max: 599 # Specifying only one of min or max matches just that one status code. # status: # min: 404 # This matches 404s only. # Conditions can be combined using 'all', 'any', and 'not'. # all: # - status: # min: 500 # max: 599 # - not: # status: # min: 503 # The response class defines whether responses should be counted as # successes or failures. isFailure: true # A route can define a request timeout. Any requests to this route that # exceed the timeout will be canceled. If unspecified, the default timeout # is '10s' (ten seconds). # timeout: 250ms # A service profile can also define a retry budget. This specifies the # maximum total number of retries that should be sent to this service as a # ratio of the original request volume. # retryBudget: # The retryRatio is the maximum ratio of retries requests to original # requests. A retryRatio of 0.2 means that retries may add at most an # additional 20% to the request load. # retryRatio: 0.2 # This is an allowance of retries per second in addition to those allowed # by the retryRatio. This allows retries to be performed, when the request # rate is very low. # minRetriesPerSecond: 10 # This duration indicates for how long requests should be considered for the # purposes of calculating the retryRatio. A higher value considers a larger # window and therefore allows burstier retries. # ttl: 10s \u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u8f93\u51fa\u5305\u542b ServiceProfile \u8d44\u6e90\u7684\u5b57\u6bb5\u548c\u6bcf\u4e2a\u5b57\u6bb5\u7684\u8be6\u7ec6\u8bf4\u660e\uff0c\u5982\u679c\u4f60\u9700\u8981 ServiceProfile \u5b9a\u4e49\u7684\u5feb\u901f\u53c2\u8003\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528 --template \u6807\u5fd7\uff01 \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86\u5982\u4f55\u751f\u6210 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u67e5\u770b\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\u6570\u636e\u3002 Linkerd Dashboard \u4e2d\u67e5\u770b Per-Route Metrics \u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u4f7f\u7528 linkerd profile \u547d\u4ee4\u6765\u751f\u6210 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u73b0\u5728\u8ba9\u6211\u4eec\u91cd\u65b0\u8fd0\u884c\u751f\u6210\u547d\u4ee4\uff0c\u5e76\u76f4\u63a5\u5c06\u751f\u6210\u7684 ServiceProfile \u5bf9\u8c61\u76f4\u63a5\u5e94\u7528\u5230\u96c6\u7fa4\u4e2d\uff1a $ linkerd profile -n emojivoto --open-api web.swagger web-svc | kubectl apply -f - serviceprofile.linkerd.io/web-svc.emojivoto.svc.cluster.local created $ linkerd profile -n emojivoto --proto Voting.proto voting-svc | kubectl apply -f - serviceprofile.linkerd.io/voting-svc.emojivoto.svc.cluster.local created $ linkerd viz profile emoji-svc --tap deploy/emoji --tap-duration 10s -n emojivoto | kubectl apply -f - serviceprofile.linkerd.io/emoji-svc.emojivoto.svc.cluster.local created \u5f53\u4e0a\u9762\u7684\u547d\u4ee4\u8fd0\u884c\u6210\u529f\u540e\uff0c\u8ba9\u6211\u4eec\u6253\u5f00 Linkerd \u4eea\u8868\u76d8\u6765\u67e5\u770b\u4e0b\u76f8\u5173\u6307\u6807\uff0c\u6211\u4eec\u5148\u5bfc\u822a\u5230 Web Deployment \u4e0b\u67e5\u770b\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\u3002 \u4ece\u4e0a\u56fe\u53ef\u4ee5\u770b\u51fa\u6765\u5728 ROUTE METRICS \u9009\u9879\u5361\u4e0b\u9762\u76f8\u6bd4\u9ed8\u8ba4\u7684 [DEFAULT] \u8def\u7531\u591a\u4e86\u4e24\u4e2a\u8def\u7531\uff0c\u8fd9\u4e24\u4e2a\u8def\u7531\u5c31\u662f\u6211\u4eec\u901a\u8fc7 linkerd profile --open-api \u547d\u4ee4\u4ece web.swagger \u6587\u4ef6\u4e2d\u751f\u6210\u7684\u4e24\u6761\u8def\u7531\uff0c\u6bcf\u884c\u5217\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e24\u6761\u8def\u7531\u7684\u6bcf\u6761\u6307\u6807\u6570\u636e\u3002 \u5728\u90e8\u7f72 ServiceProfile \u5bf9\u8c61\u4e4b\u524d\uff0c\u6211\u4eec\u53ea\u80fd\u770b\u5230 web \u670d\u52a1\u7684\u805a\u5408\u6307\u6807\uff0c\u90e8\u7f72\u540e\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u770b\u5230 /api/list \u8fd9\u6761\u8def\u7531\u662f 100% \u6210\u529f\u7684\uff0c /api/vote \u8def\u7531\u6709\u4e00\u4e9b\u9519\u8bef\u3002 \u540c\u6837\u5728\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e4b\u524d\uff0c\u6211\u4eec\u53ea\u77e5\u9053 web \u670d\u52a1\u6b63\u5728\u8fd4\u56de\u9519\u8bef\uff0c\u73b0\u5728\u6211\u4eec\u9519\u8bef\u662f\u6765\u81ea\u4e0e /api/vote \u8def\u7531\uff0c\u53e6\u5916\u7684 [DEFAULT] \u9ed8\u8ba4\u8def\u7531\u8868\u793a\u5f53\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u8def\u7531\u5339\u914d\u8bf7\u6c42\u65f6 Linkerd \u4f7f\u7528\u7684\u8def\u7531\uff0c\u5176\u4f1a\u6355\u83b7\u5728 ServiceProfile \u4e4b\u524d\u89c2\u5bdf\u5230\u7684\u4efb\u4f55\u6d41\u91cf \u73b0\u5728\u6211\u4eec\u518d\u53bb\u770b\u770b\u53e6\u5916\u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c\u5176\u4e2d\u7684 Voting \u670d\u52a1\u6bd4\u8f83\u5177\u6709\u4ee3\u8868\u6027\uff0c\u56e0\u4e3a\u5b83\u5305\u542b\u5f88\u591a\u8def\u7531\u3002 \u5728 Linkerd Dashboard \u9875\u9762\u4e0a\u5728 emojivoto \u547d\u540d\u7a7a\u95f4\u4e0a\u8fdb\u5165 Voting Deployment \uff0c\u5207\u6362\u5230 ROUTE METRICS \u9009\u9879\u5361\u3002 \u6211\u4eec\u4f1a\u8be5\u670d\u52a1\u4e0b\u6709\u975e\u5e38\u591a\u7684\u8def\u7531\uff0c\u4e0a\u9762\u7684 web \u670d\u52a1\u6211\u4eec\u77e5\u9053 /api/vote \u8def\u7531\u7684\u8bf7\u6c42\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u6240\u6709 voting \u670d\u52a1\u4e2d\u7684\u6bcf\u6761\u8def\u7531\u4fe1\u606f\u90fd\u6709\u53ef\u80fd\u4f1a\u63d0\u4f9b\u76f8\u5173\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u7531\u4e8e\u8def\u7531\u975e\u5e38\u591a\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u6309\u7167 Success Rate \u8fd9\u4e00\u5217\u8fdb\u884c\u5347\u5e8f\u6392\u5e8f\uff0c\u6b63\u5e38\u5c31\u53ef\u4ee5\u770b\u5230 VoteDoughnut \u8def\u7531\u6210\u529f\u7387\u4e3a 0\u3002 \u901a\u8fc7 Linkerd CLI \u67e5\u770b Per-Route Metrics \u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86\u5982\u4f55\u901a\u8fc7 Dashboard \u6765\u67e5\u770b Emojivoto \u5e94\u7528\u4e2d\u670d\u52a1\u7684\u6bcf\u4e2a\u8def\u7531\u6307\u6807\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u5c1d\u8bd5\u4f7f\u7528 CLI \u5de5\u5177\u67e5\u770b\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\u3002 linkerd viz routes \u547d\u4ee4\u4f7f\u7528\u4e0e\u4eea\u8868\u76d8\u4f7f\u7528\u7684\u76f8\u540c\u6307\u6807\uff0c\u8ba9\u6211\u4eec\u770b\u770b\u4f7f\u7528 Linkerd CLI \u6765\u67e5\u770b emoji \u670d\u52a1\u7684\u8def\u7531 \uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz routes deploy/emoji -n emojivoto ROUTE SERVICE SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 POST /emojivoto.v1.EmojiService/FindByShortcode emoji-svc 100.00% 1.0rps 1ms 1ms 1ms POST /emojivoto.v1.EmojiService/ListAll emoji-svc 100.00% 1.0rps 1ms 1ms 1ms [DEFAULT] emoji-svc - - - - - \u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u4e3a emoji \u670d\u52a1\u5b9a\u4e49\u7684\u4e24\u6761\u8def\u7531\u90fd\u662f\u6210\u529f\u7684\uff0c\u5e76\u4e14\u5728 1ms \u7684\u65f6\u95f4\u5185\u5904\u7406\u4e86\u8bf7\u6c42\uff0c\u53ef\u4ee5\u770b\u51fa\u8fd9\u4e9b\u8def\u7531\u662f\u5065\u5eb7\u7684\u3002\u8fd8\u8981\u6ce8\u610f\u6211\u4eec\u7684\u9ed8\u8ba4\u8def\u7531\uff0c\u6807\u8bb0\u4e3a [DEFAULT]\uff0c\u540c\u6837\u8fd9\u662f Linkerd \u5728\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u4e0e\u8bf7\u6c42\u5339\u914d\u7684\u8def\u7531\u65f6\u4f7f\u7528\u7684\u8def\u7531\u3002 \u73b0\u5728\u6211\u4eec\u7528\u540c\u6837\u7684\u65b9\u5f0f\u901a\u8fc7 linkerd viz routes \u547d\u4ee4\u6765\u67e5\u770b voting \u548c web \u670d\u52a1\u7684\u8def\u7531\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz routes deploy/web -n emojivoto ROUTE SERVICE SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 GET /api/list web-svc 100.00% 1.0rps 1ms 1ms 1ms GET /api/vote web-svc 88.33% 1.0rps 2ms 7ms 9ms [DEFAULT] web-svc - - - - - $ linkerd viz routes deploy/voting -n emojivoto ROUTE SERVICE SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 Results voting-svc - - - - - Vote100 voting-svc 100.00% 0.0rps 1ms 1ms 1ms VoteBacon voting-svc - - - - - VoteBalloon voting-svc - - - - - # ...... voting \u670d\u52a1\u7684\u8f93\u51fa\u5f88\u957f\uff0c\u56e0\u4e3a\u5b83\u6709\u5f88\u591a\u8def\u7531\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7 grep \u547d\u4ee4\u6765\u67e5\u627e VoteDoughnut \u8def\u7531\uff1a linkerd viz routes deploy/voting -n emojivoto | grep VoteDoughnut \uff08\u6216\u8005\u53ef\u4ee5\u4f7f\u7528 -o json \u6807\u5fd7\u4ee5\u53ca jq \u4e4b\u7c7b\u7684\u5de5\u5177\u6765\u89e3\u6790\u8f93\u51fa\uff09\u3002 \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u529f\u80fd\uff0c\u76ee\u524d\u6211\u4eec\u6682\u65f6\u4e13\u6ce8\u4e8e\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u7684\u53ef\u89c2\u6d4b\u6027\u529f\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e4b\u524d\u4e86\u89e3\u7684\u6bcf\u4e2a\u8def\u7531\u7684\u9ec4\u91d1\u6307\u6807\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u8fdb\u4e00\u6b65\u6df1\u5165\u4e86\u89e3 ServiceProfile \u5e76\u63a2\u7d22 Linkerd \u7684\u91cd\u8bd5\u548c\u8d85\u65f6\u529f\u80fd\u3002 \u91cd\u8bd5\u4e0e\u8d85\u65f6 \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u6765\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 ServiceProfile \u914d\u7f6e\u8d85\u65f6\u3001\u91cd\u8bd5\u3002Linkerd \u53ef\u4ee5\u901a\u8fc7\u6d41\u91cf\u62c6\u5206\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u91cd\u8bd5\u548c\u8d85\u65f6\u7b49\u529f\u80fd\u6765\u786e\u4fdd\u53ef\u9760\u6027\uff0c\u8fd9\u4e9b\u4e2d\u7684\u6bcf\u4e00\u4e2a\u90fd\u5728\u63d0\u9ad8\u7cfb\u7edf\u7684\u6574\u4f53\u53ef\u9760\u6027\u65b9\u9762\u53d1\u6325\u7740\u91cd\u8981\u4f5c\u7528\u3002 \u4f46\u662f\u8fd9\u4e9b\u7279\u6027\u7a76\u7adf\u80fd\u589e\u52a0\u4ec0\u4e48\u6837\u7684\u53ef\u9760\u6027\u5462\uff1f\u5f52\u6839\u7ed3\u5e95\u662f Linkerd \u53ef\u4ee5\u5e2e\u52a9\u9632\u6b62\u77ac\u65f6\u6545\u969c\u3002\u5982\u679c\u670d\u52a1\u5b8c\u5168\u5173\u95ed\uff0c\u6216\u59cb\u7ec8\u8fd4\u56de\u5931\u8d25\uff0c\u6216\u59cb\u7ec8\u6302\u8d77\uff0c\u90a3\u4e48\u518d\u591a\u7684\u91cd\u8bd5\u6216\u8d1f\u8f7d\u5747\u8861\u90fd\u65e0\u6d4e\u4e8e\u4e8b\u3002 \u4f46\u662f\uff0c\u5982\u679c\u670d\u52a1\u7684\u4e00\u4e2a\u5b9e\u4f8b\u51fa\u73b0\u95ee\u9898\uff0c\u6216\u8005\u6f5c\u5728\u95ee\u9898\u53ea\u662f\u6682\u65f6\u7684\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019 Linkerd \u5c31\u53ef\u4ee5\u6d3e\u4e0a\u7528\u573a\u4e86\uff0c\u800c\u4e14\u8fd9\u4e9b\u90e8\u5206\u7684\u3001\u6682\u65f6\u7684\u6545\u969c\u662f\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u6700\u5e38\u51fa\u73b0\u7684\u95ee\u9898\uff01 \u5f53\u6d89\u53ca\u5230 Linkerd \u7684\u8d1f\u8f7d\u5747\u8861\u3001\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u6838\u5fc3\u53ef\u9760\u6027\u7279\u6027\u65f6\uff0c\u8fd9\u91cc\u6709\u4e24\u4ef6\u91cd\u8981\u7684\u4e8b\u60c5\u9700\u8981\u7406\u89e3\uff08\u6d41\u91cf\u5206\u5272\uff0c\u4e5f\u662f\u4e00\u4e2a\u53ef\u9760\u6027\u7279\u6027\uff0c\u4f46\u6709\u70b9\u4e0d\u592a\u4e00\u6837\uff0c\u6211\u4eec\u5c06\u5728\u540e\u9762\u7684\u7ae0\u8282\u4e2d\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff09\uff1a \u6240\u6709\u8fd9\u4e9b\u6280\u672f\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\uff1a\u8fdb\u884c\u8c03\u7528\u7684\u4ee3\u7406\u662f\u6267\u884c\u8fd9\u4e9b\u529f\u80fd\u7684\u4ee3\u7406\uff0c\u800c\u4e0d\u662f\u670d\u52a1\u5668\u7aef\u7684\u4ee3\u7406\u3002\u5982\u679c\u4f60\u7684\u670d\u52a1\u5668\u662f\u7f51\u683c\u7684\uff0c\u4f46\u4f60\u7684\u5ba2\u6237\u7aef\u4e0d\u662f\u7684\uff0c\u90a3\u4e48\u5c06\u4e0d\u4f1a\u5728\u4e24\u8005\u4e4b\u95f4\u7684\u8c03\u7528\u4e2d\u542f\u7528\u8fd9\u4e9b\u529f\u80fd\uff01 \u8fd9\u4e09\u4e2a\u7279\u6027\u4e00\u8d77\u4f7f\u7528\u6548\u679c\u6700\u597d\u3002\u6ca1\u6709\u91cd\u8bd5\uff0c\u8d85\u65f6\u6ca1\u6709\u4ec0\u4e48\u4ef7\u503c\uff1b\u5982\u679c\u6ca1\u6709\u8d1f\u8f7d\u5747\u8861\uff0c\u91cd\u8bd5\u51e0\u4e4e\u4e5f\u6ca1\u6709\u4ec0\u4e48\u4ef7\u503c\u3002 \u6211\u4eec\u53ef\u4ee5\u5148\u4e86\u89e3\u4e0b\u8d1f\u8f7d\u5747\u8861\uff0cLinkerd \u4f1a\u81ea\u52a8\u5728\u53ef\u80fd\u7684\u76ee\u7684\u5730\u4e4b\u95f4\u5bf9\u8bf7\u6c42\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u8bf7\u6ce8 \u610f\u8bf7 \u6c42\u8fd9\u4e2a\u8bcd - \u4e0e\u56db\u5c42\u6216 TCP \u8d1f\u8f7d\u5747\u8861\u4e0d\u540c\uff0c\u5b83\u4f1a\u5747\u8861\u8fde\u63a5\uff0cLinkerd \u5c06\u5efa\u7acb\u5230\u53ef\u80fd\u7684\u7aef\u70b9\u96c6\u7684\u8fde\u63a5\uff0c\u5e76\u5728\u6240\u6709\u8fd9\u4e9b\u8fde\u63a5\u4e4b\u95f4\u5747\u8861\u8bf7\u6c42\u3002\u8fd9\u5141\u8bb8\u5bf9\u6d41\u91cf\u8fdb\u884c\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u5e76\u4e14\u5728\u540e\u53f0\uff0cLinkerd \u7684\u65b9\u6cd5\u975e\u5e38\u590d\u6742\uff0c \u4f7f\u7528\u8bf8\u5982\u670d\u52a1\u5668\u5ef6\u8fdf\u7684\u6307\u6570\u52a0\u6743\u79fb\u52a8\u5e73\u5747\uff08EWMA\uff09 \u4e4b\u7c7b\u7684\u6280\u672f\u6765\u4f18\u5316\u8bf7\u6c42\u7684\u53bb\u5411\uff1b\u5c3d\u53ef\u80fd\u8de8\u7aef\u70b9\u6c47\u96c6\u8fde\u63a5\uff1b\u5e76\u81ea\u52a8\u5c06 HTTP/1.1 \u6d41\u91cf\u5347\u7ea7\u5230\u4ee3\u7406\u4e4b\u95f4\u7684 HTTP/2 \u8fde\u63a5\u3002\u7136\u800c\uff0c\u4ece\u6211\u4eec\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5e76\u6ca1\u6709\u8fdb\u884c\u4efb\u4f55\u914d\u7f6e\uff0c\u53ea\u9700\u8981\u77e5\u9053\uff1a Linkerd \u4f1a\u81ea\u52a8\u5728\u5176\u7aef\u70b9\u4e4b\u95f4\u5e73\u8861\u8bf7\u6c42 \u3002 \u63a5\u7740\u770b\u770b\u8d85\u65f6\uff0c\u8d85\u65f6\u662f\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u6700\u957f\u65f6\u95f4\u7684\u4e00\u79cd\u65b9\u5f0f\u3002\u6bd4\u5982\u4f60\u7684\u670d\u52a1\u4e0a\u6709\u4e00\u4e2a\u540d\u4e3a getValue() \u7684\u8def\u7531\uff0c\u800c getValue() \u7684\u6027\u80fd\u662f\u4e0d\u53ef\u9884\u6d4b\u7684\uff1a\u5927\u591a\u6570\u65f6\u5019 getValue() \u4f1a\u5728 10 \u6beb\u79d2\u5185\u8fd4\u56de\uff0c\u4f46\u6709\u65f6\u9700\u8981 10 \u5206\u949f\u624d\u80fd\u8fd4\u56de\uff0c\u4e5f\u8bb8\u662f\u5728\u67d0\u4e9b\u6709\u4e89\u8bae\u7684\u8d44\u6e90\u4e0a\u5b58\u5728\u9501\u7ade\u4e89\u3002\u5982\u679c\u6ca1\u6709\u8d85\u65f6\uff0c\u8c03\u7528 getValue() \u5c06\u9700\u8981 10 \u6beb\u79d2\u5230 10 \u5206\u949f\u4e4b\u95f4\u7684\u4efb\u4f55\u65f6\u95f4\uff0c\u4f46\u662f\u5982\u679c\u8bbe\u7f6e\u4e86 500 \u6beb\u79d2\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u90a3\u4e48 getValue() \u5219\u6700\u591a\u9700\u8981 500 \u6beb\u79d2\u3002 \u6dfb\u52a0\u8d85\u65f6\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u79cd\u673a\u5236\u6765\u9650\u5236\u7cfb\u7edf\u7684\u6700\u574f\u60c5\u51b5\u5ef6\u8fdf\uff0c\u5b83\u5141\u8bb8 getValue() \u7684\u8c03\u7528\u8005\u5177\u6709\u66f4\u53ef\u9884\u6d4b\u7684\u6027\u80fd\uff0c\u5e76\u4e14\u4e0d\u4f1a\u5360\u7528\u7b49\u5f85 10 \u5206\u949f\u957f\u7684\u8c03\u7528\u8fd4\u56de\u7684\u8d44\u6e90\u3002\u5176\u6b21\uff0c\u66f4\u91cd\u8981\u7684\u662f\uff0c\u8d85\u65f6\u53ef\u4ee5\u4e0e\u91cd\u8bd5\u548c\u8d1f\u8f7d\u5747\u8861\u76f8\u7ed3\u5408\uff0c\u4ee5\u81ea\u52a8\u5c06\u8bf7\u6c42\u91cd\u65b0\u53d1\u9001\u5230\u670d\u52a1\u7684\u4e0d\u540c\u5b9e\u4f8b\u3002 \u5982\u679c getValue() \u5728\u5b9e\u4f8b A \u4e0a\u5f88\u6162\uff0c\u5728\u5b9e\u4f8b B \u6216 C \u4e0a\u53ef\u80fd\u4f1a\u5f88\u5feb\uff0c\u751a\u81f3\u591a\u6b21\u91cd\u8bd5\u4e5f\u5c06\u8fdc\u8fdc\u5c11\u4e8e\u7b49\u5f85 10 \u5206\u949f\u3002 \u6240\u4ee5\u6211\u4eec\u518d\u6765\u770b\u770b\u91cd\u8bd5\uff0c\u91cd\u8bd5\u662f\u6307 Linkerd \u81ea\u52a8\u91cd\u8bd5\u8bf7\u6c42\u3002\u8fd9\u4f1a\u5728\u4ec0\u4e48\u573a\u666f\u4e0b\u6709\u7528\u5462\uff1f\u540c\u6837\u7531\u4e8e\u67d0\u4e9b\u4e34\u65f6\u9519\u8bef\uff1a \u5982\u679c\u7279\u5b9a\u5b9e\u4f8b\u4e0a\u7684\u7279\u5b9a\u8def\u7531\u8fd4\u56de\u9519\u8bef\uff0c\u5e76\u4e14\u7b80\u5355\u5730\u91cd\u8bd5\u8be5\u8bf7\u6c42\u53ef\u80fd\u4f1a\u5bfc\u81f4\u54cd\u5e94\u6210\u529f\uff0c\u5f53\u7136\u91cd\u8981\u7684\u662f\u8981\u610f\u8bc6\u5230\u7b80\u5355\u5730\u91cd\u8bd5\u8bf7\u6c42\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u6210\u529f\u54cd\u5e94\u3002\u5982\u679c\u5e95\u5c42\u9519\u8bef\u4e0d\u662f\u6682\u65f6\u7684\uff0c\u6216\u8005\u5982\u679c Linkerd \u65e0\u6cd5\u91cd\u8bd5\uff0c\u90a3\u4e48\u5e94\u7528\u7a0b\u5e8f\u4ecd\u7136\u9700\u8981\u5904\u7406\u8fd9\u4e9b\u9519\u8bef\u3002 \u5728\u5b9e\u8df5\u4e2d\uff0c\u5b9e\u73b0\u91cd\u8bd5\u53ef\u80fd\u4f1a\u5f88\u9ebb\u70e6\u3002\u5982\u679c\u60f3\u5f53\u7136\u7684\u505a\u4e5f\u662f\u4f1a\u6709\u4e00\u5b9a\u98ce\u9669\u7684\uff0c\u53ef\u80fd\u4f1a\u7ed9\u7cfb\u7edf\u589e\u52a0\u989d\u5916\u7684\u8d1f\u8f7d\uff0c\u8fd9\u4e2a\u8d1f\u8f7d\u53ef\u80fd\u4f1a\u8ba9\u4e8b\u60c5\u53d8\u5f97\u66f4\u7cdf\u7cd5\u3002 \u4e00\u79cd\u5e38\u89c1\u7684\u6545\u969c\u573a\u666f\u5c31\u662f \u91cd\u8bd5\u98ce\u66b4 \uff1a \u670d\u52a1 A \u4e2d\u7684\u77ac\u65f6\u6545\u969c\u89e6\u53d1 B \u5bf9\u5b83\u8bf7\u6c42\u7684\u91cd\u8bd5\uff1b \u8fd9\u4e9b\u91cd\u8bd5\u5bfc\u81f4 A \u8fc7\u8f7d\uff0c\u8fd9\u610f\u5473\u7740 B \u5f00\u59cb\u5931\u8d25\u7684\u8bf7\u6c42\uff1b \u8fd9\u4f1a\u89e6\u53d1\u5176\u8c03\u7528\u8005 C \u5bf9 B \u7684\u91cd\u8bd5\uff0c\u7136\u540e\u5bfc\u81f4 B \u8fc7\u8f7d\uff0c\u4f9d\u6b64\u7c7b\u63a8\u3002\u5bf9\u4e8e\u5141\u8bb8\u4f60\u914d\u7f6e\u6bcf\u4e2a\u8bf7\u6c42\u7684\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u7684\u7cfb\u7edf\u5c24\u5176\u5982\u6b64\uff1a \u6bcf\u4e2a\u8bf7\u6c42\u6700\u591a\u91cd\u8bd5 3 \u6b21\u542c\u8d77\u6765\u53ef\u80fd\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46\u5728\u6700\u574f\u7684\u60c5\u51b5\u4e0b\u4f1a\u589e\u52a0 300% \u7684\u8d1f\u8f7d\u3002 Linkerd \u901a\u8fc7\u4f7f\u7528 \u91cd\u8bd5\u9884\u7b97 \u800c\u4e0d\u662f\u6bcf\u4e2a\u8bf7\u6c42\u7684\u9650\u5236\u6765\u8bbe\u7f6e\u91cd\u8bd5\u7684\u53c2\u6570\uff0c\u5c06\u91cd\u8bd5\u98ce\u66b4\u7684\u53ef\u80fd\u6027\u964d\u5230\u6700\u4f4e\u3002 \u91cd\u8bd5\u9884\u7b97\u662f\u53ef\u4ee5\u91cd\u8bd5\u7684\u8bf7\u6c42\u603b\u6570\u7684\u767e\u5206\u6bd4\uff0cLinkerd \u7684\u9ed8\u8ba4\u884c\u4e3a\u662f\u5141\u8bb8\u5bf9\u5931\u8d25\u7684\u8bf7\u6c42\u8fdb\u884c 20% (200) \u6b21\u91cd\u8bd5\uff0c\u518d\u52a0\u4e0a\u6bcf\u79d2\u989d\u5916\u7684 10 \u4e2a\u8bf7\u6c42\u3002\u4f8b\u5982\uff0c\u5982\u679c\u539f\u59cb\u8bf7\u6c42\u8d1f\u8f7d\u662f\u6bcf\u79d2 1000 \u4e2a\u8bf7\u6c42\uff0c\u90a3\u4e48 Linkerd \u5c06\u5141\u8bb8\u6bcf\u79d2\u91cd\u8bd5 210 \u4e2a\u8bf7\u6c42\u3002\u5f53\u9884\u7b97\u7528\u5c3d\u65f6\uff0cLinkerd \u4e0d\u4f1a\u91cd\u8bd5\u8bf7\u6c42\uff0c\u800c\u662f\u4f1a\u5411\u5ba2\u6237\u7aef\u8fd4\u56de 504 \u9519\u8bef\u3002 \u7efc\u4e0a\u6240\u8ff0\uff1a\u8d1f\u8f7d\u5747\u8861\u3001\u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u662f\u4e3a\u4e86\u5728\u51fa\u73b0\u90e8\u5206\u3001\u6682\u65f6\u6027\u6545\u969c\u7684\u60c5\u51b5\u4e0b\u4fdd\u969c\u5e94\u7528\u7a0b\u5e8f\u7684\u53ef\u9760\u6027\uff0c\u5e76\u9632\u6b62\u8fd9\u4e9b\u6545\u969c\u5347\u7ea7\u4e3a\u5168\u5c40\u4e2d\u65ad\u3002\u4f46\u5b83\u4eec\u5e76\u4e0d\u662f\u7075\u4e39\u5999\u836f\uff0c\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5fc5\u987b\u4ecd\u7136\u80fd\u591f\u5904\u7406\u9519\u8bef\u3002 \u4f7f\u7528 Per-Route Metrics \u6765\u786e\u5b9a\u4f55\u65f6\u91cd\u8bd5\u548c\u8d85\u65f6 \u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u5728 Linkerd \u4e2d\u4f7f\u7528\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u539f\u56e0\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u5728\u524d\u9762\u4e86\u89e3\u7684\u53ef\u89c2\u6d4b\u6027\u529f\u80fd\u7684\u57fa\u7840\u4e0a\uff0c\u4f7f\u7528\u6307\u6807\u6765\u505a\u6709\u5173\u5e94\u7528\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u51b3\u7b56\u3002 \u9996\u5148\uff0c\u6211\u4eec\u5c06\u67e5\u770b emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u6240\u6709 Deployments \u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u7136\u540e\u6211\u4eec\u518d\u6df1\u5165\u7814\u7a76\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u3002 \u76f4\u63a5\u4f7f\u7528 linkerd viz stat \u547d\u4ee4\u5373\u53ef\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz stat deploy -n emojivoto NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji 1/1 100.00% 2.3rps 1ms 1ms 4ms 3 vote-bot 1/1 100.00% 0.3rps 1ms 2ms 2ms 1 voting 1/1 87.01% 1.3rps 1ms 7ms 9ms 3 web 1/1 91.91% 2.3rps 1ms 10ms 28ms 3 stat \u547d\u4ee4\u5411\u6211\u4eec\u5c55\u793a\u4e86\u9ec4\u91d1\u6307\u6807\uff0c\u5305\u62ec\u6210\u529f\u7387\u548c\u5ef6\u8fdf\uff0c\u6211\u4eec\u53ef\u4ee5\u6ce8\u610f\u5230 voting \u548c web \u670d\u52a1\u7684\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c \u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 linkerd viz edges \u547d\u4ee4\u6765\u4e86\u89e3\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb \u3002 $ linkerd viz edges deploy -n emojivoto SRC DST SRC_NS DST_NS SECURED vote-bot web emojivoto emojivoto \u221a web emoji emojivoto emojivoto \u221a web voting emojivoto emojivoto \u221a prometheus emoji linkerd-viz emojivoto \u221a prometheus vote-bot linkerd-viz emojivoto \u221a prometheus voting linkerd-viz emojivoto \u221a prometheus web linkerd-viz emojivoto \u221a \u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7 Linkerd Dashboard \u6765\u67e5\u770b\u7ae0\u9c7c\u56fe\u53bb\u4e86\u89e3\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb\u3002 \u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa web \u670d\u52a1\u4e2d\u7684 Pods \u5bf9 voting \u670d\u52a1\u7684 Pods \u8fdb\u884c\u4e86\u8c03\u7528\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u731c\u6d4b\u662f voting \u670d\u52a1\u5bfc\u81f4\u4e86 web \u670d\u52a1\u7684\u9519\u8bef\uff0c\u5f53\u7136\u8fd9\u8fd8\u6ca1\u7ed3\u675f\uff0c\u8fd8\u8bb0\u5f97\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u7684 ServiceProfile \u6587\u4ef6\u5417\uff1f \u6211\u4eec\u6709\u6bcf\u6761\u8def\u7531\u7684\u6307\u6807\uff0c\u5e94\u8be5\u80fd\u591f\u51c6\u786e\u5730\u770b\u5230\u54ea\u4e9b\u8def\u7531\u7684\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u53ef\u4ee5\u901a\u8fc7 linkerd viz routes \u547d\u4ee4\u53bb\u4e86\u89e3 voting \u670d\u52a1\u7684\u8def\u7531\u6307\u6807\u60c5\u51b5\uff0c\u5982\u4e0b\u547d\u4ee4\u6240\u793a\uff1a $ linkerd viz routes deploy/voting -n emojivoto # ...... VoteDog voting-svc - - - - - VoteDoughnut voting-svc 0.00% 0.1rps 1ms 1ms 1ms VoteFax voting-svc - - - - - VoteFire voting-svc 100.00% 0.0rps 1ms 1ms 1ms VoteFlightDeparture voting-svc - - - - - # ...... \u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Linkerd Dashboard \u53bb\u67e5\u770b voting \u670d\u52a1\u7684 ROUTE METRICS \u4fe1\u606f \uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u6700\u7ec8\u6211\u4eec\u53ef\u4ee5\u5b9a\u4f4d\u5230\u662f VoteDoughnut \u8fd9\u6761\u662f\u8bf7\u6c42\u5931\u8d25\u7684\u8def\u7531\u3002 \u73b0\u5728\u6211\u4eec\u4e0d\u4ec5\u77e5\u9053 web \u670d\u52a1\u548c voting \u670d\u52a1\u4e4b\u95f4\u53d1\u751f\u4e86\u9519\u8bef\uff0c\u800c\u4e14\u4e5f\u77e5\u9053\u4e86 VoteDoughnut \u8def\u7531\u53d1\u751f\u4e86\u9519\u8bef\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u91cd\u8bd5\u6765\u5c1d\u8bd5\u89e3\u51b3\u9519\u8bef\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u8981\u6c42\u5f00\u53d1\u4eba\u5458\u8fdb\u884c\u4ee3\u7801\u8c03\u8bd5\u3002 \u914d\u7f6e\u91cd\u8bd5 \u5728\u6211\u4eec\u5f00\u59cb\u4e3a VotingDoughnut \u8def\u7531\u914d\u7f6e\u91cd\u8bd5\u4e4b\u524d\uff0c\u6211\u4eec\u5fc5\u987b\u9996\u5148\u4ed4\u7ec6\u67e5\u770b web \u548c voting \u670d\u52a1\u7684\u6307\u6807\uff0c\u56e0\u4e3a\u8fd9\u5c06\u5e2e\u52a9\u6211\u4eec\u771f\u6b63\u4e86\u89e3\u5e94\u7528\u91cd\u8bd5\u662f\u5426\u53ef\u4ee5\u89e3\u51b3\u95ee\u9898\u3002 \u8fd9\u91cc\u6211\u4eec\u5c06\u53ea\u4f7f\u7528 Linkerd CLI \uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u7528\u901a\u8fc7\u4f7f\u7528 -o wide \u6807\u5fd7\u5411\u6211\u4eec\u663e\u793a\u5b9e\u9645\u548c\u6709\u6548\u7684\u8bf7\u6c42\u91cf\u548c\u6210\u529f\u7387\uff0c Linkerd \u4eea\u8868\u76d8\u4f1a\u663e\u793a\u6574\u4f53\u6210\u529f\u7387\u548c RPS\uff0c\u4f46\u4e0d\u663e\u793a\u5b9e\u9645\u548c\u6709\u6548\u7684\u6307\u6807 \u3002\u5b9e\u9645\u6307\u6807\u548c\u6709\u6548\u6307\u6807\u4e4b\u95f4\u7684\u533a\u522b\u662f\uff1a \u5b9e\u9645\u503c\u6765\u81ea\u63a5\u6536\u8bf7\u6c42\u7684\u670d\u52a1\u5668\u7684\u89d2\u5ea6 \u6709\u6548\u503c\u662f\u4ece\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef\u7684\u89d2\u5ea6\u6765\u770b\u7684 \u5728\u6ca1\u6709\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u60c5\u51b5\u4e0b\uff0c\u663e\u7136\u8fd9\u4e24\u4e2a\u6570\u636e\u662f\u76f8\u540c\u7684\u3002\u4f46\u662f\uff0c\u4e00\u65e6\u914d\u7f6e\u4e86\u91cd\u8bd5\u6216\u8d85\u65f6\uff0c\u5b83\u4eec\u5c31\u53ef\u80fd\u4f1a\u4e0d\u4e00\u6837\u4e86\u3002\u4f8b\u5982\uff0c\u91cd\u8bd5\u4f1a\u4f7f\u5b9e\u9645\u7684 RPS \u9ad8\u4e8e\u6709\u6548\u7684 RPS\uff0c\u56e0\u4e3a\u4ece\u670d\u52a1\u5668\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u91cd\u8bd5\u662f\u53e6\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f46\u4ece\u5ba2\u6237\u7aef\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5b83\u662f\u540c\u4e00\u4e2a\u8bf7\u6c42\u3002\u91cd\u8bd5\u53ef\u4ee5\u4f7f\u5b9e\u9645\u6210\u529f\u7387\u4f4e\u4e8e\u6709\u6548\u6210\u529f\u7387\uff0c\u56e0\u4e3a\u5931\u8d25\u7684\u91cd\u8bd5\u8c03\u7528\u4e5f\u53d1\u751f\u5728\u670d\u52a1\u5668\u4e0a\uff0c\u4f46\u4e0d\u4f1a\u66b4\u9732\u7ed9\u5ba2\u6237\u7aef\u3002\u800c\u8d85\u65f6\u53ef\u80fd\u4f1a\u4ea7\u751f\u76f8\u53cd\u7684\u6548\u679c\uff1a\u8fd9\u53d6\u51b3\u4e8e\u5177\u4f53\u7684\u8fd4\u56de\u65f6\u95f4\uff0c\u4e00\u4e2a\u6700\u7ec8\u6210\u529f\u8fd4\u56de\u7684\u8d85\u65f6\u8bf7\u6c42\u53ef\u80fd\u4f1a\u4f7f\u5b9e\u9645\u6210\u529f\u7387\u9ad8\u4e8e\u6709\u6548\u6210\u529f\u7387\uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u5c06\u5176\u89c6\u4e3a\u6210\u529f\uff0c\u800c\u5ba2\u6237\u7aef\u53ea\u770b\u5230\u5931\u8d25\u3002 \u603b\u7684\u6765\u8bf4\u5c31\u662f Linkerd \u7684\u5b9e\u9645\u548c\u6709\u6548\u6307\u6807\u5728\u91cd\u8bd5\u6216\u8d85\u65f6\u7684\u60c5\u51b5\u4e0b\u53ef\u80fd\u4f1a\u6709\u6240\u4e0d\u540c\uff0c\u4f46\u5b9e\u9645\u6570\u5b57\u4ee3\u8868\u5b9e\u9645\u547d\u4e2d\u670d\u52a1\u5668\u7684\u60c5\u51b5\uff0c\u800c\u6709\u6548\u6570\u5b57\u4ee3\u8868\u4e86\u5728 Linkerd \u7684\u53ef\u9760\u6027\u903b\u8f91\u5b8c\u6210\u5176\u804c\u8d23\u540e\uff0c\u5ba2\u6237\u7aef\u6709\u6548\u5730\u5f97\u5230\u4e86\u5bf9\u5176\u8bf7\u6c42\u7684\u54cd\u5e94\u3002 \u6bd4\u5982\u6211\u4eec\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b vote-bot \u670d\u52a1\u7684\u8def\u7531\u6307\u6807\u60c5\u51b5 $ linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -owide ROUTE SERVICE EFFECTIVE_SUCCESS EFFECTIVE_RPS ACTUAL_SUCCESS ACTUAL_RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 GET /api/list web-svc 100.00% 1.0rps 100.00% 1.0rps 1ms 2ms 2ms GET /api/vote web-svc 86.21% 1.0rps 86.21% 1.0rps 2ms 7ms 10ms [DEFAULT] web-svc - - - - - - - \u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a -o wide \u7684\u6807\u5fd7\uff0c\u8fd9\u6837\u8f93\u51fa\u7ed3\u679c\u4f1a\u5305\u542b\u5b9e\u9645\u548c\u6709\u6548\u7684\u6210\u529f\u548c RPS \u6307\u6807\u3002 \u4ece vote-bot \u670d\u52a1\u6765\u770b\uff0cweb \u670d\u52a1\u7684 /api/vote \u8def\u7531\u7684\u6709\u6548\u6210\u529f\u7387\u548c\u5b9e\u9645\u6210\u529f\u7387\u90fd\u4f4e\u4e8e 100%\uff0c\u8fd9\u662f\u56e0\u4e3a\u73b0\u5728\u6211\u4eec\u8fd8\u6ca1\u6709\u914d\u7f6e\u91cd\u8bd5\u3002 \u800c\u4e14\u6211\u4eec\u4e0d\u80fd\u5047\u8bbe\u6240\u6709\u8bf7\u6c42\u90fd\u662f\u53ef\u91cd\u8bd5\u7684\uff0c\u91cd\u8bd5\u8bf7\u6c42\u5bf9\u4e8e Linkerd \u6765\u8bf4\uff0c\u662f\u6709\u975e\u5e38\u5177\u4f53\u7684\u6761\u4ef6\u7684\uff1a \u73b0\u5728\uff0c\u4f7f\u7528 HTTP POST \u65b9\u6cd5\u7684\u8bf7\u6c42\u5728 Linkerd \u4e2d\u4e0d\u53ef\u91cd\u8bd5\u3002\u56e0\u4e3a POST \u8bf7\u6c42\u51e0\u4e4e\u603b\u662f\u5728\u8bf7\u6c42 body \u4e2d\u5305\u542b\u6570\u636e\uff0c\u91cd\u8bd5\u8bf7\u6c42\u610f\u5473\u7740\u4ee3\u7406\u5fc5\u987b\u5c06\u8be5\u6570\u636e\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u4fdd\u6301\u6700\u5c0f\u7684\u5185\u5b58\u4f7f\u7528\uff0c\u4ee3\u7406\u4e0d\u5b58\u50a8 POST \u8bf7\u6c42 body\uff0c\u5e76\u4e14\u5b83\u4eec\u4e0d\u80fd\u88ab\u91cd\u8bd5\u3002 \u6b63\u5982\u6211\u4eec\u524d\u9762\u63d0\u5230\u8fc7\u7684\uff0cLinkerd \u4ec5\u5c06\u54cd\u5e94\u4e2d\u7684 5XX \u72b6\u6001\u7801\u89c6\u4e3a\u9519\u8bef\uff0c\u800c 2XX \u548c 4XX \u90fd\u88ab\u8bc6\u522b\u4e3a\u6210\u529f\u72b6\u6001\u7801\u30024XX \u72b6\u6001\u7801\u8868\u793a\u670d\u52a1\u5668\u67e5\u770b\u4f46\u627e\u4e0d\u5230\u8d44\u6e90\uff0c\u8fd9\u5c5e\u4e8e\u670d\u52a1\u5668\u7684\u6b63\u786e\u884c\u4e3a\uff0c\u800c 5XX \u72b6\u6001\u7801\u8868\u793a\u670d\u52a1\u5668\u5728\u5904\u7406\u8bf7\u6c42\u65f6\u9047\u5230\u4e86\u9519\u8bef\uff0c\u8fd9\u662f\u4e0d\u6b63\u786e\u7684\u884c\u4e3a\u3002 \u73b0\u5728\u6211\u4eec\u901a\u8fc7\u5728 web \u670d\u52a1\u7684 /api/vote \u8def\u7531\u4e2d\u6dfb\u52a0\u91cd\u8bd5\u529f\u80fd\u6765\u9a8c\u8bc1\u4e0b\u524d\u9762\u7684\u77e5\u8bc6\u3002\u6211\u4eec\u518d\u6b21\u67e5\u770b\u4e0b web \u670d\u52a1\u7684 ServiceProfile \u5bf9\u8c61\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a # web-sp.yaml apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: name: web-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: routes: - condition: method: GET pathRegex: /api/list name: GET /api/list - condition: method: GET pathRegex: /api/vote name: GET /api/vote \u63a5\u7740\u6211\u4eec\u4e3a\u8def\u7531 /api/vote \u589e\u52a0\u4e00\u4e2a isRetryable: true \u7684\u5c5e\u6027\uff0c\u5982\u4e0b\u6240\u793a\uff1a # web-sp-with-retry.yaml # ...... - condition: method: GET pathRegex: /api/vote name: GET /api/vote isRetryable: true \u66f4\u65b0\u540e\u91cd\u65b0\u5e94\u7528\u8be5 ServiceProfile \u5bf9\u8c61\uff1a $ kubectl apply -f web-sp-with-retry.yaml \u5e94\u7528\u540e\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf vote-bot \u670d\u52a1\u7684\u8def\u7531\u6307\u6807\u53d8\u5316\u60c5\u51b5\uff1a $ watch linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide Every 2.0s: linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide MBP2022.local: Sun Aug 28 17:41:37 2022 ROUTE SERVICE EFFECTIVE_SUCCESS EFFECTIVE_RPS ACTUAL_SUCCESS ACTUAL_RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 GET /api/list web-svc 100.00% 1.0rps 100.00% 1.0rps 2ms 8ms 10ms GET /api/vote web-svc 85.00% 1.0rps 16.50% 5.0rps 4ms 255ms 290ms [DEFAULT] web-svc - - - - - - - \u53ef\u4ee5\u770b\u5230\u5b9e\u9645\u6210\u529f\u7387\u53d8\u5f97\u975e\u5e38\u5e95\u4e86\uff0c\u56e0\u4e3a\u91cd\u8bd5\u7684\u7ed3\u679c\u53ef\u80fd\u8fd8\u662f\u9519\u8bef\u3002 \u4e0a\u9762\u6211\u4eec\u63d0\u5230\u4e86 Linkerd \u7684\u91cd\u8bd5\u884c\u4e3a\u662f\u7531\u91cd\u8bd5\u9884\u7b97\u914d\u7f6e\u7684\uff0c\u5f53\u914d\u7f6e isRetryable: true \u7684\u65f6\u5019\uff0c\u4f1a\u5e94\u7528\u9ed8\u8ba4\u7684\u91cd\u8bd5\u9884\u7b97\u89c4\u5219\uff0c \u4ee5\u4e0b ServiceProfile \u8d44\u6e90\u7684 YAML \u7247\u6bb5\uff0c\u663e\u793a\u4e86\u5177\u6709\u9ed8\u8ba4\u503c\u7684 retryBudget \u5bf9\u8c61\u914d\u7f6e \uff1a spec: retryBudget: retryRatio: 0.2 minRetriesPerSecond: 10 ttl: 10s \u5176\u4e2d retryBudget \u53c2\u6570\u662f\u5177\u6709\u4e09\u4e2a\u4e3b\u8981\u7684\u5b57\u6bb5\uff1a retryRatio\uff1a\u91cd\u8bd5\u7387\uff0c\u8868\u793a\u91cd\u8bd5\u8bf7\u6c42\u4e0e\u539f\u59cb\u8bf7\u6c42\u7684\u6700\u5927\u6bd4\u7387\uff0cretryRatio \u4e3a 0.2 \u8868\u793a\u91cd\u8bd5\u6700\u591a\u4f1a\u589e\u52a0 20% \u7684\u8bf7\u6c42\u8d1f\u8f7d\u3002 minRetriesPerSecond\uff1a\u8fd9\u662f\u5728 retryRatio \u5141\u8bb8\u7684\u91cd\u8bd5\u4e4b\u5916\uff0c\u6bcf\u79d2\u5141\u8bb8\u7684\u91cd\u8bd5\u6b21\u6570\uff08\u8fd9\u5141\u8bb8\u5728\u8bf7\u6c42\u7387\u5f88\u4f4e\u65f6\u8fdb\u884c\u91cd\u8bd5\uff09\uff0c\u9ed8\u8ba4\u4e3a 10 RPS\u3002 ttl\uff1a\u8868\u793a\u5728\u8ba1\u7b97\u91cd\u8bd5\u7387\u65f6\u5e94\u8003\u8651\u591a\u957f\u65f6\u95f4\u7684\u8bf7\u6c42\uff0c\u4e00\u4e2a\u8f83\u5927\u7684\u503c\u4f1a\u8003\u8651\u4e00\u4e2a\u8f83\u5927\u7684\u7a97\u53e3\uff0c\u56e0\u6b64\u5141\u8bb8\u66f4\u591a\u7684\u91cd\u8bd5\u3002\u9ed8\u8ba4\u4e3a 10 \u79d2\u3002 \u914d\u7f6e\u8d85\u65f6 \u9664\u4e86\u91cd\u8bd5\u548c\u91cd\u8bd5\u9884\u7b97\u5916\uff0cLinkerd \u8fd8\u63d0\u4f9b\u8d85\u65f6\u529f\u80fd\uff0c\u5141\u8bb8\u4f60\u786e\u4fdd\u5bf9\u6307\u5b9a\u8def\u7531\u7684\u8bf7\u6c42\u6c38\u8fdc\u4e0d\u4f1a\u8d85\u8fc7\u6307\u5b9a\u7684\u65f6\u95f4\u3002 \u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e00\u70b9\uff0c\u8ba9\u6211\u4eec\u91cd\u65b0\u6765\u770b\u4e00\u770b web \u548c voting \u670d\u52a1\u7684\u6bcf\u4e2a\u8def\u7531\u6307\u6807\u3002 $ linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide $ linkerd viz routes deploy/web -n emojivoto --to deploy/voting -o wide \u5728\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u5230 web \u548c voting \u4e4b\u95f4\u7684\u5ef6\u8fdf\u63a5\u8fd1 1ms\uff0c\u4e3a\u4e86\u6f14\u793a\u8d85\u65f6\uff0c\u6211\u4eec\u5c06 /api/vote \u8def\u7531\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a 0.5ms\uff0c\u8fd9\u6837\u57fa\u672c\u4e0a\u90fd\u65e0\u6cd5\u6ee1\u8db3\u8981\u6c42\u5c31\u8d85\u65f6\u4e86\uff0cLinkerd \u4f1a\u5c06\u9519\u8bef\u53d1\u9001\u4f1a\u5ba2\u6237\u7aef\uff0c\u6210\u529f\u7387\u53d8\u4e3a 0 \u4e86\u3002 \u4fee\u6539 web \u670d\u52a1\u7684 ServiceProfile \u5bf9\u8c61\uff0c\u6dfb\u52a0 timeout \u5c5e\u6027\uff0c\u5982\u4e0b\u6240\u793a\uff1a # web-sp-with-timeout.yaml apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: name: web-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: routes: - condition: method: GET pathRegex: /api/list name: GET /api/list - condition: method: GET pathRegex: /api/vote name: GET /api/vote timeout: 0.5ms isRetryable: true \u5e94\u7528\u4e0a\u9762\u7684\u5bf9\u8c61\u540e\uff0c\u670d\u52a1\u7684\u6709\u6548\u548c\u5b9e\u9645\u6210\u529f\u7387\u5c31\u4f1a\u90fd\u4e0b\u964d\u5230 0\uff0c\u56e0\u4e3a /api/vote \u5728 0.5ms \u5185\u90fd\u4f1a\u8d85\u65f6\uff0c\u6240\u4ee5\u6210\u529f\u7387\u53d8\u4e3a 0\u3002 $ watch linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide Every 2.0s: linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide MBP2022.local: Sun Aug 28 19:12:15 2022 ROUTE SERVICE EFFECTIVE_SUCCESS EFFECTIVE_RPS ACTUAL_SUCCESS ACTUAL_RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 GET /api/list web-svc 100.00% 1.0rps 100.00% 1.0rps 2ms 2ms 2ms GET /api/vote web-svc 0.00% 1.0rps 0.00% 0.0rps 0ms 0ms 0ms [DEFAULT] web-svc \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u4e2d\u91cd\u8bd5\u548c\u8d85\u65f6\u4f7f\u7528\uff0c\u91cd\u8bd5\u548c\u8d85\u65f6\u662f Linkerd \u6574\u4f53\u7b56\u7565\u7684\u4e00\u90e8\u5206\uff0c\u7528\u4e8e\u5728\u51fa\u73b0\u77ac\u65f6\u6545\u969c\u65f6\u589e\u52a0\u53ef\u9760\u6027\u3002 \u6211\u4eec\u901a\u8fc7\u4f7f\u7528\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u6bcf\u6761\u8def\u7531\u6307\u6807\u6765\u51b3\u5b9a\u4f55\u65f6\u4ee5\u53ca\u5982\u4f55\u914d\u7f6e\u91cd\u8bd5\u548c\u8d85\u65f6\u3002Linkerd \u7528\u91cd\u8bd5\u9884\u7b97\u4e3a\u5176\u91cd\u8bd5\u63d0\u4f9b\u53c2\u6570\uff0c\u53ef\u4ee5\u907f\u514d\u51fa\u73b0\"\u91cd\u8bd5\u98ce\u66b4\"\u7684\u60c5\u51b5\uff0c\u5f53\u91cd\u8bd5\u9884\u7b97\u7528\u5b8c\u65f6\uff0c\u4ee3\u7406\u5c06\u505c\u6b62\u5411\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\uff0c\u4ee5\u907f\u514d\u670d\u52a1\u8fc7\u8f7d\uff0c\u5e76\u53ef\u80fd\u5f71\u54cd\u5230\u5e94\u7528\u7a0b\u5e8f\u7684\u5176\u4ed6\u90e8\u5206\u3002","title":"3 Linkerd \u901a\u8fc7 ServiceProfile \u5b9e\u73b0\u8d85\u65f6\u548c\u91cd\u8bd5"},{"location":"chap11/3linkered_ServiceProfile/#3-linkerd-serviceprofile","text":"Linkerd \u670d\u52a1\u7f51\u683c\u89e3\u51b3\u7684\u6700\u91cd\u8981\u95ee\u9898\u4e4b\u4e00\u662f\u53ef\u89c2\u5bdf\u6027\uff1a\u63d0\u4f9b\u670d\u52a1\u884c\u4e3a\u7684\u8be6\u7ec6\u89c6\u56fe\uff0c Linkerd \u5bf9\u53ef\u89c2\u5bdf\u6027\u7684\u4ef7\u503c\u4e3b\u5f20\u662f\uff0c\u5b83\u53ef\u4ee5\u4e3a\u4f60\u7684 HTTP \u548c gRPC \u670d\u52a1\u63d0\u4f9b\u9ec4\u91d1\u6307\u6807\uff0c\u8fd9\u4e9b\u90fd\u662f\u81ea\u52a8\u6267\u884c\uff0c\u65e0\u9700\u66f4\u6539\u4ee3\u7801\u6216\u5f00\u53d1\u4eba\u5458\u53c2\u4e0e\u7684 \u3002 \u5f00\u7bb1\u5373\u7528\uff0cLinkerd \u5728\u6bcf\u4e2a\u670d\u52a1\u7684\u57fa\u7840\u4e0a\u63d0\u4f9b\u8fd9\u4e9b\u6307\u6807\uff1a \u8de8\u8d8a\u670d\u52a1\u7684\u6240\u6709\u8bf7\u6c42\uff0c\u65e0\u8bba\u8fd9\u4e9b\u8bf7\u6c42\u662f\u4ec0\u4e48 \u3002\u7136\u800c\uff0c\u6709\u65f6\u9700\u8981\u83b7\u5f97\u66f4\u7ec6\u7c92\u5ea6\u7684\u6307\u6807\u3002 \u4f8b\u5982\u524d\u9762\u7684 Emojivoto \u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684 Emoji \u5fae\u670d\u52a1\uff0c\u524d\u9762\u7ae0\u8282\u4e2d\u770b\u5230\u7684 Linkerd \u62a5\u544a\u7684\u6307\u6807\u662f\u5728\u8be5\u670d\u52a1\u7684\u6240\u6709\u7aef\u70b9\u4e0a\u805a\u5408\u7684\u3002\u5728\u5b9e\u9645\u573a\u666f\u4e0b\u9762\uff0c\u6211\u4eec\u53ef\u80fd\u8fd8\u5e0c\u671b\u770b\u5230 \u7279\u5b9a\u7aef\u70b9\u7684\u6210\u529f\u7387\u6216\u5ef6\u8fdf \uff0c\u4f8b\u5982\uff0c\u4e00\u4e2a\u7aef\u70b9\u53ef\u80fd\u5bf9\u670d\u52a1\u7279\u522b\u5173\u952e\uff0c\u6216\u8005\u7279\u522b\u6162\u3002 \u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c Linkerd \u4f7f\u7528\u4e86\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff08service profile\uff09\u7684\u6982\u5ff5\uff0c\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u662f\u4e00\u4e2a\u53ef\u9009\u7684\u914d\u7f6e\uff0c\u5b83\u901a\u77e5 Linkerd \u5bf9\u670d\u52a1\u7684\u4e0d\u540c\u7c7b\u578b\u7684\u8bf7\u6c42\uff0c\u6309\u5176\u8def\u7531\u8fdb\u884c\u5206\u7c7b \u3002\u8def\u7531\u53ea\u662f\u4e00\u4e2a\u7aef\u70b9\uff08\u5bf9\u4e8e gRPC\uff09\u6216\u4e00\u4e2a HTTP verb \u548c\u7aef\u70b9\uff08\u5bf9\u4e8e HTTP\uff09\u3002 \u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u5141\u8bb8 Linkerd \u4e3a\u670d\u52a1\u63d0\u4f9b\u6bcf\u4e2a\u8def\u7531\uff08pre-route\uff09\u800c\u4e0d\u662f\u6bcf\u4e2a\u670d\u52a1\u6307\u6807\uff0c\u5728\u540e\u9762\u7684\u7ae0\u8282\u4e2d\uff0c\u6211\u4eec\u8fd8\u5c06\u770b\u5230\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u5141\u8bb8 Linkerd \u5bf9\u670d\u52a1\u6267\u884c\u91cd\u8bd5\u548c\u8d85\u65f6\u7b49\u914d\u7f6e\uff0c\u4f46\u662f\u73b0\u5728\u6211\u4eec\u5148\u53ea\u5173\u6ce8\u6307\u6807\u3002 \u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u5e76\u4e0d\u662f\u7b80\u5355\u7684\u670d\u52a1\u4e0e Linkerd \u4e00\u8d77\u8fd0\u884c\u6240\u5fc5\u9700\u7684\uff0c\u5b83\u4eec\u662f\u53ef\u9009\u7684\u914d\u7f6e\u4f4d\uff0c\u53ef\u4ee5\u5b9e\u73b0 Linkerd \u7684\u66f4\u9ad8\u7ea7\u884c\u4e3a\uff0c\u5b83\u4eec\u4e5f\u662f Linkerd \u4f7f\u7528 Kubernetes CRD \u7684\u5c11\u6570\u793a\u4f8b\u4e4b\u4e00\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u4ecd\u7136\u901a\u8fc7 Emojivoto \u5e94\u7528\u8bf4\u660e\u4e0b\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u7684\u4f7f\u7528\u3002","title":"3 Linkerd \u901a\u8fc7 ServiceProfile \u5b9e\u73b0\u8d85\u65f6\u548c\u91cd\u8bd5"},{"location":"chap11/3linkered_ServiceProfile/#_1","text":"Linkerd \u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u662f\u901a\u8fc7\u5b9e\u4f8b\u5316\u4e00\u4e2a\u540d\u4e3a ServiceProfile \u7684 Kubernetes CRD \u6765\u5b9e\u73b0\u7684\u3002 ServiceProfile \u4f1a\u679a\u4e3e Linkerd \u4e3a\u8be5\u670d\u52a1\u671f\u671b\u7684\u8def\u7531 \u3002 \u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u521b\u5efa ServiceProfile\uff0c\u4f46\u4e5f\u53ef\u4ee5\u81ea\u52a8\u751f\u6210\u5b83\u4eec\u3002 Linkerd CLI \u6709\u4e00\u4e2a profile \u547d\u4ee4\uff0c\u53ef\u4ee5\u901a\u8fc7\u51e0\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u6765\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6 \u3002\u6700\u5e38\u89c1\u7684\u65b9\u6cd5\u4e4b\u4e00\u662f\u4ece\u670d\u52a1\u7684\u73b0\u6709\u8d44\u6e90\uff08\u5982 OpenAPI/Swagger \u89c4\u8303\u6216 protobuf \u6587\u4ef6\uff09\u751f\u6210\u5b83\u4eec\u3002 $ linkerd profile -h Output service profile config for Kubernetes. Usage: linkerd profile [flags] (--template | --open-api file | --proto file) (SERVICE) Examples: # Output a basic template to apply after modification. linkerd profile -n emojivoto --template web-svc # Generate a profile from an OpenAPI specification. linkerd profile -n emojivoto --open-api web-svc.swagger web-svc # Generate a profile from a protobuf definition. linkerd profile -n emojivoto --proto Voting.proto vote-svc Flags: -h, --help help for profile --ignore-cluster Output a service profile through offline generation -n, --namespace string Namespace of the service --open-api string Output a service profile based on the given OpenAPI spec file --proto string Output a service profile based on the given Protobuf spec file --template Output a service profile template Global Flags: --api-addr string Override kubeconfig and communicate directly with the control plane at host:port (mostly for testing) --as string Username to impersonate for Kubernetes operations --as-group stringArray Group to impersonate for Kubernetes operations --cni-namespace string Namespace in which the Linkerd CNI plugin is installed (default \"linkerd-cni\") --context string Name of the kubeconfig context to use --kubeconfig string Path to the kubeconfig file to use for CLI requests -L, --linkerd-namespace string Namespace in which Linkerd is installed ($LINKERD_NAMESPACE) (default \"linkerd\") --verbose Turn on debug logging \u4e0a\u9762\u7684\u5e2e\u52a9\u547d\u4ee4\u8f93\u51fa\u5217\u51fa\u4e86\u53ef\u7528\u4e8e\u4e3a ServiceProfile \u8d44\u6e90\u751f\u6210 YAML \u7684\u6807\u5fd7\uff0c\u53ef\u4ee5\u770b\u5230 \u5176\u4e2d\u5c31\u6709\u4e00\u4e2a --open-api \u6807\u5fd7\uff0c\u7528\u4e8e\u6307\u793a ServiceProfile \u8d44\u6e90\u5c06\u4ece\u6307\u5b9a\u7684 OpenAPI \u6216 Swagger \u6587\u6863\u6765\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c\u901a\u8fc7 --proto \u6807\u5fd7\u53ef\u4ee5\u6307\u793a\u4ece\u6307\u5b9a\u7684 Protobuf \u6587\u4ef6\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u3002 Emojivoto \u7684 web \u670d\u52a1\u6709\u4e00\u4e2a\u7b80\u5355\u7684 Swagger \u89c4\u8303\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a # web.swagger openapi: 3.0.1 version: v10 paths: /api/list: get: {} /api/vote: get: {} \u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528\u4e0a\u9762\u7684\u89c4\u8303\u6587\u4ef6\u6765\u751f\u6210\u4e00\u4e2a ServiceProfile \u5bf9\u8c61\uff0c\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a $ linkerd profile -n emojivoto --open-api web.swagger web-svc > web-sp.yaml \u4e0a\u8ff0\u547d\u4ee4\u5c06\u8f93\u51fa\u670d\u52a1 web-svc \u7684 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u3002\u8bf7\u6ce8\u610f\uff0c\u5c31\u50cf linkerd install \u547d\u4ee4\u4e00\u6837\uff0c linkerd profile \u547d\u4ee4\u4e5f\u53ea\u751f\u6210 YAML\uff0c\u5b83\u4e0d\u4f1a\u5c06 YAML \u5e94\u7528\u5230\u96c6\u7fa4\uff0c\u6240\u4ee5\u6211\u4eec\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230 web-sp.yaml \u6587\u4ef6\uff0c\u5bf9\u5e94\u751f\u6210\u7684\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: creationTimestamp: null name: web-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: routes: - condition: method: GET pathRegex: /api/list name: GET /api/list - condition: method: GET pathRegex: /api/vote name: GET /api/vote \u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684 ServiceProfile \u5bf9\u8c61\u7684\u58f0\u660e\u65b9\u5f0f\uff0c spec.routes \u7528\u6765\u58f0\u660e\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff0c\u6bcf\u6761\u8def\u7531\u4e2d\u5305\u542b\u4e00\u4e2a name \u548c condition \u5c5e\u6027 \uff1a name \u7528\u6765\u8868\u793a\u8def\u7531\u7684\u540d\u79f0\uff0c\u7528\u4e8e\u663e\u793a\u4f7f\u7528\u3002 condition \u7528\u6765\u63cf\u8ff0\u8def\u7531\u7684\u89c4\u8303\u3002\u4e0a\u4f8b\u4e2d\u751f\u6210\u7684 condition \u6709\u4e24\u4e2a\u5b57\u6bb5\uff1a method\uff1a\u4e0e\u8bf7\u6c42\u5339\u914d\u7684 HTTP \u65b9\u6cd5\u3002 pathRegex\uff1a\u7528\u4e8e\u5339\u914d\u8def\u5f84\u7684\u6b63\u5219\u8868\u8fbe\u5f0f \u3002\u5728\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\uff0c\u8fd9\u4e9b\u662f\u5b8c\u5168\u5339\u914d\u7684\u89c4\u5219\uff0c\u4f46\u901a\u5e38\u8fd9\u4e9b\u662f\u6b63\u5219\u8868\u8fbe\u5f0f\u3002 \u9664\u4e86\u901a\u8fc7 OpenAPI \u53ef\u4ee5\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e4b\u5916\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 Protobuf \u6765\u751f\u6210\uff0cgRPC \u534f\u8bae\u4f7f\u7528 protobuf \u5bf9\u8bf7\u6c42\u548c\u54cd\u5e94\u8fdb\u884c\u7f16\u7801\u548c\u89e3\u7801\uff0c\u8fd9\u610f\u5473\u7740\u6bcf\u4e2a gRPC \u670d\u52a1\u4e5f\u6709\u4e00\u4e2a protobuf \u5b9a\u4e49\u3002 Emojivoto \u5e94\u7528\u7684 Voting \u5fae\u670d\u52a1\u5c31\u5305\u542b\u6709 protobuf \u5b9a\u4e49\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a syntax = \"proto3\"; option go_package = \"github.com/buoyantio/emojivoto/proto\"; package emojivoto.v1; message VotingResult { string Shortcode = 1; int32 Votes = 2; } message VoteRequest { } message VoteResponse { } message ResultsRequest { } message ResultsResponse { repeated VotingResult results = 1; } service VotingService { rpc VotePoop (VoteRequest) returns (VoteResponse); rpc VoteJoy (VoteRequest) returns (VoteResponse); rpc VoteSunglasses (VoteRequest) returns (VoteResponse); ......\u7701\u7565\u90e8\u5206\u5185\u5bb9 } \u540c\u6837\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd profile \u547d\u4ee4\u6765\u751f\u6210\u5bf9\u5e94\u7684 ServiceProfile \u5bf9\u8c61\uff1a $ linkerd profile -n emojivoto --proto Voting.proto voting-svc > voting-sp.yaml \u6b64\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u5c06\u6bd4\u4e0a\u4e00\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u591a\u5f88\u591a\uff0c\u56e0\u4e3a Voting.proto \u6587\u4ef6\u5b9a\u4e49\u4e86\u66f4\u591a\u8def\u7531\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b voting-sp.yaml \u6587\u4ef6\uff0c\u5e76\u5c06\u5176\u4e0e\u4e0a\u9762\u521b\u5efa\u7684 ServiceProfile \u8d44\u6e90\u8fdb\u884c\u6bd4\u8f83\u3002 \u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u7528\u53e6\u5916\u4e00\u79cd\u65b9\u6cd5\u6765\u52a8\u6001\u751f\u6210 ServiceProfile\uff0cLinkerd \u53ef\u4ee5\u76d1\u63a7\u5728\u6307\u5b9a\u65f6\u95f4\u6bb5\u5185\u8fdb\u5165\u7684\u5b9e\u65f6\u8bf7\u6c42\uff0c\u5e76\u4ece\u4e2d\u6536\u96c6\u8def\u7531\u6570\u636e\u3002 \u5bf9\u4e8e\u4e0d\u4e86\u89e3\u670d\u52a1\u63d0\u4f9b\u7684\u5185\u90e8\u8def\u7531\u7684\u96c6\u7fa4\u7ba1\u7406\u5458\u6765\u8bf4\uff0c\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u529f\u80fd\uff0c\u56e0\u4e3a Linkerd \u4f1a\u8d1f\u8d23\u5904\u7406\u8bf7\u6c42\u5e76\u5c06\u5b83\u4eec\u5199\u5165\u6587\u4ef6\uff0c\u8be5\u7279\u6027\u7684\u5e95\u5c42\u539f\u7406\u662f\u4e0a\u4e00\u8282\u4e2d\u63d0\u5230\u7684\u5b9e\u65f6\u89c2\u5bdf\u8bf7\u6c42\u7684 Tap \u529f\u80fd\u3002 \u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u4f7f\u7528 linkerd profile \u547d\u4ee4\u76d1\u63a7 emoji \u670d\u52a1 10 \u79d2\u5e76\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\uff0c\u4e0e\u524d\u9762\u5b66\u4e60\u7684\u6240\u6709\u547d\u4ee4\u4e00\u6837\uff0c\u8f93\u51fa\u4f1a\u6253\u5370\u5230\u7ec8\u7aef\uff0c\u5e76\u4e14\u6b64\u547d\u4ee4\u4f1a\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8fd0\u884c\u8be5\u547d\u4ee4\uff08\u5e76\u7b49\u5f85 10 \u79d2\uff09\u4e00\u6b21\u3002 Linkerd Viz \u6269\u5c55\u4e5f\u6709\u81ea\u5df1\u7684\u914d\u7f6e\u6587\u4ef6\u5b50\u547d\u4ee4\uff0c\u53ef\u4ee5\u4e0e Tap \u529f\u80fd\u4e00\u8d77\u4f7f\u7528\uff0c\u4ece\u5b9e\u65f6\u6d41\u91cf\u4e2d\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff01\u5982\u4e0b\u547d\u4ee4\u6240\u793a\uff1a $ linkerd viz profile emoji-svc --tap deploy/emoji --tap-duration 10s -n emojivoto > emoji-sp.yaml \u5f53\u8bf7\u6c42\u53d1\u9001\u5230 emoji \u670d\u52a1\u65f6\uff0c\u8fd9\u4e9b\u8def\u7531\u901a\u8fc7 Tap \u529f\u80fd\u6536\u96c6\u3002\u6211 \u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 Emoji.proto \u6587\u4ef6\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u540e\u53bb\u6bd4\u8f83\u4f7f\u7528 --proto \u548c --tap \u6807\u5fd7\u521b\u5efa\u7684 ServiceProfile \u8d44\u6e90\u7684\u5b9a\u4e49 \u3002 \u751f\u6210\u7684 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a # emoji-sp.yaml apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: creationTimestamp: null name: emoji-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: routes: - condition: method: POST pathRegex: /emojivoto\\.v1\\.EmojiService/FindByShortcode name: POST /emojivoto.v1.EmojiService/FindByShortcode - condition: method: POST pathRegex: /emojivoto\\.v1\\.EmojiService/ListAll name: POST /emojivoto.v1.EmojiService/ListAll \u5982\u679c\u4f60\u9700\u8981\u624b\u52a8\u7f16\u5199\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c linkerd profile \u547d\u4ee4\u6709\u4e00\u4e2a --template \u6807\u5fd7\uff0c\u53ef\u4ee5\u751f\u6210 ServiceProfile \u8d44\u6e90\u7684\u811a\u624b\u67b6\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528\u4f60\u7684\u670d\u52a1\u7684\u8be6\u7ec6\u4fe1\u606f\u5bf9\u5176\u8fdb\u884c\u66f4\u65b0 \u3002 $ linkerd profile --template -n emojivoto emoji-svc ### ServiceProfile for emoji-svc.emojivoto ### apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: name: emoji-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: # A service profile defines a list of routes. Linkerd can aggregate metrics # like request volume, latency, and success rate by route. routes: - name: '/authors/{id}' # Each route must define a condition. All requests that match the # condition will be counted as belonging to that route. If a request # matches more than one route, the first match wins. condition: # The simplest condition is a path regular expression. pathRegex: '/authors/\\d+' # This is a condition that checks the request method. method: POST # If more than one condition field is set, all of them must be satisfied. # This is equivalent to using the 'all' condition: # all: # - pathRegex: '/authors/\\d+' # - method: POST # Conditions can be combined using 'all', 'any', and 'not'. # any: # - all: # - method: POST # - pathRegex: '/authors/\\d+' # - all: # - not: # method: DELETE # - pathRegex: /info.txt # A route may be marked as retryable. This indicates that requests to this # route are always safe to retry and will cause the proxy to retry failed # requests on this route whenever possible. # isRetryable: true # A route may optionally define a list of response classes which describe # how responses from this route will be classified. responseClasses: # Each response class must define a condition. All responses from this # route that match the condition will be classified as this response class. - condition: # The simplest condition is a HTTP status code range. status: min: 500 max: 599 # Specifying only one of min or max matches just that one status code. # status: # min: 404 # This matches 404s only. # Conditions can be combined using 'all', 'any', and 'not'. # all: # - status: # min: 500 # max: 599 # - not: # status: # min: 503 # The response class defines whether responses should be counted as # successes or failures. isFailure: true # A route can define a request timeout. Any requests to this route that # exceed the timeout will be canceled. If unspecified, the default timeout # is '10s' (ten seconds). # timeout: 250ms # A service profile can also define a retry budget. This specifies the # maximum total number of retries that should be sent to this service as a # ratio of the original request volume. # retryBudget: # The retryRatio is the maximum ratio of retries requests to original # requests. A retryRatio of 0.2 means that retries may add at most an # additional 20% to the request load. # retryRatio: 0.2 # This is an allowance of retries per second in addition to those allowed # by the retryRatio. This allows retries to be performed, when the request # rate is very low. # minRetriesPerSecond: 10 # This duration indicates for how long requests should be considered for the # purposes of calculating the retryRatio. A higher value considers a larger # window and therefore allows burstier retries. # ttl: 10s \u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u8f93\u51fa\u5305\u542b ServiceProfile \u8d44\u6e90\u7684\u5b57\u6bb5\u548c\u6bcf\u4e2a\u5b57\u6bb5\u7684\u8be6\u7ec6\u8bf4\u660e\uff0c\u5982\u679c\u4f60\u9700\u8981 ServiceProfile \u5b9a\u4e49\u7684\u5feb\u901f\u53c2\u8003\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528 --template \u6807\u5fd7\uff01 \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86\u5982\u4f55\u751f\u6210 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u67e5\u770b\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\u6570\u636e\u3002","title":"\u751f\u6210\u670d\u52a1\u914d\u7f6e\u6587\u4ef6"},{"location":"chap11/3linkered_ServiceProfile/#linkerd-dashboard-per-route-metrics","text":"\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u4f7f\u7528 linkerd profile \u547d\u4ee4\u6765\u751f\u6210 ServiceProfile \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u73b0\u5728\u8ba9\u6211\u4eec\u91cd\u65b0\u8fd0\u884c\u751f\u6210\u547d\u4ee4\uff0c\u5e76\u76f4\u63a5\u5c06\u751f\u6210\u7684 ServiceProfile \u5bf9\u8c61\u76f4\u63a5\u5e94\u7528\u5230\u96c6\u7fa4\u4e2d\uff1a $ linkerd profile -n emojivoto --open-api web.swagger web-svc | kubectl apply -f - serviceprofile.linkerd.io/web-svc.emojivoto.svc.cluster.local created $ linkerd profile -n emojivoto --proto Voting.proto voting-svc | kubectl apply -f - serviceprofile.linkerd.io/voting-svc.emojivoto.svc.cluster.local created $ linkerd viz profile emoji-svc --tap deploy/emoji --tap-duration 10s -n emojivoto | kubectl apply -f - serviceprofile.linkerd.io/emoji-svc.emojivoto.svc.cluster.local created \u5f53\u4e0a\u9762\u7684\u547d\u4ee4\u8fd0\u884c\u6210\u529f\u540e\uff0c\u8ba9\u6211\u4eec\u6253\u5f00 Linkerd \u4eea\u8868\u76d8\u6765\u67e5\u770b\u4e0b\u76f8\u5173\u6307\u6807\uff0c\u6211\u4eec\u5148\u5bfc\u822a\u5230 Web Deployment \u4e0b\u67e5\u770b\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\u3002 \u4ece\u4e0a\u56fe\u53ef\u4ee5\u770b\u51fa\u6765\u5728 ROUTE METRICS \u9009\u9879\u5361\u4e0b\u9762\u76f8\u6bd4\u9ed8\u8ba4\u7684 [DEFAULT] \u8def\u7531\u591a\u4e86\u4e24\u4e2a\u8def\u7531\uff0c\u8fd9\u4e24\u4e2a\u8def\u7531\u5c31\u662f\u6211\u4eec\u901a\u8fc7 linkerd profile --open-api \u547d\u4ee4\u4ece web.swagger \u6587\u4ef6\u4e2d\u751f\u6210\u7684\u4e24\u6761\u8def\u7531\uff0c\u6bcf\u884c\u5217\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e24\u6761\u8def\u7531\u7684\u6bcf\u6761\u6307\u6807\u6570\u636e\u3002 \u5728\u90e8\u7f72 ServiceProfile \u5bf9\u8c61\u4e4b\u524d\uff0c\u6211\u4eec\u53ea\u80fd\u770b\u5230 web \u670d\u52a1\u7684\u805a\u5408\u6307\u6807\uff0c\u90e8\u7f72\u540e\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u770b\u5230 /api/list \u8fd9\u6761\u8def\u7531\u662f 100% \u6210\u529f\u7684\uff0c /api/vote \u8def\u7531\u6709\u4e00\u4e9b\u9519\u8bef\u3002 \u540c\u6837\u5728\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e4b\u524d\uff0c\u6211\u4eec\u53ea\u77e5\u9053 web \u670d\u52a1\u6b63\u5728\u8fd4\u56de\u9519\u8bef\uff0c\u73b0\u5728\u6211\u4eec\u9519\u8bef\u662f\u6765\u81ea\u4e0e /api/vote \u8def\u7531\uff0c\u53e6\u5916\u7684 [DEFAULT] \u9ed8\u8ba4\u8def\u7531\u8868\u793a\u5f53\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u8def\u7531\u5339\u914d\u8bf7\u6c42\u65f6 Linkerd \u4f7f\u7528\u7684\u8def\u7531\uff0c\u5176\u4f1a\u6355\u83b7\u5728 ServiceProfile \u4e4b\u524d\u89c2\u5bdf\u5230\u7684\u4efb\u4f55\u6d41\u91cf \u73b0\u5728\u6211\u4eec\u518d\u53bb\u770b\u770b\u53e6\u5916\u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\uff0c\u5176\u4e2d\u7684 Voting \u670d\u52a1\u6bd4\u8f83\u5177\u6709\u4ee3\u8868\u6027\uff0c\u56e0\u4e3a\u5b83\u5305\u542b\u5f88\u591a\u8def\u7531\u3002 \u5728 Linkerd Dashboard \u9875\u9762\u4e0a\u5728 emojivoto \u547d\u540d\u7a7a\u95f4\u4e0a\u8fdb\u5165 Voting Deployment \uff0c\u5207\u6362\u5230 ROUTE METRICS \u9009\u9879\u5361\u3002 \u6211\u4eec\u4f1a\u8be5\u670d\u52a1\u4e0b\u6709\u975e\u5e38\u591a\u7684\u8def\u7531\uff0c\u4e0a\u9762\u7684 web \u670d\u52a1\u6211\u4eec\u77e5\u9053 /api/vote \u8def\u7531\u7684\u8bf7\u6c42\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u6240\u6709 voting \u670d\u52a1\u4e2d\u7684\u6bcf\u6761\u8def\u7531\u4fe1\u606f\u90fd\u6709\u53ef\u80fd\u4f1a\u63d0\u4f9b\u76f8\u5173\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u7531\u4e8e\u8def\u7531\u975e\u5e38\u591a\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u6309\u7167 Success Rate \u8fd9\u4e00\u5217\u8fdb\u884c\u5347\u5e8f\u6392\u5e8f\uff0c\u6b63\u5e38\u5c31\u53ef\u4ee5\u770b\u5230 VoteDoughnut \u8def\u7531\u6210\u529f\u7387\u4e3a 0\u3002","title":"Linkerd Dashboard \u4e2d\u67e5\u770b Per-Route Metrics"},{"location":"chap11/3linkered_ServiceProfile/#linkerd-cli-per-route-metrics","text":"\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86\u5982\u4f55\u901a\u8fc7 Dashboard \u6765\u67e5\u770b Emojivoto \u5e94\u7528\u4e2d\u670d\u52a1\u7684\u6bcf\u4e2a\u8def\u7531\u6307\u6807\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u5c1d\u8bd5\u4f7f\u7528 CLI \u5de5\u5177\u67e5\u770b\u6bcf\u4e2a\u8def\u7531\u7684\u6307\u6807\u3002 linkerd viz routes \u547d\u4ee4\u4f7f\u7528\u4e0e\u4eea\u8868\u76d8\u4f7f\u7528\u7684\u76f8\u540c\u6307\u6807\uff0c\u8ba9\u6211\u4eec\u770b\u770b\u4f7f\u7528 Linkerd CLI \u6765\u67e5\u770b emoji \u670d\u52a1\u7684\u8def\u7531 \uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz routes deploy/emoji -n emojivoto ROUTE SERVICE SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 POST /emojivoto.v1.EmojiService/FindByShortcode emoji-svc 100.00% 1.0rps 1ms 1ms 1ms POST /emojivoto.v1.EmojiService/ListAll emoji-svc 100.00% 1.0rps 1ms 1ms 1ms [DEFAULT] emoji-svc - - - - - \u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u4e3a emoji \u670d\u52a1\u5b9a\u4e49\u7684\u4e24\u6761\u8def\u7531\u90fd\u662f\u6210\u529f\u7684\uff0c\u5e76\u4e14\u5728 1ms \u7684\u65f6\u95f4\u5185\u5904\u7406\u4e86\u8bf7\u6c42\uff0c\u53ef\u4ee5\u770b\u51fa\u8fd9\u4e9b\u8def\u7531\u662f\u5065\u5eb7\u7684\u3002\u8fd8\u8981\u6ce8\u610f\u6211\u4eec\u7684\u9ed8\u8ba4\u8def\u7531\uff0c\u6807\u8bb0\u4e3a [DEFAULT]\uff0c\u540c\u6837\u8fd9\u662f Linkerd \u5728\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u4e0e\u8bf7\u6c42\u5339\u914d\u7684\u8def\u7531\u65f6\u4f7f\u7528\u7684\u8def\u7531\u3002 \u73b0\u5728\u6211\u4eec\u7528\u540c\u6837\u7684\u65b9\u5f0f\u901a\u8fc7 linkerd viz routes \u547d\u4ee4\u6765\u67e5\u770b voting \u548c web \u670d\u52a1\u7684\u8def\u7531\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz routes deploy/web -n emojivoto ROUTE SERVICE SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 GET /api/list web-svc 100.00% 1.0rps 1ms 1ms 1ms GET /api/vote web-svc 88.33% 1.0rps 2ms 7ms 9ms [DEFAULT] web-svc - - - - - $ linkerd viz routes deploy/voting -n emojivoto ROUTE SERVICE SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 Results voting-svc - - - - - Vote100 voting-svc 100.00% 0.0rps 1ms 1ms 1ms VoteBacon voting-svc - - - - - VoteBalloon voting-svc - - - - - # ...... voting \u670d\u52a1\u7684\u8f93\u51fa\u5f88\u957f\uff0c\u56e0\u4e3a\u5b83\u6709\u5f88\u591a\u8def\u7531\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7 grep \u547d\u4ee4\u6765\u67e5\u627e VoteDoughnut \u8def\u7531\uff1a linkerd viz routes deploy/voting -n emojivoto | grep VoteDoughnut \uff08\u6216\u8005\u53ef\u4ee5\u4f7f\u7528 -o json \u6807\u5fd7\u4ee5\u53ca jq \u4e4b\u7c7b\u7684\u5de5\u5177\u6765\u89e3\u6790\u8f93\u51fa\uff09\u3002 \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u529f\u80fd\uff0c\u76ee\u524d\u6211\u4eec\u6682\u65f6\u4e13\u6ce8\u4e8e\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u7684\u53ef\u89c2\u6d4b\u6027\u529f\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e4b\u524d\u4e86\u89e3\u7684\u6bcf\u4e2a\u8def\u7531\u7684\u9ec4\u91d1\u6307\u6807\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u8fdb\u4e00\u6b65\u6df1\u5165\u4e86\u89e3 ServiceProfile \u5e76\u63a2\u7d22 Linkerd \u7684\u91cd\u8bd5\u548c\u8d85\u65f6\u529f\u80fd\u3002","title":"\u901a\u8fc7 Linkerd CLI \u67e5\u770b Per-Route Metrics"},{"location":"chap11/3linkered_ServiceProfile/#_2","text":"\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u6765\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 ServiceProfile \u914d\u7f6e\u8d85\u65f6\u3001\u91cd\u8bd5\u3002Linkerd \u53ef\u4ee5\u901a\u8fc7\u6d41\u91cf\u62c6\u5206\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u91cd\u8bd5\u548c\u8d85\u65f6\u7b49\u529f\u80fd\u6765\u786e\u4fdd\u53ef\u9760\u6027\uff0c\u8fd9\u4e9b\u4e2d\u7684\u6bcf\u4e00\u4e2a\u90fd\u5728\u63d0\u9ad8\u7cfb\u7edf\u7684\u6574\u4f53\u53ef\u9760\u6027\u65b9\u9762\u53d1\u6325\u7740\u91cd\u8981\u4f5c\u7528\u3002 \u4f46\u662f\u8fd9\u4e9b\u7279\u6027\u7a76\u7adf\u80fd\u589e\u52a0\u4ec0\u4e48\u6837\u7684\u53ef\u9760\u6027\u5462\uff1f\u5f52\u6839\u7ed3\u5e95\u662f Linkerd \u53ef\u4ee5\u5e2e\u52a9\u9632\u6b62\u77ac\u65f6\u6545\u969c\u3002\u5982\u679c\u670d\u52a1\u5b8c\u5168\u5173\u95ed\uff0c\u6216\u59cb\u7ec8\u8fd4\u56de\u5931\u8d25\uff0c\u6216\u59cb\u7ec8\u6302\u8d77\uff0c\u90a3\u4e48\u518d\u591a\u7684\u91cd\u8bd5\u6216\u8d1f\u8f7d\u5747\u8861\u90fd\u65e0\u6d4e\u4e8e\u4e8b\u3002 \u4f46\u662f\uff0c\u5982\u679c\u670d\u52a1\u7684\u4e00\u4e2a\u5b9e\u4f8b\u51fa\u73b0\u95ee\u9898\uff0c\u6216\u8005\u6f5c\u5728\u95ee\u9898\u53ea\u662f\u6682\u65f6\u7684\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019 Linkerd \u5c31\u53ef\u4ee5\u6d3e\u4e0a\u7528\u573a\u4e86\uff0c\u800c\u4e14\u8fd9\u4e9b\u90e8\u5206\u7684\u3001\u6682\u65f6\u7684\u6545\u969c\u662f\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u6700\u5e38\u51fa\u73b0\u7684\u95ee\u9898\uff01 \u5f53\u6d89\u53ca\u5230 Linkerd \u7684\u8d1f\u8f7d\u5747\u8861\u3001\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u6838\u5fc3\u53ef\u9760\u6027\u7279\u6027\u65f6\uff0c\u8fd9\u91cc\u6709\u4e24\u4ef6\u91cd\u8981\u7684\u4e8b\u60c5\u9700\u8981\u7406\u89e3\uff08\u6d41\u91cf\u5206\u5272\uff0c\u4e5f\u662f\u4e00\u4e2a\u53ef\u9760\u6027\u7279\u6027\uff0c\u4f46\u6709\u70b9\u4e0d\u592a\u4e00\u6837\uff0c\u6211\u4eec\u5c06\u5728\u540e\u9762\u7684\u7ae0\u8282\u4e2d\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff09\uff1a \u6240\u6709\u8fd9\u4e9b\u6280\u672f\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\uff1a\u8fdb\u884c\u8c03\u7528\u7684\u4ee3\u7406\u662f\u6267\u884c\u8fd9\u4e9b\u529f\u80fd\u7684\u4ee3\u7406\uff0c\u800c\u4e0d\u662f\u670d\u52a1\u5668\u7aef\u7684\u4ee3\u7406\u3002\u5982\u679c\u4f60\u7684\u670d\u52a1\u5668\u662f\u7f51\u683c\u7684\uff0c\u4f46\u4f60\u7684\u5ba2\u6237\u7aef\u4e0d\u662f\u7684\uff0c\u90a3\u4e48\u5c06\u4e0d\u4f1a\u5728\u4e24\u8005\u4e4b\u95f4\u7684\u8c03\u7528\u4e2d\u542f\u7528\u8fd9\u4e9b\u529f\u80fd\uff01 \u8fd9\u4e09\u4e2a\u7279\u6027\u4e00\u8d77\u4f7f\u7528\u6548\u679c\u6700\u597d\u3002\u6ca1\u6709\u91cd\u8bd5\uff0c\u8d85\u65f6\u6ca1\u6709\u4ec0\u4e48\u4ef7\u503c\uff1b\u5982\u679c\u6ca1\u6709\u8d1f\u8f7d\u5747\u8861\uff0c\u91cd\u8bd5\u51e0\u4e4e\u4e5f\u6ca1\u6709\u4ec0\u4e48\u4ef7\u503c\u3002 \u6211\u4eec\u53ef\u4ee5\u5148\u4e86\u89e3\u4e0b\u8d1f\u8f7d\u5747\u8861\uff0cLinkerd \u4f1a\u81ea\u52a8\u5728\u53ef\u80fd\u7684\u76ee\u7684\u5730\u4e4b\u95f4\u5bf9\u8bf7\u6c42\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u8bf7\u6ce8 \u610f\u8bf7 \u6c42\u8fd9\u4e2a\u8bcd - \u4e0e\u56db\u5c42\u6216 TCP \u8d1f\u8f7d\u5747\u8861\u4e0d\u540c\uff0c\u5b83\u4f1a\u5747\u8861\u8fde\u63a5\uff0cLinkerd \u5c06\u5efa\u7acb\u5230\u53ef\u80fd\u7684\u7aef\u70b9\u96c6\u7684\u8fde\u63a5\uff0c\u5e76\u5728\u6240\u6709\u8fd9\u4e9b\u8fde\u63a5\u4e4b\u95f4\u5747\u8861\u8bf7\u6c42\u3002\u8fd9\u5141\u8bb8\u5bf9\u6d41\u91cf\u8fdb\u884c\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u5e76\u4e14\u5728\u540e\u53f0\uff0cLinkerd \u7684\u65b9\u6cd5\u975e\u5e38\u590d\u6742\uff0c \u4f7f\u7528\u8bf8\u5982\u670d\u52a1\u5668\u5ef6\u8fdf\u7684\u6307\u6570\u52a0\u6743\u79fb\u52a8\u5e73\u5747\uff08EWMA\uff09 \u4e4b\u7c7b\u7684\u6280\u672f\u6765\u4f18\u5316\u8bf7\u6c42\u7684\u53bb\u5411\uff1b\u5c3d\u53ef\u80fd\u8de8\u7aef\u70b9\u6c47\u96c6\u8fde\u63a5\uff1b\u5e76\u81ea\u52a8\u5c06 HTTP/1.1 \u6d41\u91cf\u5347\u7ea7\u5230\u4ee3\u7406\u4e4b\u95f4\u7684 HTTP/2 \u8fde\u63a5\u3002\u7136\u800c\uff0c\u4ece\u6211\u4eec\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5e76\u6ca1\u6709\u8fdb\u884c\u4efb\u4f55\u914d\u7f6e\uff0c\u53ea\u9700\u8981\u77e5\u9053\uff1a Linkerd \u4f1a\u81ea\u52a8\u5728\u5176\u7aef\u70b9\u4e4b\u95f4\u5e73\u8861\u8bf7\u6c42 \u3002 \u63a5\u7740\u770b\u770b\u8d85\u65f6\uff0c\u8d85\u65f6\u662f\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u6700\u957f\u65f6\u95f4\u7684\u4e00\u79cd\u65b9\u5f0f\u3002\u6bd4\u5982\u4f60\u7684\u670d\u52a1\u4e0a\u6709\u4e00\u4e2a\u540d\u4e3a getValue() \u7684\u8def\u7531\uff0c\u800c getValue() \u7684\u6027\u80fd\u662f\u4e0d\u53ef\u9884\u6d4b\u7684\uff1a\u5927\u591a\u6570\u65f6\u5019 getValue() \u4f1a\u5728 10 \u6beb\u79d2\u5185\u8fd4\u56de\uff0c\u4f46\u6709\u65f6\u9700\u8981 10 \u5206\u949f\u624d\u80fd\u8fd4\u56de\uff0c\u4e5f\u8bb8\u662f\u5728\u67d0\u4e9b\u6709\u4e89\u8bae\u7684\u8d44\u6e90\u4e0a\u5b58\u5728\u9501\u7ade\u4e89\u3002\u5982\u679c\u6ca1\u6709\u8d85\u65f6\uff0c\u8c03\u7528 getValue() \u5c06\u9700\u8981 10 \u6beb\u79d2\u5230 10 \u5206\u949f\u4e4b\u95f4\u7684\u4efb\u4f55\u65f6\u95f4\uff0c\u4f46\u662f\u5982\u679c\u8bbe\u7f6e\u4e86 500 \u6beb\u79d2\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u90a3\u4e48 getValue() \u5219\u6700\u591a\u9700\u8981 500 \u6beb\u79d2\u3002 \u6dfb\u52a0\u8d85\u65f6\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u79cd\u673a\u5236\u6765\u9650\u5236\u7cfb\u7edf\u7684\u6700\u574f\u60c5\u51b5\u5ef6\u8fdf\uff0c\u5b83\u5141\u8bb8 getValue() \u7684\u8c03\u7528\u8005\u5177\u6709\u66f4\u53ef\u9884\u6d4b\u7684\u6027\u80fd\uff0c\u5e76\u4e14\u4e0d\u4f1a\u5360\u7528\u7b49\u5f85 10 \u5206\u949f\u957f\u7684\u8c03\u7528\u8fd4\u56de\u7684\u8d44\u6e90\u3002\u5176\u6b21\uff0c\u66f4\u91cd\u8981\u7684\u662f\uff0c\u8d85\u65f6\u53ef\u4ee5\u4e0e\u91cd\u8bd5\u548c\u8d1f\u8f7d\u5747\u8861\u76f8\u7ed3\u5408\uff0c\u4ee5\u81ea\u52a8\u5c06\u8bf7\u6c42\u91cd\u65b0\u53d1\u9001\u5230\u670d\u52a1\u7684\u4e0d\u540c\u5b9e\u4f8b\u3002 \u5982\u679c getValue() \u5728\u5b9e\u4f8b A \u4e0a\u5f88\u6162\uff0c\u5728\u5b9e\u4f8b B \u6216 C \u4e0a\u53ef\u80fd\u4f1a\u5f88\u5feb\uff0c\u751a\u81f3\u591a\u6b21\u91cd\u8bd5\u4e5f\u5c06\u8fdc\u8fdc\u5c11\u4e8e\u7b49\u5f85 10 \u5206\u949f\u3002 \u6240\u4ee5\u6211\u4eec\u518d\u6765\u770b\u770b\u91cd\u8bd5\uff0c\u91cd\u8bd5\u662f\u6307 Linkerd \u81ea\u52a8\u91cd\u8bd5\u8bf7\u6c42\u3002\u8fd9\u4f1a\u5728\u4ec0\u4e48\u573a\u666f\u4e0b\u6709\u7528\u5462\uff1f\u540c\u6837\u7531\u4e8e\u67d0\u4e9b\u4e34\u65f6\u9519\u8bef\uff1a \u5982\u679c\u7279\u5b9a\u5b9e\u4f8b\u4e0a\u7684\u7279\u5b9a\u8def\u7531\u8fd4\u56de\u9519\u8bef\uff0c\u5e76\u4e14\u7b80\u5355\u5730\u91cd\u8bd5\u8be5\u8bf7\u6c42\u53ef\u80fd\u4f1a\u5bfc\u81f4\u54cd\u5e94\u6210\u529f\uff0c\u5f53\u7136\u91cd\u8981\u7684\u662f\u8981\u610f\u8bc6\u5230\u7b80\u5355\u5730\u91cd\u8bd5\u8bf7\u6c42\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u6210\u529f\u54cd\u5e94\u3002\u5982\u679c\u5e95\u5c42\u9519\u8bef\u4e0d\u662f\u6682\u65f6\u7684\uff0c\u6216\u8005\u5982\u679c Linkerd \u65e0\u6cd5\u91cd\u8bd5\uff0c\u90a3\u4e48\u5e94\u7528\u7a0b\u5e8f\u4ecd\u7136\u9700\u8981\u5904\u7406\u8fd9\u4e9b\u9519\u8bef\u3002 \u5728\u5b9e\u8df5\u4e2d\uff0c\u5b9e\u73b0\u91cd\u8bd5\u53ef\u80fd\u4f1a\u5f88\u9ebb\u70e6\u3002\u5982\u679c\u60f3\u5f53\u7136\u7684\u505a\u4e5f\u662f\u4f1a\u6709\u4e00\u5b9a\u98ce\u9669\u7684\uff0c\u53ef\u80fd\u4f1a\u7ed9\u7cfb\u7edf\u589e\u52a0\u989d\u5916\u7684\u8d1f\u8f7d\uff0c\u8fd9\u4e2a\u8d1f\u8f7d\u53ef\u80fd\u4f1a\u8ba9\u4e8b\u60c5\u53d8\u5f97\u66f4\u7cdf\u7cd5\u3002 \u4e00\u79cd\u5e38\u89c1\u7684\u6545\u969c\u573a\u666f\u5c31\u662f \u91cd\u8bd5\u98ce\u66b4 \uff1a \u670d\u52a1 A \u4e2d\u7684\u77ac\u65f6\u6545\u969c\u89e6\u53d1 B \u5bf9\u5b83\u8bf7\u6c42\u7684\u91cd\u8bd5\uff1b \u8fd9\u4e9b\u91cd\u8bd5\u5bfc\u81f4 A \u8fc7\u8f7d\uff0c\u8fd9\u610f\u5473\u7740 B \u5f00\u59cb\u5931\u8d25\u7684\u8bf7\u6c42\uff1b \u8fd9\u4f1a\u89e6\u53d1\u5176\u8c03\u7528\u8005 C \u5bf9 B \u7684\u91cd\u8bd5\uff0c\u7136\u540e\u5bfc\u81f4 B \u8fc7\u8f7d\uff0c\u4f9d\u6b64\u7c7b\u63a8\u3002\u5bf9\u4e8e\u5141\u8bb8\u4f60\u914d\u7f6e\u6bcf\u4e2a\u8bf7\u6c42\u7684\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u7684\u7cfb\u7edf\u5c24\u5176\u5982\u6b64\uff1a \u6bcf\u4e2a\u8bf7\u6c42\u6700\u591a\u91cd\u8bd5 3 \u6b21\u542c\u8d77\u6765\u53ef\u80fd\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46\u5728\u6700\u574f\u7684\u60c5\u51b5\u4e0b\u4f1a\u589e\u52a0 300% \u7684\u8d1f\u8f7d\u3002 Linkerd \u901a\u8fc7\u4f7f\u7528 \u91cd\u8bd5\u9884\u7b97 \u800c\u4e0d\u662f\u6bcf\u4e2a\u8bf7\u6c42\u7684\u9650\u5236\u6765\u8bbe\u7f6e\u91cd\u8bd5\u7684\u53c2\u6570\uff0c\u5c06\u91cd\u8bd5\u98ce\u66b4\u7684\u53ef\u80fd\u6027\u964d\u5230\u6700\u4f4e\u3002 \u91cd\u8bd5\u9884\u7b97\u662f\u53ef\u4ee5\u91cd\u8bd5\u7684\u8bf7\u6c42\u603b\u6570\u7684\u767e\u5206\u6bd4\uff0cLinkerd \u7684\u9ed8\u8ba4\u884c\u4e3a\u662f\u5141\u8bb8\u5bf9\u5931\u8d25\u7684\u8bf7\u6c42\u8fdb\u884c 20% (200) \u6b21\u91cd\u8bd5\uff0c\u518d\u52a0\u4e0a\u6bcf\u79d2\u989d\u5916\u7684 10 \u4e2a\u8bf7\u6c42\u3002\u4f8b\u5982\uff0c\u5982\u679c\u539f\u59cb\u8bf7\u6c42\u8d1f\u8f7d\u662f\u6bcf\u79d2 1000 \u4e2a\u8bf7\u6c42\uff0c\u90a3\u4e48 Linkerd \u5c06\u5141\u8bb8\u6bcf\u79d2\u91cd\u8bd5 210 \u4e2a\u8bf7\u6c42\u3002\u5f53\u9884\u7b97\u7528\u5c3d\u65f6\uff0cLinkerd \u4e0d\u4f1a\u91cd\u8bd5\u8bf7\u6c42\uff0c\u800c\u662f\u4f1a\u5411\u5ba2\u6237\u7aef\u8fd4\u56de 504 \u9519\u8bef\u3002 \u7efc\u4e0a\u6240\u8ff0\uff1a\u8d1f\u8f7d\u5747\u8861\u3001\u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u662f\u4e3a\u4e86\u5728\u51fa\u73b0\u90e8\u5206\u3001\u6682\u65f6\u6027\u6545\u969c\u7684\u60c5\u51b5\u4e0b\u4fdd\u969c\u5e94\u7528\u7a0b\u5e8f\u7684\u53ef\u9760\u6027\uff0c\u5e76\u9632\u6b62\u8fd9\u4e9b\u6545\u969c\u5347\u7ea7\u4e3a\u5168\u5c40\u4e2d\u65ad\u3002\u4f46\u5b83\u4eec\u5e76\u4e0d\u662f\u7075\u4e39\u5999\u836f\uff0c\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5fc5\u987b\u4ecd\u7136\u80fd\u591f\u5904\u7406\u9519\u8bef\u3002","title":"\u91cd\u8bd5\u4e0e\u8d85\u65f6"},{"location":"chap11/3linkered_ServiceProfile/#per-route-metrics","text":"\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u5728 Linkerd \u4e2d\u4f7f\u7528\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u539f\u56e0\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u5728\u524d\u9762\u4e86\u89e3\u7684\u53ef\u89c2\u6d4b\u6027\u529f\u80fd\u7684\u57fa\u7840\u4e0a\uff0c\u4f7f\u7528\u6307\u6807\u6765\u505a\u6709\u5173\u5e94\u7528\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u51b3\u7b56\u3002 \u9996\u5148\uff0c\u6211\u4eec\u5c06\u67e5\u770b emojivoto \u547d\u540d\u7a7a\u95f4\u4e2d\u6240\u6709 Deployments \u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u7136\u540e\u6211\u4eec\u518d\u6df1\u5165\u7814\u7a76\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u3002 \u76f4\u63a5\u4f7f\u7528 linkerd viz stat \u547d\u4ee4\u5373\u53ef\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz stat deploy -n emojivoto NAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji 1/1 100.00% 2.3rps 1ms 1ms 4ms 3 vote-bot 1/1 100.00% 0.3rps 1ms 2ms 2ms 1 voting 1/1 87.01% 1.3rps 1ms 7ms 9ms 3 web 1/1 91.91% 2.3rps 1ms 10ms 28ms 3 stat \u547d\u4ee4\u5411\u6211\u4eec\u5c55\u793a\u4e86\u9ec4\u91d1\u6307\u6807\uff0c\u5305\u62ec\u6210\u529f\u7387\u548c\u5ef6\u8fdf\uff0c\u6211\u4eec\u53ef\u4ee5\u6ce8\u610f\u5230 voting \u548c web \u670d\u52a1\u7684\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c \u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 linkerd viz edges \u547d\u4ee4\u6765\u4e86\u89e3\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb \u3002 $ linkerd viz edges deploy -n emojivoto SRC DST SRC_NS DST_NS SECURED vote-bot web emojivoto emojivoto \u221a web emoji emojivoto emojivoto \u221a web voting emojivoto emojivoto \u221a prometheus emoji linkerd-viz emojivoto \u221a prometheus vote-bot linkerd-viz emojivoto \u221a prometheus voting linkerd-viz emojivoto \u221a prometheus web linkerd-viz emojivoto \u221a \u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7 Linkerd Dashboard \u6765\u67e5\u770b\u7ae0\u9c7c\u56fe\u53bb\u4e86\u89e3\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb\u3002 \u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa web \u670d\u52a1\u4e2d\u7684 Pods \u5bf9 voting \u670d\u52a1\u7684 Pods \u8fdb\u884c\u4e86\u8c03\u7528\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u731c\u6d4b\u662f voting \u670d\u52a1\u5bfc\u81f4\u4e86 web \u670d\u52a1\u7684\u9519\u8bef\uff0c\u5f53\u7136\u8fd9\u8fd8\u6ca1\u7ed3\u675f\uff0c\u8fd8\u8bb0\u5f97\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u7684 ServiceProfile \u6587\u4ef6\u5417\uff1f \u6211\u4eec\u6709\u6bcf\u6761\u8def\u7531\u7684\u6307\u6807\uff0c\u5e94\u8be5\u80fd\u591f\u51c6\u786e\u5730\u770b\u5230\u54ea\u4e9b\u8def\u7531\u7684\u6210\u529f\u7387\u4f4e\u4e8e 100%\uff0c\u53ef\u4ee5\u901a\u8fc7 linkerd viz routes \u547d\u4ee4\u53bb\u4e86\u89e3 voting \u670d\u52a1\u7684\u8def\u7531\u6307\u6807\u60c5\u51b5\uff0c\u5982\u4e0b\u547d\u4ee4\u6240\u793a\uff1a $ linkerd viz routes deploy/voting -n emojivoto # ...... VoteDog voting-svc - - - - - VoteDoughnut voting-svc 0.00% 0.1rps 1ms 1ms 1ms VoteFax voting-svc - - - - - VoteFire voting-svc 100.00% 0.0rps 1ms 1ms 1ms VoteFlightDeparture voting-svc - - - - - # ...... \u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Linkerd Dashboard \u53bb\u67e5\u770b voting \u670d\u52a1\u7684 ROUTE METRICS \u4fe1\u606f \uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u6700\u7ec8\u6211\u4eec\u53ef\u4ee5\u5b9a\u4f4d\u5230\u662f VoteDoughnut \u8fd9\u6761\u662f\u8bf7\u6c42\u5931\u8d25\u7684\u8def\u7531\u3002 \u73b0\u5728\u6211\u4eec\u4e0d\u4ec5\u77e5\u9053 web \u670d\u52a1\u548c voting \u670d\u52a1\u4e4b\u95f4\u53d1\u751f\u4e86\u9519\u8bef\uff0c\u800c\u4e14\u4e5f\u77e5\u9053\u4e86 VoteDoughnut \u8def\u7531\u53d1\u751f\u4e86\u9519\u8bef\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u91cd\u8bd5\u6765\u5c1d\u8bd5\u89e3\u51b3\u9519\u8bef\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u8981\u6c42\u5f00\u53d1\u4eba\u5458\u8fdb\u884c\u4ee3\u7801\u8c03\u8bd5\u3002","title":"\u4f7f\u7528 Per-Route Metrics \u6765\u786e\u5b9a\u4f55\u65f6\u91cd\u8bd5\u548c\u8d85\u65f6"},{"location":"chap11/3linkered_ServiceProfile/#_3","text":"\u5728\u6211\u4eec\u5f00\u59cb\u4e3a VotingDoughnut \u8def\u7531\u914d\u7f6e\u91cd\u8bd5\u4e4b\u524d\uff0c\u6211\u4eec\u5fc5\u987b\u9996\u5148\u4ed4\u7ec6\u67e5\u770b web \u548c voting \u670d\u52a1\u7684\u6307\u6807\uff0c\u56e0\u4e3a\u8fd9\u5c06\u5e2e\u52a9\u6211\u4eec\u771f\u6b63\u4e86\u89e3\u5e94\u7528\u91cd\u8bd5\u662f\u5426\u53ef\u4ee5\u89e3\u51b3\u95ee\u9898\u3002 \u8fd9\u91cc\u6211\u4eec\u5c06\u53ea\u4f7f\u7528 Linkerd CLI \uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u7528\u901a\u8fc7\u4f7f\u7528 -o wide \u6807\u5fd7\u5411\u6211\u4eec\u663e\u793a\u5b9e\u9645\u548c\u6709\u6548\u7684\u8bf7\u6c42\u91cf\u548c\u6210\u529f\u7387\uff0c Linkerd \u4eea\u8868\u76d8\u4f1a\u663e\u793a\u6574\u4f53\u6210\u529f\u7387\u548c RPS\uff0c\u4f46\u4e0d\u663e\u793a\u5b9e\u9645\u548c\u6709\u6548\u7684\u6307\u6807 \u3002\u5b9e\u9645\u6307\u6807\u548c\u6709\u6548\u6307\u6807\u4e4b\u95f4\u7684\u533a\u522b\u662f\uff1a \u5b9e\u9645\u503c\u6765\u81ea\u63a5\u6536\u8bf7\u6c42\u7684\u670d\u52a1\u5668\u7684\u89d2\u5ea6 \u6709\u6548\u503c\u662f\u4ece\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef\u7684\u89d2\u5ea6\u6765\u770b\u7684 \u5728\u6ca1\u6709\u91cd\u8bd5\u548c\u8d85\u65f6\u7684\u60c5\u51b5\u4e0b\uff0c\u663e\u7136\u8fd9\u4e24\u4e2a\u6570\u636e\u662f\u76f8\u540c\u7684\u3002\u4f46\u662f\uff0c\u4e00\u65e6\u914d\u7f6e\u4e86\u91cd\u8bd5\u6216\u8d85\u65f6\uff0c\u5b83\u4eec\u5c31\u53ef\u80fd\u4f1a\u4e0d\u4e00\u6837\u4e86\u3002\u4f8b\u5982\uff0c\u91cd\u8bd5\u4f1a\u4f7f\u5b9e\u9645\u7684 RPS \u9ad8\u4e8e\u6709\u6548\u7684 RPS\uff0c\u56e0\u4e3a\u4ece\u670d\u52a1\u5668\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u91cd\u8bd5\u662f\u53e6\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f46\u4ece\u5ba2\u6237\u7aef\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5b83\u662f\u540c\u4e00\u4e2a\u8bf7\u6c42\u3002\u91cd\u8bd5\u53ef\u4ee5\u4f7f\u5b9e\u9645\u6210\u529f\u7387\u4f4e\u4e8e\u6709\u6548\u6210\u529f\u7387\uff0c\u56e0\u4e3a\u5931\u8d25\u7684\u91cd\u8bd5\u8c03\u7528\u4e5f\u53d1\u751f\u5728\u670d\u52a1\u5668\u4e0a\uff0c\u4f46\u4e0d\u4f1a\u66b4\u9732\u7ed9\u5ba2\u6237\u7aef\u3002\u800c\u8d85\u65f6\u53ef\u80fd\u4f1a\u4ea7\u751f\u76f8\u53cd\u7684\u6548\u679c\uff1a\u8fd9\u53d6\u51b3\u4e8e\u5177\u4f53\u7684\u8fd4\u56de\u65f6\u95f4\uff0c\u4e00\u4e2a\u6700\u7ec8\u6210\u529f\u8fd4\u56de\u7684\u8d85\u65f6\u8bf7\u6c42\u53ef\u80fd\u4f1a\u4f7f\u5b9e\u9645\u6210\u529f\u7387\u9ad8\u4e8e\u6709\u6548\u6210\u529f\u7387\uff0c\u56e0\u4e3a\u670d\u52a1\u5668\u5c06\u5176\u89c6\u4e3a\u6210\u529f\uff0c\u800c\u5ba2\u6237\u7aef\u53ea\u770b\u5230\u5931\u8d25\u3002 \u603b\u7684\u6765\u8bf4\u5c31\u662f Linkerd \u7684\u5b9e\u9645\u548c\u6709\u6548\u6307\u6807\u5728\u91cd\u8bd5\u6216\u8d85\u65f6\u7684\u60c5\u51b5\u4e0b\u53ef\u80fd\u4f1a\u6709\u6240\u4e0d\u540c\uff0c\u4f46\u5b9e\u9645\u6570\u5b57\u4ee3\u8868\u5b9e\u9645\u547d\u4e2d\u670d\u52a1\u5668\u7684\u60c5\u51b5\uff0c\u800c\u6709\u6548\u6570\u5b57\u4ee3\u8868\u4e86\u5728 Linkerd \u7684\u53ef\u9760\u6027\u903b\u8f91\u5b8c\u6210\u5176\u804c\u8d23\u540e\uff0c\u5ba2\u6237\u7aef\u6709\u6548\u5730\u5f97\u5230\u4e86\u5bf9\u5176\u8bf7\u6c42\u7684\u54cd\u5e94\u3002 \u6bd4\u5982\u6211\u4eec\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b vote-bot \u670d\u52a1\u7684\u8def\u7531\u6307\u6807\u60c5\u51b5 $ linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -owide ROUTE SERVICE EFFECTIVE_SUCCESS EFFECTIVE_RPS ACTUAL_SUCCESS ACTUAL_RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 GET /api/list web-svc 100.00% 1.0rps 100.00% 1.0rps 1ms 2ms 2ms GET /api/vote web-svc 86.21% 1.0rps 86.21% 1.0rps 2ms 7ms 10ms [DEFAULT] web-svc - - - - - - - \u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a -o wide \u7684\u6807\u5fd7\uff0c\u8fd9\u6837\u8f93\u51fa\u7ed3\u679c\u4f1a\u5305\u542b\u5b9e\u9645\u548c\u6709\u6548\u7684\u6210\u529f\u548c RPS \u6307\u6807\u3002 \u4ece vote-bot \u670d\u52a1\u6765\u770b\uff0cweb \u670d\u52a1\u7684 /api/vote \u8def\u7531\u7684\u6709\u6548\u6210\u529f\u7387\u548c\u5b9e\u9645\u6210\u529f\u7387\u90fd\u4f4e\u4e8e 100%\uff0c\u8fd9\u662f\u56e0\u4e3a\u73b0\u5728\u6211\u4eec\u8fd8\u6ca1\u6709\u914d\u7f6e\u91cd\u8bd5\u3002 \u800c\u4e14\u6211\u4eec\u4e0d\u80fd\u5047\u8bbe\u6240\u6709\u8bf7\u6c42\u90fd\u662f\u53ef\u91cd\u8bd5\u7684\uff0c\u91cd\u8bd5\u8bf7\u6c42\u5bf9\u4e8e Linkerd \u6765\u8bf4\uff0c\u662f\u6709\u975e\u5e38\u5177\u4f53\u7684\u6761\u4ef6\u7684\uff1a \u73b0\u5728\uff0c\u4f7f\u7528 HTTP POST \u65b9\u6cd5\u7684\u8bf7\u6c42\u5728 Linkerd \u4e2d\u4e0d\u53ef\u91cd\u8bd5\u3002\u56e0\u4e3a POST \u8bf7\u6c42\u51e0\u4e4e\u603b\u662f\u5728\u8bf7\u6c42 body \u4e2d\u5305\u542b\u6570\u636e\uff0c\u91cd\u8bd5\u8bf7\u6c42\u610f\u5473\u7740\u4ee3\u7406\u5fc5\u987b\u5c06\u8be5\u6570\u636e\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u4fdd\u6301\u6700\u5c0f\u7684\u5185\u5b58\u4f7f\u7528\uff0c\u4ee3\u7406\u4e0d\u5b58\u50a8 POST \u8bf7\u6c42 body\uff0c\u5e76\u4e14\u5b83\u4eec\u4e0d\u80fd\u88ab\u91cd\u8bd5\u3002 \u6b63\u5982\u6211\u4eec\u524d\u9762\u63d0\u5230\u8fc7\u7684\uff0cLinkerd \u4ec5\u5c06\u54cd\u5e94\u4e2d\u7684 5XX \u72b6\u6001\u7801\u89c6\u4e3a\u9519\u8bef\uff0c\u800c 2XX \u548c 4XX \u90fd\u88ab\u8bc6\u522b\u4e3a\u6210\u529f\u72b6\u6001\u7801\u30024XX \u72b6\u6001\u7801\u8868\u793a\u670d\u52a1\u5668\u67e5\u770b\u4f46\u627e\u4e0d\u5230\u8d44\u6e90\uff0c\u8fd9\u5c5e\u4e8e\u670d\u52a1\u5668\u7684\u6b63\u786e\u884c\u4e3a\uff0c\u800c 5XX \u72b6\u6001\u7801\u8868\u793a\u670d\u52a1\u5668\u5728\u5904\u7406\u8bf7\u6c42\u65f6\u9047\u5230\u4e86\u9519\u8bef\uff0c\u8fd9\u662f\u4e0d\u6b63\u786e\u7684\u884c\u4e3a\u3002 \u73b0\u5728\u6211\u4eec\u901a\u8fc7\u5728 web \u670d\u52a1\u7684 /api/vote \u8def\u7531\u4e2d\u6dfb\u52a0\u91cd\u8bd5\u529f\u80fd\u6765\u9a8c\u8bc1\u4e0b\u524d\u9762\u7684\u77e5\u8bc6\u3002\u6211\u4eec\u518d\u6b21\u67e5\u770b\u4e0b web \u670d\u52a1\u7684 ServiceProfile \u5bf9\u8c61\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a # web-sp.yaml apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: name: web-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: routes: - condition: method: GET pathRegex: /api/list name: GET /api/list - condition: method: GET pathRegex: /api/vote name: GET /api/vote \u63a5\u7740\u6211\u4eec\u4e3a\u8def\u7531 /api/vote \u589e\u52a0\u4e00\u4e2a isRetryable: true \u7684\u5c5e\u6027\uff0c\u5982\u4e0b\u6240\u793a\uff1a # web-sp-with-retry.yaml # ...... - condition: method: GET pathRegex: /api/vote name: GET /api/vote isRetryable: true \u66f4\u65b0\u540e\u91cd\u65b0\u5e94\u7528\u8be5 ServiceProfile \u5bf9\u8c61\uff1a $ kubectl apply -f web-sp-with-retry.yaml \u5e94\u7528\u540e\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf vote-bot \u670d\u52a1\u7684\u8def\u7531\u6307\u6807\u53d8\u5316\u60c5\u51b5\uff1a $ watch linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide Every 2.0s: linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide MBP2022.local: Sun Aug 28 17:41:37 2022 ROUTE SERVICE EFFECTIVE_SUCCESS EFFECTIVE_RPS ACTUAL_SUCCESS ACTUAL_RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 GET /api/list web-svc 100.00% 1.0rps 100.00% 1.0rps 2ms 8ms 10ms GET /api/vote web-svc 85.00% 1.0rps 16.50% 5.0rps 4ms 255ms 290ms [DEFAULT] web-svc - - - - - - - \u53ef\u4ee5\u770b\u5230\u5b9e\u9645\u6210\u529f\u7387\u53d8\u5f97\u975e\u5e38\u5e95\u4e86\uff0c\u56e0\u4e3a\u91cd\u8bd5\u7684\u7ed3\u679c\u53ef\u80fd\u8fd8\u662f\u9519\u8bef\u3002 \u4e0a\u9762\u6211\u4eec\u63d0\u5230\u4e86 Linkerd \u7684\u91cd\u8bd5\u884c\u4e3a\u662f\u7531\u91cd\u8bd5\u9884\u7b97\u914d\u7f6e\u7684\uff0c\u5f53\u914d\u7f6e isRetryable: true \u7684\u65f6\u5019\uff0c\u4f1a\u5e94\u7528\u9ed8\u8ba4\u7684\u91cd\u8bd5\u9884\u7b97\u89c4\u5219\uff0c \u4ee5\u4e0b ServiceProfile \u8d44\u6e90\u7684 YAML \u7247\u6bb5\uff0c\u663e\u793a\u4e86\u5177\u6709\u9ed8\u8ba4\u503c\u7684 retryBudget \u5bf9\u8c61\u914d\u7f6e \uff1a spec: retryBudget: retryRatio: 0.2 minRetriesPerSecond: 10 ttl: 10s \u5176\u4e2d retryBudget \u53c2\u6570\u662f\u5177\u6709\u4e09\u4e2a\u4e3b\u8981\u7684\u5b57\u6bb5\uff1a retryRatio\uff1a\u91cd\u8bd5\u7387\uff0c\u8868\u793a\u91cd\u8bd5\u8bf7\u6c42\u4e0e\u539f\u59cb\u8bf7\u6c42\u7684\u6700\u5927\u6bd4\u7387\uff0cretryRatio \u4e3a 0.2 \u8868\u793a\u91cd\u8bd5\u6700\u591a\u4f1a\u589e\u52a0 20% \u7684\u8bf7\u6c42\u8d1f\u8f7d\u3002 minRetriesPerSecond\uff1a\u8fd9\u662f\u5728 retryRatio \u5141\u8bb8\u7684\u91cd\u8bd5\u4e4b\u5916\uff0c\u6bcf\u79d2\u5141\u8bb8\u7684\u91cd\u8bd5\u6b21\u6570\uff08\u8fd9\u5141\u8bb8\u5728\u8bf7\u6c42\u7387\u5f88\u4f4e\u65f6\u8fdb\u884c\u91cd\u8bd5\uff09\uff0c\u9ed8\u8ba4\u4e3a 10 RPS\u3002 ttl\uff1a\u8868\u793a\u5728\u8ba1\u7b97\u91cd\u8bd5\u7387\u65f6\u5e94\u8003\u8651\u591a\u957f\u65f6\u95f4\u7684\u8bf7\u6c42\uff0c\u4e00\u4e2a\u8f83\u5927\u7684\u503c\u4f1a\u8003\u8651\u4e00\u4e2a\u8f83\u5927\u7684\u7a97\u53e3\uff0c\u56e0\u6b64\u5141\u8bb8\u66f4\u591a\u7684\u91cd\u8bd5\u3002\u9ed8\u8ba4\u4e3a 10 \u79d2\u3002","title":"\u914d\u7f6e\u91cd\u8bd5"},{"location":"chap11/3linkered_ServiceProfile/#_4","text":"\u9664\u4e86\u91cd\u8bd5\u548c\u91cd\u8bd5\u9884\u7b97\u5916\uff0cLinkerd \u8fd8\u63d0\u4f9b\u8d85\u65f6\u529f\u80fd\uff0c\u5141\u8bb8\u4f60\u786e\u4fdd\u5bf9\u6307\u5b9a\u8def\u7531\u7684\u8bf7\u6c42\u6c38\u8fdc\u4e0d\u4f1a\u8d85\u8fc7\u6307\u5b9a\u7684\u65f6\u95f4\u3002 \u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e00\u70b9\uff0c\u8ba9\u6211\u4eec\u91cd\u65b0\u6765\u770b\u4e00\u770b web \u548c voting \u670d\u52a1\u7684\u6bcf\u4e2a\u8def\u7531\u6307\u6807\u3002 $ linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide $ linkerd viz routes deploy/web -n emojivoto --to deploy/voting -o wide \u5728\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u5230 web \u548c voting \u4e4b\u95f4\u7684\u5ef6\u8fdf\u63a5\u8fd1 1ms\uff0c\u4e3a\u4e86\u6f14\u793a\u8d85\u65f6\uff0c\u6211\u4eec\u5c06 /api/vote \u8def\u7531\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a 0.5ms\uff0c\u8fd9\u6837\u57fa\u672c\u4e0a\u90fd\u65e0\u6cd5\u6ee1\u8db3\u8981\u6c42\u5c31\u8d85\u65f6\u4e86\uff0cLinkerd \u4f1a\u5c06\u9519\u8bef\u53d1\u9001\u4f1a\u5ba2\u6237\u7aef\uff0c\u6210\u529f\u7387\u53d8\u4e3a 0 \u4e86\u3002 \u4fee\u6539 web \u670d\u52a1\u7684 ServiceProfile \u5bf9\u8c61\uff0c\u6dfb\u52a0 timeout \u5c5e\u6027\uff0c\u5982\u4e0b\u6240\u793a\uff1a # web-sp-with-timeout.yaml apiVersion: linkerd.io/v1alpha2 kind: ServiceProfile metadata: name: web-svc.emojivoto.svc.cluster.local namespace: emojivoto spec: routes: - condition: method: GET pathRegex: /api/list name: GET /api/list - condition: method: GET pathRegex: /api/vote name: GET /api/vote timeout: 0.5ms isRetryable: true \u5e94\u7528\u4e0a\u9762\u7684\u5bf9\u8c61\u540e\uff0c\u670d\u52a1\u7684\u6709\u6548\u548c\u5b9e\u9645\u6210\u529f\u7387\u5c31\u4f1a\u90fd\u4e0b\u964d\u5230 0\uff0c\u56e0\u4e3a /api/vote \u5728 0.5ms \u5185\u90fd\u4f1a\u8d85\u65f6\uff0c\u6240\u4ee5\u6210\u529f\u7387\u53d8\u4e3a 0\u3002 $ watch linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide Every 2.0s: linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide MBP2022.local: Sun Aug 28 19:12:15 2022 ROUTE SERVICE EFFECTIVE_SUCCESS EFFECTIVE_RPS ACTUAL_SUCCESS ACTUAL_RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 GET /api/list web-svc 100.00% 1.0rps 100.00% 1.0rps 2ms 2ms 2ms GET /api/vote web-svc 0.00% 1.0rps 0.00% 0.0rps 0ms 0ms 0ms [DEFAULT] web-svc \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u4e2d\u91cd\u8bd5\u548c\u8d85\u65f6\u4f7f\u7528\uff0c\u91cd\u8bd5\u548c\u8d85\u65f6\u662f Linkerd \u6574\u4f53\u7b56\u7565\u7684\u4e00\u90e8\u5206\uff0c\u7528\u4e8e\u5728\u51fa\u73b0\u77ac\u65f6\u6545\u969c\u65f6\u589e\u52a0\u53ef\u9760\u6027\u3002 \u6211\u4eec\u901a\u8fc7\u4f7f\u7528\u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u6bcf\u6761\u8def\u7531\u6307\u6807\u6765\u51b3\u5b9a\u4f55\u65f6\u4ee5\u53ca\u5982\u4f55\u914d\u7f6e\u91cd\u8bd5\u548c\u8d85\u65f6\u3002Linkerd \u7528\u91cd\u8bd5\u9884\u7b97\u4e3a\u5176\u91cd\u8bd5\u63d0\u4f9b\u53c2\u6570\uff0c\u53ef\u4ee5\u907f\u514d\u51fa\u73b0\"\u91cd\u8bd5\u98ce\u66b4\"\u7684\u60c5\u51b5\uff0c\u5f53\u91cd\u8bd5\u9884\u7b97\u7528\u5b8c\u65f6\uff0c\u4ee3\u7406\u5c06\u505c\u6b62\u5411\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\uff0c\u4ee5\u907f\u514d\u670d\u52a1\u8fc7\u8f7d\uff0c\u5e76\u53ef\u80fd\u5f71\u54cd\u5230\u5e94\u7528\u7a0b\u5e8f\u7684\u5176\u4ed6\u90e8\u5206\u3002","title":"\u914d\u7f6e\u8d85\u65f6"},{"location":"chap11/4linkered_mtls/","text":"4 \u5728 Linkerd \u4e2d\u4f7f\u7528 mTLS \u4fdd\u62a4\u5e94\u7528\u7a0b\u5e8f\u901a\u4fe1 \u5b89\u5168\u6027\u662f\u4e91\u539f\u751f\u5e94\u7528\u7a0b\u5e8f\u7684\u91cd\u4e2d\u4e4b\u91cd\uff0c\u867d\u7136\u5b89\u5168\u6027\u662f\u4e00\u4e2a\u975e\u5e38\u5e7f\u6cdb\u7684\u8bdd\u9898\uff0c\u4f46 Linkerd \u4f9d\u7136\u53ef\u4ee5\u53d1\u6325\u91cd\u8981\u4f5c\u7528\uff1a\u5176\u53cc\u5411 TLS\uff08mTLS\uff09\u529f\u80fd\u662f\u4e3a\u4e86\u5728 Kubernetes \u4e2d\u5b9e\u73b0\u96f6\u4fe1\u4efb\u7684\u5b89\u5168\u65b9\u6cd5\u3002\u96f6\u4fe1\u4efb\u5b89\u5168\u662f\u4e00\u79cd IT \u5b89\u5168\u6a21\u578b\uff0c\u8981\u6c42\u8bd5\u56fe\u8bbf\u95ee\u4e13\u7528\u7f51\u7edc\u4e0a\u8d44\u6e90\u7684\u6bcf\u4e00\u4e2a\u4eba\u548c\u6bcf\u4e00\u53f0\u8bbe\u5907\uff08\u65e0\u8bba\u4f4d\u4e8e\u7f51\u7edc\u8fb9\u754c\u4e4b\u5185\u8fd8\u662f\u4e4b\u5916\uff09\u90fd\u5fc5\u987b\u8fdb\u884c\u4e25\u683c\u7684\u8eab\u4efd\u9a8c\u8bc1\u3002 \u4ec0\u4e48\u662f mTLS \u5728\u4e91\u73af\u5883\u4e2d\u8d8a\u6765\u8d8a\u666e\u904d\u7684\u901a\u4fe1\u5b89\u5168\u65b9\u6cd5\u662f \u96f6\u4fe1\u4efb \u65b9\u6cd5\uff0c\u867d\u7136\u5bf9\u96f6\u4fe1\u4efb\u5b89\u5168\u7684\u5168\u9762\u5904\u7406\u8d85\u51fa\u4e86\u672c\u8282\u7684\u8303\u56f4\uff0c\u4f46\u6838\u5fc3\u76ee\u6807\u662f\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u5b89\u5168\u8fb9\u754c\u7f29\u5c0f\u5230\u5c3d\u53ef\u80fd\u5c0f\u7684\u7ea7\u522b \u3002 \u4f8b\u5982\uff0c\u4e0e\u5176\u5728\u6570\u636e\u4e2d\u5fc3\u5468\u56f4\u8bbe\u7f6e\u9632\u706b\u5899\uff0c\u5bf9\u8fdb\u5165\u7684\u6d41\u91cf\u5b9e\u65bd\u5b89\u5168\u4fdd\u62a4\uff0c\u7559\u4e0b\"\u8f6f\u5185\u90e8\"\u800c\u4e0d\u8fdb\u4e00\u6b65\u9a8c\u8bc1\uff0c\u4e0d\u5982\u8ba9\u6570\u636e\u4e2d\u5fc3\u7684\u6bcf\u4e2a\u5e94\u7528\u5728\u81ea\u5df1\u7684\u8fb9\u754c\u5b9e\u65bd\u5b89\u5168 \u3002 \u8fd9\u79cd\u96f6\u4fe1\u4efb\u7684\u65b9\u6cd5\u81ea\u7136\u9002\u5408\u4e91\u73af\u5883\uff0c\u56e0\u4e3a\u4e91\u73af\u5883\u4e2d\u7684\u5e95\u5c42\u786c\u4ef6\u548c\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u4e0d\u5728\u4f60\u7684\u63a7\u5236\u4e4b\u4e0b\u3002 Linkerd \u5b89\u5168\u6a21\u578b\u901a\u8fc7\u5728\u670d\u52a1\u4e4b\u95f4\u63d0\u4f9b\u900f\u660e\u7684\u53cc\u5411 TLS \u901a\u4fe1\u6765\u5b9e\u73b0\u96f6\u4fe1\u4efb\u5b89\u5168\uff0c\u53cc\u5411 TLS (mTLS) \u662f\u4e00\u79cd\u4f20\u8f93\u5b89\u5168\u5f62\u5f0f\uff0c\u53ef\u63d0\u4f9b\u901a\u4fe1\u7684\u673a\u5bc6\u6027\u548c\u8eab\u4efd\u9a8c\u8bc1\u3002 \u6362\u53e5\u8bdd\u8bf4\uff0c\u4e0d\u4ec5\u901a\u4fe1\u88ab\u52a0\u5bc6\uff0c\u800c\u4e14\u8eab\u4efd\u4e5f\u5728\u8fde\u63a5\u7684\u4e24\u7aef\u8fdb\u884c\u9a8c\u8bc1\uff08 mTLS \u7684\u53cc\u5411\u7ec4\u4ef6\u4e0e\u6d4f\u89c8\u5668\u4f7f\u7528\u7684 TLS \u4e0d\u540c\uff0c\u5b83\u53ea\u9a8c\u8bc1\u8fde\u63a5\u7684\u670d\u52a1\u5668\u7aef\uff0cmTLS \u9a8c\u8bc1\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7684\u8eab\u4efd \uff09\u3002 Linkerd \u7684\u76ee\u6807\u662f\u901a\u8fc7\u4f7f\u7528 mTLS \u5bf9 Kubernetes Pod \u4e4b\u95f4\u7684\u901a\u4fe1\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u548c\u52a0\u5bc6\uff0c\u5141\u8bb8\u4f60\u5bf9 Kubernetes \u96c6\u7fa4\u91c7\u7528\u96f6\u4fe1\u4efb\u65b9\u6cd5\u3002 \u9a8c\u8bc1\u662f\u7279\u522b\u91cd\u8981\u7684\uff0c \u867d\u7136\u5927\u591a\u6570\u4eba\u8ba4\u4e3a TLS \u7684\u4ef7\u503c\u5728\u4e8e\u52a0\u5bc6\uff0c\u4f46\u9a8c\u8bc1\u8fde\u63a5\u4e24\u8fb9\u5b9e\u4f53\u7684\u8eab\u4efd\u4e5f\u540c\u6837\u91cd\u8981 \u3002\u6bd5\u7adf\u53ea\u6709\u5728\u4f60\u80fd\u76f8\u4fe1\u4e0e\u4f60\u901a\u4fe1\u7684\u53e6\u4e00\u65b9\u7684\u5b9e\u4f53\u662f\u4ed6\u4eec\u6240\u8bf4\u7684\u4eba\u7684\u60c5\u51b5\u4e0b\uff0c\u52a0\u5bc6\u624d\u662f\u6709\u7528\u7684--\u6765\u81ea\u4e0d\u826f\u884c\u4e3a\u8005\u7684\u52a0\u5bc6\u4fe1\u606f\u4ecd\u7136\u662f\u6765\u81ea\u4e0d\u826f\u884c\u4e3a\u8005\u7684\u4fe1\u606f\u3002 \u5728 Linkerd \u4e2d\uff0c \u901a\u8fc7 mTLS \u9a8c\u8bc1\u7684\u8eab\u4efd\u4e0e Kubernetes ServiceAccounts \u76f8\u5173\u8054 \u3002\u8fd9\u610f\u5473\u7740 Linkerd \u7684 mTLS \u8eab\u4efd\u7cfb\u7edf\u4f7f\u7528\u4e0e Kubernetes \u7528\u4e8e\u4e3a\u96c6\u7fa4\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5efa\u7acb\u8eab\u4efd\u548c\u8bbf\u95ee\u63a7\u5236\u7684\u5b8c\u5168\u76f8\u540c\u7684\u6a21\u5f0f\uff0c\u800c\u4e0d\u662f\u53d1\u660e\u4e00\u4e2a\u65b0\u6846\u67b6\u3002 \u4f7f\u7528 Linkerd \u7684 mTLS Linkerd \u7684\u8bbe\u8ba1\u539f\u5219\u4e4b\u4e00\u662f\uff0c \u590d\u6742\u6027\u662f\u5b89\u5168\u7684\u654c\u4eba \u3002\u914d\u7f6e\u4e1c\u897f\u8d8a\u96be\uff0c\u4f7f\u7528\u5b83\u7684\u53ef\u80fd\u6027\u5c31\u8d8a\u5c0f; \u9009\u9879\u548c\u8bbe\u7f6e\u8d8a\u591a\uff0c\u5c31\u8d8a\u6709\u53ef\u80fd\u4e0d\u5c0f\u5fc3\u4ee5\u4e0d\u5b89\u5168\u7684\u65b9\u5f0f\u8fdb\u884c\u914d\u7f6e\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c Linkerd \u4e3a\u6240\u6709\u7f51\u683c\u4e2d\u7684 pod-to-pod \u901a\u4fe1\u542f\u7528\u4e86 mTLS \uff0c \u53ea\u8981\u53cc\u65b9\u90fd\u6ce8\u5165\u4e86\u6570\u636e\u5e73\u9762\u4ee3\u7406\uff0c\u90a3\u4e48\u606d\u559c\u4f60\uff1a\u4f60\u5df2\u7ecf\u5728\u670d\u52a1\u4e4b\u95f4\u9a8c\u8bc1\u4e86\u52a0\u5bc6\u7684 mTLS \u3002\u4e8b\u5b9e\u4e0a\uff0c\u524d\u9762\u6211\u4eec\u4f7f\u7528\u7684 Emojivoto \u5e94\u7528\u7a0b\u5e8f\u4e2d\u5c31\u5df2\u7ecf\u5728\u4f7f\u7528 mTLS \u4e86\uff0c\u53ea\u662f\u6211\u4eec\u6ca1\u6709\u610f\u8bc6\u5230\u800c\u5df2\u3002 \u5bf9\u5bf9\u4e8e Linkerd \u81ea\u52a8\u6dfb\u52a0 mTLS \u7684\u529f\u80fd\uff0c\u6709\u51e0\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u3002 \u4e24\u4e2a\u7aef\u70b9\u90fd\u5fc5\u987b\u5728\u7f51\u683c\u4e2d\u3002Linkerd \u9700\u8981\u540c\u65f6\u5904\u7406\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7aef\u7684\u8fde\u63a5\u624d\u80fd\u53d1\u6325\u5176 mTLS \u7684\u9b54\u529b\u3002 \u5728 Linkerd 2.8.1 \u548c\u66f4\u65e9\u7684\u7248\u672c\u4e2d\uff0cLinkerd \u53ea\u80fd\u4e3a HTTP \u548c gRPC \u6d41\u91cf\u6dfb\u52a0 mTLS\uff0c\u5373\u4f7f\u5982\u6b64\uff0c\u4e5f\u65e0\u6cd5\u9488\u5bf9\u67d0\u4e9b\u7c7b\u578b\u7684\u6743\u9650\u3001\u4e3b\u673a\u6216 Header \u6267\u884c\u8be5\u64cd\u4f5c\uff0c\u8fd9\u4e9b\u9650\u5236\u5728 Linkerd 2.9 \u4e2d\u5df2\u7ecf\u88ab\u79fb\u9664\uff0c \u5b83\u5c06 mTLS \u6dfb\u52a0\u5230\u6240\u6709\u7684 TCP \u6d41\u91cf\u4e2d\uff0c\u4e0d\u7ba1\u662f\u4ec0\u4e48\u534f\u8bae \u3002 \u5ba2\u6237\u7aef\u53d1\u8d77 TLS \u7684\u8fde\u63a5\u4e0d\u80fd\u7531 Linkerd \u8fdb\u884c mTLS \u3002\u76f8\u53cd\uff0cLinkerd \u4f1a\u5c06\u628a\u8fd9\u4e9b\u8fde\u63a5\u89c6\u4e3a TCP \u6d41\u91cf\u3002\u8bf7\u6ce8\u610f\uff0c\u8fd9\u4e5f\u610f\u5473\u7740 Linkerd \u53ea\u80fd\u4e3a\u8fd9\u4e9b\u8fde\u63a5\u63d0\u4f9b TCP \u7ea7\u522b\u7684\u6307\u6807\u3002 \u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u6765\u4e86\u89e3\u4e0b mTLS \u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u4ee5\u53ca\u5982\u4f55\u9a8c\u8bc1\u6211\u4eec\u7684\u8fde\u63a5\u662f\u5426\u786e\u5b9e\u5177\u6709 mTLS\u3002 Linkerd Identity \u7ec4\u4ef6 \u5728\u524d\u9762\u8bb2\u89e3 Linkerd \u67b6\u6784\u7684\u65f6\u5019\u6211\u4eec\u5c31\u8ba8\u8bba\u8fc7 Linkerd \u63a7\u5236\u5e73\u9762\u7684 Identity \u7ec4\u4ef6\uff0c\u5b83\u4f5c\u4e3a CA \u6216\u8bc1\u4e66\u9881\u53d1\u673a\u6784\u6240\u626e\u6f14\u7684\u89d2\u8272\u3002\u8bc1\u4e66\u9881\u53d1\u673a\u6784\u662f\u9881\u53d1\u6570\u5b57\u8bc1\u4e66\u5e76\u4f7f\u8eab\u4efd\u7ec4\u4ef6\u6210\u4e3a\u6570\u5b57\u8bc1\u4e66\u9881\u53d1\u8005\u7684\u5b9e\u4f53 \u3002 Linkerd \u4f7f\u7528\u7684\u8bc1\u4e66\u4e0e\u7f51\u7ad9\u7528\u6765\u9a8c\u8bc1\u5176\u8eab\u4efd\u7684 TLS \u8bc1\u4e66\u201c\u7c7b\u578b\u201d\u76f8\u540c\u3002\u4e0e\u7f51\u7ad9\u4e0d\u540c\uff0c\u8fd9\u4e9b\u8bc1\u4e66\u4e0d\u7ecf\u8fc7 Verisign \u7b49\u7b2c\u4e09\u65b9\u5b9e\u4f53\u7684\u9a8c\u8bc1\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0d\u9700\u8981\u9a8c\u8bc1\uff0c\u5b83\u4eec\u4ec5\u4f9b Linkerd \u4ee3\u7406\u5728\u96c6\u7fa4\u5185\u4f7f\u7528\u3002 Linkerd \u7684 CA\uff08Identity \u670d\u52a1\uff09\u4f5c\u4e3a Linkerd \u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u3002 \u5728\u8be5\u90e8\u7f72\u8fc7\u7a0b\u4e2d\uff0cLinkerd CLI \u5c06\u751f\u6210\u4e00\u4e2a\u8bc1\u4e66\u5e76\u5c06\u5176\u5b58\u50a8\u5728 Linkerd \u547d\u540d\u7a7a\u95f4\u4e2d\u540d\u4e3a linkerd-identity-token-XXXXX \u7684 Kubernetes Secret \u4e2d\u3002 $ kubectl get secret -n linkerd NAME TYPE DATA AGE linkerd-identity-issuer Opaque 2 11d linkerd-identity-token-nqhbk kubernetes.io/service-account-token 3 11d # ...... \u901a\u8fc7\u67e5\u770b Secret \u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u524d\u7f00\u4e3a linkerd-identity-token- \u7684 Secret \u5bf9\u8c61\uff0c \u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u5bfc\u51fa\u6765\u8fdb\u884c\u67e5\u770b\uff1a $ kubectl get secret -n linkerd linkerd-identity-token-nqhbk -o yaml apiVersion: v1 data: ca.crt: <ca.crt> namespace: bGlua2VyZA== token: <token> kind: Secret metadata: annotations: kubernetes.io/service-account.name: linkerd-identity kubernetes.io/service-account.uid: cdc3d8fd-0e02-4b17-88ce-d2cc0a9e4907 name: linkerd-identity-token-nqhbk namespace: linkerd type: kubernetes.io/service-account-token \u8f93\u51fa\u7684\u6570\u636e\u90e8\u5206\u4e2d\u540d\u4e3a ca.crt \u7684\u5b57\u6bb5\u5c31\u662f\u5728 Linkerd \u5b89\u88c5\u671f\u95f4\u751f\u6210\u7684 UTF-8 \u7f16\u7801\u7684\u6839\u8bc1\u4e66\u3002\u6b64\u8bc1\u4e66\u79f0\u4e3a\u201c\u4fe1\u4efb\u4e4b\u951a\u201d\uff0c\u56e0\u4e3a\u5b83\u662f\u7528\u4f5c\u9881\u53d1\u7ed9\u4ee3\u7406\u7684\u6240\u6709\u8bc1\u4e66\u7684\u57fa\u7840\u3002 \u4fe1\u4efb\u951a\u8fd8\u7528\u4e8e\u5728\u5b89\u88c5\u65f6\u521b\u5efa\u53e6\u4e00\u4e2a\u8bc1\u4e66\u548c\u5bc6\u94a5\u5bf9\uff1a \u9881\u53d1\u8005\u51ed\u636e\uff0c\u8fd9\u4e9b\u5b58\u50a8\u5728\u540d\u4e3a linkerd-identity-issuer \u7684\u5355\u72ec Kubernetes Secret \u4e2d\u3002\u9881\u53d1\u8005\u51ed\u636e\u7528\u4e8e\u5411 Linkerd proxy \u9881\u53d1\u8bc1\u4e66\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u6765\u67e5\u770b\u8be5 Secret \u7684\u6570\u636e \u3002 $ kubectl get secret -n linkerd linkerd-identity-issuer -o yaml apiVersion: v1 data: crt.pem: <crt.pem> key.pem: <key.pem> kind: Secret metadata: labels: linkerd.io/control-plane-component: identity linkerd.io/control-plane-ns: linkerd name: linkerd-identity-issuer namespace: linkerd type: Opaque \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8fd9\u4e9b\u5bc6\u94a5\u5411\u4ee3\u7406\u9881\u53d1\u8bc1\u4e66\u4ee5\u542f\u7528 mTLS\u3002 Linkerd \u4ee3\u7406\u5982\u4f55\u83b7\u53d6\u8bc1\u4e66 \u9996\u5148\uff0c\u5f53 Pod \u88ab\u6ce8\u5165 Linkerd \u4ee3\u7406\u65f6\uff0c\u8be5\u4ee3\u7406\u4f1a\u5411 Linkerd \u7684\u8eab\u4efd\u670d\u52a1\u53d1\u9001\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42 (CSR)\u3002 \u8eab\u4efd\u670d\u52a1\u4f7f\u7528\u9881\u53d1\u8005\u51ed\u636e\u5411\u8be5\u4ee3\u7406\u9881\u53d1\u7b7e\u540d\u8bc1\u4e66\uff08CSR \u7684\u4f5c\u7528\u57df\u662f\u8fd0\u884c Pod \u7684 Kubernetes ServiceAccount\uff0c\u56e0\u6b64\u751f\u6210\u7684\u8bc1\u4e66\u4e0e\u8be5 ServiceAccount \u76f8\u5173\u8054\uff09\uff0c\u8bc1\u4e66\u5c06\u5728 24 \u5c0f\u65f6\u540e\u8fc7\u671f\u3002 \u5728\u8bc1\u4e66\u8fc7\u671f\u524d\uff0c\u4ee3\u7406\u5411\u8eab\u4efd\u670d\u52a1\u53d1\u9001\u65b0\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff0c \u83b7\u53d6\u65b0\u8bc1\u4e66 \uff1b \u8fd9\u4e2a\u8fc7\u7a0b\u5728 Linkerd \u4ee3\u7406\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u5185\u90fd\u4f1a\u6301\u7eed\uff0c\u8fd9\u79f0\u4e3a\u8bc1\u4e66\u8f6e\u6362\uff0c\u662f\u4e00\u79cd\u5c06\u8bc1\u4e66\u6cc4\u9732\u9020\u6210\u7684\u635f\u5931\u964d\u81f3\u6700\u4f4e\u7684\u81ea\u52a8\u5316\u65b9\u5f0f\uff1a \u5728\u6700\u574f\u7684\u60c5\u51b5\u4e0b\uff0c\u4efb\u4f55\u6cc4\u9732\u7684\u8bc1\u4e66\u53ea\u80fd\u4f7f\u7528 24 \u5c0f\u65f6 \u3002 linkerd check \u547d\u4ee4\u6709\u4e00\u79cd\u7b80\u5355\u7684\u65b9\u6cd5\u6765\u786e\u4fdd\u4ee3\u7406\u90fd\u5177\u6709\u7531\u8eab\u4efd\u670d\u52a1\u9881\u53d1\u7684\u8bc1\u4e66\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u901a\u8fc7\u4f20\u9012 --proxy \u6807\u5fd7\u6765\u68c0\u67e5\u4ee3\u7406\u7684\u72b6\u6001\u3002 # \u4f7f\u7528 --proxy \u6807\u5fd7\u5728\u6570\u636e\u5e73\u9762\u68c0\u67e5\u4ee3\u7406 $ linkerd check --proxy # ...... linkerd-identity ---------------- \u221a certificate config is valid \u221a trust anchors are using supported crypto algorithm \u221a trust anchors are within their validity period \u221a trust anchors are valid for at least 60 days \u221a issuer cert is using supported crypto algorithm \u221a issuer cert is within its validity period \u221a issuer cert is valid for at least 60 days \u221a issuer cert is issued by the trust anchor linkerd-identity-data-plane --------------------------- \u221a data plane proxies certificate match CA # ...... Status check results are \u221a \u4e0a\u9762\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\u5305\u62ec\u4e00\u4e2a linkerd-identity-data-plane \u90e8\u5206\uff0c\u7528\u6765\u6307\u793a\u4ee3\u7406\u662f\u5426\u6b63\u5728\u4f7f\u7528\u7531\u4fe1\u4efb\u951a\u9881\u53d1\u7684\u8bc1\u4e66\u3002 linkerd-identity-data-plane --------------------------- \u221a data plane proxies certificate match CA \u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 Linkerd \u4ee3\u7406\u548c\u8eab\u4efd\u670d\u52a1\u4e2d\u5f00\u542f debug \u6a21\u5f0f\uff0c\u4ee5\u67e5\u770b\u4ee3\u7406\u5c06 CSR \u53d1\u9001\u5230\u8eab\u4efd\u670d\u52a1\u5e76\u53d6\u56de\u8bc1\u4e66\u3002 $ kubectl get deploy -n linkerd NAME READY UP-TO-DATE AVAILABLE AGE linkerd-destination 1/1 1 1 11d linkerd-identity 1/1 1 1 11d linkerd-proxy-injector 1/1 1 1 11d $ kubectl edit deploy linkerd-identity -n linkerd # ...... spec: containers: - args: - identity - -log-level=debug # \u8bbe\u7f6e\u4e3a debug \u6a21\u5f0f - -log-format=plain - -controller-namespace=linkerd - -identity-trust-domain=cluster.local - -identity-issuance-lifetime=24h0m0s - -identity-clock-skew-allowance=20s - -identity-scheme=linkerd.io/tls # ...... \u5f53\u8eab\u4efd\u670d\u52a1\u91cd\u65b0\u66f4\u65b0\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf\u5bf9\u5e94 Pod \u7684\u65e5\u5fd7\u4fe1\u606f\uff1a $ kubectl logs -f -n linkerd deploy/linkerd-identity -c identity \u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u8f93\u51fa\u5f88\u591a\u65e5\u5fd7\u5230\u63a7\u5236\u53f0\uff0c\u5728 Linkerd \u8eab\u4efd\u65e5\u5fd7\u8f93\u51fa\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Request Body \u548c Response Body \u76f8\u5173\u7684\u8f93\u51fa\uff0c\u5176\u4e2d\u5305\u62ec\u4e00\u4e2a\u5f88\u957f\u7684 UTF-8 \u7f16\u7801\u6570\u636e\uff0c\u5373 CSR \u548c\u9881\u53d1\u7ed9\u4ee3\u7406\u7684\u8bc1\u4e66\uff1a # ...... time=\"2022-08-30T07:39:17Z\" level=debug msg=\"Issuer has been updated\" time=\"2022-08-30T07:39:17Z\" level=info msg=\"starting admin server on :9990\" time=\"2022-08-30T07:39:17Z\" level=info msg=\"starting gRPC server on :8080\" time=\"2022-08-30T07:39:17Z\" level=debug msg=\"Validating token for linkerd-identity.linkerd.serviceaccount.identity.linkerd.cluster.local\" I0830 07:39:17.291787 1 request.go:1123] Request Body: {\"kind\":\"TokenReview\",\"apiVersion\":\"authentication.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"token\":\"<......>\"},\"status\":{\"user\":{}}} # ...... I0830 07:39:17.291969 1 round_trippers.go:435] curl -k -v -XPOST -H \"Accept: application/json, */*\" -H \"Content-Type: application/json\" -H \"User-Agent: controller/v0.0.0 (linux/amd64) kubernetes/$Format\" -H \"Authorization: Bearer <masked>\" 'https://10.96.0.1:443/apis/authentication.k8s.io/v1/tokenreviews' I0830 07:39:17.293883 1 round_trippers.go:454] POST https://10.96.0.1:443/apis/authentication.k8s.io/v1/tokenreviews 201 Created in 1 milliseconds # ...... I0830 07:39:17.294241 1 request.go:1123] Response Body: {\"kind\":\"TokenReview\",\"apiVersion\":\"authentication.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null,\"managedFields\":[{\"manager\":\"controller\",\"operation\":\"Update\",\"apiVersion\":\"authentication.k8s.io/v1\",\"time\":\"2022-08-30T07:39:17Z\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:token\":{}}}}]},\"spec\":{\"token\":\"<token>\"},\"status\":{\"authenticated\":true,\"user\":{\"username\":\"system:serviceaccount:linkerd:linkerd-identity\",\"uid\":\"cdc3d8fd-0e02-4b17-88ce-d2cc0a9e4907\",\"groups\":[\"system:serviceaccounts\",\"system:serviceaccounts:linkerd\",\"system:authenticated\"],\"extra\":{\"authentication.kubernetes.io/pod-name\":[\"linkerd-identity-5d9b874d66-m77ps\"],\"authentication.kubernetes.io/pod-uid\":[\"2f147d37-1616-487a-b7aa-1805b84c026a\"]}},\"audiences\":[\"https://kubernetes.default.svc.cluster.local\"]}} # ...... \u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u67e5\u770b\u4e0b Emojivoto \u5e94\u7528\u670d\u52a1\u4e4b\u95f4\u7684\u5b89\u5168\u6027\u3002\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd viz edges \u547d\u4ee4\u6765\u67e5\u770b\u4e0b Pod \u4e4b\u95f4\u662f\u5982\u4f55\u8fde\u63a5\u7684\u3002 $ linkerd viz edges po -n emojivoto SRC DST SRC_NS DST_NS SECURED vote-bot-6d7677bb68-jvxsg web-5f86686c4d-58p7k emojivoto emojivoto \u221a web-5f86686c4d-58p7k emoji-696d9d8f95-5vn9w emojivoto emojivoto \u221a web-5f86686c4d-58p7k voting-ff4c54b8d-xhjv7 emojivoto emojivoto \u221a prometheus-7bbc4d8c5b-5rc8r emoji-696d9d8f95-5vn9w linkerd-viz emojivoto \u221a prometheus-7bbc4d8c5b-5rc8r vote-bot-6d7677bb68-jvxsg linkerd-viz emojivoto \u221a prometheus-7bbc4d8c5b-5rc8r voting-ff4c54b8d-xhjv7 linkerd-viz emojivoto \u221a prometheus-7bbc4d8c5b-5rc8r web-5f86686c4d-58p7k linkerd-viz emojivoto \u221a \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\u6700\u540e\u5305\u542b\u4e00\u5217 SECURED \uff0c\u8868\u793a\u662f\u5426\u662f\u5b89\u5168\u7684\u8fde\u63a5\uff0c\u4e0b\u9762\u7684\u503c\u5747\u4e3a \u221a \uff0c\u8868\u793a\u662f\u5b89\u5168\u7684\u8fde\u63a5\u3002 \u7136\u540e\u6211\u4eec\u518d\u6b21\u4f7f\u7528 linkerd viz tap \u547d\u4ee4\u6765\u6355\u83b7\u5b9e\u65f6\u6d41\u91cf\uff0c\u5728\u8f93\u51fa\u7684\u4fe1\u606f\u4e2d\u4e5f\u5305\u542b\u4e00\u4e2a tls=true \u7684\u6807\u7b7e\u503c\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz tap deploy web -n emojivoto req id=0:0 proxy=in src=10.244.1.165:47130 dst=10.244.1.176:8080 tls=true :method=GET :authority=web-svc.emojivoto:80 :path=/api/list req id=0:1 proxy=out src=10.244.1.176:42096 dst=10.244.1.188:8080 tls=true :method=POST :authority=emoji-svc.emojivoto:8080 :path=/emojivoto.v1.EmojiService/ListAll rsp id=0:1 proxy=out src=10.244.1.176:42096 dst=10.244.1.188:8080 tls=true :status=200 latency=2731\u00b5s # ...... \u5230\u8fd9\u91cc\u9762\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u7684 Identity \u7ec4\u4ef6\u5982\u4f55\u5411\u6570\u636e\u5e73\u9762\u4e2d\u7684 Linkerd \u4ee3\u7406\u9881\u53d1\u8bc1\u4e66\uff0c \u4ee5\u53ca Linkerd \u5728\u4ee3\u7406\u4e2d\u7684 mTLS \u5b9e\u73b0\u5982\u4f55\u4f7f\u7528\u8fd9\u4e9b\u8bc1\u4e66\u6765\u52a0\u5bc6\u901a\u4fe1\u5e76\u9a8c\u8bc1\u53cc\u65b9\u7684\u8eab\u4efd \u3002 \u81ea\u52a8\u8f6e\u6362\u63a7\u5236\u5668\u5e73\u9762 TLS \u51ed\u8bc1 Linkerd \u7684\u81ea\u52a8 mTLS \u529f\u80fd\u4f7f\u7528\u4e00\u7ec4 TLS \u51ed\u636e\u4e3a\u4ee3\u7406\u751f\u6210 TLS \u8bc1\u4e66\uff1a \u4fe1\u4efb\u951a(trust anchor)\u3001\u9881\u53d1\u8005\u8bc1\u4e66(issuer certificate)\u548c\u79c1\u94a5(private key) \u3002 \u867d\u7136 Linkerd \u6bcf 24 \u5c0f\u65f6\u81ea\u52a8\u8f6e\u6362\u6570\u636e\u5e73\u9762\u4ee3\u7406\u7684 TLS \u8bc1\u4e66\uff0c\u4f46\u5b83\u4e0d\u4f1a\u8f6e\u6362\u7528\u4e8e\u9881\u53d1\u8fd9\u4e9b\u8bc1\u4e66\u7684 TLS \u51ed\u636e\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u4e0b\u5982\u4f55\u4f7f\u7528 Cert-manager \u8fdb\u884c\u81ea\u52a8\u8f6e\u6362\u9881\u53d1\u8005\u8bc1\u4e66\u548c\u79c1\u94a5\u3002 Cert-manager Cert-manager \u662f\u4e00\u4e2a\u975e\u5e38\u6d41\u884c\u7684\u4e91\u539f\u751f\u8bc1\u4e66\u7ba1\u7406\u5de5\u5177\u3002 Cert-manager \u5c06\u8bc1\u4e66\u548c\u8bc1\u4e66\u9881\u53d1\u8005\u4f5c\u4e3a CRD \u8d44\u6e90\u7c7b\u578b\u6dfb\u52a0\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u7b80\u5316\u4e86\u83b7\u53d6\u3001\u66f4\u65b0\u548c\u4f7f\u7528\u8fd9\u4e9b\u8bc1\u4e66\u7684\u8fc7\u7a0b\u3002\u5b83\u53ef\u4ee5\u4ece\u5404\u79cd\u53d7\u652f\u6301\u7684\u6765\u6e90\u53d1\u5e03\u8bc1\u4e66\uff0c \u5305\u62ec Let's Encrypt\u3001 HashiCorp Vault \u548c Venafi \u4ee5\u53ca\u79c1\u6709 PKI \u3002\u5b83\u5c06\u786e\u4fdd\u8bc1\u4e66\u6709\u6548\u5e76\u4e14\u662f\u6700\u65b0\u7684\uff0c\u5e76\u5c1d\u8bd5\u5728\u8bc1\u4e66\u5230\u671f\u524d\u7684\u914d\u7f6e\u65f6\u95f4\u66f4\u65b0\u8bc1\u4e66\u3002 Cert-manager \u7684\u5b89\u88c5\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e00\u952e\u5b89\u88c5\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.9.1/cert-manager.yaml \u9ed8\u8ba4\u4f1a\u5c06\u76f8\u5173\u8d44\u6e90\u5b89\u88c5\u5230\u4e00\u4e2a\u540d\u4e3a cert-manager \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff1a $ kubectl get pods -n cert-manager NAME READY STATUS RESTARTS AGE cert-manager-55649d64b4-kdcfk 1/1 Running 0 43s cert-manager-cainjector-666db4777-cp2dn 1/1 Running 0 43s cert-manager-webhook-6466bc8f4-5lvw5 1/1 Running 0 43s \u9881\u53d1\u8bc1\u4e66 \u63a5\u4e0b\u6765\u6211\u4eec\u4f7f\u7528 step \u5de5\u5177\u521b\u5efa\u4e00\u4e2a\u7b7e\u540d\u5bc6\u94a5\u5bf9\uff0c\u5e76\u5c06\u5176\u5b58\u50a8\u5728 Kubernetes \u7684\u4e00\u4e2a Secret \u5bf9\u8c61\u4e2d \u3002 $ step certificate create root.linkerd.cluster.local ca.crt ca.key \\ --profile root-ca --no-password --insecure Your certificate has been saved in ca.crt. Your private key has been saved in ca.key. \u7136\u540e\u5c06\u751f\u6210\u7684 ca.crt \u548c ca.key \u4fdd\u5b58\u5230 Secret \u5bf9\u8c61\u4e2d\uff1a $ kubectl create secret tls linkerd-trust-anchor --cert=ca.crt --key=ca.key -n secret/linkerd-trust-anchor created \u6709\u4e86 Secret\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u5f15\u7528\u5bc6\u94a5\u7684\u8bc1\u4e66\u9881\u53d1\u8005 Issuer \u8d44\u6e90\uff1a $ cat <<EOF | kubectl apply -f - apiVersion: cert-manager.io/v1 kind: Issuer metadata: name: linkerd-trust-anchor namespace: linkerd spec: ca: secretName: linkerd-trust-anchor EOF $ kubectl get issuer -n linkerd NAME READY AGE linkerd-trust-anchor True 84s \u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u9881\u53d1\u8bc1\u4e66\u4e86\uff0c \u5e76\u5c06\u5b83\u4eec\u5199\u5165\u5230\u4e00\u4e2a Secret \u5bf9\u8c61\u4e2d\uff0c\u6700\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a cert-manager \"Certificate\" \u8d44\u6e90\uff0c \u5b83\u4f7f\u7528\u8fd9\u4e2a Issuer \u6765\u751f\u6210\u6240\u9700\u7684\u8bc1\u4e66 \uff1a $ cat <<EOF | kubectl apply -f - apiVersion: cert-manager.io/v1 kind: Certificate metadata: name: linkerd-identity-issuer namespace: linkerd spec: secretName: linkerd-identity-issuer duration: 48h renewBefore: 25h issuerRef: name: linkerd-trust-anchor kind: Issuer commonName: identity.linkerd.cluster.local dnsNames: - identity.linkerd.cluster.local isCA: true privateKey: algorithm: ECDSA usages: - cert sign - crl sign - server auth - client auth EOF $ kubectl get certificate -n linkerd NAME READY SECRET AGE linkerd-identity-issuer True linkerd-identity-issuer 17s \u5728\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\uff0c duration \u6307\u793a cert-manager \u5c06\u8bc1\u4e66\u89c6\u4e3a\u6709\u6548\u671f 48 \u5c0f\u65f6\uff0c\u800c renewBefore \u6307\u793a cert-manager \u5c06\u5c1d\u8bd5\u5728\u5f53\u524d\u8bc1\u4e66\u5230\u671f\u524d 25 \u5c0f\u65f6\u9881\u53d1\u65b0\u8bc1\u4e66 \u3002 \u6b64\u65f6\uff0ccert-manager \u73b0\u5728\u53ef\u4ee5\u4f7f\u7528\u6b64\u8bc1\u4e66\u8d44\u6e90\u83b7\u53d6 TLS \u51ed\u636e\uff0c\u8be5\u51ed\u636e\u5c06\u5b58\u50a8\u5728\u540d\u4e3a linkerd-identity-issuer \u7684 Secret \u4e2d\uff0c\u8981\u9a8c\u8bc1\u60a8\u65b0\u9881\u53d1\u7684\u8bc1\u4e66\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4 \uff1a $ kubectl get secret linkerd-identity-issuer -o yaml -n linkerd apiVersion: v1 data: ca.crt: <ca.crt> crt.pem: <crt.pem> key.pem: <key.pem> tls.crt: <tls.crt> tls.key: <tls.key> kind: Secret metadata: name: linkerd-identity-issuer namespace: linkerd type: Opaque \u73b0\u5728\u6211\u4eec\u53ea\u9700\u8981\u901a\u77e5 Linkerd \u4f7f\u7528\u8fd9\u4e9b\u51ed\u636e\u5c31\u53ef\u4ee5\u4e86\u3002 \u7531\u4e8e\u6211\u4eec\u662f\u901a\u8fc7 linkerd \u547d\u4ee4\u884c\u5de5\u5177\u8fdb\u884c\u5b89\u88c5\u7684\uff0cLinkerd \u63a7\u5236\u5e73\u9762\u9ed8\u8ba4\u4f1a\u901a\u8fc7 --identity-external-issuer \u6807\u5fd7\u8fdb\u884c\u5b89\u88c5\uff0c\u8be5\u6807\u5fd7\u6307\u793a Linkerd \u4ece linkerd-identity-issuer \u7684 Secret \u8bfb\u53d6\u8bc1\u4e66\u3002 \u6bcf\u5f53\u66f4\u65b0\u5b58\u50a8\u5728 Secret \u4e2d\u7684 certificate \u548c key \u65f6\uff0c identity \u670d\u52a1\u5c06\u81ea\u52a8\u68c0\u6d4b\u6b64\u66f4\u6539\u5e76\u91cd\u65b0\u52a0\u8f7d\u65b0\u51ed\u636e\u3002 \u8fd9\u6837\u6211\u4eec\u5c31\u8bbe\u7f6e\u4e86 Linkerd \u63a7\u5236\u5e73\u9762 TLS \u51ed\u636e\u7684\u81ea\u52a8\u8f6e\u6362\uff0c\u5982\u679c\u4f60\u60f3\u76d1\u63a7\u66f4\u65b0\u8fc7\u7a0b\uff0c\u4f60\u53ef\u4ee5\u68c0\u67e5\u670d\u52a1\u53d1\u51fa\u7684 IssuerUpdated \u4e8b\u4ef6 \uff1a $ kubectl get events --field-selector reason=IssuerUpdated -n linkerd LAST SEEN TYPE REASON OBJECT MESSAGE 2m37s Normal IssuerUpdated deployment/linkerd-identity Updated identity issuer \u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6267\u884c\u4e86 Updated identity issuer \u3002","title":"4 \u5728 Linkerd \u4e2d\u4f7f\u7528 mTLS \u4fdd\u62a4\u5e94\u7528\u7a0b\u5e8f\u901a\u4fe1"},{"location":"chap11/4linkered_mtls/#4-linkerd-mtls","text":"\u5b89\u5168\u6027\u662f\u4e91\u539f\u751f\u5e94\u7528\u7a0b\u5e8f\u7684\u91cd\u4e2d\u4e4b\u91cd\uff0c\u867d\u7136\u5b89\u5168\u6027\u662f\u4e00\u4e2a\u975e\u5e38\u5e7f\u6cdb\u7684\u8bdd\u9898\uff0c\u4f46 Linkerd \u4f9d\u7136\u53ef\u4ee5\u53d1\u6325\u91cd\u8981\u4f5c\u7528\uff1a\u5176\u53cc\u5411 TLS\uff08mTLS\uff09\u529f\u80fd\u662f\u4e3a\u4e86\u5728 Kubernetes \u4e2d\u5b9e\u73b0\u96f6\u4fe1\u4efb\u7684\u5b89\u5168\u65b9\u6cd5\u3002\u96f6\u4fe1\u4efb\u5b89\u5168\u662f\u4e00\u79cd IT \u5b89\u5168\u6a21\u578b\uff0c\u8981\u6c42\u8bd5\u56fe\u8bbf\u95ee\u4e13\u7528\u7f51\u7edc\u4e0a\u8d44\u6e90\u7684\u6bcf\u4e00\u4e2a\u4eba\u548c\u6bcf\u4e00\u53f0\u8bbe\u5907\uff08\u65e0\u8bba\u4f4d\u4e8e\u7f51\u7edc\u8fb9\u754c\u4e4b\u5185\u8fd8\u662f\u4e4b\u5916\uff09\u90fd\u5fc5\u987b\u8fdb\u884c\u4e25\u683c\u7684\u8eab\u4efd\u9a8c\u8bc1\u3002","title":"4 \u5728 Linkerd \u4e2d\u4f7f\u7528 mTLS \u4fdd\u62a4\u5e94\u7528\u7a0b\u5e8f\u901a\u4fe1"},{"location":"chap11/4linkered_mtls/#mtls","text":"\u5728\u4e91\u73af\u5883\u4e2d\u8d8a\u6765\u8d8a\u666e\u904d\u7684\u901a\u4fe1\u5b89\u5168\u65b9\u6cd5\u662f \u96f6\u4fe1\u4efb \u65b9\u6cd5\uff0c\u867d\u7136\u5bf9\u96f6\u4fe1\u4efb\u5b89\u5168\u7684\u5168\u9762\u5904\u7406\u8d85\u51fa\u4e86\u672c\u8282\u7684\u8303\u56f4\uff0c\u4f46\u6838\u5fc3\u76ee\u6807\u662f\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u5b89\u5168\u8fb9\u754c\u7f29\u5c0f\u5230\u5c3d\u53ef\u80fd\u5c0f\u7684\u7ea7\u522b \u3002 \u4f8b\u5982\uff0c\u4e0e\u5176\u5728\u6570\u636e\u4e2d\u5fc3\u5468\u56f4\u8bbe\u7f6e\u9632\u706b\u5899\uff0c\u5bf9\u8fdb\u5165\u7684\u6d41\u91cf\u5b9e\u65bd\u5b89\u5168\u4fdd\u62a4\uff0c\u7559\u4e0b\"\u8f6f\u5185\u90e8\"\u800c\u4e0d\u8fdb\u4e00\u6b65\u9a8c\u8bc1\uff0c\u4e0d\u5982\u8ba9\u6570\u636e\u4e2d\u5fc3\u7684\u6bcf\u4e2a\u5e94\u7528\u5728\u81ea\u5df1\u7684\u8fb9\u754c\u5b9e\u65bd\u5b89\u5168 \u3002 \u8fd9\u79cd\u96f6\u4fe1\u4efb\u7684\u65b9\u6cd5\u81ea\u7136\u9002\u5408\u4e91\u73af\u5883\uff0c\u56e0\u4e3a\u4e91\u73af\u5883\u4e2d\u7684\u5e95\u5c42\u786c\u4ef6\u548c\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u4e0d\u5728\u4f60\u7684\u63a7\u5236\u4e4b\u4e0b\u3002 Linkerd \u5b89\u5168\u6a21\u578b\u901a\u8fc7\u5728\u670d\u52a1\u4e4b\u95f4\u63d0\u4f9b\u900f\u660e\u7684\u53cc\u5411 TLS \u901a\u4fe1\u6765\u5b9e\u73b0\u96f6\u4fe1\u4efb\u5b89\u5168\uff0c\u53cc\u5411 TLS (mTLS) \u662f\u4e00\u79cd\u4f20\u8f93\u5b89\u5168\u5f62\u5f0f\uff0c\u53ef\u63d0\u4f9b\u901a\u4fe1\u7684\u673a\u5bc6\u6027\u548c\u8eab\u4efd\u9a8c\u8bc1\u3002 \u6362\u53e5\u8bdd\u8bf4\uff0c\u4e0d\u4ec5\u901a\u4fe1\u88ab\u52a0\u5bc6\uff0c\u800c\u4e14\u8eab\u4efd\u4e5f\u5728\u8fde\u63a5\u7684\u4e24\u7aef\u8fdb\u884c\u9a8c\u8bc1\uff08 mTLS \u7684\u53cc\u5411\u7ec4\u4ef6\u4e0e\u6d4f\u89c8\u5668\u4f7f\u7528\u7684 TLS \u4e0d\u540c\uff0c\u5b83\u53ea\u9a8c\u8bc1\u8fde\u63a5\u7684\u670d\u52a1\u5668\u7aef\uff0cmTLS \u9a8c\u8bc1\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7684\u8eab\u4efd \uff09\u3002 Linkerd \u7684\u76ee\u6807\u662f\u901a\u8fc7\u4f7f\u7528 mTLS \u5bf9 Kubernetes Pod \u4e4b\u95f4\u7684\u901a\u4fe1\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u548c\u52a0\u5bc6\uff0c\u5141\u8bb8\u4f60\u5bf9 Kubernetes \u96c6\u7fa4\u91c7\u7528\u96f6\u4fe1\u4efb\u65b9\u6cd5\u3002 \u9a8c\u8bc1\u662f\u7279\u522b\u91cd\u8981\u7684\uff0c \u867d\u7136\u5927\u591a\u6570\u4eba\u8ba4\u4e3a TLS \u7684\u4ef7\u503c\u5728\u4e8e\u52a0\u5bc6\uff0c\u4f46\u9a8c\u8bc1\u8fde\u63a5\u4e24\u8fb9\u5b9e\u4f53\u7684\u8eab\u4efd\u4e5f\u540c\u6837\u91cd\u8981 \u3002\u6bd5\u7adf\u53ea\u6709\u5728\u4f60\u80fd\u76f8\u4fe1\u4e0e\u4f60\u901a\u4fe1\u7684\u53e6\u4e00\u65b9\u7684\u5b9e\u4f53\u662f\u4ed6\u4eec\u6240\u8bf4\u7684\u4eba\u7684\u60c5\u51b5\u4e0b\uff0c\u52a0\u5bc6\u624d\u662f\u6709\u7528\u7684--\u6765\u81ea\u4e0d\u826f\u884c\u4e3a\u8005\u7684\u52a0\u5bc6\u4fe1\u606f\u4ecd\u7136\u662f\u6765\u81ea\u4e0d\u826f\u884c\u4e3a\u8005\u7684\u4fe1\u606f\u3002 \u5728 Linkerd \u4e2d\uff0c \u901a\u8fc7 mTLS \u9a8c\u8bc1\u7684\u8eab\u4efd\u4e0e Kubernetes ServiceAccounts \u76f8\u5173\u8054 \u3002\u8fd9\u610f\u5473\u7740 Linkerd \u7684 mTLS \u8eab\u4efd\u7cfb\u7edf\u4f7f\u7528\u4e0e Kubernetes \u7528\u4e8e\u4e3a\u96c6\u7fa4\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5efa\u7acb\u8eab\u4efd\u548c\u8bbf\u95ee\u63a7\u5236\u7684\u5b8c\u5168\u76f8\u540c\u7684\u6a21\u5f0f\uff0c\u800c\u4e0d\u662f\u53d1\u660e\u4e00\u4e2a\u65b0\u6846\u67b6\u3002","title":"\u4ec0\u4e48\u662f mTLS"},{"location":"chap11/4linkered_mtls/#linkerd-mtls","text":"Linkerd \u7684\u8bbe\u8ba1\u539f\u5219\u4e4b\u4e00\u662f\uff0c \u590d\u6742\u6027\u662f\u5b89\u5168\u7684\u654c\u4eba \u3002\u914d\u7f6e\u4e1c\u897f\u8d8a\u96be\uff0c\u4f7f\u7528\u5b83\u7684\u53ef\u80fd\u6027\u5c31\u8d8a\u5c0f; \u9009\u9879\u548c\u8bbe\u7f6e\u8d8a\u591a\uff0c\u5c31\u8d8a\u6709\u53ef\u80fd\u4e0d\u5c0f\u5fc3\u4ee5\u4e0d\u5b89\u5168\u7684\u65b9\u5f0f\u8fdb\u884c\u914d\u7f6e\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c Linkerd \u4e3a\u6240\u6709\u7f51\u683c\u4e2d\u7684 pod-to-pod \u901a\u4fe1\u542f\u7528\u4e86 mTLS \uff0c \u53ea\u8981\u53cc\u65b9\u90fd\u6ce8\u5165\u4e86\u6570\u636e\u5e73\u9762\u4ee3\u7406\uff0c\u90a3\u4e48\u606d\u559c\u4f60\uff1a\u4f60\u5df2\u7ecf\u5728\u670d\u52a1\u4e4b\u95f4\u9a8c\u8bc1\u4e86\u52a0\u5bc6\u7684 mTLS \u3002\u4e8b\u5b9e\u4e0a\uff0c\u524d\u9762\u6211\u4eec\u4f7f\u7528\u7684 Emojivoto \u5e94\u7528\u7a0b\u5e8f\u4e2d\u5c31\u5df2\u7ecf\u5728\u4f7f\u7528 mTLS \u4e86\uff0c\u53ea\u662f\u6211\u4eec\u6ca1\u6709\u610f\u8bc6\u5230\u800c\u5df2\u3002 \u5bf9\u5bf9\u4e8e Linkerd \u81ea\u52a8\u6dfb\u52a0 mTLS \u7684\u529f\u80fd\uff0c\u6709\u51e0\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u3002 \u4e24\u4e2a\u7aef\u70b9\u90fd\u5fc5\u987b\u5728\u7f51\u683c\u4e2d\u3002Linkerd \u9700\u8981\u540c\u65f6\u5904\u7406\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7aef\u7684\u8fde\u63a5\u624d\u80fd\u53d1\u6325\u5176 mTLS \u7684\u9b54\u529b\u3002 \u5728 Linkerd 2.8.1 \u548c\u66f4\u65e9\u7684\u7248\u672c\u4e2d\uff0cLinkerd \u53ea\u80fd\u4e3a HTTP \u548c gRPC \u6d41\u91cf\u6dfb\u52a0 mTLS\uff0c\u5373\u4f7f\u5982\u6b64\uff0c\u4e5f\u65e0\u6cd5\u9488\u5bf9\u67d0\u4e9b\u7c7b\u578b\u7684\u6743\u9650\u3001\u4e3b\u673a\u6216 Header \u6267\u884c\u8be5\u64cd\u4f5c\uff0c\u8fd9\u4e9b\u9650\u5236\u5728 Linkerd 2.9 \u4e2d\u5df2\u7ecf\u88ab\u79fb\u9664\uff0c \u5b83\u5c06 mTLS \u6dfb\u52a0\u5230\u6240\u6709\u7684 TCP \u6d41\u91cf\u4e2d\uff0c\u4e0d\u7ba1\u662f\u4ec0\u4e48\u534f\u8bae \u3002 \u5ba2\u6237\u7aef\u53d1\u8d77 TLS \u7684\u8fde\u63a5\u4e0d\u80fd\u7531 Linkerd \u8fdb\u884c mTLS \u3002\u76f8\u53cd\uff0cLinkerd \u4f1a\u5c06\u628a\u8fd9\u4e9b\u8fde\u63a5\u89c6\u4e3a TCP \u6d41\u91cf\u3002\u8bf7\u6ce8\u610f\uff0c\u8fd9\u4e5f\u610f\u5473\u7740 Linkerd \u53ea\u80fd\u4e3a\u8fd9\u4e9b\u8fde\u63a5\u63d0\u4f9b TCP \u7ea7\u522b\u7684\u6307\u6807\u3002 \u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u6765\u4e86\u89e3\u4e0b mTLS \u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u4ee5\u53ca\u5982\u4f55\u9a8c\u8bc1\u6211\u4eec\u7684\u8fde\u63a5\u662f\u5426\u786e\u5b9e\u5177\u6709 mTLS\u3002","title":"\u4f7f\u7528 Linkerd \u7684 mTLS"},{"location":"chap11/4linkered_mtls/#linkerd-identity","text":"\u5728\u524d\u9762\u8bb2\u89e3 Linkerd \u67b6\u6784\u7684\u65f6\u5019\u6211\u4eec\u5c31\u8ba8\u8bba\u8fc7 Linkerd \u63a7\u5236\u5e73\u9762\u7684 Identity \u7ec4\u4ef6\uff0c\u5b83\u4f5c\u4e3a CA \u6216\u8bc1\u4e66\u9881\u53d1\u673a\u6784\u6240\u626e\u6f14\u7684\u89d2\u8272\u3002\u8bc1\u4e66\u9881\u53d1\u673a\u6784\u662f\u9881\u53d1\u6570\u5b57\u8bc1\u4e66\u5e76\u4f7f\u8eab\u4efd\u7ec4\u4ef6\u6210\u4e3a\u6570\u5b57\u8bc1\u4e66\u9881\u53d1\u8005\u7684\u5b9e\u4f53 \u3002 Linkerd \u4f7f\u7528\u7684\u8bc1\u4e66\u4e0e\u7f51\u7ad9\u7528\u6765\u9a8c\u8bc1\u5176\u8eab\u4efd\u7684 TLS \u8bc1\u4e66\u201c\u7c7b\u578b\u201d\u76f8\u540c\u3002\u4e0e\u7f51\u7ad9\u4e0d\u540c\uff0c\u8fd9\u4e9b\u8bc1\u4e66\u4e0d\u7ecf\u8fc7 Verisign \u7b49\u7b2c\u4e09\u65b9\u5b9e\u4f53\u7684\u9a8c\u8bc1\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0d\u9700\u8981\u9a8c\u8bc1\uff0c\u5b83\u4eec\u4ec5\u4f9b Linkerd \u4ee3\u7406\u5728\u96c6\u7fa4\u5185\u4f7f\u7528\u3002 Linkerd \u7684 CA\uff08Identity \u670d\u52a1\uff09\u4f5c\u4e3a Linkerd \u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u3002 \u5728\u8be5\u90e8\u7f72\u8fc7\u7a0b\u4e2d\uff0cLinkerd CLI \u5c06\u751f\u6210\u4e00\u4e2a\u8bc1\u4e66\u5e76\u5c06\u5176\u5b58\u50a8\u5728 Linkerd \u547d\u540d\u7a7a\u95f4\u4e2d\u540d\u4e3a linkerd-identity-token-XXXXX \u7684 Kubernetes Secret \u4e2d\u3002 $ kubectl get secret -n linkerd NAME TYPE DATA AGE linkerd-identity-issuer Opaque 2 11d linkerd-identity-token-nqhbk kubernetes.io/service-account-token 3 11d # ...... \u901a\u8fc7\u67e5\u770b Secret \u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u524d\u7f00\u4e3a linkerd-identity-token- \u7684 Secret \u5bf9\u8c61\uff0c \u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u5bfc\u51fa\u6765\u8fdb\u884c\u67e5\u770b\uff1a $ kubectl get secret -n linkerd linkerd-identity-token-nqhbk -o yaml apiVersion: v1 data: ca.crt: <ca.crt> namespace: bGlua2VyZA== token: <token> kind: Secret metadata: annotations: kubernetes.io/service-account.name: linkerd-identity kubernetes.io/service-account.uid: cdc3d8fd-0e02-4b17-88ce-d2cc0a9e4907 name: linkerd-identity-token-nqhbk namespace: linkerd type: kubernetes.io/service-account-token \u8f93\u51fa\u7684\u6570\u636e\u90e8\u5206\u4e2d\u540d\u4e3a ca.crt \u7684\u5b57\u6bb5\u5c31\u662f\u5728 Linkerd \u5b89\u88c5\u671f\u95f4\u751f\u6210\u7684 UTF-8 \u7f16\u7801\u7684\u6839\u8bc1\u4e66\u3002\u6b64\u8bc1\u4e66\u79f0\u4e3a\u201c\u4fe1\u4efb\u4e4b\u951a\u201d\uff0c\u56e0\u4e3a\u5b83\u662f\u7528\u4f5c\u9881\u53d1\u7ed9\u4ee3\u7406\u7684\u6240\u6709\u8bc1\u4e66\u7684\u57fa\u7840\u3002 \u4fe1\u4efb\u951a\u8fd8\u7528\u4e8e\u5728\u5b89\u88c5\u65f6\u521b\u5efa\u53e6\u4e00\u4e2a\u8bc1\u4e66\u548c\u5bc6\u94a5\u5bf9\uff1a \u9881\u53d1\u8005\u51ed\u636e\uff0c\u8fd9\u4e9b\u5b58\u50a8\u5728\u540d\u4e3a linkerd-identity-issuer \u7684\u5355\u72ec Kubernetes Secret \u4e2d\u3002\u9881\u53d1\u8005\u51ed\u636e\u7528\u4e8e\u5411 Linkerd proxy \u9881\u53d1\u8bc1\u4e66\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u6765\u67e5\u770b\u8be5 Secret \u7684\u6570\u636e \u3002 $ kubectl get secret -n linkerd linkerd-identity-issuer -o yaml apiVersion: v1 data: crt.pem: <crt.pem> key.pem: <key.pem> kind: Secret metadata: labels: linkerd.io/control-plane-component: identity linkerd.io/control-plane-ns: linkerd name: linkerd-identity-issuer namespace: linkerd type: Opaque \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8fd9\u4e9b\u5bc6\u94a5\u5411\u4ee3\u7406\u9881\u53d1\u8bc1\u4e66\u4ee5\u542f\u7528 mTLS\u3002","title":"Linkerd Identity \u7ec4\u4ef6"},{"location":"chap11/4linkered_mtls/#linkerd","text":"\u9996\u5148\uff0c\u5f53 Pod \u88ab\u6ce8\u5165 Linkerd \u4ee3\u7406\u65f6\uff0c\u8be5\u4ee3\u7406\u4f1a\u5411 Linkerd \u7684\u8eab\u4efd\u670d\u52a1\u53d1\u9001\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42 (CSR)\u3002 \u8eab\u4efd\u670d\u52a1\u4f7f\u7528\u9881\u53d1\u8005\u51ed\u636e\u5411\u8be5\u4ee3\u7406\u9881\u53d1\u7b7e\u540d\u8bc1\u4e66\uff08CSR \u7684\u4f5c\u7528\u57df\u662f\u8fd0\u884c Pod \u7684 Kubernetes ServiceAccount\uff0c\u56e0\u6b64\u751f\u6210\u7684\u8bc1\u4e66\u4e0e\u8be5 ServiceAccount \u76f8\u5173\u8054\uff09\uff0c\u8bc1\u4e66\u5c06\u5728 24 \u5c0f\u65f6\u540e\u8fc7\u671f\u3002 \u5728\u8bc1\u4e66\u8fc7\u671f\u524d\uff0c\u4ee3\u7406\u5411\u8eab\u4efd\u670d\u52a1\u53d1\u9001\u65b0\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff0c \u83b7\u53d6\u65b0\u8bc1\u4e66 \uff1b \u8fd9\u4e2a\u8fc7\u7a0b\u5728 Linkerd \u4ee3\u7406\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u5185\u90fd\u4f1a\u6301\u7eed\uff0c\u8fd9\u79f0\u4e3a\u8bc1\u4e66\u8f6e\u6362\uff0c\u662f\u4e00\u79cd\u5c06\u8bc1\u4e66\u6cc4\u9732\u9020\u6210\u7684\u635f\u5931\u964d\u81f3\u6700\u4f4e\u7684\u81ea\u52a8\u5316\u65b9\u5f0f\uff1a \u5728\u6700\u574f\u7684\u60c5\u51b5\u4e0b\uff0c\u4efb\u4f55\u6cc4\u9732\u7684\u8bc1\u4e66\u53ea\u80fd\u4f7f\u7528 24 \u5c0f\u65f6 \u3002 linkerd check \u547d\u4ee4\u6709\u4e00\u79cd\u7b80\u5355\u7684\u65b9\u6cd5\u6765\u786e\u4fdd\u4ee3\u7406\u90fd\u5177\u6709\u7531\u8eab\u4efd\u670d\u52a1\u9881\u53d1\u7684\u8bc1\u4e66\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u901a\u8fc7\u4f20\u9012 --proxy \u6807\u5fd7\u6765\u68c0\u67e5\u4ee3\u7406\u7684\u72b6\u6001\u3002 # \u4f7f\u7528 --proxy \u6807\u5fd7\u5728\u6570\u636e\u5e73\u9762\u68c0\u67e5\u4ee3\u7406 $ linkerd check --proxy # ...... linkerd-identity ---------------- \u221a certificate config is valid \u221a trust anchors are using supported crypto algorithm \u221a trust anchors are within their validity period \u221a trust anchors are valid for at least 60 days \u221a issuer cert is using supported crypto algorithm \u221a issuer cert is within its validity period \u221a issuer cert is valid for at least 60 days \u221a issuer cert is issued by the trust anchor linkerd-identity-data-plane --------------------------- \u221a data plane proxies certificate match CA # ...... Status check results are \u221a \u4e0a\u9762\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\u5305\u62ec\u4e00\u4e2a linkerd-identity-data-plane \u90e8\u5206\uff0c\u7528\u6765\u6307\u793a\u4ee3\u7406\u662f\u5426\u6b63\u5728\u4f7f\u7528\u7531\u4fe1\u4efb\u951a\u9881\u53d1\u7684\u8bc1\u4e66\u3002 linkerd-identity-data-plane --------------------------- \u221a data plane proxies certificate match CA \u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 Linkerd \u4ee3\u7406\u548c\u8eab\u4efd\u670d\u52a1\u4e2d\u5f00\u542f debug \u6a21\u5f0f\uff0c\u4ee5\u67e5\u770b\u4ee3\u7406\u5c06 CSR \u53d1\u9001\u5230\u8eab\u4efd\u670d\u52a1\u5e76\u53d6\u56de\u8bc1\u4e66\u3002 $ kubectl get deploy -n linkerd NAME READY UP-TO-DATE AVAILABLE AGE linkerd-destination 1/1 1 1 11d linkerd-identity 1/1 1 1 11d linkerd-proxy-injector 1/1 1 1 11d $ kubectl edit deploy linkerd-identity -n linkerd # ...... spec: containers: - args: - identity - -log-level=debug # \u8bbe\u7f6e\u4e3a debug \u6a21\u5f0f - -log-format=plain - -controller-namespace=linkerd - -identity-trust-domain=cluster.local - -identity-issuance-lifetime=24h0m0s - -identity-clock-skew-allowance=20s - -identity-scheme=linkerd.io/tls # ...... \u5f53\u8eab\u4efd\u670d\u52a1\u91cd\u65b0\u66f4\u65b0\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf\u5bf9\u5e94 Pod \u7684\u65e5\u5fd7\u4fe1\u606f\uff1a $ kubectl logs -f -n linkerd deploy/linkerd-identity -c identity \u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u8f93\u51fa\u5f88\u591a\u65e5\u5fd7\u5230\u63a7\u5236\u53f0\uff0c\u5728 Linkerd \u8eab\u4efd\u65e5\u5fd7\u8f93\u51fa\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Request Body \u548c Response Body \u76f8\u5173\u7684\u8f93\u51fa\uff0c\u5176\u4e2d\u5305\u62ec\u4e00\u4e2a\u5f88\u957f\u7684 UTF-8 \u7f16\u7801\u6570\u636e\uff0c\u5373 CSR \u548c\u9881\u53d1\u7ed9\u4ee3\u7406\u7684\u8bc1\u4e66\uff1a # ...... time=\"2022-08-30T07:39:17Z\" level=debug msg=\"Issuer has been updated\" time=\"2022-08-30T07:39:17Z\" level=info msg=\"starting admin server on :9990\" time=\"2022-08-30T07:39:17Z\" level=info msg=\"starting gRPC server on :8080\" time=\"2022-08-30T07:39:17Z\" level=debug msg=\"Validating token for linkerd-identity.linkerd.serviceaccount.identity.linkerd.cluster.local\" I0830 07:39:17.291787 1 request.go:1123] Request Body: {\"kind\":\"TokenReview\",\"apiVersion\":\"authentication.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"token\":\"<......>\"},\"status\":{\"user\":{}}} # ...... I0830 07:39:17.291969 1 round_trippers.go:435] curl -k -v -XPOST -H \"Accept: application/json, */*\" -H \"Content-Type: application/json\" -H \"User-Agent: controller/v0.0.0 (linux/amd64) kubernetes/$Format\" -H \"Authorization: Bearer <masked>\" 'https://10.96.0.1:443/apis/authentication.k8s.io/v1/tokenreviews' I0830 07:39:17.293883 1 round_trippers.go:454] POST https://10.96.0.1:443/apis/authentication.k8s.io/v1/tokenreviews 201 Created in 1 milliseconds # ...... I0830 07:39:17.294241 1 request.go:1123] Response Body: {\"kind\":\"TokenReview\",\"apiVersion\":\"authentication.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null,\"managedFields\":[{\"manager\":\"controller\",\"operation\":\"Update\",\"apiVersion\":\"authentication.k8s.io/v1\",\"time\":\"2022-08-30T07:39:17Z\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:token\":{}}}}]},\"spec\":{\"token\":\"<token>\"},\"status\":{\"authenticated\":true,\"user\":{\"username\":\"system:serviceaccount:linkerd:linkerd-identity\",\"uid\":\"cdc3d8fd-0e02-4b17-88ce-d2cc0a9e4907\",\"groups\":[\"system:serviceaccounts\",\"system:serviceaccounts:linkerd\",\"system:authenticated\"],\"extra\":{\"authentication.kubernetes.io/pod-name\":[\"linkerd-identity-5d9b874d66-m77ps\"],\"authentication.kubernetes.io/pod-uid\":[\"2f147d37-1616-487a-b7aa-1805b84c026a\"]}},\"audiences\":[\"https://kubernetes.default.svc.cluster.local\"]}} # ...... \u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u67e5\u770b\u4e0b Emojivoto \u5e94\u7528\u670d\u52a1\u4e4b\u95f4\u7684\u5b89\u5168\u6027\u3002\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd viz edges \u547d\u4ee4\u6765\u67e5\u770b\u4e0b Pod \u4e4b\u95f4\u662f\u5982\u4f55\u8fde\u63a5\u7684\u3002 $ linkerd viz edges po -n emojivoto SRC DST SRC_NS DST_NS SECURED vote-bot-6d7677bb68-jvxsg web-5f86686c4d-58p7k emojivoto emojivoto \u221a web-5f86686c4d-58p7k emoji-696d9d8f95-5vn9w emojivoto emojivoto \u221a web-5f86686c4d-58p7k voting-ff4c54b8d-xhjv7 emojivoto emojivoto \u221a prometheus-7bbc4d8c5b-5rc8r emoji-696d9d8f95-5vn9w linkerd-viz emojivoto \u221a prometheus-7bbc4d8c5b-5rc8r vote-bot-6d7677bb68-jvxsg linkerd-viz emojivoto \u221a prometheus-7bbc4d8c5b-5rc8r voting-ff4c54b8d-xhjv7 linkerd-viz emojivoto \u221a prometheus-7bbc4d8c5b-5rc8r web-5f86686c4d-58p7k linkerd-viz emojivoto \u221a \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\u6700\u540e\u5305\u542b\u4e00\u5217 SECURED \uff0c\u8868\u793a\u662f\u5426\u662f\u5b89\u5168\u7684\u8fde\u63a5\uff0c\u4e0b\u9762\u7684\u503c\u5747\u4e3a \u221a \uff0c\u8868\u793a\u662f\u5b89\u5168\u7684\u8fde\u63a5\u3002 \u7136\u540e\u6211\u4eec\u518d\u6b21\u4f7f\u7528 linkerd viz tap \u547d\u4ee4\u6765\u6355\u83b7\u5b9e\u65f6\u6d41\u91cf\uff0c\u5728\u8f93\u51fa\u7684\u4fe1\u606f\u4e2d\u4e5f\u5305\u542b\u4e00\u4e2a tls=true \u7684\u6807\u7b7e\u503c\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ linkerd viz tap deploy web -n emojivoto req id=0:0 proxy=in src=10.244.1.165:47130 dst=10.244.1.176:8080 tls=true :method=GET :authority=web-svc.emojivoto:80 :path=/api/list req id=0:1 proxy=out src=10.244.1.176:42096 dst=10.244.1.188:8080 tls=true :method=POST :authority=emoji-svc.emojivoto:8080 :path=/emojivoto.v1.EmojiService/ListAll rsp id=0:1 proxy=out src=10.244.1.176:42096 dst=10.244.1.188:8080 tls=true :status=200 latency=2731\u00b5s # ...... \u5230\u8fd9\u91cc\u9762\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u7684 Identity \u7ec4\u4ef6\u5982\u4f55\u5411\u6570\u636e\u5e73\u9762\u4e2d\u7684 Linkerd \u4ee3\u7406\u9881\u53d1\u8bc1\u4e66\uff0c \u4ee5\u53ca Linkerd \u5728\u4ee3\u7406\u4e2d\u7684 mTLS \u5b9e\u73b0\u5982\u4f55\u4f7f\u7528\u8fd9\u4e9b\u8bc1\u4e66\u6765\u52a0\u5bc6\u901a\u4fe1\u5e76\u9a8c\u8bc1\u53cc\u65b9\u7684\u8eab\u4efd \u3002","title":"Linkerd \u4ee3\u7406\u5982\u4f55\u83b7\u53d6\u8bc1\u4e66"},{"location":"chap11/4linkered_mtls/#tls","text":"Linkerd \u7684\u81ea\u52a8 mTLS \u529f\u80fd\u4f7f\u7528\u4e00\u7ec4 TLS \u51ed\u636e\u4e3a\u4ee3\u7406\u751f\u6210 TLS \u8bc1\u4e66\uff1a \u4fe1\u4efb\u951a(trust anchor)\u3001\u9881\u53d1\u8005\u8bc1\u4e66(issuer certificate)\u548c\u79c1\u94a5(private key) \u3002 \u867d\u7136 Linkerd \u6bcf 24 \u5c0f\u65f6\u81ea\u52a8\u8f6e\u6362\u6570\u636e\u5e73\u9762\u4ee3\u7406\u7684 TLS \u8bc1\u4e66\uff0c\u4f46\u5b83\u4e0d\u4f1a\u8f6e\u6362\u7528\u4e8e\u9881\u53d1\u8fd9\u4e9b\u8bc1\u4e66\u7684 TLS \u51ed\u636e\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u4e0b\u5982\u4f55\u4f7f\u7528 Cert-manager \u8fdb\u884c\u81ea\u52a8\u8f6e\u6362\u9881\u53d1\u8005\u8bc1\u4e66\u548c\u79c1\u94a5\u3002","title":"\u81ea\u52a8\u8f6e\u6362\u63a7\u5236\u5668\u5e73\u9762 TLS \u51ed\u8bc1"},{"location":"chap11/4linkered_mtls/#cert-manager","text":"Cert-manager \u662f\u4e00\u4e2a\u975e\u5e38\u6d41\u884c\u7684\u4e91\u539f\u751f\u8bc1\u4e66\u7ba1\u7406\u5de5\u5177\u3002 Cert-manager \u5c06\u8bc1\u4e66\u548c\u8bc1\u4e66\u9881\u53d1\u8005\u4f5c\u4e3a CRD \u8d44\u6e90\u7c7b\u578b\u6dfb\u52a0\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u7b80\u5316\u4e86\u83b7\u53d6\u3001\u66f4\u65b0\u548c\u4f7f\u7528\u8fd9\u4e9b\u8bc1\u4e66\u7684\u8fc7\u7a0b\u3002\u5b83\u53ef\u4ee5\u4ece\u5404\u79cd\u53d7\u652f\u6301\u7684\u6765\u6e90\u53d1\u5e03\u8bc1\u4e66\uff0c \u5305\u62ec Let's Encrypt\u3001 HashiCorp Vault \u548c Venafi \u4ee5\u53ca\u79c1\u6709 PKI \u3002\u5b83\u5c06\u786e\u4fdd\u8bc1\u4e66\u6709\u6548\u5e76\u4e14\u662f\u6700\u65b0\u7684\uff0c\u5e76\u5c1d\u8bd5\u5728\u8bc1\u4e66\u5230\u671f\u524d\u7684\u914d\u7f6e\u65f6\u95f4\u66f4\u65b0\u8bc1\u4e66\u3002 Cert-manager \u7684\u5b89\u88c5\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e00\u952e\u5b89\u88c5\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.9.1/cert-manager.yaml \u9ed8\u8ba4\u4f1a\u5c06\u76f8\u5173\u8d44\u6e90\u5b89\u88c5\u5230\u4e00\u4e2a\u540d\u4e3a cert-manager \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff1a $ kubectl get pods -n cert-manager NAME READY STATUS RESTARTS AGE cert-manager-55649d64b4-kdcfk 1/1 Running 0 43s cert-manager-cainjector-666db4777-cp2dn 1/1 Running 0 43s cert-manager-webhook-6466bc8f4-5lvw5 1/1 Running 0 43s","title":"Cert-manager"},{"location":"chap11/4linkered_mtls/#_1","text":"\u63a5\u4e0b\u6765\u6211\u4eec\u4f7f\u7528 step \u5de5\u5177\u521b\u5efa\u4e00\u4e2a\u7b7e\u540d\u5bc6\u94a5\u5bf9\uff0c\u5e76\u5c06\u5176\u5b58\u50a8\u5728 Kubernetes \u7684\u4e00\u4e2a Secret \u5bf9\u8c61\u4e2d \u3002 $ step certificate create root.linkerd.cluster.local ca.crt ca.key \\ --profile root-ca --no-password --insecure Your certificate has been saved in ca.crt. Your private key has been saved in ca.key. \u7136\u540e\u5c06\u751f\u6210\u7684 ca.crt \u548c ca.key \u4fdd\u5b58\u5230 Secret \u5bf9\u8c61\u4e2d\uff1a $ kubectl create secret tls linkerd-trust-anchor --cert=ca.crt --key=ca.key -n secret/linkerd-trust-anchor created \u6709\u4e86 Secret\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u5f15\u7528\u5bc6\u94a5\u7684\u8bc1\u4e66\u9881\u53d1\u8005 Issuer \u8d44\u6e90\uff1a $ cat <<EOF | kubectl apply -f - apiVersion: cert-manager.io/v1 kind: Issuer metadata: name: linkerd-trust-anchor namespace: linkerd spec: ca: secretName: linkerd-trust-anchor EOF $ kubectl get issuer -n linkerd NAME READY AGE linkerd-trust-anchor True 84s \u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u9881\u53d1\u8bc1\u4e66\u4e86\uff0c \u5e76\u5c06\u5b83\u4eec\u5199\u5165\u5230\u4e00\u4e2a Secret \u5bf9\u8c61\u4e2d\uff0c\u6700\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a cert-manager \"Certificate\" \u8d44\u6e90\uff0c \u5b83\u4f7f\u7528\u8fd9\u4e2a Issuer \u6765\u751f\u6210\u6240\u9700\u7684\u8bc1\u4e66 \uff1a $ cat <<EOF | kubectl apply -f - apiVersion: cert-manager.io/v1 kind: Certificate metadata: name: linkerd-identity-issuer namespace: linkerd spec: secretName: linkerd-identity-issuer duration: 48h renewBefore: 25h issuerRef: name: linkerd-trust-anchor kind: Issuer commonName: identity.linkerd.cluster.local dnsNames: - identity.linkerd.cluster.local isCA: true privateKey: algorithm: ECDSA usages: - cert sign - crl sign - server auth - client auth EOF $ kubectl get certificate -n linkerd NAME READY SECRET AGE linkerd-identity-issuer True linkerd-identity-issuer 17s \u5728\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\uff0c duration \u6307\u793a cert-manager \u5c06\u8bc1\u4e66\u89c6\u4e3a\u6709\u6548\u671f 48 \u5c0f\u65f6\uff0c\u800c renewBefore \u6307\u793a cert-manager \u5c06\u5c1d\u8bd5\u5728\u5f53\u524d\u8bc1\u4e66\u5230\u671f\u524d 25 \u5c0f\u65f6\u9881\u53d1\u65b0\u8bc1\u4e66 \u3002 \u6b64\u65f6\uff0ccert-manager \u73b0\u5728\u53ef\u4ee5\u4f7f\u7528\u6b64\u8bc1\u4e66\u8d44\u6e90\u83b7\u53d6 TLS \u51ed\u636e\uff0c\u8be5\u51ed\u636e\u5c06\u5b58\u50a8\u5728\u540d\u4e3a linkerd-identity-issuer \u7684 Secret \u4e2d\uff0c\u8981\u9a8c\u8bc1\u60a8\u65b0\u9881\u53d1\u7684\u8bc1\u4e66\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4 \uff1a $ kubectl get secret linkerd-identity-issuer -o yaml -n linkerd apiVersion: v1 data: ca.crt: <ca.crt> crt.pem: <crt.pem> key.pem: <key.pem> tls.crt: <tls.crt> tls.key: <tls.key> kind: Secret metadata: name: linkerd-identity-issuer namespace: linkerd type: Opaque \u73b0\u5728\u6211\u4eec\u53ea\u9700\u8981\u901a\u77e5 Linkerd \u4f7f\u7528\u8fd9\u4e9b\u51ed\u636e\u5c31\u53ef\u4ee5\u4e86\u3002 \u7531\u4e8e\u6211\u4eec\u662f\u901a\u8fc7 linkerd \u547d\u4ee4\u884c\u5de5\u5177\u8fdb\u884c\u5b89\u88c5\u7684\uff0cLinkerd \u63a7\u5236\u5e73\u9762\u9ed8\u8ba4\u4f1a\u901a\u8fc7 --identity-external-issuer \u6807\u5fd7\u8fdb\u884c\u5b89\u88c5\uff0c\u8be5\u6807\u5fd7\u6307\u793a Linkerd \u4ece linkerd-identity-issuer \u7684 Secret \u8bfb\u53d6\u8bc1\u4e66\u3002 \u6bcf\u5f53\u66f4\u65b0\u5b58\u50a8\u5728 Secret \u4e2d\u7684 certificate \u548c key \u65f6\uff0c identity \u670d\u52a1\u5c06\u81ea\u52a8\u68c0\u6d4b\u6b64\u66f4\u6539\u5e76\u91cd\u65b0\u52a0\u8f7d\u65b0\u51ed\u636e\u3002 \u8fd9\u6837\u6211\u4eec\u5c31\u8bbe\u7f6e\u4e86 Linkerd \u63a7\u5236\u5e73\u9762 TLS \u51ed\u636e\u7684\u81ea\u52a8\u8f6e\u6362\uff0c\u5982\u679c\u4f60\u60f3\u76d1\u63a7\u66f4\u65b0\u8fc7\u7a0b\uff0c\u4f60\u53ef\u4ee5\u68c0\u67e5\u670d\u52a1\u53d1\u51fa\u7684 IssuerUpdated \u4e8b\u4ef6 \uff1a $ kubectl get events --field-selector reason=IssuerUpdated -n linkerd LAST SEEN TYPE REASON OBJECT MESSAGE 2m37s Normal IssuerUpdated deployment/linkerd-identity Updated identity issuer \u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6267\u884c\u4e86 Updated identity issuer \u3002","title":"\u9881\u53d1\u8bc1\u4e66"},{"location":"chap11/5linkerd_flow_split/","text":"5 \u5728 Linkerd \u4e2d\u5b9e\u73b0\u6d41\u91cf\u62c6\u5206\u529f\u80fd \u5728 Linkerd \u4e2d\uff0c\u91d1\u4e1d\u96c0\u53d1\u5e03\u662f\u901a\u8fc7\u6d41\u91cf\u62c6\u5206\u6765\u7ba1\u7406\u7684\uff0c\u8fd9\u9879\u529f\u80fd\u5141\u8bb8\u4f60\u6839\u636e\u53ef\u52a8\u6001\u914d\u7f6e\u7684\u6743\u91cd\uff0c\u5c06\u8bf7\u6c42\u5206\u914d\u7ed9\u4e0d\u540c\u7684 Kubernetes \u670d\u52a1\u5bf9\u8c61\u3002 \u867d\u7136\u6d41\u91cf\u5206\u5272\u53ef\u4ee5\u9002\u7528\u4e8e\u4efb\u610f\u7684 Service \u5bf9\u8c61\uff0c\u4f46\u4e00\u822c\u60c5\u51b5\u4e0b\u662f\u5c06\u4e00\u4e2a Service \u7684\u4f20\u5165\u6d41\u91cf\u5206\u7ed9\u4e0d\u540c\u7248\u672c\u7684 Service\u3002 \u6d41\u91cf\u5206\u5272\u529f\u80fd\u662f\u901a\u8fc7 Linkerd \u7684 TrafficSplit CRD \u6765\u63a7\u5236\u7684\uff08 TrafficSplit CRD \u9075\u5faa\u670d\u52a1\u7f51\u63a5\u53e3\uff08SMI\uff09\u4e2d\u5b9a\u4e49\u7684\u89c4\u8303\uff0c\u8fd9\u662f Linkerd \u5b9e\u73b0\u7684\u51e0\u4e2a SMI API \u4e2d\u7684\u4e00\u4e2a \uff09\u3002 \u521b\u5efa TrafficSplit CRD \u5141\u8bb8\u6211\u4eec\u63a7\u5236 Linkerd \u5982\u4f55\u5c06\u6d41\u91cf\u4ee3\u7406\u7ed9 TrafficSplit \u5f15\u7528\u7684\u670d\u52a1 \u3002 TrafficSplit CRD \u662f\u6839\u636e Kubernetes Service \u5bf9\u8c61\u7f16\u5199\u7684\uff0cTrafficSplit \u63cf\u8ff0\u4e86\u4e00\u4e2a\u4e2d\u5fc3\u6839\u6216 apex \u670d\u52a1\uff0c\u6d41\u91cf\u88ab\u53d1\u9001\u5230\u8be5\u670d\u52a1\uff0c\u4ee5\u53ca\u4e00\u4e2a\u6216\u591a\u4e2a\u5b9e\u9645\u63a5\u6536\u5b83\u7684\u540e\u7aef\u670d\u52a1\uff0c\u4e0e TrafficSplit \u4e2d\u8fd8\u6307\u5b9a\u7684\u6743\u91cd\u6210\u6bd4\u4f8b\u3002 \u53e6\u5916\u9700\u8981\u6ce8\u610f\uff0cKubernetes \u7684 Service \u5bf9\u8c61\u4e0d\u4e00\u5b9a\u6709\u540e\u53f0\u5de5\u4f5c\u8d1f\u8f7d\u3002\u867d\u7136\u8fd9\u5bf9\u4e8e\u666e\u901a\u670d\u52a1\u6765\u8bf4\u5f88\u5c11\u89c1\uff0c\u4f46\u662f\u6211\u4eec\u4f1a\u5728 TrafficSplits \u7684 apex \u670d\u52a1\u4e2d\u5927\u91cf\u4f7f\u7528\u8be5\u529f\u80fd\uff0c\u56e0\u4e3a TrafficSplit \u4f1a\u5bfc\u81f4\u53d1\u5f80 apex \u7684\u6d41\u91cf\u5b9e\u9645\u53d1\u9001\u5230\u540e\u7aef\u670d\u52a1\uff0c\u6240\u4ee5 apex \u5b9e\u9645\u4e0a\u4e0d\u9700\u8981\u62e5\u6709\u81ea\u5df1\u7684 Deployment\u3002 \u66f4\u65b0\u670d\u52a1 \u63a5\u4e0b\u6765\u6211\u4eec\u8fd8\u662f\u4ee5 Emojivoto \u5e94\u7528\u4e3a\u4f8b\u6765\u521b\u5efa\u4e24\u4e2a\u65b0\u7684 Service \u5bf9\u8c61\uff0capex \u670d\u52a1\u5c06\u6ca1\u6709\u5173\u8054\u7684 Deployment \u8d44\u6e90\uff0c\u7b2c\u4e8c\u9879\u670d\u52a1\u5c06\u662f Emojivoto \u7684 web \u670d\u52a1\u7684\u4e00\u4e2a\u66f4\u65b0\u7248\u672c\uff0c\u4f1a\u5728\u9875\u9762\u9876\u90e8\u6dfb\u52a0\u4e00\u4e9b\u6587\u672c\u4fe1\u606f\u3002 \u521b\u5efa\u8fd9\u4e24\u4e2a\u670d\u52a1\u540e\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a TrafficSplit \u8d44\u6e90\uff0c\u8be5\u8d44\u6e90\u4f1a\u5c06\u53d1\u9001\u5230 apex \u670d\u52a1\u7684\u6d41\u91cf\u5728 web \u670d\u52a1\u7684\u539f\u59cb\u7248\u672c\u548c\u66f4\u65b0\u7248\u672c\u4e4b\u95f4\u8fdb\u884c\u62c6\u5206\u3002 \u66f4\u65b0\u7248\u672c\u7684 web \u670d\u52a1\u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a # web-svc-2.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-2 namespace: emojivoto --- apiVersion: v1 kind: Service metadata: name: web-svc-2 namespace: emojivoto spec: ports: - name: http port: 80 targetPort: 8080 selector: app: web-svc-2 type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: web-svc-2 app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: linux-training-v2 name: web-svc-2 namespace: emojivoto spec: selector: matchLabels: app: web-svc-2 version: linux-training-v2 template: metadata: annotations: linkerd.io/inject: enabled # \u8bbe\u7f6e\u81ea\u52a8\u6ce8\u5165\u7684\u6ce8\u89e3 labels: app: web-svc-2 version: linux-training-v2 spec: containers: - env: - name: WEB_PORT value: \"8080\" - name: EMOJISVC_HOST value: emoji-svc.emojivoto:8080 - name: VOTINGSVC_HOST value: voting-svc.emojivoto:8080 - name: INDEX_BUNDLE value: dist/index_bundle.js - name: MESSAGE_OF_THE_DAY value: \"Welcome to version 2! Now with more words!\" image: buoyantio/emojivoto-web:lf-training name: web-svc-2 ports: - containerPort: 8080 name: http resources: requests: cpu: 100m serviceAccountName: web-2 \u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f web-svc-2.yaml serviceaccount/web-2 created service/web-svc-2 created deployment.apps/web-svc-2 created \u90e8\u7f72\u540e\u5148\u9a8c\u8bc1\u66f4\u65b0\u7248\u672c\u7684\u670d\u52a1\u662f\u5426\u5df2\u7ecf\u6b63\u786e\u90e8\u7f72\u4e86\u3002 $ kubectl get po --selector app=web-svc-2 -n emojivoto NAME READY STATUS RESTARTS AGE web-svc-2-f9d77474f-hgsg4 2/2 Running 0 10s $ kubectl get svc web-svc-2 -n emojivoto NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE web-svc-2 ClusterIP 10.102.99.153 <none> 80/TCP 3m45s \u90e8\u7f72\u6210\u529f\u540e\u540c\u6837\u53ef\u4ee5\u4f7f\u7528 kubectl port-forward \u547d\u4ee4\u6765\u66b4\u9732\u670d\u52a1\uff1a $ kubectl port-forward svc/web-svc-2 8080:80 -n emojivoto \u540c\u6837\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u901a\u8fc7 localhost:8080 \u8bbf\u95ee\u65b0\u7248\u672c\u7684\u5e94\u7528\u3002 \u5728\u9875\u9762\u9876\u90e8\u53ef\u4ee5\u770b\u5230\u65b0\u7248\u672c\u7684\u5e94\u7528\u591a\u4e86\u4e00\u884c\u5b57\u7b26\u4fe1\u606f\u3002 \u521b\u5efa TrafficSplit \u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a apex \u670d\u52a1\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06\u5176\u79f0\u4e3a web-apex\uff0c\u4e0d\u8fc7\u8fd9\u6b21\u6ca1\u6709 Pod \u8fd0\u884c\uff0c\u6240\u4ee5\u65e0\u6cd5\u5411\u670d\u52a1\u53d1\u9001\u4efb\u4f55\u8bf7\u6c42\uff0c\u56e0\u4e3a\u6ca1\u6709\u7aef\u70b9\u3002 # web-apex.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-apex namespace: emojivoto --- apiVersion: v1 kind: Service metadata: name: web-apex namespace: emojivoto spec: ports: - name: http port: 80 selector: app: web-apex type: ClusterIP \u540c\u6837\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f web-apex.yaml serviceaccount/web-apex created service/web-apex created $ kubectl get svc -n emojivoto -o wide NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR emoji-svc ClusterIP 10.103.235.14 <none> 8080/TCP,8801/TCP 8d app=emoji-svc voting-svc ClusterIP 10.102.32.81 <none> 8080/TCP,8801/TCP 8d app=voting-svc web-apex ClusterIP 10.104.12.249 <none> 80/TCP 84s app=web-apex web-svc ClusterIP 10.106.220.250 <none> 80/TCP 8d app=web-svc web-svc-2 ClusterIP 10.102.99.153 <none> 80/TCP 27m app=web-svc-2 \u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u53ef\u4ee5\u770b\u5230 web-apex \u670d\u52a1\u548c\u5176\u4ed6\u666e\u901a\u670d\u52a1\u4e00\u6837 \uff0c\u4f46\u662f\u4ed6\u5e76\u6ca1\u6709\u7aef\u70b9\u3002 $ kubectl get ep -n emojivoto NAME ENDPOINTS AGE emoji-svc 10.244.1.228:8801,10.244.1.228:8080 8d voting-svc 10.244.1.202:8801,10.244.1.202:8080 8d web-apex <none> 2m55s web-svc 10.244.1.227:8080 8d web-svc-2 10.244.1.233:8080 28m \u5728\u7ee7\u7eed\u4e4b\u524d\u6211\u4eec\u53ef\u4ee5\u5148\u770b\u770b\u5f53\u524d\u5e94\u7528\u7684\u6d41\u91cf\u72b6\u6001\uff1a $ linkerd viz stat po -n emojivoto NAME STATUS MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji-696d9d8f95-5vn9w Running 1/1 100.00% 2.3rps 1ms 1ms 1ms 4 vote-bot-6d7677bb68-jvxsg Running 1/1 100.00% 0.3rps 1ms 1ms 1ms 1 voting-ff4c54b8d-xhjv7 Running 1/1 98.04% 0.8rps 1ms 8ms 10ms 4 web-5f86686c4d-58p7k Running 1/1 100.00% 1.4rps 1ms 6ms 9ms 2 \u53ef\u4ee5\u6e05\u695a\u770b\u5230\u867d\u7136\u6211\u4eec\u5c06 web \u670d\u52a1\u7684\u66f4\u65b0\u7248\u672c\u5df2\u7ecf\u90e8\u7f72\u4e86\uff0c \u4f46\u662f\u73b0\u5728\u6ca1\u6709\u4ea7\u751f\u4efb\u4f55\u7684\u6d41\u91cf\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u53bb\u521b\u5efa\u4e00\u4e2a TrafficSplit \u5bf9\u8c61\uff0c\u7136\u540e\u53bb\u62c6\u5206\u4e00\u90e8\u5206\u6d41\u91cf\u5230\u6211\u4eec\u7684\u65b0\u670d\u52a1\u4e2d\u53bb \u3002 \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 TrafficSplit \u8d44\u6e90\u5bf9\u8c61\uff1a # web-svc-ts.yml apiVersion: split.smi-spec.io/v1alpha2 kind: TrafficSplit metadata: name: web-svc-ts namespace: emojivoto spec: # \u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1 service: web-apex # \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service \u4ee5\u53ca\u5b83\u4eec\u81ea\u5df1\u7684 selectors\u3001\u7aef\u70b9\u548c\u914d\u7f6e\u3002 backends: # \u62c6\u5206\u7684\u540e\u7aef\u670d\u52a1 - service: web-svc weight: 500 # \u6743\u91cd - service: web-svc-2 weight: 500 \u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u4e2d\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u5c5e\u6027\uff1a service\uff1a\u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1 backends\uff1a\u547d\u540d\u7a7a\u95f4\u5185\u7684\u670d\u52a1\uff0c\u5177\u6709\u81ea\u5df1\u7684\u9009\u62e9\u5668\u3001\u7aef\u70b9\u548c\u914d\u7f6e\uff08\u6211\u4eec\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u670d\u52a1\u770b\u6210\u53f6\u670d\u52a1\uff09\u3002 service\uff1a\u4e0e\u53ef\u4ee5\u5904\u7406\u8bf7\u6c42\u7684 Pod \u5173\u8054\u5730\u5177\u4f53\u670d\u52a1\u7684\u540d\u79f0\u3002 weight\uff1a\u5b83\u4e0e\u5206\u914d\u7ed9\u670d\u52a1\u7684\u603b\u6d41\u91cf\u7684\u767e\u5206\u6bd4\u76f8\u5173\u3002 \u73b0\u5728\u6211\u4eec\u6765\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f web-svc-ts.yaml trafficsplit.split.smi-spec.io/web-svc-ts created $ kubectl get trafficsplit -n emojivoto NAME SERVICE web-svc-ts web-apex \u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 linkerd viz stat \u547d\u4ee4\u7684\u4e00\u4e2a trafficsplit \u5b50\u547d\u4ee4\uff08\u53ef\u4ee5\u7f29\u5199\u4e3a ts\uff09\uff0c\u6765\u663e\u793a\u6240\u6709\u7684\u6d41\u91cf\u62c6\u5206\u7edf\u8ba1\u4fe1\u606f\u3002 $ linkerd viz stat ts -n emojivoto Starting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi NAME APEX LEAF WEIGHT SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 web-svc-ts web-apex web-svc 500 - - - - - web-svc-ts web-apex web-svc-2 500 - - - - - \u7531\u4e8e\u6295\u7968\u673a\u5668\u4eba\u914d\u7f6e\u4e3a\u5c06\u6d41\u91cf\u53d1\u9001\u5230 web-svc.emojivoto:80 \uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u770b\u4e0d\u5230\u4efb\u4f55\u6d41\u91cf\u62c6\u5206\u7684\u6307\u6807\u3002 \u6240\u4ee5\u6211\u4eec\u5148\u66f4\u65b0\u4e0b vote-bot \u670d\u52a1\u5c06\u6d41\u91cf\u53d1\u9001\u5230 web-apex \u670d\u52a1\uff0c\u800c\u4e0d\u662f web-svc`\u3002 \u4ee5\u4e0b kubectl \u547d\u4ee4\u4e2d\u4f7f\u7528\u7684\u6587\u4ef6\u66f4\u6539\u4e86 vote-bot \u90e8\u7f72\u4e2d\u7684 WEB_HOST \u73af\u5883\u53d8\u91cf\uff0c\u4ee5\u5c06\u6d41\u91cf\u53d1\u9001\u5230 web-apex \u670d\u52a1\uff0c\u4ece\u800c\u4f7f TrafficSplit \u914d\u7f6e\u751f\u6548\u3002 $ kubectl edit deploy vote-bot -n emojivoto # ...... spec: containers: - command: - emojivoto-vote-bot env: - name: WEB_HOST value: web-apex.emojivoto:80 image: docker.l5d.io/buoyantio/emojivoto-web:v11 imagePullPolicy: IfNotPresent name: vote-bot # ...... \u66f4\u65b0\u540e\u65b0\u7684 vote-bot \u670d\u52a1\u5c06\u5411 web-apex \u670d\u52a1\u53d1\u51fa\u8bf7\u6c42\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684 trafficsplit \u5b50\u547d\u4ee4\u518d\u6b21\u6765\u9a8c\u8bc1\uff1a $ linkerd viz stat ts -n emojivoto Starting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi NAME APEX LEAF WEIGHT SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 web-svc-ts web-apex web-svc 500 90.32% 1.0rps 3ms 9ms 10ms web-svc-ts web-apex web-svc-2 500 96.49% 0.9rps 1ms 5ms 5ms \u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u53ef\u4ee5\u770b\u5230 web-apex \u670d\u52a1\u662f web-svc \u548c web-svc-2 \u670d\u52a1\u7684 APEX \u670d\u52a1\uff0c\u5b83\u4eec\u81ea\u5df1\u5219\u662f LEAF \u670d\u52a1\uff0c\u8f93\u51fa\u7ed3\u679c\u8fd8\u663e\u793a\u4e86\u6bcf\u4e2a\u670d\u52a1\u7684\u6743\u91cd\u5206\u5e03\u3002 \u8c03\u6574\u6743\u91cd \u63a5\u7740\u6211\u4eec\u518d\u7528 linkerd viz stat \u547d\u4ee4\u6765\u67e5\u770b\u4e0b\u5e94\u7528\u7684\u6d41\u91cf\u60c5\u51b5\uff0c\u4e0a\u4e00\u6b21\u6211\u4eec\u67e5\u770b\u7684\u65f6\u5019 web-svc-2 \u670d\u52a1\u5173\u8054\u7684 Pod \u6ca1\u6709\u6536\u5230\u4efb\u4f55\u6d41\u91cf\u3002 $ linkerd viz stat pod -n emojivoto NAME STATUS MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji-696d9d8f95-5vn9w Running 1/1 100.00% 2.3rps 1ms 2ms 3ms 5 vote-bot-646b9fd6fd-js526 Running 1/1 100.00% 0.3rps 1ms 1ms 1ms 1 voting-ff4c54b8d-xhjv7 Running 1/1 89.74% 1.3rps 1ms 7ms 9ms 5 web-5f86686c4d-58p7k Running 1/1 97.33% 1.2rps 2ms 9ms 10ms 3 web-svc-2-f9d77474f-hgsg4 Running 1/1 92.31% 1.3rps 1ms 6ms 9ms 3 \u8fd9\u6b21\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0e web-svc \u548c web-svc-2 \u76f8\u5173\u7684\u4e24\u4e2a Pod \u90fd\u5728\u5904\u7406\u8bf7\u6c42\u4e86\u3002\u8bc1\u660e\u6211\u4eec\u7684\u6d41\u91cf\u62c6\u5206\u914d\u7f6e\u662f\u6b63\u786e\u7684\u3002 TrafficSplit \u5b9a\u4e49\u4e2d\u5c06\u6bcf\u4e2a\u670d\u52a1\u7684\u6743\u91cd\u8bbe\u7f6e\u4e3a 500\uff0c\u4ee5\u5e73\u5747\u5206\u914d\u6d41\u91cf\u3002\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u5c06 web-svc-2 \u7684\u6743\u91cd\u8bbe\u7f6e\u4e3a 1%\u7684\u6216\u8005\u5f88\u4f4e\u7684\u6743\u91cd\u5f00\u59cb\uff0c\u4ee5\u786e\u4fdd\u6ca1\u6709\u9519\u8bef\uff0c\u7136\u540e\u5f53\u6211\u4eec\u786e\u5b9a\u65b0\u7248\u672c\u6ca1\u6709\u95ee\u9898\u540e\uff0c\u53ef\u4ee5\u8c03\u6574\u6162\u6162\u8c03\u6574\u6bcf\u4e2a\u670d\u52a1\u7684\u6743\u91cd\uff0c\u5230\u6700\u7ec8\u6240\u6709\u6d41\u91cf\u90fd\u5207\u6362\u5230\u65b0\u7248\u672c\u4e0a\u9762\u53bb\u3002 \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u624b\u52a8\u7f16\u8f91 TrafficSplit \u5bf9\u8c61\u6765\u624b\u52a8\u8c03\u6574\u8fd9\u4e24\u4e2a\u670d\u52a1\u7684\u6743\u91cd\u3002\u5c06 75% \u7684\u6d41\u91cf\u53d1\u9001\u5230 web-svc-2\uff0c\u5c06 25% \u7684\u6d41\u91cf\u53d1\u9001\u5230 web-svc\u3002 # web-svc-ts-2.yml apiVersion: split.smi-spec.io/v1alpha2 kind: TrafficSplit metadata: name: web-svc-ts namespace: emojivoto spec: # \u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1 service: web-apex # \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service \u4ee5\u53ca\u5b83\u4eec\u81ea\u5df1\u7684 selectors\u3001\u7aef\u70b9\u548c\u914d\u7f6e\u3002 backends: # \u62c6\u5206\u7684\u540e\u7aef\u670d\u52a1 - service: web-svc weight: 250 # \u6743\u91cd - service: web-svc-2 weight: 750 \u66f4\u65b0\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u540e\uff0c\u518d\u6b21\u67e5\u770b\u6d41\u91cf\u62c6\u5206\u7684\u60c5\u51b5\u3002 $ linkerd viz stat ts -n emojivoto Starting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi NAME APEX LEAF WEIGHT SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 web-svc-ts web-apex web-svc 250 87.88% 0.6rps 6ms 17ms 20ms web-svc-ts web-apex web-svc-2 750 94.12% 1.4rps 2ms 8ms 10ms \u5728\u8f93\u51fa\u4e2d\uff0c\u4f60\u5c06\u770b\u5230 WEIGHT \u5217\u4e0e\u4e0a\u9762\u7684\u53d8\u66f4\u76f8\u5339\u914d\uff0cweb-svc-2 \u4e3a 750\u3001web-svc \u4e3a 250\u3002\u63a5\u7740\u6211\u4eec\u518d\u66f4\u6539 TrafficSplit \u5bf9\u8c61\uff0c\u5c06\u6240\u6709\u6d41\u91cf\u53d1\u9001\u5230 web-svc-2 \u670d\u52a1\u53bb\u3002 # web-svc-ts-3.yml apiVersion: split.smi-spec.io/v1alpha2 kind: TrafficSplit metadata: name: web-svc-ts namespace: emojivoto spec: # \u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1 service: web-apex # \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service \u4ee5\u53ca\u5b83\u4eec\u81ea\u5df1\u7684 selectors\u3001\u7aef\u70b9\u548c\u914d\u7f6e\u3002 backends: # \u62c6\u5206\u7684\u540e\u7aef\u670d\u52a1 - service: web-svc weight: 0 # \u6743\u91cd - service: web-svc-2 weight: 1 \u66f4\u65b0\u540e\u6211\u4eec\u518d\u6b21\u67e5\u770b\u6d41\u91cf\u62c6\u5206\u60c5\u51b5\uff1a $ linkerd viz stat ts -n emojivoto Starting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi NAME APEX LEAF WEIGHT SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 web-svc-ts web-apex web-svc 0 - - - - - web-svc-ts web-apex web-svc-2 1 99.15% 1.9rps 2ms 3ms 3ms \u6b63\u5e38\u6211\u4eec\u53ef\u4ee5\u770b\u5230 web-svc-2 \u670d\u52a1\u5bf9\u5e94\u7684 WEIGHT \u4e3a 1\uff0c\u800c web-svc \u4e3a 0\u3002 \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u4e2d\u7684\u6d41\u91cf\u62c6\u5206\u7684\u4f7f\u7528\uff0c\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u4e00\u4e2a\u5355\u72ec\u7684 web-apex \u670d\u52a1\uff0c\u5f53\u7136 apex \u670d\u52a1\u4e5f\u53ef\u4ee5\u662f\u540e\u7aef\u4e4b\u4e00\u7684\u670d\u52a1\uff0capex \u548c\u540e\u7aef\u4e4b\u4e00\u5177\u6709\u76f8\u540c\u670d\u52a1\u7684 TrafficSplit \u4f1a\u5c06\u53d1\u5f80\u8be5\u670d\u52a1\u7684\u6d41\u91cf\u53d1\u9001\u5230\u8be5\u670d\u52a1\uff0c\u4f46\u4f1a\u4e0e\u5176\u4f59\u540e\u7aef\u670d\u52a1\u6210\u6bd4\u4f8b\uff0c\u8fd9\u662f\u53ef\u4ee5\u52a8\u6001\u5b8c\u6210\u7684\uff0c\u5141\u8bb8\u4f60\u5728\u73b0\u6709\u670d\u52a1\u4e4b\u4e0a\u63d2\u5165\u4e00\u4e2a TrafficSplit\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u5730\u4f7f\u7528 web-svc \u4f5c\u4e3a apex\uff08\u5e76\u7ee7\u7eed\u4f7f\u7528\u5b83\u4ee5\u53ca web-svc-2 \u4f5c\u4e3a\u540e\u7aef\uff09\uff0c\u800c\u4e0d\u662f\u4f7f\u7528 web-apex\u3002\u5728\u521b\u5efa TrafficSplit \u7684\u90a3\u4e00\u523b\uff0c\u5230 web-svc \u7684\u73b0\u6709\u6d41\u91cf\u5c06\u9075\u5faa TrafficSplit \u7684\u89c4\u5219\uff1b\u5e76\u4e14\u5728\u5b83\u88ab\u5220\u9664\u7684\u90a3\u4e00\u523b\uff0c\u5230 web-svc \u7684\u6d41\u91cf\u5c06\u6062\u590d\u6b63\u5e38\u3002 \u5728\u5b9e\u8df5\u4e2d\u6211\u4eec\u5f80\u5f80\u8fd8\u4f1a\u5c06 Linkerd \u7684\u6d41\u91cf\u62c6\u5206\u529f\u80fd\u4e0e CI/CD \u7cfb\u7edf\u8fdb\u884c\u96c6\u6210\uff0c\u4ee5\u81ea\u52a8\u5316\u53d1\u5e03\u8fc7\u7a0b\uff0cLinkerd \u672c\u8eab\u5c31\u63d0\u4f9b\u4e86\u76f8\u5173\u6307\u6807\uff0c\u8fd9\u7ed3\u5408\u8d77\u6765\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u5b9e\u73b0\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u4e86\uff1a \u901a\u8fc7\u5c06\u6307\u6807\u548c\u6d41\u91cf\u62c6\u5206\u6346\u7ed1\u5728\u4e00\u8d77\uff0c\u53ef\u4ee5\u4ee5\u589e\u91cf\u3001\u5b89\u5168\u548c\u5b8c\u5168\u81ea\u52a8\u5316\u7684\u65b9\u5f0f\u53d1\u5e03\u65b0\u4ee3\u7801\uff0c\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u8fc7 Argo Rollouts\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528\u50cf https://flagger.app/ \u8fd9\u6837\u7684\u9879\u76ee\uff0c\u56e0\u4e3a\u5b83\u662f\u5efa\u7acb\u5728 Linkerd \u7684\u6307\u6807\u548c\u6d41\u91cf\u62c6\u5206\u529f\u80fd\u4e4b\u4e0a\u6765\u6267\u884c\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u7684 \u3002","title":"5 \u5728 Linkerd \u4e2d\u5b9e\u73b0\u6d41\u91cf\u62c6\u5206\u529f\u80fd"},{"location":"chap11/5linkerd_flow_split/#5-linkerd","text":"\u5728 Linkerd \u4e2d\uff0c\u91d1\u4e1d\u96c0\u53d1\u5e03\u662f\u901a\u8fc7\u6d41\u91cf\u62c6\u5206\u6765\u7ba1\u7406\u7684\uff0c\u8fd9\u9879\u529f\u80fd\u5141\u8bb8\u4f60\u6839\u636e\u53ef\u52a8\u6001\u914d\u7f6e\u7684\u6743\u91cd\uff0c\u5c06\u8bf7\u6c42\u5206\u914d\u7ed9\u4e0d\u540c\u7684 Kubernetes \u670d\u52a1\u5bf9\u8c61\u3002 \u867d\u7136\u6d41\u91cf\u5206\u5272\u53ef\u4ee5\u9002\u7528\u4e8e\u4efb\u610f\u7684 Service \u5bf9\u8c61\uff0c\u4f46\u4e00\u822c\u60c5\u51b5\u4e0b\u662f\u5c06\u4e00\u4e2a Service \u7684\u4f20\u5165\u6d41\u91cf\u5206\u7ed9\u4e0d\u540c\u7248\u672c\u7684 Service\u3002 \u6d41\u91cf\u5206\u5272\u529f\u80fd\u662f\u901a\u8fc7 Linkerd \u7684 TrafficSplit CRD \u6765\u63a7\u5236\u7684\uff08 TrafficSplit CRD \u9075\u5faa\u670d\u52a1\u7f51\u63a5\u53e3\uff08SMI\uff09\u4e2d\u5b9a\u4e49\u7684\u89c4\u8303\uff0c\u8fd9\u662f Linkerd \u5b9e\u73b0\u7684\u51e0\u4e2a SMI API \u4e2d\u7684\u4e00\u4e2a \uff09\u3002 \u521b\u5efa TrafficSplit CRD \u5141\u8bb8\u6211\u4eec\u63a7\u5236 Linkerd \u5982\u4f55\u5c06\u6d41\u91cf\u4ee3\u7406\u7ed9 TrafficSplit \u5f15\u7528\u7684\u670d\u52a1 \u3002 TrafficSplit CRD \u662f\u6839\u636e Kubernetes Service \u5bf9\u8c61\u7f16\u5199\u7684\uff0cTrafficSplit \u63cf\u8ff0\u4e86\u4e00\u4e2a\u4e2d\u5fc3\u6839\u6216 apex \u670d\u52a1\uff0c\u6d41\u91cf\u88ab\u53d1\u9001\u5230\u8be5\u670d\u52a1\uff0c\u4ee5\u53ca\u4e00\u4e2a\u6216\u591a\u4e2a\u5b9e\u9645\u63a5\u6536\u5b83\u7684\u540e\u7aef\u670d\u52a1\uff0c\u4e0e TrafficSplit \u4e2d\u8fd8\u6307\u5b9a\u7684\u6743\u91cd\u6210\u6bd4\u4f8b\u3002 \u53e6\u5916\u9700\u8981\u6ce8\u610f\uff0cKubernetes \u7684 Service \u5bf9\u8c61\u4e0d\u4e00\u5b9a\u6709\u540e\u53f0\u5de5\u4f5c\u8d1f\u8f7d\u3002\u867d\u7136\u8fd9\u5bf9\u4e8e\u666e\u901a\u670d\u52a1\u6765\u8bf4\u5f88\u5c11\u89c1\uff0c\u4f46\u662f\u6211\u4eec\u4f1a\u5728 TrafficSplits \u7684 apex \u670d\u52a1\u4e2d\u5927\u91cf\u4f7f\u7528\u8be5\u529f\u80fd\uff0c\u56e0\u4e3a TrafficSplit \u4f1a\u5bfc\u81f4\u53d1\u5f80 apex \u7684\u6d41\u91cf\u5b9e\u9645\u53d1\u9001\u5230\u540e\u7aef\u670d\u52a1\uff0c\u6240\u4ee5 apex \u5b9e\u9645\u4e0a\u4e0d\u9700\u8981\u62e5\u6709\u81ea\u5df1\u7684 Deployment\u3002","title":"5 \u5728 Linkerd \u4e2d\u5b9e\u73b0\u6d41\u91cf\u62c6\u5206\u529f\u80fd"},{"location":"chap11/5linkerd_flow_split/#_1","text":"\u63a5\u4e0b\u6765\u6211\u4eec\u8fd8\u662f\u4ee5 Emojivoto \u5e94\u7528\u4e3a\u4f8b\u6765\u521b\u5efa\u4e24\u4e2a\u65b0\u7684 Service \u5bf9\u8c61\uff0capex \u670d\u52a1\u5c06\u6ca1\u6709\u5173\u8054\u7684 Deployment \u8d44\u6e90\uff0c\u7b2c\u4e8c\u9879\u670d\u52a1\u5c06\u662f Emojivoto \u7684 web \u670d\u52a1\u7684\u4e00\u4e2a\u66f4\u65b0\u7248\u672c\uff0c\u4f1a\u5728\u9875\u9762\u9876\u90e8\u6dfb\u52a0\u4e00\u4e9b\u6587\u672c\u4fe1\u606f\u3002 \u521b\u5efa\u8fd9\u4e24\u4e2a\u670d\u52a1\u540e\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a TrafficSplit \u8d44\u6e90\uff0c\u8be5\u8d44\u6e90\u4f1a\u5c06\u53d1\u9001\u5230 apex \u670d\u52a1\u7684\u6d41\u91cf\u5728 web \u670d\u52a1\u7684\u539f\u59cb\u7248\u672c\u548c\u66f4\u65b0\u7248\u672c\u4e4b\u95f4\u8fdb\u884c\u62c6\u5206\u3002 \u66f4\u65b0\u7248\u672c\u7684 web \u670d\u52a1\u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a # web-svc-2.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-2 namespace: emojivoto --- apiVersion: v1 kind: Service metadata: name: web-svc-2 namespace: emojivoto spec: ports: - name: http port: 80 targetPort: 8080 selector: app: web-svc-2 type: ClusterIP --- apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/name: web-svc-2 app.kubernetes.io/part-of: emojivoto app.kubernetes.io/version: linux-training-v2 name: web-svc-2 namespace: emojivoto spec: selector: matchLabels: app: web-svc-2 version: linux-training-v2 template: metadata: annotations: linkerd.io/inject: enabled # \u8bbe\u7f6e\u81ea\u52a8\u6ce8\u5165\u7684\u6ce8\u89e3 labels: app: web-svc-2 version: linux-training-v2 spec: containers: - env: - name: WEB_PORT value: \"8080\" - name: EMOJISVC_HOST value: emoji-svc.emojivoto:8080 - name: VOTINGSVC_HOST value: voting-svc.emojivoto:8080 - name: INDEX_BUNDLE value: dist/index_bundle.js - name: MESSAGE_OF_THE_DAY value: \"Welcome to version 2! Now with more words!\" image: buoyantio/emojivoto-web:lf-training name: web-svc-2 ports: - containerPort: 8080 name: http resources: requests: cpu: 100m serviceAccountName: web-2 \u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f web-svc-2.yaml serviceaccount/web-2 created service/web-svc-2 created deployment.apps/web-svc-2 created \u90e8\u7f72\u540e\u5148\u9a8c\u8bc1\u66f4\u65b0\u7248\u672c\u7684\u670d\u52a1\u662f\u5426\u5df2\u7ecf\u6b63\u786e\u90e8\u7f72\u4e86\u3002 $ kubectl get po --selector app=web-svc-2 -n emojivoto NAME READY STATUS RESTARTS AGE web-svc-2-f9d77474f-hgsg4 2/2 Running 0 10s $ kubectl get svc web-svc-2 -n emojivoto NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE web-svc-2 ClusterIP 10.102.99.153 <none> 80/TCP 3m45s \u90e8\u7f72\u6210\u529f\u540e\u540c\u6837\u53ef\u4ee5\u4f7f\u7528 kubectl port-forward \u547d\u4ee4\u6765\u66b4\u9732\u670d\u52a1\uff1a $ kubectl port-forward svc/web-svc-2 8080:80 -n emojivoto \u540c\u6837\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u901a\u8fc7 localhost:8080 \u8bbf\u95ee\u65b0\u7248\u672c\u7684\u5e94\u7528\u3002 \u5728\u9875\u9762\u9876\u90e8\u53ef\u4ee5\u770b\u5230\u65b0\u7248\u672c\u7684\u5e94\u7528\u591a\u4e86\u4e00\u884c\u5b57\u7b26\u4fe1\u606f\u3002","title":"\u66f4\u65b0\u670d\u52a1"},{"location":"chap11/5linkerd_flow_split/#trafficsplit","text":"\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a apex \u670d\u52a1\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06\u5176\u79f0\u4e3a web-apex\uff0c\u4e0d\u8fc7\u8fd9\u6b21\u6ca1\u6709 Pod \u8fd0\u884c\uff0c\u6240\u4ee5\u65e0\u6cd5\u5411\u670d\u52a1\u53d1\u9001\u4efb\u4f55\u8bf7\u6c42\uff0c\u56e0\u4e3a\u6ca1\u6709\u7aef\u70b9\u3002 # web-apex.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-apex namespace: emojivoto --- apiVersion: v1 kind: Service metadata: name: web-apex namespace: emojivoto spec: ports: - name: http port: 80 selector: app: web-apex type: ClusterIP \u540c\u6837\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f web-apex.yaml serviceaccount/web-apex created service/web-apex created $ kubectl get svc -n emojivoto -o wide NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR emoji-svc ClusterIP 10.103.235.14 <none> 8080/TCP,8801/TCP 8d app=emoji-svc voting-svc ClusterIP 10.102.32.81 <none> 8080/TCP,8801/TCP 8d app=voting-svc web-apex ClusterIP 10.104.12.249 <none> 80/TCP 84s app=web-apex web-svc ClusterIP 10.106.220.250 <none> 80/TCP 8d app=web-svc web-svc-2 ClusterIP 10.102.99.153 <none> 80/TCP 27m app=web-svc-2 \u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u53ef\u4ee5\u770b\u5230 web-apex \u670d\u52a1\u548c\u5176\u4ed6\u666e\u901a\u670d\u52a1\u4e00\u6837 \uff0c\u4f46\u662f\u4ed6\u5e76\u6ca1\u6709\u7aef\u70b9\u3002 $ kubectl get ep -n emojivoto NAME ENDPOINTS AGE emoji-svc 10.244.1.228:8801,10.244.1.228:8080 8d voting-svc 10.244.1.202:8801,10.244.1.202:8080 8d web-apex <none> 2m55s web-svc 10.244.1.227:8080 8d web-svc-2 10.244.1.233:8080 28m \u5728\u7ee7\u7eed\u4e4b\u524d\u6211\u4eec\u53ef\u4ee5\u5148\u770b\u770b\u5f53\u524d\u5e94\u7528\u7684\u6d41\u91cf\u72b6\u6001\uff1a $ linkerd viz stat po -n emojivoto NAME STATUS MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji-696d9d8f95-5vn9w Running 1/1 100.00% 2.3rps 1ms 1ms 1ms 4 vote-bot-6d7677bb68-jvxsg Running 1/1 100.00% 0.3rps 1ms 1ms 1ms 1 voting-ff4c54b8d-xhjv7 Running 1/1 98.04% 0.8rps 1ms 8ms 10ms 4 web-5f86686c4d-58p7k Running 1/1 100.00% 1.4rps 1ms 6ms 9ms 2 \u53ef\u4ee5\u6e05\u695a\u770b\u5230\u867d\u7136\u6211\u4eec\u5c06 web \u670d\u52a1\u7684\u66f4\u65b0\u7248\u672c\u5df2\u7ecf\u90e8\u7f72\u4e86\uff0c \u4f46\u662f\u73b0\u5728\u6ca1\u6709\u4ea7\u751f\u4efb\u4f55\u7684\u6d41\u91cf\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u53bb\u521b\u5efa\u4e00\u4e2a TrafficSplit \u5bf9\u8c61\uff0c\u7136\u540e\u53bb\u62c6\u5206\u4e00\u90e8\u5206\u6d41\u91cf\u5230\u6211\u4eec\u7684\u65b0\u670d\u52a1\u4e2d\u53bb \u3002 \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 TrafficSplit \u8d44\u6e90\u5bf9\u8c61\uff1a # web-svc-ts.yml apiVersion: split.smi-spec.io/v1alpha2 kind: TrafficSplit metadata: name: web-svc-ts namespace: emojivoto spec: # \u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1 service: web-apex # \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service \u4ee5\u53ca\u5b83\u4eec\u81ea\u5df1\u7684 selectors\u3001\u7aef\u70b9\u548c\u914d\u7f6e\u3002 backends: # \u62c6\u5206\u7684\u540e\u7aef\u670d\u52a1 - service: web-svc weight: 500 # \u6743\u91cd - service: web-svc-2 weight: 500 \u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u4e2d\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u5c5e\u6027\uff1a service\uff1a\u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1 backends\uff1a\u547d\u540d\u7a7a\u95f4\u5185\u7684\u670d\u52a1\uff0c\u5177\u6709\u81ea\u5df1\u7684\u9009\u62e9\u5668\u3001\u7aef\u70b9\u548c\u914d\u7f6e\uff08\u6211\u4eec\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u670d\u52a1\u770b\u6210\u53f6\u670d\u52a1\uff09\u3002 service\uff1a\u4e0e\u53ef\u4ee5\u5904\u7406\u8bf7\u6c42\u7684 Pod \u5173\u8054\u5730\u5177\u4f53\u670d\u52a1\u7684\u540d\u79f0\u3002 weight\uff1a\u5b83\u4e0e\u5206\u914d\u7ed9\u670d\u52a1\u7684\u603b\u6d41\u91cf\u7684\u767e\u5206\u6bd4\u76f8\u5173\u3002 \u73b0\u5728\u6211\u4eec\u6765\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f web-svc-ts.yaml trafficsplit.split.smi-spec.io/web-svc-ts created $ kubectl get trafficsplit -n emojivoto NAME SERVICE web-svc-ts web-apex \u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 linkerd viz stat \u547d\u4ee4\u7684\u4e00\u4e2a trafficsplit \u5b50\u547d\u4ee4\uff08\u53ef\u4ee5\u7f29\u5199\u4e3a ts\uff09\uff0c\u6765\u663e\u793a\u6240\u6709\u7684\u6d41\u91cf\u62c6\u5206\u7edf\u8ba1\u4fe1\u606f\u3002 $ linkerd viz stat ts -n emojivoto Starting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi NAME APEX LEAF WEIGHT SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 web-svc-ts web-apex web-svc 500 - - - - - web-svc-ts web-apex web-svc-2 500 - - - - - \u7531\u4e8e\u6295\u7968\u673a\u5668\u4eba\u914d\u7f6e\u4e3a\u5c06\u6d41\u91cf\u53d1\u9001\u5230 web-svc.emojivoto:80 \uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u770b\u4e0d\u5230\u4efb\u4f55\u6d41\u91cf\u62c6\u5206\u7684\u6307\u6807\u3002 \u6240\u4ee5\u6211\u4eec\u5148\u66f4\u65b0\u4e0b vote-bot \u670d\u52a1\u5c06\u6d41\u91cf\u53d1\u9001\u5230 web-apex \u670d\u52a1\uff0c\u800c\u4e0d\u662f web-svc`\u3002 \u4ee5\u4e0b kubectl \u547d\u4ee4\u4e2d\u4f7f\u7528\u7684\u6587\u4ef6\u66f4\u6539\u4e86 vote-bot \u90e8\u7f72\u4e2d\u7684 WEB_HOST \u73af\u5883\u53d8\u91cf\uff0c\u4ee5\u5c06\u6d41\u91cf\u53d1\u9001\u5230 web-apex \u670d\u52a1\uff0c\u4ece\u800c\u4f7f TrafficSplit \u914d\u7f6e\u751f\u6548\u3002 $ kubectl edit deploy vote-bot -n emojivoto # ...... spec: containers: - command: - emojivoto-vote-bot env: - name: WEB_HOST value: web-apex.emojivoto:80 image: docker.l5d.io/buoyantio/emojivoto-web:v11 imagePullPolicy: IfNotPresent name: vote-bot # ...... \u66f4\u65b0\u540e\u65b0\u7684 vote-bot \u670d\u52a1\u5c06\u5411 web-apex \u670d\u52a1\u53d1\u51fa\u8bf7\u6c42\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684 trafficsplit \u5b50\u547d\u4ee4\u518d\u6b21\u6765\u9a8c\u8bc1\uff1a $ linkerd viz stat ts -n emojivoto Starting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi NAME APEX LEAF WEIGHT SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 web-svc-ts web-apex web-svc 500 90.32% 1.0rps 3ms 9ms 10ms web-svc-ts web-apex web-svc-2 500 96.49% 0.9rps 1ms 5ms 5ms \u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u53ef\u4ee5\u770b\u5230 web-apex \u670d\u52a1\u662f web-svc \u548c web-svc-2 \u670d\u52a1\u7684 APEX \u670d\u52a1\uff0c\u5b83\u4eec\u81ea\u5df1\u5219\u662f LEAF \u670d\u52a1\uff0c\u8f93\u51fa\u7ed3\u679c\u8fd8\u663e\u793a\u4e86\u6bcf\u4e2a\u670d\u52a1\u7684\u6743\u91cd\u5206\u5e03\u3002","title":"\u521b\u5efa TrafficSplit"},{"location":"chap11/5linkerd_flow_split/#_2","text":"\u63a5\u7740\u6211\u4eec\u518d\u7528 linkerd viz stat \u547d\u4ee4\u6765\u67e5\u770b\u4e0b\u5e94\u7528\u7684\u6d41\u91cf\u60c5\u51b5\uff0c\u4e0a\u4e00\u6b21\u6211\u4eec\u67e5\u770b\u7684\u65f6\u5019 web-svc-2 \u670d\u52a1\u5173\u8054\u7684 Pod \u6ca1\u6709\u6536\u5230\u4efb\u4f55\u6d41\u91cf\u3002 $ linkerd viz stat pod -n emojivoto NAME STATUS MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONN emoji-696d9d8f95-5vn9w Running 1/1 100.00% 2.3rps 1ms 2ms 3ms 5 vote-bot-646b9fd6fd-js526 Running 1/1 100.00% 0.3rps 1ms 1ms 1ms 1 voting-ff4c54b8d-xhjv7 Running 1/1 89.74% 1.3rps 1ms 7ms 9ms 5 web-5f86686c4d-58p7k Running 1/1 97.33% 1.2rps 2ms 9ms 10ms 3 web-svc-2-f9d77474f-hgsg4 Running 1/1 92.31% 1.3rps 1ms 6ms 9ms 3 \u8fd9\u6b21\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0e web-svc \u548c web-svc-2 \u76f8\u5173\u7684\u4e24\u4e2a Pod \u90fd\u5728\u5904\u7406\u8bf7\u6c42\u4e86\u3002\u8bc1\u660e\u6211\u4eec\u7684\u6d41\u91cf\u62c6\u5206\u914d\u7f6e\u662f\u6b63\u786e\u7684\u3002 TrafficSplit \u5b9a\u4e49\u4e2d\u5c06\u6bcf\u4e2a\u670d\u52a1\u7684\u6743\u91cd\u8bbe\u7f6e\u4e3a 500\uff0c\u4ee5\u5e73\u5747\u5206\u914d\u6d41\u91cf\u3002\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u5c06 web-svc-2 \u7684\u6743\u91cd\u8bbe\u7f6e\u4e3a 1%\u7684\u6216\u8005\u5f88\u4f4e\u7684\u6743\u91cd\u5f00\u59cb\uff0c\u4ee5\u786e\u4fdd\u6ca1\u6709\u9519\u8bef\uff0c\u7136\u540e\u5f53\u6211\u4eec\u786e\u5b9a\u65b0\u7248\u672c\u6ca1\u6709\u95ee\u9898\u540e\uff0c\u53ef\u4ee5\u8c03\u6574\u6162\u6162\u8c03\u6574\u6bcf\u4e2a\u670d\u52a1\u7684\u6743\u91cd\uff0c\u5230\u6700\u7ec8\u6240\u6709\u6d41\u91cf\u90fd\u5207\u6362\u5230\u65b0\u7248\u672c\u4e0a\u9762\u53bb\u3002 \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u624b\u52a8\u7f16\u8f91 TrafficSplit \u5bf9\u8c61\u6765\u624b\u52a8\u8c03\u6574\u8fd9\u4e24\u4e2a\u670d\u52a1\u7684\u6743\u91cd\u3002\u5c06 75% \u7684\u6d41\u91cf\u53d1\u9001\u5230 web-svc-2\uff0c\u5c06 25% \u7684\u6d41\u91cf\u53d1\u9001\u5230 web-svc\u3002 # web-svc-ts-2.yml apiVersion: split.smi-spec.io/v1alpha2 kind: TrafficSplit metadata: name: web-svc-ts namespace: emojivoto spec: # \u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1 service: web-apex # \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service \u4ee5\u53ca\u5b83\u4eec\u81ea\u5df1\u7684 selectors\u3001\u7aef\u70b9\u548c\u914d\u7f6e\u3002 backends: # \u62c6\u5206\u7684\u540e\u7aef\u670d\u52a1 - service: web-svc weight: 250 # \u6743\u91cd - service: web-svc-2 weight: 750 \u66f4\u65b0\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u540e\uff0c\u518d\u6b21\u67e5\u770b\u6d41\u91cf\u62c6\u5206\u7684\u60c5\u51b5\u3002 $ linkerd viz stat ts -n emojivoto Starting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi NAME APEX LEAF WEIGHT SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 web-svc-ts web-apex web-svc 250 87.88% 0.6rps 6ms 17ms 20ms web-svc-ts web-apex web-svc-2 750 94.12% 1.4rps 2ms 8ms 10ms \u5728\u8f93\u51fa\u4e2d\uff0c\u4f60\u5c06\u770b\u5230 WEIGHT \u5217\u4e0e\u4e0a\u9762\u7684\u53d8\u66f4\u76f8\u5339\u914d\uff0cweb-svc-2 \u4e3a 750\u3001web-svc \u4e3a 250\u3002\u63a5\u7740\u6211\u4eec\u518d\u66f4\u6539 TrafficSplit \u5bf9\u8c61\uff0c\u5c06\u6240\u6709\u6d41\u91cf\u53d1\u9001\u5230 web-svc-2 \u670d\u52a1\u53bb\u3002 # web-svc-ts-3.yml apiVersion: split.smi-spec.io/v1alpha2 kind: TrafficSplit metadata: name: web-svc-ts namespace: emojivoto spec: # \u5ba2\u6237\u7aef\u7528\u4e8e\u8fde\u63a5\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684 root \u670d\u52a1 service: web-apex # \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service \u4ee5\u53ca\u5b83\u4eec\u81ea\u5df1\u7684 selectors\u3001\u7aef\u70b9\u548c\u914d\u7f6e\u3002 backends: # \u62c6\u5206\u7684\u540e\u7aef\u670d\u52a1 - service: web-svc weight: 0 # \u6743\u91cd - service: web-svc-2 weight: 1 \u66f4\u65b0\u540e\u6211\u4eec\u518d\u6b21\u67e5\u770b\u6d41\u91cf\u62c6\u5206\u60c5\u51b5\uff1a $ linkerd viz stat ts -n emojivoto Starting in 2.12, the SMI extension will be required for traffic splitting. Please follow the SMI extension getting started guide from https://linkerd.io/2.10/tasks/linkerd-smi NAME APEX LEAF WEIGHT SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 web-svc-ts web-apex web-svc 0 - - - - - web-svc-ts web-apex web-svc-2 1 99.15% 1.9rps 2ms 3ms 3ms \u6b63\u5e38\u6211\u4eec\u53ef\u4ee5\u770b\u5230 web-svc-2 \u670d\u52a1\u5bf9\u5e94\u7684 WEIGHT \u4e3a 1\uff0c\u800c web-svc \u4e3a 0\u3002 \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u4e86\u89e3\u4e86 Linkerd \u4e2d\u7684\u6d41\u91cf\u62c6\u5206\u7684\u4f7f\u7528\uff0c\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u4e00\u4e2a\u5355\u72ec\u7684 web-apex \u670d\u52a1\uff0c\u5f53\u7136 apex \u670d\u52a1\u4e5f\u53ef\u4ee5\u662f\u540e\u7aef\u4e4b\u4e00\u7684\u670d\u52a1\uff0capex \u548c\u540e\u7aef\u4e4b\u4e00\u5177\u6709\u76f8\u540c\u670d\u52a1\u7684 TrafficSplit \u4f1a\u5c06\u53d1\u5f80\u8be5\u670d\u52a1\u7684\u6d41\u91cf\u53d1\u9001\u5230\u8be5\u670d\u52a1\uff0c\u4f46\u4f1a\u4e0e\u5176\u4f59\u540e\u7aef\u670d\u52a1\u6210\u6bd4\u4f8b\uff0c\u8fd9\u662f\u53ef\u4ee5\u52a8\u6001\u5b8c\u6210\u7684\uff0c\u5141\u8bb8\u4f60\u5728\u73b0\u6709\u670d\u52a1\u4e4b\u4e0a\u63d2\u5165\u4e00\u4e2a TrafficSplit\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u5730\u4f7f\u7528 web-svc \u4f5c\u4e3a apex\uff08\u5e76\u7ee7\u7eed\u4f7f\u7528\u5b83\u4ee5\u53ca web-svc-2 \u4f5c\u4e3a\u540e\u7aef\uff09\uff0c\u800c\u4e0d\u662f\u4f7f\u7528 web-apex\u3002\u5728\u521b\u5efa TrafficSplit \u7684\u90a3\u4e00\u523b\uff0c\u5230 web-svc \u7684\u73b0\u6709\u6d41\u91cf\u5c06\u9075\u5faa TrafficSplit \u7684\u89c4\u5219\uff1b\u5e76\u4e14\u5728\u5b83\u88ab\u5220\u9664\u7684\u90a3\u4e00\u523b\uff0c\u5230 web-svc \u7684\u6d41\u91cf\u5c06\u6062\u590d\u6b63\u5e38\u3002 \u5728\u5b9e\u8df5\u4e2d\u6211\u4eec\u5f80\u5f80\u8fd8\u4f1a\u5c06 Linkerd \u7684\u6d41\u91cf\u62c6\u5206\u529f\u80fd\u4e0e CI/CD \u7cfb\u7edf\u8fdb\u884c\u96c6\u6210\uff0c\u4ee5\u81ea\u52a8\u5316\u53d1\u5e03\u8fc7\u7a0b\uff0cLinkerd \u672c\u8eab\u5c31\u63d0\u4f9b\u4e86\u76f8\u5173\u6307\u6807\uff0c\u8fd9\u7ed3\u5408\u8d77\u6765\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u5b9e\u73b0\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u4e86\uff1a \u901a\u8fc7\u5c06\u6307\u6807\u548c\u6d41\u91cf\u62c6\u5206\u6346\u7ed1\u5728\u4e00\u8d77\uff0c\u53ef\u4ee5\u4ee5\u589e\u91cf\u3001\u5b89\u5168\u548c\u5b8c\u5168\u81ea\u52a8\u5316\u7684\u65b9\u5f0f\u53d1\u5e03\u65b0\u4ee3\u7801\uff0c\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u8fc7 Argo Rollouts\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528\u50cf https://flagger.app/ \u8fd9\u6837\u7684\u9879\u76ee\uff0c\u56e0\u4e3a\u5b83\u662f\u5efa\u7acb\u5728 Linkerd \u7684\u6307\u6807\u548c\u6d41\u91cf\u62c6\u5206\u529f\u80fd\u4e4b\u4e0a\u6765\u6267\u884c\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u7684 \u3002","title":"\u8c03\u6574\u6743\u91cd"},{"location":"chap11/6linkered_prod/","text":"6 \u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528 Linkerd \u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u4e00\u76f4\u5728\u4ee5\u6700\u57fa\u672c\u7684\u5f62\u5f0f\u4f7f\u7528 Linkerd\uff0c\u800c\u6ca1\u6709\u5173\u6ce8\u751f\u4ea7\u7ea7\u522b\u7684\u76f8\u5173\u95ee\u9898\u3002\u672c\u8282\u6211\u4eec\u5c06\u4e86\u89e3\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u7684\u4e00\u4e9b\u4e3b\u8981\u6ce8\u610f\u4e8b\u9879\uff0c\u5305\u62ec\u9ad8\u53ef\u7528 (HA) \u6a21\u5f0f\u3001Helm Chart\u3001\u8de8\u96c6\u7fa4\u901a\u4fe1\u548c\u5916\u90e8 Prometheus\u3002 \u9ad8\u53ef\u7528 \u9ad8\u53ef\u7528 \u63cf\u8ff0\u4e86\u5177\u6709\u5197\u4f59\u67b6\u6784\u7684\u7cfb\u7edf\uff0c\u5982\u679c\u7cfb\u7edf\u7684\u67d0\u4e9b\u90e8\u5206\u51fa\u73b0\u6545\u969c\uff0c\u8be5\u7cfb\u7edf\u5c06\u7ee7\u7eed\u8fd0\u884c\u3002Linkerd \u7684\u9ad8\u53ef\u7528\u6a21\u5f0f\u65e8\u5728\u6d88\u9664\u63a7\u5236\u5e73\u9762\u7684\u5355\u70b9\u6545\u969c\u3002 \u542f\u7528 HA \u6a21\u5f0f\u7684\u4e00\u79cd\u65b9\u6cd5\u662f\u4e3a linkerd install \u6307\u5b9a --ha \u6807\u5fd7 \uff0c\u6b64\u6807\u5fd7\u542f\u7528\u51e0\u79cd\u4e0d\u540c\u7684\u884c\u4e3a\u3002\u5b83\u53ef\u4ee5\u90e8\u7f72\u67d0\u4e9b Linkerd \u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u7684\u591a\u4e2a\u526f\u672c\uff1a Controller Destination Identity Proxy Injector Service Profile Validator \u8bf7\u6ce8\u610f\uff0c\u5176\u4ed6\u7ec4\u4ef6\uff0c\u4f8b\u5982 Grafana\u3001Prometheus\uff0c\u4e0d\u88ab\u770b\u6210\u6838\u5fc3\u7684\u5173\u952e\u7ec4\u4ef6\uff0c\u56e0\u6b64\u4e0d\u4f1a\u914d\u7f6e\u591a\u526f\u672c\uff08\u5982\u679c\u6ca1\u6709\u8fd9\u4e9b\u7ec4\u4ef6\uff0c\u6570\u636e\u5e73\u9762\u4ecd\u7136\u53ef\u4ee5\u7ee7\u7eed\u6b63\u5e38\u8fd0\u884c\uff09\u3002 \u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f HA \u6a21\u5f0f\u6709\u4e00\u4e9b\u7ec6\u5fae\u7684\u533a\u522b\uff0c \u9996\u5148 HA \u6a21\u5f0f\u6539\u53d8\u4e86 proxy injector \u7684\u65b9\u5f0f\uff0c\u5f3a\u5236\u8981\u6c42\u5728\u6709\u9002\u5f53\u6ce8\u89e3\u7684\u60c5\u51b5\u4e0b\u6ce8\u5165\u4ee3\u7406 \u3002 \u8fd9\u662f\u4e3a\u4e86\u786e\u4fdd\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c \u4f7f\u7528 Linkerd \u8fdb\u884c mTLS \u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4f9d\u8d56\u8be5\u4ee3\u7406\uff0c\u5f53\u7136\u5982\u679c Linkerd \u7684 proxy injector \u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u4e0d\u53ef\u7528\u4e86\uff0c\u5219\u5c31\u65e0\u6cd5\u521b\u5efa Pod \u4e86 \u3002 \u6bd4\u5982 kube-system \u547d\u540d\u7a7a\u95f4\u5c31\u4f1a\u51fa\u73b0\u95ee\u9898\uff0c \u56e0\u6b64\u4f7f\u7528 HA \u6a21\u5f0f\u9700\u8981\u5c06\u6807\u7b7e config.linkerd.io/admission-webhooks: disabled \u6dfb\u52a0\u5230 kube-system \u547d\u540d\u7a7a\u95f4\u4e2d \uff0c\u4ee5\u5141\u8bb8\u521b\u5efa Kubernetes \u7ec4\u4ef6\uff0c\u5373\u4f7f Linkerd \u51fa\u73b0\u67d0\u79cd\u95ee\u9898\uff0c\u4f46\u4e5f\u4e0d\u7528\u592a\u62c5\u5fc3\uff0c\u5f53\u5728 HA \u6a21\u5f0f\u4e0b\u8fd0\u884c\u65f6\uff0c\u5f53\u6807\u7b7e\u4e0d\u5728 kube-system \u547d\u540d\u7a7a\u95f4\u4e0a\u65f6\uff0c linkerd check \u547d\u4ee4\u4e5f\u4f1a\u6253\u5370\u51fa\u4e00\u6761\u544a\u8b66\u4fe1\u606f\u3002 Helm Chart \u4e00\u822c\u6765\u8bf4\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4e0d\u63a8\u8350\u4f7f\u7528 Linkerd CLI \u5de5\u5177\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u800c\u66f4\u63a8\u8350\u4f7f\u7528 Helm \u4e4b\u7c7b\u7684\u5de5\u5177\u8fdb\u884c\u5b89\u88c5\u3002 Linkerd \u4e3a\u666e\u901a\u6a21\u5f0f\u548c HA \u6a21\u5f0f\u63d0\u4f9b\u4e86 Helm Chart\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e2a\u540d\u4e3a values-ha.yaml \u7684\u6a21\u677f\uff0c\u53ef\u4ee5\u5c06\u5176\u7528\u4f5c\u5411\u96c6\u7fa4\u90e8\u7f72\u9ad8\u53ef\u7528\u6027\u7684\u57fa\u7840\uff0cHelm \u5bf9\u4e8e\u5728\u65b0\u521b\u5efa\u7684\u96c6\u7fa4\u4e0a\u81ea\u52a8\u914d\u7f6e Linkerd \u7279\u522b\u6709\u7528 \u3002 \u9700\u8981\u6ce8\u610f\u7684\u4e00\u70b9\u662f\uff0cHelm \u7684\u5b89\u88c5\u8fc7\u7a0b\u4e0d\u4f1a\u50cf linkerd install \u547d\u4ee4\u90a3\u6837\u4e3a\u4f60\u751f\u6210\u8bc1\u4e66\uff0c\u6240\u4ee5\u9700\u8981\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u81ea\u5df1\u7684\u8bc1\u4e66\uff0c\u524d\u9762 mTLS \u7ae0\u8282\u5df2\u7ecf\u4ecb\u7ecd\u8fc7 \u3002 \u65e0\u8bba\u4f60\u662f\u5426\u4f7f\u7528 Helm \u5b89\u88c5\uff0c\u662f\u5426\u5728 HA \u6a21\u5f0f\u4e0b\u5b89\u88c5\uff0c\u5bf9\u4e8e\u751f\u4ea7\u7cfb\u7edf\u6765\u8bf4\uff0c\u4f60\u90fd\u5e94\u8be5\u81ea\u5df1\u751f\u6210\u6839\u8bc1\u4e66\u548c\u7b7e\u53d1\u8005\u8bc1\u4e66\u3002\u521b\u5efa\u4f60\u81ea\u5df1\u7684\u4fe1\u4efb\u951a\uff0c\u53ef\u4ee5\u8ba9\u4f60\u907f\u514d\u624b\u52a8\u8f6e\u8f6c\u7684\u9ebb\u70e6 \uff08\u6211\u4eec\u5efa\u8bae\u5c06\u8fc7\u671f\u65f6\u95f4\u8bbe\u7f6e\u4e3a 10 \u5e74\uff0c\u800c\u4e0d\u662f\u9ed8\u8ba4\u7684 1 \u5e74\uff09\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u672a\u6765\u7684\u96c6\u7fa4\u751f\u6210\u7b7e\u53d1\u8005\u8bc1\u4e66\uff0c\u8bf7\u786e\u4fdd\u5c06\u79c1\u94a5\u5b58\u653e\u5728\u4e00\u4e2a\u5b89\u5168\u7684\u5730\u65b9! Prometheus \u6307\u6807 Linkerd \u63a7\u5236\u5e73\u9762\u5305\u542b\u4e00\u4e2a Prometheus \u7684\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u4e2d\u7684\u6570\u636e\u88ab\u7528\u6765\u4e3a Linkerd \u4eea\u8868\u677f\u4ee5\u53ca linkerd viz stat \u7b49\u547d\u4ee4\u7684\u8f93\u51fa\u63d0\u4f9b\u652f\u6301\u3002 Linkerd \u63a7\u5236\u5e73\u9762\u5305\u542b\u4e00\u4e2a Prometheus \u7684\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u4e2d\u7684\u6570\u636e\u88ab\u7528\u6765\u4e3a Linkerd \u4eea\u8868\u677f\u4ee5\u53ca linkerd viz stat \u7b49\u547d\u4ee4\u7684\u8f93\u51fa\u63d0\u4f9b\u652f\u6301 \u3002 \u8be5\u5b9e\u4f8b\u9ed8\u8ba4\u53ea\u4fdd\u7559\u6700\u8fd1 6 \u5c0f\u65f6\u7684\u6307\u6807\u6570\u636e\uff0c\u751f\u4ea7\u73af\u5883\u5f80\u5f80\u9700\u8981\u5728\u66f4\u957f\u7684\u65f6\u95f4\u5185\u8bbf\u95ee\u6307\u6807\uff0c\u6bd4\u5982 1 \u5468\u30011 \u4e2a\u6708\u751a\u81f3 1 \u5e74\u3002\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u91cd\u65b0\u914d\u7f6e\u4e0b\u8be5 Prometheus \u5b9e\u4f8b\uff0c\u63d0\u9ad8\u4e0b\u6570\u636e\u4fdd\u7559\u65f6\u957f\uff0c\u4f46\u662f\u663e\u7136\u8fd9\u662f\u4e0d\u88ab\u63a8\u8350\u7684\u4e00\u79cd\u65b9\u6cd5\uff0c\u6700\u4f73\u7684\u505a\u6cd5\u662f\u5c06\u6307\u6807\u4ece Linkerd \u7684\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\u7684 Prometheus \u8f93\u51fa\u5230\u4e00\u4e2a\u4e13\u95e8\u7684\u8fdc\u7a0b\u5b58\u50a8\u4e2d\u53bb\uff0c\u6bd4\u5982 Cortex\u3001Thanos \u6216\u8005 Victoriametrics\uff0c\u6839\u636e\u524d\u9762\u6211\u4eec\u7684\u5bf9 Prometheus \u7684\u5b66\u4e60\u66f4\u52a0\u63a8\u8350\u4f7f\u7528 Victoriametrics\u3002 \u5982\u679c\u4f60\u73b0\u5728\u5df2\u7ecf\u6709\u4e00\u4e2a\u53ef\u7528\u7684 Prometheus \u96c6\u7fa4\u4e86\uff0c\u90a3\u4e48\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u914d\u7f6e\u8ba9 Linkerd \u6765\u4f7f\u7528\u5916\u90e8\u7684 Prometheus \u5b9e\u4f8b\uff0c\u540c\u6837\u53ef\u4ee5\u83b7\u53d6 Linkerd \u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u548c\u4ee3\u7406\u7684\u76f8\u5173\u6307\u6807 \u3002 \u914d\u7f6e\u5916\u90e8 Prometheus \u5982\u679c\u8981\u4f7f\u7528\u5916\u90e8\u7684 Prometheus \u5219\u9700\u8981\u5728\u5916\u90e8 Prometheus \u4e2d\u6dfb\u52a0\u5982\u4e0b\u6293\u53d6\u914d\u7f6e\uff1a - job_name: \"grafana\" kubernetes_sd_configs: - role: pod namespaces: names: [\"linkerd-viz\"] relabel_configs: - source_labels: - __meta_kubernetes_pod_container_name action: keep regex: ^grafana$ - job_name: \"linkerd-controller\" relabel_configs: - source_labels: - __meta_kubernetes_pod_container_port_name action: keep regex: admin-http - source_labels: [__meta_kubernetes_pod_container_name] action: replace target_label: component kubernetes_sd_configs: - role: pod namespaces: names: - \"linkerd\" - \"linkerd-viz\" - job_name: \"linkerd-service-mirror\" kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: - __meta_kubernetes_pod_label_linkerd_io_control_plane_component - __meta_kubernetes_pod_container_port_name action: keep regex: linkerd-service-mirror;admin-http$ - source_labels: [__meta_kubernetes_pod_container_name] action: replace target_label: component - job_name: \"linkerd-proxy\" kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: - __meta_kubernetes_pod_container_name - __meta_kubernetes_pod_container_port_name - __meta_kubernetes_pod_label_linkerd_io_control_plane_ns action: keep regex: ^linkerd-proxy;linkerd-admin;linkerd$ - source_labels: [__meta_kubernetes_namespace] action: replace target_label: namespace - source_labels: [__meta_kubernetes_pod_name] action: replace target_label: pod # special case k8s' \"job\" label, to not interfere with prometheus' \"job\" # label # __meta_kubernetes_pod_label_linkerd_io_proxy_job=foo => # k8s_job=foo - source_labels: [__meta_kubernetes_pod_label_linkerd_io_proxy_job] action: replace target_label: k8s_job # drop __meta_kubernetes_pod_label_linkerd_io_proxy_job - action: labeldrop regex: __meta_kubernetes_pod_label_linkerd_io_proxy_job # __meta_kubernetes_pod_label_linkerd_io_proxy_deployment=foo => # deployment=foo - action: labelmap regex: __meta_kubernetes_pod_label_linkerd_io_proxy_(.+) # drop all labels that we just made copies of in the previous labelmap - action: labeldrop regex: __meta_kubernetes_pod_label_linkerd_io_proxy_(.+) # __meta_kubernetes_pod_label_linkerd_io_foo=bar => # foo=bar - action: labelmap regex: __meta_kubernetes_pod_label_linkerd_io_(.+) # Copy all pod labels to tmp labels - action: labelmap regex: __meta_kubernetes_pod_label_(.+) replacement: __tmp_pod_label_$1 # Take `linkerd_io_` prefixed labels and copy them without the prefix - action: labelmap regex: __tmp_pod_label_linkerd_io_(.+) replacement: __tmp_pod_label_$1 # Drop the `linkerd_io_` originals - action: labeldrop regex: __tmp_pod_label_linkerd_io_(.+) # Copy tmp labels into real labels - action: labelmap regex: __tmp_pod_label_(.+) \u4e0a\u9762\u7684\u6293\u53d6\u914d\u7f6e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 kubectl get cm -n linkerd-viz prometheus-config -o yaml \u83b7\u53d6\u5b8c\u6574\u7684\u914d\u7f6e\uff0c\u6293\u53d6\u914d\u7f6e\u66f4\u65b0\u5b8c\u6210\u540e\u786e\u4fdd Prometheus \u53ef\u4ee5\u6293\u53d6\u5230\u76f8\u5173\u6307\u6807\u6570\u636e\u3002 Linkerd \u7684 viz \u6269\u5c55\u7ec4\u4ef6\u4f9d\u8d56\u4e8e Prometheus \u5b9e\u4f8b\u6765\u4e3a\u4eea\u8868\u677f\u548c CLI \u63d0\u4f9b\u6570\u636e\u3002 \u5b89\u88c5\u7684\u65f6\u5019\u6709\u4e00\u4e2a prometheusUrl \u5b57\u6bb5\u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u5916\u90e8 Prometheus \u7684\u5730\u5740\uff0c\u6240\u6709\u8fd9\u4e9b\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u901a\u8fc7\u8be5\u53c2\u6570\u914d\u7f6e\u5230\u5916\u90e8 Prometheus URL\u3002 \u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u4f7f\u7528\u5916\u90e8 Prometheus \u5e76\u914d\u7f6e prometheusUrl \u5b57\u6bb5\u65f6\uff0cLinkerd \u7684 Prometheus \u4ecd\u7136\u4f1a\u5305\u542b\u5728\u5b89\u88c5\u4e2d\u3002\u5982\u679c\u60a8\u60f3\u7981\u7528\u5b83\uff0c\u8bf7\u52a1\u5fc5\u540c\u65f6\u5305\u542b\u4ee5\u4e0b\u914d\u7f6e\uff1a prometheus: enabled: false \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5728 kube-mon \u547d\u540d\u7a7a\u95f4\u4e2d\u6709\u4e00\u4e2a\u53ef\u7528\u7684 Prometheus \u5b9e\u4f8b\uff0c\u5219\u53ef\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u8fdb\u884c\u66ff\u6362\uff1a $ kubectl get svc prometheus -n kube-mon NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE prometheus NodePort 10.100.236.253 <none> 9090:31561/TCP 60d $ linkerd viz install --set prometheusUrl=http://prometheus.kube-mon.svc.cluster.local:9090,prometheus.enabled=false | kubectl apply -f - \u5982\u679c\u4f7f\u7528\u7684\u662f Helm \u8fdb\u884c\u5b89\u88c5\u7684\u5219\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 values \u6587\u4ef6\u6765\u8fdb\u884c\u914d\u7f6e\u3002\u66f4\u65b0\u540e\u91cd\u65b0\u67e5\u770b Linkerd \u7684 Dashboard \u4f9d\u65e7\u53ef\u4ee5\u770b\u5230\u5e94\u7528\u7684\u76f8\u5173\u6307\u6807\u6570\u636e\u3002 \u5305\u62ec Grafana \u7684\u56fe\u8868\u4e5f\u662f\u6b63\u5e38\u663e\u793a\u7684\u3002 \u8fd9\u6837\u5bf9\u4e8e Prometheus \u6307\u6807\u6570\u636e\u4fdd\u5b58\u591a\u957f\u65f6\u95f4\u6216\u8005\u5982\u4f55\u4fdd\u5b58\u5c31\u662f\u4f9d\u9760\u6211\u4eec\u7684\u5916\u90e8 Prometheus \u81ea\u8eab\u53bb\u5b9e\u73b0\u4e86\uff0c\u8fd9\u5f53\u7136\u964d\u4f4e\u4e86 Linkerd \u81ea\u8eab\u7684\u590d\u6742\u6027\u3002 \u591a\u96c6\u7fa4\u901a\u4fe1 inkerd \u652f\u6301\u591a\u96c6\u7fa4\u901a\u4fe1\uff0c\u8fd9\u4e00\u529f\u80fd\u5141\u8bb8\u670d\u52a1\u5728 Kubernetes \u96c6\u7fa4\u95f4\u900f\u660e\u5730\u8fdb\u884c\u901a\u4fe1\u3002\u542f\u7528\u8be5\u529f\u80fd\u540e\uff0c\u5982\u679c\u670d\u52a1 A \u4e0e\u670d\u52a1 B \u901a\u4fe1\uff0c\u5b83\u4e0d\u9700\u8981\u77e5\u9053 B \u662f\u5728\u540c\u4e00\u4e2a\u96c6\u7fa4\u8fd8\u662f\u4e0d\u540c\u7684\u96c6\u7fa4\u4e0a\u8fd0\u884c\uff0c\u662f\u5728\u540c\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3\u8fd8\u662f\u5728\u4e92\u8054\u7f51\u4e0a\u3002\u540c\u6837\u7684 mTLS\u3001\u6307\u6807\u548c\u53ef\u9760\u6027\u529f\u80fd\u5728\u96c6\u7fa4\u5185\u548c\u8de8\u96c6\u7fa4\u7684\u901a\u4fe1\u4e2d\u90fd\u662f\u7edf\u4e00\u5e94\u7528\u7684\u3002\u4e8b\u5b9e\u4e0a\uff0c\u5f53\u4e0e\u6d41\u91cf\u5206\u5272\u76f8\u7ed3\u5408\u65f6\uff0c\u670d\u52a1 B \u53ef\u4ee5\u4ece\u672c\u5730\u96c6\u7fa4\u8fc1\u79fb\u6216\u6545\u969c\u8f6c\u79fb\u5230\u8fdc\u7a0b\u96c6\u7fa4\uff0c\u6216\u8de8\u8d8a\u72ec\u7acb\u7684\u8fdc\u7a0b\u96c6\u7fa4\u3002 Linkerd \u591a\u96c6\u7fa4\u7ec4\u4ef6\u4f7f\u7528 linkerd multi-cluster install \u547d\u4ee4\u4e0e\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u5206\u5f00\u5b89\u88c5 \uff0c \u6b64\u547d\u4ee4\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a linkerd-multi-cluster \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u4e2a\u7ec4\u4ef6\uff1a service-mirror \u548c linkerd-gateway \uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u7528\u4e8e\u786e\u4fdd\u4e24\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u8fde\u63a5\u7684\u5065\u5eb7\uff0c\u5e76\u4e3a\u8fdc\u7a0b\u6216\u76ee\u6807\u96c6\u7fa4\u4e0a\u5b58\u5728\u7684\u670d\u52a1\u8def\u7531\u6d41\u91cf \u3002 \u6bcf\u4e2a\u53c2\u4e0e\u7684\u96c6\u7fa4\u90fd\u5fc5\u987b\u5728\u5b89\u88c5\u4e86\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u60c5\u51b5\u4e0b\u8fd0\u884c Linkerd \u63a7\u5236\u5e73\u9762\u3002\u8fd9\u5c31\u6d88\u9664\u4e86\u4efb\u4f55\u4e00\u4e2a\u96c6\u7fa4\u7684\u5355\u70b9\u6545\u969c\uff1a \u5982\u679c\u4e00\u4e2a\u96c6\u7fa4\u88ab\u79fb\u9664\u3001\u5d29\u6e83\u6216\u53d8\u5f97\u4e0d\u53ef\u7528\uff0c\u5176\u4f59\u7684\u96c6\u7fa4\u548c\u63a7\u5236\u5e73\u9762\u5c06\u7ee7\u7eed\u8fd0\u4f5c \u3002 \u591a\u96c6\u7fa4\u8bbe\u7f6e\u4e2d\u6700\u56f0\u96be\u7684\u90e8\u5206\u662f mTLS \u57fa\u7840\u8bbe\u65bd\uff1a\u6bcf\u4e2a\u96c6\u7fa4\u4e0a\u7684\u9881\u53d1\u8005\u8bc1\u4e66\u5fc5\u987b\u7531\u540c\u4e00\u4e2a\u4fe1\u4efb\u6839\u7b7e\u7f72\u3002\u8fd9\u610f\u5473\u7740\u7b80\u5355\u5730\u8fd0\u884c linkerd install \u8fdb\u884c\u5b89\u88c5\u4f1a\u6709\u95ee\u9898\uff0c\u9700\u8981\u6307\u5b9a\u540c\u4e00\u4e2a\u6839\u8bc1\u4e66\u3002 \u5176\u4ed6 \u4e0a\u9762\u662f\u5c06 Linkerd \u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e4b\u524d\u9700\u8981\u8003\u8651\u7684\u4e00\u4e9b\u91cd\u8981\u4e8b\u9879\uff0c\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u4e8b\u9879\u4e5f\u662f\u503c\u5f97\u6211\u4eec\u5173\u6ce8\u7684\uff1a \u914d\u7f6e\u8d44\u6e90 \uff1a\u5f53\u4f60\u5728 HA \u6a21\u5f0f\u4e0b\u90e8\u7f72 Linkerd \u65f6\uff0cLinkerd \u4e3a\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u8bbe\u7f6e CPU \u548c\u5185\u5b58\u8d44\u6e90\u8bf7\u6c42\u548c\u9650\u5236\u3002\u8fd9\u4e9b\u9650\u5236\u662f\u4e00\u4e2a\u76f8\u5bf9\u5408\u7406\u7684\u503c\uff0c\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u5e94\u7528\u90fd\u662f\u4e00\u6837\u7684\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u8c03\u6574\u8fd9\u4e9b\u8d44\u6e90\u914d\u7f6e\u4ee5\u9002\u5e94\u4f60\u7684\u9700\u6c42\u3002\u5bf9\u4e8e\u9ad8\u6d41\u91cf\u7684\u670d\u52a1\uff08\u6bcf\u4e2a\u5b9e\u4f8b\u6bcf\u79d2>1000\u4e2a\u8bf7\u6c42\uff09\uff0c\u6211\u4eec\u53ef\u80fd\u8fd8\u9700\u8981\u8c03\u6574\u4ee3\u7406\u8d44\u6e90\uff0c\u4e5f\u53ef\u4ee5\u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\u6307\u5b9a config.linkerd.io/proxy-cpu-limit \u6ce8\u89e3\u6765\u914d\u7f6e\u4ee3\u7406\u7684\u5e76\u53d1\u3002 \u68c0\u67e5\u65f6\u949f\u504f\u5dee \uff1a\u786e\u4fdd\u96c6\u7fa4\u4e2d\u7684\u8282\u70b9\u4fdd\u6301\u540c\u6b65\u5f88\u91cd\u8981\uff0c\u4f8b\u5982\u901a\u8fc7\u4f7f\u7528 NTP\uff0c\u8282\u70b9\u4e4b\u95f4\u7684\u5927\u65f6\u949f\u504f\u5dee\u53ef\u80fd\u4f1a\u7834\u574f Linkerd \u4ee3\u7406\u9a8c\u8bc1\u5b83\u4eec\u7528\u4e8e mTLS \u7684\u8bc1\u4e66\u7684\u80fd\u529b\uff08\u5728\u89e3\u51b3\u96c6\u7fa4\u4e2d\u7684\u95ee\u9898\u65f6\uff0c\u5927\u7684\u65f6\u949f\u504f\u5dee\u53ef\u80fd\u4f1a\u4f7f\u8de8\u8282\u70b9\u8bfb\u53d6\u65e5\u5fd7\u6587\u4ef6\u53d8\u5f97\u56f0\u96be\uff01\uff09\u3002 \u5904\u7406 NET_ADMIN \uff1aLinkerd \u7684 proxy-init \u5bb9\u5668\u5728\u6ce8\u5165 Pod \u65f6\u8fd0\u884c\uff0c\u5e76\u8d1f\u8d23\u914d\u7f6e iptables \u89c4\u5219\uff0c\u4ee5\u4fbf\u6240\u6709\u8fdb\u51fa\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684 TCP \u6d41\u91cf\u90fd\u81ea\u52a8\u901a\u8fc7\u4ee3\u7406\u5bb9\u5668\u8def\u7531\u3002\u8fd9\u9700\u8981 Kubernetes \u7684 NET_ADMIN \u8fd9\u4e2a Linux Capability\uff0c\u8fd9\u610f\u5473\u7740\u4efb\u4f55\u5411\u96c6\u7fa4\u6dfb\u52a0\u652f\u6301 Linkerd \u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7cfb\u7edf\u90fd\u5fc5\u987b\u88ab\u6388\u4e88\u8be5\u80fd\u529b\u3002\u5982\u679c\u51fa\u4e8e\u5b89\u5168\u539f\u56e0\u4e0d\u5e0c\u671b\u8fd9\u6837\u505a\uff0c\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528 Linkerd CNI \u63d2\u4ef6\u5728\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u8005\u6743\u9650\u8303\u56f4\u4e4b\u5916\u6267\u884c\u6b64\u64cd\u4f5c\u3002 linkerd viz tap \u6743\u9650 \uff1a\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u8fc7 tap \u8fd9\u4e2a\u5f3a\u5927\u7684\u547d\u4ee4\uff0c\u4f46\u662f\u8fd9\u4e2a\u529f\u80fd\u4e5f\u4f1a\u9644\u5e26\u5f88\u591a\u98ce\u9669\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u547d\u4ee4\u53ef\u80fd\u4f1a\u5c06\u6f5c\u5728\u7684\u654f\u611f\u4fe1\u606f\u66b4\u9732\u7ed9\u7528\u6237\uff0c\u4e0d\u8fc7 Linkerd \u5141\u8bb8\u6211\u4eec\u4f7f\u7528 Kubernetes RBAC \u9650\u5236\u6765\u63a7\u5236\u8c01\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8f93\u51fa\u3002 \u4f7f\u7528 Ingress \uff1a\u4e0e\u5176\u4ed6\u4e00\u4e9b\u670d\u52a1\u7f51\u683c\u4e0d\u540c\uff0cLinkerd \u4e0d\u63d0\u4f9b\u81ea\u5df1\u7684 Ingress \u63a7\u5236\u5668\u3002\u76f8\u53cd\uff0c\u4f60\u53ef\u4ee5\u5c06 Linkerd \u4e0e\u5176\u4ed6\u53ef\u7528\u7684 Kubernetes Ingress \u63a7\u5236\u5668\u914d\u5408\u4f7f\u7528\uff0c\u5f53\u8fd9\u6837\u505a\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5efa\u8bae\u5c06 Ingress \u63a7\u5236\u5668\u4e0e Linkerd \u4ee3\u7406\u6ce8\u5165\uff0c\u8fd9\u5c06\u5141\u8bb8 Linkerd \u7684 mTLS \u548c\u53ef\u89c2\u5bdf\u6027\u4ece\u8bf7\u6c42\u8fdb\u5165\u96c6\u7fa4\u7684\u90a3\u4e00\u523b\u8d77\u5c31\u5df2\u7ecf\u53ef\u7528\u4e86\u3002 \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u57fa\u672c\u4e0a\u4e86\u89e3\u4e86\u5982\u4f55\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528 Linkerd \u4e86\u3002\u4f46\u4e5f\u8981\u6ce8\u610f\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u7684\u8fd9\u4e9b\u4e8b\u9879\u5e76\u4e0d\u662f\u6240\u6709\u7684\uff0c\u5f3a\u70c8\u5efa\u8bae\u5728\u5c06 Linkerd \u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e4b\u524d\u5b8c\u5168\u7406\u89e3\u8fd9\u4e9b\u6982\u5ff5\u5e76\u901a\u8bfb Linkerd \u6587\u6863\u3002","title":"6 \u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528 Linkerd"},{"location":"chap11/6linkered_prod/#6-linkerd","text":"\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u4e00\u76f4\u5728\u4ee5\u6700\u57fa\u672c\u7684\u5f62\u5f0f\u4f7f\u7528 Linkerd\uff0c\u800c\u6ca1\u6709\u5173\u6ce8\u751f\u4ea7\u7ea7\u522b\u7684\u76f8\u5173\u95ee\u9898\u3002\u672c\u8282\u6211\u4eec\u5c06\u4e86\u89e3\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u7684\u4e00\u4e9b\u4e3b\u8981\u6ce8\u610f\u4e8b\u9879\uff0c\u5305\u62ec\u9ad8\u53ef\u7528 (HA) \u6a21\u5f0f\u3001Helm Chart\u3001\u8de8\u96c6\u7fa4\u901a\u4fe1\u548c\u5916\u90e8 Prometheus\u3002","title":"6 \u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528 Linkerd"},{"location":"chap11/6linkered_prod/#_1","text":"\u9ad8\u53ef\u7528 \u63cf\u8ff0\u4e86\u5177\u6709\u5197\u4f59\u67b6\u6784\u7684\u7cfb\u7edf\uff0c\u5982\u679c\u7cfb\u7edf\u7684\u67d0\u4e9b\u90e8\u5206\u51fa\u73b0\u6545\u969c\uff0c\u8be5\u7cfb\u7edf\u5c06\u7ee7\u7eed\u8fd0\u884c\u3002Linkerd \u7684\u9ad8\u53ef\u7528\u6a21\u5f0f\u65e8\u5728\u6d88\u9664\u63a7\u5236\u5e73\u9762\u7684\u5355\u70b9\u6545\u969c\u3002 \u542f\u7528 HA \u6a21\u5f0f\u7684\u4e00\u79cd\u65b9\u6cd5\u662f\u4e3a linkerd install \u6307\u5b9a --ha \u6807\u5fd7 \uff0c\u6b64\u6807\u5fd7\u542f\u7528\u51e0\u79cd\u4e0d\u540c\u7684\u884c\u4e3a\u3002\u5b83\u53ef\u4ee5\u90e8\u7f72\u67d0\u4e9b Linkerd \u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u7684\u591a\u4e2a\u526f\u672c\uff1a Controller Destination Identity Proxy Injector Service Profile Validator \u8bf7\u6ce8\u610f\uff0c\u5176\u4ed6\u7ec4\u4ef6\uff0c\u4f8b\u5982 Grafana\u3001Prometheus\uff0c\u4e0d\u88ab\u770b\u6210\u6838\u5fc3\u7684\u5173\u952e\u7ec4\u4ef6\uff0c\u56e0\u6b64\u4e0d\u4f1a\u914d\u7f6e\u591a\u526f\u672c\uff08\u5982\u679c\u6ca1\u6709\u8fd9\u4e9b\u7ec4\u4ef6\uff0c\u6570\u636e\u5e73\u9762\u4ecd\u7136\u53ef\u4ee5\u7ee7\u7eed\u6b63\u5e38\u8fd0\u884c\uff09\u3002 \u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f HA \u6a21\u5f0f\u6709\u4e00\u4e9b\u7ec6\u5fae\u7684\u533a\u522b\uff0c \u9996\u5148 HA \u6a21\u5f0f\u6539\u53d8\u4e86 proxy injector \u7684\u65b9\u5f0f\uff0c\u5f3a\u5236\u8981\u6c42\u5728\u6709\u9002\u5f53\u6ce8\u89e3\u7684\u60c5\u51b5\u4e0b\u6ce8\u5165\u4ee3\u7406 \u3002 \u8fd9\u662f\u4e3a\u4e86\u786e\u4fdd\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c \u4f7f\u7528 Linkerd \u8fdb\u884c mTLS \u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4f9d\u8d56\u8be5\u4ee3\u7406\uff0c\u5f53\u7136\u5982\u679c Linkerd \u7684 proxy injector \u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u4e0d\u53ef\u7528\u4e86\uff0c\u5219\u5c31\u65e0\u6cd5\u521b\u5efa Pod \u4e86 \u3002 \u6bd4\u5982 kube-system \u547d\u540d\u7a7a\u95f4\u5c31\u4f1a\u51fa\u73b0\u95ee\u9898\uff0c \u56e0\u6b64\u4f7f\u7528 HA \u6a21\u5f0f\u9700\u8981\u5c06\u6807\u7b7e config.linkerd.io/admission-webhooks: disabled \u6dfb\u52a0\u5230 kube-system \u547d\u540d\u7a7a\u95f4\u4e2d \uff0c\u4ee5\u5141\u8bb8\u521b\u5efa Kubernetes \u7ec4\u4ef6\uff0c\u5373\u4f7f Linkerd \u51fa\u73b0\u67d0\u79cd\u95ee\u9898\uff0c\u4f46\u4e5f\u4e0d\u7528\u592a\u62c5\u5fc3\uff0c\u5f53\u5728 HA \u6a21\u5f0f\u4e0b\u8fd0\u884c\u65f6\uff0c\u5f53\u6807\u7b7e\u4e0d\u5728 kube-system \u547d\u540d\u7a7a\u95f4\u4e0a\u65f6\uff0c linkerd check \u547d\u4ee4\u4e5f\u4f1a\u6253\u5370\u51fa\u4e00\u6761\u544a\u8b66\u4fe1\u606f\u3002","title":"\u9ad8\u53ef\u7528"},{"location":"chap11/6linkered_prod/#helm-chart","text":"\u4e00\u822c\u6765\u8bf4\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4e0d\u63a8\u8350\u4f7f\u7528 Linkerd CLI \u5de5\u5177\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u800c\u66f4\u63a8\u8350\u4f7f\u7528 Helm \u4e4b\u7c7b\u7684\u5de5\u5177\u8fdb\u884c\u5b89\u88c5\u3002 Linkerd \u4e3a\u666e\u901a\u6a21\u5f0f\u548c HA \u6a21\u5f0f\u63d0\u4f9b\u4e86 Helm Chart\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e2a\u540d\u4e3a values-ha.yaml \u7684\u6a21\u677f\uff0c\u53ef\u4ee5\u5c06\u5176\u7528\u4f5c\u5411\u96c6\u7fa4\u90e8\u7f72\u9ad8\u53ef\u7528\u6027\u7684\u57fa\u7840\uff0cHelm \u5bf9\u4e8e\u5728\u65b0\u521b\u5efa\u7684\u96c6\u7fa4\u4e0a\u81ea\u52a8\u914d\u7f6e Linkerd \u7279\u522b\u6709\u7528 \u3002 \u9700\u8981\u6ce8\u610f\u7684\u4e00\u70b9\u662f\uff0cHelm \u7684\u5b89\u88c5\u8fc7\u7a0b\u4e0d\u4f1a\u50cf linkerd install \u547d\u4ee4\u90a3\u6837\u4e3a\u4f60\u751f\u6210\u8bc1\u4e66\uff0c\u6240\u4ee5\u9700\u8981\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u81ea\u5df1\u7684\u8bc1\u4e66\uff0c\u524d\u9762 mTLS \u7ae0\u8282\u5df2\u7ecf\u4ecb\u7ecd\u8fc7 \u3002 \u65e0\u8bba\u4f60\u662f\u5426\u4f7f\u7528 Helm \u5b89\u88c5\uff0c\u662f\u5426\u5728 HA \u6a21\u5f0f\u4e0b\u5b89\u88c5\uff0c\u5bf9\u4e8e\u751f\u4ea7\u7cfb\u7edf\u6765\u8bf4\uff0c\u4f60\u90fd\u5e94\u8be5\u81ea\u5df1\u751f\u6210\u6839\u8bc1\u4e66\u548c\u7b7e\u53d1\u8005\u8bc1\u4e66\u3002\u521b\u5efa\u4f60\u81ea\u5df1\u7684\u4fe1\u4efb\u951a\uff0c\u53ef\u4ee5\u8ba9\u4f60\u907f\u514d\u624b\u52a8\u8f6e\u8f6c\u7684\u9ebb\u70e6 \uff08\u6211\u4eec\u5efa\u8bae\u5c06\u8fc7\u671f\u65f6\u95f4\u8bbe\u7f6e\u4e3a 10 \u5e74\uff0c\u800c\u4e0d\u662f\u9ed8\u8ba4\u7684 1 \u5e74\uff09\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u672a\u6765\u7684\u96c6\u7fa4\u751f\u6210\u7b7e\u53d1\u8005\u8bc1\u4e66\uff0c\u8bf7\u786e\u4fdd\u5c06\u79c1\u94a5\u5b58\u653e\u5728\u4e00\u4e2a\u5b89\u5168\u7684\u5730\u65b9!","title":"Helm Chart"},{"location":"chap11/6linkered_prod/#prometheus","text":"Linkerd \u63a7\u5236\u5e73\u9762\u5305\u542b\u4e00\u4e2a Prometheus \u7684\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u4e2d\u7684\u6570\u636e\u88ab\u7528\u6765\u4e3a Linkerd \u4eea\u8868\u677f\u4ee5\u53ca linkerd viz stat \u7b49\u547d\u4ee4\u7684\u8f93\u51fa\u63d0\u4f9b\u652f\u6301\u3002 Linkerd \u63a7\u5236\u5e73\u9762\u5305\u542b\u4e00\u4e2a Prometheus \u7684\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u4e2d\u7684\u6570\u636e\u88ab\u7528\u6765\u4e3a Linkerd \u4eea\u8868\u677f\u4ee5\u53ca linkerd viz stat \u7b49\u547d\u4ee4\u7684\u8f93\u51fa\u63d0\u4f9b\u652f\u6301 \u3002 \u8be5\u5b9e\u4f8b\u9ed8\u8ba4\u53ea\u4fdd\u7559\u6700\u8fd1 6 \u5c0f\u65f6\u7684\u6307\u6807\u6570\u636e\uff0c\u751f\u4ea7\u73af\u5883\u5f80\u5f80\u9700\u8981\u5728\u66f4\u957f\u7684\u65f6\u95f4\u5185\u8bbf\u95ee\u6307\u6807\uff0c\u6bd4\u5982 1 \u5468\u30011 \u4e2a\u6708\u751a\u81f3 1 \u5e74\u3002\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u91cd\u65b0\u914d\u7f6e\u4e0b\u8be5 Prometheus \u5b9e\u4f8b\uff0c\u63d0\u9ad8\u4e0b\u6570\u636e\u4fdd\u7559\u65f6\u957f\uff0c\u4f46\u662f\u663e\u7136\u8fd9\u662f\u4e0d\u88ab\u63a8\u8350\u7684\u4e00\u79cd\u65b9\u6cd5\uff0c\u6700\u4f73\u7684\u505a\u6cd5\u662f\u5c06\u6307\u6807\u4ece Linkerd \u7684\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\u7684 Prometheus \u8f93\u51fa\u5230\u4e00\u4e2a\u4e13\u95e8\u7684\u8fdc\u7a0b\u5b58\u50a8\u4e2d\u53bb\uff0c\u6bd4\u5982 Cortex\u3001Thanos \u6216\u8005 Victoriametrics\uff0c\u6839\u636e\u524d\u9762\u6211\u4eec\u7684\u5bf9 Prometheus \u7684\u5b66\u4e60\u66f4\u52a0\u63a8\u8350\u4f7f\u7528 Victoriametrics\u3002 \u5982\u679c\u4f60\u73b0\u5728\u5df2\u7ecf\u6709\u4e00\u4e2a\u53ef\u7528\u7684 Prometheus \u96c6\u7fa4\u4e86\uff0c\u90a3\u4e48\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u914d\u7f6e\u8ba9 Linkerd \u6765\u4f7f\u7528\u5916\u90e8\u7684 Prometheus \u5b9e\u4f8b\uff0c\u540c\u6837\u53ef\u4ee5\u83b7\u53d6 Linkerd \u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u548c\u4ee3\u7406\u7684\u76f8\u5173\u6307\u6807 \u3002","title":"Prometheus \u6307\u6807"},{"location":"chap11/6linkered_prod/#prometheus_1","text":"\u5982\u679c\u8981\u4f7f\u7528\u5916\u90e8\u7684 Prometheus \u5219\u9700\u8981\u5728\u5916\u90e8 Prometheus \u4e2d\u6dfb\u52a0\u5982\u4e0b\u6293\u53d6\u914d\u7f6e\uff1a - job_name: \"grafana\" kubernetes_sd_configs: - role: pod namespaces: names: [\"linkerd-viz\"] relabel_configs: - source_labels: - __meta_kubernetes_pod_container_name action: keep regex: ^grafana$ - job_name: \"linkerd-controller\" relabel_configs: - source_labels: - __meta_kubernetes_pod_container_port_name action: keep regex: admin-http - source_labels: [__meta_kubernetes_pod_container_name] action: replace target_label: component kubernetes_sd_configs: - role: pod namespaces: names: - \"linkerd\" - \"linkerd-viz\" - job_name: \"linkerd-service-mirror\" kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: - __meta_kubernetes_pod_label_linkerd_io_control_plane_component - __meta_kubernetes_pod_container_port_name action: keep regex: linkerd-service-mirror;admin-http$ - source_labels: [__meta_kubernetes_pod_container_name] action: replace target_label: component - job_name: \"linkerd-proxy\" kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: - __meta_kubernetes_pod_container_name - __meta_kubernetes_pod_container_port_name - __meta_kubernetes_pod_label_linkerd_io_control_plane_ns action: keep regex: ^linkerd-proxy;linkerd-admin;linkerd$ - source_labels: [__meta_kubernetes_namespace] action: replace target_label: namespace - source_labels: [__meta_kubernetes_pod_name] action: replace target_label: pod # special case k8s' \"job\" label, to not interfere with prometheus' \"job\" # label # __meta_kubernetes_pod_label_linkerd_io_proxy_job=foo => # k8s_job=foo - source_labels: [__meta_kubernetes_pod_label_linkerd_io_proxy_job] action: replace target_label: k8s_job # drop __meta_kubernetes_pod_label_linkerd_io_proxy_job - action: labeldrop regex: __meta_kubernetes_pod_label_linkerd_io_proxy_job # __meta_kubernetes_pod_label_linkerd_io_proxy_deployment=foo => # deployment=foo - action: labelmap regex: __meta_kubernetes_pod_label_linkerd_io_proxy_(.+) # drop all labels that we just made copies of in the previous labelmap - action: labeldrop regex: __meta_kubernetes_pod_label_linkerd_io_proxy_(.+) # __meta_kubernetes_pod_label_linkerd_io_foo=bar => # foo=bar - action: labelmap regex: __meta_kubernetes_pod_label_linkerd_io_(.+) # Copy all pod labels to tmp labels - action: labelmap regex: __meta_kubernetes_pod_label_(.+) replacement: __tmp_pod_label_$1 # Take `linkerd_io_` prefixed labels and copy them without the prefix - action: labelmap regex: __tmp_pod_label_linkerd_io_(.+) replacement: __tmp_pod_label_$1 # Drop the `linkerd_io_` originals - action: labeldrop regex: __tmp_pod_label_linkerd_io_(.+) # Copy tmp labels into real labels - action: labelmap regex: __tmp_pod_label_(.+) \u4e0a\u9762\u7684\u6293\u53d6\u914d\u7f6e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 kubectl get cm -n linkerd-viz prometheus-config -o yaml \u83b7\u53d6\u5b8c\u6574\u7684\u914d\u7f6e\uff0c\u6293\u53d6\u914d\u7f6e\u66f4\u65b0\u5b8c\u6210\u540e\u786e\u4fdd Prometheus \u53ef\u4ee5\u6293\u53d6\u5230\u76f8\u5173\u6307\u6807\u6570\u636e\u3002 Linkerd \u7684 viz \u6269\u5c55\u7ec4\u4ef6\u4f9d\u8d56\u4e8e Prometheus \u5b9e\u4f8b\u6765\u4e3a\u4eea\u8868\u677f\u548c CLI \u63d0\u4f9b\u6570\u636e\u3002 \u5b89\u88c5\u7684\u65f6\u5019\u6709\u4e00\u4e2a prometheusUrl \u5b57\u6bb5\u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u5916\u90e8 Prometheus \u7684\u5730\u5740\uff0c\u6240\u6709\u8fd9\u4e9b\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u901a\u8fc7\u8be5\u53c2\u6570\u914d\u7f6e\u5230\u5916\u90e8 Prometheus URL\u3002 \u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u4f7f\u7528\u5916\u90e8 Prometheus \u5e76\u914d\u7f6e prometheusUrl \u5b57\u6bb5\u65f6\uff0cLinkerd \u7684 Prometheus \u4ecd\u7136\u4f1a\u5305\u542b\u5728\u5b89\u88c5\u4e2d\u3002\u5982\u679c\u60a8\u60f3\u7981\u7528\u5b83\uff0c\u8bf7\u52a1\u5fc5\u540c\u65f6\u5305\u542b\u4ee5\u4e0b\u914d\u7f6e\uff1a prometheus: enabled: false \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5728 kube-mon \u547d\u540d\u7a7a\u95f4\u4e2d\u6709\u4e00\u4e2a\u53ef\u7528\u7684 Prometheus \u5b9e\u4f8b\uff0c\u5219\u53ef\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u8fdb\u884c\u66ff\u6362\uff1a $ kubectl get svc prometheus -n kube-mon NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE prometheus NodePort 10.100.236.253 <none> 9090:31561/TCP 60d $ linkerd viz install --set prometheusUrl=http://prometheus.kube-mon.svc.cluster.local:9090,prometheus.enabled=false | kubectl apply -f - \u5982\u679c\u4f7f\u7528\u7684\u662f Helm \u8fdb\u884c\u5b89\u88c5\u7684\u5219\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 values \u6587\u4ef6\u6765\u8fdb\u884c\u914d\u7f6e\u3002\u66f4\u65b0\u540e\u91cd\u65b0\u67e5\u770b Linkerd \u7684 Dashboard \u4f9d\u65e7\u53ef\u4ee5\u770b\u5230\u5e94\u7528\u7684\u76f8\u5173\u6307\u6807\u6570\u636e\u3002 \u5305\u62ec Grafana \u7684\u56fe\u8868\u4e5f\u662f\u6b63\u5e38\u663e\u793a\u7684\u3002 \u8fd9\u6837\u5bf9\u4e8e Prometheus \u6307\u6807\u6570\u636e\u4fdd\u5b58\u591a\u957f\u65f6\u95f4\u6216\u8005\u5982\u4f55\u4fdd\u5b58\u5c31\u662f\u4f9d\u9760\u6211\u4eec\u7684\u5916\u90e8 Prometheus \u81ea\u8eab\u53bb\u5b9e\u73b0\u4e86\uff0c\u8fd9\u5f53\u7136\u964d\u4f4e\u4e86 Linkerd \u81ea\u8eab\u7684\u590d\u6742\u6027\u3002","title":"\u914d\u7f6e\u5916\u90e8 Prometheus"},{"location":"chap11/6linkered_prod/#_2","text":"inkerd \u652f\u6301\u591a\u96c6\u7fa4\u901a\u4fe1\uff0c\u8fd9\u4e00\u529f\u80fd\u5141\u8bb8\u670d\u52a1\u5728 Kubernetes \u96c6\u7fa4\u95f4\u900f\u660e\u5730\u8fdb\u884c\u901a\u4fe1\u3002\u542f\u7528\u8be5\u529f\u80fd\u540e\uff0c\u5982\u679c\u670d\u52a1 A \u4e0e\u670d\u52a1 B \u901a\u4fe1\uff0c\u5b83\u4e0d\u9700\u8981\u77e5\u9053 B \u662f\u5728\u540c\u4e00\u4e2a\u96c6\u7fa4\u8fd8\u662f\u4e0d\u540c\u7684\u96c6\u7fa4\u4e0a\u8fd0\u884c\uff0c\u662f\u5728\u540c\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3\u8fd8\u662f\u5728\u4e92\u8054\u7f51\u4e0a\u3002\u540c\u6837\u7684 mTLS\u3001\u6307\u6807\u548c\u53ef\u9760\u6027\u529f\u80fd\u5728\u96c6\u7fa4\u5185\u548c\u8de8\u96c6\u7fa4\u7684\u901a\u4fe1\u4e2d\u90fd\u662f\u7edf\u4e00\u5e94\u7528\u7684\u3002\u4e8b\u5b9e\u4e0a\uff0c\u5f53\u4e0e\u6d41\u91cf\u5206\u5272\u76f8\u7ed3\u5408\u65f6\uff0c\u670d\u52a1 B \u53ef\u4ee5\u4ece\u672c\u5730\u96c6\u7fa4\u8fc1\u79fb\u6216\u6545\u969c\u8f6c\u79fb\u5230\u8fdc\u7a0b\u96c6\u7fa4\uff0c\u6216\u8de8\u8d8a\u72ec\u7acb\u7684\u8fdc\u7a0b\u96c6\u7fa4\u3002 Linkerd \u591a\u96c6\u7fa4\u7ec4\u4ef6\u4f7f\u7528 linkerd multi-cluster install \u547d\u4ee4\u4e0e\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u5206\u5f00\u5b89\u88c5 \uff0c \u6b64\u547d\u4ee4\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a linkerd-multi-cluster \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u4e2a\u7ec4\u4ef6\uff1a service-mirror \u548c linkerd-gateway \uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u7528\u4e8e\u786e\u4fdd\u4e24\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u8fde\u63a5\u7684\u5065\u5eb7\uff0c\u5e76\u4e3a\u8fdc\u7a0b\u6216\u76ee\u6807\u96c6\u7fa4\u4e0a\u5b58\u5728\u7684\u670d\u52a1\u8def\u7531\u6d41\u91cf \u3002 \u6bcf\u4e2a\u53c2\u4e0e\u7684\u96c6\u7fa4\u90fd\u5fc5\u987b\u5728\u5b89\u88c5\u4e86\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u60c5\u51b5\u4e0b\u8fd0\u884c Linkerd \u63a7\u5236\u5e73\u9762\u3002\u8fd9\u5c31\u6d88\u9664\u4e86\u4efb\u4f55\u4e00\u4e2a\u96c6\u7fa4\u7684\u5355\u70b9\u6545\u969c\uff1a \u5982\u679c\u4e00\u4e2a\u96c6\u7fa4\u88ab\u79fb\u9664\u3001\u5d29\u6e83\u6216\u53d8\u5f97\u4e0d\u53ef\u7528\uff0c\u5176\u4f59\u7684\u96c6\u7fa4\u548c\u63a7\u5236\u5e73\u9762\u5c06\u7ee7\u7eed\u8fd0\u4f5c \u3002 \u591a\u96c6\u7fa4\u8bbe\u7f6e\u4e2d\u6700\u56f0\u96be\u7684\u90e8\u5206\u662f mTLS \u57fa\u7840\u8bbe\u65bd\uff1a\u6bcf\u4e2a\u96c6\u7fa4\u4e0a\u7684\u9881\u53d1\u8005\u8bc1\u4e66\u5fc5\u987b\u7531\u540c\u4e00\u4e2a\u4fe1\u4efb\u6839\u7b7e\u7f72\u3002\u8fd9\u610f\u5473\u7740\u7b80\u5355\u5730\u8fd0\u884c linkerd install \u8fdb\u884c\u5b89\u88c5\u4f1a\u6709\u95ee\u9898\uff0c\u9700\u8981\u6307\u5b9a\u540c\u4e00\u4e2a\u6839\u8bc1\u4e66\u3002","title":"\u591a\u96c6\u7fa4\u901a\u4fe1"},{"location":"chap11/6linkered_prod/#_3","text":"\u4e0a\u9762\u662f\u5c06 Linkerd \u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e4b\u524d\u9700\u8981\u8003\u8651\u7684\u4e00\u4e9b\u91cd\u8981\u4e8b\u9879\uff0c\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u4e8b\u9879\u4e5f\u662f\u503c\u5f97\u6211\u4eec\u5173\u6ce8\u7684\uff1a \u914d\u7f6e\u8d44\u6e90 \uff1a\u5f53\u4f60\u5728 HA \u6a21\u5f0f\u4e0b\u90e8\u7f72 Linkerd \u65f6\uff0cLinkerd \u4e3a\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u8bbe\u7f6e CPU \u548c\u5185\u5b58\u8d44\u6e90\u8bf7\u6c42\u548c\u9650\u5236\u3002\u8fd9\u4e9b\u9650\u5236\u662f\u4e00\u4e2a\u76f8\u5bf9\u5408\u7406\u7684\u503c\uff0c\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u5e94\u7528\u90fd\u662f\u4e00\u6837\u7684\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u8c03\u6574\u8fd9\u4e9b\u8d44\u6e90\u914d\u7f6e\u4ee5\u9002\u5e94\u4f60\u7684\u9700\u6c42\u3002\u5bf9\u4e8e\u9ad8\u6d41\u91cf\u7684\u670d\u52a1\uff08\u6bcf\u4e2a\u5b9e\u4f8b\u6bcf\u79d2>1000\u4e2a\u8bf7\u6c42\uff09\uff0c\u6211\u4eec\u53ef\u80fd\u8fd8\u9700\u8981\u8c03\u6574\u4ee3\u7406\u8d44\u6e90\uff0c\u4e5f\u53ef\u4ee5\u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\u6307\u5b9a config.linkerd.io/proxy-cpu-limit \u6ce8\u89e3\u6765\u914d\u7f6e\u4ee3\u7406\u7684\u5e76\u53d1\u3002 \u68c0\u67e5\u65f6\u949f\u504f\u5dee \uff1a\u786e\u4fdd\u96c6\u7fa4\u4e2d\u7684\u8282\u70b9\u4fdd\u6301\u540c\u6b65\u5f88\u91cd\u8981\uff0c\u4f8b\u5982\u901a\u8fc7\u4f7f\u7528 NTP\uff0c\u8282\u70b9\u4e4b\u95f4\u7684\u5927\u65f6\u949f\u504f\u5dee\u53ef\u80fd\u4f1a\u7834\u574f Linkerd \u4ee3\u7406\u9a8c\u8bc1\u5b83\u4eec\u7528\u4e8e mTLS \u7684\u8bc1\u4e66\u7684\u80fd\u529b\uff08\u5728\u89e3\u51b3\u96c6\u7fa4\u4e2d\u7684\u95ee\u9898\u65f6\uff0c\u5927\u7684\u65f6\u949f\u504f\u5dee\u53ef\u80fd\u4f1a\u4f7f\u8de8\u8282\u70b9\u8bfb\u53d6\u65e5\u5fd7\u6587\u4ef6\u53d8\u5f97\u56f0\u96be\uff01\uff09\u3002 \u5904\u7406 NET_ADMIN \uff1aLinkerd \u7684 proxy-init \u5bb9\u5668\u5728\u6ce8\u5165 Pod \u65f6\u8fd0\u884c\uff0c\u5e76\u8d1f\u8d23\u914d\u7f6e iptables \u89c4\u5219\uff0c\u4ee5\u4fbf\u6240\u6709\u8fdb\u51fa\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684 TCP \u6d41\u91cf\u90fd\u81ea\u52a8\u901a\u8fc7\u4ee3\u7406\u5bb9\u5668\u8def\u7531\u3002\u8fd9\u9700\u8981 Kubernetes \u7684 NET_ADMIN \u8fd9\u4e2a Linux Capability\uff0c\u8fd9\u610f\u5473\u7740\u4efb\u4f55\u5411\u96c6\u7fa4\u6dfb\u52a0\u652f\u6301 Linkerd \u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7cfb\u7edf\u90fd\u5fc5\u987b\u88ab\u6388\u4e88\u8be5\u80fd\u529b\u3002\u5982\u679c\u51fa\u4e8e\u5b89\u5168\u539f\u56e0\u4e0d\u5e0c\u671b\u8fd9\u6837\u505a\uff0c\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528 Linkerd CNI \u63d2\u4ef6\u5728\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u8005\u6743\u9650\u8303\u56f4\u4e4b\u5916\u6267\u884c\u6b64\u64cd\u4f5c\u3002 linkerd viz tap \u6743\u9650 \uff1a\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u8fc7 tap \u8fd9\u4e2a\u5f3a\u5927\u7684\u547d\u4ee4\uff0c\u4f46\u662f\u8fd9\u4e2a\u529f\u80fd\u4e5f\u4f1a\u9644\u5e26\u5f88\u591a\u98ce\u9669\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u547d\u4ee4\u53ef\u80fd\u4f1a\u5c06\u6f5c\u5728\u7684\u654f\u611f\u4fe1\u606f\u66b4\u9732\u7ed9\u7528\u6237\uff0c\u4e0d\u8fc7 Linkerd \u5141\u8bb8\u6211\u4eec\u4f7f\u7528 Kubernetes RBAC \u9650\u5236\u6765\u63a7\u5236\u8c01\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8f93\u51fa\u3002 \u4f7f\u7528 Ingress \uff1a\u4e0e\u5176\u4ed6\u4e00\u4e9b\u670d\u52a1\u7f51\u683c\u4e0d\u540c\uff0cLinkerd \u4e0d\u63d0\u4f9b\u81ea\u5df1\u7684 Ingress \u63a7\u5236\u5668\u3002\u76f8\u53cd\uff0c\u4f60\u53ef\u4ee5\u5c06 Linkerd \u4e0e\u5176\u4ed6\u53ef\u7528\u7684 Kubernetes Ingress \u63a7\u5236\u5668\u914d\u5408\u4f7f\u7528\uff0c\u5f53\u8fd9\u6837\u505a\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5efa\u8bae\u5c06 Ingress \u63a7\u5236\u5668\u4e0e Linkerd \u4ee3\u7406\u6ce8\u5165\uff0c\u8fd9\u5c06\u5141\u8bb8 Linkerd \u7684 mTLS \u548c\u53ef\u89c2\u5bdf\u6027\u4ece\u8bf7\u6c42\u8fdb\u5165\u96c6\u7fa4\u7684\u90a3\u4e00\u523b\u8d77\u5c31\u5df2\u7ecf\u53ef\u7528\u4e86\u3002 \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u57fa\u672c\u4e0a\u4e86\u89e3\u4e86\u5982\u4f55\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528 Linkerd \u4e86\u3002\u4f46\u4e5f\u8981\u6ce8\u610f\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u7684\u8fd9\u4e9b\u4e8b\u9879\u5e76\u4e0d\u662f\u6240\u6709\u7684\uff0c\u5f3a\u70c8\u5efa\u8bae\u5728\u5c06 Linkerd \u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e4b\u524d\u5b8c\u5168\u7406\u89e3\u8fd9\u4e9b\u6982\u5ff5\u5e76\u901a\u8bfb Linkerd \u6587\u6863\u3002","title":"\u5176\u4ed6"},{"location":"chap11/7linkered_ingress/","text":"7 Linkerd \u4e0e ingress-nginx \u7ed3\u5408\u4f7f\u7528\u4ee5\u53ca\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\u9650\u5236 \u51fa\u4e8e\u7b80\u5355\uff0cLinkerd \u672c\u8eab\u5e76\u6ca1\u6709\u63d0\u4f9b\u5185\u7f6e\u7684 Ingress \u63a7\u5236\u5668\uff0cLinkerd \u65e8\u5728\u4e0e\u73b0\u6709\u7684 Kubernetes Ingress \u89e3\u51b3\u65b9\u6848\u4e00\u8d77\u4f7f\u7528\u3002 \u8981\u7ed3\u5408 Linkerd \u548c\u4f60\u7684 Ingress \u89e3\u51b3\u65b9\u6848\u9700\u8981\u4e24\u4ef6\u4e8b\uff1a \u914d\u7f6e\u4f60\u7684 Ingress \u4ee5\u652f\u6301 Linkerd\u3002 \u7f51\u683c\u5316\u4f60\u7684 Ingress \u63a7\u5236\u5668\uff0c\u4ee5\u4fbf\u5b83\u4eec\u5b89\u88c5 Linkerd \u4ee3\u7406\u3002 \u5bf9 Ingress \u63a7\u5236\u5668\u8fdb\u884c\u7f51\u683c\u5316\u5c06\u5141\u8bb8 Linkerd \u5728\u6d41\u91cf\u8fdb\u5165\u96c6\u7fa4\u65f6\u63d0\u4f9b L7 \u6307\u6807\u548c mTLS \u7b49\u529f\u80fd\uff0cLinkerd \u652f\u6301\u4e0e\u5927\u90e8\u5206 Ingress \u63a7\u5236\u5668\u8fdb\u884c\u96c6\u6210\uff0c\u5305\u62ec\uff1a Ambassador Nginx Traefik Traefik 1.x Traefik 2.x GCE Gloo Contour Kong Haproxy ingress-nginx \u6211\u4eec\u8fd9\u91cc\u4ee5\u96c6\u7fa4\u4e2d\u4f7f\u7528\u7684 ingress-nginx \u4e3a\u4f8b\u6765\u8bf4\u660e\u5982\u4f55\u5c06\u5176\u4e0e Linkerd \u8fdb\u884c\u96c6\u6210\u4f7f\u7528\u3002 $ kubectl get deploy -n ingress-nginx NAME READY UP-TO-DATE AVAILABLE AGE ingress-nginx-controller 1/1 1 1 57d ingress-nginx-defaultbackend 1/1 1 1 57d $ kubectl get pods -n ingress-nginx NAME READY STATUS RESTARTS AGE ingress-nginx-controller-7647c44fb9-sss9m 1/1 Running 26 (59m ago) 57d ingress-nginx-defaultbackend-84854cd6cb-rvgd2 1/1 Running 27 (59m ago) 57d \u9996\u5148\u6211\u4eec\u9700\u8981\u66f4\u65b0 ingress-nginx-controller \u63a7\u5236\u5668\uff0c\u4e3a Pod \u6dfb\u52a0\u4e00\u4e2a linkerd.io/inject: enabled \u6ce8\u89e3\uff0c \u53ef\u4ee5\u76f4\u63a5 kubectl edit \u8fd9\u4e2a Deployment \uff0c\u7531\u4e8e\u6211\u4eec\u96c6\u7fa4\u4e2d\u7684 ingress-nginx \u4f7f\u7528\u7684 Helm Chart \u5b89\u88c5\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u5728 values \u4e2d\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u914d\u7f6e\uff1a controller: podAnnotations: linkerd.io/inject: enabled # ...... \u7136\u540e\u4f7f\u7528\u8be5 values \u91cd\u65b0\u66f4\u65b0\u5373\u53ef\uff1a # Update your helm repos with the ingress-nginx repo $ helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx $ helm repo update # Install the ingress-nginx chart $ helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx --namespace=ingress-nginx --values=values.yaml \u66f4\u65b0\u540e ingress-nginx \u7684\u63a7\u5236\u5668 Pod \u5c31\u4f1a\u88ab\u81ea\u52a8\u6ce8\u5165\u4e00\u4e2a linkerd proxy \u7684 sidecar \u5bb9\u5668 \uff1a $ kubectl get pods -n ingress-nginx NAME READY STATUS RESTARTS AGE ingress-nginx-controller-f56c7f6fd-rxhrs 2/2 Running 0 4m21s ingress-nginx-defaultbackend-84854cd6cb-rvgd2 1/1 Running 27 (62m ago) 57d \u8fd9\u6837 ingress \u63a7\u5236\u5668\u4e5f\u88ab\u52a0\u5165\u5230\u7f51\u683c\u4e2d\u53bb\u4e86\uff0c\u6240\u4ee5\u4e5f\u5177\u6709\u4e86 Linkerd \u7f51\u683c\u7684\u76f8\u5173\u529f\u80fd\uff1a \u4e3a Ingress \u63a7\u5236\u5668\u63d0\u4f9b\u9ec4\u91d1\u6307\u6807\uff08\u6bcf\u79d2\u8bf7\u6c42\u6570\u7b49\uff09\u3002 Ingress \u63a7\u5236\u5668 Pod \u548c\u7f51\u683c\u5e94\u7528 Pod \u4e4b\u95f4\u7684\u6d41\u91cf\u662f\u52a0\u5bc6\u7684\uff08\u5e76\u76f8\u4e92\u9a8c\u8bc1\uff09\u3002 \u53ef\u4ee5\u770b\u5230 HTTP \u6d41\u91cf \u5f53\u5e94\u7528\u7a0b\u5e8f\u8fd4\u56de\u9519\u8bef\uff08\u5982 5xx HTTP \u72b6\u6001\u4ee3\u7801\uff09\u65f6\uff0c\u8fd9\u5c06\u5728 Linkerd UI \u4e2d\u770b\u5230\uff0c\u4e0d\u4ec5\u662f\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd8\u6709 nginx ingress \u63a7\u5236\u5668\uff0c\u56e0\u4e3a\u5b83\u5411\u5ba2\u6237\u7aef\u8fd4\u56de\u9519\u8bef\u4ee3\u7801\u3002 \u5728 Linkerd Dashboard \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u6307\u6807\u6570\u636e\u4e86\u3002 \u5bf9\u5e94\u5728 Grafana \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u56fe\u8868\u4fe1\u606f\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u4e3a Emojivoto \u5e94\u7528\u6dfb\u52a0\u4e00\u4e2a\u5bf9\u5e94\u7684 Ingress \u8d44\u6e90\u5bf9\u8c61\u6765\u5bf9\u5916\u66b4\u9732\u670d\u52a1\u3002 # emojivoto-ingress.yaml apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: emojivoto-ingress labels: name: emojivoto-ingress namespace: emojivoto annotations: # add below line of nginx is meshed nginx.ingress.kubernetes.io/service-upstream: \"true\" # nginx.ingress.kubernetes.io/affinity: \"cookie\" # nginx.ingress.kubernetes.io/affinity-mode: \"persistent\" spec: ingressClassName: nginx rules: # update IP with your own IP used by Ingress Controller - host: emoji.192.168.0.52.nip.io http: paths: - pathType: Prefix path: / backend: service: name: web-svc-2 port: number: 80 \u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a $ kubectl apply -f emojivoto-ingress.yaml $ kubectl get ingress -n emojivoto NAME CLASS HOSTS ADDRESS PORTS AGE emojivoto-ingress nginx emoji.192.168.0.52.nip.io 192.168.0.52 80 61s \u5176\u4e2d nip.io \u662f\u4efb\u4f55 IP \u5730\u5740\u7684\u7b80\u5355\u901a\u914d\u7b26 DNS \uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u4e0d\u7528\u4f7f\u7528\u81ea\u5b9a\u4e49\u4e3b\u673a\u540d\u548c IP \u5730\u5740\u6620\u5c04\u6765\u7f16\u8f91\u4f60\u7684 etc/hosts \u6587\u4ef6\u4e86 \uff0c nip.io \u5141\u8bb8\u4f60\u901a\u8fc7\u4f7f\u7528\u4ee5\u4e0b\u683c\u5f0f\u5c06\u4efb\u4f55 IP \u5730\u5740\u6620\u5c04\u5230\u4e00\u4e2a\u4e3b\u673a\u540d\u3002 \u4e0d\u5e26\u540d\u79f0 10.0.0.1.nip.io \u6620\u5c04\u5230 10.0.0.1 192-168-1-250.nip.io \u6620\u5c04\u5230 192.168.1.250 0a000803.nip.io \u6620\u5c04\u5230 10.0.8.3 \u5e26\u540d\u79f0 app.10.8.0.1.nip.io \u6620\u5c04\u5230 10.8.0.1 app-116-203-255-68.nip.io \u6620\u5c04\u5230 116.203.255.68 app-c0a801fc.nip.io \u6620\u5c04\u5230 192.168.1.252 customer1.app.10.0.0.1.nip.io \u6620\u5c04\u5230 10.0.0.1 customer2-app-127-0-0-1.nip.io \u6620\u5c04\u5230 127.0.0.1 customer3-app-7f000101.nip.io \u6620\u5c04\u5230 127.0.1.1 nip.io \u5c06 <anything>[.-]<IP Address>.nip.io \u4ee5\"\u70b9\"\u3001\"\u7834\u6298\u53f7\"\u6216\"\u5341\u516d\u8fdb\u5236\"\u7b26\u53f7\u6620\u5c04\u5230\u76f8\u5e94\u7684 <IP Address> \u3002 \u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u57df\u540d emoji.192.168.0.52.nip.io \u76f8\u5f53\u4e8e\u76f4\u63a5\u6620\u5c04\u5230 192.168.0.52 \u8fd9\u4e2a IP \u5730\u5740\u4e0a\uff0c\u8be5\u5730\u5740\u662f\u6211\u4eec ingress-nginx \u7684\u5165\u53e3\u5730\u5740\uff0c\u8fd9\u6837\u6211\u4eec\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u6620\u5c04\u5373\u53ef\u8bbf\u95ee\u670d\u52a1\u4e86\u3002 \u53e6\u5916\u9700\u8981\u6ce8\u610f\u5728\u4e0a\u9762\u7684 Ingress \u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a nginx.ingress.kubernetes.io/service-upstream: true \u7684\u6ce8\u89e3\uff0c\u8fd9\u662f\u7528\u6765\u544a\u8bc9 Nginx Ingress Controller \u5c06\u6d41\u91cf\u8def\u7531\u5230\u7f51\u683c\u5e94\u7528\u7684\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u8def\u7531\u5230 Pod\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIngress \u63a7\u5236\u5668\u53ea\u662f\u67e5\u8be2\u5176\u76ee\u6807\u670d\u52a1\u7684\u7aef\u70b9\uff0c\u4ee5\u68c0\u7d22\u8be5\u670d\u52a1\u80cc\u540e\u7684 Pod \u7684 IP \u5730\u5740\u3002\u800c\u901a\u8fc7\u5411\u7f51\u683c\u670d\u52a1\u53d1\u9001\u6d41\u91cf\uff0cLinkerd \u7684\u76f8\u5173\u529f\u80fd\u5982\u8d1f\u8f7d\u5747\u8861\u548c\u6d41\u91cf\u62c6\u5206\u5219\u4f1a\u88ab\u542f\u7528\u3002 \u9650\u5236\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee Linkerd policy \u8d44\u6e90\u53ef\u7528\u4e8e\u9650\u5236\u54ea\u4e9b\u5ba2\u6237\u7aef\u53ef\u4ee5\u8bbf\u95ee\u670d\u52a1\u3002\u540c\u6837\u6211\u4eec\u8fd8\u662f\u4f7f\u7528 Emojivoto \u5e94\u7528\u6765\u5c55\u793a\u5982\u4f55\u9650\u5236\u5bf9 Voting \u5fae\u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4f7f\u5176\u53ea\u80fd\u4ece Web \u670d\u52a1\u4e2d\u8c03\u7528\u3002 \u6211\u4eec\u9996\u5148\u4e3a Voting \u670d\u52a1\u521b\u5efa\u4e00\u4e2a Server \u8d44\u6e90\uff0cServer \u662f Linkerd \u7684\u53e6\u5916\u4e00\u4e2a CRD \u81ea\u5b9a\u4e49\u8d44\u6e90\uff0c\u5b83\u7528\u4e8e\u63cf\u8ff0\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7279\u5b9a\u7aef\u53e3 \u3002\u4e00\u65e6 Server \u8d44\u6e90\u88ab\u521b\u5efa\uff0c\u53ea\u6709\u88ab\u6388\u6743\u7684\u5ba2\u6237\u7aef\u624d\u80fd\u8bbf\u95ee\u5b83\u3002 \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a # voting-server.yaml apiVersion: policy.linkerd.io/v1beta1 kind: Server metadata: name: voting-grpc namespace: emojivoto labels: app: voting-svc spec: podSelector: matchLabels: app: voting-svc port: grpc proxyProtocol: gRPC \u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a $ kubectl apply -f voting-server.yaml server.policy.linkerd.io/voting-grpc created $ kubectl get server -n emojivoto NAME PORT PROTOCOL voting-grpc grpc gRPC \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8be5 Server \u4f7f\u7528\u4e86\u4e00\u4e2a podSelector \u5c5e\u6027\u6765\u9009\u62e9\u5b83\u6240\u63cf\u8ff0\u7684 Voting \u670d\u52a1\u7684 Pod\uff0c\u5b83\u8fd8\u6307\u5b9a\u4e86\u5b83\u9002\u7528\u7684\u547d\u540d\u7aef\u53e3 (grpc)\uff0c\u6700\u540e\u6307\u5b9a\u5728\u6b64\u7aef\u53e3\u4e0a\u63d0\u4f9b\u670d\u52a1\u7684\u534f\u8bae\u4e3a gRPC \uff0c \u8fd9\u53ef\u786e\u4fdd\u4ee3\u7406\u6b63\u786e\u5904\u7406\u6d41\u91cf\u5e76\u5141\u8bb8\u5b83\u8df3\u8fc7\u534f\u8bae\u68c0\u6d4b\u3002 \u73b0\u5728\u6ca1\u6709\u5ba2\u6237\u7aef\u88ab\u6388\u6743\u8bbf\u95ee\u6b64\u670d\u52a1\uff0c\u6b63\u5e38\u4f1a\u770b\u5230\u6210\u529f\u7387\u6709\u6240\u4e0b\u964d\uff0c \u56e0\u4e3a\u4ece Web \u670d\u52a1\u5230 Voting \u7684\u8bf7\u6c42\u5f00\u59cb\u88ab\u62d2\u7edd\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b Web \u670d\u52a1\u7684 Pod \u65e5\u5fd7\u6765\u9a8c\u8bc1\uff1a $ kubectl logs -f web-svc-2-f9d77474f-vxlrh -n emojivoto -c web-svc-2 2022/09/06 09:31:27 Error serving request [&{GET /api/vote?choice=:trophy: HTTP/1.1 1 1 map[Accept-Encoding:[gzip] L5d-Client-Id:[default.emojivoto.serviceaccount.identity.linkerd.cluster.local] L5d-Dst-Canonical:[web-apex.emojivoto.svc.cluster.local:80] User-Agent:[Go-http-client/1.1] X-B3-Sampled:[1] X-B3-Spanid:[f9e1dc6e24803ea8] X-B3-Traceid:[5ae662deee8fdbf2f3b9eaa40eb673d5]] {} <nil> 0 [] false web-apex.emojivoto:80 map[choice:[:trophy:]] map[] <nil> map[] 10.244.1.87:51244 /api/vote?choice=:trophy: <nil> <nil> <nil> 0xc00045e4b0}]: rpc error: code = PermissionDenied desc = unauthorized connection on server voting-grpc # ...... \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd viz authz \u547d\u4ee4\u67e5\u770b\u8fdb\u5165 Voting \u670d\u52a1\u7684\u8bf7\u6c42\u7684\u6388\u6743\u72b6\u6001\uff1a $ linkerd viz authz -n emojivoto deploy/voting SERVER AUTHZ SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 voting-grpc [UNAUTHORIZED] - 0.9rps \u53ef\u4ee5\u770b\u5230\u6240\u6709\u4f20\u5165\u7684\u8bf7\u6c42\u5f53\u524d\u90fd\u5904\u4e8e\u672a\u7ecf\u6388\u6743\u72b6\u6001\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u4e3a\u5ba2\u6237\u7aef\u6765\u6388\u4e88\u8bbf\u95ee\u8be5 Server \u7684\u6743\u9650\uff0c\u8fd9\u91cc\u9700\u8981\u4f7f\u7528\u5230\u53e6\u5916\u4e00\u4e2a CRD \u5bf9\u8c61 ServerAuthorization\uff0c\u521b\u5efa\u8be5\u5bf9\u8c61\u6765\u6388\u4e88 Web \u670d\u52a1\u8bbf\u95ee\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u7684 Voting Server \u7684\u6743\u9650\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a # voting-server-auth.yaml apiVersion: policy.linkerd.io/v1beta1 kind: ServerAuthorization metadata: name: voting-grpc namespace: emojivoto spec: server: name: voting-grpc # \u5173\u8054 Server \u5bf9\u8c61 # The voting service only allows requests from the web service. client: meshTLS: serviceAccounts: - name: web - name: web-2 \u4e0a\u9762\u5bf9\u8c61\u4e2d\u901a\u8fc7 spec.server.name \u6765\u5173\u8054\u4e0a\u9762\u7684 Server \u5bf9\u8c61\uff0c\u7531\u4e8e meshTLS \u4f7f\u7528 ServiceAccounts \u4f5c\u4e3a\u8eab\u4efd\u57fa\u7840\uff0c\u56e0\u6b64\u6211\u4eec\u7684\u6388\u6743\u4e5f\u5c06\u57fa\u4e8e ServiceAccounts \uff0c\u6240\u4ee5\u901a\u8fc7 spec.client.meshTLS.serviceAccounts \u6765\u6307\u5b9a\u5141\u8bb8\u4ece\u54ea\u4e9b\u670d\u52a1\u6765\u8bbf\u95ee Voting \u670d\u52a1\u3002 \u540c\u6837\u76f4\u63a5\u5e94\u7528\u8be5\u8d44\u6e90\u6e05\u5355\u5373\u53ef\uff1a $ kubectl apply -f voting-server-auth.yaml serverauthorization.policy.linkerd.io/voting-grpc created $ kubectl get serverauthorization -n emojivoto NAME SERVER voting-grpc voting-grpc \u6709\u4e86\u8fd9\u4e2a\u5bf9\u8c61\u540e\uff0c\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u770b\u5230\u6240\u6709\u5bf9 Voting \u670d\u52a1\u7684\u8bf7\u6c42\u90fd\u662f\u7531 voting-grpc \u8fd9\u4e2a ServerAuthorization \u6388\u6743\u7684\u3002\u8bf7\u6ce8\u610f\uff0c\u7531\u4e8e linkerd viz auth \u547d\u4ee4\u5728\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\u5185\u67e5\u8be2\uff0c\u6240\u4ee5\u53ef\u80fd\u4f1a\u770b\u5230\u4e00\u4e9b\u672a\u6388\u6743(UNAUTHORIZED)\u7684\u8bf7\u6c42\u5728\u77ed\u65f6\u95f4\u5185\u663e\u793a\u3002 $ linkerd viz authz -n emojivoto deploy/voting SERVER AUTHZ SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 voting-grpc voting-grpc 84.48% 1.0rps 1ms 1ms 1ms \u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a gRPC \u5ba2\u6237\u7aef Pod \u6765\u5c1d\u8bd5\u4ece\u4e2d\u8bbf\u95ee Voting \u670d\u52a1\u6d4b\u8bd5\u6765\u81ea\u5176\u4ed6 Pod \u7684\u8bf7\u6c42\u662f\u5426\u4f1a\u88ab\u62d2\u7edd\uff1a $ kubectl run grpcurl --rm -it --image=networld/grpcurl --restart=Never --command -- ./grpcurl -plaintext voting-svc.emojivoto:8080 emojivoto.v1.VotingService/VoteDog If you don't see a command prompt, try pressing enter. Error attaching, falling back to logs: unable to upgrade connection: container grpcurl not found in pod grpcurl_default Error invoking method \"emojivoto.v1.VotingService/VoteDog\": failed to query for service descriptor \"emojivoto.v1.VotingService\": rpc error: code = PermissionDenied desc = pod \"grpcurl\" deleted pod default/grpcurl terminated (Error)` \u7531\u4e8e\u8be5 client \u672a\u7ecf\u6388\u6743\uff0c\u6240\u4ee5\u8be5\u8bf7\u6c42\u5c06\u88ab\u62d2\u7edd\u5e76\u663e\u793a PermissionDenied \u9519\u8bef\u3002 \u6211\u4eec\u53ef\u4ee5\u6839\u636e\u9700\u8981\u521b\u5efa\u4efb\u610f\u6570\u91cf\u7684 ServerAuthorization \u8d44\u6e90\u6765\u6388\u6743\u8bb8\u591a\u4e0d\u540c\u7684\u5ba2\u6237\u7aef\uff0c\u8fd8\u53ef\u4ee5\u6307\u5b9a\u662f\u6388\u6743\u672a\u7ecf\u8eab\u4efd\u9a8c\u8bc1\uff08\u5373 unmeshed\uff09\u7684\u5ba2\u6237\u7aef\u3001\u4efb\u4f55\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u5ba2\u6237\u7aef\uff0c\u8fd8\u662f\u4ec5\u6388\u6743\u5177\u6709\u7279\u5b9a\u8eab\u4efd\u7684\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u5ba2\u6237\u7aef\u3002 \u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u4e3a\u6574\u4e2a\u96c6\u7fa4\u8bbe\u7f6e\u4e00\u4e2a\u9ed8\u8ba4\u7b56\u7565\uff0c\u8be5\u7b56\u7565\u5c06\u5e94\u7528\u4e8e\u6240\u6709\u672a\u5b9a\u4e49 Server \u8d44\u6e90\u7684\u3002Linkerd \u5728\u51b3\u5b9a\u662f\u5426\u5141\u8bb8\u8bf7\u6c42\u65f6\u4f1a\u4f7f\u7528\u4ee5\u4e0b\u903b\u8f91\uff1a \u5982\u679c\u6709\u4e00\u4e2a Server \u8d44\u6e90\u5e76\u4e14\u5ba2\u6237\u7aef\u4e3a\u5176\u5339\u914d\u4e00\u4e2a ServerAuthorization \u8d44\u6e90\uff0c\u5219\u4e3a ALLOW \u5982\u679c\u6709\u4e00\u4e2a Server \u8d44\u6e90\uff0c\u4f46\u5ba2\u6237\u7aef\u4e0d\u5339\u914d\u5b83\u7684\u4efb\u4f55 ServerAuthorizations\uff0c\u5219\u4e3a DENY \u5982\u679c\u7aef\u53e3\u6ca1\u6709 Server \u8d44\u6e90\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7b56\u7565 \u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd upgrade \u547d\u4ee4\u5c06\u9ed8\u8ba4\u7b56\u7565\u8bbe\u7f6e\u4e3a deny\uff1a $ linkerd upgrade --set policyController.defaultAllowPolicy=deny | kubectl apply -f - \u53e6\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e config.linkerd.io/default-inbound-policy \u6ce8\u89e3\uff0c\u53ef\u4ee5\u5728\u5355\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6216\u547d\u540d\u7a7a\u95f4\u4e0a\u8bbe\u7f6e\u9ed8\u8ba4\u7b56\u7565 \u3002 \u610f\u601d\u5c31\u662f\u9664\u975e\u901a\u8fc7\u521b\u5efa Server \u548c ServerAuthorization \u5bf9\u8c61\u660e\u786e\u6388\u6743\uff0c\u5426\u5219\u6240\u6709\u8bf7\u6c42\u90fd\u5c06\u88ab\u62d2\u7edd\uff0c\u8fd9\u6837\u7684\u8bdd\u5bf9\u4e8e liveness \u548c readiness \u63a2\u9488\u9700\u8981\u660e\u786e\u6388\u6743\uff0c\u5426\u5219 Kubernetes \u5c06\u65e0\u6cd5\u5c06 Pod \u8bc6\u522b\u4e3a live \u6216 ready \u72b6\u6001\uff0c\u5e76\u5c06\u91cd\u65b0\u542f\u52a8\u5b83\u4eec\u3002 \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u7b56\u7565\u5bf9\u8c61\uff0c\u6765\u5141\u8bb8\u6240\u6709\u5ba2\u6237\u7aef\u8bbf\u95ee Linkerd admin \u7aef\u53e3\uff0c\u4ee5\u4fbf Kubernetes \u53ef\u4ee5\u6267\u884c liveness \u548c readiness \u68c0\u67e5\uff1a $ cat << EOF | kubectl apply -f - --- # Server \"admin\": matches the admin port for every pod in this namespace apiVersion: policy.linkerd.io/v1beta1 kind: Server metadata: namespace: emojivoto name: admin spec: port: linkerd-admin podSelector: matchLabels: {} # every pod proxyProtocol: HTTP/1 --- # ServerAuthorization \"admin-everyone\": allows unauthenticated access to the # \"admin\" Server, so that Kubernetes health checks can get through. apiVersion: policy.linkerd.io/v1beta1 kind: ServerAuthorization metadata: namespace: emojivoto name: admin-everyone spec: server: name: admin client: unauthenticated: true ization \u9650\u5236\u4e3a\u8fd9\u4e9b IP \u5730\u5740\u6216\u8303\u56f4\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u77e5\u9053 Kubelet \u5728 10.244.0.1 \u4e0a\u8fd0\u884c\uff0c\u90a3\u4e48\u4f60\u7684 ServerAuthorization \u53ef\u4ee5\u6539\u4e3a\uff1a # ServerAuthorization \"admin-kublet\": allows unauthenticated access to the # \"admin\" Server from the kubelet, so that Kubernetes health checks can get through. apiVersion: policy.linkerd.io/v1beta1 kind: ServerAuthorization metadata: namespace: emojivoto name: admin-kubelet spec: server: name: admin client: networks: - cidr: 10.244.0.1/32 unauthenticated: true \u53e6\u5916\u6709\u4e00\u4e2a\u503c\u5f97\u6ce8\u610f\u7684\u662f\u5728\u6211\u4eec\u521b\u5efa Server \u8d44\u6e90\u4e4b\u540e\uff0c\u4f46\u5728\u521b\u5efa ServerAuthorization \u4e4b\u524d\u6709\u4e00\u6bb5\u65f6\u95f4\uff0c\u6240\u6709\u8bf7\u6c42\u90fd\u88ab\u62d2\u7edd\u3002\u4e3a\u4e86\u907f\u514d\u5728\u5b9e\u65f6\u7cfb\u7edf\u4e2d\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u5efa\u8bae\u4f60\u5728\u90e8\u7f72\u670d\u52a1\u4e4b\u524d\u521b\u5efa policy \u8d44\u6e90\uff0c\u6216\u8005\u5728\u521b\u5efa Server \u4e4b\u524d\u521b\u5efa ServiceAuthorizations\uff0c\u4ee5\u4fbf\u7acb\u5373\u6388\u6743\u5ba2\u6237\u7aef\u3002 \u5173\u4e8e\u6388\u6743\u7b56\u7565\u7684\u66f4\u591a\u4f7f\u7528\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 https://linkerd.io/2.11/reference/authorization-policy/ \u4ee5\u4e86\u89e3\u66f4\u591a\u76f8\u5173\u4fe1\u606f\u3002","title":"7 Linkerd \u4e0e ingress-nginx \u7ed3\u5408\u4f7f\u7528\u4ee5\u53ca\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\u9650\u5236"},{"location":"chap11/7linkered_ingress/#7-linkerd-ingress-nginx","text":"\u51fa\u4e8e\u7b80\u5355\uff0cLinkerd \u672c\u8eab\u5e76\u6ca1\u6709\u63d0\u4f9b\u5185\u7f6e\u7684 Ingress \u63a7\u5236\u5668\uff0cLinkerd \u65e8\u5728\u4e0e\u73b0\u6709\u7684 Kubernetes Ingress \u89e3\u51b3\u65b9\u6848\u4e00\u8d77\u4f7f\u7528\u3002 \u8981\u7ed3\u5408 Linkerd \u548c\u4f60\u7684 Ingress \u89e3\u51b3\u65b9\u6848\u9700\u8981\u4e24\u4ef6\u4e8b\uff1a \u914d\u7f6e\u4f60\u7684 Ingress \u4ee5\u652f\u6301 Linkerd\u3002 \u7f51\u683c\u5316\u4f60\u7684 Ingress \u63a7\u5236\u5668\uff0c\u4ee5\u4fbf\u5b83\u4eec\u5b89\u88c5 Linkerd \u4ee3\u7406\u3002 \u5bf9 Ingress \u63a7\u5236\u5668\u8fdb\u884c\u7f51\u683c\u5316\u5c06\u5141\u8bb8 Linkerd \u5728\u6d41\u91cf\u8fdb\u5165\u96c6\u7fa4\u65f6\u63d0\u4f9b L7 \u6307\u6807\u548c mTLS \u7b49\u529f\u80fd\uff0cLinkerd \u652f\u6301\u4e0e\u5927\u90e8\u5206 Ingress \u63a7\u5236\u5668\u8fdb\u884c\u96c6\u6210\uff0c\u5305\u62ec\uff1a Ambassador Nginx Traefik Traefik 1.x Traefik 2.x GCE Gloo Contour Kong Haproxy","title":"7 Linkerd \u4e0e ingress-nginx \u7ed3\u5408\u4f7f\u7528\u4ee5\u53ca\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\u9650\u5236"},{"location":"chap11/7linkered_ingress/#ingress-nginx","text":"\u6211\u4eec\u8fd9\u91cc\u4ee5\u96c6\u7fa4\u4e2d\u4f7f\u7528\u7684 ingress-nginx \u4e3a\u4f8b\u6765\u8bf4\u660e\u5982\u4f55\u5c06\u5176\u4e0e Linkerd \u8fdb\u884c\u96c6\u6210\u4f7f\u7528\u3002 $ kubectl get deploy -n ingress-nginx NAME READY UP-TO-DATE AVAILABLE AGE ingress-nginx-controller 1/1 1 1 57d ingress-nginx-defaultbackend 1/1 1 1 57d $ kubectl get pods -n ingress-nginx NAME READY STATUS RESTARTS AGE ingress-nginx-controller-7647c44fb9-sss9m 1/1 Running 26 (59m ago) 57d ingress-nginx-defaultbackend-84854cd6cb-rvgd2 1/1 Running 27 (59m ago) 57d \u9996\u5148\u6211\u4eec\u9700\u8981\u66f4\u65b0 ingress-nginx-controller \u63a7\u5236\u5668\uff0c\u4e3a Pod \u6dfb\u52a0\u4e00\u4e2a linkerd.io/inject: enabled \u6ce8\u89e3\uff0c \u53ef\u4ee5\u76f4\u63a5 kubectl edit \u8fd9\u4e2a Deployment \uff0c\u7531\u4e8e\u6211\u4eec\u96c6\u7fa4\u4e2d\u7684 ingress-nginx \u4f7f\u7528\u7684 Helm Chart \u5b89\u88c5\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u5728 values \u4e2d\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u914d\u7f6e\uff1a controller: podAnnotations: linkerd.io/inject: enabled # ...... \u7136\u540e\u4f7f\u7528\u8be5 values \u91cd\u65b0\u66f4\u65b0\u5373\u53ef\uff1a # Update your helm repos with the ingress-nginx repo $ helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx $ helm repo update # Install the ingress-nginx chart $ helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx --namespace=ingress-nginx --values=values.yaml \u66f4\u65b0\u540e ingress-nginx \u7684\u63a7\u5236\u5668 Pod \u5c31\u4f1a\u88ab\u81ea\u52a8\u6ce8\u5165\u4e00\u4e2a linkerd proxy \u7684 sidecar \u5bb9\u5668 \uff1a $ kubectl get pods -n ingress-nginx NAME READY STATUS RESTARTS AGE ingress-nginx-controller-f56c7f6fd-rxhrs 2/2 Running 0 4m21s ingress-nginx-defaultbackend-84854cd6cb-rvgd2 1/1 Running 27 (62m ago) 57d \u8fd9\u6837 ingress \u63a7\u5236\u5668\u4e5f\u88ab\u52a0\u5165\u5230\u7f51\u683c\u4e2d\u53bb\u4e86\uff0c\u6240\u4ee5\u4e5f\u5177\u6709\u4e86 Linkerd \u7f51\u683c\u7684\u76f8\u5173\u529f\u80fd\uff1a \u4e3a Ingress \u63a7\u5236\u5668\u63d0\u4f9b\u9ec4\u91d1\u6307\u6807\uff08\u6bcf\u79d2\u8bf7\u6c42\u6570\u7b49\uff09\u3002 Ingress \u63a7\u5236\u5668 Pod \u548c\u7f51\u683c\u5e94\u7528 Pod \u4e4b\u95f4\u7684\u6d41\u91cf\u662f\u52a0\u5bc6\u7684\uff08\u5e76\u76f8\u4e92\u9a8c\u8bc1\uff09\u3002 \u53ef\u4ee5\u770b\u5230 HTTP \u6d41\u91cf \u5f53\u5e94\u7528\u7a0b\u5e8f\u8fd4\u56de\u9519\u8bef\uff08\u5982 5xx HTTP \u72b6\u6001\u4ee3\u7801\uff09\u65f6\uff0c\u8fd9\u5c06\u5728 Linkerd UI \u4e2d\u770b\u5230\uff0c\u4e0d\u4ec5\u662f\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd8\u6709 nginx ingress \u63a7\u5236\u5668\uff0c\u56e0\u4e3a\u5b83\u5411\u5ba2\u6237\u7aef\u8fd4\u56de\u9519\u8bef\u4ee3\u7801\u3002 \u5728 Linkerd Dashboard \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u6307\u6807\u6570\u636e\u4e86\u3002 \u5bf9\u5e94\u5728 Grafana \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u56fe\u8868\u4fe1\u606f\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u4e3a Emojivoto \u5e94\u7528\u6dfb\u52a0\u4e00\u4e2a\u5bf9\u5e94\u7684 Ingress \u8d44\u6e90\u5bf9\u8c61\u6765\u5bf9\u5916\u66b4\u9732\u670d\u52a1\u3002 # emojivoto-ingress.yaml apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: emojivoto-ingress labels: name: emojivoto-ingress namespace: emojivoto annotations: # add below line of nginx is meshed nginx.ingress.kubernetes.io/service-upstream: \"true\" # nginx.ingress.kubernetes.io/affinity: \"cookie\" # nginx.ingress.kubernetes.io/affinity-mode: \"persistent\" spec: ingressClassName: nginx rules: # update IP with your own IP used by Ingress Controller - host: emoji.192.168.0.52.nip.io http: paths: - pathType: Prefix path: / backend: service: name: web-svc-2 port: number: 80 \u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a $ kubectl apply -f emojivoto-ingress.yaml $ kubectl get ingress -n emojivoto NAME CLASS HOSTS ADDRESS PORTS AGE emojivoto-ingress nginx emoji.192.168.0.52.nip.io 192.168.0.52 80 61s \u5176\u4e2d nip.io \u662f\u4efb\u4f55 IP \u5730\u5740\u7684\u7b80\u5355\u901a\u914d\u7b26 DNS \uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u4e0d\u7528\u4f7f\u7528\u81ea\u5b9a\u4e49\u4e3b\u673a\u540d\u548c IP \u5730\u5740\u6620\u5c04\u6765\u7f16\u8f91\u4f60\u7684 etc/hosts \u6587\u4ef6\u4e86 \uff0c nip.io \u5141\u8bb8\u4f60\u901a\u8fc7\u4f7f\u7528\u4ee5\u4e0b\u683c\u5f0f\u5c06\u4efb\u4f55 IP \u5730\u5740\u6620\u5c04\u5230\u4e00\u4e2a\u4e3b\u673a\u540d\u3002","title":"ingress-nginx"},{"location":"chap11/7linkered_ingress/#_1","text":"10.0.0.1.nip.io \u6620\u5c04\u5230 10.0.0.1 192-168-1-250.nip.io \u6620\u5c04\u5230 192.168.1.250 0a000803.nip.io \u6620\u5c04\u5230 10.0.8.3","title":"\u4e0d\u5e26\u540d\u79f0"},{"location":"chap11/7linkered_ingress/#_2","text":"app.10.8.0.1.nip.io \u6620\u5c04\u5230 10.8.0.1 app-116-203-255-68.nip.io \u6620\u5c04\u5230 116.203.255.68 app-c0a801fc.nip.io \u6620\u5c04\u5230 192.168.1.252 customer1.app.10.0.0.1.nip.io \u6620\u5c04\u5230 10.0.0.1 customer2-app-127-0-0-1.nip.io \u6620\u5c04\u5230 127.0.0.1 customer3-app-7f000101.nip.io \u6620\u5c04\u5230 127.0.1.1 nip.io \u5c06 <anything>[.-]<IP Address>.nip.io \u4ee5\"\u70b9\"\u3001\"\u7834\u6298\u53f7\"\u6216\"\u5341\u516d\u8fdb\u5236\"\u7b26\u53f7\u6620\u5c04\u5230\u76f8\u5e94\u7684 <IP Address> \u3002 \u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u57df\u540d emoji.192.168.0.52.nip.io \u76f8\u5f53\u4e8e\u76f4\u63a5\u6620\u5c04\u5230 192.168.0.52 \u8fd9\u4e2a IP \u5730\u5740\u4e0a\uff0c\u8be5\u5730\u5740\u662f\u6211\u4eec ingress-nginx \u7684\u5165\u53e3\u5730\u5740\uff0c\u8fd9\u6837\u6211\u4eec\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u6620\u5c04\u5373\u53ef\u8bbf\u95ee\u670d\u52a1\u4e86\u3002 \u53e6\u5916\u9700\u8981\u6ce8\u610f\u5728\u4e0a\u9762\u7684 Ingress \u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a nginx.ingress.kubernetes.io/service-upstream: true \u7684\u6ce8\u89e3\uff0c\u8fd9\u662f\u7528\u6765\u544a\u8bc9 Nginx Ingress Controller \u5c06\u6d41\u91cf\u8def\u7531\u5230\u7f51\u683c\u5e94\u7528\u7684\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u8def\u7531\u5230 Pod\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIngress \u63a7\u5236\u5668\u53ea\u662f\u67e5\u8be2\u5176\u76ee\u6807\u670d\u52a1\u7684\u7aef\u70b9\uff0c\u4ee5\u68c0\u7d22\u8be5\u670d\u52a1\u80cc\u540e\u7684 Pod \u7684 IP \u5730\u5740\u3002\u800c\u901a\u8fc7\u5411\u7f51\u683c\u670d\u52a1\u53d1\u9001\u6d41\u91cf\uff0cLinkerd \u7684\u76f8\u5173\u529f\u80fd\u5982\u8d1f\u8f7d\u5747\u8861\u548c\u6d41\u91cf\u62c6\u5206\u5219\u4f1a\u88ab\u542f\u7528\u3002","title":"\u5e26\u540d\u79f0"},{"location":"chap11/7linkered_ingress/#_3","text":"Linkerd policy \u8d44\u6e90\u53ef\u7528\u4e8e\u9650\u5236\u54ea\u4e9b\u5ba2\u6237\u7aef\u53ef\u4ee5\u8bbf\u95ee\u670d\u52a1\u3002\u540c\u6837\u6211\u4eec\u8fd8\u662f\u4f7f\u7528 Emojivoto \u5e94\u7528\u6765\u5c55\u793a\u5982\u4f55\u9650\u5236\u5bf9 Voting \u5fae\u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4f7f\u5176\u53ea\u80fd\u4ece Web \u670d\u52a1\u4e2d\u8c03\u7528\u3002 \u6211\u4eec\u9996\u5148\u4e3a Voting \u670d\u52a1\u521b\u5efa\u4e00\u4e2a Server \u8d44\u6e90\uff0cServer \u662f Linkerd \u7684\u53e6\u5916\u4e00\u4e2a CRD \u81ea\u5b9a\u4e49\u8d44\u6e90\uff0c\u5b83\u7528\u4e8e\u63cf\u8ff0\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7279\u5b9a\u7aef\u53e3 \u3002\u4e00\u65e6 Server \u8d44\u6e90\u88ab\u521b\u5efa\uff0c\u53ea\u6709\u88ab\u6388\u6743\u7684\u5ba2\u6237\u7aef\u624d\u80fd\u8bbf\u95ee\u5b83\u3002 \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a # voting-server.yaml apiVersion: policy.linkerd.io/v1beta1 kind: Server metadata: name: voting-grpc namespace: emojivoto labels: app: voting-svc spec: podSelector: matchLabels: app: voting-svc port: grpc proxyProtocol: gRPC \u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a $ kubectl apply -f voting-server.yaml server.policy.linkerd.io/voting-grpc created $ kubectl get server -n emojivoto NAME PORT PROTOCOL voting-grpc grpc gRPC \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8be5 Server \u4f7f\u7528\u4e86\u4e00\u4e2a podSelector \u5c5e\u6027\u6765\u9009\u62e9\u5b83\u6240\u63cf\u8ff0\u7684 Voting \u670d\u52a1\u7684 Pod\uff0c\u5b83\u8fd8\u6307\u5b9a\u4e86\u5b83\u9002\u7528\u7684\u547d\u540d\u7aef\u53e3 (grpc)\uff0c\u6700\u540e\u6307\u5b9a\u5728\u6b64\u7aef\u53e3\u4e0a\u63d0\u4f9b\u670d\u52a1\u7684\u534f\u8bae\u4e3a gRPC \uff0c \u8fd9\u53ef\u786e\u4fdd\u4ee3\u7406\u6b63\u786e\u5904\u7406\u6d41\u91cf\u5e76\u5141\u8bb8\u5b83\u8df3\u8fc7\u534f\u8bae\u68c0\u6d4b\u3002 \u73b0\u5728\u6ca1\u6709\u5ba2\u6237\u7aef\u88ab\u6388\u6743\u8bbf\u95ee\u6b64\u670d\u52a1\uff0c\u6b63\u5e38\u4f1a\u770b\u5230\u6210\u529f\u7387\u6709\u6240\u4e0b\u964d\uff0c \u56e0\u4e3a\u4ece Web \u670d\u52a1\u5230 Voting \u7684\u8bf7\u6c42\u5f00\u59cb\u88ab\u62d2\u7edd\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b Web \u670d\u52a1\u7684 Pod \u65e5\u5fd7\u6765\u9a8c\u8bc1\uff1a $ kubectl logs -f web-svc-2-f9d77474f-vxlrh -n emojivoto -c web-svc-2 2022/09/06 09:31:27 Error serving request [&{GET /api/vote?choice=:trophy: HTTP/1.1 1 1 map[Accept-Encoding:[gzip] L5d-Client-Id:[default.emojivoto.serviceaccount.identity.linkerd.cluster.local] L5d-Dst-Canonical:[web-apex.emojivoto.svc.cluster.local:80] User-Agent:[Go-http-client/1.1] X-B3-Sampled:[1] X-B3-Spanid:[f9e1dc6e24803ea8] X-B3-Traceid:[5ae662deee8fdbf2f3b9eaa40eb673d5]] {} <nil> 0 [] false web-apex.emojivoto:80 map[choice:[:trophy:]] map[] <nil> map[] 10.244.1.87:51244 /api/vote?choice=:trophy: <nil> <nil> <nil> 0xc00045e4b0}]: rpc error: code = PermissionDenied desc = unauthorized connection on server voting-grpc # ...... \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd viz authz \u547d\u4ee4\u67e5\u770b\u8fdb\u5165 Voting \u670d\u52a1\u7684\u8bf7\u6c42\u7684\u6388\u6743\u72b6\u6001\uff1a $ linkerd viz authz -n emojivoto deploy/voting SERVER AUTHZ SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 voting-grpc [UNAUTHORIZED] - 0.9rps \u53ef\u4ee5\u770b\u5230\u6240\u6709\u4f20\u5165\u7684\u8bf7\u6c42\u5f53\u524d\u90fd\u5904\u4e8e\u672a\u7ecf\u6388\u6743\u72b6\u6001\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u4e3a\u5ba2\u6237\u7aef\u6765\u6388\u4e88\u8bbf\u95ee\u8be5 Server \u7684\u6743\u9650\uff0c\u8fd9\u91cc\u9700\u8981\u4f7f\u7528\u5230\u53e6\u5916\u4e00\u4e2a CRD \u5bf9\u8c61 ServerAuthorization\uff0c\u521b\u5efa\u8be5\u5bf9\u8c61\u6765\u6388\u4e88 Web \u670d\u52a1\u8bbf\u95ee\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u7684 Voting Server \u7684\u6743\u9650\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a # voting-server-auth.yaml apiVersion: policy.linkerd.io/v1beta1 kind: ServerAuthorization metadata: name: voting-grpc namespace: emojivoto spec: server: name: voting-grpc # \u5173\u8054 Server \u5bf9\u8c61 # The voting service only allows requests from the web service. client: meshTLS: serviceAccounts: - name: web - name: web-2 \u4e0a\u9762\u5bf9\u8c61\u4e2d\u901a\u8fc7 spec.server.name \u6765\u5173\u8054\u4e0a\u9762\u7684 Server \u5bf9\u8c61\uff0c\u7531\u4e8e meshTLS \u4f7f\u7528 ServiceAccounts \u4f5c\u4e3a\u8eab\u4efd\u57fa\u7840\uff0c\u56e0\u6b64\u6211\u4eec\u7684\u6388\u6743\u4e5f\u5c06\u57fa\u4e8e ServiceAccounts \uff0c\u6240\u4ee5\u901a\u8fc7 spec.client.meshTLS.serviceAccounts \u6765\u6307\u5b9a\u5141\u8bb8\u4ece\u54ea\u4e9b\u670d\u52a1\u6765\u8bbf\u95ee Voting \u670d\u52a1\u3002 \u540c\u6837\u76f4\u63a5\u5e94\u7528\u8be5\u8d44\u6e90\u6e05\u5355\u5373\u53ef\uff1a $ kubectl apply -f voting-server-auth.yaml serverauthorization.policy.linkerd.io/voting-grpc created $ kubectl get serverauthorization -n emojivoto NAME SERVER voting-grpc voting-grpc \u6709\u4e86\u8fd9\u4e2a\u5bf9\u8c61\u540e\uff0c\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u770b\u5230\u6240\u6709\u5bf9 Voting \u670d\u52a1\u7684\u8bf7\u6c42\u90fd\u662f\u7531 voting-grpc \u8fd9\u4e2a ServerAuthorization \u6388\u6743\u7684\u3002\u8bf7\u6ce8\u610f\uff0c\u7531\u4e8e linkerd viz auth \u547d\u4ee4\u5728\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\u5185\u67e5\u8be2\uff0c\u6240\u4ee5\u53ef\u80fd\u4f1a\u770b\u5230\u4e00\u4e9b\u672a\u6388\u6743(UNAUTHORIZED)\u7684\u8bf7\u6c42\u5728\u77ed\u65f6\u95f4\u5185\u663e\u793a\u3002 $ linkerd viz authz -n emojivoto deploy/voting SERVER AUTHZ SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 voting-grpc voting-grpc 84.48% 1.0rps 1ms 1ms 1ms \u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a gRPC \u5ba2\u6237\u7aef Pod \u6765\u5c1d\u8bd5\u4ece\u4e2d\u8bbf\u95ee Voting \u670d\u52a1\u6d4b\u8bd5\u6765\u81ea\u5176\u4ed6 Pod \u7684\u8bf7\u6c42\u662f\u5426\u4f1a\u88ab\u62d2\u7edd\uff1a $ kubectl run grpcurl --rm -it --image=networld/grpcurl --restart=Never --command -- ./grpcurl -plaintext voting-svc.emojivoto:8080 emojivoto.v1.VotingService/VoteDog If you don't see a command prompt, try pressing enter. Error attaching, falling back to logs: unable to upgrade connection: container grpcurl not found in pod grpcurl_default Error invoking method \"emojivoto.v1.VotingService/VoteDog\": failed to query for service descriptor \"emojivoto.v1.VotingService\": rpc error: code = PermissionDenied desc = pod \"grpcurl\" deleted pod default/grpcurl terminated (Error)` \u7531\u4e8e\u8be5 client \u672a\u7ecf\u6388\u6743\uff0c\u6240\u4ee5\u8be5\u8bf7\u6c42\u5c06\u88ab\u62d2\u7edd\u5e76\u663e\u793a PermissionDenied \u9519\u8bef\u3002 \u6211\u4eec\u53ef\u4ee5\u6839\u636e\u9700\u8981\u521b\u5efa\u4efb\u610f\u6570\u91cf\u7684 ServerAuthorization \u8d44\u6e90\u6765\u6388\u6743\u8bb8\u591a\u4e0d\u540c\u7684\u5ba2\u6237\u7aef\uff0c\u8fd8\u53ef\u4ee5\u6307\u5b9a\u662f\u6388\u6743\u672a\u7ecf\u8eab\u4efd\u9a8c\u8bc1\uff08\u5373 unmeshed\uff09\u7684\u5ba2\u6237\u7aef\u3001\u4efb\u4f55\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u5ba2\u6237\u7aef\uff0c\u8fd8\u662f\u4ec5\u6388\u6743\u5177\u6709\u7279\u5b9a\u8eab\u4efd\u7684\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u5ba2\u6237\u7aef\u3002 \u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u4e3a\u6574\u4e2a\u96c6\u7fa4\u8bbe\u7f6e\u4e00\u4e2a\u9ed8\u8ba4\u7b56\u7565\uff0c\u8be5\u7b56\u7565\u5c06\u5e94\u7528\u4e8e\u6240\u6709\u672a\u5b9a\u4e49 Server \u8d44\u6e90\u7684\u3002Linkerd \u5728\u51b3\u5b9a\u662f\u5426\u5141\u8bb8\u8bf7\u6c42\u65f6\u4f1a\u4f7f\u7528\u4ee5\u4e0b\u903b\u8f91\uff1a \u5982\u679c\u6709\u4e00\u4e2a Server \u8d44\u6e90\u5e76\u4e14\u5ba2\u6237\u7aef\u4e3a\u5176\u5339\u914d\u4e00\u4e2a ServerAuthorization \u8d44\u6e90\uff0c\u5219\u4e3a ALLOW \u5982\u679c\u6709\u4e00\u4e2a Server \u8d44\u6e90\uff0c\u4f46\u5ba2\u6237\u7aef\u4e0d\u5339\u914d\u5b83\u7684\u4efb\u4f55 ServerAuthorizations\uff0c\u5219\u4e3a DENY \u5982\u679c\u7aef\u53e3\u6ca1\u6709 Server \u8d44\u6e90\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7b56\u7565 \u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 linkerd upgrade \u547d\u4ee4\u5c06\u9ed8\u8ba4\u7b56\u7565\u8bbe\u7f6e\u4e3a deny\uff1a $ linkerd upgrade --set policyController.defaultAllowPolicy=deny | kubectl apply -f - \u53e6\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e config.linkerd.io/default-inbound-policy \u6ce8\u89e3\uff0c\u53ef\u4ee5\u5728\u5355\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6216\u547d\u540d\u7a7a\u95f4\u4e0a\u8bbe\u7f6e\u9ed8\u8ba4\u7b56\u7565 \u3002 \u610f\u601d\u5c31\u662f\u9664\u975e\u901a\u8fc7\u521b\u5efa Server \u548c ServerAuthorization \u5bf9\u8c61\u660e\u786e\u6388\u6743\uff0c\u5426\u5219\u6240\u6709\u8bf7\u6c42\u90fd\u5c06\u88ab\u62d2\u7edd\uff0c\u8fd9\u6837\u7684\u8bdd\u5bf9\u4e8e liveness \u548c readiness \u63a2\u9488\u9700\u8981\u660e\u786e\u6388\u6743\uff0c\u5426\u5219 Kubernetes \u5c06\u65e0\u6cd5\u5c06 Pod \u8bc6\u522b\u4e3a live \u6216 ready \u72b6\u6001\uff0c\u5e76\u5c06\u91cd\u65b0\u542f\u52a8\u5b83\u4eec\u3002 \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u7b56\u7565\u5bf9\u8c61\uff0c\u6765\u5141\u8bb8\u6240\u6709\u5ba2\u6237\u7aef\u8bbf\u95ee Linkerd admin \u7aef\u53e3\uff0c\u4ee5\u4fbf Kubernetes \u53ef\u4ee5\u6267\u884c liveness \u548c readiness \u68c0\u67e5\uff1a $ cat << EOF | kubectl apply -f - --- # Server \"admin\": matches the admin port for every pod in this namespace apiVersion: policy.linkerd.io/v1beta1 kind: Server metadata: namespace: emojivoto name: admin spec: port: linkerd-admin podSelector: matchLabels: {} # every pod proxyProtocol: HTTP/1 --- # ServerAuthorization \"admin-everyone\": allows unauthenticated access to the # \"admin\" Server, so that Kubernetes health checks can get through. apiVersion: policy.linkerd.io/v1beta1 kind: ServerAuthorization metadata: namespace: emojivoto name: admin-everyone spec: server: name: admin client: unauthenticated: true ization \u9650\u5236\u4e3a\u8fd9\u4e9b IP \u5730\u5740\u6216\u8303\u56f4\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u77e5\u9053 Kubelet \u5728 10.244.0.1 \u4e0a\u8fd0\u884c\uff0c\u90a3\u4e48\u4f60\u7684 ServerAuthorization \u53ef\u4ee5\u6539\u4e3a\uff1a # ServerAuthorization \"admin-kublet\": allows unauthenticated access to the # \"admin\" Server from the kubelet, so that Kubernetes health checks can get through. apiVersion: policy.linkerd.io/v1beta1 kind: ServerAuthorization metadata: namespace: emojivoto name: admin-kubelet spec: server: name: admin client: networks: - cidr: 10.244.0.1/32 unauthenticated: true \u53e6\u5916\u6709\u4e00\u4e2a\u503c\u5f97\u6ce8\u610f\u7684\u662f\u5728\u6211\u4eec\u521b\u5efa Server \u8d44\u6e90\u4e4b\u540e\uff0c\u4f46\u5728\u521b\u5efa ServerAuthorization \u4e4b\u524d\u6709\u4e00\u6bb5\u65f6\u95f4\uff0c\u6240\u6709\u8bf7\u6c42\u90fd\u88ab\u62d2\u7edd\u3002\u4e3a\u4e86\u907f\u514d\u5728\u5b9e\u65f6\u7cfb\u7edf\u4e2d\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u5efa\u8bae\u4f60\u5728\u90e8\u7f72\u670d\u52a1\u4e4b\u524d\u521b\u5efa policy \u8d44\u6e90\uff0c\u6216\u8005\u5728\u521b\u5efa Server \u4e4b\u524d\u521b\u5efa ServiceAuthorizations\uff0c\u4ee5\u4fbf\u7acb\u5373\u6388\u6743\u5ba2\u6237\u7aef\u3002 \u5173\u4e8e\u6388\u6743\u7b56\u7565\u7684\u66f4\u591a\u4f7f\u7528\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 https://linkerd.io/2.11/reference/authorization-policy/ \u4ee5\u4e86\u89e3\u66f4\u591a\u76f8\u5173\u4fe1\u606f\u3002","title":"\u9650\u5236\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee"},{"location":"chap11/8linkerd_212/","text":"8 Linkerd \u5347\u7ea7\u5230\u5168\u65b0\u7684 2.12 \u7248\u672c Linkerd \u6700\u65b0\u7684 2.12 \u7248\u672c\u5df2\u7ecf\u53d1\u5e03\u4e86\uff0c\u8fd9\u4e2a\u5e9e\u5927\u7684\u7248\u672c\u4e3a Linkerd \u5f15\u5165\u4e86\u57fa\u4e8e\u8def\u7531\u7684\u7b56\u7565\uff0c\u5141\u8bb8\u7528\u6237\u4ee5\u5b8c\u5168\u96f6\u4fe1\u4efb\u7684\u65b9\u5f0f\u5b9a\u4e49\u548c\u6267\u884c\u57fa\u4e8e HTTP \u8def\u7531\u7684\u6388\u6743\u7b56\u7565\u3002 \u8fd9\u4e9b\u7b56\u7565\u5efa\u7acb\u5728 Linkerd \u5f3a\u5927\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u4e4b\u4e0a\uff0c\u7531\u53cc\u5411 TLS \u4fdd\u62a4\uff0c\u5e76\u4f7f\u7528 Kubernetes \u65b0\u63a8\u51fa\u7684 Gateway API \u7684\u7c7b\u578b\u8fdb\u884c\u914d\u7f6e\u3002 \u66f4\u65b0\u65e5\u5fd7 Linkerd 2.12 \u662f\u91c7\u7528 Gateway API \u4f5c\u4e3a\u6838\u5fc3\u914d\u7f6e\u673a\u5236\u7684\u7b2c\u4e00\u6b65\u3002 \u867d\u7136\u8fd9\u4e2a API \u5bf9\u4e8e\u670d\u52a1\u7f51\u683c\u7528\u4f8b\u6765\u8bf4\u8fd8\u4e0d\u662f\u5b8c\u7f8e\u7684\uff0c\u4f46\u5b83\u4e3a\u8fd9\u4e2a\u7248\u672c\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f3a\u5927\u7684\u8d77\u70b9\uff0c\u66f4\u91cd\u8981\u7684\u662f\uff0c\u5728 Gateway API \u7684\u57fa\u7840\u4e0a\u6784\u5efa\u5c06\u4f7f\u6211\u4eec\u80fd\u591f\u5c06\u7279\u5b9a\u4e8e Linkerd \u7684\u914d\u7f6e\u5bf9\u8c61\u7684\u6570\u91cf\u4fdd\u6301\u5728\u6700\u4f4e\u9650\u5ea6\uff0c\u5373\u4f7f\u6211\u4eec\u5f15\u5165\u4e86\u65b0\u529f\u80fd\u3002 \u8fd9\u662f\u6211\u4eec\u4e3a Kubernetes \u6210\u4e3a\u6700\u7b80\u5355\u548c\u6700\u8f7b\u91cf\u7684\u670d\u52a1\u7f51\u683c\u7684\u76ee\u6807\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002 \u6b64\u5916 2.12 \u7248\u672c\u8fd8\u5f15\u5165\u4e86\u8bbf\u95ee\u65e5\u5fd7\u8bb0\u5f55\uff0c\u8fd9\u662f\u4e00\u4e2a\u671f\u5f85\u5df2\u4e45\u7684\u529f\u80fd\uff0c\u5141\u8bb8 Linkerd \u751f\u6210 Apache \u6837\u5f0f\u7684\u8bf7\u6c42\u65e5\u5fd7\u3002\u5b83\u589e\u52a0\u4e86\u5bf9 iptables-nft \u7684\u652f\u6301\uff0c\u5e76\u5f15\u5165\u4e86\u8bb8\u591a\u5176\u4ed6\u6539\u8fdb\u548c\u6027\u80fd\u589e\u5f3a\u3002 Per-route \u7b56\u7565 Linkerd \u7684\u65b0\u7684 per-route \u7b56\u7565\u6269\u5c55\u4e86\u73b0\u6709\u7684\u57fa\u4e8e\u7aef\u53e3\u7684\u7b56\u7565\uff0c\u5bf9\u670d\u52a1\u5982\u4f55\u88ab\u5141\u8bb8\u76f8\u4e92\u901a\u4fe1\u8fdb\u884c\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\u3002 \u8fd9\u4e9b\u7b56\u7565\u662f\u4e3a\u91c7\u53d6\u96f6\u4fe1\u4efb\u5b89\u5168\u65b9\u6cd5\u7684\u7ec4\u7ec7\u8bbe\u8ba1\u7684\uff0c\u8fd9\u79cd\u65b9\u6cd5\u4e0d\u4ec5\u9700\u8981\u52a0\u5bc6\uff0c\u8fd8\u9700\u8981\u5f3a\u5927\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u548c\u660e\u786e\u7684\u6388\u6743\u3002 \u5c06\u7f51\u7edc\u89c6\u4e3a\u5bf9\u6297\u6027\u7684 \uff1a\u5b83\u4eec\u4e0d\u4f9d\u8d56 IP \u5730\u5740\uff0c\u4e5f\u4e0d\u8981\u6c42 CNI \u5c42\u6216\u5e95\u5c42\u7f51\u7edc\u7684\u4efb\u4f55\u5176\u4ed6\u65b9\u9762\u662f\u5b89\u5168\u7684\u3002 \u4f7f\u7528\u5b89\u5168\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd \uff1aLinkerd \u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u662f\u7531 ServiceAccounts \u81ea\u52a8\u751f\u6210\u7684\uff0c\u5e76\u5728\u8fde\u63a5\u65f6\u901a\u8fc7\u53cc\u5411 TLS \u8fdb\u884c\u52a0\u5bc6\u9a8c\u8bc1\u3002 \u5728 Pod \u7ea7\u522b\u4e0a\u5f3a\u5236\u6267\u884c \uff1a\u6bcf\u4e2a\u8fde\u63a5\u548c\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u7ecf\u8fc7\u9a8c\u8bc1\u3002 \u5f88\u5bb9\u6613\u7684\u5141\u8bb8\u6a21\u5f0f \uff1a\u6709\u5b89\u5168\u610f\u8bc6\u7684\u91c7\u7528\u8005\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u9ed8\u8ba4\u62d2\u7edd\u5bf9\u654f\u611f\u8d44\u6e90\u7684\u8bbf\u95ee\uff0c\u9664\u975e\u660e\u786e\u5141\u8bb8\uff08\"\u6700\u5c0f\u7279\u6743\u539f\u5219\"\uff09\u3002 \u9ed8\u8ba4\u62d2\u7edd\u914d\u7f6e\u5728 Kubernetes \u4e2d\u53ef\u80fd\u4f1a\u6709\u4e00\u4e9b\u95ee\u9898\uff0c\u56e0\u4e3a health \u548c readiness \u63a2\u9488\u72b6\u6001\u9700\u8981\u5728\u6ca1\u6709\u6388\u6743\u7684\u60c5\u51b5\u4e0b\u901a\u8fc7\u3002 \u5728 Linkerd 2.12 \u4e2d\uff0chealth \u548c readiness \u72b6\u6001\u63a2\u6d4b\u73b0\u5728\u662f\u9ed8\u8ba4\u6388\u6743\u7684\uff0c\u4f46\u4e5f\u53ef\u4ee5\u660e\u786e\u6388\u6743\uff0c\u540c\u65f6\u4ecd\u7136\u9501\u5b9a\u5176\u4ed6\u5e94\u7528\u7aef\u70b9\u3002 Gateway API Linkerd 2.12 \u63d0\u4f9b\u4e86\u652f\u6301 Kubernetes Gateway API \u7684\u7b2c\u4e00\u6b65\u3002\u867d\u7136 Gateway API \u6700\u521d\u662f\u4f5c\u4e3a Kubernetes \u4e2d\u957f\u671f\u5b58\u5728\u7684 Ingress \u8d44\u6e90\u7684\u4e00\u4e2a\u66f4\u4e30\u5bcc\u3001\u66f4\u7075\u6d3b\u7684\u66ff\u4ee3\u54c1\u800c\u8bbe\u8ba1\u7684\uff0c\u4f46\u5b83\u4e3a\u63cf\u8ff0\u670d\u52a1\u7f51\u72b6\u6d41\u91cf\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f88\u597d\u7684\u57fa\u7840\uff0c\u5e76\u5141\u8bb8 Linkerd \u5c06\u5176\u589e\u52a0\u7684\u914d\u7f6e\u4fdd\u6301\u5728\u6700\u4f4e\u6c34\u5e73\u3002 \u5728 Linkerd 2.12 \u4e2d\uff0cLinkerd \u63d0\u4f9b\u4e86 Gateway API \u7684\u90e8\u5206\u5b9e\u73b0\u6765\u914d\u7f6e Linkerd \u7684\u57fa\u4e8e\u8def\u7531\u7684\u7b56\u7565\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5f00\u59cb\u4f7f\u7528 Gateway API\uff0c\u800c\u4e0d\u7528\u5b9e\u73b0\u89c4\u8303\u4e2d\u5bf9 Linkerd \u6ca1\u6709\u610f\u4e49\u7684\u90e8\u5206\u3002\u968f\u7740 Gateway API \u7684\u53d1\u5c55\uff0c\u4e5f\u4f1a\u6162\u6162\u5730\u66f4\u597d\u6ee1\u8db3 Linkerd \u7684\u9700\u6c42\u3002 \u8bbf\u95ee\u65e5\u5fd7 Linkerd 2.12 \u8fd8\u5f15\u5165\u4e86\u8bbf\u95ee\u65e5\u5fd7\u8bb0\u5f55\uff0c\u5b83\u5141\u8bb8\u4ee3\u7406\u53d1\u51fa Apache \u6837\u5f0f\u7684\u8bf7\u6c42\u65e5\u5fd7\u3002\u51fa\u4e8e\u6027\u80fd\u548c\u8d44\u6e90\u5229\u7528\u7387\u7684\u539f\u56e0\uff0c\u6b64\u529f\u80fd\u9ed8\u8ba4\u5173\u95ed\uff08\u5c24\u5176\u662f\u5bf9\u4e8e\u9ad8\u6d41\u91cf\u5de5\u4f5c\u8d1f\u8f7d\uff09\uff0c\u4f46\u4e5f\u53ef\u4ee5\u5728\u9700\u8981\u5b83\u7684\u60c5\u51b5\u4e0b\u8f7b\u677e\u542f\u7528\u3002 \u5176\u4ed6\u66f4\u65b0 Linkerd 2.12 \u8fd8\u6709\u5927\u91cf\u7684\u5176\u4ed6\u6539\u8fdb\u3001\u6027\u80fd\u63d0\u5347\u548c\u9519\u8bef\u4fee\u590d\uff0c\u5305\u62ec\uff1a \u4e00\u4e2a\u65b0\u7684 config.linkerd.io/shutdown-grace-period \u6ce8\u89e3\uff0c\u7528\u4e8e\u914d\u7f6e\u4ee3\u7406\u7684\u6700\u5927\u5bbd\u9650\u671f\uff0c\u4ee5\u4fbf\u4f18\u96c5\u5730\u5173\u95ed\u3002 \u4e00\u4e2a\u65b0\u7684 iptables-nft \u6a21\u5f0f\uff0c\u7528\u4e8e Linkerd \u7684 init \u5bb9\u5668\u4e2d\u7684 iptables-nft \u652f\u6301\u3002 \u4fee\u590d\u4e86\u67d0\u4e9b\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u5728\u4fe1\u4efb\u6839\u8f6e\u6362\u540e\u672a\u6309\u8981\u6c42\u91cd\u542f\u7684\u95ee\u9898\u3002 \u4fee\u6b63\u4e86\u5f53\u5728 Linkerd \u547d\u540d\u7a7a\u95f4\u4e2d\u53d1\u73b0\u610f\u5916\u7684 Pod \u65f6\uff0c linkerd check \u547d\u4ee4\u5d29\u6e83\u7684\u95ee\u9898\u3002 \u4fee\u6539\u4e86 proxy.await \u7684 Helm \u503c\uff0c\u8fd9\u6837\u7528\u6237\u5c31\u53ef\u4ee5\u5728\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u4e0a\u7981\u7528 linkerd-await\u3002 \u6ce8\u91ca\uff0c\u5141\u8bb8 Linkerd \u6269\u5c55\u90e8\u7f72\u5728\u5fc5\u8981\u65f6\u88ab\u81ea\u52a8\u7f29\u653e\u5668\u9a71\u9010\u3002 \u80fd\u591f\u5728\u72ec\u7acb\u6a21\u5f0f\u4e0b\u8fd0\u884c Linkerd CNI \u63d2\u4ef6\u3002 \u591a\u96c6\u7fa4\u6269\u5c55\u4e2d\u7684 ServiceAccount token Secret \uff0c\u652f\u6301 Kubernetes \u7248\u672c >= v1.24 \u3002 \u5347\u7ea7 \u73b0\u5728\u6211\u4eec\u5c06\u96c6\u7fa4\u4e2d\u7684 Linkerd \u5347\u7ea7\u5230\u6700\u65b0\u7684 2.12 \u7248\u672c\u3002 \u9996\u5148\u9700\u8981\u66f4\u65b0 Linkerd CLI \u5de5\u5177\uff0c\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u5373\u53ef\uff1a $ curl --proto '=https' --tlsv1.2 -sSfL https://run.linkerd.io/install | sh \u8fd9\u4f1a\u5c06\u4f60\u7684\u672c\u5730 CLI \u5347\u7ea7\u5230\u6700\u65b0\u7248\u672c\u3002\u5f53\u7136\u6211\u4eec\u6709\u53ef\u4ee5\u901a\u8fc7 Linkerd \u7684 Release \u9875\u9762\u76f4\u63a5\u4e0b\u8f7d\u5bf9\u5e94\u5e73\u53f0\u7684 CLI \u5b89\u88c5\u5305\u3002 $ wget https://github.91chi.fun/https://github.com//linkerd/linkerd2/releases/download/stable-2.12.0/linkerd2-cli-stable-2.12.0-darwin-arm64 $ sudo mv linkerd2-cli-stable-2.12.0-darwin-arm64 /usr/local/bin/linkerd $ chmod +x /usr/local/bin/linkerd \u9a8c\u8bc1 CLI \u5df2\u5b89\u88c5\u5e76\u6b63\u786e\u8fd0\u884c\uff1a $ linkerd version Client version: stable-2.12.0 Server version: stable-2.11.1 \u53ef\u4ee5\u770b\u5230 CLI \u5347\u7ea7\u6210\u529f\u4e86\uff0c\u7531\u4e8e \u63a7\u5236\u5e73\u9762\u8fd8\u6ca1\u5347\u7ea7 \uff0c\u6240\u4ee5\u770b\u5230\u7684\u8fd8\u662f\u73b0\u5728\u7684 2.11.1 \u7248\u672c\u3002 \u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u5347\u7ea7 Kubernetes \u96c6\u7fa4\u4e0a\u7684 Linkerd \u63a7\u5236\u5e73\u9762\u4e86\uff0c\u4e0d\u7528\u62c5\u5fc3\uff0c\u73b0\u6709\u7684\u6570\u636e\u5e73\u9762\u5c06\u7ee7\u7eed\u4f7f\u7528\u66f4\u65b0\u7248\u672c\u7684\u63a7\u5236\u5e73\u9762\u8fd0\u884c\uff0c\u5e76\u4e14\u4f60\u7684\u7f51\u683c\u670d\u52a1\u4e0d\u4f1a\u51fa\u73b0\u6545\u969c\u3002 \u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f viz \u63d2\u4ef6\u81ea\u5e26\u7684 Prometheus \u7ec4\u4ef6\uff0c\u90a3\u4e48\u5347\u7ea7\u540e\u6570\u636e\u4f1a\u4e22\u5931\uff0c\u5982\u679c\u4f60\u914d\u7f6e\u7684\u5916\u7f6e\u7684 Prometheus \u5219\u4e0d\u7528\u62c5\u5fc3\u8be5\u95ee\u9898\u3002 Linkerd SMI \u6269\u5c55 \u5982\u679c\u4f60\u4f7f\u7528 CLI \u5b89\u88c5\u4e86 Linkerd 2.11.x\uff0c\u5e76\u4e14\u6b63\u5728\u4f7f\u7528 TrafficSplit CRD\uff0c\u5219\u9700\u8981\u6ce8\u610f\u4e22\u5931 TS \u7684 CR\uff0c\u5982\u679c\u4f60\u4e0d\u4f7f\u7528\u6b64 CRD\uff0c\u5219\u53ef\u4ee5\u5ffd\u7565\u8be5\u6ce8\u610f\u4e8b\u9879\u3002 TrafficSplit CRD \u4e0d\u518d\u968f Linkerd 2.12.0 \u63d0\u4f9b\uff0c\u800c\u662f\u7531 Linkerd SMI \u6269\u5c55\u63d0\u4f9b \u3002 \u540c\u6837\u9996\u5148\u4ece Release \u9875\u9762\u4e0b\u8f7d\u5bf9\u5e94\u7684\u53ef\u6267\u884c\u5305\uff1a $ wget https://github.91chi.fun/https://github.com//linkerd/linkerd-smi/releases/download/v0.2.0/linkerd-smi-0.2.0-darwin-arm64 $ chmod +x linkerd-smi-0.2.0-darwin-arm64 $ sudo mv linkerd-smi-0.2.0-darwin-arm64 /usr/local/bin/linkerd-smi $ linkerd-smi version v0.2.0 \u540c\u6837 Linkerd SMI \u4e5f\u53ef\u4ee5\u901a\u8fc7 CLI \u5de5\u5177\u8fdb\u884c\u5b89\u88c5\uff0c\u6b64\u6269\u5c55\u5305\u542b\u4e00\u4e2a SMI-Adaptor\uff0c\u5b83\u5c06 SMI \u8d44\u6e90\u8f6c\u6362\u4e3a\u672c\u5730 Linkerd \u8d44\u6e90 \u3002 $ linkerd smi install | kubectl apply -f - $ linkerd smi check \u6b64\u5916\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684 Helm \u65b9\u5f0f\u6765\u5b89\u88c5 Linkerd SMI \u6269\u5c55 \u3002\u4f46\u5728\u5b89\u88c5\u8be5\u6269\u5c55\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u5728 CRD \u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u6ce8\u91ca\u548c\u6807\u7b7e\uff0c\u4ee5\u4fbf linkerd-smi chart \u53ef\u4ee5\u91c7\u7528\u5b83\uff1a $ kubectl annotate --overwrite crd/trafficsplits.split.smi-spec.io \\ meta.helm.sh/release-name=linkerd-smi \\ meta.helm.sh/release-namespace=linkerd-smi # \u6dfb\u52a0smi repo\u4ed3\u5e93 $ helm repo add l5d-smi https://linkerd.github.io/linkerd-smi $ helm upgrade --install linkerd-smi -n linkerd-smi --create-namespace l5d-smi/linkerd-smi Release \"linkerd-smi\" has been upgraded. Happy Helming! NAME: linkerd-smi LAST DEPLOYED: Sun Sep 11 14:54:02 2022 NAMESPACE: linkerd-smi STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: The Linkerd SMI extension was successfully installed \ud83c\udf89 $ kubectl get pods -n linkerd-smi NAME READY STATUS RESTARTS AGE namespace-metadata--1-jnttx 0/1 Completed 0 17m smi-adaptor-5788b875d4-r4b7w 2/2 Running 6 (5m53s ago) 17m \u6700\u540e\uff0c\u4f60\u53ef\u4ee5\u7ee7\u7eed\u4f7f\u7528\u901a\u5e38\u7684 CLI \u5347\u7ea7\u8bf4\u660e\uff0c\u4f46\u5728\u5e94\u7528 linkerd upgrade --crds \u7684\u8f93\u51fa\u65f6\u907f\u514d\u4f7f\u7528 --prune \u6807\u5fd7\u4ee5\u907f\u514d\u5220\u9664 TrafficSplit CRD \uff01 \u5347\u7ea7 \u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5 \u76f4\u63a5\u4f7f\u7528 linkerd upgrade \u547d\u4ee4\u6765\u5347\u7ea7\u63a7\u5236\u5e73\u9762 \uff0c\u8be5\u547d\u4ee4\u786e\u4fdd\u63a7\u5236\u5e73\u9762\u7684\u6240\u6709\u73b0\u6709\u914d\u7f6e\u548c mTLS \u88ab\u4fdd\u7559\u4e0b\u6765\u3002 $ kubectl get crd |grep linkerd serverauthorizations.policy.linkerd.io 2022-08-19T04:06:33Z servers.policy.linkerd.io 2022-08-19T04:06:33Z serviceprofiles.linkerd.io 2022-08-19T04:06:33Z $ linkerd upgrade --crds | \\ kubectl apply --prune -l linkerd.io/control-plane-ns=linkerd \\ --prune-whitelist=apiextensions.k8s.io/v1/customresourcedefinition \\ --prune-whitelist=split.smi-spec.io/v1alpha2/trafficsplit \\ -f - customresourcedefinition.apiextensions.k8s.io/authorizationpolicies.policy.linkerd.io created customresourcedefinition.apiextensions.k8s.io/httproutes.policy.linkerd.io created customresourcedefinition.apiextensions.k8s.io/meshtlsauthentications.policy.linkerd.io created customresourcedefinition.apiextensions.k8s.io/networkauthentications.policy.linkerd.io created customresourcedefinition.apiextensions.k8s.io/serverauthorizations.policy.linkerd.io configured customresourcedefinition.apiextensions.k8s.io/servers.policy.linkerd.io configured customresourcedefinition.apiextensions.k8s.io/serviceprofiles.linkerd.io configured customresourcedefinition.apiextensions.k8s.io/trafficsplits.split.smi-spec.io configured \u6ce8\u610f\uff0c\u4e0a\u9762\u66f4\u65b0\u547d\u4ee4\u4e2d\u6211\u4eec\u4f7f\u7528\u4e86 --prune \u6807\u5fd7\uff0c\u8be5\u6807\u5fd7\u53ef\u4ee5\u5220\u9664\u5728\u65b0\u7248\u672c\u4e2d\u4e0d\u518d\u5b58\u5728\u7684\u524d\u4e00\u7248\u672c\u7684 Linkerd \u8d44\u6e90\uff0c\u4e0a\u9762\u6211\u4eec\u662f\u66f4\u65b0\u65b0\u7248\u672c\u7684 CRD \u8d44\u6e90\uff0c\u53ef\u4ee5\u770b\u5230\u65b0\u589e\u4e86 4 \u4e2a CRD \uff0c\u56e0\u4e3a\u73b0\u5728\u5f15\u5165\u4e86 Gateway API \u3002 $ kubectl get crd |grep linkerd authorizationpolicies.policy.linkerd.io 2022-09-11T02:56:13Z httproutes.policy.linkerd.io 2022-09-11T02:56:13Z meshtlsauthentications.policy.linkerd.io 2022-09-11T02:56:14Z networkauthentications.policy.linkerd.io 2022-09-11T02:56:14Z serverauthorizations.policy.linkerd.io 2022-08-19T04:06:33Z servers.policy.linkerd.io 2022-08-19T04:06:33Z serviceprofiles.linkerd.io 2022-08-19T04:06:33Z \u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u65b0\u589e\u7684 Gateway API \u76f8\u5173\u7684 CRD \u5e76\u4e0d\u662f\u539f\u59cb Kubernetes \u4e0b\u9762\u5b9a\u4e49\u7684\uff0c\u800c\u662f\u4e5f\u662f\u5728 policy.linkerd.io \u7684\u7ec4\u4e0b\u9762\uff0c\u8fd9\u662f\u56e0\u4e3a Linkerd \u5bf9\u8fd9\u4e9b CRD \u4e5f\u505a\u4e86\u4e00\u4e9b\u9002\u914d\u3002 \u63a5\u4e0b\u6765\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u66f4\u65b0\u63a7\u5236\u5e73\u9762\u8d44\u6e90\u5bf9\u8c61\uff1a $ linkerd upgrade | \\ kubectl apply --prune -l linkerd.io/control-plane-ns=linkerd -f - \u63a5\u4e0b\u6765\uff0c\u518d\u6b21\u8fd0\u884c\u6b64\u547d\u4ee4\u5e76\u6dfb\u52a0\u4e00\u4e9b --prune-whitelist \u6807\u5fd7\uff0c\u8fd9\u53ef\u4ee5\u786e\u4fdd\u6b63\u786e\u4fee\u526a\u67d0\u4e9b\u96c6\u7fa4\u8303\u56f4\u7684\u8d44\u6e90\u6240\u5fc5\u9700\u7684\u3002 $ linkerd upgrade | kubectl apply --prune -l linkerd.io/control-plane-ns=linkerd \\ --prune-whitelist=rbac.authorization.k8s.io/v1/clusterrole \\ --prune-whitelist=rbac.authorization.k8s.io/v1/clusterrolebinding \\ --prune-whitelist=apiregistration.k8s.io/v1/apiservice -f - \u5347\u7ea7\u8fc7\u7a0b\u5b8c\u6210\u540e\uff0c\u540c\u6837\u53ef\u4ee5\u8fd0\u884c\u68c0\u67e5\u547d\u4ee4\u6765\u786e\u4fdd\u4e00\u5207\u6b63\u5e38\uff1a $ linkerd check \u8be5\u547d\u4ee4\u5c06\u9488\u5bf9\u63a7\u5236\u5e73\u9762\u8fdb\u884c\u4e00\u7cfb\u5217\u68c0\u67e5\uff0c\u5e76\u786e\u4fdd\u5176\u6b63\u5e38\u8fd0\u884c\u3002 \u73b0\u5728\u518d\u6b21\u67e5\u770b Linkerd \u7248\u672c\uff0c\u6b63\u5e38 Server \u7aef\u7684\u7248\u672c\u4e5f\u66f4\u65b0\u4e86\u3002 $ linkerd version Client version: stable-2.12.0 Server version: stable-2.12.0 \u63a5\u7740\u6211\u4eec\u5c31\u53ef\u4ee5\u5347\u7ea7\u6570\u636e\u5e73\u9762\u4e86\uff0c\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u5728\u4f60\u7684\u670d\u52a1\u4e0a\u8fd0\u884c\u6eda\u52a8\u90e8\u7f72\uff0c\u5141\u8bb8\u4ee3\u7406\u6ce8\u5165\u5668\u5728\u5b83\u4eec\u51fa\u73b0\u65f6\u6ce8\u5165\u6700\u65b0\u7248\u672c\u7684\u4ee3\u7406\u3002 $ kubectl -n <namespace> rollout restart deploy \u4e00\u822c\u6765\u8bf4\u7a33\u5b9a\u7248\u7684\u63a7\u5236\u5e73\u9762\u4e0e\u4e0a\u4e00\u4e2a\u7a33\u5b9a\u7248\u7684\u6570\u636e\u5e73\u9762\u662f\u517c\u5bb9\u7684\uff0c\u6240\u4ee5\u6570\u636e\u5e73\u9762\u7684\u5347\u7ea7\u53ef\u4ee5\u5728\u63a7\u5236\u5e73\u9762\u5347\u7ea7\u540e\u7684\u4efb\u4f55\u65f6\u5019\u8fdb\u884c\uff0c\u4f46\u662f\u4e0d\u5efa\u8bae\u8d85\u8fc7\u4e00\u4e2a\u7a33\u5b9a\u7248\u672c\u7684\u5dee\u8ddd\u3002 \u540c\u6837\u66f4\u65b0\u5b8c\u6210\u540e\u53ef\u4ee5\u4f7f\u7528 check \u547d\u4ee4\u6765\u6821\u9a8c\u6570\u636e\u5e73\u9762\u72b6\u6001\u3002 $ linkerd check --proxy # ...... linkerd-data-plane ------------------ \u221a data plane namespace exists \u221a data plane proxies are ready \u203c data plane is up-to-date some proxies are not running the current version: * emoji-696d9d8f95-5vn9w (stable-2.11.1) * vote-bot-646b9fd6fd-8xj2j (stable-2.11.1) * voting-ff4c54b8d-xhjv7 (stable-2.11.1) * web-5f86686c4d-58p7k (stable-2.11.1) * web-svc-2-f9d77474f-vxlrh (stable-2.11.1) * ingress-nginx-controller-f56c7f6fd-rxhrs (stable-2.11.1) see https://linkerd.io/2.12/checks/#l5d-data-plane-version for hints \u203c data plane and cli versions match emoji-696d9d8f95-5vn9w running stable-2.11.1 but cli running stable-2.12.0 see https://linkerd.io/2.12/checks/#l5d-data-plane-cli-version for hints \u221a data plane pod labels are configured correctly \u221a data plane service labels are configured correctly \u221a data plane service annotations are configured correctly \u221a opaque ports are properly annotated Linkerd extensions checks ========================= - Running smi extension check \u8be5\u547d\u4ee4\u901a\u8fc7\u4e00\u7ec4\u68c0\u67e5\u6765\u9a8c\u8bc1\u6570\u636e\u5e73\u9762\u662f\u5426\u6b63\u5e38\u8fd0\u884c\uff0c\u5e76\u5c06\u5217\u51fa\u4ecd\u5728\u8fd0\u884c\u65e7\u7248\u672c\u4ee3\u7406\u7684 pod\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u53bb\u5347\u7ea7\u5bf9\u5e94\u7684 pod \u5373\u53ef\u3002 Linkerd Viz \u6269\u5c55 \u53e6\u5916\u8fd8\u6709\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u662f viz \u63d2\u4ef6\uff0c\u5728\u6700\u65b0\u7248\u672c\u4e2d\u5df2\u7ecf\u6ca1\u6709\u5185\u7f6e grafana \u4e86\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u5148\u76f4\u63a5\u5c06\u8be5\u63d2\u4ef6\u5378\u8f7d\u5e72\u51c0\uff08\u8be5\u63d2\u4ef6\u4e0d\u4f1a\u5f71\u54cd\u7f51\u683c\u7684\u6838\u5fc3\u529f\u80fd\uff09\uff0c\u7136\u540e\u91cd\u65b0\u5b89\u88c5\u6700\u65b0\u7248\u672c\u3002 $ linkerd viz install | kubectl delete -f - \u5378\u8f7d\u5b8c\u6210\u540e\u91cd\u65b0\u5b89\u88c5\uff0c\u7531\u4e8e\u65b0\u7248\u672c\u5df2\u7ecf\u6ca1\u6709\u5185\u7f6e Grafana \u4e86\uff0c\u6211\u4eec\u91cd\u65b0\u5b89\u88c5\u7684\u4f7f\u7528\u53ef\u4ee5\u901a\u8fc7 --set grafana.url \u6765\u6307\u5b9a\u5916\u90e8\u7684 Grafana \u5730\u5740\uff08\u5982\u679c\u662f\u96c6\u7fa4\u5916\u7684\u5730\u5740\u53ef\u4ee5\u901a\u8fc7 grafana.externalUrl \u53c2\u6570\u6307\u5b9a\uff09\uff0c\u540c\u6837\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5916\u90e8\u7684 Prometheus\uff1a $ linkerd viz install --set grafana.url=grafana:3000,prometheusUrl=http://prometheus.kube-mon.svc.cluster.local:9090,prometheus.enabled=false | kubectl apply -f - \u91cd\u65b0\u5b89\u88c5\u540e\u67e5\u770b viz \u7684 pod \u5217\u8868\uff1a $ kubectl get pods -n linkerd-viz NAME READY STATUS RESTARTS AGE metrics-api-674bf48d7f-kzr5b 2/2 Running 0 17m tap-67d6d8ff4d-q7nqn 2/2 Running 0 5m21s tap-injector-7c565f754-jgvc5 2/2 Running 0 5m20s web-87b958bcf-d5pfp 2/2 Running 0 5m20s \u53ef\u4ee5\u770b\u5230\u73b0\u5728\u6ca1\u6709\u4e86 Grafana \u548c Prometheus \u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u5bf9\u63a5\u7684\u5916\u90e8 Prometheus\uff0c\u800c Grafana \u5219\u662f\u65b0\u7248\u672c\u4e2d\u6ca1\u6709\u5185\u7f6e\u4f7f\u7528\u4e86\uff0c\u4e0a\u9762\u6211\u4eec\u6307\u5b9a\u7684 Grafana \u5730\u5740\u5728 viz \u540c\u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u624b\u52a8\u5b89\u88c5\u4e00\u4e2a\u5373\u53ef\u3002 \u5982\u679c\u5355\u4e2a Grafana \u5b9e\u4f8b\u6307\u5411\u591a\u4e2a Linkerd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u5176 UID \u4e2d\u7684\u4e0d\u540c\u524d\u7f00\u5206\u9694\u4eea\u8868\u677f\uff0c\u53ef\u4ee5\u5728\u6bcf\u4e2a Linkerd \u5b9e\u4f8b\u7684 grafana.uidPrefix \u8bbe\u7f6e\u4e2d\u914d\u7f6e\u8fd9\u4e9b\u524d\u7f00\u3002 \u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 Helm Chart \u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u5b9a\u5236\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a podAnnotations: linkerd.io/inject: enabled grafana.ini: server: root_url: \"%(protocol)s://%(domain)s:/grafana/\" auth: disable_login_form: true auth.anonymous: enabled: true org_role: Editor auth.basic: enabled: false analytics: check_for_updates: false panels: disable_sanitize_html: true log: mode: console log.console: format: text level: info datasources: datasources.yaml: apiVersion: 1 datasources: - name: prometheus type: prometheus access: proxy orgId: 1 url: http://prometheus.kube-mon.svc.cluster.local:9090 isDefault: true jsonData: timeInterval: \"5s\" editable: true dashboardProviders: dashboardproviders.yaml: apiVersion: 1 providers: - name: \"default\" orgId: 1 folder: \"\" type: file disableDeletion: false editable: true options: path: /var/lib/grafana/dashboards/default dashboards: default: # all these charts are hosted at https://grafana.com/grafana/dashboards/{id} top-line: gnetId: 15474 revision: 3 datasource: prometheus health: gnetId: 15486 revision: 2 datasource: prometheus kubernetes: gnetId: 15479 revision: 2 datasource: prometheus namespace: gnetId: 15478 revision: 2 datasource: prometheus deployment: gnetId: 15475 revision: 5 datasource: prometheus pod: gnetId: 15477 revision: 2 datasource: prometheus service: gnetId: 15480 revision: 2 datasource: prometheus route: gnetId: 15481 revision: 2 datasource: prometheus authority: gnetId: 15482 revision: 2 datasource: prometheus cronjob: gnetId: 15483 revision: 2 datasource: prometheus job: gnetId: 15487 revision: 2 datasource: prometheus daemonset: gnetId: 15484 revision: 2 datasource: prometheus replicaset: gnetId: 15491 revision: 2 datasource: prometheus statefulset: gnetId: 15493 revision: 2 datasource: prometheus replicationcontroller: gnetId: 15492 revision: 2 datasource: prometheus prometheus: gnetId: 15489 revision: 2 datasource: prometheus prometheus-benchmark: gnetId: 15490 revision: 2 datasource: prometheus multicluster: gnetId: 15488 revision: 2 datasource: prometheus \u4e0a\u9762\u7684 values \u6587\u4ef6\u4e2d\u6211\u4eec\u6ce8\u5165\u4e86 linkerd.io/inject: enabled \u8fd9\u4e2a\u6ce8\u89e3\uff0c\u4e3a\u5176\u6ce8\u5165 Linkerd \u7684 proxy\uff0c\u7136\u540e\u8fd8\u8981\u6ce8\u610f\u914d\u7f6e Prometheus \u6570\u636e\u6e90\u5730\u5740\u3002 $ helm repo add grafana https://grafana.github.io/helm-charts $ helm upgrade --install grafana -n linkerd-viz grafana/grafana -f values.yaml \u5982\u679c\u6211\u4eec\u5df2\u7ecf\u6709\u4e00\u4e2a\u5916\u90e8\u7684 Grafana\uff0c\u90a3\u4e48\u5728\u5b89\u88c5\u7684\u65f6\u5019\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 grafana.externalUrl \u6765\u6307\u5b9a\uff1a $ linkerd viz install --set grafana.externalUrl=http://192.168.0.106:30403,prometheusUrl=http://prometheus.kube-mon.svc.cluster.local:9090,prometheus.enabled=false | kubectl apply -f - \u8fd9\u6837\u66f4\u65b0\u540e\u8bb0\u5f97\u8981\u5728\u5916\u90e8 Grafana \u4e2d\u5bfc\u5165 Linkerd \u76f8\u5173\u7684 Dashboard\uff0c\u53ef\u4ee5\u4ece Grafana \u5b98\u7f51 https://grafana.com/orgs/linkerd \u83b7\u53d6\u3002 \u6bd4\u5982\u6211\u4eec\u5bfc\u5165 Deployments \u7684 dashboard\uff0c\u53ef\u4ee5\u5bfc\u5165 15475 \u8fd9\u4e2a ID\uff0c\u6216\u8005\u4e0b\u8f7d JSON \u6587\u4ef6\u4e0a\u4f20\u5bfc\u5165\u3002 \u5bfc\u5165\u540e\u91cd\u65b0\u8bbf\u95ee Viz \u7684 Dashboard\uff1a \u540c\u6837\u70b9\u51fb\u9875\u9762\u4e0a\u7684 Grafana \u56fe\u6807\u5c31\u53ef\u4ee5\u76f4\u63a5\u8df3\u8f6c\u5230 Grafana Dashboard \u9875\u9762\uff1a","title":"8 Linkerd \u5347\u7ea7\u5230\u5168\u65b0\u7684 2.12 \u7248\u672c"},{"location":"chap11/8linkerd_212/#8-linkerd-212","text":"Linkerd \u6700\u65b0\u7684 2.12 \u7248\u672c\u5df2\u7ecf\u53d1\u5e03\u4e86\uff0c\u8fd9\u4e2a\u5e9e\u5927\u7684\u7248\u672c\u4e3a Linkerd \u5f15\u5165\u4e86\u57fa\u4e8e\u8def\u7531\u7684\u7b56\u7565\uff0c\u5141\u8bb8\u7528\u6237\u4ee5\u5b8c\u5168\u96f6\u4fe1\u4efb\u7684\u65b9\u5f0f\u5b9a\u4e49\u548c\u6267\u884c\u57fa\u4e8e HTTP \u8def\u7531\u7684\u6388\u6743\u7b56\u7565\u3002 \u8fd9\u4e9b\u7b56\u7565\u5efa\u7acb\u5728 Linkerd \u5f3a\u5927\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u4e4b\u4e0a\uff0c\u7531\u53cc\u5411 TLS \u4fdd\u62a4\uff0c\u5e76\u4f7f\u7528 Kubernetes \u65b0\u63a8\u51fa\u7684 Gateway API \u7684\u7c7b\u578b\u8fdb\u884c\u914d\u7f6e\u3002","title":"8 Linkerd \u5347\u7ea7\u5230\u5168\u65b0\u7684 2.12 \u7248\u672c"},{"location":"chap11/8linkerd_212/#_1","text":"Linkerd 2.12 \u662f\u91c7\u7528 Gateway API \u4f5c\u4e3a\u6838\u5fc3\u914d\u7f6e\u673a\u5236\u7684\u7b2c\u4e00\u6b65\u3002 \u867d\u7136\u8fd9\u4e2a API \u5bf9\u4e8e\u670d\u52a1\u7f51\u683c\u7528\u4f8b\u6765\u8bf4\u8fd8\u4e0d\u662f\u5b8c\u7f8e\u7684\uff0c\u4f46\u5b83\u4e3a\u8fd9\u4e2a\u7248\u672c\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f3a\u5927\u7684\u8d77\u70b9\uff0c\u66f4\u91cd\u8981\u7684\u662f\uff0c\u5728 Gateway API \u7684\u57fa\u7840\u4e0a\u6784\u5efa\u5c06\u4f7f\u6211\u4eec\u80fd\u591f\u5c06\u7279\u5b9a\u4e8e Linkerd \u7684\u914d\u7f6e\u5bf9\u8c61\u7684\u6570\u91cf\u4fdd\u6301\u5728\u6700\u4f4e\u9650\u5ea6\uff0c\u5373\u4f7f\u6211\u4eec\u5f15\u5165\u4e86\u65b0\u529f\u80fd\u3002 \u8fd9\u662f\u6211\u4eec\u4e3a Kubernetes \u6210\u4e3a\u6700\u7b80\u5355\u548c\u6700\u8f7b\u91cf\u7684\u670d\u52a1\u7f51\u683c\u7684\u76ee\u6807\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002 \u6b64\u5916 2.12 \u7248\u672c\u8fd8\u5f15\u5165\u4e86\u8bbf\u95ee\u65e5\u5fd7\u8bb0\u5f55\uff0c\u8fd9\u662f\u4e00\u4e2a\u671f\u5f85\u5df2\u4e45\u7684\u529f\u80fd\uff0c\u5141\u8bb8 Linkerd \u751f\u6210 Apache \u6837\u5f0f\u7684\u8bf7\u6c42\u65e5\u5fd7\u3002\u5b83\u589e\u52a0\u4e86\u5bf9 iptables-nft \u7684\u652f\u6301\uff0c\u5e76\u5f15\u5165\u4e86\u8bb8\u591a\u5176\u4ed6\u6539\u8fdb\u548c\u6027\u80fd\u589e\u5f3a\u3002","title":"\u66f4\u65b0\u65e5\u5fd7"},{"location":"chap11/8linkerd_212/#per-route","text":"Linkerd \u7684\u65b0\u7684 per-route \u7b56\u7565\u6269\u5c55\u4e86\u73b0\u6709\u7684\u57fa\u4e8e\u7aef\u53e3\u7684\u7b56\u7565\uff0c\u5bf9\u670d\u52a1\u5982\u4f55\u88ab\u5141\u8bb8\u76f8\u4e92\u901a\u4fe1\u8fdb\u884c\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\u3002 \u8fd9\u4e9b\u7b56\u7565\u662f\u4e3a\u91c7\u53d6\u96f6\u4fe1\u4efb\u5b89\u5168\u65b9\u6cd5\u7684\u7ec4\u7ec7\u8bbe\u8ba1\u7684\uff0c\u8fd9\u79cd\u65b9\u6cd5\u4e0d\u4ec5\u9700\u8981\u52a0\u5bc6\uff0c\u8fd8\u9700\u8981\u5f3a\u5927\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u548c\u660e\u786e\u7684\u6388\u6743\u3002 \u5c06\u7f51\u7edc\u89c6\u4e3a\u5bf9\u6297\u6027\u7684 \uff1a\u5b83\u4eec\u4e0d\u4f9d\u8d56 IP \u5730\u5740\uff0c\u4e5f\u4e0d\u8981\u6c42 CNI \u5c42\u6216\u5e95\u5c42\u7f51\u7edc\u7684\u4efb\u4f55\u5176\u4ed6\u65b9\u9762\u662f\u5b89\u5168\u7684\u3002 \u4f7f\u7528\u5b89\u5168\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd \uff1aLinkerd \u7684\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u662f\u7531 ServiceAccounts \u81ea\u52a8\u751f\u6210\u7684\uff0c\u5e76\u5728\u8fde\u63a5\u65f6\u901a\u8fc7\u53cc\u5411 TLS \u8fdb\u884c\u52a0\u5bc6\u9a8c\u8bc1\u3002 \u5728 Pod \u7ea7\u522b\u4e0a\u5f3a\u5236\u6267\u884c \uff1a\u6bcf\u4e2a\u8fde\u63a5\u548c\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u7ecf\u8fc7\u9a8c\u8bc1\u3002 \u5f88\u5bb9\u6613\u7684\u5141\u8bb8\u6a21\u5f0f \uff1a\u6709\u5b89\u5168\u610f\u8bc6\u7684\u91c7\u7528\u8005\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u9ed8\u8ba4\u62d2\u7edd\u5bf9\u654f\u611f\u8d44\u6e90\u7684\u8bbf\u95ee\uff0c\u9664\u975e\u660e\u786e\u5141\u8bb8\uff08\"\u6700\u5c0f\u7279\u6743\u539f\u5219\"\uff09\u3002 \u9ed8\u8ba4\u62d2\u7edd\u914d\u7f6e\u5728 Kubernetes \u4e2d\u53ef\u80fd\u4f1a\u6709\u4e00\u4e9b\u95ee\u9898\uff0c\u56e0\u4e3a health \u548c readiness \u63a2\u9488\u72b6\u6001\u9700\u8981\u5728\u6ca1\u6709\u6388\u6743\u7684\u60c5\u51b5\u4e0b\u901a\u8fc7\u3002 \u5728 Linkerd 2.12 \u4e2d\uff0chealth \u548c readiness \u72b6\u6001\u63a2\u6d4b\u73b0\u5728\u662f\u9ed8\u8ba4\u6388\u6743\u7684\uff0c\u4f46\u4e5f\u53ef\u4ee5\u660e\u786e\u6388\u6743\uff0c\u540c\u65f6\u4ecd\u7136\u9501\u5b9a\u5176\u4ed6\u5e94\u7528\u7aef\u70b9\u3002","title":"Per-route \u7b56\u7565"},{"location":"chap11/8linkerd_212/#gateway-api","text":"Linkerd 2.12 \u63d0\u4f9b\u4e86\u652f\u6301 Kubernetes Gateway API \u7684\u7b2c\u4e00\u6b65\u3002\u867d\u7136 Gateway API \u6700\u521d\u662f\u4f5c\u4e3a Kubernetes \u4e2d\u957f\u671f\u5b58\u5728\u7684 Ingress \u8d44\u6e90\u7684\u4e00\u4e2a\u66f4\u4e30\u5bcc\u3001\u66f4\u7075\u6d3b\u7684\u66ff\u4ee3\u54c1\u800c\u8bbe\u8ba1\u7684\uff0c\u4f46\u5b83\u4e3a\u63cf\u8ff0\u670d\u52a1\u7f51\u72b6\u6d41\u91cf\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f88\u597d\u7684\u57fa\u7840\uff0c\u5e76\u5141\u8bb8 Linkerd \u5c06\u5176\u589e\u52a0\u7684\u914d\u7f6e\u4fdd\u6301\u5728\u6700\u4f4e\u6c34\u5e73\u3002 \u5728 Linkerd 2.12 \u4e2d\uff0cLinkerd \u63d0\u4f9b\u4e86 Gateway API \u7684\u90e8\u5206\u5b9e\u73b0\u6765\u914d\u7f6e Linkerd \u7684\u57fa\u4e8e\u8def\u7531\u7684\u7b56\u7565\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5f00\u59cb\u4f7f\u7528 Gateway API\uff0c\u800c\u4e0d\u7528\u5b9e\u73b0\u89c4\u8303\u4e2d\u5bf9 Linkerd \u6ca1\u6709\u610f\u4e49\u7684\u90e8\u5206\u3002\u968f\u7740 Gateway API \u7684\u53d1\u5c55\uff0c\u4e5f\u4f1a\u6162\u6162\u5730\u66f4\u597d\u6ee1\u8db3 Linkerd \u7684\u9700\u6c42\u3002","title":"Gateway API"},{"location":"chap11/8linkerd_212/#_2","text":"Linkerd 2.12 \u8fd8\u5f15\u5165\u4e86\u8bbf\u95ee\u65e5\u5fd7\u8bb0\u5f55\uff0c\u5b83\u5141\u8bb8\u4ee3\u7406\u53d1\u51fa Apache \u6837\u5f0f\u7684\u8bf7\u6c42\u65e5\u5fd7\u3002\u51fa\u4e8e\u6027\u80fd\u548c\u8d44\u6e90\u5229\u7528\u7387\u7684\u539f\u56e0\uff0c\u6b64\u529f\u80fd\u9ed8\u8ba4\u5173\u95ed\uff08\u5c24\u5176\u662f\u5bf9\u4e8e\u9ad8\u6d41\u91cf\u5de5\u4f5c\u8d1f\u8f7d\uff09\uff0c\u4f46\u4e5f\u53ef\u4ee5\u5728\u9700\u8981\u5b83\u7684\u60c5\u51b5\u4e0b\u8f7b\u677e\u542f\u7528\u3002","title":"\u8bbf\u95ee\u65e5\u5fd7"},{"location":"chap11/8linkerd_212/#_3","text":"Linkerd 2.12 \u8fd8\u6709\u5927\u91cf\u7684\u5176\u4ed6\u6539\u8fdb\u3001\u6027\u80fd\u63d0\u5347\u548c\u9519\u8bef\u4fee\u590d\uff0c\u5305\u62ec\uff1a \u4e00\u4e2a\u65b0\u7684 config.linkerd.io/shutdown-grace-period \u6ce8\u89e3\uff0c\u7528\u4e8e\u914d\u7f6e\u4ee3\u7406\u7684\u6700\u5927\u5bbd\u9650\u671f\uff0c\u4ee5\u4fbf\u4f18\u96c5\u5730\u5173\u95ed\u3002 \u4e00\u4e2a\u65b0\u7684 iptables-nft \u6a21\u5f0f\uff0c\u7528\u4e8e Linkerd \u7684 init \u5bb9\u5668\u4e2d\u7684 iptables-nft \u652f\u6301\u3002 \u4fee\u590d\u4e86\u67d0\u4e9b\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u5728\u4fe1\u4efb\u6839\u8f6e\u6362\u540e\u672a\u6309\u8981\u6c42\u91cd\u542f\u7684\u95ee\u9898\u3002 \u4fee\u6b63\u4e86\u5f53\u5728 Linkerd \u547d\u540d\u7a7a\u95f4\u4e2d\u53d1\u73b0\u610f\u5916\u7684 Pod \u65f6\uff0c linkerd check \u547d\u4ee4\u5d29\u6e83\u7684\u95ee\u9898\u3002 \u4fee\u6539\u4e86 proxy.await \u7684 Helm \u503c\uff0c\u8fd9\u6837\u7528\u6237\u5c31\u53ef\u4ee5\u5728\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u4e0a\u7981\u7528 linkerd-await\u3002 \u6ce8\u91ca\uff0c\u5141\u8bb8 Linkerd \u6269\u5c55\u90e8\u7f72\u5728\u5fc5\u8981\u65f6\u88ab\u81ea\u52a8\u7f29\u653e\u5668\u9a71\u9010\u3002 \u80fd\u591f\u5728\u72ec\u7acb\u6a21\u5f0f\u4e0b\u8fd0\u884c Linkerd CNI \u63d2\u4ef6\u3002 \u591a\u96c6\u7fa4\u6269\u5c55\u4e2d\u7684 ServiceAccount token Secret \uff0c\u652f\u6301 Kubernetes \u7248\u672c >= v1.24 \u3002","title":"\u5176\u4ed6\u66f4\u65b0"},{"location":"chap11/8linkerd_212/#_4","text":"\u73b0\u5728\u6211\u4eec\u5c06\u96c6\u7fa4\u4e2d\u7684 Linkerd \u5347\u7ea7\u5230\u6700\u65b0\u7684 2.12 \u7248\u672c\u3002 \u9996\u5148\u9700\u8981\u66f4\u65b0 Linkerd CLI \u5de5\u5177\uff0c\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u5373\u53ef\uff1a $ curl --proto '=https' --tlsv1.2 -sSfL https://run.linkerd.io/install | sh \u8fd9\u4f1a\u5c06\u4f60\u7684\u672c\u5730 CLI \u5347\u7ea7\u5230\u6700\u65b0\u7248\u672c\u3002\u5f53\u7136\u6211\u4eec\u6709\u53ef\u4ee5\u901a\u8fc7 Linkerd \u7684 Release \u9875\u9762\u76f4\u63a5\u4e0b\u8f7d\u5bf9\u5e94\u5e73\u53f0\u7684 CLI \u5b89\u88c5\u5305\u3002 $ wget https://github.91chi.fun/https://github.com//linkerd/linkerd2/releases/download/stable-2.12.0/linkerd2-cli-stable-2.12.0-darwin-arm64 $ sudo mv linkerd2-cli-stable-2.12.0-darwin-arm64 /usr/local/bin/linkerd $ chmod +x /usr/local/bin/linkerd \u9a8c\u8bc1 CLI \u5df2\u5b89\u88c5\u5e76\u6b63\u786e\u8fd0\u884c\uff1a $ linkerd version Client version: stable-2.12.0 Server version: stable-2.11.1 \u53ef\u4ee5\u770b\u5230 CLI \u5347\u7ea7\u6210\u529f\u4e86\uff0c\u7531\u4e8e \u63a7\u5236\u5e73\u9762\u8fd8\u6ca1\u5347\u7ea7 \uff0c\u6240\u4ee5\u770b\u5230\u7684\u8fd8\u662f\u73b0\u5728\u7684 2.11.1 \u7248\u672c\u3002 \u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u5347\u7ea7 Kubernetes \u96c6\u7fa4\u4e0a\u7684 Linkerd \u63a7\u5236\u5e73\u9762\u4e86\uff0c\u4e0d\u7528\u62c5\u5fc3\uff0c\u73b0\u6709\u7684\u6570\u636e\u5e73\u9762\u5c06\u7ee7\u7eed\u4f7f\u7528\u66f4\u65b0\u7248\u672c\u7684\u63a7\u5236\u5e73\u9762\u8fd0\u884c\uff0c\u5e76\u4e14\u4f60\u7684\u7f51\u683c\u670d\u52a1\u4e0d\u4f1a\u51fa\u73b0\u6545\u969c\u3002 \u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f viz \u63d2\u4ef6\u81ea\u5e26\u7684 Prometheus \u7ec4\u4ef6\uff0c\u90a3\u4e48\u5347\u7ea7\u540e\u6570\u636e\u4f1a\u4e22\u5931\uff0c\u5982\u679c\u4f60\u914d\u7f6e\u7684\u5916\u7f6e\u7684 Prometheus \u5219\u4e0d\u7528\u62c5\u5fc3\u8be5\u95ee\u9898\u3002","title":"\u5347\u7ea7"},{"location":"chap11/8linkerd_212/#linkerd-smi","text":"\u5982\u679c\u4f60\u4f7f\u7528 CLI \u5b89\u88c5\u4e86 Linkerd 2.11.x\uff0c\u5e76\u4e14\u6b63\u5728\u4f7f\u7528 TrafficSplit CRD\uff0c\u5219\u9700\u8981\u6ce8\u610f\u4e22\u5931 TS \u7684 CR\uff0c\u5982\u679c\u4f60\u4e0d\u4f7f\u7528\u6b64 CRD\uff0c\u5219\u53ef\u4ee5\u5ffd\u7565\u8be5\u6ce8\u610f\u4e8b\u9879\u3002 TrafficSplit CRD \u4e0d\u518d\u968f Linkerd 2.12.0 \u63d0\u4f9b\uff0c\u800c\u662f\u7531 Linkerd SMI \u6269\u5c55\u63d0\u4f9b \u3002 \u540c\u6837\u9996\u5148\u4ece Release \u9875\u9762\u4e0b\u8f7d\u5bf9\u5e94\u7684\u53ef\u6267\u884c\u5305\uff1a $ wget https://github.91chi.fun/https://github.com//linkerd/linkerd-smi/releases/download/v0.2.0/linkerd-smi-0.2.0-darwin-arm64 $ chmod +x linkerd-smi-0.2.0-darwin-arm64 $ sudo mv linkerd-smi-0.2.0-darwin-arm64 /usr/local/bin/linkerd-smi $ linkerd-smi version v0.2.0 \u540c\u6837 Linkerd SMI \u4e5f\u53ef\u4ee5\u901a\u8fc7 CLI \u5de5\u5177\u8fdb\u884c\u5b89\u88c5\uff0c\u6b64\u6269\u5c55\u5305\u542b\u4e00\u4e2a SMI-Adaptor\uff0c\u5b83\u5c06 SMI \u8d44\u6e90\u8f6c\u6362\u4e3a\u672c\u5730 Linkerd \u8d44\u6e90 \u3002 $ linkerd smi install | kubectl apply -f - $ linkerd smi check \u6b64\u5916\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684 Helm \u65b9\u5f0f\u6765\u5b89\u88c5 Linkerd SMI \u6269\u5c55 \u3002\u4f46\u5728\u5b89\u88c5\u8be5\u6269\u5c55\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u5728 CRD \u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u6ce8\u91ca\u548c\u6807\u7b7e\uff0c\u4ee5\u4fbf linkerd-smi chart \u53ef\u4ee5\u91c7\u7528\u5b83\uff1a $ kubectl annotate --overwrite crd/trafficsplits.split.smi-spec.io \\ meta.helm.sh/release-name=linkerd-smi \\ meta.helm.sh/release-namespace=linkerd-smi # \u6dfb\u52a0smi repo\u4ed3\u5e93 $ helm repo add l5d-smi https://linkerd.github.io/linkerd-smi $ helm upgrade --install linkerd-smi -n linkerd-smi --create-namespace l5d-smi/linkerd-smi Release \"linkerd-smi\" has been upgraded. Happy Helming! NAME: linkerd-smi LAST DEPLOYED: Sun Sep 11 14:54:02 2022 NAMESPACE: linkerd-smi STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: The Linkerd SMI extension was successfully installed \ud83c\udf89 $ kubectl get pods -n linkerd-smi NAME READY STATUS RESTARTS AGE namespace-metadata--1-jnttx 0/1 Completed 0 17m smi-adaptor-5788b875d4-r4b7w 2/2 Running 6 (5m53s ago) 17m \u6700\u540e\uff0c\u4f60\u53ef\u4ee5\u7ee7\u7eed\u4f7f\u7528\u901a\u5e38\u7684 CLI \u5347\u7ea7\u8bf4\u660e\uff0c\u4f46\u5728\u5e94\u7528 linkerd upgrade --crds \u7684\u8f93\u51fa\u65f6\u907f\u514d\u4f7f\u7528 --prune \u6807\u5fd7\u4ee5\u907f\u514d\u5220\u9664 TrafficSplit CRD \uff01","title":"Linkerd SMI \u6269\u5c55"},{"location":"chap11/8linkerd_212/#_5","text":"\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5 \u76f4\u63a5\u4f7f\u7528 linkerd upgrade \u547d\u4ee4\u6765\u5347\u7ea7\u63a7\u5236\u5e73\u9762 \uff0c\u8be5\u547d\u4ee4\u786e\u4fdd\u63a7\u5236\u5e73\u9762\u7684\u6240\u6709\u73b0\u6709\u914d\u7f6e\u548c mTLS \u88ab\u4fdd\u7559\u4e0b\u6765\u3002 $ kubectl get crd |grep linkerd serverauthorizations.policy.linkerd.io 2022-08-19T04:06:33Z servers.policy.linkerd.io 2022-08-19T04:06:33Z serviceprofiles.linkerd.io 2022-08-19T04:06:33Z $ linkerd upgrade --crds | \\ kubectl apply --prune -l linkerd.io/control-plane-ns=linkerd \\ --prune-whitelist=apiextensions.k8s.io/v1/customresourcedefinition \\ --prune-whitelist=split.smi-spec.io/v1alpha2/trafficsplit \\ -f - customresourcedefinition.apiextensions.k8s.io/authorizationpolicies.policy.linkerd.io created customresourcedefinition.apiextensions.k8s.io/httproutes.policy.linkerd.io created customresourcedefinition.apiextensions.k8s.io/meshtlsauthentications.policy.linkerd.io created customresourcedefinition.apiextensions.k8s.io/networkauthentications.policy.linkerd.io created customresourcedefinition.apiextensions.k8s.io/serverauthorizations.policy.linkerd.io configured customresourcedefinition.apiextensions.k8s.io/servers.policy.linkerd.io configured customresourcedefinition.apiextensions.k8s.io/serviceprofiles.linkerd.io configured customresourcedefinition.apiextensions.k8s.io/trafficsplits.split.smi-spec.io configured \u6ce8\u610f\uff0c\u4e0a\u9762\u66f4\u65b0\u547d\u4ee4\u4e2d\u6211\u4eec\u4f7f\u7528\u4e86 --prune \u6807\u5fd7\uff0c\u8be5\u6807\u5fd7\u53ef\u4ee5\u5220\u9664\u5728\u65b0\u7248\u672c\u4e2d\u4e0d\u518d\u5b58\u5728\u7684\u524d\u4e00\u7248\u672c\u7684 Linkerd \u8d44\u6e90\uff0c\u4e0a\u9762\u6211\u4eec\u662f\u66f4\u65b0\u65b0\u7248\u672c\u7684 CRD \u8d44\u6e90\uff0c\u53ef\u4ee5\u770b\u5230\u65b0\u589e\u4e86 4 \u4e2a CRD \uff0c\u56e0\u4e3a\u73b0\u5728\u5f15\u5165\u4e86 Gateway API \u3002 $ kubectl get crd |grep linkerd authorizationpolicies.policy.linkerd.io 2022-09-11T02:56:13Z httproutes.policy.linkerd.io 2022-09-11T02:56:13Z meshtlsauthentications.policy.linkerd.io 2022-09-11T02:56:14Z networkauthentications.policy.linkerd.io 2022-09-11T02:56:14Z serverauthorizations.policy.linkerd.io 2022-08-19T04:06:33Z servers.policy.linkerd.io 2022-08-19T04:06:33Z serviceprofiles.linkerd.io 2022-08-19T04:06:33Z \u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u65b0\u589e\u7684 Gateway API \u76f8\u5173\u7684 CRD \u5e76\u4e0d\u662f\u539f\u59cb Kubernetes \u4e0b\u9762\u5b9a\u4e49\u7684\uff0c\u800c\u662f\u4e5f\u662f\u5728 policy.linkerd.io \u7684\u7ec4\u4e0b\u9762\uff0c\u8fd9\u662f\u56e0\u4e3a Linkerd \u5bf9\u8fd9\u4e9b CRD \u4e5f\u505a\u4e86\u4e00\u4e9b\u9002\u914d\u3002 \u63a5\u4e0b\u6765\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u66f4\u65b0\u63a7\u5236\u5e73\u9762\u8d44\u6e90\u5bf9\u8c61\uff1a $ linkerd upgrade | \\ kubectl apply --prune -l linkerd.io/control-plane-ns=linkerd -f - \u63a5\u4e0b\u6765\uff0c\u518d\u6b21\u8fd0\u884c\u6b64\u547d\u4ee4\u5e76\u6dfb\u52a0\u4e00\u4e9b --prune-whitelist \u6807\u5fd7\uff0c\u8fd9\u53ef\u4ee5\u786e\u4fdd\u6b63\u786e\u4fee\u526a\u67d0\u4e9b\u96c6\u7fa4\u8303\u56f4\u7684\u8d44\u6e90\u6240\u5fc5\u9700\u7684\u3002 $ linkerd upgrade | kubectl apply --prune -l linkerd.io/control-plane-ns=linkerd \\ --prune-whitelist=rbac.authorization.k8s.io/v1/clusterrole \\ --prune-whitelist=rbac.authorization.k8s.io/v1/clusterrolebinding \\ --prune-whitelist=apiregistration.k8s.io/v1/apiservice -f - \u5347\u7ea7\u8fc7\u7a0b\u5b8c\u6210\u540e\uff0c\u540c\u6837\u53ef\u4ee5\u8fd0\u884c\u68c0\u67e5\u547d\u4ee4\u6765\u786e\u4fdd\u4e00\u5207\u6b63\u5e38\uff1a $ linkerd check \u8be5\u547d\u4ee4\u5c06\u9488\u5bf9\u63a7\u5236\u5e73\u9762\u8fdb\u884c\u4e00\u7cfb\u5217\u68c0\u67e5\uff0c\u5e76\u786e\u4fdd\u5176\u6b63\u5e38\u8fd0\u884c\u3002 \u73b0\u5728\u518d\u6b21\u67e5\u770b Linkerd \u7248\u672c\uff0c\u6b63\u5e38 Server \u7aef\u7684\u7248\u672c\u4e5f\u66f4\u65b0\u4e86\u3002 $ linkerd version Client version: stable-2.12.0 Server version: stable-2.12.0 \u63a5\u7740\u6211\u4eec\u5c31\u53ef\u4ee5\u5347\u7ea7\u6570\u636e\u5e73\u9762\u4e86\uff0c\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u5728\u4f60\u7684\u670d\u52a1\u4e0a\u8fd0\u884c\u6eda\u52a8\u90e8\u7f72\uff0c\u5141\u8bb8\u4ee3\u7406\u6ce8\u5165\u5668\u5728\u5b83\u4eec\u51fa\u73b0\u65f6\u6ce8\u5165\u6700\u65b0\u7248\u672c\u7684\u4ee3\u7406\u3002 $ kubectl -n <namespace> rollout restart deploy \u4e00\u822c\u6765\u8bf4\u7a33\u5b9a\u7248\u7684\u63a7\u5236\u5e73\u9762\u4e0e\u4e0a\u4e00\u4e2a\u7a33\u5b9a\u7248\u7684\u6570\u636e\u5e73\u9762\u662f\u517c\u5bb9\u7684\uff0c\u6240\u4ee5\u6570\u636e\u5e73\u9762\u7684\u5347\u7ea7\u53ef\u4ee5\u5728\u63a7\u5236\u5e73\u9762\u5347\u7ea7\u540e\u7684\u4efb\u4f55\u65f6\u5019\u8fdb\u884c\uff0c\u4f46\u662f\u4e0d\u5efa\u8bae\u8d85\u8fc7\u4e00\u4e2a\u7a33\u5b9a\u7248\u672c\u7684\u5dee\u8ddd\u3002 \u540c\u6837\u66f4\u65b0\u5b8c\u6210\u540e\u53ef\u4ee5\u4f7f\u7528 check \u547d\u4ee4\u6765\u6821\u9a8c\u6570\u636e\u5e73\u9762\u72b6\u6001\u3002 $ linkerd check --proxy # ...... linkerd-data-plane ------------------ \u221a data plane namespace exists \u221a data plane proxies are ready \u203c data plane is up-to-date some proxies are not running the current version: * emoji-696d9d8f95-5vn9w (stable-2.11.1) * vote-bot-646b9fd6fd-8xj2j (stable-2.11.1) * voting-ff4c54b8d-xhjv7 (stable-2.11.1) * web-5f86686c4d-58p7k (stable-2.11.1) * web-svc-2-f9d77474f-vxlrh (stable-2.11.1) * ingress-nginx-controller-f56c7f6fd-rxhrs (stable-2.11.1) see https://linkerd.io/2.12/checks/#l5d-data-plane-version for hints \u203c data plane and cli versions match emoji-696d9d8f95-5vn9w running stable-2.11.1 but cli running stable-2.12.0 see https://linkerd.io/2.12/checks/#l5d-data-plane-cli-version for hints \u221a data plane pod labels are configured correctly \u221a data plane service labels are configured correctly \u221a data plane service annotations are configured correctly \u221a opaque ports are properly annotated Linkerd extensions checks ========================= - Running smi extension check \u8be5\u547d\u4ee4\u901a\u8fc7\u4e00\u7ec4\u68c0\u67e5\u6765\u9a8c\u8bc1\u6570\u636e\u5e73\u9762\u662f\u5426\u6b63\u5e38\u8fd0\u884c\uff0c\u5e76\u5c06\u5217\u51fa\u4ecd\u5728\u8fd0\u884c\u65e7\u7248\u672c\u4ee3\u7406\u7684 pod\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u53bb\u5347\u7ea7\u5bf9\u5e94\u7684 pod \u5373\u53ef\u3002","title":"\u5347\u7ea7"},{"location":"chap11/8linkerd_212/#linkerd-viz","text":"\u53e6\u5916\u8fd8\u6709\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u662f viz \u63d2\u4ef6\uff0c\u5728\u6700\u65b0\u7248\u672c\u4e2d\u5df2\u7ecf\u6ca1\u6709\u5185\u7f6e grafana \u4e86\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u5148\u76f4\u63a5\u5c06\u8be5\u63d2\u4ef6\u5378\u8f7d\u5e72\u51c0\uff08\u8be5\u63d2\u4ef6\u4e0d\u4f1a\u5f71\u54cd\u7f51\u683c\u7684\u6838\u5fc3\u529f\u80fd\uff09\uff0c\u7136\u540e\u91cd\u65b0\u5b89\u88c5\u6700\u65b0\u7248\u672c\u3002 $ linkerd viz install | kubectl delete -f - \u5378\u8f7d\u5b8c\u6210\u540e\u91cd\u65b0\u5b89\u88c5\uff0c\u7531\u4e8e\u65b0\u7248\u672c\u5df2\u7ecf\u6ca1\u6709\u5185\u7f6e Grafana \u4e86\uff0c\u6211\u4eec\u91cd\u65b0\u5b89\u88c5\u7684\u4f7f\u7528\u53ef\u4ee5\u901a\u8fc7 --set grafana.url \u6765\u6307\u5b9a\u5916\u90e8\u7684 Grafana \u5730\u5740\uff08\u5982\u679c\u662f\u96c6\u7fa4\u5916\u7684\u5730\u5740\u53ef\u4ee5\u901a\u8fc7 grafana.externalUrl \u53c2\u6570\u6307\u5b9a\uff09\uff0c\u540c\u6837\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5916\u90e8\u7684 Prometheus\uff1a $ linkerd viz install --set grafana.url=grafana:3000,prometheusUrl=http://prometheus.kube-mon.svc.cluster.local:9090,prometheus.enabled=false | kubectl apply -f - \u91cd\u65b0\u5b89\u88c5\u540e\u67e5\u770b viz \u7684 pod \u5217\u8868\uff1a $ kubectl get pods -n linkerd-viz NAME READY STATUS RESTARTS AGE metrics-api-674bf48d7f-kzr5b 2/2 Running 0 17m tap-67d6d8ff4d-q7nqn 2/2 Running 0 5m21s tap-injector-7c565f754-jgvc5 2/2 Running 0 5m20s web-87b958bcf-d5pfp 2/2 Running 0 5m20s \u53ef\u4ee5\u770b\u5230\u73b0\u5728\u6ca1\u6709\u4e86 Grafana \u548c Prometheus \u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u5bf9\u63a5\u7684\u5916\u90e8 Prometheus\uff0c\u800c Grafana \u5219\u662f\u65b0\u7248\u672c\u4e2d\u6ca1\u6709\u5185\u7f6e\u4f7f\u7528\u4e86\uff0c\u4e0a\u9762\u6211\u4eec\u6307\u5b9a\u7684 Grafana \u5730\u5740\u5728 viz \u540c\u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u624b\u52a8\u5b89\u88c5\u4e00\u4e2a\u5373\u53ef\u3002 \u5982\u679c\u5355\u4e2a Grafana \u5b9e\u4f8b\u6307\u5411\u591a\u4e2a Linkerd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u5176 UID \u4e2d\u7684\u4e0d\u540c\u524d\u7f00\u5206\u9694\u4eea\u8868\u677f\uff0c\u53ef\u4ee5\u5728\u6bcf\u4e2a Linkerd \u5b9e\u4f8b\u7684 grafana.uidPrefix \u8bbe\u7f6e\u4e2d\u914d\u7f6e\u8fd9\u4e9b\u524d\u7f00\u3002 \u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 Helm Chart \u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u5b9a\u5236\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a podAnnotations: linkerd.io/inject: enabled grafana.ini: server: root_url: \"%(protocol)s://%(domain)s:/grafana/\" auth: disable_login_form: true auth.anonymous: enabled: true org_role: Editor auth.basic: enabled: false analytics: check_for_updates: false panels: disable_sanitize_html: true log: mode: console log.console: format: text level: info datasources: datasources.yaml: apiVersion: 1 datasources: - name: prometheus type: prometheus access: proxy orgId: 1 url: http://prometheus.kube-mon.svc.cluster.local:9090 isDefault: true jsonData: timeInterval: \"5s\" editable: true dashboardProviders: dashboardproviders.yaml: apiVersion: 1 providers: - name: \"default\" orgId: 1 folder: \"\" type: file disableDeletion: false editable: true options: path: /var/lib/grafana/dashboards/default dashboards: default: # all these charts are hosted at https://grafana.com/grafana/dashboards/{id} top-line: gnetId: 15474 revision: 3 datasource: prometheus health: gnetId: 15486 revision: 2 datasource: prometheus kubernetes: gnetId: 15479 revision: 2 datasource: prometheus namespace: gnetId: 15478 revision: 2 datasource: prometheus deployment: gnetId: 15475 revision: 5 datasource: prometheus pod: gnetId: 15477 revision: 2 datasource: prometheus service: gnetId: 15480 revision: 2 datasource: prometheus route: gnetId: 15481 revision: 2 datasource: prometheus authority: gnetId: 15482 revision: 2 datasource: prometheus cronjob: gnetId: 15483 revision: 2 datasource: prometheus job: gnetId: 15487 revision: 2 datasource: prometheus daemonset: gnetId: 15484 revision: 2 datasource: prometheus replicaset: gnetId: 15491 revision: 2 datasource: prometheus statefulset: gnetId: 15493 revision: 2 datasource: prometheus replicationcontroller: gnetId: 15492 revision: 2 datasource: prometheus prometheus: gnetId: 15489 revision: 2 datasource: prometheus prometheus-benchmark: gnetId: 15490 revision: 2 datasource: prometheus multicluster: gnetId: 15488 revision: 2 datasource: prometheus \u4e0a\u9762\u7684 values \u6587\u4ef6\u4e2d\u6211\u4eec\u6ce8\u5165\u4e86 linkerd.io/inject: enabled \u8fd9\u4e2a\u6ce8\u89e3\uff0c\u4e3a\u5176\u6ce8\u5165 Linkerd \u7684 proxy\uff0c\u7136\u540e\u8fd8\u8981\u6ce8\u610f\u914d\u7f6e Prometheus \u6570\u636e\u6e90\u5730\u5740\u3002 $ helm repo add grafana https://grafana.github.io/helm-charts $ helm upgrade --install grafana -n linkerd-viz grafana/grafana -f values.yaml \u5982\u679c\u6211\u4eec\u5df2\u7ecf\u6709\u4e00\u4e2a\u5916\u90e8\u7684 Grafana\uff0c\u90a3\u4e48\u5728\u5b89\u88c5\u7684\u65f6\u5019\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 grafana.externalUrl \u6765\u6307\u5b9a\uff1a $ linkerd viz install --set grafana.externalUrl=http://192.168.0.106:30403,prometheusUrl=http://prometheus.kube-mon.svc.cluster.local:9090,prometheus.enabled=false | kubectl apply -f - \u8fd9\u6837\u66f4\u65b0\u540e\u8bb0\u5f97\u8981\u5728\u5916\u90e8 Grafana \u4e2d\u5bfc\u5165 Linkerd \u76f8\u5173\u7684 Dashboard\uff0c\u53ef\u4ee5\u4ece Grafana \u5b98\u7f51 https://grafana.com/orgs/linkerd \u83b7\u53d6\u3002 \u6bd4\u5982\u6211\u4eec\u5bfc\u5165 Deployments \u7684 dashboard\uff0c\u53ef\u4ee5\u5bfc\u5165 15475 \u8fd9\u4e2a ID\uff0c\u6216\u8005\u4e0b\u8f7d JSON \u6587\u4ef6\u4e0a\u4f20\u5bfc\u5165\u3002 \u5bfc\u5165\u540e\u91cd\u65b0\u8bbf\u95ee Viz \u7684 Dashboard\uff1a \u540c\u6837\u70b9\u51fb\u9875\u9762\u4e0a\u7684 Grafana \u56fe\u6807\u5c31\u53ef\u4ee5\u76f4\u63a5\u8df3\u8f6c\u5230 Grafana Dashboard \u9875\u9762\uff1a","title":"Linkerd Viz \u6269\u5c55"},{"location":"chap2/10chap3_mesh/","text":"\u7b2c\u5341\u8282 Mesh\u7684\u672a\u6765\u53d1\u5c55\u4e0e\u53ef\u884c\u6027\u65b9\u5411 1\u3001\u4e2d\u95f4\u4ef6 Mesh \u5316\u7684\u53ef\u884c\u6027 Service Mesh \u4e3b\u8981\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5305\u62ec\u8fb9\u7f18\u7f51\u5173\u7684\u5357\u5317\u5411\u6d41\u91cf\u548c\u5185\u90e8\u901a\u4fe1\u7684\u4e1c\u897f\u5411\u6d41\u91cf\u3002 Service Mesh \u4e3b\u8981\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf \u670d\u52a1\u548c\u4e2d\u95f4\u4ef6\u901a\u4fe1\u7684\u6d41\u91cf\u4e5f\u975e\u5e38\u91cd\u8981\uff0c\u662f\u672a\u6765\u6574\u4e2a\u5fae\u670d\u52a1 Mesh \u5316\u4e2d\u91cd\u8981\u7684\u4e00\u73af\u3002 FaaS\uff08Function as a Service\uff09\u4e5f\u662f\u672a\u6765\u5fae\u670d\u52a1\u67b6\u6784\u91cd\u8981\u7684\u6f14\u8fdb\u65b9\u5411\u4e4b\u4e00\uff0c\u5728 FaaS \u67b6\u6784\u4e2d\uff0cService Mesh \u540c\u6837\u53ef\u4ee5\u4f5c\u4e3a\u5e95\u5c42\u57fa\u7840\u8bbe\u65bd\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\u3002 1-1 \u4e2d\u95f4\u4ef6 Mesh \u5316 \u8457\u540d\u7684\u6570\u636e\u9762\u5df2\u7ecf\u652f\u6301\u4e86\u8bf8\u591a\u6570\u636e\u5e93\u548c\u961f\u5217\u4e2d\u95f4\u4ef6 1-2 Redis \u4ee3\u7406 Envoy \u53ef\u4ee5\u4f5c\u4e3a Redis \u7684\u4ee3\u7406\uff0c\u90e8\u7f72\u5728\u6bcf\u4e2a\u670d\u52a1\u7684\u8282\u70b9\u4e0a\uff0c\u8fd9\u6837\u5c31\u65e0\u987b\u4f20\u7edf\u7684 Redis \u4e2d\u95f4\u4ef6\u8d1f\u8d23 Redis \u96c6\u7fa4\u7684\u4ee3\u7406\u5de5\u4f5c\uff0c\u4e5f\u4e0d\u9700\u8981\u4f20\u7edf Redis \u5b98\u65b9\u63d0\u4f9b\u7684 Smart Client\u3002 Envoy \u53ef\u4ee5\u66ff\u4ee3\u8fd9\u90e8\u5206\u529f\u80fd\uff0c\u63a7\u5236 Redis \u96c6\u7fa4\uff0c\u8def\u7531\u5230\u6b63\u786e\u7684 hash \u5206\u7247\u8282\u70b9\u4e0a\u3002 \u4f7f\u7528 Envoy \u505a Redis \u4ee3\u7406\uff0c\u65e2\u907f\u514d\u4e86\u4f20\u7edf\u7684 Smart Client \u7684\u5347\u7ea7\u7ef4\u62a4\u95ee\u9898\uff0c\u4e5f\u907f\u514d\u4e86\u4f20\u7edf\u7684 Redis \u4e2d\u95f4\u4ef6\u4e2d\u5fc3\u5316\u7684\u95ee\u9898\u3002 \u901a\u8fc7 Mesh \u7684\u67b6\u6784\u3001Metrics \u6ce8\u5165\u7b49\u65b9\u5f0f\uff0c\u53ef\u4ee5\u770b\u5230\u5230\u5e95\u662f\u54ea\u4e2a\u670d\u52a1\u8c03\u7528\u7684 Redis\uff0c\u518d\u914d\u5408\u670d\u52a1\u95f4\u7684\u94fe\u8def\u8c03\u7528\u56fe\uff0c\u8fd9\u6837\u6574\u4e2a\u5185\u7f51\u95f4\u6240\u6709\u6d41\u91cf\u7684\u94fe\u8def\u8c03\u7528\u56fe\u5c31\u53ef\u4ee5\u7ed8\u5236\u51fa\u6765\u4e86\u3002 \u76ee\u524d Envoy \u7684 Redis \u4ee3\u7406\u652f\u6301\u4ee5\u4e0b\u529f\u80fd\uff1a Redis \u534f\u8bae\u7684\u7f16\u89e3\u7801\uff1b \u57fa\u4e8e\u54c8\u5e0c\u7684\u5206\u7247\uff1b Ketama \u4e00\u81f4\u6027\u54c8\u5e0c\u7b97\u6cd5\uff1b \u8be6\u7ec6\u7684\u6570\u636e\u7edf\u8ba1\u4fe1\u606f\uff1b \u5bf9\u4e8e Redis \u8282\u70b9\u7684\u4e3b\u52a8\u548c\u88ab\u52a8\u5065\u5eb7\u68c0\u67e5\uff1b \u4e0a\u6e38\u4ee3\u7406\u548c\u4e0b\u6e38\u4ee3\u7406\u5206\u522b\u8fdb\u884c\u8eab\u4efd\u8ba4\u8bc1\u3002 Envoy \u5bf9\u4e8e Redis \u7684\u652f\u6301\u76f8\u5bf9\u6bd4\u8f83\u7b80\u5355\uff0c\u5f53\u7136\u672a\u6765\u793e\u533a\u4e5f\u5728\u89c4\u5212\u652f\u6301\u66f4\u591a\u7684\u529f\u80fd\uff0c\u5305\u62ec\u7194\u65ad\u3001\u94fe\u8def\u8ffd\u8e2a\u3001\u91cd\u8bd5\u7b49 \u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u4ea7\u54c1\uff08\u6bd4\u5982 Redis \u96c6\u7fa4\u4e2d\u95f4\u4ef6\u3001MySQL \u96c6\u7fa4\u4e2d\u95f4\u4ef6\uff09\u7684\u529f\u80fd\u4e3b\u8981\u662f\u5bf9\u6570\u636e\u505a\u5206\u7247\u5904\u7406\uff0c\u4ee5\u89e3\u51b3\u5355\u4e2a Redis \u6216\u8005 MySQL \u8282\u70b9\u65e0\u6cd5\u5904\u7406\u7684\u8d1f\u8f7d\u3002 \u8fd9\u4e9b\u529f\u80fd\u6700\u65e9\u4e5f\u5728 SDK \u4e2d\uff0c\u56e0\u4e3a\u7ef4\u62a4\u5347\u7ea7\u4e0d\u65b9\u4fbf\uff0c\u6240\u4ee5\u6f14\u8fdb\u6210\u4e86\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u3002 \u968f\u7740 Mesh \u5316\u67b6\u6784\u7684\u6d41\u884c\uff0c\u5728\u670d\u52a1\u672c\u5730\u90e8\u7f72\u4e00\u4e2a Sidecar\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u4ea7\u54c1\u4e2d\u5fc3\u5316\u7684\u95ee\u9898\u3002 \u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u7684 Mesh \u5316\u548c\u4f20\u7edf\u7684\u670d\u52a1 Mesh \u5316 \uff0c\u5173\u6ce8\u7684\u70b9\u7565\u6709\u4e0d\u540c\uff1a \u6570\u636e\u5e93\u7684\u4e2d\u95f4\u4ef6\u4ea7\u54c1\u66f4\u5173\u6ce8\u7684\u662f\u5bf9\u4e8e\u6570\u636e\u7684\u5206\u7247\u5904\u7406 \uff0c\u6bd4\u5982 MySQL \u7684\u5206\u5e93\u5206\u8868\u7b49\u7b97\u6cd5\u3001Redis \u96c6\u7fa4\u7684\u5206\u7247\u7b97\u6cd5\u7b49\u3002\u4f46\u4e5f\u6709\u5f88\u591a\u529f\u80fd\u662f\u901a\u7528\u7684\uff0c \u6bd4\u5982\u9650\u6d41\u7194\u65ad\u7b49\u6cbb\u7406\u529f\u80fd\u3001\u94fe\u8def\u8ffd\u8e2a\u3001Metrics \u76d1\u63a7\uff0c\u751a\u81f3\u670d\u52a1\u53d1\u73b0\u7b49\u529f\u80fd \u3002 1-3 FaaS FaaS\uff08Function as a Service\uff09\u662f\u4e00\u79cd\u5728\u65e0\u72b6\u6001\u5bb9\u5668\u4e2d\u8fd0\u884c\u7684\u4e8b\u4ef6\u9a71\u52a8\u6a21\u578b \u3002 \u7b80\u5355\u6765\u8bf4\uff0cFunction \u662f\u6bd4 Service \u66f4\u5c0f\u7684\u7a0b\u5e8f\u5355\u5143\uff0c \u5982\u679c\u8981\u8fdb\u884c\u6807\u51c6\u5316\u7684 FaaS \u5316\u6539\u9020\uff0c\u5c31\u9700\u8981\u8fdb\u4e00\u6b65\u62c6\u5206\uff0c\u5c06\u5fae\u670d\u52a1\u4e2d\u7684\u6bcf\u4e2a\u65b9\u6cd5\u90fd\u62c6\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u670d\u52a1 \u3002 FaaS \u4f9d\u7136\u662f\u4e00\u79cd\u975e\u5e38\u7406\u60f3\u5316\u7684\u67b6\u6784\uff0c\u6bd4\u5982\u5728\u670d\u52a1 0 \u8282\u70b9\u7684\u60c5\u51b5\u4e0b\u8981\u6d88\u8017\u5927\u91cf\u7684\u65f6\u95f4\u7b49\u5f85\u670d\u52a1\u542f\u52a8\uff0c\u4f46 FaaS \u4e2d\u7684\u4e00\u4e9b\u6838\u5fc3\u601d\u60f3\uff0c\u4f9d\u7136\u662f\u5fae\u670d\u52a1\u67b6\u6784\u7684\u53d1\u5c55\u8d8b\u52bf\uff0c\u6216\u8005\u8bf4\u5b83\u4eec\u53ef\u4ee5\u76f4\u63a5\u843d\u5730\uff0c\u6bd4\u5982\u5f3a\u5927\u7684\u81ea\u52a8\u6269\u7f29\u5bb9\u80fd\u529b\u3001\u57fa\u4e8e\u5f02\u6b65\u7684\u4e8b\u4ef6\u9a71\u52a8\u6a21\u578b\u7b49 FaaS \u7684\u5f00\u6e90\u65b9\u6848\u6709 Knative\u3001OpenFaaS\u3001Fission\u3001Kubeless \u7b49\uff0c\u4e0b\u9762\u6211\u4eec\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u51e0\u79cd\u5e38\u89c1\u7684\u5f00\u6e90\u65b9\u6848\u3002 Knative Knative \u662f\u8c37\u6b4c\u7275\u5934\u53d1\u8d77\u7684 Serverless \u9879\u76ee\uff0c\u662f\u57fa\u4e8e Kubernetes \u548c Istio \u7684 Serverless \u89e3\u51b3\u65b9\u6848\u3002 OpenFaaS OpenFaaS \u662f\u4e00\u4e2a\u4f7f\u7528 Docker \u6784\u5efa\u65e0\u670d\u52a1\u5668\uff08Serverless\uff09\u529f\u80fd\u7684\u6846\u67b6\uff0c\u53ef\u4ee5\u90e8\u7f72\u5728 Kubernetes \u6216\u8005 Swarm \u5e73\u53f0\u3002\u901a\u8fc7 Watchdog \u542f\u52a8\u8fdb\u7a0b\u7684\u65b9\u5f0f\u8fdb\u884c\u51fd\u6570\u5f0f\u8c03\u7528\u3002 Fission Fission \u662f\u4e00\u6b3e\u57fa\u4e8e Kubernetes \u7684 FaaS \u6846\u67b6\uff0c\u901a\u8fc7 Fission \u53ef\u4ee5\u8f7b\u800c\u6613\u4e3e\u5730\u5c06\u51fd\u6570\u53d1\u5e03\u6210 HTTP \u670d\u52a1\u3002\u5b83\u7684\u4e3b\u8981\u7279\u70b9\u662f Fission \u7ef4\u62a4\u4e00\u4e2a\u5bb9\u5668\u6c60\uff0c\u53ef\u4ee5\u505a\u5230\u51fd\u6570 100ms \u51b7\u542f\u52a8\u3002 Kubeless Kubeless \u662f\u57fa\u4e8e Kubernetes \u7684 Serverless \u6846\u67b6\uff0c\u501f\u52a9 Kubernetes \u63d0\u4f9b\u81ea\u52a8\u6269\u7f29\u5bb9\u3001API \u8def\u7531\u3001\u76d1\u63a7\u7684\u529f\u80fd\u3002 1-4 Knative Knative \u5305\u542b\u4e09\u4e2a\u6838\u5fc3\u7ec4\u4ef6\uff0c \u5206\u522b\u662f\u8d1f\u8d23\u670d\u52a1\u5904\u7406\u7684 Serving\u3001\u4e8b\u4ef6\u5904\u7406\u7684 Eventing\uff0c\u4ee5\u53ca\u8d1f\u8d23\u4e91\u539f\u751f CI/CD \u6784\u5efa\u7684 Tekton \u3002 Serving Knative Serving \u7ec4\u4ef6\u4f9d\u6258\u4e8e Kubernetes \u5e73\u53f0\u548c Istio\uff0c\u63d0\u4f9b\u670d\u52a1\u81ea\u52a8\u6269\u7f29\u5bb9\u3001\u670d\u52a1\u8def\u7531\u3001\u6d41\u91cf\u4ee3\u7406\u3001\u5bb9\u5668\u90e8\u7f72\u7b49\u529f\u80fd\u3002 Eventing Eventing \u4e3b\u8981\u7531\u4e8b\u4ef6\u6e90\uff08EventSource\uff09\u3001\u4e8b\u4ef6\u5904\u7406\uff08Flow\uff09\u4ee5\u53ca\u4e8b\u4ef6\u6d88\u8d39\u8005\uff08EventConsumer\uff09\u4e09\u90e8\u5206\u6784\u6210\uff0c\u5b9a\u4e49\u4e86 CloudEvent \u7684\u901a\u7528\u4e8b\u4ef6\u6807\u51c6\u3002 Tekton Tekton \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u4e14\u7075\u6d3b\u7684 Kubernetes \u4e91\u539f\u751f CI/CD \u5f00\u6e90\u6846\u67b6\u3002 \u4e0b\u56fe\u4e2d\u7684 Route \u53ef\u4ee5\u7406\u89e3\u4e3a Istio Gateway \u7684\u89d2\u8272\u3002\u5b9e\u9645\u4e0a\uff0c\u5927\u591a\u6570 FaaS \u67b6\u6784\uff0c\u90fd\u6709\u4e00\u4e2a\u7c7b\u4f3c API Gateway \u7684\u89d2\u8272\uff0c\u4e3b\u8981\u7528\u6765\u5904\u7406\u6d41\u91cf\u7684\u8f6c\u53d1\uff0c\u5728 Pod \u6570\u91cf\u4e3a 0 \u65f6\uff0c\u4e5f\u4f1a\u505a\u4e00\u4e9b\u7279\u6b8a\u5904\u7406\uff0c\u6bd4\u5982\u6b64\u65f6\u8981 hold \u4f4f\u6d41\u91cf\uff0c\u7b49\u5f85 Pod \u542f\u52a8\u3002 \u6d41\u91cf\u7ecf\u8fc7 Gateway\uff08Route\uff09\u540e\uff0c\u4f1a\u6709\u4e24\u4e2a\u5206\u652f\uff0c \u4e00\u4e2a\u662f\u670d\u52a1\u7684 Pod \u5b58\u5728\u7684\u65f6\u5019\uff0c\u6d41\u91cf\u4f1a\u76f4\u63a5\u8def\u7531\u5230 Pod \u4e0a\u9762\uff1b \u53e6\u5916\u4e00\u4e2a\u5728 Pod \u7f29\u5bb9\u5230 0 \u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u8f6c\u53d1\u5230\u4e00\u4e2a Activator \u7684\u7ec4\u4ef6\u4e2d\uff0c \u8fd9\u4e2a\u7ec4\u4ef6\u7684\u4e3b\u8981\u529f\u80fd\u662f\u5bf9\u5bb9\u5668\u8d44\u6e90\u7684\u8c03\u5ea6 \u3002 \u5f53\u6709\u6d41\u91cf\u88ab\u8f6c\u53d1\u5230 Activator \u7ec4\u4ef6\u65f6\uff0c\u5b83\u4f1a\u4e3b\u52a8\u901a\u77e5 Autoscaler \u7ec4\u4ef6\u8fdb\u884c\u6269\u5bb9\u64cd\u4f5c\uff0c\u8fd9\u65f6 Autoscaler \u4f1a\u521b\u5efa\u65b0\u7684 Pod\uff0c\u63d0\u4f9b\u670d\u52a1\u3002 \u6b64\u65f6 Activator \u5bf9\u542f\u52a8\u7684 Pod \u8fdb\u884c\u5065\u5eb7\u68c0\u67e5\uff0c\u68c0\u67e5\u901a\u8fc7\u540e\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u76f8\u5e94\u7684 Pod \u4e0a\u9762\u3002 Activator \u7ec4\u4ef6\u5904\u7406\u5b8c\u6d41\u91cf\u540e\uff0c\u4f1a\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9 Gateway \u5728\u6d41\u91cf\u88ab\u8f6c\u53d1\u5230 Activator \u7ec4\u4ef6\u8fd9\u4e2a\u5206\u652f\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c Pod \u6570\u91cf\u4e3a 0\uff0c\u672c\u6b21\u6d41\u91cf\u5904\u7406\u7684\u65f6\u95f4\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u5c31\u53d6\u51b3\u4e8e Pod \u542f\u52a8\u7684\u65f6\u95f4\uff0c\u800c\u8fd9\u4e2a\u65f6\u95f4\u5927\u6982\u7387\u662f\u79d2\u7ea7\u522b\u7684 \u3002 \u4f46\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u4e00\u822c\u7684\u8bf7\u6c42\u9700\u8981\u6beb\u79d2\u7ea7\u522b\u8fd4\u56de\u7ed3\u679c\uff0c\u79d2\u7ea7\u522b\u7684\u54cd\u5e94\u901f\u5ea6\u5f88\u96be\u63a5\u53d7\uff0c\u8fd9\u4e5f\u662f FaaS \u67b6\u6784\u76ee\u524d\u5728\u843d\u5730\u4e2d\u9762\u4e34\u7684\u6700\u5927\u95ee\u9898\uff0c\u5927\u90e8\u5206\u5bf9\u54cd\u5e94\u901f\u5ea6\u8981\u6c42\u6bd4\u8f83\u9ad8\u7684\u573a\u666f\uff0cPod \u7f29\u5bb9\u4e3a 0 \u90fd\u662f\u96be\u4ee5\u63a5\u53d7\u7684\u3002 \u6240\u4ee5 Knative \u4e5f\u63d0\u4f9b\u4e86 Pod \u662f\u5426\u7f29\u5bb9\u5230 0 \u7684\u9009\u9879\uff0c\u8fd9\u6837\u66f4\u6709\u5229\u4e8e FaaS \u67b6\u6784\u7684\u843d\u5730\u3002\u5c3d\u7ba1\u6ca1\u6709\u505a\u5230\u5b8c\u5168\u7684 Serverless\uff0c\u4f46\u80fd\u591f\u62e5\u6709\u5f3a\u5927\u7684\u6269\u7f29\u5bb9\u80fd\u529b\u5df2\u7ecf\u975e\u5e38\u6709\u8bf1\u60d1\u529b\u4e86\u3002 1-5 OpenFaaS \u7edf\u7684\u5fae\u670d\u52a1\u8c03\u7528\u3002\u5728\u8fd9\u5f20\u56fe\u7247\u4e2d\uff0c\u6211\u4eec\u7684\u9700\u6c42\u662f\u4ece\u6570\u636e\u5e93\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u5e76\u6839\u636e\u83b7\u53d6\u7684\u6570\u636e\u751f\u6210\u4e00\u4e2a PDF \u6587\u4ef6\u4e0a\u4f20\u5230 S3 \u670d\u52a1\u5668\u4e2d\u3002\u4f46\u662f\u8fd9\u4e2a\u573a\u666f\u6d88\u8017\u7684\u65f6\u95f4\u4f1a\u6bd4\u8f83\u957f\uff0c\u5927\u6982\u662f 2 \u5206\u949f\u5de6\u53f3\uff0c\u800c\u4e14\u4e0b\u56fe\u7684\u540c\u6b65\u67b6\u6784\uff0c\u4f1a\u963b\u585e\u7a0b\u5e8f\u8fdb\u7a0b\uff0c\u524d\u7aef\u7684\u54cd\u5e94\u4e5f\u4f1a\u7b49\u5f85\u5f88\u957f\u65f6\u95f4\u3002 \u5728\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u4e00\u822c\u6211\u4eec\u4e5f\u4e0d\u4f1a\u91c7\u7528\u4e0b\u56fe\u7684\u540c\u6b65\u7cfb\u7edf\uff0c\u800c\u662f\u91c7\u7528\u5f02\u6b65\u961f\u5217\u7cfb\u7edf\u89e3\u51b3\uff1a\u5c06\u751f\u6210 PDF \u4f5c\u4e3a\u4e8b\u4ef6\u5b58\u5165\u961f\u5217\u4e2d\uff0c\u901a\u8fc7\u961f\u5217\u6d88\u8d39\u751f\u6210 PDF \u5e76\u4e0a\u4f20\u5230 S3 \u670d\u52a1\u5668\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5927\u5927\u63d0\u9ad8\u5fae\u670d\u52a1\u7684\u540c\u6b65\u54cd\u5e94\u901f\u5ea6\u4e86\u3002 \u5728 FaaS \u4e2d\u6709\u6ca1\u6709\u66f4\u597d\u7684\u89e3\u51b3\u65b9\u6848\u5462\uff1f\u6211\u4eec\u6765\u770b OpenFaaS \u4e2d\u7684\u5f02\u6b65\u65b9\u6848\u3002 1-6 \u5f02\u6b65 \u5728 OpenFaaS \u4e2d\uff0c OpenFaaS \u5c06\u8bf7\u6c42\u4f5c\u4e3a\u4e8b\u4ef6\u76f4\u63a5\u653e\u5165 NATS \u8fd9\u4e2a\u961f\u5217\u7cfb\u7edf\u4e2d\uff0c\u5bf9\u4e8e\u4f7f\u7528\u8005\u6765\u8bf4\uff0c\u4ed6\u5e76\u4e0d\u9700\u8981\u5173\u5fc3\u8fd9\u662f\u5426\u662f\u4e00\u4e2a\u5f02\u6b65\u8c03\u7528\u3002 \u8fd9\u4e2a\u8c03\u7528\u7684\u7f16\u7a0b\u65b9\u5f0f\uff0c\u4f9d\u7136\u662f HTTP \u7684\u65b9\u5f0f\uff0c\u53ea\u662f OpenFaaS Gateway \u81ea\u52a8\u5c06\u6b64\u6b21 HTTP \u8c03\u7528\u653e\u5165\u4e86 NATS \u961f\u5217\u4e2d\uff0c\u901a\u8fc7 queue-worker\u8fd9\u4e2a\u8fdb\u7a0b\u8fdb\u884c\u961f\u5217\u6d88\u8d39\uff0c\u518d\u901a\u8fc7 HTTP \u8bf7\u6c42 Generate Statement \u670d\u52a1\u7684\u65b9\u5f0f\u89e6\u53d1\u6b64\u6b21\u670d\u52a1\u8c03\u7528\uff0c \u7528\u770b\u8d77\u6765\u540c\u6b65\u7684\u65b9\u5f0f\u5b8c\u6210\u4e86\u6574\u4e2a\u5f02\u6b65\u8c03\u7528 \u3002 \u6574\u4e2a\u8fd0\u884c\u8fc7\u7a0b \u5728\u8fd9\u4e2a\u67b6\u6784\u4e2d\uff0c\u4f7f\u7528\u8005\u65e0\u987b\u5173\u5fc3\u751a\u81f3\u65e0\u987b\u611f\u77e5 NATS \u961f\u5217\u7cfb\u7edf\uff0c\u5bf9\u4e8e\u4f7f\u7528\u8005\u6765\u8bf4\uff0c\u8fd9\u770b\u8d77\u6765\u5c31\u662f\u4e00\u6b21\u666e\u901a\u7684 HTTP \u670d\u52a1\u8c03\u7528\u3002 \u800c PDF \u751f\u6210\u670d\u52a1\u7684\u7f16\u5199\u8005\uff0c\u4e5f\u4e0d\u9700\u8981\u5904\u7406\u590d\u6742\u7684\u961f\u5217\u6d88\u8d39\uff0c\u5bf9\u4e8e\u4ed6\u6765\u8bf4\uff0c\u4e5f\u548c\u5176\u4ed6\u540c\u6b65\u670d\u52a1\u4e00\u6837\uff0c\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u7684 HTTP \u670d\u52a1\u63a5\u53e3\u5c31\u53ef\u4ee5\u4e86\u3002 FaaS \u67b6\u6784\u8ba9\u961f\u5217\u7cfb\u7edf\u548c\u4e1a\u52a1\u89e3\u8026\uff0c","title":"\u7b2c\u5341\u8282 Mesh\u7684\u672a\u6765\u53d1\u5c55\u4e0e\u53ef\u884c\u6027\u65b9\u5411"},{"location":"chap2/10chap3_mesh/#mesh","text":"","title":"\u7b2c\u5341\u8282 Mesh\u7684\u672a\u6765\u53d1\u5c55\u4e0e\u53ef\u884c\u6027\u65b9\u5411"},{"location":"chap2/10chap3_mesh/#1-mesh","text":"Service Mesh \u4e3b\u8981\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5305\u62ec\u8fb9\u7f18\u7f51\u5173\u7684\u5357\u5317\u5411\u6d41\u91cf\u548c\u5185\u90e8\u901a\u4fe1\u7684\u4e1c\u897f\u5411\u6d41\u91cf\u3002 Service Mesh \u4e3b\u8981\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf \u670d\u52a1\u548c\u4e2d\u95f4\u4ef6\u901a\u4fe1\u7684\u6d41\u91cf\u4e5f\u975e\u5e38\u91cd\u8981\uff0c\u662f\u672a\u6765\u6574\u4e2a\u5fae\u670d\u52a1 Mesh \u5316\u4e2d\u91cd\u8981\u7684\u4e00\u73af\u3002 FaaS\uff08Function as a Service\uff09\u4e5f\u662f\u672a\u6765\u5fae\u670d\u52a1\u67b6\u6784\u91cd\u8981\u7684\u6f14\u8fdb\u65b9\u5411\u4e4b\u4e00\uff0c\u5728 FaaS \u67b6\u6784\u4e2d\uff0cService Mesh \u540c\u6837\u53ef\u4ee5\u4f5c\u4e3a\u5e95\u5c42\u57fa\u7840\u8bbe\u65bd\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\u3002","title":"1\u3001\u4e2d\u95f4\u4ef6 Mesh \u5316\u7684\u53ef\u884c\u6027"},{"location":"chap2/10chap3_mesh/#1-1-mesh","text":"\u8457\u540d\u7684\u6570\u636e\u9762\u5df2\u7ecf\u652f\u6301\u4e86\u8bf8\u591a\u6570\u636e\u5e93\u548c\u961f\u5217\u4e2d\u95f4\u4ef6","title":"1-1 \u4e2d\u95f4\u4ef6 Mesh \u5316"},{"location":"chap2/10chap3_mesh/#1-2-redis","text":"Envoy \u53ef\u4ee5\u4f5c\u4e3a Redis \u7684\u4ee3\u7406\uff0c\u90e8\u7f72\u5728\u6bcf\u4e2a\u670d\u52a1\u7684\u8282\u70b9\u4e0a\uff0c\u8fd9\u6837\u5c31\u65e0\u987b\u4f20\u7edf\u7684 Redis \u4e2d\u95f4\u4ef6\u8d1f\u8d23 Redis \u96c6\u7fa4\u7684\u4ee3\u7406\u5de5\u4f5c\uff0c\u4e5f\u4e0d\u9700\u8981\u4f20\u7edf Redis \u5b98\u65b9\u63d0\u4f9b\u7684 Smart Client\u3002 Envoy \u53ef\u4ee5\u66ff\u4ee3\u8fd9\u90e8\u5206\u529f\u80fd\uff0c\u63a7\u5236 Redis \u96c6\u7fa4\uff0c\u8def\u7531\u5230\u6b63\u786e\u7684 hash \u5206\u7247\u8282\u70b9\u4e0a\u3002 \u4f7f\u7528 Envoy \u505a Redis \u4ee3\u7406\uff0c\u65e2\u907f\u514d\u4e86\u4f20\u7edf\u7684 Smart Client \u7684\u5347\u7ea7\u7ef4\u62a4\u95ee\u9898\uff0c\u4e5f\u907f\u514d\u4e86\u4f20\u7edf\u7684 Redis \u4e2d\u95f4\u4ef6\u4e2d\u5fc3\u5316\u7684\u95ee\u9898\u3002 \u901a\u8fc7 Mesh \u7684\u67b6\u6784\u3001Metrics \u6ce8\u5165\u7b49\u65b9\u5f0f\uff0c\u53ef\u4ee5\u770b\u5230\u5230\u5e95\u662f\u54ea\u4e2a\u670d\u52a1\u8c03\u7528\u7684 Redis\uff0c\u518d\u914d\u5408\u670d\u52a1\u95f4\u7684\u94fe\u8def\u8c03\u7528\u56fe\uff0c\u8fd9\u6837\u6574\u4e2a\u5185\u7f51\u95f4\u6240\u6709\u6d41\u91cf\u7684\u94fe\u8def\u8c03\u7528\u56fe\u5c31\u53ef\u4ee5\u7ed8\u5236\u51fa\u6765\u4e86\u3002 \u76ee\u524d Envoy \u7684 Redis \u4ee3\u7406\u652f\u6301\u4ee5\u4e0b\u529f\u80fd\uff1a Redis \u534f\u8bae\u7684\u7f16\u89e3\u7801\uff1b \u57fa\u4e8e\u54c8\u5e0c\u7684\u5206\u7247\uff1b Ketama \u4e00\u81f4\u6027\u54c8\u5e0c\u7b97\u6cd5\uff1b \u8be6\u7ec6\u7684\u6570\u636e\u7edf\u8ba1\u4fe1\u606f\uff1b \u5bf9\u4e8e Redis \u8282\u70b9\u7684\u4e3b\u52a8\u548c\u88ab\u52a8\u5065\u5eb7\u68c0\u67e5\uff1b \u4e0a\u6e38\u4ee3\u7406\u548c\u4e0b\u6e38\u4ee3\u7406\u5206\u522b\u8fdb\u884c\u8eab\u4efd\u8ba4\u8bc1\u3002 Envoy \u5bf9\u4e8e Redis \u7684\u652f\u6301\u76f8\u5bf9\u6bd4\u8f83\u7b80\u5355\uff0c\u5f53\u7136\u672a\u6765\u793e\u533a\u4e5f\u5728\u89c4\u5212\u652f\u6301\u66f4\u591a\u7684\u529f\u80fd\uff0c\u5305\u62ec\u7194\u65ad\u3001\u94fe\u8def\u8ffd\u8e2a\u3001\u91cd\u8bd5\u7b49 \u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u4ea7\u54c1\uff08\u6bd4\u5982 Redis \u96c6\u7fa4\u4e2d\u95f4\u4ef6\u3001MySQL \u96c6\u7fa4\u4e2d\u95f4\u4ef6\uff09\u7684\u529f\u80fd\u4e3b\u8981\u662f\u5bf9\u6570\u636e\u505a\u5206\u7247\u5904\u7406\uff0c\u4ee5\u89e3\u51b3\u5355\u4e2a Redis \u6216\u8005 MySQL \u8282\u70b9\u65e0\u6cd5\u5904\u7406\u7684\u8d1f\u8f7d\u3002 \u8fd9\u4e9b\u529f\u80fd\u6700\u65e9\u4e5f\u5728 SDK \u4e2d\uff0c\u56e0\u4e3a\u7ef4\u62a4\u5347\u7ea7\u4e0d\u65b9\u4fbf\uff0c\u6240\u4ee5\u6f14\u8fdb\u6210\u4e86\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u3002 \u968f\u7740 Mesh \u5316\u67b6\u6784\u7684\u6d41\u884c\uff0c\u5728\u670d\u52a1\u672c\u5730\u90e8\u7f72\u4e00\u4e2a Sidecar\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u4ea7\u54c1\u4e2d\u5fc3\u5316\u7684\u95ee\u9898\u3002 \u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u7684 Mesh \u5316\u548c\u4f20\u7edf\u7684\u670d\u52a1 Mesh \u5316 \uff0c\u5173\u6ce8\u7684\u70b9\u7565\u6709\u4e0d\u540c\uff1a \u6570\u636e\u5e93\u7684\u4e2d\u95f4\u4ef6\u4ea7\u54c1\u66f4\u5173\u6ce8\u7684\u662f\u5bf9\u4e8e\u6570\u636e\u7684\u5206\u7247\u5904\u7406 \uff0c\u6bd4\u5982 MySQL \u7684\u5206\u5e93\u5206\u8868\u7b49\u7b97\u6cd5\u3001Redis \u96c6\u7fa4\u7684\u5206\u7247\u7b97\u6cd5\u7b49\u3002\u4f46\u4e5f\u6709\u5f88\u591a\u529f\u80fd\u662f\u901a\u7528\u7684\uff0c \u6bd4\u5982\u9650\u6d41\u7194\u65ad\u7b49\u6cbb\u7406\u529f\u80fd\u3001\u94fe\u8def\u8ffd\u8e2a\u3001Metrics \u76d1\u63a7\uff0c\u751a\u81f3\u670d\u52a1\u53d1\u73b0\u7b49\u529f\u80fd \u3002","title":"1-2 Redis \u4ee3\u7406"},{"location":"chap2/10chap3_mesh/#1-3-faas","text":"FaaS\uff08Function as a Service\uff09\u662f\u4e00\u79cd\u5728\u65e0\u72b6\u6001\u5bb9\u5668\u4e2d\u8fd0\u884c\u7684\u4e8b\u4ef6\u9a71\u52a8\u6a21\u578b \u3002 \u7b80\u5355\u6765\u8bf4\uff0cFunction \u662f\u6bd4 Service \u66f4\u5c0f\u7684\u7a0b\u5e8f\u5355\u5143\uff0c \u5982\u679c\u8981\u8fdb\u884c\u6807\u51c6\u5316\u7684 FaaS \u5316\u6539\u9020\uff0c\u5c31\u9700\u8981\u8fdb\u4e00\u6b65\u62c6\u5206\uff0c\u5c06\u5fae\u670d\u52a1\u4e2d\u7684\u6bcf\u4e2a\u65b9\u6cd5\u90fd\u62c6\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u670d\u52a1 \u3002 FaaS \u4f9d\u7136\u662f\u4e00\u79cd\u975e\u5e38\u7406\u60f3\u5316\u7684\u67b6\u6784\uff0c\u6bd4\u5982\u5728\u670d\u52a1 0 \u8282\u70b9\u7684\u60c5\u51b5\u4e0b\u8981\u6d88\u8017\u5927\u91cf\u7684\u65f6\u95f4\u7b49\u5f85\u670d\u52a1\u542f\u52a8\uff0c\u4f46 FaaS \u4e2d\u7684\u4e00\u4e9b\u6838\u5fc3\u601d\u60f3\uff0c\u4f9d\u7136\u662f\u5fae\u670d\u52a1\u67b6\u6784\u7684\u53d1\u5c55\u8d8b\u52bf\uff0c\u6216\u8005\u8bf4\u5b83\u4eec\u53ef\u4ee5\u76f4\u63a5\u843d\u5730\uff0c\u6bd4\u5982\u5f3a\u5927\u7684\u81ea\u52a8\u6269\u7f29\u5bb9\u80fd\u529b\u3001\u57fa\u4e8e\u5f02\u6b65\u7684\u4e8b\u4ef6\u9a71\u52a8\u6a21\u578b\u7b49 FaaS \u7684\u5f00\u6e90\u65b9\u6848\u6709 Knative\u3001OpenFaaS\u3001Fission\u3001Kubeless \u7b49\uff0c\u4e0b\u9762\u6211\u4eec\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u51e0\u79cd\u5e38\u89c1\u7684\u5f00\u6e90\u65b9\u6848\u3002 Knative Knative \u662f\u8c37\u6b4c\u7275\u5934\u53d1\u8d77\u7684 Serverless \u9879\u76ee\uff0c\u662f\u57fa\u4e8e Kubernetes \u548c Istio \u7684 Serverless \u89e3\u51b3\u65b9\u6848\u3002 OpenFaaS OpenFaaS \u662f\u4e00\u4e2a\u4f7f\u7528 Docker \u6784\u5efa\u65e0\u670d\u52a1\u5668\uff08Serverless\uff09\u529f\u80fd\u7684\u6846\u67b6\uff0c\u53ef\u4ee5\u90e8\u7f72\u5728 Kubernetes \u6216\u8005 Swarm \u5e73\u53f0\u3002\u901a\u8fc7 Watchdog \u542f\u52a8\u8fdb\u7a0b\u7684\u65b9\u5f0f\u8fdb\u884c\u51fd\u6570\u5f0f\u8c03\u7528\u3002 Fission Fission \u662f\u4e00\u6b3e\u57fa\u4e8e Kubernetes \u7684 FaaS \u6846\u67b6\uff0c\u901a\u8fc7 Fission \u53ef\u4ee5\u8f7b\u800c\u6613\u4e3e\u5730\u5c06\u51fd\u6570\u53d1\u5e03\u6210 HTTP \u670d\u52a1\u3002\u5b83\u7684\u4e3b\u8981\u7279\u70b9\u662f Fission \u7ef4\u62a4\u4e00\u4e2a\u5bb9\u5668\u6c60\uff0c\u53ef\u4ee5\u505a\u5230\u51fd\u6570 100ms \u51b7\u542f\u52a8\u3002 Kubeless Kubeless \u662f\u57fa\u4e8e Kubernetes \u7684 Serverless \u6846\u67b6\uff0c\u501f\u52a9 Kubernetes \u63d0\u4f9b\u81ea\u52a8\u6269\u7f29\u5bb9\u3001API \u8def\u7531\u3001\u76d1\u63a7\u7684\u529f\u80fd\u3002","title":"1-3 FaaS"},{"location":"chap2/10chap3_mesh/#1-4-knative","text":"Knative \u5305\u542b\u4e09\u4e2a\u6838\u5fc3\u7ec4\u4ef6\uff0c \u5206\u522b\u662f\u8d1f\u8d23\u670d\u52a1\u5904\u7406\u7684 Serving\u3001\u4e8b\u4ef6\u5904\u7406\u7684 Eventing\uff0c\u4ee5\u53ca\u8d1f\u8d23\u4e91\u539f\u751f CI/CD \u6784\u5efa\u7684 Tekton \u3002 Serving Knative Serving \u7ec4\u4ef6\u4f9d\u6258\u4e8e Kubernetes \u5e73\u53f0\u548c Istio\uff0c\u63d0\u4f9b\u670d\u52a1\u81ea\u52a8\u6269\u7f29\u5bb9\u3001\u670d\u52a1\u8def\u7531\u3001\u6d41\u91cf\u4ee3\u7406\u3001\u5bb9\u5668\u90e8\u7f72\u7b49\u529f\u80fd\u3002 Eventing Eventing \u4e3b\u8981\u7531\u4e8b\u4ef6\u6e90\uff08EventSource\uff09\u3001\u4e8b\u4ef6\u5904\u7406\uff08Flow\uff09\u4ee5\u53ca\u4e8b\u4ef6\u6d88\u8d39\u8005\uff08EventConsumer\uff09\u4e09\u90e8\u5206\u6784\u6210\uff0c\u5b9a\u4e49\u4e86 CloudEvent \u7684\u901a\u7528\u4e8b\u4ef6\u6807\u51c6\u3002 Tekton Tekton \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u4e14\u7075\u6d3b\u7684 Kubernetes \u4e91\u539f\u751f CI/CD \u5f00\u6e90\u6846\u67b6\u3002 \u4e0b\u56fe\u4e2d\u7684 Route \u53ef\u4ee5\u7406\u89e3\u4e3a Istio Gateway \u7684\u89d2\u8272\u3002\u5b9e\u9645\u4e0a\uff0c\u5927\u591a\u6570 FaaS \u67b6\u6784\uff0c\u90fd\u6709\u4e00\u4e2a\u7c7b\u4f3c API Gateway \u7684\u89d2\u8272\uff0c\u4e3b\u8981\u7528\u6765\u5904\u7406\u6d41\u91cf\u7684\u8f6c\u53d1\uff0c\u5728 Pod \u6570\u91cf\u4e3a 0 \u65f6\uff0c\u4e5f\u4f1a\u505a\u4e00\u4e9b\u7279\u6b8a\u5904\u7406\uff0c\u6bd4\u5982\u6b64\u65f6\u8981 hold \u4f4f\u6d41\u91cf\uff0c\u7b49\u5f85 Pod \u542f\u52a8\u3002 \u6d41\u91cf\u7ecf\u8fc7 Gateway\uff08Route\uff09\u540e\uff0c\u4f1a\u6709\u4e24\u4e2a\u5206\u652f\uff0c \u4e00\u4e2a\u662f\u670d\u52a1\u7684 Pod \u5b58\u5728\u7684\u65f6\u5019\uff0c\u6d41\u91cf\u4f1a\u76f4\u63a5\u8def\u7531\u5230 Pod \u4e0a\u9762\uff1b \u53e6\u5916\u4e00\u4e2a\u5728 Pod \u7f29\u5bb9\u5230 0 \u7684\u60c5\u51b5\u4e0b\uff0c\u4f1a\u8f6c\u53d1\u5230\u4e00\u4e2a Activator \u7684\u7ec4\u4ef6\u4e2d\uff0c \u8fd9\u4e2a\u7ec4\u4ef6\u7684\u4e3b\u8981\u529f\u80fd\u662f\u5bf9\u5bb9\u5668\u8d44\u6e90\u7684\u8c03\u5ea6 \u3002 \u5f53\u6709\u6d41\u91cf\u88ab\u8f6c\u53d1\u5230 Activator \u7ec4\u4ef6\u65f6\uff0c\u5b83\u4f1a\u4e3b\u52a8\u901a\u77e5 Autoscaler \u7ec4\u4ef6\u8fdb\u884c\u6269\u5bb9\u64cd\u4f5c\uff0c\u8fd9\u65f6 Autoscaler \u4f1a\u521b\u5efa\u65b0\u7684 Pod\uff0c\u63d0\u4f9b\u670d\u52a1\u3002 \u6b64\u65f6 Activator \u5bf9\u542f\u52a8\u7684 Pod \u8fdb\u884c\u5065\u5eb7\u68c0\u67e5\uff0c\u68c0\u67e5\u901a\u8fc7\u540e\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u76f8\u5e94\u7684 Pod \u4e0a\u9762\u3002 Activator \u7ec4\u4ef6\u5904\u7406\u5b8c\u6d41\u91cf\u540e\uff0c\u4f1a\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9 Gateway \u5728\u6d41\u91cf\u88ab\u8f6c\u53d1\u5230 Activator \u7ec4\u4ef6\u8fd9\u4e2a\u5206\u652f\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c Pod \u6570\u91cf\u4e3a 0\uff0c\u672c\u6b21\u6d41\u91cf\u5904\u7406\u7684\u65f6\u95f4\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u5c31\u53d6\u51b3\u4e8e Pod \u542f\u52a8\u7684\u65f6\u95f4\uff0c\u800c\u8fd9\u4e2a\u65f6\u95f4\u5927\u6982\u7387\u662f\u79d2\u7ea7\u522b\u7684 \u3002 \u4f46\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u4e00\u822c\u7684\u8bf7\u6c42\u9700\u8981\u6beb\u79d2\u7ea7\u522b\u8fd4\u56de\u7ed3\u679c\uff0c\u79d2\u7ea7\u522b\u7684\u54cd\u5e94\u901f\u5ea6\u5f88\u96be\u63a5\u53d7\uff0c\u8fd9\u4e5f\u662f FaaS \u67b6\u6784\u76ee\u524d\u5728\u843d\u5730\u4e2d\u9762\u4e34\u7684\u6700\u5927\u95ee\u9898\uff0c\u5927\u90e8\u5206\u5bf9\u54cd\u5e94\u901f\u5ea6\u8981\u6c42\u6bd4\u8f83\u9ad8\u7684\u573a\u666f\uff0cPod \u7f29\u5bb9\u4e3a 0 \u90fd\u662f\u96be\u4ee5\u63a5\u53d7\u7684\u3002 \u6240\u4ee5 Knative \u4e5f\u63d0\u4f9b\u4e86 Pod \u662f\u5426\u7f29\u5bb9\u5230 0 \u7684\u9009\u9879\uff0c\u8fd9\u6837\u66f4\u6709\u5229\u4e8e FaaS \u67b6\u6784\u7684\u843d\u5730\u3002\u5c3d\u7ba1\u6ca1\u6709\u505a\u5230\u5b8c\u5168\u7684 Serverless\uff0c\u4f46\u80fd\u591f\u62e5\u6709\u5f3a\u5927\u7684\u6269\u7f29\u5bb9\u80fd\u529b\u5df2\u7ecf\u975e\u5e38\u6709\u8bf1\u60d1\u529b\u4e86\u3002","title":"1-4 Knative"},{"location":"chap2/10chap3_mesh/#1-5-openfaas","text":"\u7edf\u7684\u5fae\u670d\u52a1\u8c03\u7528\u3002\u5728\u8fd9\u5f20\u56fe\u7247\u4e2d\uff0c\u6211\u4eec\u7684\u9700\u6c42\u662f\u4ece\u6570\u636e\u5e93\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u5e76\u6839\u636e\u83b7\u53d6\u7684\u6570\u636e\u751f\u6210\u4e00\u4e2a PDF \u6587\u4ef6\u4e0a\u4f20\u5230 S3 \u670d\u52a1\u5668\u4e2d\u3002\u4f46\u662f\u8fd9\u4e2a\u573a\u666f\u6d88\u8017\u7684\u65f6\u95f4\u4f1a\u6bd4\u8f83\u957f\uff0c\u5927\u6982\u662f 2 \u5206\u949f\u5de6\u53f3\uff0c\u800c\u4e14\u4e0b\u56fe\u7684\u540c\u6b65\u67b6\u6784\uff0c\u4f1a\u963b\u585e\u7a0b\u5e8f\u8fdb\u7a0b\uff0c\u524d\u7aef\u7684\u54cd\u5e94\u4e5f\u4f1a\u7b49\u5f85\u5f88\u957f\u65f6\u95f4\u3002 \u5728\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u4e00\u822c\u6211\u4eec\u4e5f\u4e0d\u4f1a\u91c7\u7528\u4e0b\u56fe\u7684\u540c\u6b65\u7cfb\u7edf\uff0c\u800c\u662f\u91c7\u7528\u5f02\u6b65\u961f\u5217\u7cfb\u7edf\u89e3\u51b3\uff1a\u5c06\u751f\u6210 PDF \u4f5c\u4e3a\u4e8b\u4ef6\u5b58\u5165\u961f\u5217\u4e2d\uff0c\u901a\u8fc7\u961f\u5217\u6d88\u8d39\u751f\u6210 PDF \u5e76\u4e0a\u4f20\u5230 S3 \u670d\u52a1\u5668\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5927\u5927\u63d0\u9ad8\u5fae\u670d\u52a1\u7684\u540c\u6b65\u54cd\u5e94\u901f\u5ea6\u4e86\u3002 \u5728 FaaS \u4e2d\u6709\u6ca1\u6709\u66f4\u597d\u7684\u89e3\u51b3\u65b9\u6848\u5462\uff1f\u6211\u4eec\u6765\u770b OpenFaaS \u4e2d\u7684\u5f02\u6b65\u65b9\u6848\u3002","title":"1-5 OpenFaaS"},{"location":"chap2/10chap3_mesh/#1-6","text":"\u5728 OpenFaaS \u4e2d\uff0c OpenFaaS \u5c06\u8bf7\u6c42\u4f5c\u4e3a\u4e8b\u4ef6\u76f4\u63a5\u653e\u5165 NATS \u8fd9\u4e2a\u961f\u5217\u7cfb\u7edf\u4e2d\uff0c\u5bf9\u4e8e\u4f7f\u7528\u8005\u6765\u8bf4\uff0c\u4ed6\u5e76\u4e0d\u9700\u8981\u5173\u5fc3\u8fd9\u662f\u5426\u662f\u4e00\u4e2a\u5f02\u6b65\u8c03\u7528\u3002 \u8fd9\u4e2a\u8c03\u7528\u7684\u7f16\u7a0b\u65b9\u5f0f\uff0c\u4f9d\u7136\u662f HTTP \u7684\u65b9\u5f0f\uff0c\u53ea\u662f OpenFaaS Gateway \u81ea\u52a8\u5c06\u6b64\u6b21 HTTP \u8c03\u7528\u653e\u5165\u4e86 NATS \u961f\u5217\u4e2d\uff0c\u901a\u8fc7 queue-worker\u8fd9\u4e2a\u8fdb\u7a0b\u8fdb\u884c\u961f\u5217\u6d88\u8d39\uff0c\u518d\u901a\u8fc7 HTTP \u8bf7\u6c42 Generate Statement \u670d\u52a1\u7684\u65b9\u5f0f\u89e6\u53d1\u6b64\u6b21\u670d\u52a1\u8c03\u7528\uff0c \u7528\u770b\u8d77\u6765\u540c\u6b65\u7684\u65b9\u5f0f\u5b8c\u6210\u4e86\u6574\u4e2a\u5f02\u6b65\u8c03\u7528 \u3002 \u6574\u4e2a\u8fd0\u884c\u8fc7\u7a0b \u5728\u8fd9\u4e2a\u67b6\u6784\u4e2d\uff0c\u4f7f\u7528\u8005\u65e0\u987b\u5173\u5fc3\u751a\u81f3\u65e0\u987b\u611f\u77e5 NATS \u961f\u5217\u7cfb\u7edf\uff0c\u5bf9\u4e8e\u4f7f\u7528\u8005\u6765\u8bf4\uff0c\u8fd9\u770b\u8d77\u6765\u5c31\u662f\u4e00\u6b21\u666e\u901a\u7684 HTTP \u670d\u52a1\u8c03\u7528\u3002 \u800c PDF \u751f\u6210\u670d\u52a1\u7684\u7f16\u5199\u8005\uff0c\u4e5f\u4e0d\u9700\u8981\u5904\u7406\u590d\u6742\u7684\u961f\u5217\u6d88\u8d39\uff0c\u5bf9\u4e8e\u4ed6\u6765\u8bf4\uff0c\u4e5f\u548c\u5176\u4ed6\u540c\u6b65\u670d\u52a1\u4e00\u6837\uff0c\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u7684 HTTP \u670d\u52a1\u63a5\u53e3\u5c31\u53ef\u4ee5\u4e86\u3002 FaaS \u67b6\u6784\u8ba9\u961f\u5217\u7cfb\u7edf\u548c\u4e1a\u52a1\u89e3\u8026\uff0c","title":"1-6 \u5f02\u6b65"},{"location":"chap2/1chap2_sm_prods/","text":"\u7b2c\u4e00\u8282 Service Mesh \u5f00\u6e90\u4ea7\u54c1\u4e2d\u7684\u6280\u672f\u9009\u578b Service Mesh\uff0c\u8bd1\u4e3a\u670d\u52a1\u7f51\u683c\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5c06\u53ef\u4ee5\u914d\u7f6e\u7684\u4ee3\u7406\u5c42\u548c\u670d\u52a1\u90e8\u7f72\u5728\u4e00\u8d77\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u57fa\u7840\u8bbe\u65bd\u5c42\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5e76\u63d0\u4f9b\u901a\u7528\u7684\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u8eab\u4efd\u9a8c\u8bc1\u3001\u7cbe\u51c6\u8def\u7531\u3001\u670d\u52a1\u9274\u6743\u7b49\u57fa\u7840\u529f\u80fd\u3002 1\u3001\u4e3a\u4ec0\u4e48\u8981\u5f15\u5165 Service Mesh 1-1 \u6846\u67b6/SDK \u5347\u7ea7\u7ef4\u62a4\u56f0\u96be 1-2 \u65e0\u6cd5\u7ef4\u62a4\u591a\u8bed\u8a00 SDK 1-3 \u8001\u9879\u76ee\u8fc1\u79fb\u56f0\u96be 1-4 \u7f3a\u4e4f\u7edf\u4e00\u63a7\u5236\u9762 \u65e9\u671f\u7684\u6846\u67b6\u57fa\u672c\u4e0a\u90fd\u662f Web \u6846\u67b6\uff0c\u6ca1\u6709\u8003\u8651\u8fdc\u7a0b\u4e0b\u53d1\u914d\u7f6e\u7684\u95ee\u9898\uff0c\u5bf9\u5fae\u670d\u52a1\u7684\u4e00\u4e9b\u914d\u7f6e\u5e76\u4e0d\u80fd\u52a8\u6001\u7684\u66f4\u65b0\uff0c\u4e5f\u6ca1\u6709\u60f3 Service Mesh \u8fd9\u6837\u7684\u7edf\u4e00\u63a7\u5236\u9762\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u53d1\u914d\u7f6e\u4fee\u6539\u670d\u52a1\u95f4\u7684\u8c03\u7528\u884c\u4e3a\uff0c\u6bd4\u5982\u8def\u7531\u914d\u7f6e\u7b49\u3002 2\u3001\u5e38\u89c1\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848 2-1 Istio + Envoy \u73b0\u5982\u4eca\uff0cIstio \u51e0\u4e4e\u662f Service Mesh \u7684\u4ee3\u540d\u8bcd\u4e86\uff0c Istio \u5305\u542b\u63a7\u5236\u9762 Istiod \u548c\u6570\u636e\u9762 Envoy \u4e24\u4e2a\u7ec4\u4ef6 \u3002 \u5176\u4e2d Istiod \u662f Istio \u7684\u63a7\u5236\u9762\uff0c\u8d1f\u8d23\u914d\u7f6e\u6821\u9a8c\u548c\u4e0b\u53d1\u3001\u8bc1\u4e66\u8f6e\u8f6c\u7b49\u5de5\u4f5c\uff1b Envoy \u5219\u8d1f\u8d23\u6570\u636e\u4ee3\u7406\u548c\u6d41\u91cf\u8def\u7531\u7b49\u5de5\u4f5c\u3002 \u51c6\u786e\u6765\u8bf4 Istio \u5b9e\u9645\u4e0a\u53ea\u662f Service Mesh \u7684\u63a7\u5236\u9762\uff0c\u800c Istio + Envoy \u624d\u7ec4\u6210\u6574\u4e2a Service Mesh \u4f53\u7cfb\uff0c\u8fd9\u6709\u70b9\u50cf GNU/Linux\uff0c\u901a\u5e38\u88ab\u7b80\u5355\u5730\u79f0\u4e3a Linux\u3002 Istio \u5305\u542b\u8d1f\u8d23\u914d\u7f6e\u4e0b\u53d1\u7684 Pilot\u3001 \u8d1f\u8d23\u8bc1\u4e66\u8f6e\u8f6c\u7684 Citadel \u8d1f\u8d23\u914d\u7f6e\u6821\u9a8c\u7684 Galley\u3002 \u5728 1.5 \u7248\u672c\u53bb\u9664 mixer \u540e\uff0c Istio \u5df2\u7ecf\u53d8\u5f97\u76f8\u5bf9\u7b80\u5355\u4e86\uff0c\u5b83\u7684\u4e3b\u8981\u5de5\u4f5c\u5c31\u662f\u914d\u7f6e\u4e0b\u53d1\u3002 Envoy \u662f C++ \u7f16\u5199\u7684\u9ad8\u6027\u80fd\u8fb9\u7f18\u7f51\u5173\u548c\u4ee3\u7406\u7a0b\u5e8f\uff0c\u652f\u6301 HTTP\u3001gRPC\u3001Thrift\u3001Redis\u3001MongoDB \u7b49\u591a\u79cd\u534f\u8bae\u4ee3\u7406\u3002\u5f53\u7136\u8fd9\u91cc\u9762\u652f\u6301\u6700\u597d\u7684\u8fd8\u662f HTTP\uff0c\u5b83\u51e0\u4e4e\u5177\u5907\u4e86 Service Mesh \u6570\u636e\u9762\u9700\u8981\u7684\u6240\u6709\u529f\u80fd\uff0c\u6bd4\u5982\u670d\u52a1\u53d1\u73b0\u3001\u9650\u6d41\u7194\u65ad\u3001\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3001\u7cbe\u51c6\u6d41\u91cf\u8def\u7531\u7b49\u3002 2-2 Linkerd Linkerd \u662f\u4e91\u539f\u751f\u8f6f\u4ef6\u516c\u53f8 Buoyant \u5f00\u6e90\u7684 Service Mesh \u65b9\u6848\uff0c\u800c Service Mesh \u7684\u6982\u5ff5\u4e5f\u662f Linkerd \u9996\u5148\u63d0\u51fa\u7684 Linkerd \u5f00\u53d1\u4e86 2.0 \u7248\u672c\uff0c \u6570\u636e\u9762\u4f7f\u7528 Rust \u7f16\u5199\uff0c\u63a7\u5236\u9762\u57fa\u4e8e Go \u8bed\u8a00\u5b9e\u73b0 \u3002 mTLS \uff1aLinkerd \u4e3a\u6240\u6709\u7f51\u683c\u5185\u7684\u670d\u52a1\u63d0\u4f9b\u53cc\u5411 TLS \u52a0\u5bc6\u8ba4\u8bc1\u7684\u529f\u80fd\uff0c\u4fdd\u8bc1\u6d41\u91cf\u4f20\u8f93\u5b89\u5168\u3002 \u53ef\u89c2\u6d4b\u6027 \uff1a\u63d0\u4f9b\u4e86 Grafana \u7684\u56fe\u5f62\u754c\u9762\u4ee5\u53ca\u94fe\u8def\u8ffd\u8e2a\u529f\u80fd\u3002 \u534f\u8bae\u652f\u6301 \uff1a\u63d0\u4f9b\u4e86 gRPC\u3001HTTP\u3001HTTP/2 \u7b49\u591a\u79cd\u534f\u8bae\u652f\u6301\u3002 \u8d1f\u8f7d\u5747\u8861 \uff1a\u63d0\u4f9b\u4e86\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u529f\u80fd\uff0c\u5305\u62ec\u57fa\u4e8e\u5f53\u524d\u8bf7\u6c42\u6570\u7684 P2C \u7b97\u6cd5\u3001\u57fa\u4e8e EWMA \u7684\u591a\u79cd\u7b56\u7565\u7684 P2C \u7b97\u6cd5\uff0c\u4ee5\u53ca\u5e38\u89c4\u7684 WRR \u548c RR \u7b97\u6cd5\u3002 \u52a8\u6001\u8def\u7531\u529f\u80fd \uff1a\u652f\u6301\u6839\u636e header \u8bbe\u7f6e\u4e0d\u540c\u7684\u8def\u7531\u89c4\u5219\uff0c\u652f\u6301\u6d41\u91cf\u8f6c\u79fb\u529f\u80fd\uff0c\u53ef\u4ee5\u5728\u4e0d\u540c\u670d\u52a1\u4e4b\u95f4\u3001\u76f8\u540c\u670d\u52a1\u4e0d\u540c\u7248\u672c\u4e4b\u95f4\u505a\u6d41\u91cf\u8f6c\u79fb\u3002 2-3 SOFAMesh SOFAMesh \u662f\u8682\u8681\u91d1\u670d\u5f00\u6e90\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0c\u5305\u542b\u6570\u636e\u9762 MOSN \u548c\u4fee\u6539\u540e\u7684 Istio Pilot \u63a7\u5236\u9762 \u3002\u4e0d\u8fc7\u5728\u6700\u65b0\u7248\u672c\uff0c\u63a7\u5236\u9762\u5df2\u7ecf\u505c\u6b62\u7ef4\u62a4\uff0c\u8f6c\u800c\u548c\u793e\u533a\u5408\u4f5c\uff0c\u4f7f\u7528 Istio \u4f5c\u4e3a\u63a7\u5236\u9762\u3002 \u591a\u534f\u8bae\u8f6c\u53d1 \uff1aMOSN \u652f\u6301\u6700\u597d\u7684\u662f\u8682\u8681\u7684 SOFARPC\uff0c\u6700\u8fd1\u4e5f\u589e\u5f3a\u4e86\u5bf9 Dubbo \u7684\u652f\u6301\uff0c\u5bf9\u4e8e HTTP \u548c HTTP/2 \u7684\u652f\u6301\u8f83\u5f31\u3002\u5982\u679c\u4f60\u7684\u516c\u53f8\u591a\u662f\u57fa\u4e8e HTTP \u548c gRPC \u534f\u8bae\u6784\u5efa\u7684\u5fae\u670d\u52a1\uff0c\u4e0d\u592a\u9002\u5408\u4f7f\u7528\u3002 \u8def\u7531 \uff1a\u652f\u6301 VirtualHost \u548c\u57fa\u4e8e header\u3001URL\u3001Prefix \u7b49\u591a\u79cd\u8def\u7531\u65b9\u5f0f\u3002 \u8d1f\u8f7d\u5747\u8861 \uff1a\u652f\u6301\u57fa\u672c\u7684 RoundRobin \u548c Random \u7b97\u6cd5\u3001\u57fa\u4e8e\u5f53\u524d\u8bf7\u6c42\u6570\u7684 P2C \u7b97\u6cd5\uff0c\u4e5f\u652f\u6301\u57fa\u4e8e host subset \u5206\u7ec4\u8def\u7531\u7b97\u6cd5\uff0c\u4ee5\u5b9e\u73b0\u91d1\u4e1d\u96c0\u53d1\u5e03\u548c\u67d3\u8272\u7b49\u529f\u80fd\u3002 TLS \uff1a\u5bf9\u4e8e HTTP\u3001HTTP/2\u3001SOFARPC \u90fd\u652f\u6301 TLS \u53cc\u5411\u52a0\u5bc6\u3002 \u5e73\u6ed1\u91cd\u542f \uff1a\u9488\u5bf9 Dubbo\u3001SOFARPC \u7b49\u79c1\u6709 RPC \u534f\u8bae\uff0c\u652f\u6301\u5728\u4e0d\u65ad\u5f00\u8fde\u63a5\u7684\u60c5\u51b5\u4e0b\u5e73\u6ed1\u91cd\u542f\uff0c\u4ee5\u4fdd\u8bc1 Sidecar \u5728\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u4e0d\u5f71\u54cd\u4e1a\u52a1\u3002 2-4 Kong Mesh-Kuma \u73b0\u5728 Kong \u63a8\u51fa\u4e86\u57fa\u4e8e Envoy \u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\u2014\u2014Kuma Kuma \u6700\u5927\u7684\u7279\u70b9\u662f\u540c\u65f6\u652f\u6301 Kubernetes \u548c VM \u865a\u62df\u673a \uff0c\u8fd9\u6837\u5373\u4fbf\u516c\u53f8\u5b58\u5728\u591a\u79cd\u8fd0\u884c\u73af\u5883\uff0c\u4e5f\u53ef\u4ee5\u652f\u6301\u3002 \u53e6\u5916\u5b83\u4e5f\u652f\u6301\u5355\u4e00\u63a7\u5236\u9762\u540c\u65f6\u63a7\u5236\u591a\u5957\u96c6\u7fa4\uff0c\u7531\u4e8e\u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u6240\u4ee5\u5728\u6838\u5fc3\u529f\u80fd\u652f\u6301\u4e0a\u548c Istio \u76f8\u5dee\u4e0d\u5927\uff0c\u6bd4\u8f83\u7279\u522b\u7684\u662f\u652f\u6301 Kong \u4f5c\u4e3a\u5165\u53e3\u7f51\u5173\u5c42\u3002\u6b64\u5916 \uff0cKuma \u91c7\u7528 Go \u8bed\u8a00\u7f16\u5199\uff0c\u65b9\u4fbf\u4e8c\u6b21\u5f00\u53d1\u6269\u5c55 2-5 NGINX Service Mesh Nginx \u5305\u542b\u4e00\u4e2a \u5904\u7406\u4e1c\u897f\u6d41\u91cf\u7684 NGINX Plus \u6570\u636e\u9762\u548c\u4e00\u4e2a\u7528\u4f5c\u5165\u53e3\u7f51\u5173\uff08\u5357\u5317\u5411\u6d41\u91cf\uff09\u7684NGINX Plus \uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u63a7\u5236\u9762\u8fdb\u884c\u63a7\u5236\u3002 \u63a7\u5236\u9762\u4e13\u95e8\u4e3a NGINX Plus \u5f00\u53d1\uff0c\u4e0b\u53d1\u914d\u7f6e\u7528\u4e8e\u63a7\u5236 NGINX Plus \u7684\u6570\u636e\u9762\uff0c\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b\u90e8\u5206\u3002 Grafana\uff1a\u7528\u4e8e\u6536\u96c6 Metrics \u6307\u6807\u7684\u53ef\u89c6\u5316\u5c55\u793a\u3002 Kubernetes Ingress Controllers\uff1a\u7ba1\u7406\u5165\u53e3\u548c\u51fa\u53e3\u6d41\u91cf\u3002 SPIRE\uff1a\u590d\u6742\u8bc1\u4e66\u8f6e\u8f6c\u3002 NATS\uff1a\u8d1f\u8d23\u4e0b\u53d1\u914d\u7f6e\uff0c\u6bd4\u5982\u8def\u7531\u4fe1\u606f\u66f4\u65b0\u7b49\u3002 Open Tracing\uff1a\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\uff0c\u540c\u65f6\u652f\u6301 Zipkin \u548c Jaeger\u3002 Prometheus\uff1a\u6536\u96c6 Metrics \u4fe1\u606f\uff0c\u5305\u62ec\u8bf7\u6c42\u6570\uff0c\u8fde\u63a5\u6570\uff0cSSL \u63e1\u624b\u6b21\u6570\u7b49\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cNGINX Plus \u662f Nginx \u6536\u8d39\u7248\u672c\uff0c\u5e76\u4e0d\u662f\u5f00\u6e90\u8f6f\u4ef6\uff0c\u65e0\u6cd5\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\u3002 2-6 Traefik Mesh Traefik Mesh \u7531 Go \u8bed\u8a00\u7f16\u5199\u7684\u5f00\u6e90\u7f51\u5173\u7cfb\u7edf Traefik \u6f14\u8fdb\u800c\u6765\uff0c \u4e0e\u5176\u4ed6\u63d0\u5230\u7684 Mesh \u89e3\u51b3\u65b9\u6848\u4e0d\u540c\uff0cTaeafik Mesh \u5c06 Sidecar \u90e8\u7f72\u5728\u4e86 Kubernetes Node \u8282\u70b9\u4e0a \u3002 \u8fd9\u6837\u7684\u597d\u5904\u662f\u5728\u540c\u4e00\u4e2a Node \u8282\u70b9\u4e0a\u7684 Pod\uff0c\u53ef\u4ee5\u5171\u4eab\u4e00\u4e2a Sidecar\uff0c\u4e0d\u7528\u4e3a\u6bcf\u4e2a Pod \u5355\u72ec\u5206\u914d Sidecar \u8d44\u6e90\uff0c \u4ece\u800c\u8fbe\u5230\u8282\u7701\u8d44\u6e90\u7684\u76ee\u7684\uff0c\u540c\u65f6\u76f8\u5bf9\u4e8e\u5728 Pod \u7684 Container \u91cc\u90e8\u7f72 Sidecar\uff0c\u8fd9\u6837\u4e5f\u65b9\u4fbf\u5347\u7ea7\u7ef4\u62a4 \u3002 \u4f46\u8fd9\u79cd\u505a\u6cd5\u4e5f\u6709\u7f3a\u70b9\uff0c\u8d44\u6e90\u9694\u79bb\u6027\u4e0d\u597d\uff0c\u5bb9\u6613\u76f8\u4e92\u5f71\u54cd\uff0c\u6bd4\u5982\u540c\u4e00\u4e2a Node \u8282\u70b9\u4e0a\u67d0\u4e2a\u670d\u52a1\u51fa\u73b0\u4e86\u95ee\u9898\uff0c\u4ece\u800c\u5360\u7528\u4e86\u66f4\u591a\u7684\u8d44\u6e90\uff0c\u5176\u4ed6\u7684 Pod \u53ef\u80fd\u5c31\u6ca1\u6709\u8d44\u6e90\u53ef\u7528\u4e86\u3002 2-7 Consul Connect Consul Connect \u662f HashiCorp \u516c\u53f8\u5f00\u6e90\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0c \u9700\u8981\u548c Consul \u7ed1\u5b9a\u4f7f\u7528\uff0c\u540c\u6837\u91c7\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0cConsul Connect \u5145\u5f53\u63a7\u5236\u9762\u7684\u89d2\u8272 \u3002 Traffic Director \u662fGoogle Cloud Platform\uff08\u8c37\u6b4c\u4e91\u5e73\u53f0\uff09\u63d0\u4f9b\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0c \u540c\u65f6\u652f\u6301\u865a\u62df\u673a\u548c\u5bb9\u5668\u73af\u5883 \u3002\u5b83\u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u901a\u8fc7 xDS API \u4e0e\u6570\u636e\u9762\u8fdb\u884c\u901a\u4fe1\u3002 Traffic Director \u901a\u8fc7\u96c6\u4e2d\u5316\u7684\u5065\u5eb7\u68c0\u67e5 \u4ee3\u66ff\u4e86 Envoy \u5185\u7f6e\u7f51\u683c\u7684\u5065\u5eb7\u68c0\u67e5\u65b9\u5f0f\uff0c\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\u51cf\u5c11\u4e86\u7f51\u683c\u5065\u5eb7\u68c0\u67e5\u5e26\u6765\u7684\u670d\u52a1\u538b\u529b\uff0c\u4f46\u9700\u8981\u6ce8\u610f\u7684\u662f\u96c6\u4e2d\u5f0f\u7684\u5065\u5eb7\u68c0\u67e5\u65e0\u6cd5\u5904\u7406\u7f51\u7edc\u5206\u533a\u6545\u969c\u7684\u95ee\u9898\u3002 \u5728\u8bf8\u591a\u5f00\u6e90\u89e3\u51b3\u65b9\u6848\u4e2d\uff0c\u90fd\u4f7f\u7528\u4e86 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u6bd4\u5982 Consul\u3001Connnet\u3001Kuma \u7b49\u3002","title":"\u7b2c\u4e00\u8282 Service Mesh \u5f00\u6e90\u4ea7\u54c1\u4e2d\u7684\u6280\u672f\u9009\u578b"},{"location":"chap2/1chap2_sm_prods/#service-mesh","text":"Service Mesh\uff0c\u8bd1\u4e3a\u670d\u52a1\u7f51\u683c\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5c06\u53ef\u4ee5\u914d\u7f6e\u7684\u4ee3\u7406\u5c42\u548c\u670d\u52a1\u90e8\u7f72\u5728\u4e00\u8d77\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u57fa\u7840\u8bbe\u65bd\u5c42\u63a5\u7ba1\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5e76\u63d0\u4f9b\u901a\u7528\u7684\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u8eab\u4efd\u9a8c\u8bc1\u3001\u7cbe\u51c6\u8def\u7531\u3001\u670d\u52a1\u9274\u6743\u7b49\u57fa\u7840\u529f\u80fd\u3002","title":"\u7b2c\u4e00\u8282 Service Mesh \u5f00\u6e90\u4ea7\u54c1\u4e2d\u7684\u6280\u672f\u9009\u578b"},{"location":"chap2/1chap2_sm_prods/#1-service-mesh","text":"","title":"1\u3001\u4e3a\u4ec0\u4e48\u8981\u5f15\u5165 Service Mesh"},{"location":"chap2/1chap2_sm_prods/#1-1-sdk","text":"","title":"1-1 \u6846\u67b6/SDK \u5347\u7ea7\u7ef4\u62a4\u56f0\u96be"},{"location":"chap2/1chap2_sm_prods/#1-2-sdk","text":"","title":"1-2 \u65e0\u6cd5\u7ef4\u62a4\u591a\u8bed\u8a00 SDK"},{"location":"chap2/1chap2_sm_prods/#1-3","text":"","title":"1-3 \u8001\u9879\u76ee\u8fc1\u79fb\u56f0\u96be"},{"location":"chap2/1chap2_sm_prods/#1-4","text":"\u65e9\u671f\u7684\u6846\u67b6\u57fa\u672c\u4e0a\u90fd\u662f Web \u6846\u67b6\uff0c\u6ca1\u6709\u8003\u8651\u8fdc\u7a0b\u4e0b\u53d1\u914d\u7f6e\u7684\u95ee\u9898\uff0c\u5bf9\u5fae\u670d\u52a1\u7684\u4e00\u4e9b\u914d\u7f6e\u5e76\u4e0d\u80fd\u52a8\u6001\u7684\u66f4\u65b0\uff0c\u4e5f\u6ca1\u6709\u60f3 Service Mesh \u8fd9\u6837\u7684\u7edf\u4e00\u63a7\u5236\u9762\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u53d1\u914d\u7f6e\u4fee\u6539\u670d\u52a1\u95f4\u7684\u8c03\u7528\u884c\u4e3a\uff0c\u6bd4\u5982\u8def\u7531\u914d\u7f6e\u7b49\u3002","title":"1-4 \u7f3a\u4e4f\u7edf\u4e00\u63a7\u5236\u9762"},{"location":"chap2/1chap2_sm_prods/#2-service-mesh","text":"","title":"2\u3001\u5e38\u89c1\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848"},{"location":"chap2/1chap2_sm_prods/#2-1-istio-envoy","text":"\u73b0\u5982\u4eca\uff0cIstio \u51e0\u4e4e\u662f Service Mesh \u7684\u4ee3\u540d\u8bcd\u4e86\uff0c Istio \u5305\u542b\u63a7\u5236\u9762 Istiod \u548c\u6570\u636e\u9762 Envoy \u4e24\u4e2a\u7ec4\u4ef6 \u3002 \u5176\u4e2d Istiod \u662f Istio \u7684\u63a7\u5236\u9762\uff0c\u8d1f\u8d23\u914d\u7f6e\u6821\u9a8c\u548c\u4e0b\u53d1\u3001\u8bc1\u4e66\u8f6e\u8f6c\u7b49\u5de5\u4f5c\uff1b Envoy \u5219\u8d1f\u8d23\u6570\u636e\u4ee3\u7406\u548c\u6d41\u91cf\u8def\u7531\u7b49\u5de5\u4f5c\u3002 \u51c6\u786e\u6765\u8bf4 Istio \u5b9e\u9645\u4e0a\u53ea\u662f Service Mesh \u7684\u63a7\u5236\u9762\uff0c\u800c Istio + Envoy \u624d\u7ec4\u6210\u6574\u4e2a Service Mesh \u4f53\u7cfb\uff0c\u8fd9\u6709\u70b9\u50cf GNU/Linux\uff0c\u901a\u5e38\u88ab\u7b80\u5355\u5730\u79f0\u4e3a Linux\u3002 Istio \u5305\u542b\u8d1f\u8d23\u914d\u7f6e\u4e0b\u53d1\u7684 Pilot\u3001 \u8d1f\u8d23\u8bc1\u4e66\u8f6e\u8f6c\u7684 Citadel \u8d1f\u8d23\u914d\u7f6e\u6821\u9a8c\u7684 Galley\u3002 \u5728 1.5 \u7248\u672c\u53bb\u9664 mixer \u540e\uff0c Istio \u5df2\u7ecf\u53d8\u5f97\u76f8\u5bf9\u7b80\u5355\u4e86\uff0c\u5b83\u7684\u4e3b\u8981\u5de5\u4f5c\u5c31\u662f\u914d\u7f6e\u4e0b\u53d1\u3002 Envoy \u662f C++ \u7f16\u5199\u7684\u9ad8\u6027\u80fd\u8fb9\u7f18\u7f51\u5173\u548c\u4ee3\u7406\u7a0b\u5e8f\uff0c\u652f\u6301 HTTP\u3001gRPC\u3001Thrift\u3001Redis\u3001MongoDB \u7b49\u591a\u79cd\u534f\u8bae\u4ee3\u7406\u3002\u5f53\u7136\u8fd9\u91cc\u9762\u652f\u6301\u6700\u597d\u7684\u8fd8\u662f HTTP\uff0c\u5b83\u51e0\u4e4e\u5177\u5907\u4e86 Service Mesh \u6570\u636e\u9762\u9700\u8981\u7684\u6240\u6709\u529f\u80fd\uff0c\u6bd4\u5982\u670d\u52a1\u53d1\u73b0\u3001\u9650\u6d41\u7194\u65ad\u3001\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3001\u7cbe\u51c6\u6d41\u91cf\u8def\u7531\u7b49\u3002","title":"2-1 Istio + Envoy"},{"location":"chap2/1chap2_sm_prods/#2-2-linkerd","text":"Linkerd \u662f\u4e91\u539f\u751f\u8f6f\u4ef6\u516c\u53f8 Buoyant \u5f00\u6e90\u7684 Service Mesh \u65b9\u6848\uff0c\u800c Service Mesh \u7684\u6982\u5ff5\u4e5f\u662f Linkerd \u9996\u5148\u63d0\u51fa\u7684 Linkerd \u5f00\u53d1\u4e86 2.0 \u7248\u672c\uff0c \u6570\u636e\u9762\u4f7f\u7528 Rust \u7f16\u5199\uff0c\u63a7\u5236\u9762\u57fa\u4e8e Go \u8bed\u8a00\u5b9e\u73b0 \u3002 mTLS \uff1aLinkerd \u4e3a\u6240\u6709\u7f51\u683c\u5185\u7684\u670d\u52a1\u63d0\u4f9b\u53cc\u5411 TLS \u52a0\u5bc6\u8ba4\u8bc1\u7684\u529f\u80fd\uff0c\u4fdd\u8bc1\u6d41\u91cf\u4f20\u8f93\u5b89\u5168\u3002 \u53ef\u89c2\u6d4b\u6027 \uff1a\u63d0\u4f9b\u4e86 Grafana \u7684\u56fe\u5f62\u754c\u9762\u4ee5\u53ca\u94fe\u8def\u8ffd\u8e2a\u529f\u80fd\u3002 \u534f\u8bae\u652f\u6301 \uff1a\u63d0\u4f9b\u4e86 gRPC\u3001HTTP\u3001HTTP/2 \u7b49\u591a\u79cd\u534f\u8bae\u652f\u6301\u3002 \u8d1f\u8f7d\u5747\u8861 \uff1a\u63d0\u4f9b\u4e86\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u529f\u80fd\uff0c\u5305\u62ec\u57fa\u4e8e\u5f53\u524d\u8bf7\u6c42\u6570\u7684 P2C \u7b97\u6cd5\u3001\u57fa\u4e8e EWMA \u7684\u591a\u79cd\u7b56\u7565\u7684 P2C \u7b97\u6cd5\uff0c\u4ee5\u53ca\u5e38\u89c4\u7684 WRR \u548c RR \u7b97\u6cd5\u3002 \u52a8\u6001\u8def\u7531\u529f\u80fd \uff1a\u652f\u6301\u6839\u636e header \u8bbe\u7f6e\u4e0d\u540c\u7684\u8def\u7531\u89c4\u5219\uff0c\u652f\u6301\u6d41\u91cf\u8f6c\u79fb\u529f\u80fd\uff0c\u53ef\u4ee5\u5728\u4e0d\u540c\u670d\u52a1\u4e4b\u95f4\u3001\u76f8\u540c\u670d\u52a1\u4e0d\u540c\u7248\u672c\u4e4b\u95f4\u505a\u6d41\u91cf\u8f6c\u79fb\u3002","title":"2-2 Linkerd"},{"location":"chap2/1chap2_sm_prods/#2-3-sofamesh","text":"SOFAMesh \u662f\u8682\u8681\u91d1\u670d\u5f00\u6e90\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0c\u5305\u542b\u6570\u636e\u9762 MOSN \u548c\u4fee\u6539\u540e\u7684 Istio Pilot \u63a7\u5236\u9762 \u3002\u4e0d\u8fc7\u5728\u6700\u65b0\u7248\u672c\uff0c\u63a7\u5236\u9762\u5df2\u7ecf\u505c\u6b62\u7ef4\u62a4\uff0c\u8f6c\u800c\u548c\u793e\u533a\u5408\u4f5c\uff0c\u4f7f\u7528 Istio \u4f5c\u4e3a\u63a7\u5236\u9762\u3002 \u591a\u534f\u8bae\u8f6c\u53d1 \uff1aMOSN \u652f\u6301\u6700\u597d\u7684\u662f\u8682\u8681\u7684 SOFARPC\uff0c\u6700\u8fd1\u4e5f\u589e\u5f3a\u4e86\u5bf9 Dubbo \u7684\u652f\u6301\uff0c\u5bf9\u4e8e HTTP \u548c HTTP/2 \u7684\u652f\u6301\u8f83\u5f31\u3002\u5982\u679c\u4f60\u7684\u516c\u53f8\u591a\u662f\u57fa\u4e8e HTTP \u548c gRPC \u534f\u8bae\u6784\u5efa\u7684\u5fae\u670d\u52a1\uff0c\u4e0d\u592a\u9002\u5408\u4f7f\u7528\u3002 \u8def\u7531 \uff1a\u652f\u6301 VirtualHost \u548c\u57fa\u4e8e header\u3001URL\u3001Prefix \u7b49\u591a\u79cd\u8def\u7531\u65b9\u5f0f\u3002 \u8d1f\u8f7d\u5747\u8861 \uff1a\u652f\u6301\u57fa\u672c\u7684 RoundRobin \u548c Random \u7b97\u6cd5\u3001\u57fa\u4e8e\u5f53\u524d\u8bf7\u6c42\u6570\u7684 P2C \u7b97\u6cd5\uff0c\u4e5f\u652f\u6301\u57fa\u4e8e host subset \u5206\u7ec4\u8def\u7531\u7b97\u6cd5\uff0c\u4ee5\u5b9e\u73b0\u91d1\u4e1d\u96c0\u53d1\u5e03\u548c\u67d3\u8272\u7b49\u529f\u80fd\u3002 TLS \uff1a\u5bf9\u4e8e HTTP\u3001HTTP/2\u3001SOFARPC \u90fd\u652f\u6301 TLS \u53cc\u5411\u52a0\u5bc6\u3002 \u5e73\u6ed1\u91cd\u542f \uff1a\u9488\u5bf9 Dubbo\u3001SOFARPC \u7b49\u79c1\u6709 RPC \u534f\u8bae\uff0c\u652f\u6301\u5728\u4e0d\u65ad\u5f00\u8fde\u63a5\u7684\u60c5\u51b5\u4e0b\u5e73\u6ed1\u91cd\u542f\uff0c\u4ee5\u4fdd\u8bc1 Sidecar \u5728\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u4e0d\u5f71\u54cd\u4e1a\u52a1\u3002","title":"2-3 SOFAMesh"},{"location":"chap2/1chap2_sm_prods/#2-4-kong-mesh-kuma","text":"\u73b0\u5728 Kong \u63a8\u51fa\u4e86\u57fa\u4e8e Envoy \u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\u2014\u2014Kuma Kuma \u6700\u5927\u7684\u7279\u70b9\u662f\u540c\u65f6\u652f\u6301 Kubernetes \u548c VM \u865a\u62df\u673a \uff0c\u8fd9\u6837\u5373\u4fbf\u516c\u53f8\u5b58\u5728\u591a\u79cd\u8fd0\u884c\u73af\u5883\uff0c\u4e5f\u53ef\u4ee5\u652f\u6301\u3002 \u53e6\u5916\u5b83\u4e5f\u652f\u6301\u5355\u4e00\u63a7\u5236\u9762\u540c\u65f6\u63a7\u5236\u591a\u5957\u96c6\u7fa4\uff0c\u7531\u4e8e\u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u6240\u4ee5\u5728\u6838\u5fc3\u529f\u80fd\u652f\u6301\u4e0a\u548c Istio \u76f8\u5dee\u4e0d\u5927\uff0c\u6bd4\u8f83\u7279\u522b\u7684\u662f\u652f\u6301 Kong \u4f5c\u4e3a\u5165\u53e3\u7f51\u5173\u5c42\u3002\u6b64\u5916 \uff0cKuma \u91c7\u7528 Go \u8bed\u8a00\u7f16\u5199\uff0c\u65b9\u4fbf\u4e8c\u6b21\u5f00\u53d1\u6269\u5c55","title":"2-4 Kong Mesh-Kuma"},{"location":"chap2/1chap2_sm_prods/#2-5-nginx-service-mesh","text":"Nginx \u5305\u542b\u4e00\u4e2a \u5904\u7406\u4e1c\u897f\u6d41\u91cf\u7684 NGINX Plus \u6570\u636e\u9762\u548c\u4e00\u4e2a\u7528\u4f5c\u5165\u53e3\u7f51\u5173\uff08\u5357\u5317\u5411\u6d41\u91cf\uff09\u7684NGINX Plus \uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u63a7\u5236\u9762\u8fdb\u884c\u63a7\u5236\u3002 \u63a7\u5236\u9762\u4e13\u95e8\u4e3a NGINX Plus \u5f00\u53d1\uff0c\u4e0b\u53d1\u914d\u7f6e\u7528\u4e8e\u63a7\u5236 NGINX Plus \u7684\u6570\u636e\u9762\uff0c\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b\u90e8\u5206\u3002 Grafana\uff1a\u7528\u4e8e\u6536\u96c6 Metrics \u6307\u6807\u7684\u53ef\u89c6\u5316\u5c55\u793a\u3002 Kubernetes Ingress Controllers\uff1a\u7ba1\u7406\u5165\u53e3\u548c\u51fa\u53e3\u6d41\u91cf\u3002 SPIRE\uff1a\u590d\u6742\u8bc1\u4e66\u8f6e\u8f6c\u3002 NATS\uff1a\u8d1f\u8d23\u4e0b\u53d1\u914d\u7f6e\uff0c\u6bd4\u5982\u8def\u7531\u4fe1\u606f\u66f4\u65b0\u7b49\u3002 Open Tracing\uff1a\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\uff0c\u540c\u65f6\u652f\u6301 Zipkin \u548c Jaeger\u3002 Prometheus\uff1a\u6536\u96c6 Metrics \u4fe1\u606f\uff0c\u5305\u62ec\u8bf7\u6c42\u6570\uff0c\u8fde\u63a5\u6570\uff0cSSL \u63e1\u624b\u6b21\u6570\u7b49\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cNGINX Plus \u662f Nginx \u6536\u8d39\u7248\u672c\uff0c\u5e76\u4e0d\u662f\u5f00\u6e90\u8f6f\u4ef6\uff0c\u65e0\u6cd5\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\u3002","title":"2-5 NGINX Service Mesh"},{"location":"chap2/1chap2_sm_prods/#2-6-traefik-mesh","text":"Traefik Mesh \u7531 Go \u8bed\u8a00\u7f16\u5199\u7684\u5f00\u6e90\u7f51\u5173\u7cfb\u7edf Traefik \u6f14\u8fdb\u800c\u6765\uff0c \u4e0e\u5176\u4ed6\u63d0\u5230\u7684 Mesh \u89e3\u51b3\u65b9\u6848\u4e0d\u540c\uff0cTaeafik Mesh \u5c06 Sidecar \u90e8\u7f72\u5728\u4e86 Kubernetes Node \u8282\u70b9\u4e0a \u3002 \u8fd9\u6837\u7684\u597d\u5904\u662f\u5728\u540c\u4e00\u4e2a Node \u8282\u70b9\u4e0a\u7684 Pod\uff0c\u53ef\u4ee5\u5171\u4eab\u4e00\u4e2a Sidecar\uff0c\u4e0d\u7528\u4e3a\u6bcf\u4e2a Pod \u5355\u72ec\u5206\u914d Sidecar \u8d44\u6e90\uff0c \u4ece\u800c\u8fbe\u5230\u8282\u7701\u8d44\u6e90\u7684\u76ee\u7684\uff0c\u540c\u65f6\u76f8\u5bf9\u4e8e\u5728 Pod \u7684 Container \u91cc\u90e8\u7f72 Sidecar\uff0c\u8fd9\u6837\u4e5f\u65b9\u4fbf\u5347\u7ea7\u7ef4\u62a4 \u3002 \u4f46\u8fd9\u79cd\u505a\u6cd5\u4e5f\u6709\u7f3a\u70b9\uff0c\u8d44\u6e90\u9694\u79bb\u6027\u4e0d\u597d\uff0c\u5bb9\u6613\u76f8\u4e92\u5f71\u54cd\uff0c\u6bd4\u5982\u540c\u4e00\u4e2a Node \u8282\u70b9\u4e0a\u67d0\u4e2a\u670d\u52a1\u51fa\u73b0\u4e86\u95ee\u9898\uff0c\u4ece\u800c\u5360\u7528\u4e86\u66f4\u591a\u7684\u8d44\u6e90\uff0c\u5176\u4ed6\u7684 Pod \u53ef\u80fd\u5c31\u6ca1\u6709\u8d44\u6e90\u53ef\u7528\u4e86\u3002","title":"2-6 Traefik Mesh"},{"location":"chap2/1chap2_sm_prods/#2-7-consul-connect","text":"Consul Connect \u662f HashiCorp \u516c\u53f8\u5f00\u6e90\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0c \u9700\u8981\u548c Consul \u7ed1\u5b9a\u4f7f\u7528\uff0c\u540c\u6837\u91c7\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0cConsul Connect \u5145\u5f53\u63a7\u5236\u9762\u7684\u89d2\u8272 \u3002 Traffic Director \u662fGoogle Cloud Platform\uff08\u8c37\u6b4c\u4e91\u5e73\u53f0\uff09\u63d0\u4f9b\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0c \u540c\u65f6\u652f\u6301\u865a\u62df\u673a\u548c\u5bb9\u5668\u73af\u5883 \u3002\u5b83\u4f7f\u7528 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u901a\u8fc7 xDS API \u4e0e\u6570\u636e\u9762\u8fdb\u884c\u901a\u4fe1\u3002 Traffic Director \u901a\u8fc7\u96c6\u4e2d\u5316\u7684\u5065\u5eb7\u68c0\u67e5 \u4ee3\u66ff\u4e86 Envoy \u5185\u7f6e\u7f51\u683c\u7684\u5065\u5eb7\u68c0\u67e5\u65b9\u5f0f\uff0c\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\u51cf\u5c11\u4e86\u7f51\u683c\u5065\u5eb7\u68c0\u67e5\u5e26\u6765\u7684\u670d\u52a1\u538b\u529b\uff0c\u4f46\u9700\u8981\u6ce8\u610f\u7684\u662f\u96c6\u4e2d\u5f0f\u7684\u5065\u5eb7\u68c0\u67e5\u65e0\u6cd5\u5904\u7406\u7f51\u7edc\u5206\u533a\u6545\u969c\u7684\u95ee\u9898\u3002 \u5728\u8bf8\u591a\u5f00\u6e90\u89e3\u51b3\u65b9\u6848\u4e2d\uff0c\u90fd\u4f7f\u7528\u4e86 Envoy \u4f5c\u4e3a\u6570\u636e\u9762\uff0c\u6bd4\u5982 Consul\u3001Connnet\u3001Kuma \u7b49\u3002","title":"2-7 Consul Connect"},{"location":"chap2/2chap2_sm_envoy/","text":"\u7b2c\u4e8c\u8282 \u6700\u5e38\u7528\u7684\u6570\u636e\u9762 Envoy\u4ecb\u7ecd Envoy \u662f\u4e13\u4e3a\u5927\u578b\u73b0\u4ee3 SOA\uff08\u9762\u5411\u670d\u52a1\u67b6\u6784\uff09\u67b6\u6784\u8bbe\u8ba1\u7684 L7 \u4ee3\u7406\u548c\u901a\u4fe1\u603b\u7ebf\uff0c\u5b83\u65e2\u53ef\u4ee5\u4f5c\u4e3a Service Mesh \u4e2d\u7684\u6570\u636e\u9762\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u5165\u53e3\u7f51\u5173\u5c42\u4f7f\u7528 \uff0c\u53ef\u4ee5\u901a\u8fc7 xDS API \u63a7\u5236 Envoy \u7684\u76d1\u542c\u3001\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u7b49\u884c\u4e3a\u3002 1\u3001\u6838\u5fc3\u529f\u80fd \u9ad8\u6027\u80fd\u8bbe\u8ba1 \uff1a\u91c7\u7528 C++ \u7f16\u5199\uff0c\u62e5\u6709\u826f\u597d\u7684\u56db\u5c42\u3001\u4e03\u5c42\u4ee3\u7406\u6027\u80fd\uff0c\u5728 8 \u6838\u7684\u673a\u5668\u4e0a\uff0cHTTP \u4ee3\u7406\u53ef\u4ee5\u8fbe\u5230 10w \u7684 QPS\uff0cgRPC \u53ef\u4ee5\u8fbe\u5230 15w QPS\uff0c\u5b8c\u5168\u6ee1\u8db3\u4e86 Service Mesh \u4e2d Sidecar \u7684\u5e94\u7528\u573a\u666f\u3002 Filter \u67b6\u6784 \uff1a\u53ef\u4ee5\u5728\u56db\u3001\u4e03\u5c42\u7f16\u5199 Filter \u4ee5\u6269\u5c55 Envoy \u7684\u529f\u80fd\uff0c\u6bd4\u5982\u76d1\u542c\u8fc7\u6ee4\u5668\u3001\u56db\u5c42\u7f51\u7edc\u8fc7\u6ee4\u5668\uff0c\u4ee5\u53ca\u4e03\u5c42\u8fc7\u6ee4\u5668\u3002 \u4e0d\u8fc7 Envoy \u652f\u6301\u6700\u5b8c\u5584\u7684\u8fd8\u662fHTTP \u8fc7\u6ee4\u5668 \uff0c\u652f\u6301\u4e86\u9650\u6d41\u3001\u8def\u7531\u8f6c\u53d1\u3001\u6545\u969c\u6ce8\u5165\u7b49\u591a\u79cd\u670d\u52a1\u6cbb\u7406\u529f\u80fd\uff0c \u826f\u597d\u7684 HTTP/2 \u652f\u6301 \uff1a\u968f\u7740 gRPC \u6846\u67b6\u7684\u6d41\u884c\u4ee5\u53ca\u8fb9\u7f18\u5c42\u7f51\u7edc\u6027\u80fd\u7684\u8981\u6c42\u63d0\u5347\uff0cHTTP/2 \u8d8a\u6765\u8d8a\u88ab\u91cd\u89c6\u3002Envoy \u539f\u751f\u652f\u6301 HTTP/2\uff0c\u53ef\u4ee5\u5728 HTTP \u548c HTTP/2 \u4e4b\u95f4\u505a\u8f6c\u6362\u3002\u6bd4\u5982\u5728 Sidecar \u6a21\u5f0f\u4e2d\uff0c \u65e0\u8bba\u5e94\u7528\u534f\u8bae\u662f HTTP \u8fd8\u662f HTTP/2\uff0cEnvoy \u4e4b\u95f4\u9ed8\u8ba4\u4f7f\u7528 HTTP/2 \u901a\u4fe1 \uff0c\u8fd9\u6837\u6781\u5927\u63d0\u5347\u4e86\u670d\u52a1\u6027\u80fd\u548c\u7a33\u5b9a\u6027\uff0c\u907f\u514d\u4e86 HTTP \u9891\u7e41\u5efa\u7acb\u8fde\u63a5\u5e26\u6765\u7684\u6d88\u8017\u548c\u4e0d\u7a33\u5b9a\u6027\u3002 \u591a\u79cd\u534f\u8bae\u652f\u6301 \uff1a\u4e0d\u4ec5\u652f\u6301 HTTP \u548c HTTP/2\uff0c\u968f\u7740\u793e\u533a\u7684\u53d1\u5c55\uff0cThrift\u3001gRPC\u3001MongoDB\u3001Redis\u3001MySQL \u7b49\u591a\u79cd\u7f51\u7edc\u534f\u8bae\u90fd\u88ab\u652f\u6301\uff0c\u751a\u81f3\u53ef\u4ee5\u4f7f\u7528 Envoy \u505a Redis \u7684 Mesh \u65b9\u6848\uff0c\u7528\u6765\u4ee3\u66ff\u6d41\u884c\u7684 Redis \u4e2d\u95f4\u4ef6\u3002 \u53ef\u89c2\u6d4b\u6027 \uff1a\u652f\u6301\u5f3a\u5927\u7684\u7edf\u8ba1\u7cfb\u7edf\u3002\u65e5\u5fd7\u3001Metrics\u3001\u94fe\u8def\u8ffd\u8e2a\u90fd\u6709\u826f\u597d\u7684\u652f\u6301\u3002 \u8fb9\u7f18\u7f51\u5173 \uff1aEnvoy \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u7f51\u7edc\u4ee3\u7406\u7ec4\u4ef6\uff0c \u5b8c\u5168\u53ef\u4ee5\u4f5c\u4e3a\u5165\u53e3\u7f51\u5173\u5c42\u4f7f\u7528\uff0c\u5728 Kubernetes \u4e2d\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a Egress \u548c Ingress \u4f7f\u7528 \u3002 \u670d\u52a1\u53d1\u73b0 \uff1a\u548c\u5176\u4ed6\u5e38\u89c1\u7684\u7f51\u7edc\u4ee3\u7406\u8f6f\u4ef6\u4e0d\u540c\uff0cEnvoy \u9ed8\u8ba4\u652f\u6301\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u3002 Envoy \u4f7f\u7528\u4e86\u4e00\u5957xDS \u7684\u52a8\u6001 API \uff0c\u83b7\u53d6\u670d\u52a1\u7684\u540e\u7aef\u8282\u70b9\u5e76\u5b9e\u65f6\u66f4\u65b0\uff0c\u7ed3\u5408 Envoy \u5f3a\u5927\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u53ef\u4ee5\u505a\u5230\u6700\u7ec8\u4e00\u81f4\u6027\u3002 Wasm \u6269\u5c55 \uff1aEnvoy \u5728\u6700\u8fd1\u7684 1.17 \u7248\u672c\u589e\u52a0\u4e86\u5bf9 Wasm \u7684\u652f\u6301\u3002Wasm \u5168\u79f0\u4e3a WebAssembly\uff0c\u6700\u65e9\u7528\u5728\u6d4f\u89c8\u5668\u7aef\u7528\u6765\u89e3\u51b3 JavaScript \u6027\u80fd\u95ee\u9898\u548c\u5927\u578b\u9879\u76ee\u56e2\u961f\u534f\u4f5c\u95ee\u9898\u3002\u8fd1\u4e9b\u5e74\uff0c\u5b83\u5f00\u59cb\u5728\u4e00\u4e9b\u540e\u7aef\u6280\u672f\u4e0a\u4f7f\u7528\uff0c\u7528\u6765\u4ee3\u66ff Lua\uff0c\u4f5c\u4e3a\u6838\u5fc3\u7cfb\u7edf\u7684\u6269\u5c55\u65b9\u5f0f\u3002\u56e0\u4e3a Wasm \u53ef\u4ee5\u4f7f\u7528\u591a\u79cd\u8bed\u8a00\u8fdb\u884c\u5f00\u53d1\uff0c\u6240\u4ee5\u65b9\u4fbf\u5bf9\u6838\u5fc3\u7cfb\u7edf\u8fdb\u884c\u6269\u5c55\uff0c\u4e0d\u7528\u62c5\u5fc3\u8bed\u8a00\u95ee\u9898\u3002\u5f53\u7136\u76f8\u5bf9\u4e8e\u539f\u751f\u7684 C++ \u6269\u5c55\u65b9\u5f0f\uff0c\u5b83\u5927\u6982\u6709 3 \u6210\u7684\u6027\u80fd\u635f\u8017\u3002 2\u3001\u67b6\u6784\u8bbe\u8ba1 \u4e0b\u56fe\u662f Envoy \u67b6\u6784\u7684\u8bbe\u8ba1\u56fe\uff0c\u4ece\u56fe\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5165\u6d41\u91cf\u7ecf\u8fc7 Iptables \u52ab\u6301\u88ab\u8f6c\u53d1\u5230\u4e86 Envoy \u7684\u7aef\u53e3\uff0cEnvoy \u901a\u8fc7\u76d1\u542c\u7aef\u53e3\u521b\u5efa\u8fde\u63a5\uff0c\u63d0\u4f9b\u4e03\u5c42\u4ee3\u7406\u670d\u52a1 Iptable \uff1a\u901a\u8fc7 Iptable \u52ab\u6301\uff0c\u5c06\u5165\u53e3\u548c\u51fa\u53e3\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230 Envoy \u4e0a\uff0c\u8fbe\u5230\u52ab\u6301\u6d41\u91cf\u7684\u76ee\u7684\u3002 Listener\uff1aEnvoy \u901a\u8fc7\u5efa\u7acb\u591a\u4e2a\u76d1\u542c\u5668\u63d0\u4f9b\u4e0d\u540c\u7684\u670d\u52a1 \u3002 \u6bd4\u5982\u901a\u8fc7\u76d1\u542c\u7684\u4e24\u4e2a\u7aef\u53e3\u5206\u522b\u8d1f\u8d23 Sidecar \u6a21\u5f0f\u7684\u51fa\u6d41\u91cf\u548c\u5165\u6d41\u91cf\uff0cSidecar \u591a\u4f7f\u7528\u8fd9\u79cd\u8bbe\u8ba1\uff0c\u8fd9\u6837\u53ef\u4ee5\u7b80\u5316\u7f16\u7a0b\u903b\u8f91\uff0c\u4e5f\u53ef\u4ee5\u589e\u5f3a Filter \u7684\u901a\u7528\u6027\u3002\u5982\u679c\u63d0\u4f9b\u4e0d\u540c\u534f\u8bae\uff0cEnvoy \u4e5f\u4f1a\u5efa\u7acb\u4e0d\u540c\u7684\u7aef\u53e3\u6765\u63d0\u4f9b\u670d\u52a1\u3002 Worker \uff1a\u6bcf\u4e2a Listener \u7ef4\u62a4\u4e00\u4e2a\u5bf9\u5e94\u7684 Worker Pool\uff0cEnvoy \u4e3a\u6bcf\u4e2a\u903b\u8f91\u5904\u7406\u5668\u521b\u5efa\u4e00\u4e2a Worker \u7ebf\u7a0b\uff0c\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u65b0\u7684\u7aef\u53e3\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 server \u65f6\uff0cEnvoy \u4e5f\u4f1a\u6839\u636e -concurrency \u521b\u5efa\u5bf9\u5e94\u7684 Worker \u7ebf\u7a0b\uff0c \u8981\u6ce8\u610f\u542f\u52a8\u592a\u591a\u7684 worker \u7ebf\u7a0b\u5e76\u4e0d\u4e00\u5b9a\u662f\u597d\u4e8b \uff0c\u7279\u522b\u662f\u5728 Sidecar \u6a21\u5f0f\uff0c\u6211\u4eec\u5e76\u4e0d\u4f1a\u5206\u914d\u8fc7\u591a\u7684\u903b\u8f91\u6838\u5fc3\u7ed9\u5230 Sidecar\uff0c\u521b\u5efa\u8fc7\u591a\u7684 Worker \u7ebf\u7a0b\u53ef\u80fd\u5bfc\u81f4\u6bcf\u4e2a Worker \u7ebf\u7a0b\u7ef4\u62a4\u7684\u8fde\u63a5\u53d8\u591a\uff0cUpstream \u538b\u529b\u8fc7\u5927\u3002 Filters\uff1a\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e2d\u95f4\u4ef6\uff0c\u901a\u8fc7 Filter\uff0c\u53ef\u4ee5\u505a\u5230\u56db\u5c42\u548c\u4e03\u5c42\u7684\u6d41\u91cf\u8fc7\u6ee4\uff0c\u652f\u6301\u670d\u52a1\u6cbb\u7406\u9700\u8981\u7684\u9650\u6d41\u3001\u7194\u65ad\u7b49\u529f\u80fd \u3002 Cluster Manager \uff1a\u6d41\u91cf\u7ecf\u8fc7 Router\uff0c\u8bc6\u522b\u51fa\u9700\u8981\u8f6c\u53d1\u7684 Cluster\uff0c\u901a\u8fc7 Cluster Manager \u8fdb\u884c\u670d\u52a1\u53d1\u73b0\u548c\u8d1f\u8f7d\u5747\u8861\u7b49\u529f\u80fd\u3002 Upstream \uff1aUpstream \u7ef4\u62a4\u4e86 EndPoint \u7684\u8fde\u63a5\u6c60\uff0c\u901a\u8fc7\u8d1f\u8f7d\u5177\u8861\u5668\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u5408\u9002\u7684 EndPoint \u4e0a\u9762\u3002 Envoy \u4f5c\u4e3a Sidecar \u4f7f\u7528\u65f6\uff0c\u9700\u8981\u548c\u670d\u52a1\u90e8\u7f72\u5728\u540c\u4e00\u53f0\u673a\u5668\u6216\u8005 Pod \u4e2d\uff0c\u7528\u6237\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u65f6\uff0c\u6d41\u91cf\u4f1a\u88ab\u81ea\u52a8\u52ab\u6301\u5230 Envoy \u4e2d\u3002 \u4e0b\u56fe\u662f Productpage \u670d\u52a1\u901a\u8fc7 HTTP \u534f\u8bae\uff0c\u8c03\u7528 review \u670d\u52a1\u7684\u8fc7\u7a0b\u3002 \u901a\u8fc7 Iptables \u5bf9\u6d41\u91cf\u8fdb\u884c\u52ab\u6301\uff0c\u5c06 Productpage \u8bbf\u95ee Reviews \u7684\u6d41\u91cf\u8f6c\u53d1\u5230 Envoy \u7684\u51fa\u6d41\u91cf 15001 \u7aef\u53e3\u4e0a\u3002 Envoy \u5148\u6839\u636e virtual_hosts \u8fdb\u884c\u5339\u914d\uff0c\u518d\u901a\u8fc7\u8def\u7531\u5339\u914d\uff0c\u53d1\u73b0\u8def\u7531\u5bf9\u5e94\u7684 Cluster\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u627e\u5230 Cluster \u5bf9\u5e94\u7684 EndPoint \uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 10.40.0.15:9080 \u7684 Pod \u4e0a\u3002 Reviews \u7684 Pod \u901a\u8fc7 Iptables \u5bf9\u6d41\u91cf\u8fdb\u884c\u52ab\u6301\uff0c\u5c06\u6d41\u91cf\u52ab\u6301\u5230 Envoy \u7684\u5165\u6d41\u91cf\u7aef\u53e3 15006 \u4e0a\u3002 Envoy \u5c06\u672c\u5730\u6d41\u91cf\u8f6c\u53d1\u5230\u5bf9\u5e94\u7684\u672c\u5730\u5730\u5740 127.0.0.1:9080 \uff0c\u8fd9\u91cc\u4e0d\u9700\u8981\u5bf9\u6d41\u91cf\u8fdb\u884c\u8bc6\u522b\uff0c\u56e0\u4e3a\u6d41\u91cf\u88ab\u8f6c\u53d1\u5230\u5165\u6d41\u91cf\u7aef\u53e3 15006 \u4e0a\uff0c\u8fd9\u4e2a\u7aef\u53e3\u7684\u914d\u7f6e\u7528\u4e8e\u672c\u5730\u6d41\u91cf\u7684\u8f6c\u53d1\u3002 \u5230\u8fd9\u91cc\u6574\u4e2a Sidecar \u7684\u6d41\u91cf\u51fa\u5165\u8fc7\u7a0b\u5c31\u7ed3\u675f\u4e86\u3002\u51fa\u5165\u6d41\u91cf\u90fd\u7ecf\u7531 Envoy\uff0c\u6700\u7ec8\u88ab\u6b63\u786e\u7684\u8f6c\u53d1\u5230\u4e86 Reviews \u7684 Pod \u4e0a\u9762\u3002 2\u3001\u9759\u6001\u914d\u7f6e Envoy \u7684\u914d\u7f6e\u5206\u4e3a \u9759\u6001\u914d\u7f6e\u548c\u52a8\u6001\u914d\u7f6e \uff0c\u9759\u6001\u914d\u7f6e\u5c31\u662f\u624b\u52a8\u586b\u5199\u7684\u914d\u7f6e\uff0c\u52a8\u6001\u914d\u7f6e\u662f\u6307\u7531 xDS API \u83b7\u53d6\u7684\u914d\u7f6e \u5982\u4e0b\u4ee3\u7801\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86 Listener \u76d1\u542c\u5668\uff0c\u76d1\u542c\u7aef\u53e3\u4e3a 10000\u3002 virtual_hosts \u5339\u914d\u6240\u6709\u57df\u540d\uff0cRoutes \u7684\u5339\u914d\u89c4\u5219\u4e3a\u6240\u6709 Path\uff0c\u4e5f\u5c31\u662f\u6240\u6709\u8bbf\u95ee 10000 \u7aef\u53e3\u7684\u8bf7\u6c42\u90fd\u4f1a\u88ab\u8f6c\u53d1\u5230 service_google \u670d\u52a1\u3002 listeners: - name: listener_0 address: socket_address: { address: 0.0.0.0, port_value: 10000 } filter_chains: - filters: - name: envoy.http_connection_manager config: stat_prefix: ingress_http codec_type: AUTO route_config: name: local_route virtual_hosts: - name: local_service domains: [\"*\"] // \u5339\u914d\u6240\u6709\u57df\u540d routes: - match: { prefix: \"/\" }// \u5339\u914d\u6240\u6709 path route: { host_rewrite: www.google.com, cluster: service_google } // \u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 service_google \u670d\u52a1 http_filters: - name: envoy.router \u4e0b\u9762\u7684\u914d\u7f6e\u662f service_google \u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4\uff0c\u4ee5\u53ca\u8981\u8f6c\u53d1\u7684\u5730\u5740\u3002 clusters: - name: service_google connect_timeout: 0.25s type: LOGICAL_DNS # Comment out the following line to test on v6 networks dns_lookup_family: V4_ONLY lb_policy: ROUND_ROBIN hosts: [{ socket_address: { address: google.com, port_value: 443 }}] tls_context: { sni: www.google.com } 3\u3001\u8fb9\u7f18\u4ee3\u7406\u6a21\u5f0f Envoy \u4e0d\u4ec5\u53ef\u4ee5\u7528\u4e8e Sidecar \u6a21\u5f0f\uff0c\u4e5f\u53ef\u4ee5\u7528\u4f5c\u8fb9\u7f18\u7f51\u5173\uff0c\u4f46\u662f\u7528\u4f5c\u8fb9\u7f18\u7f51\u5173\u5c42\u6211\u4eec\u6709\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c 3-1 HTTP \u6807\u5934\u6e05\u7406 \u4e00\u4e9b\u5916\u90e8\u4f20\u5165\u7684 header \u53ef\u80fd\u4f1a\u5f71\u54cd\u5185\u90e8\u884c\u4e3a\uff0c\u5e94\u8be5\u7edf\u4e00\u505a\u51fa\u6e05\u7406\u64cd\u4f5c\uff0c\u6bd4\u5982\u6211\u4eec\u7ecf\u5e38\u4f1a\u7528\u5230\u7684 x-forward-for \uff0c\u5728\u53cd\u5411\u4ee3\u7406\u4e2d\uff0c\u672a\u7ecf\u8fc7\u4e00\u5c42\u4ee3\u7406\uff0c\u90fd\u5e94\u8be5\u5c06\u4ee3\u7406\u7684 IP \u8ffd\u52a0\u5728 x-forward-for \u4e2d\uff0c\u4ee5\u4fdd\u8bc1\u901a\u8fc7 x-forward-for \u53ef\u4ee5\u83b7\u53d6\u6700\u539f\u59cb\u7684 IP\uff0c \u5982\u679c\u6709\u5ba2\u6237\u7aef\u6076\u610f\u4f20\u8f93 x-forward-for \uff0c\u4e0d\u505a\u6e05\u9664\u64cd\u4f5c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u62ff\u5230\u9519\u8bef\u7684\u5ba2\u6237\u7aef IP \u3002 \u5728 Envoy \u4e2d\u53ef\u4ee5\u901a\u8fc7 use_remote_address \u8bbe\u7f6e\u4e3a true \u6765\u6e05\u7406 HTTP \u6807\u5934 \u3002 3-2 \u8d85\u65f6\u63a7\u5236 \u8d85\u65f6\u63a7\u5236\u5206\u4e3a\u8fde\u63a5\u8d85\u65f6\u3001\u6d41\u8d85\u65f6\u548c\u8def\u7531\u8d85\u65f6 \u3002 \u8fd9\u4e9b\u8d85\u65f6\u63a7\u5236\u4e0d\u4ec5\u5728\u8fb9\u7f18\u7f51\u5173\u6a21\u5f0f\u4e2d\u9700\u8981\u6ce8\u610f\uff0c\u5728 Sidecar \u6a21\u5f0f\u4e5f\u9700\u8981\u6ce8\u610f\uff0c\u4e00\u4e9b\u4e0d\u5408\u7406\u7684\u8d85\u65f6\u53ef\u80fd\u4f1a\u5f15\u8d77\u670d\u52a1\u7684\u96ea\u5d29\u3002\u867d\u7136\u5728\u5185\u7f51\u670d\u52a1\u8c03\u7528\u65f6\u4e00\u822c\u90fd\u4f1a\u8bbe\u7f6e\u9ed8\u8ba4\u8d85\u65f6\uff0c\u4f46 Sidecar \u5e94\u8be5\u8bbe\u7f6e\u4e00\u4e2a\u9ed8\u8ba4\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u907f\u514d\u670d\u52a1\u6ca1\u6709\u8bbe\u7f6e\u6709\u6548\u8d85\u65f6\u7684\u60c5\u51b5\u5f15\u8d77\u7684\u95ee\u9898\u3002 3-4 \u8fde\u63a5\u8d85\u65f6 Envoy \u4e3a HTTP \u670d\u52a1\u63d0\u4f9b\u4e86\u7a7a\u95f2\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4\u7684\u8bbe\u7f6e \uff0c\u7a7a\u95f2\u8d85\u65f6\u662f\u6307\u4e00\u4e2a\u8fde\u63a5\u5728\u63a5\u6536\u5230\u8bf7\u6c42\u540e\uff0c\u4f1a\u8bbe\u7f6e TCP \u7684 idle Timeout \u7684\u53c2\u6570\uff0c\u4e00\u6bb5\u65f6\u95f4\u5185\u6ca1\u6709\u6536\u5230\u4ee3\u7406\u670d\u52a1\u7684\u54cd\u5e94\u8bf7\u6c42\uff0c\u5219\u4f1a\u65ad\u5f00\u8fde\u63a5\u3002Envoy \u9ed8\u8ba4\u7684\u7a7a\u95f2\u8d85\u65f6\u662f 1 \u5c0f\u65f6\u3002\u8fde\u63a5\u8d85\u65f6\u5bf9\u6240\u6709\u6d41\u751f\u6548\uff0c\u8fde\u63a5\u4e00\u65e6\u65ad\u5f00\uff0c\u6240\u6709\u6d41\u5904\u7406\u4e5f\u4f1a\u4e2d\u65ad\u3002 3-5 \u6d41\u8d85\u65f6 \u6d41\u662f HTTP/2 \u4e2d\u7684\u6982\u5ff5\uff0c\u5728 HTTP/1 \u4e2d\u6ca1\u6709\u6d41\u7684\u6982\u5ff5\uff0cEnvoy \u901a\u8fc7\u5c06 HTTP \u8fde\u63a5\u5bf9\u5e94\u5230\u6d41\u6a21\u5f0f\uff0c\u7edf\u4e00\u8fdb\u884c\u5904\u7406\u3002 HTTP \u8fde\u63a5\u7ba1\u7406\u5668 stream_idle_timeout \u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\u4e3a 5 \u5206\u949f\uff0c\u63a8\u8350\u5bf9\u6240\u6709\u6d41\u8bbe\u7f6e\u5408\u7406\u7684\u8d85\u65f6\u65f6\u95f4\uff0c \u8fd9\u4e2a\u65f6\u95f4\u5c31\u662f\u63a5\u6536\u8bf7\u6c42\u5230\u8fd4\u56de\u6570\u636e\u7684\u5904\u7406\u65f6\u95f4\uff0c\u5982\u679c\u6ca1\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u5efa\u8bae\u8bbe\u7f6e\u4e3a 10s\uff0c\u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\u504f\u957f \u3002\u5982\u679c\u89e6\u53d1\u6b64\u8d85\u65f6\u65f6\u95f4\uff0c\u5219\u4f1a\u51fa\u53d1 504 Gateway Timeout \u7684\u9519\u8bef\u7801\u3002 3-6 \u8def\u7531\u8d85\u65f6 \u9664\u4e86\u8bbe\u7f6e\u5168\u5c40\u7684\u6d41\u8d85\u65f6\u5916\uff0c\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u8def\u7531\u5c42\u9762\u7684\u8d85\u65f6\uff0c\u4e3a\u67d0\u4e9b\u8bf7\u6c42\u8bbe\u7f6e\u7279\u6b8a\u7684\u914d\u7f6e\uff0c\u4e00\u4e9b\u8bf7\u6c42\u53ef\u80fd\u9700\u8981\u66f4\u5feb\u7684\u54cd\u5e94\u901f\u5ea6\uff0c\u6240\u4ee5\u8981\u8bbe\u7f6e\u8f83\u77ed\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ea\u8981\u5728\u8def\u7531\u5c42\u9762\u8bbe\u7f6e\u5373\u53ef\uff0c\u6bd4\u5982\u9488\u5bf9\u67d0\u4e9b Path \u8bbe\u7f6e\u66f4\u77ed\u7684\u8d85\u65f6\u65f6\u95f4\u3002 3-7 \u8fde\u63a5\u9650\u5236 Envoy \u53ef\u4ee5\u9488\u5bf9\u5168\u5c40\u6216\u8005\u76d1\u542c\u5668\u8bbe\u7f6e\u8fde\u63a5\u9650\u5236\u3002\u4e00\u822c\u5355\u4e00\u670d\u52a1\u5668\u53ef\u627f\u8f7d\u7684\u5e76\u53d1\u8fde\u63a5\u6570\u6709\u9650\uff0c\u6839\u636e\u7ebf\u4e0a\u7684\u5cf0\u503c\u8fde\u63a5\u8fd0\u884c\u60c5\u51b5\uff0c\u8bbe\u7f6e\u5408\u7406\u7684\u8fde\u63a5\u8bbe\u7f6e\uff0c \u53ef\u4ee5\u907f\u514d\u56e0\u670d\u52a1\u51fa\u95ee\u9898\u65f6\u54cd\u5e94\u8fc7\u6162\uff0c\u5927\u91cf\u65b0\u5efa HTTP \u8fde\u63a5\u51fb\u57ae Envoy \u7684\u60c5\u51b5\u3002 Envoy \u4e0d\u4ec5\u53ef\u4ee5\u4f5c\u4e3a Service Mesh \u4e2d\u7684 Sidecar \u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u8fb9\u7f18\u7f51\u5173\u4f7f\u7528\uff0c\u5b83\u7684\u672c\u8d28\u5c31\u662f\u4e00\u4e2a\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\uff0cNginx\u3001HAProxy \u80fd\u505a\u7684\u4e8b\u60c5 Envoy \u4e5f\u53ef\u4ee5\u505a\u5f97\u5f88\u597d\u3002","title":"\u7b2c\u4e8c\u8282 \u6700\u5e38\u7528\u7684\u6570\u636e\u9762 Envoy\u4ecb\u7ecd"},{"location":"chap2/2chap2_sm_envoy/#envoy","text":"Envoy \u662f\u4e13\u4e3a\u5927\u578b\u73b0\u4ee3 SOA\uff08\u9762\u5411\u670d\u52a1\u67b6\u6784\uff09\u67b6\u6784\u8bbe\u8ba1\u7684 L7 \u4ee3\u7406\u548c\u901a\u4fe1\u603b\u7ebf\uff0c\u5b83\u65e2\u53ef\u4ee5\u4f5c\u4e3a Service Mesh \u4e2d\u7684\u6570\u636e\u9762\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u5165\u53e3\u7f51\u5173\u5c42\u4f7f\u7528 \uff0c\u53ef\u4ee5\u901a\u8fc7 xDS API \u63a7\u5236 Envoy \u7684\u76d1\u542c\u3001\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u7b49\u884c\u4e3a\u3002","title":"\u7b2c\u4e8c\u8282 \u6700\u5e38\u7528\u7684\u6570\u636e\u9762 Envoy\u4ecb\u7ecd"},{"location":"chap2/2chap2_sm_envoy/#1","text":"\u9ad8\u6027\u80fd\u8bbe\u8ba1 \uff1a\u91c7\u7528 C++ \u7f16\u5199\uff0c\u62e5\u6709\u826f\u597d\u7684\u56db\u5c42\u3001\u4e03\u5c42\u4ee3\u7406\u6027\u80fd\uff0c\u5728 8 \u6838\u7684\u673a\u5668\u4e0a\uff0cHTTP \u4ee3\u7406\u53ef\u4ee5\u8fbe\u5230 10w \u7684 QPS\uff0cgRPC \u53ef\u4ee5\u8fbe\u5230 15w QPS\uff0c\u5b8c\u5168\u6ee1\u8db3\u4e86 Service Mesh \u4e2d Sidecar \u7684\u5e94\u7528\u573a\u666f\u3002 Filter \u67b6\u6784 \uff1a\u53ef\u4ee5\u5728\u56db\u3001\u4e03\u5c42\u7f16\u5199 Filter \u4ee5\u6269\u5c55 Envoy \u7684\u529f\u80fd\uff0c\u6bd4\u5982\u76d1\u542c\u8fc7\u6ee4\u5668\u3001\u56db\u5c42\u7f51\u7edc\u8fc7\u6ee4\u5668\uff0c\u4ee5\u53ca\u4e03\u5c42\u8fc7\u6ee4\u5668\u3002 \u4e0d\u8fc7 Envoy \u652f\u6301\u6700\u5b8c\u5584\u7684\u8fd8\u662fHTTP \u8fc7\u6ee4\u5668 \uff0c\u652f\u6301\u4e86\u9650\u6d41\u3001\u8def\u7531\u8f6c\u53d1\u3001\u6545\u969c\u6ce8\u5165\u7b49\u591a\u79cd\u670d\u52a1\u6cbb\u7406\u529f\u80fd\uff0c \u826f\u597d\u7684 HTTP/2 \u652f\u6301 \uff1a\u968f\u7740 gRPC \u6846\u67b6\u7684\u6d41\u884c\u4ee5\u53ca\u8fb9\u7f18\u5c42\u7f51\u7edc\u6027\u80fd\u7684\u8981\u6c42\u63d0\u5347\uff0cHTTP/2 \u8d8a\u6765\u8d8a\u88ab\u91cd\u89c6\u3002Envoy \u539f\u751f\u652f\u6301 HTTP/2\uff0c\u53ef\u4ee5\u5728 HTTP \u548c HTTP/2 \u4e4b\u95f4\u505a\u8f6c\u6362\u3002\u6bd4\u5982\u5728 Sidecar \u6a21\u5f0f\u4e2d\uff0c \u65e0\u8bba\u5e94\u7528\u534f\u8bae\u662f HTTP \u8fd8\u662f HTTP/2\uff0cEnvoy \u4e4b\u95f4\u9ed8\u8ba4\u4f7f\u7528 HTTP/2 \u901a\u4fe1 \uff0c\u8fd9\u6837\u6781\u5927\u63d0\u5347\u4e86\u670d\u52a1\u6027\u80fd\u548c\u7a33\u5b9a\u6027\uff0c\u907f\u514d\u4e86 HTTP \u9891\u7e41\u5efa\u7acb\u8fde\u63a5\u5e26\u6765\u7684\u6d88\u8017\u548c\u4e0d\u7a33\u5b9a\u6027\u3002 \u591a\u79cd\u534f\u8bae\u652f\u6301 \uff1a\u4e0d\u4ec5\u652f\u6301 HTTP \u548c HTTP/2\uff0c\u968f\u7740\u793e\u533a\u7684\u53d1\u5c55\uff0cThrift\u3001gRPC\u3001MongoDB\u3001Redis\u3001MySQL \u7b49\u591a\u79cd\u7f51\u7edc\u534f\u8bae\u90fd\u88ab\u652f\u6301\uff0c\u751a\u81f3\u53ef\u4ee5\u4f7f\u7528 Envoy \u505a Redis \u7684 Mesh \u65b9\u6848\uff0c\u7528\u6765\u4ee3\u66ff\u6d41\u884c\u7684 Redis \u4e2d\u95f4\u4ef6\u3002 \u53ef\u89c2\u6d4b\u6027 \uff1a\u652f\u6301\u5f3a\u5927\u7684\u7edf\u8ba1\u7cfb\u7edf\u3002\u65e5\u5fd7\u3001Metrics\u3001\u94fe\u8def\u8ffd\u8e2a\u90fd\u6709\u826f\u597d\u7684\u652f\u6301\u3002 \u8fb9\u7f18\u7f51\u5173 \uff1aEnvoy \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u7f51\u7edc\u4ee3\u7406\u7ec4\u4ef6\uff0c \u5b8c\u5168\u53ef\u4ee5\u4f5c\u4e3a\u5165\u53e3\u7f51\u5173\u5c42\u4f7f\u7528\uff0c\u5728 Kubernetes \u4e2d\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a Egress \u548c Ingress \u4f7f\u7528 \u3002 \u670d\u52a1\u53d1\u73b0 \uff1a\u548c\u5176\u4ed6\u5e38\u89c1\u7684\u7f51\u7edc\u4ee3\u7406\u8f6f\u4ef6\u4e0d\u540c\uff0cEnvoy \u9ed8\u8ba4\u652f\u6301\u670d\u52a1\u53d1\u73b0\u7ec4\u4ef6\u3002 Envoy \u4f7f\u7528\u4e86\u4e00\u5957xDS \u7684\u52a8\u6001 API \uff0c\u83b7\u53d6\u670d\u52a1\u7684\u540e\u7aef\u8282\u70b9\u5e76\u5b9e\u65f6\u66f4\u65b0\uff0c\u7ed3\u5408 Envoy \u5f3a\u5927\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u53ef\u4ee5\u505a\u5230\u6700\u7ec8\u4e00\u81f4\u6027\u3002 Wasm \u6269\u5c55 \uff1aEnvoy \u5728\u6700\u8fd1\u7684 1.17 \u7248\u672c\u589e\u52a0\u4e86\u5bf9 Wasm \u7684\u652f\u6301\u3002Wasm \u5168\u79f0\u4e3a WebAssembly\uff0c\u6700\u65e9\u7528\u5728\u6d4f\u89c8\u5668\u7aef\u7528\u6765\u89e3\u51b3 JavaScript \u6027\u80fd\u95ee\u9898\u548c\u5927\u578b\u9879\u76ee\u56e2\u961f\u534f\u4f5c\u95ee\u9898\u3002\u8fd1\u4e9b\u5e74\uff0c\u5b83\u5f00\u59cb\u5728\u4e00\u4e9b\u540e\u7aef\u6280\u672f\u4e0a\u4f7f\u7528\uff0c\u7528\u6765\u4ee3\u66ff Lua\uff0c\u4f5c\u4e3a\u6838\u5fc3\u7cfb\u7edf\u7684\u6269\u5c55\u65b9\u5f0f\u3002\u56e0\u4e3a Wasm \u53ef\u4ee5\u4f7f\u7528\u591a\u79cd\u8bed\u8a00\u8fdb\u884c\u5f00\u53d1\uff0c\u6240\u4ee5\u65b9\u4fbf\u5bf9\u6838\u5fc3\u7cfb\u7edf\u8fdb\u884c\u6269\u5c55\uff0c\u4e0d\u7528\u62c5\u5fc3\u8bed\u8a00\u95ee\u9898\u3002\u5f53\u7136\u76f8\u5bf9\u4e8e\u539f\u751f\u7684 C++ \u6269\u5c55\u65b9\u5f0f\uff0c\u5b83\u5927\u6982\u6709 3 \u6210\u7684\u6027\u80fd\u635f\u8017\u3002","title":"1\u3001\u6838\u5fc3\u529f\u80fd"},{"location":"chap2/2chap2_sm_envoy/#2","text":"\u4e0b\u56fe\u662f Envoy \u67b6\u6784\u7684\u8bbe\u8ba1\u56fe\uff0c\u4ece\u56fe\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5165\u6d41\u91cf\u7ecf\u8fc7 Iptables \u52ab\u6301\u88ab\u8f6c\u53d1\u5230\u4e86 Envoy \u7684\u7aef\u53e3\uff0cEnvoy \u901a\u8fc7\u76d1\u542c\u7aef\u53e3\u521b\u5efa\u8fde\u63a5\uff0c\u63d0\u4f9b\u4e03\u5c42\u4ee3\u7406\u670d\u52a1 Iptable \uff1a\u901a\u8fc7 Iptable \u52ab\u6301\uff0c\u5c06\u5165\u53e3\u548c\u51fa\u53e3\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230 Envoy \u4e0a\uff0c\u8fbe\u5230\u52ab\u6301\u6d41\u91cf\u7684\u76ee\u7684\u3002 Listener\uff1aEnvoy \u901a\u8fc7\u5efa\u7acb\u591a\u4e2a\u76d1\u542c\u5668\u63d0\u4f9b\u4e0d\u540c\u7684\u670d\u52a1 \u3002 \u6bd4\u5982\u901a\u8fc7\u76d1\u542c\u7684\u4e24\u4e2a\u7aef\u53e3\u5206\u522b\u8d1f\u8d23 Sidecar \u6a21\u5f0f\u7684\u51fa\u6d41\u91cf\u548c\u5165\u6d41\u91cf\uff0cSidecar \u591a\u4f7f\u7528\u8fd9\u79cd\u8bbe\u8ba1\uff0c\u8fd9\u6837\u53ef\u4ee5\u7b80\u5316\u7f16\u7a0b\u903b\u8f91\uff0c\u4e5f\u53ef\u4ee5\u589e\u5f3a Filter \u7684\u901a\u7528\u6027\u3002\u5982\u679c\u63d0\u4f9b\u4e0d\u540c\u534f\u8bae\uff0cEnvoy \u4e5f\u4f1a\u5efa\u7acb\u4e0d\u540c\u7684\u7aef\u53e3\u6765\u63d0\u4f9b\u670d\u52a1\u3002 Worker \uff1a\u6bcf\u4e2a Listener \u7ef4\u62a4\u4e00\u4e2a\u5bf9\u5e94\u7684 Worker Pool\uff0cEnvoy \u4e3a\u6bcf\u4e2a\u903b\u8f91\u5904\u7406\u5668\u521b\u5efa\u4e00\u4e2a Worker \u7ebf\u7a0b\uff0c\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u65b0\u7684\u7aef\u53e3\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 server \u65f6\uff0cEnvoy \u4e5f\u4f1a\u6839\u636e -concurrency \u521b\u5efa\u5bf9\u5e94\u7684 Worker \u7ebf\u7a0b\uff0c \u8981\u6ce8\u610f\u542f\u52a8\u592a\u591a\u7684 worker \u7ebf\u7a0b\u5e76\u4e0d\u4e00\u5b9a\u662f\u597d\u4e8b \uff0c\u7279\u522b\u662f\u5728 Sidecar \u6a21\u5f0f\uff0c\u6211\u4eec\u5e76\u4e0d\u4f1a\u5206\u914d\u8fc7\u591a\u7684\u903b\u8f91\u6838\u5fc3\u7ed9\u5230 Sidecar\uff0c\u521b\u5efa\u8fc7\u591a\u7684 Worker \u7ebf\u7a0b\u53ef\u80fd\u5bfc\u81f4\u6bcf\u4e2a Worker \u7ebf\u7a0b\u7ef4\u62a4\u7684\u8fde\u63a5\u53d8\u591a\uff0cUpstream \u538b\u529b\u8fc7\u5927\u3002 Filters\uff1a\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e2d\u95f4\u4ef6\uff0c\u901a\u8fc7 Filter\uff0c\u53ef\u4ee5\u505a\u5230\u56db\u5c42\u548c\u4e03\u5c42\u7684\u6d41\u91cf\u8fc7\u6ee4\uff0c\u652f\u6301\u670d\u52a1\u6cbb\u7406\u9700\u8981\u7684\u9650\u6d41\u3001\u7194\u65ad\u7b49\u529f\u80fd \u3002 Cluster Manager \uff1a\u6d41\u91cf\u7ecf\u8fc7 Router\uff0c\u8bc6\u522b\u51fa\u9700\u8981\u8f6c\u53d1\u7684 Cluster\uff0c\u901a\u8fc7 Cluster Manager \u8fdb\u884c\u670d\u52a1\u53d1\u73b0\u548c\u8d1f\u8f7d\u5747\u8861\u7b49\u529f\u80fd\u3002 Upstream \uff1aUpstream \u7ef4\u62a4\u4e86 EndPoint \u7684\u8fde\u63a5\u6c60\uff0c\u901a\u8fc7\u8d1f\u8f7d\u5177\u8861\u5668\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u5408\u9002\u7684 EndPoint \u4e0a\u9762\u3002 Envoy \u4f5c\u4e3a Sidecar \u4f7f\u7528\u65f6\uff0c\u9700\u8981\u548c\u670d\u52a1\u90e8\u7f72\u5728\u540c\u4e00\u53f0\u673a\u5668\u6216\u8005 Pod \u4e2d\uff0c\u7528\u6237\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u65f6\uff0c\u6d41\u91cf\u4f1a\u88ab\u81ea\u52a8\u52ab\u6301\u5230 Envoy \u4e2d\u3002 \u4e0b\u56fe\u662f Productpage \u670d\u52a1\u901a\u8fc7 HTTP \u534f\u8bae\uff0c\u8c03\u7528 review \u670d\u52a1\u7684\u8fc7\u7a0b\u3002 \u901a\u8fc7 Iptables \u5bf9\u6d41\u91cf\u8fdb\u884c\u52ab\u6301\uff0c\u5c06 Productpage \u8bbf\u95ee Reviews \u7684\u6d41\u91cf\u8f6c\u53d1\u5230 Envoy \u7684\u51fa\u6d41\u91cf 15001 \u7aef\u53e3\u4e0a\u3002 Envoy \u5148\u6839\u636e virtual_hosts \u8fdb\u884c\u5339\u914d\uff0c\u518d\u901a\u8fc7\u8def\u7531\u5339\u914d\uff0c\u53d1\u73b0\u8def\u7531\u5bf9\u5e94\u7684 Cluster\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u627e\u5230 Cluster \u5bf9\u5e94\u7684 EndPoint \uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 10.40.0.15:9080 \u7684 Pod \u4e0a\u3002 Reviews \u7684 Pod \u901a\u8fc7 Iptables \u5bf9\u6d41\u91cf\u8fdb\u884c\u52ab\u6301\uff0c\u5c06\u6d41\u91cf\u52ab\u6301\u5230 Envoy \u7684\u5165\u6d41\u91cf\u7aef\u53e3 15006 \u4e0a\u3002 Envoy \u5c06\u672c\u5730\u6d41\u91cf\u8f6c\u53d1\u5230\u5bf9\u5e94\u7684\u672c\u5730\u5730\u5740 127.0.0.1:9080 \uff0c\u8fd9\u91cc\u4e0d\u9700\u8981\u5bf9\u6d41\u91cf\u8fdb\u884c\u8bc6\u522b\uff0c\u56e0\u4e3a\u6d41\u91cf\u88ab\u8f6c\u53d1\u5230\u5165\u6d41\u91cf\u7aef\u53e3 15006 \u4e0a\uff0c\u8fd9\u4e2a\u7aef\u53e3\u7684\u914d\u7f6e\u7528\u4e8e\u672c\u5730\u6d41\u91cf\u7684\u8f6c\u53d1\u3002 \u5230\u8fd9\u91cc\u6574\u4e2a Sidecar \u7684\u6d41\u91cf\u51fa\u5165\u8fc7\u7a0b\u5c31\u7ed3\u675f\u4e86\u3002\u51fa\u5165\u6d41\u91cf\u90fd\u7ecf\u7531 Envoy\uff0c\u6700\u7ec8\u88ab\u6b63\u786e\u7684\u8f6c\u53d1\u5230\u4e86 Reviews \u7684 Pod \u4e0a\u9762\u3002","title":"2\u3001\u67b6\u6784\u8bbe\u8ba1"},{"location":"chap2/2chap2_sm_envoy/#2_1","text":"Envoy \u7684\u914d\u7f6e\u5206\u4e3a \u9759\u6001\u914d\u7f6e\u548c\u52a8\u6001\u914d\u7f6e \uff0c\u9759\u6001\u914d\u7f6e\u5c31\u662f\u624b\u52a8\u586b\u5199\u7684\u914d\u7f6e\uff0c\u52a8\u6001\u914d\u7f6e\u662f\u6307\u7531 xDS API \u83b7\u53d6\u7684\u914d\u7f6e \u5982\u4e0b\u4ee3\u7801\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86 Listener \u76d1\u542c\u5668\uff0c\u76d1\u542c\u7aef\u53e3\u4e3a 10000\u3002 virtual_hosts \u5339\u914d\u6240\u6709\u57df\u540d\uff0cRoutes \u7684\u5339\u914d\u89c4\u5219\u4e3a\u6240\u6709 Path\uff0c\u4e5f\u5c31\u662f\u6240\u6709\u8bbf\u95ee 10000 \u7aef\u53e3\u7684\u8bf7\u6c42\u90fd\u4f1a\u88ab\u8f6c\u53d1\u5230 service_google \u670d\u52a1\u3002 listeners: - name: listener_0 address: socket_address: { address: 0.0.0.0, port_value: 10000 } filter_chains: - filters: - name: envoy.http_connection_manager config: stat_prefix: ingress_http codec_type: AUTO route_config: name: local_route virtual_hosts: - name: local_service domains: [\"*\"] // \u5339\u914d\u6240\u6709\u57df\u540d routes: - match: { prefix: \"/\" }// \u5339\u914d\u6240\u6709 path route: { host_rewrite: www.google.com, cluster: service_google } // \u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 service_google \u670d\u52a1 http_filters: - name: envoy.router \u4e0b\u9762\u7684\u914d\u7f6e\u662f service_google \u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4\uff0c\u4ee5\u53ca\u8981\u8f6c\u53d1\u7684\u5730\u5740\u3002 clusters: - name: service_google connect_timeout: 0.25s type: LOGICAL_DNS # Comment out the following line to test on v6 networks dns_lookup_family: V4_ONLY lb_policy: ROUND_ROBIN hosts: [{ socket_address: { address: google.com, port_value: 443 }}] tls_context: { sni: www.google.com }","title":"2\u3001\u9759\u6001\u914d\u7f6e"},{"location":"chap2/2chap2_sm_envoy/#3","text":"Envoy \u4e0d\u4ec5\u53ef\u4ee5\u7528\u4e8e Sidecar \u6a21\u5f0f\uff0c\u4e5f\u53ef\u4ee5\u7528\u4f5c\u8fb9\u7f18\u7f51\u5173\uff0c\u4f46\u662f\u7528\u4f5c\u8fb9\u7f18\u7f51\u5173\u5c42\u6211\u4eec\u6709\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c","title":"3\u3001\u8fb9\u7f18\u4ee3\u7406\u6a21\u5f0f"},{"location":"chap2/2chap2_sm_envoy/#3-1-http","text":"\u4e00\u4e9b\u5916\u90e8\u4f20\u5165\u7684 header \u53ef\u80fd\u4f1a\u5f71\u54cd\u5185\u90e8\u884c\u4e3a\uff0c\u5e94\u8be5\u7edf\u4e00\u505a\u51fa\u6e05\u7406\u64cd\u4f5c\uff0c\u6bd4\u5982\u6211\u4eec\u7ecf\u5e38\u4f1a\u7528\u5230\u7684 x-forward-for \uff0c\u5728\u53cd\u5411\u4ee3\u7406\u4e2d\uff0c\u672a\u7ecf\u8fc7\u4e00\u5c42\u4ee3\u7406\uff0c\u90fd\u5e94\u8be5\u5c06\u4ee3\u7406\u7684 IP \u8ffd\u52a0\u5728 x-forward-for \u4e2d\uff0c\u4ee5\u4fdd\u8bc1\u901a\u8fc7 x-forward-for \u53ef\u4ee5\u83b7\u53d6\u6700\u539f\u59cb\u7684 IP\uff0c \u5982\u679c\u6709\u5ba2\u6237\u7aef\u6076\u610f\u4f20\u8f93 x-forward-for \uff0c\u4e0d\u505a\u6e05\u9664\u64cd\u4f5c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u62ff\u5230\u9519\u8bef\u7684\u5ba2\u6237\u7aef IP \u3002 \u5728 Envoy \u4e2d\u53ef\u4ee5\u901a\u8fc7 use_remote_address \u8bbe\u7f6e\u4e3a true \u6765\u6e05\u7406 HTTP \u6807\u5934 \u3002","title":"3-1 HTTP \u6807\u5934\u6e05\u7406"},{"location":"chap2/2chap2_sm_envoy/#3-2","text":"\u8d85\u65f6\u63a7\u5236\u5206\u4e3a\u8fde\u63a5\u8d85\u65f6\u3001\u6d41\u8d85\u65f6\u548c\u8def\u7531\u8d85\u65f6 \u3002 \u8fd9\u4e9b\u8d85\u65f6\u63a7\u5236\u4e0d\u4ec5\u5728\u8fb9\u7f18\u7f51\u5173\u6a21\u5f0f\u4e2d\u9700\u8981\u6ce8\u610f\uff0c\u5728 Sidecar \u6a21\u5f0f\u4e5f\u9700\u8981\u6ce8\u610f\uff0c\u4e00\u4e9b\u4e0d\u5408\u7406\u7684\u8d85\u65f6\u53ef\u80fd\u4f1a\u5f15\u8d77\u670d\u52a1\u7684\u96ea\u5d29\u3002\u867d\u7136\u5728\u5185\u7f51\u670d\u52a1\u8c03\u7528\u65f6\u4e00\u822c\u90fd\u4f1a\u8bbe\u7f6e\u9ed8\u8ba4\u8d85\u65f6\uff0c\u4f46 Sidecar \u5e94\u8be5\u8bbe\u7f6e\u4e00\u4e2a\u9ed8\u8ba4\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u907f\u514d\u670d\u52a1\u6ca1\u6709\u8bbe\u7f6e\u6709\u6548\u8d85\u65f6\u7684\u60c5\u51b5\u5f15\u8d77\u7684\u95ee\u9898\u3002","title":"3-2 \u8d85\u65f6\u63a7\u5236"},{"location":"chap2/2chap2_sm_envoy/#3-4","text":"Envoy \u4e3a HTTP \u670d\u52a1\u63d0\u4f9b\u4e86\u7a7a\u95f2\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4\u7684\u8bbe\u7f6e \uff0c\u7a7a\u95f2\u8d85\u65f6\u662f\u6307\u4e00\u4e2a\u8fde\u63a5\u5728\u63a5\u6536\u5230\u8bf7\u6c42\u540e\uff0c\u4f1a\u8bbe\u7f6e TCP \u7684 idle Timeout \u7684\u53c2\u6570\uff0c\u4e00\u6bb5\u65f6\u95f4\u5185\u6ca1\u6709\u6536\u5230\u4ee3\u7406\u670d\u52a1\u7684\u54cd\u5e94\u8bf7\u6c42\uff0c\u5219\u4f1a\u65ad\u5f00\u8fde\u63a5\u3002Envoy \u9ed8\u8ba4\u7684\u7a7a\u95f2\u8d85\u65f6\u662f 1 \u5c0f\u65f6\u3002\u8fde\u63a5\u8d85\u65f6\u5bf9\u6240\u6709\u6d41\u751f\u6548\uff0c\u8fde\u63a5\u4e00\u65e6\u65ad\u5f00\uff0c\u6240\u6709\u6d41\u5904\u7406\u4e5f\u4f1a\u4e2d\u65ad\u3002","title":"3-4 \u8fde\u63a5\u8d85\u65f6"},{"location":"chap2/2chap2_sm_envoy/#3-5","text":"\u6d41\u662f HTTP/2 \u4e2d\u7684\u6982\u5ff5\uff0c\u5728 HTTP/1 \u4e2d\u6ca1\u6709\u6d41\u7684\u6982\u5ff5\uff0cEnvoy \u901a\u8fc7\u5c06 HTTP \u8fde\u63a5\u5bf9\u5e94\u5230\u6d41\u6a21\u5f0f\uff0c\u7edf\u4e00\u8fdb\u884c\u5904\u7406\u3002 HTTP \u8fde\u63a5\u7ba1\u7406\u5668 stream_idle_timeout \u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\u4e3a 5 \u5206\u949f\uff0c\u63a8\u8350\u5bf9\u6240\u6709\u6d41\u8bbe\u7f6e\u5408\u7406\u7684\u8d85\u65f6\u65f6\u95f4\uff0c \u8fd9\u4e2a\u65f6\u95f4\u5c31\u662f\u63a5\u6536\u8bf7\u6c42\u5230\u8fd4\u56de\u6570\u636e\u7684\u5904\u7406\u65f6\u95f4\uff0c\u5982\u679c\u6ca1\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u5efa\u8bae\u8bbe\u7f6e\u4e3a 10s\uff0c\u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\u504f\u957f \u3002\u5982\u679c\u89e6\u53d1\u6b64\u8d85\u65f6\u65f6\u95f4\uff0c\u5219\u4f1a\u51fa\u53d1 504 Gateway Timeout \u7684\u9519\u8bef\u7801\u3002","title":"3-5 \u6d41\u8d85\u65f6"},{"location":"chap2/2chap2_sm_envoy/#3-6","text":"\u9664\u4e86\u8bbe\u7f6e\u5168\u5c40\u7684\u6d41\u8d85\u65f6\u5916\uff0c\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u8def\u7531\u5c42\u9762\u7684\u8d85\u65f6\uff0c\u4e3a\u67d0\u4e9b\u8bf7\u6c42\u8bbe\u7f6e\u7279\u6b8a\u7684\u914d\u7f6e\uff0c\u4e00\u4e9b\u8bf7\u6c42\u53ef\u80fd\u9700\u8981\u66f4\u5feb\u7684\u54cd\u5e94\u901f\u5ea6\uff0c\u6240\u4ee5\u8981\u8bbe\u7f6e\u8f83\u77ed\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ea\u8981\u5728\u8def\u7531\u5c42\u9762\u8bbe\u7f6e\u5373\u53ef\uff0c\u6bd4\u5982\u9488\u5bf9\u67d0\u4e9b Path \u8bbe\u7f6e\u66f4\u77ed\u7684\u8d85\u65f6\u65f6\u95f4\u3002","title":"3-6 \u8def\u7531\u8d85\u65f6"},{"location":"chap2/2chap2_sm_envoy/#3-7","text":"Envoy \u53ef\u4ee5\u9488\u5bf9\u5168\u5c40\u6216\u8005\u76d1\u542c\u5668\u8bbe\u7f6e\u8fde\u63a5\u9650\u5236\u3002\u4e00\u822c\u5355\u4e00\u670d\u52a1\u5668\u53ef\u627f\u8f7d\u7684\u5e76\u53d1\u8fde\u63a5\u6570\u6709\u9650\uff0c\u6839\u636e\u7ebf\u4e0a\u7684\u5cf0\u503c\u8fde\u63a5\u8fd0\u884c\u60c5\u51b5\uff0c\u8bbe\u7f6e\u5408\u7406\u7684\u8fde\u63a5\u8bbe\u7f6e\uff0c \u53ef\u4ee5\u907f\u514d\u56e0\u670d\u52a1\u51fa\u95ee\u9898\u65f6\u54cd\u5e94\u8fc7\u6162\uff0c\u5927\u91cf\u65b0\u5efa HTTP \u8fde\u63a5\u51fb\u57ae Envoy \u7684\u60c5\u51b5\u3002 Envoy \u4e0d\u4ec5\u53ef\u4ee5\u4f5c\u4e3a Service Mesh \u4e2d\u7684 Sidecar \u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u8fb9\u7f18\u7f51\u5173\u4f7f\u7528\uff0c\u5b83\u7684\u672c\u8d28\u5c31\u662f\u4e00\u4e2a\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\uff0cNginx\u3001HAProxy \u80fd\u505a\u7684\u4e8b\u60c5 Envoy \u4e5f\u53ef\u4ee5\u505a\u5f97\u5f88\u597d\u3002","title":"3-7 \u8fde\u63a5\u9650\u5236"},{"location":"chap2/3chap3_isitio_17/","text":"\u7b2c\u4e09\u8282 Istio \u5165\u95e8\uff1a\u57fa\u4e8e\u6700\u65b0 1.7 \u7248\u672c\u7684\u73af\u5883\u642d\u5efa\u548c\u4ecb\u7ecd \u8c08\u5230 Service Mesh\uff0c\u4e0d\u5f97\u4e0d\u63d0\u53ca Istio\uff0c\u4f5c\u4e3a Google\u3001IBM\u3001lynx \u8054\u5408\u63a8\u51fa\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0cIstio \u51e0\u4e4e\u6210\u4e86 Service Mesh \u7684\u4ee3\u540d\u8bcd\uff0c\u4f46\u5b9e\u9645\u4e0a Istio \u4ec5\u4ec5\u662f Service Mesh \u4e2d\u7684\u63a7\u5236\u9762\uff0c\u5b83\u7684\u4e3b\u8981\u529f\u80fd\u662f\u4e3a\u6570\u636e\u9762\u4e0b\u53d1\u670d\u52a1\u6cbb\u7406\u7b56\u7565\u3002 Istio \u6700\u8fd1\u5728 1.5 \u7248\u672c\u8fdb\u884c\u4e86\u4e00\u6b21\u5927\u7684\u53d8\u66f4\uff0c\u7531\u65e9\u671f\u7684\u5fae\u670d\u52a1\u67b6\u6784\u53d8\u6210\u4e86\u5355\u4f53\u67b6\u6784\u3002 \u4e4b\u524d\u7248\u672c\u7684Istio \u7531 Pilot\u3001Citadel\u3001Galley\u3001Sidecar \u6ce8\u5165\u5668\u7b49\u591a\u4e2a\u5fae\u670d\u52a1\u7ec4\u6210\uff0c\u4f46\u73b0\u5728\u53ea\u9700\u8981\u4e00\u4e2a Istiod \u7684\u5355\u4f53\u670d\u52a1\u3002 \u6700\u65b0\u7248\u672c\u7684 Istio \u63a7\u5236\u9762\u7531\u4ee5\u4e0b\u51e0\u4e2a\u7ec4\u4ef6\u7ec4\u6210\u3002 Pilot\uff1aIstio \u63a7\u5236\u9762\u4e2d\u6700\u6838\u5fc3\u7684\u6a21\u5757\uff0c\u8d1f\u8d23\u8fd0\u884c\u65f6\u914d\u7f6e\u4e0b\u53d1 \uff0c\u5177\u4f53\u6765\u8bf4\uff0c\u5c31\u662f\u548c Envoy \u4e4b\u95f4\u57fa\u4e8e xDS \u534f\u8bae\u8fdb\u884c\u7684\u5404\u79cd Envoy \u914d\u7f6e\u4fe1\u606f\u7684\u63a8\u9001 \uff0c\u5305\u62ec\u670d\u52a1\u53d1\u73b0\u3001\u8def\u7531\u53d1\u73b0\u3001\u96c6\u7fa4\u53d1\u73b0\u3001\u76d1\u542c\u5668\u53d1\u73b0\u7b49\u3002 Citadel \uff1a\u8d1f\u8d23\u8bc1\u4e66\u7684\u5206\u53d1\u548c\u8f6e\u6362\uff0c\u4f7f Sidecar \u4ee3\u7406\u4e24\u7aef\u5b9e\u73b0\u53cc\u5411 TLS \u8ba4\u8bc1\u3001\u8bbf\u95ee\u6388\u6743\u7b49\u3002 Galley \uff1a \u914d\u7f6e\u4fe1\u606f\u7684\u683c\u5f0f\u548c\u6b63\u786e\u6027\u6821\u9a8c\uff0c\u5c06\u914d\u7f6e\u4fe1\u606f\u63d0\u4f9b\u7ed9 Pilot \u4f7f\u7528 \u3002 1\u3001Istio \u73af\u5883\u642d\u5efa \u56e0\u4e3a Istio \u5f3a\u4f9d\u8d56\u4e8e Kubernetes \u73af\u5883\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5148\u8fdb\u884c Kubernetes \u73af\u5883\u7684\u642d\u5efa\uff0c\u4e3a\u4e86\u66f4\u52a0\u65b9\u4fbf\uff0c\u6211\u4eec\u4f7f\u7528 Minikube \u5728\u672c\u5730\u642d\u5efa\u3002 \u5728 macOS \u73af\u5883\u4e0b\uff0c\u53ea\u8981\u7b80\u5355\u8fd0\u884c\u5982\u4e0b\u547d\u4ee4\u5373\u53ef\uff1a $ brew install minikube $ minikube start --kubernetes-version=v1.19.2 --driver=docker \u53e6\u5916\u542f\u52a8\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u9047\u5230\u95ee\u9898\uff0c\u53ef\u4ee5\u52a0\u4e0a --alsologtostderr \u8f93\u51fa\u8be6\u7ec6\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u5efa\u8bae\u5c06 Docker \u7248\u672c\u4e5f\u5347\u7ea7\u81f3\u6700\u65b0\u3002 \u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684 Istio\uff1a $ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.7.3 sh - \u4e3a\u4e86\u4fdd\u8bc1\u540e\u7eed\u547d\u4ee4\u7684\u51c6\u786e\u6027\uff0c\u8fd9\u91cc\u6307\u5b9a\u4e86\u7248\u672c\u53f7 \u3002 \u8fdb\u5165\u4e0b\u8f7d\u76ee\u5f55\uff1a $ cd istio-1.7.3 \u5c06 Istioctl \u5ba2\u6237\u7aef\u6dfb\u52a0\u5230\u53ef\u6267\u884c\u8def\u5f84\uff1a $ export PATH=$PWD/bin:$PATH \u4f7f\u7528 Istioctl \u5ba2\u6237\u7aef\u5b89\u88c5 Istio\uff1a $ istioctl install --set profile=demo \u5728\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u5f00\u542f\u81ea\u52a8\u6ce8\u5165 Envoy Sidecar\uff1a $ kubectl label namespace default istio-injection=enabled \u901a\u8fc7\u4e0a\u8ff0\u64cd\u4f5c\uff0cIstio \u7684\u73af\u5883\u5c31\u5b89\u88c5\u597d\u4e86\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b Istio \u7ec4\u4ef6\uff1a $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-egressgateway ClusterIP 10.104.140.107 <none> 80/TCP,443/TCP,15443/TCP 2d5h istio-ingressgateway LoadBalancer 10.103.123.96 <pending> 15021:32148/TCP,80:32124/TCP,443:31370/TCP,31400:31690/TCP,15443:32721/TCP 2d5h istiod ClusterIP 10.106.54.115 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP,853/TCP 2d5h Istio \u4ee5\u4e00\u4e2a\u670d\u52a1\u7684\u5f62\u5f0f\u90e8\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u3002\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u90e8\u7f72\u597d\u7684 Pods \u4e2d\uff0c\u9664\u4e86\u6709 Istiod \u8fd9\u4e2a\u6838\u5fc3\u7ec4\u4ef6\u5916\uff0c \u8fd8\u6709 Istio Egressgate Way \u548c Istio Ingressgate Way \u4e24\u4e2a\u7ec4\u4ef6\uff0c\u5206\u522b\u662f\u51fa\u53e3\u7f51\u5173\u548c\u5165\u53e3\u7f51\u5173 \u3002 2\u3001\u90e8\u7f72 Bookinfo \u793a\u4f8b\u7a0b\u5e8f \u90e8\u7f72\u793a\u4f8b\u7a0b\u5e8f\uff1a $ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml \u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b Pod \u7684\u8fd0\u884c\u72b6\u6001\uff1a $ kubectl get pods \u5f53 Pod ready \u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5185\u90e8\u670d\u52a1\u8bbf\u95ee\u7684\u65b9\u5f0f\uff0c\u67e5\u770b\u670d\u52a1\u7684\u8fd0\u884c\u60c5\u51b5\uff1a $ kubectl exec \"$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')\" -c ratings -- curl -s productpage:9080/productpage | grep -o \"<title>.*</title>\" <title>Simple Bookstore App</title> \u73b0\u5728\uff0c\u670d\u52a1\u5df2\u7ecf\u6b63\u5e38\u542f\u52a8\u4e86\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7 Ingress \u7684\u65b9\u5f0f\uff0c\u8ba9\u6d4f\u89c8\u5668\u53ef\u4ee5\u6253\u5f00\u8fd9\u4e2a\u9875\u9762\u3002 \u901a\u8fc7 Ingress \u6253\u901a\u5185\u5916\u7f51\u670d\u52a1\uff1a $ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml gateway.networking.istio.io/bookinfo-gateway created virtualservice.networking.istio.io/bookinfo created \u67e5\u770b Minikube \u7684 IP\uff1a $ minikube ip 127.0.0.1 \u7136\u540e\uff0c\u6253\u5f00\u65b0\u7684\u7ec8\u7aef\u7a97\u53e3\uff0c\u4e3a LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\u6253\u901a\u5916\u7f51\uff1a $ minikube tunnel The service Istio -ingressgateway requires privileged ports to be exposed: [80 443] sudo permission will be asked for it. Starting tunnel for service Istio -ingressgateway. Password: \u6253\u5f00\u6d4f\u89c8\u5668\u8bbf\u95ee http://127.0.0.1/productpage \uff08IP \u66ff\u6362\u4e3a\u4e0a\u9762\u8fd0\u884c\u7684 Minikube IP\uff09\uff0c \u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u9875\u9762\u4e86\u3002 3\u3001\u53ef\u89c2\u6d4b\u6027\u90e8\u7f72 Kiali \u662f\u4e00\u4e2a\u57fa\u4e8e\u670d\u52a1\u7f51\u683c\u7684 Istio \u7ba1\u7406\u63a7\u5236\u53f0\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u4e9b\u6570\u636e\u7684\u4eea\u8868\u76d8\u548c\u53ef\u89c2\u6d4b\u80fd\u529b\uff0c\u540c\u65f6\u53ef\u4ee5\u8ba9\u4f60\u53bb\u64cd\u4f5c\u7f51\u683c\u7684\u914d\u7f6e\u3002 \u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u5feb\u901f\u90e8\u7f72\u4e00\u4e2a\u7528\u4e8e\u6f14\u793a\u7684 Kiali\uff1a $ kubectl apply -f samples/addons $ kubectl get pod -n istio-system -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES grafana-57bb676c4c-4nfcd 1/1 Running 3 13d 172.18.0.11 minikube <none> <none> istio-egressgateway-8556f8c8dc-pnlbl 1/1 Running 4 16d 172.18.0.4 minikube <none> <none> istio-ingressgateway-589d868684-xcx42 1/1 Running 4 16d 172.18.0.6 minikube <none> <none> istiod-86d65b6959-jl8fs 1/1 Running 4 16d 172.18.0.3 minikube <none> <none> jaeger-75948789b4-9bc4f 1/1 Running 15 13d 172.18.0.13 minikube <none> <none> kiali-7d5cb68b45-cz75l 1/1 Running 13 13d 172.18.0.5 minikube <none> <none> prometheus-7c8bf6df84-8jp99 2/2 Running 12 13d 172.18.0.9 minikube <none> <none> \u5982\u679c\u6709\u542f\u52a8\u6bd4\u8f83\u6162\u7684 Pod\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u4e00\u4e0b Pod \u7684\u4e8b\u4ef6\uff0c\u4e86\u89e3\u4e00\u4e0b\u5177\u4f53\u539f\u56e0\u3002 $ kubectl describe pod kiali-7d5cb68b45-cz75l -n istio-system Pod \u5168\u90e8\u542f\u52a8\u6210\u529f\u540e\uff0c\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u6574\u4e2a\u8c03\u7528\u5173\u7cfb\u60c5\u51b5\uff1a $ istioctl dashboard kiali 4\u3001\u5b9e\u4f8b\u670d\u52a1\u539f\u7406\u89e3\u6790 apiVersion: v1 kind: Service metadata: name: productpage labels: app: productpage service: productpage spec: ports: - port: 9080 name: http selector: app: productpage \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7 Deployment \u63a7\u5236 Pod \u7684\u751f\u547d\u5468\u671f\uff0c\u5b9a\u4e49\u4e86 Pod \u7684\u526f\u672c\u6570\u91cf\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u5b9a\u4e49\u4e00\u4e2a replicas \u4e3a 1\uff0c\u4e5f\u5c31\u662f Pod \u7684\u526f\u672c\u6570\u91cf\u4e3a 1\uff0c\u56e0\u4e3a\u662f\u6d4b\u8bd5\u73af\u5883\uff0c\u6240\u4ee5\u6ca1\u6709\u8bbe\u7f6e\u66f4\u591a\u7684\u526f\u672c\u6570\u91cf\u4fdd\u969c\u670d\u52a1\u7684 SLA \u3002 apiVersion: apps/v1 kind: Deployment metadata: name: productpage-v1 labels: app: productpage version: v1 spec: replicas: 1 selector: matchLabels: app: productpage version: v1 template: metadata: labels: app: productpage version: v1 spec: serviceAccountName: bookinfo-productpage containers: - name: productpage image: docker.io/istio/examples-bookinfo-productpage-v1:1.16.2 imagePullPolicy: IfNotPresent ports: - containerPort: 9080 volumeMounts: - name: tmp mountPath: /tmp volumes: - name: tmp emptyDir: {} \u53e6\u5916\u5728 Kubernetes \u7684 Service \u91cc\u9762\u5e76\u6ca1\u6709\u7248\u672c\u7684\u6982\u5ff5\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8fdb\u884c\u67d3\u8272\u6216\u8005\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u5c31\u9700\u8981\u501f\u52a9 Istio \u7684\u80fd\u529b\u3002 \u901a\u8fc7\u4e0a\u8ff0\u547d\u4ee4\u53ef\u4ee5\u770b\u5230\uff0c\u5728 Deployment \u7c7b\u578b\u4e2d\u5b9a\u4e49\u4e86 Version V1 \u7684 lable\uff0c\u8fd9\u4e2a lable \u6700\u7ec8\u4f1a\u8f6c\u5316\u6210\u4e0d\u540c\u7684\u670d\u52a1\u540d\uff0c\u6bd4\u5982 productpage-v1 \u7684\u65b9\u5f0f\uff0c\u4e0b\u53d1\u5230 Sidecar \u4e2d\uff0c Sidecar \u6839\u636e\u8fd9\u4e2a\u670d\u52a1\u540d\u79f0\u8fdb\u884c\u670d\u52a1\u53d1\u73b0\uff0c\u4ee5\u5b9e\u73b0\u4e0d\u540c\u7248\u672c\u53f7\u8bbf\u95ee\u7684\u65b9\u6cd5\u3002 \u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u7528\u5230\u4e86 Ingress \u6a21\u5f0f\u3002\u6211\u4eec\u5b9a\u4e49\u4e00\u7ec4\u7f51\u5173\u7c7b\u578b\u7684\u8d44\u6e90\uff0c Istio \u901a\u8fc7 Gateway \u5c06\u670d\u52a1\u53d1\u5e03\u6210\u5916\u90e8\u53ef\u8bbf\u95ee\u7684\u670d\u52a1 \uff0c\u901a\u8fc7 80 \u7aef\u53e3\u5c06\u670d\u52a1\u901a\u8fc7 Ingress \u7f51\u5173\u8f6c\u53d1\u5230\u7279\u5b9a\u7684\u670d\u52a1\u4e0a\u3002 apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: bookinfo-gateway spec: selector: istio: ingressgateway # use istio default controller servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*\" \u5728\u8fd9\u91cc\uff0cGateway \u8d44\u6e90\u7c7b\u578b\uff0c\u9700\u8981\u914d\u5408 VirtualService \u7c7b\u578b\u7684\u8d44\u6e90\u4e00\u8d77\u4f7f\u7528\u3002 \u5728\u8fd9\u4e2a\u7a0b\u5e8f\u4e2d\u4f60\u53ef\u4ee5\u770b\u5230\u5339\u914d\u5230 /productpage \u8def\u5f84\u7684\u670d\u52a1\uff0c\u800c\u5728 route \u4e2d\u5b9a\u4e49\u4e86 destination \u7684 host \u5c06\u4f1a\u662f\u8def\u7531\u7684\u670d\u52a1\u540d\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: bookinfo spec: hosts: - \"*\" gateways: - bookinfo-gateway http: - match: - uri: exact: /productpage - uri: prefix: /static - uri: exact: /login - uri: exact: /logout - uri: prefix: /api/v1/products route: - destination: host: productpage port: number: 9080 Istio \u901a\u8fc7 Galley \u6a21\u5757\u7ba1\u7406\u914d\u7f6e\uff0c Pilot \u6a21\u5757\u89e3\u6790\u914d\u7f6e\u4e3a xDS \u534f\u8bae\u683c\u5f0f \uff0c\u901a\u8fc7 gRPC \u548c Envoy \u8fdb\u884c\u901a\u4fe1\uff0c\u4ee5\u4fbf\u5b8c\u6210\u914d\u7f6e\u548c\u8282\u70b9\u4fe1\u606f\u66f4\u65b0\uff0c pilot-agent \u4f5c\u4e3a Envoy \u5b88\u62a4\u6a21\u5757\uff0c\u4fdd\u8bc1 Envoy \u7684\u6b63\u5e38\u8fd0\u884c\u548c\u5e73\u6ed1\u91cd\u542f\u3002 \u672c\u5730\u4e1a\u52a1\u670d\u52a1 productpage \u901a\u8fc7 iptables \u52ab\u6301\u7684\u65b9\u5f0f\u548c\u672c\u5730 Envoy \u8fdb\u884c\u901a\u4fe1\uff0cEnvoy \u5b8c\u6210\u670d\u52a1\u53d1\u73b0\u540e\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230 ProductDetail \u670d\u52a1\u7684\u6240\u5728 Pod\uff0c\u540c\u6837\u901a\u8fc7 iptables \u52ab\u6301\u7684\u65b9\u5f0f\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u672c\u5730\u7684\u4e1a\u52a1\u670d\u52a1 ProductDetail\u3002","title":"\u7b2c\u4e09\u8282 Istio \u5165\u95e8\uff1a\u57fa\u4e8e\u6700\u65b0 1.7 \u7248\u672c\u7684\u73af\u5883\u642d\u5efa\u548c\u4ecb\u7ecd"},{"location":"chap2/3chap3_isitio_17/#istio-17","text":"\u8c08\u5230 Service Mesh\uff0c\u4e0d\u5f97\u4e0d\u63d0\u53ca Istio\uff0c\u4f5c\u4e3a Google\u3001IBM\u3001lynx \u8054\u5408\u63a8\u51fa\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\uff0cIstio \u51e0\u4e4e\u6210\u4e86 Service Mesh \u7684\u4ee3\u540d\u8bcd\uff0c\u4f46\u5b9e\u9645\u4e0a Istio \u4ec5\u4ec5\u662f Service Mesh \u4e2d\u7684\u63a7\u5236\u9762\uff0c\u5b83\u7684\u4e3b\u8981\u529f\u80fd\u662f\u4e3a\u6570\u636e\u9762\u4e0b\u53d1\u670d\u52a1\u6cbb\u7406\u7b56\u7565\u3002 Istio \u6700\u8fd1\u5728 1.5 \u7248\u672c\u8fdb\u884c\u4e86\u4e00\u6b21\u5927\u7684\u53d8\u66f4\uff0c\u7531\u65e9\u671f\u7684\u5fae\u670d\u52a1\u67b6\u6784\u53d8\u6210\u4e86\u5355\u4f53\u67b6\u6784\u3002 \u4e4b\u524d\u7248\u672c\u7684Istio \u7531 Pilot\u3001Citadel\u3001Galley\u3001Sidecar \u6ce8\u5165\u5668\u7b49\u591a\u4e2a\u5fae\u670d\u52a1\u7ec4\u6210\uff0c\u4f46\u73b0\u5728\u53ea\u9700\u8981\u4e00\u4e2a Istiod \u7684\u5355\u4f53\u670d\u52a1\u3002 \u6700\u65b0\u7248\u672c\u7684 Istio \u63a7\u5236\u9762\u7531\u4ee5\u4e0b\u51e0\u4e2a\u7ec4\u4ef6\u7ec4\u6210\u3002 Pilot\uff1aIstio \u63a7\u5236\u9762\u4e2d\u6700\u6838\u5fc3\u7684\u6a21\u5757\uff0c\u8d1f\u8d23\u8fd0\u884c\u65f6\u914d\u7f6e\u4e0b\u53d1 \uff0c\u5177\u4f53\u6765\u8bf4\uff0c\u5c31\u662f\u548c Envoy \u4e4b\u95f4\u57fa\u4e8e xDS \u534f\u8bae\u8fdb\u884c\u7684\u5404\u79cd Envoy \u914d\u7f6e\u4fe1\u606f\u7684\u63a8\u9001 \uff0c\u5305\u62ec\u670d\u52a1\u53d1\u73b0\u3001\u8def\u7531\u53d1\u73b0\u3001\u96c6\u7fa4\u53d1\u73b0\u3001\u76d1\u542c\u5668\u53d1\u73b0\u7b49\u3002 Citadel \uff1a\u8d1f\u8d23\u8bc1\u4e66\u7684\u5206\u53d1\u548c\u8f6e\u6362\uff0c\u4f7f Sidecar \u4ee3\u7406\u4e24\u7aef\u5b9e\u73b0\u53cc\u5411 TLS \u8ba4\u8bc1\u3001\u8bbf\u95ee\u6388\u6743\u7b49\u3002 Galley \uff1a \u914d\u7f6e\u4fe1\u606f\u7684\u683c\u5f0f\u548c\u6b63\u786e\u6027\u6821\u9a8c\uff0c\u5c06\u914d\u7f6e\u4fe1\u606f\u63d0\u4f9b\u7ed9 Pilot \u4f7f\u7528 \u3002","title":"\u7b2c\u4e09\u8282 Istio \u5165\u95e8\uff1a\u57fa\u4e8e\u6700\u65b0 1.7 \u7248\u672c\u7684\u73af\u5883\u642d\u5efa\u548c\u4ecb\u7ecd"},{"location":"chap2/3chap3_isitio_17/#1istio","text":"\u56e0\u4e3a Istio \u5f3a\u4f9d\u8d56\u4e8e Kubernetes \u73af\u5883\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5148\u8fdb\u884c Kubernetes \u73af\u5883\u7684\u642d\u5efa\uff0c\u4e3a\u4e86\u66f4\u52a0\u65b9\u4fbf\uff0c\u6211\u4eec\u4f7f\u7528 Minikube \u5728\u672c\u5730\u642d\u5efa\u3002 \u5728 macOS \u73af\u5883\u4e0b\uff0c\u53ea\u8981\u7b80\u5355\u8fd0\u884c\u5982\u4e0b\u547d\u4ee4\u5373\u53ef\uff1a $ brew install minikube $ minikube start --kubernetes-version=v1.19.2 --driver=docker \u53e6\u5916\u542f\u52a8\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u9047\u5230\u95ee\u9898\uff0c\u53ef\u4ee5\u52a0\u4e0a --alsologtostderr \u8f93\u51fa\u8be6\u7ec6\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u5efa\u8bae\u5c06 Docker \u7248\u672c\u4e5f\u5347\u7ea7\u81f3\u6700\u65b0\u3002 \u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684 Istio\uff1a $ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.7.3 sh - \u4e3a\u4e86\u4fdd\u8bc1\u540e\u7eed\u547d\u4ee4\u7684\u51c6\u786e\u6027\uff0c\u8fd9\u91cc\u6307\u5b9a\u4e86\u7248\u672c\u53f7 \u3002 \u8fdb\u5165\u4e0b\u8f7d\u76ee\u5f55\uff1a $ cd istio-1.7.3 \u5c06 Istioctl \u5ba2\u6237\u7aef\u6dfb\u52a0\u5230\u53ef\u6267\u884c\u8def\u5f84\uff1a $ export PATH=$PWD/bin:$PATH \u4f7f\u7528 Istioctl \u5ba2\u6237\u7aef\u5b89\u88c5 Istio\uff1a $ istioctl install --set profile=demo \u5728\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u5f00\u542f\u81ea\u52a8\u6ce8\u5165 Envoy Sidecar\uff1a $ kubectl label namespace default istio-injection=enabled \u901a\u8fc7\u4e0a\u8ff0\u64cd\u4f5c\uff0cIstio \u7684\u73af\u5883\u5c31\u5b89\u88c5\u597d\u4e86\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b Istio \u7ec4\u4ef6\uff1a $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-egressgateway ClusterIP 10.104.140.107 <none> 80/TCP,443/TCP,15443/TCP 2d5h istio-ingressgateway LoadBalancer 10.103.123.96 <pending> 15021:32148/TCP,80:32124/TCP,443:31370/TCP,31400:31690/TCP,15443:32721/TCP 2d5h istiod ClusterIP 10.106.54.115 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP,853/TCP 2d5h Istio \u4ee5\u4e00\u4e2a\u670d\u52a1\u7684\u5f62\u5f0f\u90e8\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u3002\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u90e8\u7f72\u597d\u7684 Pods \u4e2d\uff0c\u9664\u4e86\u6709 Istiod \u8fd9\u4e2a\u6838\u5fc3\u7ec4\u4ef6\u5916\uff0c \u8fd8\u6709 Istio Egressgate Way \u548c Istio Ingressgate Way \u4e24\u4e2a\u7ec4\u4ef6\uff0c\u5206\u522b\u662f\u51fa\u53e3\u7f51\u5173\u548c\u5165\u53e3\u7f51\u5173 \u3002","title":"1\u3001Istio \u73af\u5883\u642d\u5efa"},{"location":"chap2/3chap3_isitio_17/#2-bookinfo","text":"\u90e8\u7f72\u793a\u4f8b\u7a0b\u5e8f\uff1a $ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml \u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b Pod \u7684\u8fd0\u884c\u72b6\u6001\uff1a $ kubectl get pods \u5f53 Pod ready \u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5185\u90e8\u670d\u52a1\u8bbf\u95ee\u7684\u65b9\u5f0f\uff0c\u67e5\u770b\u670d\u52a1\u7684\u8fd0\u884c\u60c5\u51b5\uff1a $ kubectl exec \"$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')\" -c ratings -- curl -s productpage:9080/productpage | grep -o \"<title>.*</title>\" <title>Simple Bookstore App</title> \u73b0\u5728\uff0c\u670d\u52a1\u5df2\u7ecf\u6b63\u5e38\u542f\u52a8\u4e86\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7 Ingress \u7684\u65b9\u5f0f\uff0c\u8ba9\u6d4f\u89c8\u5668\u53ef\u4ee5\u6253\u5f00\u8fd9\u4e2a\u9875\u9762\u3002 \u901a\u8fc7 Ingress \u6253\u901a\u5185\u5916\u7f51\u670d\u52a1\uff1a $ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml gateway.networking.istio.io/bookinfo-gateway created virtualservice.networking.istio.io/bookinfo created \u67e5\u770b Minikube \u7684 IP\uff1a $ minikube ip 127.0.0.1 \u7136\u540e\uff0c\u6253\u5f00\u65b0\u7684\u7ec8\u7aef\u7a97\u53e3\uff0c\u4e3a LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\u6253\u901a\u5916\u7f51\uff1a $ minikube tunnel The service Istio -ingressgateway requires privileged ports to be exposed: [80 443] sudo permission will be asked for it. Starting tunnel for service Istio -ingressgateway. Password: \u6253\u5f00\u6d4f\u89c8\u5668\u8bbf\u95ee http://127.0.0.1/productpage \uff08IP \u66ff\u6362\u4e3a\u4e0a\u9762\u8fd0\u884c\u7684 Minikube IP\uff09\uff0c \u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u9875\u9762\u4e86\u3002","title":"2\u3001\u90e8\u7f72 Bookinfo \u793a\u4f8b\u7a0b\u5e8f"},{"location":"chap2/3chap3_isitio_17/#3","text":"Kiali \u662f\u4e00\u4e2a\u57fa\u4e8e\u670d\u52a1\u7f51\u683c\u7684 Istio \u7ba1\u7406\u63a7\u5236\u53f0\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u4e9b\u6570\u636e\u7684\u4eea\u8868\u76d8\u548c\u53ef\u89c2\u6d4b\u80fd\u529b\uff0c\u540c\u65f6\u53ef\u4ee5\u8ba9\u4f60\u53bb\u64cd\u4f5c\u7f51\u683c\u7684\u914d\u7f6e\u3002 \u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u5feb\u901f\u90e8\u7f72\u4e00\u4e2a\u7528\u4e8e\u6f14\u793a\u7684 Kiali\uff1a $ kubectl apply -f samples/addons $ kubectl get pod -n istio-system -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES grafana-57bb676c4c-4nfcd 1/1 Running 3 13d 172.18.0.11 minikube <none> <none> istio-egressgateway-8556f8c8dc-pnlbl 1/1 Running 4 16d 172.18.0.4 minikube <none> <none> istio-ingressgateway-589d868684-xcx42 1/1 Running 4 16d 172.18.0.6 minikube <none> <none> istiod-86d65b6959-jl8fs 1/1 Running 4 16d 172.18.0.3 minikube <none> <none> jaeger-75948789b4-9bc4f 1/1 Running 15 13d 172.18.0.13 minikube <none> <none> kiali-7d5cb68b45-cz75l 1/1 Running 13 13d 172.18.0.5 minikube <none> <none> prometheus-7c8bf6df84-8jp99 2/2 Running 12 13d 172.18.0.9 minikube <none> <none> \u5982\u679c\u6709\u542f\u52a8\u6bd4\u8f83\u6162\u7684 Pod\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u4e00\u4e0b Pod \u7684\u4e8b\u4ef6\uff0c\u4e86\u89e3\u4e00\u4e0b\u5177\u4f53\u539f\u56e0\u3002 $ kubectl describe pod kiali-7d5cb68b45-cz75l -n istio-system Pod \u5168\u90e8\u542f\u52a8\u6210\u529f\u540e\uff0c\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u6574\u4e2a\u8c03\u7528\u5173\u7cfb\u60c5\u51b5\uff1a $ istioctl dashboard kiali","title":"3\u3001\u53ef\u89c2\u6d4b\u6027\u90e8\u7f72"},{"location":"chap2/3chap3_isitio_17/#4","text":"apiVersion: v1 kind: Service metadata: name: productpage labels: app: productpage service: productpage spec: ports: - port: 9080 name: http selector: app: productpage \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7 Deployment \u63a7\u5236 Pod \u7684\u751f\u547d\u5468\u671f\uff0c\u5b9a\u4e49\u4e86 Pod \u7684\u526f\u672c\u6570\u91cf\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u5b9a\u4e49\u4e00\u4e2a replicas \u4e3a 1\uff0c\u4e5f\u5c31\u662f Pod \u7684\u526f\u672c\u6570\u91cf\u4e3a 1\uff0c\u56e0\u4e3a\u662f\u6d4b\u8bd5\u73af\u5883\uff0c\u6240\u4ee5\u6ca1\u6709\u8bbe\u7f6e\u66f4\u591a\u7684\u526f\u672c\u6570\u91cf\u4fdd\u969c\u670d\u52a1\u7684 SLA \u3002 apiVersion: apps/v1 kind: Deployment metadata: name: productpage-v1 labels: app: productpage version: v1 spec: replicas: 1 selector: matchLabels: app: productpage version: v1 template: metadata: labels: app: productpage version: v1 spec: serviceAccountName: bookinfo-productpage containers: - name: productpage image: docker.io/istio/examples-bookinfo-productpage-v1:1.16.2 imagePullPolicy: IfNotPresent ports: - containerPort: 9080 volumeMounts: - name: tmp mountPath: /tmp volumes: - name: tmp emptyDir: {} \u53e6\u5916\u5728 Kubernetes \u7684 Service \u91cc\u9762\u5e76\u6ca1\u6709\u7248\u672c\u7684\u6982\u5ff5\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8fdb\u884c\u67d3\u8272\u6216\u8005\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u5c31\u9700\u8981\u501f\u52a9 Istio \u7684\u80fd\u529b\u3002 \u901a\u8fc7\u4e0a\u8ff0\u547d\u4ee4\u53ef\u4ee5\u770b\u5230\uff0c\u5728 Deployment \u7c7b\u578b\u4e2d\u5b9a\u4e49\u4e86 Version V1 \u7684 lable\uff0c\u8fd9\u4e2a lable \u6700\u7ec8\u4f1a\u8f6c\u5316\u6210\u4e0d\u540c\u7684\u670d\u52a1\u540d\uff0c\u6bd4\u5982 productpage-v1 \u7684\u65b9\u5f0f\uff0c\u4e0b\u53d1\u5230 Sidecar \u4e2d\uff0c Sidecar \u6839\u636e\u8fd9\u4e2a\u670d\u52a1\u540d\u79f0\u8fdb\u884c\u670d\u52a1\u53d1\u73b0\uff0c\u4ee5\u5b9e\u73b0\u4e0d\u540c\u7248\u672c\u53f7\u8bbf\u95ee\u7684\u65b9\u6cd5\u3002 \u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u7528\u5230\u4e86 Ingress \u6a21\u5f0f\u3002\u6211\u4eec\u5b9a\u4e49\u4e00\u7ec4\u7f51\u5173\u7c7b\u578b\u7684\u8d44\u6e90\uff0c Istio \u901a\u8fc7 Gateway \u5c06\u670d\u52a1\u53d1\u5e03\u6210\u5916\u90e8\u53ef\u8bbf\u95ee\u7684\u670d\u52a1 \uff0c\u901a\u8fc7 80 \u7aef\u53e3\u5c06\u670d\u52a1\u901a\u8fc7 Ingress \u7f51\u5173\u8f6c\u53d1\u5230\u7279\u5b9a\u7684\u670d\u52a1\u4e0a\u3002 apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: bookinfo-gateway spec: selector: istio: ingressgateway # use istio default controller servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*\" \u5728\u8fd9\u91cc\uff0cGateway \u8d44\u6e90\u7c7b\u578b\uff0c\u9700\u8981\u914d\u5408 VirtualService \u7c7b\u578b\u7684\u8d44\u6e90\u4e00\u8d77\u4f7f\u7528\u3002 \u5728\u8fd9\u4e2a\u7a0b\u5e8f\u4e2d\u4f60\u53ef\u4ee5\u770b\u5230\u5339\u914d\u5230 /productpage \u8def\u5f84\u7684\u670d\u52a1\uff0c\u800c\u5728 route \u4e2d\u5b9a\u4e49\u4e86 destination \u7684 host \u5c06\u4f1a\u662f\u8def\u7531\u7684\u670d\u52a1\u540d\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: bookinfo spec: hosts: - \"*\" gateways: - bookinfo-gateway http: - match: - uri: exact: /productpage - uri: prefix: /static - uri: exact: /login - uri: exact: /logout - uri: prefix: /api/v1/products route: - destination: host: productpage port: number: 9080 Istio \u901a\u8fc7 Galley \u6a21\u5757\u7ba1\u7406\u914d\u7f6e\uff0c Pilot \u6a21\u5757\u89e3\u6790\u914d\u7f6e\u4e3a xDS \u534f\u8bae\u683c\u5f0f \uff0c\u901a\u8fc7 gRPC \u548c Envoy \u8fdb\u884c\u901a\u4fe1\uff0c\u4ee5\u4fbf\u5b8c\u6210\u914d\u7f6e\u548c\u8282\u70b9\u4fe1\u606f\u66f4\u65b0\uff0c pilot-agent \u4f5c\u4e3a Envoy \u5b88\u62a4\u6a21\u5757\uff0c\u4fdd\u8bc1 Envoy \u7684\u6b63\u5e38\u8fd0\u884c\u548c\u5e73\u6ed1\u91cd\u542f\u3002 \u672c\u5730\u4e1a\u52a1\u670d\u52a1 productpage \u901a\u8fc7 iptables \u52ab\u6301\u7684\u65b9\u5f0f\u548c\u672c\u5730 Envoy \u8fdb\u884c\u901a\u4fe1\uff0cEnvoy \u5b8c\u6210\u670d\u52a1\u53d1\u73b0\u540e\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230 ProductDetail \u670d\u52a1\u7684\u6240\u5728 Pod\uff0c\u540c\u6837\u901a\u8fc7 iptables \u52ab\u6301\u7684\u65b9\u5f0f\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u672c\u5730\u7684\u4e1a\u52a1\u670d\u52a1 ProductDetail\u3002","title":"4\u3001\u5b9e\u4f8b\u670d\u52a1\u539f\u7406\u89e3\u6790"},{"location":"chap2/4chap3_xds/","text":"\u7b2c\u56db\u8282 xDS\uff1a\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u901a\u4fe1\u6865\u6881 \u901a\u8fc7\u67e5\u8be2\u4e00\u4e2a\u6216\u591a\u4e2a\u7ba1\u7406\u670d\u52a1\u5668\u83b7\u53d6\u6570\u636e\u4ee5\u53d1\u73b0\u52a8\u6001\u8d44\u6e90\u53d8\u66f4\uff0c\u6bd4\u5982 Router\u3001Cluster\u3001EndPoint \u7b49\uff0c \u6211\u4eec\u628a\u8fd9\u4e9b\u53d1\u73b0\u670d\u52a1\u53ca\u5176\u5bf9\u5e94\u7684 API \u79f0\u4e3a xDS \u3002 xDS \u6700\u5927\u7684\u4ef7\u503c\u5c31\u662f\u5b9a\u4e49\u4e86\u4e00\u5957\u53ef\u6269\u5c55\u7684\u901a\u7528\u5fae\u670d\u52a1\u63a7\u5236 API\uff0c \u8fd9\u4e9bAPI\u4e0d\u4ec5\u53ef\u4ee5\u505a\u5230\u670d\u52a1\u53d1\u73b0\uff0c\u4e5f\u53ef\u4ee5\u505a\u5230\u8def\u7531\u53d1\u73b0\u3001\u96c6\u7fa4\u53d1\u73b0\uff0c\u53ef\u4ee5\u8bf4\u6240\u6709\u914d\u7f6e\u90fd\u80fd\u901a\u8fc7\u53d1\u73b0\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u8fd9\u662f\u4e00\u79cd\u5168\u65b0\u7684\u89e3\u51b3\u65b9\u6848 \uff0c\u6240\u4ee5 xDS API \u4e0d\u4ec5\u88ab\u7528\u5728\u4e86 Service Mesh \u4e2d\uff0c\u4e5f\u7528\u5728\u4e86\u4e00\u4e9b RPC \u6846\u67b6\u4e2d\uff0c\u6bd4\u5982 gRPC \u5c31\u662f\u7528 xDS \u534f\u8bae\u505a\u670d\u52a1\u53d1\u73b0\u7684\u3002 1\u3001xDS \u6982\u5ff5\u4ecb\u7ecd xDS \u5305\u542b LDS\uff08\u76d1\u542c\u5668\u53d1\u73b0\u670d\u52a1\uff09\u3001 CDS\uff08\u96c6\u7fa4\u53d1\u73b0\u670d\u52a1\uff09\u3001 EDS\uff08\u8282\u70b9\u53d1\u73b0\u670d\u52a1\uff09\u3001 SDS\uff08\u5bc6\u94a5\u53d1\u73b0\u670d\u52a1\uff09 RDS\uff08\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff09\u3002 xDS \u4e2d\u6bcf\u79cd\u7c7b\u578b\u5bf9\u5e94\u4e00\u4e2a\u53d1\u73b0\u7684\u8d44\u6e90\uff0c\u8fd9\u4e9b\u7c7b\u578b\u6570\u636e\u5b58\u50a8\u5728 xDS \u534f\u8bae\u7684 Discovery Request \u548c Discovery Response \u7684 TypeUrl \u5b57\u6bb5\u4e2d, \u8fd9\u4e2a\u5b57\u6bb5\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u5b58\u50a8\uff1a type.googleapis.com/<resource type> \u6bd4\u5982 type.googleapis.com/envoy.api.v2.Cluster \u5c31\u8868 \u660e\u662f Cluster \u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u9700\u8981\u6309\u7167 Cluster \u7c7b\u578b\u5904\u7406\u6570\u636e \u3002 envoy.api.v2.Listener\uff08LDS\uff09 \uff1a\u5bf9\u5e94 Listener \u6570\u636e\u7c7b\u578b\uff0c\u5305\u542b\u4e86\u76d1\u542c\u5668\u7684\u540d\u79f0\u3001\u76d1\u542c\u7aef\u53e3\u3001\u76d1\u542c\u5730\u5740\u7b49\u4fe1\u606f\uff0c\u901a\u8fc7\u52a8\u6001\u66f4\u65b0\u6b64\u7c7b \u578b\uff0c\u53ef\u4ee5\u52a8\u6001\u65b0\u589e\u76d1\u542c\u5668\u6216\u8005\u66f4\u65b0\u76d1\u542c\u5668\u7684\u5730\u5740\u7aef\u53e3\u7b49\u4fe1\u606f\u3002 LDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"name\": \"...\", \"address\": \"{...}\", \"filter_chains\": [], \"use_original_dst\": \"{...}\", \"per_connection_buffer_limit_bytes\": \"{...}\", \"metadata\": \"{...}\", \"drain_type\": \"...\", \"listener_filters\": [], \"listener_filters_timeout\": \"{...}\", \"continue_on_listener_filters_timeout\": \"...\", \"transparent\": \"{...}\", \"freebind\": \"{...}\", \"socket_options\": [], \"tcp_fast_open_queue_length\": \"{...}\", \"traffic_direction\": \"...\", \"udp_listener_config\": \"{...}\", \"api_listener\": \"{...}\", \"connection_balance_config\": \"{...}\", \"reuse_port\": \"...\", \"access_log\": [] } envoy.api.v2.RouteConfiguration\uff08RDS\uff09 \uff1a\u5bf9\u5e94 Envoy \u4e2d\u7684 Route \u7c7b\u578b\uff0c\u7528\u4e8e\u66f4\u65b0 virtual_hosts \uff0c\u4ee5\u53ca virtual_hosts \u5305\u542b\u7684\u8def\u7531\u8868\u4fe1\u606f\u3001\u8def\u7531\u89c4\u5219\u3001\u9488\u5bf9\u8def\u7531\u7684\u9650\u6d41\u3001\u8def\u7531\u7ea7\u522b\u7684\u63d2\u4ef6\u7b49\uff0c\u5305\u62ec\u8def\u7531\u5339\u914d\u5230\u7684 Cluster \u3002 RDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"name\": \"...\", \"virtual_hosts\": [], \"vhds\": \"{...}\", \"internal_only_headers\": [], \"response_headers_to_add\": [], \"response_headers_to_remove\": [], \"request_headers_to_add\": [], \"request_headers_to_remove\": [], \"most_specific_header_mutations_wins\": \"...\", \"validate_clusters\": \"{...}\" } envoy.api.v2.Cluster\uff08CDS\uff09 \uff1a\u5bf9\u5e94 Envoy \u4e2d\u7684 Cluster \u7c7b\u578b\uff0c\u5305\u542b\u4e86 Cluster \u662f\u91c7\u7528\u9759\u6001\u914d\u7f6e\u6570\u636e\uff0c\u8fd8\u662f\u91c7\u7528\u52a8\u6001 EDS \u53d1\u73b0\u7684\u65b9\u5f0f\uff0c\u5305\u62ec Cluster \u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3001\u5065\u5eb7\u68c0\u67e5\u914d\u7f6e\u7b49\uff0c\u4ee5\u53ca\u670d\u52a1\u7ea7\u522b\u7684\u63d2\u4ef6\u8bbe\u7f6e\u3002 CDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"transport_socket_matches\": [], \"name\": \"...\", \"alt_stat_name\": \"...\", \"type\": \"...\", \"cluster_type\": \"{...}\", \"eds_cluster_config\": \"{...}\", \"connect_timeout\": \"{...}\", \"per_connection_buffer_limit_bytes\": \"{...}\", \"lb_policy\": \"...\", \"hosts\": [], \"load_assignment\": \"{...}\", \"health_checks\": [], \"max_requests_per_connection\": \"{...}\", \"circuit_breakers\": \"{...}\", \"tls_context\": \"{...}\", \"upstream_http_protocol_options\": \"{...}\", \"common_http_protocol_options\": \"{...}\", \"http_protocol_options\": \"{...}\", \"http2_protocol_options\": \"{...}\", \"extension_protocol_options\": \"{...}\", \"typed_extension_protocol_options\": \"{...}\", \"dns_refresh_rate\": \"{...}\", \"dns_failure_refresh_rate\": \"{...}\", \"respect_dns_ttl\": \"...\", \"dns_lookup_family\": \"...\", \"dns_resolvers\": [], \"use_tcp_for_dns_lookups\": \"...\", \"outlier_detection\": \"{...}\", \"cleanup_interval\": \"{...}\", \"upstream_bind_config\": \"{...}\", \"lb_subset_config\": \"{...}\", \"ring_hash_lb_config\": \"{...}\", \"original_dst_lb_config\": \"{...}\", \"least_request_lb_config\": \"{...}\", \"common_lb_config\": \"{...}\", \"transport_socket\": \"{...}\", \"metadata\": \"{...}\", \"protocol_selection\": \"...\", \"upstream_connection_options\": \"{...}\", \"close_connections_on_host_health_failure\": \"...\", \"drain_connections_on_host_removal\": \"...\", \"filters\": [], \"track_timeout_budgets\": \"...\" } envoy.api.v2.ClusterLoadAssignment\uff08EDS\uff09 \uff1aEDS\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u670d\u52a1\u53d1\u73b0\u3002\u5305\u542b\u670d\u52a1\u540d\u3001\u8282\u70b9\u4fe1\u606f\u548c LB \u7b56\u7565\u7b49\u6570\u636e\u3002 EDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"cluster_name\": \"...\", \"endpoints\": [], \"policy\": \"{...}\" } envoy.api.v2.Auth.Secret\uff08SDS\uff09 \uff1a\u7528\u4e8e\u53d1\u73b0\u8bc1\u4e66\u4fe1\u606f\uff0c\u4ee5\u52a8\u6001\u66f4\u65b0\u8bc1\u4e66\u3002 \u65e9\u671f Istio \u4f7f\u7528\u53d8\u66f4 TLS \u8bc1\u4e66\u6587\u4ef6\uff0c\u7136\u540e\u70ed\u91cd\u542f Envoy \u7684\u65b9\u5f0f\u66f4\u65b0\u8bc1\u4e66\uff0c \u73b0\u5728\u901a\u8fc7 SDS \u5373\u53ef\u52a8\u6001\u66f4\u65b0\u8bc1\u4e66 \u3002 SDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"name\": \"...\", \"tls_certificate\": \"{...}\", \"session_ticket_keys\": \"{...}\", \"validation_context\": \"{...}\", \"generic_secret\": \"{...}\" } Envoy xDS \u534f\u8bae\u6700\u65e9\u5e76\u6ca1\u6709\u91c7\u7528 gRPC \u6d41\u5f0f\u8ba2\u9605\uff0c\u800c\u662f\u91c7\u7528 rest-json \u8f6e\u8be2\u7684\u6a21\u5f0f\u5b9e\u73b0\uff0c \u540e\u6765\u56e0\u4e3a gRPC \u6d41\u5f0f\u8ba2\u9605\u6570\u636e\u66f4\u65b0\u66f4\u52a0\u53ca\u65f6\uff0c\u6027\u80fd\u4e5f\u76f8\u5bf9\u9ad8\u6548\uff0c\u6240\u4ee5\u5728 v2 \u7248\u672c\u8f6c\u5411\u4e86 gRPC \u7684\u65b9\u5f0f\u66f4\u65b0\u6570\u636e \u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u4e3b\u8981\u770b\u4e00\u4e0b gRPC \u6d41\u5f0f\u8ba2\u9605\u6a21\u5f0f\u3002 3\u3001gRPC \u6d41\u5f0f\u8ba2\u9605 3-1 API \u8bf7\u6c42\u987a\u5e8f \u5178\u578b\u7684 HTTP \u8def\u7531\u573a\u666f\uff0c\u5ba2\u6237\u7aef\u9700\u8981\u5148\u83b7\u53d6 Listener \u8d44\u6e90\uff0c\u901a\u8fc7 Listener \u8d44\u6e90\u62ff\u5230 Route \u7684\u914d\u7f6e\u3002 Route \u4e2d\u5305\u542b\u4e00\u4e2a\u6216\u8005\u591a\u4e2a Cluster \u96c6\u7fa4\u8d44\u6e90\uff0c\u901a\u8fc7 Cluster \u96c6\u7fa4\u7684\u4fe1\u606f\u518d\u83b7\u53d6\u96c6\u7fa4\u8282\u70b9\u7684\u4fe1\u606f\uff0c\u8fd9\u6837\u6574\u4e2a\u8bf7\u6c42\u94fe\u8def\u5c31\u5b8c\u6210\u4e86\u3002 3-2 \u5168\u91cf\u8bf7\u6c42\u548c\u589e\u91cf\u8bf7\u6c42 \u4f20\u7edf\u7684 xDS \u534f\u8bae\u4f1a\u5168\u91cf\u54cd\u5e94\u8ba2\u9605\u6570\u636e\uff0c\u5bf9\u4e8e\u4e2d\u9014\u65b0\u589e\u7684\u8d44\u6e90\u8ba2\u9605\u6765\u8bf4\uff0c\u8fd9\u65e0\u7591\u662f\u8d44\u6e90\u6d6a\u8d39\uff0c\u6240\u4ee5 xDS \u65b0\u589e\u4e86\u589e\u91cf\u8ba2\u9605\u3002 \u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u51fa\u73b0\u65b0\u7684\u8d44\u6e90\u65f6\uff0c\u53ea\u9700\u5411 Management Server \u53d1\u9001\u65b0\u589e\u7684\u8d44\u6e90\uff0cManagement Server \u4e5f\u53ea\u4f1a\u8fd4\u56de\u65b0\u589e\u8d44\u6e90\u7684\u6570\u636e\u3002 3-3 \u591a\u6761\u8bf7\u6c42\u6d41\u548c\u5355\u6761\u8bf7\u6c42\u6d41 xDS \u534f\u8bae\u5e76\u4e0d\u7ea6\u675f\u5728\u8bf7\u6c42\u591a\u4e2a\u8d44\u6e90\u65f6\uff0c\u591a\u4e2a\u8d44\u6e90\u4f7f\u7528\u540c\u4e00\u4e2a\u8bf7\u6c42\u6d41\uff0c\u8fd8\u662f\u6bcf\u4e2a\u8d44\u6e90\u5404\u4f7f\u7528\u4e00\u4e2a\u8bf7\u6c42\u6d41\uff0cManagement Server \u5e94\u8be5\u540c\u65f6\u652f\u6301\u8fd9\u4e24\u79cd\u6a21\u5f0f\u3002 3-4 \u5728\u4e00\u4e2a\u8fde\u63a5\u8bf7\u6c42\u591a\u4e2a\u8d44\u6e90 \u5728\u65e9\u671f\u7684\u8bbe\u8ba1\u4e2d\uff0cxDS \u88ab\u8bbe\u8ba1\u4e3a\u591a\u4e2a\u8fde\u63a5\uff0c\u6bd4\u5982 CDS\u3001EDS \u5206\u522b\u548c Management Server \u5efa\u7acb\u8fde\u63a5\u3002\u5728\u540e\u7eed\u7684\u6539\u8fdb\u4e2d\uff0c\u652f\u6301\u5728\u4e00\u6761\u8fde\u63a5\u4e2d\u6309\u7167\u987a\u5e8f\u83b7\u53d6 xDS \u4e2d\u7684\u5404\u79cd API\uff0c\u6bd4\u5982\u5148\u8bf7\u6c42 CDS\uff0c\u7136\u540e\u8bf7\u6c42 EDS\u3002 4\u3001xDS \u534f\u8bae\u8be6\u89e3 4-1 xDS \u534f\u8bae\u8be6\u89e3 xDS API \u7684\u57fa\u7840\u77e5\u8bc6 \u4e00\u4e2a\u8bf7\u6c42\u4fe1\u606f\u793a\u4f8b\uff1a version_info: node: { id: envoy } resource_names: - foo - bar type_url: type.googleapis.com/envoy.api.v2.ClusterLoadAssignment response_nonce: \u5982\u4e0a\u8ff0\u5185\u5bb9\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u6d41\u90fd\u5e26\u6709\u4e00\u4e2a version_info \u8868\u660e\u7248\u672c\u4fe1\u606f\u3002\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u7684 version_info \u4e3a\u7a7a\uff0c\u8868\u793a\u8fd9\u662f\u8fde\u63a5\u4e2d\u7684\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u6d41\uff0c\u540e\u7eed\u4f1a\u6839\u636e Management Server \u63a8\u9001\u7684 version_info \u4f20\u9012\u3002 Node \u4e2d\u7684 ID \u5219\u8868\u660e\u673a\u5668\u4fe1\u606f\uff0c\u9700\u8981\u4f20\u9012\u673a\u5668\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u53ef\u4ee5\u7528\u673a\u5668\u7684 hostname\u3002 \u53ea\u6709\u6d41\u4e0a\u7684\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u9700\u8981\u643a\u5e26\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u540e\u7eed\u5982\u679c\u63a8\u9001\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u4e5f\u4ee5\u7b2c\u4e00\u4e2a\u4e3a\u51c6\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u503c\u5728 Management Server \u4f1a\u88ab\u7ed1\u5b9a\u5728\u8fde\u63a5\u5bf9\u5e94\u7684 stream \u4e0a\u3002 resource_names \u662f\u4e00\u4e2a\u591a\u6001\u4fe1\u606f\uff0c\u5728\u4e0d\u540c\u7684 xDS \u7c7b\u578b\u4e2d\u8868\u793a\u4e0d\u540c\u7684\u610f\u601d\uff0c\u8fd9\u91cc\u662f Cluster \u96c6\u7fa4\u7684\u540d\u79f0\u3002 type_url \u8868\u793a xDS \u7684\u7c7b\u578b\uff0c\u8fd9\u91cc\u662f CDS\uff0c\u5373\u96c6\u7fa4\u53d1\u73b0\u670d\u52a1\u3002 response_nonce \u662f Management Server \u63a8\u9001\u7684\u54cd\u5e94\u552f\u4e00\u6807\u8bc6\uff0c\u54cd\u5e94\u4fe1\u606f\u4e2d\u7684 Nonce \u4f1a\u4f5c\u4e3a\u8bf7\u6c42\u4fe1\u606f\u4e2d\u7684 response_nonce \u53d1\u9001\uff0c\u5c31\u50cf\u4e00\u4f1a\u6211\u4eec\u5c06\u5728\u8d44\u6e90\u66f4\u65b0\u90e8\u5206\u8bb2\u89e3\u7684\u4e00\u6837\uff0c Nonce \u4e3b\u8981\u662f\u7528\u6765\u6d88\u9664 ACK \u548c NACK \u4e4b\u95f4\u7684\u6b67\u4e49\u3002 \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u56e0\u4e3a\u662f\u9996\u6b21\u8bf7\u6c42\uff0c response_nonce \u4e3a\u7a7a\u3002 version_info: X resources: - foo ClusterLoadAssignment proto encoding - bar ClusterLoadAssignment proto encoding type_url: type.googleapis.com/envoy.api.v2.ClusterLoadAssignment nonce: A version_info \uff1aManagement Server \u54cd\u5e94\u6216\u8005\u63a8\u9001\u7ed9\u5ba2\u6237\u7aef Envoy \u7684\u6d88\u606f\u4e2d\uff0c\u90fd\u4f1a\u643a\u5e26\u4e00\u4e2a\u6700\u65b0\u7684\u7248\u672c\u53f7\u3002 resources\uff1a\u8fd9\u4e2a\u662f\u8fd4\u56de\u8bf7\u6c42\u4fe1\u606f\u4e2d resource_names \u5bf9\u5e94\u7684 Protobuf \u534f\u8bae\u7684\u7ed3\u6784\u4f53\u3002 type_url \uff1a\u548c\u8bf7\u6c42\u4fe1\u606f\u4e2d\u7684\u610f\u601d\u76f8\u540c\u3002 Nonce\uff1a\u6bcf\u6b21\u54cd\u5e94\u4f1a\u643a\u5e26\u4e00\u4e2a Nonce \u4f5c\u4e3a\u552f\u4e00\u6807\u8bc6\uff0c\u7528\u4e8e\u5ba2\u6237\u7aef\u7684 ACK/NACK \u6216\u8005\u533a\u5206\u8d44\u6e90\u66f4\u65b0\u5230\u5e95\u662f\u54cd\u5e94\u54ea\u4e2a\u63a8\u9001\u6570\u636e\u3002 4-2 ACK \u548c NACK& \u5728\u6536\u5230 Management Server \u63a8\u9001\u7684\u65b0\u7248\u672c\u6570\u636e\u540e\uff0cEnvoy \u4f1a\u54cd\u5e94 ACK \u6216\u8005 NACK \u544a\u77e5 Management Server \u662f\u5426\u66f4\u65b0\u7248\u672c\u6210\u529f\u3002 ACK \u4ee3\u8868\u66f4\u65b0\u7248\u672c\u6210\u529f\uff0c\u8fd9\u65f6\u4f1a\u643a\u5e26 Management Server \u63a8\u9001\u7684\u6700\u65b0\u7248\u672c\u53f7\u53d1\u9001 ACK \u4fe1\u606f\uff1b NACK \u4ee3\u8868\u66f4\u65b0\u7248\u672c\u5931\u8d25\uff0c\u8fd9\u65f6\u4f1a\u643a\u5e26\u65e7\u7684\u7248\u672c\u53f7\u53d1\u9001 NACK \u4fe1\u606f\u3002 4-3 \u8d44\u6e90\u66f4\u65b0 \u5982\u679c\u53d1\u73b0\u7684\u6570\u636e\u51fa\u73b0\u53d8\u5316\uff0c\u4f9d\u8d56\u53d1\u73b0\u6570\u636e\u7684\u5176\u4ed6\u914d\u7f6e\u5c31\u8981\u53ca\u65f6\u66f4\u65b0\u3002 \u4e3e\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u6bd4\u5982 CDS \u7684 Cluster \u96c6\u7fa4\u4fe1\u606f\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u90a3\u5c31\u610f\u5473\u7740\u7528\u6237\u8981\u8ba2\u9605\u7684\u670d\u52a1\u5217\u8868\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u56e0\u6b64\u9700\u8981\u901a\u8fc7 EDS \u7684\u670d\u52a1\u53d1\u73b0\u4fe1\u606f\uff0c\u4f20\u9012\u65b0\u8ba2\u9605\u7684\u96c6\u7fa4\u4fe1\u606f\u5230 EDS\u3002 \u5982\u4e0b\u56fe\u6240\u793a \uff0c\u6bd4\u5982\u6700\u65e9\u7528\u6237\u53ea\u8ba2\u9605\u4e86 foo \u8fd9\u4e2a\u670d\u52a1\uff0c\u4f46\u662f\u8fd9\u65f6 CDS \u4f20\u9012\u4e86\u65b0\u7684 bar \u670d\u52a1\u7ed9\u5230\u4e86 Envoy\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5f80 EDS \u53d1\u9001 foo \u548c bar \u4e24\u4e2a\u670d\u52a1\u7684\u8ba2\u9605\u4fe1\u606f\u3002 \u670d\u52a1 A \u539f\u672c\u4f9d\u8d56\u670d\u52a1 foo\uff0c\u4f46\u7ecf\u8fc7\u4e86\u4e00\u6b21\u7248\u672c\u66f4\u65b0\uff0c\u670d\u52a1 A \u540c\u65f6\u4f9d\u8d56\u670d\u52a1 foo \u548c\u670d\u52a1 bar\uff0c\u8fd9\u4e2a\u65f6\u5019 CDS \u5c31\u4f1a\u63a8\u9001 foo \u548c bar \u7684\u4fe1\u606f\u7ed9\u5230 Envoy\uff0cEnvoy \u5c31\u4f1a\u8ba9 EDS \u8fdb\u884c\u8d44\u6e90\u66f4\u65b0\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cDiscovery Request \u9664\u4e86\u9996\u6b21\u7528\u6765\u8fdb\u884c\u8d44\u6e90\u8ba2\u9605\uff0c\u540e\u9762\u57fa\u672c\u4e0a\u90fd\u662f\u7528\u6765\u505a ACK \u6216\u8005 NACK \u786e\u8ba4\u7684 Discovery Request \u4f1a\u5728 ACK \u4e4b\u540e\u7528\u76f8\u540c\u7684 version_info \u53d1\u9001\u989d\u5916\u7684 Discovery Request \u4fe1\u606f\uff0c\u8ba9 Management Server \u66f4\u65b0\u8d44\u6e90\u4fe1\u606f\u3002\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5b83\u4f1a\u4e3a\u7248\u672c X \u989d\u5916\u53d1\u9001\u4e00\u4e2a resource_names \uff0c\u4f5c\u4e3a {foo, bar} \u6570\u636e\u7684 Discovery Request \u3002 \u4f46\u662f\uff0c\u4f60\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u91cc\u53ef\u80fd\u4f1a\u53d1\u751f\u51b2\u7a81\u3002\u6bd4\u5982 Management Server \u5728\u6536\u5230 V=X \u7684\u786e\u8ba4\u6d88\u606f\u540e\uff0cfoo \u670d\u52a1\u7684 EndPoints \u4fe1\u606f\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u8fd9\u65f6 Management Server \u4f1a\u63a8\u9001\u4e00\u4e2a\u65b0\u7248\u672c V=Y \u7684\u6d88\u606f\u7ed9 Envoy\uff0c\u5982\u679c Envoy \u53d1\u9001 V=X \u7684\u65b0\u8d44\u6e90\u8ba2\u9605\u6d88\u606f\u7ed9 Management Server \uff0cManagement Server \u53ef\u80fd\u4f1a\u8bef\u8ba4\u4e3a Envoy \u62d2\u7edd\u4e86 V=Y \u7684\u65b0\u7248\u672c\u63a8\u9001\u3002 \u90a3\u4e48\u5982\u4f55\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f Envoy \u5f15\u5165\u4e86 Nonce\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u548c\u54cd\u5e94\u90fd\u5bf9\u5e94\u552f\u4e00\u7684 Nonce\uff0c\u56e0\u4e3a Envoy \u7684\u65b0\u8ba2\u9605\u6d88\u606f\u643a\u5e26\u7684 Nonce \u662f A\uff0c\u800c Management Server \u8fd4\u56de\u7684 V=Y \u7684 Nonce \u662f B\uff0c\u6240\u4ee5\u5e76\u4e0d\u4f1a\u8bef\u8ba4\u4e3a\u662f Envoy \u62d2\u7edd\u4e86\u65b0\u6570\u636e\u7684\u66f4\u65b0\u3002 Envoy \u7684\u8fd9\u4e2a\u8bbe\u8ba1\u6211\u89c9\u5f97\u6709\u70b9\u7ed5\uff0c\u5b9e\u9645\u4e0a\u5728 Istio \u7684\u63a7\u5236\u9762\u4e2d\uff0c\u4e5f\u5c31\u662f\u8fd9\u91cc\u7684 Management Server\uff0c\u5e76\u6ca1\u6709\u5b8c\u5168\u9075\u5b88\u4e0a\u9762\u63d0\u5230\u7684 Nonce \u548c version_info \u7684\u7ea6\u5b9a\uff0c\u800c\u662f\u91c7\u7528\u4e86\u4e00\u79cd\u66f4\u7b80\u5355\u3001\u76f4\u767d\u7684\u65b9\u5f0f\u89e3\u51b3\u4e0a\u9762\u63d0\u5230\u7684\u51b2\u7a81\u95ee\u9898\u3002 Istio \u5224\u65ad\u4e86\u4f20\u9012\u7684 resource_names \u7684 Clusters \u4fe1\u606f\u662f\u5426\u53d1\u751f\u53d8\u5316\uff0c\u5982\u679c\u53d1\u751f\u53d8\u5316\uff0c\u5219\u4e0d\u8ba4\u4e3a\u662f ACK \u6216\u8005 NACK\uff0c\u76f4\u63a5\u5f53\u4f5c\u8d44\u6e90\u66f4\u65b0\u5904\u7406\u3002\u663e\u7136\u8fd9\u6837\u7684\u903b\u8f91\u66f4\u6613\u4e8e\u7406\u89e3\u3002 5\u3001\u603b\u7ed3 Service Mesh \u4e2d\u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u7684\u901a\u4fe1\u6865\u6881\u2014\u2014xDS \u534f\u8bae\uff0c\u901a\u8fc7 xDS \u534f\u8bae\u6211\u4eec\u53ef\u4ee5\u505a\u5230 discovery everything\uff0c\u6240\u6709\u914d\u7f6e\u90fd\u53ef\u4ee5\u901a\u8fc7\u53d1\u73b0\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u8fd9\u662f Envoy xDS \u67b6\u6784\u4e3a\u5fae\u670d\u52a1\u4e16\u754c\u5e26\u6765\u7684\u91cd\u5927\u53d8\u9769\u3002","title":"\u7b2c\u56db\u8282 xDS\uff1a\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u901a\u4fe1\u6865\u6881"},{"location":"chap2/4chap3_xds/#xds","text":"\u901a\u8fc7\u67e5\u8be2\u4e00\u4e2a\u6216\u591a\u4e2a\u7ba1\u7406\u670d\u52a1\u5668\u83b7\u53d6\u6570\u636e\u4ee5\u53d1\u73b0\u52a8\u6001\u8d44\u6e90\u53d8\u66f4\uff0c\u6bd4\u5982 Router\u3001Cluster\u3001EndPoint \u7b49\uff0c \u6211\u4eec\u628a\u8fd9\u4e9b\u53d1\u73b0\u670d\u52a1\u53ca\u5176\u5bf9\u5e94\u7684 API \u79f0\u4e3a xDS \u3002 xDS \u6700\u5927\u7684\u4ef7\u503c\u5c31\u662f\u5b9a\u4e49\u4e86\u4e00\u5957\u53ef\u6269\u5c55\u7684\u901a\u7528\u5fae\u670d\u52a1\u63a7\u5236 API\uff0c \u8fd9\u4e9bAPI\u4e0d\u4ec5\u53ef\u4ee5\u505a\u5230\u670d\u52a1\u53d1\u73b0\uff0c\u4e5f\u53ef\u4ee5\u505a\u5230\u8def\u7531\u53d1\u73b0\u3001\u96c6\u7fa4\u53d1\u73b0\uff0c\u53ef\u4ee5\u8bf4\u6240\u6709\u914d\u7f6e\u90fd\u80fd\u901a\u8fc7\u53d1\u73b0\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u8fd9\u662f\u4e00\u79cd\u5168\u65b0\u7684\u89e3\u51b3\u65b9\u6848 \uff0c\u6240\u4ee5 xDS API \u4e0d\u4ec5\u88ab\u7528\u5728\u4e86 Service Mesh \u4e2d\uff0c\u4e5f\u7528\u5728\u4e86\u4e00\u4e9b RPC \u6846\u67b6\u4e2d\uff0c\u6bd4\u5982 gRPC \u5c31\u662f\u7528 xDS \u534f\u8bae\u505a\u670d\u52a1\u53d1\u73b0\u7684\u3002","title":"\u7b2c\u56db\u8282 xDS\uff1a\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u7684\u901a\u4fe1\u6865\u6881"},{"location":"chap2/4chap3_xds/#1xds","text":"xDS \u5305\u542b LDS\uff08\u76d1\u542c\u5668\u53d1\u73b0\u670d\u52a1\uff09\u3001 CDS\uff08\u96c6\u7fa4\u53d1\u73b0\u670d\u52a1\uff09\u3001 EDS\uff08\u8282\u70b9\u53d1\u73b0\u670d\u52a1\uff09\u3001 SDS\uff08\u5bc6\u94a5\u53d1\u73b0\u670d\u52a1\uff09 RDS\uff08\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff09\u3002 xDS \u4e2d\u6bcf\u79cd\u7c7b\u578b\u5bf9\u5e94\u4e00\u4e2a\u53d1\u73b0\u7684\u8d44\u6e90\uff0c\u8fd9\u4e9b\u7c7b\u578b\u6570\u636e\u5b58\u50a8\u5728 xDS \u534f\u8bae\u7684 Discovery Request \u548c Discovery Response \u7684 TypeUrl \u5b57\u6bb5\u4e2d, \u8fd9\u4e2a\u5b57\u6bb5\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u5b58\u50a8\uff1a type.googleapis.com/<resource type> \u6bd4\u5982 type.googleapis.com/envoy.api.v2.Cluster \u5c31\u8868 \u660e\u662f Cluster \u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u9700\u8981\u6309\u7167 Cluster \u7c7b\u578b\u5904\u7406\u6570\u636e \u3002 envoy.api.v2.Listener\uff08LDS\uff09 \uff1a\u5bf9\u5e94 Listener \u6570\u636e\u7c7b\u578b\uff0c\u5305\u542b\u4e86\u76d1\u542c\u5668\u7684\u540d\u79f0\u3001\u76d1\u542c\u7aef\u53e3\u3001\u76d1\u542c\u5730\u5740\u7b49\u4fe1\u606f\uff0c\u901a\u8fc7\u52a8\u6001\u66f4\u65b0\u6b64\u7c7b \u578b\uff0c\u53ef\u4ee5\u52a8\u6001\u65b0\u589e\u76d1\u542c\u5668\u6216\u8005\u66f4\u65b0\u76d1\u542c\u5668\u7684\u5730\u5740\u7aef\u53e3\u7b49\u4fe1\u606f\u3002 LDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"name\": \"...\", \"address\": \"{...}\", \"filter_chains\": [], \"use_original_dst\": \"{...}\", \"per_connection_buffer_limit_bytes\": \"{...}\", \"metadata\": \"{...}\", \"drain_type\": \"...\", \"listener_filters\": [], \"listener_filters_timeout\": \"{...}\", \"continue_on_listener_filters_timeout\": \"...\", \"transparent\": \"{...}\", \"freebind\": \"{...}\", \"socket_options\": [], \"tcp_fast_open_queue_length\": \"{...}\", \"traffic_direction\": \"...\", \"udp_listener_config\": \"{...}\", \"api_listener\": \"{...}\", \"connection_balance_config\": \"{...}\", \"reuse_port\": \"...\", \"access_log\": [] } envoy.api.v2.RouteConfiguration\uff08RDS\uff09 \uff1a\u5bf9\u5e94 Envoy \u4e2d\u7684 Route \u7c7b\u578b\uff0c\u7528\u4e8e\u66f4\u65b0 virtual_hosts \uff0c\u4ee5\u53ca virtual_hosts \u5305\u542b\u7684\u8def\u7531\u8868\u4fe1\u606f\u3001\u8def\u7531\u89c4\u5219\u3001\u9488\u5bf9\u8def\u7531\u7684\u9650\u6d41\u3001\u8def\u7531\u7ea7\u522b\u7684\u63d2\u4ef6\u7b49\uff0c\u5305\u62ec\u8def\u7531\u5339\u914d\u5230\u7684 Cluster \u3002 RDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"name\": \"...\", \"virtual_hosts\": [], \"vhds\": \"{...}\", \"internal_only_headers\": [], \"response_headers_to_add\": [], \"response_headers_to_remove\": [], \"request_headers_to_add\": [], \"request_headers_to_remove\": [], \"most_specific_header_mutations_wins\": \"...\", \"validate_clusters\": \"{...}\" } envoy.api.v2.Cluster\uff08CDS\uff09 \uff1a\u5bf9\u5e94 Envoy \u4e2d\u7684 Cluster \u7c7b\u578b\uff0c\u5305\u542b\u4e86 Cluster \u662f\u91c7\u7528\u9759\u6001\u914d\u7f6e\u6570\u636e\uff0c\u8fd8\u662f\u91c7\u7528\u52a8\u6001 EDS \u53d1\u73b0\u7684\u65b9\u5f0f\uff0c\u5305\u62ec Cluster \u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3001\u5065\u5eb7\u68c0\u67e5\u914d\u7f6e\u7b49\uff0c\u4ee5\u53ca\u670d\u52a1\u7ea7\u522b\u7684\u63d2\u4ef6\u8bbe\u7f6e\u3002 CDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"transport_socket_matches\": [], \"name\": \"...\", \"alt_stat_name\": \"...\", \"type\": \"...\", \"cluster_type\": \"{...}\", \"eds_cluster_config\": \"{...}\", \"connect_timeout\": \"{...}\", \"per_connection_buffer_limit_bytes\": \"{...}\", \"lb_policy\": \"...\", \"hosts\": [], \"load_assignment\": \"{...}\", \"health_checks\": [], \"max_requests_per_connection\": \"{...}\", \"circuit_breakers\": \"{...}\", \"tls_context\": \"{...}\", \"upstream_http_protocol_options\": \"{...}\", \"common_http_protocol_options\": \"{...}\", \"http_protocol_options\": \"{...}\", \"http2_protocol_options\": \"{...}\", \"extension_protocol_options\": \"{...}\", \"typed_extension_protocol_options\": \"{...}\", \"dns_refresh_rate\": \"{...}\", \"dns_failure_refresh_rate\": \"{...}\", \"respect_dns_ttl\": \"...\", \"dns_lookup_family\": \"...\", \"dns_resolvers\": [], \"use_tcp_for_dns_lookups\": \"...\", \"outlier_detection\": \"{...}\", \"cleanup_interval\": \"{...}\", \"upstream_bind_config\": \"{...}\", \"lb_subset_config\": \"{...}\", \"ring_hash_lb_config\": \"{...}\", \"original_dst_lb_config\": \"{...}\", \"least_request_lb_config\": \"{...}\", \"common_lb_config\": \"{...}\", \"transport_socket\": \"{...}\", \"metadata\": \"{...}\", \"protocol_selection\": \"...\", \"upstream_connection_options\": \"{...}\", \"close_connections_on_host_health_failure\": \"...\", \"drain_connections_on_host_removal\": \"...\", \"filters\": [], \"track_timeout_budgets\": \"...\" } envoy.api.v2.ClusterLoadAssignment\uff08EDS\uff09 \uff1aEDS\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u670d\u52a1\u53d1\u73b0\u3002\u5305\u542b\u670d\u52a1\u540d\u3001\u8282\u70b9\u4fe1\u606f\u548c LB \u7b56\u7565\u7b49\u6570\u636e\u3002 EDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"cluster_name\": \"...\", \"endpoints\": [], \"policy\": \"{...}\" } envoy.api.v2.Auth.Secret\uff08SDS\uff09 \uff1a\u7528\u4e8e\u53d1\u73b0\u8bc1\u4e66\u4fe1\u606f\uff0c\u4ee5\u52a8\u6001\u66f4\u65b0\u8bc1\u4e66\u3002 \u65e9\u671f Istio \u4f7f\u7528\u53d8\u66f4 TLS \u8bc1\u4e66\u6587\u4ef6\uff0c\u7136\u540e\u70ed\u91cd\u542f Envoy \u7684\u65b9\u5f0f\u66f4\u65b0\u8bc1\u4e66\uff0c \u73b0\u5728\u901a\u8fc7 SDS \u5373\u53ef\u52a8\u6001\u66f4\u65b0\u8bc1\u4e66 \u3002 SDS \u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a { \"name\": \"...\", \"tls_certificate\": \"{...}\", \"session_ticket_keys\": \"{...}\", \"validation_context\": \"{...}\", \"generic_secret\": \"{...}\" } Envoy xDS \u534f\u8bae\u6700\u65e9\u5e76\u6ca1\u6709\u91c7\u7528 gRPC \u6d41\u5f0f\u8ba2\u9605\uff0c\u800c\u662f\u91c7\u7528 rest-json \u8f6e\u8be2\u7684\u6a21\u5f0f\u5b9e\u73b0\uff0c \u540e\u6765\u56e0\u4e3a gRPC \u6d41\u5f0f\u8ba2\u9605\u6570\u636e\u66f4\u65b0\u66f4\u52a0\u53ca\u65f6\uff0c\u6027\u80fd\u4e5f\u76f8\u5bf9\u9ad8\u6548\uff0c\u6240\u4ee5\u5728 v2 \u7248\u672c\u8f6c\u5411\u4e86 gRPC \u7684\u65b9\u5f0f\u66f4\u65b0\u6570\u636e \u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u4e3b\u8981\u770b\u4e00\u4e0b gRPC \u6d41\u5f0f\u8ba2\u9605\u6a21\u5f0f\u3002","title":"1\u3001xDS \u6982\u5ff5\u4ecb\u7ecd"},{"location":"chap2/4chap3_xds/#3grpc","text":"","title":"3\u3001gRPC \u6d41\u5f0f\u8ba2\u9605"},{"location":"chap2/4chap3_xds/#3-1-api","text":"\u5178\u578b\u7684 HTTP \u8def\u7531\u573a\u666f\uff0c\u5ba2\u6237\u7aef\u9700\u8981\u5148\u83b7\u53d6 Listener \u8d44\u6e90\uff0c\u901a\u8fc7 Listener \u8d44\u6e90\u62ff\u5230 Route \u7684\u914d\u7f6e\u3002 Route \u4e2d\u5305\u542b\u4e00\u4e2a\u6216\u8005\u591a\u4e2a Cluster \u96c6\u7fa4\u8d44\u6e90\uff0c\u901a\u8fc7 Cluster \u96c6\u7fa4\u7684\u4fe1\u606f\u518d\u83b7\u53d6\u96c6\u7fa4\u8282\u70b9\u7684\u4fe1\u606f\uff0c\u8fd9\u6837\u6574\u4e2a\u8bf7\u6c42\u94fe\u8def\u5c31\u5b8c\u6210\u4e86\u3002","title":"3-1 API \u8bf7\u6c42\u987a\u5e8f"},{"location":"chap2/4chap3_xds/#3-2","text":"\u4f20\u7edf\u7684 xDS \u534f\u8bae\u4f1a\u5168\u91cf\u54cd\u5e94\u8ba2\u9605\u6570\u636e\uff0c\u5bf9\u4e8e\u4e2d\u9014\u65b0\u589e\u7684\u8d44\u6e90\u8ba2\u9605\u6765\u8bf4\uff0c\u8fd9\u65e0\u7591\u662f\u8d44\u6e90\u6d6a\u8d39\uff0c\u6240\u4ee5 xDS \u65b0\u589e\u4e86\u589e\u91cf\u8ba2\u9605\u3002 \u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u51fa\u73b0\u65b0\u7684\u8d44\u6e90\u65f6\uff0c\u53ea\u9700\u5411 Management Server \u53d1\u9001\u65b0\u589e\u7684\u8d44\u6e90\uff0cManagement Server \u4e5f\u53ea\u4f1a\u8fd4\u56de\u65b0\u589e\u8d44\u6e90\u7684\u6570\u636e\u3002","title":"3-2 \u5168\u91cf\u8bf7\u6c42\u548c\u589e\u91cf\u8bf7\u6c42"},{"location":"chap2/4chap3_xds/#3-3","text":"xDS \u534f\u8bae\u5e76\u4e0d\u7ea6\u675f\u5728\u8bf7\u6c42\u591a\u4e2a\u8d44\u6e90\u65f6\uff0c\u591a\u4e2a\u8d44\u6e90\u4f7f\u7528\u540c\u4e00\u4e2a\u8bf7\u6c42\u6d41\uff0c\u8fd8\u662f\u6bcf\u4e2a\u8d44\u6e90\u5404\u4f7f\u7528\u4e00\u4e2a\u8bf7\u6c42\u6d41\uff0cManagement Server \u5e94\u8be5\u540c\u65f6\u652f\u6301\u8fd9\u4e24\u79cd\u6a21\u5f0f\u3002","title":"3-3 \u591a\u6761\u8bf7\u6c42\u6d41\u548c\u5355\u6761\u8bf7\u6c42\u6d41"},{"location":"chap2/4chap3_xds/#3-4","text":"\u5728\u65e9\u671f\u7684\u8bbe\u8ba1\u4e2d\uff0cxDS \u88ab\u8bbe\u8ba1\u4e3a\u591a\u4e2a\u8fde\u63a5\uff0c\u6bd4\u5982 CDS\u3001EDS \u5206\u522b\u548c Management Server \u5efa\u7acb\u8fde\u63a5\u3002\u5728\u540e\u7eed\u7684\u6539\u8fdb\u4e2d\uff0c\u652f\u6301\u5728\u4e00\u6761\u8fde\u63a5\u4e2d\u6309\u7167\u987a\u5e8f\u83b7\u53d6 xDS \u4e2d\u7684\u5404\u79cd API\uff0c\u6bd4\u5982\u5148\u8bf7\u6c42 CDS\uff0c\u7136\u540e\u8bf7\u6c42 EDS\u3002","title":"3-4 \u5728\u4e00\u4e2a\u8fde\u63a5\u8bf7\u6c42\u591a\u4e2a\u8d44\u6e90"},{"location":"chap2/4chap3_xds/#4xds","text":"","title":"4\u3001xDS \u534f\u8bae\u8be6\u89e3"},{"location":"chap2/4chap3_xds/#4-1-xds","text":"xDS API \u7684\u57fa\u7840\u77e5\u8bc6 \u4e00\u4e2a\u8bf7\u6c42\u4fe1\u606f\u793a\u4f8b\uff1a version_info: node: { id: envoy } resource_names: - foo - bar type_url: type.googleapis.com/envoy.api.v2.ClusterLoadAssignment response_nonce: \u5982\u4e0a\u8ff0\u5185\u5bb9\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u6d41\u90fd\u5e26\u6709\u4e00\u4e2a version_info \u8868\u660e\u7248\u672c\u4fe1\u606f\u3002\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u7684 version_info \u4e3a\u7a7a\uff0c\u8868\u793a\u8fd9\u662f\u8fde\u63a5\u4e2d\u7684\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u6d41\uff0c\u540e\u7eed\u4f1a\u6839\u636e Management Server \u63a8\u9001\u7684 version_info \u4f20\u9012\u3002 Node \u4e2d\u7684 ID \u5219\u8868\u660e\u673a\u5668\u4fe1\u606f\uff0c\u9700\u8981\u4f20\u9012\u673a\u5668\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u53ef\u4ee5\u7528\u673a\u5668\u7684 hostname\u3002 \u53ea\u6709\u6d41\u4e0a\u7684\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u9700\u8981\u643a\u5e26\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u540e\u7eed\u5982\u679c\u63a8\u9001\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u4e5f\u4ee5\u7b2c\u4e00\u4e2a\u4e3a\u51c6\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u503c\u5728 Management Server \u4f1a\u88ab\u7ed1\u5b9a\u5728\u8fde\u63a5\u5bf9\u5e94\u7684 stream \u4e0a\u3002 resource_names \u662f\u4e00\u4e2a\u591a\u6001\u4fe1\u606f\uff0c\u5728\u4e0d\u540c\u7684 xDS \u7c7b\u578b\u4e2d\u8868\u793a\u4e0d\u540c\u7684\u610f\u601d\uff0c\u8fd9\u91cc\u662f Cluster \u96c6\u7fa4\u7684\u540d\u79f0\u3002 type_url \u8868\u793a xDS \u7684\u7c7b\u578b\uff0c\u8fd9\u91cc\u662f CDS\uff0c\u5373\u96c6\u7fa4\u53d1\u73b0\u670d\u52a1\u3002 response_nonce \u662f Management Server \u63a8\u9001\u7684\u54cd\u5e94\u552f\u4e00\u6807\u8bc6\uff0c\u54cd\u5e94\u4fe1\u606f\u4e2d\u7684 Nonce \u4f1a\u4f5c\u4e3a\u8bf7\u6c42\u4fe1\u606f\u4e2d\u7684 response_nonce \u53d1\u9001\uff0c\u5c31\u50cf\u4e00\u4f1a\u6211\u4eec\u5c06\u5728\u8d44\u6e90\u66f4\u65b0\u90e8\u5206\u8bb2\u89e3\u7684\u4e00\u6837\uff0c Nonce \u4e3b\u8981\u662f\u7528\u6765\u6d88\u9664 ACK \u548c NACK \u4e4b\u95f4\u7684\u6b67\u4e49\u3002 \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u56e0\u4e3a\u662f\u9996\u6b21\u8bf7\u6c42\uff0c response_nonce \u4e3a\u7a7a\u3002 version_info: X resources: - foo ClusterLoadAssignment proto encoding - bar ClusterLoadAssignment proto encoding type_url: type.googleapis.com/envoy.api.v2.ClusterLoadAssignment nonce: A version_info \uff1aManagement Server \u54cd\u5e94\u6216\u8005\u63a8\u9001\u7ed9\u5ba2\u6237\u7aef Envoy \u7684\u6d88\u606f\u4e2d\uff0c\u90fd\u4f1a\u643a\u5e26\u4e00\u4e2a\u6700\u65b0\u7684\u7248\u672c\u53f7\u3002 resources\uff1a\u8fd9\u4e2a\u662f\u8fd4\u56de\u8bf7\u6c42\u4fe1\u606f\u4e2d resource_names \u5bf9\u5e94\u7684 Protobuf \u534f\u8bae\u7684\u7ed3\u6784\u4f53\u3002 type_url \uff1a\u548c\u8bf7\u6c42\u4fe1\u606f\u4e2d\u7684\u610f\u601d\u76f8\u540c\u3002 Nonce\uff1a\u6bcf\u6b21\u54cd\u5e94\u4f1a\u643a\u5e26\u4e00\u4e2a Nonce \u4f5c\u4e3a\u552f\u4e00\u6807\u8bc6\uff0c\u7528\u4e8e\u5ba2\u6237\u7aef\u7684 ACK/NACK \u6216\u8005\u533a\u5206\u8d44\u6e90\u66f4\u65b0\u5230\u5e95\u662f\u54cd\u5e94\u54ea\u4e2a\u63a8\u9001\u6570\u636e\u3002","title":"4-1 xDS \u534f\u8bae\u8be6\u89e3"},{"location":"chap2/4chap3_xds/#4-2-ack-nack","text":"\u5728\u6536\u5230 Management Server \u63a8\u9001\u7684\u65b0\u7248\u672c\u6570\u636e\u540e\uff0cEnvoy \u4f1a\u54cd\u5e94 ACK \u6216\u8005 NACK \u544a\u77e5 Management Server \u662f\u5426\u66f4\u65b0\u7248\u672c\u6210\u529f\u3002 ACK \u4ee3\u8868\u66f4\u65b0\u7248\u672c\u6210\u529f\uff0c\u8fd9\u65f6\u4f1a\u643a\u5e26 Management Server \u63a8\u9001\u7684\u6700\u65b0\u7248\u672c\u53f7\u53d1\u9001 ACK \u4fe1\u606f\uff1b NACK \u4ee3\u8868\u66f4\u65b0\u7248\u672c\u5931\u8d25\uff0c\u8fd9\u65f6\u4f1a\u643a\u5e26\u65e7\u7684\u7248\u672c\u53f7\u53d1\u9001 NACK \u4fe1\u606f\u3002","title":"4-2 ACK \u548c NACK&amp;"},{"location":"chap2/4chap3_xds/#4-3","text":"\u5982\u679c\u53d1\u73b0\u7684\u6570\u636e\u51fa\u73b0\u53d8\u5316\uff0c\u4f9d\u8d56\u53d1\u73b0\u6570\u636e\u7684\u5176\u4ed6\u914d\u7f6e\u5c31\u8981\u53ca\u65f6\u66f4\u65b0\u3002 \u4e3e\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u6bd4\u5982 CDS \u7684 Cluster \u96c6\u7fa4\u4fe1\u606f\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u90a3\u5c31\u610f\u5473\u7740\u7528\u6237\u8981\u8ba2\u9605\u7684\u670d\u52a1\u5217\u8868\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u56e0\u6b64\u9700\u8981\u901a\u8fc7 EDS \u7684\u670d\u52a1\u53d1\u73b0\u4fe1\u606f\uff0c\u4f20\u9012\u65b0\u8ba2\u9605\u7684\u96c6\u7fa4\u4fe1\u606f\u5230 EDS\u3002 \u5982\u4e0b\u56fe\u6240\u793a \uff0c\u6bd4\u5982\u6700\u65e9\u7528\u6237\u53ea\u8ba2\u9605\u4e86 foo \u8fd9\u4e2a\u670d\u52a1\uff0c\u4f46\u662f\u8fd9\u65f6 CDS \u4f20\u9012\u4e86\u65b0\u7684 bar \u670d\u52a1\u7ed9\u5230\u4e86 Envoy\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5f80 EDS \u53d1\u9001 foo \u548c bar \u4e24\u4e2a\u670d\u52a1\u7684\u8ba2\u9605\u4fe1\u606f\u3002 \u670d\u52a1 A \u539f\u672c\u4f9d\u8d56\u670d\u52a1 foo\uff0c\u4f46\u7ecf\u8fc7\u4e86\u4e00\u6b21\u7248\u672c\u66f4\u65b0\uff0c\u670d\u52a1 A \u540c\u65f6\u4f9d\u8d56\u670d\u52a1 foo \u548c\u670d\u52a1 bar\uff0c\u8fd9\u4e2a\u65f6\u5019 CDS \u5c31\u4f1a\u63a8\u9001 foo \u548c bar \u7684\u4fe1\u606f\u7ed9\u5230 Envoy\uff0cEnvoy \u5c31\u4f1a\u8ba9 EDS \u8fdb\u884c\u8d44\u6e90\u66f4\u65b0\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cDiscovery Request \u9664\u4e86\u9996\u6b21\u7528\u6765\u8fdb\u884c\u8d44\u6e90\u8ba2\u9605\uff0c\u540e\u9762\u57fa\u672c\u4e0a\u90fd\u662f\u7528\u6765\u505a ACK \u6216\u8005 NACK \u786e\u8ba4\u7684 Discovery Request \u4f1a\u5728 ACK \u4e4b\u540e\u7528\u76f8\u540c\u7684 version_info \u53d1\u9001\u989d\u5916\u7684 Discovery Request \u4fe1\u606f\uff0c\u8ba9 Management Server \u66f4\u65b0\u8d44\u6e90\u4fe1\u606f\u3002\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5b83\u4f1a\u4e3a\u7248\u672c X \u989d\u5916\u53d1\u9001\u4e00\u4e2a resource_names \uff0c\u4f5c\u4e3a {foo, bar} \u6570\u636e\u7684 Discovery Request \u3002 \u4f46\u662f\uff0c\u4f60\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u91cc\u53ef\u80fd\u4f1a\u53d1\u751f\u51b2\u7a81\u3002\u6bd4\u5982 Management Server \u5728\u6536\u5230 V=X \u7684\u786e\u8ba4\u6d88\u606f\u540e\uff0cfoo \u670d\u52a1\u7684 EndPoints \u4fe1\u606f\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u8fd9\u65f6 Management Server \u4f1a\u63a8\u9001\u4e00\u4e2a\u65b0\u7248\u672c V=Y \u7684\u6d88\u606f\u7ed9 Envoy\uff0c\u5982\u679c Envoy \u53d1\u9001 V=X \u7684\u65b0\u8d44\u6e90\u8ba2\u9605\u6d88\u606f\u7ed9 Management Server \uff0cManagement Server \u53ef\u80fd\u4f1a\u8bef\u8ba4\u4e3a Envoy \u62d2\u7edd\u4e86 V=Y \u7684\u65b0\u7248\u672c\u63a8\u9001\u3002 \u90a3\u4e48\u5982\u4f55\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f Envoy \u5f15\u5165\u4e86 Nonce\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u548c\u54cd\u5e94\u90fd\u5bf9\u5e94\u552f\u4e00\u7684 Nonce\uff0c\u56e0\u4e3a Envoy \u7684\u65b0\u8ba2\u9605\u6d88\u606f\u643a\u5e26\u7684 Nonce \u662f A\uff0c\u800c Management Server \u8fd4\u56de\u7684 V=Y \u7684 Nonce \u662f B\uff0c\u6240\u4ee5\u5e76\u4e0d\u4f1a\u8bef\u8ba4\u4e3a\u662f Envoy \u62d2\u7edd\u4e86\u65b0\u6570\u636e\u7684\u66f4\u65b0\u3002 Envoy \u7684\u8fd9\u4e2a\u8bbe\u8ba1\u6211\u89c9\u5f97\u6709\u70b9\u7ed5\uff0c\u5b9e\u9645\u4e0a\u5728 Istio \u7684\u63a7\u5236\u9762\u4e2d\uff0c\u4e5f\u5c31\u662f\u8fd9\u91cc\u7684 Management Server\uff0c\u5e76\u6ca1\u6709\u5b8c\u5168\u9075\u5b88\u4e0a\u9762\u63d0\u5230\u7684 Nonce \u548c version_info \u7684\u7ea6\u5b9a\uff0c\u800c\u662f\u91c7\u7528\u4e86\u4e00\u79cd\u66f4\u7b80\u5355\u3001\u76f4\u767d\u7684\u65b9\u5f0f\u89e3\u51b3\u4e0a\u9762\u63d0\u5230\u7684\u51b2\u7a81\u95ee\u9898\u3002 Istio \u5224\u65ad\u4e86\u4f20\u9012\u7684 resource_names \u7684 Clusters \u4fe1\u606f\u662f\u5426\u53d1\u751f\u53d8\u5316\uff0c\u5982\u679c\u53d1\u751f\u53d8\u5316\uff0c\u5219\u4e0d\u8ba4\u4e3a\u662f ACK \u6216\u8005 NACK\uff0c\u76f4\u63a5\u5f53\u4f5c\u8d44\u6e90\u66f4\u65b0\u5904\u7406\u3002\u663e\u7136\u8fd9\u6837\u7684\u903b\u8f91\u66f4\u6613\u4e8e\u7406\u89e3\u3002","title":"4-3 \u8d44\u6e90\u66f4\u65b0"},{"location":"chap2/4chap3_xds/#5","text":"Service Mesh \u4e2d\u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u7684\u901a\u4fe1\u6865\u6881\u2014\u2014xDS \u534f\u8bae\uff0c\u901a\u8fc7 xDS \u534f\u8bae\u6211\u4eec\u53ef\u4ee5\u505a\u5230 discovery everything\uff0c\u6240\u6709\u914d\u7f6e\u90fd\u53ef\u4ee5\u901a\u8fc7\u53d1\u73b0\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u8fd9\u662f Envoy xDS \u67b6\u6784\u4e3a\u5fae\u670d\u52a1\u4e16\u754c\u5e26\u6765\u7684\u91cd\u5927\u53d8\u9769\u3002","title":"5\u3001\u603b\u7ed3"},{"location":"chap2/5chap3_ingress_egress/","text":"\u7b2c\u4e94\u8282 Ingress \u548c Egress\uff1a\u5165\u53e3\u6d41\u91cf\u548c\u51fa\u53e3\u6d41\u91cf\u63a7\u5236 Ingress \u662f Kubernetes \u96c6\u7fa4\u4e3a\u4e86\u8ba9\u5916\u90e8\u53ef\u4ee5\u8bbf\u95ee\uff0c\u5f15\u5165\u7684\u4e00\u79cd\u8d44\u6e90\u7c7b\u578b\u3002 \u4e00\u822c Ingress \u4e3a\u5e38\u89c1\u7684 Nginx \u8fd9\u6837\u7684\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\u63d0\u4f9b\u5177\u4f53\u529f\u80fd\uff0c\u8bf8\u5982\u8d1f\u8f7d\u5747\u8861\u3001SSL \u8bc1\u4e66\u5378\u8f7d\uff0c\u4ee5\u53ca\u57fa\u4e8e\u540d\u79f0\u7684\u865a\u62df\u4e3b\u673a\u529f\u80fd\u3002\u8fd9\u4e9b\u529f\u80fd\u662f\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\u7684\u57fa\u672c\u529f\u80fd\uff0c Ingress \u53ef\u4ee5\u7406\u89e3\u4e3a\u5165\u53e3\u7f51\u5173 \uff0c\u800c Egress \u548c Ingress \u7684\u529f\u80fd\u76f8\u4eff\uff0c\u53ea\u662f\u6d41\u91cf\u7684\u4ee3\u7406\u6d41\u5411\u4e0d\u540c\uff0c Egress \u8d1f\u8d23\u51fa\u53e3\u6d41\u91cf\u7684\u4ee3\u7406 \u3002 1\u3001\u4e3a\u4ec0\u4e48\u9700\u8981 Ingress \u4e00\u822c\u6765\u8bf4\u6709\u4e24\u79cd\u5e38\u7528\u7684\u65b9\u5f0f\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u5185\u90e8\u7684\u7f51\u7edc\uff0c\u5206\u522b\u662fNodePort \u6a21\u5f0f\u548c Ingress \u6a21\u5f0f\u3002 1-1 NodePort \u6a21\u5f0f \u5728 Kubernetes \u96c6\u7fa4\u5185\u90e8\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Service \u7684\u57df\u540d\u8bbf\u95ee\u670d\u52a1\u7684 Pod\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684 YAML \u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u53ef\u4ee5\u8ba9\u96c6\u7fa4\u5916\u90e8\u901a\u8fc7 NodePort \u7684\u65b9\u5f0f\u8bbf\u95ee\u96c6\u7fa4\u5185\u90e8\u7684\u8d44\u6e90\uff1a apiVersion: v1 kind: Service metadata: name: my-service spec: type: NodePort selector: app: MyApp ports: # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c`targetPort` \u88ab\u8bbe\u7f6e\u4e3a\u4e0e `port` \u5b57\u6bb5\u76f8\u540c\u7684\u503c - port: 80 targetPort: 80 # \u53ef\u9009\u5b57\u6bb5 # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0cKubernetes \u63a7\u5236\u5e73\u9762\u4f1a\u4ece\u67d0\u4e2a\u8303\u56f4\u5185\u5206\u914d\u4e00\u4e2a\u7aef\u53e3\u53f7\uff08\u9ed8\u8ba4\uff1a30000-32767\uff09 nodePort: 30007 NodePort \u7684\u9ed8\u8ba4\u7aef\u53e3\u8303\u56f4\u662f 30000-32767\uff0c\u4f46\u662f\u4e00\u822c\u4e0d\u5efa\u8bae\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u8fd9\u4e2a\u7aef\u53e3\u8303\u56f4\uff0c\u4ee5\u514d\u5f15\u53d1\u51b2\u7a81\u3002 \u5982\u4e0a\u793a\u4f8b\uff0c\u96c6\u7fa4\u5916\u90e8\u9996\u5148\u8bbf\u95ee NodePort \u7684\u7aef\u53e3\uff0c\u793a\u4f8b\u4e2d\u7aef\u53e3\u4e3a 30007\uff0c\u901a\u8fc7 IPVS \u4e00\u7cfb\u5217\u7684\u52ab\u6301\u8def\u7531\u64cd\u4f5c\uff0c\u5c06\u6d41\u91cf\u8def\u7531\u5230\u96c6\u7fa4\u5185\u90e8\u7684 my-service \u670d\u52a1\u7684\u7aef\u53e3 80\uff0c\u8fd9\u4e2a\u7aef\u53e3\u662f ClusterIP \u66b4\u9732\u51fa\u6765\u7684\u7aef\u53e3\uff0c\u5728 Kubernetes \u96c6\u7fa4\u5185\u90e8\u53ef\u4ee5\u901a\u8fc7 ClusterIP:Port \u7684\u65b9\u5f0f\u8bbf\u95ee my-service \u670d\u52a1\u3002 Kubernetes \u96c6\u7fa4\u5185\u90e8\u4f1a\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u670d\u52a1\u5bf9\u5e94\u7684 Pod IP \u7684 TargetPort \u4e0a\u9762\u3002 \u901a\u8fc7\u51e0\u53f0\u7279\u5b9a\u7684 Node \u673a\u5668\u505a\u6570\u636e\u8f6c\u53d1\uff0c\u4e00\u65e6\u6d41\u91cf\u589e\u52a0\uff0c\u53ef\u80fd\u4f1a\u5f71\u54cd\u8be5\u673a\u5668\u5bbf\u4e3b\u673a\u7684\u7a33\u5b9a\u6027\u3002\u5982\u679c\u96c6\u7fa4\u5bf9\u5916\u66b4\u9732\u591a\u4e2a\u670d\u52a1\uff0c\u7ef4\u62a4\u7684\u96be\u5ea6\u4e5f\u968f\u4e4b\u589e\u52a0\uff0c\u4e0a\u9762\u63d0\u5230\u7684\u6269\u7f29\u5bb9\u95ee\u9898\uff0c\u4f1a\u88ab\u6570\u500d\u653e\u5927\uff1a \u4e00\u53f0 Node \u673a\u5668\u7684\u53d8\u52a8\uff0c\u9700\u8981\u4fee\u6539\u5927\u91cf\u7684\u5165\u53e3\u670d\u52a1\u914d\u7f6e\u3002 1-2 Ingress \u6a21\u5f0f \u5ba2\u6237\u7aef\u901a\u8fc7 Ingress \u4e0a\u5b9a\u4e49\u7684\u8def\u7531\u89c4\u5219\uff0c\u8f6c\u53d1\u5230\u7279\u5b9a\u7684 Service \u4e0a\u9762\uff0c\u6bd4\u5982\u901a\u8fc7\u8bbe\u7f6e path\u3001header\u3001host \u7b49\u8def\u7531\u89c4\u5219\u6765\u51b3\u5b9a\u5177\u4f53\u8f6c\u53d1\u5230\u54ea\u4e2a Service\u3002 \u901a\u8fc7\u4e0b\u9762\u7684\u914d\u7f6e\u4f60\u53ef\u4ee5\u770b\u5230\uff0cIngress \u662f\u4e00\u79cd\u5168\u65b0\u7684\u8d44\u6e90\u7c7b\u578b\uff0c\u4e0e\u6240\u6709\u5176\u4ed6 Kubernetes \u8d44\u6e90\u4e00\u6837\uff0cIngress \u9700\u8981\u4f7f\u7528 apiVersion\u3001kind \u548c metadata \u5b57\u6bb5\u3002 apiVersion: networking.Kubernetes.io/v1 kind: Ingress metadata: name: minimal-ingress annotations: nginx.ingress.kubernetes.io/rewrite-target: / spec: rules: - http: paths: - path: /testpath pathType: Prefix backend: service: name: test port: number: 80 \u6211\u4eec\u6765\u770b\u4e00\u4e0b\uff0c Ingress \u8d44\u6e90\u7c7b\u578b\u7279\u6709\u7684\u51e0\u4e2a\u5b57\u6bb5\u7684\u542b\u4e49\u3002 host \uff1a\u53ef\u9009\u62e9\u548c\u57df\u540d\u5339\u914d\u7684 host\uff0c\u6bd4\u5982\u5982\u679c\u8bbe\u7f6e host \u5b57\u6bb5 foo.bar.com \uff0c\u5219\u9700\u8981\u901a\u8fc7 foo.bar.com \u7684\u57df\u540d\u8bbf\u95ee\u3002\u5982\u679c\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u6ca1\u6709\u8bbe\u7f6e host \u5b57\u6bb5\uff0c\u5219\u8868\u660e\u4efb\u4f55\u57df\u540d\u8fc7\u6765\u7684\u8bf7\u6c42\u90fd\u53ef\u4ee5\u5339\u914d\u3002 http.paths.path \uff1a\u7528\u4e8e\u8bf7\u6c42 path \u7684\u5339\u914d\uff0c\u6bd4\u5982\u8fd9\u4e2a\u4f8b\u5b50\u901a\u8fc7 pathType:Prefix \u524d\u7f00\u5339\u914d\u7684\u65b9\u5f0f\uff0c\u6240\u6709 path \u4e2d\u524d\u7f00\u4e3a /testpath \u7684\u8def\u5f84\uff0c\u90fd\u4f1a\u88ab\u5339\u914d\u5230\uff1b\u800c\u5176\u4ed6\u6ca1\u6709\u5339\u914d\u5230\u7684 path \u5c31\u4f1a\u8fd4\u56de 404\u3002 http.paths.backend \uff1a\u5176\u4e2d name \u5b57\u6bb5\u8868\u793a\u670d\u52a1\u540d\uff0c\u8fd9\u4e2a\u670d\u52a1\u540d\u548c Kubernetes \u4e2d\u7684Service \u540d\u79f0\u76f8\u5339\u914d\uff1bport \u5219\u662f Service \u7684\u7aef\u53e3\u53f7\uff0c\u6d41\u91cf\u4f1a\u901a\u8fc7 clusterIP:port \u7684\u65b9\u5f0f\u88ab\u8f6c\u53d1\u5230\u7279\u5b9a\u670d\u52a1\u3002 2\u3001IngressClass \u8d44\u6e90\u7c7b\u578b \u5728 Kubernetes1.18 \u7248\u672c\u4e4b\u524d\uff0cIngressClass \u662f\u901a\u8fc7 Ingress \u4e2d\u7684\u4e00\u4e2a kubernetes.io/ingress.class \u6ce8\u89e3\u6765\u6307\u5b9a\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4ece 1.18 \u5f00\u59cb\u5982\u4f55\u914d\u7f6e Ingress Class\u3002 \u901a\u8fc7\u5728 Ingress \u8d44\u6e90\u7c7b\u578b\u4e2d\u8bbe\u7f6e IngressClassName \u6765\u6307\u5b9a\u7279\u5b9a\u7684 IngressClass \u914d\u7f6e\uff0c IngressClass \u7684\u914d\u7f6e\u5982\u4e0b\uff0c\u5176\u4e2d\u5305\u542b\u4e86 ingress-controller \u7684\u540d\u79f0 \uff0c \u5728\u8fd9\u91cc ingress-controller \u540d\u79f0\u4e3a example.com/ingress-controller \uff1a apiVersion: networking.k8s.io/v1 kind: IngressClass metadata: name: external-lb spec: controller: example.com/ingress-controller parameters: apiGroup: k8s.example.com kind: IngressParameters name: external-lb 2-1 ingress-controller ingress-controller \u5e76\u4e0d\u662f\u968f\u7740 Kubernetes \u96c6\u7fa4\u4e00\u8d77\u542f\u52a8\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u5982\u4f55\u5728 Minukube \u73af\u5883\u4e2d\u4f7f\u7528 Nginx ingress-controller\u3002 \u542f\u52a8 Minukube \u96c6\u7fa4\uff0c\u9700\u8981\u5148\u5220\u9664\u5df2\u6709\u7684 Minukube \u96c6\u7fa4\uff1a minikube delete \u7136\u540e\u901a\u8fc7\u865a\u62df\u673a\u65b9\u5f0f\u542f\u52a8\uff0c\u56e0\u4e3a Ingress \u7684 Addon \u65e0\u6cd5\u5728 Docker \u6a21\u5f0f\u4f7f\u7528\uff1a minikube start --kubernetes-version=v1.19.2 --vm=true \u542f\u52a8 ingress-controller \uff1a minikube addons enable ingress \u90e8\u7f72 helloapp\uff1a kubectl create deployment web --image=gcr.io/google-samples/hello-app:1.0 \u521b\u5efa Ingress \u8d44\u6e90\uff1a kubectl apply -f https://k8s.io/examples/service/networking/example-ingress.yaml \u901a\u8fc7 minikube iP \u547d\u4ee4\u83b7\u53d6 Ip \u5730\u5740\uff0c\u5e76\u4fee\u6539 /etc/hosts \uff0c\u5c06\u5176\u6dfb\u52a0\u5728\u6587\u4ef6\u7ed3\u5c3e\uff0c\u4ee3\u7801\u4e2d 127.0.0.1 \u5c31\u662f minikube ip \u83b7\u53d6\u7684 IP\uff1a 127.0.0.1 hello-world.info \u901a\u8fc7 cURL \u6216\u8005\u6d4f\u89c8\u5668\u8bbf\u95ee hello-world.info\uff1a curl hello-world.info \u81f3\u6b64\uff0cKubernetes \u539f\u751f\u7684 Ingress \u5c31\u8bb2\u5b8c\u4e86\u3002 Ingress \u89e3\u51b3\u4e86 NodePod \u914d\u7f6e\u4e0d\u65b9\u4fbf\u7684\u95ee\u9898\uff0c\u4f46\u901a\u8fc7 YAML \u7684\u65b9\u5f0f\u63a7\u5236 Ingress \u4f9d\u7136\u662f\u4e00\u4ef6\u9ebb\u70e6\u4e8b\uff0c\u53e6\u5916 Ingress \u5185\u90e8\u4f9d\u7136\u662f\u4f7f\u7528 ClusterIP \u7684\u65b9\u5f0f\u6765\u8bbf\u95ee Service\uff0c\u800c\u8fd9\u6837\u7684\u65b9\u5f0f\u662f\u901a\u8fc7 IPVS \u56db\u5c42\u8f6c\u53d1\u505a\u5230\u7684\u3002 3\u3001Istio Gateway Istio \u91c7\u7528\u4e86\u4e00\u79cd\u65b0\u7684\u6a21\u578b\u2014\u2014Istio Gateway \u6765\u4ee3\u66ff Kubernetes \u4e2d\u7684 Ingress \u8d44\u6e90\u7c7b\u578b\u3002 Gateway \u5141\u8bb8\u5916\u90e8\u6d41\u91cf\u8bbf\u95ee\u5185\u90e8\u670d\u52a1 \uff0c\u5f97\u76ca\u4e8e Istio \u5f3a\u5927\u7684\u63a7\u5236\u9762\u914d\u7f6e\uff0cGateway \u8d44\u6e90\u7c7b\u578b\u7684\u914d\u7f6e\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u6d41\u91cf\u8f6c\u53d1\u5373\u53ef\u3002 minikube delete minikube start --kubernetes-version=v1.19.2 --driver=docker minikube tunnel \u8fd9\u6837\u5916\u90e8\u5c31\u53ef\u4ee5\u901a\u8fc7 Minikube IP \u8bbf\u95ee\u96c6\u7fa4\u5185\u90e8\u7684\u8d44\u6e90\u4e86\u3002 \u4e0b\u9762\u8fdb\u5165 Istio \u76ee\u5f55\uff0c\u90e8\u7f72\u4e00\u4e2a\u6d4b\u8bd5\u670d\u52a1\uff1a kubectl apply -f samples/httpbin/httpbin.yaml \u901a\u8fc7\u547d\u4ee4\u67e5\u770b Pod \u662f\u5426\u6210\u529f\u542f\u52a8\uff0c\u6839\u636e\u673a\u5668\u914d\u7f6e\u4e0d\u540c\uff0c\u8fd9\u91cc\u7684 Pod \u542f\u52a8\u53ef\u80fd\u9700\u8981\u4e00\u5b9a\u7684\u65f6\u95f4\uff0c\u8bf7\u8010\u5fc3\u7b49\u5f85 pod \u542f\u52a8\u6210\u529f\uff1a $ kubectl get pods NAME READY STATUS RESTARTS AGE details-v1-79c697d759-gt9th 2/2 Running 7 95d httpbin-74fb669cc6-jzs87 0/2 Init:0/1 0 7s productpage-v1-65576bb7bf-wjkjm 2/2 Running 7 95d ratings-v1-7d99676f7f-h9blt 2/2 Running 6 95d reviews-v1-987d495c-pmnb9 2/2 Running 7 95d reviews-v2-6c5bf657cf-qd2kr 2/2 Running 7 95d reviews-v3-5f7b9f4f77-gnv4c 2/2 Running 7 95d \u521b\u5efa Istio Gateway\uff0c\u6ce8\u610f\uff1a \u8fd9\u91cc\u8bbe\u7f6e\u4e86 hosts \u4e3a httpbin.example.com \uff0c\u4e5f\u5c31\u662f\u53ea\u6709 host \u4e3a httpbin.example.com \u624d\u80fd\u6b63\u786e\u8bbf\u95ee httpbin \u7684\u670d\u52a1 \uff1a kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: httpbin-gateway spec: selector: istio: ingressgateway # use Istio default gateway implementation servers: - port: number: 80 name: http protocol: HTTP hosts: - \"httpbin.example.com\" EOF \u5c06 httpbin \u670d\u52a1\u66b4\u9732\u7ed9 Istio Gateway \uff0c\u5176\u4e2d destination \u4e2d\u7684 host \u5b57\u6bb5\u4e3a Istio Service \u914d\u7f6e\u4e2d\u7684\u670d\u52a1\u540d\uff0cEnvoy \u4f1a\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u5c06\u6d41\u91cf\u8def\u7531\u5230 httpbin \u5bf9\u5e94\u7684 Pod IP\uff1a kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - \"httpbin.example.com\" gateways: - httpbin-gateway http: - match: - uri: prefix: /status - uri: prefix: /delay route: - destination: port: number: 8000 host: httpbin EOF \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7 cURL \u8bbf\u95ee\u7279\u5b9a\u7684 URL Path \u5c31\u53ef\u4ee5\u8bbf\u95ee\u8be5\u670d\u52a1\u4e86\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff1a \u9700\u8981\u8bbe\u7f6e host \u4e3a httpbin.example.com \u3002\u56e0\u4e3a\u5728\u524d\u9762\u7684 Gateway \u914d\u7f6e\u4e2d\uff0c\u6211\u4eec\u7ed1\u5b9a\u4e86 host\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 /etc/hosts \u6765\u7ed1\u5b9a\u57df\u540d\u4e3a\u672c\u5730\u5730\u5740\uff1a curl -I -HHost:httpbin.example.com http://127.0.0.1/status/200 HTTP/1.1 200 OK server: istio-envoy date: Mon, 08 Feb 2021 04:42:54 GMT content-type: text/html; charset=utf-8 access-control-allow-origin: * access-control-allow-credentials: true content-length: 0 x-envoy-upstream-service-time: 327 \u5982\u679c\u6ca1\u6709\u5339\u914d\u5230\u8def\u7531\u89c4\u5219\uff0c\u5219\u4f1a\u8fd4\u56de404\uff1a $ curl -I -HHost:httpbin.example.com http://127.0.0.1/1status/200 HTTP/1.1 404 Not Found date: Mon, 08 Feb 2021 04:45:50 GMT server: istio-envoy transfer-encoding: chunked \u901a\u8fc7\u547d\u4ee4\u67e5\u770b Envoy \u65e5\u5fd7\uff0c\u8fd9\u91cc\u7684 httpbin-74fb669cc6-jzs87 \u662f\u901a\u8fc7\u4e0a\u9762 kubectl get pods \u547d\u4ee4\u83b7\u53d6\u5230\u7684 Pod \u540d\u79f0\uff0c\u9700\u8981\u52a0\u4e0a -c container \u7684\u540d\u79f0\u6765\u67e5\u770b Envoy \u7684\u65e5\u5fd7\uff1a kubectl logs httpbin-74fb669cc6-jzs87 -c istio-proxy \u8fd9\u91cc\u6211\u5217\u4e86\u51e0\u6761\u521a\u624d\u8bbf\u95ee\u4ea7\u751f\u7684 Envoy \u65e5\u5fd7\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u6709\u6b63\u786e\u7684 200 \u65e5\u5fd7\u548c\u9519\u8bef\u7684 404 \u65e5\u5fd7\uff1a 2021-02-08T04:29:17.701261Z info Envoy proxy is ready [2021-02-08T04:42:54.644Z] \"HEAD /status/200 HTTP/1.1\" 200 - \"-\" \"-\" 0 0 225 199 \"172.17.0.2\" \"curl/7.54.0\" \"be1d93ab-32b3-9882-8c34-87dd39ddf6ab\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:34580 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default [2021-02-08T04:45:14.862Z] \"HEAD /status2/200 HTTP/1.1\" 404 - \"-\" \"-\" 0 0 351 337 \"172.17.0.2\" \"curl/7.54.0\" \"b433ee7d-6f89-9854-bee7-eeed33884003\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:36896 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default [2021-02-08T04:45:57.688Z] \"HEAD /status/500 HTTP/1.1\" 500 - \"-\" \"-\" 0 0 14 11 \"172.17.0.2\" \"curl/7.54.0\" \"5ca2dbf4-473f-9dd0-97a0-397a98f2805c\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:37604 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default [2021-02-08T04:46:04.233Z] \"HEAD /status/400 HTTP/1.1\" 400 - \"-\" \"-\" 0 0 3 2 \"172.17.0.2\" \"curl/7.54.0\" \"4c6e9a80-74f4-98bb-ba3e-8140a4a16099\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:37722 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default [2021-02-08T04:53:33.695Z] \"HEAD /status/500 HTTP/1.1\" 500 - \"-\" \"-\" 0 0 4 2 \"172.17.0.2\" \"curl/7.54.0\" \"6865f4bf-c407-9fa2-a6e2-f14668a9ba63\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:45104 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default \u6700\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\uff0c\u6e05\u9664 httpbin \u670d\u52a1\u548c\u76f8\u5173\u7684 Istio Gateway \u914d\u7f6e\uff1a $ kubectl delete gateway httpbin-gateway $ kubectl delete virtualservice httpbin $ kubectl delete --ignore-not-found=true -f samples/httpbin/httpbin.yaml Gateway \u7c7b\u578b\u5229\u7528 Envoy \u7684\u5f3a\u5927\u529f\u80fd\uff0c\u53ef\u4ee5\u5b9e\u73b0\u8def\u7531\u5c42\u4e30\u5bcc\u7684\u914d\u7f6e\u3002 \u8fd9\u4e9b\u529f\u80fd\u548c\u7f51\u683c\u5185\u90e8\u63d0\u4f9b\u7684\u529f\u80fd\u3001\u914d\u7f6e\u65b9\u5f0f\u4e00\u6837\uff0c\u5305\u62ec\u7194\u65ad\u3001\u4e30\u5bcc\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3001\u670d\u52a1\u53d1\u73b0\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u4f60\u4e5f\u53ef\u4ee5\u89e3\u51b3 Kubernetes Ingress \u56db\u5c42\u8def\u7531\u7684\u7f3a\u9677\u3002 4\u3001Egress \u51fa\u53e3\u6d41\u91cf Egress \u51fa\u53e3\u6d41\u91cf\u662f\u4e91\u539f\u751f\u5f15\u5165\u7684\u65b0\u7684\u8bbe\u8ba1\u6a21\u5f0f\u548c\u67b6\u6784\uff0c\u5728\u4f20\u7edf\u7684 Web \u67b6\u6784\u4e2d\uff0c\u5f88\u5c11\u6709\u51fa\u53e3\u7f51\u5173\u7684\u6982\u5ff5\u3002 4-1 Kubernetes \u4e2d\u7684 Egress \u76f8\u8f83\u4e8e Kubernetes \u4e2d Ingress \u7684\u5f3a\u5927\u529f\u80fd\uff0cKubernetes \u4e2d\u7684 Egress \u5c31\u663e\u5f97\u6bd4\u8f83\u5f31\u4e86\uff0cKubernetes \u7684 Egress \u5e76\u6ca1\u6709\u5f15\u5165\u50cf Nginx \u8fd9\u6837\u7684\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\uff0c \u53ea\u662f\u5728 IP \u5730\u5740\u6216\u7aef\u53e3\u5c42\u9762\uff08OSI \u7b2c 3 \u5c42\u6216\u7b2c 4 \u5c42\uff09\u63a7\u5236\u7f51\u7edc\u6d41\u91cf \u3002 \u901a\u8fc7 Network Policy \u7684\u8d44\u6e90\uff0c \u53ef\u4ee5\u914d\u7f6e\u5728\u4e09\u5c42\u6216\u8005\u56db\u5c42\u7f51\u7edc\u7684 Ingress \u6216\u8005 Egress \u7b56\u7565 \u3002\u8fd9\u91cc\u7684\u914d\u7f6e\u8bbe\u7f6e\u4e86\u4e00\u4e9b IP \u548c\u7aef\u53e3\u7684\u9ed1\u767d\u540d\u5355\uff1a apiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: test-network-policy namespace: default spec: podSelector: matchLabels: role: db policyTypes: - Ingress - Egress ingress: - from: - ipBlock: cidr: 172.17.0.0/16 except: - 172.17.1.0/24 - namespaceSelector: matchLabels: project: myproject - podSelector: matchLabels: role: frontend ports: - protocol: TCP port: 6379 egress: - to: - ipBlock: cidr: 10.0.0.0/24 ports: - protocol: TCP port: 5978 4-2 Istio Egress Istio Egress \u548c Kubernetes \u4e2d\u7684 Egress \u4e0d\u540c\uff0c Istio\u7684 Egress \u672c\u8d28\u4e0a\u662f\u4e00\u4e2a Envoy Proxy\uff0c\u901a\u8fc7 Envoy \u5f3a\u5927\u7684\u4e03\u5c42\u4ee3\u7406\u529f\u80fd\uff0c\u63d0\u4f9b\u4e30\u5bcc\u7684\u8def\u7531\u7b56\u7565 \uff0c \u800c\u4e0d\u5c40\u9650\u4e8e\u7b80\u5355\u7684\u56db\u5c42\u7f51\u7edc IP \u7aef\u53e3\u9ed1\u767d\u540d\u5355\u7684\u914d\u7f6e\u3002 \u901a\u8fc7\u4e0b\u9762\u7684\u67b6\u6784\u56fe\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a\u670d\u52a1\u7684\u672c\u5730 Proxy \u53ef\u4ee5\u901a\u8fc7\u8fde\u63a5\u5230 Egress Gateway \u8bbf\u95ee\u5916\u90e8\u670d\u52a1\uff0c\u8fbe\u5230\u7cbe\u51c6\u7684\u5b89\u5168\u7b56\u7565\u63a7\u5236\u3002 \u9996\u5148\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1 Sleep\uff1a $ kubectl apply -f samples/sleep/sleep.yaml $ kubectl get all | grep sleep pod/sleep-557747455f-w95vv 2/2 Running 0 58s service/sleep ClusterIP 10.100.21.83 <none> 80/TCP 58s deployment.apps/sleep 1/1 1 1 58s replicaset.apps/sleep-557747455f 1 1 1 58s \u8bbe\u7f6e Pod \u7684\u73af\u5883\u53d8\u91cf\uff1a export SOURCE_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name}) $ kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name} sleep-557747455f-w95vv export SOURCE_POD=sleep-557747455f-w95vv \u5728\u8bbe\u7f6e\u7b56\u7565\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u5c1d\u8bd5\u4ece Pod \u5185\u90e8\u8bbf\u95ee\u5916\u90e8\u670d\u52a1\uff1a kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://www.douban.com | grep \"HTTP/\"; kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://edition.cnn.com | grep \"HTTP/\" \u53ef\u4ee5\u5f97\u5230\u4ee5\u4e0b\u7ed3\u679c\uff0c\u8868\u660e\u8bbf\u95ee\u5916\u90e8\u6b63\u5e38\uff1a HTTP/1.1 200 OK HTTP/2 200 $ kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://www.douban.com | grep \"HTTP/\"; HTTP/1.1 200 OK \u901a\u8fc7\u4e0b\u8ff0\u547d\u4ee4\uff0c\u67e5\u770b Istio Egress Gateway \u662f\u5426\u90e8\u7f72\uff1a $ kubectl get pod -l istio=egressgateway -n istio-system NAME READY STATUS RESTARTS AGE istio-egressgateway-5547fcc8fc-flqkt 1/1 Running 2 13d \u521b\u5efa\u4e00\u4e2a ServiceEntry\uff0c\u5141\u8bb8\u6d41\u91cf\u76f4\u63a5\u8bbf\u95ee\u4e00\u4e2a\u5916\u90e8\u670d\u52a1 kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: cnn spec: hosts: - edition.cnn.com ports: - number: 80 name: http-port protocol: HTTP - number: 443 name: https protocol: HTTPS resolution: DNS EOF \u4e3a edition.cnn.com \u7aef\u53e3 80 \u521b\u5efa Egress Gateway \uff0c\u5e76\u4e3a\u6307\u5411 Egress Gateway \u7684\u6d41\u91cf\u521b\u5efa\u4e00\u4e2a Destination Rule \uff1a $ kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: istio-egressgateway spec: selector: istio: egressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - edition.cnn.com --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: egressgateway-for-cnn spec: host: istio-egressgateway.istio-system.svc.cluster.local subsets: - name: cnn EOF \u5b9a\u4e49\u4e00\u4e2a VirtualService\uff0c\u5c06\u6d41\u91cf\u4ece Sidecar \u5f15\u5bfc\u81f3 Egress Gateway\uff0c\u518d\u4ece Egress Gateway \u5f15\u5bfc\u81f3\u5916\u90e8\u670d\u52a1 \uff1a $ kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: direct-cnn-through-egress-gateway spec: hosts: - edition.cnn.com gateways: - istio-egressgateway - mesh http: - match: - gateways: - mesh port: 80 route: - destination: host: istio-egressgateway.istio-system.svc.cluster.local subset: cnn port: number: 80 weight: 100 - match: - gateways: - istio-egressgateway port: 80 route: - destination: host: edition.cnn.com port: number: 80 weight: 100 EOF \u67e5\u770b istio-egressgateway \u65e5\u5fd7\uff1a kubectl logs -l istio=egressgateway -c istio-proxy -n istio-system | tail \u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u65e5\u5fd7\uff0c\u8868\u660e\u6d41\u91cf\u7ecf\u8fc7\u4e86 Egress Gateway\uff1a [2021-02-08T06:02:46.098Z] \"GET /politics HTTP/2\" 301 - \"-\" \"-\" 0 0 162 147 \"172.18.0.17\" \"curl/7.69.1\" \"57d13492-b521-961b-bd93-90ab3f0e295e\" \"edition.cnn.com\" \"151.101.129.67:80\" outbound|80||edition.cnn.com 172.18.0.4:41758 172.18.0.4:8080 172.18.0.17:32816 - - \u6e05\u9664\u670d\u52a1\u76f8\u5173\u914d\u7f6e\uff1a $ kubectl delete gateway istio-egressgateway $ kubectl delete serviceentry cnn $ kubectl delete virtualservice direct-cnn-through-egress-gateway $ kubectl delete destinationrule egressgateway-for-cnn \u81f3\u6b64\uff0cIstio Egress Gateway \u5c31\u914d\u7f6e\u5b8c\u6210\u4e86\uff0c\u901a\u8fc7\u8fd9\u90e8\u5206\u7684\u5b66\u4e60\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Istio Egress Gateway \u7684\u5f3a\u5927\u914d\u7f6e\uff0c \u901a\u8fc7 Egress Gateway \u6211\u4eec\u53ef\u4ee5\u5bf9\u5916\u90e8\u6d41\u91cf\u8fdb\u884c\u6743\u9650\u63a7\u5236\u548c\u7cbe\u51c6\u7684\u8def\u7531\u5339\u914d\u8bbf\u95ee \u3002 \u5728\u5b9e\u9645\u5de5\u4f5c\u7684\u9879\u76ee\u4e2d\uff0c\u6211\u501f\u9274\u4e86 Istio Egress Gateway \u7684\u601d\u60f3\uff0c\u5c06\u6240\u6709\u5916\u90e8\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u8bbf\u95ee\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230 Egress Gateway\uff0c\u7ecf\u7531 Egress Gateway \u8bbf\u95ee\u51fa\u53bb\uff0c\u901a\u8fc7\u8fd9\u6837\u7684\u65b9\u5f0f\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u7684\u5ef6\u65f6\uff0c\u7ef4\u6301 HTTP \u7684 KeepAlive \u957f\u8fde\u63a5\u3002 \u56e0\u4e3a\u5982\u679c\u670d\u52a1\u7684\u673a\u5668\u6570\u91cf\u8fc7\u591a\uff0c\u8bbf\u95ee\u5916\u90e8\u9891\u7387\u53c8\u4e0d\u662f\u5f88\u9ad8\uff0c\u4e0e\u5916\u90e8\u670d\u52a1\u7684\u8fde\u63a5\u5c31\u5f88\u5bb9\u6613\u65ad\u6389\uff0c\u4e0d\u5f97\u4e0d\u91cd\u65b0\u5efa\u8fde\uff0c\u800c\u73b0\u5728\u5927\u591a\u6570\u5916\u90e8\u670d\u52a1\u90fd\u662f HTTPS \u7684\uff0c\u9700\u8981\u6d88\u8017\u8fc7\u591a\u7684 SSL \u63e1\u624b\u65f6\u95f4\u3002","title":"\u7b2c\u4e94\u8282 Ingress \u548c Egress\uff1a\u5165\u53e3\u6d41\u91cf\u548c\u51fa\u53e3\u6d41\u91cf\u63a7\u5236"},{"location":"chap2/5chap3_ingress_egress/#ingress-egress","text":"Ingress \u662f Kubernetes \u96c6\u7fa4\u4e3a\u4e86\u8ba9\u5916\u90e8\u53ef\u4ee5\u8bbf\u95ee\uff0c\u5f15\u5165\u7684\u4e00\u79cd\u8d44\u6e90\u7c7b\u578b\u3002 \u4e00\u822c Ingress \u4e3a\u5e38\u89c1\u7684 Nginx \u8fd9\u6837\u7684\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\u63d0\u4f9b\u5177\u4f53\u529f\u80fd\uff0c\u8bf8\u5982\u8d1f\u8f7d\u5747\u8861\u3001SSL \u8bc1\u4e66\u5378\u8f7d\uff0c\u4ee5\u53ca\u57fa\u4e8e\u540d\u79f0\u7684\u865a\u62df\u4e3b\u673a\u529f\u80fd\u3002\u8fd9\u4e9b\u529f\u80fd\u662f\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\u7684\u57fa\u672c\u529f\u80fd\uff0c Ingress \u53ef\u4ee5\u7406\u89e3\u4e3a\u5165\u53e3\u7f51\u5173 \uff0c\u800c Egress \u548c Ingress \u7684\u529f\u80fd\u76f8\u4eff\uff0c\u53ea\u662f\u6d41\u91cf\u7684\u4ee3\u7406\u6d41\u5411\u4e0d\u540c\uff0c Egress \u8d1f\u8d23\u51fa\u53e3\u6d41\u91cf\u7684\u4ee3\u7406 \u3002","title":"\u7b2c\u4e94\u8282 Ingress \u548c Egress\uff1a\u5165\u53e3\u6d41\u91cf\u548c\u51fa\u53e3\u6d41\u91cf\u63a7\u5236"},{"location":"chap2/5chap3_ingress_egress/#1-ingress","text":"\u4e00\u822c\u6765\u8bf4\u6709\u4e24\u79cd\u5e38\u7528\u7684\u65b9\u5f0f\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u5185\u90e8\u7684\u7f51\u7edc\uff0c\u5206\u522b\u662fNodePort \u6a21\u5f0f\u548c Ingress \u6a21\u5f0f\u3002","title":"1\u3001\u4e3a\u4ec0\u4e48\u9700\u8981 Ingress"},{"location":"chap2/5chap3_ingress_egress/#1-1-nodeport","text":"\u5728 Kubernetes \u96c6\u7fa4\u5185\u90e8\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Service \u7684\u57df\u540d\u8bbf\u95ee\u670d\u52a1\u7684 Pod\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684 YAML \u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u53ef\u4ee5\u8ba9\u96c6\u7fa4\u5916\u90e8\u901a\u8fc7 NodePort \u7684\u65b9\u5f0f\u8bbf\u95ee\u96c6\u7fa4\u5185\u90e8\u7684\u8d44\u6e90\uff1a apiVersion: v1 kind: Service metadata: name: my-service spec: type: NodePort selector: app: MyApp ports: # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c`targetPort` \u88ab\u8bbe\u7f6e\u4e3a\u4e0e `port` \u5b57\u6bb5\u76f8\u540c\u7684\u503c - port: 80 targetPort: 80 # \u53ef\u9009\u5b57\u6bb5 # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0cKubernetes \u63a7\u5236\u5e73\u9762\u4f1a\u4ece\u67d0\u4e2a\u8303\u56f4\u5185\u5206\u914d\u4e00\u4e2a\u7aef\u53e3\u53f7\uff08\u9ed8\u8ba4\uff1a30000-32767\uff09 nodePort: 30007 NodePort \u7684\u9ed8\u8ba4\u7aef\u53e3\u8303\u56f4\u662f 30000-32767\uff0c\u4f46\u662f\u4e00\u822c\u4e0d\u5efa\u8bae\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u8fd9\u4e2a\u7aef\u53e3\u8303\u56f4\uff0c\u4ee5\u514d\u5f15\u53d1\u51b2\u7a81\u3002 \u5982\u4e0a\u793a\u4f8b\uff0c\u96c6\u7fa4\u5916\u90e8\u9996\u5148\u8bbf\u95ee NodePort \u7684\u7aef\u53e3\uff0c\u793a\u4f8b\u4e2d\u7aef\u53e3\u4e3a 30007\uff0c\u901a\u8fc7 IPVS \u4e00\u7cfb\u5217\u7684\u52ab\u6301\u8def\u7531\u64cd\u4f5c\uff0c\u5c06\u6d41\u91cf\u8def\u7531\u5230\u96c6\u7fa4\u5185\u90e8\u7684 my-service \u670d\u52a1\u7684\u7aef\u53e3 80\uff0c\u8fd9\u4e2a\u7aef\u53e3\u662f ClusterIP \u66b4\u9732\u51fa\u6765\u7684\u7aef\u53e3\uff0c\u5728 Kubernetes \u96c6\u7fa4\u5185\u90e8\u53ef\u4ee5\u901a\u8fc7 ClusterIP:Port \u7684\u65b9\u5f0f\u8bbf\u95ee my-service \u670d\u52a1\u3002 Kubernetes \u96c6\u7fa4\u5185\u90e8\u4f1a\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u670d\u52a1\u5bf9\u5e94\u7684 Pod IP \u7684 TargetPort \u4e0a\u9762\u3002 \u901a\u8fc7\u51e0\u53f0\u7279\u5b9a\u7684 Node \u673a\u5668\u505a\u6570\u636e\u8f6c\u53d1\uff0c\u4e00\u65e6\u6d41\u91cf\u589e\u52a0\uff0c\u53ef\u80fd\u4f1a\u5f71\u54cd\u8be5\u673a\u5668\u5bbf\u4e3b\u673a\u7684\u7a33\u5b9a\u6027\u3002\u5982\u679c\u96c6\u7fa4\u5bf9\u5916\u66b4\u9732\u591a\u4e2a\u670d\u52a1\uff0c\u7ef4\u62a4\u7684\u96be\u5ea6\u4e5f\u968f\u4e4b\u589e\u52a0\uff0c\u4e0a\u9762\u63d0\u5230\u7684\u6269\u7f29\u5bb9\u95ee\u9898\uff0c\u4f1a\u88ab\u6570\u500d\u653e\u5927\uff1a \u4e00\u53f0 Node \u673a\u5668\u7684\u53d8\u52a8\uff0c\u9700\u8981\u4fee\u6539\u5927\u91cf\u7684\u5165\u53e3\u670d\u52a1\u914d\u7f6e\u3002","title":"1-1 NodePort \u6a21\u5f0f"},{"location":"chap2/5chap3_ingress_egress/#1-2-ingress","text":"\u5ba2\u6237\u7aef\u901a\u8fc7 Ingress \u4e0a\u5b9a\u4e49\u7684\u8def\u7531\u89c4\u5219\uff0c\u8f6c\u53d1\u5230\u7279\u5b9a\u7684 Service \u4e0a\u9762\uff0c\u6bd4\u5982\u901a\u8fc7\u8bbe\u7f6e path\u3001header\u3001host \u7b49\u8def\u7531\u89c4\u5219\u6765\u51b3\u5b9a\u5177\u4f53\u8f6c\u53d1\u5230\u54ea\u4e2a Service\u3002 \u901a\u8fc7\u4e0b\u9762\u7684\u914d\u7f6e\u4f60\u53ef\u4ee5\u770b\u5230\uff0cIngress \u662f\u4e00\u79cd\u5168\u65b0\u7684\u8d44\u6e90\u7c7b\u578b\uff0c\u4e0e\u6240\u6709\u5176\u4ed6 Kubernetes \u8d44\u6e90\u4e00\u6837\uff0cIngress \u9700\u8981\u4f7f\u7528 apiVersion\u3001kind \u548c metadata \u5b57\u6bb5\u3002 apiVersion: networking.Kubernetes.io/v1 kind: Ingress metadata: name: minimal-ingress annotations: nginx.ingress.kubernetes.io/rewrite-target: / spec: rules: - http: paths: - path: /testpath pathType: Prefix backend: service: name: test port: number: 80 \u6211\u4eec\u6765\u770b\u4e00\u4e0b\uff0c Ingress \u8d44\u6e90\u7c7b\u578b\u7279\u6709\u7684\u51e0\u4e2a\u5b57\u6bb5\u7684\u542b\u4e49\u3002 host \uff1a\u53ef\u9009\u62e9\u548c\u57df\u540d\u5339\u914d\u7684 host\uff0c\u6bd4\u5982\u5982\u679c\u8bbe\u7f6e host \u5b57\u6bb5 foo.bar.com \uff0c\u5219\u9700\u8981\u901a\u8fc7 foo.bar.com \u7684\u57df\u540d\u8bbf\u95ee\u3002\u5982\u679c\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u6ca1\u6709\u8bbe\u7f6e host \u5b57\u6bb5\uff0c\u5219\u8868\u660e\u4efb\u4f55\u57df\u540d\u8fc7\u6765\u7684\u8bf7\u6c42\u90fd\u53ef\u4ee5\u5339\u914d\u3002 http.paths.path \uff1a\u7528\u4e8e\u8bf7\u6c42 path \u7684\u5339\u914d\uff0c\u6bd4\u5982\u8fd9\u4e2a\u4f8b\u5b50\u901a\u8fc7 pathType:Prefix \u524d\u7f00\u5339\u914d\u7684\u65b9\u5f0f\uff0c\u6240\u6709 path \u4e2d\u524d\u7f00\u4e3a /testpath \u7684\u8def\u5f84\uff0c\u90fd\u4f1a\u88ab\u5339\u914d\u5230\uff1b\u800c\u5176\u4ed6\u6ca1\u6709\u5339\u914d\u5230\u7684 path \u5c31\u4f1a\u8fd4\u56de 404\u3002 http.paths.backend \uff1a\u5176\u4e2d name \u5b57\u6bb5\u8868\u793a\u670d\u52a1\u540d\uff0c\u8fd9\u4e2a\u670d\u52a1\u540d\u548c Kubernetes \u4e2d\u7684Service \u540d\u79f0\u76f8\u5339\u914d\uff1bport \u5219\u662f Service \u7684\u7aef\u53e3\u53f7\uff0c\u6d41\u91cf\u4f1a\u901a\u8fc7 clusterIP:port \u7684\u65b9\u5f0f\u88ab\u8f6c\u53d1\u5230\u7279\u5b9a\u670d\u52a1\u3002","title":"1-2 Ingress \u6a21\u5f0f"},{"location":"chap2/5chap3_ingress_egress/#2ingressclass","text":"\u5728 Kubernetes1.18 \u7248\u672c\u4e4b\u524d\uff0cIngressClass \u662f\u901a\u8fc7 Ingress \u4e2d\u7684\u4e00\u4e2a kubernetes.io/ingress.class \u6ce8\u89e3\u6765\u6307\u5b9a\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4ece 1.18 \u5f00\u59cb\u5982\u4f55\u914d\u7f6e Ingress Class\u3002 \u901a\u8fc7\u5728 Ingress \u8d44\u6e90\u7c7b\u578b\u4e2d\u8bbe\u7f6e IngressClassName \u6765\u6307\u5b9a\u7279\u5b9a\u7684 IngressClass \u914d\u7f6e\uff0c IngressClass \u7684\u914d\u7f6e\u5982\u4e0b\uff0c\u5176\u4e2d\u5305\u542b\u4e86 ingress-controller \u7684\u540d\u79f0 \uff0c \u5728\u8fd9\u91cc ingress-controller \u540d\u79f0\u4e3a example.com/ingress-controller \uff1a apiVersion: networking.k8s.io/v1 kind: IngressClass metadata: name: external-lb spec: controller: example.com/ingress-controller parameters: apiGroup: k8s.example.com kind: IngressParameters name: external-lb","title":"2\u3001IngressClass \u8d44\u6e90\u7c7b\u578b"},{"location":"chap2/5chap3_ingress_egress/#2-1-ingress-controller","text":"ingress-controller \u5e76\u4e0d\u662f\u968f\u7740 Kubernetes \u96c6\u7fa4\u4e00\u8d77\u542f\u52a8\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u5982\u4f55\u5728 Minukube \u73af\u5883\u4e2d\u4f7f\u7528 Nginx ingress-controller\u3002 \u542f\u52a8 Minukube \u96c6\u7fa4\uff0c\u9700\u8981\u5148\u5220\u9664\u5df2\u6709\u7684 Minukube \u96c6\u7fa4\uff1a minikube delete \u7136\u540e\u901a\u8fc7\u865a\u62df\u673a\u65b9\u5f0f\u542f\u52a8\uff0c\u56e0\u4e3a Ingress \u7684 Addon \u65e0\u6cd5\u5728 Docker \u6a21\u5f0f\u4f7f\u7528\uff1a minikube start --kubernetes-version=v1.19.2 --vm=true \u542f\u52a8 ingress-controller \uff1a minikube addons enable ingress \u90e8\u7f72 helloapp\uff1a kubectl create deployment web --image=gcr.io/google-samples/hello-app:1.0 \u521b\u5efa Ingress \u8d44\u6e90\uff1a kubectl apply -f https://k8s.io/examples/service/networking/example-ingress.yaml \u901a\u8fc7 minikube iP \u547d\u4ee4\u83b7\u53d6 Ip \u5730\u5740\uff0c\u5e76\u4fee\u6539 /etc/hosts \uff0c\u5c06\u5176\u6dfb\u52a0\u5728\u6587\u4ef6\u7ed3\u5c3e\uff0c\u4ee3\u7801\u4e2d 127.0.0.1 \u5c31\u662f minikube ip \u83b7\u53d6\u7684 IP\uff1a 127.0.0.1 hello-world.info \u901a\u8fc7 cURL \u6216\u8005\u6d4f\u89c8\u5668\u8bbf\u95ee hello-world.info\uff1a curl hello-world.info \u81f3\u6b64\uff0cKubernetes \u539f\u751f\u7684 Ingress \u5c31\u8bb2\u5b8c\u4e86\u3002 Ingress \u89e3\u51b3\u4e86 NodePod \u914d\u7f6e\u4e0d\u65b9\u4fbf\u7684\u95ee\u9898\uff0c\u4f46\u901a\u8fc7 YAML \u7684\u65b9\u5f0f\u63a7\u5236 Ingress \u4f9d\u7136\u662f\u4e00\u4ef6\u9ebb\u70e6\u4e8b\uff0c\u53e6\u5916 Ingress \u5185\u90e8\u4f9d\u7136\u662f\u4f7f\u7528 ClusterIP \u7684\u65b9\u5f0f\u6765\u8bbf\u95ee Service\uff0c\u800c\u8fd9\u6837\u7684\u65b9\u5f0f\u662f\u901a\u8fc7 IPVS \u56db\u5c42\u8f6c\u53d1\u505a\u5230\u7684\u3002","title":"2-1 ingress-controller"},{"location":"chap2/5chap3_ingress_egress/#3istio-gateway","text":"Istio \u91c7\u7528\u4e86\u4e00\u79cd\u65b0\u7684\u6a21\u578b\u2014\u2014Istio Gateway \u6765\u4ee3\u66ff Kubernetes \u4e2d\u7684 Ingress \u8d44\u6e90\u7c7b\u578b\u3002 Gateway \u5141\u8bb8\u5916\u90e8\u6d41\u91cf\u8bbf\u95ee\u5185\u90e8\u670d\u52a1 \uff0c\u5f97\u76ca\u4e8e Istio \u5f3a\u5927\u7684\u63a7\u5236\u9762\u914d\u7f6e\uff0cGateway \u8d44\u6e90\u7c7b\u578b\u7684\u914d\u7f6e\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u6d41\u91cf\u8f6c\u53d1\u5373\u53ef\u3002 minikube delete minikube start --kubernetes-version=v1.19.2 --driver=docker minikube tunnel \u8fd9\u6837\u5916\u90e8\u5c31\u53ef\u4ee5\u901a\u8fc7 Minikube IP \u8bbf\u95ee\u96c6\u7fa4\u5185\u90e8\u7684\u8d44\u6e90\u4e86\u3002 \u4e0b\u9762\u8fdb\u5165 Istio \u76ee\u5f55\uff0c\u90e8\u7f72\u4e00\u4e2a\u6d4b\u8bd5\u670d\u52a1\uff1a kubectl apply -f samples/httpbin/httpbin.yaml \u901a\u8fc7\u547d\u4ee4\u67e5\u770b Pod \u662f\u5426\u6210\u529f\u542f\u52a8\uff0c\u6839\u636e\u673a\u5668\u914d\u7f6e\u4e0d\u540c\uff0c\u8fd9\u91cc\u7684 Pod \u542f\u52a8\u53ef\u80fd\u9700\u8981\u4e00\u5b9a\u7684\u65f6\u95f4\uff0c\u8bf7\u8010\u5fc3\u7b49\u5f85 pod \u542f\u52a8\u6210\u529f\uff1a $ kubectl get pods NAME READY STATUS RESTARTS AGE details-v1-79c697d759-gt9th 2/2 Running 7 95d httpbin-74fb669cc6-jzs87 0/2 Init:0/1 0 7s productpage-v1-65576bb7bf-wjkjm 2/2 Running 7 95d ratings-v1-7d99676f7f-h9blt 2/2 Running 6 95d reviews-v1-987d495c-pmnb9 2/2 Running 7 95d reviews-v2-6c5bf657cf-qd2kr 2/2 Running 7 95d reviews-v3-5f7b9f4f77-gnv4c 2/2 Running 7 95d \u521b\u5efa Istio Gateway\uff0c\u6ce8\u610f\uff1a \u8fd9\u91cc\u8bbe\u7f6e\u4e86 hosts \u4e3a httpbin.example.com \uff0c\u4e5f\u5c31\u662f\u53ea\u6709 host \u4e3a httpbin.example.com \u624d\u80fd\u6b63\u786e\u8bbf\u95ee httpbin \u7684\u670d\u52a1 \uff1a kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: httpbin-gateway spec: selector: istio: ingressgateway # use Istio default gateway implementation servers: - port: number: 80 name: http protocol: HTTP hosts: - \"httpbin.example.com\" EOF \u5c06 httpbin \u670d\u52a1\u66b4\u9732\u7ed9 Istio Gateway \uff0c\u5176\u4e2d destination \u4e2d\u7684 host \u5b57\u6bb5\u4e3a Istio Service \u914d\u7f6e\u4e2d\u7684\u670d\u52a1\u540d\uff0cEnvoy \u4f1a\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u5c06\u6d41\u91cf\u8def\u7531\u5230 httpbin \u5bf9\u5e94\u7684 Pod IP\uff1a kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - \"httpbin.example.com\" gateways: - httpbin-gateway http: - match: - uri: prefix: /status - uri: prefix: /delay route: - destination: port: number: 8000 host: httpbin EOF \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7 cURL \u8bbf\u95ee\u7279\u5b9a\u7684 URL Path \u5c31\u53ef\u4ee5\u8bbf\u95ee\u8be5\u670d\u52a1\u4e86\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff1a \u9700\u8981\u8bbe\u7f6e host \u4e3a httpbin.example.com \u3002\u56e0\u4e3a\u5728\u524d\u9762\u7684 Gateway \u914d\u7f6e\u4e2d\uff0c\u6211\u4eec\u7ed1\u5b9a\u4e86 host\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 /etc/hosts \u6765\u7ed1\u5b9a\u57df\u540d\u4e3a\u672c\u5730\u5730\u5740\uff1a curl -I -HHost:httpbin.example.com http://127.0.0.1/status/200 HTTP/1.1 200 OK server: istio-envoy date: Mon, 08 Feb 2021 04:42:54 GMT content-type: text/html; charset=utf-8 access-control-allow-origin: * access-control-allow-credentials: true content-length: 0 x-envoy-upstream-service-time: 327 \u5982\u679c\u6ca1\u6709\u5339\u914d\u5230\u8def\u7531\u89c4\u5219\uff0c\u5219\u4f1a\u8fd4\u56de404\uff1a $ curl -I -HHost:httpbin.example.com http://127.0.0.1/1status/200 HTTP/1.1 404 Not Found date: Mon, 08 Feb 2021 04:45:50 GMT server: istio-envoy transfer-encoding: chunked \u901a\u8fc7\u547d\u4ee4\u67e5\u770b Envoy \u65e5\u5fd7\uff0c\u8fd9\u91cc\u7684 httpbin-74fb669cc6-jzs87 \u662f\u901a\u8fc7\u4e0a\u9762 kubectl get pods \u547d\u4ee4\u83b7\u53d6\u5230\u7684 Pod \u540d\u79f0\uff0c\u9700\u8981\u52a0\u4e0a -c container \u7684\u540d\u79f0\u6765\u67e5\u770b Envoy \u7684\u65e5\u5fd7\uff1a kubectl logs httpbin-74fb669cc6-jzs87 -c istio-proxy \u8fd9\u91cc\u6211\u5217\u4e86\u51e0\u6761\u521a\u624d\u8bbf\u95ee\u4ea7\u751f\u7684 Envoy \u65e5\u5fd7\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u6709\u6b63\u786e\u7684 200 \u65e5\u5fd7\u548c\u9519\u8bef\u7684 404 \u65e5\u5fd7\uff1a 2021-02-08T04:29:17.701261Z info Envoy proxy is ready [2021-02-08T04:42:54.644Z] \"HEAD /status/200 HTTP/1.1\" 200 - \"-\" \"-\" 0 0 225 199 \"172.17.0.2\" \"curl/7.54.0\" \"be1d93ab-32b3-9882-8c34-87dd39ddf6ab\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:34580 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default [2021-02-08T04:45:14.862Z] \"HEAD /status2/200 HTTP/1.1\" 404 - \"-\" \"-\" 0 0 351 337 \"172.17.0.2\" \"curl/7.54.0\" \"b433ee7d-6f89-9854-bee7-eeed33884003\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:36896 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default [2021-02-08T04:45:57.688Z] \"HEAD /status/500 HTTP/1.1\" 500 - \"-\" \"-\" 0 0 14 11 \"172.17.0.2\" \"curl/7.54.0\" \"5ca2dbf4-473f-9dd0-97a0-397a98f2805c\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:37604 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default [2021-02-08T04:46:04.233Z] \"HEAD /status/400 HTTP/1.1\" 400 - \"-\" \"-\" 0 0 3 2 \"172.17.0.2\" \"curl/7.54.0\" \"4c6e9a80-74f4-98bb-ba3e-8140a4a16099\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:37722 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default [2021-02-08T04:53:33.695Z] \"HEAD /status/500 HTTP/1.1\" 500 - \"-\" \"-\" 0 0 4 2 \"172.17.0.2\" \"curl/7.54.0\" \"6865f4bf-c407-9fa2-a6e2-f14668a9ba63\" \"httpbin.example.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local 127.0.0.1:45104 172.18.0.16:80 172.17.0.2:0 outbound_.8000_._.httpbin.default.svc.cluster.local default \u6700\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\uff0c\u6e05\u9664 httpbin \u670d\u52a1\u548c\u76f8\u5173\u7684 Istio Gateway \u914d\u7f6e\uff1a $ kubectl delete gateway httpbin-gateway $ kubectl delete virtualservice httpbin $ kubectl delete --ignore-not-found=true -f samples/httpbin/httpbin.yaml Gateway \u7c7b\u578b\u5229\u7528 Envoy \u7684\u5f3a\u5927\u529f\u80fd\uff0c\u53ef\u4ee5\u5b9e\u73b0\u8def\u7531\u5c42\u4e30\u5bcc\u7684\u914d\u7f6e\u3002 \u8fd9\u4e9b\u529f\u80fd\u548c\u7f51\u683c\u5185\u90e8\u63d0\u4f9b\u7684\u529f\u80fd\u3001\u914d\u7f6e\u65b9\u5f0f\u4e00\u6837\uff0c\u5305\u62ec\u7194\u65ad\u3001\u4e30\u5bcc\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3001\u670d\u52a1\u53d1\u73b0\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\uff0c\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u4f60\u4e5f\u53ef\u4ee5\u89e3\u51b3 Kubernetes Ingress \u56db\u5c42\u8def\u7531\u7684\u7f3a\u9677\u3002","title":"3\u3001Istio Gateway"},{"location":"chap2/5chap3_ingress_egress/#4egress","text":"Egress \u51fa\u53e3\u6d41\u91cf\u662f\u4e91\u539f\u751f\u5f15\u5165\u7684\u65b0\u7684\u8bbe\u8ba1\u6a21\u5f0f\u548c\u67b6\u6784\uff0c\u5728\u4f20\u7edf\u7684 Web \u67b6\u6784\u4e2d\uff0c\u5f88\u5c11\u6709\u51fa\u53e3\u7f51\u5173\u7684\u6982\u5ff5\u3002","title":"4\u3001Egress \u51fa\u53e3\u6d41\u91cf"},{"location":"chap2/5chap3_ingress_egress/#4-1-kubernetes-egress","text":"\u76f8\u8f83\u4e8e Kubernetes \u4e2d Ingress \u7684\u5f3a\u5927\u529f\u80fd\uff0cKubernetes \u4e2d\u7684 Egress \u5c31\u663e\u5f97\u6bd4\u8f83\u5f31\u4e86\uff0cKubernetes \u7684 Egress \u5e76\u6ca1\u6709\u5f15\u5165\u50cf Nginx \u8fd9\u6837\u7684\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u5668\uff0c \u53ea\u662f\u5728 IP \u5730\u5740\u6216\u7aef\u53e3\u5c42\u9762\uff08OSI \u7b2c 3 \u5c42\u6216\u7b2c 4 \u5c42\uff09\u63a7\u5236\u7f51\u7edc\u6d41\u91cf \u3002 \u901a\u8fc7 Network Policy \u7684\u8d44\u6e90\uff0c \u53ef\u4ee5\u914d\u7f6e\u5728\u4e09\u5c42\u6216\u8005\u56db\u5c42\u7f51\u7edc\u7684 Ingress \u6216\u8005 Egress \u7b56\u7565 \u3002\u8fd9\u91cc\u7684\u914d\u7f6e\u8bbe\u7f6e\u4e86\u4e00\u4e9b IP \u548c\u7aef\u53e3\u7684\u9ed1\u767d\u540d\u5355\uff1a apiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: test-network-policy namespace: default spec: podSelector: matchLabels: role: db policyTypes: - Ingress - Egress ingress: - from: - ipBlock: cidr: 172.17.0.0/16 except: - 172.17.1.0/24 - namespaceSelector: matchLabels: project: myproject - podSelector: matchLabels: role: frontend ports: - protocol: TCP port: 6379 egress: - to: - ipBlock: cidr: 10.0.0.0/24 ports: - protocol: TCP port: 5978","title":"4-1 Kubernetes \u4e2d\u7684 Egress"},{"location":"chap2/5chap3_ingress_egress/#4-2-istio-egress","text":"Istio Egress \u548c Kubernetes \u4e2d\u7684 Egress \u4e0d\u540c\uff0c Istio\u7684 Egress \u672c\u8d28\u4e0a\u662f\u4e00\u4e2a Envoy Proxy\uff0c\u901a\u8fc7 Envoy \u5f3a\u5927\u7684\u4e03\u5c42\u4ee3\u7406\u529f\u80fd\uff0c\u63d0\u4f9b\u4e30\u5bcc\u7684\u8def\u7531\u7b56\u7565 \uff0c \u800c\u4e0d\u5c40\u9650\u4e8e\u7b80\u5355\u7684\u56db\u5c42\u7f51\u7edc IP \u7aef\u53e3\u9ed1\u767d\u540d\u5355\u7684\u914d\u7f6e\u3002 \u901a\u8fc7\u4e0b\u9762\u7684\u67b6\u6784\u56fe\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a\u670d\u52a1\u7684\u672c\u5730 Proxy \u53ef\u4ee5\u901a\u8fc7\u8fde\u63a5\u5230 Egress Gateway \u8bbf\u95ee\u5916\u90e8\u670d\u52a1\uff0c\u8fbe\u5230\u7cbe\u51c6\u7684\u5b89\u5168\u7b56\u7565\u63a7\u5236\u3002 \u9996\u5148\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1 Sleep\uff1a $ kubectl apply -f samples/sleep/sleep.yaml $ kubectl get all | grep sleep pod/sleep-557747455f-w95vv 2/2 Running 0 58s service/sleep ClusterIP 10.100.21.83 <none> 80/TCP 58s deployment.apps/sleep 1/1 1 1 58s replicaset.apps/sleep-557747455f 1 1 1 58s \u8bbe\u7f6e Pod \u7684\u73af\u5883\u53d8\u91cf\uff1a export SOURCE_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name}) $ kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name} sleep-557747455f-w95vv export SOURCE_POD=sleep-557747455f-w95vv \u5728\u8bbe\u7f6e\u7b56\u7565\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u5c1d\u8bd5\u4ece Pod \u5185\u90e8\u8bbf\u95ee\u5916\u90e8\u670d\u52a1\uff1a kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://www.douban.com | grep \"HTTP/\"; kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://edition.cnn.com | grep \"HTTP/\" \u53ef\u4ee5\u5f97\u5230\u4ee5\u4e0b\u7ed3\u679c\uff0c\u8868\u660e\u8bbf\u95ee\u5916\u90e8\u6b63\u5e38\uff1a HTTP/1.1 200 OK HTTP/2 200 $ kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://www.douban.com | grep \"HTTP/\"; HTTP/1.1 200 OK \u901a\u8fc7\u4e0b\u8ff0\u547d\u4ee4\uff0c\u67e5\u770b Istio Egress Gateway \u662f\u5426\u90e8\u7f72\uff1a $ kubectl get pod -l istio=egressgateway -n istio-system NAME READY STATUS RESTARTS AGE istio-egressgateway-5547fcc8fc-flqkt 1/1 Running 2 13d \u521b\u5efa\u4e00\u4e2a ServiceEntry\uff0c\u5141\u8bb8\u6d41\u91cf\u76f4\u63a5\u8bbf\u95ee\u4e00\u4e2a\u5916\u90e8\u670d\u52a1 kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: cnn spec: hosts: - edition.cnn.com ports: - number: 80 name: http-port protocol: HTTP - number: 443 name: https protocol: HTTPS resolution: DNS EOF \u4e3a edition.cnn.com \u7aef\u53e3 80 \u521b\u5efa Egress Gateway \uff0c\u5e76\u4e3a\u6307\u5411 Egress Gateway \u7684\u6d41\u91cf\u521b\u5efa\u4e00\u4e2a Destination Rule \uff1a $ kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: istio-egressgateway spec: selector: istio: egressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - edition.cnn.com --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: egressgateway-for-cnn spec: host: istio-egressgateway.istio-system.svc.cluster.local subsets: - name: cnn EOF \u5b9a\u4e49\u4e00\u4e2a VirtualService\uff0c\u5c06\u6d41\u91cf\u4ece Sidecar \u5f15\u5bfc\u81f3 Egress Gateway\uff0c\u518d\u4ece Egress Gateway \u5f15\u5bfc\u81f3\u5916\u90e8\u670d\u52a1 \uff1a $ kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: direct-cnn-through-egress-gateway spec: hosts: - edition.cnn.com gateways: - istio-egressgateway - mesh http: - match: - gateways: - mesh port: 80 route: - destination: host: istio-egressgateway.istio-system.svc.cluster.local subset: cnn port: number: 80 weight: 100 - match: - gateways: - istio-egressgateway port: 80 route: - destination: host: edition.cnn.com port: number: 80 weight: 100 EOF \u67e5\u770b istio-egressgateway \u65e5\u5fd7\uff1a kubectl logs -l istio=egressgateway -c istio-proxy -n istio-system | tail \u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u65e5\u5fd7\uff0c\u8868\u660e\u6d41\u91cf\u7ecf\u8fc7\u4e86 Egress Gateway\uff1a [2021-02-08T06:02:46.098Z] \"GET /politics HTTP/2\" 301 - \"-\" \"-\" 0 0 162 147 \"172.18.0.17\" \"curl/7.69.1\" \"57d13492-b521-961b-bd93-90ab3f0e295e\" \"edition.cnn.com\" \"151.101.129.67:80\" outbound|80||edition.cnn.com 172.18.0.4:41758 172.18.0.4:8080 172.18.0.17:32816 - - \u6e05\u9664\u670d\u52a1\u76f8\u5173\u914d\u7f6e\uff1a $ kubectl delete gateway istio-egressgateway $ kubectl delete serviceentry cnn $ kubectl delete virtualservice direct-cnn-through-egress-gateway $ kubectl delete destinationrule egressgateway-for-cnn \u81f3\u6b64\uff0cIstio Egress Gateway \u5c31\u914d\u7f6e\u5b8c\u6210\u4e86\uff0c\u901a\u8fc7\u8fd9\u90e8\u5206\u7684\u5b66\u4e60\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Istio Egress Gateway \u7684\u5f3a\u5927\u914d\u7f6e\uff0c \u901a\u8fc7 Egress Gateway \u6211\u4eec\u53ef\u4ee5\u5bf9\u5916\u90e8\u6d41\u91cf\u8fdb\u884c\u6743\u9650\u63a7\u5236\u548c\u7cbe\u51c6\u7684\u8def\u7531\u5339\u914d\u8bbf\u95ee \u3002 \u5728\u5b9e\u9645\u5de5\u4f5c\u7684\u9879\u76ee\u4e2d\uff0c\u6211\u501f\u9274\u4e86 Istio Egress Gateway \u7684\u601d\u60f3\uff0c\u5c06\u6240\u6709\u5916\u90e8\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u8bbf\u95ee\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230 Egress Gateway\uff0c\u7ecf\u7531 Egress Gateway \u8bbf\u95ee\u51fa\u53bb\uff0c\u901a\u8fc7\u8fd9\u6837\u7684\u65b9\u5f0f\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u7684\u5ef6\u65f6\uff0c\u7ef4\u6301 HTTP \u7684 KeepAlive \u957f\u8fde\u63a5\u3002 \u56e0\u4e3a\u5982\u679c\u670d\u52a1\u7684\u673a\u5668\u6570\u91cf\u8fc7\u591a\uff0c\u8bbf\u95ee\u5916\u90e8\u9891\u7387\u53c8\u4e0d\u662f\u5f88\u9ad8\uff0c\u4e0e\u5916\u90e8\u670d\u52a1\u7684\u8fde\u63a5\u5c31\u5f88\u5bb9\u6613\u65ad\u6389\uff0c\u4e0d\u5f97\u4e0d\u91cd\u65b0\u5efa\u8fde\uff0c\u800c\u73b0\u5728\u5927\u591a\u6570\u5916\u90e8\u670d\u52a1\u90fd\u662f HTTPS \u7684\uff0c\u9700\u8981\u6d88\u8017\u8fc7\u591a\u7684 SSL \u63e1\u624b\u65f6\u95f4\u3002","title":"4-2 Istio Egress"},{"location":"chap2/6chap3_canary/","text":"\u7b2c\u516d\u8282 \u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u7248\u672c\u63a7\u5236 1\u3001Kubernetes \u4e2d\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03 \u5982\u4f55\u5728 Kubernetes \u4e2d\u8fdb\u884c\u7248\u672c\u66f4\u65b0 \u9996\u5148\u542f\u52a8 Minikube \u73af\u5883\uff1a minikube start --kubernetes-version=v1.19.2 --driver=docker \u521b\u5efa controllers/nginx-deployment.yaml \u7684\u914d\u7f6e\u6587\u4ef6\uff1a apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 \u53ef\u4ee5\u770b\u5230\uff1a \u6211\u4eec\u521b\u5efa\u4e86 3 \u4e2a\u526f\u672c\u6570\u91cf\u7684 Nginx\uff0c\u7248\u672c\u53f7\u4e3a 1.14.2 \u3002 \u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u521b\u5efa Deployment\uff1a kubectl apply -f https://k8s.io/examples/controllers/nginx-deployment.yaml \u901a\u8fc7\u547d\u4ee4\u67e5\u770b Pod \u7684\u8fd0\u884c\u72b6\u6001\uff1a kubectl get pods --show-labels -o wide \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELS nginx-deployment-66b6c48dd5-b92bv 1/1 Running 0 2m5s 172.18.0.3 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-66b6c48dd5-hshnm 1/1 Running 0 2m5s 172.18.0.4 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-66b6c48dd5-tfwfc 1/1 Running 0 2m5s 172.18.0.5 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 \u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u4f7f\u7528\u547d\u4ee4\u67e5\u770b Deployment\u8be6\u7ec6\u4fe1\u606f\uff1a kubectl describe deployments \u53ef\u4ee5\u770b\u5230 Nginx \u7684\u7248\u672c\u4e3a 1.14.2\uff1a Pod Template: Labels: app=nginx Containers: nginx: Image: nginx:1.14.2 Port: 80/TCP Host Port: 0/TCP Environment: <none> Mounts: <none> Volumes: <none> \u4e0b\u9762\u6211\u4eec\u5c1d\u8bd5\u4fee\u6539 Deployment\uff0c\u6765\u66f4\u65b0 Nginx \u7684\u7248\u672c\uff1a kubectl edit deployment.v1.apps/nginx-deployment \u4fee\u6539 .spec.template.spec.containers[0].image \u5b57\u6bb5\uff0c\u4ece nginx:1.14.2 \u6539\u6210 nginx:1.16.1 \uff0c\u8f93\u51fa\u5982\u4e0b\uff1a deployment.apps/nginx-deployment edited \u67e5\u770b\u6eda\u52a8\u5347\u7ea7\u72b6\u6001\uff1a kubectl rollout status deployment/nginx-deployment Waiting for deployment \"nginx-deployment\" rollout to finish: 1 out of 3 new replicas have been updated.. \u67e5\u770b Pod \u7684\u72b6\u6001\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u65b0\u7684\u526f\u672c\u5df2\u7ecf\u542f\u52a8\u6210\u529f\uff0c\u65e7\u7248\u672c\u7684\u526f\u672c\u5df2\u7ecf\u505c\u6b62\uff1a kubectl get pods --show-labels -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELS nginx-deployment-559d658b74-8w29d 1/1 Running 0 2s 172.18.0.3 minikube <none> <none> app=nginx,pod-template-hash=559d658b74 nginx-deployment-559d658b74-df9rv 1/1 Running 0 77s 172.18.0.6 minikube <none> <none> app=nginx,pod-template-hash=559d658b74 nginx-deployment-559d658b74-ktzsh 1/1 Running 0 4s 172.18.0.5 minikube <none> <none> app=nginx,pod-template-hash=559d658b74 nginx-deployment-66b6c48dd5-b92bv 0/1 Terminating 0 27m 172.18.0.3 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-66b6c48dd5-hshnm 1/1 Terminating 0 27m 172.18.0.4 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-66b6c48dd5-tfwfc 0/1 Terminating 0 27m 172.18.0.5 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 \u6211\u4eec\u518d\u6765\u770b\u4e00\u4e0b Nginx \u7684\u7248\u672c\u4fe1\u606f\uff0c\u67e5\u770b\u662f\u5426\u66f4\u65b0\u6210\u529f\uff1a Pod Template: Labels: app=nginx Containers: nginx: Image: nginx:1.16.1 Port: 80/TCP Host Port: 0/TCP Environment: <none> Mounts: <none> Volumes: <none> \u6700\u540e\u5220\u9664 Deployment \u8d44\u6e90\uff0c\u786e\u4fdd\u4e0b\u9762\u7684\u793a\u4f8b\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff1a kubectl delete deployment.v1.apps/nginx-deployment Kubernetes \u4e2d\u7684\u7248\u672c\u66f4\u65b0\u5df2\u7ecf\u5b8c\u6210\u4e86\uff0c\u901a\u8fc7\u6eda\u52a8\u5347\u7ea7\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u5730\u8fdb\u884c\u7248\u672c\u66f4\u65b0\u3002 \u4f46\u662f\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c \u5e76\u6ca1\u6709\u7070\u5ea6\u529f\u80fd\uff0c\u8fd9\u5c31\u76f8\u5f53\u4e8e\u76f4\u63a5\u8fdb\u884c\u65b0\u7248\u672c\u5168\u91cf\u53d1\u5e03\u4e86\uff0c\u5f88\u663e\u7136\u4e0d\u7b26\u5408\u751f\u4ea7\u73af\u5883\u7684\u8981\u6c42\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u5b66\u4e60\u5982\u4f55\u5728 Kubernetes \u4e2d\u7ed3\u5408\u7248\u672c\u66f4\u65b0\u505a\u5230\u91d1\u4e1d\u96c0\u53d1\u5e03 \u9996\u5148\u521b\u5efa Nginx \u7684\u5e94\u7528\uff0c\u5e76\u90e8\u7f72\uff1a apiVersion: v1 kind: Service metadata: name: my-nginx-svc labels: app: nginx spec: type: LoadBalancer ports: - port: 80 selector: app: nginx --- apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 kubectl apply -f https://k8s.io/examples/application/nginx-app.yaml \u542f\u52a8 Minikube \u96a7\u9053\uff0c\u6253\u901a\u7f51\u7edc\uff1a minikube tunnel \u901a\u8fc7\u6d4f\u89c8\u5668\u6216\u8005 curl \u547d\u4ee4\u8bbf\u95ee minikube ip \u83b7\u53d6 IP\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a curl -i http://127.0.0.1 HTTP/1.1 200 OK Server: nginx/1.14.2 Date: Fri, 12 Feb 2021 07:28:56 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 04 Dec 2018 14:44:49 GMT Connection: keep-alive ETag: \"5c0692e1-264\" Accept-Ranges: bytes \u53ef\u4ee5\u770b\u5230\uff0cNginx\u662f\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u7684\uff0c\u4ece\u8fd4\u56de\u7684 header \u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230 Nginx \u7248\u672c\u53f7\u3002 \u91cd\u590d\u4e0a\u9762\u7684 Kubernetes \u7248\u672c\u66f4\u65b0\u65f6\u7684\u6b65\u9aa4\uff0c\u90e8\u7f72\u4e00\u4e2a\u65b0\u7684\u7248\u672c\uff1a kubectl apply -f https://k8s.io/examples/controllers/nginx-deployment.yaml \u4fee\u6539 nginx-deployment \u4e2d Nginx \u7684\u7248\u672c\u53f7\uff0c\u5e76\u4e3a\u5176\u589e\u52a0\u65b0\u7684\u6807\u7b7e track:canary \uff0c\u5177\u4f53\u8def\u5f84\u4e3a .spec.template.metadata.lables.track:canary \uff1a kubectl edit deployment.v1.apps/nginx-deployment \u7ee7\u7eed\u67e5\u770b Pod\uff0c \u53ef\u4ee5\u53d1\u73b0\u6b64\u65f6\u540c\u65f6\u542f\u52a8\u4e86\u4e24\u4e2a\u7248\u672c \uff0c\u65b0\u542f\u52a8\u7684\u7248\u672c\u5e26\u6709 track=canary \u7684\u6807\u7b7e\uff1a kubectl get pods --show-labels -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELS my-nginx-66b6c48dd5-82v69 1/1 Running 0 38m 172.18.0.8 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 my-nginx-66b6c48dd5-clzgn 1/1 Running 0 38m 172.18.0.7 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 my-nginx-66b6c48dd5-ngbql 1/1 Running 0 38m 172.18.0.4 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-975fd467c-7ghzx 1/1 Running 0 100s 172.18.0.6 minikube <none> <none> app=nginx,pod-template-hash=975fd467c,track=canary nginx-deployment-975fd467c-lx5sz 1/1 Running 0 104s 172.18.0.5 minikube <none> <none> app=nginx,pod-template-hash=975fd467c,track=canary nginx-deployment-975fd467c-vqm4m 1/1 Running 0 102s 172.18.0.3 minikube <none> <none> app=nginx,pod-template-hash=975fd467c,track=canary app=nginx,pod-template-hash=975fd467c,track=canary \u5b9e\u9645\u4e0a\uff0c\u6b64\u65f6 Nginx \u540c\u65f6\u8fd0\u884c\u4e86\u4e24\u4e2a\u7248\u672c\uff0c \u6211\u4eec\u65b0\u53d1\u5e03\u7684\u7248\u672c\u662f Nginx1.16.1\uff0c\u53ef\u4ee5\u901a\u8fc7 curl -i \u7684\u547d\u4ee4\u67e5\u770b \uff1a curl -i http://127.0.0.1 HTTP/1.1 200 OK Server: nginx/1.16.1 Date: Fri, 12 Feb 2021 07:57:30 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 13 Aug 2019 10:05:00 GMT Connection: keep-alive ETag: \"5d528b4c-264\" Accept-Ranges: bytes \u591a\u6b21\u8fd0\u884c curl -i \u547d\u4ee4\u67e5\u770b\u7ed3\u679c\uff0c\u4f60\u53ef\u4ee5\u53d1\u73b0\uff0c\u8fd4\u56de\u7684 header \u4e2d\u540c\u65f6\u5b58\u5728 1.16.1 \u548c 1.14.2 \u4e24\u4e2a Nginx \u7248\u672c \u3002 \u901a\u8fc7\u8fd9\u6837\u6eda\u52a8\u5347\u7ea7\u7684\u65b9\u5f0f\uff0cKubernetes \u53ef\u4ee5\u505a\u5230\u7b80\u5355\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u8fd9\u6837\u7684\u65b9\u5f0f\u5df2\u7ecf\u53ef\u4ee5\u6ee1\u8db3\u4e00\u4e9b\u7b80\u5355\u7684\u573a\u666f\uff0c\u4f46\u662f\u6d41\u91cf\u6bd4\u4f8b\u53ea\u80fd\u901a\u8fc7\u7070\u5ea6\u5355\u4e2a Pod \u7684\u65b9\u5f0f\u63a7\u5236\u3002 2\u3001Istio \u4e2d\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03 Istio\u548c Kubernetes \u5b9e\u73b0\u91d1\u4e1d\u96c0\u53d1\u5e03\u7684\u65b9\u5f0f\u4e0d\u592a\u4e00\u6837\uff0c Istio \u901a\u8fc7 Envoy \u5f3a\u5927\u7684\u8def\u7531\u89c4\u5219\u7ba1\u7406\u80fd\u529b\uff0c\u53ef\u4ee5\u7075\u6d3b\u5730\u63a7\u5236\u5bf9\u5e94\u7248\u672c\u7684\u6d41\u91cf\u767e\u5206\u6bd4 \u793a\u610f\u56fe\u5982\u4e0b\uff0c\u7528\u6237\u8bbf\u95ee productpage \u7684\u8bf7\u6c42\uff0c \u5185\u90e8\u6d41\u91cf\u4f1a\u5206\u522b\u8def\u7531\u5230 reviews-v1 \u548c v2 \u4e24\u4e2a\u7248\u672c \u3002 kubectl get pods NAME READY STATUS RESTARTS AGE details-v1-b87bfc85d-nd8v7 2/2 Running 0 2m12s productpage-v1-65576bb7bf-hj6mw 1/2 Running 0 2m11s ratings-v1-645b477958-gtrqd 0/2 PodInitializing 0 2m12s reviews-v1-987d495c-2x5rh 2/2 Running 0 2m12s reviews-v2-6c5bf657cf-t66hz 2/2 Running 0 2m12s reviews-v3-5f7b9f4f77-gcrsj 2/2 Running 0 2m12s \u901a\u8fc7\u67e5\u770b samples/bookinfo/platform/kube/bookinfo.yaml \u7684\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u770b\u5230\uff1a\u6709\u4e09\u4e2a reviews \u670d\u52a1\u7684\u90e8\u7f72\u7c7b\u578b\u8d44\u6e90\u3002\u901a\u8fc7\u524d\u9762 Kubernetes \u7070\u5ea6\u53d1\u5e03\u7684\u5185\u5bb9\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff0c\u901a\u8fc7\u914d\u7f6e\u4e0d\u540c\u7684 labels\uff0c\u53ef\u4ee5\u8ba9\u540c\u4e00\u4e2a\u670d\u52a1\u7684\u4e09\u4e2a\u90e8\u7f72\u8d44\u6e90\u540c\u65f6\u5b58\u5728\u3002 \u8fd9\u4e09\u4e2a\u90e8\u7f72\u8d44\u6e90\u7684\u670d\u52a1\u955c\u50cf\u6307\u5411\u4e86\u4e09\u4e2a\u4e0d\u540c\u7684\u5730\u5740\uff0c\u5206\u522b\u662f examples-bookinfo-reviews-v1:1.16.2 \u3001 examples-bookinfo-reviews-v2:1.16.2 \u548c examples-bookinfo-reviews-v3:1.16.2 \uff1a --- apiVersion: apps/v1 kind: Deployment metadata: name: reviews-v1 labels: app: reviews version: v1 spec: replicas: 1 selector: matchLabels: app: reviews version: v1 template: metadata: labels: app: reviews version: v1 spec: serviceAccountName: bookinfo-reviews containers: - name: reviews image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 imagePullPolicy: IfNotPresent env: - name: LOG_DIR value: \"/tmp/logs\" ports: - containerPort: 9080 volumeMounts: - name: tmp mountPath: /tmp - name: wlp-output mountPath: /opt/ibm/wlp/output volumes: - name: wlp-output emptyDir: {} - name: tmp emptyDir: {} --- apiVersion: apps/v1 kind: Deployment metadata: name: reviews-v2 labels: app: reviews version: v2 spec: replicas: 1 selector: matchLabels: app: reviews version: v2 template: metadata: labels: app: reviews version: v2 spec: serviceAccountName: bookinfo-reviews containers: - name: reviews image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 imagePullPolicy: IfNotPresent env: - name: LOG_DIR value: \"/tmp/logs\" ports: - containerPort: 9080 volumeMounts: - name: tmp mountPath: /tmp - name: wlp-output mountPath: /opt/ibm/wlp/output volumes: - name: wlp-output emptyDir: {} - name: tmp emptyDir: {} --- apiVersion: apps/v1 kind: Deployment metadata: name: reviews-v3 labels: app: reviews version: v3 spec: replicas: 1 selector: matchLabels: app: reviews version: v3 template: metadata: labels: app: reviews version: v3 spec: serviceAccountName: bookinfo-reviews containers: - name: reviews image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2 imagePullPolicy: IfNotPresent env: - name: LOG_DIR value: \"/tmp/logs\" ports: - containerPort: 9080 volumeMounts: - name: tmp mountPath: /tmp - name: wlp-output mountPath: /opt/ibm/wlp/output volumes: - name: wlp-output emptyDir: {} - name: tmp emptyDir: {} \u6211\u4eec\u5728\u9875\u9762\u4e2d\uff0c\u53cd\u590d\u5237\u65b0 http://127.0.0.1/productpage \u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u540c\u7684\u4e09\u79cd reviews \u7684\u663e\u793a\u3002 \u901a\u8fc7\u4e0a\u9762\u7684\u8bf7\u6c42\u7ed3\u679c\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0cIstio \u786e\u5b9e\u5c06\u6d41\u91cf\u8def\u7531\u5230\u4e86\u4e0d\u540c\u7684 reviews \u7248\u672c\u4e0a\uff0c\u4f46\u662f\u8fd9\u91cc\u6211\u4eec\u8fd8\u6ca1\u6709\u5bf9 Istio \u7684\u8def\u7531\u89c4\u5219\u505a\u7279\u6b8a\u914d\u7f6e \uff0c\u6240\u4ee5\u8fd9\u91cc\u7684\u6d41\u91cf\u662f\u5747\u5206\u7684\uff0c\u4f60\u4e5f\u53ef\u4ee5\u7406\u89e3\u4e3a\u548c Kubernetes \u7684\u7248\u672c\u7070\u5ea6\u7b56\u7565\u662f\u4e00\u81f4\u7684 \u3002 \u4e0b\u9762\u6211\u4eec\u521b\u5efa\u4e00\u4e2a reviews \u7684\u8def\u7531\u89c4\u5219\uff0c\u4e3a\u4e86\u65b9\u4fbf\u9a8c\u8bc1\uff0c\u8fd9\u4e2a\u914d\u7f6e\u5c06\u6240\u6709\u6d41\u91cf\u6307\u5411 reviews \u7684 v1 \u7248\u672c\uff1a kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reivews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 EOF \u6b64\u65f6\uff0c\u6211\u4eec\u65e0\u8bba\u5982\u4f55\u5237\u65b0\u9875\u9762\uff0c\u90fd\u4f1a\u53d1\u73b0\u9875\u9762\u7684\u663e\u793a\u5185\u5bb9\uff0c\u603b\u662f\u505c\u7559\u5728 reviews \u7684 v1 \u7248\u672c\u3002 \u4e0b\u9762\u6211\u4eec\u518d\u505a\u51fa\u4e00\u4e9b\u6539\u52a8\uff0c\u4fee\u6539 Istio \u8def\u7531\u914d\u7f6e\uff0c \u5c06 90% \u7684\u6d41\u91cf\u6307\u5411 v1 \u7248\u672c\uff0c10% \u7684\u6d41\u91cf\u6307\u5411 v2 \u7248\u672c \uff0c\u4ee5\u8fbe\u5230\u6211\u4eec\u6700\u5f00\u59cb\u7684\u9700\u6c42\u2014\u2014\u7cbe\u51c6\u6d41\u91cf\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a $ kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reivews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 weight: 90 - destination: host: reviews subset: v2 weight: 10 EOF \u6210\u529f\u6267\u884c\u4e0a\u8ff0\u547d\u4ee4\uff0c \u6211\u4eec\u53cd\u590d\u5237\u65b0 productpage \u9875\u9762\uff0c\u53ef\u4ee5\u53d1\u73b0\u5927\u6982\u6709 10% \u7684\u6d41\u91cf\u88ab\u8def\u7531\u5230\u4e86\u65b0\u7684 reviews v2 \u7248\u672c \u3002 \u73b0\u5b9e\u573a\u666f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u7075\u6d3b\u5730\u8bbe\u7f6e reviews v1 \u7248\u672c\u548c v2 \u7248\u672c\u7684\u6d41\u91cf\u6bd4\u4f8b\uff0c\u6bd4\u5982\u8bbe\u7f6e v2 \u7248\u672c\u6d41\u91cf\u6bd4\u4f8b\u4e3a 1%\uff0c\u7528\u4e8e\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u8fd9\u6837\u7684\u65b9\u5f0f\u76f8\u8f83\u4e8e Kubernetes \u542f\u52a8 100 \u4e2a pod \u8fdb\u884c\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u8981\u7075\u6d3b\u5f97\u591a\u3002 \u5728\u91d1\u4e1d\u96c0\u53d1\u5e03\u7684\u8fc7\u7a0b\u4e2d\uff0c \u901a\u8fc7\u4e0d\u65ad\u589e\u52a0 v2 \u7684\u6d41\u91cf\u6bd4\u4f8b\u8fbe\u5230\u7cbe\u51c6\u6d41\u91cf\u7070\u5ea6\u53d1\u5e03\u7684\u76ee\u7684 \uff0c\u914d\u5408 Metrics \u76d1\u63a7\u6307\u6807\uff0c\u53ef\u4ee5\u968f\u65f6\u81ea\u52a8\u8c03\u6574 v2 \u7684\u6bd4\u4f8b\uff0c\u4ee5\u51cf\u5c11\u65b0\u7248\u672c\u51fa\u95ee\u9898\u65f6\u5bf9\u751f\u4ea7\u73af\u5883\u7684\u5f71\u54cd\u3002\u968f\u7740 v2 \u7248\u672c\u7684\u6d41\u91cf\u4e0d\u65ad\u589e\u5927\uff0c\u6700\u7ec8\u5f7b\u5e95\u66ff\u4ee3 v1 \u7248\u672c\u6210\u4e3a\u7ebf\u4e0a\u6b63\u5f0f\u7248\u672c\uff0c\u6574\u4e2a\u91d1\u4e1d\u96c0\u53d1\u5e03\u4e5f\u5c31\u7ed3\u675f\u4e86\u3002 \u5f53\u7136\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u4f60\u5e94\u8be5\u7075\u6d3b\u8c03\u6574 v1 \u548c v2 \u7248\u672c\u7684 Kubernetes \u526f\u672c\u6570\u91cf\uff0c\u6216\u8005\u914d\u5408 Kubernetes \u7684 HPA\uff0c\u4ee5\u8fbe\u5230\u81ea\u52a8\u6269\u7f29\u5bb9\u7684\u76ee\u7684\uff1a $ kubectl autoscale deployment reviews-v1 --cpu-percent=50 --min=1 --max=10 $ kubectl autoscale deployment reviews-v2 --cpu-percent=50 --min=1 --max=10 Istio \u4e2d\u53e6\u4e00\u4e2a\u5f3a\u5927\u7684\u529f\u80fd\uff1a \u9488\u5bf9 header \u8bbe\u7f6e\u8def\u7531\u7b56\u7565\uff0c\u4ee5\u8fbe\u5230\u91d1\u4e1d\u96c0\u6d4b\u8bd5\u7684\u76ee\u7684 \u3002\u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u9488\u5bf9\u4e0d\u540c\u7528\u6237\u6216\u4e0d\u540c\u7684\u5ba2\u6237\u7aef\u7248\u672c\uff08\u9488\u5bf9\u6d4b\u8bd5\u4eba\u5458\u5355\u72ec\u53d1\u5e03\u7684\u6d4b\u8bd5\u7248\u672c\uff09\uff0c\u8fdb\u884c\u7cbe\u51c6\u7684\u6d41\u91cf\u8def\u7531\u3002 3\u3001Istio \u91d1\u4e1d\u96c0\u6d4b\u8bd5 \u9996\u5148\u6211\u4eec\u521b\u5efa\u4e00\u4e2a VirtualService \u914d\u7f6e\uff0c\u5c06\u767b\u5f55\u7528\u6237\u540d\u4e3a testuser \u7684\u7528\u6237\u6307\u5411\u6d4b\u8bd5\u7248\u672c v2 \u548c v3\uff0c \u5176\u4e2d v3 \u6d41\u91cf\u5360\u6bd4 90%\uff0cv2 \u6d41\u91cf\u5360\u6bd4 10%\u3002 \u8fd9\u4e2a\u7248\u672c\u4e13\u95e8\u7528\u4e8e testuser \u7684\u6d4b\u8bd5\u4eba\u5458\u8fdb\u884c\u65b0\u7248\u672c\u7684\u6d4b\u8bd5\uff0c\u5176\u4ed6\u767b\u5f55\u7528\u6237\u5168\u90e8\u8def\u7531\u5230 v1 \u7248\u672c\uff1a kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: testuser route: - destination: host: reviews subset: v2 weight: 10 - destination: host: reviews subset: v3 weight: 90 - route: - destination: host: reviews subset: v1 EOF \u6267\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53cd\u590d\u8bbf\u95ee productpage \u9875\u9762\uff0c\u53d1\u73b0\u6d41\u91cf\u5927\u90e8\u5206\u90fd\u8def\u7531\u5230\u4e86 v3 \u7248\u672c\uff0c\u5c11\u91cf\u6d41\u91cf\u8def\u7531\u5230\u4e86 v2 \u7248\u672c\u3002 \u81f3\u6b64\uff0c\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Istio \u7684\u91d1\u4e1d\u96c0\u6d4b\u8bd5\u3002","title":"\u7b2c\u516d\u8282 \u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u7248\u672c\u63a7\u5236"},{"location":"chap2/6chap3_canary/#_1","text":"","title":"\u7b2c\u516d\u8282 \u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u7248\u672c\u63a7\u5236"},{"location":"chap2/6chap3_canary/#1kubernetes","text":"\u5982\u4f55\u5728 Kubernetes \u4e2d\u8fdb\u884c\u7248\u672c\u66f4\u65b0 \u9996\u5148\u542f\u52a8 Minikube \u73af\u5883\uff1a minikube start --kubernetes-version=v1.19.2 --driver=docker \u521b\u5efa controllers/nginx-deployment.yaml \u7684\u914d\u7f6e\u6587\u4ef6\uff1a apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 \u53ef\u4ee5\u770b\u5230\uff1a \u6211\u4eec\u521b\u5efa\u4e86 3 \u4e2a\u526f\u672c\u6570\u91cf\u7684 Nginx\uff0c\u7248\u672c\u53f7\u4e3a 1.14.2 \u3002 \u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u521b\u5efa Deployment\uff1a kubectl apply -f https://k8s.io/examples/controllers/nginx-deployment.yaml \u901a\u8fc7\u547d\u4ee4\u67e5\u770b Pod \u7684\u8fd0\u884c\u72b6\u6001\uff1a kubectl get pods --show-labels -o wide \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELS nginx-deployment-66b6c48dd5-b92bv 1/1 Running 0 2m5s 172.18.0.3 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-66b6c48dd5-hshnm 1/1 Running 0 2m5s 172.18.0.4 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-66b6c48dd5-tfwfc 1/1 Running 0 2m5s 172.18.0.5 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 \u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u4f7f\u7528\u547d\u4ee4\u67e5\u770b Deployment\u8be6\u7ec6\u4fe1\u606f\uff1a kubectl describe deployments \u53ef\u4ee5\u770b\u5230 Nginx \u7684\u7248\u672c\u4e3a 1.14.2\uff1a Pod Template: Labels: app=nginx Containers: nginx: Image: nginx:1.14.2 Port: 80/TCP Host Port: 0/TCP Environment: <none> Mounts: <none> Volumes: <none> \u4e0b\u9762\u6211\u4eec\u5c1d\u8bd5\u4fee\u6539 Deployment\uff0c\u6765\u66f4\u65b0 Nginx \u7684\u7248\u672c\uff1a kubectl edit deployment.v1.apps/nginx-deployment \u4fee\u6539 .spec.template.spec.containers[0].image \u5b57\u6bb5\uff0c\u4ece nginx:1.14.2 \u6539\u6210 nginx:1.16.1 \uff0c\u8f93\u51fa\u5982\u4e0b\uff1a deployment.apps/nginx-deployment edited \u67e5\u770b\u6eda\u52a8\u5347\u7ea7\u72b6\u6001\uff1a kubectl rollout status deployment/nginx-deployment Waiting for deployment \"nginx-deployment\" rollout to finish: 1 out of 3 new replicas have been updated.. \u67e5\u770b Pod \u7684\u72b6\u6001\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u65b0\u7684\u526f\u672c\u5df2\u7ecf\u542f\u52a8\u6210\u529f\uff0c\u65e7\u7248\u672c\u7684\u526f\u672c\u5df2\u7ecf\u505c\u6b62\uff1a kubectl get pods --show-labels -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELS nginx-deployment-559d658b74-8w29d 1/1 Running 0 2s 172.18.0.3 minikube <none> <none> app=nginx,pod-template-hash=559d658b74 nginx-deployment-559d658b74-df9rv 1/1 Running 0 77s 172.18.0.6 minikube <none> <none> app=nginx,pod-template-hash=559d658b74 nginx-deployment-559d658b74-ktzsh 1/1 Running 0 4s 172.18.0.5 minikube <none> <none> app=nginx,pod-template-hash=559d658b74 nginx-deployment-66b6c48dd5-b92bv 0/1 Terminating 0 27m 172.18.0.3 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-66b6c48dd5-hshnm 1/1 Terminating 0 27m 172.18.0.4 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-66b6c48dd5-tfwfc 0/1 Terminating 0 27m 172.18.0.5 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 \u6211\u4eec\u518d\u6765\u770b\u4e00\u4e0b Nginx \u7684\u7248\u672c\u4fe1\u606f\uff0c\u67e5\u770b\u662f\u5426\u66f4\u65b0\u6210\u529f\uff1a Pod Template: Labels: app=nginx Containers: nginx: Image: nginx:1.16.1 Port: 80/TCP Host Port: 0/TCP Environment: <none> Mounts: <none> Volumes: <none> \u6700\u540e\u5220\u9664 Deployment \u8d44\u6e90\uff0c\u786e\u4fdd\u4e0b\u9762\u7684\u793a\u4f8b\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff1a kubectl delete deployment.v1.apps/nginx-deployment Kubernetes \u4e2d\u7684\u7248\u672c\u66f4\u65b0\u5df2\u7ecf\u5b8c\u6210\u4e86\uff0c\u901a\u8fc7\u6eda\u52a8\u5347\u7ea7\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u5730\u8fdb\u884c\u7248\u672c\u66f4\u65b0\u3002 \u4f46\u662f\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c \u5e76\u6ca1\u6709\u7070\u5ea6\u529f\u80fd\uff0c\u8fd9\u5c31\u76f8\u5f53\u4e8e\u76f4\u63a5\u8fdb\u884c\u65b0\u7248\u672c\u5168\u91cf\u53d1\u5e03\u4e86\uff0c\u5f88\u663e\u7136\u4e0d\u7b26\u5408\u751f\u4ea7\u73af\u5883\u7684\u8981\u6c42\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u5b66\u4e60\u5982\u4f55\u5728 Kubernetes \u4e2d\u7ed3\u5408\u7248\u672c\u66f4\u65b0\u505a\u5230\u91d1\u4e1d\u96c0\u53d1\u5e03 \u9996\u5148\u521b\u5efa Nginx \u7684\u5e94\u7528\uff0c\u5e76\u90e8\u7f72\uff1a apiVersion: v1 kind: Service metadata: name: my-nginx-svc labels: app: nginx spec: type: LoadBalancer ports: - port: 80 selector: app: nginx --- apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 kubectl apply -f https://k8s.io/examples/application/nginx-app.yaml \u542f\u52a8 Minikube \u96a7\u9053\uff0c\u6253\u901a\u7f51\u7edc\uff1a minikube tunnel \u901a\u8fc7\u6d4f\u89c8\u5668\u6216\u8005 curl \u547d\u4ee4\u8bbf\u95ee minikube ip \u83b7\u53d6 IP\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7ed3\u679c\uff1a curl -i http://127.0.0.1 HTTP/1.1 200 OK Server: nginx/1.14.2 Date: Fri, 12 Feb 2021 07:28:56 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 04 Dec 2018 14:44:49 GMT Connection: keep-alive ETag: \"5c0692e1-264\" Accept-Ranges: bytes \u53ef\u4ee5\u770b\u5230\uff0cNginx\u662f\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u7684\uff0c\u4ece\u8fd4\u56de\u7684 header \u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230 Nginx \u7248\u672c\u53f7\u3002 \u91cd\u590d\u4e0a\u9762\u7684 Kubernetes \u7248\u672c\u66f4\u65b0\u65f6\u7684\u6b65\u9aa4\uff0c\u90e8\u7f72\u4e00\u4e2a\u65b0\u7684\u7248\u672c\uff1a kubectl apply -f https://k8s.io/examples/controllers/nginx-deployment.yaml \u4fee\u6539 nginx-deployment \u4e2d Nginx \u7684\u7248\u672c\u53f7\uff0c\u5e76\u4e3a\u5176\u589e\u52a0\u65b0\u7684\u6807\u7b7e track:canary \uff0c\u5177\u4f53\u8def\u5f84\u4e3a .spec.template.metadata.lables.track:canary \uff1a kubectl edit deployment.v1.apps/nginx-deployment \u7ee7\u7eed\u67e5\u770b Pod\uff0c \u53ef\u4ee5\u53d1\u73b0\u6b64\u65f6\u540c\u65f6\u542f\u52a8\u4e86\u4e24\u4e2a\u7248\u672c \uff0c\u65b0\u542f\u52a8\u7684\u7248\u672c\u5e26\u6709 track=canary \u7684\u6807\u7b7e\uff1a kubectl get pods --show-labels -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELS my-nginx-66b6c48dd5-82v69 1/1 Running 0 38m 172.18.0.8 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 my-nginx-66b6c48dd5-clzgn 1/1 Running 0 38m 172.18.0.7 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 my-nginx-66b6c48dd5-ngbql 1/1 Running 0 38m 172.18.0.4 minikube <none> <none> app=nginx,pod-template-hash=66b6c48dd5 nginx-deployment-975fd467c-7ghzx 1/1 Running 0 100s 172.18.0.6 minikube <none> <none> app=nginx,pod-template-hash=975fd467c,track=canary nginx-deployment-975fd467c-lx5sz 1/1 Running 0 104s 172.18.0.5 minikube <none> <none> app=nginx,pod-template-hash=975fd467c,track=canary nginx-deployment-975fd467c-vqm4m 1/1 Running 0 102s 172.18.0.3 minikube <none> <none> app=nginx,pod-template-hash=975fd467c,track=canary app=nginx,pod-template-hash=975fd467c,track=canary \u5b9e\u9645\u4e0a\uff0c\u6b64\u65f6 Nginx \u540c\u65f6\u8fd0\u884c\u4e86\u4e24\u4e2a\u7248\u672c\uff0c \u6211\u4eec\u65b0\u53d1\u5e03\u7684\u7248\u672c\u662f Nginx1.16.1\uff0c\u53ef\u4ee5\u901a\u8fc7 curl -i \u7684\u547d\u4ee4\u67e5\u770b \uff1a curl -i http://127.0.0.1 HTTP/1.1 200 OK Server: nginx/1.16.1 Date: Fri, 12 Feb 2021 07:57:30 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 13 Aug 2019 10:05:00 GMT Connection: keep-alive ETag: \"5d528b4c-264\" Accept-Ranges: bytes \u591a\u6b21\u8fd0\u884c curl -i \u547d\u4ee4\u67e5\u770b\u7ed3\u679c\uff0c\u4f60\u53ef\u4ee5\u53d1\u73b0\uff0c\u8fd4\u56de\u7684 header \u4e2d\u540c\u65f6\u5b58\u5728 1.16.1 \u548c 1.14.2 \u4e24\u4e2a Nginx \u7248\u672c \u3002 \u901a\u8fc7\u8fd9\u6837\u6eda\u52a8\u5347\u7ea7\u7684\u65b9\u5f0f\uff0cKubernetes \u53ef\u4ee5\u505a\u5230\u7b80\u5355\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u8fd9\u6837\u7684\u65b9\u5f0f\u5df2\u7ecf\u53ef\u4ee5\u6ee1\u8db3\u4e00\u4e9b\u7b80\u5355\u7684\u573a\u666f\uff0c\u4f46\u662f\u6d41\u91cf\u6bd4\u4f8b\u53ea\u80fd\u901a\u8fc7\u7070\u5ea6\u5355\u4e2a Pod \u7684\u65b9\u5f0f\u63a7\u5236\u3002","title":"1\u3001Kubernetes \u4e2d\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03"},{"location":"chap2/6chap3_canary/#2istio","text":"Istio\u548c Kubernetes \u5b9e\u73b0\u91d1\u4e1d\u96c0\u53d1\u5e03\u7684\u65b9\u5f0f\u4e0d\u592a\u4e00\u6837\uff0c Istio \u901a\u8fc7 Envoy \u5f3a\u5927\u7684\u8def\u7531\u89c4\u5219\u7ba1\u7406\u80fd\u529b\uff0c\u53ef\u4ee5\u7075\u6d3b\u5730\u63a7\u5236\u5bf9\u5e94\u7248\u672c\u7684\u6d41\u91cf\u767e\u5206\u6bd4 \u793a\u610f\u56fe\u5982\u4e0b\uff0c\u7528\u6237\u8bbf\u95ee productpage \u7684\u8bf7\u6c42\uff0c \u5185\u90e8\u6d41\u91cf\u4f1a\u5206\u522b\u8def\u7531\u5230 reviews-v1 \u548c v2 \u4e24\u4e2a\u7248\u672c \u3002 kubectl get pods NAME READY STATUS RESTARTS AGE details-v1-b87bfc85d-nd8v7 2/2 Running 0 2m12s productpage-v1-65576bb7bf-hj6mw 1/2 Running 0 2m11s ratings-v1-645b477958-gtrqd 0/2 PodInitializing 0 2m12s reviews-v1-987d495c-2x5rh 2/2 Running 0 2m12s reviews-v2-6c5bf657cf-t66hz 2/2 Running 0 2m12s reviews-v3-5f7b9f4f77-gcrsj 2/2 Running 0 2m12s \u901a\u8fc7\u67e5\u770b samples/bookinfo/platform/kube/bookinfo.yaml \u7684\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u770b\u5230\uff1a\u6709\u4e09\u4e2a reviews \u670d\u52a1\u7684\u90e8\u7f72\u7c7b\u578b\u8d44\u6e90\u3002\u901a\u8fc7\u524d\u9762 Kubernetes \u7070\u5ea6\u53d1\u5e03\u7684\u5185\u5bb9\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff0c\u901a\u8fc7\u914d\u7f6e\u4e0d\u540c\u7684 labels\uff0c\u53ef\u4ee5\u8ba9\u540c\u4e00\u4e2a\u670d\u52a1\u7684\u4e09\u4e2a\u90e8\u7f72\u8d44\u6e90\u540c\u65f6\u5b58\u5728\u3002 \u8fd9\u4e09\u4e2a\u90e8\u7f72\u8d44\u6e90\u7684\u670d\u52a1\u955c\u50cf\u6307\u5411\u4e86\u4e09\u4e2a\u4e0d\u540c\u7684\u5730\u5740\uff0c\u5206\u522b\u662f examples-bookinfo-reviews-v1:1.16.2 \u3001 examples-bookinfo-reviews-v2:1.16.2 \u548c examples-bookinfo-reviews-v3:1.16.2 \uff1a --- apiVersion: apps/v1 kind: Deployment metadata: name: reviews-v1 labels: app: reviews version: v1 spec: replicas: 1 selector: matchLabels: app: reviews version: v1 template: metadata: labels: app: reviews version: v1 spec: serviceAccountName: bookinfo-reviews containers: - name: reviews image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 imagePullPolicy: IfNotPresent env: - name: LOG_DIR value: \"/tmp/logs\" ports: - containerPort: 9080 volumeMounts: - name: tmp mountPath: /tmp - name: wlp-output mountPath: /opt/ibm/wlp/output volumes: - name: wlp-output emptyDir: {} - name: tmp emptyDir: {} --- apiVersion: apps/v1 kind: Deployment metadata: name: reviews-v2 labels: app: reviews version: v2 spec: replicas: 1 selector: matchLabels: app: reviews version: v2 template: metadata: labels: app: reviews version: v2 spec: serviceAccountName: bookinfo-reviews containers: - name: reviews image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 imagePullPolicy: IfNotPresent env: - name: LOG_DIR value: \"/tmp/logs\" ports: - containerPort: 9080 volumeMounts: - name: tmp mountPath: /tmp - name: wlp-output mountPath: /opt/ibm/wlp/output volumes: - name: wlp-output emptyDir: {} - name: tmp emptyDir: {} --- apiVersion: apps/v1 kind: Deployment metadata: name: reviews-v3 labels: app: reviews version: v3 spec: replicas: 1 selector: matchLabels: app: reviews version: v3 template: metadata: labels: app: reviews version: v3 spec: serviceAccountName: bookinfo-reviews containers: - name: reviews image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2 imagePullPolicy: IfNotPresent env: - name: LOG_DIR value: \"/tmp/logs\" ports: - containerPort: 9080 volumeMounts: - name: tmp mountPath: /tmp - name: wlp-output mountPath: /opt/ibm/wlp/output volumes: - name: wlp-output emptyDir: {} - name: tmp emptyDir: {} \u6211\u4eec\u5728\u9875\u9762\u4e2d\uff0c\u53cd\u590d\u5237\u65b0 http://127.0.0.1/productpage \u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u540c\u7684\u4e09\u79cd reviews \u7684\u663e\u793a\u3002 \u901a\u8fc7\u4e0a\u9762\u7684\u8bf7\u6c42\u7ed3\u679c\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0cIstio \u786e\u5b9e\u5c06\u6d41\u91cf\u8def\u7531\u5230\u4e86\u4e0d\u540c\u7684 reviews \u7248\u672c\u4e0a\uff0c\u4f46\u662f\u8fd9\u91cc\u6211\u4eec\u8fd8\u6ca1\u6709\u5bf9 Istio \u7684\u8def\u7531\u89c4\u5219\u505a\u7279\u6b8a\u914d\u7f6e \uff0c\u6240\u4ee5\u8fd9\u91cc\u7684\u6d41\u91cf\u662f\u5747\u5206\u7684\uff0c\u4f60\u4e5f\u53ef\u4ee5\u7406\u89e3\u4e3a\u548c Kubernetes \u7684\u7248\u672c\u7070\u5ea6\u7b56\u7565\u662f\u4e00\u81f4\u7684 \u3002 \u4e0b\u9762\u6211\u4eec\u521b\u5efa\u4e00\u4e2a reviews \u7684\u8def\u7531\u89c4\u5219\uff0c\u4e3a\u4e86\u65b9\u4fbf\u9a8c\u8bc1\uff0c\u8fd9\u4e2a\u914d\u7f6e\u5c06\u6240\u6709\u6d41\u91cf\u6307\u5411 reviews \u7684 v1 \u7248\u672c\uff1a kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reivews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 EOF \u6b64\u65f6\uff0c\u6211\u4eec\u65e0\u8bba\u5982\u4f55\u5237\u65b0\u9875\u9762\uff0c\u90fd\u4f1a\u53d1\u73b0\u9875\u9762\u7684\u663e\u793a\u5185\u5bb9\uff0c\u603b\u662f\u505c\u7559\u5728 reviews \u7684 v1 \u7248\u672c\u3002 \u4e0b\u9762\u6211\u4eec\u518d\u505a\u51fa\u4e00\u4e9b\u6539\u52a8\uff0c\u4fee\u6539 Istio \u8def\u7531\u914d\u7f6e\uff0c \u5c06 90% \u7684\u6d41\u91cf\u6307\u5411 v1 \u7248\u672c\uff0c10% \u7684\u6d41\u91cf\u6307\u5411 v2 \u7248\u672c \uff0c\u4ee5\u8fbe\u5230\u6211\u4eec\u6700\u5f00\u59cb\u7684\u9700\u6c42\u2014\u2014\u7cbe\u51c6\u6d41\u91cf\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03\uff1a $ kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reivews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 weight: 90 - destination: host: reviews subset: v2 weight: 10 EOF \u6210\u529f\u6267\u884c\u4e0a\u8ff0\u547d\u4ee4\uff0c \u6211\u4eec\u53cd\u590d\u5237\u65b0 productpage \u9875\u9762\uff0c\u53ef\u4ee5\u53d1\u73b0\u5927\u6982\u6709 10% \u7684\u6d41\u91cf\u88ab\u8def\u7531\u5230\u4e86\u65b0\u7684 reviews v2 \u7248\u672c \u3002 \u73b0\u5b9e\u573a\u666f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u7075\u6d3b\u5730\u8bbe\u7f6e reviews v1 \u7248\u672c\u548c v2 \u7248\u672c\u7684\u6d41\u91cf\u6bd4\u4f8b\uff0c\u6bd4\u5982\u8bbe\u7f6e v2 \u7248\u672c\u6d41\u91cf\u6bd4\u4f8b\u4e3a 1%\uff0c\u7528\u4e8e\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u8fd9\u6837\u7684\u65b9\u5f0f\u76f8\u8f83\u4e8e Kubernetes \u542f\u52a8 100 \u4e2a pod \u8fdb\u884c\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u8981\u7075\u6d3b\u5f97\u591a\u3002 \u5728\u91d1\u4e1d\u96c0\u53d1\u5e03\u7684\u8fc7\u7a0b\u4e2d\uff0c \u901a\u8fc7\u4e0d\u65ad\u589e\u52a0 v2 \u7684\u6d41\u91cf\u6bd4\u4f8b\u8fbe\u5230\u7cbe\u51c6\u6d41\u91cf\u7070\u5ea6\u53d1\u5e03\u7684\u76ee\u7684 \uff0c\u914d\u5408 Metrics \u76d1\u63a7\u6307\u6807\uff0c\u53ef\u4ee5\u968f\u65f6\u81ea\u52a8\u8c03\u6574 v2 \u7684\u6bd4\u4f8b\uff0c\u4ee5\u51cf\u5c11\u65b0\u7248\u672c\u51fa\u95ee\u9898\u65f6\u5bf9\u751f\u4ea7\u73af\u5883\u7684\u5f71\u54cd\u3002\u968f\u7740 v2 \u7248\u672c\u7684\u6d41\u91cf\u4e0d\u65ad\u589e\u5927\uff0c\u6700\u7ec8\u5f7b\u5e95\u66ff\u4ee3 v1 \u7248\u672c\u6210\u4e3a\u7ebf\u4e0a\u6b63\u5f0f\u7248\u672c\uff0c\u6574\u4e2a\u91d1\u4e1d\u96c0\u53d1\u5e03\u4e5f\u5c31\u7ed3\u675f\u4e86\u3002 \u5f53\u7136\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u4f60\u5e94\u8be5\u7075\u6d3b\u8c03\u6574 v1 \u548c v2 \u7248\u672c\u7684 Kubernetes \u526f\u672c\u6570\u91cf\uff0c\u6216\u8005\u914d\u5408 Kubernetes \u7684 HPA\uff0c\u4ee5\u8fbe\u5230\u81ea\u52a8\u6269\u7f29\u5bb9\u7684\u76ee\u7684\uff1a $ kubectl autoscale deployment reviews-v1 --cpu-percent=50 --min=1 --max=10 $ kubectl autoscale deployment reviews-v2 --cpu-percent=50 --min=1 --max=10 Istio \u4e2d\u53e6\u4e00\u4e2a\u5f3a\u5927\u7684\u529f\u80fd\uff1a \u9488\u5bf9 header \u8bbe\u7f6e\u8def\u7531\u7b56\u7565\uff0c\u4ee5\u8fbe\u5230\u91d1\u4e1d\u96c0\u6d4b\u8bd5\u7684\u76ee\u7684 \u3002\u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u9488\u5bf9\u4e0d\u540c\u7528\u6237\u6216\u4e0d\u540c\u7684\u5ba2\u6237\u7aef\u7248\u672c\uff08\u9488\u5bf9\u6d4b\u8bd5\u4eba\u5458\u5355\u72ec\u53d1\u5e03\u7684\u6d4b\u8bd5\u7248\u672c\uff09\uff0c\u8fdb\u884c\u7cbe\u51c6\u7684\u6d41\u91cf\u8def\u7531\u3002","title":"2\u3001Istio \u4e2d\u7684\u91d1\u4e1d\u96c0\u53d1\u5e03"},{"location":"chap2/6chap3_canary/#3istio","text":"\u9996\u5148\u6211\u4eec\u521b\u5efa\u4e00\u4e2a VirtualService \u914d\u7f6e\uff0c\u5c06\u767b\u5f55\u7528\u6237\u540d\u4e3a testuser \u7684\u7528\u6237\u6307\u5411\u6d4b\u8bd5\u7248\u672c v2 \u548c v3\uff0c \u5176\u4e2d v3 \u6d41\u91cf\u5360\u6bd4 90%\uff0cv2 \u6d41\u91cf\u5360\u6bd4 10%\u3002 \u8fd9\u4e2a\u7248\u672c\u4e13\u95e8\u7528\u4e8e testuser \u7684\u6d4b\u8bd5\u4eba\u5458\u8fdb\u884c\u65b0\u7248\u672c\u7684\u6d4b\u8bd5\uff0c\u5176\u4ed6\u767b\u5f55\u7528\u6237\u5168\u90e8\u8def\u7531\u5230 v1 \u7248\u672c\uff1a kubectl apply -f - <<EOF apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: testuser route: - destination: host: reviews subset: v2 weight: 10 - destination: host: reviews subset: v3 weight: 90 - route: - destination: host: reviews subset: v1 EOF \u6267\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53cd\u590d\u8bbf\u95ee productpage \u9875\u9762\uff0c\u53d1\u73b0\u6d41\u91cf\u5927\u90e8\u5206\u90fd\u8def\u7531\u5230\u4e86 v3 \u7248\u672c\uff0c\u5c11\u91cf\u6d41\u91cf\u8def\u7531\u5230\u4e86 v2 \u7248\u672c\u3002 \u81f3\u6b64\uff0c\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Istio \u7684\u91d1\u4e1d\u96c0\u6d4b\u8bd5\u3002","title":"3\u3001Istio \u91d1\u4e1d\u96c0\u6d4b\u8bd5"},{"location":"chap2/7chap3_monitor/","text":"\u7b2c\u4e03\u8282 \u5982\u4f55\u5229\u7528\u7ec4\u4ef6\u505a\u5230\u670d\u52a1\u7684\u53ef\u89c2\u6d4b\u6027 1\u3001Metrics \u6307\u6807 \u5728\u5f00\u59cb\u8fd9\u90e8\u5206\u5185\u5bb9\u4e4b\u524d\uff0c\u5148\u901a\u8fc7\u547d\u4ee4\u786e\u8ba4\u4f60\u662f\u5426\u5b89\u88c5\u4e86 Prometheus \u548c Grafana\uff1a $ kubectl -n istio-system get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.108.76.68 <none> 3000/TCP 92m istio-egressgateway ClusterIP 10.103.64.246 <none> 80/TCP,443/TCP,15443/TCP 26h istio-ingressgateway LoadBalancer 10.108.98.172 127.0.0.1 15021:31530/TCP,80:31636/TCP,443:31905/TCP,31400:31942/TCP,15443:32337/TCP 26h istiod ClusterIP 10.109.14.171 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP,853/TCP 26h kiali ClusterIP 10.110.51.251 <none> 20001/TCP,9090/TCP 92m prometheus ClusterIP 10.106.46.62 <none> 9090/TCP 92m tracing ClusterIP 10.100.200.122 <none> 80/TCP 92m zipkin ClusterIP 10.100.85.63 <none> 9411/TCP 1-1 Prometheus \u6211\u4eec\u5148\u6765\u542f\u52a8 Prometheus \u7684\u56fe\u5f62\u754c\u9762\uff1a istioctl dashboard prometheus \u8fd9\u4e2a\u547d\u4ee4\u4f1a\u5e2e\u6211\u4eec\u6253\u5f00 Prometheus \u7684 Web \u754c\u9762\uff0c\u5982\u4e0b\u56fe\uff1a Envoy \u7a81\u51fa\u7684 Metrics\uff0c\u5728 Prometheus \u4e2d\u67e5\u8be2 istio_requests_total{connection_security_policy!=\"mutual_tls\", destination_service=~\"reviews.default.svc.cluster.local\", reporter=\"source\"}[5m] \u5207\u6362\u5230 Console \u754c\u9762\uff0c\u53ef\u4ee5\u67e5\u770b\u4e00\u4e9b\u8f93\u51fa\u4fe1\u606f\uff0c\u8bf4\u660e\u4fe1\u606f\u88ab\u6b63\u786e\u91c7\u96c6\uff1a 1-2 Grafana Grafna \u7684\u542f\u52a8\u65b9\u5f0f\u4e5f\u5f88\u7b80\u5355\uff0c\u548c Prometheus \u7c7b\u4f3c\uff1a $ istioctl dashboard grafana Istio \u4e5f\u4e3a\u6211\u4eec\u81ea\u52a8\u5730\u5728\u672c\u5730\u6253\u5f00\u4e86 Grafana \u7684\u754c\u9762 \u8fd9\u91cc\u6211\u4eec\u9700\u8981\u624b\u52a8\u5728\u6d4f\u89c8\u5668\u8f93\u5165 http://localhost:3000/dashboard/db/Istio-mesh-dashboard \u5e76\u8bbf\u95ee\uff0c\u53ef\u4ee5\u76f4\u63a5\u770b\u5230 Istio \u7ba1\u7406\u7684\u670d\u52a1\u5217\u8868\u4fe1\u606f\u3002 \u53ef\u4ee5\u70b9\u51fb\u5230\u4efb\u610f\u94fe\u63a5\u8fdb\u5165\u5b50\u9875\u9762\uff0c\u4e0b\u9762\u6211\u4eec\u8fdb\u5165 Service \u9875\u9762\uff0c\u67e5\u770b\u67d0\u4e2a Service \u7684\u5177\u4f53\u4fe1\u606f\uff08 http://localhost:3000/d/LJ_uJAvmk/istio-service-dashboard?orgId=1&refresh=10s \uff09\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u754c\u9762\uff1a \u5728\u9875\u9762\u7684\u6700\u4e0a\u65b9\uff0c\u6709\u51e0\u4e2a\u9009\u9879\uff0c\u53ef\u4ee5\u9009\u62e9\u6211\u4eec\u9700\u8981\u7684\u53c2\u6570\u3002 Service \uff1a\u670d\u52a1\u540d\uff0c\u8fd9\u91cc\u7684\u670d\u52a1\u540d\u5c31\u662f\u6211\u4eec\u5728 Kubernetes \u4e2d\u8981\u8bbf\u95ee\u7684\u670d\u52a1\u540d\uff0c\u6bd4\u5982 details.default.svc.cluster.local \u3002Bookinfo \u8fd9\u4e2a\u9879\u76ee\u6240\u5305\u542b\u7684\u51e0\u4e2a\u5fae\u670d\u52a1\uff0c\u90fd\u53ef\u4ee5\u5728\u8fd9\u91cc\u9009\u62e9\u3002 Client Workload Namespace\uff08Or Service Workload Namespace\uff09 \uff1a\u8fd9\u91cc\u6307\u7684\u662f Kubernetes \u7684 namespace \u547d\u540d\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f\u670d\u52a1\u521b\u5efa\u5728\u4e86\u54ea\u4e2a\u547d\u540d\u7a7a\u95f4\u3002\u8fd9\u91cc\u5e94\u7528\u7c7b\u578b\u7684\u670d\u52a1\u90fd\u521b\u5efa\u5728\u4e86 default \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u53ea\u6709 istio-ingressgateway \u521b\u5efa\u4e86 istio-system \u7684\u547d\u540d\u7a7a\u95f4\u3002 Client Workload \uff1a\u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d Service \u7684 upstream\uff0c\u4e5f\u5c31\u662f Client \u8c03\u7528\u7aef\u3002 \u6211\u4eec\u9ed8\u8ba4\u9009\u4e2d\u4e86 details.default.svc.cluster.local \u8fd9\u4e2a\u670d\u52a1\uff0c\u67e5\u770b Client Workload \u7684\u4e0b\u62c9\u6846\u53ef\u4ee5\u770b\u5230 productpage-v1 \u7684\u9009\u9879\uff0c\u8fd9\u8bf4\u660e details.default.svc.cluster.local \u8fd9\u4e2a\u670d\u52a1\u7684\u6d41\u91cf\u6765\u6e90\u662f productpage \u7684 v1 \u7248\u672c\u3002\u5982\u679c\u8fd9\u91cc\u6709\u591a\u4e2a\u9009\u9879\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u9009\u4e2d\u5176\u4e2d\u4e00\u4e2a\u8fdb\u884c\u67e5\u770b\uff0c\u901a\u8fc7\u89c2\u5bdf\u4e0d\u540c\u7684\u6d41\u91cf\u6765\u6e90\uff0c\u5728\u51fa\u73b0\u95ee\u9898\u7684\u65f6\u5019\u53ef\u4ee5\u5f88\u597d\u5730\u533a\u5206\u5230\u5e95\u662f\u54ea\u4e2a\u6d41\u91cf\u6765\u6e90\u7684\u95ee\u9898\uff0c\u4fbf\u4e8e\u6392\u67e5\u95ee\u9898\u7684\u6839\u56e0\u3002 Istio \u8fd9\u6837\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\u5219\u6ca1\u6709\u8fd9\u6837\u7684\u56f0\u6270\uff0c \u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u63a7\u5236\u9762\u4e0b\u53d1\u5f53\u524d\u670d\u52a1\u7684\u670d\u52a1\u540d\uff0c\u8ba9 Sidecar \u5728 Metrics \u4e2d\u81ea\u52a8\u6ce8\u5165 \uff0c\u4e0d\u5141\u8bb8\u4e1a\u52a1\u4ee3\u7801\u7f16\u5199\u4eba\u5458\u4fee\u6539\u8fd9\u4e2a\u670d\u52a1\u540d\uff0c\u4ece\u800c\u5728\u6839\u672c\u4e0a\u675c\u7edd\u4e86\u8c03\u7528\u65b9\u670d\u52a1\u540d\u51fa\u9519\u7684\u95ee\u9898\u3002 Service Workload\uff1a\u8fd9\u91cc\u6211\u4eec\u9009\u4e2d reviews.default.svc.cluster.local \uff0c\u7136\u540e\u67e5\u770b Service Workload \u7684\u4e0b\u62c9\u6846\uff0c\u53ef\u4ee5\u770b\u5230\u4e09\u4e2a\u9009\u9879 review-v1\u3001reviews-v2\u3001reviews-v3\u3002\u8fd9\u91cc\u5176\u5b9e\u5c31\u662f reviews \u8fd9\u4e2a\u670d\u52a1\u7684\u4e09\u4e2a\u4e0d\u540c\u7248\u672c\uff0c\u53ef\u4ee5\u5206\u522b\u9009\u62e9\u8fd9\u4e09\u4e2a\u7248\u672c\u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u67e5\u770b\u76f8\u5e94\u7684\u76d1\u63a7\u4fe1\u606f\u3002 \u63a5\u4e0b\u6765\u5c55\u793a\u4e86 SERVICE: reviews.default.svc.cluster.local \u7684\u4e00\u4e9b\u5e38\u89c1\u4fe1\u606f\uff0c\u6bd4\u5982\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef\u8bf7\u6c42\u7684 QPS\u3001\u6210\u529f\u7387\u3001\u5ef6\u65f6\u7b49\u3002 \u8fd9\u91cc\u6240\u6709\u7684\u6307\u6807\u90fd\u6709\u4e24\u4e2a\u7ef4\u5ea6\uff0c \u4e00\u4e2a\u662f\u670d\u52a1\u7aef\u81ea\u8eab\u7684\uff0c\u4e00\u4e2a\u662fClient \u7aef\u7684 \uff0c\u76f8\u5bf9\u6765\u8bf4 Client \u7aef\u7684\u7edf\u8ba1\u66f4\u63a5\u8fd1\u670d\u52a1\u672c\u8eab\u7684\u8017\u65f6\uff0c\u56e0\u4e3a\u670d\u52a1\u81ea\u8eab\u7684\u7edf\u8ba1\u65e0\u6cd5\u628a\u7f51\u7edc\u6d88\u8017\u7edf\u8ba1\u5728\u5185\u3002\u5f88\u591a\u65f6\u5019\u6211\u4eec\u7ecf\u5e38\u8fc7\u5ea6\u5173\u6ce8\u670d\u52a1\u81ea\u8eab\u7684\u5404\u79cd\u6307\u6807\uff0c\u53cd\u800c\u5ffd\u7565\u4e86\u7f51\u7edc\u5c42\u9762\u7684\u4e00\u4e9b\u6d88\u8017\u3002 \u518d\u4e0b\u9762\u7684\u9762\u677f\u662f Client Workloads\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u540c\u7248\u672c\u7684\u8c03\u7528\u7aef\u670d\u52a1\u3001\u8bf7\u6c42\u7684\u9ec4\u91d1\u6307\u6807\uff0c\u5305\u62ec QPS\u3001\u5ef6\u65f6\u3001\u54cd\u5e94\u5927\u5c0f\u7b49 \u3002 \u6700\u540e\u7684\u9762\u677f\u662f Service Workloads\uff0c\u4e5f\u5c31\u662f\u5f53\u524d\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u540c\u6837\u5305\u542b\u4e86 QPS\u3001\u5ef6\u65f6\u3001\u54cd\u5e94\u5927\u5c0f\uff0c\u4ee5\u53ca TCP \u8fde\u63a5\u7b49\u4fe1\u606f\u3002 \u76f4\u63a5\u8bbf\u95ee http://localhost:3000/dashboard/db/istio-workload-dashboard \uff0c\u4e5f\u53ef\u4ee5\u70b9\u51fb istio-mesh-dashboard \u4e0a\u7684\u94fe\u63a5\u8bbf\u95ee\u3002 \u76f8\u5bf9\u4e8e istio-services-dashboard\uff0c\u8fd9\u4e2a\u9875\u9762\u6700\u5927\u7684\u4f18\u52bf\uff0c \u662f\u53ef\u4ee5\u770b\u5230 inbound\uff08\u5165\u6d41\u91cf\uff09\u548c outbound\uff08\u51fa\u6d41\u91cf\uff09\u4e24\u4e2a\u6d41\u91cf\u65b9\u5411\u7684\u76d1\u63a7\u4fe1\u606f \uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u9009\u4e2d reviews-v3 \u8fd9\u4e2a Workload\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u7684 inbound \u7684\u4fe1\u606f\uff0c\u4e5f\u5c31\u662f productpage-v1 \u8fd9\u4e2a\u8c03\u7528\u7aef\u8bbf\u95ee\u8fc7\u6765\u7684\u6d41\u91cf\uff1b \u4e5f\u53ef\u4ee5\u770b\u5230 review-v3 \u8bbf\u95ee\u51fa\u53bb\u7684\u6d41\u91cf\uff0c\u6d41\u91cf\u8def\u7531\u5230\u7684\u670d\u52a1\u662f ratings.default.svc.cluster.local \u3002 \u4ee5\u5ba2\u6237\u7aef\u7684\u89c6\u89d2\uff0c\u67e5\u770b\u670d\u52a1\u7684\u51fa\u6d41\u91cf\u5728\u5f88\u591a\u573a\u666f\u4e0b\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u5f88\u591a\u65f6\u5019\u6211\u4eec\u4e0d\u4ec5\u8981\u5173\u6ce8\u5176\u4ed6\u670d\u52a1\u8c03\u7528\u6211\u4eec\u670d\u52a1\u7684\u5065\u5eb7\u60c5\u51b5\uff0c\u4e5f\u8981\u5173\u6ce8\u6211\u4eec\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u7684\u5065\u5eb7\u72b6\u51b5\uff0c\u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\u4e8c\u8005\u662f\u606f\u606f\u76f8\u5173\u7684\u3002 Namespace \uff1a\u8fd9\u91cc\u548c\u4e0a\u9762 Services dashboard \u63d0\u5230\u7684 namespace \u662f\u540c\u4e00\u4e2a\u6982\u5ff5\u3002 Workload \uff1a\u6307\u7684\u662f\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u3002\u6bd4\u5982 reviews \u8fd9\u4e2a\u670d\u52a1\u5c31\u53ef\u4ee5\u9009\u62e9 v1\u3001v2\u3001v3 \u4e09\u4e2a\u7248\u672c\u3002 Inbound Workload \uff1a\u6307\u7684\u662f\u4e0d\u540c\u7248\u672c\u7684\u8c03\u7528\u65b9\u670d\u52a1\uff0c\u6bd4\u5982 review-v3 \u8fd9\u4e2a\u670d\u52a1\uff0c\u5c31\u53ef\u4ee5\u770b\u5230 productpage-v1 \u8fd9\u4e2a\u8c03\u7528\u65b9\u3002 Destination Service \uff1a\u6307\u7684\u662f\u5f53\u524d\u7248\u672c\u7684\u670d\u52a1\u8c03\u7528\u4e86\u54ea\u4e9b\u670d\u52a1\uff0c\u6bd4\u5982 review-v3 \u8fd9\u4e2a\u670d\u52a1\uff0c\u5c31\u53ef\u4ee5\u770b\u5230 ratings.default.svc.cluster.local \u8fd9\u4e2a\u88ab\u8c03\u65b9\u670d\u52a1\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u6765\u770b\u51e0\u4e2a\u9762\u677f\u5c55\u793a\u7684\u4fe1\u606f\u3002 WORKLOAD : reviews-v3.default\uff1a\u8fd9\u91cc\u5305\u542b\u4e86 review-v3 \u8fd9\u4e2a workload \u7684\u4e00\u4e9b\u57fa\u7840\u4fe1\u606f\uff0c\u5305\u542bQPS\u3001\u9519\u8bef\u7edf\u8ba1\u3001\u5ef6\u65f6\u7b49\u4fe1\u606f\u3002 INBOUND WORKLOAD \uff1a\u5c55\u793a\u4e86\u4e0d\u540c\u7684\u8c03\u7528\u65b9\u7684 workload \u7ef4\u5ea6\u7684\u57fa\u7840\u4fe1\u606f\u3002 OUTBOUND SERVICES \uff1a\u5c55\u793a\u4e86\u5f53\u524d\u670d\u52a1\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u7684\u76d1\u63a7\u4fe1\u606f\u3002 2\u3001Log \u65e5\u5fd7 \u65e5\u5fd7\u7684\u89c2\u6d4b\u76f8\u5bf9\u7b80\u5355\uff0c\u6211\u4eec\u8fd8\u662f\u8bbf\u95ee\u51e0\u6b21 productpage \u9875\u9762\uff0c\u901a\u8fc7\u547d\u4ee4\u67e5\u770b\uff1a \u00b7\u00b7\u00b7 $ kubectl logs productpage-v1-65576bb7bf-hj6mw -c Istio-proxy \u00b7\u00b7\u00b7 \u5728\u7ec8\u7aef\u4f1a\u770b\u5230\u5982\u4e0b\u8f93\u51fa\uff1a [2021-02-14T02:36:34.480Z] \"GET /details/0 HTTP/1.1\" 200 - \"-\" \"-\" 0 178 7 7 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36\" \"8b9abfac-215b-93d6-98b6-6c56b8eb14da\" \"details:9080\" \"172.18.0.15:9080\" outbound|9080||details.default.svc.cluster.local 172.18.0.20:45544 10.110.238.95:9080 172.18.0.20:48928 - default [2021-02-14T02:36:34.493Z] \"GET /reviews/0 HTTP/1.1\" 200 - \"-\" \"-\" 0 379 318 316 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36\" \"8b9abfac-215b-93d6-98b6-6c56b8eb14da\" \"reviews:9080\" \"172.18.0.14:9080\" outbound|9080|v2|reviews.default.svc.cluster.local 172.18.0.20:57886 10.107.87.91:9080 172.18.0.20:43118 - - [2021-02-14T02:36:34.473Z] \"GET /productpage HTTP/1.1\" 200 - \"-\" \"-\" 0 5292 344 343 \"172.17.0.2\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36\" \"8b9abfac-215b-93d6-98b6-6c56b8eb14da\" \"127.0.0.1\" \"127.0.0.1:9080\" inbound|9080|http|productpage.default.svc.cluster.local 127.0.0.1:52130 172.18.0.20:9080 172.17.0.2:0 outbound_.9080_._.productpage.default.svc.cluster.local default \u4f60\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u9762\u5305\u542b\u4e86 Envoy \u6536\u96c6\u7684\u8bbf\u95ee\u65e5\u5fd7\uff0c\u5305\u62ec\u8bbf\u95ee IP\u3001\u670d\u52a1\u540d\u3001user-agent \u7b49\u57fa\u672c\u4fe1\u606f\u3002\u5f53\u7136\u5982\u679c\u8981\u5206\u6790\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u4ec5\u4ec5\u901a\u8fc7\u547d\u4ee4\u67e5\u770b\u662f\u8fdc\u8fdc\u4e0d\u591f\u7684\uff0c \u6b64\u65f6\u6211\u4eec\u9700\u8981\u501f\u52a9 ELK \u8fd9\u6837\u7684\u5de5\u5177\u8fdb\u884c\u6536\u96c6\u548c\u5206\u6790 \u3002 3\u3001Trace \u94fe\u8def\u8ffd\u8e2a \u4ece\u4ee3\u7801\u5c42\u9762\u770b\u770b Istio \u662f\u5982\u4f55\u63a5\u5165 Trace \u7cfb\u7edf\u7684\u3002 \u867d\u7136\u7f51\u683c\u4ee3\u7406 Envoy \u80fd\u591f\u81ea\u52a8\u8bc6\u522b Trace \u4e2d\u7684 header\uff0c\u5728\u8bf7\u6c42 upstream \u7684\u65f6\u5019\u81ea\u52a8\u751f\u6210 span \u5e76\u643a\u5e26\u53d1\u9001\uff0c\u4f46\u662f\u5982\u679c\u8981\u5c06\u6574\u4e2a\u94fe\u8def\u8ffd\u8e2a\u4fe1\u606f\u4e32\u5728\u4e00\u8d77\uff0c\u8fd8\u9700\u8981\u4ee3\u7801\u4e2d\u989d\u5916\u643a\u5e26\u4e00\u4e9b\u94fe\u8def\u8ffd\u8e2a\u4fe1\u606f\u624d\u80fd\u5b8c\u6210\u3002 x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context \u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b Bookinfo \u4e2d\u7684 productpage \u8fd9\u4e2a\u9879\u76ee\u4ee3\u7801\uff0c\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002\u6e90\u7801\u7684\u5730\u5740\u4e3a https://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/productpage.py \u3002 \u9996\u5148\u6211\u4eec\u770b\u4e00\u4e0b\u5165\u53e3\u65b9\u6cd5\uff1a @app.route('/productpage') @trace() def front(): product_id = 0 # TODO: replace default value headers = getForwardHeaders(request) user = session.get('user', '') product = getProduct(product_id) detailsStatus, details = getProductDetails(product_id, headers) \u53ef\u4ee5\u770b\u5230\uff0c \u901a\u8fc7 getForwardHeaders \u65b9\u6cd5\uff0c\u6211\u4eec\u83b7\u53d6\u4e86\u5728\u8bf7\u6c42\u5176\u4ed6\u670d\u52a1\u65f6\u9700\u8981\u4f20\u9012\u7684 header \u53c2\u6570\uff0c\u5728 getProductDetails \u8c03\u7528\u7684\u65f6\u5019\uff0c\u4f20\u9012\u4e86\u6211\u4eec\u901a\u8fc7 getForwardHeaders \u65b9\u6cd5\u83b7\u5f97\u7684 header \u53c2\u6570 \u3002 \u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b\u4e0a\u8ff0\u5185\u5bb9\u5982\u4f55\u5728\u4ee3\u7801\u4e2d\u5f97\u4ee5\u4f53\u73b0\uff1a def getForwardHeaders(request): headers = {} # x-b3-*** \u901a\u8fc7 opentracing \u7684\u5e93\u76f4\u63a5\u83b7\u53d6 span = get_current_span() # \u83b7\u53d6 downstream header \u4e2d\u4f20\u9012\u7684 span carrier = {} tracer.inject( span_context=span.context, format=Format.HTTP_HEADERS, carrier=carrier) # \u5c06 trace header \u6ce8\u5165 carrier headers.update(carrier) # \u66f4\u65b0 headers # \u624b\u52a8\u83b7\u53d6\u5176\u4ed6\u975e x-b3-*** \u7684 header if 'user' in session: headers['end-user'] = session['user'] # Keep this in sync with the headers in details and reviews. incoming_headers = [ # All applications should propagate x-request-id. This header is # included in access log statements and is used for consistent trace # sampling and log sampling decisions in Istio. 'x-request-id', # Lightstep tracing header. Propagate this if you use lightstep tracing # in Istio (see # https://istio.io/latest/docs/tasks/observability/distributed-tracing/lightstep/) # Note: this should probably be changed to use B3 or W3C TRACE_CONTEXT. # Lightstep recommends using B3 or TRACE_CONTEXT and most application # libraries from lightstep do not support x-ot-span-context. 'x-ot-span-context', # Datadog tracing header. Propagate these headers if you use Datadog # tracing. 'x-datadog-trace-id', 'x-datadog-parent-id', 'x-datadog-sampling-priority', # W3C Trace Context. Compatible with OpenCensusAgent and Stackdriver Istio # configurations. 'traceparent', 'tracestate', # Cloud trace context. Compatible with OpenCensusAgent and Stackdriver Istio # configurations. 'x-cloud-trace-context', # Grpc binary trace context. Compatible with OpenCensusAgent nad # Stackdriver Istio configurations. 'grpc-trace-bin', # b3 trace headers. Compatible with Zipkin, OpenCensusAgent, and # Stackdriver Istio configurations. Commented out since they are # propagated by the OpenTracing tracer above. # 'x-b3-traceid', # 'x-b3-spanid', # 'x-b3-parentspanid', # 'x-b3-sampled', # 'x-b3-flags', # Application-specific headers to forward. 'user-agent', ] # For Zipkin, always propagate b3 headers. # For Lightstep, always propagate the x-ot-span-context header. # For Datadog, propagate the corresponding datadog headers. # For OpenCensusAgent and Stackdriver configurations, you can choose any # set of compatible headers to propagate within your application. For # example, you can propagate b3 headers or W3C trace context headers with # the same result. This can also allow you to translate between context # propagation mechanisms between different applications. # \u4f20\u9012\u5176\u4ed6\u975e b3 header \u7684\u5934\u4fe1\u606f for ihdr in incoming_headers: val = request.headers.get(ihdr) if val is not None: headers[ihdr] = val return headers \u53ef\u4ee5\u770b\u5230\uff0c\u901a\u8fc7 Jaeger \u7684\u7c7b\u5e93\uff0c \u81ea\u52a8\u5c06\u5e26\u6709 b3 header \u7684\u6570\u636e\u5b58\u50a8\u5230\u4e86 headers \u4e2d\uff0c\u5176\u4ed6\u7684\u4e00\u4e9b Trace \u89c4\u8303\uff0c\u5219\u9700\u8981\u901a\u8fc7 incoming_headers \u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u81ea\u52a8\u4f20\u9012 \u3002 \u81f3\u6b64\uff0c\u4ee3\u7801\u65b9\u9762\u7684\u539f\u7406\u544a\u4e00\u6bb5\u843d\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u542f\u52a8 Jaeger \u770b\u770b\u5177\u4f53\u7684\u6548\u679c\u3002 \u542f\u52a8 Jaeger\uff0c\u901a\u8fc7 URL \u6216\u8005 cURL \u7684\u65b9\u5f0f\u591a\u6b21\u8bbf\u95ee productpage\uff1a istioctl dashboard jaeger \u70b9\u51fb\u4e00\u6761\u5177\u4f53\u7684\u94fe\u8def\uff0c\u8fdb\u5165\u8be6\u60c5\u9875\u9762\uff0c\u53ef\u4ee5\u8be6\u7ec6\u5c55\u793a\u6574\u4e2a\u5fae\u670d\u52a1\u8c03\u7528\u7684\u94fe\u8def\uff0c\u5305\u542b\u6bcf\u4e2a\u9636\u6bb5\u8017\u65f6\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u65b9\u4fbf\u6211\u4eec\u6392\u67e5\u5177\u4f53\u54ea\u4e2a\u73af\u8282\u51fa\u73b0\u4e86\u95ee\u9898\uff1a \u70b9\u51fb\u4e00\u6761\u5177\u4f53\u7684\u94fe\u8def\uff0c\u8fdb\u5165\u8be6\u60c5\u9875\u9762\uff0c\u53ef\u4ee5\u8be6\u7ec6\u5c55\u793a\u6574\u4e2a\u5fae\u670d\u52a1\u8c03\u7528\u7684\u94fe\u8def\uff0c\u5305\u542b\u6bcf\u4e2a\u9636\u6bb5\u8017\u65f6\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u65b9\u4fbf\u6211\u4eec\u6392\u67e5\u5177\u4f53\u54ea\u4e2a\u73af\u8282\u51fa\u73b0\u4e86\u95ee\u9898\uff1a \u70b9\u51fb System Architecture \u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u6574\u4e2a\u5fae\u670d\u52a1\u7684\u8c03\u7528\u5173\u7cfb\u5c55\u793a\uff1a","title":"\u7b2c\u4e03\u8282 \u5982\u4f55\u5229\u7528\u7ec4\u4ef6\u505a\u5230\u670d\u52a1\u7684\u53ef\u89c2\u6d4b\u6027"},{"location":"chap2/7chap3_monitor/#_1","text":"","title":"\u7b2c\u4e03\u8282 \u5982\u4f55\u5229\u7528\u7ec4\u4ef6\u505a\u5230\u670d\u52a1\u7684\u53ef\u89c2\u6d4b\u6027"},{"location":"chap2/7chap3_monitor/#1metrics","text":"\u5728\u5f00\u59cb\u8fd9\u90e8\u5206\u5185\u5bb9\u4e4b\u524d\uff0c\u5148\u901a\u8fc7\u547d\u4ee4\u786e\u8ba4\u4f60\u662f\u5426\u5b89\u88c5\u4e86 Prometheus \u548c Grafana\uff1a $ kubectl -n istio-system get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.108.76.68 <none> 3000/TCP 92m istio-egressgateway ClusterIP 10.103.64.246 <none> 80/TCP,443/TCP,15443/TCP 26h istio-ingressgateway LoadBalancer 10.108.98.172 127.0.0.1 15021:31530/TCP,80:31636/TCP,443:31905/TCP,31400:31942/TCP,15443:32337/TCP 26h istiod ClusterIP 10.109.14.171 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP,853/TCP 26h kiali ClusterIP 10.110.51.251 <none> 20001/TCP,9090/TCP 92m prometheus ClusterIP 10.106.46.62 <none> 9090/TCP 92m tracing ClusterIP 10.100.200.122 <none> 80/TCP 92m zipkin ClusterIP 10.100.85.63 <none> 9411/TCP","title":"1\u3001Metrics \u6307\u6807"},{"location":"chap2/7chap3_monitor/#1-1-prometheus","text":"\u6211\u4eec\u5148\u6765\u542f\u52a8 Prometheus \u7684\u56fe\u5f62\u754c\u9762\uff1a istioctl dashboard prometheus \u8fd9\u4e2a\u547d\u4ee4\u4f1a\u5e2e\u6211\u4eec\u6253\u5f00 Prometheus \u7684 Web \u754c\u9762\uff0c\u5982\u4e0b\u56fe\uff1a Envoy \u7a81\u51fa\u7684 Metrics\uff0c\u5728 Prometheus \u4e2d\u67e5\u8be2 istio_requests_total{connection_security_policy!=\"mutual_tls\", destination_service=~\"reviews.default.svc.cluster.local\", reporter=\"source\"}[5m] \u5207\u6362\u5230 Console \u754c\u9762\uff0c\u53ef\u4ee5\u67e5\u770b\u4e00\u4e9b\u8f93\u51fa\u4fe1\u606f\uff0c\u8bf4\u660e\u4fe1\u606f\u88ab\u6b63\u786e\u91c7\u96c6\uff1a","title":"1-1 Prometheus"},{"location":"chap2/7chap3_monitor/#1-2-grafana","text":"Grafna \u7684\u542f\u52a8\u65b9\u5f0f\u4e5f\u5f88\u7b80\u5355\uff0c\u548c Prometheus \u7c7b\u4f3c\uff1a $ istioctl dashboard grafana Istio \u4e5f\u4e3a\u6211\u4eec\u81ea\u52a8\u5730\u5728\u672c\u5730\u6253\u5f00\u4e86 Grafana \u7684\u754c\u9762 \u8fd9\u91cc\u6211\u4eec\u9700\u8981\u624b\u52a8\u5728\u6d4f\u89c8\u5668\u8f93\u5165 http://localhost:3000/dashboard/db/Istio-mesh-dashboard \u5e76\u8bbf\u95ee\uff0c\u53ef\u4ee5\u76f4\u63a5\u770b\u5230 Istio \u7ba1\u7406\u7684\u670d\u52a1\u5217\u8868\u4fe1\u606f\u3002 \u53ef\u4ee5\u70b9\u51fb\u5230\u4efb\u610f\u94fe\u63a5\u8fdb\u5165\u5b50\u9875\u9762\uff0c\u4e0b\u9762\u6211\u4eec\u8fdb\u5165 Service \u9875\u9762\uff0c\u67e5\u770b\u67d0\u4e2a Service \u7684\u5177\u4f53\u4fe1\u606f\uff08 http://localhost:3000/d/LJ_uJAvmk/istio-service-dashboard?orgId=1&refresh=10s \uff09\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u754c\u9762\uff1a \u5728\u9875\u9762\u7684\u6700\u4e0a\u65b9\uff0c\u6709\u51e0\u4e2a\u9009\u9879\uff0c\u53ef\u4ee5\u9009\u62e9\u6211\u4eec\u9700\u8981\u7684\u53c2\u6570\u3002 Service \uff1a\u670d\u52a1\u540d\uff0c\u8fd9\u91cc\u7684\u670d\u52a1\u540d\u5c31\u662f\u6211\u4eec\u5728 Kubernetes \u4e2d\u8981\u8bbf\u95ee\u7684\u670d\u52a1\u540d\uff0c\u6bd4\u5982 details.default.svc.cluster.local \u3002Bookinfo \u8fd9\u4e2a\u9879\u76ee\u6240\u5305\u542b\u7684\u51e0\u4e2a\u5fae\u670d\u52a1\uff0c\u90fd\u53ef\u4ee5\u5728\u8fd9\u91cc\u9009\u62e9\u3002 Client Workload Namespace\uff08Or Service Workload Namespace\uff09 \uff1a\u8fd9\u91cc\u6307\u7684\u662f Kubernetes \u7684 namespace \u547d\u540d\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f\u670d\u52a1\u521b\u5efa\u5728\u4e86\u54ea\u4e2a\u547d\u540d\u7a7a\u95f4\u3002\u8fd9\u91cc\u5e94\u7528\u7c7b\u578b\u7684\u670d\u52a1\u90fd\u521b\u5efa\u5728\u4e86 default \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u53ea\u6709 istio-ingressgateway \u521b\u5efa\u4e86 istio-system \u7684\u547d\u540d\u7a7a\u95f4\u3002 Client Workload \uff1a\u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d Service \u7684 upstream\uff0c\u4e5f\u5c31\u662f Client \u8c03\u7528\u7aef\u3002 \u6211\u4eec\u9ed8\u8ba4\u9009\u4e2d\u4e86 details.default.svc.cluster.local \u8fd9\u4e2a\u670d\u52a1\uff0c\u67e5\u770b Client Workload \u7684\u4e0b\u62c9\u6846\u53ef\u4ee5\u770b\u5230 productpage-v1 \u7684\u9009\u9879\uff0c\u8fd9\u8bf4\u660e details.default.svc.cluster.local \u8fd9\u4e2a\u670d\u52a1\u7684\u6d41\u91cf\u6765\u6e90\u662f productpage \u7684 v1 \u7248\u672c\u3002\u5982\u679c\u8fd9\u91cc\u6709\u591a\u4e2a\u9009\u9879\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u9009\u4e2d\u5176\u4e2d\u4e00\u4e2a\u8fdb\u884c\u67e5\u770b\uff0c\u901a\u8fc7\u89c2\u5bdf\u4e0d\u540c\u7684\u6d41\u91cf\u6765\u6e90\uff0c\u5728\u51fa\u73b0\u95ee\u9898\u7684\u65f6\u5019\u53ef\u4ee5\u5f88\u597d\u5730\u533a\u5206\u5230\u5e95\u662f\u54ea\u4e2a\u6d41\u91cf\u6765\u6e90\u7684\u95ee\u9898\uff0c\u4fbf\u4e8e\u6392\u67e5\u95ee\u9898\u7684\u6839\u56e0\u3002 Istio \u8fd9\u6837\u7684 Service Mesh \u89e3\u51b3\u65b9\u6848\u5219\u6ca1\u6709\u8fd9\u6837\u7684\u56f0\u6270\uff0c \u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u63a7\u5236\u9762\u4e0b\u53d1\u5f53\u524d\u670d\u52a1\u7684\u670d\u52a1\u540d\uff0c\u8ba9 Sidecar \u5728 Metrics \u4e2d\u81ea\u52a8\u6ce8\u5165 \uff0c\u4e0d\u5141\u8bb8\u4e1a\u52a1\u4ee3\u7801\u7f16\u5199\u4eba\u5458\u4fee\u6539\u8fd9\u4e2a\u670d\u52a1\u540d\uff0c\u4ece\u800c\u5728\u6839\u672c\u4e0a\u675c\u7edd\u4e86\u8c03\u7528\u65b9\u670d\u52a1\u540d\u51fa\u9519\u7684\u95ee\u9898\u3002 Service Workload\uff1a\u8fd9\u91cc\u6211\u4eec\u9009\u4e2d reviews.default.svc.cluster.local \uff0c\u7136\u540e\u67e5\u770b Service Workload \u7684\u4e0b\u62c9\u6846\uff0c\u53ef\u4ee5\u770b\u5230\u4e09\u4e2a\u9009\u9879 review-v1\u3001reviews-v2\u3001reviews-v3\u3002\u8fd9\u91cc\u5176\u5b9e\u5c31\u662f reviews \u8fd9\u4e2a\u670d\u52a1\u7684\u4e09\u4e2a\u4e0d\u540c\u7248\u672c\uff0c\u53ef\u4ee5\u5206\u522b\u9009\u62e9\u8fd9\u4e09\u4e2a\u7248\u672c\u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u67e5\u770b\u76f8\u5e94\u7684\u76d1\u63a7\u4fe1\u606f\u3002 \u63a5\u4e0b\u6765\u5c55\u793a\u4e86 SERVICE: reviews.default.svc.cluster.local \u7684\u4e00\u4e9b\u5e38\u89c1\u4fe1\u606f\uff0c\u6bd4\u5982\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef\u8bf7\u6c42\u7684 QPS\u3001\u6210\u529f\u7387\u3001\u5ef6\u65f6\u7b49\u3002 \u8fd9\u91cc\u6240\u6709\u7684\u6307\u6807\u90fd\u6709\u4e24\u4e2a\u7ef4\u5ea6\uff0c \u4e00\u4e2a\u662f\u670d\u52a1\u7aef\u81ea\u8eab\u7684\uff0c\u4e00\u4e2a\u662fClient \u7aef\u7684 \uff0c\u76f8\u5bf9\u6765\u8bf4 Client \u7aef\u7684\u7edf\u8ba1\u66f4\u63a5\u8fd1\u670d\u52a1\u672c\u8eab\u7684\u8017\u65f6\uff0c\u56e0\u4e3a\u670d\u52a1\u81ea\u8eab\u7684\u7edf\u8ba1\u65e0\u6cd5\u628a\u7f51\u7edc\u6d88\u8017\u7edf\u8ba1\u5728\u5185\u3002\u5f88\u591a\u65f6\u5019\u6211\u4eec\u7ecf\u5e38\u8fc7\u5ea6\u5173\u6ce8\u670d\u52a1\u81ea\u8eab\u7684\u5404\u79cd\u6307\u6807\uff0c\u53cd\u800c\u5ffd\u7565\u4e86\u7f51\u7edc\u5c42\u9762\u7684\u4e00\u4e9b\u6d88\u8017\u3002 \u518d\u4e0b\u9762\u7684\u9762\u677f\u662f Client Workloads\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u540c\u7248\u672c\u7684\u8c03\u7528\u7aef\u670d\u52a1\u3001\u8bf7\u6c42\u7684\u9ec4\u91d1\u6307\u6807\uff0c\u5305\u62ec QPS\u3001\u5ef6\u65f6\u3001\u54cd\u5e94\u5927\u5c0f\u7b49 \u3002 \u6700\u540e\u7684\u9762\u677f\u662f Service Workloads\uff0c\u4e5f\u5c31\u662f\u5f53\u524d\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u540c\u6837\u5305\u542b\u4e86 QPS\u3001\u5ef6\u65f6\u3001\u54cd\u5e94\u5927\u5c0f\uff0c\u4ee5\u53ca TCP \u8fde\u63a5\u7b49\u4fe1\u606f\u3002 \u76f4\u63a5\u8bbf\u95ee http://localhost:3000/dashboard/db/istio-workload-dashboard \uff0c\u4e5f\u53ef\u4ee5\u70b9\u51fb istio-mesh-dashboard \u4e0a\u7684\u94fe\u63a5\u8bbf\u95ee\u3002 \u76f8\u5bf9\u4e8e istio-services-dashboard\uff0c\u8fd9\u4e2a\u9875\u9762\u6700\u5927\u7684\u4f18\u52bf\uff0c \u662f\u53ef\u4ee5\u770b\u5230 inbound\uff08\u5165\u6d41\u91cf\uff09\u548c outbound\uff08\u51fa\u6d41\u91cf\uff09\u4e24\u4e2a\u6d41\u91cf\u65b9\u5411\u7684\u76d1\u63a7\u4fe1\u606f \uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u9009\u4e2d reviews-v3 \u8fd9\u4e2a Workload\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u7684 inbound \u7684\u4fe1\u606f\uff0c\u4e5f\u5c31\u662f productpage-v1 \u8fd9\u4e2a\u8c03\u7528\u7aef\u8bbf\u95ee\u8fc7\u6765\u7684\u6d41\u91cf\uff1b \u4e5f\u53ef\u4ee5\u770b\u5230 review-v3 \u8bbf\u95ee\u51fa\u53bb\u7684\u6d41\u91cf\uff0c\u6d41\u91cf\u8def\u7531\u5230\u7684\u670d\u52a1\u662f ratings.default.svc.cluster.local \u3002 \u4ee5\u5ba2\u6237\u7aef\u7684\u89c6\u89d2\uff0c\u67e5\u770b\u670d\u52a1\u7684\u51fa\u6d41\u91cf\u5728\u5f88\u591a\u573a\u666f\u4e0b\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u5f88\u591a\u65f6\u5019\u6211\u4eec\u4e0d\u4ec5\u8981\u5173\u6ce8\u5176\u4ed6\u670d\u52a1\u8c03\u7528\u6211\u4eec\u670d\u52a1\u7684\u5065\u5eb7\u60c5\u51b5\uff0c\u4e5f\u8981\u5173\u6ce8\u6211\u4eec\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u7684\u5065\u5eb7\u72b6\u51b5\uff0c\u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\u4e8c\u8005\u662f\u606f\u606f\u76f8\u5173\u7684\u3002 Namespace \uff1a\u8fd9\u91cc\u548c\u4e0a\u9762 Services dashboard \u63d0\u5230\u7684 namespace \u662f\u540c\u4e00\u4e2a\u6982\u5ff5\u3002 Workload \uff1a\u6307\u7684\u662f\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u3002\u6bd4\u5982 reviews \u8fd9\u4e2a\u670d\u52a1\u5c31\u53ef\u4ee5\u9009\u62e9 v1\u3001v2\u3001v3 \u4e09\u4e2a\u7248\u672c\u3002 Inbound Workload \uff1a\u6307\u7684\u662f\u4e0d\u540c\u7248\u672c\u7684\u8c03\u7528\u65b9\u670d\u52a1\uff0c\u6bd4\u5982 review-v3 \u8fd9\u4e2a\u670d\u52a1\uff0c\u5c31\u53ef\u4ee5\u770b\u5230 productpage-v1 \u8fd9\u4e2a\u8c03\u7528\u65b9\u3002 Destination Service \uff1a\u6307\u7684\u662f\u5f53\u524d\u7248\u672c\u7684\u670d\u52a1\u8c03\u7528\u4e86\u54ea\u4e9b\u670d\u52a1\uff0c\u6bd4\u5982 review-v3 \u8fd9\u4e2a\u670d\u52a1\uff0c\u5c31\u53ef\u4ee5\u770b\u5230 ratings.default.svc.cluster.local \u8fd9\u4e2a\u88ab\u8c03\u65b9\u670d\u52a1\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u6765\u770b\u51e0\u4e2a\u9762\u677f\u5c55\u793a\u7684\u4fe1\u606f\u3002 WORKLOAD : reviews-v3.default\uff1a\u8fd9\u91cc\u5305\u542b\u4e86 review-v3 \u8fd9\u4e2a workload \u7684\u4e00\u4e9b\u57fa\u7840\u4fe1\u606f\uff0c\u5305\u542bQPS\u3001\u9519\u8bef\u7edf\u8ba1\u3001\u5ef6\u65f6\u7b49\u4fe1\u606f\u3002 INBOUND WORKLOAD \uff1a\u5c55\u793a\u4e86\u4e0d\u540c\u7684\u8c03\u7528\u65b9\u7684 workload \u7ef4\u5ea6\u7684\u57fa\u7840\u4fe1\u606f\u3002 OUTBOUND SERVICES \uff1a\u5c55\u793a\u4e86\u5f53\u524d\u670d\u52a1\u8bbf\u95ee\u5176\u4ed6\u670d\u52a1\u7684\u76d1\u63a7\u4fe1\u606f\u3002","title":"1-2 Grafana"},{"location":"chap2/7chap3_monitor/#2log","text":"\u65e5\u5fd7\u7684\u89c2\u6d4b\u76f8\u5bf9\u7b80\u5355\uff0c\u6211\u4eec\u8fd8\u662f\u8bbf\u95ee\u51e0\u6b21 productpage \u9875\u9762\uff0c\u901a\u8fc7\u547d\u4ee4\u67e5\u770b\uff1a \u00b7\u00b7\u00b7 $ kubectl logs productpage-v1-65576bb7bf-hj6mw -c Istio-proxy \u00b7\u00b7\u00b7 \u5728\u7ec8\u7aef\u4f1a\u770b\u5230\u5982\u4e0b\u8f93\u51fa\uff1a [2021-02-14T02:36:34.480Z] \"GET /details/0 HTTP/1.1\" 200 - \"-\" \"-\" 0 178 7 7 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36\" \"8b9abfac-215b-93d6-98b6-6c56b8eb14da\" \"details:9080\" \"172.18.0.15:9080\" outbound|9080||details.default.svc.cluster.local 172.18.0.20:45544 10.110.238.95:9080 172.18.0.20:48928 - default [2021-02-14T02:36:34.493Z] \"GET /reviews/0 HTTP/1.1\" 200 - \"-\" \"-\" 0 379 318 316 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36\" \"8b9abfac-215b-93d6-98b6-6c56b8eb14da\" \"reviews:9080\" \"172.18.0.14:9080\" outbound|9080|v2|reviews.default.svc.cluster.local 172.18.0.20:57886 10.107.87.91:9080 172.18.0.20:43118 - - [2021-02-14T02:36:34.473Z] \"GET /productpage HTTP/1.1\" 200 - \"-\" \"-\" 0 5292 344 343 \"172.17.0.2\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36\" \"8b9abfac-215b-93d6-98b6-6c56b8eb14da\" \"127.0.0.1\" \"127.0.0.1:9080\" inbound|9080|http|productpage.default.svc.cluster.local 127.0.0.1:52130 172.18.0.20:9080 172.17.0.2:0 outbound_.9080_._.productpage.default.svc.cluster.local default \u4f60\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u9762\u5305\u542b\u4e86 Envoy \u6536\u96c6\u7684\u8bbf\u95ee\u65e5\u5fd7\uff0c\u5305\u62ec\u8bbf\u95ee IP\u3001\u670d\u52a1\u540d\u3001user-agent \u7b49\u57fa\u672c\u4fe1\u606f\u3002\u5f53\u7136\u5982\u679c\u8981\u5206\u6790\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u4ec5\u4ec5\u901a\u8fc7\u547d\u4ee4\u67e5\u770b\u662f\u8fdc\u8fdc\u4e0d\u591f\u7684\uff0c \u6b64\u65f6\u6211\u4eec\u9700\u8981\u501f\u52a9 ELK \u8fd9\u6837\u7684\u5de5\u5177\u8fdb\u884c\u6536\u96c6\u548c\u5206\u6790 \u3002","title":"2\u3001Log \u65e5\u5fd7"},{"location":"chap2/7chap3_monitor/#3trace","text":"\u4ece\u4ee3\u7801\u5c42\u9762\u770b\u770b Istio \u662f\u5982\u4f55\u63a5\u5165 Trace \u7cfb\u7edf\u7684\u3002 \u867d\u7136\u7f51\u683c\u4ee3\u7406 Envoy \u80fd\u591f\u81ea\u52a8\u8bc6\u522b Trace \u4e2d\u7684 header\uff0c\u5728\u8bf7\u6c42 upstream \u7684\u65f6\u5019\u81ea\u52a8\u751f\u6210 span \u5e76\u643a\u5e26\u53d1\u9001\uff0c\u4f46\u662f\u5982\u679c\u8981\u5c06\u6574\u4e2a\u94fe\u8def\u8ffd\u8e2a\u4fe1\u606f\u4e32\u5728\u4e00\u8d77\uff0c\u8fd8\u9700\u8981\u4ee3\u7801\u4e2d\u989d\u5916\u643a\u5e26\u4e00\u4e9b\u94fe\u8def\u8ffd\u8e2a\u4fe1\u606f\u624d\u80fd\u5b8c\u6210\u3002 x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context \u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b Bookinfo \u4e2d\u7684 productpage \u8fd9\u4e2a\u9879\u76ee\u4ee3\u7801\uff0c\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002\u6e90\u7801\u7684\u5730\u5740\u4e3a https://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/productpage.py \u3002 \u9996\u5148\u6211\u4eec\u770b\u4e00\u4e0b\u5165\u53e3\u65b9\u6cd5\uff1a @app.route('/productpage') @trace() def front(): product_id = 0 # TODO: replace default value headers = getForwardHeaders(request) user = session.get('user', '') product = getProduct(product_id) detailsStatus, details = getProductDetails(product_id, headers) \u53ef\u4ee5\u770b\u5230\uff0c \u901a\u8fc7 getForwardHeaders \u65b9\u6cd5\uff0c\u6211\u4eec\u83b7\u53d6\u4e86\u5728\u8bf7\u6c42\u5176\u4ed6\u670d\u52a1\u65f6\u9700\u8981\u4f20\u9012\u7684 header \u53c2\u6570\uff0c\u5728 getProductDetails \u8c03\u7528\u7684\u65f6\u5019\uff0c\u4f20\u9012\u4e86\u6211\u4eec\u901a\u8fc7 getForwardHeaders \u65b9\u6cd5\u83b7\u5f97\u7684 header \u53c2\u6570 \u3002 \u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b\u4e0a\u8ff0\u5185\u5bb9\u5982\u4f55\u5728\u4ee3\u7801\u4e2d\u5f97\u4ee5\u4f53\u73b0\uff1a def getForwardHeaders(request): headers = {} # x-b3-*** \u901a\u8fc7 opentracing \u7684\u5e93\u76f4\u63a5\u83b7\u53d6 span = get_current_span() # \u83b7\u53d6 downstream header \u4e2d\u4f20\u9012\u7684 span carrier = {} tracer.inject( span_context=span.context, format=Format.HTTP_HEADERS, carrier=carrier) # \u5c06 trace header \u6ce8\u5165 carrier headers.update(carrier) # \u66f4\u65b0 headers # \u624b\u52a8\u83b7\u53d6\u5176\u4ed6\u975e x-b3-*** \u7684 header if 'user' in session: headers['end-user'] = session['user'] # Keep this in sync with the headers in details and reviews. incoming_headers = [ # All applications should propagate x-request-id. This header is # included in access log statements and is used for consistent trace # sampling and log sampling decisions in Istio. 'x-request-id', # Lightstep tracing header. Propagate this if you use lightstep tracing # in Istio (see # https://istio.io/latest/docs/tasks/observability/distributed-tracing/lightstep/) # Note: this should probably be changed to use B3 or W3C TRACE_CONTEXT. # Lightstep recommends using B3 or TRACE_CONTEXT and most application # libraries from lightstep do not support x-ot-span-context. 'x-ot-span-context', # Datadog tracing header. Propagate these headers if you use Datadog # tracing. 'x-datadog-trace-id', 'x-datadog-parent-id', 'x-datadog-sampling-priority', # W3C Trace Context. Compatible with OpenCensusAgent and Stackdriver Istio # configurations. 'traceparent', 'tracestate', # Cloud trace context. Compatible with OpenCensusAgent and Stackdriver Istio # configurations. 'x-cloud-trace-context', # Grpc binary trace context. Compatible with OpenCensusAgent nad # Stackdriver Istio configurations. 'grpc-trace-bin', # b3 trace headers. Compatible with Zipkin, OpenCensusAgent, and # Stackdriver Istio configurations. Commented out since they are # propagated by the OpenTracing tracer above. # 'x-b3-traceid', # 'x-b3-spanid', # 'x-b3-parentspanid', # 'x-b3-sampled', # 'x-b3-flags', # Application-specific headers to forward. 'user-agent', ] # For Zipkin, always propagate b3 headers. # For Lightstep, always propagate the x-ot-span-context header. # For Datadog, propagate the corresponding datadog headers. # For OpenCensusAgent and Stackdriver configurations, you can choose any # set of compatible headers to propagate within your application. For # example, you can propagate b3 headers or W3C trace context headers with # the same result. This can also allow you to translate between context # propagation mechanisms between different applications. # \u4f20\u9012\u5176\u4ed6\u975e b3 header \u7684\u5934\u4fe1\u606f for ihdr in incoming_headers: val = request.headers.get(ihdr) if val is not None: headers[ihdr] = val return headers \u53ef\u4ee5\u770b\u5230\uff0c\u901a\u8fc7 Jaeger \u7684\u7c7b\u5e93\uff0c \u81ea\u52a8\u5c06\u5e26\u6709 b3 header \u7684\u6570\u636e\u5b58\u50a8\u5230\u4e86 headers \u4e2d\uff0c\u5176\u4ed6\u7684\u4e00\u4e9b Trace \u89c4\u8303\uff0c\u5219\u9700\u8981\u901a\u8fc7 incoming_headers \u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u81ea\u52a8\u4f20\u9012 \u3002 \u81f3\u6b64\uff0c\u4ee3\u7801\u65b9\u9762\u7684\u539f\u7406\u544a\u4e00\u6bb5\u843d\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u542f\u52a8 Jaeger \u770b\u770b\u5177\u4f53\u7684\u6548\u679c\u3002 \u542f\u52a8 Jaeger\uff0c\u901a\u8fc7 URL \u6216\u8005 cURL \u7684\u65b9\u5f0f\u591a\u6b21\u8bbf\u95ee productpage\uff1a istioctl dashboard jaeger \u70b9\u51fb\u4e00\u6761\u5177\u4f53\u7684\u94fe\u8def\uff0c\u8fdb\u5165\u8be6\u60c5\u9875\u9762\uff0c\u53ef\u4ee5\u8be6\u7ec6\u5c55\u793a\u6574\u4e2a\u5fae\u670d\u52a1\u8c03\u7528\u7684\u94fe\u8def\uff0c\u5305\u542b\u6bcf\u4e2a\u9636\u6bb5\u8017\u65f6\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u65b9\u4fbf\u6211\u4eec\u6392\u67e5\u5177\u4f53\u54ea\u4e2a\u73af\u8282\u51fa\u73b0\u4e86\u95ee\u9898\uff1a \u70b9\u51fb\u4e00\u6761\u5177\u4f53\u7684\u94fe\u8def\uff0c\u8fdb\u5165\u8be6\u60c5\u9875\u9762\uff0c\u53ef\u4ee5\u8be6\u7ec6\u5c55\u793a\u6574\u4e2a\u5fae\u670d\u52a1\u8c03\u7528\u7684\u94fe\u8def\uff0c\u5305\u542b\u6bcf\u4e2a\u9636\u6bb5\u8017\u65f6\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u65b9\u4fbf\u6211\u4eec\u6392\u67e5\u5177\u4f53\u54ea\u4e2a\u73af\u8282\u51fa\u73b0\u4e86\u95ee\u9898\uff1a \u70b9\u51fb System Architecture \u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u6574\u4e2a\u5fae\u670d\u52a1\u7684\u8c03\u7528\u5173\u7cfb\u5c55\u793a\uff1a","title":"3\u3001Trace \u94fe\u8def\u8ffd\u8e2a"},{"location":"chap2/8chap3_SM_GO_PROJ/","text":"\u7b2c\u516b\u8282 Proj\u9879\u76ee\u843d\u5730: Go \u5b9e\u73b0 Service Mesh 1\u3001\u9879\u76ee\u80cc\u666f\uff1a\u5224\u65ad\u9009\u62e9\u5f00\u6e90\u4ea7\u54c1\u8fd8\u662f\u81ea\u7814 1-1 \u9879\u76ee\u80cc\u666f \u5165\u53e3\u5c42\u7f3a\u4e4f\u7edf\u4e00\u7684\u7cfb\u7edf\u7f51\u5173 \uff1a\u591a\u4e2a\u670d\u52a1\u540c\u65f6\u5bf9\u5916\u66b4\u9732\uff0c\u65e0\u6cd5\u8fdb\u884c\u7edf\u4e00\u7684\u767b\u5f55\u9a8c\u8bc1\u3001\u52a0/\u89e3\u5bc6\u7b49\u529f\u80fd\uff0c\u53ea\u80fd\u5728\u5404\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u670d\u52a1\u4e2d\u5355\u72ec\u5b9e\u73b0\uff0c\u65e0\u6cd5\u8fdb\u884c\u7edf\u4e00\u7684\u7ef4\u62a4\u3002 \u5b58\u5728\u96ea\u5d29\u73b0\u8c61 \uff1a\u67d0\u4e00\u4e2a\u6838\u5fc3\u5fae\u670d\u52a1\u51fa\u73b0\u6545\u969c\u540e\uff0c\u5bfc\u81f4\u7ea7\u8054\u6545\u969c\uff0c\u4f9d\u8d56\u7684\u670d\u52a1\u56e0\u4e3a\u54cd\u5e94\u5ef6\u65f6\u53d8\u9ad8\uff0c\u90fd\u5c06\u51fa\u73b0\u6545\u969c\uff0c\u6700\u7ec8\u5bfc\u81f4\u6574\u7ad9\u6545\u969c\u3002 \u65e0\u6cd5\u5904\u7406\u7a81\u53d1\u6d41\u91cf \uff1a\u5f88\u591a\u65f6\u5019\u56e0\u4e3a\u8fd0\u8425\u6d3b\u52a8\uff0c\u524d\u671f\u6ca1\u6709\u914d\u5408\u63d0\u524d\u6269\u5bb9\u8d44\u6e90, \u5bfc\u81f4\u670d\u52a1\u88ab\u7a81\u53d1\u6d41\u91cf\u6253\u6302\u3002 \u5185\u90e8\u901a\u8fc7\u5185\u7f51\u96c6\u4e2d\u7f51\u5173\u8c03\u7528 \uff1a\u5185\u90e8\u901a\u8fc7\u7edf\u4e00\u7684\u7f51\u5173\u8c03\u7528\uff0c\u4e00\u65e6\u5185\u90e8\u96c6\u4e2d\u7f51\u5173\u51fa\u73b0\u95ee\u9898\uff0c\u5bfc\u81f4\u6240\u6709\u670d\u52a1\u51fa\u73b0\u6545\u969c\uff0c\u7ee7\u800c\u5f15\u8d77\u6574\u7ad9\u6545\u969c\u3002 \u9879\u76ee\u53ef\u89c2\u6d4b\u6027\u4e0d\u8db3\uff0c\u95ee\u9898\u6392\u67e5\u56f0\u96be \uff1a\u5404\u4e2a\u670d\u52a1\u81ea\u5df1\u5b9e\u73b0\u76d1\u63a7\u6307\u6807\uff0c\u6ca1\u6709\u7edf\u4e00\u7684\u76d1\u63a7\uff0c\u968f\u7740\u670d\u52a1\u6570\u91cf\u589e\u591a\uff0c\u95ee\u9898\u8d8a\u6765\u8d8a\u96be\u4ee5\u6392\u67e5\u3002 \u8c03\u7814\u4ee5\u4e0b\u51e0\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u5305\u62ec\u5fae\u670d\u52a1\u6846\u67b6\u3001\u5f00\u6e90 Service Mesh \u65b9\u6848\u3001\u81ea\u7814 Service Mesh \u65b9\u6848 \u5176\u4e2d\u5fae\u670d\u52a1\u6846\u67b6\u9700\u8981\u518d\u5f15\u5165\u4e00\u4e2a\u5f00\u6e90\u7cfb\u7edf\u7f51\u5173\u6216\u8005\u7528\u6846\u67b6\u5b9e\u73b0\u805a\u5408\u5c42 \u3002 1-2 \u6280\u672f\u9009\u578b \u5fae\u670d\u52a1\u6846\u67b6 \u5fae\u670d\u52a1\u6846\u67b6\u5728 Web \u6846\u67b6\u7684\u57fa\u7840\u4e0a\uff0c\u589e\u52a0\u4e86\u670d\u52a1\u6cbb\u7406\u3001\u6ce8\u518c\u53d1\u73b0\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u8d1f\u8f7d\u5747\u8861\u3001RPC \u7b49\u591a\u79cd\u529f\u80fd\uff0c\u76ee\u7684\u662f\u63d0\u9ad8\u5fae\u670d\u52a1\u67b6\u6784\u7684\u7a33\u5b9a\u6027 \u4f18\u70b9 \u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u76f4\u63a5\u8c03\u7528 upstream \u670d\u52a1\uff0c\u65e0\u987b\u7ecf\u8fc7\u4e2d\u95f4\u4ee3\u7406\u5c42\uff0c\u6027\u80fd\u9ad8\uff1b \u5fae\u670d\u52a1\u6846\u67b6\u76f8\u5bf9\u6bd4\u8f83\u6210\u719f\u3002 \u7f3a\u70b9\uff1a \u6846\u67b6\u7ef4\u62a4\u5347\u7ea7\u6210\u672c\u9ad8\uff0c\u5fae\u670d\u52a1\u7684\u62c6\u5206\u4f1a\u5bfc\u81f4\u670d\u52a1\u6570\u91cf\u975e\u5e38\u591a\uff0c\u4e00\u65e6\u6846\u67b6\u53d1\u5e03\uff0c\u540e\u7eed\u5347\u7ea7\u51e0\u4e4e\u4e0d\u53ef\u80fd\u5b8c\u6210\uff1b \u65e7\u670d\u52a1\u63a5\u5165\u56f0\u96be\uff0c\u4fee\u6539\u4ee3\u7801\u6210\u672c\u9ad8\uff1b \u8bed\u8a00\u76f8\u5173\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u53ea\u80fd\u7ef4\u62a4\u4e00\u79cd\u8bed\u8a00\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u5bf9\u4e8e\u5c0f\u4f17\u8bed\u8a00\u65e0\u6cd5\u652f\u6301\u3002 \u603b\u7ed3\uff1a\u76f8\u5bf9\u6765\u8bf4 Go \u8bed\u8a00\u7684\u5fae\u670d\u52a1\u6846\u67b6\u5e76\u4e0d\u7b97\u4e30\u5bcc\uff0c\u66f4\u591a\u6846\u67b6\u8fd8\u505c\u7559\u5728 Web \u65b9\u9762\uff0c\u6bd4\u5982 Gin\u3001Echo \u90fd\u662f\u51fa\u8272\u7684 Web \u6846\u67b6\u3002\u5982\u679c\u662f\u65b0\u9879\u76ee\uff0c\u5fae\u670d\u52a1\u6846\u67b6 go-zero \u662f\u76f8\u5bf9\u4e0d\u9519\u7684\u9009\u62e9\u3002 1-2 \u5f00\u6e90 Service Mesh \u65b9\u6848 \u4f18\u70b9\uff1a \u76f8\u5bf9\u4e8e\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u901a\u8fc7\u548c\u4e1a\u52a1\u67b6\u6784\u89e3\u8026\u7684\u65b9\u5f0f\uff0c\u964d\u4f4e\u4e86\u5347\u7ea7\u7ef4\u62a4\u7684\u6210\u672c\uff1b \u65b0\u65e7\u670d\u52a1\u63a5\u5165\u540c\u6837\u7b80\u5355\uff0c\u53ef\u4ee5\u901a\u8fc7 iptables \u7f51\u7edc\u52ab\u6301\u65e0\u611f\u77e5\u65b9\u5f0f\u63a5\u5165\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u5c11\u91cf\u4ee3\u7801\u652f\u6301\uff1b \u8bed\u8a00\u65e0\u5173\u6027\uff0c\u516c\u53f8\u7684\u5c0f\u4f17\u8bed\u8a00\u4e5f\u53ef\u4ee5\u5f88\u597d\u5730\u652f\u6301\uff1b \u53ef\u4ee5\u6301\u7eed\u8ddf\u8fdb\u793e\u533a\u65b9\u6848\uff0c\u83b7\u5f97\u793e\u533a\u7684\u6700\u65b0\u6210\u679c\uff1b \u9879\u76ee\u542f\u52a8\u5feb\uff0c\u4e0d\u9700\u8981\u7814\u53d1\uff0c\u53ea\u9700\u8981\u505a\u597d\u6d4b\u8bd5\u3002 \u7f3a\u70b9\uff1a \u4ee3\u7801\u4e8c\u6b21\u6269\u5c55\u96be\u5ea6\u6bd4\u8f83\u5927\uff0c\u9700\u8981\u7279\u5b9a\u7684\u8bed\u8a00\u5f00\u53d1\u7ecf\u9a8c\uff0c\u516c\u53f8\u4e2a\u6027\u5316\u7684\u9700\u6c42\u65e0\u6cd5\u6ee1\u8db3\uff1b \u5f00\u6e90\u8f6f\u4ef6\u5f80\u5f80\u7248\u672c\u53d8\u5316\u6bd4\u8f83\u5927\uff0c\u5411\u524d\u517c\u5bb9\u6027\u6bd4\u8f83\u5dee\uff0c\u5982\u679c\u60f3\u8981\u7ef4\u62a4\u5347\u7ea7\uff0c\u4e5f\u9700\u8981\u5bf9\u6e90\u7801\u6709\u4e00\u5b9a\u7684\u638c\u63e1\uff0c\u5426\u5219\u5347\u7ea7\u98ce\u9669\u6bd4\u8f83\u5927\u3002 1-3 \u81ea\u7814 Service Mesh \u65b9\u6848 \u81ea\u7814 Service Mesh \u65b9\u6848\u5206\u4e3a\u4e24\u79cd\uff0c \u4e00\u79cd\u662f\u6570\u636e\u9762 Sidecar \u548c\u63a7\u5236\u9762\u5168\u90e8\u81ea\u7814\uff0c\u53e6\u5916\u4e00\u79cd\u662f\u4f7f\u7528\u5f00\u6e90\u6570\u636e\u9762\uff0c\u4f46\u662f\u81ea\u7814\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\u63a7\u5236\u9762 \u3002 1-4 \u5b8c\u5168\u81ea\u7814 \u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u5b8c\u5168\u81ea\u7814\u7684\u65b9\u6848\u3002 \u4f18\u70b9\uff1a \u5177\u5907\u5f00\u6e90 Service Mesh \u65b9\u6848\u76f8\u5bf9\u4e8e\u5fae\u670d\u52a1\u6846\u67b6\u7684\u4f18\u52bf\uff1b \u53ef\u6269\u5c55\u6027\u5f3a\uff0c\u53ef\u4ee5\u517c\u5bb9\u516c\u53f8\u8fd0\u7ef4\u73af\u5883\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u5b9a\u5236\u578b\u9700\u6c42\uff0c\u6bd4\u5982\u65b0\u7684 RPC \u534f\u8bae\u652f\u6301\u3001\u591a\u534f\u8bae\u670d\u52a1\u6cbb\u7406\u3001\u65b0\u7684\u8d1f\u8f7d\u5747\u8861\u652f\u6301\u7b49\uff1b \u9879\u76ee\u628a\u63a7\u529b\u5f3a\uff0c\u51fa\u73b0\u95ee\u9898\u53ef\u4ee5\u5feb\u901f\u89e3\u51b3 \u7f3a\u70b9\uff1a \u7814\u53d1\u6210\u672c\u9ad8\uff0c\u9700\u8981\u4e00\u5b9a\u7684\u7814\u53d1\u65f6\u95f4\uff0c\u4e0a\u7ebf\u7070\u5ea6\u5230\u7a33\u5b9a\u7248\u672c\u4e5f\u9700\u8981\u65f6\u95f4\uff0c\u5728\u7070\u5ea6\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u4f1a\u6709 Bug \u51fa\u73b0\uff1b \u548c\u793e\u533a\u6709\u4e00\u5b9a\u7684\u5272\u88c2\u3002 1-5 \u5f00\u6e90\u6570\u636e\u9762+\u81ea\u7814\u63a7\u5236\u9762 \u76f4\u63a5\u4f7f\u7528 \u5f00\u6e90\u63a7\u5236\u9762\u65b9\u6848\u57fa\u672c\u4e0a\u65e0\u6cd5\u6ee1\u8db3\u63a7\u5236\u9762\u4e2a\u6027\u7684\u9700\u6c42 \uff0c\u6bd4\u5982\u7b2c\u4e09\u65b9\u6ce8\u518c\u4e2d\u5fc3\u7684\u652f\u6301\u3001\u865a\u62df\u673a\u73af\u5883\u7684\u652f\u6301\u7b49 \u4f18\u70b9\uff1a \u53ef\u4ee5\u6ee1\u8db3\u516c\u53f8\u591a\u6837\u7684\u8fd0\u7ef4\u73af\u5883\uff1b \u63a7\u5236\u9762\u81ea\u7814\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\uff0c\u6709\u4e00\u5b9a\u7684\u5b9a\u5236\u6027\u3002 \u7f3a\u70b9\uff1a \u6570\u636e\u9762 Sidecar \u4f9d\u7136\u6709\u5f00\u6e90\u65b9\u6848\u7684\u5f0a\u7aef\u3002 \u9996\u5148\u4e8e\u6570\u636e\u9762\u65e0\u6cd5\u5b9a\u5236\uff0c\u5176\u6b21\u5bf9\u4e8e\u63a7\u5236\u9762\u80fd\u505a\u7684\u8054\u52a8\u6709\u4e00\u5b9a\u7684\u5c40\u9650\u6027\u3002 1-6 \u6280\u672f\u5b9e\u73b0 \u529f\u80fd\u70b9 \u6570\u636e\u9762 Sidecar\uff1a \u5b9e\u73b0\u57fa\u7840\u6846\u67b6\uff0c\u80fd\u591f\u4ee3\u7406 HTTP \u534f\u8bae\uff0c\u5e76\u5177\u5907\u6269\u5c55\u6027\uff1b \u652f\u6301\u9650\u6d41\u3001\u7194\u65ad\u7b49\u670d\u52a1\u6cbb\u7406\u4e2d\u95f4\u4ef6\uff1b \u652f\u6301\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\uff0c\u5305\u62ec Log\u3001Trace \u548c Metrics\uff1b \u652f\u6301\u670d\u52a1\u6ce8\u518c\u548c\u53d1\u73b0\uff0c\u80fd\u591f\u4ee3\u7406\u4e1a\u52a1\u670d\u52a1\u8fdb\u884c\u6ce8\u518c\uff1b \u901a\u8fc7 xDS \u548c\u63a7\u5236\u9762\u901a\u4fe1\u3002 \u63a7\u5236\u9762\uff1a \u540c\u65f6\u517c\u5bb9\u865a\u62df\u673a\u548c Kubernetes\uff0c\u548c\u516c\u53f8\u73b0\u6709\u7684 CMDB \u7cfb\u7edf\u6253\u901a\uff0c\u540c\u6b65\u673a\u5668\u5143\u6570\u636e\u3002 \u652f\u6301 xDS \u534f\u8bae\uff0c\u517c\u5bb9\u73b0\u6709\u7684\u3001\u91c7\u7528 xDS \u534f\u8bae\u7684\u6570\u636e\u9762\u3002 \u6280\u672f\u9009\u578b Go-Micro \u6846\u67b6\u5b8c\u5168\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u6570\u636e\u9762 Sidecar \u7684\u9700\u6c42\uff0c\u5176\u672c\u8eab\u4e5f\u652f\u6301\u4e86\u591a\u79cd\u534f\u8bae\u3002\uff08Go-Micro \u9879\u76ee\u5730\u5740https://github.com/asim/go-micro\uff09 \u63a7\u5236\u9762 Envoy \u4e5f\u63d0\u4f9b\u4e86\u57fa\u7840\u6846\u67b6\uff0c\u4e3a\u4e86\u964d\u4f4e\u590d\u6742\u5ea6\uff0c\u6211\u4eec\u4e0d\u4f7f\u7528 Istio \u4e8c\u6b21\u5f00\u53d1\uff0c\u76f4\u63a5\u7528 Envoy \u63d0\u4f9b\u7684\u63a7\u5236\u9762\u57fa\u7840\u6846\u67b6\u6765\u5f00\u53d1\u3002\uff08\u5730\u5740\u4e3ahttps://github.com/envoyproxy/go-control-plane\uff09 2\u3001\u6570\u636e\u9762\uff1a\u57fa\u4e8e Go-Micro \u5feb\u901f\u5b9e\u73b0\u4ee3\u7406\u6a21\u5757 \u5728\u5e38\u89c1\u7684\u5f00\u6e90\u6570\u636e\u9762\u4e2d\uff0cEnvoy \u4f7f\u7528 C++ \u5b9e\u73b0\uff0cLinkerd \u65e9\u671f\u7248\u672c\u4f7f\u7528 Java\uff0c\u65b0\u7248\u672c\u4f7f\u7528 Rust \u5b9e\u73b0\uff0c\u800c MOSN \u548c Maesh \u90fd\u4f7f\u7528 Go \u8bed\u8a00\u5b9e\u73b0\u3002\u4ece\u8fd9\u4e9b\u6280\u672f\u9009\u578b\u53ef\u4ee5\u770b\u51fa\uff0c Go \u8bed\u8a00\u5728\u6570\u636e\u9762\u7684\u5b9e\u73b0\u4e2d\u5360\u6709\u4e00\u5e2d\u4e4b\u5730\uff0c\u4e3b\u8981\u662f\u8f83\u9ad8\u7684\u6027\u80fd\u548c\u8f83\u5c11\u7684\u5185\u5b58\u5360\u7528\uff0c\u6bd4\u8f83\u9002\u5408 Sidecar \u7684\u5e94\u7528\u573a\u666f\u3002 \u4e3a\u4e86\u5feb\u901f\u5b9e\u73b0\uff0c\u6211\u4eec\u4f7f\u7528\u4e86 Go-micro \u6846\u67b6\uff0c\u8fd9\u4e2a\u6846\u67b6\u6709\u975e\u5e38\u597d\u7684\u62bd\u8c61\u5c42\uff0c\u652f\u6301 MUCP\u3001gRPC\u3001HTTP \u7b49\u534f\u8bae\u7684\u539f\u751f\u4ee3\u7406\uff0c\u540e\u671f\u4e5f\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u6269\u5c55\u534f\u8bae\u5c42\u3002 https://github.com/beck917/easymesh 2-1 \u73af\u5883\u5b89\u88c5&\u6846\u67b6\u642d\u5efa \u9996\u5148\u8fdb\u5165 Go \u8bed\u8a00\u5b98\u7f51\uff0c\u6839\u636e\u73af\u5883\u4e0b\u8f7d\u5408\u9002\u7684\u7248\u672c https://golang.google.cn/dl/ \uff0c\u56e0\u4e3a Go-Micro \u7684\u65e7\u7248\u672c\u4f9d\u8d56\u95ee\u9898\uff0c\u8fd9\u91cc\u6211\u4eec\u9009\u62e9 Go 1.14 \u7248\u672c\u3002 2-2 \u4ee3\u7801\u89e3\u6790 \u9996\u5148\u6211\u4eec\u770b\u4e00\u4e0b main \u65b9\u6cd5\uff0c\u8fd9\u91cc\u521b\u5efa\u4e86\u4e24\u4e2a\u4ee3\u7406\u670d\u52a1\u5668\uff0c \u5206\u522b\u662f\u76d1\u542c 8082 \u7aef\u53e3\u7684\u51fa\u6d41\u91cf\u4ee3\u7406\u548c\u76d1\u542c 8083 \u7aef\u53e3\u7684 8083 \u670d\u52a1 \uff1a func main() { http.HandleFunc(\"/\", indexHandler) go http.ListenAndServe(\":6060\", nil) // start the client proxy go proxy.Run(&proxy.ServerOptions{ Name: \"Client Listener Proxy\", Address: \":8082\", Endpoint: \"http://127.0.0.1:8083\", Protocol: \"http\", }) time.Sleep(1 * time.Second) // start the server proxy proxy.Run(&proxy.ServerOptions{ Name: \"Server Listener Proxy\", Address: \":8083\", Endpoint: \"http://127.0.0.1:6060\", Protocol: \"http\", }) } \u4e0b\u9762\u89e3\u91ca\u4e0b proxy.Run \u65b9\u6cd5\u7684\u51e0\u4e2a\u53c2\u6570\u3002 Name\uff1a\u4ee3\u7406\u670d\u52a1\u5668\u552f\u4e00\u6807\u8bc6\u3002 Address\uff1a\u4ee3\u7406\u670d\u52a1\u5668\u76d1\u542c\u5730\u5740\u3002 Endpoint\uff1a\u4ee3\u7406\u670d\u52a1\u5668\u6d41\u91cf\u8f6c\u53d1\u7684\u5730\u5740\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc Client Proxy \u5c06 Endpoint \u8bbe\u7f6e\u4e3a http://127.0.0.1:8083 \uff0c\u610f\u601d\u662f\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 Server Proxy \uff0c\u800c Server Proxy \u5c06\u6d41\u91cf\u8f6c\u5411\u4e86\u672c\u5730\u7684 6060 \u7aef\u53e3\uff0c\u4e5f\u5c31\u662f\u670d\u52a1\u7aef\u53e3\uff0c\u8fd9\u6837\u5c31\u5f62\u6210\u4e86\u4e00\u4e2a\u5b8c\u6210\u7684 Mesh \u94fe\u8def\u3002 Protocol\uff1a\u4ee3\u7406\u7684\u534f\u8bae\uff0c\u8fd9\u91cc\u662f HTTP\u3002 \u4e0b\u9762\u6211\u4eec\u8fdb\u5165 Run \u65b9\u6cd5\u770b\u4e00\u4e0b\u6838\u5fc3\u4ee3\u7801\uff1a // new proxy var p proxy.Proxy var s server.Server // set endpoint if len(Endpoint) > 0 { switch { case strings.HasPrefix(Endpoint, \"grpc://\"): ep := strings.TrimPrefix(Endpoint, \"grpc://\") popts = append(popts, proxy.WithEndpoint(ep)) p = grpc.NewProxy(popts...) case strings.HasPrefix(Endpoint, \"http://\"): // TODO: strip prefix? popts = append(popts, proxy.WithEndpoint(Endpoint)) p = http.NewProxy(popts...) s = smucp.NewServer( server.WrapHandler(ratelimiter.NewHandlerWrapper(10)), ) default: // TODO: strip prefix? popts = append(popts, proxy.WithEndpoint(Endpoint)) p = mucp.NewProxy(popts...) } } Run() \u65b9\u6cd5\u6839\u636e\u4f20\u5165\u7684\u53c2\u6570 Endpoint \u4f1a\u9009\u62e9\u5bf9\u5e94\u7684\u534f\u8bae\uff0c\u8fd9\u91cc\u6211\u4f20\u5165\u7684\u662f HTTP \u534f\u8bae\u7684Endpoint\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2a HTTP \u7684 Proxy\u3002 \u8fd9\u4e2a HTTP \u7684 Proxy \u8ddf\u8e2a\u4f60\u53ef\u4ee5\u53c2\u7167 Go-Micro \u7684\u4ee3\u7801 \uff0c\u4e5f\u5f88\u7b80\u5355\uff0c\u5176\u5b9e\u6240\u6709\u7684 Proxy \u90fd\u4f1a\u901a\u8fc7 ServeRequest(ctx context.Context, req server.Request, rsp server.Response) \u8fd9\u4e2a\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u5bf9 Server \u5904\u7406\u8fc7\u540e\u7684 HTTP \u8fdb\u884c\u8f6c\u53d1\u64cd\u4f5c\u3002 // get data body, err := req.Read() if err == io.EOF { return nil } if err != nil { return err } // get the header hdr := req.Header() // get method method := getMethod(hdr) // get endpoint endpoint := getEndpoint(hdr) // send to backend hreq, err := http.NewRequest(method, endpoint, bytes.NewReader(body)) if err != nil { return errors.InternalServerError(req.Service(), err.Error()) } // set the headers for k, v := range hdr { hreq.Header.Set(k, v) } // make the call hrsp, err := http.DefaultClient.Do(hreq) if err != nil { return errors.InternalServerError(req.Service(), err.Error()) } \u8fd9\u91cc\u5148\u8bfb\u53d6\u4e86 Server \u83b7\u53d6\u5230\u7684\u8bf7\u6c42 header \u548c body\uff0c\u7136\u540e\u5efa\u7acb\u4e86 HTTP \u5ba2\u6237\u7aef\u8fdb\u884c\u6d41\u91cf\u8f6c\u53d1\u3002 \u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u7684\u8f6c\u53d1\u76f8\u5bf9\u7b80\u5355\uff0c\u56e0\u4e3a\u76f8\u5bf9\u4e8e\u81ea\u5b9a\u4e49\u534f\u8bae\uff0c HTTP Golang \u63d0\u4f9b\u4e86\u73b0\u6210\u7684\u5ba2\u6237\u7aef\uff0c\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528\u5373\u53ef \u3002 Go-Micro \u7684 HTTP \u7684\u4ee3\u7406\u5b9e\u73b0\u76f8\u5bf9\u7b80\u5355\uff0c\u4f46\u662f\u4f60\u8981\u6ce8\u610f\uff1a\u8fd9\u91cc\u7684\u4ee3\u7801\u5e76\u6ca1\u6709\u8fdb\u884c\u4f18\u5316\u548c\u5ba2\u6237\u7aef\u7684\u8d85\u65f6\u5904\u7406\uff0c\u65e0\u6cd5\u76f4\u63a5\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u3002\u5982\u679c\u60f3\u7528\u4e8e\u751f\u4ea7\u73af\u5883\uff0c\u8fd8\u9700\u8981\u4e00\u4e9b\u6539\u9020\uff0c\u6bd4 \u5982\u81ea\u5df1\u5efa\u7acb HTTP Client\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u7528 http.DefaultClient \u3002 \u53e6\u5916\uff0chreq \u5bf9\u8c61\u4e5f\u8981\u643a\u5e26 context\uff0c\u4ee5\u786e\u4fdd\u53ef\u4ee5\u63a7\u5236\u8d85\u65f6\uff0c\u8fd4\u56de 504 Gateway Timetout \u7684\u9519\u8bef\u3002 \u521b\u5efa\u5b8c Proxy \u540e\uff0c\u4e0b\u9762\u7684\u4ee3\u7801\u57fa\u672c\u4e0a\u548c Go-Micro \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Server \u6ca1\u6709\u4ec0\u4e48\u533a\u522b\u4e86\u3002 \u53ea\u662f\u8fd9\u91cc\u7684 Muxer \u8fd9\u4e2a router \u5c06\u4f1a\u76f4\u63a5\u7ed5\u8fc7 Server \u7684 router \u5c42\uff0c\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u5411 Proxy \u5c42\uff0c\u56e0\u4e3a Server \u7684 router \u5176\u5b9e\u5df2\u7ecf\u6ca1\u6709\u7528\u4e86\uff0c\u76f8\u5f53\u4e8e\u88ab Proxy \u52ab\u6301\u4e86\uff0c\u6bd5\u7adf\u8fd9\u91cc\u6211\u4eec\u4e0d\u9700\u8981\u8def\u7531\u5230 Server \u7684\u5177\u4f53\u65b9\u6cd5\u3002 // new service service := micro.NewService(srvOpts...) // create a new proxy muxer which includes the debug handler muxer := mux.New(Name, p) // set the router service.Server().Init( server.WithRouter(muxer), ) // Run internal service if err := service.Run(); err != nil { log.Fatal(err) } \u8fdb\u5165 mux \u7684\u4ee3\u7801\u4e5f\u53ef\u4ee5\u4e86\u89e3\u5230\uff0c\u8fd9\u91cc\u76f4\u63a5\u8c03\u7528\u4e86 proxy.ServeRequest() \uff1a func (s *Server) ServeRequest(ctx context.Context, req server.Request, rsp server.Response) error { if req.Service() == s.Name { return server.DefaultRouter.ServeRequest(ctx, req, rsp) } return s.Proxy.ServeRequest(ctx, req, rsp) } \u63a7\u5236\u9762\uff1a\u5b9e\u73b0 xDS \u914d\u7f6e\u7ba1\u7406 \u6211\u4eec\u5148\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u9650\u6d41\u4e2d\u95f4\u4ef6\u5b66\u4e60\u4e00\u4e0b\u8fd9\u90e8\u5206\u5185\u5bb9\uff1a s = smucp.NewServer( server.WrapHandler(ratelimiter.NewHandlerWrapper(10)), ) RateLimit \u4e2d\u95f4\u4ef6\u4f7f\u7528\u4e86 Uber \u7684\u5e93\u5b9e\u73b0\uff0c\u8fbe\u5230\u9650\u6d41\u503c\u4f1a\u4ea7\u751f\u963b\u585e\uff0c\u800c\u4e0d\u662f\u8fd4\u56de\u9519\u8bef\u3002 \u5728\u751f\u4ea7\u4e2d\uff0c\u8fd8\u662f\u5efa\u8bae\u4f7f\u7528\u8fd4\u56de\u9519\u8bef\u7684\u65b9\u5f0f\u5b9e\u73b0\u9650\u6d41\u5668 \uff0c\u56e0\u4e3a\u4ea7\u751f\u963b\u585e\u53ef\u80fd\u4f1a\u8fdb\u4e00\u6b65\u6076\u5316\u5e76\u53d1\u60c5\u51b5\u3002\u5177\u4f53\u4ee3\u7801\u5982\u4e0b\uff1a // NewHandlerWrapper creates a blocking server side rate limiter func NewHandlerWrapper(rate int) server.HandlerWrapper { r := ratelimit.New(rate) return func(h server.HandlerFunc) server.HandlerFunc { return func(ctx context.Context, req server.Request, rsp interface{}) error { r.Take() return h(ctx, req, rsp) } } } \u81f3\u6b64\uff0c\u4e00\u4e2a\u7b80\u5355\u7684 Sidecar Proxy \u7684\u4ee3\u7801\u5b9e\u73b0\u90e8\u5206\u5c31\u8bb2\u89e3\u5b8c\u4e86\u3002\u4e0b\u9762\u6211\u4eec\u7f16\u8bd1\u5e76\u542f\u52a8\u8fd9\u4e2a\u7b80\u5355\u7684 Sidecar \uff0c\u6765\u770b\u4e00\u4e0b\u5b9e\u9645\u7684\u8fd0\u884c\u6548\u679c\u3002 \u5bf9\u4ee3\u7801\u8fdb\u884c\u7f16\u8bd1\u5e76\u542f\u52a8\uff1a go run -mod=vendor .\\main.go \u53ef\u4ee5\u770b\u5230\u4e0b\u9762\u7684\u542f\u52a8\u4fe1\u606f\uff1a 2021-02-20 23:49:44.486504 I | [proxy] Proxy [http] serving endpoint: http://127.0.0.1:8083 2021-02-20 23:49:44.490502 I | [proxy] Transport [http] Listening on [::]:8082 2021-02-20 23:49:44.502494 I | [proxy] Broker [http] Connected to [::]:14393 2021-02-20 23:49:44.695376 I | [proxy] Registry [mdns] Registering node: Client Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d 2021-02-20 23:49:45.497904 I | [proxy] Proxy [http] serving endpoint: http://127.0.0.1:6060 2021-02-20 23:49:45.498903 I | [proxy] Transport [http] Listening on [::]:8083 2021-02-20 23:49:45.585850 I | [proxy] Broker [http] Connected to [::]:14393 2021-02-20 23:49:45.758753 I | [proxy] Registry [mdns] Registering node: Server Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d 2021-02-20 23:49:46.606504 I | [proxy] Registry [mdns] Deregistering node: Client Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d 2021-02-20 23:49:46.609502 I | [proxy] Registry [mdns] Deregistering node: Server Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d \u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u540c\u65f6\u542f\u52a8\u4e86\u4e24\u4e2a\u7aef\u53e3 8082 \u548c 8083\uff0c\u5206\u522b\u662f Sidecar \u5904\u7406\u51fa\u6d41\u91cf\u548c\u5165\u6d41\u91cf\u7684\u7aef\u53e3\uff0c\u540c\u65f6\u6709\u8f93\u51fa\u4e86\u4e24\u4e2a Server \u4ee3\u7406\u7684\u76ee\u7684\u5730\u3002 \u6211\u4eec\u5148\u6765\u8bf7\u6c42 8083 \u7aef\u53e3\uff0c\u8fd9\u4e2a\u7aef\u53e3\u4f1a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u672c\u5730\u7684 6060 \u7aef\u53e3 \u3002\u4e3a\u4e86\u8c03\u8bd5\uff0c\u6211\u4eec\u7684 Sidecar \u4ee3\u7801\u5728 6060 \u7aef\u53e3\u542f\u52a8\u4e86\u4e00\u4e2a HTTP \u670d\u52a1\u5668\uff0c\u8bf7\u6c42\u8fd9\u4e2a Server \u4f1a\u8fd4\u56de Hello World \u7684\u8f93\u51fa\uff1a curl 127.0.0.1:6060/ -i StatusCode : 200 StatusDescription : OK Content : hello world RawContent : HTTP/1.1 200 OK Content-Length: 11 Content-Type: text/plain; charset=utf-8 Date: Sun, 21 Feb 2021 18:27:35 GMT hello world \u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u4e86\u76f8\u540c\u7684\u4fe1\u606f\uff0c\u8868\u793a Sidecar \u786e\u5b9e\u8fdb\u884c\u4e86\u6b63\u786e\u7684\u8f6c\u53d1\u3002 \u4e0b\u9762\u6211\u4eec\u518d\u8bf7\u6c42 8082 \u7aef\u53e3\uff0c\u6a21\u62df\u4e00\u4e0b\u5b8c\u6574\u7684 Mesh \u8fc7\u7a0b\u3002\u6574\u4e2a\u8fc7\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u8bf7\u6c428082\u7aef\u53e3\uff1a curl 127.0.0.1:8082/ StatusCode : 200 StatusDescription : OK Content : hello world RawContent : HTTP/1.1 200 OK Accept-Encoding: gzip Connection: Keep-Alive User-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; zh-CN) WindowsPowerShell/5.1.18362.1171 Content-Length: 11 Content-Type: text/pl... \u89e3\u6790\u53ef\u4ee5\u53d1\u73b0\uff0c\u8fd9\u91cc\u7684\u6d41\u91cf\u7ecf\u7531 8082\uff0c\u88ab\u8f6c\u53d1\u5230\u4e86 8083 \u7aef\u53e3\uff0c\u7ecf\u5386\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684 Mesh \u4ee3\u7406\u8fc7\u7a0b\u3002 \u4ece\u5ba2\u6237\u7aef\u7684\u6b63\u5411\u4ee3\u7406\uff0c\u5230\u670d\u52a1\u7aef\u7684\u53cd\u5411\u4ee3\u7406\uff0c\u901a\u8fc7\u5bf9\u51fa\u6d41\u91cf\u548c\u5165\u6d41\u91cf\u8fdb\u884c\u4ee3\u7406\uff0c\u5b8c\u6574\u638c\u63a7\u4e86\u6574\u4e2a\u5fae\u670d\u52a1\u94fe\u8def\u7684\u6d41\u91cf\u3002\u6700\u540e\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u4e86\u771f\u5b9e\u7684 Service\uff0c\u4e5f\u5c31\u662f 6060 \u7aef\u53e3\u542f\u52a8\u7684\u670d\u52a1\u3002 \u5230\u8fd9\u91cc\uff0c\u5229\u7528 Go-Micro \u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684 Sidecar \u5c31\u5b8c\u6210\u4e86\u3002\u4f60\u53ef\u4ee5\u770b\u5230\uff0cSidecar \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u4ee3\u7406\u7a0b\u5e8f\uff0c\u800c\u5229\u7528 Go-Micro \u5b9e\u73b0\u4e00\u4e2a Sidecar \u539f\u578b\u4e5f\u5e76\u4e0d\u590d\u6742\uff0c\u4f46\u8981\u505a\u4e00\u4e2a\u751f\u4ea7\u73af\u5883\u53ef\u7528\u7684 Sidecar \u8fd8\u6709\u5f88\u591a\u5de5\u4f5c\u8981\u5b8c\u5584\uff0c \u6bd4\u5982\u4e00\u4e9b\u9519\u8bef\u7684\u5904\u7406\u3001\u591a\u79cd\u534f\u8bae\u7684\u652f\u6301\u3001\u652f\u6301\u590d\u6742\u7684\u8def\u7531\u548c\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u4ee5\u53ca\u9650\u6d41\u7194\u65ad\u7b49\u57fa\u672c\u7684\u670d\u52a1\u6cbb\u7406\u529f\u80fd \u3002 \u5b9e\u9645\u4e0a\uff0c\u5728 Go \u8bed\u8a00\u4e2d\u8fd8\u6709\u53e6\u5916\u4e00\u79cd\u5b9e\u73b0 HTTP \u4ee3\u7406\u66f4\u7b80\u5355\u3001\u66f4\u7a33\u5b9a\u7684\u65b9\u6cd5\uff0c\u8fd9\u91cc\u6211\u4eec\u4e5f\u7b80\u5355\u505a\u4e00\u4e0b\u4ecb\u7ecd\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u6ca1\u6709\u7740\u91cd\u4ecb\u7ecd\u8fd9\u79cd\u65b9\u6cd5\uff0c\u800c\u9009\u62e9\u91c7\u7528 Go-Micro \u6765\u5b9e\u73b0\uff0c\u662f\u56e0\u4e3a Go-Micro \u65b9\u4fbf\u6269\u5c55\u591a\u79cd\u534f\u8bae\uff0c\u4ee5\u53ca\u7edf\u4e00\u7684\u4e2d\u95f4\u4ef6\u5c42\u3002 package main import ( \"log\" \"math/rand\" \"net/http\" \"net/http/httputil\" \"net/url\" ) func NewMultipleHostsReverseProxy(targets []*url.URL) *httputil.ReverseProxy { director := func(req *http.Request) { target := targets[rand.Int()%len(targets)] req.URL.Scheme = target.Scheme req.URL.Host = target.Host req.URL.Path = target.Path } return &httputil.ReverseProxy{Director: director} } func main() { proxy := NewMultipleHostsReverseProxy([]*url.URL{ { Scheme: \"http\", Host: \"localhost:6060\", }, }) log.Fatal(http.ListenAndServe(\":9090\", proxy)) } \u53ef\u4ee5\u770b\u5230\uff0c Golang \u672c\u8eab\u63d0\u4f9b\u4e86 ReverseProxy \u7684\u5bf9\u8c61 \u3002 \u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u5bf9\u8c61\uff0c\u5e76\u4f20\u5165 HTTP Server\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684 HTTP Proxy \u529f\u80fd\u3002\u5bf9\u4e8e HTTP \u670d\u52a1\u6765\u8bf4\uff0c\u8fd9\u4e2a Proxy \u5b9e\u73b0\u6bd4 Go-Micro \u7684\u5b9e\u73b0\u76f8\u5bf9\u9ad8\u6548\uff0c\u5b83\u5e76\u6ca1\u6709\u521b\u5efa HTTP Client\uff0c\u800c\u662f\u76f4\u63a5\u5229\u7528\u4e86\u66f4\u5e95\u5c42\u7684 HTTP Transport \u8fdb\u884c\u6d41\u91cf\u7684\u8f6c\u53d1\uff0c Golang \u7684\u6e90\u7801: https://github.com/golang/go/blob/master/src/net/http/httputil/reverseproxy.go 3\u3001 \u63a7\u5236\u9762\uff1a\u5b9e\u73b0 xDS \u914d\u7f6e\u7ba1\u7406 \u4ee3\u7801\u5b9e\u73b0 Service Mesh \u63a7\u5236\u9762\uff0c\u5b9e\u73b0 xDS \u914d\u7f6e\u7ba1\u7406\uff0c\u4ee5\u53ca\u6570\u636e\u9762 Sidecar \u5982\u4f55\u4e0e\u63a7\u5236\u9762\u8fdb\u884c\u901a\u4fe1\u3002 \u4ee3\u7801\u5b9e\u73b0\u5728https://github.com/beck917/easypilot\u548chttps://github.com/beck917/easymesh\u4e2d Envoy \u5b98\u65b9\u7684\u5b9e\u4f8b\u548c\u8457\u540d\u7684\u63a7\u5236\u9762 Istio\uff0c\u90fd\u9009\u62e9\u4f7f\u7528 Go \u8bed\u8a00\u6765\u5b9e\u73b0\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u4e5f\u91c7\u7528 Go \u8bed\u8a00\u5b9e\u73b0\u63a7\u5236\u9762\u4ee3\u7801 3-1 \u4ee3\u7801\u89e3\u6790 \u9996\u5148\u770b\u4e00\u4e0b main.go \u7684\u5165\u53e3\u4ee3\u7801\uff0c\u8fd9\u90e8\u5206\u4ee3\u7801\u521b\u5efa\u4e86\u4e00\u4e2a gRPC Server\uff0c\u6765\u63d0\u4f9b xDS \u670d\u52a1\u3002 go-control-plane \u7c7b\u5e93\u4f7f\u7528 Snapshot \u7684\u65b9\u5f0f\u5b58\u50a8\u6570\u636e\uff0c\u6bd4\u5982 EDS \u4e2d\u7684 Endpoint \u6570\u636e\uff0c\u5982\u679c\u8fdb\u884c\u6570\u636e\u66f4\u65b0\uff0c\u53ea\u9700\u5237\u65b0 Snapshot \u6570\u636e\u5c31\u53ef\u4ee5\u4e86 \u3002 \u8fd9\u91cc\u9996\u5148\u521b\u5efa\u4e86 SnapshotCache\uff0c\u7136\u540e\u7528 Mock \u7684\u6570\u636e\u751f\u6210\u4e86\u4e00\u4efd Snapshot\uff0c\u6700\u540e\u5c06 Snapshop \u5b58\u50a8\u5230 Cache \u4e2d\uff0c\u4e3a\u5bf9\u5e94\u7684 NodeID \u751f\u6210\u4e00\u4efd Cache \u6570\u636e\uff0c\u8fd9\u6837 xDS Server \u5728\u63d0\u4f9b\u670d\u52a1\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u5c06\u5bf9\u5e94\u7684\u6570\u636e\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u4e86\uff1a // \u521b\u5efa\u7f13\u5b58 cache := cachev3.NewSnapshotCache(false, cachev3.IDHash{}, l) // \u521b\u5efa snapshot \u6570\u636e\uff0c\u7528\u4e8e\u7ed9\u6570\u636e\u9762\u63d0\u4f9b xds \u6570\u636e snapshot := example.GenerateSnapshot() if err := snapshot.Consistent(); err != nil { l.Errorf(\"snapshot inconsistency: %+v\\n%+v\", snapshot, err) os.Exit(1) } l.Debugf(\"will serve snapshot %+v\", snapshot) // \u5c06 snapshot \u5199\u5165\u7f13\u5b58 if err := cache.SetSnapshot(nodeID, snapshot); err != nil { l.Errorf(\"snapshot error %q for %+v\", err, snapshot) os.Exit(1) } // \u8fd0\u884c xds \u670d\u52a1\u5668 ctx := context.Background() cb := &testv3.Callbacks{Debug: l.Debug} srv := serverv3.NewServer(ctx, cache, cb) example.RunServer(ctx, srv, port) \u5148\u6765\u770b example.GenerateSnapshot() \u8fd9\u4e2a\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u6a21\u62df\u4e86\u4e00\u4e9b\u6d4b\u8bd5\u6570\u636e\u3002 \u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\u521b\u5efa\u4e86 CDS\u3001EDS\u3001RDS\u3001LDS \u5bf9\u5e94\u7684\u6570\u636e\uff0c\u5176\u4e2d\u5305\u62ec\u96c6\u7fa4\u3001\u8282\u70b9\u3001\u8def\u7531\u3001\u76d1\u542c\u5668\u7b49\u6570\u636e\uff1a func GenerateSnapshot() cache.Snapshot { return cache.NewSnapshot( \"1\", []types.Resource{}, // endpoints []types.Resource{makeCluster(ClusterName)}, []types.Resource{makeRoute(RouteName, ClusterName)}, []types.Resource{makeHTTPListener(ListenerName, RouteName)}, []types.Resource{}, // runtimes []types.Resource{}, // secrets ) } \u6211\u4eec\u518d\u6765\u770b CDS \u548c EDS \u7684\u6570\u636e\u521b\u5efa\u3002 \u6211\u4eec\u5148\u6765\u770b Cluster \u7684\u6570\u636e\u7c7b\u578b\u7684\u53c2\u6570\uff1a func makeCluster(clusterName string) *cluster.Cluster { return &cluster.Cluster{ Name: clusterName, ConnectTimeout: ptypes.DurationProto(5 * time.Second), ClusterDiscoveryType: &cluster.Cluster_Type{Type: cluster.Cluster_LOGICAL_DNS}, LbPolicy: cluster.Cluster_ROUND_ROBIN, LoadAssignment: makeEndpoint(clusterName), DnsLookupFamily: cluster.Cluster_V4_ONLY, } } func makeEndpoint(clusterName string) *endpoint.ClusterLoadAssignment { return &endpoint.ClusterLoadAssignment{ ClusterName: clusterName, Endpoints: []*endpoint.LocalityLbEndpoints{{ LbEndpoints: []*endpoint.LbEndpoint{{ HostIdentifier: &endpoint.LbEndpoint_Endpoint{ Endpoint: &endpoint.Endpoint{ Address: &core.Address{ Address: &core.Address_SocketAddress{ SocketAddress: &core.SocketAddress{ Protocol: core.SocketAddress_TCP, Address: UpstreamHost, PortSpecifier: &core.SocketAddress_PortValue{ PortValue: UpstreamPort, }, }, }, }, }, }, }}, }}, } } \u63a5\u4e0b\u6765\u770b\u4e00\u4e0b example.RunServer(ctx, srv, port) \u8fd9\u4e2a\u65b9\u6cd5\u3002\u8be5\u65b9\u6cd5\u9996\u5148\u521b\u5efa\u4e86\u4e00\u4e2a gRPC Server\uff0c\u5e76\u8bbe\u7f6e\u4e86 grpcMaxConcurrentStreams \uff1a // \u542f\u52a8 xds server func RunServer(ctx context.Context, srv3 serverv3.Server, port uint) { // \u8bbe\u7f6e grpcMaxConcurrentStreams \u53c2\u6570\uff0c\u7528\u4e8e\u589e\u52a0\u9ed8\u8ba4\u7684\u5355\u8fde\u63a5\u5e76\u53d1\u6570\u91cf var grpcOptions []grpc.ServerOption grpcOptions = append(grpcOptions, grpc.MaxConcurrentStreams(grpcMaxConcurrentStreams)) grpcServer := grpc.NewServer(grpcOptions...) lis, err := net.Listen(\"tcp\", fmt.Sprintf(\":%d\", port)) if err != nil { log.Fatal(err) } registerServer(grpcServer, srv3) log.Printf(\"management server listening on %d\\n\", port) if err = grpcServer.Serve(lis); err != nil { log.Println(err) } } \u63a5\u6765\u4e0b\u901a\u8fc7 registerServer \u65b9\u6cd5\uff0c\u5c06\u63d0\u4f9b xDS \u670d\u52a1\u7684 Service \u6ce8\u518c\u5230\u5df2\u7ecf\u521b\u5efa\u597d\u7684 gRPC Server \u4e0a\u9762\uff0c\u7528\u4e8e\u63d0\u4f9b\u5bf9\u5e94\u7684 xDS Server\u670d\u52a1\u3002\u4f60\u8981\u6ce8\u610f\uff0c\u8fd9\u91cc\u6709\u4e00\u4e2a RegisterAggregatedDiscoveryServiceServer \u7684 Server \u63d0\u4f9b\u805a\u5408\u67e5\u8be2\u670d\u52a1\uff0c\u901a\u8fc7\u8fd9\u4e2a Server \u53ef\u4ee5\u4e3a\u6240\u6709\u7684 xDS \u534f\u8bae\u63d0\u4f9b\u670d\u52a1\uff1a func registerServer(grpcServer *grpc.Server, server serverv3.Server) { // \u6ce8\u518c\u670d\u52a1 discoverygrpc.RegisterAggregatedDiscoveryServiceServer(grpcServer, server) endpointservice.RegisterEndpointDiscoveryServiceServer(grpcServer, server) clusterservice.RegisterClusterDiscoveryServiceServer(grpcServer, server) routeservice.RegisterRouteDiscoveryServiceServer(grpcServer, server) listenerservice.RegisterListenerDiscoveryServiceServer(grpcServer, server) secretservice.RegisterSecretDiscoveryServiceServer(grpcServer, server) runtimeservice.RegisterRuntimeDiscoveryServiceServer(grpcServer, server) } \u4e00\u4e2a\u7b80\u5355\u7684 xDS Server \u5c31\u8bb2\u5b8c\u4e86\u3002\u8fd9\u91cc\u7684 xDS Server \u586b\u5145\u4e86\u4e00\u4e9b\u6d4b\u8bd5\u6570\u636e\u6765\u6a21\u62df\u7ed3\u679c\uff0c\u5982\u679c\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\uff0c\u9700\u8981\u63a5\u5165\u76f8\u5e94\u7684\u5e73\u53f0\u624d\u80fd\u63d0\u4f9b\u6570\u636e\u3002 \u6bd4\u5982\u5728 Istio \u4e2d\u901a\u8fc7 Kubernetes \u7684 API \u4e3a xDS Server \u63d0\u4f9b\u6570\u636e\uff1b\u901a\u8fc7\u5728 YAML \u4e2d\u58f0\u660e VirtualService \u7c7b\u578b\u6765\u4e3a RDS \u670d\u52a1\u63d0\u4f9b\u6570\u636e\u3002\u53c8\u6216\u8005\u4f7f\u7528\u4e86\u7b2c\u4e09\u65b9\u7684\u6ce8\u518c\u4e2d\u5fc3\uff0c\u6bd4\u5982 Consul\uff0c\u5219\u9700\u8981\u901a\u8fc7 Consul API \u4e3a EDS \u670d\u52a1\u63d0\u4f9b\u6570\u636e \u3002 \u6211\u4eec\u901a\u8fc7\u4e00\u4e2a EDS Client\uff0c\u6765\u770b\u4e00\u4e0b\u5982\u4f55\u5728\u6570\u636e\u9762 Sidecar \u4e2d\u901a\u8fc7 xDS \u548c\u63a7\u5236\u9762\u534f\u8bae\u901a\u4fe1\u3002\u8fd9\u90e8\u5206\u4ee3\u7801\u8fd8\u662f\u5728 https://github.com/beck917/easymesh \u4ee3\u7801\u4ed3\u5e93\u4e2d\u3002 \u5148\u6765\u770b utils/eds \u6587\u4ef6\u5939\u4e0b\u7684\u4ee3\u7801\u3002 \u9996\u5148\u901a\u8fc7 NewWithInterval \u521b\u5efa\u4e00\u4e2a EDS \u5bf9\u8c61\uff0c\u7136\u540e\u8fde\u63a5 EDS \u670d\u52a1\u5668\uff0c\u5e76\u4e14\u521b\u5efa\u4e00\u4e2a Goroutine\uff0c\u901a\u8fc7 Loop \u7684\u65b9\u6cd5\u5b9a\u65f6\u53d1\u9001\u8bf7\u6c42\u6570\u636e\u5230 EDS \u670d\u52a1\u5668\u3002\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u4e86\u63a8\u62c9\u7ed3\u5408\u7684\u65b9\u5f0f\u6765\u83b7\u53d6 EDS \u6570\u636e\uff1a func NewWithInterval(addr string, interval time.Duration) (*adapter, error) { if interval <= 0 { interval = time.Minute } urlobj, err := url.Parse(addr) if err == nil && len(urlobj.Host) > 0 { addr = urlobj.Host } eds := &adapter{ addr: addr, node: &core.Node{ Id: generateNodeID(), }, single: new(singleflight.Group), cache: registry.NewServiceCache(nil, 0), streams: sync.Map{}, fetchInterval: interval, } err = eds.connect() if err != nil { return nil, errors.Wrap(err) } // \u5b9a\u65f6\u62c9\u53d6\u6570\u636e go eds.loop() return eds, nil } \u540c\u65f6\u5728\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\uff0c\u6211\u4eec\u91c7\u7528 getService \u6765\u83b7\u53d6\u670d\u52a1\u8282\u70b9\u6570\u636e\u3002 \u8fd9\u4e2a\u65b9\u6cd5\u9996\u5148\u4f1a\u8bfb\u53d6\u7f13\u5b58\u4e2d\u7684\u6570\u636e\uff0c\u5982\u679c\u7f13\u5b58\u4e2d\u6ca1\u6709\u6570\u636e\u5219\u4f1a\u901a\u8fc7\u521b\u5efa\u548c EDS \u670d\u52a1\u5668\u5efa\u7acb Watch \u673a\u5236\uff0c\u52a8\u6001\u66f4\u65b0 Cache \u4e2d\u7684\u6570\u636e\uff1a func (eds *adapter) GetServices(name string, opts ...registry.DiscoveryOption) (services []*registry.Service, err error) { if eds.ccErr != nil { err = errors.Wrap(eds.ccErr) return } options := registry.NewCommonDiscoveryOption(opts...) key := registry.NewServiceKey(name, options.Tags, options.DC) // \u7b2c\u4e00\u6b65\uff0c\u4ece\u7f13\u5b58\u8bfb\u53d6 services, err = eds.cache.GetServices(key) if err == nil && len(services) > 0 { return } // \u4ece eds \u670d\u52a1\u83b7\u53d6 return eds.fetchServices(key, options.Tags) } startWatch \u65b9\u6cd5\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 Goroutine \u7528\u4e8e\u76d1\u542c EDS \u6570\u636e\u7684\u53d8\u5316\uff0c\u901a\u8fc7 parseStream \u963b\u585e\u83b7\u53d6 EDS Server \u7684\u63a8\u9001\u83b7\u53d6\u6570\u636e\uff0c\u83b7\u53d6\u6570\u636e\u540e\uff0c\u5c06\u6570\u636e\u5b58\u5165 Cache \u4e2d \uff1a func (eds *adapter) startWatch(client discovery.AggregatedDiscoveryService_StreamAggregatedResourcesClient, key registry.ServiceKey, tags []string) { logger.Infof(\"eds.Watch(%+v) ...\", key) go func(streamClient discovery.AggregatedDiscoveryService_StreamAggregatedResourcesClient, serviceKey registry.ServiceKey) { defer func() { if panicErr := recover(); panicErr != nil { logger.Errorf(\"eds.startWatch() panic: %+v\", panicErr) } else { //eds.streams.Delete(key) } }() for { services, err := eds.parseStream(eds.getStreamClient(key), tags) if err != nil { logger.Errorf(\"eds.Watch(%+v): %+v\", key, err) time.Sleep(1 * time.Second) continue } if len(services) <= 0 { logger.Warnf(\"eds.Watch(%+v): empty services, ignored!\", key) continue } ipv4s := make([]string, len(services)) for i, svc := range services { ipv4s[i] = svc.ServiceIP() } logger.Infof(\"eds.Watch(%+v): total=%d, services=%+v\", key, len(services), ipv4s) eds.cache.Set(key, services) if eds.watcher != nil { eds.watcher.Handle(key, services) } } }(client, key) } \u5f53\u53d1\u9001\u6570\u636e\uff0c\u6216\u8005\u83b7\u53d6\u6570\u636e\u9519\u8bef\u7684\u65f6\u5019\uff0c\u9700\u8981\u91cd\u65b0\u8fde\u63a5 EDS \u670d\u52a1\u5668\uff0c\u5426\u5219\u4e00\u65e6\u7f51\u7edc\u5f02\u5e38\u6216\u8005 EDS \u670d\u52a1\u5668\u91cd\u542f\uff0c\u5bfc\u81f4 EDS \u8fde\u63a5\u65ad\u5f00\uff0c\u5c31\u65e0\u6cd5\u6b63\u786e\u5730\u66f4\u65b0\u6570\u636e\u4e86 \u3002 \u548c\u4f20\u7edf\u7684\u5728 Client SDK \u4e2d\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u5668\u6709\u6240\u4e0d\u540c\uff0cSDK \u4e2d\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u4e00\u822c\u662f\u521b\u5efa\u597d\u540e\u4f20\u5165 Client \u5bf9\u8c61\u3002 Client \u5bf9\u8c61\u5728\u53d1\u51fa\u8bf7\u6c42\u524d\uff0c\u5148\u8c03\u7528\u8d1f\u8f7d\u5747\u8861\u5668\u7684 Next \u65b9\u6cd5\uff0c\u83b7\u53d6\u5230\u88ab\u8c03\u670d\u52a1\u7684 IP\uff0c\u7136\u540e\u8fdb\u884c\u670d\u52a1\u8bf7\u6c42\u3002\u6bd4\u5982\u4e0b\u9762\u7684\u4ee3\u7801\uff1a var srv *registry.Service srv, err = tp.rr.Next(ireq.Context(), host) if err != nil { logger.Errorf(\"get host:%v err:%v\", host, err) continue } ireq.URL.Host = srv.Addr() resp, err = tp.rt.RoundTrip(ireq)\u3001 \u4f46\u5728 Sidecar \u4e2d\uff0c\u8d1f\u8f7d\u5747\u8861\u5668\u7ec4\u4ef6\u4e5f\u88ab\u62bd\u8c61\u6210\u4e86\u4e2d\u95f4\u4ef6\u7684\u65b9\u5f0f\uff0c \u5177\u4f53\u5728 Go-Micro \u4e2d\uff0c\u5c31\u662f\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Wrapper\u3002\u800c\u4e14\u8fd9\u4e9b\u4e2d\u95f4\u4ef6\u90fd\u88ab\u7edf\u4e00\u5199\u5728\u4e86 Server \u7684\u4e2d\u95f4\u4ef6\u4e2d \uff0c\u5e76\u4e0d\u9700\u8981\u5199\u5728 Client \u7684\u4e2d\u95f4\u4ef6\u4e2d\uff0c\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u7684\u62bd\u8c61\u7a0b\u5ea6\u66f4\u597d\uff0c\u6a21\u578b\u4e5f\u66f4\u52a0\u7edf\u4e00\uff0c\u5bf9\u4e8e\u7406\u89e3\u548c\u7f16\u5199\u3001\u7ef4\u62a4\u4ee3\u7801\u90fd\u6709\u5e2e\u52a9\u3002 \u8def\u7531\u5668\u4e2d\u95f4\u4ef6\u7684\u4f5c\u7528\u662f\u6839\u636e\u6211\u4eec\u7684\u8bf7\u6c42\u53c2\u6570\uff0c\u6bd4\u5982 header\u3001path \u7b49\uff0c\u627e\u5230\u5bf9\u5e94\u7684\u670d\u52a1\u3002\u53ea\u6709\u901a\u8fc7\u8def\u7531\u5668\u4e2d\u95f4\u4ef6\u627e\u5230\u4e86\u5bf9\u5e94\u7684\u670d\u52a1\u540d\uff0c\u6211\u4eec\u624d\u80fd\u8ba9\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u95f4\u4ef6\u901a\u8fc7\u670d\u52a1\u540d\u627e\u5230\u5bf9\u5e94\u7684 Endpoint\u3002 \u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u901a\u8fc7 match \u65b9\u6cd5\u83b7\u53d6\u5230\u4e86\u5bf9\u5e94\u7684 router \u5bf9\u8c61\u548c router \u5bf9\u8c61\u5185\u5305\u542b\u7684 handlers\uff0c \u8fd9\u4e2a handler \u5b9e\u9645\u4e0a\u662f\u7ed1\u5b9a\u5728 router \u4e0a\u7684\u53e6\u5916\u4e00\u5957\u4e2d\u95f4\u4ef6\u4f53\u7cfb\uff0c\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u8ba9\u4e2d\u95f4\u4ef6\u66f4\u5bb9\u6613\u83b7\u53d6 router \u7684\u4e00\u4e9b\u4fe1\u606f\uff0c\u5426\u5219\u8fd8\u9700\u8981\u901a\u8fc7 routername \u67e5\u8be2\u624d\u80fd\u83b7\u53d6\u5230\u76f8\u5173\u4fe1\u606f \u3002 // HandlerWrapper \u670d\u52a1\u7aef\u4e2d\u95f4\u4ef6 func (wrap *Wrappers) HandlerWrapper() server.HandlerWrapper { return func(next server.HandlerFunc) server.HandlerFunc { return func(ctx context.Context, req server.Request, rsp interface{}) error { route, handlers := wrap.match(req.Service(), req.Method()) if route == nil { return errors.NotFound(\"mesh.wrap.router\", \"route mismatch\") } ctx = context.WithValue(ctx, defs.CtxRouter{}, route) handler := func(ctx context.Context, req server.Request, rsp interface{}) error { return next(ctx, req, rsp) } // \u5d4c\u5957\u81ea\u5b9a\u4e49 wraps for i := len(handlers); i > 0; i-- { handler = handlers[i-1](handler) } return handler(ctx, req, rsp) } } } \u6bcf\u4e2a\u4e2d\u95f4\u4ef6\uff0c\u90fd\u6709\u4e00\u4e2a Reload \u7684\u65b9\u6cd5\uff0c\u8fd9\u4e2a Reload \u65b9\u6cd5\u7528\u6765\u66f4\u65b0 xDS \u83b7\u53d6\u7684\u914d\u7f6e\u5230\u5177\u4f53\u7684\u4e2d\u95f4\u4ef6\u5bf9\u8c61\u4e2d\u3002 \u6bd4\u5982 router \u4e2d\u95f4\u4ef6\u7684 Reload \u65b9\u6cd5\uff0c\u5c31\u5c06\u6240\u6709\u7684\u8def\u7531\u4fe1\u606f\u89e3\u6790\u51fa\u6765\uff0c\u5b58\u50a8\u5728 ServiceRoutes \u5bf9\u8c61\u4e2d\uff0c\u7528\u4e8e match \u65b9\u6cd5\u7684\u5339\u914d\uff0c\u8fd9\u6837\u624d\u80fd\u627e\u5230\u8bf7\u6c42\u5177\u4f53\u5bf9\u5e94\u7684\u670d\u52a1\u540d\u3002 \u8d1f\u8f7d\u5747\u8861\u5668\u7684\u4e2d\u95f4\u4ef6\uff0c\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u4e5f\u7ed1\u5b9a\u5728\u8def\u7531\u5bf9\u8c61\u4e2d\uff0c\u5f53\u5339\u914d\u5230\u5bf9\u5e94\u7684\u8def\u7531\u540e\uff0c\u4f1a\u81ea\u52a8\u901a\u8fc7 Next \u65b9\u6cd5\u8c03\u7528\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u3002 // \u6ce8\u5165\u4e2d\u95f4\u4ef6 routeHandlers := handlers lbWrap, err := loadbalance.HandlerWrapper(srv, config, dis) if err != nil { return fmt.Errorf(\"service key:%s empty route:%+v build lb wrap err:%v\", srvKey, route, err) } \u8d1f\u8f7d\u5747\u8861\u5668\u4f1a\u901a\u8fc7 nextNode \u7684\u65b9\u6cd5\u83b7\u53d6\u8bf7\u6c42\u7684\u8282\u70b9\uff0cnextNode \u65b9\u6cd5\u76f4\u63a5\u4ece LB \u5bf9\u8c61\u4e2d\u83b7\u53d6\u76f8\u5e94\u7684 Endpoint \u6570\u636e\u3002 \u8fd9\u91cc\u548c EDS \u7684\u7c7b\u5e93\u6709\u4e00\u4e2a\u4ea4\u4e92\uff0cEDS \u7c7b\u5e93\u5728\u83b7\u53d6\u5230\u65b0\u7684\u6570\u636e\u65f6\u4f1a\u4e3b\u52a8\u66f4\u65b0 LB \u5bf9\u8c61\u4e2d\u7684\u6570\u636e\uff0c\u4ee5\u786e\u4fdd LB \u4e2d\u7684 Next \u65b9\u6cd5\u53ef\u4ee5\u4e00\u76f4\u83b7\u53d6\u5230\u6700\u65b0\u7684\u8282\u70b9\u6570\u636e \u3002 // HandlerWrapper \u8d1f\u8f7d\u5747\u8861\u548c\u670d\u52a1\u53d1\u73b0 func HandlerWrapper(cluster *qdx.Cluster, config *types.Config, dis qudiscovery.Discovery) (server.HandlerWrapper, error) { nextNode, err := newNext(cluster, config.Upstreams, dis) if err != nil { return nil, err } return func(next server.HandlerFunc) server.HandlerFunc { return func(ctx context.Context, req server.Request, rsp interface{}) error { node, err := nextNode() if err != nil { return errors.BadRequest(\"mesh.wrap.lb\", \"lb.next err:%v\", err) } ctx = context.WithValue(ctx, defs.CtxAddress{}, node.Address) return next(ctx, req, rsp) } }, nil }","title":"\u7b2c\u516b\u8282 Proj\u9879\u76ee\u843d\u5730: Go \u5b9e\u73b0 Service Mesh"},{"location":"chap2/8chap3_SM_GO_PROJ/#proj-go-service-mesh","text":"","title":"\u7b2c\u516b\u8282 Proj\u9879\u76ee\u843d\u5730: Go \u5b9e\u73b0 Service Mesh"},{"location":"chap2/8chap3_SM_GO_PROJ/#1","text":"","title":"1\u3001\u9879\u76ee\u80cc\u666f\uff1a\u5224\u65ad\u9009\u62e9\u5f00\u6e90\u4ea7\u54c1\u8fd8\u662f\u81ea\u7814"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-1","text":"\u5165\u53e3\u5c42\u7f3a\u4e4f\u7edf\u4e00\u7684\u7cfb\u7edf\u7f51\u5173 \uff1a\u591a\u4e2a\u670d\u52a1\u540c\u65f6\u5bf9\u5916\u66b4\u9732\uff0c\u65e0\u6cd5\u8fdb\u884c\u7edf\u4e00\u7684\u767b\u5f55\u9a8c\u8bc1\u3001\u52a0/\u89e3\u5bc6\u7b49\u529f\u80fd\uff0c\u53ea\u80fd\u5728\u5404\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u670d\u52a1\u4e2d\u5355\u72ec\u5b9e\u73b0\uff0c\u65e0\u6cd5\u8fdb\u884c\u7edf\u4e00\u7684\u7ef4\u62a4\u3002 \u5b58\u5728\u96ea\u5d29\u73b0\u8c61 \uff1a\u67d0\u4e00\u4e2a\u6838\u5fc3\u5fae\u670d\u52a1\u51fa\u73b0\u6545\u969c\u540e\uff0c\u5bfc\u81f4\u7ea7\u8054\u6545\u969c\uff0c\u4f9d\u8d56\u7684\u670d\u52a1\u56e0\u4e3a\u54cd\u5e94\u5ef6\u65f6\u53d8\u9ad8\uff0c\u90fd\u5c06\u51fa\u73b0\u6545\u969c\uff0c\u6700\u7ec8\u5bfc\u81f4\u6574\u7ad9\u6545\u969c\u3002 \u65e0\u6cd5\u5904\u7406\u7a81\u53d1\u6d41\u91cf \uff1a\u5f88\u591a\u65f6\u5019\u56e0\u4e3a\u8fd0\u8425\u6d3b\u52a8\uff0c\u524d\u671f\u6ca1\u6709\u914d\u5408\u63d0\u524d\u6269\u5bb9\u8d44\u6e90, \u5bfc\u81f4\u670d\u52a1\u88ab\u7a81\u53d1\u6d41\u91cf\u6253\u6302\u3002 \u5185\u90e8\u901a\u8fc7\u5185\u7f51\u96c6\u4e2d\u7f51\u5173\u8c03\u7528 \uff1a\u5185\u90e8\u901a\u8fc7\u7edf\u4e00\u7684\u7f51\u5173\u8c03\u7528\uff0c\u4e00\u65e6\u5185\u90e8\u96c6\u4e2d\u7f51\u5173\u51fa\u73b0\u95ee\u9898\uff0c\u5bfc\u81f4\u6240\u6709\u670d\u52a1\u51fa\u73b0\u6545\u969c\uff0c\u7ee7\u800c\u5f15\u8d77\u6574\u7ad9\u6545\u969c\u3002 \u9879\u76ee\u53ef\u89c2\u6d4b\u6027\u4e0d\u8db3\uff0c\u95ee\u9898\u6392\u67e5\u56f0\u96be \uff1a\u5404\u4e2a\u670d\u52a1\u81ea\u5df1\u5b9e\u73b0\u76d1\u63a7\u6307\u6807\uff0c\u6ca1\u6709\u7edf\u4e00\u7684\u76d1\u63a7\uff0c\u968f\u7740\u670d\u52a1\u6570\u91cf\u589e\u591a\uff0c\u95ee\u9898\u8d8a\u6765\u8d8a\u96be\u4ee5\u6392\u67e5\u3002 \u8c03\u7814\u4ee5\u4e0b\u51e0\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u5305\u62ec\u5fae\u670d\u52a1\u6846\u67b6\u3001\u5f00\u6e90 Service Mesh \u65b9\u6848\u3001\u81ea\u7814 Service Mesh \u65b9\u6848 \u5176\u4e2d\u5fae\u670d\u52a1\u6846\u67b6\u9700\u8981\u518d\u5f15\u5165\u4e00\u4e2a\u5f00\u6e90\u7cfb\u7edf\u7f51\u5173\u6216\u8005\u7528\u6846\u67b6\u5b9e\u73b0\u805a\u5408\u5c42 \u3002","title":"1-1 \u9879\u76ee\u80cc\u666f"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-2","text":"\u5fae\u670d\u52a1\u6846\u67b6 \u5fae\u670d\u52a1\u6846\u67b6\u5728 Web \u6846\u67b6\u7684\u57fa\u7840\u4e0a\uff0c\u589e\u52a0\u4e86\u670d\u52a1\u6cbb\u7406\u3001\u6ce8\u518c\u53d1\u73b0\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u8d1f\u8f7d\u5747\u8861\u3001RPC \u7b49\u591a\u79cd\u529f\u80fd\uff0c\u76ee\u7684\u662f\u63d0\u9ad8\u5fae\u670d\u52a1\u67b6\u6784\u7684\u7a33\u5b9a\u6027 \u4f18\u70b9 \u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u76f4\u63a5\u8c03\u7528 upstream \u670d\u52a1\uff0c\u65e0\u987b\u7ecf\u8fc7\u4e2d\u95f4\u4ee3\u7406\u5c42\uff0c\u6027\u80fd\u9ad8\uff1b \u5fae\u670d\u52a1\u6846\u67b6\u76f8\u5bf9\u6bd4\u8f83\u6210\u719f\u3002 \u7f3a\u70b9\uff1a \u6846\u67b6\u7ef4\u62a4\u5347\u7ea7\u6210\u672c\u9ad8\uff0c\u5fae\u670d\u52a1\u7684\u62c6\u5206\u4f1a\u5bfc\u81f4\u670d\u52a1\u6570\u91cf\u975e\u5e38\u591a\uff0c\u4e00\u65e6\u6846\u67b6\u53d1\u5e03\uff0c\u540e\u7eed\u5347\u7ea7\u51e0\u4e4e\u4e0d\u53ef\u80fd\u5b8c\u6210\uff1b \u65e7\u670d\u52a1\u63a5\u5165\u56f0\u96be\uff0c\u4fee\u6539\u4ee3\u7801\u6210\u672c\u9ad8\uff1b \u8bed\u8a00\u76f8\u5173\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u53ea\u80fd\u7ef4\u62a4\u4e00\u79cd\u8bed\u8a00\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u5bf9\u4e8e\u5c0f\u4f17\u8bed\u8a00\u65e0\u6cd5\u652f\u6301\u3002 \u603b\u7ed3\uff1a\u76f8\u5bf9\u6765\u8bf4 Go \u8bed\u8a00\u7684\u5fae\u670d\u52a1\u6846\u67b6\u5e76\u4e0d\u7b97\u4e30\u5bcc\uff0c\u66f4\u591a\u6846\u67b6\u8fd8\u505c\u7559\u5728 Web \u65b9\u9762\uff0c\u6bd4\u5982 Gin\u3001Echo \u90fd\u662f\u51fa\u8272\u7684 Web \u6846\u67b6\u3002\u5982\u679c\u662f\u65b0\u9879\u76ee\uff0c\u5fae\u670d\u52a1\u6846\u67b6 go-zero \u662f\u76f8\u5bf9\u4e0d\u9519\u7684\u9009\u62e9\u3002","title":"1-2 \u6280\u672f\u9009\u578b"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-2-service-mesh","text":"\u4f18\u70b9\uff1a \u76f8\u5bf9\u4e8e\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u901a\u8fc7\u548c\u4e1a\u52a1\u67b6\u6784\u89e3\u8026\u7684\u65b9\u5f0f\uff0c\u964d\u4f4e\u4e86\u5347\u7ea7\u7ef4\u62a4\u7684\u6210\u672c\uff1b \u65b0\u65e7\u670d\u52a1\u63a5\u5165\u540c\u6837\u7b80\u5355\uff0c\u53ef\u4ee5\u901a\u8fc7 iptables \u7f51\u7edc\u52ab\u6301\u65e0\u611f\u77e5\u65b9\u5f0f\u63a5\u5165\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u5c11\u91cf\u4ee3\u7801\u652f\u6301\uff1b \u8bed\u8a00\u65e0\u5173\u6027\uff0c\u516c\u53f8\u7684\u5c0f\u4f17\u8bed\u8a00\u4e5f\u53ef\u4ee5\u5f88\u597d\u5730\u652f\u6301\uff1b \u53ef\u4ee5\u6301\u7eed\u8ddf\u8fdb\u793e\u533a\u65b9\u6848\uff0c\u83b7\u5f97\u793e\u533a\u7684\u6700\u65b0\u6210\u679c\uff1b \u9879\u76ee\u542f\u52a8\u5feb\uff0c\u4e0d\u9700\u8981\u7814\u53d1\uff0c\u53ea\u9700\u8981\u505a\u597d\u6d4b\u8bd5\u3002 \u7f3a\u70b9\uff1a \u4ee3\u7801\u4e8c\u6b21\u6269\u5c55\u96be\u5ea6\u6bd4\u8f83\u5927\uff0c\u9700\u8981\u7279\u5b9a\u7684\u8bed\u8a00\u5f00\u53d1\u7ecf\u9a8c\uff0c\u516c\u53f8\u4e2a\u6027\u5316\u7684\u9700\u6c42\u65e0\u6cd5\u6ee1\u8db3\uff1b \u5f00\u6e90\u8f6f\u4ef6\u5f80\u5f80\u7248\u672c\u53d8\u5316\u6bd4\u8f83\u5927\uff0c\u5411\u524d\u517c\u5bb9\u6027\u6bd4\u8f83\u5dee\uff0c\u5982\u679c\u60f3\u8981\u7ef4\u62a4\u5347\u7ea7\uff0c\u4e5f\u9700\u8981\u5bf9\u6e90\u7801\u6709\u4e00\u5b9a\u7684\u638c\u63e1\uff0c\u5426\u5219\u5347\u7ea7\u98ce\u9669\u6bd4\u8f83\u5927\u3002","title":"1-2 \u5f00\u6e90 Service Mesh \u65b9\u6848"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-3-service-mesh","text":"\u81ea\u7814 Service Mesh \u65b9\u6848\u5206\u4e3a\u4e24\u79cd\uff0c \u4e00\u79cd\u662f\u6570\u636e\u9762 Sidecar \u548c\u63a7\u5236\u9762\u5168\u90e8\u81ea\u7814\uff0c\u53e6\u5916\u4e00\u79cd\u662f\u4f7f\u7528\u5f00\u6e90\u6570\u636e\u9762\uff0c\u4f46\u662f\u81ea\u7814\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\u63a7\u5236\u9762 \u3002","title":"1-3 \u81ea\u7814 Service Mesh \u65b9\u6848"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-4","text":"\u6570\u636e\u9762\u548c\u63a7\u5236\u9762\u5b8c\u5168\u81ea\u7814\u7684\u65b9\u6848\u3002 \u4f18\u70b9\uff1a \u5177\u5907\u5f00\u6e90 Service Mesh \u65b9\u6848\u76f8\u5bf9\u4e8e\u5fae\u670d\u52a1\u6846\u67b6\u7684\u4f18\u52bf\uff1b \u53ef\u6269\u5c55\u6027\u5f3a\uff0c\u53ef\u4ee5\u517c\u5bb9\u516c\u53f8\u8fd0\u7ef4\u73af\u5883\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u5b9a\u5236\u578b\u9700\u6c42\uff0c\u6bd4\u5982\u65b0\u7684 RPC \u534f\u8bae\u652f\u6301\u3001\u591a\u534f\u8bae\u670d\u52a1\u6cbb\u7406\u3001\u65b0\u7684\u8d1f\u8f7d\u5747\u8861\u652f\u6301\u7b49\uff1b \u9879\u76ee\u628a\u63a7\u529b\u5f3a\uff0c\u51fa\u73b0\u95ee\u9898\u53ef\u4ee5\u5feb\u901f\u89e3\u51b3 \u7f3a\u70b9\uff1a \u7814\u53d1\u6210\u672c\u9ad8\uff0c\u9700\u8981\u4e00\u5b9a\u7684\u7814\u53d1\u65f6\u95f4\uff0c\u4e0a\u7ebf\u7070\u5ea6\u5230\u7a33\u5b9a\u7248\u672c\u4e5f\u9700\u8981\u65f6\u95f4\uff0c\u5728\u7070\u5ea6\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u4f1a\u6709 Bug \u51fa\u73b0\uff1b \u548c\u793e\u533a\u6709\u4e00\u5b9a\u7684\u5272\u88c2\u3002","title":"1-4 \u5b8c\u5168\u81ea\u7814"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-5","text":"\u76f4\u63a5\u4f7f\u7528 \u5f00\u6e90\u63a7\u5236\u9762\u65b9\u6848\u57fa\u672c\u4e0a\u65e0\u6cd5\u6ee1\u8db3\u63a7\u5236\u9762\u4e2a\u6027\u7684\u9700\u6c42 \uff0c\u6bd4\u5982\u7b2c\u4e09\u65b9\u6ce8\u518c\u4e2d\u5fc3\u7684\u652f\u6301\u3001\u865a\u62df\u673a\u73af\u5883\u7684\u652f\u6301\u7b49 \u4f18\u70b9\uff1a \u53ef\u4ee5\u6ee1\u8db3\u516c\u53f8\u591a\u6837\u7684\u8fd0\u7ef4\u73af\u5883\uff1b \u63a7\u5236\u9762\u81ea\u7814\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\uff0c\u6709\u4e00\u5b9a\u7684\u5b9a\u5236\u6027\u3002 \u7f3a\u70b9\uff1a \u6570\u636e\u9762 Sidecar \u4f9d\u7136\u6709\u5f00\u6e90\u65b9\u6848\u7684\u5f0a\u7aef\u3002 \u9996\u5148\u4e8e\u6570\u636e\u9762\u65e0\u6cd5\u5b9a\u5236\uff0c\u5176\u6b21\u5bf9\u4e8e\u63a7\u5236\u9762\u80fd\u505a\u7684\u8054\u52a8\u6709\u4e00\u5b9a\u7684\u5c40\u9650\u6027\u3002","title":"1-5 \u5f00\u6e90\u6570\u636e\u9762+\u81ea\u7814\u63a7\u5236\u9762"},{"location":"chap2/8chap3_SM_GO_PROJ/#1-6","text":"\u529f\u80fd\u70b9 \u6570\u636e\u9762 Sidecar\uff1a \u5b9e\u73b0\u57fa\u7840\u6846\u67b6\uff0c\u80fd\u591f\u4ee3\u7406 HTTP \u534f\u8bae\uff0c\u5e76\u5177\u5907\u6269\u5c55\u6027\uff1b \u652f\u6301\u9650\u6d41\u3001\u7194\u65ad\u7b49\u670d\u52a1\u6cbb\u7406\u4e2d\u95f4\u4ef6\uff1b \u652f\u6301\u53ef\u89c2\u6d4b\u6027\u7ec4\u4ef6\uff0c\u5305\u62ec Log\u3001Trace \u548c Metrics\uff1b \u652f\u6301\u670d\u52a1\u6ce8\u518c\u548c\u53d1\u73b0\uff0c\u80fd\u591f\u4ee3\u7406\u4e1a\u52a1\u670d\u52a1\u8fdb\u884c\u6ce8\u518c\uff1b \u901a\u8fc7 xDS \u548c\u63a7\u5236\u9762\u901a\u4fe1\u3002 \u63a7\u5236\u9762\uff1a \u540c\u65f6\u517c\u5bb9\u865a\u62df\u673a\u548c Kubernetes\uff0c\u548c\u516c\u53f8\u73b0\u6709\u7684 CMDB \u7cfb\u7edf\u6253\u901a\uff0c\u540c\u6b65\u673a\u5668\u5143\u6570\u636e\u3002 \u652f\u6301 xDS \u534f\u8bae\uff0c\u517c\u5bb9\u73b0\u6709\u7684\u3001\u91c7\u7528 xDS \u534f\u8bae\u7684\u6570\u636e\u9762\u3002 \u6280\u672f\u9009\u578b Go-Micro \u6846\u67b6\u5b8c\u5168\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u6570\u636e\u9762 Sidecar \u7684\u9700\u6c42\uff0c\u5176\u672c\u8eab\u4e5f\u652f\u6301\u4e86\u591a\u79cd\u534f\u8bae\u3002\uff08Go-Micro \u9879\u76ee\u5730\u5740https://github.com/asim/go-micro\uff09 \u63a7\u5236\u9762 Envoy \u4e5f\u63d0\u4f9b\u4e86\u57fa\u7840\u6846\u67b6\uff0c\u4e3a\u4e86\u964d\u4f4e\u590d\u6742\u5ea6\uff0c\u6211\u4eec\u4e0d\u4f7f\u7528 Istio \u4e8c\u6b21\u5f00\u53d1\uff0c\u76f4\u63a5\u7528 Envoy \u63d0\u4f9b\u7684\u63a7\u5236\u9762\u57fa\u7840\u6846\u67b6\u6765\u5f00\u53d1\u3002\uff08\u5730\u5740\u4e3ahttps://github.com/envoyproxy/go-control-plane\uff09","title":"1-6 \u6280\u672f\u5b9e\u73b0"},{"location":"chap2/8chap3_SM_GO_PROJ/#2-go-micro","text":"\u5728\u5e38\u89c1\u7684\u5f00\u6e90\u6570\u636e\u9762\u4e2d\uff0cEnvoy \u4f7f\u7528 C++ \u5b9e\u73b0\uff0cLinkerd \u65e9\u671f\u7248\u672c\u4f7f\u7528 Java\uff0c\u65b0\u7248\u672c\u4f7f\u7528 Rust \u5b9e\u73b0\uff0c\u800c MOSN \u548c Maesh \u90fd\u4f7f\u7528 Go \u8bed\u8a00\u5b9e\u73b0\u3002\u4ece\u8fd9\u4e9b\u6280\u672f\u9009\u578b\u53ef\u4ee5\u770b\u51fa\uff0c Go \u8bed\u8a00\u5728\u6570\u636e\u9762\u7684\u5b9e\u73b0\u4e2d\u5360\u6709\u4e00\u5e2d\u4e4b\u5730\uff0c\u4e3b\u8981\u662f\u8f83\u9ad8\u7684\u6027\u80fd\u548c\u8f83\u5c11\u7684\u5185\u5b58\u5360\u7528\uff0c\u6bd4\u8f83\u9002\u5408 Sidecar \u7684\u5e94\u7528\u573a\u666f\u3002 \u4e3a\u4e86\u5feb\u901f\u5b9e\u73b0\uff0c\u6211\u4eec\u4f7f\u7528\u4e86 Go-micro \u6846\u67b6\uff0c\u8fd9\u4e2a\u6846\u67b6\u6709\u975e\u5e38\u597d\u7684\u62bd\u8c61\u5c42\uff0c\u652f\u6301 MUCP\u3001gRPC\u3001HTTP \u7b49\u534f\u8bae\u7684\u539f\u751f\u4ee3\u7406\uff0c\u540e\u671f\u4e5f\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u6269\u5c55\u534f\u8bae\u5c42\u3002 https://github.com/beck917/easymesh","title":"2\u3001\u6570\u636e\u9762\uff1a\u57fa\u4e8e Go-Micro \u5feb\u901f\u5b9e\u73b0\u4ee3\u7406\u6a21\u5757"},{"location":"chap2/8chap3_SM_GO_PROJ/#2-1","text":"\u9996\u5148\u8fdb\u5165 Go \u8bed\u8a00\u5b98\u7f51\uff0c\u6839\u636e\u73af\u5883\u4e0b\u8f7d\u5408\u9002\u7684\u7248\u672c https://golang.google.cn/dl/ \uff0c\u56e0\u4e3a Go-Micro \u7684\u65e7\u7248\u672c\u4f9d\u8d56\u95ee\u9898\uff0c\u8fd9\u91cc\u6211\u4eec\u9009\u62e9 Go 1.14 \u7248\u672c\u3002","title":"2-1 \u73af\u5883\u5b89\u88c5&amp;\u6846\u67b6\u642d\u5efa"},{"location":"chap2/8chap3_SM_GO_PROJ/#2-2","text":"\u9996\u5148\u6211\u4eec\u770b\u4e00\u4e0b main \u65b9\u6cd5\uff0c\u8fd9\u91cc\u521b\u5efa\u4e86\u4e24\u4e2a\u4ee3\u7406\u670d\u52a1\u5668\uff0c \u5206\u522b\u662f\u76d1\u542c 8082 \u7aef\u53e3\u7684\u51fa\u6d41\u91cf\u4ee3\u7406\u548c\u76d1\u542c 8083 \u7aef\u53e3\u7684 8083 \u670d\u52a1 \uff1a func main() { http.HandleFunc(\"/\", indexHandler) go http.ListenAndServe(\":6060\", nil) // start the client proxy go proxy.Run(&proxy.ServerOptions{ Name: \"Client Listener Proxy\", Address: \":8082\", Endpoint: \"http://127.0.0.1:8083\", Protocol: \"http\", }) time.Sleep(1 * time.Second) // start the server proxy proxy.Run(&proxy.ServerOptions{ Name: \"Server Listener Proxy\", Address: \":8083\", Endpoint: \"http://127.0.0.1:6060\", Protocol: \"http\", }) } \u4e0b\u9762\u89e3\u91ca\u4e0b proxy.Run \u65b9\u6cd5\u7684\u51e0\u4e2a\u53c2\u6570\u3002 Name\uff1a\u4ee3\u7406\u670d\u52a1\u5668\u552f\u4e00\u6807\u8bc6\u3002 Address\uff1a\u4ee3\u7406\u670d\u52a1\u5668\u76d1\u542c\u5730\u5740\u3002 Endpoint\uff1a\u4ee3\u7406\u670d\u52a1\u5668\u6d41\u91cf\u8f6c\u53d1\u7684\u5730\u5740\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc Client Proxy \u5c06 Endpoint \u8bbe\u7f6e\u4e3a http://127.0.0.1:8083 \uff0c\u610f\u601d\u662f\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 Server Proxy \uff0c\u800c Server Proxy \u5c06\u6d41\u91cf\u8f6c\u5411\u4e86\u672c\u5730\u7684 6060 \u7aef\u53e3\uff0c\u4e5f\u5c31\u662f\u670d\u52a1\u7aef\u53e3\uff0c\u8fd9\u6837\u5c31\u5f62\u6210\u4e86\u4e00\u4e2a\u5b8c\u6210\u7684 Mesh \u94fe\u8def\u3002 Protocol\uff1a\u4ee3\u7406\u7684\u534f\u8bae\uff0c\u8fd9\u91cc\u662f HTTP\u3002 \u4e0b\u9762\u6211\u4eec\u8fdb\u5165 Run \u65b9\u6cd5\u770b\u4e00\u4e0b\u6838\u5fc3\u4ee3\u7801\uff1a // new proxy var p proxy.Proxy var s server.Server // set endpoint if len(Endpoint) > 0 { switch { case strings.HasPrefix(Endpoint, \"grpc://\"): ep := strings.TrimPrefix(Endpoint, \"grpc://\") popts = append(popts, proxy.WithEndpoint(ep)) p = grpc.NewProxy(popts...) case strings.HasPrefix(Endpoint, \"http://\"): // TODO: strip prefix? popts = append(popts, proxy.WithEndpoint(Endpoint)) p = http.NewProxy(popts...) s = smucp.NewServer( server.WrapHandler(ratelimiter.NewHandlerWrapper(10)), ) default: // TODO: strip prefix? popts = append(popts, proxy.WithEndpoint(Endpoint)) p = mucp.NewProxy(popts...) } } Run() \u65b9\u6cd5\u6839\u636e\u4f20\u5165\u7684\u53c2\u6570 Endpoint \u4f1a\u9009\u62e9\u5bf9\u5e94\u7684\u534f\u8bae\uff0c\u8fd9\u91cc\u6211\u4f20\u5165\u7684\u662f HTTP \u534f\u8bae\u7684Endpoint\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2a HTTP \u7684 Proxy\u3002 \u8fd9\u4e2a HTTP \u7684 Proxy \u8ddf\u8e2a\u4f60\u53ef\u4ee5\u53c2\u7167 Go-Micro \u7684\u4ee3\u7801 \uff0c\u4e5f\u5f88\u7b80\u5355\uff0c\u5176\u5b9e\u6240\u6709\u7684 Proxy \u90fd\u4f1a\u901a\u8fc7 ServeRequest(ctx context.Context, req server.Request, rsp server.Response) \u8fd9\u4e2a\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u5bf9 Server \u5904\u7406\u8fc7\u540e\u7684 HTTP \u8fdb\u884c\u8f6c\u53d1\u64cd\u4f5c\u3002 // get data body, err := req.Read() if err == io.EOF { return nil } if err != nil { return err } // get the header hdr := req.Header() // get method method := getMethod(hdr) // get endpoint endpoint := getEndpoint(hdr) // send to backend hreq, err := http.NewRequest(method, endpoint, bytes.NewReader(body)) if err != nil { return errors.InternalServerError(req.Service(), err.Error()) } // set the headers for k, v := range hdr { hreq.Header.Set(k, v) } // make the call hrsp, err := http.DefaultClient.Do(hreq) if err != nil { return errors.InternalServerError(req.Service(), err.Error()) } \u8fd9\u91cc\u5148\u8bfb\u53d6\u4e86 Server \u83b7\u53d6\u5230\u7684\u8bf7\u6c42 header \u548c body\uff0c\u7136\u540e\u5efa\u7acb\u4e86 HTTP \u5ba2\u6237\u7aef\u8fdb\u884c\u6d41\u91cf\u8f6c\u53d1\u3002 \u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u7684\u8f6c\u53d1\u76f8\u5bf9\u7b80\u5355\uff0c\u56e0\u4e3a\u76f8\u5bf9\u4e8e\u81ea\u5b9a\u4e49\u534f\u8bae\uff0c HTTP Golang \u63d0\u4f9b\u4e86\u73b0\u6210\u7684\u5ba2\u6237\u7aef\uff0c\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528\u5373\u53ef \u3002 Go-Micro \u7684 HTTP \u7684\u4ee3\u7406\u5b9e\u73b0\u76f8\u5bf9\u7b80\u5355\uff0c\u4f46\u662f\u4f60\u8981\u6ce8\u610f\uff1a\u8fd9\u91cc\u7684\u4ee3\u7801\u5e76\u6ca1\u6709\u8fdb\u884c\u4f18\u5316\u548c\u5ba2\u6237\u7aef\u7684\u8d85\u65f6\u5904\u7406\uff0c\u65e0\u6cd5\u76f4\u63a5\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u3002\u5982\u679c\u60f3\u7528\u4e8e\u751f\u4ea7\u73af\u5883\uff0c\u8fd8\u9700\u8981\u4e00\u4e9b\u6539\u9020\uff0c\u6bd4 \u5982\u81ea\u5df1\u5efa\u7acb HTTP Client\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u7528 http.DefaultClient \u3002 \u53e6\u5916\uff0chreq \u5bf9\u8c61\u4e5f\u8981\u643a\u5e26 context\uff0c\u4ee5\u786e\u4fdd\u53ef\u4ee5\u63a7\u5236\u8d85\u65f6\uff0c\u8fd4\u56de 504 Gateway Timetout \u7684\u9519\u8bef\u3002 \u521b\u5efa\u5b8c Proxy \u540e\uff0c\u4e0b\u9762\u7684\u4ee3\u7801\u57fa\u672c\u4e0a\u548c Go-Micro \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Server \u6ca1\u6709\u4ec0\u4e48\u533a\u522b\u4e86\u3002 \u53ea\u662f\u8fd9\u91cc\u7684 Muxer \u8fd9\u4e2a router \u5c06\u4f1a\u76f4\u63a5\u7ed5\u8fc7 Server \u7684 router \u5c42\uff0c\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u5411 Proxy \u5c42\uff0c\u56e0\u4e3a Server \u7684 router \u5176\u5b9e\u5df2\u7ecf\u6ca1\u6709\u7528\u4e86\uff0c\u76f8\u5f53\u4e8e\u88ab Proxy \u52ab\u6301\u4e86\uff0c\u6bd5\u7adf\u8fd9\u91cc\u6211\u4eec\u4e0d\u9700\u8981\u8def\u7531\u5230 Server \u7684\u5177\u4f53\u65b9\u6cd5\u3002 // new service service := micro.NewService(srvOpts...) // create a new proxy muxer which includes the debug handler muxer := mux.New(Name, p) // set the router service.Server().Init( server.WithRouter(muxer), ) // Run internal service if err := service.Run(); err != nil { log.Fatal(err) } \u8fdb\u5165 mux \u7684\u4ee3\u7801\u4e5f\u53ef\u4ee5\u4e86\u89e3\u5230\uff0c\u8fd9\u91cc\u76f4\u63a5\u8c03\u7528\u4e86 proxy.ServeRequest() \uff1a func (s *Server) ServeRequest(ctx context.Context, req server.Request, rsp server.Response) error { if req.Service() == s.Name { return server.DefaultRouter.ServeRequest(ctx, req, rsp) } return s.Proxy.ServeRequest(ctx, req, rsp) } \u63a7\u5236\u9762\uff1a\u5b9e\u73b0 xDS \u914d\u7f6e\u7ba1\u7406 \u6211\u4eec\u5148\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u9650\u6d41\u4e2d\u95f4\u4ef6\u5b66\u4e60\u4e00\u4e0b\u8fd9\u90e8\u5206\u5185\u5bb9\uff1a s = smucp.NewServer( server.WrapHandler(ratelimiter.NewHandlerWrapper(10)), ) RateLimit \u4e2d\u95f4\u4ef6\u4f7f\u7528\u4e86 Uber \u7684\u5e93\u5b9e\u73b0\uff0c\u8fbe\u5230\u9650\u6d41\u503c\u4f1a\u4ea7\u751f\u963b\u585e\uff0c\u800c\u4e0d\u662f\u8fd4\u56de\u9519\u8bef\u3002 \u5728\u751f\u4ea7\u4e2d\uff0c\u8fd8\u662f\u5efa\u8bae\u4f7f\u7528\u8fd4\u56de\u9519\u8bef\u7684\u65b9\u5f0f\u5b9e\u73b0\u9650\u6d41\u5668 \uff0c\u56e0\u4e3a\u4ea7\u751f\u963b\u585e\u53ef\u80fd\u4f1a\u8fdb\u4e00\u6b65\u6076\u5316\u5e76\u53d1\u60c5\u51b5\u3002\u5177\u4f53\u4ee3\u7801\u5982\u4e0b\uff1a // NewHandlerWrapper creates a blocking server side rate limiter func NewHandlerWrapper(rate int) server.HandlerWrapper { r := ratelimit.New(rate) return func(h server.HandlerFunc) server.HandlerFunc { return func(ctx context.Context, req server.Request, rsp interface{}) error { r.Take() return h(ctx, req, rsp) } } } \u81f3\u6b64\uff0c\u4e00\u4e2a\u7b80\u5355\u7684 Sidecar Proxy \u7684\u4ee3\u7801\u5b9e\u73b0\u90e8\u5206\u5c31\u8bb2\u89e3\u5b8c\u4e86\u3002\u4e0b\u9762\u6211\u4eec\u7f16\u8bd1\u5e76\u542f\u52a8\u8fd9\u4e2a\u7b80\u5355\u7684 Sidecar \uff0c\u6765\u770b\u4e00\u4e0b\u5b9e\u9645\u7684\u8fd0\u884c\u6548\u679c\u3002 \u5bf9\u4ee3\u7801\u8fdb\u884c\u7f16\u8bd1\u5e76\u542f\u52a8\uff1a go run -mod=vendor .\\main.go \u53ef\u4ee5\u770b\u5230\u4e0b\u9762\u7684\u542f\u52a8\u4fe1\u606f\uff1a 2021-02-20 23:49:44.486504 I | [proxy] Proxy [http] serving endpoint: http://127.0.0.1:8083 2021-02-20 23:49:44.490502 I | [proxy] Transport [http] Listening on [::]:8082 2021-02-20 23:49:44.502494 I | [proxy] Broker [http] Connected to [::]:14393 2021-02-20 23:49:44.695376 I | [proxy] Registry [mdns] Registering node: Client Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d 2021-02-20 23:49:45.497904 I | [proxy] Proxy [http] serving endpoint: http://127.0.0.1:6060 2021-02-20 23:49:45.498903 I | [proxy] Transport [http] Listening on [::]:8083 2021-02-20 23:49:45.585850 I | [proxy] Broker [http] Connected to [::]:14393 2021-02-20 23:49:45.758753 I | [proxy] Registry [mdns] Registering node: Server Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d 2021-02-20 23:49:46.606504 I | [proxy] Registry [mdns] Deregistering node: Client Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d 2021-02-20 23:49:46.609502 I | [proxy] Registry [mdns] Deregistering node: Server Listener Proxy-5512f579-7eed-4ef6-8c80-4342650afc2d \u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u540c\u65f6\u542f\u52a8\u4e86\u4e24\u4e2a\u7aef\u53e3 8082 \u548c 8083\uff0c\u5206\u522b\u662f Sidecar \u5904\u7406\u51fa\u6d41\u91cf\u548c\u5165\u6d41\u91cf\u7684\u7aef\u53e3\uff0c\u540c\u65f6\u6709\u8f93\u51fa\u4e86\u4e24\u4e2a Server \u4ee3\u7406\u7684\u76ee\u7684\u5730\u3002 \u6211\u4eec\u5148\u6765\u8bf7\u6c42 8083 \u7aef\u53e3\uff0c\u8fd9\u4e2a\u7aef\u53e3\u4f1a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u672c\u5730\u7684 6060 \u7aef\u53e3 \u3002\u4e3a\u4e86\u8c03\u8bd5\uff0c\u6211\u4eec\u7684 Sidecar \u4ee3\u7801\u5728 6060 \u7aef\u53e3\u542f\u52a8\u4e86\u4e00\u4e2a HTTP \u670d\u52a1\u5668\uff0c\u8bf7\u6c42\u8fd9\u4e2a Server \u4f1a\u8fd4\u56de Hello World \u7684\u8f93\u51fa\uff1a curl 127.0.0.1:6060/ -i StatusCode : 200 StatusDescription : OK Content : hello world RawContent : HTTP/1.1 200 OK Content-Length: 11 Content-Type: text/plain; charset=utf-8 Date: Sun, 21 Feb 2021 18:27:35 GMT hello world \u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u4e86\u76f8\u540c\u7684\u4fe1\u606f\uff0c\u8868\u793a Sidecar \u786e\u5b9e\u8fdb\u884c\u4e86\u6b63\u786e\u7684\u8f6c\u53d1\u3002 \u4e0b\u9762\u6211\u4eec\u518d\u8bf7\u6c42 8082 \u7aef\u53e3\uff0c\u6a21\u62df\u4e00\u4e0b\u5b8c\u6574\u7684 Mesh \u8fc7\u7a0b\u3002\u6574\u4e2a\u8fc7\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u8bf7\u6c428082\u7aef\u53e3\uff1a curl 127.0.0.1:8082/ StatusCode : 200 StatusDescription : OK Content : hello world RawContent : HTTP/1.1 200 OK Accept-Encoding: gzip Connection: Keep-Alive User-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; zh-CN) WindowsPowerShell/5.1.18362.1171 Content-Length: 11 Content-Type: text/pl... \u89e3\u6790\u53ef\u4ee5\u53d1\u73b0\uff0c\u8fd9\u91cc\u7684\u6d41\u91cf\u7ecf\u7531 8082\uff0c\u88ab\u8f6c\u53d1\u5230\u4e86 8083 \u7aef\u53e3\uff0c\u7ecf\u5386\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684 Mesh \u4ee3\u7406\u8fc7\u7a0b\u3002 \u4ece\u5ba2\u6237\u7aef\u7684\u6b63\u5411\u4ee3\u7406\uff0c\u5230\u670d\u52a1\u7aef\u7684\u53cd\u5411\u4ee3\u7406\uff0c\u901a\u8fc7\u5bf9\u51fa\u6d41\u91cf\u548c\u5165\u6d41\u91cf\u8fdb\u884c\u4ee3\u7406\uff0c\u5b8c\u6574\u638c\u63a7\u4e86\u6574\u4e2a\u5fae\u670d\u52a1\u94fe\u8def\u7684\u6d41\u91cf\u3002\u6700\u540e\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u4e86\u771f\u5b9e\u7684 Service\uff0c\u4e5f\u5c31\u662f 6060 \u7aef\u53e3\u542f\u52a8\u7684\u670d\u52a1\u3002 \u5230\u8fd9\u91cc\uff0c\u5229\u7528 Go-Micro \u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684 Sidecar \u5c31\u5b8c\u6210\u4e86\u3002\u4f60\u53ef\u4ee5\u770b\u5230\uff0cSidecar \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u4ee3\u7406\u7a0b\u5e8f\uff0c\u800c\u5229\u7528 Go-Micro \u5b9e\u73b0\u4e00\u4e2a Sidecar \u539f\u578b\u4e5f\u5e76\u4e0d\u590d\u6742\uff0c\u4f46\u8981\u505a\u4e00\u4e2a\u751f\u4ea7\u73af\u5883\u53ef\u7528\u7684 Sidecar \u8fd8\u6709\u5f88\u591a\u5de5\u4f5c\u8981\u5b8c\u5584\uff0c \u6bd4\u5982\u4e00\u4e9b\u9519\u8bef\u7684\u5904\u7406\u3001\u591a\u79cd\u534f\u8bae\u7684\u652f\u6301\u3001\u652f\u6301\u590d\u6742\u7684\u8def\u7531\u548c\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u4ee5\u53ca\u9650\u6d41\u7194\u65ad\u7b49\u57fa\u672c\u7684\u670d\u52a1\u6cbb\u7406\u529f\u80fd \u3002 \u5b9e\u9645\u4e0a\uff0c\u5728 Go \u8bed\u8a00\u4e2d\u8fd8\u6709\u53e6\u5916\u4e00\u79cd\u5b9e\u73b0 HTTP \u4ee3\u7406\u66f4\u7b80\u5355\u3001\u66f4\u7a33\u5b9a\u7684\u65b9\u6cd5\uff0c\u8fd9\u91cc\u6211\u4eec\u4e5f\u7b80\u5355\u505a\u4e00\u4e0b\u4ecb\u7ecd\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u6ca1\u6709\u7740\u91cd\u4ecb\u7ecd\u8fd9\u79cd\u65b9\u6cd5\uff0c\u800c\u9009\u62e9\u91c7\u7528 Go-Micro \u6765\u5b9e\u73b0\uff0c\u662f\u56e0\u4e3a Go-Micro \u65b9\u4fbf\u6269\u5c55\u591a\u79cd\u534f\u8bae\uff0c\u4ee5\u53ca\u7edf\u4e00\u7684\u4e2d\u95f4\u4ef6\u5c42\u3002 package main import ( \"log\" \"math/rand\" \"net/http\" \"net/http/httputil\" \"net/url\" ) func NewMultipleHostsReverseProxy(targets []*url.URL) *httputil.ReverseProxy { director := func(req *http.Request) { target := targets[rand.Int()%len(targets)] req.URL.Scheme = target.Scheme req.URL.Host = target.Host req.URL.Path = target.Path } return &httputil.ReverseProxy{Director: director} } func main() { proxy := NewMultipleHostsReverseProxy([]*url.URL{ { Scheme: \"http\", Host: \"localhost:6060\", }, }) log.Fatal(http.ListenAndServe(\":9090\", proxy)) } \u53ef\u4ee5\u770b\u5230\uff0c Golang \u672c\u8eab\u63d0\u4f9b\u4e86 ReverseProxy \u7684\u5bf9\u8c61 \u3002 \u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u5bf9\u8c61\uff0c\u5e76\u4f20\u5165 HTTP Server\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684 HTTP Proxy \u529f\u80fd\u3002\u5bf9\u4e8e HTTP \u670d\u52a1\u6765\u8bf4\uff0c\u8fd9\u4e2a Proxy \u5b9e\u73b0\u6bd4 Go-Micro \u7684\u5b9e\u73b0\u76f8\u5bf9\u9ad8\u6548\uff0c\u5b83\u5e76\u6ca1\u6709\u521b\u5efa HTTP Client\uff0c\u800c\u662f\u76f4\u63a5\u5229\u7528\u4e86\u66f4\u5e95\u5c42\u7684 HTTP Transport \u8fdb\u884c\u6d41\u91cf\u7684\u8f6c\u53d1\uff0c Golang \u7684\u6e90\u7801: https://github.com/golang/go/blob/master/src/net/http/httputil/reverseproxy.go","title":"2-2 \u4ee3\u7801\u89e3\u6790"},{"location":"chap2/8chap3_SM_GO_PROJ/#3-xds","text":"\u4ee3\u7801\u5b9e\u73b0 Service Mesh \u63a7\u5236\u9762\uff0c\u5b9e\u73b0 xDS \u914d\u7f6e\u7ba1\u7406\uff0c\u4ee5\u53ca\u6570\u636e\u9762 Sidecar \u5982\u4f55\u4e0e\u63a7\u5236\u9762\u8fdb\u884c\u901a\u4fe1\u3002 \u4ee3\u7801\u5b9e\u73b0\u5728https://github.com/beck917/easypilot\u548chttps://github.com/beck917/easymesh\u4e2d Envoy \u5b98\u65b9\u7684\u5b9e\u4f8b\u548c\u8457\u540d\u7684\u63a7\u5236\u9762 Istio\uff0c\u90fd\u9009\u62e9\u4f7f\u7528 Go \u8bed\u8a00\u6765\u5b9e\u73b0\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u4e5f\u91c7\u7528 Go \u8bed\u8a00\u5b9e\u73b0\u63a7\u5236\u9762\u4ee3\u7801","title":"3\u3001 \u63a7\u5236\u9762\uff1a\u5b9e\u73b0 xDS \u914d\u7f6e\u7ba1\u7406"},{"location":"chap2/8chap3_SM_GO_PROJ/#3-1","text":"\u9996\u5148\u770b\u4e00\u4e0b main.go \u7684\u5165\u53e3\u4ee3\u7801\uff0c\u8fd9\u90e8\u5206\u4ee3\u7801\u521b\u5efa\u4e86\u4e00\u4e2a gRPC Server\uff0c\u6765\u63d0\u4f9b xDS \u670d\u52a1\u3002 go-control-plane \u7c7b\u5e93\u4f7f\u7528 Snapshot \u7684\u65b9\u5f0f\u5b58\u50a8\u6570\u636e\uff0c\u6bd4\u5982 EDS \u4e2d\u7684 Endpoint \u6570\u636e\uff0c\u5982\u679c\u8fdb\u884c\u6570\u636e\u66f4\u65b0\uff0c\u53ea\u9700\u5237\u65b0 Snapshot \u6570\u636e\u5c31\u53ef\u4ee5\u4e86 \u3002 \u8fd9\u91cc\u9996\u5148\u521b\u5efa\u4e86 SnapshotCache\uff0c\u7136\u540e\u7528 Mock \u7684\u6570\u636e\u751f\u6210\u4e86\u4e00\u4efd Snapshot\uff0c\u6700\u540e\u5c06 Snapshop \u5b58\u50a8\u5230 Cache \u4e2d\uff0c\u4e3a\u5bf9\u5e94\u7684 NodeID \u751f\u6210\u4e00\u4efd Cache \u6570\u636e\uff0c\u8fd9\u6837 xDS Server \u5728\u63d0\u4f9b\u670d\u52a1\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u5c06\u5bf9\u5e94\u7684\u6570\u636e\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u4e86\uff1a // \u521b\u5efa\u7f13\u5b58 cache := cachev3.NewSnapshotCache(false, cachev3.IDHash{}, l) // \u521b\u5efa snapshot \u6570\u636e\uff0c\u7528\u4e8e\u7ed9\u6570\u636e\u9762\u63d0\u4f9b xds \u6570\u636e snapshot := example.GenerateSnapshot() if err := snapshot.Consistent(); err != nil { l.Errorf(\"snapshot inconsistency: %+v\\n%+v\", snapshot, err) os.Exit(1) } l.Debugf(\"will serve snapshot %+v\", snapshot) // \u5c06 snapshot \u5199\u5165\u7f13\u5b58 if err := cache.SetSnapshot(nodeID, snapshot); err != nil { l.Errorf(\"snapshot error %q for %+v\", err, snapshot) os.Exit(1) } // \u8fd0\u884c xds \u670d\u52a1\u5668 ctx := context.Background() cb := &testv3.Callbacks{Debug: l.Debug} srv := serverv3.NewServer(ctx, cache, cb) example.RunServer(ctx, srv, port) \u5148\u6765\u770b example.GenerateSnapshot() \u8fd9\u4e2a\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u6a21\u62df\u4e86\u4e00\u4e9b\u6d4b\u8bd5\u6570\u636e\u3002 \u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\u521b\u5efa\u4e86 CDS\u3001EDS\u3001RDS\u3001LDS \u5bf9\u5e94\u7684\u6570\u636e\uff0c\u5176\u4e2d\u5305\u62ec\u96c6\u7fa4\u3001\u8282\u70b9\u3001\u8def\u7531\u3001\u76d1\u542c\u5668\u7b49\u6570\u636e\uff1a func GenerateSnapshot() cache.Snapshot { return cache.NewSnapshot( \"1\", []types.Resource{}, // endpoints []types.Resource{makeCluster(ClusterName)}, []types.Resource{makeRoute(RouteName, ClusterName)}, []types.Resource{makeHTTPListener(ListenerName, RouteName)}, []types.Resource{}, // runtimes []types.Resource{}, // secrets ) } \u6211\u4eec\u518d\u6765\u770b CDS \u548c EDS \u7684\u6570\u636e\u521b\u5efa\u3002 \u6211\u4eec\u5148\u6765\u770b Cluster \u7684\u6570\u636e\u7c7b\u578b\u7684\u53c2\u6570\uff1a func makeCluster(clusterName string) *cluster.Cluster { return &cluster.Cluster{ Name: clusterName, ConnectTimeout: ptypes.DurationProto(5 * time.Second), ClusterDiscoveryType: &cluster.Cluster_Type{Type: cluster.Cluster_LOGICAL_DNS}, LbPolicy: cluster.Cluster_ROUND_ROBIN, LoadAssignment: makeEndpoint(clusterName), DnsLookupFamily: cluster.Cluster_V4_ONLY, } } func makeEndpoint(clusterName string) *endpoint.ClusterLoadAssignment { return &endpoint.ClusterLoadAssignment{ ClusterName: clusterName, Endpoints: []*endpoint.LocalityLbEndpoints{{ LbEndpoints: []*endpoint.LbEndpoint{{ HostIdentifier: &endpoint.LbEndpoint_Endpoint{ Endpoint: &endpoint.Endpoint{ Address: &core.Address{ Address: &core.Address_SocketAddress{ SocketAddress: &core.SocketAddress{ Protocol: core.SocketAddress_TCP, Address: UpstreamHost, PortSpecifier: &core.SocketAddress_PortValue{ PortValue: UpstreamPort, }, }, }, }, }, }, }}, }}, } } \u63a5\u4e0b\u6765\u770b\u4e00\u4e0b example.RunServer(ctx, srv, port) \u8fd9\u4e2a\u65b9\u6cd5\u3002\u8be5\u65b9\u6cd5\u9996\u5148\u521b\u5efa\u4e86\u4e00\u4e2a gRPC Server\uff0c\u5e76\u8bbe\u7f6e\u4e86 grpcMaxConcurrentStreams \uff1a // \u542f\u52a8 xds server func RunServer(ctx context.Context, srv3 serverv3.Server, port uint) { // \u8bbe\u7f6e grpcMaxConcurrentStreams \u53c2\u6570\uff0c\u7528\u4e8e\u589e\u52a0\u9ed8\u8ba4\u7684\u5355\u8fde\u63a5\u5e76\u53d1\u6570\u91cf var grpcOptions []grpc.ServerOption grpcOptions = append(grpcOptions, grpc.MaxConcurrentStreams(grpcMaxConcurrentStreams)) grpcServer := grpc.NewServer(grpcOptions...) lis, err := net.Listen(\"tcp\", fmt.Sprintf(\":%d\", port)) if err != nil { log.Fatal(err) } registerServer(grpcServer, srv3) log.Printf(\"management server listening on %d\\n\", port) if err = grpcServer.Serve(lis); err != nil { log.Println(err) } } \u63a5\u6765\u4e0b\u901a\u8fc7 registerServer \u65b9\u6cd5\uff0c\u5c06\u63d0\u4f9b xDS \u670d\u52a1\u7684 Service \u6ce8\u518c\u5230\u5df2\u7ecf\u521b\u5efa\u597d\u7684 gRPC Server \u4e0a\u9762\uff0c\u7528\u4e8e\u63d0\u4f9b\u5bf9\u5e94\u7684 xDS Server\u670d\u52a1\u3002\u4f60\u8981\u6ce8\u610f\uff0c\u8fd9\u91cc\u6709\u4e00\u4e2a RegisterAggregatedDiscoveryServiceServer \u7684 Server \u63d0\u4f9b\u805a\u5408\u67e5\u8be2\u670d\u52a1\uff0c\u901a\u8fc7\u8fd9\u4e2a Server \u53ef\u4ee5\u4e3a\u6240\u6709\u7684 xDS \u534f\u8bae\u63d0\u4f9b\u670d\u52a1\uff1a func registerServer(grpcServer *grpc.Server, server serverv3.Server) { // \u6ce8\u518c\u670d\u52a1 discoverygrpc.RegisterAggregatedDiscoveryServiceServer(grpcServer, server) endpointservice.RegisterEndpointDiscoveryServiceServer(grpcServer, server) clusterservice.RegisterClusterDiscoveryServiceServer(grpcServer, server) routeservice.RegisterRouteDiscoveryServiceServer(grpcServer, server) listenerservice.RegisterListenerDiscoveryServiceServer(grpcServer, server) secretservice.RegisterSecretDiscoveryServiceServer(grpcServer, server) runtimeservice.RegisterRuntimeDiscoveryServiceServer(grpcServer, server) } \u4e00\u4e2a\u7b80\u5355\u7684 xDS Server \u5c31\u8bb2\u5b8c\u4e86\u3002\u8fd9\u91cc\u7684 xDS Server \u586b\u5145\u4e86\u4e00\u4e9b\u6d4b\u8bd5\u6570\u636e\u6765\u6a21\u62df\u7ed3\u679c\uff0c\u5982\u679c\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\uff0c\u9700\u8981\u63a5\u5165\u76f8\u5e94\u7684\u5e73\u53f0\u624d\u80fd\u63d0\u4f9b\u6570\u636e\u3002 \u6bd4\u5982\u5728 Istio \u4e2d\u901a\u8fc7 Kubernetes \u7684 API \u4e3a xDS Server \u63d0\u4f9b\u6570\u636e\uff1b\u901a\u8fc7\u5728 YAML \u4e2d\u58f0\u660e VirtualService \u7c7b\u578b\u6765\u4e3a RDS \u670d\u52a1\u63d0\u4f9b\u6570\u636e\u3002\u53c8\u6216\u8005\u4f7f\u7528\u4e86\u7b2c\u4e09\u65b9\u7684\u6ce8\u518c\u4e2d\u5fc3\uff0c\u6bd4\u5982 Consul\uff0c\u5219\u9700\u8981\u901a\u8fc7 Consul API \u4e3a EDS \u670d\u52a1\u63d0\u4f9b\u6570\u636e \u3002 \u6211\u4eec\u901a\u8fc7\u4e00\u4e2a EDS Client\uff0c\u6765\u770b\u4e00\u4e0b\u5982\u4f55\u5728\u6570\u636e\u9762 Sidecar \u4e2d\u901a\u8fc7 xDS \u548c\u63a7\u5236\u9762\u534f\u8bae\u901a\u4fe1\u3002\u8fd9\u90e8\u5206\u4ee3\u7801\u8fd8\u662f\u5728 https://github.com/beck917/easymesh \u4ee3\u7801\u4ed3\u5e93\u4e2d\u3002 \u5148\u6765\u770b utils/eds \u6587\u4ef6\u5939\u4e0b\u7684\u4ee3\u7801\u3002 \u9996\u5148\u901a\u8fc7 NewWithInterval \u521b\u5efa\u4e00\u4e2a EDS \u5bf9\u8c61\uff0c\u7136\u540e\u8fde\u63a5 EDS \u670d\u52a1\u5668\uff0c\u5e76\u4e14\u521b\u5efa\u4e00\u4e2a Goroutine\uff0c\u901a\u8fc7 Loop \u7684\u65b9\u6cd5\u5b9a\u65f6\u53d1\u9001\u8bf7\u6c42\u6570\u636e\u5230 EDS \u670d\u52a1\u5668\u3002\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u4e86\u63a8\u62c9\u7ed3\u5408\u7684\u65b9\u5f0f\u6765\u83b7\u53d6 EDS \u6570\u636e\uff1a func NewWithInterval(addr string, interval time.Duration) (*adapter, error) { if interval <= 0 { interval = time.Minute } urlobj, err := url.Parse(addr) if err == nil && len(urlobj.Host) > 0 { addr = urlobj.Host } eds := &adapter{ addr: addr, node: &core.Node{ Id: generateNodeID(), }, single: new(singleflight.Group), cache: registry.NewServiceCache(nil, 0), streams: sync.Map{}, fetchInterval: interval, } err = eds.connect() if err != nil { return nil, errors.Wrap(err) } // \u5b9a\u65f6\u62c9\u53d6\u6570\u636e go eds.loop() return eds, nil } \u540c\u65f6\u5728\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\uff0c\u6211\u4eec\u91c7\u7528 getService \u6765\u83b7\u53d6\u670d\u52a1\u8282\u70b9\u6570\u636e\u3002 \u8fd9\u4e2a\u65b9\u6cd5\u9996\u5148\u4f1a\u8bfb\u53d6\u7f13\u5b58\u4e2d\u7684\u6570\u636e\uff0c\u5982\u679c\u7f13\u5b58\u4e2d\u6ca1\u6709\u6570\u636e\u5219\u4f1a\u901a\u8fc7\u521b\u5efa\u548c EDS \u670d\u52a1\u5668\u5efa\u7acb Watch \u673a\u5236\uff0c\u52a8\u6001\u66f4\u65b0 Cache \u4e2d\u7684\u6570\u636e\uff1a func (eds *adapter) GetServices(name string, opts ...registry.DiscoveryOption) (services []*registry.Service, err error) { if eds.ccErr != nil { err = errors.Wrap(eds.ccErr) return } options := registry.NewCommonDiscoveryOption(opts...) key := registry.NewServiceKey(name, options.Tags, options.DC) // \u7b2c\u4e00\u6b65\uff0c\u4ece\u7f13\u5b58\u8bfb\u53d6 services, err = eds.cache.GetServices(key) if err == nil && len(services) > 0 { return } // \u4ece eds \u670d\u52a1\u83b7\u53d6 return eds.fetchServices(key, options.Tags) } startWatch \u65b9\u6cd5\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 Goroutine \u7528\u4e8e\u76d1\u542c EDS \u6570\u636e\u7684\u53d8\u5316\uff0c\u901a\u8fc7 parseStream \u963b\u585e\u83b7\u53d6 EDS Server \u7684\u63a8\u9001\u83b7\u53d6\u6570\u636e\uff0c\u83b7\u53d6\u6570\u636e\u540e\uff0c\u5c06\u6570\u636e\u5b58\u5165 Cache \u4e2d \uff1a func (eds *adapter) startWatch(client discovery.AggregatedDiscoveryService_StreamAggregatedResourcesClient, key registry.ServiceKey, tags []string) { logger.Infof(\"eds.Watch(%+v) ...\", key) go func(streamClient discovery.AggregatedDiscoveryService_StreamAggregatedResourcesClient, serviceKey registry.ServiceKey) { defer func() { if panicErr := recover(); panicErr != nil { logger.Errorf(\"eds.startWatch() panic: %+v\", panicErr) } else { //eds.streams.Delete(key) } }() for { services, err := eds.parseStream(eds.getStreamClient(key), tags) if err != nil { logger.Errorf(\"eds.Watch(%+v): %+v\", key, err) time.Sleep(1 * time.Second) continue } if len(services) <= 0 { logger.Warnf(\"eds.Watch(%+v): empty services, ignored!\", key) continue } ipv4s := make([]string, len(services)) for i, svc := range services { ipv4s[i] = svc.ServiceIP() } logger.Infof(\"eds.Watch(%+v): total=%d, services=%+v\", key, len(services), ipv4s) eds.cache.Set(key, services) if eds.watcher != nil { eds.watcher.Handle(key, services) } } }(client, key) } \u5f53\u53d1\u9001\u6570\u636e\uff0c\u6216\u8005\u83b7\u53d6\u6570\u636e\u9519\u8bef\u7684\u65f6\u5019\uff0c\u9700\u8981\u91cd\u65b0\u8fde\u63a5 EDS \u670d\u52a1\u5668\uff0c\u5426\u5219\u4e00\u65e6\u7f51\u7edc\u5f02\u5e38\u6216\u8005 EDS \u670d\u52a1\u5668\u91cd\u542f\uff0c\u5bfc\u81f4 EDS \u8fde\u63a5\u65ad\u5f00\uff0c\u5c31\u65e0\u6cd5\u6b63\u786e\u5730\u66f4\u65b0\u6570\u636e\u4e86 \u3002 \u548c\u4f20\u7edf\u7684\u5728 Client SDK \u4e2d\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u5668\u6709\u6240\u4e0d\u540c\uff0cSDK \u4e2d\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u4e00\u822c\u662f\u521b\u5efa\u597d\u540e\u4f20\u5165 Client \u5bf9\u8c61\u3002 Client \u5bf9\u8c61\u5728\u53d1\u51fa\u8bf7\u6c42\u524d\uff0c\u5148\u8c03\u7528\u8d1f\u8f7d\u5747\u8861\u5668\u7684 Next \u65b9\u6cd5\uff0c\u83b7\u53d6\u5230\u88ab\u8c03\u670d\u52a1\u7684 IP\uff0c\u7136\u540e\u8fdb\u884c\u670d\u52a1\u8bf7\u6c42\u3002\u6bd4\u5982\u4e0b\u9762\u7684\u4ee3\u7801\uff1a var srv *registry.Service srv, err = tp.rr.Next(ireq.Context(), host) if err != nil { logger.Errorf(\"get host:%v err:%v\", host, err) continue } ireq.URL.Host = srv.Addr() resp, err = tp.rt.RoundTrip(ireq)\u3001 \u4f46\u5728 Sidecar \u4e2d\uff0c\u8d1f\u8f7d\u5747\u8861\u5668\u7ec4\u4ef6\u4e5f\u88ab\u62bd\u8c61\u6210\u4e86\u4e2d\u95f4\u4ef6\u7684\u65b9\u5f0f\uff0c \u5177\u4f53\u5728 Go-Micro \u4e2d\uff0c\u5c31\u662f\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Wrapper\u3002\u800c\u4e14\u8fd9\u4e9b\u4e2d\u95f4\u4ef6\u90fd\u88ab\u7edf\u4e00\u5199\u5728\u4e86 Server \u7684\u4e2d\u95f4\u4ef6\u4e2d \uff0c\u5e76\u4e0d\u9700\u8981\u5199\u5728 Client \u7684\u4e2d\u95f4\u4ef6\u4e2d\uff0c\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u7684\u62bd\u8c61\u7a0b\u5ea6\u66f4\u597d\uff0c\u6a21\u578b\u4e5f\u66f4\u52a0\u7edf\u4e00\uff0c\u5bf9\u4e8e\u7406\u89e3\u548c\u7f16\u5199\u3001\u7ef4\u62a4\u4ee3\u7801\u90fd\u6709\u5e2e\u52a9\u3002 \u8def\u7531\u5668\u4e2d\u95f4\u4ef6\u7684\u4f5c\u7528\u662f\u6839\u636e\u6211\u4eec\u7684\u8bf7\u6c42\u53c2\u6570\uff0c\u6bd4\u5982 header\u3001path \u7b49\uff0c\u627e\u5230\u5bf9\u5e94\u7684\u670d\u52a1\u3002\u53ea\u6709\u901a\u8fc7\u8def\u7531\u5668\u4e2d\u95f4\u4ef6\u627e\u5230\u4e86\u5bf9\u5e94\u7684\u670d\u52a1\u540d\uff0c\u6211\u4eec\u624d\u80fd\u8ba9\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u95f4\u4ef6\u901a\u8fc7\u670d\u52a1\u540d\u627e\u5230\u5bf9\u5e94\u7684 Endpoint\u3002 \u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u901a\u8fc7 match \u65b9\u6cd5\u83b7\u53d6\u5230\u4e86\u5bf9\u5e94\u7684 router \u5bf9\u8c61\u548c router \u5bf9\u8c61\u5185\u5305\u542b\u7684 handlers\uff0c \u8fd9\u4e2a handler \u5b9e\u9645\u4e0a\u662f\u7ed1\u5b9a\u5728 router \u4e0a\u7684\u53e6\u5916\u4e00\u5957\u4e2d\u95f4\u4ef6\u4f53\u7cfb\uff0c\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u8ba9\u4e2d\u95f4\u4ef6\u66f4\u5bb9\u6613\u83b7\u53d6 router \u7684\u4e00\u4e9b\u4fe1\u606f\uff0c\u5426\u5219\u8fd8\u9700\u8981\u901a\u8fc7 routername \u67e5\u8be2\u624d\u80fd\u83b7\u53d6\u5230\u76f8\u5173\u4fe1\u606f \u3002 // HandlerWrapper \u670d\u52a1\u7aef\u4e2d\u95f4\u4ef6 func (wrap *Wrappers) HandlerWrapper() server.HandlerWrapper { return func(next server.HandlerFunc) server.HandlerFunc { return func(ctx context.Context, req server.Request, rsp interface{}) error { route, handlers := wrap.match(req.Service(), req.Method()) if route == nil { return errors.NotFound(\"mesh.wrap.router\", \"route mismatch\") } ctx = context.WithValue(ctx, defs.CtxRouter{}, route) handler := func(ctx context.Context, req server.Request, rsp interface{}) error { return next(ctx, req, rsp) } // \u5d4c\u5957\u81ea\u5b9a\u4e49 wraps for i := len(handlers); i > 0; i-- { handler = handlers[i-1](handler) } return handler(ctx, req, rsp) } } } \u6bcf\u4e2a\u4e2d\u95f4\u4ef6\uff0c\u90fd\u6709\u4e00\u4e2a Reload \u7684\u65b9\u6cd5\uff0c\u8fd9\u4e2a Reload \u65b9\u6cd5\u7528\u6765\u66f4\u65b0 xDS \u83b7\u53d6\u7684\u914d\u7f6e\u5230\u5177\u4f53\u7684\u4e2d\u95f4\u4ef6\u5bf9\u8c61\u4e2d\u3002 \u6bd4\u5982 router \u4e2d\u95f4\u4ef6\u7684 Reload \u65b9\u6cd5\uff0c\u5c31\u5c06\u6240\u6709\u7684\u8def\u7531\u4fe1\u606f\u89e3\u6790\u51fa\u6765\uff0c\u5b58\u50a8\u5728 ServiceRoutes \u5bf9\u8c61\u4e2d\uff0c\u7528\u4e8e match \u65b9\u6cd5\u7684\u5339\u914d\uff0c\u8fd9\u6837\u624d\u80fd\u627e\u5230\u8bf7\u6c42\u5177\u4f53\u5bf9\u5e94\u7684\u670d\u52a1\u540d\u3002 \u8d1f\u8f7d\u5747\u8861\u5668\u7684\u4e2d\u95f4\u4ef6\uff0c\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u4e5f\u7ed1\u5b9a\u5728\u8def\u7531\u5bf9\u8c61\u4e2d\uff0c\u5f53\u5339\u914d\u5230\u5bf9\u5e94\u7684\u8def\u7531\u540e\uff0c\u4f1a\u81ea\u52a8\u901a\u8fc7 Next \u65b9\u6cd5\u8c03\u7528\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u3002 // \u6ce8\u5165\u4e2d\u95f4\u4ef6 routeHandlers := handlers lbWrap, err := loadbalance.HandlerWrapper(srv, config, dis) if err != nil { return fmt.Errorf(\"service key:%s empty route:%+v build lb wrap err:%v\", srvKey, route, err) } \u8d1f\u8f7d\u5747\u8861\u5668\u4f1a\u901a\u8fc7 nextNode \u7684\u65b9\u6cd5\u83b7\u53d6\u8bf7\u6c42\u7684\u8282\u70b9\uff0cnextNode \u65b9\u6cd5\u76f4\u63a5\u4ece LB \u5bf9\u8c61\u4e2d\u83b7\u53d6\u76f8\u5e94\u7684 Endpoint \u6570\u636e\u3002 \u8fd9\u91cc\u548c EDS \u7684\u7c7b\u5e93\u6709\u4e00\u4e2a\u4ea4\u4e92\uff0cEDS \u7c7b\u5e93\u5728\u83b7\u53d6\u5230\u65b0\u7684\u6570\u636e\u65f6\u4f1a\u4e3b\u52a8\u66f4\u65b0 LB \u5bf9\u8c61\u4e2d\u7684\u6570\u636e\uff0c\u4ee5\u786e\u4fdd LB \u4e2d\u7684 Next \u65b9\u6cd5\u53ef\u4ee5\u4e00\u76f4\u83b7\u53d6\u5230\u6700\u65b0\u7684\u8282\u70b9\u6570\u636e \u3002 // HandlerWrapper \u8d1f\u8f7d\u5747\u8861\u548c\u670d\u52a1\u53d1\u73b0 func HandlerWrapper(cluster *qdx.Cluster, config *types.Config, dis qudiscovery.Discovery) (server.HandlerWrapper, error) { nextNode, err := newNext(cluster, config.Upstreams, dis) if err != nil { return nil, err } return func(next server.HandlerFunc) server.HandlerFunc { return func(ctx context.Context, req server.Request, rsp interface{}) error { node, err := nextNode() if err != nil { return errors.BadRequest(\"mesh.wrap.lb\", \"lb.next err:%v\", err) } ctx = context.WithValue(ctx, defs.CtxAddress{}, node.Address) return next(ctx, req, rsp) } }, nil }","title":"3-1 \u4ee3\u7801\u89e3\u6790"},{"location":"chap2/9chap3_pratice/","text":"\u7b2c\u4e5d\u8282 Service Mesh \u843d\u5730\u548c\u5c55\u671b 1\u3001\u5728\u5b9e\u8df5\u843d\u5730\u4e2d\u53ef\u80fd\u9047\u5230\u7684\u95ee\u9898\u548c\u56f0\u96be 1-1 \u5fae\u670d\u52a1\u6846\u67b6\u529f\u80fd\u53ca\u4f9d\u8d56\u7684\u5916\u90e8\u57fa\u7840\u8bbe\u65bd \u5fae\u670d\u52a1\u6846\u67b6\u529f\u80fd\u53ca\u4f9d\u8d56\u7684\u5916\u90e8\u57fa\u7840\u8bbe\u65bd \u670d\u52a1\u6ce8\u518c\u53d1\u73b0 \uff1a\u5fae\u670d\u52a1\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u8d1f\u8d23\u670d\u52a1\u7684\u6ce8\u518c\uff0c\u4ee5\u53ca upstream \u670d\u52a1\u7684 Endpoint \u7684\u53d1\u73b0\u3002 \u8def\u7531 \uff1a\u8d1f\u8d23\u6d41\u91cf\u8f6c\u53d1\u7684\u914d\u7f6e\u3002 \u8d1f\u8f7d\u5747\u8861 \uff1a\u5177\u5907\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u9488\u5bf9 upstream Endpoint \u8fdb\u884c\u6d41\u91cf\u5206\u53d1\u3002 \u670d\u52a1\u6cbb\u7406 \uff1a\u901a\u5e38\u6307\u7684\u662f\u9650\u6d41\u3001\u7194\u65ad\u3001\u964d\u7ea7\u7b49\u53ef\u4ee5\u63d0\u9ad8\u5fae\u670d\u52a1\u67b6\u6784\u7a33\u5b9a\u6027\u7684\u63aa\u65bd\u3002 \u53ef\u89c2\u6d4b\u6027 \uff1aMetrics\u3001\u65e5\u5fd7\u3001\u94fe\u8def\u8ffd\u8e2a\u7b49\u7ec4\u4ef6\u3002 \u811a\u624b\u67b6 \uff1a\u5fae\u670d\u52a1\u6846\u67b6\u4e3a\u4e86\u8ba9\u4e1a\u52a1\u5feb\u901f\u4e0a\u624b\uff0c\u901a\u5e38\u9700\u8981\u4e00\u4e2a\u811a\u624b\u67b6\uff0c\u8ba9\u4e1a\u52a1\u65b9\u5feb\u901f\u751f\u6210\u9879\u76ee\u4ee3\u7801\u3002 RPC \uff1a\u8fd9\u91cc\u6307\u7684\u662f\u5e7f\u4e49\u7684 RPC\uff0c\u53ef\u4ee5\u662f gRPC \u6216\u8005 Dubbo \u7b49 RPC \u534f\u8bae\uff0c\u4e5f\u53ef\u4ee5\u662f HTTP \u534f\u8bae\u3002 \u5f53\u7136\uff0c\u6574\u4e2a\u5fae\u670d\u52a1\u7684\u751f\u6001\u5728\u4e0d\u65ad\u6f14\u8fdb\uff0c\u7ed3\u5408\u516c\u53f8\u7684\u9700\u6c42\uff0c\u9002\u5f53\u589e\u52a0\u4e00\u4e9b\u65b0\u7684\u529f\u80fd\u4e5f\u662f\u6709\u5fc5\u8981\u7684\uff0c\u6bd4\u5982\u67d3\u8272\u3001\u901a\u7528 header \u4f20\u9012\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\u3002 \u5fae\u670d\u52a1\u6846\u67b6\u843d\u5730\u4f9d\u8d56\u4e8e\u5916\u90e8\u54ea\u4e9b\u57fa\u7840\u8bbe\u65bd\u3002 \u8fb9\u7f18\u7f51\u5173\u5c42 \uff1a\u7edf\u4e00\u7684\u5165\u53e3\u7f51\u5173\u5c42\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u7684\u5165\u53e3\u5c42\uff0c\u8d1f\u8d23\u5357\u5317\u6d41\u91cf\u7684\u6cbb\u7406\u3002 \u76d1\u63a7\u544a\u8b66 \uff1a\u6536\u96c6\u4e1a\u52a1\u7684 Metrics\u3001Trace\u3001Log \u7b49\u4fe1\u606f\uff0c\u5e76\u914d\u7f6e\u76d1\u63a7\u544a\u8b66\u3002 \u914d\u7f6e\u4e2d\u5fc3 \uff1a\u8d1f\u8d23\u5fae\u670d\u52a1\u7684\u7cfb\u7edf\u914d\u7f6e\u7684\u7ba1\u7406\uff0c\u6bd4\u5982 MySQL\u3001Redis\uff0c\u4ee5\u53ca\u4e0a\u4e0b\u6e38\u670d\u52a1\u7684\u8c03\u7528\u914d\u7f6e\u7b49\u3002 CI/CD\uff1a\u5305\u542b CI \u6301\u7eed\u96c6\u6210\uff08Continuous Integration\uff09\u548c CD \u6301\u7eed\u90e8\u7f72\uff08Continuous Deployment\uff09 \u3002\u6301\u7eed\u96c6\u6210\u4e3b\u8981\u662f\u6307\u4ee3\u7801\u90e8\u7f72\u524d\u7684\u81ea\u52a8\u5316\u6d4b\u8bd5\u548c\u81ea\u52a8\u5316\u7f16\u8bd1\u6253\u5305\u7684\u8fc7\u7a0b\uff0c\u6301\u7eed\u90e8\u7f72\u662f\u6307\u7f16\u8bd1\u6253\u5305\u540e\u7684\u4ee3\u7801\u90e8\u7f72\u53d1\u5e03\u7684\u8fc7\u7a0b\u3002\u4ee3\u7801\u53d1\u5e03\u548c\u90e8\u7f72\u5206\u5f00\uff0c \u6709\u5229\u4e8e\u7248\u672c\u63a7\u5236\u548c\u56de\u6eda \uff0c\u65b9\u4fbf\u7ebf\u4e0a\u968f\u65f6\u6062\u590d\u5230\u4efb\u610f\u7248\u672c\u3002\u5f00\u6e90\u65b9\u6848\u4e3b\u8981\u6709 GitLab \u548c Jenkins\u3002 PAAS \u5e73\u53f0\uff1a\u8fd9\u91cc\u4e3b\u8981\u662f\u6307\u8fd0\u7ef4\u7ba1\u7406\u5e73\u53f0\uff0c\u4e3b\u8981\u5305\u542b\u673a\u5668\u7684\u8d44\u6e90\u7ba1\u7406\u7684 CMDB\u3001\u5fae\u670d\u52a1\u6d41\u7a0b\u7ba1\u7406\u3001\u670d\u52a1\u6cbb\u7406\u5e73\u53f0\u7b49 \u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5728\u8fd9\u4e2a\u5e73\u53f0\u4e2d\uff0c\u6211\u4eec\u7533\u8bf7\u673a\u5668\u8d44\u6e90\u3001\u5404\u7c7b\u4e2d\u95f4\u4ef6\u8d44\u6e90\u3001\u6570\u636e\u5e93\u8d44\u6e90\u3001\u7f13\u5b58\u5c42\u8d44\u6e90\uff0c\u4ee5\u53ca\u5404\u79cd\u673a\u5668\u7684\u6743\u9650\u7b49\uff1b\u53e6\u5916\u5305\u62ec\u6574\u4e2a\u5fae\u670d\u52a1\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u3001\u670d\u52a1\u6cbb\u7406\u7684\u9650\u6d41\u7194\u65ad\u7b49\u914d\u7f6e\uff0c\u90fd\u53ef\u4ee5\u5728\u8fd9\u4e2a\u4e00\u7ad9\u5f0f\u7684\u670d\u52a1\u5e73\u53f0\u89e3\u51b3\u3002PAAS \u5e73\u53f0\u5728\u5fae\u670d\u52a1\u67b6\u6784\u7684\u843d\u5730\u4e2d\u81f3\u5173\u91cd\u8981\uff0c\u5bf9\u4e8e\u63d0\u9ad8\u4ea7\u7814\u6548\u7387\u8d77\u7740\u5173\u952e\u4f5c\u7528\u3002 1-3 \u5fae\u670d\u52a1\u6846\u67b6\u843d\u5730\u4e2d\u7684\u95ee\u9898 \u63a8\u5e7f\u56f0\u96be \uff1a \u5728\u6846\u67b6\u7684\u843d\u5730\u4e2d\uff0c\u4e9f\u987b\u89e3\u51b3\u7684\u662f\u6846\u67b6\u8986\u76d6\u5ea6\u7684\u95ee\u9898\uff0c\u4f46\u5404\u4e2a\u4e1a\u52a1\u65b9\u5f80\u5f80\u90fd\u6709\u81ea\u5df1\u7684\u6846\u67b6\u9009\u578b \u8fed\u4ee3\u5347\u7ea7\u56f0\u96be \u6392\u67e5\u95ee\u9898 \uff1a \u6846\u67b6\u4ee3\u7801\u548c\u4e1a\u52a1\u4ee3\u7801\u6df7\u6dc6\u5728\u4e00\u8d77\uff0c\u65e5\u5fd7\u76d1\u63a7\u7b49\u6392\u67e5\u4fe1\u606f\u4e5f\u6df7\u5408\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\uff0c\u53d1\u751f\u95ee\u9898\u65f6\u5c31\u9700\u8981\u6846\u67b6\u65b9\u548c\u4e1a\u52a1\u65b9\u8054\u5408\u6392\u67e5\uff0c\u800c\u6846\u67b6\u63d0\u4f9b\u65b9\u9700\u8981\u5728\u65e5\u5fd7\u4e2d\u627e\u51fa\u548c\u6846\u67b6\u6709\u5173\u4fe1\u606f\uff0c\u65e0\u7591\u589e\u5927\u4e86\u6392\u67e5\u95ee\u9898\u7684\u96be\u5ea6\u3002 \u591a\u8bed\u8a00 1-4 Service Mesh \u67b6\u6784\u5982\u4f55\u843d\u5730 \u6839\u636e\u516c\u53f8\u7684\u8fd0\u7ef4\u73af\u5883\u4e0d\u540c\uff0cService Mesh \u843d\u5730\u8def\u5f84\uff0c\u5927\u81f4\u5206\u4e3a\u4ee5\u4e0b\u51e0\u79cd\u3002 \u865a\u62df\u673a\u73af\u5883 \uff1a\u4e5f\u5c31\u662f\u4f20\u7edf\u7684 VM \u73af\u5883\uff0c\u8fd9\u79cd\u73af\u5883\u9700\u8981\u63a7\u5236\u9762\u548c\u516c\u53f8\u7684\u8fd0\u7ef4\u5e73\u53f0\u6216\u8005 CMDB \u6253\u901a\uff0c\u9700\u8981\u505a\u7684\u4e8b\u60c5\u8f83\u591a\uff0c\u56e0\u4e3a\u548c CMDB \u8026\u5408\u6bd4\u8f83\u4e25\u91cd\uff0c\u6240\u4ee5\u7ef4\u62a4\u6210\u672c\u8f83\u9ad8\u3002 Kubernetes \u73af\u5883 \uff1a\u7eaf Kubernetes \u73af\u5883\u76f8\u5bf9\u6bd4\u8f83\u5bb9\u6613\uff0c\u56e0\u4e3a\u4e0d\u518d\u9700\u8981\u7ef4\u62a4\u673a\u5668\u8d44\u6e90\uff0c\u53ea\u5728 Kubernetes \u7684 Pod \u4e2d\u6ce8\u5165\u76f8\u5e94\u7684\u73af\u5883\u53d8\u91cf\uff0c\u6bd4\u5982\u670d\u52a1\u540d\u3001\u8282\u70b9\u540d\u79f0\u3001\u73af\u5883\u7b49\u4fe1\u606f\u5373\u53ef\u3002 Kubernetes +\u865a\u62df\u673a\u6df7\u5408\u73af\u5883 \uff1a\u5982\u679c\u516c\u53f8\u9762\u4e34\u865a\u62df\u673a\u73af\u5883\u5411 Kubernetes \u73af\u5883\u7684\u8fc1\u79fb\uff0c\u8fd9\u79cd\u6df7\u5408\u73af\u5883\u662f\u4e0d\u53ef\u907f\u514d\u7684\uff0c\u4f46\u662f\u6b64\u65f6\u6d89\u53ca\u7684\u95ee\u9898\u5c31\u6bd4\u8f83\u591a\uff0c\u4e0a\u9762\u63d0\u5230\u7684\u4e24\u79cd\u73af\u5883\u90fd\u8981\u652f\u6301\uff0c\u800c\u4e14\u670d\u52a1\u7684\u5207\u6d41\uff08\u6307\u7684\u662f\u6d41\u91cf\u4ece\u865a\u62df\u673a\u5207\u6362\u5230 Kubernetes \u4e0a\uff09\u4e5f\u9700\u8981\u5728\u63a7\u5236\u9762\u652f\u6301\u3002 1-5 Service Mesh \u67b6\u6784\u843d\u5730\u4e2d\u7684\u4f18\u52bf \u8fed\u4ee3\u5347\u7ea7\uff1a\u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u8fed\u4ee3\u5347\u7ea7\u65e0\u987b\u4e1a\u52a1\u65b9\u611f\u77e5\uff0c\u53ef\u4ee5\u72ec\u7acb\u6f14\u8fdb\u3002 \u591a\u8bed\u8a00\uff1a\u65e0\u987b\u5173\u6ce8\u516c\u53f8\u4e3b\u529b\u8bed\u8a00\uff0c\u5bf9\u4e8e\u975e\u4e3b\u529b\u8bed\u8a00\uff0c\u4e5f\u4f5c\u4e3a\u201c\u4e00\u7b49\u516c\u6c11\u201d\u540c\u7b49\u5bf9\u5f85\u3002 \u7075\u6d3b\u90e8\u7f72\uff1a\u4e3a\u4e86\u5feb\u901f\u843d\u5730\uff0cService Mesh \u67b6\u6784\u5e76\u4e0d\u4e00\u5b9a\u975e\u5f97\u5168\u90e8\u63a5\u7ba1\u5165\u6d41\u91cf\u548c\u51fa\u6d41\u91cf\u3002\u5728\u65e9\u671f\uff0c\u53ea\u63a5\u7ba1\u5165\u6d41\u91cf\uff08\u4e5f\u5c31\u662f\u670d\u52a1\u7aef\u6d41\u91cf\uff09\uff0c\u4f1a\u66f4\u5bb9\u6613\u4e00\u4e9b\uff0c\u56e0\u4e3a\u63a5\u7ba1\u51fa\u6d41\u91cf\u5f80\u5f80\u9700\u8981\u6539\u52a8\u5ba2\u6237\u7aef\u4ee3\u7801\uff0c\u800c\u63a5\u7ba1\u5165\u6d41\u91cf\u53ea\u9700\u4fee\u6539 LB \u4ee3\u7406\u7684\u7aef\u53e3\uff0c\u6216\u8005\u7531 Sidecar \u4ee3\u7406\u6ce8\u518c\u5373\u53ef\u3002 1-6 Service Mesh \u67b6\u6784\u843d\u5730\u4e2d\u7684\u56f0\u96be \u6392\u67e5\u95ee\u9898 \u4e00\u6b21\u670d\u52a1\u8c03\u7528\uff0c\u5728\u94fe\u8def\u4e0a\u4f1a\u589e\u52a0\u4e24\u6b21\u8c03\u7528\uff0c\u8fd9\u786e\u5b9e\u7ed9\u6392\u67e5\u95ee\u9898\u5e26\u6765\u4e86\u4e0d\u4fbf\u3002\u672c\u6765\u53ea\u9700\u6392\u67e5\u670d\u52a1\u81ea\u8eab\u7684\u95ee\u9898\uff0c\u73b0\u5728\u5374\u8981\u7ecf\u5e38\u8003\u8651\u662f\u4e0d\u662f Sidecar \u51fa\u73b0\u4e86\u95ee\u9898\u3002\u89e3\u51b3\u6392\u67e5\u56f0\u96be\u7684\u95ee\u9898\uff0c\u53ea\u80fd\u4ece\u53ef\u89c2\u6d4b\u6027\u5165\u624b\uff0c\u6bd4\u5982\u589e\u52a0\u4e30\u5bcc\u7684 Metrics \u6307\u6807\u3001\u6253\u5370\u5173\u952e\u65e5\u5fd7\u3001\u8bb0\u5f55 Trace \u94fe\u8def\u3002 \u6027\u80fd \u4e0a\u9762\u4e5f\u63d0\u5230\u4e86\uff0c\u6bcf\u6b21\u8c03\u7528\u4f1a\u591a\u51fa\u4e24\u6b21\u8bf7\u6c42\uff0c\u8fd9\u5c31\u5bfc\u81f4\u589e\u52a0\u5ef6\u65f6\u548c\u670d\u52a1\u5668\u8d44\u6e90\u6d88\u8017\u7684\u95ee\u9898\u65e0\u6cd5\u907f\u514d\u3002\u5728\u843d\u5730\u8fc7\u7a0b\u4e2d\uff0c\u6027\u80fd\u8fd9\u4e2a\u70b9\u662f\u88ab\u4e1a\u52a1\u65b9\u6311\u6218\u6700\u591a\u7684\uff0c\u6bd5\u7adf\u8fd9\u662f\u5b9e\u6253\u5b9e\u53ef\u4ee5\u770b\u5230\u7684\u635f\u8017\u3002 \u8fd9\u5c31\u9700\u8981\u6211\u4eec\u5c3d\u53ef\u80fd\u63d0\u5347 Sidecar \u7684\u4ee3\u7406\u6027\u80fd\u3001\u5ef6\u65f6\u548c CPU \u6d88\u8017\u3002 \u6bd4\u5982\u5ef6\u65f6\uff0cHTTP \u7684\u5355\u6b21\u4ee3\u7406\u5ef6\u65f6\u6d88\u8017\u5927\u6982\u589e\u52a0 0.3ms\uff0c\u800c\u79c1\u6709\u7684 RPC \u534f\u8bae\u53ef\u4ee5\u505a\u5230\u5c0f\u4e8e 0.1ms\u3002\u8fd9\u6837\u7684\u5ef6\u65f6\uff0c\u5927\u90e8\u5206\u7684\u4e1a\u52a1\u573a\u666f\u90fd\u53ef\u4ee5\u63a5\u53d7\u3002 \u4fe1\u4efb\u95ee\u9898 Sidecar \u5bfc\u81f4\u4e86\u670d\u52a1\u4e0d\u7a33\u5b9a \u670d\u52a1\u4f7f\u7528 Sidecar \u53ef\u80fd\u4f1a\u6709\u4e00\u4e9b\u5f02\u5e38\u7684\u6296\u52a8\u3002 \u8fd9\u4e9b\u95ee\u9898\u53ef\u80fd\u662f\u4e0a Sidecar \u5bfc\u81f4\u7684\uff0c\u4e5f\u53ef\u80fd\u662f\u56e0\u4e3a\u670d\u52a1\u672c\u8eab\u7684\u529f\u80fd\u8fed\u4ee3\uff0c\u4f46\u662f\u8fd9\u79cd\u4e0d\u7a33\u5b9a\u9700\u8981\u6839\u636e\u5177\u4f53\u95ee\u9898\u6392\u67e5\u3002 \u6bd4\u5982\u5728\u843d\u5730\u4e2d\uff0c\u6211\u5c31\u9047\u5230\u8fc7\u56e0\u4e3a Http Client \u53c2\u6570\u914d\u7f6e\u4e0d\u5408\u7406\u5bfc\u81f4\u4e0a Sidecar \u4e4b\u540e\u51fa\u73b0\u670d\u52a1\u6296\u52a8\uff1b \u4e5f\u9047\u5230\u8fc7\u670d\u52a1\u81ea\u8eab\u7684\u4e1a\u52a1\u8fed\u4ee3\u6216\u8005\u673a\u5668\u8d44\u6e90\u4e0d\u8db3\u5bfc\u81f4\u7684\u95ee\u9898\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u4e00\u5b9a\u8981\u8fde\u540c\u4e1a\u52a1\u65b9\u4e00\u8d77\u6392\u67e5\u95ee\u9898\uff0c\u627e\u51fa\u6839\u56e0\u3002 \u670d\u52a1\u8c03\u8bd5\u4e0d\u65b9\u4fbf Sidecar \u589e\u52a0\u4e86\u5ef6\u65f6 \u4ed6\u4eec\u901a\u8fc7 Trace \u65e5\u5fd7\u4e2d\u7684\u8868\u8c61\uff0c\u548c\u6211\u4eec\u53cd\u6620 Sidecar \u5927\u5927\u589e\u52a0\u4e86\u5ef6\u65f6\u3002 \u8fd9\u79cd\u60c5\u51b5\u5f80\u5f80\u51fa\u73b0\u5728\u670d\u52a1\u5f02\u5e38\u7684\u65f6\u5019\uff0c\u4ece Trace \u94fe\u8def\u770b\uff0cSidecar \u7684\u73af\u8282\u786e\u5b9e\u76f8\u5bf9\u670d\u52a1\u5ef6\u65f6\u8f83\u9ad8\u3002 \u4f46\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u90fd\u662f\u673a\u5668\u8d44\u6e90\u95ee\u9898\u5bfc\u81f4\uff0c\u56e0\u4e3a\u670d\u52a1\u7684 Trace \u94fe\u8def\u5b9e\u9645\u4e0a\u662f\u65e0\u6cd5\u8ddf\u8e2a\u7f51\u7edc\u548c\u7cfb\u7edf\u5c42\u9762\u7684\u6d88\u8017\u7684\uff0c\u6b64\u65f6\u8fd9\u90e8\u5206\u6d88\u8017\u4f1a\u88ab\u8bb0\u5f55\u5728 Sidecar \u7684 Trace \u94fe\u8def\u4e2d\u3002 2\u3001\u4e3a\u4ec0\u4e48\u8981\u4ece SDK \u6f14\u8fdb\u5230 Service Mesh\uff1f 2-1 \u7ebf\u4e0a\u6545\u969c\u68b3\u7406 2-1-1 \u670d\u52a1\u53d8\u66f4\u6545\u969c \u7ebf\u4e0a\u6545\u969c\u4e2d\uff0c\u51fa\u73b0\u6982\u7387\u6700\u5927\u7684\u5c31\u662f\u670d\u52a1\u53d8\u66f4\u6545\u969c\uff0c\u4e00\u822c\u6307\u7684\u662f\u4e1a\u52a1\u8fed\u4ee3\u8fdb\u884c\u7248\u672c\u66f4\u65b0\uff0c\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u9047\u5230\u7684\u6545\u969c\uff0c\u4e5f\u5305\u62ec\u9879\u76ee\u914d\u7f6e\u53d8\u66f4\uff0c\u6570\u636e\u53d8\u66f4\u7b49\u3002 \u4e00\u822c\u6765\u8bf4\uff0c\u8fd9\u79cd\u95ee\u9898\u53ea\u8981\u53ca\u65f6\u56de\u6eda\u5c31\u53ef\u4ee5\u89e3\u51b3\uff0c \u6240\u4ee5\u6700\u5927\u7684\u96be\u70b9\u5728\u4e8e\u5982\u4f55\u7528\u6700\u5feb\u7684\u901f\u5ea6\u53d1\u73b0\u6545\u969c \u3002 \u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u901a\u8fc7 Metrics \u8fdb\u884c\u6545\u969c\u62a5\u8b66\uff0c\u5728 Service Mesh \u67b6\u6784\u4e2d\uff0c\u53ef\u4ee5\u4e0d\u4f9d\u8d56\u4e8e\u6846\u67b6\u6216\u8005\u4e1a\u52a1\u6ce8\u5165 Metrics\uff0c\u901a\u8fc7\u6536\u96c6 Sidecar \u4e2d\u7684 Metrics \uff0c\u8fbe\u5230\u76d1\u63a7\u62a5\u8b66\u7684\u76ee\u7684\u3002 2-1-2 \u7a81\u53d1\u6d41\u91cf\u5bfc\u81f4\u7684\u6545\u969c \u9664\u53bb\u670d\u52a1\u53d8\u66f4\u6545\u969c\uff0c\u7a81\u53d1\u6d41\u91cf\u662f\u53e6\u5916\u4e00\u4e2a\u9ad8\u9891\u53d1\u751f\u7684\u6545\u969c\u7c7b\u578b\u3002\u6bd4\u5982\u7a81\u53d1\u70ed\u70b9\uff0c\u6216\u8005\u8fd0\u8425\u6d3b\u52a8\uff0c\u90fd\u53ef\u80fd\u5bfc\u81f4\u8fd9\u79cd\u6545\u969c\u3002 2-1-3 \u4f9d\u8d56\u6545\u969c \u4f9d\u8d56\u6545\u969c\uff0c\u4e3b\u8981\u6307\u7684\u662f upstream \u4e0a\u6e38\u670d\u52a1\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u5bfc\u81f4\u7684\u7ea7\u8054\u6545\u969c\uff0c\u5982\u679c\u6ca1\u6709\u76f8\u5e94\u7684\u670d\u52a1\u6cbb\u7406\u624b\u6bb5\uff0c\u5c06\u4f1a\u5bfc\u81f4\u6574\u6761\u5fae\u670d\u52a1\u94fe\u8def\u88ab\u62d6\u6162\uff0c\u6700\u7ec8\u5bfc\u81f4\u96c6\u7fa4\u96ea\u5d29\u3002 \u5e94\u5bf9\u8fd9\u79cd\u95ee\u9898\u7684\u529e\u6cd5\uff0c\u5c31\u662f\u901a\u8fc7 Service Mesh \u670d\u52a1\u6cbb\u7406\u7684\u624b\u6bb5\u4e4b\u4e00\u2014\u2014\u7194\u65ad\uff0c \u5728\u4e0a\u6e38\u670d\u52a1\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u7194\u65ad\uff0c\u5bf9\u4e0a\u6e38\u670d\u52a1\u7684\u8bf7\u6c42\u76f4\u63a5\u8fd4\u56de\u9519\u8bef \uff0c\u8fd9\u6837\u5c31\u51cf\u5c11\u4e86\u670d\u52a1\u94fe\u8def\u7684\u8017\u65f6\uff0c\u4ece\u800c\u907f\u514d\u5fae\u670d\u52a1\u96c6\u7fa4\u96ea\u5d29\u3002 \u53e6\u5916\u7194\u65ad\u4e5f\u53ef\u4ee5\u914d\u5408\u964d\u7ea7\u4f7f\u7528\uff0c\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0c\u6bd4\u5982 Feed \u6d41\uff0c\u5982\u679c\u4e0a\u6e38\u670d\u52a1\u6545\u969c\u89e6\u53d1\u7194\u65ad\u65f6 2-1-4 \u7f51\u7edc\u5f15\u8d77\u7684\u6545\u969c \u8fd9\u79cd\u6545\u969c\u5f80\u5f80\u53d1\u751f\u5728\u670d\u52a1\u65b0\u52a0\u8282\u70b9\u7684\u60c5\u51b5 \uff0c\u56e0\u4e3a\u7f51\u7edc\u914d\u7f6e\u95ee\u9898\uff0c\u8fd9\u4e9b\u8282\u70b9\u53ef\u80fd\u5728\u67d0\u4e9b\u7f51\u6bb5\u4e0d\u901a\uff0c\u4f46\u662f\u548c\u6ce8\u518c\u4e2d\u5fc3\u662f\u76f8\u901a\u7684\uff0c\u8fd9\u5c31\u5bfc\u81f4\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u5eb7\u68c0\u67e5\u53ef\u4ee5\u901a\u8fc7\uff0c\u4f46\u662f\u670d\u52a1\u8c03\u7528\u7684\u65f6\u5019\u5374\u65e0\u6cd5\u8054\u901a\u3002 \u6b64\u65f6\u5c31\u9700\u8981 Service Mesh \u4e2d\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u6709\u8282\u70b9\u6458\u9664\u7684\u529f\u80fd\uff0c \u5728\u53d1\u751f\u7f51\u7edc\u6545\u969c\u7684\u65f6\u5019\u5c06\u5931\u8d25\u7684\u8282\u70b9\u6458\u9664\u6389 \u3002\u5f53\u7136\uff0c\u6211\u4eec\u5e73\u65f6\u4e5f\u9700\u8981\u505a\u597d\u7f51\u7edc\u5206\u533a\u7684\u89c4\u5212\uff0c\u786e\u4fdd\u670d\u52a1\u90e8\u7f72\u5728\u591a\u4e2a\u5206\u533a\uff0c\u4ee5\u907f\u514d\u67d0\u4e2a\u7f51\u7edc\u5206\u533a\u6545\u969c\u5f15\u8d77\u6574\u4e2a\u7f51\u7edc\u762b\u75ea\u3002 2-1-5 \u673a\u5668\u5f15\u8d77\u7684\u6545\u969c \u673a\u5668\u5f15\u8d77\u7684\u6545\u969c\u4e3b\u8981\u662f\u6307\u673a\u5668 hang \u4f4f\uff0c\u6216\u8005\u673a\u5668 down \u673a\u91cd\u542f\u7684\u60c5\u51b5\u3002\u673a\u5668\u6545\u969c\u95ee\u9898\u53ef\u4ee5\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u5eb7\u68c0\u67e5\u89e3\u51b3\u3002\u5982\u679c\u662f\u5728 Kubernetes \u73af\u5883\u4e2d\uff0c\u5219\u9700\u8981\u6ce8\u610f\uff0c \u4e0d\u8981\u5c06\u4e00\u4e2a\u670d\u52a1\u7684 Pod \u90fd\u8c03\u5ea6\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u5426\u5219\u673a\u5668\u6545\u969c\u4f1a\u5bfc\u81f4\u6574\u4e2a\u670d\u52a1\u4e0d\u53ef\u7528 \u3002 2-2 \u5982\u4f55\u63d0\u5347\u7814\u53d1\u6548\u7387 \u901a\u8fc7\u63a7\u5236\u9762\u4e0b\u53d1\u6ce8\u518c\u4fe1\u606f\uff0c\u907f\u514d\u4e86\u4e1a\u52a1\u65b9\u624b\u52a8\u8bbe\u7f6e\u6ce8\u518c\u53c2\u6570\u7684\u8fc7\u7a0b\uff0c\u51cf\u5c11\u6545\u969c\u53d1\u751f\u7684\u6982\u7387\u3002 2-2-1 \u4ee3\u7406\u6ce8\u518c \u5982\u679c\u6ca1\u6709\u4f7f\u7528 Kubernetes \u5185\u7f6e\u7684\u6ce8\u518c\u53d1\u73b0\u4f53\u7cfb\uff0c\u5c31\u9700\u8981\u901a\u8fc7\u6846\u67b6\u6765\u6ce8\u518c\u3002\u4f46\u662f\u6846\u67b6\u6ce8\u518c\u514d\u4e0d\u4e86\u4e1a\u52a1\u914d\u7f6e\u4e00\u4e9b\u53c2\u6570\uff0c\u6bd4\u5982\u670d\u52a1\u540d\u3001\u8fd0\u884c\u73af\u5883\u7b49\u3002 \u4e00\u65e6\u8fd9\u4e9b\u53c2\u6570\u914d\u7f6e\u9519\u8bef\u4f1a\u5f15\u53d1\u7ebf\u4e0a\u6545\u969c\uff0c\u6240\u4ee5\u901a\u8fc7 Sidecar \u4ee3\u7406\u6ce8\u518c\u662f\u6700\u597d\u7684\u89e3\u51b3\u65b9\u6848\u3002 \u901a\u8fc7\u63a7\u5236\u9762\u4e0b\u53d1\u6ce8\u518c\u4fe1\u606f\uff0c\u907f\u514d\u4e86\u4e1a\u52a1\u65b9\u624b\u52a8\u8bbe\u7f6e\u6ce8\u518c\u53c2\u6570\u7684\u8fc7\u7a0b\uff0c\u51cf\u5c11\u6545\u969c\u53d1\u751f\u7684\u6982\u7387\u3002 2-2-2 \u5b89\u5168\u901a\u4fe1 \u5728\u5185\u7f51\u73af\u5883\u4e2d\uff0c\u5185\u7f51\u5b89\u5168\u5f80\u5f80\u6ca1\u6709\u5916\u7f51\u5b89\u5168\u90a3\u4e48\u53d7\u91cd\u89c6\u3002 \u4e91\u539f\u751f\u7684\u73af\u5883\uff0c\u63d0\u51fa\u4e86\u96f6\u4fe1\u4efb\u7684\u6982\u5ff5\uff0c\u8fd9\u4e2a\u65f6\u5019\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\u52a0\u5165 TLS \u8ba4\u8bc1\u6216\u8005 Token \u8ba4\u8bc1\uff0c\u90fd\u5b58\u5728\u4e0d\u597d\u63a7\u5236\u548c\u7ef4\u62a4\u7684\u95ee\u9898\u3002 \u76f4\u63a5\u5728 Service Mesh \u4e2d\uff0c\u96c6\u6210\u5b89\u5168\u76f8\u5173\u7684\u529f\u80fd\uff0c\u5c06\u662f\u6700\u5408\u9002\u7684\u9009\u62e9\uff0c \u670d\u52a1\u95f4\u901a\u8fc7\u53cc\u5411 TLS \u8ba4\u8bc1\u7684\u65b9\u5f0f\u8fdb\u884c\u5b89\u5168\u901a\u4fe1 \u3002 2-2-3 \u5e73\u6ed1\u91cd\u542f \u5728\u4f20\u7edf\u7684\u865a\u62df\u673a\u73af\u5883\u4e0b\uff0c\u670d\u52a1\u60f3\u8981\u505a\u5230\u5e73\u6ed1\u91cd\u542f\uff0c\u9664\u4e86\u81ea\u8eab\u7528\u4ee3\u7801\u5b9e\u73b0\u76f8\u5bf9\u590d\u6742\u7684\u5e73\u6ed1\u91cd\u542f\u5916\uff0c\u8fd8\u6709\u4e00\u79cd\u65b9\u5f0f\u5c31\u662f\u901a\u8fc7\u5173\u95ed\u524d\u53cd\u6ce8\u518c\u6458\u9664\u6d41\u91cf\uff0c\u542f\u52a8\u540e\u518d\u6ce8\u518c\u7684\u65b9\u5f0f\u5b9e\u73b0\u5e73\u6ed1\u91cd\u542f\u3002 \u501f\u52a9 Sidecar \u7684\u80fd\u529b\uff0c\u901a\u8fc7\u548c Sidecar \u7684\u63a7\u5236\u63a5\u53e3\u901a\u4fe1\uff0c\u8c03\u7528\u63a5\u53e3\u63a7\u5236\u6ce8\u518c/\u53cd\u6ce8\u518c\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0\u5e73\u6ed1\u91cd\u542f\u3002\u8fd9\u4e2a\u529f\u80fd\u53ef\u4ee5\u96c6\u6210\u5728 CD \u5e73\u53f0\u4e2d\uff0c\u4ece\u800c\u5b9e\u73b0\u548c\u4e1a\u52a1\u4ee3\u7801\u7684\u89e3\u8026\uff0c\u4e1a\u52a1\u65e0\u987b\u5173\u5fc3\u6ce8\u518c/\u53cd\u6ce8\u518c\u7684\u8fc7\u7a0b\u3002 2-2-4 \u5e73\u6ed1\u653e\u91cf \u5728\u4e00\u4e9b\u573a\u666f\u4e2d\uff0c\u6bd4\u5982 Java \u8bed\u8a00\uff0c\u542f\u52a8\u76f8\u5bf9\u6bd4\u8f83\u6162\u3002\u5982\u679c\u8282\u70b9\u521a\u542f\u52a8\u5c31\u653e\u5927\u91cf\u6d41\u91cf\u8fdb\u5165\uff0c\u4e00\u4e9b\u7ebf\u7a0b\u6c60\u8fd8\u6ca1\u6765\u5f97\u53ca\u9884\u70ed\uff0c\u5c31\u63a5\u7ba1\u6d41\u91cf\uff0c\u4f1a\u5bfc\u81f4\u5927\u91cf\u7684\u9519\u8bef\u3002 \u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u5229\u7528 Sidecar \u5b9e\u73b0\u5e73\u6ed1\u653e\u91cf\u7684\u529f\u80fd\uff0c\u65b0\u52a0\u5165\u7684\u8282\u70b9\u5148\u5c06\u6743\u91cd\u8bbe\u7f6e\u4e3a 1\uff0c\u7136\u540e\u7f13\u6162\u589e\u52a0\u5230 100\uff0c\u53ef\u4ee5\u9884\u70ed Java \u7684\u7ebf\u7a0b\u6c60\uff0c\u8fbe\u5230\u5e73\u6ed1\u653e\u91cf\u7684\u76ee\u7684\u3002 2-2-5 \u67d3\u8272 \u901a\u8fc7\u67d3\u8272\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u5f88\u597d\u5730\u8fdb\u884c\u6d41\u91cf\u533a\u5206\uff0c\u8fbe\u5230\u7ebf\u4e0a\u771f\u5b9e\u6d41\u91cf\u6d4b\u8bd5\u7684\u76ee\u7684\uff0c\u751a\u81f3\u53ef\u4ee5\u914d\u5408\u6545\u969c\u6f14\u7ec3\u4f7f\u7528\u3002\u5c06\u67d0\u4e9b\u7b26\u5408\u6761\u4ef6\u7684\u6d41\u91cf\u6253\u4e0a\u7279\u5b9a\u7684\u6807\u8bb0\uff0c\u901a\u8fc7 header \u5728\u5fae\u670d\u52a1\u4e4b\u95f4\u4f20\u9012\uff0c\u8fdb\u800c\u8fbe\u5230\u6d41\u91cf\u67d3\u8272\u7684\u76ee\u7684\u3002 2-3 \u5982\u4f55\u4ece\u865a\u62df\u673a\u73af\u5883\u8fc1\u79fb\u5230 Kubernetes \u73af\u5883 2-3-1 \u670d\u52a1\u53d1\u73b0\u95ee\u9898 \u5efa\u8bae\u6cbf\u7528\u72ec\u7acb\u6ce8\u518c\u4e2d\u5fc3\u7684\u65b9\u6848\u3002 \u901a\u8fc7\u63a7\u5236\u9762\u805a\u5408\u591a\u4e2a\u6ce8\u518c\u4e2d\u5fc3\u6570\u636e\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u53d1\u73b0\u65b9\u5f0f\u5219\u7edf\u4e00\u5230 Envoy EDS \u534f\u8bae\uff08\u8282\u70b9\u53d1\u73b0\u670d\u52a1\uff09\u3002 2-3-2 \u8d1f\u8f7d\u5747\u8861\u95ee\u9898 \u865a\u62df\u673a\u8fc1\u79fb\u5230\u5bb9\u5668\u73af\u5883\u540e\uff0c\u4f20\u7edf\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u4f1a\u56e0\u4e3a Pod \u5bbf\u4e3b\u673a\u673a\u5668\u914d\u7f6e\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u6d41\u91cf\u5747\u8861\uff0c\u800c CPU \u8d1f\u8f7d\u4e0d\u5747\u8861\u7684\u95ee\u9898\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 P2C\uff08Pick of 2 choices\uff09\u7684\u7b97\u6cd5\u89e3\u51b3\u3002 2-3-3 \u9650\u6d41\u8bbe\u7f6e\u95ee\u9898 \u865a\u62df\u673a\u8fc1\u79fb\u5bb9\u5668\u73af\u5883\u540e\uff0c\u56e0\u4e3a\u5bb9\u5668\u73af\u5883\u5e38\u5e38\u4f1a\u914d\u7f6e HPA\uff08\u81ea\u52a8\u6269\u7f29\u5bb9\uff09\uff0cHPA \u4f1a\u6839\u636e CPU \u7684\u6c34\u4f4d\u5bf9 Pod \u7684\u6570\u91cf\u8fdb\u884c\u8c03\u6574\uff0c\u5728\u6d41\u91cf\u4e0a\u6da8\u7684\u60c5\u51b5\uff0c\u4f1a\u8fdb\u884c\u6269\u5bb9\u64cd\u4f5c\u3002\u6b64\u65f6\u5982\u679c\u9650\u6d41\u503c\u914d\u7f6e\u4e0d\u5408\u7406\uff0c\u4f1a\u5f71\u54cd\u6269\u5bb9\u64cd\u4f5c\uff0c\u5bfc\u81f4\u4e0d\u5fc5\u8981\u7684\u6d41\u91cf\u635f\u5931\u3002\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u5f15\u5165\u81ea\u9002\u5e94\u9650\u6d41\u7684\u7b97\u6cd5\uff0c\u6839\u636e\u5ef6\u65f6\u3001CPU \u6c34\u4f4d\u7b49\u4fe1\u606f\uff0c\u81ea\u52a8\u8c03\u6574\u9650\u6d41\u503c\uff0c\u907f\u514d\u624b\u52a8\u914d\u7f6e\u5f15\u8d77\u7684\u6545\u969c\u3002 2-3-4 \u7070\u5ea6\u6d41\u91cf\u95ee\u9898 \u5728\u865a\u62df\u673a\u5411\u5bb9\u5668\u8fc1\u79fb\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u53ef\u907f\u514d\u4f1a\u6d89\u53ca\u5982\u4f55\u7070\u5ea6\u6d41\u91cf\u7684\u95ee\u9898\u3002\u5728\u4f20\u7edf\u7684 SDK \u6a21\u5f0f\u4e2d\uff0c\u9700\u8981\u4e1a\u52a1\u53cd\u590d\u53d1\u7248\u6216\u8005\u914d\u7f6e\u4e2d\u5fc3\u4fee\u6539\u624d\u80fd\u8c03\u6574\u670d\u52a1\u8282\u70b9\u7684\u6743\u91cd\u3002\u4f46\u662f\u5728\u4e24\u79cd\u73af\u5883\u4e0b\uff0c\u914d\u7f6e\u4e2d\u5fc3\u9488\u5bf9\u4e24\u79cd\u73af\u5883\u8bbe\u7f6e\u4e0d\u540c\u7684\u914d\u7f6e\u624d\u53ef\u4ee5\u505a\u5230\uff0c\u670d\u52a1\u4ee3\u7801\u53d1\u7248\u4e5f\u9700\u8981\u5728\u4e24\u4e2a\u73af\u5883\u53d1\u7248\uff0c\u56e0\u4e3a\u540c\u4e00\u4e2a\u670d\u52a1\u4ee3\u7801\u914d\u7f6e\u4e0d\u540c\uff0c\u5f88\u5bb9\u6613\u5728\u751f\u4ea7\u73af\u5883\u4ea7\u751f\u4eba\u4e3a\u6545\u969c\u3002 \u4e0a\u8ff0\u95ee\u9898\u90fd\u53ef\u4ee5\u901a\u8fc7 Service Mesh \u63a7\u5236\u9762\u89e3\u51b3\uff0c \u63a7\u5236\u9762\u652f\u6301\u4e24\u79cd\u73af\u5883\u4e0d\u540c\u7684\u6743\u91cd\u914d\u7f6e \uff0c\u7ed3\u5408\u670d\u52a1\u6cbb\u7406\u5e73\u53f0\u63d0\u4f9b\u7684 Web UI\uff0c\u53ef\u4ee5\u8ba9\u8fd0\u7ef4\u975e\u5e38\u65b9\u4fbf\u5730\u64cd\u4f5c\uff0c\u800c\u4e0d\u9700\u8981\u4e1a\u52a1\u65b9\u4fee\u6539\u4ee3\u7801\u6216\u8005\u914d\u7f6e\u4e2d\u5fc3\u3002","title":"\u7b2c\u4e5d\u8282 Service Mesh \u843d\u5730\u548c\u5c55\u671b"},{"location":"chap2/9chap3_pratice/#service-mesh","text":"","title":"\u7b2c\u4e5d\u8282 Service Mesh \u843d\u5730\u548c\u5c55\u671b"},{"location":"chap2/9chap3_pratice/#1","text":"","title":"1\u3001\u5728\u5b9e\u8df5\u843d\u5730\u4e2d\u53ef\u80fd\u9047\u5230\u7684\u95ee\u9898\u548c\u56f0\u96be"},{"location":"chap2/9chap3_pratice/#1-1","text":"\u5fae\u670d\u52a1\u6846\u67b6\u529f\u80fd\u53ca\u4f9d\u8d56\u7684\u5916\u90e8\u57fa\u7840\u8bbe\u65bd \u670d\u52a1\u6ce8\u518c\u53d1\u73b0 \uff1a\u5fae\u670d\u52a1\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u8d1f\u8d23\u670d\u52a1\u7684\u6ce8\u518c\uff0c\u4ee5\u53ca upstream \u670d\u52a1\u7684 Endpoint \u7684\u53d1\u73b0\u3002 \u8def\u7531 \uff1a\u8d1f\u8d23\u6d41\u91cf\u8f6c\u53d1\u7684\u914d\u7f6e\u3002 \u8d1f\u8f7d\u5747\u8861 \uff1a\u5177\u5907\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u9488\u5bf9 upstream Endpoint \u8fdb\u884c\u6d41\u91cf\u5206\u53d1\u3002 \u670d\u52a1\u6cbb\u7406 \uff1a\u901a\u5e38\u6307\u7684\u662f\u9650\u6d41\u3001\u7194\u65ad\u3001\u964d\u7ea7\u7b49\u53ef\u4ee5\u63d0\u9ad8\u5fae\u670d\u52a1\u67b6\u6784\u7a33\u5b9a\u6027\u7684\u63aa\u65bd\u3002 \u53ef\u89c2\u6d4b\u6027 \uff1aMetrics\u3001\u65e5\u5fd7\u3001\u94fe\u8def\u8ffd\u8e2a\u7b49\u7ec4\u4ef6\u3002 \u811a\u624b\u67b6 \uff1a\u5fae\u670d\u52a1\u6846\u67b6\u4e3a\u4e86\u8ba9\u4e1a\u52a1\u5feb\u901f\u4e0a\u624b\uff0c\u901a\u5e38\u9700\u8981\u4e00\u4e2a\u811a\u624b\u67b6\uff0c\u8ba9\u4e1a\u52a1\u65b9\u5feb\u901f\u751f\u6210\u9879\u76ee\u4ee3\u7801\u3002 RPC \uff1a\u8fd9\u91cc\u6307\u7684\u662f\u5e7f\u4e49\u7684 RPC\uff0c\u53ef\u4ee5\u662f gRPC \u6216\u8005 Dubbo \u7b49 RPC \u534f\u8bae\uff0c\u4e5f\u53ef\u4ee5\u662f HTTP \u534f\u8bae\u3002 \u5f53\u7136\uff0c\u6574\u4e2a\u5fae\u670d\u52a1\u7684\u751f\u6001\u5728\u4e0d\u65ad\u6f14\u8fdb\uff0c\u7ed3\u5408\u516c\u53f8\u7684\u9700\u6c42\uff0c\u9002\u5f53\u589e\u52a0\u4e00\u4e9b\u65b0\u7684\u529f\u80fd\u4e5f\u662f\u6709\u5fc5\u8981\u7684\uff0c\u6bd4\u5982\u67d3\u8272\u3001\u901a\u7528 header \u4f20\u9012\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\u3002 \u5fae\u670d\u52a1\u6846\u67b6\u843d\u5730\u4f9d\u8d56\u4e8e\u5916\u90e8\u54ea\u4e9b\u57fa\u7840\u8bbe\u65bd\u3002 \u8fb9\u7f18\u7f51\u5173\u5c42 \uff1a\u7edf\u4e00\u7684\u5165\u53e3\u7f51\u5173\u5c42\uff0c\u4f5c\u4e3a\u5fae\u670d\u52a1\u7684\u5165\u53e3\u5c42\uff0c\u8d1f\u8d23\u5357\u5317\u6d41\u91cf\u7684\u6cbb\u7406\u3002 \u76d1\u63a7\u544a\u8b66 \uff1a\u6536\u96c6\u4e1a\u52a1\u7684 Metrics\u3001Trace\u3001Log \u7b49\u4fe1\u606f\uff0c\u5e76\u914d\u7f6e\u76d1\u63a7\u544a\u8b66\u3002 \u914d\u7f6e\u4e2d\u5fc3 \uff1a\u8d1f\u8d23\u5fae\u670d\u52a1\u7684\u7cfb\u7edf\u914d\u7f6e\u7684\u7ba1\u7406\uff0c\u6bd4\u5982 MySQL\u3001Redis\uff0c\u4ee5\u53ca\u4e0a\u4e0b\u6e38\u670d\u52a1\u7684\u8c03\u7528\u914d\u7f6e\u7b49\u3002 CI/CD\uff1a\u5305\u542b CI \u6301\u7eed\u96c6\u6210\uff08Continuous Integration\uff09\u548c CD \u6301\u7eed\u90e8\u7f72\uff08Continuous Deployment\uff09 \u3002\u6301\u7eed\u96c6\u6210\u4e3b\u8981\u662f\u6307\u4ee3\u7801\u90e8\u7f72\u524d\u7684\u81ea\u52a8\u5316\u6d4b\u8bd5\u548c\u81ea\u52a8\u5316\u7f16\u8bd1\u6253\u5305\u7684\u8fc7\u7a0b\uff0c\u6301\u7eed\u90e8\u7f72\u662f\u6307\u7f16\u8bd1\u6253\u5305\u540e\u7684\u4ee3\u7801\u90e8\u7f72\u53d1\u5e03\u7684\u8fc7\u7a0b\u3002\u4ee3\u7801\u53d1\u5e03\u548c\u90e8\u7f72\u5206\u5f00\uff0c \u6709\u5229\u4e8e\u7248\u672c\u63a7\u5236\u548c\u56de\u6eda \uff0c\u65b9\u4fbf\u7ebf\u4e0a\u968f\u65f6\u6062\u590d\u5230\u4efb\u610f\u7248\u672c\u3002\u5f00\u6e90\u65b9\u6848\u4e3b\u8981\u6709 GitLab \u548c Jenkins\u3002 PAAS \u5e73\u53f0\uff1a\u8fd9\u91cc\u4e3b\u8981\u662f\u6307\u8fd0\u7ef4\u7ba1\u7406\u5e73\u53f0\uff0c\u4e3b\u8981\u5305\u542b\u673a\u5668\u7684\u8d44\u6e90\u7ba1\u7406\u7684 CMDB\u3001\u5fae\u670d\u52a1\u6d41\u7a0b\u7ba1\u7406\u3001\u670d\u52a1\u6cbb\u7406\u5e73\u53f0\u7b49 \u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5728\u8fd9\u4e2a\u5e73\u53f0\u4e2d\uff0c\u6211\u4eec\u7533\u8bf7\u673a\u5668\u8d44\u6e90\u3001\u5404\u7c7b\u4e2d\u95f4\u4ef6\u8d44\u6e90\u3001\u6570\u636e\u5e93\u8d44\u6e90\u3001\u7f13\u5b58\u5c42\u8d44\u6e90\uff0c\u4ee5\u53ca\u5404\u79cd\u673a\u5668\u7684\u6743\u9650\u7b49\uff1b\u53e6\u5916\u5305\u62ec\u6574\u4e2a\u5fae\u670d\u52a1\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u3001\u670d\u52a1\u6cbb\u7406\u7684\u9650\u6d41\u7194\u65ad\u7b49\u914d\u7f6e\uff0c\u90fd\u53ef\u4ee5\u5728\u8fd9\u4e2a\u4e00\u7ad9\u5f0f\u7684\u670d\u52a1\u5e73\u53f0\u89e3\u51b3\u3002PAAS \u5e73\u53f0\u5728\u5fae\u670d\u52a1\u67b6\u6784\u7684\u843d\u5730\u4e2d\u81f3\u5173\u91cd\u8981\uff0c\u5bf9\u4e8e\u63d0\u9ad8\u4ea7\u7814\u6548\u7387\u8d77\u7740\u5173\u952e\u4f5c\u7528\u3002","title":"1-1 \u5fae\u670d\u52a1\u6846\u67b6\u529f\u80fd\u53ca\u4f9d\u8d56\u7684\u5916\u90e8\u57fa\u7840\u8bbe\u65bd"},{"location":"chap2/9chap3_pratice/#1-3","text":"\u63a8\u5e7f\u56f0\u96be \uff1a \u5728\u6846\u67b6\u7684\u843d\u5730\u4e2d\uff0c\u4e9f\u987b\u89e3\u51b3\u7684\u662f\u6846\u67b6\u8986\u76d6\u5ea6\u7684\u95ee\u9898\uff0c\u4f46\u5404\u4e2a\u4e1a\u52a1\u65b9\u5f80\u5f80\u90fd\u6709\u81ea\u5df1\u7684\u6846\u67b6\u9009\u578b \u8fed\u4ee3\u5347\u7ea7\u56f0\u96be \u6392\u67e5\u95ee\u9898 \uff1a \u6846\u67b6\u4ee3\u7801\u548c\u4e1a\u52a1\u4ee3\u7801\u6df7\u6dc6\u5728\u4e00\u8d77\uff0c\u65e5\u5fd7\u76d1\u63a7\u7b49\u6392\u67e5\u4fe1\u606f\u4e5f\u6df7\u5408\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\uff0c\u53d1\u751f\u95ee\u9898\u65f6\u5c31\u9700\u8981\u6846\u67b6\u65b9\u548c\u4e1a\u52a1\u65b9\u8054\u5408\u6392\u67e5\uff0c\u800c\u6846\u67b6\u63d0\u4f9b\u65b9\u9700\u8981\u5728\u65e5\u5fd7\u4e2d\u627e\u51fa\u548c\u6846\u67b6\u6709\u5173\u4fe1\u606f\uff0c\u65e0\u7591\u589e\u5927\u4e86\u6392\u67e5\u95ee\u9898\u7684\u96be\u5ea6\u3002 \u591a\u8bed\u8a00","title":"1-3  \u5fae\u670d\u52a1\u6846\u67b6\u843d\u5730\u4e2d\u7684\u95ee\u9898"},{"location":"chap2/9chap3_pratice/#1-4-service-mesh","text":"\u6839\u636e\u516c\u53f8\u7684\u8fd0\u7ef4\u73af\u5883\u4e0d\u540c\uff0cService Mesh \u843d\u5730\u8def\u5f84\uff0c\u5927\u81f4\u5206\u4e3a\u4ee5\u4e0b\u51e0\u79cd\u3002 \u865a\u62df\u673a\u73af\u5883 \uff1a\u4e5f\u5c31\u662f\u4f20\u7edf\u7684 VM \u73af\u5883\uff0c\u8fd9\u79cd\u73af\u5883\u9700\u8981\u63a7\u5236\u9762\u548c\u516c\u53f8\u7684\u8fd0\u7ef4\u5e73\u53f0\u6216\u8005 CMDB \u6253\u901a\uff0c\u9700\u8981\u505a\u7684\u4e8b\u60c5\u8f83\u591a\uff0c\u56e0\u4e3a\u548c CMDB \u8026\u5408\u6bd4\u8f83\u4e25\u91cd\uff0c\u6240\u4ee5\u7ef4\u62a4\u6210\u672c\u8f83\u9ad8\u3002 Kubernetes \u73af\u5883 \uff1a\u7eaf Kubernetes \u73af\u5883\u76f8\u5bf9\u6bd4\u8f83\u5bb9\u6613\uff0c\u56e0\u4e3a\u4e0d\u518d\u9700\u8981\u7ef4\u62a4\u673a\u5668\u8d44\u6e90\uff0c\u53ea\u5728 Kubernetes \u7684 Pod \u4e2d\u6ce8\u5165\u76f8\u5e94\u7684\u73af\u5883\u53d8\u91cf\uff0c\u6bd4\u5982\u670d\u52a1\u540d\u3001\u8282\u70b9\u540d\u79f0\u3001\u73af\u5883\u7b49\u4fe1\u606f\u5373\u53ef\u3002 Kubernetes +\u865a\u62df\u673a\u6df7\u5408\u73af\u5883 \uff1a\u5982\u679c\u516c\u53f8\u9762\u4e34\u865a\u62df\u673a\u73af\u5883\u5411 Kubernetes \u73af\u5883\u7684\u8fc1\u79fb\uff0c\u8fd9\u79cd\u6df7\u5408\u73af\u5883\u662f\u4e0d\u53ef\u907f\u514d\u7684\uff0c\u4f46\u662f\u6b64\u65f6\u6d89\u53ca\u7684\u95ee\u9898\u5c31\u6bd4\u8f83\u591a\uff0c\u4e0a\u9762\u63d0\u5230\u7684\u4e24\u79cd\u73af\u5883\u90fd\u8981\u652f\u6301\uff0c\u800c\u4e14\u670d\u52a1\u7684\u5207\u6d41\uff08\u6307\u7684\u662f\u6d41\u91cf\u4ece\u865a\u62df\u673a\u5207\u6362\u5230 Kubernetes \u4e0a\uff09\u4e5f\u9700\u8981\u5728\u63a7\u5236\u9762\u652f\u6301\u3002","title":"1-4 Service Mesh \u67b6\u6784\u5982\u4f55\u843d\u5730"},{"location":"chap2/9chap3_pratice/#1-5-service-mesh","text":"\u8fed\u4ee3\u5347\u7ea7\uff1a\u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u8fed\u4ee3\u5347\u7ea7\u65e0\u987b\u4e1a\u52a1\u65b9\u611f\u77e5\uff0c\u53ef\u4ee5\u72ec\u7acb\u6f14\u8fdb\u3002 \u591a\u8bed\u8a00\uff1a\u65e0\u987b\u5173\u6ce8\u516c\u53f8\u4e3b\u529b\u8bed\u8a00\uff0c\u5bf9\u4e8e\u975e\u4e3b\u529b\u8bed\u8a00\uff0c\u4e5f\u4f5c\u4e3a\u201c\u4e00\u7b49\u516c\u6c11\u201d\u540c\u7b49\u5bf9\u5f85\u3002 \u7075\u6d3b\u90e8\u7f72\uff1a\u4e3a\u4e86\u5feb\u901f\u843d\u5730\uff0cService Mesh \u67b6\u6784\u5e76\u4e0d\u4e00\u5b9a\u975e\u5f97\u5168\u90e8\u63a5\u7ba1\u5165\u6d41\u91cf\u548c\u51fa\u6d41\u91cf\u3002\u5728\u65e9\u671f\uff0c\u53ea\u63a5\u7ba1\u5165\u6d41\u91cf\uff08\u4e5f\u5c31\u662f\u670d\u52a1\u7aef\u6d41\u91cf\uff09\uff0c\u4f1a\u66f4\u5bb9\u6613\u4e00\u4e9b\uff0c\u56e0\u4e3a\u63a5\u7ba1\u51fa\u6d41\u91cf\u5f80\u5f80\u9700\u8981\u6539\u52a8\u5ba2\u6237\u7aef\u4ee3\u7801\uff0c\u800c\u63a5\u7ba1\u5165\u6d41\u91cf\u53ea\u9700\u4fee\u6539 LB \u4ee3\u7406\u7684\u7aef\u53e3\uff0c\u6216\u8005\u7531 Sidecar \u4ee3\u7406\u6ce8\u518c\u5373\u53ef\u3002","title":"1-5 Service Mesh \u67b6\u6784\u843d\u5730\u4e2d\u7684\u4f18\u52bf"},{"location":"chap2/9chap3_pratice/#1-6-service-mesh","text":"\u6392\u67e5\u95ee\u9898 \u4e00\u6b21\u670d\u52a1\u8c03\u7528\uff0c\u5728\u94fe\u8def\u4e0a\u4f1a\u589e\u52a0\u4e24\u6b21\u8c03\u7528\uff0c\u8fd9\u786e\u5b9e\u7ed9\u6392\u67e5\u95ee\u9898\u5e26\u6765\u4e86\u4e0d\u4fbf\u3002\u672c\u6765\u53ea\u9700\u6392\u67e5\u670d\u52a1\u81ea\u8eab\u7684\u95ee\u9898\uff0c\u73b0\u5728\u5374\u8981\u7ecf\u5e38\u8003\u8651\u662f\u4e0d\u662f Sidecar \u51fa\u73b0\u4e86\u95ee\u9898\u3002\u89e3\u51b3\u6392\u67e5\u56f0\u96be\u7684\u95ee\u9898\uff0c\u53ea\u80fd\u4ece\u53ef\u89c2\u6d4b\u6027\u5165\u624b\uff0c\u6bd4\u5982\u589e\u52a0\u4e30\u5bcc\u7684 Metrics \u6307\u6807\u3001\u6253\u5370\u5173\u952e\u65e5\u5fd7\u3001\u8bb0\u5f55 Trace \u94fe\u8def\u3002 \u6027\u80fd \u4e0a\u9762\u4e5f\u63d0\u5230\u4e86\uff0c\u6bcf\u6b21\u8c03\u7528\u4f1a\u591a\u51fa\u4e24\u6b21\u8bf7\u6c42\uff0c\u8fd9\u5c31\u5bfc\u81f4\u589e\u52a0\u5ef6\u65f6\u548c\u670d\u52a1\u5668\u8d44\u6e90\u6d88\u8017\u7684\u95ee\u9898\u65e0\u6cd5\u907f\u514d\u3002\u5728\u843d\u5730\u8fc7\u7a0b\u4e2d\uff0c\u6027\u80fd\u8fd9\u4e2a\u70b9\u662f\u88ab\u4e1a\u52a1\u65b9\u6311\u6218\u6700\u591a\u7684\uff0c\u6bd5\u7adf\u8fd9\u662f\u5b9e\u6253\u5b9e\u53ef\u4ee5\u770b\u5230\u7684\u635f\u8017\u3002 \u8fd9\u5c31\u9700\u8981\u6211\u4eec\u5c3d\u53ef\u80fd\u63d0\u5347 Sidecar \u7684\u4ee3\u7406\u6027\u80fd\u3001\u5ef6\u65f6\u548c CPU \u6d88\u8017\u3002 \u6bd4\u5982\u5ef6\u65f6\uff0cHTTP \u7684\u5355\u6b21\u4ee3\u7406\u5ef6\u65f6\u6d88\u8017\u5927\u6982\u589e\u52a0 0.3ms\uff0c\u800c\u79c1\u6709\u7684 RPC \u534f\u8bae\u53ef\u4ee5\u505a\u5230\u5c0f\u4e8e 0.1ms\u3002\u8fd9\u6837\u7684\u5ef6\u65f6\uff0c\u5927\u90e8\u5206\u7684\u4e1a\u52a1\u573a\u666f\u90fd\u53ef\u4ee5\u63a5\u53d7\u3002 \u4fe1\u4efb\u95ee\u9898 Sidecar \u5bfc\u81f4\u4e86\u670d\u52a1\u4e0d\u7a33\u5b9a \u670d\u52a1\u4f7f\u7528 Sidecar \u53ef\u80fd\u4f1a\u6709\u4e00\u4e9b\u5f02\u5e38\u7684\u6296\u52a8\u3002 \u8fd9\u4e9b\u95ee\u9898\u53ef\u80fd\u662f\u4e0a Sidecar \u5bfc\u81f4\u7684\uff0c\u4e5f\u53ef\u80fd\u662f\u56e0\u4e3a\u670d\u52a1\u672c\u8eab\u7684\u529f\u80fd\u8fed\u4ee3\uff0c\u4f46\u662f\u8fd9\u79cd\u4e0d\u7a33\u5b9a\u9700\u8981\u6839\u636e\u5177\u4f53\u95ee\u9898\u6392\u67e5\u3002 \u6bd4\u5982\u5728\u843d\u5730\u4e2d\uff0c\u6211\u5c31\u9047\u5230\u8fc7\u56e0\u4e3a Http Client \u53c2\u6570\u914d\u7f6e\u4e0d\u5408\u7406\u5bfc\u81f4\u4e0a Sidecar \u4e4b\u540e\u51fa\u73b0\u670d\u52a1\u6296\u52a8\uff1b \u4e5f\u9047\u5230\u8fc7\u670d\u52a1\u81ea\u8eab\u7684\u4e1a\u52a1\u8fed\u4ee3\u6216\u8005\u673a\u5668\u8d44\u6e90\u4e0d\u8db3\u5bfc\u81f4\u7684\u95ee\u9898\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u4e00\u5b9a\u8981\u8fde\u540c\u4e1a\u52a1\u65b9\u4e00\u8d77\u6392\u67e5\u95ee\u9898\uff0c\u627e\u51fa\u6839\u56e0\u3002 \u670d\u52a1\u8c03\u8bd5\u4e0d\u65b9\u4fbf Sidecar \u589e\u52a0\u4e86\u5ef6\u65f6 \u4ed6\u4eec\u901a\u8fc7 Trace \u65e5\u5fd7\u4e2d\u7684\u8868\u8c61\uff0c\u548c\u6211\u4eec\u53cd\u6620 Sidecar \u5927\u5927\u589e\u52a0\u4e86\u5ef6\u65f6\u3002 \u8fd9\u79cd\u60c5\u51b5\u5f80\u5f80\u51fa\u73b0\u5728\u670d\u52a1\u5f02\u5e38\u7684\u65f6\u5019\uff0c\u4ece Trace \u94fe\u8def\u770b\uff0cSidecar \u7684\u73af\u8282\u786e\u5b9e\u76f8\u5bf9\u670d\u52a1\u5ef6\u65f6\u8f83\u9ad8\u3002 \u4f46\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u90fd\u662f\u673a\u5668\u8d44\u6e90\u95ee\u9898\u5bfc\u81f4\uff0c\u56e0\u4e3a\u670d\u52a1\u7684 Trace \u94fe\u8def\u5b9e\u9645\u4e0a\u662f\u65e0\u6cd5\u8ddf\u8e2a\u7f51\u7edc\u548c\u7cfb\u7edf\u5c42\u9762\u7684\u6d88\u8017\u7684\uff0c\u6b64\u65f6\u8fd9\u90e8\u5206\u6d88\u8017\u4f1a\u88ab\u8bb0\u5f55\u5728 Sidecar \u7684 Trace \u94fe\u8def\u4e2d\u3002","title":"1-6 Service Mesh \u67b6\u6784\u843d\u5730\u4e2d\u7684\u56f0\u96be"},{"location":"chap2/9chap3_pratice/#2-sdk-service-mesh","text":"","title":"2\u3001\u4e3a\u4ec0\u4e48\u8981\u4ece SDK \u6f14\u8fdb\u5230 Service Mesh\uff1f"},{"location":"chap2/9chap3_pratice/#2-1","text":"2-1-1 \u670d\u52a1\u53d8\u66f4\u6545\u969c \u7ebf\u4e0a\u6545\u969c\u4e2d\uff0c\u51fa\u73b0\u6982\u7387\u6700\u5927\u7684\u5c31\u662f\u670d\u52a1\u53d8\u66f4\u6545\u969c\uff0c\u4e00\u822c\u6307\u7684\u662f\u4e1a\u52a1\u8fed\u4ee3\u8fdb\u884c\u7248\u672c\u66f4\u65b0\uff0c\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u9047\u5230\u7684\u6545\u969c\uff0c\u4e5f\u5305\u62ec\u9879\u76ee\u914d\u7f6e\u53d8\u66f4\uff0c\u6570\u636e\u53d8\u66f4\u7b49\u3002 \u4e00\u822c\u6765\u8bf4\uff0c\u8fd9\u79cd\u95ee\u9898\u53ea\u8981\u53ca\u65f6\u56de\u6eda\u5c31\u53ef\u4ee5\u89e3\u51b3\uff0c \u6240\u4ee5\u6700\u5927\u7684\u96be\u70b9\u5728\u4e8e\u5982\u4f55\u7528\u6700\u5feb\u7684\u901f\u5ea6\u53d1\u73b0\u6545\u969c \u3002 \u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u901a\u8fc7 Metrics \u8fdb\u884c\u6545\u969c\u62a5\u8b66\uff0c\u5728 Service Mesh \u67b6\u6784\u4e2d\uff0c\u53ef\u4ee5\u4e0d\u4f9d\u8d56\u4e8e\u6846\u67b6\u6216\u8005\u4e1a\u52a1\u6ce8\u5165 Metrics\uff0c\u901a\u8fc7\u6536\u96c6 Sidecar \u4e2d\u7684 Metrics \uff0c\u8fbe\u5230\u76d1\u63a7\u62a5\u8b66\u7684\u76ee\u7684\u3002 2-1-2 \u7a81\u53d1\u6d41\u91cf\u5bfc\u81f4\u7684\u6545\u969c \u9664\u53bb\u670d\u52a1\u53d8\u66f4\u6545\u969c\uff0c\u7a81\u53d1\u6d41\u91cf\u662f\u53e6\u5916\u4e00\u4e2a\u9ad8\u9891\u53d1\u751f\u7684\u6545\u969c\u7c7b\u578b\u3002\u6bd4\u5982\u7a81\u53d1\u70ed\u70b9\uff0c\u6216\u8005\u8fd0\u8425\u6d3b\u52a8\uff0c\u90fd\u53ef\u80fd\u5bfc\u81f4\u8fd9\u79cd\u6545\u969c\u3002 2-1-3 \u4f9d\u8d56\u6545\u969c \u4f9d\u8d56\u6545\u969c\uff0c\u4e3b\u8981\u6307\u7684\u662f upstream \u4e0a\u6e38\u670d\u52a1\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u5bfc\u81f4\u7684\u7ea7\u8054\u6545\u969c\uff0c\u5982\u679c\u6ca1\u6709\u76f8\u5e94\u7684\u670d\u52a1\u6cbb\u7406\u624b\u6bb5\uff0c\u5c06\u4f1a\u5bfc\u81f4\u6574\u6761\u5fae\u670d\u52a1\u94fe\u8def\u88ab\u62d6\u6162\uff0c\u6700\u7ec8\u5bfc\u81f4\u96c6\u7fa4\u96ea\u5d29\u3002 \u5e94\u5bf9\u8fd9\u79cd\u95ee\u9898\u7684\u529e\u6cd5\uff0c\u5c31\u662f\u901a\u8fc7 Service Mesh \u670d\u52a1\u6cbb\u7406\u7684\u624b\u6bb5\u4e4b\u4e00\u2014\u2014\u7194\u65ad\uff0c \u5728\u4e0a\u6e38\u670d\u52a1\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u7194\u65ad\uff0c\u5bf9\u4e0a\u6e38\u670d\u52a1\u7684\u8bf7\u6c42\u76f4\u63a5\u8fd4\u56de\u9519\u8bef \uff0c\u8fd9\u6837\u5c31\u51cf\u5c11\u4e86\u670d\u52a1\u94fe\u8def\u7684\u8017\u65f6\uff0c\u4ece\u800c\u907f\u514d\u5fae\u670d\u52a1\u96c6\u7fa4\u96ea\u5d29\u3002 \u53e6\u5916\u7194\u65ad\u4e5f\u53ef\u4ee5\u914d\u5408\u964d\u7ea7\u4f7f\u7528\uff0c\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0c\u6bd4\u5982 Feed \u6d41\uff0c\u5982\u679c\u4e0a\u6e38\u670d\u52a1\u6545\u969c\u89e6\u53d1\u7194\u65ad\u65f6 2-1-4 \u7f51\u7edc\u5f15\u8d77\u7684\u6545\u969c \u8fd9\u79cd\u6545\u969c\u5f80\u5f80\u53d1\u751f\u5728\u670d\u52a1\u65b0\u52a0\u8282\u70b9\u7684\u60c5\u51b5 \uff0c\u56e0\u4e3a\u7f51\u7edc\u914d\u7f6e\u95ee\u9898\uff0c\u8fd9\u4e9b\u8282\u70b9\u53ef\u80fd\u5728\u67d0\u4e9b\u7f51\u6bb5\u4e0d\u901a\uff0c\u4f46\u662f\u548c\u6ce8\u518c\u4e2d\u5fc3\u662f\u76f8\u901a\u7684\uff0c\u8fd9\u5c31\u5bfc\u81f4\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u5eb7\u68c0\u67e5\u53ef\u4ee5\u901a\u8fc7\uff0c\u4f46\u662f\u670d\u52a1\u8c03\u7528\u7684\u65f6\u5019\u5374\u65e0\u6cd5\u8054\u901a\u3002 \u6b64\u65f6\u5c31\u9700\u8981 Service Mesh \u4e2d\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u6709\u8282\u70b9\u6458\u9664\u7684\u529f\u80fd\uff0c \u5728\u53d1\u751f\u7f51\u7edc\u6545\u969c\u7684\u65f6\u5019\u5c06\u5931\u8d25\u7684\u8282\u70b9\u6458\u9664\u6389 \u3002\u5f53\u7136\uff0c\u6211\u4eec\u5e73\u65f6\u4e5f\u9700\u8981\u505a\u597d\u7f51\u7edc\u5206\u533a\u7684\u89c4\u5212\uff0c\u786e\u4fdd\u670d\u52a1\u90e8\u7f72\u5728\u591a\u4e2a\u5206\u533a\uff0c\u4ee5\u907f\u514d\u67d0\u4e2a\u7f51\u7edc\u5206\u533a\u6545\u969c\u5f15\u8d77\u6574\u4e2a\u7f51\u7edc\u762b\u75ea\u3002 2-1-5 \u673a\u5668\u5f15\u8d77\u7684\u6545\u969c \u673a\u5668\u5f15\u8d77\u7684\u6545\u969c\u4e3b\u8981\u662f\u6307\u673a\u5668 hang \u4f4f\uff0c\u6216\u8005\u673a\u5668 down \u673a\u91cd\u542f\u7684\u60c5\u51b5\u3002\u673a\u5668\u6545\u969c\u95ee\u9898\u53ef\u4ee5\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u7684\u5065\u5eb7\u68c0\u67e5\u89e3\u51b3\u3002\u5982\u679c\u662f\u5728 Kubernetes \u73af\u5883\u4e2d\uff0c\u5219\u9700\u8981\u6ce8\u610f\uff0c \u4e0d\u8981\u5c06\u4e00\u4e2a\u670d\u52a1\u7684 Pod \u90fd\u8c03\u5ea6\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u5426\u5219\u673a\u5668\u6545\u969c\u4f1a\u5bfc\u81f4\u6574\u4e2a\u670d\u52a1\u4e0d\u53ef\u7528 \u3002","title":"2-1 \u7ebf\u4e0a\u6545\u969c\u68b3\u7406"},{"location":"chap2/9chap3_pratice/#2-2","text":"\u901a\u8fc7\u63a7\u5236\u9762\u4e0b\u53d1\u6ce8\u518c\u4fe1\u606f\uff0c\u907f\u514d\u4e86\u4e1a\u52a1\u65b9\u624b\u52a8\u8bbe\u7f6e\u6ce8\u518c\u53c2\u6570\u7684\u8fc7\u7a0b\uff0c\u51cf\u5c11\u6545\u969c\u53d1\u751f\u7684\u6982\u7387\u3002 2-2-1 \u4ee3\u7406\u6ce8\u518c \u5982\u679c\u6ca1\u6709\u4f7f\u7528 Kubernetes \u5185\u7f6e\u7684\u6ce8\u518c\u53d1\u73b0\u4f53\u7cfb\uff0c\u5c31\u9700\u8981\u901a\u8fc7\u6846\u67b6\u6765\u6ce8\u518c\u3002\u4f46\u662f\u6846\u67b6\u6ce8\u518c\u514d\u4e0d\u4e86\u4e1a\u52a1\u914d\u7f6e\u4e00\u4e9b\u53c2\u6570\uff0c\u6bd4\u5982\u670d\u52a1\u540d\u3001\u8fd0\u884c\u73af\u5883\u7b49\u3002 \u4e00\u65e6\u8fd9\u4e9b\u53c2\u6570\u914d\u7f6e\u9519\u8bef\u4f1a\u5f15\u53d1\u7ebf\u4e0a\u6545\u969c\uff0c\u6240\u4ee5\u901a\u8fc7 Sidecar \u4ee3\u7406\u6ce8\u518c\u662f\u6700\u597d\u7684\u89e3\u51b3\u65b9\u6848\u3002 \u901a\u8fc7\u63a7\u5236\u9762\u4e0b\u53d1\u6ce8\u518c\u4fe1\u606f\uff0c\u907f\u514d\u4e86\u4e1a\u52a1\u65b9\u624b\u52a8\u8bbe\u7f6e\u6ce8\u518c\u53c2\u6570\u7684\u8fc7\u7a0b\uff0c\u51cf\u5c11\u6545\u969c\u53d1\u751f\u7684\u6982\u7387\u3002 2-2-2 \u5b89\u5168\u901a\u4fe1 \u5728\u5185\u7f51\u73af\u5883\u4e2d\uff0c\u5185\u7f51\u5b89\u5168\u5f80\u5f80\u6ca1\u6709\u5916\u7f51\u5b89\u5168\u90a3\u4e48\u53d7\u91cd\u89c6\u3002 \u4e91\u539f\u751f\u7684\u73af\u5883\uff0c\u63d0\u51fa\u4e86\u96f6\u4fe1\u4efb\u7684\u6982\u5ff5\uff0c\u8fd9\u4e2a\u65f6\u5019\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\u52a0\u5165 TLS \u8ba4\u8bc1\u6216\u8005 Token \u8ba4\u8bc1\uff0c\u90fd\u5b58\u5728\u4e0d\u597d\u63a7\u5236\u548c\u7ef4\u62a4\u7684\u95ee\u9898\u3002 \u76f4\u63a5\u5728 Service Mesh \u4e2d\uff0c\u96c6\u6210\u5b89\u5168\u76f8\u5173\u7684\u529f\u80fd\uff0c\u5c06\u662f\u6700\u5408\u9002\u7684\u9009\u62e9\uff0c \u670d\u52a1\u95f4\u901a\u8fc7\u53cc\u5411 TLS \u8ba4\u8bc1\u7684\u65b9\u5f0f\u8fdb\u884c\u5b89\u5168\u901a\u4fe1 \u3002 2-2-3 \u5e73\u6ed1\u91cd\u542f \u5728\u4f20\u7edf\u7684\u865a\u62df\u673a\u73af\u5883\u4e0b\uff0c\u670d\u52a1\u60f3\u8981\u505a\u5230\u5e73\u6ed1\u91cd\u542f\uff0c\u9664\u4e86\u81ea\u8eab\u7528\u4ee3\u7801\u5b9e\u73b0\u76f8\u5bf9\u590d\u6742\u7684\u5e73\u6ed1\u91cd\u542f\u5916\uff0c\u8fd8\u6709\u4e00\u79cd\u65b9\u5f0f\u5c31\u662f\u901a\u8fc7\u5173\u95ed\u524d\u53cd\u6ce8\u518c\u6458\u9664\u6d41\u91cf\uff0c\u542f\u52a8\u540e\u518d\u6ce8\u518c\u7684\u65b9\u5f0f\u5b9e\u73b0\u5e73\u6ed1\u91cd\u542f\u3002 \u501f\u52a9 Sidecar \u7684\u80fd\u529b\uff0c\u901a\u8fc7\u548c Sidecar \u7684\u63a7\u5236\u63a5\u53e3\u901a\u4fe1\uff0c\u8c03\u7528\u63a5\u53e3\u63a7\u5236\u6ce8\u518c/\u53cd\u6ce8\u518c\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0\u5e73\u6ed1\u91cd\u542f\u3002\u8fd9\u4e2a\u529f\u80fd\u53ef\u4ee5\u96c6\u6210\u5728 CD \u5e73\u53f0\u4e2d\uff0c\u4ece\u800c\u5b9e\u73b0\u548c\u4e1a\u52a1\u4ee3\u7801\u7684\u89e3\u8026\uff0c\u4e1a\u52a1\u65e0\u987b\u5173\u5fc3\u6ce8\u518c/\u53cd\u6ce8\u518c\u7684\u8fc7\u7a0b\u3002 2-2-4 \u5e73\u6ed1\u653e\u91cf \u5728\u4e00\u4e9b\u573a\u666f\u4e2d\uff0c\u6bd4\u5982 Java \u8bed\u8a00\uff0c\u542f\u52a8\u76f8\u5bf9\u6bd4\u8f83\u6162\u3002\u5982\u679c\u8282\u70b9\u521a\u542f\u52a8\u5c31\u653e\u5927\u91cf\u6d41\u91cf\u8fdb\u5165\uff0c\u4e00\u4e9b\u7ebf\u7a0b\u6c60\u8fd8\u6ca1\u6765\u5f97\u53ca\u9884\u70ed\uff0c\u5c31\u63a5\u7ba1\u6d41\u91cf\uff0c\u4f1a\u5bfc\u81f4\u5927\u91cf\u7684\u9519\u8bef\u3002 \u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u5229\u7528 Sidecar \u5b9e\u73b0\u5e73\u6ed1\u653e\u91cf\u7684\u529f\u80fd\uff0c\u65b0\u52a0\u5165\u7684\u8282\u70b9\u5148\u5c06\u6743\u91cd\u8bbe\u7f6e\u4e3a 1\uff0c\u7136\u540e\u7f13\u6162\u589e\u52a0\u5230 100\uff0c\u53ef\u4ee5\u9884\u70ed Java \u7684\u7ebf\u7a0b\u6c60\uff0c\u8fbe\u5230\u5e73\u6ed1\u653e\u91cf\u7684\u76ee\u7684\u3002 2-2-5 \u67d3\u8272 \u901a\u8fc7\u67d3\u8272\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u5f88\u597d\u5730\u8fdb\u884c\u6d41\u91cf\u533a\u5206\uff0c\u8fbe\u5230\u7ebf\u4e0a\u771f\u5b9e\u6d41\u91cf\u6d4b\u8bd5\u7684\u76ee\u7684\uff0c\u751a\u81f3\u53ef\u4ee5\u914d\u5408\u6545\u969c\u6f14\u7ec3\u4f7f\u7528\u3002\u5c06\u67d0\u4e9b\u7b26\u5408\u6761\u4ef6\u7684\u6d41\u91cf\u6253\u4e0a\u7279\u5b9a\u7684\u6807\u8bb0\uff0c\u901a\u8fc7 header \u5728\u5fae\u670d\u52a1\u4e4b\u95f4\u4f20\u9012\uff0c\u8fdb\u800c\u8fbe\u5230\u6d41\u91cf\u67d3\u8272\u7684\u76ee\u7684\u3002","title":"2-2 \u5982\u4f55\u63d0\u5347\u7814\u53d1\u6548\u7387"},{"location":"chap2/9chap3_pratice/#2-3-kubernetes","text":"2-3-1 \u670d\u52a1\u53d1\u73b0\u95ee\u9898 \u5efa\u8bae\u6cbf\u7528\u72ec\u7acb\u6ce8\u518c\u4e2d\u5fc3\u7684\u65b9\u6848\u3002 \u901a\u8fc7\u63a7\u5236\u9762\u805a\u5408\u591a\u4e2a\u6ce8\u518c\u4e2d\u5fc3\u6570\u636e\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u53d1\u73b0\u65b9\u5f0f\u5219\u7edf\u4e00\u5230 Envoy EDS \u534f\u8bae\uff08\u8282\u70b9\u53d1\u73b0\u670d\u52a1\uff09\u3002 2-3-2 \u8d1f\u8f7d\u5747\u8861\u95ee\u9898 \u865a\u62df\u673a\u8fc1\u79fb\u5230\u5bb9\u5668\u73af\u5883\u540e\uff0c\u4f20\u7edf\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u4f1a\u56e0\u4e3a Pod \u5bbf\u4e3b\u673a\u673a\u5668\u914d\u7f6e\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u6d41\u91cf\u5747\u8861\uff0c\u800c CPU \u8d1f\u8f7d\u4e0d\u5747\u8861\u7684\u95ee\u9898\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 P2C\uff08Pick of 2 choices\uff09\u7684\u7b97\u6cd5\u89e3\u51b3\u3002 2-3-3 \u9650\u6d41\u8bbe\u7f6e\u95ee\u9898 \u865a\u62df\u673a\u8fc1\u79fb\u5bb9\u5668\u73af\u5883\u540e\uff0c\u56e0\u4e3a\u5bb9\u5668\u73af\u5883\u5e38\u5e38\u4f1a\u914d\u7f6e HPA\uff08\u81ea\u52a8\u6269\u7f29\u5bb9\uff09\uff0cHPA \u4f1a\u6839\u636e CPU \u7684\u6c34\u4f4d\u5bf9 Pod \u7684\u6570\u91cf\u8fdb\u884c\u8c03\u6574\uff0c\u5728\u6d41\u91cf\u4e0a\u6da8\u7684\u60c5\u51b5\uff0c\u4f1a\u8fdb\u884c\u6269\u5bb9\u64cd\u4f5c\u3002\u6b64\u65f6\u5982\u679c\u9650\u6d41\u503c\u914d\u7f6e\u4e0d\u5408\u7406\uff0c\u4f1a\u5f71\u54cd\u6269\u5bb9\u64cd\u4f5c\uff0c\u5bfc\u81f4\u4e0d\u5fc5\u8981\u7684\u6d41\u91cf\u635f\u5931\u3002\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u5f15\u5165\u81ea\u9002\u5e94\u9650\u6d41\u7684\u7b97\u6cd5\uff0c\u6839\u636e\u5ef6\u65f6\u3001CPU \u6c34\u4f4d\u7b49\u4fe1\u606f\uff0c\u81ea\u52a8\u8c03\u6574\u9650\u6d41\u503c\uff0c\u907f\u514d\u624b\u52a8\u914d\u7f6e\u5f15\u8d77\u7684\u6545\u969c\u3002 2-3-4 \u7070\u5ea6\u6d41\u91cf\u95ee\u9898 \u5728\u865a\u62df\u673a\u5411\u5bb9\u5668\u8fc1\u79fb\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u53ef\u907f\u514d\u4f1a\u6d89\u53ca\u5982\u4f55\u7070\u5ea6\u6d41\u91cf\u7684\u95ee\u9898\u3002\u5728\u4f20\u7edf\u7684 SDK \u6a21\u5f0f\u4e2d\uff0c\u9700\u8981\u4e1a\u52a1\u53cd\u590d\u53d1\u7248\u6216\u8005\u914d\u7f6e\u4e2d\u5fc3\u4fee\u6539\u624d\u80fd\u8c03\u6574\u670d\u52a1\u8282\u70b9\u7684\u6743\u91cd\u3002\u4f46\u662f\u5728\u4e24\u79cd\u73af\u5883\u4e0b\uff0c\u914d\u7f6e\u4e2d\u5fc3\u9488\u5bf9\u4e24\u79cd\u73af\u5883\u8bbe\u7f6e\u4e0d\u540c\u7684\u914d\u7f6e\u624d\u53ef\u4ee5\u505a\u5230\uff0c\u670d\u52a1\u4ee3\u7801\u53d1\u7248\u4e5f\u9700\u8981\u5728\u4e24\u4e2a\u73af\u5883\u53d1\u7248\uff0c\u56e0\u4e3a\u540c\u4e00\u4e2a\u670d\u52a1\u4ee3\u7801\u914d\u7f6e\u4e0d\u540c\uff0c\u5f88\u5bb9\u6613\u5728\u751f\u4ea7\u73af\u5883\u4ea7\u751f\u4eba\u4e3a\u6545\u969c\u3002 \u4e0a\u8ff0\u95ee\u9898\u90fd\u53ef\u4ee5\u901a\u8fc7 Service Mesh \u63a7\u5236\u9762\u89e3\u51b3\uff0c \u63a7\u5236\u9762\u652f\u6301\u4e24\u79cd\u73af\u5883\u4e0d\u540c\u7684\u6743\u91cd\u914d\u7f6e \uff0c\u7ed3\u5408\u670d\u52a1\u6cbb\u7406\u5e73\u53f0\u63d0\u4f9b\u7684 Web UI\uff0c\u53ef\u4ee5\u8ba9\u8fd0\u7ef4\u975e\u5e38\u65b9\u4fbf\u5730\u64cd\u4f5c\uff0c\u800c\u4e0d\u9700\u8981\u4e1a\u52a1\u65b9\u4fee\u6539\u4ee3\u7801\u6216\u8005\u914d\u7f6e\u4e2d\u5fc3\u3002","title":"2-3 \u5982\u4f55\u4ece\u865a\u62df\u673a\u73af\u5883\u8fc1\u79fb\u5230 Kubernetes \u73af\u5883"},{"location":"chap3/0Service_Mesh/","text":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c(Service Mesh)\u662f\u4ec0\u4e48? \u73b0\u5728\u6700\u706b\u7684\u540e\u7aef\u67b6\u6784\u65e0\u7591\u662f \u5fae\u670d\u52a1 \u4e86\uff0c\u5fae\u670d\u52a1\u5c06\u4e4b\u524d\u7684\u5355\u4f53\u5e94\u7528\u62c6\u5206\u6210\u4e86\u8bb8\u591a\u72ec\u7acb\u7684\u670d\u52a1\u5e94\u7528\uff0c\u6bcf\u4e2a\u5fae\u670d\u52a1\u90fd\u662f\u72ec\u7acb\u7684\uff0c\u597d\u5904\u81ea\u7136\u5f88\u591a\uff0c\u4f46\u662f\u968f\u7740\u5e94\u7528\u7684\u8d8a\u6765\u8d8a\u5927\uff0c\u5fae\u670d\u52a1\u66b4\u9732\u51fa\u6765\u7684\u95ee\u9898\u4e5f\u5c31\u968f\u4e4b\u800c\u6765\u4e86\uff0c\u5fae\u670d\u52a1\u8d8a\u6765\u8d8a\u591a\uff0c\u7ba1\u7406\u8d8a\u6765\u8d8a\u9ebb\u70e6\uff0c\u7279\u522b\u662f\u8981\u4f60\u90e8\u7f72\u4e00\u5957\u65b0\u73af\u5883\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u80fd\u4f53\u4f1a\u5230\u8fd9\u79cd\u75db\u82e6\u4e86\uff0c\u968f\u4e4b\u800c\u6765\u7684 \u670d\u52a1\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001Trace\u8ddf\u8e2a\u3001\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u8ba4\u8bc1 \u7b49\u7b49\u95ee\u9898\u3002 \u5982\u679c\u4ece\u5934\u5230\u5c3e\u5b8c\u6210\u8fc7\u4e00\u5957\u5fae\u670d\u52a1\u6846\u67b6\u7684\u8bdd\uff0c\u4f60\u5c31\u4f1a\u77e5\u9053\u8fd9\u91cc\u9762\u6d89\u53ca\u5230\u7684\u4e1c\u897f\u771f\u7684\u975e\u5e38\u591a\u3002\u5f53\u7136\u968f\u7740\u5fae\u670d\u52a1\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u5fae\u670d\u52a1\u7684\u751f\u6001\u4e5f\u4e0d\u65ad\u5b8c\u5584\uff0c\u6700\u8fd1\u5c31\u53d1\u73b0\u65b0\u4e00\u4ee3\u7684\u5fae\u670d\u52a1\u5f00\u53d1\u5c31\u6084\u7136\u5174\u8d77\u4e86\uff0c\u90a3\u5c31\u662f \u670d\u52a1\u7f51\u683c/Service Mesh \u3002 1\u3001\u4ec0\u4e48\u662fService Mesh\uff1f Service Mesh \u662f\u4e00\u4e2a\u975e\u5e38\u65b0\u7684\u540d\u8bcd\uff0c\u6700\u65e9\u662f2016\u5e74\u7531\u5f00\u53d1Linkerd\u7684 Buoyant \u516c\u53f8\u63d0\u51fa\u7684\uff0c\u642c\u968f\u7740Linkerd\u7684\u4f20\u5165\uff0c Service Mesh \u7684\u6982\u5ff5\u4e5f\u6162\u6162\u8fdb\u5165\u56fd\u5185\u6280\u672f\u793e\u533a\u3002\u4e4b\u524d infoQ \u7684\u4e00\u7bc7\u4ecb\u7ecd istio \u7684\u6587\u7ae0\u5c06 Service Mesh \u7ffb\u8bd1\u6210\u7684 \u670d\u52a1\u556e\u5408\u5c42 \uff0c \u556e\u5408 \u7684\u5b57\u9762\u610f\u601d\u662f\uff1a\u4e24\u4e2a\u9f7f\u8f6e\u95f4\u7684\u54ac\u5408\uff0c\u548c Service Mesh \u8868\u8fbe\u7684\u610f\u601d\u57fa\u672c\u4e0a\u8fd8\u662f\u543b\u5408\u7684\uff0c\u4f46\u662f\u8fd9\u4e2a\u8bcd\u6bd4\u8f83\u62d7\u53e3\u3002\u5230\u73b0\u5728\u4e3b\u6d41\u7684\u53eb\u6cd5\u90fd\u53eb\uff1a \u670d\u52a1\u7f51\u683c \u3002 Willian Morgan\uff08Linker \u7684CEO\uff09\u7ed9\u51fa\u7684 Service Mesh \u5b9a\u4e49\uff1a A service mesh is a dedicated infrastructure layer for handling service-to-service communication. It\u2019s responsible for the reliable delivery of requests through the complex topology of services that comprise a modern, cloud native application. In practice, the service mesh is typically implemented as an array of lightweight network proxies that are deployed alongside application code, without the application needing to be aware. \u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u7528\u4e8e\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5b83\u8d1f\u8d23\u4e3a\u6784\u5efa\u590d\u6742\u7684\u4e91\u539f\u751f\u5e94\u7528\u4f20\u9012\u53ef\u9760\u7684\u7f51\u7edc\u8bf7\u6c42\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u901a\u5e38\u5b9e\u73b0\u4e3a\u4e00\u7ec4\u548c\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5728\u4e00\u8d77\u7684\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\uff0c\u4f46\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u662f\u900f\u660e\u7684\u3002 2\u3001\u600e\u4e48\u7406\u89e3\u7f51\u683c \u8981\u7406\u89e3\u7f51\u683c\u7684\u6982\u5ff5\uff0c\u5c31\u5f97\u4ece\u670d\u52a1\u7684\u90e8\u7f72\u6a21\u578b\u8bf4\u8d77\uff1a 2-1 \u5355\u4e2a\u670d\u52a1\u8c03\u7528\uff0c\u8868\u73b0\u4e3a sidecar Service Mesh \u7684\u90e8\u7f72\u6a21\u578b\uff0c\u5148\u770b\u5355\u4e2a\u7684\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7b80\u5355\u8bf7\u6c42\uff0c\u4f5c\u4e3a\u8bf7\u6c42\u53d1\u8d77\u8005\u7684\u5ba2\u6237\u7aef\u5e94\u7528\u5b9e\u4f8b\uff0c\u4f1a\u9996\u5148\u7528\u7b80\u5355\u65b9\u5f0f\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u672c\u5730\u7684 Service Mesh \u5b9e\u4f8b\u3002 \u8fd9\u662f\u4e24\u4e2a\u72ec\u7acb\u8fdb\u7a0b\uff0c\u4ed6\u4eec\u4e4b\u95f4\u662f\u8fdc\u7a0b\u8c03\u7528\u3002 Service Mesh \u4f1a\u5b8c\u6210\u5b8c\u6574\u7684\u670d\u52a1\u95f4\u8c03\u7528\u6d41\u7a0b\uff0c\u5982\u670d\u52a1\u53d1\u73b0\u8d1f\u8f7d\u5747\u8861\uff0c\u6700\u540e\u5c06\u8bf7\u6c42\u53d1\u9001\u7ed9\u76ee\u6807\u670d\u52a1\u3002\u8fd9\u8868\u73b0\u4e3a Sidecar \u3002 \u63d0\u5230 Sidecar \uff0c\u5728Kubernetes\u4e2d\u90e8\u7f72\u7684 POD \u4e2d\u4e5f\u4f1a\u6709\u4e00\u4e2a\u9644\u52a0\u7684 Sidecar \u5bb9\u5668\u3002 \u5fae\u670d\u52a1\u4e2d\u7684Sidecar\u8bbe\u8ba1\u6a21\u5f0f\u89e3\u6790 2-2 \u90e8\u7f72\u591a\u4e2a\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u901a\u8baf\u5c42 \u591a\u4e2a\u670d\u52a1\u8c03\u7528\u7684\u60c5\u51b5\uff0c\u5728\u8fd9\u4e2a\u56fe\u4e0a\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Service Mesh \u5728\u6240\u6709\u7684\u670d\u52a1\u7684\u4e0b\u9762\uff0c \u8fd9\u4e00\u5c42\u88ab\u79f0\u4e4b\u4e3a\u670d\u52a1\u95f4\u901a\u8baf\u4e13\u7528\u57fa\u7840\u8bbe\u65bd\u5c42 \u3002 Service Mesh \u4f1a\u63a5\u7ba1\u6574\u4e2a\u7f51\u7edc\uff0c\u628a\u6240\u6709\u7684\u8bf7\u6c42\u5728\u670d\u52a1\u4e4b\u95f4\u505a\u8f6c\u53d1 \u3002 \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4e0a\u9762\u7684\u670d\u52a1\u4e0d\u518d\u8d1f\u8d23\u4f20\u9012\u8bf7\u6c42\u7684\u5177\u4f53\u903b\u8f91\uff0c\u53ea\u8d1f\u8d23\u5b8c\u6210\u4e1a\u52a1\u5904\u7406\u3002 \u670d\u52a1\u95f4\u901a\u8baf\u7684\u73af\u8282\u5c31\u4ece\u5e94\u7528\u91cc\u9762\u5265\u79bb\u51fa\u6765\uff0c\u5448\u73b0\u51fa\u4e00\u4e2a\u62bd\u8c61\u5c42\u3002 2-3 \u6709\u5927\u91cf\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u7f51\u7edc \u5982\u679c\u6709\u5927\u91cf\u7684\u670d\u52a1\uff0c\u5c31\u4f1a\u8868\u73b0\u51fa\u6765\u7f51\u683c\u3002 \u56fe\u4e2d\u5de6\u8fb9\u7eff\u8272\u65b9\u683c\u662f\u5e94\u7528\uff0c \u53f3\u8fb9\u84dd\u8272\u7684\u65b9\u6846\u662f Service Mesh \uff0c\u84dd\u8272\u4e4b\u95f4\u7684\u7ebf\u6761\u662f\u8868\u793a\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u3002 Sidecar \u4e4b\u95f4\u7684\u8fde\u63a5\u5c31\u4f1a\u5f62\u6210\u4e00\u4e2a\u7f51\u7edc\uff0c \u8fd9\u4e2a\u5c31\u662f\u670d\u52a1\u7f51\u683c\u540d\u5b57\u7684\u7531\u6765 \u3002 \u8fd9\u4e2a\u65f6\u5019\u4ee3\u7406\u4f53\u73b0\u51fa\u6765\u7684\u5c31\u548c\u524d\u9762\u7684 Sidecar \u4e0d\u4e00\u6837\u4e86\uff0c\u5f62\u6210\u7f51\u72b6\u3002 3\u3001\u670d\u52a1\u7f51\u683c \u9996\u5148\u7b2c\u4e00\u4e2a\uff0c\u670d\u52a1\u7f51\u683c\u662f\u62bd\u8c61\u7684\uff0c\u5b9e\u9645\u4e0a\u662f\u62bd\u8c61\u51fa\u4e86\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5728\u5e94\u7528\u4e4b\u5916\u3002\u5176\u6b21\uff0c\u529f\u80fd\u662f\u5b9e\u73b0\u8bf7\u6c42\u7684\u53ef\u9760\u4f20\u9012\u3002\u90e8\u7f72\u4e0a\u4f53\u73b0\u4e3a\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\u3002\u6700\u540e\u4e00\u4e2a\u5173\u952e\u8bcd\u662f\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u900f\u660e\u3002 \u5927\u5bb6\u6ce8\u610f\u770b\uff0c\u4e0a\u9762\u7684\u56fe\u4e2d\uff0c\u7f51\u7edc\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u4e0d\u662f\u7279\u522b\u660e\u663e\u3002 \u4f46\u662f\u5982\u679c\u628a\u5de6\u8fb9\u7684\u5e94\u7528\u7a0b\u5e8f\u53bb\u6389\uff0c\u73b0\u5728\u53ea\u5448\u73b0\u51fa\u6765 Service Mesh \u548c\u4ed6\u4eec\u4e4b\u95f4\u7684\u8c03\u7528\uff0c\u8fd9\u4e2a\u65f6\u5019\u5173\u7cfb\u5c31\u4f1a\u7279\u522b\u6e05\u6670\uff0c\u5c31\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u7f51\u7edc\u3002 \u8fd9\u662f Service Mesh \u5b9a\u4e49\u5f53\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5173\u952e\u70b9\uff0c\u548c Sidecar \u4e0d\u76f8\u540c\u7684\u5730\u65b9\uff1a\u4e0d\u518d\u5c06\u4ee3\u7406\u89c6\u4e3a\u5355\u72ec\u7684\u7ec4\u4ef6\uff0c\u800c\u662f\u5f3a\u8c03\u7531\u8fd9\u4e9b\u4ee3\u7406\u8fde\u63a5\u800c\u5f62\u6210\u7684\u7f51\u7edc\u3002\u5728 Service Mesh \u91cc\u9762\u975e\u5e38\u5f3a\u8c03\u4ee3\u7406\u8fde\u63a5\u7ec4\u6210\u7684\u7f51\u7edc\uff0c\u800c\u4e0d\u50cf Sidecar \u90a3\u6837\u770b\u5f85\u4e2a\u4f53\u3002 What's a service mesh? And why do I need one?","title":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c(Service Mesh)\u662f\u4ec0\u4e48?"},{"location":"chap3/0Service_Mesh/#service-mesh","text":"\u73b0\u5728\u6700\u706b\u7684\u540e\u7aef\u67b6\u6784\u65e0\u7591\u662f \u5fae\u670d\u52a1 \u4e86\uff0c\u5fae\u670d\u52a1\u5c06\u4e4b\u524d\u7684\u5355\u4f53\u5e94\u7528\u62c6\u5206\u6210\u4e86\u8bb8\u591a\u72ec\u7acb\u7684\u670d\u52a1\u5e94\u7528\uff0c\u6bcf\u4e2a\u5fae\u670d\u52a1\u90fd\u662f\u72ec\u7acb\u7684\uff0c\u597d\u5904\u81ea\u7136\u5f88\u591a\uff0c\u4f46\u662f\u968f\u7740\u5e94\u7528\u7684\u8d8a\u6765\u8d8a\u5927\uff0c\u5fae\u670d\u52a1\u66b4\u9732\u51fa\u6765\u7684\u95ee\u9898\u4e5f\u5c31\u968f\u4e4b\u800c\u6765\u4e86\uff0c\u5fae\u670d\u52a1\u8d8a\u6765\u8d8a\u591a\uff0c\u7ba1\u7406\u8d8a\u6765\u8d8a\u9ebb\u70e6\uff0c\u7279\u522b\u662f\u8981\u4f60\u90e8\u7f72\u4e00\u5957\u65b0\u73af\u5883\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u80fd\u4f53\u4f1a\u5230\u8fd9\u79cd\u75db\u82e6\u4e86\uff0c\u968f\u4e4b\u800c\u6765\u7684 \u670d\u52a1\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001Trace\u8ddf\u8e2a\u3001\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u8ba4\u8bc1 \u7b49\u7b49\u95ee\u9898\u3002 \u5982\u679c\u4ece\u5934\u5230\u5c3e\u5b8c\u6210\u8fc7\u4e00\u5957\u5fae\u670d\u52a1\u6846\u67b6\u7684\u8bdd\uff0c\u4f60\u5c31\u4f1a\u77e5\u9053\u8fd9\u91cc\u9762\u6d89\u53ca\u5230\u7684\u4e1c\u897f\u771f\u7684\u975e\u5e38\u591a\u3002\u5f53\u7136\u968f\u7740\u5fae\u670d\u52a1\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u5fae\u670d\u52a1\u7684\u751f\u6001\u4e5f\u4e0d\u65ad\u5b8c\u5584\uff0c\u6700\u8fd1\u5c31\u53d1\u73b0\u65b0\u4e00\u4ee3\u7684\u5fae\u670d\u52a1\u5f00\u53d1\u5c31\u6084\u7136\u5174\u8d77\u4e86\uff0c\u90a3\u5c31\u662f \u670d\u52a1\u7f51\u683c/Service Mesh \u3002","title":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c(Service Mesh)\u662f\u4ec0\u4e48?"},{"location":"chap3/0Service_Mesh/#1service-mesh","text":"Service Mesh \u662f\u4e00\u4e2a\u975e\u5e38\u65b0\u7684\u540d\u8bcd\uff0c\u6700\u65e9\u662f2016\u5e74\u7531\u5f00\u53d1Linkerd\u7684 Buoyant \u516c\u53f8\u63d0\u51fa\u7684\uff0c\u642c\u968f\u7740Linkerd\u7684\u4f20\u5165\uff0c Service Mesh \u7684\u6982\u5ff5\u4e5f\u6162\u6162\u8fdb\u5165\u56fd\u5185\u6280\u672f\u793e\u533a\u3002\u4e4b\u524d infoQ \u7684\u4e00\u7bc7\u4ecb\u7ecd istio \u7684\u6587\u7ae0\u5c06 Service Mesh \u7ffb\u8bd1\u6210\u7684 \u670d\u52a1\u556e\u5408\u5c42 \uff0c \u556e\u5408 \u7684\u5b57\u9762\u610f\u601d\u662f\uff1a\u4e24\u4e2a\u9f7f\u8f6e\u95f4\u7684\u54ac\u5408\uff0c\u548c Service Mesh \u8868\u8fbe\u7684\u610f\u601d\u57fa\u672c\u4e0a\u8fd8\u662f\u543b\u5408\u7684\uff0c\u4f46\u662f\u8fd9\u4e2a\u8bcd\u6bd4\u8f83\u62d7\u53e3\u3002\u5230\u73b0\u5728\u4e3b\u6d41\u7684\u53eb\u6cd5\u90fd\u53eb\uff1a \u670d\u52a1\u7f51\u683c \u3002 Willian Morgan\uff08Linker \u7684CEO\uff09\u7ed9\u51fa\u7684 Service Mesh \u5b9a\u4e49\uff1a A service mesh is a dedicated infrastructure layer for handling service-to-service communication. It\u2019s responsible for the reliable delivery of requests through the complex topology of services that comprise a modern, cloud native application. In practice, the service mesh is typically implemented as an array of lightweight network proxies that are deployed alongside application code, without the application needing to be aware. \u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u7528\u4e8e\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5b83\u8d1f\u8d23\u4e3a\u6784\u5efa\u590d\u6742\u7684\u4e91\u539f\u751f\u5e94\u7528\u4f20\u9012\u53ef\u9760\u7684\u7f51\u7edc\u8bf7\u6c42\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u901a\u5e38\u5b9e\u73b0\u4e3a\u4e00\u7ec4\u548c\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5728\u4e00\u8d77\u7684\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\uff0c\u4f46\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u662f\u900f\u660e\u7684\u3002","title":"1\u3001\u4ec0\u4e48\u662fService Mesh\uff1f"},{"location":"chap3/0Service_Mesh/#2","text":"\u8981\u7406\u89e3\u7f51\u683c\u7684\u6982\u5ff5\uff0c\u5c31\u5f97\u4ece\u670d\u52a1\u7684\u90e8\u7f72\u6a21\u578b\u8bf4\u8d77\uff1a","title":"2\u3001\u600e\u4e48\u7406\u89e3\u7f51\u683c"},{"location":"chap3/0Service_Mesh/#2-1-sidecar","text":"Service Mesh \u7684\u90e8\u7f72\u6a21\u578b\uff0c\u5148\u770b\u5355\u4e2a\u7684\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7b80\u5355\u8bf7\u6c42\uff0c\u4f5c\u4e3a\u8bf7\u6c42\u53d1\u8d77\u8005\u7684\u5ba2\u6237\u7aef\u5e94\u7528\u5b9e\u4f8b\uff0c\u4f1a\u9996\u5148\u7528\u7b80\u5355\u65b9\u5f0f\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u672c\u5730\u7684 Service Mesh \u5b9e\u4f8b\u3002 \u8fd9\u662f\u4e24\u4e2a\u72ec\u7acb\u8fdb\u7a0b\uff0c\u4ed6\u4eec\u4e4b\u95f4\u662f\u8fdc\u7a0b\u8c03\u7528\u3002 Service Mesh \u4f1a\u5b8c\u6210\u5b8c\u6574\u7684\u670d\u52a1\u95f4\u8c03\u7528\u6d41\u7a0b\uff0c\u5982\u670d\u52a1\u53d1\u73b0\u8d1f\u8f7d\u5747\u8861\uff0c\u6700\u540e\u5c06\u8bf7\u6c42\u53d1\u9001\u7ed9\u76ee\u6807\u670d\u52a1\u3002\u8fd9\u8868\u73b0\u4e3a Sidecar \u3002 \u63d0\u5230 Sidecar \uff0c\u5728Kubernetes\u4e2d\u90e8\u7f72\u7684 POD \u4e2d\u4e5f\u4f1a\u6709\u4e00\u4e2a\u9644\u52a0\u7684 Sidecar \u5bb9\u5668\u3002 \u5fae\u670d\u52a1\u4e2d\u7684Sidecar\u8bbe\u8ba1\u6a21\u5f0f\u89e3\u6790","title":"2-1 \u5355\u4e2a\u670d\u52a1\u8c03\u7528\uff0c\u8868\u73b0\u4e3asidecar"},{"location":"chap3/0Service_Mesh/#2-2","text":"\u591a\u4e2a\u670d\u52a1\u8c03\u7528\u7684\u60c5\u51b5\uff0c\u5728\u8fd9\u4e2a\u56fe\u4e0a\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Service Mesh \u5728\u6240\u6709\u7684\u670d\u52a1\u7684\u4e0b\u9762\uff0c \u8fd9\u4e00\u5c42\u88ab\u79f0\u4e4b\u4e3a\u670d\u52a1\u95f4\u901a\u8baf\u4e13\u7528\u57fa\u7840\u8bbe\u65bd\u5c42 \u3002 Service Mesh \u4f1a\u63a5\u7ba1\u6574\u4e2a\u7f51\u7edc\uff0c\u628a\u6240\u6709\u7684\u8bf7\u6c42\u5728\u670d\u52a1\u4e4b\u95f4\u505a\u8f6c\u53d1 \u3002 \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4e0a\u9762\u7684\u670d\u52a1\u4e0d\u518d\u8d1f\u8d23\u4f20\u9012\u8bf7\u6c42\u7684\u5177\u4f53\u903b\u8f91\uff0c\u53ea\u8d1f\u8d23\u5b8c\u6210\u4e1a\u52a1\u5904\u7406\u3002 \u670d\u52a1\u95f4\u901a\u8baf\u7684\u73af\u8282\u5c31\u4ece\u5e94\u7528\u91cc\u9762\u5265\u79bb\u51fa\u6765\uff0c\u5448\u73b0\u51fa\u4e00\u4e2a\u62bd\u8c61\u5c42\u3002","title":"2-2 \u90e8\u7f72\u591a\u4e2a\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u901a\u8baf\u5c42"},{"location":"chap3/0Service_Mesh/#2-3","text":"\u5982\u679c\u6709\u5927\u91cf\u7684\u670d\u52a1\uff0c\u5c31\u4f1a\u8868\u73b0\u51fa\u6765\u7f51\u683c\u3002 \u56fe\u4e2d\u5de6\u8fb9\u7eff\u8272\u65b9\u683c\u662f\u5e94\u7528\uff0c \u53f3\u8fb9\u84dd\u8272\u7684\u65b9\u6846\u662f Service Mesh \uff0c\u84dd\u8272\u4e4b\u95f4\u7684\u7ebf\u6761\u662f\u8868\u793a\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u3002 Sidecar \u4e4b\u95f4\u7684\u8fde\u63a5\u5c31\u4f1a\u5f62\u6210\u4e00\u4e2a\u7f51\u7edc\uff0c \u8fd9\u4e2a\u5c31\u662f\u670d\u52a1\u7f51\u683c\u540d\u5b57\u7684\u7531\u6765 \u3002 \u8fd9\u4e2a\u65f6\u5019\u4ee3\u7406\u4f53\u73b0\u51fa\u6765\u7684\u5c31\u548c\u524d\u9762\u7684 Sidecar \u4e0d\u4e00\u6837\u4e86\uff0c\u5f62\u6210\u7f51\u72b6\u3002","title":"2-3 \u6709\u5927\u91cf\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u7f51\u7edc"},{"location":"chap3/0Service_Mesh/#3","text":"\u9996\u5148\u7b2c\u4e00\u4e2a\uff0c\u670d\u52a1\u7f51\u683c\u662f\u62bd\u8c61\u7684\uff0c\u5b9e\u9645\u4e0a\u662f\u62bd\u8c61\u51fa\u4e86\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5728\u5e94\u7528\u4e4b\u5916\u3002\u5176\u6b21\uff0c\u529f\u80fd\u662f\u5b9e\u73b0\u8bf7\u6c42\u7684\u53ef\u9760\u4f20\u9012\u3002\u90e8\u7f72\u4e0a\u4f53\u73b0\u4e3a\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\u3002\u6700\u540e\u4e00\u4e2a\u5173\u952e\u8bcd\u662f\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u900f\u660e\u3002 \u5927\u5bb6\u6ce8\u610f\u770b\uff0c\u4e0a\u9762\u7684\u56fe\u4e2d\uff0c\u7f51\u7edc\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u4e0d\u662f\u7279\u522b\u660e\u663e\u3002 \u4f46\u662f\u5982\u679c\u628a\u5de6\u8fb9\u7684\u5e94\u7528\u7a0b\u5e8f\u53bb\u6389\uff0c\u73b0\u5728\u53ea\u5448\u73b0\u51fa\u6765 Service Mesh \u548c\u4ed6\u4eec\u4e4b\u95f4\u7684\u8c03\u7528\uff0c\u8fd9\u4e2a\u65f6\u5019\u5173\u7cfb\u5c31\u4f1a\u7279\u522b\u6e05\u6670\uff0c\u5c31\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u7f51\u7edc\u3002 \u8fd9\u662f Service Mesh \u5b9a\u4e49\u5f53\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5173\u952e\u70b9\uff0c\u548c Sidecar \u4e0d\u76f8\u540c\u7684\u5730\u65b9\uff1a\u4e0d\u518d\u5c06\u4ee3\u7406\u89c6\u4e3a\u5355\u72ec\u7684\u7ec4\u4ef6\uff0c\u800c\u662f\u5f3a\u8c03\u7531\u8fd9\u4e9b\u4ee3\u7406\u8fde\u63a5\u800c\u5f62\u6210\u7684\u7f51\u7edc\u3002\u5728 Service Mesh \u91cc\u9762\u975e\u5e38\u5f3a\u8c03\u4ee3\u7406\u8fde\u63a5\u7ec4\u6210\u7684\u7f51\u7edc\uff0c\u800c\u4e0d\u50cf Sidecar \u90a3\u6837\u770b\u5f85\u4e2a\u4f53\u3002 What's a service mesh? And why do I need one?","title":"3\u3001\u670d\u52a1\u7f51\u683c"},{"location":"chap3/1isba_Frame_Tech/","text":"\u7b2c\u4e8c\u8282 Istio \u67b6\u6784\u4e0e\u6280\u672f \u5927\u7eb2 Service Mesh Istio \u67b6\u6784\u57fa\u7840 Istio \u57fa\u672c\u6982\u5ff5 Istio & Kubernetes:\u67b6\u6784\u7ed3\u5408 \u8fd0\u884c\u7b2c\u4e00\u4e2aIstio\u96c6\u7fa4 1\u3001Kubernetes Kubernetes \u63d0\u4f9b\u5e73\u53f0\u57fa\u7840\u8bbe\u65bd\u5c42\u5f3a\u5927\u7684 \u5bb9\u5668\u7f16\u6392\u4e0e\u8c03\u5ea6\u80fd\u529b \u670d\u52a1\u90e8\u7f72\u4e0e\u5f39\u6027\u4f38\u7f29 : Deployment \u670d\u52a1\u62c6\u5206\u4e0e\u670d\u52a1\u53d1\u73b0 : Service Kubernetes \u63d0\u4f9b\u7b80\u5355\u7684\u8d1f\u8f7d\u5747\u8861 \u8d1f\u8f7d\u5747\u8861 :\u57fa\u4e8e IPVS \u6216 Iptables \u7684\u7b80\u5355\u5747\u8861\u673a\u5236 2\u3001Service Mesh \u6cbb\u7406\u80fd\u529b\u72ec\u7acb(Sidecar) \u5e94\u7528\u7a0b\u5e8f\u65e0\u611f\u77e5 \u670d\u52a1\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42 3\u3001Istio\u95ee\u4e16 \u8fde\u63a5(Connect) \u5b89\u5168(Secure) \u63a7\u5236(Control) \u89c2\u5bdf(Observe) 3-1 Istio\u5173\u952e\u80fd\u529b \u529f\u80fd \u6269\u5c55 4\u3001Istio + Kubernetes:\u4e91\u539f\u751f\u5e94\u7528\u6cbb\u7406 + \u4e91\u539f\u751f\u5e94\u7528\u8bbe\u65bd 4-1 Istio\u67b6\u6784\u4e0e\u5176\u5173\u952e\u7ec4\u4ef6 4-2 Pilot, Service discovery and traffic rule 4-3 Mixer, Check & Report 4-4 Citadel 5\u3001Istio & Kubernetes:\u67b6\u6784\u7ed3\u5408 5-1 Envoy \u57fa\u4e8eC++\u7684 L4/L7 Proxy\u8f6c\u53d1\u5668 CNCF\u7b2c\u4e09\u4e2a\u6bd5\u4e1a\u7684\u9879\u76ee Listeners (LDS) Routes (RDS) Clusters (CDS) Endpoints (EDS) 5-2 Envoy \u914d\u7f6e\u6587\u4ef6 6\u3001Istio \u57fa\u7840\u6982\u5ff5 6-1 VirtualService \u6700\u6838\u5fc3\u7684\u914d\u7f6e\u63a5\u53e3\uff0c\u5b9a\u4e49\u6307\u5b9a\u670d\u52a1\u7684\u6240\u6709\u8def\u7531\u89c4\u5219 Hosts Gateways Http Tcp Tls apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews-route namespace: foo spec: hosts: - reviews http: - match: - uri: prefix: \"/wpcatalog\" - uri: prefix: \"/consumercatalog\" rewrite: uri: \"/newcatalog\" route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v1 6-2 DestinationRule \u5176\u5b9a\u4e49\u7684\u7b56\u7565\uff0c\u51b3\u5b9a\u4e86\u8def\u7531\u5904\u7406\u4e4b\u540e\u7684\u6d41 \u91cf\u8bbf\u95ee\u7b56\u7565\u3002\u8d1f\u8f7d\u5747\u8861\u8bbe\u7f6e\uff0c\u65ad\u8def\u5668\uff0c TLS\u8bbe\u7f6e\u7b49 Host Subset TrafficPolicy apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: bookinfo-ratings spec: host: ratings trafficPolicy: loadBalancer: simple: LEAST_CONN subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 trafficPolicy: loadBalancer: simple: ROUND_ROBIN 6-3 Gateway \u63d0\u4f9b\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u63a5\u5165\uff0c\u53ef\u53d1\u5e03\u4efb\u610f\u5185\u90e8\u7aef \u53e3\u7684\u670d\u52a1\uff0c\u4f9b\u5916\u90e8\u8bbf\u95ee\u3002 \u914d\u5408 VirtualService \u4f7f\u7528\uff0c\u4f7f\u7528\u6807\u51c6Istio\u89c4\u5219\u6cbb\u7406 Servers Selector apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: bookinfo-gateway spec: selector: istio: ingressgateway # use istio default controller servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*\" --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: bookinfo spec: hosts: - \"*\" gateways: - bookinfo-gateway http: - match: - uri: exact: /productpage route: - destination: ... 6-4 ServiceEntry \u5c06\u5916\u90e8\u670d\u52a1\u63a5\u5165\u5230\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\uff0c\u8ba9Istio\u4e2d\u81ea\u52a8\u53d1\u73b0\u7684\u670d\u52a1\u80fd\u591f\u8bbf\u95ee\u548c\u8def\u7531\u5230\u8fd9\u4e9b\u624b\u5de5\u52a0\u5165\u7684\u670d\u52a1\u3002 \u4e0e VirtualService \u6216 DestinationRule \u914d\u5408\u4f7f\u7528 Hosts Addresss Ports Location Resolution Endpoints apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: external-svc-mongocluster spec: hosts: - mymongodb.somedomain addresses: - 192.192.192.192/24 # VIPs ports: - number: 27018 name: mongodb protocol: MONGO location: MESH_INTERNAL resolution: STATIC endpoints: - address: 2.2.2.2 - address: 3.3.3.3 ---- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: mtls-mongocluster spec: host: mymongodb.somedomain trafficPolicy: tls: mode: MUTUAL clientCertificate: /etc/certs/myclientcert.pem privateKey: /etc/certs/client_private_key.pem caCertificates: /etc/certs/rootcacerts.pem 7\u3001\u57fa\u4e8eK8s\u8fd0\u884cIstio\u96c6\u7fa4 kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml helm template install/kubernetes/helm/istio --name istio --namespace istio-system > $HOME/istio.yaml kubectl create namespace istio-system kubectl apply -f $HOME/istio.yaml 7-1 Istioctl proxy-status :\u72b6\u6001\u540c\u6b65\u60c5\u51b5 proxy-config:envoy \u4e2d\u5177\u4f53\u89c4\u5219\u67e5\u8be2 listener route cluster endpoint kube-inject ...... 8\u3001Demo $ kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml $ helm template install/kubernetes/helm/istio --name istio --namespace istio-system > $HOME/istio.yaml $ kubectl create namespace istio-system $ kubectl apply -f $HOME/istio.yaml 8-1 Every pod inside default namespace will inject istio sidecar $ kubectl label namespace default istio-injection=enabled 8-2 check ingress gateway svc $ kubectl get svc istio-ingressgateway -n istio-system $ kubectl get svc istio-ingressgateway -n istio-system -o yaml 8-3 The bookinfo experiments please check I did before \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e1 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e2","title":"\u7b2c\u4e8c\u8282 Istio \u67b6\u6784\u4e0e\u6280\u672f"},{"location":"chap3/1isba_Frame_Tech/#istio","text":"","title":"\u7b2c\u4e8c\u8282 Istio \u67b6\u6784\u4e0e\u6280\u672f"},{"location":"chap3/1isba_Frame_Tech/#_1","text":"Service Mesh Istio \u67b6\u6784\u57fa\u7840 Istio \u57fa\u672c\u6982\u5ff5 Istio & Kubernetes:\u67b6\u6784\u7ed3\u5408 \u8fd0\u884c\u7b2c\u4e00\u4e2aIstio\u96c6\u7fa4","title":"\u5927\u7eb2"},{"location":"chap3/1isba_Frame_Tech/#1kubernetes","text":"Kubernetes \u63d0\u4f9b\u5e73\u53f0\u57fa\u7840\u8bbe\u65bd\u5c42\u5f3a\u5927\u7684 \u5bb9\u5668\u7f16\u6392\u4e0e\u8c03\u5ea6\u80fd\u529b \u670d\u52a1\u90e8\u7f72\u4e0e\u5f39\u6027\u4f38\u7f29 : Deployment \u670d\u52a1\u62c6\u5206\u4e0e\u670d\u52a1\u53d1\u73b0 : Service Kubernetes \u63d0\u4f9b\u7b80\u5355\u7684\u8d1f\u8f7d\u5747\u8861 \u8d1f\u8f7d\u5747\u8861 :\u57fa\u4e8e IPVS \u6216 Iptables \u7684\u7b80\u5355\u5747\u8861\u673a\u5236","title":"1\u3001Kubernetes"},{"location":"chap3/1isba_Frame_Tech/#2service-mesh","text":"\u6cbb\u7406\u80fd\u529b\u72ec\u7acb(Sidecar) \u5e94\u7528\u7a0b\u5e8f\u65e0\u611f\u77e5 \u670d\u52a1\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42","title":"2\u3001Service Mesh"},{"location":"chap3/1isba_Frame_Tech/#3istio","text":"\u8fde\u63a5(Connect) \u5b89\u5168(Secure) \u63a7\u5236(Control) \u89c2\u5bdf(Observe)","title":"3\u3001Istio\u95ee\u4e16"},{"location":"chap3/1isba_Frame_Tech/#3-1-istio","text":"","title":"3-1 Istio\u5173\u952e\u80fd\u529b"},{"location":"chap3/1isba_Frame_Tech/#_2","text":"","title":"\u529f\u80fd"},{"location":"chap3/1isba_Frame_Tech/#_3","text":"","title":"\u6269\u5c55"},{"location":"chap3/1isba_Frame_Tech/#4istio-kubernetes","text":"","title":"4\u3001Istio + Kubernetes:\u4e91\u539f\u751f\u5e94\u7528\u6cbb\u7406 + \u4e91\u539f\u751f\u5e94\u7528\u8bbe\u65bd"},{"location":"chap3/1isba_Frame_Tech/#4-1-istio","text":"","title":"4-1 Istio\u67b6\u6784\u4e0e\u5176\u5173\u952e\u7ec4\u4ef6"},{"location":"chap3/1isba_Frame_Tech/#4-2-pilot-service-discovery-and-traffic-rule","text":"","title":"4-2 Pilot, Service discovery and traffic rule"},{"location":"chap3/1isba_Frame_Tech/#4-3-mixer-check-report","text":"","title":"4-3 Mixer, Check &amp; Report"},{"location":"chap3/1isba_Frame_Tech/#4-4-citadel","text":"","title":"4-4 Citadel"},{"location":"chap3/1isba_Frame_Tech/#5istio-kubernetes","text":"","title":"5\u3001Istio &amp; Kubernetes:\u67b6\u6784\u7ed3\u5408"},{"location":"chap3/1isba_Frame_Tech/#5-1-envoy","text":"\u57fa\u4e8eC++\u7684 L4/L7 Proxy\u8f6c\u53d1\u5668 CNCF\u7b2c\u4e09\u4e2a\u6bd5\u4e1a\u7684\u9879\u76ee Listeners (LDS) Routes (RDS) Clusters (CDS) Endpoints (EDS)","title":"5-1 Envoy"},{"location":"chap3/1isba_Frame_Tech/#5-2-envoy","text":"","title":"5-2 Envoy \u914d\u7f6e\u6587\u4ef6"},{"location":"chap3/1isba_Frame_Tech/#6istio","text":"","title":"6\u3001Istio \u57fa\u7840\u6982\u5ff5"},{"location":"chap3/1isba_Frame_Tech/#6-1-virtualservice","text":"\u6700\u6838\u5fc3\u7684\u914d\u7f6e\u63a5\u53e3\uff0c\u5b9a\u4e49\u6307\u5b9a\u670d\u52a1\u7684\u6240\u6709\u8def\u7531\u89c4\u5219 Hosts Gateways Http Tcp Tls apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews-route namespace: foo spec: hosts: - reviews http: - match: - uri: prefix: \"/wpcatalog\" - uri: prefix: \"/consumercatalog\" rewrite: uri: \"/newcatalog\" route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v1","title":"6-1 VirtualService"},{"location":"chap3/1isba_Frame_Tech/#6-2-destinationrule","text":"\u5176\u5b9a\u4e49\u7684\u7b56\u7565\uff0c\u51b3\u5b9a\u4e86\u8def\u7531\u5904\u7406\u4e4b\u540e\u7684\u6d41 \u91cf\u8bbf\u95ee\u7b56\u7565\u3002\u8d1f\u8f7d\u5747\u8861\u8bbe\u7f6e\uff0c\u65ad\u8def\u5668\uff0c TLS\u8bbe\u7f6e\u7b49 Host Subset TrafficPolicy apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: bookinfo-ratings spec: host: ratings trafficPolicy: loadBalancer: simple: LEAST_CONN subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 trafficPolicy: loadBalancer: simple: ROUND_ROBIN","title":"6-2 DestinationRule"},{"location":"chap3/1isba_Frame_Tech/#6-3-gateway","text":"\u63d0\u4f9b\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u63a5\u5165\uff0c\u53ef\u53d1\u5e03\u4efb\u610f\u5185\u90e8\u7aef \u53e3\u7684\u670d\u52a1\uff0c\u4f9b\u5916\u90e8\u8bbf\u95ee\u3002 \u914d\u5408 VirtualService \u4f7f\u7528\uff0c\u4f7f\u7528\u6807\u51c6Istio\u89c4\u5219\u6cbb\u7406 Servers Selector apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: bookinfo-gateway spec: selector: istio: ingressgateway # use istio default controller servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*\" --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: bookinfo spec: hosts: - \"*\" gateways: - bookinfo-gateway http: - match: - uri: exact: /productpage route: - destination: ...","title":"6-3 Gateway"},{"location":"chap3/1isba_Frame_Tech/#6-4-serviceentry","text":"\u5c06\u5916\u90e8\u670d\u52a1\u63a5\u5165\u5230\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\uff0c\u8ba9Istio\u4e2d\u81ea\u52a8\u53d1\u73b0\u7684\u670d\u52a1\u80fd\u591f\u8bbf\u95ee\u548c\u8def\u7531\u5230\u8fd9\u4e9b\u624b\u5de5\u52a0\u5165\u7684\u670d\u52a1\u3002 \u4e0e VirtualService \u6216 DestinationRule \u914d\u5408\u4f7f\u7528 Hosts Addresss Ports Location Resolution Endpoints apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: external-svc-mongocluster spec: hosts: - mymongodb.somedomain addresses: - 192.192.192.192/24 # VIPs ports: - number: 27018 name: mongodb protocol: MONGO location: MESH_INTERNAL resolution: STATIC endpoints: - address: 2.2.2.2 - address: 3.3.3.3 ---- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: mtls-mongocluster spec: host: mymongodb.somedomain trafficPolicy: tls: mode: MUTUAL clientCertificate: /etc/certs/myclientcert.pem privateKey: /etc/certs/client_private_key.pem caCertificates: /etc/certs/rootcacerts.pem","title":"6-4 ServiceEntry"},{"location":"chap3/1isba_Frame_Tech/#7k8sistio","text":"kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml helm template install/kubernetes/helm/istio --name istio --namespace istio-system > $HOME/istio.yaml kubectl create namespace istio-system kubectl apply -f $HOME/istio.yaml","title":"7\u3001\u57fa\u4e8eK8s\u8fd0\u884cIstio\u96c6\u7fa4"},{"location":"chap3/1isba_Frame_Tech/#7-1-istioctl","text":"proxy-status :\u72b6\u6001\u540c\u6b65\u60c5\u51b5 proxy-config:envoy \u4e2d\u5177\u4f53\u89c4\u5219\u67e5\u8be2 listener route cluster endpoint kube-inject ......","title":"7-1 Istioctl"},{"location":"chap3/1isba_Frame_Tech/#8demo","text":"$ kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml $ helm template install/kubernetes/helm/istio --name istio --namespace istio-system > $HOME/istio.yaml $ kubectl create namespace istio-system $ kubectl apply -f $HOME/istio.yaml","title":"8\u3001Demo"},{"location":"chap3/1isba_Frame_Tech/#8-1-every-pod-inside-default-namespace-will-inject-istio-sidecar","text":"$ kubectl label namespace default istio-injection=enabled","title":"8-1 Every pod inside default namespace will inject istio sidecar"},{"location":"chap3/1isba_Frame_Tech/#8-2-check-ingress-gateway-svc","text":"$ kubectl get svc istio-ingressgateway -n istio-system $ kubectl get svc istio-ingressgateway -n istio-system -o yaml","title":"8-2 check ingress gateway svc"},{"location":"chap3/1isba_Frame_Tech/#8-3-the-bookinfo-experiments-please-check-i-did-before","text":"\u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e1 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e2","title":"8-3 The bookinfo experiments please check I did before"},{"location":"chap3/2isba_Service_Find/","text":"\u7b2c\u4e09\u8282 Istio \u670d\u52a1\u53d1\u73b0\u548c Pilot\u7684\u67b6\u6784\u673a\u5236 Istio\u67b6\u6784\u56de\u987e&Pilot\u4ecb\u7ecd Istio\u670d\u52a1\u53d1\u73b0 Istio\u670d\u52a1\u914d\u7f6e Istio\u670d\u52a1\u53d1\u73b0&\u89c4\u5219\u7ba1\u7406\u4e0eKubernetes\u7ed3\u5408 ShowCase 1\u3001Istio\u67b6\u6784\u56de\u987e&Pilot\u4ecb\u7ecd 1-1 \u4e0a\u671f\u56de\u987e:Istio\u67b6\u6784 1-2 Pilot\u529f\u80fd \u670d\u52a1\u53d1\u73b0 \u670d\u52a1\u914d\u7f6e 2\u3001Istio\u670d\u52a1\u53d1\u73b0 2-1 \u670d\u52a1\u53d1\u73b0\u57fa\u672c\u539f\u7406 Service register Service discover Service provide 2-2 SpringCloud\u7684\u670d\u52a1(\u5916\u90e8\uff09\u6ce8\u518c\u4e0e\u53d1\u73b0\u6d41\u7a0b \u670d\u52a1\u6ce8\u518c\u8868 : \u5982 Springcloud \u4e2d\u4e00\u822c Eureka \u670d\u52a1; \u670d\u52a1\u6ce8\u518c : \u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u914d\u7f6e\u670d\u52a1\u540d\u548c\u672c\u5b9e\u4f8b\u5730\u5740 \uff0c\u5b9e\u4f8b\u542f\u52a8\u65f6\u81ea\u52a8\u6ce8\u518c\u5230\u670d\u52a1\u6ce8\u518c\u8868; \u670d\u52a1\u53d1\u73b0 : \u8bbf\u95ee\u76ee\u6807\u670d\u52a1\u65f6\u8fde\u670d\u52a1\u6ce8\u518c\u8868 \uff0c\u83b7\u53d6\u670d\u52a1\u5b9e\u4f8b\u5217\u8868\u3002\u6839\u636e LB \u6839\u636e\u7b56\u7565\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\uff0c\u5efa\u7acb\u8fde\u63a5\u53bb\u8bbf\u95ee\u3002 Eureka Server - Register Service list Load Balancer - Find Service Eureka Client - Service return 2-3 Istio\u670d\u52a1\u53d1\u73b0\u6d41\u7a0b\uff08\u5185\u90e8\uff09 \u670d\u52a1\u6ce8\u518c\u8868: Pilot \u4ece\u5e73\u53f0\u83b7\u53d6\u670d\u52a1\u53d1\u73b0\u6570\u636e\uff0c\u5e76\u63d0\u4f9b\u7edf\u4e00\u7684\u670d\u52a1\u53d1\u73b0\u63a5\u53e3\u3002 \u670d\u52a1\u6ce8\u518c: \u65e0 \u670d\u52a1\u53d1\u73b0: Envoy \u5b9e\u73b0\u670d\u52a1\u53d1\u73b0 \uff0c\u52a8\u6001\u66f4\u65b0\u8d1f\u8f7d\u5747\u8861\u6c60\u3002 \u5728\u670d\u52a1\u8bf7\u6c42\u65f6\u4f7f\u7528\u5bf9\u5e94\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u5bf9\u5e94\u7684\u540e\u7aef\u3002 Pilot -> Service registration by the platform Enovy -> Service discovery by Envoys 2-4 Pilot\u670d\u52a1\u53d1\u73b0\u673a\u5236\u7684Adapter\u673a\u5236 Abstract Model Services Services Instances Services Versions 2-5 Istio\u670d\u52a1\u53d1\u73b0\u5b9e\u73b0: \u57fa\u4e8e Eureka Pilot \u5b9e\u73b0 \u82e5\u5e72\u670d\u52a1\u53d1\u73b0\u7684\u63a5\u53e3\u5b9a\u4e49 Controller \u4f7f\u7528 EurekaClient \u6765\u83b7\u53d6\u670d\u52a1\u5217\u8868\uff0c\u63d0\u4f9b\u8f6c\u6362\u540e\u7684\u6807\u51c6\u7684\u670d\u52a1\u53d1\u73b0\u63a5\u53e3\u548c\u6570\u636e\u7ed3\u6784; Discoveryserver \u57fa\u4e8e Controller \u4e0a\u7ef4\u62a4\u7684\u670d\u52a1\u53d1\u73b0\u6570\u636e\uff0c\u53d1\u5e03\u6210 gRPC \u534f\u8bae\u7684\u670d\u52a1\u4f9b Envoy \u4f7f\u7528\u3002 \u5f53\u6709\u670d\u52a1\u8bbf\u95ee\u65f6\uff0c Envoy \u5728\u5904\u7406 Outbound \u8bf7\u6c42\u65f6\uff0c\u6839\u636e\u914d\u7f6e\u7684 LB \u7b56\u7565\uff0c\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u53d1\u8d77\u8bbf\u95ee public interface ServiceInstance { String getServiceId(); String getHost(); int getPort(); boolean isSecure(); URI getUri(); Map<String, String> getMetadata(); } 2-6 Istio \u670d\u52a1\u53d1\u73b0\u5b9e\u73b0:\u57fa\u4e8eKubernetes Pilot \u5b9e\u73b0\u82e5\u5e72\u670d\u52a1\u53d1\u73b0\u7684\u63a5\u53e3\u5b9a\u4e49 Pilot \u7684 Controller List/Watch KubeAPIserver \u4e0a service \u3001 endpoint \u7b49\u8d44\u6e90\u5bf9\u8c61\u5e76\u8f6c\u6362\u6210\u6807\u51c6\u683c\u5f0f \u3002 Envoy \u4ece Pilot \u83b7\u53d6 xDS \uff0c\u52a8\u6001\u66f4\u65b0 \u5f53\u6709\u670d\u52a1\u8bbf\u95ee\u65f6\uff0c Envoy \u5728\u5904\u7406 Outbound \u8bf7\u6c42\u65f6\uff0c\u6839\u636e\u914d\u7f6e\u7684 LB \u7b56\u7565\uff0c\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u53d1\u8d77\u8bbf\u95ee\u3002 type Service struct { // Hostname of the service, e.g. \"catalog.mystore.com\" Hostname Hostname `json:\"hostname\"` Address string `json:\"address,omitempty\"` Addresses map[string]string `json:\"addresses,omitempty\"` // Ports is the set of network ports where the service is listening for connections Ports PortList `json:\"ports,omitempty\"` ExternalName Hostname `json:\"external\"` ... } 2-7 Kubernetes & Istio \u670d\u52a1\u6a21\u578b 2-8 Kuberntes\u7684\u670d\u52a1\u53d1\u73b0 2-9 Istio Upon Kubernetes\u573a\u666f Istiio => \u670d\u52a1\u6cbb\u7406 \u2022 \u8c03\u7528\u94fe\u8ffd\u8e2a \u2022 \u52a8\u6001\u8def\u7531 \u2022 \u7194\u65ad\u9650\u6d41 kubernetes => \u670d\u52a1\u7684\u90e8\u7f72\u8fd0\u7ef4 \u2022 \u8d1f\u8f7d\u5747\u8861 \u2022 \u670d\u52a1\u53d1\u73b0 \u2022 \u6269\u7f29\u5bb9 \u2022 \u8fd0\u7ef4 \u2022 \u90e8\u7f72 2-10 Istio (upon Kubernetes)\u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e POD to POD => Enovy to Enovy Envoy \u4ece Pilot \u83b7\u53d6 xDS \uff0c\u52a8\u6001\u66f4\u65b0 Pilot \u7684 Controller List/Watch KubeAPIserver \u4e0a service \u3001 endpoint \u7b49\u8d44\u6e90\u5bf9\u8c61\u5e76\u8f6c\u6362\u6210\u6807\u51c6\u683c\u5f0f 3\u3001Istio\u670d\u52a1\u914d\u7f6e\u7ba1\u7406 3-1 Istio \u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7ef4\u62a4\u548c\u5de5\u4f5c\u673a\u5236 \u914d\u7f6e: \u7ba1\u7406\u5458\u901a\u8fc7Pilot\u914d\u7f6e\u6cbb\u7597\u89c4\u5219 \u4e0b\u53d1: Envoy\u4ecePilot\u83b7\u53d6\u6cbb\u7406\u89c4\u5219 \u6267\u884c: \u5728\u6d41\u91cf\u8bbf\u95ee\u7684\u65f6\u5019\u6267\u884c\u6cbb\u7406\u89c4\u5219 3-2 Istio\u6cbb\u7406\u89c4\u5219 VirtualService : Configuration affecting label/content routing, sni routing, etc. DestinationRule : Configuration affecting load balancing, outlier detection, etc. Gateway : Configuration affecting edge load balancer. ServiceEntry : Configuration affecting service registry. Sidecar : Configuration affecting network reachability of a sidecar. Envoy Filter : Configuration affecting insertion of custom Envoy filters. https://istio.io/docs/reference/config/istio.networking.v1alpha3/ 3-3 Istio\u6d41\u91cf\u89c4\u5219: VirtualService \u670d\u52a1\u8bbf\u95ee\u8def\u7531\u63a7\u5236 \u3002 \u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6\u7684\u8bf7\u6c42\u6d41\u5230\u54ea\u91cc\uff0c\u8fc7\u7a0b\u4e2d\u6cbb\u7406\u3002\u5305\u62ec\u8bf7\u6c42\u91cd\u5199\u3001\u91cd\u8bd5\u3001\u6545\u969c\u6ce8\u5165\u7b49\u3002 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: Foo: exact: bar fault: delay: fixedDelay: 5s abort: percent: 10 httpStatus: 400 route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v1 \u534f\u8bae\u652f\u6301: http HTTPRoute[] tls TLSRoute[] tcp TCPRoute[] HTTP\u534f\u8bae\u6d41\u91cf\u89c4\u5219: Field Type match HTTPMatchRequest[] route HTTPRouteDestination[] redirect HTTPRedirect rewrite HTTPRewrite timeout google.protobuf.Duration retries HTTPRetry fault HTTPFaultInjection mirror Destination 3-4 Istio\u6d41\u91cf\u89c4\u5219: DestinationRule \u76ee\u6807\u670d\u52a1\u7684\u7b56\u7565\uff0c\u5305\u62ec\u76ee\u6807\u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u8fde\u63a5\u6c60\u7ba1\u7406\u7b49 apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews trafficPolicy: loadBalancer: simple: RANDOM subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 trafficPolicy: loadBalancer: simple: ROUND_ROBIN - name: v3 labels: version: v3 host string trafficPolicy TrafficPolicy subsets Subset[] loadBalancer LoadBalancerSettings connectionPool ConnectionPoolSettings outlierDetection OutlierDetection tls TLSSettings portLevelSettings TrafficPolicy.PortTrafficPolicy[] name string labels map<string, string> trafficPolicy TrafficPolicy 3-5 Istio\u6d41\u91cf\u89c4\u5219: ServiceEntry & Gateway ServiceEntry: \u529f\u80fd : Mesh \u5916\u7684\u670d\u52a1\u52a0\u5165\u5230\u670d\u52a1\u53d1\u73b0\u4e2d\uff0c\u5411 Mesh \u91cc\u9762\u7684\u670d\u52a1\u4e00\u6837\u7684\u88ab\u6cbb\u7406 \u673a\u5236 : \u5c06 ServiceEntry \u63cf\u8ff0\u7684\u670d\u52a1\u52a0\u5165\u5230\u670d\u52a1\u53d1\u73b0\u4e2d;\u5bf9\u8fd9\u4e9b\u670d\u52a1\u7684 outbound \u6d41\u91cf\u8fdb\u884c\u62e6\u622a\uff0c\u8fdb\u800c\u8fdb\u884c\u6cbb\u7406 Gateway: \u529f\u80fd : \u5c06 mesh \u5185\u7684\u4e00\u4e2a\u670d\u52a1\u53d1\u5e03\u6210\u53ef\u4f9b\u5916\u90e8\u8bbf\u95ee\u3002 \u673a\u5236 : \u5728\u5165\u53e3\u5904\u90e8\u7f72\u4e00\u4e2a ingress \u7684 Envoy \uff0c\u5728\u5176\u4e0a\u6267\u884c\u670d\u52a1\u6cbb\u7406\u3002 3-6 Istio\u914d\u7f6e\u89c4\u5219\u7ef4\u62a4\u548c\u4e0b\u53d1\u6d41\u7a0b 3-7 \u6cbb\u7406\u89c4\u5219\u5b9a\u4e49 Istio VS Envoy Istio \u89c4\u5219 3-8 Envoy\u89c4\u5219 3-9 Istio\u6cbb\u7406\u80fd\u529b\u6267\u884c\u4f4d\u7f6e 4\u3001Istio\u670d\u52a1\u53d1\u73b0&\u89c4\u5219\u7ba1\u7406\u4e0eKubernetes\u7ed3\u5408 4-1 Kubernetes & Istio \u7ed3\u5408 \u5bf9\u4e8e\u4e91\u539f\u751f\u5e94\u7528\uff0c\u91c7\u7528kubernetes\u6784\u5efa\u5fae\u670d\u52a1\u90e8\u7f72\u548c\u96c6\u7fa4\u7ba1\u7406\u80fd\u529b\uff0c\u91c7\u7528Istio\u6784\u5efa\u670d\u52a1\u6cbb\u7406\u80fd\u529b\uff0c\u5c06\u9010\u6e10\u6210\u4e3a\u5e94\u7528\u5fae\u670d\u52a1\u8f6c\u578b\u7684\u6807\u51c6\u914d\u7f6e\u3002 4-2 \u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e\u7ba1\u7406: Istio+K8S (Internal) Envoy 1. \u6cbb\u7406\u548c\u4e1a\u52a1 : Sidecar \u81ea\u52a8\u6ce8\u5165\uff0c\u81ea\u52a8\u63a5\u7ba1\u6d41\u91cf \uff0c\u5b9e\u73b0\u6cbb\u7406\u903b\u8f91\uff0c\u4e14\u4e0e\u4e1a\u52a1\u8fdb\u7a0b\u5206\u79bb\u3002 2. \u6cbb\u7406\u5347\u7ea7 : \u6cbb\u7406\u80fd\u529b\u5347\u7ea7\u4e0d\u5f71\u54cd\u4e1a\u52a1\u3002\u53ea\u9700\u5347\u7ea7 Istio \u7ba1\u7406\u9762\u548c Envoy \u3002 \u4e1a\u52a1\u4ee3\u7801\u65e0\u611f\u77e5 Istio \u4e00\u81f4\u670d\u52a1\u53d1\u73b0 : \u7edf \u4e00\u670d\u52a1\u53d1\u73b0 \u57fa\u4e8eK8S \u6570\u636e\u505a\u670d\u52a1\u53d1\u73b0 Kube-APIServer \u6cbb\u7406\u89c4\u5219 : \u6cbb\u7406\u89c4\u5219\u57fa\u4e8e K8S CRD \u5b9a\u4e49\uff0c \u65e0\u9700\u4e13\u95e8\u914d\u7f6e\u7ba1\u7406\u670d\u52a1 \u670d\u52a1\u53d1\u73b0\u65b9\u5f0f :\u65e0\u9700\u4e13\u95e8\u670d\u52a1\u6ce8\u518c \u90e8\u7f72\u6210 K8S Service \u5373\u53ef 4-3 \u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e\u7ba1\u7406: Spring Cloud+K8S Pod+Java+SDK \u6cbb\u7406\u548c\u4e1a\u52a1:\u6cbb\u7406\u903b\u8f91\u548c\u4e1a\u52a1\u4ee3\u7801\u5171\u5b58 \u6cbb\u7406\u5347\u7ea7:\u6cbb\u7406\u903b \u8f91\u5347\u7ea7\u7528\u6237\u4e1a\u52a1\u4e5f\u9700\u968f\u4e4b\u5347\u7ea7 Service Registry (Eureka) \u670d\u52a1\u6ce8\u518c:\u4e1a\u52a1\u4ee3\u7801\u4e2d\u9700\u8981\u914d\u7f6e\u6ce8\u518c\u4e2d\u5fc3\u5730\u5740\uff0c\u672c\u670d\u52a1\u7684\u63cf\u8ff0\uff0c\u542f\u52a8\u65f6\u5019\u6ce8\u518c \u6cbb\u7406\u89c4\u5219:\u6cbb\u7406\u89c4\u5219\u548c\u670d\u52a1\u6ce8\u518c\u4e00\u8d77\uff0c\u83b7\u53d6\u5355\u72ec\u7684\u914d\u7f6e\u670d\u52a1 \u670d\u52a1\u53d1\u73b0\u65b9\u5f0f:\u4e1a\u52a1\u4ee3\u7801\u4e2d\u9700\u8981\u914d\u7f6e\u6ce8 \u518c\u4e2d\u5fc3\u5730\u5740\uff0c\u83b7\u53d6\u76ee\u6807\u670d\u52a1\u5b9e\u4f8b\u4fe1\u606f","title":"\u7b2c\u4e09\u8282 Istio \u670d\u52a1\u53d1\u73b0\u548c Pilot\u7684\u67b6\u6784\u673a\u5236"},{"location":"chap3/2isba_Service_Find/#istio-pilot","text":"Istio\u67b6\u6784\u56de\u987e&Pilot\u4ecb\u7ecd Istio\u670d\u52a1\u53d1\u73b0 Istio\u670d\u52a1\u914d\u7f6e Istio\u670d\u52a1\u53d1\u73b0&\u89c4\u5219\u7ba1\u7406\u4e0eKubernetes\u7ed3\u5408 ShowCase","title":"\u7b2c\u4e09\u8282 Istio \u670d\u52a1\u53d1\u73b0\u548c Pilot\u7684\u67b6\u6784\u673a\u5236"},{"location":"chap3/2isba_Service_Find/#1istiopilot","text":"","title":"1\u3001Istio\u67b6\u6784\u56de\u987e&amp;Pilot\u4ecb\u7ecd"},{"location":"chap3/2isba_Service_Find/#1-1-istio","text":"","title":"1-1 \u4e0a\u671f\u56de\u987e:Istio\u67b6\u6784"},{"location":"chap3/2isba_Service_Find/#1-2-pilot","text":"\u670d\u52a1\u53d1\u73b0 \u670d\u52a1\u914d\u7f6e","title":"1-2 Pilot\u529f\u80fd"},{"location":"chap3/2isba_Service_Find/#2istio","text":"","title":"2\u3001Istio\u670d\u52a1\u53d1\u73b0"},{"location":"chap3/2isba_Service_Find/#2-1","text":"Service register Service discover Service provide","title":"2-1 \u670d\u52a1\u53d1\u73b0\u57fa\u672c\u539f\u7406"},{"location":"chap3/2isba_Service_Find/#2-2-springcloud","text":"\u670d\u52a1\u6ce8\u518c\u8868 : \u5982 Springcloud \u4e2d\u4e00\u822c Eureka \u670d\u52a1; \u670d\u52a1\u6ce8\u518c : \u670d\u52a1\u914d\u7f6e\u6587\u4ef6\u4e2d\u914d\u7f6e\u670d\u52a1\u540d\u548c\u672c\u5b9e\u4f8b\u5730\u5740 \uff0c\u5b9e\u4f8b\u542f\u52a8\u65f6\u81ea\u52a8\u6ce8\u518c\u5230\u670d\u52a1\u6ce8\u518c\u8868; \u670d\u52a1\u53d1\u73b0 : \u8bbf\u95ee\u76ee\u6807\u670d\u52a1\u65f6\u8fde\u670d\u52a1\u6ce8\u518c\u8868 \uff0c\u83b7\u53d6\u670d\u52a1\u5b9e\u4f8b\u5217\u8868\u3002\u6839\u636e LB \u6839\u636e\u7b56\u7565\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\uff0c\u5efa\u7acb\u8fde\u63a5\u53bb\u8bbf\u95ee\u3002 Eureka Server - Register Service list Load Balancer - Find Service Eureka Client - Service return","title":"2-2 SpringCloud\u7684\u670d\u52a1(\u5916\u90e8\uff09\u6ce8\u518c\u4e0e\u53d1\u73b0\u6d41\u7a0b"},{"location":"chap3/2isba_Service_Find/#2-3-istio","text":"\u670d\u52a1\u6ce8\u518c\u8868: Pilot \u4ece\u5e73\u53f0\u83b7\u53d6\u670d\u52a1\u53d1\u73b0\u6570\u636e\uff0c\u5e76\u63d0\u4f9b\u7edf\u4e00\u7684\u670d\u52a1\u53d1\u73b0\u63a5\u53e3\u3002 \u670d\u52a1\u6ce8\u518c: \u65e0 \u670d\u52a1\u53d1\u73b0: Envoy \u5b9e\u73b0\u670d\u52a1\u53d1\u73b0 \uff0c\u52a8\u6001\u66f4\u65b0\u8d1f\u8f7d\u5747\u8861\u6c60\u3002 \u5728\u670d\u52a1\u8bf7\u6c42\u65f6\u4f7f\u7528\u5bf9\u5e94\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u5bf9\u5e94\u7684\u540e\u7aef\u3002 Pilot -> Service registration by the platform Enovy -> Service discovery by Envoys","title":"2-3 Istio\u670d\u52a1\u53d1\u73b0\u6d41\u7a0b\uff08\u5185\u90e8\uff09"},{"location":"chap3/2isba_Service_Find/#2-4-pilotadapter","text":"","title":"2-4 Pilot\u670d\u52a1\u53d1\u73b0\u673a\u5236\u7684Adapter\u673a\u5236"},{"location":"chap3/2isba_Service_Find/#abstract-model","text":"Services Services Instances Services Versions","title":"Abstract Model"},{"location":"chap3/2isba_Service_Find/#2-5-istio-eureka","text":"Pilot \u5b9e\u73b0 \u82e5\u5e72\u670d\u52a1\u53d1\u73b0\u7684\u63a5\u53e3\u5b9a\u4e49 Controller \u4f7f\u7528 EurekaClient \u6765\u83b7\u53d6\u670d\u52a1\u5217\u8868\uff0c\u63d0\u4f9b\u8f6c\u6362\u540e\u7684\u6807\u51c6\u7684\u670d\u52a1\u53d1\u73b0\u63a5\u53e3\u548c\u6570\u636e\u7ed3\u6784; Discoveryserver \u57fa\u4e8e Controller \u4e0a\u7ef4\u62a4\u7684\u670d\u52a1\u53d1\u73b0\u6570\u636e\uff0c\u53d1\u5e03\u6210 gRPC \u534f\u8bae\u7684\u670d\u52a1\u4f9b Envoy \u4f7f\u7528\u3002 \u5f53\u6709\u670d\u52a1\u8bbf\u95ee\u65f6\uff0c Envoy \u5728\u5904\u7406 Outbound \u8bf7\u6c42\u65f6\uff0c\u6839\u636e\u914d\u7f6e\u7684 LB \u7b56\u7565\uff0c\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u53d1\u8d77\u8bbf\u95ee public interface ServiceInstance { String getServiceId(); String getHost(); int getPort(); boolean isSecure(); URI getUri(); Map<String, String> getMetadata(); }","title":"2-5 Istio\u670d\u52a1\u53d1\u73b0\u5b9e\u73b0: \u57fa\u4e8e Eureka"},{"location":"chap3/2isba_Service_Find/#2-6-istio-kubernetes","text":"Pilot \u5b9e\u73b0\u82e5\u5e72\u670d\u52a1\u53d1\u73b0\u7684\u63a5\u53e3\u5b9a\u4e49 Pilot \u7684 Controller List/Watch KubeAPIserver \u4e0a service \u3001 endpoint \u7b49\u8d44\u6e90\u5bf9\u8c61\u5e76\u8f6c\u6362\u6210\u6807\u51c6\u683c\u5f0f \u3002 Envoy \u4ece Pilot \u83b7\u53d6 xDS \uff0c\u52a8\u6001\u66f4\u65b0 \u5f53\u6709\u670d\u52a1\u8bbf\u95ee\u65f6\uff0c Envoy \u5728\u5904\u7406 Outbound \u8bf7\u6c42\u65f6\uff0c\u6839\u636e\u914d\u7f6e\u7684 LB \u7b56\u7565\uff0c\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u53d1\u8d77\u8bbf\u95ee\u3002 type Service struct { // Hostname of the service, e.g. \"catalog.mystore.com\" Hostname Hostname `json:\"hostname\"` Address string `json:\"address,omitempty\"` Addresses map[string]string `json:\"addresses,omitempty\"` // Ports is the set of network ports where the service is listening for connections Ports PortList `json:\"ports,omitempty\"` ExternalName Hostname `json:\"external\"` ... }","title":"2-6 Istio \u670d\u52a1\u53d1\u73b0\u5b9e\u73b0:\u57fa\u4e8eKubernetes"},{"location":"chap3/2isba_Service_Find/#2-7-kubernetes-istio","text":"","title":"2-7 Kubernetes &amp; Istio \u670d\u52a1\u6a21\u578b"},{"location":"chap3/2isba_Service_Find/#2-8-kuberntes","text":"","title":"2-8 Kuberntes\u7684\u670d\u52a1\u53d1\u73b0"},{"location":"chap3/2isba_Service_Find/#2-9-istio-upon-kubernetes","text":"Istiio => \u670d\u52a1\u6cbb\u7406 \u2022 \u8c03\u7528\u94fe\u8ffd\u8e2a \u2022 \u52a8\u6001\u8def\u7531 \u2022 \u7194\u65ad\u9650\u6d41 kubernetes => \u670d\u52a1\u7684\u90e8\u7f72\u8fd0\u7ef4 \u2022 \u8d1f\u8f7d\u5747\u8861 \u2022 \u670d\u52a1\u53d1\u73b0 \u2022 \u6269\u7f29\u5bb9 \u2022 \u8fd0\u7ef4 \u2022 \u90e8\u7f72","title":"2-9 Istio Upon Kubernetes\u573a\u666f"},{"location":"chap3/2isba_Service_Find/#2-10-istio-upon-kubernetes","text":"POD to POD => Enovy to Enovy Envoy \u4ece Pilot \u83b7\u53d6 xDS \uff0c\u52a8\u6001\u66f4\u65b0 Pilot \u7684 Controller List/Watch KubeAPIserver \u4e0a service \u3001 endpoint \u7b49\u8d44\u6e90\u5bf9\u8c61\u5e76\u8f6c\u6362\u6210\u6807\u51c6\u683c\u5f0f","title":"2-10 Istio (upon Kubernetes)\u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e"},{"location":"chap3/2isba_Service_Find/#3istio","text":"","title":"3\u3001Istio\u670d\u52a1\u914d\u7f6e\u7ba1\u7406"},{"location":"chap3/2isba_Service_Find/#3-1-istio","text":"\u914d\u7f6e: \u7ba1\u7406\u5458\u901a\u8fc7Pilot\u914d\u7f6e\u6cbb\u7597\u89c4\u5219 \u4e0b\u53d1: Envoy\u4ecePilot\u83b7\u53d6\u6cbb\u7406\u89c4\u5219 \u6267\u884c: \u5728\u6d41\u91cf\u8bbf\u95ee\u7684\u65f6\u5019\u6267\u884c\u6cbb\u7406\u89c4\u5219","title":"3-1 Istio \u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7ef4\u62a4\u548c\u5de5\u4f5c\u673a\u5236"},{"location":"chap3/2isba_Service_Find/#3-2-istio","text":"VirtualService : Configuration affecting label/content routing, sni routing, etc. DestinationRule : Configuration affecting load balancing, outlier detection, etc. Gateway : Configuration affecting edge load balancer. ServiceEntry : Configuration affecting service registry. Sidecar : Configuration affecting network reachability of a sidecar. Envoy Filter : Configuration affecting insertion of custom Envoy filters. https://istio.io/docs/reference/config/istio.networking.v1alpha3/","title":"3-2 Istio\u6cbb\u7406\u89c4\u5219"},{"location":"chap3/2isba_Service_Find/#3-3-istio-virtualservice","text":"\u670d\u52a1\u8bbf\u95ee\u8def\u7531\u63a7\u5236 \u3002 \u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6\u7684\u8bf7\u6c42\u6d41\u5230\u54ea\u91cc\uff0c\u8fc7\u7a0b\u4e2d\u6cbb\u7406\u3002\u5305\u62ec\u8bf7\u6c42\u91cd\u5199\u3001\u91cd\u8bd5\u3001\u6545\u969c\u6ce8\u5165\u7b49\u3002 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: Foo: exact: bar fault: delay: fixedDelay: 5s abort: percent: 10 httpStatus: 400 route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v1 \u534f\u8bae\u652f\u6301: http HTTPRoute[] tls TLSRoute[] tcp TCPRoute[] HTTP\u534f\u8bae\u6d41\u91cf\u89c4\u5219: Field Type match HTTPMatchRequest[] route HTTPRouteDestination[] redirect HTTPRedirect rewrite HTTPRewrite timeout google.protobuf.Duration retries HTTPRetry fault HTTPFaultInjection mirror Destination","title":"3-3 Istio\u6d41\u91cf\u89c4\u5219: VirtualService"},{"location":"chap3/2isba_Service_Find/#3-4-istio-destinationrule","text":"\u76ee\u6807\u670d\u52a1\u7684\u7b56\u7565\uff0c\u5305\u62ec\u76ee\u6807\u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u8fde\u63a5\u6c60\u7ba1\u7406\u7b49 apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews trafficPolicy: loadBalancer: simple: RANDOM subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 trafficPolicy: loadBalancer: simple: ROUND_ROBIN - name: v3 labels: version: v3 host string trafficPolicy TrafficPolicy subsets Subset[] loadBalancer LoadBalancerSettings connectionPool ConnectionPoolSettings outlierDetection OutlierDetection tls TLSSettings portLevelSettings TrafficPolicy.PortTrafficPolicy[] name string labels map<string, string> trafficPolicy TrafficPolicy","title":"3-4 Istio\u6d41\u91cf\u89c4\u5219: DestinationRule"},{"location":"chap3/2isba_Service_Find/#3-5-istio-serviceentry-gateway","text":"","title":"3-5 Istio\u6d41\u91cf\u89c4\u5219: ServiceEntry &amp; Gateway"},{"location":"chap3/2isba_Service_Find/#serviceentry","text":"\u529f\u80fd : Mesh \u5916\u7684\u670d\u52a1\u52a0\u5165\u5230\u670d\u52a1\u53d1\u73b0\u4e2d\uff0c\u5411 Mesh \u91cc\u9762\u7684\u670d\u52a1\u4e00\u6837\u7684\u88ab\u6cbb\u7406 \u673a\u5236 : \u5c06 ServiceEntry \u63cf\u8ff0\u7684\u670d\u52a1\u52a0\u5165\u5230\u670d\u52a1\u53d1\u73b0\u4e2d;\u5bf9\u8fd9\u4e9b\u670d\u52a1\u7684 outbound \u6d41\u91cf\u8fdb\u884c\u62e6\u622a\uff0c\u8fdb\u800c\u8fdb\u884c\u6cbb\u7406","title":"ServiceEntry:"},{"location":"chap3/2isba_Service_Find/#gateway","text":"\u529f\u80fd : \u5c06 mesh \u5185\u7684\u4e00\u4e2a\u670d\u52a1\u53d1\u5e03\u6210\u53ef\u4f9b\u5916\u90e8\u8bbf\u95ee\u3002 \u673a\u5236 : \u5728\u5165\u53e3\u5904\u90e8\u7f72\u4e00\u4e2a ingress \u7684 Envoy \uff0c\u5728\u5176\u4e0a\u6267\u884c\u670d\u52a1\u6cbb\u7406\u3002","title":"Gateway:"},{"location":"chap3/2isba_Service_Find/#3-6-istio","text":"","title":"3-6 Istio\u914d\u7f6e\u89c4\u5219\u7ef4\u62a4\u548c\u4e0b\u53d1\u6d41\u7a0b"},{"location":"chap3/2isba_Service_Find/#3-7-istio-vs-envoy","text":"","title":"3-7 \u6cbb\u7406\u89c4\u5219\u5b9a\u4e49 Istio VS Envoy"},{"location":"chap3/2isba_Service_Find/#istio","text":"","title":"Istio \u89c4\u5219"},{"location":"chap3/2isba_Service_Find/#3-8-envoy","text":"","title":"3-8 Envoy\u89c4\u5219"},{"location":"chap3/2isba_Service_Find/#3-9-istio","text":"","title":"3-9 Istio\u6cbb\u7406\u80fd\u529b\u6267\u884c\u4f4d\u7f6e"},{"location":"chap3/2isba_Service_Find/#4istiokubernetes","text":"","title":"4\u3001Istio\u670d\u52a1\u53d1\u73b0&amp;\u89c4\u5219\u7ba1\u7406\u4e0eKubernetes\u7ed3\u5408"},{"location":"chap3/2isba_Service_Find/#4-1-kubernetes-istio","text":"\u5bf9\u4e8e\u4e91\u539f\u751f\u5e94\u7528\uff0c\u91c7\u7528kubernetes\u6784\u5efa\u5fae\u670d\u52a1\u90e8\u7f72\u548c\u96c6\u7fa4\u7ba1\u7406\u80fd\u529b\uff0c\u91c7\u7528Istio\u6784\u5efa\u670d\u52a1\u6cbb\u7406\u80fd\u529b\uff0c\u5c06\u9010\u6e10\u6210\u4e3a\u5e94\u7528\u5fae\u670d\u52a1\u8f6c\u578b\u7684\u6807\u51c6\u914d\u7f6e\u3002","title":"4-1 Kubernetes &amp; Istio \u7ed3\u5408"},{"location":"chap3/2isba_Service_Find/#4-2-istiok8s-internal","text":"Envoy 1. \u6cbb\u7406\u548c\u4e1a\u52a1 : Sidecar \u81ea\u52a8\u6ce8\u5165\uff0c\u81ea\u52a8\u63a5\u7ba1\u6d41\u91cf \uff0c\u5b9e\u73b0\u6cbb\u7406\u903b\u8f91\uff0c\u4e14\u4e0e\u4e1a\u52a1\u8fdb\u7a0b\u5206\u79bb\u3002 2. \u6cbb\u7406\u5347\u7ea7 : \u6cbb\u7406\u80fd\u529b\u5347\u7ea7\u4e0d\u5f71\u54cd\u4e1a\u52a1\u3002\u53ea\u9700\u5347\u7ea7 Istio \u7ba1\u7406\u9762\u548c Envoy \u3002 \u4e1a\u52a1\u4ee3\u7801\u65e0\u611f\u77e5 Istio \u4e00\u81f4\u670d\u52a1\u53d1\u73b0 : \u7edf \u4e00\u670d\u52a1\u53d1\u73b0 \u57fa\u4e8eK8S \u6570\u636e\u505a\u670d\u52a1\u53d1\u73b0 Kube-APIServer \u6cbb\u7406\u89c4\u5219 : \u6cbb\u7406\u89c4\u5219\u57fa\u4e8e K8S CRD \u5b9a\u4e49\uff0c \u65e0\u9700\u4e13\u95e8\u914d\u7f6e\u7ba1\u7406\u670d\u52a1 \u670d\u52a1\u53d1\u73b0\u65b9\u5f0f :\u65e0\u9700\u4e13\u95e8\u670d\u52a1\u6ce8\u518c \u90e8\u7f72\u6210 K8S Service \u5373\u53ef","title":"4-2 \u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e\u7ba1\u7406: Istio+K8S (Internal)"},{"location":"chap3/2isba_Service_Find/#4-3-spring-cloudk8s","text":"Pod+Java+SDK \u6cbb\u7406\u548c\u4e1a\u52a1:\u6cbb\u7406\u903b\u8f91\u548c\u4e1a\u52a1\u4ee3\u7801\u5171\u5b58 \u6cbb\u7406\u5347\u7ea7:\u6cbb\u7406\u903b \u8f91\u5347\u7ea7\u7528\u6237\u4e1a\u52a1\u4e5f\u9700\u968f\u4e4b\u5347\u7ea7 Service Registry (Eureka) \u670d\u52a1\u6ce8\u518c:\u4e1a\u52a1\u4ee3\u7801\u4e2d\u9700\u8981\u914d\u7f6e\u6ce8\u518c\u4e2d\u5fc3\u5730\u5740\uff0c\u672c\u670d\u52a1\u7684\u63cf\u8ff0\uff0c\u542f\u52a8\u65f6\u5019\u6ce8\u518c \u6cbb\u7406\u89c4\u5219:\u6cbb\u7406\u89c4\u5219\u548c\u670d\u52a1\u6ce8\u518c\u4e00\u8d77\uff0c\u83b7\u53d6\u5355\u72ec\u7684\u914d\u7f6e\u670d\u52a1 \u670d\u52a1\u53d1\u73b0\u65b9\u5f0f:\u4e1a\u52a1\u4ee3\u7801\u4e2d\u9700\u8981\u914d\u7f6e\u6ce8 \u518c\u4e2d\u5fc3\u5730\u5740\uff0c\u83b7\u53d6\u76ee\u6807\u670d\u52a1\u5b9e\u4f8b\u4fe1\u606f","title":"4-3 \u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e\u7ba1\u7406: Spring Cloud+K8S"},{"location":"chap3/3isba_Gateway/","text":"\u7b2c\u56db\u8282 Gateway \u8bbe\u8ba1\u4e0e\u5b9e\u73b0 \u76ee\u5f55 Gateway\u7b80\u4ecb Gateway vs Kubernetes Ingress Gateway\u539f\u7406\u53ca\u5b9e\u73b0 Gateway demo\u6f14\u793a 1\u3001Gateway\u7b80\u4ecb \u5728Istio\u4e2d\uff0cGateway\u63a7\u5236\u7740\u7f51\u683c\u8fb9\u7f18\u7684\u670d\u52a1\u66b4\u9732\u3002 Ingress Gateway + Egress Gateway Gateway\u4e5f\u53ef\u4ee5\u770b\u4f5c \u7f51\u683c\u7684\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c \u63d0\u4f9b\u4ee5\u4e0b\u529f\u80fd: 1) L4-L6\u7684\u8d1f\u8f7d\u5747\u8861 2) \u5bf9\u5916\u7684 mTLS Istio \u670d\u52a1\u7f51\u683c\u4e2d\uff0c Gateway \u53ef\u4ee5\u90e8\u7f72\u4efb\u610f\u591a\u4e2a\uff0c\u53ef\u4ee5\u5171\u7528\u4e00\u4e2a\uff0c \u4e5f\u53ef\u4ee5\u6bcf\u4e2a\u79df\u6237\u3001 namespace \u5355\u72ec\u9694\u79bb\u3002 Port: number: 443 => Gateway \u76d1\u542c\u7684\u7aef\u53e3\u53ca\u534f\u8bae hosts: bookinfo.com => Gateway \u5141\u8bb8\u5916\u90e8\u8bbf\u95ee host:bookinfo.com \u7684 https \u6d41\u91cf\u8fdb\u53bb\u7f51\u683c\u5185 tls => TLS \u8bbe\u7f6e VirtualService \u5b9a\u4e49 Gateway L7 \u8def\u7531\uff0c \u4e3a\u8bbf\u95ee bookinfo.com \u7684 https \u6d41\u91cf\uff0c\u63d0\u4f9b\u8def\u7531\u5339\u914d\u8f6c\u53d1\u7b56\u7565 Gateway\u6839\u636e\u6d41\u5165\u6d41\u51fa\u65b9\u5411\u5206\u4e3a ingress gateway \u548c egress gateway Ingress gateway: \u63a7\u5236\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5185\u670d\u52a1\uff0c\u914d\u5408 VirtualService Egress gateway: \u63a7\u5236\u7f51\u683c\u5185\u670d\u52a1\u8bbf\u95ee\u5916\u90e8\u670d\u52a1, \u914d\u5408 DestinationRule ServiceEntry \u4f7f\u7528 2\u3001Gateway vs Kubernetes Ingress Kubernetes Ingress \u96c6\u7fa4\u8fb9\u7f18\u8d1f\u8f7d\u5747\u8861\uff0c \u63d0\u4f9b\u96c6\u7fa4\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u5165\u53e3\uff0c\u4ec5\u652f\u6301L7\u8d1f\u8f7d\u5747\u8861\uff0c\u529f\u80fd\u5355\u4e00 Istio 1.0 \u4ee5\u524d \u5229\u7528 Kubernetes Ingress \u5b9e\u73b0\u7f51\u683c\u5185\u670d\u52a1\u66b4\u9732\u3002 \u4f46\u662f Ingress \u65e0\u6cd5\u5b9e\u73b0\u5f88\u591a\u529f\u80fd: L4-L6 \u8d1f\u8f7d\u5747\u8861 \u5bf9\u5916 mTLS SNI \u7684\u652f\u6301 \u5176\u4ed6 istio \u4e2d\u5df2\u7ecf\u5b9e\u73b0\u7684\u5185\u90e8\u7f51\u7edc\u529f\u80fd: Fault Injection \uff0c Traffic Shifting \uff0c Circuit Breaking \uff0c Mirroring **\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u8fd9\u4e9b\u95ee\u9898\uff0cIstio\u57281.0\u7248\u672c\u8bbe\u8ba1\u4e86\u65b0\u7684 v1alpha3 API \u3002 * Gateway \u5141\u8bb8\u7ba1\u7406\u5458\u6307\u5b9a L4-L6 \u7684\u8bbe\u7f6e: \u7aef\u53e3\u53caTLS\u8bbe\u7f6e**\u3002 * \u5bf9\u4e8e ingress \u7684 L7 \u8bbe\u7f6e\uff0c Istio \u5141\u8bb8\u5c06 VirtualService \u4e0e Gateway \u7ed1\u5b9a\u8d77\u6765\u3002 * \u5206\u79bb\u7684\u597d\u5904:\u7528\u6237\u53ef\u4ee5\u50cf\u4f7f\u7528\u4f20\u7edf\u7684\u8d1f\u8f7d\u5747\u8861\u8bbe\u5907\u4e00\u6837\u7ba1\u7406\u8fdb\u5165\u7f51\u683c\u5185\u90e8\u7684\u6d41\u91cf\uff0c\u7ed1\u5b9a\u865a\u62df IP \u5230\u865a\u62df\u670d\u52a1\u5668\u4e0a \u3002\u4fbf\u4e8e\u4f20\u7edf\u6280\u672f\u7528\u6237\u65e0\u7f1d\u8fc1\u79fb\u5230\u5fae\u670d\u52a1\u3002 3\u3001Gateway\u539f\u7406\u53ca\u5b9e\u73b0 Gateway \u4e0e \u666e\u901a sidecar \u5747\u662f\u4f7f\u7528 Envoy \u4f5c\u4e3a proxy \u5b9e\u884c\u6d41\u91cf\u63a7\u5236\u3002 Pilot \u4e3a\u4e0d\u540c\u7c7b\u578b\u7684 proxy \u751f\u6210\u76f8\u5e94\u7684\u914d\u7f6e Gateway \u7684\u7c7b\u578b\u4e3a router sidecar \u7684\u7c7b\u578b\u4e3a sidecar 3-1 Ingress Gateway \u542f\u52a8\u53c2\u6570: $ kubectl -n istio-system exec -ti istio-ingrssgateway-*** sh 3-2 Sidecar\u542f\u52a8\u53c2\u6570: $ kubectl -n istio-system exec -ti istio-proxy-*** sh $ ps -efww 3-3 Pilot\u5982\u4f55\u5f97\u77e5proxy\u7c7b\u578b? Envoy \u53d1\u73b0\u670d\u52a1\u4f7f\u7528\u7684\u662f xDS \u534f\u8bae\uff0c Envoy \u5411 server \u7aef pilot \u53d1\u8d77\u8bf7\u6c42 DiscoveryRequest \u65f6\u4f1a\u643a\u5e26\u81ea\u8eab\u4fe1\u606f node \uff0c node \u6709\u4e00\u4e2a ID \u6807\u8bc6\uff0c pilot \u4f1a\u89e3\u6790 node \u6807\u8bc6\u83b7\u53d6 proxy \u7c7b\u578b\u3002 ANd Envoy \u7684\u8282\u70b9\u6807\u8bc6\u53ef\u4ee5\u901a\u8fc7\u9759\u6001\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u542f\u52a8\u53c2\u6570 --service-node \u6307\u5b9a Gateway \u5bf9\u8c61\u5728 Istio \u4e2d\u662f\u7528 CRD(CustomResourceDefinition) \u58f0\u660e\u7684\uff0c\u53ef\u901a\u8fc7 $ kubectl get crd gateways.networking.istio.io \u9a8c\u8bc1 $ kubectl get crd gateways.networking.istio.io -oyaml Istio networking \u6240\u6709\u914d\u7f6e API \u5b9a\u4e49: https://github.com/istio/api/tree/master/networking/v1alpha3 type Gateway struct { // REQUIRED: A list of server specifications. Servers []*Server `protobuf:\"bytes,1,rep,name=servers\" json:\"servers,omitempty\"` // REQUIRED: One or more labels that indicate a specific set of pods/VMs // on which this gateway configuration should be applied. // The scope of label search is platform dependent. // On Kubernetes, for example, the scope includes pods running in // all reachable namespaces. Selector map[string]string `protobuf:\"bytes,2,rep,name=selector\" json:\"selector,omitempty\" protobuf_key:\"bytes,1,opt,name=key,proto3\" protobuf_val:\"bytes,2,opt,name=value,proto3\"` } Servers []... : \u5b9a\u4e49\u865a\u62df\u670d\u52a1\u5668\u7aef\u53e3\u534f\u8bae\uff0c TLS \u8bbe\u7f6e\u7b49 Selector map[string] : \u6807\u7b7e\u5339\u914d, k8s \u4e2d\u6240\u6709 namespace \u7684 pod \u90fd\u4f1a\u8fdb\u884c\u5339\u914d type Server struct { // REQUIRED: The Port on which the proxy should listen for incoming // connections Port *Port `protobuf:\"bytes,1,opt,name=port\" json:\"port,omitempty\"` // REQUIRED. A list of hosts exposed by this gateway. At least one // host is required. While typically applicable to // HTTP services, it can also be used for TCP services using TLS with // SNI. May contain a wildcard prefix for the bottom-level component of // a domain name. For example `*.foo.com` matches `bar.foo.com` // and `*.com` matches `bar.foo.com`, `example.com`, and so on. // // **Note**: A `VirtualService` that is bound to a gateway must have one // or more hosts that match the hosts specified in a server. The match // could be an exact match or a suffix match with the server's hosts. For // example, if the server's hosts specifies \"*.example.com\", // VirtualServices with hosts dev.example.com, prod.example.com will // match. However, VirtualServices with hosts example.com or // newexample.com will not match. Hosts []string `protobuf:\"bytes,2,rep,name=hosts\" json:\"hosts,omitempty\"` // Set of TLS related options that govern the server's behavior. Use // these options to control if all http requests should be redirected to // https, and the TLS modes to use. Tls *Server_TLSOptions `protobuf:\"bytes,3,opt,name=tls\" json:\"tls,omitempty\"` } type VirtualService struct { Hosts []string `protobuf:\"bytes,1,rep,name=hosts\" json:\"hosts,omitempty\"` Gateways []string `protobuf:\"bytes,2,rep,name=gateways\" json:\"gateways,omitempty\"` // An ordered list of route rules for HTTP traffic. HTTP routes will be // applied to platform service ports named 'http-*'/'http2-*'/'grpc-*', gateway // ports with protocol HTTP/HTTP2/GRPC/ TLS-terminated-HTTPS and service // entry ports using HTTP/HTTP2/GRPC protocols. The first rule matching // an incoming request is used. Http []*HTTPRoute `protobuf:\"bytes,3,rep,name=http\" json:\"http,omitempty\"` Tls []*TLSRoute `protobuf:\"bytes,5,rep,name=tls\"json:\"tls,omitempty\"` Tcp []*TCPRoute `protobuf:\"bytes,4,rep,name=tcp\" json:\"tcp,omitempty\"` ConfigScope ConfigScope } Hosts [] : \u57df\u540d\uff0c\u6839\u636e\u5e73\u53f0\u7684\u4e0d\u901a\u53ef\u4ee5\u4e0d\u662f FQDN Gateways : Gateway\u9009\u62e9 Http [] : HTTP\u8def\u7531 Tcp [] : TCP\u8def\u7531 ConfigScope : \u89c4\u5219\u4f5c\u7528\u57df\uff0c namespaced/meshscoped // Describes match conditions and actions for routing HTTP/1.1, HTTP2, and // gRPC traffic. See VirtualService for usage examples. type HTTPRoute struct { Match []*HTTPMatchRequest `protobuf:\"bytes,1,rep,name=match\" json:\"match,omitempty\"` Route []*HTTPRouteDestination `protobuf:\"bytes,2,rep,name=route\" json:\"route,omitempty\"` Redirect *HTTPRedirect `protobuf:\"bytes,3,opt,name=redirect\" json:\"redirect,omitempty\"` Rewrite *HTTPRewrite `protobuf:\"bytes,4,opt,name=rewrite\" json:\"rewrite,omitempty\"` // Timeout for HTTP requests. Timeout *google_protobuf.Duration `protobuf:\"bytes,6,opt,name=timeout\" json:\"timeout,omitempty\"` // Retry policy for HTTP requests. Retries *HTTPRetry `protobuf:\"bytes,7,opt,name=retries\" json:\"retries,omitempty\"` Fault *HTTPFaultInjection `protobuf:\"bytes,8,opt,name=fault\" json:\"fault,omitempty\"` Mirror *Destination `protobuf:\"bytes,9,opt,name=mirror\" json:\"mirror,omitempty\"` ... } Redirect : \u8def\u7531\u89c4\u5219 3-4 Gateway\u914d\u7f6e\u4e0b\u53d1: \u9075\u5faa make-before-break \u539f\u5219\uff0c\u675c\u7edd\u89c4\u5219\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u51fa\u73b0 503 router \u7c7b\u578b\u4e0e sidecar \u7c7b\u578b\u7684 proxy \u6700\u672c\u8d28\u7684\u533a\u522b\u662f\u6ca1\u6709 inbound cluster \uff0c endpoint \uff0c listener \u8fd9\u4e5f\u4ece\u4fa7\u9762\u8bc1\u660e Gateway \u4e0d\u662f\u6d41\u91cf\u7684\u7ec8\u70b9\u53ea\u662f\u5145\u5f53\u4e00\u4e2a\u4ee3\u7406\u8f6c\u53d1\u3002 3-5 Gateway demo\u6f14\u793a \u63a7\u5236 Ingress HTTP \u6d41\u91cf \u5229\u7528 HTTPS \u4fdd\u62a4\u540e\u7aef\u670d\u52a1 mTLS \u63a7\u5236 egress \u6d41\u91cf 3-6 \u7406\u89e3\u5916\u90e8\u8bf7\u6c42\u5982\u4f55\u5230\u8fbe\u5e94\u7528 Client \u53d1\u8d77\u8bf7\u6c42\u5230\u7279\u5b9a\u7aef\u53e3 Load Balancer \u76d1\u542c\u5728\u8fd9\u4e2a\u7aef\u53e3\uff0c\u5e76\u8f6c\u53d1\u5230\u540e\u7aef \u5728 Istio \u4e2d\uff0cLB\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230 IngressGateway \u670d\u52a1 Service \u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230 IngressGateway pod Pod \u83b7\u53d6 Gateway \u548c VirtualService \u914d\u7f6e\uff0c \u83b7\u53d6\u7aef\u53e3\u3001\u534f\u8bae\u3001\u8bc1\u4e66\uff0c\u521b\u5efa\u76d1\u542c\u5668 Gateway pod \u6839\u636e\u8def\u7531\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u5e94\u7528 pod ( \u4e0d\u662f service ) 3-7 \u63a7\u5236 Ingress HTTP \u6d41\u91cf \u521b\u5efa\u5e94\u7528 $ kubectl apply -f samples/httpbin/httpbin.yaml \u521b\u5efa\u89c4\u5219 $ kubectl apply -f samples/httpbin/httpbin-gateway.yaml \u8bbf\u95ee http://139.159.236.125:31380/headers Cleanup: $ kubectl delete gateway httpbin-gateway $ kubectl delete virtualservice httpbin $ kubectl delete -f samples/httpbin/httpbin.yaml 3-8 HTTPS termination \u751f\u6210\u8bc1\u4e66 https://istio.io/docs/tasks/traffic-management/secure-ingress/#generate-client-and-server-certificates-and-keys \u521b\u5efasecret:\u540d\u79f0\u4e00\u5b9a\u662f istio-ingressgateway-certs \uff0c\u5426\u5219 mount \u4e0d\u4e0a $ kubectl create -n istio-system secret tls istio-ingressgateway-certs --key httpbin.example.com/3_application/private/httpbin.example.com.key.pem --cert httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem \u521b\u5efa\u5e94\u7528 $ kubectl apply -f samples/httpbin/httpbin.yaml \u521b\u5efa\u8def\u7531\u89c4\u5219 $ kubectl apply -f samples/httpbin/httpbin-gateway-https.yaml \u901a\u8fc7HTTPS\u8bbf\u95ee $ curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:31390:100.109.176.196 -- cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem https://httpbin.example.com:31390/status/418 3-9 mTLS \u521b\u5efa\u5305\u542b CA \u8bc1\u4e66\u7684 secret kubectl create -n istio-system secret generic istio-ingressgateway-ca-certs --from-file=httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem \u66f4\u65b0 Gateway TLS setting \u901a\u8fc7HTTPS\u8bbf\u95ee $ curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:31390:139.159.236.125 -- cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem https://httpbin.example.com:31390/status/418 curl: (35) error:14094410:SSL routines:SSL3_READ_BYTES:sslv3 alert handshake failure $ curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:31390:139.159.236.125 --cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem --cert httpbin.example.com/4_client/certs/httpbin.example.com.cert.pem --key httpbin.example.com/4_client/private/httpbin.example.com.key.pem https://httpbin.example.com:31390/status/418 Gateway\u8981\u9a8c\u8bc1\u5ba2\u6237\u7aef\u7684\u8bc1\u4e66\uff0c\u6240\u4ee5\u5fc5\u987b\u643a\u5e26\u8bc1\u4e66\u624d\u80fd\u8bbf\u95ee 3-10 Istio\u8bbf\u95ee\u5916\u90e8\u670d\u52a1 Istio\u7f51\u683c\u5185\u9ed8\u8ba4\u4e0d\u80fd\u8bbf\u95ee\u5916\u90e8\u670d\u52a1\uff0c\u5982\u679c\u9700\u8981\u8bbf\u95ee\u5916\u90e8\u670d\u52a1\u6709\u4e09\u79cd\u65b9\u5f0f: Istio\u5b89\u88c5\u65f6\u8bbe\u7f6e: --set global.proxy.includeIPRanges=\"10.0.0.1/24\" \u521b\u5efa\u5e94\u7528\u65f6\u6307\u5b9apod annotation traffic.sidecar.istio.io/includeOutboundIPRanges: \"127.0.0.1/24,10.96.0.1/24\u201c \u521b\u5efa ServiceEntry \u5141\u8bb8\u96c6\u7fa4\u5185\u8bbf\u95ee\u5916\u90e8\u670d\u52a1 http://httpbin.org:80 3-11 \u901a\u8fc7 egress gateway \u63a7\u5236\u8bbf\u95ee\u5916\u90e8\u670d\u52a1 \u8bbf\u95ee: https://edition.cnn.com/politics 1) \u521b\u5efa ServiceEntry \uff0c\u5141\u8bb8\u8bbf\u95ee edtion.cnn.com 2) \u521b\u5efa Gateway \uff0c\u6307\u5b9a egress gateway \u76d1\u542c\u7aef\u53e3 3) \u521b\u5efa VirtualService \uff0c\u6307\u5b9a \u8def\u7531\u89c4\u5219 \uff0c \u7f51\u683c\u5185\u666e\u901a\u5e94\u7528\u8bbf\u95ee edtion.cnn.com:443 \uff0c\u5168\u90e8 \u8f6c\u53d1\u5230 egress-gateway \uff0c egress-gateway \u900f\u660e\u8f6c\u53d1 4) \u521b\u5efa DestinationRule \uff0c\u6307\u5b9a subset","title":"\u7b2c\u56db\u8282 Gateway \u8bbe\u8ba1\u4e0e\u5b9e\u73b0"},{"location":"chap3/3isba_Gateway/#gateway","text":"","title":"\u7b2c\u56db\u8282 Gateway \u8bbe\u8ba1\u4e0e\u5b9e\u73b0"},{"location":"chap3/3isba_Gateway/#_1","text":"Gateway\u7b80\u4ecb Gateway vs Kubernetes Ingress Gateway\u539f\u7406\u53ca\u5b9e\u73b0 Gateway demo\u6f14\u793a","title":"\u76ee\u5f55"},{"location":"chap3/3isba_Gateway/#1gateway","text":"\u5728Istio\u4e2d\uff0cGateway\u63a7\u5236\u7740\u7f51\u683c\u8fb9\u7f18\u7684\u670d\u52a1\u66b4\u9732\u3002 Ingress Gateway + Egress Gateway Gateway\u4e5f\u53ef\u4ee5\u770b\u4f5c \u7f51\u683c\u7684\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c \u63d0\u4f9b\u4ee5\u4e0b\u529f\u80fd: 1) L4-L6\u7684\u8d1f\u8f7d\u5747\u8861 2) \u5bf9\u5916\u7684 mTLS Istio \u670d\u52a1\u7f51\u683c\u4e2d\uff0c Gateway \u53ef\u4ee5\u90e8\u7f72\u4efb\u610f\u591a\u4e2a\uff0c\u53ef\u4ee5\u5171\u7528\u4e00\u4e2a\uff0c \u4e5f\u53ef\u4ee5\u6bcf\u4e2a\u79df\u6237\u3001 namespace \u5355\u72ec\u9694\u79bb\u3002 Port: number: 443 => Gateway \u76d1\u542c\u7684\u7aef\u53e3\u53ca\u534f\u8bae hosts: bookinfo.com => Gateway \u5141\u8bb8\u5916\u90e8\u8bbf\u95ee host:bookinfo.com \u7684 https \u6d41\u91cf\u8fdb\u53bb\u7f51\u683c\u5185 tls => TLS \u8bbe\u7f6e VirtualService \u5b9a\u4e49 Gateway L7 \u8def\u7531\uff0c \u4e3a\u8bbf\u95ee bookinfo.com \u7684 https \u6d41\u91cf\uff0c\u63d0\u4f9b\u8def\u7531\u5339\u914d\u8f6c\u53d1\u7b56\u7565","title":"1\u3001Gateway\u7b80\u4ecb"},{"location":"chap3/3isba_Gateway/#gatewayingress-gatewayegress-gateway","text":"Ingress gateway: \u63a7\u5236\u5916\u90e8\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5185\u670d\u52a1\uff0c\u914d\u5408 VirtualService Egress gateway: \u63a7\u5236\u7f51\u683c\u5185\u670d\u52a1\u8bbf\u95ee\u5916\u90e8\u670d\u52a1, \u914d\u5408 DestinationRule ServiceEntry \u4f7f\u7528","title":"Gateway\u6839\u636e\u6d41\u5165\u6d41\u51fa\u65b9\u5411\u5206\u4e3aingress gateway\u548cegress gateway"},{"location":"chap3/3isba_Gateway/#2gateway-vs-kubernetes-ingress","text":"Kubernetes Ingress \u96c6\u7fa4\u8fb9\u7f18\u8d1f\u8f7d\u5747\u8861\uff0c \u63d0\u4f9b\u96c6\u7fa4\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u5165\u53e3\uff0c\u4ec5\u652f\u6301L7\u8d1f\u8f7d\u5747\u8861\uff0c\u529f\u80fd\u5355\u4e00","title":"2\u3001Gateway vs Kubernetes Ingress"},{"location":"chap3/3isba_Gateway/#istio-10","text":"\u5229\u7528 Kubernetes Ingress \u5b9e\u73b0\u7f51\u683c\u5185\u670d\u52a1\u66b4\u9732\u3002 \u4f46\u662f Ingress \u65e0\u6cd5\u5b9e\u73b0\u5f88\u591a\u529f\u80fd: L4-L6 \u8d1f\u8f7d\u5747\u8861 \u5bf9\u5916 mTLS SNI \u7684\u652f\u6301 \u5176\u4ed6 istio \u4e2d\u5df2\u7ecf\u5b9e\u73b0\u7684\u5185\u90e8\u7f51\u7edc\u529f\u80fd: Fault Injection \uff0c Traffic Shifting \uff0c Circuit Breaking \uff0c Mirroring","title":"Istio 1.0\u4ee5\u524d"},{"location":"chap3/3isba_Gateway/#istio10v1alpha3-api","text":"* Gateway \u5141\u8bb8\u7ba1\u7406\u5458\u6307\u5b9a L4-L6 \u7684\u8bbe\u7f6e: \u7aef\u53e3\u53caTLS\u8bbe\u7f6e**\u3002 * \u5bf9\u4e8e ingress \u7684 L7 \u8bbe\u7f6e\uff0c Istio \u5141\u8bb8\u5c06 VirtualService \u4e0e Gateway \u7ed1\u5b9a\u8d77\u6765\u3002 * \u5206\u79bb\u7684\u597d\u5904:\u7528\u6237\u53ef\u4ee5\u50cf\u4f7f\u7528\u4f20\u7edf\u7684\u8d1f\u8f7d\u5747\u8861\u8bbe\u5907\u4e00\u6837\u7ba1\u7406\u8fdb\u5165\u7f51\u683c\u5185\u90e8\u7684\u6d41\u91cf\uff0c\u7ed1\u5b9a\u865a\u62df IP \u5230\u865a\u62df\u670d\u52a1\u5668\u4e0a \u3002\u4fbf\u4e8e\u4f20\u7edf\u6280\u672f\u7528\u6237\u65e0\u7f1d\u8fc1\u79fb\u5230\u5fae\u670d\u52a1\u3002","title":"**\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u8fd9\u4e9b\u95ee\u9898\uff0cIstio\u57281.0\u7248\u672c\u8bbe\u8ba1\u4e86\u65b0\u7684v1alpha3 API\u3002"},{"location":"chap3/3isba_Gateway/#3gateway","text":"Gateway \u4e0e \u666e\u901a sidecar \u5747\u662f\u4f7f\u7528 Envoy \u4f5c\u4e3a proxy \u5b9e\u884c\u6d41\u91cf\u63a7\u5236\u3002 Pilot \u4e3a\u4e0d\u540c\u7c7b\u578b\u7684 proxy \u751f\u6210\u76f8\u5e94\u7684\u914d\u7f6e Gateway \u7684\u7c7b\u578b\u4e3a router sidecar \u7684\u7c7b\u578b\u4e3a sidecar","title":"3\u3001Gateway\u539f\u7406\u53ca\u5b9e\u73b0"},{"location":"chap3/3isba_Gateway/#3-1-ingress-gateway","text":"$ kubectl -n istio-system exec -ti istio-ingrssgateway-*** sh","title":"3-1 Ingress Gateway \u542f\u52a8\u53c2\u6570:"},{"location":"chap3/3isba_Gateway/#3-2-sidecar","text":"$ kubectl -n istio-system exec -ti istio-proxy-*** sh $ ps -efww","title":"3-2 Sidecar\u542f\u52a8\u53c2\u6570:"},{"location":"chap3/3isba_Gateway/#3-3-pilotproxy","text":"Envoy \u53d1\u73b0\u670d\u52a1\u4f7f\u7528\u7684\u662f xDS \u534f\u8bae\uff0c Envoy \u5411 server \u7aef pilot \u53d1\u8d77\u8bf7\u6c42 DiscoveryRequest \u65f6\u4f1a\u643a\u5e26\u81ea\u8eab\u4fe1\u606f node \uff0c node \u6709\u4e00\u4e2a ID \u6807\u8bc6\uff0c pilot \u4f1a\u89e3\u6790 node \u6807\u8bc6\u83b7\u53d6 proxy \u7c7b\u578b\u3002 ANd Envoy \u7684\u8282\u70b9\u6807\u8bc6\u53ef\u4ee5\u901a\u8fc7\u9759\u6001\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u542f\u52a8\u53c2\u6570 --service-node \u6307\u5b9a Gateway \u5bf9\u8c61\u5728 Istio \u4e2d\u662f\u7528 CRD(CustomResourceDefinition) \u58f0\u660e\u7684\uff0c\u53ef\u901a\u8fc7 $ kubectl get crd gateways.networking.istio.io \u9a8c\u8bc1 $ kubectl get crd gateways.networking.istio.io -oyaml Istio networking \u6240\u6709\u914d\u7f6e API \u5b9a\u4e49: https://github.com/istio/api/tree/master/networking/v1alpha3 type Gateway struct { // REQUIRED: A list of server specifications. Servers []*Server `protobuf:\"bytes,1,rep,name=servers\" json:\"servers,omitempty\"` // REQUIRED: One or more labels that indicate a specific set of pods/VMs // on which this gateway configuration should be applied. // The scope of label search is platform dependent. // On Kubernetes, for example, the scope includes pods running in // all reachable namespaces. Selector map[string]string `protobuf:\"bytes,2,rep,name=selector\" json:\"selector,omitempty\" protobuf_key:\"bytes,1,opt,name=key,proto3\" protobuf_val:\"bytes,2,opt,name=value,proto3\"` } Servers []... : \u5b9a\u4e49\u865a\u62df\u670d\u52a1\u5668\u7aef\u53e3\u534f\u8bae\uff0c TLS \u8bbe\u7f6e\u7b49 Selector map[string] : \u6807\u7b7e\u5339\u914d, k8s \u4e2d\u6240\u6709 namespace \u7684 pod \u90fd\u4f1a\u8fdb\u884c\u5339\u914d type Server struct { // REQUIRED: The Port on which the proxy should listen for incoming // connections Port *Port `protobuf:\"bytes,1,opt,name=port\" json:\"port,omitempty\"` // REQUIRED. A list of hosts exposed by this gateway. At least one // host is required. While typically applicable to // HTTP services, it can also be used for TCP services using TLS with // SNI. May contain a wildcard prefix for the bottom-level component of // a domain name. For example `*.foo.com` matches `bar.foo.com` // and `*.com` matches `bar.foo.com`, `example.com`, and so on. // // **Note**: A `VirtualService` that is bound to a gateway must have one // or more hosts that match the hosts specified in a server. The match // could be an exact match or a suffix match with the server's hosts. For // example, if the server's hosts specifies \"*.example.com\", // VirtualServices with hosts dev.example.com, prod.example.com will // match. However, VirtualServices with hosts example.com or // newexample.com will not match. Hosts []string `protobuf:\"bytes,2,rep,name=hosts\" json:\"hosts,omitempty\"` // Set of TLS related options that govern the server's behavior. Use // these options to control if all http requests should be redirected to // https, and the TLS modes to use. Tls *Server_TLSOptions `protobuf:\"bytes,3,opt,name=tls\" json:\"tls,omitempty\"` } type VirtualService struct { Hosts []string `protobuf:\"bytes,1,rep,name=hosts\" json:\"hosts,omitempty\"` Gateways []string `protobuf:\"bytes,2,rep,name=gateways\" json:\"gateways,omitempty\"` // An ordered list of route rules for HTTP traffic. HTTP routes will be // applied to platform service ports named 'http-*'/'http2-*'/'grpc-*', gateway // ports with protocol HTTP/HTTP2/GRPC/ TLS-terminated-HTTPS and service // entry ports using HTTP/HTTP2/GRPC protocols. The first rule matching // an incoming request is used. Http []*HTTPRoute `protobuf:\"bytes,3,rep,name=http\" json:\"http,omitempty\"` Tls []*TLSRoute `protobuf:\"bytes,5,rep,name=tls\"json:\"tls,omitempty\"` Tcp []*TCPRoute `protobuf:\"bytes,4,rep,name=tcp\" json:\"tcp,omitempty\"` ConfigScope ConfigScope } Hosts [] : \u57df\u540d\uff0c\u6839\u636e\u5e73\u53f0\u7684\u4e0d\u901a\u53ef\u4ee5\u4e0d\u662f FQDN Gateways : Gateway\u9009\u62e9 Http [] : HTTP\u8def\u7531 Tcp [] : TCP\u8def\u7531 ConfigScope : \u89c4\u5219\u4f5c\u7528\u57df\uff0c namespaced/meshscoped // Describes match conditions and actions for routing HTTP/1.1, HTTP2, and // gRPC traffic. See VirtualService for usage examples. type HTTPRoute struct { Match []*HTTPMatchRequest `protobuf:\"bytes,1,rep,name=match\" json:\"match,omitempty\"` Route []*HTTPRouteDestination `protobuf:\"bytes,2,rep,name=route\" json:\"route,omitempty\"` Redirect *HTTPRedirect `protobuf:\"bytes,3,opt,name=redirect\" json:\"redirect,omitempty\"` Rewrite *HTTPRewrite `protobuf:\"bytes,4,opt,name=rewrite\" json:\"rewrite,omitempty\"` // Timeout for HTTP requests. Timeout *google_protobuf.Duration `protobuf:\"bytes,6,opt,name=timeout\" json:\"timeout,omitempty\"` // Retry policy for HTTP requests. Retries *HTTPRetry `protobuf:\"bytes,7,opt,name=retries\" json:\"retries,omitempty\"` Fault *HTTPFaultInjection `protobuf:\"bytes,8,opt,name=fault\" json:\"fault,omitempty\"` Mirror *Destination `protobuf:\"bytes,9,opt,name=mirror\" json:\"mirror,omitempty\"` ... } Redirect : \u8def\u7531\u89c4\u5219","title":"3-3 Pilot\u5982\u4f55\u5f97\u77e5proxy\u7c7b\u578b?"},{"location":"chap3/3isba_Gateway/#3-4-gateway","text":"\u9075\u5faa make-before-break \u539f\u5219\uff0c\u675c\u7edd\u89c4\u5219\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u51fa\u73b0 503 router \u7c7b\u578b\u4e0e sidecar \u7c7b\u578b\u7684 proxy \u6700\u672c\u8d28\u7684\u533a\u522b\u662f\u6ca1\u6709 inbound cluster \uff0c endpoint \uff0c listener","title":"3-4 Gateway\u914d\u7f6e\u4e0b\u53d1:"},{"location":"chap3/3isba_Gateway/#gateway_1","text":"","title":"\u8fd9\u4e5f\u4ece\u4fa7\u9762\u8bc1\u660eGateway\u4e0d\u662f\u6d41\u91cf\u7684\u7ec8\u70b9\u53ea\u662f\u5145\u5f53\u4e00\u4e2a\u4ee3\u7406\u8f6c\u53d1\u3002"},{"location":"chap3/3isba_Gateway/#3-5-gateway-demo","text":"\u63a7\u5236 Ingress HTTP \u6d41\u91cf \u5229\u7528 HTTPS \u4fdd\u62a4\u540e\u7aef\u670d\u52a1 mTLS \u63a7\u5236 egress \u6d41\u91cf","title":"3-5 Gateway demo\u6f14\u793a"},{"location":"chap3/3isba_Gateway/#3-6","text":"Client \u53d1\u8d77\u8bf7\u6c42\u5230\u7279\u5b9a\u7aef\u53e3 Load Balancer \u76d1\u542c\u5728\u8fd9\u4e2a\u7aef\u53e3\uff0c\u5e76\u8f6c\u53d1\u5230\u540e\u7aef \u5728 Istio \u4e2d\uff0cLB\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230 IngressGateway \u670d\u52a1 Service \u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230 IngressGateway pod Pod \u83b7\u53d6 Gateway \u548c VirtualService \u914d\u7f6e\uff0c \u83b7\u53d6\u7aef\u53e3\u3001\u534f\u8bae\u3001\u8bc1\u4e66\uff0c\u521b\u5efa\u76d1\u542c\u5668 Gateway pod \u6839\u636e\u8def\u7531\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u5e94\u7528 pod ( \u4e0d\u662f service )","title":"3-6 \u7406\u89e3\u5916\u90e8\u8bf7\u6c42\u5982\u4f55\u5230\u8fbe\u5e94\u7528"},{"location":"chap3/3isba_Gateway/#3-7-ingress-http","text":"","title":"3-7 \u63a7\u5236Ingress HTTP\u6d41\u91cf"},{"location":"chap3/3isba_Gateway/#_2","text":"$ kubectl apply -f samples/httpbin/httpbin.yaml","title":"\u521b\u5efa\u5e94\u7528"},{"location":"chap3/3isba_Gateway/#_3","text":"$ kubectl apply -f samples/httpbin/httpbin-gateway.yaml \u8bbf\u95ee http://139.159.236.125:31380/headers","title":"\u521b\u5efa\u89c4\u5219"},{"location":"chap3/3isba_Gateway/#cleanup","text":"$ kubectl delete gateway httpbin-gateway $ kubectl delete virtualservice httpbin $ kubectl delete -f samples/httpbin/httpbin.yaml","title":"Cleanup:"},{"location":"chap3/3isba_Gateway/#3-8-https-termination","text":"","title":"3-8 HTTPS termination"},{"location":"chap3/3isba_Gateway/#_4","text":"https://istio.io/docs/tasks/traffic-management/secure-ingress/#generate-client-and-server-certificates-and-keys","title":"\u751f\u6210\u8bc1\u4e66"},{"location":"chap3/3isba_Gateway/#secretistio-ingressgateway-certsmount","text":"$ kubectl create -n istio-system secret tls istio-ingressgateway-certs --key httpbin.example.com/3_application/private/httpbin.example.com.key.pem --cert httpbin.example.com/3_application/certs/httpbin.example.com.cert.pem","title":"\u521b\u5efasecret:\u540d\u79f0\u4e00\u5b9a\u662fistio-ingressgateway-certs\uff0c\u5426\u5219mount\u4e0d\u4e0a"},{"location":"chap3/3isba_Gateway/#_5","text":"$ kubectl apply -f samples/httpbin/httpbin.yaml","title":"\u521b\u5efa\u5e94\u7528"},{"location":"chap3/3isba_Gateway/#_6","text":"$ kubectl apply -f samples/httpbin/httpbin-gateway-https.yaml","title":"\u521b\u5efa\u8def\u7531\u89c4\u5219"},{"location":"chap3/3isba_Gateway/#https","text":"$ curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:31390:100.109.176.196 -- cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem https://httpbin.example.com:31390/status/418","title":"\u901a\u8fc7HTTPS\u8bbf\u95ee"},{"location":"chap3/3isba_Gateway/#3-9-mtls","text":"","title":"3-9 mTLS"},{"location":"chap3/3isba_Gateway/#casecret","text":"kubectl create -n istio-system secret generic istio-ingressgateway-ca-certs --from-file=httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem","title":"\u521b\u5efa\u5305\u542bCA\u8bc1\u4e66\u7684secret"},{"location":"chap3/3isba_Gateway/#gateway-tls-setting","text":"","title":"\u66f4\u65b0Gateway TLS setting"},{"location":"chap3/3isba_Gateway/#https_1","text":"$ curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:31390:139.159.236.125 -- cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem https://httpbin.example.com:31390/status/418 curl: (35) error:14094410:SSL routines:SSL3_READ_BYTES:sslv3 alert handshake failure $ curl -v -HHost:httpbin.example.com --resolve httpbin.example.com:31390:139.159.236.125 --cacert httpbin.example.com/2_intermediate/certs/ca-chain.cert.pem --cert httpbin.example.com/4_client/certs/httpbin.example.com.cert.pem --key httpbin.example.com/4_client/private/httpbin.example.com.key.pem https://httpbin.example.com:31390/status/418 Gateway\u8981\u9a8c\u8bc1\u5ba2\u6237\u7aef\u7684\u8bc1\u4e66\uff0c\u6240\u4ee5\u5fc5\u987b\u643a\u5e26\u8bc1\u4e66\u624d\u80fd\u8bbf\u95ee","title":"\u901a\u8fc7HTTPS\u8bbf\u95ee"},{"location":"chap3/3isba_Gateway/#3-10-istio","text":"Istio\u7f51\u683c\u5185\u9ed8\u8ba4\u4e0d\u80fd\u8bbf\u95ee\u5916\u90e8\u670d\u52a1\uff0c\u5982\u679c\u9700\u8981\u8bbf\u95ee\u5916\u90e8\u670d\u52a1\u6709\u4e09\u79cd\u65b9\u5f0f:","title":"3-10 Istio\u8bbf\u95ee\u5916\u90e8\u670d\u52a1"},{"location":"chap3/3isba_Gateway/#istio","text":"--set global.proxy.includeIPRanges=\"10.0.0.1/24\"","title":"Istio\u5b89\u88c5\u65f6\u8bbe\u7f6e:"},{"location":"chap3/3isba_Gateway/#pod-annotation","text":"traffic.sidecar.istio.io/includeOutboundIPRanges: \"127.0.0.1/24,10.96.0.1/24\u201c","title":"\u521b\u5efa\u5e94\u7528\u65f6\u6307\u5b9apod annotation"},{"location":"chap3/3isba_Gateway/#serviceentry","text":"\u5141\u8bb8\u96c6\u7fa4\u5185\u8bbf\u95ee\u5916\u90e8\u670d\u52a1 http://httpbin.org:80","title":"\u521b\u5efaServiceEntry"},{"location":"chap3/3isba_Gateway/#3-11-egress-gateway","text":"\u8bbf\u95ee: https://edition.cnn.com/politics 1) \u521b\u5efa ServiceEntry \uff0c\u5141\u8bb8\u8bbf\u95ee edtion.cnn.com 2) \u521b\u5efa Gateway \uff0c\u6307\u5b9a egress gateway \u76d1\u542c\u7aef\u53e3 3) \u521b\u5efa VirtualService \uff0c\u6307\u5b9a \u8def\u7531\u89c4\u5219 \uff0c \u7f51\u683c\u5185\u666e\u901a\u5e94\u7528\u8bbf\u95ee edtion.cnn.com:443 \uff0c\u5168\u90e8 \u8f6c\u53d1\u5230 egress-gateway \uff0c egress-gateway \u900f\u660e\u8f6c\u53d1 4) \u521b\u5efa DestinationRule \uff0c\u6307\u5b9a subset","title":"3-11 \u901a\u8fc7egress gateway\u63a7\u5236\u8bbf\u95ee\u5916\u90e8\u670d\u52a1"},{"location":"chap3/4isba_Gray_release/","text":"\u7b2c\u4e94\u8282 Istio \u7070\u5ea6\u53d1\u5e03\u4e0e\u6280\u672f\u5b9e\u73b0 \u5927\u7eb2 \u5178\u578b\u53d1\u5e03\u7c7b\u578b\u5bf9\u6bd4 Istio\u6d41\u91cf\u6cbb\u7406\u6280\u672f\u89e3\u6790 \u667a\u80fd\u7070\u5ea6\u53d1\u5e03\u4ecb\u7ecd \u7070\u5ea6\u53d1\u5e03\u529f\u80fd\u5c55\u793aDemo 1\u3001\u53d1\u5e03\u7c7b\u578b \u84dd\u7eff\u53d1\u5e03 \u7070\u5ea6\u53d1\u5e03(\u91d1\u4e1d\u96c0\u53d1\u5e03) A/B Test 1-1 \u84dd\u7eff\u53d1\u5e03 Green * 3 => ELB Blue * 3 CREATED Blue * 3 => ELB Green * 3 Deleted 1-2 \u91d1\u4e1d\u96c0\u53d1\u5e03 Green * 3 * 100% => ELB Blue * 3 CREATED Green * 3 * 90% + Blue * 3 * 10% => ELB Blue * 3 * 100% => ELB 1-3 A/B Test V1 * 3 + V2 * 3 => ELB \u914d\u7f6e\u7b56\u7565 \u76d1\u63a7\u6307\u6807 \u5206\u6790\u6570\u636e \u4f5c\u51fa\u51b3\u7b56 \u6267\u884c\u51b3\u7b56 A/B Test \u4e3b\u8981\u5bf9\u7279\u5b9a\u7528\u6237\u91c7\u6837\u540e\uff0c\u5bf9\u6536\u96c6\u5230\u7684\u53cd\u9988\u6570\u636e\u505a\u76f8\u5173\u5bf9\u6bd4\uff0c\u7136\u540e\u6839\u636e\u6bd4\u5bf9\u7ed3\u679c\u4f5c\u51fa\u51b3\u7b56\u3002 \u7528\u6765\u6d4b\u8bd5\u5e94\u7528\u529f\u80fd\u8868\u73b0\u7684\u65b9\u6cd5\uff0c\u4fa7\u91cd\u5e94\u7528\u7684 \u53ef\u7528\u6027\uff0c\u53d7\u6b22\u8fce\u7a0b\u5ea6 \u7b49\u3002 2\u3001Istio \u6d41\u91cf\u7ba1\u7406 2-1 \u914d\u7f6e\u89c4\u5219 \ud83d\udc4d VirtualService \u5728 Istio \u670d\u52a1\u7f51\u683c\u4e2d \u5b9a\u4e49\u8def\u7531\u89c4\u5219 \uff0c \u63a7\u5236\u8def\u7531\u5982\u4f55\u8def\u7531\u5230\u670d\u52a1\u4e0a \u3002 DestinationRule \u662f VirtualService \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6 \u3002 ServiceEntry \u662f\u901a\u5e38\u7528\u4e8e\u5728 Istio \u670d\u52a1\u7f51\u683c\u4e4b\u5916\u542f\u7528\u5bf9\u670d\u52a1\u7684\u8bf7\u6c42 \u3002 Gateway \u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c\u6700\u5e38\u89c1\u7684\u662f\u5728 \u7f51\u683c\u7684\u8fb9\u7f18\u7684\u64cd\u4f5c \uff0c\u4ee5 \u542f\u7528\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\u6d41\u91cf \u3002 2-2 DestinationRule apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: bookinfo-ratings spec: host: ratings.prod.svc.cluster.local trafficPolicy: loadBalancer: simple: RANDOM subsets: - name: v3 labels: version: v3 trafficPolicy: loadBalancer: simple: ROUND_ROBIN DestinationRule \u6240\u5b9a\u4e49\u7684\u7b56\u7565\uff0c \u51b3\u5b9a\u4e86\u7ecf\u8fc7\u8def\u7531\u5904\u7406\u4e4b\u540e\u7684\u6d41\u91cf\u7684\u8bbf\u95ee\u7b56\u7565 \u3002 host \u2014\u2014 \u76ee\u6807\u670d\u52a1\u7684\u540d\u79f0 trafficPolicy \u2014\u2014 \u6d41\u91cf\u7b56\u7565(\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u3001\u8fde\u63a5\u6c60\u914d\u7f6e\u548c\u7194\u65ad\u914d\u7f6e) \u3002 subsets \u2014\u2014 \u4e00\u4e2a\u6216\u591a\u4e2a\u670d\u52a1\u7248\u672c 2-3 Virtualservice apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: myapp-route spec: gateways: - mesh hosts: - myapp http: - match: - port: 3711 route: - destination: host: myapp port: number: 8080 subset: v1 tcp: - match: - port: 3721 route: - destination: host: myapp port: number: 8009 VirtualService \u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217\u9488\u5bf9 \u6307\u5b9a\u670d\u52a1\u7684\u6d41\u91cf\u8def\u7531\u89c4\u5219 \u3002 hosts \u2014\u2014 \u6d41\u91cf\u7684\u76ee\u6807\u4e3b\u673a gateways \u2014\u2014 Gateway\u540d\u79f0\u5217\u8868 http \u2014\u2014 HTTP \u6d41\u91cf\u89c4\u5219( HTTPRoute )\u7684\u5217\u8868 tcp \u2014\u2014 tcp \u6d41\u91cf\u89c4\u5219( TCPRoute )\u7684\u5217\u8868 tls \u2014\u2014 tls \u548c https (TLSRoute)\u6d41\u91cf\u89c4\u5219\u7684\u5217\u8868 HTTPRoute HttpMatchRequest(uri,headers,port,method......) DestinationWeight(destination\uff0cweight) Redirect Rewrite Timeout Retries ...... TCPRoute L4MatchAttributes(destinationSubnets,port......) DestinationWeight(destination\uff0cweight) 2-4 \u57fa\u4e8e\u6743\u91cd\u7684\u8def\u7531 apiVersion: ... kind: VirtualService metadata: name: vs-svcb spec: hosts: - svcb http: route: - destination: name: v1 weight: 20 - destination: name: v2 weight: 80 2-5 \u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u8def\u7531 apiVersion: ... kind: VirtualService metadata: name: ratings-route spec: hosts: - svcb http: - match: - headers: cookie: exact: \u201cgroup=dev\u201d route: - destination: name: v1 - route: - destination: name: v2 2-6 \u590d\u6742\u7070\u5ea6\u573a\u666f\u4e0b\u7684VirtualService apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: helloworld spec: hosts: - helloworld http: - match: - headers: cookie: regex: \"^(.*?;)?(email=[^;]*@some-company-name.com)(;.*)?$\" route: - destination: host: helloworld subset: v1 weight: 50 - destination: host: helloworld subset: v2 weight: 50 - route: - destination: host: helloworld subset: v1 2-7 \u7070\u5ea6\u7248\u672c\u5b58\u5728\u5f62\u5f0f kind: Deployment metadata: name: rating-v1 spec: replicas: 2 template: metadata: labels: app: rating version: v1 spec: containers: - image: rating-v1 ... kind: Deployment metadata: name: rating-v2 spec: replicas: 3 template: metadata: labels: app: rating version: v2 spec: containers: - image: rating-v2 ... 2-8 \u7070\u5ea6\u53d1\u5e03\u6d41\u7a0b 3\u3001\u667a\u80fd\u7070\u5ea6\u53d1\u5e03 \u76ee\u6807:\u7ec6\u7c92\u5ea6\u63a7\u5236\u7684\u81ea\u52a8\u5316\u7684\u6301\u7eed\u4ea4\u4ed8 3-1 \u7279\u70b9: \u7528\u6237\u7ec6\u5206 \u6d41\u91cf\u7ba1\u7406 \u5173\u952e\u6307\u6807\u53ef\u89c2\u6d4b \u53d1\u5e03\u6d41\u7a0b\u81ea\u52a8\u5316 3-2 \u667a\u80fd\u7070\u5ea6\u53d1\u5e03 3-3 \u81ea\u9002\u5e94\u7070\u5ea6\u53d1\u5e03\u53c2\u6570 \u8d1f\u8f7d\u5065\u5eb7\u72b6\u6001 \u8bf7\u6c42\u6210\u529f\u7387 \u5e73\u5747\u8bf7\u6c42\u65f6\u5ef6 \u6d41\u91cf\u6743\u91cd\u6b65\u957f \u56de\u6eda\u95e8\u9650\u503c 3-4 \u76d1\u63a7\u6307\u6807 RED (Request) Rate - the number of requests, per second, your services are serving. (Request) Errors - the number of failed requests per second. (Request) Duration - The amount of time each request takes expressed as a time interval USE(utilization\uff0csaturation\uff0cerrors) CPUs : sockets, cores, hardware threads (virtual CPUs) Memory : capacity Network interfaces Storage devices : I/O, capacity Controllers : storage, network cards Interconnects : CPUs, memory, I/O 3-5 flagger Flagger is a Kubernetes operator that automates the promotion of canary deployments using Istio routing for traffic shifting and Prometheus metrics for canary analysis. Details about flagger 3-6 \u76f8\u5173\u94fe\u63a5 https://github.com/stefanprodan/flagger https://github.com/magneticio/vamp2setup/blob/master/BASIC_TUTORIAL.md https://github.com/intuit/wasabi","title":"\u7b2c\u4e94\u8282 Istio \u7070\u5ea6\u53d1\u5e03\u4e0e\u6280\u672f\u5b9e\u73b0"},{"location":"chap3/4isba_Gray_release/#istio","text":"","title":"\u7b2c\u4e94\u8282 Istio \u7070\u5ea6\u53d1\u5e03\u4e0e\u6280\u672f\u5b9e\u73b0"},{"location":"chap3/4isba_Gray_release/#_1","text":"\u5178\u578b\u53d1\u5e03\u7c7b\u578b\u5bf9\u6bd4 Istio\u6d41\u91cf\u6cbb\u7406\u6280\u672f\u89e3\u6790 \u667a\u80fd\u7070\u5ea6\u53d1\u5e03\u4ecb\u7ecd \u7070\u5ea6\u53d1\u5e03\u529f\u80fd\u5c55\u793aDemo","title":"\u5927\u7eb2"},{"location":"chap3/4isba_Gray_release/#1","text":"\u84dd\u7eff\u53d1\u5e03 \u7070\u5ea6\u53d1\u5e03(\u91d1\u4e1d\u96c0\u53d1\u5e03) A/B Test","title":"1\u3001\u53d1\u5e03\u7c7b\u578b"},{"location":"chap3/4isba_Gray_release/#1-1","text":"Green * 3 => ELB Blue * 3 CREATED Blue * 3 => ELB Green * 3 Deleted","title":"1-1 \u84dd\u7eff\u53d1\u5e03"},{"location":"chap3/4isba_Gray_release/#1-2","text":"Green * 3 * 100% => ELB Blue * 3 CREATED Green * 3 * 90% + Blue * 3 * 10% => ELB Blue * 3 * 100% => ELB","title":"1-2 \u91d1\u4e1d\u96c0\u53d1\u5e03"},{"location":"chap3/4isba_Gray_release/#1-3-ab-test","text":"V1 * 3 + V2 * 3 => ELB \u914d\u7f6e\u7b56\u7565 \u76d1\u63a7\u6307\u6807 \u5206\u6790\u6570\u636e \u4f5c\u51fa\u51b3\u7b56 \u6267\u884c\u51b3\u7b56 A/B Test \u4e3b\u8981\u5bf9\u7279\u5b9a\u7528\u6237\u91c7\u6837\u540e\uff0c\u5bf9\u6536\u96c6\u5230\u7684\u53cd\u9988\u6570\u636e\u505a\u76f8\u5173\u5bf9\u6bd4\uff0c\u7136\u540e\u6839\u636e\u6bd4\u5bf9\u7ed3\u679c\u4f5c\u51fa\u51b3\u7b56\u3002 \u7528\u6765\u6d4b\u8bd5\u5e94\u7528\u529f\u80fd\u8868\u73b0\u7684\u65b9\u6cd5\uff0c\u4fa7\u91cd\u5e94\u7528\u7684 \u53ef\u7528\u6027\uff0c\u53d7\u6b22\u8fce\u7a0b\u5ea6 \u7b49\u3002","title":"1-3 A/B Test"},{"location":"chap3/4isba_Gray_release/#2istio","text":"","title":"2\u3001Istio \u6d41\u91cf\u7ba1\u7406"},{"location":"chap3/4isba_Gray_release/#2-1","text":"VirtualService \u5728 Istio \u670d\u52a1\u7f51\u683c\u4e2d \u5b9a\u4e49\u8def\u7531\u89c4\u5219 \uff0c \u63a7\u5236\u8def\u7531\u5982\u4f55\u8def\u7531\u5230\u670d\u52a1\u4e0a \u3002 DestinationRule \u662f VirtualService \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6 \u3002 ServiceEntry \u662f\u901a\u5e38\u7528\u4e8e\u5728 Istio \u670d\u52a1\u7f51\u683c\u4e4b\u5916\u542f\u7528\u5bf9\u670d\u52a1\u7684\u8bf7\u6c42 \u3002 Gateway \u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c\u6700\u5e38\u89c1\u7684\u662f\u5728 \u7f51\u683c\u7684\u8fb9\u7f18\u7684\u64cd\u4f5c \uff0c\u4ee5 \u542f\u7528\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\u6d41\u91cf \u3002","title":"2-1 \u914d\u7f6e\u89c4\u5219 \ud83d\udc4d"},{"location":"chap3/4isba_Gray_release/#2-2-destinationrule","text":"apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: bookinfo-ratings spec: host: ratings.prod.svc.cluster.local trafficPolicy: loadBalancer: simple: RANDOM subsets: - name: v3 labels: version: v3 trafficPolicy: loadBalancer: simple: ROUND_ROBIN DestinationRule \u6240\u5b9a\u4e49\u7684\u7b56\u7565\uff0c \u51b3\u5b9a\u4e86\u7ecf\u8fc7\u8def\u7531\u5904\u7406\u4e4b\u540e\u7684\u6d41\u91cf\u7684\u8bbf\u95ee\u7b56\u7565 \u3002 host \u2014\u2014 \u76ee\u6807\u670d\u52a1\u7684\u540d\u79f0 trafficPolicy \u2014\u2014 \u6d41\u91cf\u7b56\u7565(\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u3001\u8fde\u63a5\u6c60\u914d\u7f6e\u548c\u7194\u65ad\u914d\u7f6e) \u3002 subsets \u2014\u2014 \u4e00\u4e2a\u6216\u591a\u4e2a\u670d\u52a1\u7248\u672c","title":"2-2 DestinationRule"},{"location":"chap3/4isba_Gray_release/#2-3-virtualservice","text":"apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: myapp-route spec: gateways: - mesh hosts: - myapp http: - match: - port: 3711 route: - destination: host: myapp port: number: 8080 subset: v1 tcp: - match: - port: 3721 route: - destination: host: myapp port: number: 8009 VirtualService \u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217\u9488\u5bf9 \u6307\u5b9a\u670d\u52a1\u7684\u6d41\u91cf\u8def\u7531\u89c4\u5219 \u3002 hosts \u2014\u2014 \u6d41\u91cf\u7684\u76ee\u6807\u4e3b\u673a gateways \u2014\u2014 Gateway\u540d\u79f0\u5217\u8868 http \u2014\u2014 HTTP \u6d41\u91cf\u89c4\u5219( HTTPRoute )\u7684\u5217\u8868 tcp \u2014\u2014 tcp \u6d41\u91cf\u89c4\u5219( TCPRoute )\u7684\u5217\u8868 tls \u2014\u2014 tls \u548c https (TLSRoute)\u6d41\u91cf\u89c4\u5219\u7684\u5217\u8868 HTTPRoute HttpMatchRequest(uri,headers,port,method......) DestinationWeight(destination\uff0cweight) Redirect Rewrite Timeout Retries ...... TCPRoute L4MatchAttributes(destinationSubnets,port......) DestinationWeight(destination\uff0cweight)","title":"2-3 Virtualservice"},{"location":"chap3/4isba_Gray_release/#2-4","text":"apiVersion: ... kind: VirtualService metadata: name: vs-svcb spec: hosts: - svcb http: route: - destination: name: v1 weight: 20 - destination: name: v2 weight: 80","title":"2-4 \u57fa\u4e8e\u6743\u91cd\u7684\u8def\u7531"},{"location":"chap3/4isba_Gray_release/#2-5","text":"apiVersion: ... kind: VirtualService metadata: name: ratings-route spec: hosts: - svcb http: - match: - headers: cookie: exact: \u201cgroup=dev\u201d route: - destination: name: v1 - route: - destination: name: v2","title":"2-5 \u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u8def\u7531"},{"location":"chap3/4isba_Gray_release/#2-6-virtualservice","text":"apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: helloworld spec: hosts: - helloworld http: - match: - headers: cookie: regex: \"^(.*?;)?(email=[^;]*@some-company-name.com)(;.*)?$\" route: - destination: host: helloworld subset: v1 weight: 50 - destination: host: helloworld subset: v2 weight: 50 - route: - destination: host: helloworld subset: v1","title":"2-6 \u590d\u6742\u7070\u5ea6\u573a\u666f\u4e0b\u7684VirtualService"},{"location":"chap3/4isba_Gray_release/#2-7","text":"kind: Deployment metadata: name: rating-v1 spec: replicas: 2 template: metadata: labels: app: rating version: v1 spec: containers: - image: rating-v1 ... kind: Deployment metadata: name: rating-v2 spec: replicas: 3 template: metadata: labels: app: rating version: v2 spec: containers: - image: rating-v2 ...","title":"2-7 \u7070\u5ea6\u7248\u672c\u5b58\u5728\u5f62\u5f0f"},{"location":"chap3/4isba_Gray_release/#2-8","text":"","title":"2-8 \u7070\u5ea6\u53d1\u5e03\u6d41\u7a0b"},{"location":"chap3/4isba_Gray_release/#3","text":"\u76ee\u6807:\u7ec6\u7c92\u5ea6\u63a7\u5236\u7684\u81ea\u52a8\u5316\u7684\u6301\u7eed\u4ea4\u4ed8","title":"3\u3001\u667a\u80fd\u7070\u5ea6\u53d1\u5e03"},{"location":"chap3/4isba_Gray_release/#3-1","text":"\u7528\u6237\u7ec6\u5206 \u6d41\u91cf\u7ba1\u7406 \u5173\u952e\u6307\u6807\u53ef\u89c2\u6d4b \u53d1\u5e03\u6d41\u7a0b\u81ea\u52a8\u5316","title":"3-1 \u7279\u70b9:"},{"location":"chap3/4isba_Gray_release/#3-2","text":"","title":"3-2 \u667a\u80fd\u7070\u5ea6\u53d1\u5e03"},{"location":"chap3/4isba_Gray_release/#3-3","text":"\u8d1f\u8f7d\u5065\u5eb7\u72b6\u6001 \u8bf7\u6c42\u6210\u529f\u7387 \u5e73\u5747\u8bf7\u6c42\u65f6\u5ef6 \u6d41\u91cf\u6743\u91cd\u6b65\u957f \u56de\u6eda\u95e8\u9650\u503c","title":"3-3 \u81ea\u9002\u5e94\u7070\u5ea6\u53d1\u5e03\u53c2\u6570"},{"location":"chap3/4isba_Gray_release/#3-4","text":"","title":"3-4 \u76d1\u63a7\u6307\u6807"},{"location":"chap3/4isba_Gray_release/#red","text":"(Request) Rate - the number of requests, per second, your services are serving. (Request) Errors - the number of failed requests per second. (Request) Duration - The amount of time each request takes expressed as a time interval","title":"RED"},{"location":"chap3/4isba_Gray_release/#useutilizationsaturationerrors","text":"CPUs : sockets, cores, hardware threads (virtual CPUs) Memory : capacity Network interfaces Storage devices : I/O, capacity Controllers : storage, network cards Interconnects : CPUs, memory, I/O","title":"USE(utilization\uff0csaturation\uff0cerrors)"},{"location":"chap3/4isba_Gray_release/#3-5-flagger","text":"Flagger is a Kubernetes operator that automates the promotion of canary deployments using Istio routing for traffic shifting and Prometheus metrics for canary analysis. Details about flagger","title":"3-5 flagger"},{"location":"chap3/4isba_Gray_release/#3-6","text":"https://github.com/stefanprodan/flagger https://github.com/magneticio/vamp2setup/blob/master/BASIC_TUTORIAL.md https://github.com/intuit/wasabi","title":"3-6 \u76f8\u5173\u94fe\u63a5"},{"location":"chap3/5isba_Xds/","text":"\u7b2c\u516d\u8282 xDS\u534f\u8bae\u89e3\u6790 \u76ee\u5f55 xDS\u57fa\u672c\u6982\u5ff5 xDS\u534f\u8bae\u5206\u6790 ADS\u7406\u89e3 xDS\u7684\u672a\u6765 Istio \u53d1\u73b0\u6a21\u578b 1\u3001xDS\u662f\u4ec0\u4e48 xDS \u662f\u4e00\u7c7b\u53d1\u73b0\u670d\u52a1\u7684\u603b\u79f0\uff0c\u5305\u542b LDS \uff0c RDS \uff0c CDS \uff0c EDS \u4ee5\u53ca SDS \u3002 Envoy \u901a\u8fc7 xDS API \u53ef\u4ee5\u52a8\u6001\u83b7\u53d6 Listener(\u76d1\u542c\u5668) \uff0c Route(\u8def\u7531) \uff0c Cluster(\u96c6\u7fa4) \uff0c Endpoint(\u96c6\u7fa4\u6210\u5458) \u4ee5\u53ca Secret(\u8bc1\u4e66) \u914d\u7f6e\u3002 1-1 LDS (listener) Listener \u53d1\u73b0\u670d\u52a1\u3002 Listener \u76d1\u542c\u5668\u63a7\u5236 Envoy \u542f\u52a8\u7aef\u53e3\u76d1\u542c (\u76ee\u524d\u53ea\u652f\u6301TCP\u534f\u8bae)\uff0c\u5e76\u914d\u7f6e L3/L4 \u5c42\u8fc7\u6ee4\u5668\uff0c\u5f53\u7f51\u7edc\u8fde\u63a5\u8fbe\u5230\u540e\uff0c\u914d\u7f6e\u597d\u7684\u7f51\u7edc\u8fc7\u6ee4\u5668\u5806\u6808\u5f00\u59cb\u5904\u7406\u540e\u7eed\u4e8b\u4ef6 \u3002 \u8fd9\u79cd\u901a\u7528\u7684\u76d1\u542c\u5668\u4f53\u7cfb\u7ed3\u6784\u7528\u4e8e\u6267\u884c\u5927\u591a\u6570\u4e0d\u540c\u7684\u4ee3\u7406\u4efb\u52a1(\u9650\u6d41\uff0c\u5ba2\u6237\u7aef\u8ba4\u8bc1\uff0cHTTP\u8fde\u63a5\u7ba1\u7406\uff0cTCP\u4ee3\u7406\u7b49)\u3002 1-2 RDS (Route) Route \u53d1\u73b0\u670d\u52a1\uff0c\u7528\u4e8e HTTP \u8fde\u63a5\u7ba1\u7406\u8fc7\u6ee4\u5668\u52a8\u6001\u83b7\u53d6\u8def\u7531\u914d\u7f6e\u3002 \u8def\u7531\u914d\u7f6e\u5305\u542b HTTP \u5934\u90e8\u4fee\u6539(\u589e\u52a0\u3001\u5220\u9664HTTP\u5934\u90e8\u952e\u503c)\uff0c virtual hosts\u00b7 (\u865a\u62df\u4e3b\u673a)\uff0c\u4ee5\u53ca virtual hosts` \u5b9a\u4e49\u7684\u5404\u4e2a\u8def\u7531\u6761\u76ee\u3002 1-3 CDS (cluster) Cluster \u53d1\u73b0\u670d\u52a1\uff0c\u7528\u4e8e\u52a8\u6001\u83b7\u53d6 Cluster \u4fe1\u606f\u3002 Envoy cluster \u7ba1\u7406\u5668\u7ba1\u7406\u7740\u6240\u6709\u7684\u4e0a\u6e38 cluster \u3002 \u9274\u4e8e\u4e0a\u6e38 cluster \u6216\u8005\u4e3b\u673a\u53ef\u7528\u4e8e\u4efb\u4f55\u4ee3\u7406\u8f6c\u53d1\u4efb\u52a1\uff0c\u6240\u4ee5\u4e0a\u6e38 cluster \u4e00\u822c\u4ece Listener \u6216 Route \u4e2d\u62bd\u8c61\u51fa\u6765\u3002 1-4 EDS (Endpoint) Endpoint \u53d1\u73b0\u670d\u52a1\u3002 \u5728 Envoy \u672f\u8bed\u4e2d\uff0c Cluster \u6210\u5458\u5c31\u53eb Endpoint \uff0c\u5bf9\u4e8e\u6bcf\u4e2a Cluster \uff0c Envoy \u901a\u8fc7 EDS API \u52a8\u6001\u83b7\u53d6 Endpoint \u3002 EDS \u4f5c\u4e3a\u9996\u9009\u7684\u670d\u52a1\u53d1\u73b0\u7684\u539f\u56e0\u6709\u4e24\u70b9: \u4e0e\u901a\u8fc7 DNS \u89e3\u6790\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u8def\u7531\u76f8\u6bd4\uff0c Envoy \u80fd\u660e\u786e\u7684\u77e5\u9053\u6bcf\u4e2a\u4e0a\u6e38\u4e3b\u673a\u7684\u4fe1\u606f\uff0c\u56e0\u800c\u53ef\u4ee5\u505a\u51fa\u66f4\u52a0\u667a\u80fd\u7684\u8d1f\u8f7d \u5747\u8861\u51b3\u7b56\u3002 Endpoint \u914d\u7f6e\u5305\u542b\u8d1f\u8f7d\u5747\u8861\u6743\u91cd\u3001\u53ef\u7528\u57df\u7b49\u9644\u52a0\u4e3b\u673a\u5c5e\u6027\uff0c \u8fd9\u4e9b\u5c5e\u6027\u53ef\u7528\u57df\u670d\u52a1\u7f51\u683c\u8d1f\u8f7d\u5747\u8861\uff0c\u7edf\u8ba1\u6536\u96c6\u7b49\u8fc7\u7a0b\u4e2d 1-5 SDS (Secret) Secret \u53d1\u73b0\u670d\u52a1\uff0c\u7528\u4e8e\u8fd0\u884c\u65f6\u52a8\u6001\u83b7\u53d6 TLS \u8bc1\u4e66\u3002 \u82e5\u6ca1\u6709 SDS \u7279\u6027\uff0c\u5728 k8s \u73af\u5883\u4e2d\uff0c\u5fc5\u987b\u521b\u5efa\u5305\u542b\u8bc1\u4e66\u7684 Secret \uff0c\u4ee3\u7406\u542f\u52a8\u524d Secret \u5fc5\u987b\u6302\u8f7d\u5230 sidecar \u5bb9\u5668\u4e2d\uff0c\u5982\u679c\u8bc1\u4e66\u8fc7\u671f\uff0c\u5219\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u3002 \u4f7f\u7528 SDS \uff0c\u96c6\u4e2d\u5f0f\u7684 SDS \u670d\u52a1\u5668\u5c06\u8bc1\u4e66\u5206\u53d1\u7ed9\u6240\u6709\u7684 Envoy \u5b9e\u4f8b\uff0c\u5982\u679c\u8bc1\u4e66\u8fc7\u671f\uff0c\u670d\u52a1\u5668\u4f1a\u5c06\u65b0\u7684\u8bc1\u4e66\u5206\u53d1\uff0c Envoy \u63a5\u6536\u5230\u65b0\u7684\u8bc1\u4e66\u540e\u91cd\u65b0\u52a0\u8f7d\u513f\u4e0d\u7528\u91cd\u65b0\u90e8\u7f72\u3002 1-6 \u6807\u51c6xDS\u6d41\u7a0b 2\u3001xDS\u534f\u8bae xDS \u534f\u8bae\u662f Envoy \u83b7\u53d6\u914d\u7f6e\u4fe1\u606f\u7684\u4f20\u8f93\u534f\u8bae \uff0c \u4e5f\u662f Istio \u4e0e Envoy \u8fde\u63a5\u7684\u6865\u6881\u3002 Envoy \u52a8\u6001\u7684\u53d1\u73b0\u670d\u52a1\u4ee5\u53ca\u76f8\u5173\u8d44\u6e90\u7684 API \u5c31\u662f\u6307 xDS \u3002 xDS \u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u627f\u8f7d: gRPC (new)\u3001 REST \uff0c \u8fd9\u4e24\u79cd\u65b9\u5f0f\u90fd\u662f\u901a\u8fc7 xDS-API \u53d1\u9001 DiscoveryRequest \u8bf7\u6c42\uff0c\u7136\u540e\u8d44\u6e90\u901a\u8fc7 DiscoveryResponse \u4e0b\u53d1 \u3002 2-1 DiscoveryRequest 2-2 DiscoveryResponse 3\u3001What is ADS ADS \u662f\u4e00\u79cd xDS \u7684\u5b9e\u73b0, \u5b83\u57fa\u4e8e gRPC \u957f\u8fde\u63a5\u3002 gRPC \u7684\u5b9e\u73b0\u662f\u627f\u8f7d\u5728 HTTP/2 \u4e4b\u4e0a\u3002 3-1 Why ADS Istio 0.8\u4ee5\u524d\uff0cPilot\u63d0\u4f9b\u7684\u7684\u5355\u4e00\u8d44\u6e90\u7684DS \u6bcf\u79cd\u8d44\u6e90\u9700\u8981\u4e00\u6761\u5355\u72ec\u7684\u8fde\u63a5 Istio\u9ad8\u53ef\u7528\u73af\u5883\u4e0b\uff0c\u53ef\u80fd\u90e8\u7f72\u591a\u4e2a Pilot \u5e26\u6765\u7684\u6311\u6218: \u6ca1\u529e\u6cd5\u4fdd\u8bc1\u914d\u7f6e\u8d44\u6e90\u66f4\u65b0\u7684\u987a\u5e8f \u591a Pilot \u914d\u7f6e\u8d44\u6e90\u7684\u4e00\u81f4\u6027\u6ca1\u6cd5\u4fdd\u8bc1 \u7efc\u5408\u4ee5\u4e0a\u4e24\u4e2a\u95ee\u9898\uff0c\u5f88\u5bb9\u6613\u51fa\u73b0\u914d\u7f6e\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u7f51\u7edc\u6d41\u91cf\u4e22\u5931\u5e26\u6765\u7f51\u7edc\u9519\u8bef(\u865a\u5047\u7684\uff09 ADS\u5141\u8bb8\u901a\u8fc7\u4e00\u6761\u8fde\u63a5( gRPC \u7684\u540c\u4e00stream)\uff0c\u53d1\u9001\u591a\u79cd\u8d44\u6e90\u7684\u8bf7\u6c42\u548c\u54cd\u5e94 \u3002 \u80fd\u591f\u4fdd\u8bc1\u8bf7\u6c42\u4e00\u5b9a\u843d\u5728\u540c\u4e00 Pilot \u4e0a\uff0c\u89e3\u51b3\u591a\u4e2a\u7ba1\u7406\u670d\u52a1\u5668\u914d\u7f6e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898 \u901a\u8fc7\u987a\u5e8f\u7684\u914d\u7f6e\u5206\u53d1\uff0c\u8f7b\u677e\u89e3\u51b3\u8d44\u6e90\u66f4\u65b0\u987a\u5e8f\u7684\u95ee\u9898 3-2 ADS\u6700\u7ec8\u4e00\u81f4\u6027\u7684\u8003\u91cf xDS \u662f\u4e00\u79cd\u6700\u7ec8\u4e00\u81f4\u7684\u534f\u8bae\uff0c\u6240\u4ee5\u5728\u914d\u7f6e\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u6d41\u91cf\u4f1a\u4e22\u5931\u3002 \u4f8b\u5982, EDS \u8fd8\u6ca1\u6709\u6765\uff0c\u5982\u679c\u901a\u8fc7 CDS/EDS \u83b7\u5f97 Cluster X \uff0c \u4e00\u6761\u6307\u5411 Cluster X \u7684 RouteConfiguration \u521a\u597d\u8c03\u6574\u4e3a\u6307\u5411 Cluster Y \uff0c \u4f46\u662f\u5728 CDS/ \u53ca\u4e0b\u53d1 Cluster Y \u7684\u914d\u7f6e\u7684\u6761\u4ef6\u4e0b\uff0c\u5230 Y \u7684\u6d41\u91cf\u4f1a\u5168\u90e8\u88ab\u4e22\u5f03\uff0c\u5e76\u4e14\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u72b6\u6001\u7801 503 \u3002 \u5728\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u6d41\u91cf\u4e22\u5f03\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\u3002 Istio \u901a\u8fc7\u9075\u5faa make before break \u6a21\u578b\uff0c\u8c03\u6574\u914d\u7f6e\u66f4\u65b0\u987a\u5e8f\u53ef\u4ee5\u5b8c\u5168\u907f\u514d\u6d41\u91cf\u4e22\u5931\u3002 4\u3001xDS\u672a\u6765\u53d1\u5c55 4-1 Istio\u76ee\u524d\u662f\u5168\u91cf\u7684\u5411sidecar\u5206\u53d1\u914d\u7f6e\uff0c\u7531\u6b64\u5e26\u6765\u51e0\u4e2a\u95ee\u9898 \u914d\u7f6e\u66f4\u65b0\u9891\u7387\u9ad8\uff0c\u5927\u96c6\u7fa4\u7684\u670d\u52a1\uff0c\u5b9e\u4f8b\u6570\u76ee\u591a\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u66f4\u65b0\u540e\u4fbf\u4f1a\u89e6\u53d1\u5168\u91cf\u7684\u914d\u7f6e\u63a8\u9001\u5230\u6240\u6709\u7684 sidecar \u3002 \u5e26\u5bbd\u5360\u7528\u5927\uff0cPilot\u7aefcpu\u5229\u7528\u7387\u9ad8 Sidecar \u5360\u7528\u5185\u5b58\u591a\uff0c\u968f\u7740\u96c6\u7fa4\u89c4\u6a21\u589e\u5927\uff0c\u914d\u7f6e\u8d44\u6e90\u5448\u6307\u6570\u7ea7\u589e\u957f\uff0c\u6781\u5927\u7684\u9650\u5236\u4e86\u670d\u52a1\u7f51\u683c\u7684\u89c4\u6a21 \u9891\u7e41\u7684\u914d\u7f6e\u52a0\u8f7d\u5f71\u54cd sidecar \u6027\u80fd\u7a33\u5b9a\u6027 4-2 xDS\u672a\u6765\u53d1\u5c55 sidecar \u6309\u9700\u8bf7\u6c42\u8d44\u6e90\uff0c\u61d2\u52a0\u8f7d\u7684\u65b9\u5f0f\uff0c\u5f53\u771f\u6b63\u7684\u9700\u8981\u6d41\u91cf\u8f6c\u53d1\u7684\u65f6\u5019\uff0c \u518d\u53bb\u83b7\u53d6\u8def\u7531\u7b49\u914d\u7f6e \u5b9a\u4e49 workload \u7684\u670d\u52a1\u4f9d\u8d56\uff0c\u4f8b\u5982\u5de5\u4f5c\u8d1f\u8f7dA\u53ef\u4ee5\u8bbf\u95ee ns1/serviceB \u5b9a\u4e49\u914d\u7f6e\u89c4\u5219\u3001 Service \u7684 NetworkScope \uff0c\u4f8b\u5982\u670d\u52a1A\u53ea\u80fd\u88ab\u540c\u4e00 Namesapce \u7684 workload \u8bbf\u95ee\u3002 4-3 \u589e\u91cfxDS Incremental xDS \u662f\u4e00\u4e2a\u72ec\u7acb\u7684 xDS endpoint \uff0c\u662f\u4e00\u79cd runtime \u7684\u52a8\u6001\u914d\u7f6e\u83b7\u53d6\u65b9\u6848\uff0c\u7528\u4e8e\u589e\u91cf\u7684\u66f4\u65b0xDS\u5ba2\u6237\u7aef\u8ba2\u9605\u7684\u8d44\u6e90\uff0c\u9002\u7528\u4e8e ADS \uff0c CDS \u548c RDS : \u4fdd\u8bc1 Envoy \u6309\u9700/\u61d2\u8bf7\u6c42\u6240\u9700\u8981\u7684\u8d44\u6e90\u3002\u4f8b\u5982\u5f53\u6d41\u91cf\u8def\u7531\u5230\u672a\u77e5\u7684 cluster \u65f6\uff0cEnvoy\u5c31\u4f1a\u8bf7\u6c42\u83b7\u53d6\u672a\u77e5\u7684cluster\u4fe1\u606f\u3002 \u652f\u6301\u5927\u89c4\u6a21\u53ef\u6269\u5c55\u7684\u76ee\u6807\u3002\u4f8b\u5982\u5728\u4e00\u4e2a\u6709 100K \u4e2a\u670d\u52a1\u5b9e\u4f8b \u96c6\u7fa4\u4e2d\uff0c\u5982\u679c\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u6709\u66f4\u65b0\uff0c\u7ba1\u7406\u670d\u52a1\u5668\u53ea\u9700\u8981\u4e0b\u53d1\u4e00\u4e2a Cluster \u7684\u4fe1\u606f\u3002 5\u3001Demo $ kubectl get svc $ istioctl pc listener *** $ istioctl pc listener *** --port=9080 $ istioctl pc endpoint ***","title":"\u7b2c\u516d\u8282 xDS\u534f\u8bae\u89e3\u6790"},{"location":"chap3/5isba_Xds/#xds","text":"","title":"\u7b2c\u516d\u8282 xDS\u534f\u8bae\u89e3\u6790"},{"location":"chap3/5isba_Xds/#_1","text":"xDS\u57fa\u672c\u6982\u5ff5 xDS\u534f\u8bae\u5206\u6790 ADS\u7406\u89e3 xDS\u7684\u672a\u6765","title":"\u76ee\u5f55"},{"location":"chap3/5isba_Xds/#istio","text":"","title":"Istio \u53d1\u73b0\u6a21\u578b"},{"location":"chap3/5isba_Xds/#1xds","text":"xDS \u662f\u4e00\u7c7b\u53d1\u73b0\u670d\u52a1\u7684\u603b\u79f0\uff0c\u5305\u542b LDS \uff0c RDS \uff0c CDS \uff0c EDS \u4ee5\u53ca SDS \u3002 Envoy \u901a\u8fc7 xDS API \u53ef\u4ee5\u52a8\u6001\u83b7\u53d6 Listener(\u76d1\u542c\u5668) \uff0c Route(\u8def\u7531) \uff0c Cluster(\u96c6\u7fa4) \uff0c Endpoint(\u96c6\u7fa4\u6210\u5458) \u4ee5\u53ca Secret(\u8bc1\u4e66) \u914d\u7f6e\u3002","title":"1\u3001xDS\u662f\u4ec0\u4e48"},{"location":"chap3/5isba_Xds/#1-1-lds-listener","text":"Listener \u53d1\u73b0\u670d\u52a1\u3002 Listener \u76d1\u542c\u5668\u63a7\u5236 Envoy \u542f\u52a8\u7aef\u53e3\u76d1\u542c (\u76ee\u524d\u53ea\u652f\u6301TCP\u534f\u8bae)\uff0c\u5e76\u914d\u7f6e L3/L4 \u5c42\u8fc7\u6ee4\u5668\uff0c\u5f53\u7f51\u7edc\u8fde\u63a5\u8fbe\u5230\u540e\uff0c\u914d\u7f6e\u597d\u7684\u7f51\u7edc\u8fc7\u6ee4\u5668\u5806\u6808\u5f00\u59cb\u5904\u7406\u540e\u7eed\u4e8b\u4ef6 \u3002 \u8fd9\u79cd\u901a\u7528\u7684\u76d1\u542c\u5668\u4f53\u7cfb\u7ed3\u6784\u7528\u4e8e\u6267\u884c\u5927\u591a\u6570\u4e0d\u540c\u7684\u4ee3\u7406\u4efb\u52a1(\u9650\u6d41\uff0c\u5ba2\u6237\u7aef\u8ba4\u8bc1\uff0cHTTP\u8fde\u63a5\u7ba1\u7406\uff0cTCP\u4ee3\u7406\u7b49)\u3002","title":"1-1 LDS (listener)"},{"location":"chap3/5isba_Xds/#1-2-rds-route","text":"Route \u53d1\u73b0\u670d\u52a1\uff0c\u7528\u4e8e HTTP \u8fde\u63a5\u7ba1\u7406\u8fc7\u6ee4\u5668\u52a8\u6001\u83b7\u53d6\u8def\u7531\u914d\u7f6e\u3002 \u8def\u7531\u914d\u7f6e\u5305\u542b HTTP \u5934\u90e8\u4fee\u6539(\u589e\u52a0\u3001\u5220\u9664HTTP\u5934\u90e8\u952e\u503c)\uff0c virtual hosts\u00b7 (\u865a\u62df\u4e3b\u673a)\uff0c\u4ee5\u53ca virtual hosts` \u5b9a\u4e49\u7684\u5404\u4e2a\u8def\u7531\u6761\u76ee\u3002","title":"1-2 RDS (Route)"},{"location":"chap3/5isba_Xds/#1-3-cds-cluster","text":"Cluster \u53d1\u73b0\u670d\u52a1\uff0c\u7528\u4e8e\u52a8\u6001\u83b7\u53d6 Cluster \u4fe1\u606f\u3002 Envoy cluster \u7ba1\u7406\u5668\u7ba1\u7406\u7740\u6240\u6709\u7684\u4e0a\u6e38 cluster \u3002 \u9274\u4e8e\u4e0a\u6e38 cluster \u6216\u8005\u4e3b\u673a\u53ef\u7528\u4e8e\u4efb\u4f55\u4ee3\u7406\u8f6c\u53d1\u4efb\u52a1\uff0c\u6240\u4ee5\u4e0a\u6e38 cluster \u4e00\u822c\u4ece Listener \u6216 Route \u4e2d\u62bd\u8c61\u51fa\u6765\u3002","title":"1-3 CDS (cluster)"},{"location":"chap3/5isba_Xds/#1-4-eds-endpoint","text":"Endpoint \u53d1\u73b0\u670d\u52a1\u3002 \u5728 Envoy \u672f\u8bed\u4e2d\uff0c Cluster \u6210\u5458\u5c31\u53eb Endpoint \uff0c\u5bf9\u4e8e\u6bcf\u4e2a Cluster \uff0c Envoy \u901a\u8fc7 EDS API \u52a8\u6001\u83b7\u53d6 Endpoint \u3002 EDS \u4f5c\u4e3a\u9996\u9009\u7684\u670d\u52a1\u53d1\u73b0\u7684\u539f\u56e0\u6709\u4e24\u70b9: \u4e0e\u901a\u8fc7 DNS \u89e3\u6790\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u8fdb\u884c\u8def\u7531\u76f8\u6bd4\uff0c Envoy \u80fd\u660e\u786e\u7684\u77e5\u9053\u6bcf\u4e2a\u4e0a\u6e38\u4e3b\u673a\u7684\u4fe1\u606f\uff0c\u56e0\u800c\u53ef\u4ee5\u505a\u51fa\u66f4\u52a0\u667a\u80fd\u7684\u8d1f\u8f7d \u5747\u8861\u51b3\u7b56\u3002 Endpoint \u914d\u7f6e\u5305\u542b\u8d1f\u8f7d\u5747\u8861\u6743\u91cd\u3001\u53ef\u7528\u57df\u7b49\u9644\u52a0\u4e3b\u673a\u5c5e\u6027\uff0c \u8fd9\u4e9b\u5c5e\u6027\u53ef\u7528\u57df\u670d\u52a1\u7f51\u683c\u8d1f\u8f7d\u5747\u8861\uff0c\u7edf\u8ba1\u6536\u96c6\u7b49\u8fc7\u7a0b\u4e2d","title":"1-4 EDS (Endpoint)"},{"location":"chap3/5isba_Xds/#1-5-sds-secret","text":"Secret \u53d1\u73b0\u670d\u52a1\uff0c\u7528\u4e8e\u8fd0\u884c\u65f6\u52a8\u6001\u83b7\u53d6 TLS \u8bc1\u4e66\u3002 \u82e5\u6ca1\u6709 SDS \u7279\u6027\uff0c\u5728 k8s \u73af\u5883\u4e2d\uff0c\u5fc5\u987b\u521b\u5efa\u5305\u542b\u8bc1\u4e66\u7684 Secret \uff0c\u4ee3\u7406\u542f\u52a8\u524d Secret \u5fc5\u987b\u6302\u8f7d\u5230 sidecar \u5bb9\u5668\u4e2d\uff0c\u5982\u679c\u8bc1\u4e66\u8fc7\u671f\uff0c\u5219\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u3002 \u4f7f\u7528 SDS \uff0c\u96c6\u4e2d\u5f0f\u7684 SDS \u670d\u52a1\u5668\u5c06\u8bc1\u4e66\u5206\u53d1\u7ed9\u6240\u6709\u7684 Envoy \u5b9e\u4f8b\uff0c\u5982\u679c\u8bc1\u4e66\u8fc7\u671f\uff0c\u670d\u52a1\u5668\u4f1a\u5c06\u65b0\u7684\u8bc1\u4e66\u5206\u53d1\uff0c Envoy \u63a5\u6536\u5230\u65b0\u7684\u8bc1\u4e66\u540e\u91cd\u65b0\u52a0\u8f7d\u513f\u4e0d\u7528\u91cd\u65b0\u90e8\u7f72\u3002","title":"1-5 SDS (Secret)"},{"location":"chap3/5isba_Xds/#1-6-xds","text":"","title":"1-6 \u6807\u51c6xDS\u6d41\u7a0b"},{"location":"chap3/5isba_Xds/#2xds","text":"xDS \u534f\u8bae\u662f Envoy \u83b7\u53d6\u914d\u7f6e\u4fe1\u606f\u7684\u4f20\u8f93\u534f\u8bae \uff0c \u4e5f\u662f Istio \u4e0e Envoy \u8fde\u63a5\u7684\u6865\u6881\u3002 Envoy \u52a8\u6001\u7684\u53d1\u73b0\u670d\u52a1\u4ee5\u53ca\u76f8\u5173\u8d44\u6e90\u7684 API \u5c31\u662f\u6307 xDS \u3002 xDS \u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u627f\u8f7d: gRPC (new)\u3001 REST \uff0c \u8fd9\u4e24\u79cd\u65b9\u5f0f\u90fd\u662f\u901a\u8fc7 xDS-API \u53d1\u9001 DiscoveryRequest \u8bf7\u6c42\uff0c\u7136\u540e\u8d44\u6e90\u901a\u8fc7 DiscoveryResponse \u4e0b\u53d1 \u3002","title":"2\u3001xDS\u534f\u8bae"},{"location":"chap3/5isba_Xds/#2-1-discoveryrequest","text":"","title":"2-1 DiscoveryRequest"},{"location":"chap3/5isba_Xds/#2-2-discoveryresponse","text":"","title":"2-2 DiscoveryResponse"},{"location":"chap3/5isba_Xds/#3what-is-ads","text":"ADS \u662f\u4e00\u79cd xDS \u7684\u5b9e\u73b0, \u5b83\u57fa\u4e8e gRPC \u957f\u8fde\u63a5\u3002 gRPC \u7684\u5b9e\u73b0\u662f\u627f\u8f7d\u5728 HTTP/2 \u4e4b\u4e0a\u3002","title":"3\u3001What is ADS"},{"location":"chap3/5isba_Xds/#3-1-why-ads","text":"Istio 0.8\u4ee5\u524d\uff0cPilot\u63d0\u4f9b\u7684\u7684\u5355\u4e00\u8d44\u6e90\u7684DS \u6bcf\u79cd\u8d44\u6e90\u9700\u8981\u4e00\u6761\u5355\u72ec\u7684\u8fde\u63a5 Istio\u9ad8\u53ef\u7528\u73af\u5883\u4e0b\uff0c\u53ef\u80fd\u90e8\u7f72\u591a\u4e2a Pilot","title":"3-1 Why ADS"},{"location":"chap3/5isba_Xds/#_2","text":"\u6ca1\u529e\u6cd5\u4fdd\u8bc1\u914d\u7f6e\u8d44\u6e90\u66f4\u65b0\u7684\u987a\u5e8f \u591a Pilot \u914d\u7f6e\u8d44\u6e90\u7684\u4e00\u81f4\u6027\u6ca1\u6cd5\u4fdd\u8bc1 \u7efc\u5408\u4ee5\u4e0a\u4e24\u4e2a\u95ee\u9898\uff0c\u5f88\u5bb9\u6613\u51fa\u73b0\u914d\u7f6e\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u7f51\u7edc\u6d41\u91cf\u4e22\u5931\u5e26\u6765\u7f51\u7edc\u9519\u8bef(\u865a\u5047\u7684\uff09","title":"\u5e26\u6765\u7684\u6311\u6218:"},{"location":"chap3/5isba_Xds/#adsgrpcstream","text":"\u80fd\u591f\u4fdd\u8bc1\u8bf7\u6c42\u4e00\u5b9a\u843d\u5728\u540c\u4e00 Pilot \u4e0a\uff0c\u89e3\u51b3\u591a\u4e2a\u7ba1\u7406\u670d\u52a1\u5668\u914d\u7f6e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898 \u901a\u8fc7\u987a\u5e8f\u7684\u914d\u7f6e\u5206\u53d1\uff0c\u8f7b\u677e\u89e3\u51b3\u8d44\u6e90\u66f4\u65b0\u987a\u5e8f\u7684\u95ee\u9898","title":"ADS\u5141\u8bb8\u901a\u8fc7\u4e00\u6761\u8fde\u63a5(gRPC\u7684\u540c\u4e00stream)\uff0c\u53d1\u9001\u591a\u79cd\u8d44\u6e90\u7684\u8bf7\u6c42\u548c\u54cd\u5e94\u3002"},{"location":"chap3/5isba_Xds/#3-2-ads","text":"xDS \u662f\u4e00\u79cd\u6700\u7ec8\u4e00\u81f4\u7684\u534f\u8bae\uff0c\u6240\u4ee5\u5728\u914d\u7f6e\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u6d41\u91cf\u4f1a\u4e22\u5931\u3002 \u4f8b\u5982, EDS \u8fd8\u6ca1\u6709\u6765\uff0c\u5982\u679c\u901a\u8fc7 CDS/EDS \u83b7\u5f97 Cluster X \uff0c \u4e00\u6761\u6307\u5411 Cluster X \u7684 RouteConfiguration \u521a\u597d\u8c03\u6574\u4e3a\u6307\u5411 Cluster Y \uff0c \u4f46\u662f\u5728 CDS/ \u53ca\u4e0b\u53d1 Cluster Y \u7684\u914d\u7f6e\u7684\u6761\u4ef6\u4e0b\uff0c\u5230 Y \u7684\u6d41\u91cf\u4f1a\u5168\u90e8\u88ab\u4e22\u5f03\uff0c\u5e76\u4e14\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u72b6\u6001\u7801 503 \u3002 \u5728\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u6d41\u91cf\u4e22\u5f03\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\u3002 Istio \u901a\u8fc7\u9075\u5faa make before break \u6a21\u578b\uff0c\u8c03\u6574\u914d\u7f6e\u66f4\u65b0\u987a\u5e8f\u53ef\u4ee5\u5b8c\u5168\u907f\u514d\u6d41\u91cf\u4e22\u5931\u3002","title":"3-2 ADS\u6700\u7ec8\u4e00\u81f4\u6027\u7684\u8003\u91cf"},{"location":"chap3/5isba_Xds/#4xds","text":"","title":"4\u3001xDS\u672a\u6765\u53d1\u5c55"},{"location":"chap3/5isba_Xds/#4-1-istiosidecar","text":"\u914d\u7f6e\u66f4\u65b0\u9891\u7387\u9ad8\uff0c\u5927\u96c6\u7fa4\u7684\u670d\u52a1\uff0c\u5b9e\u4f8b\u6570\u76ee\u591a\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u66f4\u65b0\u540e\u4fbf\u4f1a\u89e6\u53d1\u5168\u91cf\u7684\u914d\u7f6e\u63a8\u9001\u5230\u6240\u6709\u7684 sidecar \u3002 \u5e26\u5bbd\u5360\u7528\u5927\uff0cPilot\u7aefcpu\u5229\u7528\u7387\u9ad8 Sidecar \u5360\u7528\u5185\u5b58\u591a\uff0c\u968f\u7740\u96c6\u7fa4\u89c4\u6a21\u589e\u5927\uff0c\u914d\u7f6e\u8d44\u6e90\u5448\u6307\u6570\u7ea7\u589e\u957f\uff0c\u6781\u5927\u7684\u9650\u5236\u4e86\u670d\u52a1\u7f51\u683c\u7684\u89c4\u6a21 \u9891\u7e41\u7684\u914d\u7f6e\u52a0\u8f7d\u5f71\u54cd sidecar \u6027\u80fd\u7a33\u5b9a\u6027","title":"4-1 Istio\u76ee\u524d\u662f\u5168\u91cf\u7684\u5411sidecar\u5206\u53d1\u914d\u7f6e\uff0c\u7531\u6b64\u5e26\u6765\u51e0\u4e2a\u95ee\u9898"},{"location":"chap3/5isba_Xds/#4-2-xds","text":"sidecar \u6309\u9700\u8bf7\u6c42\u8d44\u6e90\uff0c\u61d2\u52a0\u8f7d\u7684\u65b9\u5f0f\uff0c\u5f53\u771f\u6b63\u7684\u9700\u8981\u6d41\u91cf\u8f6c\u53d1\u7684\u65f6\u5019\uff0c \u518d\u53bb\u83b7\u53d6\u8def\u7531\u7b49\u914d\u7f6e \u5b9a\u4e49 workload \u7684\u670d\u52a1\u4f9d\u8d56\uff0c\u4f8b\u5982\u5de5\u4f5c\u8d1f\u8f7dA\u53ef\u4ee5\u8bbf\u95ee ns1/serviceB \u5b9a\u4e49\u914d\u7f6e\u89c4\u5219\u3001 Service \u7684 NetworkScope \uff0c\u4f8b\u5982\u670d\u52a1A\u53ea\u80fd\u88ab\u540c\u4e00 Namesapce \u7684 workload \u8bbf\u95ee\u3002","title":"4-2 xDS\u672a\u6765\u53d1\u5c55"},{"location":"chap3/5isba_Xds/#4-3-xds","text":"Incremental xDS \u662f\u4e00\u4e2a\u72ec\u7acb\u7684 xDS endpoint \uff0c\u662f\u4e00\u79cd runtime \u7684\u52a8\u6001\u914d\u7f6e\u83b7\u53d6\u65b9\u6848\uff0c\u7528\u4e8e\u589e\u91cf\u7684\u66f4\u65b0xDS\u5ba2\u6237\u7aef\u8ba2\u9605\u7684\u8d44\u6e90\uff0c\u9002\u7528\u4e8e ADS \uff0c CDS \u548c RDS : \u4fdd\u8bc1 Envoy \u6309\u9700/\u61d2\u8bf7\u6c42\u6240\u9700\u8981\u7684\u8d44\u6e90\u3002\u4f8b\u5982\u5f53\u6d41\u91cf\u8def\u7531\u5230\u672a\u77e5\u7684 cluster \u65f6\uff0cEnvoy\u5c31\u4f1a\u8bf7\u6c42\u83b7\u53d6\u672a\u77e5\u7684cluster\u4fe1\u606f\u3002 \u652f\u6301\u5927\u89c4\u6a21\u53ef\u6269\u5c55\u7684\u76ee\u6807\u3002\u4f8b\u5982\u5728\u4e00\u4e2a\u6709 100K \u4e2a\u670d\u52a1\u5b9e\u4f8b \u96c6\u7fa4\u4e2d\uff0c\u5982\u679c\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u6709\u66f4\u65b0\uff0c\u7ba1\u7406\u670d\u52a1\u5668\u53ea\u9700\u8981\u4e0b\u53d1\u4e00\u4e2a Cluster \u7684\u4fe1\u606f\u3002","title":"4-3 \u589e\u91cfxDS"},{"location":"chap3/5isba_Xds/#5demo","text":"$ kubectl get svc $ istioctl pc listener *** $ istioctl pc listener *** --port=9080 $ istioctl pc endpoint ***","title":"5\u3001Demo"},{"location":"chap3/6isba_Mixer/","text":"\u7b2c\u4e03\u8282 Mixer\u57fa\u7840\u4e0e\u5b9e\u73b0 Agenda Istio\u67b6\u6784\u56de\u987e&Mixer\u4ecb\u7ecd Mixer\u7684\u529f\u80fd\u548c\u8bbe\u8ba1 Mixer\u7684\u914d\u7f6e\u6a21\u578b Mixer\u7684\u5178\u578b\u5e94\u7528 Mixer\u5b9e\u8df51\u548c2 1\u3001\u56de\u987e:Istio\u67b6\u6784 Istio Control plane API Pilot : Config data to proxies Mixer : Policy checks, telemetry Citadel : TLS certs to proxies 1-1 Istio \u5b98\u65b9\u56db\u5927\u529f\u80fd\u4e2d\u4e24\u4e2a\u57fa\u4e8e Mixer \u5b9e\u73b0 Control & Observer 1-2 Mixer\u5728Istio\u4e2d\u89d2\u8272 \u529f\u80fd\u4e0a :\u8d1f\u8d23\u7b56\u7565\u63a7\u5236\u548c\u9065\u6d4b\u6536\u96c6 \u67b6\u6784\u4e0a :\u63d0\u4f9b\u63d2\u4ef6\u6a21\u578b\uff0c\u53ef\u4ee5\u6269\u5c55\u548c\u5b9a\u5236 2\u3001Mixer\u7684\u529f\u80fd\u548c\u8bbe\u8ba1 2-1 \u6ca1\u6709Mixer\u7684\u65f6\u5019 Total Chaos 2-2 Mixer\u7684Adapter\u673a\u5236 https://istio.io/docs/concepts/policies-and-telemetry/ Mixer \u5904\u7406\u4e0d\u540c\u57fa\u7840\u8bbe\u65bd\u540e\u7aef\u7684\u7075\u6d3b\u6027\u662f\u901a\u8fc7\u4f7f\u7528\u901a\u7528\u63d2\u4ef6\u6a21\u578b\u5b9e\u73b0\u7684\uff0c\u8fd9\u79cd\u63d2\u4ef6\u79f0\u4e3a Adapter \u3002 Mixer \u901a\u8fc7\u5b83\u4eec\u4e0e\u4e0d\u540c\u7684\u57fa\u7840\u8bbe\u65bd\u540e\u7aef\u8fde\u63a5\uff0c\u8fd9\u4e9b\u540e\u7aef\u53ef\u63d0\u4f9b\u6838\u5fc3\u529f\u80fd\uff0c\u63d0\u4f9b\u65e5\u5fd7\u3001\u76d1\u63a7\u3001\u914d\u989d\u3001ACL \u68c0\u67e5\u7b49 2-3 Mixer\u5b8c\u6574\u89c6\u56fe \u89e3\u8026\u3001\u4e2d\u4ecb\u3001\u8fd0\u7ef4\u65f6\u914d\u7f6e Mixer: Route to backend services Route to backend metric Custom Metrics 2-4 Mixer\u7684\u5904\u7406\u6d41\u7a0b Envoy \u751f\u6210\u5c5e\u6027\u4e0a\u62a5 Mixer Mixer \u8c03\u7528\u5bf9\u5e94\u540e\u7aef\u5904\u7406\u5c5e\u6027 https://istio.io/docs/reference/config/policy-and-telemetry/attribute-vocabulary/ 2-5 Mixer \u914d\u7f6e\u6a21\u578b\u6982\u8ff0 Handler : \u521b\u5efa Handler ,\u5373\u914d\u7f6e Mixer \u9002\u914d\u5668\u3002 Instance : \u4ece Istio \u5c5e\u6027\u4e2d\u751f\u6210 instance \u3002 Rule : \u914d\u7f6e\u4e00\u7ec4\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u63cf\u8ff0\u4e86\u4f55\u65f6\u8c03\u7528\u7279\u5b9a\u9002\u914d\u5668\u53ca\u54ea\u4e9b\u5b9e\u4f8b\u3002 3\u3001Mixer\u7684\u914d\u7f6e\u6a21\u578b 3-1 Mixer \u914d\u7f6e\u6a21\u578b1: Handler \u5b9e\u4f8b\u5316\u4e00\u4e2a Adapter \uff0c\u5305\u62ec\u4e86 Mixer \u548c\u540e\u7aef\u4ea4\u4e92\u7684\u63a5\u53e3\u3002 apiVersion: \"config.istio.io/v1alpha2\" kind: stdio metadata: name: handler spec: outputAsJson: true Stdio Adapter \u5b9a\u4e49\u53c2\u7167: mixer/adapter/stdio/config/config.proto:94 3-2 Mixer \u914d\u7f6e\u6a21\u578b2:\u5b9e\u4f8b( Instance ) apiVersion: \"config.istio.io/v1alpha2\" kind: logentry metadata: name: accesslog namespace: {{ .Release.Namespace }} spec: severity: '\"Info\"' timestamp: request.time variables: sourceIp: source.ip | ip(\"0.0.0.0\") sourceApp: source.labels[\"app\"] | \"\" sourcePrincipal: source.principal | \"\" sourceName: source.name | \"\" destinationApp: destination.labels[\"app\"] | \"\" destinationIp: destination.ip | ip(\"0.0.0.0\") destinationServiceHost: destination.service.host | \"\" destinationWorkload: destination.workload.name | \"\" destinationName: destination.name | \"\" destinationNamespace: destination.namespace | \"\" protocol: request.scheme | context.protocol | \"http\" method: request.method | \"\" url: request.path | \"\" responseCode: response.code | 0 responseSize: response.size | 0 requestSize: request.size | 0 requestId: request.headers[\"x-request-id\"] | \"\" userAgent: request.useragent | \"\" responseTimestamp: response.time ... \u5b9e\u4f8b\u5c06\u8bf7\u6c42\u4e2d\u7684\u5c5e\u6027\u6620\u5c04\u6210\u4e3a\u9002\u914d\u5668\u7684\u8f93\u5165\uff0c\u6bcf\u6b21\u8bf7\u6c42\u9002\u914d\u5668\u6d88\u8d39\u7684\u6570\u636e\u3002 3-3 Mixer \u914d\u7f6e\u6a21\u578b3:\u89c4\u5219(Rule) apiVersion: \"config.istio.io/v1alpha2\" kind: rule metadata: name: stdio namespace: {{ .Release.Namespace }} spec: match: context.protocol == \"http\" || context.protocol == \"grpc\" actions: - handler: handler.stdio instances: - accesslog.logentry \u544a\u8bc9 Mixer \u54ea\u4e2a instance \u5728\u4ec0\u4e48\u65f6\u5019\u53d1\u9001\u7ed9\u54ea\u4e2a handler \u6765\u5904\u7406 3-4 Request \u7684\u5c5e\u6027\u5904\u7406\u6d41\u7a0b \u63a5\u6536\u5c5e\u6027 \u8865\u5145\u5c5e\u6027 \u5904\u7406\u5c5e\u6027 3-5 Mixer Adapters https://istio.io/docs/reference/config/policy-and-telemetry/adapters/ 3-6 Mixer \u7684 Check Adapter mixer/adapter/list/list.go Adapter\u5b9e\u73b0 func (h *handler) HandleListEntry(_ context.Context, entry *listentry.Instance) (adapter.CheckResult, error) { h.lock.Lock() l := h.list err := h.lastFetchError h.lock.Unlock() if l == nil { // no valid list return adapter.CheckResult{}, err } var value string ... return getCheckResult(h.config, code, msg), nil } https://github.com/istio/istio/blob/master/mixer/adapter/list/config/config.proto Adapter\u914d\u7f6e\u5b9a\u4e49 // Configuration format for the `list` adapter. message Params { // Where to find the list to check against. This may be omitted for a completely local list. string provider_url = 1; ... // Determines the type of list that the adapter is consulting. enum ListEntryType { // List entries are treated as plain strings. STRINGS = 0; // List entries are treated as case-insensitive strings. CASE_INSENSITIVE_STRINGS = 1; // List entries are treated as IP addresses and ranges. IP_ADDRESSES = 2; // List entries are treated as re2 regexp. See [here](https://github.com/google/re2/wiki/Syntax) for the supported syntax. REGEX = 3; } // Determines the kind of list entry and overrides. ListEntryType entry_type = 7; // Whether the list operates as a blacklist or a whitelist. bool blacklist = 8; } 3-7 Mixer \u7684 Report Adapter https://github.com/istio/istio/tree/master/mixer/adapter/stdio Adapter\u5b9e\u73b0 func (h *handler) HandleLogEntry(_ context.Context, instances []*logentry.Instance) error { var errors *multierror.Error fields := make([]zapcore.Field, 0, 6) for _, instance := range instances { entry := zapcore.Entry{ LoggerName: instance.Name, Level: h.mapSeverityLevel(instance.Severity), Time: instance.Timestamp, } var logEntryTypes map[string]istio_policy_v1beta1.ValueType if typeInfo, found := h.logEntryTypes[instance.Name]; found { logEntryTypes = typeInfo.Variables } for _, varName := range h.logEntryVars[instance.Name] { if value, ok := instance.Variables[varName]; ok { fields = append(fields, zap.Any(varName, convertValueTypes(value, varName, logEntryTypes))) } } if err := h.write(entry, fields); err != nil { errors = multierror.Append(errors, err) } fields = fields[:0] } return errors.ErrorOrNil() } Adapter\u914d\u7f6e\u5b9a\u4e49 https://github.com/istio/istio/blob/master/mixer/adapter/stdio/config/config.proto // Configuration format for the `stdio` adapter message Params { // Stream is used to select between different log output sinks. enum Stream { // Output to the Mixer process' standard output stream. This is the default value. STDOUT = 0; ... // The maximum number of days to retain old rotated log files based on the // timestamp encoded in their filename. Note that a day is defined as 24 // hours and may not exactly correspond to calendar days due to daylight // savings, leap seconds, etc. The default is to remove log files // older than 30 days. 0 indicates no limit. int32 max_days_before_rotation = 8; // The maximum number of old rotated log files to retain. The default // is to retain at most 1000 logs. 0 indicates no limit. int32 max_rotated_files = 9; } 3-8 Mixer\u7684\u9ad8\u53ef\u7528\u8bbe\u8ba1 \u65e0\u72b6\u6001 \u9ad8\u53ef\u4ee5\u7528 \u7f13\u5b58\u548c\u7f13\u51b2 Envoy First Level: Per-sidecar cache Mixer Second Level: Shared Cache 3-9 Mixer \u7684 Batch Report 4\u3001Mixer\u7684\u5178\u578b\u5e94\u7528 4-1 Mixer\u5178\u578b\u5e94\u75281: \u534e\u4e3a\u4e91\u5e94\u7528\u670d\u52a1\u7f51\u683c 4-2 Mixer\u5178\u578b\u5e94\u75282: Google Apigee https://docs.apigee.com/api-platform/istio-adapter/concepts 5\u3001Mixer\u5b9e\u8df51\u548c2 5-1 \u5b9e\u8df51 \u4ece0\u5f00\u53d1\u5e76\u8fd0\u884c\u4e00\u4e2a Mixer Adapter :\u539f\u7406 5-2 \u4e24\u4e2a\u89d2\u8272 \u914d\u7f6e\u6a21\u677f\u4f7f\u7528\u4e00\u4e2a Adapter => \u5f00\u53d1\u4ee3\u7801\u5b9a\u4e49\u6a21\u677f\u5f00\u53d1\u4e00\u4e2aAdapter 5-3 \u5b9e\u8df51 \u4ece0\u5f00\u53d1\u5e76\u8fd0\u884c\u4e00\u4e2aMixer Adapter:\u6b65\u9aa4 1.\u521b\u5efa\u72ec\u7acb\u7684Adapter\u76ee\u5f55\uff0c\u5e76\u5f00\u53d1Adapter\u7684\u4ee3\u7801\u5f00\u53d1Adapter\u4ee3\u7801 cd $MIXER_REPO/adapter && mkdir mysampleadapter && cd mysampleadapter #\u521b\u5efamysampleadapter .go\u6587\u4ef6\u5b9a\u4e49\u5904\u7406\u903b\u8f91 2.\u914d\u7f6e config.proto \uff0c\u63cf\u8ff0\u914d\u7f6e\u7684\u5b9a\u4e49\u3002 #\u521b\u5efaconfig.proto\u6587\u4ef6\uff0c\u63cf\u8ff0adapter\u7684\u914d\u7f6e\u53c2\u6570 $ mkdir config 3.\u6839\u636e proto \u751f\u6210go\u7684\u914d\u7f6e\uff0c\u5e76\u5728adapter\u4ee3\u7801\u4e2d\u4f7f\u7528 go generate ./... go build ./... 4.\u5728 Mixer \u4e2d\u6ce8\u518c\u8fd9\u4e2a\u65b0\u7684 Adapter \u3002 # \u5728inventory.yaml \u4e2d\u6ce8\u518cadapter\uff0c mysampleadapter: \"istio.io/istio/mixer/adapter/mysampleadapter\" go generate $MIXER_REPO/adapter/doc.go 5.\u914d\u7f6e\u5e76\u4f7f\u7528\u65b0\u521b\u5efa\u7684 adapter \u3002 #\u5728testdata\u76ee\u5f55\u4e0b\u521b\u5efa\u4f7f\u7528\u8be5adapter\u7684\u914d\u7f6e\uff0c\u5373handler\uff0cinstance\uff0crule\u3002 $mkdir $MIXER_REPO/adapter/mysampleadapter/testdata #\u786e\u8ba4\u4e24\u4e2a\u6587\u4ef6attributes.yaml\u548cmysampleadapter.yaml 6.\u542f\u52a8 mixer \u670d\u52a1\u7aef pushd $ISTIO/istio && make mixs $GOPATH/out/linux_amd64/release/mixs server --configStoreURL=fs://$(pwd)/mixer/adapter/mysampleadapter/testdata 7.\u542f\u52a8\u4e00\u4e2a\u5ba2\u6237\u7aef\uff0c\u6a21\u62df\u4e0a\u62a5\u6570\u636e pushd $ISTIO/istio && make mixc $GOPATH/out/linux_amd64/release/mixc report -s destination.service=\"svc.cluster.local\" -t request.time=\"2019-01-10T20:00:00Z\" 8.\u67e5\u770b\u7ed3\u679c\u8f93\u51fa tail $ISTIO/istio/out.txt 5-4 \u6548\u679c 6\u3001\u5b9e\u8df52 \u901a\u8fc7Mixer\u6536\u96c6\u81ea\u5b9a\u4e49\u7684\u9065\u6d4b\u6570\u636e:\u76ee\u6807 \u7f16\u5199\u81ea\u5b9a\u4e49\u7684 Metric \u6a21\u677f \u5728 Istio \u4e2d\u521b\u5efa\u81ea\u5b9a\u4e49 Metric \u3001 Prometheus Handler \u548c Rule \u8ba4\u8bc6 Prometheus Adapter \u5b9e\u8df5 Prometheus \u7684\u4e3b\u8981\u80fd\u529b 6-1 \u5b9e\u8df52 \u901a\u8fc7Mixer\u6536\u96c6\u81ea\u5b9a\u4e49\u7684\u9065\u6d4b\u6570\u636e:\u6b65\u9aa4 1.\u521b\u5efa\u914d\u7f6e\uff0c\u5305\u62ecprometheus\u7684handler\u3001metric\u548crule kubectl apply -f double-request.yaml 2.\u67e5\u770b\u521b\u5efa\u7684\u5bf9\u8c61 kubectl get metrics.config.istio.io -nistio-system kubectl get rules.config.istio.io -nistio-system kubectl get prometheus.config.istio.io -nistio-system 3.\u53d1\u8d77\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u751f\u6210\u8bbf\u95ee metric \u6570\u636e 4.\u901a\u8fc7 Prometheus \u67e5\u770b metric \u6570\u636e 4.1 \u67e5\u770b doublereques \u7684metric http://49.4.84.29:9090/graph?g0.range_input=1h&g0.expr=istio_double_request_count&g0.tab=1 4.2 \u901a\u8fc7 prometheus \u68c0\u7d22\u7279\u5b9a\u76ee\u6807\u7684 metric istio_double_request_count{destination=\"details-v1\"} 6-2 \u6548\u679c","title":"\u7b2c\u4e03\u8282 Mixer\u57fa\u7840\u4e0e\u5b9e\u73b0"},{"location":"chap3/6isba_Mixer/#mixer","text":"","title":"\u7b2c\u4e03\u8282 Mixer\u57fa\u7840\u4e0e\u5b9e\u73b0"},{"location":"chap3/6isba_Mixer/#agenda","text":"Istio\u67b6\u6784\u56de\u987e&Mixer\u4ecb\u7ecd Mixer\u7684\u529f\u80fd\u548c\u8bbe\u8ba1 Mixer\u7684\u914d\u7f6e\u6a21\u578b Mixer\u7684\u5178\u578b\u5e94\u7528 Mixer\u5b9e\u8df51\u548c2","title":"Agenda"},{"location":"chap3/6isba_Mixer/#1istio","text":"Istio Control plane API Pilot : Config data to proxies Mixer : Policy checks, telemetry Citadel : TLS certs to proxies","title":"1\u3001\u56de\u987e:Istio\u67b6\u6784"},{"location":"chap3/6isba_Mixer/#1-1-istio-mixer-control-observer","text":"","title":"1-1 Istio \u5b98\u65b9\u56db\u5927\u529f\u80fd\u4e2d\u4e24\u4e2a\u57fa\u4e8eMixer\u5b9e\u73b0 Control &amp; Observer"},{"location":"chap3/6isba_Mixer/#1-2-mixeristio","text":"\u529f\u80fd\u4e0a :\u8d1f\u8d23\u7b56\u7565\u63a7\u5236\u548c\u9065\u6d4b\u6536\u96c6 \u67b6\u6784\u4e0a :\u63d0\u4f9b\u63d2\u4ef6\u6a21\u578b\uff0c\u53ef\u4ee5\u6269\u5c55\u548c\u5b9a\u5236","title":"1-2 Mixer\u5728Istio\u4e2d\u89d2\u8272"},{"location":"chap3/6isba_Mixer/#2mixer","text":"","title":"2\u3001Mixer\u7684\u529f\u80fd\u548c\u8bbe\u8ba1"},{"location":"chap3/6isba_Mixer/#2-1-mixer-total-chaos","text":"","title":"2-1 \u6ca1\u6709Mixer\u7684\u65f6\u5019 Total Chaos"},{"location":"chap3/6isba_Mixer/#2-2-mixeradapter","text":"https://istio.io/docs/concepts/policies-and-telemetry/ Mixer \u5904\u7406\u4e0d\u540c\u57fa\u7840\u8bbe\u65bd\u540e\u7aef\u7684\u7075\u6d3b\u6027\u662f\u901a\u8fc7\u4f7f\u7528\u901a\u7528\u63d2\u4ef6\u6a21\u578b\u5b9e\u73b0\u7684\uff0c\u8fd9\u79cd\u63d2\u4ef6\u79f0\u4e3a Adapter \u3002 Mixer \u901a\u8fc7\u5b83\u4eec\u4e0e\u4e0d\u540c\u7684\u57fa\u7840\u8bbe\u65bd\u540e\u7aef\u8fde\u63a5\uff0c\u8fd9\u4e9b\u540e\u7aef\u53ef\u63d0\u4f9b\u6838\u5fc3\u529f\u80fd\uff0c\u63d0\u4f9b\u65e5\u5fd7\u3001\u76d1\u63a7\u3001\u914d\u989d\u3001ACL \u68c0\u67e5\u7b49","title":"2-2 Mixer\u7684Adapter\u673a\u5236"},{"location":"chap3/6isba_Mixer/#2-3-mixer","text":"\u89e3\u8026\u3001\u4e2d\u4ecb\u3001\u8fd0\u7ef4\u65f6\u914d\u7f6e Mixer: Route to backend services Route to backend metric Custom Metrics","title":"2-3 Mixer\u5b8c\u6574\u89c6\u56fe"},{"location":"chap3/6isba_Mixer/#2-4-mixer","text":"Envoy \u751f\u6210\u5c5e\u6027\u4e0a\u62a5 Mixer Mixer \u8c03\u7528\u5bf9\u5e94\u540e\u7aef\u5904\u7406\u5c5e\u6027 https://istio.io/docs/reference/config/policy-and-telemetry/attribute-vocabulary/","title":"2-4 Mixer\u7684\u5904\u7406\u6d41\u7a0b"},{"location":"chap3/6isba_Mixer/#2-5-mixer","text":"Handler : \u521b\u5efa Handler ,\u5373\u914d\u7f6e Mixer \u9002\u914d\u5668\u3002 Instance : \u4ece Istio \u5c5e\u6027\u4e2d\u751f\u6210 instance \u3002 Rule : \u914d\u7f6e\u4e00\u7ec4\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u63cf\u8ff0\u4e86\u4f55\u65f6\u8c03\u7528\u7279\u5b9a\u9002\u914d\u5668\u53ca\u54ea\u4e9b\u5b9e\u4f8b\u3002","title":"2-5 Mixer \u914d\u7f6e\u6a21\u578b\u6982\u8ff0"},{"location":"chap3/6isba_Mixer/#3mixer","text":"","title":"3\u3001Mixer\u7684\u914d\u7f6e\u6a21\u578b"},{"location":"chap3/6isba_Mixer/#3-1-mixer-1-handler","text":"\u5b9e\u4f8b\u5316\u4e00\u4e2a Adapter \uff0c\u5305\u62ec\u4e86 Mixer \u548c\u540e\u7aef\u4ea4\u4e92\u7684\u63a5\u53e3\u3002 apiVersion: \"config.istio.io/v1alpha2\" kind: stdio metadata: name: handler spec: outputAsJson: true Stdio Adapter \u5b9a\u4e49\u53c2\u7167: mixer/adapter/stdio/config/config.proto:94","title":"3-1 Mixer \u914d\u7f6e\u6a21\u578b1: Handler"},{"location":"chap3/6isba_Mixer/#3-2-mixer-2instance","text":"apiVersion: \"config.istio.io/v1alpha2\" kind: logentry metadata: name: accesslog namespace: {{ .Release.Namespace }} spec: severity: '\"Info\"' timestamp: request.time variables: sourceIp: source.ip | ip(\"0.0.0.0\") sourceApp: source.labels[\"app\"] | \"\" sourcePrincipal: source.principal | \"\" sourceName: source.name | \"\" destinationApp: destination.labels[\"app\"] | \"\" destinationIp: destination.ip | ip(\"0.0.0.0\") destinationServiceHost: destination.service.host | \"\" destinationWorkload: destination.workload.name | \"\" destinationName: destination.name | \"\" destinationNamespace: destination.namespace | \"\" protocol: request.scheme | context.protocol | \"http\" method: request.method | \"\" url: request.path | \"\" responseCode: response.code | 0 responseSize: response.size | 0 requestSize: request.size | 0 requestId: request.headers[\"x-request-id\"] | \"\" userAgent: request.useragent | \"\" responseTimestamp: response.time ... \u5b9e\u4f8b\u5c06\u8bf7\u6c42\u4e2d\u7684\u5c5e\u6027\u6620\u5c04\u6210\u4e3a\u9002\u914d\u5668\u7684\u8f93\u5165\uff0c\u6bcf\u6b21\u8bf7\u6c42\u9002\u914d\u5668\u6d88\u8d39\u7684\u6570\u636e\u3002","title":"3-2 Mixer \u914d\u7f6e\u6a21\u578b2:\u5b9e\u4f8b(Instance)"},{"location":"chap3/6isba_Mixer/#3-3-mixer-3rule","text":"apiVersion: \"config.istio.io/v1alpha2\" kind: rule metadata: name: stdio namespace: {{ .Release.Namespace }} spec: match: context.protocol == \"http\" || context.protocol == \"grpc\" actions: - handler: handler.stdio instances: - accesslog.logentry \u544a\u8bc9 Mixer \u54ea\u4e2a instance \u5728\u4ec0\u4e48\u65f6\u5019\u53d1\u9001\u7ed9\u54ea\u4e2a handler \u6765\u5904\u7406","title":"3-3 Mixer \u914d\u7f6e\u6a21\u578b3:\u89c4\u5219(Rule)"},{"location":"chap3/6isba_Mixer/#3-4-request","text":"\u63a5\u6536\u5c5e\u6027 \u8865\u5145\u5c5e\u6027 \u5904\u7406\u5c5e\u6027","title":"3-4 Request\u7684\u5c5e\u6027\u5904\u7406\u6d41\u7a0b"},{"location":"chap3/6isba_Mixer/#3-5-mixer-adapters","text":"https://istio.io/docs/reference/config/policy-and-telemetry/adapters/","title":"3-5 Mixer Adapters"},{"location":"chap3/6isba_Mixer/#3-6-mixer-check-adapter","text":"mixer/adapter/list/list.go Adapter\u5b9e\u73b0 func (h *handler) HandleListEntry(_ context.Context, entry *listentry.Instance) (adapter.CheckResult, error) { h.lock.Lock() l := h.list err := h.lastFetchError h.lock.Unlock() if l == nil { // no valid list return adapter.CheckResult{}, err } var value string ... return getCheckResult(h.config, code, msg), nil } https://github.com/istio/istio/blob/master/mixer/adapter/list/config/config.proto Adapter\u914d\u7f6e\u5b9a\u4e49 // Configuration format for the `list` adapter. message Params { // Where to find the list to check against. This may be omitted for a completely local list. string provider_url = 1; ... // Determines the type of list that the adapter is consulting. enum ListEntryType { // List entries are treated as plain strings. STRINGS = 0; // List entries are treated as case-insensitive strings. CASE_INSENSITIVE_STRINGS = 1; // List entries are treated as IP addresses and ranges. IP_ADDRESSES = 2; // List entries are treated as re2 regexp. See [here](https://github.com/google/re2/wiki/Syntax) for the supported syntax. REGEX = 3; } // Determines the kind of list entry and overrides. ListEntryType entry_type = 7; // Whether the list operates as a blacklist or a whitelist. bool blacklist = 8; }","title":"3-6 Mixer \u7684 Check Adapter"},{"location":"chap3/6isba_Mixer/#3-7-mixer-report-adapter","text":"https://github.com/istio/istio/tree/master/mixer/adapter/stdio Adapter\u5b9e\u73b0 func (h *handler) HandleLogEntry(_ context.Context, instances []*logentry.Instance) error { var errors *multierror.Error fields := make([]zapcore.Field, 0, 6) for _, instance := range instances { entry := zapcore.Entry{ LoggerName: instance.Name, Level: h.mapSeverityLevel(instance.Severity), Time: instance.Timestamp, } var logEntryTypes map[string]istio_policy_v1beta1.ValueType if typeInfo, found := h.logEntryTypes[instance.Name]; found { logEntryTypes = typeInfo.Variables } for _, varName := range h.logEntryVars[instance.Name] { if value, ok := instance.Variables[varName]; ok { fields = append(fields, zap.Any(varName, convertValueTypes(value, varName, logEntryTypes))) } } if err := h.write(entry, fields); err != nil { errors = multierror.Append(errors, err) } fields = fields[:0] } return errors.ErrorOrNil() } Adapter\u914d\u7f6e\u5b9a\u4e49 https://github.com/istio/istio/blob/master/mixer/adapter/stdio/config/config.proto // Configuration format for the `stdio` adapter message Params { // Stream is used to select between different log output sinks. enum Stream { // Output to the Mixer process' standard output stream. This is the default value. STDOUT = 0; ... // The maximum number of days to retain old rotated log files based on the // timestamp encoded in their filename. Note that a day is defined as 24 // hours and may not exactly correspond to calendar days due to daylight // savings, leap seconds, etc. The default is to remove log files // older than 30 days. 0 indicates no limit. int32 max_days_before_rotation = 8; // The maximum number of old rotated log files to retain. The default // is to retain at most 1000 logs. 0 indicates no limit. int32 max_rotated_files = 9; }","title":"3-7 Mixer \u7684 Report Adapter"},{"location":"chap3/6isba_Mixer/#3-8-mixer","text":"\u65e0\u72b6\u6001 \u9ad8\u53ef\u4ee5\u7528 \u7f13\u5b58\u548c\u7f13\u51b2","title":"3-8 Mixer\u7684\u9ad8\u53ef\u7528\u8bbe\u8ba1"},{"location":"chap3/6isba_Mixer/#envoy","text":"First Level: Per-sidecar cache","title":"Envoy"},{"location":"chap3/6isba_Mixer/#mixer_1","text":"Second Level: Shared Cache","title":"Mixer"},{"location":"chap3/6isba_Mixer/#3-9-mixer-batch-report","text":"","title":"3-9 Mixer \u7684 Batch Report"},{"location":"chap3/6isba_Mixer/#4mixer","text":"","title":"4\u3001Mixer\u7684\u5178\u578b\u5e94\u7528"},{"location":"chap3/6isba_Mixer/#4-1-mixer1","text":"","title":"4-1 Mixer\u5178\u578b\u5e94\u75281: \u534e\u4e3a\u4e91\u5e94\u7528\u670d\u52a1\u7f51\u683c"},{"location":"chap3/6isba_Mixer/#4-2-mixer2-google-apigee","text":"https://docs.apigee.com/api-platform/istio-adapter/concepts","title":"4-2 Mixer\u5178\u578b\u5e94\u75282: Google Apigee"},{"location":"chap3/6isba_Mixer/#5mixer12","text":"","title":"5\u3001Mixer\u5b9e\u8df51\u548c2"},{"location":"chap3/6isba_Mixer/#5-1-1-0mixer-adapter","text":"","title":"5-1 \u5b9e\u8df51 \u4ece0\u5f00\u53d1\u5e76\u8fd0\u884c\u4e00\u4e2aMixer Adapter:\u539f\u7406"},{"location":"chap3/6isba_Mixer/#5-2","text":"\u914d\u7f6e\u6a21\u677f\u4f7f\u7528\u4e00\u4e2a Adapter => \u5f00\u53d1\u4ee3\u7801\u5b9a\u4e49\u6a21\u677f\u5f00\u53d1\u4e00\u4e2aAdapter","title":"5-2 \u4e24\u4e2a\u89d2\u8272"},{"location":"chap3/6isba_Mixer/#5-3-1-0mixer-adapter","text":"1.\u521b\u5efa\u72ec\u7acb\u7684Adapter\u76ee\u5f55\uff0c\u5e76\u5f00\u53d1Adapter\u7684\u4ee3\u7801\u5f00\u53d1Adapter\u4ee3\u7801 cd $MIXER_REPO/adapter && mkdir mysampleadapter && cd mysampleadapter #\u521b\u5efamysampleadapter .go\u6587\u4ef6\u5b9a\u4e49\u5904\u7406\u903b\u8f91 2.\u914d\u7f6e config.proto \uff0c\u63cf\u8ff0\u914d\u7f6e\u7684\u5b9a\u4e49\u3002 #\u521b\u5efaconfig.proto\u6587\u4ef6\uff0c\u63cf\u8ff0adapter\u7684\u914d\u7f6e\u53c2\u6570 $ mkdir config 3.\u6839\u636e proto \u751f\u6210go\u7684\u914d\u7f6e\uff0c\u5e76\u5728adapter\u4ee3\u7801\u4e2d\u4f7f\u7528 go generate ./... go build ./... 4.\u5728 Mixer \u4e2d\u6ce8\u518c\u8fd9\u4e2a\u65b0\u7684 Adapter \u3002 # \u5728inventory.yaml \u4e2d\u6ce8\u518cadapter\uff0c mysampleadapter: \"istio.io/istio/mixer/adapter/mysampleadapter\" go generate $MIXER_REPO/adapter/doc.go 5.\u914d\u7f6e\u5e76\u4f7f\u7528\u65b0\u521b\u5efa\u7684 adapter \u3002 #\u5728testdata\u76ee\u5f55\u4e0b\u521b\u5efa\u4f7f\u7528\u8be5adapter\u7684\u914d\u7f6e\uff0c\u5373handler\uff0cinstance\uff0crule\u3002 $mkdir $MIXER_REPO/adapter/mysampleadapter/testdata #\u786e\u8ba4\u4e24\u4e2a\u6587\u4ef6attributes.yaml\u548cmysampleadapter.yaml 6.\u542f\u52a8 mixer \u670d\u52a1\u7aef pushd $ISTIO/istio && make mixs $GOPATH/out/linux_amd64/release/mixs server --configStoreURL=fs://$(pwd)/mixer/adapter/mysampleadapter/testdata 7.\u542f\u52a8\u4e00\u4e2a\u5ba2\u6237\u7aef\uff0c\u6a21\u62df\u4e0a\u62a5\u6570\u636e pushd $ISTIO/istio && make mixc $GOPATH/out/linux_amd64/release/mixc report -s destination.service=\"svc.cluster.local\" -t request.time=\"2019-01-10T20:00:00Z\" 8.\u67e5\u770b\u7ed3\u679c\u8f93\u51fa tail $ISTIO/istio/out.txt","title":"5-3 \u5b9e\u8df51 \u4ece0\u5f00\u53d1\u5e76\u8fd0\u884c\u4e00\u4e2aMixer Adapter:\u6b65\u9aa4"},{"location":"chap3/6isba_Mixer/#5-4","text":"","title":"5-4 \u6548\u679c"},{"location":"chap3/6isba_Mixer/#62-mixer","text":"\u7f16\u5199\u81ea\u5b9a\u4e49\u7684 Metric \u6a21\u677f \u5728 Istio \u4e2d\u521b\u5efa\u81ea\u5b9a\u4e49 Metric \u3001 Prometheus Handler \u548c Rule \u8ba4\u8bc6 Prometheus Adapter \u5b9e\u8df5 Prometheus \u7684\u4e3b\u8981\u80fd\u529b","title":"6\u3001\u5b9e\u8df52 \u901a\u8fc7Mixer\u6536\u96c6\u81ea\u5b9a\u4e49\u7684\u9065\u6d4b\u6570\u636e:\u76ee\u6807"},{"location":"chap3/6isba_Mixer/#6-1-2-mixer","text":"1.\u521b\u5efa\u914d\u7f6e\uff0c\u5305\u62ecprometheus\u7684handler\u3001metric\u548crule kubectl apply -f double-request.yaml 2.\u67e5\u770b\u521b\u5efa\u7684\u5bf9\u8c61 kubectl get metrics.config.istio.io -nistio-system kubectl get rules.config.istio.io -nistio-system kubectl get prometheus.config.istio.io -nistio-system 3.\u53d1\u8d77\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u751f\u6210\u8bbf\u95ee metric \u6570\u636e 4.\u901a\u8fc7 Prometheus \u67e5\u770b metric \u6570\u636e 4.1 \u67e5\u770b doublereques \u7684metric http://49.4.84.29:9090/graph?g0.range_input=1h&g0.expr=istio_double_request_count&g0.tab=1 4.2 \u901a\u8fc7 prometheus \u68c0\u7d22\u7279\u5b9a\u76ee\u6807\u7684 metric istio_double_request_count{destination=\"details-v1\"}","title":"6-1 \u5b9e\u8df52 \u901a\u8fc7Mixer\u6536\u96c6\u81ea\u5b9a\u4e49\u7684\u9065\u6d4b\u6570\u636e:\u6b65\u9aa4"},{"location":"chap3/6isba_Mixer/#6-2","text":"","title":"6-2 \u6548\u679c"},{"location":"chap4/1Istio_Intro/","text":"\u7b2c\u4e00\u8282 2021 Service Mesh & Istio \u4ecb\u7ecd/\u5b89\u88c5(1.10.3) \u73b0\u5728\u6700\u706b\u7684\u540e\u7aef\u67b6\u6784\u65e0\u7591\u662f\u5fae\u670d\u52a1\u4e86\uff0c\u5fae\u670d\u52a1\u5c06\u4e4b\u524d\u7684\u5355\u4f53\u5e94\u7528\u62c6\u5206\u6210\u4e86\u8bb8\u591a\u72ec\u7acb\u7684\u670d\u52a1\u5e94\u7528\uff0c\u6bcf\u4e2a\u5fae\u670d\u52a1\u90fd\u662f\u72ec\u7acb\u7684\uff0c\u597d\u5904\u81ea\u7136\u5f88\u591a\uff0c\u4f46\u662f\u968f\u7740\u5e94\u7528\u7684\u8d8a\u6765\u8d8a\u5927\uff0c\u5fae\u670d\u52a1\u66b4\u9732\u51fa\u6765\u7684\u95ee\u9898\u4e5f\u5c31\u968f\u4e4b\u800c\u6765\u4e86\uff0c\u5fae\u670d\u52a1\u8d8a\u6765\u8d8a\u591a\uff0c\u7ba1\u7406\u8d8a\u6765\u8d8a\u9ebb\u70e6\uff0c\u7279\u522b\u662f\u8981\u4f60\u90e8\u7f72\u4e00\u5957\u65b0\u73af\u5883\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u80fd\u4f53\u4f1a\u5230\u8fd9\u79cd\u75db\u82e6\u4e86\uff0c\u968f\u4e4b\u800c\u6765\u7684 \u670d\u52a1\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001Trace\u8ddf\u8e2a\u3001\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u8ba4\u8bc1\u7b49\u7b49\u95ee\u9898 \u3002 \u5982\u679c\u4ece\u5934\u5230\u5c3e\u5b8c\u6210\u8fc7\u4e00\u5957\u5fae\u670d\u52a1\u6846\u67b6\u7684\u8bdd\uff0c\u4f60\u5c31\u4f1a\u77e5\u9053\u8fd9\u91cc\u9762\u6d89\u53ca\u5230\u7684\u4e1c\u897f\u771f\u7684\u975e\u5e38\u591a\u3002\u5f53\u7136\u968f\u7740\u5fae\u670d\u52a1\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u5fae\u670d\u52a1\u7684\u751f\u6001\u4e5f\u4e0d\u65ad\u5b8c\u5584\uff0c\u6700\u8fd1\u65b0\u4e00\u4ee3\u7684\u5fae\u670d\u52a1\u5f00\u53d1\u5c31\u6084\u7136\u5174\u8d77\u4e86\uff0c\u90a3\u5c31\u662f\u670d\u52a1\u7f51\u683c/Service Mesh\u3002 1\u3001\u4ec0\u4e48\u662fService Mesh\uff1f Service Mesh \u662f\u4e00\u4e2a\u975e\u5e38\u65b0\u7684\u540d\u8bcd\uff0c\u6700\u65e9\u662f2016\u5e74\u7531\u5f00\u53d1 Linkerd \u7684 Buoyant \u516c\u53f8\u63d0\u51fa\u7684\uff0c\u4f34\u968f\u7740 Linkerd \u7684\u4f20\u5165\uff0c Service Mesh \u7684\u6982\u5ff5\u4e5f\u6162\u6162\u8fdb\u5165\u56fd\u5185\u6280\u672f\u793e\u533a\uff0c \u73b0\u5728\u4e3b\u6d41\u7684\u53eb\u6cd5\u90fd\u53eb\uff1a\u670d\u52a1\u7f51\u683c\u3002 \u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u7528\u4e8e\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5b83\u8d1f\u8d23\u4e3a\u6784\u5efa\u590d\u6742\u7684\u4e91\u539f\u751f\u5e94\u7528\u4f20\u9012\u53ef\u9760\u7684\u7f51\u7edc\u8bf7\u6c42\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u901a\u5e38\u5b9e\u73b0\u4e3a\u4e00\u7ec4\u548c\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5728\u4e00\u8d77\u7684\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\uff0c\u4f46\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u662f\u900f\u660e\u7684\u3002 \u8981\u7406\u89e3\u7f51\u683c\u7684\u6982\u5ff5\uff0c\u5c31\u5f97\u4ece\u670d\u52a1\u7684\u90e8\u7f72\u6a21\u578b\u8bf4\u8d77\uff1a 1-1 \u5355\u4e2a\u670d\u52a1\u8c03\u7528\uff0c\u8868\u73b0\u4e3asidecar \u5355\u4e2a\u670d\u52a1\u8c03\u7528 Service Mesh \u7684\u90e8\u7f72\u6a21\u578b\uff0c\u5148\u770b\u5355\u4e2a\u7684\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7b80\u5355\u8bf7\u6c42\uff0c\u4f5c\u4e3a\u8bf7\u6c42\u53d1\u8d77\u8005\u7684\u5ba2\u6237\u7aef\u5e94\u7528\u5b9e\u4f8b\uff0c\u4f1a\u9996\u5148\u7528\u7b80\u5355\u65b9\u5f0f\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u672c\u5730\u7684 Service Mesh \u5b9e\u4f8b\u3002 \u8fd9\u662f\u4e24\u4e2a\u72ec\u7acb\u8fdb\u7a0b\uff0c\u4ed6\u4eec\u4e4b\u95f4\u662f\u8fdc\u7a0b\u8c03\u7528\u3002 Service Mesh \u4f1a\u5b8c\u6210\u5b8c\u6574\u7684\u670d\u52a1\u95f4\u8c03\u7528\u6d41\u7a0b\uff0c\u5982\u670d\u52a1\u53d1\u73b0\u8d1f\u8f7d\u5747\u8861\uff0c\u6700\u540e\u5c06\u8bf7\u6c42\u53d1\u9001\u7ed9\u76ee\u6807\u670d\u52a1\uff0c\u8fd9\u8868\u73b0\u4e3a Sidecar \u65b9\u5f0f\u3002 1-2 \u90e8\u7f72\u591a\u4e2a\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u901a\u8baf\u5c42 \u591a\u4e2a\u670d\u52a1\u8c03\u7528\u7684\u60c5\u51b5\uff0c\u5728\u8fd9\u4e2a\u56fe\u4e0a\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Service Mesh \u5728\u6240\u6709\u7684\u670d\u52a1\u7684\u4e0b\u9762\uff0c\u8fd9\u4e00\u5c42\u88ab\u79f0\u4e4b\u4e3a\u670d\u52a1\u95f4\u901a\u8baf\u4e13\u7528\u57fa\u7840\u8bbe\u65bd\u5c42\u3002 Service Mesh \u4f1a\u63a5\u7ba1\u6574\u4e2a\u7f51\u7edc\uff0c\u628a\u6240\u6709\u7684\u8bf7\u6c42\u5728\u670d\u52a1\u4e4b\u95f4\u505a\u8f6c\u53d1\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4e0a\u9762\u7684\u670d\u52a1\u4e0d\u518d\u8d1f\u8d23\u4f20\u9012\u8bf7\u6c42\u7684\u5177\u4f53\u903b\u8f91\uff0c\u53ea\u8d1f\u8d23\u5b8c\u6210\u4e1a\u52a1\u5904\u7406\u3002\u670d\u52a1\u95f4\u901a\u8baf\u7684\u73af\u8282\u5c31\u4ece\u5e94\u7528\u91cc\u9762\u5265\u79bb\u51fa\u6765\uff0c\u5448\u73b0\u51fa\u4e00\u4e2a\u62bd\u8c61\u5c42\u3002 1-3 \u6709\u5927\u91cf\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u7f51\u7edc \u5982\u679c\u6709\u5927\u91cf\u7684\u670d\u52a1\uff0c\u5c31\u4f1a\u8868\u73b0\u51fa\u6765\u7f51\u683c\uff0c\u56fe\u4e2d\u5de6\u8fb9\u7eff\u8272\u65b9\u683c\u662f\u5e94\u7528\uff0c\u53f3\u8fb9\u84dd\u8272\u7684\u65b9\u6846\u662f Service Mesh\uff0c\u84dd\u8272\u4e4b\u95f4\u7684\u7ebf\u6761\u662f\u8868\u793a\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u3002Sidecar \u4e4b\u95f4\u7684\u8fde\u63a5\u5c31\u4f1a\u5f62\u6210\u4e00\u4e2a\u7f51\u7edc\uff0c\u8fd9\u4e2a\u5c31\u662f\u670d\u52a1\u7f51\u683c\u540d\u5b57\u7684\u7531\u6765\uff0c\u8fd9\u4e2a\u65f6\u5019\u4ee3\u7406\u4f53\u73b0\u51fa\u6765\u7684\u5c31\u548c\u524d\u9762\u7684 Sidecar \u4e0d\u4e00\u6837\u4e86\uff0c\u5f62\u6210\u7f51\u72b6\u3002 \u9996\u5148\u7b2c\u4e00\u4e2a\uff0c\u670d\u52a1\u7f51\u683c\u662f\u62bd\u8c61\u7684\uff0c\u5b9e\u9645\u4e0a\u662f\u62bd\u8c61\u51fa\u4e86\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5728\u5e94\u7528\u4e4b\u5916\u3002\u5176\u6b21\uff0c\u529f\u80fd\u662f\u5b9e\u73b0\u8bf7\u6c42\u7684\u53ef\u9760\u4f20\u9012\u3002\u90e8\u7f72\u4e0a\u4f53\u73b0\u4e3a\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\u3002\u6700\u540e\u4e00\u4e2a\u5173\u952e\u8bcd\u662f\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u900f\u660e\u3002 \u5927\u5bb6\u6ce8\u610f\u770b\uff0c\u4e0a\u9762\u7684\u56fe\u4e2d\uff0c\u7f51\u7edc\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u4e0d\u662f\u7279\u522b\u660e\u663e\u3002\u4f46\u662f\u5982\u679c\u628a\u5de6\u8fb9\u7684\u5e94\u7528\u7a0b\u5e8f\u53bb\u6389\uff0c\u73b0\u5728\u53ea\u5448\u73b0\u51fa\u6765 Service Mesh \u548c\u4ed6\u4eec\u4e4b\u95f4\u7684\u8c03\u7528\uff0c\u8fd9\u4e2a\u65f6\u5019\u5173\u7cfb\u5c31\u4f1a\u7279\u522b\u6e05\u6670\uff0c\u5c31\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u7f51\u7edc\u3002 \u8fd9\u662f Service Mesh \u5b9a\u4e49\u5f53\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5173\u952e\u70b9\uff0c\u548c Sidecar \u4e0d\u76f8\u540c\u7684\u5730\u65b9\uff1a \u4e0d\u518d\u5c06\u4ee3\u7406\u89c6\u4e3a\u5355\u72ec\u7684\u7ec4\u4ef6\uff0c\u800c\u662f\u5f3a\u8c03\u7531\u8fd9\u4e9b\u4ee3\u7406\u8fde\u63a5\u800c\u5f62\u6210\u7684\u7f51\u7edc\u3002\u5728 Service Mesh \u91cc\u9762\u975e\u5e38\u5f3a\u8c03\u4ee3\u7406\u8fde\u63a5\u7ec4\u6210\u7684\u7f51\u7edc\uff0c\u800c\u4e0d\u50cf Sidecar \u90a3\u6837\u770b\u5f85\u4e2a\u4f53\u3002 \u73b0\u5728\u6211\u4eec\u57fa\u672c\u4e0a\u628a Service Mesh \u7684\u5b9a\u4e49\u4ecb\u7ecd\u6e05\u695a\u4e86\uff0c\u5927\u5bb6\u5e94\u8be5\u53ef\u4ee5\u5927\u6982\u4e86\u89e3\u4ec0\u4e48\u662f Service Mesh \u4e86\u3002\u73b0\u5728\u5b9e\u73b0 Service Mesh \u7684\u5f00\u6e90\u65b9\u6848\u6709\u5f88\u591a\uff0c\u6bd4\u5982 Linkerd\u3001Istio \u7b49\uff0c\u5f53\u7136\u76ee\u524d\u6700\u6d41\u884c\u6700\u706b\u70ed\u7684\u8fd8\u662f\u8981\u6570 Istio \u4e86\uff0c\u8bb0\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5f00\u59cb\u8bb2\u89e3 Istio \u7684\u4f7f\u7528\u3002 2\u3001\u4ec0\u4e48\u662fIstio\uff1f Istio \u89e3\u51b3\u4e86\u5f00\u53d1\u4eba\u5458\u548c\u8fd0\u7ef4\u5728\u5206\u5e03\u5f0f\u6216\u5fae\u670d\u52a1\u67b6\u6784\u65b9\u9762\u9762\u4e34\u7684\u6311\u6218\uff0c\u65e0\u8bba\u662f\u4ece\u5934\u5f00\u59cb\u6784\u5efa\u8fd8\u662f\u5c06\u73b0\u6709\u5e94\u7528\u7a0b\u5e8f\u8fc1\u79fb\u5230\u4e91\u539f\u751f\u73af\u5883\u4e0b\uff0cIstio \u90fd\u53ef\u4ee5\u63d0\u4f9b\u5e2e\u52a9\u3002 \u901a\u8fc7\u5728\u90e8\u7f72\u7684\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u6dfb\u52a0\u4ee3\u7406 sidecar\uff0cIstio \u5141\u8bb8\u60a8\u5c06\u5e94\u7528\u7a0b\u5e8f\u611f\u77e5\u6d41\u91cf\u7ba1\u7406\u3001\u4ee4\u4eba\u96be\u4ee5\u7f6e\u4fe1\u7684\u53ef\u89c2\u5bdf\u6027\u548c\u5f3a\u5927\u7684\u5b89\u5168\u529f\u80fd\u7f16\u7a0b\u5230\u60a8\u7684\u7f51\u7edc\u4e2d\u3002 Istio \u662f\u4e00\u4e2a\u5f00\u6e90\u670d\u52a1\u7f51\u683c\uff0c\u5b83\u900f\u660e\u5730\u5206\u5c42\u5230\u73b0\u6709\u7684\u5206\u5e03\u5f0f\u5e94\u7528\u7a0b\u5e8f\u4e0a\u3002Istio \u5f3a\u5927\u7684\u7279\u6027\u63d0\u4f9b\u4e86\u4e00\u79cd\u7edf\u4e00\u548c\u66f4\u6709\u6548\u7684\u65b9\u5f0f\u6765\u4fdd\u62a4\u3001\u8fde\u63a5\u548c\u76d1\u89c6\u670d\u52a1\u3002 Istio \u662f\u5b9e\u73b0\u8d1f\u8f7d\u5e73\u8861\u3001\u670d\u52a1\u5230\u670d\u52a1\u8eab\u4efd\u9a8c\u8bc1\u548c\u76d1\u89c6\u7684\u8def\u5f84\u2014\u2014\u53ea\u9700\u8981\u5f88\u5c11\u6216\u4e0d\u9700\u8981\u66f4\u6539\u670d\u52a1\u4ee3\u7801\u3002\u5b83\u5f3a\u5927\u7684\u63a7\u5236\u5e73\u9762\u5e26\u6765\u4e86\u91cd\u8981\u7684\u7279\u70b9\uff0c\u5305\u62ec\uff1a \u4f7f\u7528 TLS \u52a0\u5bc6\u3001\u5f3a\u8eab\u4efd\u8ba4\u8bc1\u548c\u6388\u6743\u7684\u96c6\u7fa4\u5185\u670d\u52a1\u5230\u670d\u52a1\u7684\u5b89\u5168\u901a\u4fe1 \u81ea\u52a8\u8d1f\u8f7d\u5747\u8861\u7684 HTTP, gRPC, WebSocket\uff0c\u548c TCP \u6d41\u91cf \u901a\u8fc7\u4e30\u5bcc\u7684\u8def\u7531\u89c4\u5219\u3001\u91cd\u8bd5\u3001\u6545\u969c\u8f6c\u79fb\u548c\u6545\u969c\u6ce8\u5165\u5bf9\u6d41\u91cf\u884c\u4e3a\u8fdb\u884c\u7ec6\u7c92\u5ea6\u63a7\u5236 \u4e00\u4e2a\u53ef\u63d2\u5165\u7684\u7b56\u7565\u5c42\u548c\u914d\u7f6e API\uff0c\u652f\u6301\u8bbf\u95ee\u63a7\u5236\u3001\u901f\u7387\u9650\u5236\u548c\u914d\u989d \u5bf9\u96c6\u7fa4\u5185\u7684\u6240\u6709\u6d41\u91cf(\u5305\u62ec\u96c6\u7fa4\u5165\u53e3\u548c\u51fa\u53e3)\u8fdb\u884c\u81ea\u52a8\u5ea6\u91cf\u3001\u65e5\u5fd7\u548c\u8ddf\u8e2a Istio \u662f\u4e3a\u53ef\u6269\u5c55\u6027\u800c\u8bbe\u8ba1\u7684\uff0c\u53ef\u4ee5\u5904\u7406\u4e0d\u540c\u8303\u56f4\u7684\u90e8\u7f72\u9700\u6c42\u3002 Istio \u7684\u63a7\u5236\u5e73\u9762\u8fd0\u884c\u5728 Kubernetes \u4e0a\uff0c\u60a8\u53ef\u4ee5\u5c06\u90e8\u7f72\u5728\u8be5\u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u5230\u60a8\u7684\u7f51\u683c\u4e2d\uff0c\u5c06\u7f51\u683c\u6269\u5c55\u5230\u5176\u4ed6\u96c6\u7fa4\uff0c\u751a\u81f3\u8fde\u63a5 VM \u6216\u8fd0\u884c\u5728 Kubernetes \u4e4b\u5916\u7684\u5176\u4ed6\u7aef\u70b9\u3002 3\u3001\u67b6\u6784 Istio \u6709\u4e24\u4e2a\u7ec4\u6210\u90e8\u5206\uff1a \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 \u3002 \u6570\u636e\u5e73\u9762\u7531\u4e00\u7ec4\u667a\u80fd\u4ee3\u7406\uff08Envoy\uff09\u7ec4\u6210\uff0c\u88ab\u90e8\u7f72\u4e3a Sidecar\u3002\u8fd9\u4e9b\u4ee3\u7406\u8d1f\u8d23\u534f\u8c03\u548c\u63a7\u5236\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1\u3002\u5b83\u4eec\u8fd8\u6536\u96c6\u548c\u62a5\u544a\u6240\u6709\u7f51\u683c\u6d41\u91cf\u7684\u9065\u6d4b\u6570\u636e \u3002 \u670d\u52a1\u7f51\u683c\u4f7f\u7528\u4ee3\u7406\u62e6\u622a\u6240\u6709\u7684\u7f51\u7edc\u6d41\u91cf\uff0c\u5141\u8bb8\u6839\u636e\u60a8\u8bbe\u7f6e\u7684\u914d\u7f6e\u63d0\u4f9b\u5e7f\u6cdb\u7684\u5e94\u7528\u7a0b\u5e8f\u611f\u77e5\u529f\u80fd\u3002 \u4ee3\u7406\u4e0e\u60a8\u5728\u96c6\u7fa4\u4e2d\u542f\u52a8\u7684\u6bcf\u4e2a\u670d\u52a1\u4e00\u8d77\u90e8\u7f72\uff0c\u6216\u8005\u4e0e\u8fd0\u884c\u5728\u865a\u62df\u673a\u4e0a\u7684\u670d\u52a1\u4e00\u8d77\u8fd0\u884c\u3002 \u63a7\u5236\u5e73\u9762\u7ba1\u7406\u5e76\u914d\u7f6e\u4ee3\u7406\u6765\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002 \u5728\u4f7f\u7528 Istio \u4e4b\u524d\u670d\u52a1\u4e0e\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u4f7f\u7528 Istio \u4e4b\u540e\u670d\u52a1\u4e0e\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u5219\u901a\u8fc7 Envoy \u4ee3\u7406\u8fdb\u884c\uff1a \u4e0b\u56fe\u5219\u662f Istio \u6bcf\u4e2a\u5e73\u9762\u7684\u4e0d\u540c\u7ec4\u4ef6\u7684\u67b6\u6784\uff1a 3-1 Envoy Istio \u9ed8\u8ba4\u4f7f\u7528 Envoy \u4ee3\u7406\u7684\u6269\u5c55\u7248\u672c\uff0cEnvoy \u662f\u7528 C++ \u5f00\u53d1\u7684\u9ad8\u6027\u80fd\u4ee3\u7406\uff0c\u7528\u4e8e\u534f\u8c03\u670d\u52a1\u7f51\u683c\u4e2d\u6240\u6709\u670d\u52a1\u7684\u5165\u7ad9\u548c\u51fa\u7ad9\u6d41\u91cf\u3002Envoy \u4ee3\u7406\u662f\u552f\u4e00\u4e0e\u6570\u636e\u5e73\u9762\u6d41\u91cf\u4ea4\u4e92\u7684 Istio \u7ec4\u4ef6\u3002 Envoy \u4ee3\u7406\u88ab\u90e8\u7f72\u4e3a\u670d\u52a1\u7684 Sidecar\uff0c\u5728\u903b\u8f91\u4e0a\u4e3a\u670d\u52a1\u589e\u52a0\u4e86 Envoy \u7684\u8bb8\u591a\u5185\u7f6e\u7279\u6027\uff0c\u4f8b\u5982\uff1a \u52a8\u6001\u670d\u52a1\u53d1\u73b0 \u8d1f\u8f7d\u5747\u8861 TLS \u6821\u9a8c HTTP/2 \u4e0e gRPC \u4ee3\u7406 \u7194\u65ad\u5668 \u5065\u5eb7\u68c0\u67e5 \u57fa\u4e8e\u767e\u5206\u6bd4\u6d41\u91cf\u5206\u5272\u7684\u5206\u9636\u6bb5\u53d1\u5e03 \u6545\u969c\u6ce8\u5165 \u4e30\u5bcc\u7684\u6307\u6807 \u8fd9\u79cd Sidecar \u90e8\u7f72\u5141\u8bb8 Istio \u53ef\u4ee5\u6267\u884c\u7b56\u7565\u51b3\u7b56\uff0c\u5e76\u63d0\u53d6\u4e30\u5bcc\u7684\u9065\u6d4b\u6570\u636e\uff0c\u63a5\u7740\u5c06\u8fd9\u4e9b\u6570\u636e\u53d1\u9001\u5230\u76d1\u89c6\u7cfb\u7edf\u4ee5\u63d0\u4f9b\u6709\u5173\u6574\u4e2a\u7f51\u683c\u884c\u4e3a\u7684\u4fe1\u606f\u3002 Sidecar \u4ee3\u7406\u6a21\u578b\u8fd8\u5141\u8bb8\u4f60\u5411\u73b0\u6709\u7684\u5e94\u7528\u6dfb\u52a0 Istio \u529f\u80fd\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u8bbe\u8ba1\u67b6\u6784\u6216\u91cd\u5199\u4ee3\u7801\u3002 \u7531 Envoy \u4ee3\u7406\u542f\u7528\u7684\u4e00\u4e9b Istio \u7684\u529f\u80fd\u548c\u4efb\u52a1\u5305\u62ec\uff1a \u6d41\u91cf\u63a7\u5236\u529f\u80fd \uff1a\u901a\u8fc7\u4e30\u5bcc\u7684 HTTP\u3001gRPC\u3001WebSocket \u548c TCP \u6d41\u91cf\u8def\u7531\u89c4\u5219\u6765\u6267\u884c\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u63a7\u5236\u3002 \u7f51\u7edc\u5f39\u6027\u7279\u6027\uff1a\u91cd\u8bd5\u8bbe\u7f6e\u3001\u6545\u969c\u8f6c\u79fb\u3001\u7194\u65ad\u5668\u548c\u6545\u969c\u6ce8\u5165 \u3002 \u5b89\u5168\u6027\u548c\u8eab\u4efd\u8ba4\u8bc1\u7279\u6027 \uff1a\u6267\u884c\u5b89\u5168\u6027\u7b56\u7565\uff0c\u5e76\u5f3a\u5236\u5b9e\u884c\u901a\u8fc7\u914d\u7f6e API \u5b9a\u4e49\u7684\u8bbf\u95ee\u63a7\u5236\u548c\u901f\u7387\u9650\u5236\u3002 \u57fa\u4e8e WebAssembly \u7684\u53ef\u63d2\u62d4\u6269\u5c55\u6a21\u578b\uff0c\u5141\u8bb8\u901a\u8fc7\u81ea\u5b9a\u4e49\u7b56\u7565\u6267\u884c\u548c\u751f\u6210\u7f51\u683c\u6d41\u91cf\u7684\u9065\u6d4b \u3002 3-2 Istiod \u7ec4\u4ef6 Istiod \u63d0\u4f9b \u670d\u52a1\u53d1\u73b0\u3001\u914d\u7f6e\u548c\u8bc1\u4e66\u7ba1\u7406 \u3002 Istiod \u5c06\u63a7\u5236\u6d41\u91cf\u884c\u4e3a\u7684\u9ad8\u7ea7\u8def\u7531\u89c4\u5219\u8f6c\u6362\u4e3a Envoy \u7279\u5b9a\u7684\u914d\u7f6e\uff0c\u5e76\u5728\u8fd0\u884c\u65f6\u5c06\u5176\u4f20\u64ad\u7ed9 Sidecar\u3002 Pilot \u63d0\u53d6\u4e86\u7279\u5b9a\u5e73\u53f0\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\uff0c\u5e76\u5c06\u5176\u914d\u7f6e\u4e3a\u4e00\u79cd\u6807\u51c6\u683c\u5f0f\uff0c\u4efb\u4f55\u7b26\u5408 Envoy API \u7684 Sidecar \u90fd\u53ef\u4ee5\u4f7f\u7528\u3002 Istio \u53ef\u4ee5\u652f\u6301\u53d1\u73b0\u591a\u79cd\u73af\u5883\uff0c\u5982 Kubernetes \u6216 VM\u3002 \u4f60\u53ef\u4ee5\u4f7f\u7528 Istio \u6d41\u91cf\u7ba1\u7406 API \u8ba9 Istiod \u91cd\u65b0\u6784\u9020 Envoy \u7684\u914d\u7f6e\uff0c\u4ee5\u4fbf\u5bf9\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\u8fdb\u884c\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\u3002 Istiod \u901a\u8fc7\u5185\u7f6e\u7684\u8eab\u4efd\u548c\u51ed\u8bc1\u7ba1\u7406\u8fdb\u884c\u5b89\u5168\u7ba1\u7406\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Istio \u6765\u5347\u7ea7\u670d\u52a1\u7f51\u683c\u4e2d\u672a\u52a0\u5bc6\u7684\u6d41\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528 Istio \u7684\u6388\u6743\u529f\u80fd\u63a7\u5236\u8c01\u53ef\u4ee5\u8bbf\u95ee\u4f60\u7684\u670d\u52a1\u3002 Istiod \u5145\u5f53\u8bc1\u4e66\u6388\u6743\uff08CA\uff09\uff0c\u5e76\u751f\u6210\u8bc1\u4e66\u4ee5\u5141\u8bb8\u5728\u6570\u636e\u5e73\u9762\u4e2d\u8fdb\u884c\u5b89\u5168\u7684 mTLS \u901a\u4fe1 \u3002 4\u3001\u5b89\u88c5 \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4ecb\u7ecd\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5 Istio\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u662f\u6700\u65b0\u7684 1.10.3 \u7248\u672c\u3002 \u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u4e0b\u8f7d\u6307\u5b9a\u7684 1.10.3 \u7248\u672c\u7684 Istio\uff1a ~ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh - $ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh - % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 102 100 102 0 0 41 0 0:00:02 0:00:02 --:--:-- 41 100 4573 100 4573 0 0 994 0 0:00:04 0:00:04 --:--:-- 4191 Downloading istio-1.10.3 from https://github.com/istio/istio/releases/download/1.10.3/istio-1.10.3-osx.tar.gz ... Istio 1.10.3 Download Complete! Istio has been successfully downloaded into the istio-1.10.3 folder on your system. Next Steps: See https://istio.io/latest/docs/setup/install/ to add Istio to your Kubernetes cluster. To configure the istioctl client tool for your workstation, add the /Users/i515190/k8s_test/istio/istio-1.10.3/bin directory to your environment path variable with: export PATH=\"$PATH:/Users/i515190/k8s_test/istio/istio-1.10.3/bin\" Begin the Istio pre-installation check by running: istioctl x precheck Need more information? Visit https://istio.io/latest/docs/setup/install/ \u5982\u679c\u5b89\u88c5\u5931\u8d25\uff0c\u53ef\u4ee5\u7528\u624b\u52a8\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\uff0c\u5728 GitHub Release \u9875\u9762\u83b7\u53d6\u5bf9\u5e94\u7cfb\u7edf\u7684\u4e0b\u8f7d\u5730\u5740\uff1a # \u6ce8\u610f\u9009\u62e9\u548c\u81ea\u5df1\u64cd\u4f5c\u7cfb\u7edf\u5339\u914d\u7684\u6587\u4ef6 \u279c ~ wget https://github.com/istio/istio/releases/download/1.10.3/istio-1.10.3-linux-amd64.tar.gz \u279c ~ tar -xzf istioctl-1.10.3-linux-amd64.tar.gz # \u8fdb\u5165\u5230 istio \u89e3\u538b\u7684\u76ee\u5f55 \u279c ~ cd istio-1.10.3 && ls -la total 48 drwxr-x---@ 9 ych staff 288 Jul 15 13:32 . drwx---r-x@ 482 ych staff 15424 Jul 20 14:17 .. -rw-r--r--@ 1 ych staff 11348 Jul 15 13:32 LICENSE -rw-r--r--@ 1 ych staff 5866 Jul 15 13:32 README.md drwxr-x---@ 3 ych staff 96 Jul 15 13:32 bin -rw-r-----@ 1 ych staff 854 Jul 15 13:32 manifest.yaml drwxr-xr-x@ 5 ych staff 160 Jul 15 13:32 manifests drwxr-xr-x@ 21 ych staff 672 Jul 15 13:32 samples drwxr-xr-x@ 5 ych staff 160 Jul 15 13:32 tools \u5176\u4e2d samples/ \u76ee\u5f55\u4e0b\u9762\u662f\u4e00\u4e9b\u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\uff0c bin/ \u76ee\u5f55\u4e0b\u9762\u7684 istioctl \u662f Istio \u7684 CLI \u5de5\u5177\uff0c\u53ef\u4ee5\u5c06\u8be5 bin/ \u76ee\u5f55\u52a0\u5165\u5230 PATH \u8def\u5f84\u4e4b\u4e0b\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u62f7\u8d1d\u5230\u67d0\u4e2a PATH \u76ee\u5f55\u4e0b\u53bb\uff1a $ cd istio-1.10.3 $ sudo cp bin/istioctl /usr/local/bin/istioctl $ istioctl version no running Istio pods in \"istio-system\" 1.10.3 \u5b89\u88c5 istio \u7684\u5de5\u5177\u548c\u6587\u4ef6\u51c6\u5907\u597d\u8fc7\u540e\uff0c\u76f4\u63a5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u5b89\u88c5\u547d\u4ee4\u5373\u53ef\uff0c\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u7684\u662f demo \u914d\u7f6e\u7ec4\u5408\u7684\u5f62\u5f0f\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u5305\u542b\u4e86\u4e00\u7ec4\u4e13\u4e3a\u6d4b\u8bd5\u51c6\u5907\u7684\u529f\u80fd\u96c6\u5408\uff0c\u53e6\u5916\u8fd8\u6709\u7528\u4e8e\u751f\u4ea7\u6216\u6027\u80fd\u6d4b\u8bd5\u7684\u914d\u7f6e\u7ec4\u5408\u3002 $ istioctl install --set profile=demo -y \u2714 Istio core installed \u2714 Istiod installed \u2714 Ingress gateways installed \u2714 Egress gateways installed \u2714 Installation complete Thank you for installing Istio 1.10. Please take a few minutes to tell us about your install/upgrade experience! https://forms.gle /KjkrDnMPByq7akrYA \u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 Pod \u8fd0\u884c\u72b6\u6001\uff1a $ kubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE istio-egressgateway-5547fcc8fc-flqkt 1/1 Running 0 3m6s istio-ingressgateway-8f568d595-hsm6l 1/1 Running 0 3m6s istiod-568d797f55-56vg9 1/1 Running 0 4m48s \u5982\u679c\u90fd\u662f Running \u72b6\u6001\u8bc1\u660e istio \u5c31\u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002\u7136\u540e\u6211\u4eec\u8fd8\u53ef\u4ee5\u7ed9 namespace \u6dfb\u52a0\u4e00\u4e2a isito-injection=enabled \u7684 label \u6807\u7b7e\uff0c\u6307\u793a Istio \u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u81ea\u52a8\u6ce8\u5165 Envoy Sidecar \u4ee3\u7406\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u7ed9 default \u547d\u540d\u7a7a\u95f4\u6ce8\u5165\u81ea\u52a8\u6807\u7b7e\uff1a $ kubectl label namespace default istio-injection=enabled namespace/default labeled 4\u3001\u90e8\u7f72\u793a\u4f8b\u5e94\u7528 \u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6765\u5b89\u88c5\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u975e\u5e38\u7ecf\u5178\u7684 Bookinfo \u5e94\u7528\u793a\u4f8b\uff0c\u8fd9\u4e2a\u793a\u4f8b\u90e8\u7f72\u4e86\u4e00\u4e2a\u7528\u4e8e\u6f14\u793a\u591a\u79cd Istio \u7279\u6027\u7684\u5e94\u7528\uff0c\u8be5\u5e94\u7528\u7531\u56db\u4e2a\u5355\u72ec\u7684\u5fae\u670d\u52a1\u6784\u6210\uff0c\u8fd9\u4e2a\u5e94\u7528\u6a21\u4eff\u5728\u7ebf\u4e66\u5e97\u7684\u4e00\u4e2a\u5206\u7c7b\uff0c\u663e\u793a\u4e00\u672c\u4e66\u7684\u4fe1\u606f\u3002\u9875\u9762\u4e0a\u4f1a\u663e\u793a\u4e00\u672c\u4e66\u7684\u63cf\u8ff0\u3001\u4e66\u7c4d\u7684 ISBN\u3001\u9875\u6570\u7b49\u4fe1\u606f\uff0c\u4ee5\u53ca\u5173\u4e8e\u8fd9\u672c\u4e66\u7684\u4e00\u4e9b\u8bc4\u8bba\u3002 Bookinfo \u5e94\u7528\u5206\u4e3a\u56db\u4e2a\u5355\u72ec\u7684\u5fae\u670d\u52a1\uff1a productpage\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4f1a\u8c03\u7528 details \u548c reviews \u4e24\u4e2a\u5fae\u670d\u52a1\uff0c\u7528\u6765\u751f\u6210\u9875\u9762\u3002 details\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u4e66\u7c4d\u7684\u4fe1\u606f\u3002 reviews\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u4e66\u7c4d\u76f8\u5173\u7684\u8bc4\u8bba\uff0c\u5b83\u8fd8\u4f1a\u8c03\u7528 ratings \u5fae\u670d\u52a1\u3002 ratings\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u7531\u4e66\u7c4d\u8bc4\u4ef7\u7ec4\u6210\u7684\u8bc4\u7ea7\u4fe1\u606f\u3002 reviews \u5fae\u670d\u52a1\u6709 3 \u4e2a\u7248\u672c\uff1a v1 \u7248\u672c\u4e0d\u4f1a\u8c03\u7528 ratings \u670d\u52a1\u3002 v2 \u7248\u672c\u4f1a\u8c03\u7528 ratings \u670d\u52a1\uff0c\u5e76\u4f7f\u7528 1 \u5230 5 \u4e2a\u9ed1\u8272\u661f\u5f62\u56fe\u6807\u6765\u663e\u793a\u8bc4\u5206\u4fe1\u606f \u3002 v3 \u7248\u672c\u4f1a\u8c03\u7528 ratings \u670d\u52a1\uff0c\u5e76\u4f7f\u7528 1 \u5230 5 \u4e2a\u7ea2\u8272\u661f\u5f62\u56fe\u6807\u6765\u663e\u793a\u8bc4\u5206\u4fe1\u606f \u3002 \u4e0b\u56fe\u53ef\u4ee5\u7528\u6765\u8bf4\u660e\u6211\u4eec\u8fd9\u4e2a\u793a\u4f8b\u5e94\u7528\u7684\u6574\u4f53\u67b6\u6784\uff1a Bookinfo \u5e94\u7528\u4e2d\u7684\u51e0\u4e2a\u5fae\u670d\u52a1\u662f\u7531\u4e0d\u540c\u7684\u8bed\u8a00\u7f16\u5199\u800c\u6210\u7684\uff0c\u8fd9\u4e9b\u670d\u52a1\u5bf9 Istio \u5e76\u65e0\u4f9d\u8d56\uff0c\u4f46\u662f\u6784\u6210\u4e86\u4e00\u4e2a\u6709\u4ee3\u8868\u6027\u7684\u670d\u52a1\u7f51\u683c\u7684\u4f8b\u5b50\uff1a\u5b83\u7531\u591a\u4e2a\u670d\u52a1\u3001\u591a\u4e2a\u8bed\u8a00\u6784\u6210\uff0c\u5e76\u4e14 reviews \u670d\u52a1\u5177\u6709\u591a\u4e2a\u7248\u672c\u3002 \u6211\u4eec\u8981\u5728 Istio \u4e2d\u8fd0\u884c\u8fd9\u4e2a\u5e94\u7528\uff0c\u4e0d\u9700\u8981\u5bf9\u5e94\u7528\u672c\u8eab\u505a\u4efb\u4f55\u6539\u53d8\uff0c\u53ea\u8981\u7b80\u5355\u7684\u5728 Istio \u73af\u5883\u4e2d\u5bf9\u670d\u52a1\u8fdb\u884c\u914d\u7f6e\u548c\u8fd0\u884c\uff0c\u4e5f\u5c31\u662f\u628a Envoy sidecar \u6ce8\u5165\u5230\u6bcf\u4e2a\u670d\u52a1\u4e4b\u4e2d\u3002\u6700\u7ec8\u7684\u90e8\u7f72\u7ed3\u679c\u5c06\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u6240\u6709\u7684\u5fae\u670d\u52a1\u90fd\u548c Envoy sidecar \u96c6\u6210\u5728\u4e00\u8d77\uff0c\u88ab\u96c6\u6210\u670d\u52a1\u6240\u6709\u7684\u51fa\u5165\u6d41\u91cf\u90fd\u88ab sidecar \u6240\u52ab\u6301\uff0c\u8fd9\u6837\u5c31\u4e3a\u5916\u90e8\u63a7\u5236\u51c6\u5907\u4e86\u6240\u9700\u7684 Hook\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u5229\u7528 Istio \u63a7\u5236\u5e73\u9762\u4e3a\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\u8def\u7531\u3001\u9065\u6d4b\u6570\u636e\u6536\u96c6\u4ee5\u53ca\u7b56\u7565\u5b9e\u65bd\u7b49\u529f\u80fd\u3002 \u8fdb\u5165\u4e0a\u9762\u7684 Istio \u5b89\u88c5\u76ee\u5f55\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a $ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml service/details created serviceaccount/bookinfo-details created deployment.apps/details-v1 created service/ratings created serviceaccount/bookinfo-ratings created deployment.apps/ratings-v1 created service/reviews created serviceaccount/bookinfo-reviews created deployment.apps/reviews-v1 created deployment.apps/reviews-v2 created deployment.apps/reviews-v3 created service/productpage created serviceaccount/bookinfo-productpage created deployment.apps/productpage-v1 created \u5982\u679c\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u7981\u7528\u4e86 Sidecar \u81ea\u52a8\u6ce8\u5165\u529f\u80fd\u800c\u9009\u62e9\u624b\u52a8\u6ce8\u5165 Sidecar\uff0c\u8bf7\u5728\u90e8\u7f72\u5e94\u7528\u4e4b\u524d\u53ef\u4ee5\u4f7f\u7528 istioctl kube-inject \u547d\u4ee4\u6765\u6ce8\u5165 sidecar \u5bb9\u5668\u3002 $ kubectl apply -f <(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml) \u8fd9\u91cc\u6211\u4eec\u90e8\u7f72\u7684 bookinfo.yaml \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5c31\u662f\u666e\u901a\u7684 Kubernetes \u7684 Deployment \u548c Service \u7684 yaml \u6587\u4ef6\uff0c\u4f7f\u7528 istioctl kube-inject \u6216\u8005\u914d\u7f6e\u81ea\u52a8\u6ce8\u5165\u540e\u4f1a\u5728\u8fd9\u4e2a\u6587\u4ef6\u7684\u57fa\u7840\u4e0a\u5411\u5176\u4e2d\u7684 Deployment \u8ffd\u52a0\u4e00\u4e2a\u955c\u50cf\u4e3a docker.io/istio/proxyv2:1.10.3 \u7684 sidecar \u5bb9\u5668\uff0c\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u542f\u52a8\u5168\u90e8\u7684\u56db\u4e2a\u670d\u52a1\uff0c\u5176\u4e2d\u4e5f\u5305\u62ec\u4e86 reviews \u670d\u52a1\u7684\u4e09\u4e2a\u7248\u672c\uff08v1\u3001v2 \u4ee5\u53ca v3\uff09\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE details-v1-79f774bdb9-bxgnv 2/2 Running 0 7m3s productpage-v1-6b746f74dc-drxqj 2/2 Running 0 7m3s ratings-v1-b6994bb9-62nrz 2/2 Running 0 7m3s reviews-v1-545db77b95-lgcjt 2/2 Running 0 7m3s reviews-v2-7bf8c9648f-mlfb7 2/2 Running 0 7m3s reviews-v3-84779c7bbc-fnqbg 2/2 Running 0 7m3s $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE details ClusterIP 10.110.179.156 <none> 9080/TCP 7m7s kubernetes ClusterIP 10.96.0.1 <none> 443/TCP 20h productpage ClusterIP 10.96.138.142 <none> 9080/TCP 7m7s ratings ClusterIP 10.102.119.192 <none> 9080/TCP 7m7s reviews ClusterIP 10.102.66.198 <none> 9080/TCP 7m7s \u73b0\u5728\u5e94\u7528\u7684\u670d\u52a1\u90fd\u90e8\u7f72\u6210\u529f\u5e76\u542f\u52a8\u4e86\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\uff0c\u5c31\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a istio gateway\uff0cgateway \u76f8\u5f53\u4e8e k8s \u7684 ingress controller \u548c ingress\uff0c\u5b83\u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\uff0c\u901a\u5e38\u5728\u670d\u52a1\u7f51\u683c\u8fb9\u7f18\u4f5c\u4e3a\u5e94\u7528\u7684 ingress \u6d41\u91cf\u7ba1\u7406\u3002 \u521b\u5efa\u4e00\u4e2a Ingress gateway: $ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml gateway.networking.istio.io/bookinfo-gateway created virtualservice.networking.istio.io/bookinfo created \u9a8c\u8bc1 gateway \u662f\u5426\u521b\u5efa\u6210\u529f: $ kubectl get gateway NAME AGE bookinfo-gateway 72s \u8981\u60f3\u8bbf\u95ee\u8fd9\u4e2a\u5e94\u7528\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u66f4\u6539\u4e0b istio \u63d0\u4f9b\u7684 istio-ingressgateway \u8fd9\u4e2a Service \u5bf9\u8c61\uff0c\u9ed8\u8ba4\u662f LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff1a $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-egressgateway ClusterIP 10.101.179.89 <none> 80/TCP,443/TCP 3h16m istio-ingressgateway LoadBalancer 10.99.72.32 localhost 15021:32556/TCP,80:31102/TCP,443:30657/TCP,31400:32719/TCP,15443 :31978/TCP 3h16m istiod ClusterIP 10.107.4.189 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP 3h18m LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u5b9e\u9645\u4e0a\u662f\u7528\u6765\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\uff0c\u5982\u679c\u6211\u4eec\u6ca1\u6709\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\u8bdd\uff0c \u53ef\u4ee5\u5c06\u8fd9\u91cc\u7c7b\u578b\u6539\u6210 NodePort\uff0c\u4f46\u662f\u8fd9\u6837\u5f53\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u7684\u65f6\u5019\u5c31\u9700\u8981\u52a0\u4e0a nodePort \u7aef\u53e3\u4e86 \uff1a $ kubectl edit svc istio-ingressgateway -n istio-system service/istio-ingressgateway edited ...... type: NodePort # \u4fee\u6539\u6210 NodePort \u7c7b\u578b status: loadBalancer: {} $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-egressgateway ClusterIP 10.101.179.89 <none> 80/TCP,443/TCP 3h20m istio-ingressgateway NodePort 10.99.72.32 <none> 15021:32556/TCP,80:31102/TCP,443:30657/TCP,31400:32719/TCP,15443:31 978/TCP 3h20m istiod ClusterIP 10.107.4.189 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP 3h22m \u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 http://<NodeIP>:<nodePort>/productpage \u4ece\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee Bookinfo \u5e94\u7528\u4e86\uff1a http://127.0.0.1:31102/productpage \u5237\u65b0\u9875\u9762\u53ef\u4ee5\u770b\u5230 Book Reviews \u53d1\u751f\u4e86\u6539\u53d8\uff08\u7ea2\u8272\u3001\u9ed1\u8272\u7684\u661f\u5f62\u6216\u8005\u6ca1\u6709\u663e\u793a\uff09\uff0c\u56e0\u4e3a\u6bcf\u6b21\u8bf7\u6c42\u4f1a\u88ab\u8def\u7531\u5230\u5230\u4e86\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\u53bb\u3002 5\u3001\u4eea\u8868\u76d8 \u4e0a\u9762\u6211\u4eec\u662f\u5b89\u88c5\u7684 Istio \u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u6b64\u5916 Istio \u8fd8\u548c\u4e00\u4e9b\u9065\u6d4b\u5e94\u7528\u505a\u4e86\u96c6\u6210\uff0c\u9065\u6d4b\u80fd\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u670d\u52a1\u7f51\u683c\u7684\u7ed3\u6784\u3001\u5c55\u793a\u7f51\u7edc\u7684\u62d3\u6251\u7ed3\u6784\u3001\u5206\u6790\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u6001\u7b49\uff0c\u5bf9\u4e8e\u5206\u5e03\u5f0f\u5fae\u670d\u52a1\u5e94\u7528\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u90e8\u7f72 Kiali\u3001Prometheus\u3001Grafana \u4ee5\u53ca Jaeger\uff1a kubectl apply -f samples/addons # \u5982\u679c\u51fa\u73b0\u4e86\u9519\u8bef\uff0c\u5219\u53ef\u4ee5\u91cd\u65b0\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4 $ kubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE grafana-f766d6c97-4888w 1/1 Running 0 3m57s istio-egressgateway-5c8d96c9b5-6d5g9 1/1 Running 0 60m istio-ingressgateway-6bcfd457f9-wpj7w 1/1 Running 0 60m istiod-775bcf58f7-v6jl2 1/1 Running 0 61m jaeger-7f78b6fb65-bj8pm 1/1 Running 0 3m56s kiali-85c8cdd5b5-b5zv4 1/1 Running 0 3m55s prometheus-54b5dcf6bf-wjkpl 3/3 Running 0 3m48s \u4e0a\u9762\u51e0\u4e2a\u7ec4\u4ef6\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u524d\u9762 Bookinfo \u793a\u4f8b\u5e94\u7528\u7684\u9065\u6d4b\u4fe1\u606f\u4e86\uff0c\u6bd4\u5982\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8bbf\u95ee Kiali\uff1a istioctl dashboard kiali \u5728\u5de6\u4fa7\u7684\u5bfc\u822a\u83dc\u5355\uff0c\u9009\u62e9 Graph \uff0c\u7136\u540e\u5728 Namespace \u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9009\u62e9 default \u3002Kiali \u4eea\u8868\u677f\u5c55\u793a\u4e86\u7f51\u683c\u7684\u6982\u89c8\u3001\u4ee5\u53ca Bookinfo \u793a\u4f8b\u5e94\u7528\u7684\u5404\u4e2a\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u5b83\u8fd8\u63d0\u4f9b\u8fc7\u6ee4\u5668\u6765\u53ef\u89c6\u5316\u6d41\u91cf\u7684\u6d41\u52a8\u3002 \u81f3\u6b64\uff0c\u6574\u4e2a Istio \u548c Bookinfo \u793a\u4f8b\u5e94\u7528\u5c31\u5b89\u88c5\u5e76\u9a8c\u8bc1\u6210\u529f\u4e86\uff0c\u73b0\u5728\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e00\u5e94\u7528\u6765\u4f53\u9a8c Istio \u7684\u7279\u6027\u4e86\uff0c\u5176\u4e2d\u5305\u62ec\u4e86\u6d41\u91cf\u7684\u8def\u7531\u3001\u9519\u8bef\u6ce8\u5165\u3001\u901f\u7387\u9650\u5236\u7b49\u7279\u6027\u3002 \u76ee\u524d\u642d\u5efa Bookinfo \u5e94\u7528\u6211\u4eec\u53ea\u7528\u5230\u4e86\u4e0b\u9762\u4e24\u4e2a\u8d44\u6e90\u6587\u4ef6\uff1a samples/bookinfo/platform/kube/bookinfo.yaml samples/bookinfo/networking/bookinfo-gateway.yaml \u524d\u8005\u5c31\u662f\u901a\u5e38\u7684 Kubernetes \u5b9a\u4e49\u7684 Deployment \u548c Service \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u53ea\u662f\u5728\u90e8\u7f72\u65f6\u4f7f\u7528 istioctl kube-inject \uff08\u6216\u8005\u901a\u8fc7\u5bf9\u547d\u540d\u7a7a\u95f4\u6253\u4e0a\u81ea\u52a8\u6ce8\u5165\u7684\u6807\u7b7e\uff09\u5bf9\u8fd9\u4e2a\u6587\u4ef6\u5b9a\u4e49\u7684 Pod \u6ce8\u5165\u4e86 sidecar \u4ee3\u7406\uff0c\u540e\u8005\u5b9a\u4e49\u4e86\u8fd9\u4e2a\u5e94\u7528\u7684\u5916\u90e8\u8bbf\u95ee\u5165\u53e3 gateway\uff0c\u4ee5\u53ca\u5e94\u7528\u5185\u90e8 productpage \u670d\u52a1\u7684 VirtualService \u89c4\u5219\uff0c\u800c\u5176\u4ed6\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fd8\u6ca1\u6709\u88ab\u5b9a\u4e49\u3002 \u73b0\u5728\u8bbf\u95ee\u5e94\u7528\u754c\u9762\u5e76\u5237\u65b0\uff0c\u4f1a\u770b\u5230 Reviews \u6709\u65f6\u4e0d\u4f1a\u663e\u793a\u8bc4\u5206\uff0c\u6709\u65f6\u5019\u4f1a\u663e\u793a\u4e0d\u540c\u6837\u5f0f\u7684\u8bc4\u5206\uff0c\u8fd9\u662f\u56e0\u4e3a\u540e\u9762\u67093\u4e2a\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\uff0c\u800c\u6ca1\u6709\u914d\u7f6e\u8be5\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\u7684\u60c5\u51b5\u4e0b\uff0c\u8be5\u670d\u52a1\u7684\u51e0\u4e2a\u5b9e\u4f8b\u4f1a\u88ab\u968f\u673a\u8bbf\u95ee\u5230\uff0c\u6709\u7684\u7248\u672c\u670d\u52a1\u4f1a\u8fdb\u4e00\u6b65\u8c03\u7528 Ratings \u670d\u52a1\uff0c\u6709\u7684\u4e0d\u4f1a\u3002","title":"\u7b2c\u4e00\u8282 2021 Service Mesh & Istio \u4ecb\u7ecd/\u5b89\u88c5(1.10.3)"},{"location":"chap4/1Istio_Intro/#2021-service-mesh-istio-1103","text":"\u73b0\u5728\u6700\u706b\u7684\u540e\u7aef\u67b6\u6784\u65e0\u7591\u662f\u5fae\u670d\u52a1\u4e86\uff0c\u5fae\u670d\u52a1\u5c06\u4e4b\u524d\u7684\u5355\u4f53\u5e94\u7528\u62c6\u5206\u6210\u4e86\u8bb8\u591a\u72ec\u7acb\u7684\u670d\u52a1\u5e94\u7528\uff0c\u6bcf\u4e2a\u5fae\u670d\u52a1\u90fd\u662f\u72ec\u7acb\u7684\uff0c\u597d\u5904\u81ea\u7136\u5f88\u591a\uff0c\u4f46\u662f\u968f\u7740\u5e94\u7528\u7684\u8d8a\u6765\u8d8a\u5927\uff0c\u5fae\u670d\u52a1\u66b4\u9732\u51fa\u6765\u7684\u95ee\u9898\u4e5f\u5c31\u968f\u4e4b\u800c\u6765\u4e86\uff0c\u5fae\u670d\u52a1\u8d8a\u6765\u8d8a\u591a\uff0c\u7ba1\u7406\u8d8a\u6765\u8d8a\u9ebb\u70e6\uff0c\u7279\u522b\u662f\u8981\u4f60\u90e8\u7f72\u4e00\u5957\u65b0\u73af\u5883\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u80fd\u4f53\u4f1a\u5230\u8fd9\u79cd\u75db\u82e6\u4e86\uff0c\u968f\u4e4b\u800c\u6765\u7684 \u670d\u52a1\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001Trace\u8ddf\u8e2a\u3001\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u8ba4\u8bc1\u7b49\u7b49\u95ee\u9898 \u3002 \u5982\u679c\u4ece\u5934\u5230\u5c3e\u5b8c\u6210\u8fc7\u4e00\u5957\u5fae\u670d\u52a1\u6846\u67b6\u7684\u8bdd\uff0c\u4f60\u5c31\u4f1a\u77e5\u9053\u8fd9\u91cc\u9762\u6d89\u53ca\u5230\u7684\u4e1c\u897f\u771f\u7684\u975e\u5e38\u591a\u3002\u5f53\u7136\u968f\u7740\u5fae\u670d\u52a1\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u5fae\u670d\u52a1\u7684\u751f\u6001\u4e5f\u4e0d\u65ad\u5b8c\u5584\uff0c\u6700\u8fd1\u65b0\u4e00\u4ee3\u7684\u5fae\u670d\u52a1\u5f00\u53d1\u5c31\u6084\u7136\u5174\u8d77\u4e86\uff0c\u90a3\u5c31\u662f\u670d\u52a1\u7f51\u683c/Service Mesh\u3002","title":"\u7b2c\u4e00\u8282 2021 Service Mesh &amp; Istio \u4ecb\u7ecd/\u5b89\u88c5(1.10.3)"},{"location":"chap4/1Istio_Intro/#1service-mesh","text":"Service Mesh \u662f\u4e00\u4e2a\u975e\u5e38\u65b0\u7684\u540d\u8bcd\uff0c\u6700\u65e9\u662f2016\u5e74\u7531\u5f00\u53d1 Linkerd \u7684 Buoyant \u516c\u53f8\u63d0\u51fa\u7684\uff0c\u4f34\u968f\u7740 Linkerd \u7684\u4f20\u5165\uff0c Service Mesh \u7684\u6982\u5ff5\u4e5f\u6162\u6162\u8fdb\u5165\u56fd\u5185\u6280\u672f\u793e\u533a\uff0c \u73b0\u5728\u4e3b\u6d41\u7684\u53eb\u6cd5\u90fd\u53eb\uff1a\u670d\u52a1\u7f51\u683c\u3002 \u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u7528\u4e8e\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5b83\u8d1f\u8d23\u4e3a\u6784\u5efa\u590d\u6742\u7684\u4e91\u539f\u751f\u5e94\u7528\u4f20\u9012\u53ef\u9760\u7684\u7f51\u7edc\u8bf7\u6c42\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u901a\u5e38\u5b9e\u73b0\u4e3a\u4e00\u7ec4\u548c\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5728\u4e00\u8d77\u7684\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\uff0c\u4f46\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u662f\u900f\u660e\u7684\u3002 \u8981\u7406\u89e3\u7f51\u683c\u7684\u6982\u5ff5\uff0c\u5c31\u5f97\u4ece\u670d\u52a1\u7684\u90e8\u7f72\u6a21\u578b\u8bf4\u8d77\uff1a","title":"1\u3001\u4ec0\u4e48\u662fService Mesh\uff1f"},{"location":"chap4/1Istio_Intro/#1-1-sidecar","text":"\u5355\u4e2a\u670d\u52a1\u8c03\u7528 Service Mesh \u7684\u90e8\u7f72\u6a21\u578b\uff0c\u5148\u770b\u5355\u4e2a\u7684\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7b80\u5355\u8bf7\u6c42\uff0c\u4f5c\u4e3a\u8bf7\u6c42\u53d1\u8d77\u8005\u7684\u5ba2\u6237\u7aef\u5e94\u7528\u5b9e\u4f8b\uff0c\u4f1a\u9996\u5148\u7528\u7b80\u5355\u65b9\u5f0f\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u672c\u5730\u7684 Service Mesh \u5b9e\u4f8b\u3002 \u8fd9\u662f\u4e24\u4e2a\u72ec\u7acb\u8fdb\u7a0b\uff0c\u4ed6\u4eec\u4e4b\u95f4\u662f\u8fdc\u7a0b\u8c03\u7528\u3002 Service Mesh \u4f1a\u5b8c\u6210\u5b8c\u6574\u7684\u670d\u52a1\u95f4\u8c03\u7528\u6d41\u7a0b\uff0c\u5982\u670d\u52a1\u53d1\u73b0\u8d1f\u8f7d\u5747\u8861\uff0c\u6700\u540e\u5c06\u8bf7\u6c42\u53d1\u9001\u7ed9\u76ee\u6807\u670d\u52a1\uff0c\u8fd9\u8868\u73b0\u4e3a Sidecar \u65b9\u5f0f\u3002","title":"1-1 \u5355\u4e2a\u670d\u52a1\u8c03\u7528\uff0c\u8868\u73b0\u4e3asidecar"},{"location":"chap4/1Istio_Intro/#1-2","text":"\u591a\u4e2a\u670d\u52a1\u8c03\u7528\u7684\u60c5\u51b5\uff0c\u5728\u8fd9\u4e2a\u56fe\u4e0a\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Service Mesh \u5728\u6240\u6709\u7684\u670d\u52a1\u7684\u4e0b\u9762\uff0c\u8fd9\u4e00\u5c42\u88ab\u79f0\u4e4b\u4e3a\u670d\u52a1\u95f4\u901a\u8baf\u4e13\u7528\u57fa\u7840\u8bbe\u65bd\u5c42\u3002 Service Mesh \u4f1a\u63a5\u7ba1\u6574\u4e2a\u7f51\u7edc\uff0c\u628a\u6240\u6709\u7684\u8bf7\u6c42\u5728\u670d\u52a1\u4e4b\u95f4\u505a\u8f6c\u53d1\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4e0a\u9762\u7684\u670d\u52a1\u4e0d\u518d\u8d1f\u8d23\u4f20\u9012\u8bf7\u6c42\u7684\u5177\u4f53\u903b\u8f91\uff0c\u53ea\u8d1f\u8d23\u5b8c\u6210\u4e1a\u52a1\u5904\u7406\u3002\u670d\u52a1\u95f4\u901a\u8baf\u7684\u73af\u8282\u5c31\u4ece\u5e94\u7528\u91cc\u9762\u5265\u79bb\u51fa\u6765\uff0c\u5448\u73b0\u51fa\u4e00\u4e2a\u62bd\u8c61\u5c42\u3002","title":"1-2 \u90e8\u7f72\u591a\u4e2a\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u901a\u8baf\u5c42"},{"location":"chap4/1Istio_Intro/#1-3","text":"\u5982\u679c\u6709\u5927\u91cf\u7684\u670d\u52a1\uff0c\u5c31\u4f1a\u8868\u73b0\u51fa\u6765\u7f51\u683c\uff0c\u56fe\u4e2d\u5de6\u8fb9\u7eff\u8272\u65b9\u683c\u662f\u5e94\u7528\uff0c\u53f3\u8fb9\u84dd\u8272\u7684\u65b9\u6846\u662f Service Mesh\uff0c\u84dd\u8272\u4e4b\u95f4\u7684\u7ebf\u6761\u662f\u8868\u793a\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u3002Sidecar \u4e4b\u95f4\u7684\u8fde\u63a5\u5c31\u4f1a\u5f62\u6210\u4e00\u4e2a\u7f51\u7edc\uff0c\u8fd9\u4e2a\u5c31\u662f\u670d\u52a1\u7f51\u683c\u540d\u5b57\u7684\u7531\u6765\uff0c\u8fd9\u4e2a\u65f6\u5019\u4ee3\u7406\u4f53\u73b0\u51fa\u6765\u7684\u5c31\u548c\u524d\u9762\u7684 Sidecar \u4e0d\u4e00\u6837\u4e86\uff0c\u5f62\u6210\u7f51\u72b6\u3002 \u9996\u5148\u7b2c\u4e00\u4e2a\uff0c\u670d\u52a1\u7f51\u683c\u662f\u62bd\u8c61\u7684\uff0c\u5b9e\u9645\u4e0a\u662f\u62bd\u8c61\u51fa\u4e86\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u5728\u5e94\u7528\u4e4b\u5916\u3002\u5176\u6b21\uff0c\u529f\u80fd\u662f\u5b9e\u73b0\u8bf7\u6c42\u7684\u53ef\u9760\u4f20\u9012\u3002\u90e8\u7f72\u4e0a\u4f53\u73b0\u4e3a\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\u3002\u6700\u540e\u4e00\u4e2a\u5173\u952e\u8bcd\u662f\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u900f\u660e\u3002 \u5927\u5bb6\u6ce8\u610f\u770b\uff0c\u4e0a\u9762\u7684\u56fe\u4e2d\uff0c\u7f51\u7edc\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u4e0d\u662f\u7279\u522b\u660e\u663e\u3002\u4f46\u662f\u5982\u679c\u628a\u5de6\u8fb9\u7684\u5e94\u7528\u7a0b\u5e8f\u53bb\u6389\uff0c\u73b0\u5728\u53ea\u5448\u73b0\u51fa\u6765 Service Mesh \u548c\u4ed6\u4eec\u4e4b\u95f4\u7684\u8c03\u7528\uff0c\u8fd9\u4e2a\u65f6\u5019\u5173\u7cfb\u5c31\u4f1a\u7279\u522b\u6e05\u6670\uff0c\u5c31\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u7f51\u7edc\u3002 \u8fd9\u662f Service Mesh \u5b9a\u4e49\u5f53\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5173\u952e\u70b9\uff0c\u548c Sidecar \u4e0d\u76f8\u540c\u7684\u5730\u65b9\uff1a \u4e0d\u518d\u5c06\u4ee3\u7406\u89c6\u4e3a\u5355\u72ec\u7684\u7ec4\u4ef6\uff0c\u800c\u662f\u5f3a\u8c03\u7531\u8fd9\u4e9b\u4ee3\u7406\u8fde\u63a5\u800c\u5f62\u6210\u7684\u7f51\u7edc\u3002\u5728 Service Mesh \u91cc\u9762\u975e\u5e38\u5f3a\u8c03\u4ee3\u7406\u8fde\u63a5\u7ec4\u6210\u7684\u7f51\u7edc\uff0c\u800c\u4e0d\u50cf Sidecar \u90a3\u6837\u770b\u5f85\u4e2a\u4f53\u3002 \u73b0\u5728\u6211\u4eec\u57fa\u672c\u4e0a\u628a Service Mesh \u7684\u5b9a\u4e49\u4ecb\u7ecd\u6e05\u695a\u4e86\uff0c\u5927\u5bb6\u5e94\u8be5\u53ef\u4ee5\u5927\u6982\u4e86\u89e3\u4ec0\u4e48\u662f Service Mesh \u4e86\u3002\u73b0\u5728\u5b9e\u73b0 Service Mesh \u7684\u5f00\u6e90\u65b9\u6848\u6709\u5f88\u591a\uff0c\u6bd4\u5982 Linkerd\u3001Istio \u7b49\uff0c\u5f53\u7136\u76ee\u524d\u6700\u6d41\u884c\u6700\u706b\u70ed\u7684\u8fd8\u662f\u8981\u6570 Istio \u4e86\uff0c\u8bb0\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5f00\u59cb\u8bb2\u89e3 Istio \u7684\u4f7f\u7528\u3002","title":"1-3 \u6709\u5927\u91cf\u670d\u52a1\uff0c\u8868\u73b0\u4e3a\u7f51\u7edc"},{"location":"chap4/1Istio_Intro/#2istio","text":"Istio \u89e3\u51b3\u4e86\u5f00\u53d1\u4eba\u5458\u548c\u8fd0\u7ef4\u5728\u5206\u5e03\u5f0f\u6216\u5fae\u670d\u52a1\u67b6\u6784\u65b9\u9762\u9762\u4e34\u7684\u6311\u6218\uff0c\u65e0\u8bba\u662f\u4ece\u5934\u5f00\u59cb\u6784\u5efa\u8fd8\u662f\u5c06\u73b0\u6709\u5e94\u7528\u7a0b\u5e8f\u8fc1\u79fb\u5230\u4e91\u539f\u751f\u73af\u5883\u4e0b\uff0cIstio \u90fd\u53ef\u4ee5\u63d0\u4f9b\u5e2e\u52a9\u3002 \u901a\u8fc7\u5728\u90e8\u7f72\u7684\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u6dfb\u52a0\u4ee3\u7406 sidecar\uff0cIstio \u5141\u8bb8\u60a8\u5c06\u5e94\u7528\u7a0b\u5e8f\u611f\u77e5\u6d41\u91cf\u7ba1\u7406\u3001\u4ee4\u4eba\u96be\u4ee5\u7f6e\u4fe1\u7684\u53ef\u89c2\u5bdf\u6027\u548c\u5f3a\u5927\u7684\u5b89\u5168\u529f\u80fd\u7f16\u7a0b\u5230\u60a8\u7684\u7f51\u7edc\u4e2d\u3002 Istio \u662f\u4e00\u4e2a\u5f00\u6e90\u670d\u52a1\u7f51\u683c\uff0c\u5b83\u900f\u660e\u5730\u5206\u5c42\u5230\u73b0\u6709\u7684\u5206\u5e03\u5f0f\u5e94\u7528\u7a0b\u5e8f\u4e0a\u3002Istio \u5f3a\u5927\u7684\u7279\u6027\u63d0\u4f9b\u4e86\u4e00\u79cd\u7edf\u4e00\u548c\u66f4\u6709\u6548\u7684\u65b9\u5f0f\u6765\u4fdd\u62a4\u3001\u8fde\u63a5\u548c\u76d1\u89c6\u670d\u52a1\u3002 Istio \u662f\u5b9e\u73b0\u8d1f\u8f7d\u5e73\u8861\u3001\u670d\u52a1\u5230\u670d\u52a1\u8eab\u4efd\u9a8c\u8bc1\u548c\u76d1\u89c6\u7684\u8def\u5f84\u2014\u2014\u53ea\u9700\u8981\u5f88\u5c11\u6216\u4e0d\u9700\u8981\u66f4\u6539\u670d\u52a1\u4ee3\u7801\u3002\u5b83\u5f3a\u5927\u7684\u63a7\u5236\u5e73\u9762\u5e26\u6765\u4e86\u91cd\u8981\u7684\u7279\u70b9\uff0c\u5305\u62ec\uff1a \u4f7f\u7528 TLS \u52a0\u5bc6\u3001\u5f3a\u8eab\u4efd\u8ba4\u8bc1\u548c\u6388\u6743\u7684\u96c6\u7fa4\u5185\u670d\u52a1\u5230\u670d\u52a1\u7684\u5b89\u5168\u901a\u4fe1 \u81ea\u52a8\u8d1f\u8f7d\u5747\u8861\u7684 HTTP, gRPC, WebSocket\uff0c\u548c TCP \u6d41\u91cf \u901a\u8fc7\u4e30\u5bcc\u7684\u8def\u7531\u89c4\u5219\u3001\u91cd\u8bd5\u3001\u6545\u969c\u8f6c\u79fb\u548c\u6545\u969c\u6ce8\u5165\u5bf9\u6d41\u91cf\u884c\u4e3a\u8fdb\u884c\u7ec6\u7c92\u5ea6\u63a7\u5236 \u4e00\u4e2a\u53ef\u63d2\u5165\u7684\u7b56\u7565\u5c42\u548c\u914d\u7f6e API\uff0c\u652f\u6301\u8bbf\u95ee\u63a7\u5236\u3001\u901f\u7387\u9650\u5236\u548c\u914d\u989d \u5bf9\u96c6\u7fa4\u5185\u7684\u6240\u6709\u6d41\u91cf(\u5305\u62ec\u96c6\u7fa4\u5165\u53e3\u548c\u51fa\u53e3)\u8fdb\u884c\u81ea\u52a8\u5ea6\u91cf\u3001\u65e5\u5fd7\u548c\u8ddf\u8e2a Istio \u662f\u4e3a\u53ef\u6269\u5c55\u6027\u800c\u8bbe\u8ba1\u7684\uff0c\u53ef\u4ee5\u5904\u7406\u4e0d\u540c\u8303\u56f4\u7684\u90e8\u7f72\u9700\u6c42\u3002 Istio \u7684\u63a7\u5236\u5e73\u9762\u8fd0\u884c\u5728 Kubernetes \u4e0a\uff0c\u60a8\u53ef\u4ee5\u5c06\u90e8\u7f72\u5728\u8be5\u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u5230\u60a8\u7684\u7f51\u683c\u4e2d\uff0c\u5c06\u7f51\u683c\u6269\u5c55\u5230\u5176\u4ed6\u96c6\u7fa4\uff0c\u751a\u81f3\u8fde\u63a5 VM \u6216\u8fd0\u884c\u5728 Kubernetes \u4e4b\u5916\u7684\u5176\u4ed6\u7aef\u70b9\u3002","title":"2\u3001\u4ec0\u4e48\u662fIstio\uff1f"},{"location":"chap4/1Istio_Intro/#3","text":"Istio \u6709\u4e24\u4e2a\u7ec4\u6210\u90e8\u5206\uff1a \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 \u3002 \u6570\u636e\u5e73\u9762\u7531\u4e00\u7ec4\u667a\u80fd\u4ee3\u7406\uff08Envoy\uff09\u7ec4\u6210\uff0c\u88ab\u90e8\u7f72\u4e3a Sidecar\u3002\u8fd9\u4e9b\u4ee3\u7406\u8d1f\u8d23\u534f\u8c03\u548c\u63a7\u5236\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1\u3002\u5b83\u4eec\u8fd8\u6536\u96c6\u548c\u62a5\u544a\u6240\u6709\u7f51\u683c\u6d41\u91cf\u7684\u9065\u6d4b\u6570\u636e \u3002 \u670d\u52a1\u7f51\u683c\u4f7f\u7528\u4ee3\u7406\u62e6\u622a\u6240\u6709\u7684\u7f51\u7edc\u6d41\u91cf\uff0c\u5141\u8bb8\u6839\u636e\u60a8\u8bbe\u7f6e\u7684\u914d\u7f6e\u63d0\u4f9b\u5e7f\u6cdb\u7684\u5e94\u7528\u7a0b\u5e8f\u611f\u77e5\u529f\u80fd\u3002 \u4ee3\u7406\u4e0e\u60a8\u5728\u96c6\u7fa4\u4e2d\u542f\u52a8\u7684\u6bcf\u4e2a\u670d\u52a1\u4e00\u8d77\u90e8\u7f72\uff0c\u6216\u8005\u4e0e\u8fd0\u884c\u5728\u865a\u62df\u673a\u4e0a\u7684\u670d\u52a1\u4e00\u8d77\u8fd0\u884c\u3002 \u63a7\u5236\u5e73\u9762\u7ba1\u7406\u5e76\u914d\u7f6e\u4ee3\u7406\u6765\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002 \u5728\u4f7f\u7528 Istio \u4e4b\u524d\u670d\u52a1\u4e0e\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u4f7f\u7528 Istio \u4e4b\u540e\u670d\u52a1\u4e0e\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u5219\u901a\u8fc7 Envoy \u4ee3\u7406\u8fdb\u884c\uff1a \u4e0b\u56fe\u5219\u662f Istio \u6bcf\u4e2a\u5e73\u9762\u7684\u4e0d\u540c\u7ec4\u4ef6\u7684\u67b6\u6784\uff1a","title":"3\u3001\u67b6\u6784"},{"location":"chap4/1Istio_Intro/#3-1-envoy","text":"Istio \u9ed8\u8ba4\u4f7f\u7528 Envoy \u4ee3\u7406\u7684\u6269\u5c55\u7248\u672c\uff0cEnvoy \u662f\u7528 C++ \u5f00\u53d1\u7684\u9ad8\u6027\u80fd\u4ee3\u7406\uff0c\u7528\u4e8e\u534f\u8c03\u670d\u52a1\u7f51\u683c\u4e2d\u6240\u6709\u670d\u52a1\u7684\u5165\u7ad9\u548c\u51fa\u7ad9\u6d41\u91cf\u3002Envoy \u4ee3\u7406\u662f\u552f\u4e00\u4e0e\u6570\u636e\u5e73\u9762\u6d41\u91cf\u4ea4\u4e92\u7684 Istio \u7ec4\u4ef6\u3002 Envoy \u4ee3\u7406\u88ab\u90e8\u7f72\u4e3a\u670d\u52a1\u7684 Sidecar\uff0c\u5728\u903b\u8f91\u4e0a\u4e3a\u670d\u52a1\u589e\u52a0\u4e86 Envoy \u7684\u8bb8\u591a\u5185\u7f6e\u7279\u6027\uff0c\u4f8b\u5982\uff1a \u52a8\u6001\u670d\u52a1\u53d1\u73b0 \u8d1f\u8f7d\u5747\u8861 TLS \u6821\u9a8c HTTP/2 \u4e0e gRPC \u4ee3\u7406 \u7194\u65ad\u5668 \u5065\u5eb7\u68c0\u67e5 \u57fa\u4e8e\u767e\u5206\u6bd4\u6d41\u91cf\u5206\u5272\u7684\u5206\u9636\u6bb5\u53d1\u5e03 \u6545\u969c\u6ce8\u5165 \u4e30\u5bcc\u7684\u6307\u6807 \u8fd9\u79cd Sidecar \u90e8\u7f72\u5141\u8bb8 Istio \u53ef\u4ee5\u6267\u884c\u7b56\u7565\u51b3\u7b56\uff0c\u5e76\u63d0\u53d6\u4e30\u5bcc\u7684\u9065\u6d4b\u6570\u636e\uff0c\u63a5\u7740\u5c06\u8fd9\u4e9b\u6570\u636e\u53d1\u9001\u5230\u76d1\u89c6\u7cfb\u7edf\u4ee5\u63d0\u4f9b\u6709\u5173\u6574\u4e2a\u7f51\u683c\u884c\u4e3a\u7684\u4fe1\u606f\u3002 Sidecar \u4ee3\u7406\u6a21\u578b\u8fd8\u5141\u8bb8\u4f60\u5411\u73b0\u6709\u7684\u5e94\u7528\u6dfb\u52a0 Istio \u529f\u80fd\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u8bbe\u8ba1\u67b6\u6784\u6216\u91cd\u5199\u4ee3\u7801\u3002 \u7531 Envoy \u4ee3\u7406\u542f\u7528\u7684\u4e00\u4e9b Istio \u7684\u529f\u80fd\u548c\u4efb\u52a1\u5305\u62ec\uff1a \u6d41\u91cf\u63a7\u5236\u529f\u80fd \uff1a\u901a\u8fc7\u4e30\u5bcc\u7684 HTTP\u3001gRPC\u3001WebSocket \u548c TCP \u6d41\u91cf\u8def\u7531\u89c4\u5219\u6765\u6267\u884c\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u63a7\u5236\u3002 \u7f51\u7edc\u5f39\u6027\u7279\u6027\uff1a\u91cd\u8bd5\u8bbe\u7f6e\u3001\u6545\u969c\u8f6c\u79fb\u3001\u7194\u65ad\u5668\u548c\u6545\u969c\u6ce8\u5165 \u3002 \u5b89\u5168\u6027\u548c\u8eab\u4efd\u8ba4\u8bc1\u7279\u6027 \uff1a\u6267\u884c\u5b89\u5168\u6027\u7b56\u7565\uff0c\u5e76\u5f3a\u5236\u5b9e\u884c\u901a\u8fc7\u914d\u7f6e API \u5b9a\u4e49\u7684\u8bbf\u95ee\u63a7\u5236\u548c\u901f\u7387\u9650\u5236\u3002 \u57fa\u4e8e WebAssembly \u7684\u53ef\u63d2\u62d4\u6269\u5c55\u6a21\u578b\uff0c\u5141\u8bb8\u901a\u8fc7\u81ea\u5b9a\u4e49\u7b56\u7565\u6267\u884c\u548c\u751f\u6210\u7f51\u683c\u6d41\u91cf\u7684\u9065\u6d4b \u3002","title":"3-1 Envoy"},{"location":"chap4/1Istio_Intro/#3-2-istiod","text":"\u7ec4\u4ef6 Istiod \u63d0\u4f9b \u670d\u52a1\u53d1\u73b0\u3001\u914d\u7f6e\u548c\u8bc1\u4e66\u7ba1\u7406 \u3002 Istiod \u5c06\u63a7\u5236\u6d41\u91cf\u884c\u4e3a\u7684\u9ad8\u7ea7\u8def\u7531\u89c4\u5219\u8f6c\u6362\u4e3a Envoy \u7279\u5b9a\u7684\u914d\u7f6e\uff0c\u5e76\u5728\u8fd0\u884c\u65f6\u5c06\u5176\u4f20\u64ad\u7ed9 Sidecar\u3002 Pilot \u63d0\u53d6\u4e86\u7279\u5b9a\u5e73\u53f0\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\uff0c\u5e76\u5c06\u5176\u914d\u7f6e\u4e3a\u4e00\u79cd\u6807\u51c6\u683c\u5f0f\uff0c\u4efb\u4f55\u7b26\u5408 Envoy API \u7684 Sidecar \u90fd\u53ef\u4ee5\u4f7f\u7528\u3002 Istio \u53ef\u4ee5\u652f\u6301\u53d1\u73b0\u591a\u79cd\u73af\u5883\uff0c\u5982 Kubernetes \u6216 VM\u3002 \u4f60\u53ef\u4ee5\u4f7f\u7528 Istio \u6d41\u91cf\u7ba1\u7406 API \u8ba9 Istiod \u91cd\u65b0\u6784\u9020 Envoy \u7684\u914d\u7f6e\uff0c\u4ee5\u4fbf\u5bf9\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\u8fdb\u884c\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\u3002 Istiod \u901a\u8fc7\u5185\u7f6e\u7684\u8eab\u4efd\u548c\u51ed\u8bc1\u7ba1\u7406\u8fdb\u884c\u5b89\u5168\u7ba1\u7406\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Istio \u6765\u5347\u7ea7\u670d\u52a1\u7f51\u683c\u4e2d\u672a\u52a0\u5bc6\u7684\u6d41\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528 Istio \u7684\u6388\u6743\u529f\u80fd\u63a7\u5236\u8c01\u53ef\u4ee5\u8bbf\u95ee\u4f60\u7684\u670d\u52a1\u3002 Istiod \u5145\u5f53\u8bc1\u4e66\u6388\u6743\uff08CA\uff09\uff0c\u5e76\u751f\u6210\u8bc1\u4e66\u4ee5\u5141\u8bb8\u5728\u6570\u636e\u5e73\u9762\u4e2d\u8fdb\u884c\u5b89\u5168\u7684 mTLS \u901a\u4fe1 \u3002","title":"3-2 Istiod"},{"location":"chap4/1Istio_Intro/#4","text":"\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4ecb\u7ecd\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5 Istio\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u662f\u6700\u65b0\u7684 1.10.3 \u7248\u672c\u3002 \u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u4e0b\u8f7d\u6307\u5b9a\u7684 1.10.3 \u7248\u672c\u7684 Istio\uff1a ~ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh - $ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh - % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 102 100 102 0 0 41 0 0:00:02 0:00:02 --:--:-- 41 100 4573 100 4573 0 0 994 0 0:00:04 0:00:04 --:--:-- 4191 Downloading istio-1.10.3 from https://github.com/istio/istio/releases/download/1.10.3/istio-1.10.3-osx.tar.gz ... Istio 1.10.3 Download Complete! Istio has been successfully downloaded into the istio-1.10.3 folder on your system. Next Steps: See https://istio.io/latest/docs/setup/install/ to add Istio to your Kubernetes cluster. To configure the istioctl client tool for your workstation, add the /Users/i515190/k8s_test/istio/istio-1.10.3/bin directory to your environment path variable with: export PATH=\"$PATH:/Users/i515190/k8s_test/istio/istio-1.10.3/bin\" Begin the Istio pre-installation check by running: istioctl x precheck Need more information? Visit https://istio.io/latest/docs/setup/install/ \u5982\u679c\u5b89\u88c5\u5931\u8d25\uff0c\u53ef\u4ee5\u7528\u624b\u52a8\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\uff0c\u5728 GitHub Release \u9875\u9762\u83b7\u53d6\u5bf9\u5e94\u7cfb\u7edf\u7684\u4e0b\u8f7d\u5730\u5740\uff1a # \u6ce8\u610f\u9009\u62e9\u548c\u81ea\u5df1\u64cd\u4f5c\u7cfb\u7edf\u5339\u914d\u7684\u6587\u4ef6 \u279c ~ wget https://github.com/istio/istio/releases/download/1.10.3/istio-1.10.3-linux-amd64.tar.gz \u279c ~ tar -xzf istioctl-1.10.3-linux-amd64.tar.gz # \u8fdb\u5165\u5230 istio \u89e3\u538b\u7684\u76ee\u5f55 \u279c ~ cd istio-1.10.3 && ls -la total 48 drwxr-x---@ 9 ych staff 288 Jul 15 13:32 . drwx---r-x@ 482 ych staff 15424 Jul 20 14:17 .. -rw-r--r--@ 1 ych staff 11348 Jul 15 13:32 LICENSE -rw-r--r--@ 1 ych staff 5866 Jul 15 13:32 README.md drwxr-x---@ 3 ych staff 96 Jul 15 13:32 bin -rw-r-----@ 1 ych staff 854 Jul 15 13:32 manifest.yaml drwxr-xr-x@ 5 ych staff 160 Jul 15 13:32 manifests drwxr-xr-x@ 21 ych staff 672 Jul 15 13:32 samples drwxr-xr-x@ 5 ych staff 160 Jul 15 13:32 tools \u5176\u4e2d samples/ \u76ee\u5f55\u4e0b\u9762\u662f\u4e00\u4e9b\u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\uff0c bin/ \u76ee\u5f55\u4e0b\u9762\u7684 istioctl \u662f Istio \u7684 CLI \u5de5\u5177\uff0c\u53ef\u4ee5\u5c06\u8be5 bin/ \u76ee\u5f55\u52a0\u5165\u5230 PATH \u8def\u5f84\u4e4b\u4e0b\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u62f7\u8d1d\u5230\u67d0\u4e2a PATH \u76ee\u5f55\u4e0b\u53bb\uff1a $ cd istio-1.10.3 $ sudo cp bin/istioctl /usr/local/bin/istioctl $ istioctl version no running Istio pods in \"istio-system\" 1.10.3 \u5b89\u88c5 istio \u7684\u5de5\u5177\u548c\u6587\u4ef6\u51c6\u5907\u597d\u8fc7\u540e\uff0c\u76f4\u63a5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u5b89\u88c5\u547d\u4ee4\u5373\u53ef\uff0c\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u7684\u662f demo \u914d\u7f6e\u7ec4\u5408\u7684\u5f62\u5f0f\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u5305\u542b\u4e86\u4e00\u7ec4\u4e13\u4e3a\u6d4b\u8bd5\u51c6\u5907\u7684\u529f\u80fd\u96c6\u5408\uff0c\u53e6\u5916\u8fd8\u6709\u7528\u4e8e\u751f\u4ea7\u6216\u6027\u80fd\u6d4b\u8bd5\u7684\u914d\u7f6e\u7ec4\u5408\u3002 $ istioctl install --set profile=demo -y \u2714 Istio core installed \u2714 Istiod installed \u2714 Ingress gateways installed \u2714 Egress gateways installed \u2714 Installation complete Thank you for installing Istio 1.10. Please take a few minutes to tell us about your install/upgrade experience! https://forms.gle /KjkrDnMPByq7akrYA \u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 Pod \u8fd0\u884c\u72b6\u6001\uff1a $ kubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE istio-egressgateway-5547fcc8fc-flqkt 1/1 Running 0 3m6s istio-ingressgateway-8f568d595-hsm6l 1/1 Running 0 3m6s istiod-568d797f55-56vg9 1/1 Running 0 4m48s \u5982\u679c\u90fd\u662f Running \u72b6\u6001\u8bc1\u660e istio \u5c31\u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002\u7136\u540e\u6211\u4eec\u8fd8\u53ef\u4ee5\u7ed9 namespace \u6dfb\u52a0\u4e00\u4e2a isito-injection=enabled \u7684 label \u6807\u7b7e\uff0c\u6307\u793a Istio \u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u81ea\u52a8\u6ce8\u5165 Envoy Sidecar \u4ee3\u7406\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u7ed9 default \u547d\u540d\u7a7a\u95f4\u6ce8\u5165\u81ea\u52a8\u6807\u7b7e\uff1a $ kubectl label namespace default istio-injection=enabled namespace/default labeled","title":"4\u3001\u5b89\u88c5"},{"location":"chap4/1Istio_Intro/#4_1","text":"\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6765\u5b89\u88c5\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u975e\u5e38\u7ecf\u5178\u7684 Bookinfo \u5e94\u7528\u793a\u4f8b\uff0c\u8fd9\u4e2a\u793a\u4f8b\u90e8\u7f72\u4e86\u4e00\u4e2a\u7528\u4e8e\u6f14\u793a\u591a\u79cd Istio \u7279\u6027\u7684\u5e94\u7528\uff0c\u8be5\u5e94\u7528\u7531\u56db\u4e2a\u5355\u72ec\u7684\u5fae\u670d\u52a1\u6784\u6210\uff0c\u8fd9\u4e2a\u5e94\u7528\u6a21\u4eff\u5728\u7ebf\u4e66\u5e97\u7684\u4e00\u4e2a\u5206\u7c7b\uff0c\u663e\u793a\u4e00\u672c\u4e66\u7684\u4fe1\u606f\u3002\u9875\u9762\u4e0a\u4f1a\u663e\u793a\u4e00\u672c\u4e66\u7684\u63cf\u8ff0\u3001\u4e66\u7c4d\u7684 ISBN\u3001\u9875\u6570\u7b49\u4fe1\u606f\uff0c\u4ee5\u53ca\u5173\u4e8e\u8fd9\u672c\u4e66\u7684\u4e00\u4e9b\u8bc4\u8bba\u3002 Bookinfo \u5e94\u7528\u5206\u4e3a\u56db\u4e2a\u5355\u72ec\u7684\u5fae\u670d\u52a1\uff1a productpage\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4f1a\u8c03\u7528 details \u548c reviews \u4e24\u4e2a\u5fae\u670d\u52a1\uff0c\u7528\u6765\u751f\u6210\u9875\u9762\u3002 details\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u4e66\u7c4d\u7684\u4fe1\u606f\u3002 reviews\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u4e66\u7c4d\u76f8\u5173\u7684\u8bc4\u8bba\uff0c\u5b83\u8fd8\u4f1a\u8c03\u7528 ratings \u5fae\u670d\u52a1\u3002 ratings\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u7531\u4e66\u7c4d\u8bc4\u4ef7\u7ec4\u6210\u7684\u8bc4\u7ea7\u4fe1\u606f\u3002 reviews \u5fae\u670d\u52a1\u6709 3 \u4e2a\u7248\u672c\uff1a v1 \u7248\u672c\u4e0d\u4f1a\u8c03\u7528 ratings \u670d\u52a1\u3002 v2 \u7248\u672c\u4f1a\u8c03\u7528 ratings \u670d\u52a1\uff0c\u5e76\u4f7f\u7528 1 \u5230 5 \u4e2a\u9ed1\u8272\u661f\u5f62\u56fe\u6807\u6765\u663e\u793a\u8bc4\u5206\u4fe1\u606f \u3002 v3 \u7248\u672c\u4f1a\u8c03\u7528 ratings \u670d\u52a1\uff0c\u5e76\u4f7f\u7528 1 \u5230 5 \u4e2a\u7ea2\u8272\u661f\u5f62\u56fe\u6807\u6765\u663e\u793a\u8bc4\u5206\u4fe1\u606f \u3002 \u4e0b\u56fe\u53ef\u4ee5\u7528\u6765\u8bf4\u660e\u6211\u4eec\u8fd9\u4e2a\u793a\u4f8b\u5e94\u7528\u7684\u6574\u4f53\u67b6\u6784\uff1a Bookinfo \u5e94\u7528\u4e2d\u7684\u51e0\u4e2a\u5fae\u670d\u52a1\u662f\u7531\u4e0d\u540c\u7684\u8bed\u8a00\u7f16\u5199\u800c\u6210\u7684\uff0c\u8fd9\u4e9b\u670d\u52a1\u5bf9 Istio \u5e76\u65e0\u4f9d\u8d56\uff0c\u4f46\u662f\u6784\u6210\u4e86\u4e00\u4e2a\u6709\u4ee3\u8868\u6027\u7684\u670d\u52a1\u7f51\u683c\u7684\u4f8b\u5b50\uff1a\u5b83\u7531\u591a\u4e2a\u670d\u52a1\u3001\u591a\u4e2a\u8bed\u8a00\u6784\u6210\uff0c\u5e76\u4e14 reviews \u670d\u52a1\u5177\u6709\u591a\u4e2a\u7248\u672c\u3002 \u6211\u4eec\u8981\u5728 Istio \u4e2d\u8fd0\u884c\u8fd9\u4e2a\u5e94\u7528\uff0c\u4e0d\u9700\u8981\u5bf9\u5e94\u7528\u672c\u8eab\u505a\u4efb\u4f55\u6539\u53d8\uff0c\u53ea\u8981\u7b80\u5355\u7684\u5728 Istio \u73af\u5883\u4e2d\u5bf9\u670d\u52a1\u8fdb\u884c\u914d\u7f6e\u548c\u8fd0\u884c\uff0c\u4e5f\u5c31\u662f\u628a Envoy sidecar \u6ce8\u5165\u5230\u6bcf\u4e2a\u670d\u52a1\u4e4b\u4e2d\u3002\u6700\u7ec8\u7684\u90e8\u7f72\u7ed3\u679c\u5c06\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u6240\u6709\u7684\u5fae\u670d\u52a1\u90fd\u548c Envoy sidecar \u96c6\u6210\u5728\u4e00\u8d77\uff0c\u88ab\u96c6\u6210\u670d\u52a1\u6240\u6709\u7684\u51fa\u5165\u6d41\u91cf\u90fd\u88ab sidecar \u6240\u52ab\u6301\uff0c\u8fd9\u6837\u5c31\u4e3a\u5916\u90e8\u63a7\u5236\u51c6\u5907\u4e86\u6240\u9700\u7684 Hook\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u5229\u7528 Istio \u63a7\u5236\u5e73\u9762\u4e3a\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\u8def\u7531\u3001\u9065\u6d4b\u6570\u636e\u6536\u96c6\u4ee5\u53ca\u7b56\u7565\u5b9e\u65bd\u7b49\u529f\u80fd\u3002 \u8fdb\u5165\u4e0a\u9762\u7684 Istio \u5b89\u88c5\u76ee\u5f55\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a $ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml service/details created serviceaccount/bookinfo-details created deployment.apps/details-v1 created service/ratings created serviceaccount/bookinfo-ratings created deployment.apps/ratings-v1 created service/reviews created serviceaccount/bookinfo-reviews created deployment.apps/reviews-v1 created deployment.apps/reviews-v2 created deployment.apps/reviews-v3 created service/productpage created serviceaccount/bookinfo-productpage created deployment.apps/productpage-v1 created \u5982\u679c\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u7981\u7528\u4e86 Sidecar \u81ea\u52a8\u6ce8\u5165\u529f\u80fd\u800c\u9009\u62e9\u624b\u52a8\u6ce8\u5165 Sidecar\uff0c\u8bf7\u5728\u90e8\u7f72\u5e94\u7528\u4e4b\u524d\u53ef\u4ee5\u4f7f\u7528 istioctl kube-inject \u547d\u4ee4\u6765\u6ce8\u5165 sidecar \u5bb9\u5668\u3002 $ kubectl apply -f <(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml) \u8fd9\u91cc\u6211\u4eec\u90e8\u7f72\u7684 bookinfo.yaml \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5c31\u662f\u666e\u901a\u7684 Kubernetes \u7684 Deployment \u548c Service \u7684 yaml \u6587\u4ef6\uff0c\u4f7f\u7528 istioctl kube-inject \u6216\u8005\u914d\u7f6e\u81ea\u52a8\u6ce8\u5165\u540e\u4f1a\u5728\u8fd9\u4e2a\u6587\u4ef6\u7684\u57fa\u7840\u4e0a\u5411\u5176\u4e2d\u7684 Deployment \u8ffd\u52a0\u4e00\u4e2a\u955c\u50cf\u4e3a docker.io/istio/proxyv2:1.10.3 \u7684 sidecar \u5bb9\u5668\uff0c\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u542f\u52a8\u5168\u90e8\u7684\u56db\u4e2a\u670d\u52a1\uff0c\u5176\u4e2d\u4e5f\u5305\u62ec\u4e86 reviews \u670d\u52a1\u7684\u4e09\u4e2a\u7248\u672c\uff08v1\u3001v2 \u4ee5\u53ca v3\uff09\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE details-v1-79f774bdb9-bxgnv 2/2 Running 0 7m3s productpage-v1-6b746f74dc-drxqj 2/2 Running 0 7m3s ratings-v1-b6994bb9-62nrz 2/2 Running 0 7m3s reviews-v1-545db77b95-lgcjt 2/2 Running 0 7m3s reviews-v2-7bf8c9648f-mlfb7 2/2 Running 0 7m3s reviews-v3-84779c7bbc-fnqbg 2/2 Running 0 7m3s $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE details ClusterIP 10.110.179.156 <none> 9080/TCP 7m7s kubernetes ClusterIP 10.96.0.1 <none> 443/TCP 20h productpage ClusterIP 10.96.138.142 <none> 9080/TCP 7m7s ratings ClusterIP 10.102.119.192 <none> 9080/TCP 7m7s reviews ClusterIP 10.102.66.198 <none> 9080/TCP 7m7s \u73b0\u5728\u5e94\u7528\u7684\u670d\u52a1\u90fd\u90e8\u7f72\u6210\u529f\u5e76\u542f\u52a8\u4e86\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\uff0c\u5c31\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a istio gateway\uff0cgateway \u76f8\u5f53\u4e8e k8s \u7684 ingress controller \u548c ingress\uff0c\u5b83\u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\uff0c\u901a\u5e38\u5728\u670d\u52a1\u7f51\u683c\u8fb9\u7f18\u4f5c\u4e3a\u5e94\u7528\u7684 ingress \u6d41\u91cf\u7ba1\u7406\u3002 \u521b\u5efa\u4e00\u4e2a Ingress gateway: $ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml gateway.networking.istio.io/bookinfo-gateway created virtualservice.networking.istio.io/bookinfo created \u9a8c\u8bc1 gateway \u662f\u5426\u521b\u5efa\u6210\u529f: $ kubectl get gateway NAME AGE bookinfo-gateway 72s \u8981\u60f3\u8bbf\u95ee\u8fd9\u4e2a\u5e94\u7528\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u66f4\u6539\u4e0b istio \u63d0\u4f9b\u7684 istio-ingressgateway \u8fd9\u4e2a Service \u5bf9\u8c61\uff0c\u9ed8\u8ba4\u662f LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff1a $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-egressgateway ClusterIP 10.101.179.89 <none> 80/TCP,443/TCP 3h16m istio-ingressgateway LoadBalancer 10.99.72.32 localhost 15021:32556/TCP,80:31102/TCP,443:30657/TCP,31400:32719/TCP,15443 :31978/TCP 3h16m istiod ClusterIP 10.107.4.189 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP 3h18m LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u5b9e\u9645\u4e0a\u662f\u7528\u6765\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\uff0c\u5982\u679c\u6211\u4eec\u6ca1\u6709\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\u8bdd\uff0c \u53ef\u4ee5\u5c06\u8fd9\u91cc\u7c7b\u578b\u6539\u6210 NodePort\uff0c\u4f46\u662f\u8fd9\u6837\u5f53\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u7684\u65f6\u5019\u5c31\u9700\u8981\u52a0\u4e0a nodePort \u7aef\u53e3\u4e86 \uff1a $ kubectl edit svc istio-ingressgateway -n istio-system service/istio-ingressgateway edited ...... type: NodePort # \u4fee\u6539\u6210 NodePort \u7c7b\u578b status: loadBalancer: {} $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-egressgateway ClusterIP 10.101.179.89 <none> 80/TCP,443/TCP 3h20m istio-ingressgateway NodePort 10.99.72.32 <none> 15021:32556/TCP,80:31102/TCP,443:30657/TCP,31400:32719/TCP,15443:31 978/TCP 3h20m istiod ClusterIP 10.107.4.189 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP 3h22m \u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 http://<NodeIP>:<nodePort>/productpage \u4ece\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee Bookinfo \u5e94\u7528\u4e86\uff1a http://127.0.0.1:31102/productpage \u5237\u65b0\u9875\u9762\u53ef\u4ee5\u770b\u5230 Book Reviews \u53d1\u751f\u4e86\u6539\u53d8\uff08\u7ea2\u8272\u3001\u9ed1\u8272\u7684\u661f\u5f62\u6216\u8005\u6ca1\u6709\u663e\u793a\uff09\uff0c\u56e0\u4e3a\u6bcf\u6b21\u8bf7\u6c42\u4f1a\u88ab\u8def\u7531\u5230\u5230\u4e86\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\u53bb\u3002","title":"4\u3001\u90e8\u7f72\u793a\u4f8b\u5e94\u7528"},{"location":"chap4/1Istio_Intro/#5","text":"\u4e0a\u9762\u6211\u4eec\u662f\u5b89\u88c5\u7684 Istio \u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u6b64\u5916 Istio \u8fd8\u548c\u4e00\u4e9b\u9065\u6d4b\u5e94\u7528\u505a\u4e86\u96c6\u6210\uff0c\u9065\u6d4b\u80fd\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u670d\u52a1\u7f51\u683c\u7684\u7ed3\u6784\u3001\u5c55\u793a\u7f51\u7edc\u7684\u62d3\u6251\u7ed3\u6784\u3001\u5206\u6790\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u6001\u7b49\uff0c\u5bf9\u4e8e\u5206\u5e03\u5f0f\u5fae\u670d\u52a1\u5e94\u7528\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u90e8\u7f72 Kiali\u3001Prometheus\u3001Grafana \u4ee5\u53ca Jaeger\uff1a kubectl apply -f samples/addons # \u5982\u679c\u51fa\u73b0\u4e86\u9519\u8bef\uff0c\u5219\u53ef\u4ee5\u91cd\u65b0\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4 $ kubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE grafana-f766d6c97-4888w 1/1 Running 0 3m57s istio-egressgateway-5c8d96c9b5-6d5g9 1/1 Running 0 60m istio-ingressgateway-6bcfd457f9-wpj7w 1/1 Running 0 60m istiod-775bcf58f7-v6jl2 1/1 Running 0 61m jaeger-7f78b6fb65-bj8pm 1/1 Running 0 3m56s kiali-85c8cdd5b5-b5zv4 1/1 Running 0 3m55s prometheus-54b5dcf6bf-wjkpl 3/3 Running 0 3m48s \u4e0a\u9762\u51e0\u4e2a\u7ec4\u4ef6\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u524d\u9762 Bookinfo \u793a\u4f8b\u5e94\u7528\u7684\u9065\u6d4b\u4fe1\u606f\u4e86\uff0c\u6bd4\u5982\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8bbf\u95ee Kiali\uff1a istioctl dashboard kiali \u5728\u5de6\u4fa7\u7684\u5bfc\u822a\u83dc\u5355\uff0c\u9009\u62e9 Graph \uff0c\u7136\u540e\u5728 Namespace \u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9009\u62e9 default \u3002Kiali \u4eea\u8868\u677f\u5c55\u793a\u4e86\u7f51\u683c\u7684\u6982\u89c8\u3001\u4ee5\u53ca Bookinfo \u793a\u4f8b\u5e94\u7528\u7684\u5404\u4e2a\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u5b83\u8fd8\u63d0\u4f9b\u8fc7\u6ee4\u5668\u6765\u53ef\u89c6\u5316\u6d41\u91cf\u7684\u6d41\u52a8\u3002 \u81f3\u6b64\uff0c\u6574\u4e2a Istio \u548c Bookinfo \u793a\u4f8b\u5e94\u7528\u5c31\u5b89\u88c5\u5e76\u9a8c\u8bc1\u6210\u529f\u4e86\uff0c\u73b0\u5728\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e00\u5e94\u7528\u6765\u4f53\u9a8c Istio \u7684\u7279\u6027\u4e86\uff0c\u5176\u4e2d\u5305\u62ec\u4e86\u6d41\u91cf\u7684\u8def\u7531\u3001\u9519\u8bef\u6ce8\u5165\u3001\u901f\u7387\u9650\u5236\u7b49\u7279\u6027\u3002 \u76ee\u524d\u642d\u5efa Bookinfo \u5e94\u7528\u6211\u4eec\u53ea\u7528\u5230\u4e86\u4e0b\u9762\u4e24\u4e2a\u8d44\u6e90\u6587\u4ef6\uff1a samples/bookinfo/platform/kube/bookinfo.yaml samples/bookinfo/networking/bookinfo-gateway.yaml \u524d\u8005\u5c31\u662f\u901a\u5e38\u7684 Kubernetes \u5b9a\u4e49\u7684 Deployment \u548c Service \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u53ea\u662f\u5728\u90e8\u7f72\u65f6\u4f7f\u7528 istioctl kube-inject \uff08\u6216\u8005\u901a\u8fc7\u5bf9\u547d\u540d\u7a7a\u95f4\u6253\u4e0a\u81ea\u52a8\u6ce8\u5165\u7684\u6807\u7b7e\uff09\u5bf9\u8fd9\u4e2a\u6587\u4ef6\u5b9a\u4e49\u7684 Pod \u6ce8\u5165\u4e86 sidecar \u4ee3\u7406\uff0c\u540e\u8005\u5b9a\u4e49\u4e86\u8fd9\u4e2a\u5e94\u7528\u7684\u5916\u90e8\u8bbf\u95ee\u5165\u53e3 gateway\uff0c\u4ee5\u53ca\u5e94\u7528\u5185\u90e8 productpage \u670d\u52a1\u7684 VirtualService \u89c4\u5219\uff0c\u800c\u5176\u4ed6\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fd8\u6ca1\u6709\u88ab\u5b9a\u4e49\u3002 \u73b0\u5728\u8bbf\u95ee\u5e94\u7528\u754c\u9762\u5e76\u5237\u65b0\uff0c\u4f1a\u770b\u5230 Reviews \u6709\u65f6\u4e0d\u4f1a\u663e\u793a\u8bc4\u5206\uff0c\u6709\u65f6\u5019\u4f1a\u663e\u793a\u4e0d\u540c\u6837\u5f0f\u7684\u8bc4\u5206\uff0c\u8fd9\u662f\u56e0\u4e3a\u540e\u9762\u67093\u4e2a\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\uff0c\u800c\u6ca1\u6709\u914d\u7f6e\u8be5\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\u7684\u60c5\u51b5\u4e0b\uff0c\u8be5\u670d\u52a1\u7684\u51e0\u4e2a\u5b9e\u4f8b\u4f1a\u88ab\u968f\u673a\u8bbf\u95ee\u5230\uff0c\u6709\u7684\u7248\u672c\u670d\u52a1\u4f1a\u8fdb\u4e00\u6b65\u8c03\u7528 Ratings \u670d\u52a1\uff0c\u6709\u7684\u4e0d\u4f1a\u3002","title":"5\u3001\u4eea\u8868\u76d8"},{"location":"chap4/2Istio_flow_control/","text":"\u7b2c\u4e8c\u8282 \u4f7f\u7528 Istio \u5b9e\u73b0\u975e\u4fb5\u5165\u6d41\u91cf\u6cbb\u7406 Istio \u4e2d\u4e24\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6d41\u91cf\u7ba1\u7406\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a VirtualService \uff08\u865a\u62df\u670d\u52a1\uff09\uff1a\u7528\u6765\u5728 Istio \u4e2d\u5b9a\u4e49\u8def\u7531\u89c4\u5219\uff0c \u63a7\u5236\u6d41\u91cf\u8def\u7531\u5230\u670d\u52a1\u4e0a\u7684\u5404\u79cd\u884c\u4e3a \u3002 DestinationRule \uff08\u76ee\u6807\u89c4\u5219\uff09\uff1a \u865a\u62df\u670d\u52a1\u89c6\u5b9a\u4e49\u5c06\u6d41\u91cf\u5982\u4f55\u8def\u7531\u5230\u6307\u5b9a\u76ee\u6807\u5730\u5740\uff0c\u7136\u540e\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6765\u914d\u7f6e\u8be5\u76ee\u6807\u7684\u6d41\u91cf\uff0c\u5728\u8bc4\u4f30\u865a\u62df\u670d\u52a1\u8def\u7531\u89c4\u5219\u4e4b\u540e\uff0c\u76ee\u6807\u89c4\u5219\u5c06\u5e94\u7528\u4e8e\u6d41\u91cf\u7684\u771f\u5b9e\u76ee\u6807\u5730\u5740\u3002 1\u3001VirtualService \u865a\u62df\u670d\u52a1\uff08VirtualService\uff09\u548c\u76ee\u6807\u89c4\u5219\uff08Destination Rule\uff09\u662f Istio \u6d41\u91cf\u8def\u7531\u529f\u80fd\u7684\u5173\u952e\u5bf9\u8c61\uff0c \u865a\u62df\u670d\u52a1\u914d\u7f6e\u5982\u4f55\u5728 Istio \u5185\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u670d\u52a1 \uff0c\u6bcf\u4e2a\u865a\u62df\u670d\u52a1\u5305\u542b\u4e00\u7ec4 \u8def\u7531\u89c4\u5219 \uff0cIstio \u4f1a\u6309\u5b9a\u4e49\u7684\u987a\u5e8f\u6765\u8bc4\u4f30\u5b83\u4eec\uff0cIstio \u5c06\u6bcf\u4e2a\u6307\u5b9a\u7684\u8bf7\u6c42\u5339\u914d\u5230\u865a\u62df\u670d\u52a1\u6307\u5b9a\u7684\u5b9e\u9645\u76ee\u6807\u5730\u5740\u3002\u5728\u7f51\u683c\u4e2d\u53ef\u4ee5\u6709\u591a\u4e2a\u865a\u62df\u670d\u52a1\uff0c\u4e5f\u53ef\u4ee5\u6ca1\u6709\u3002 \u4f7f\u7528\u865a\u62df\u670d\u52a1\uff0c\u4f60\u53ef\u4ee5\u4e3a\u4e00\u4e2a\u6216\u591a\u4e2a\u4e3b\u673a\u540d\u6307\u5b9a\u6d41\u91cf\u884c\u4e3a\uff0c\u5728\u865a\u62df\u670d\u52a1\u4e2d\u4f7f\u7528\u8def\u7531\u89c4\u5219\uff0c\u544a\u8bc9 Envoy \u5982\u4f55\u53d1\u9001\u865a\u62df\u670d\u52a1\u7684\u6d41\u91cf\u5230\u5408\u9002\u7684\u76ee\u6807\uff0c\u8def\u7531\u76ee\u6807\u5730\u5740\u53ef\u4ee5\u662f\u540c\u4e00\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\uff0c\u4e5f\u53ef\u4ee5\u662f\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\u3002 \u4e00\u4e2a\u5178\u578b\u7684\u4f7f\u7528\u573a\u666f\u662f\u5c06\u6d41\u91cf\u53d1\u9001\u5230\u6307\u5b9a\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u3002 \u5ba2\u6237\u7aef\u4f1a\u5c06\u865a\u62df\u670d\u52a1\u89c6\u4e3a\u4e00\u4e2a\u5355\u4e00\u5b9e\u4f53\uff0c\u5c06\u8bf7\u6c42\u53d1\u9001\u81f3\u865a\u62df\u670d\u52a1\u4e3b\u673a\uff0c\u7136\u540e Envoy \u6839\u636e\u865a\u62df\u670d\u52a1\u89c4\u5219\u628a\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684\u7248\u672c\u3002 \u6bd4\u5982\u628a 20% \u7684\u6d41\u91cf\u8def\u7531\u5230\u65b0\u7248\u672c \u6216 \u5c06\u8fd9\u4e9b\u7528\u6237\u7684\u8bf7\u6c42\u8def\u7531\u5230\u7248\u672c 2\uff0c\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u7136\u540e\u9010\u6b65\u589e\u52a0\u53d1\u9001\u5230\u65b0\u7248\u672c\u670d\u52a1\u7684\u6d41\u91cf\u767e\u5206\u6bd4\u3002 \u6d41\u91cf\u8def\u7531\u5b8c\u5168\u72ec\u7acb\u4e8e\u5b9e\u4f8b\u90e8\u7f72\uff0c\u6240\u4ee5\u5b9e\u73b0\u65b0\u7248\u672c\u670d\u52a1\u7684\u5b9e\u4f8b\u53ef\u4ee5\u6839\u636e\u6d41\u91cf\u7684\u8d1f\u8f7d\u6765\u4f38\u7f29\uff0c\u5b8c\u5168\u4e0d\u5f71\u54cd\u6d41\u91cf\u8def\u7531\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0cKubernetes \u5219\u53ea\u652f\u6301\u57fa\u4e8e\u5b9e\u4f8b\u7f29\u653e\u7684\u6d41\u91cf\u5206\u53d1\uff0c\u8fd9\u4f1a\u66f4\u590d\u6742\u3002 \u5982\u4e0b\u6240\u793a\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u865a\u62df\u670d\u52a1\uff0c\u6839\u636e\u8bf7\u6c42\u662f\u5426\u6765\u81ea\u67d0\u4e2a\u7279\u5b9a\u7528\u6237\uff0c\u628a\u5b83\u4eec\u8def\u7531\u5230\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u53bb\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: # \u5217\u51faVirtualService\u7684hosts\uff0c\u53ef\u4ee5\u662fIP\u3001DNS\u540d\u79f0\u3001FQDN\u6216* - reviews http: # \u5728\u4e0b\u9762\u914d\u7f6eVirtualService\u7684\u8def\u7531\u89c4\u5219\uff0c\u6307\u5b9a\u7b26\u5408\u54ea\u4e9b\u89c4\u5219\u7684\u6d41\u91cf\u6253\u5230\u54ea\u4e9bDestination\uff0c\u652f\u6301HTTP/1.1\uff0cHTTP2\uff0c\u53cagRPC\u7b49\u534f\u8bae - match: # \u6307\u5b9a\u5177\u4f53\u7684\u5339\u914d\u89c4\u5219 - headers: end-user: exact: jason route: - destination: # \u6307\u5b9a\u6ee1\u8db3\u89c4\u5219\u540e\u5c06\u6d41\u91cf\u6253\u5230\u54ea\u4e2a\u5177\u4f53\u7684Destination host: reviews subset: v2 - route: # \u6d41\u91cf\u89c4\u5219\u6309\u4ece\u4e0a\u5230\u4e0b\u7684\u4f18\u5148\u7ea7\u53bb\u5339\u914d\uff0c\u82e5\u4e0d\u6ee1\u8db3\u4e0a\u8ff0\u89c4\u5219\u65f6\uff0c\u8fdb\u5165\u8be5\u9ed8\u8ba4\u89c4\u5219 - destination: host: reviews subset: v3 \u6211\u4eec\u4f7f\u7528 hosts \u5b57\u6bb5\u5217\u4e3e\u865a\u62df\u670d\u52a1\u7684\u4e3b\u673a\u2014\u2014\u5373\u7528\u6237\u6307\u5b9a\u7684\u76ee\u6807\u6216\u662f\u8def\u7531\u89c4\u5219\u8bbe\u5b9a\u7684\u76ee\u6807\uff0c\u8fd9\u662f\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\u65f6\u4f7f\u7528\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u5730\u5740\u3002 hosts: - reviews \u865a\u62df\u670d\u52a1\u4e3b\u673a\u540d\u53ef\u4ee5\u662f IP \u5730\u5740\u3001DNS \u540d\u79f0\uff0c\u6bd4\u5982 Kubernetes Service \u7684\u77ed\u540d\u79f0\uff0c\u9690\u5f0f\u6216\u663e\u5f0f\u5730\u6307\u5411\u4e00\u4e2a\u5b8c\u5168\u9650\u5b9a\u57df\u540d\uff08FQDN\uff09\u3002 \u4e5f\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26\uff08\u201c*\u201d\uff09\u524d\u7f00\uff0c\u521b\u5efa\u4e00\u7ec4\u5339\u914d\u6240\u6709\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\u3002\u865a\u62df\u670d\u52a1\u7684 hosts \u5b57\u6bb5\u5b9e\u9645\u4e0a\u4e0d\u5fc5\u662f Istio \u670d\u52a1\u6ce8\u518c\u7684\u4e00\u90e8\u5206\uff0c\u5b83\u53ea\u662f\u865a\u62df\u7684\u76ee\u6807\u5730\u5740\uff0c\u8fd9\u6837\u53ef\u4ee5\u4e3a\u6ca1\u6709\u8def\u7531\u5230\u7f51\u683c\u5185\u90e8\u7684\u865a\u62df\u4e3b\u673a\u5efa\u6a21\u3002 \u7136\u540e\u63a5\u7740\u5c31\u662f\u8def\u7531\u89c4\u5219\u7684\u5b9a\u4e49\uff0c\u8fd9\u91cc\u901a\u8fc7 http \u5b57\u6bb5\u6765\u5b9a\u4e49\u865a\u62df\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\uff0c\u7528\u6765\u63cf\u8ff0\u5339\u914d\u6761\u4ef6\u548c\u8def\u7531\u884c\u4e3a\uff0c\u5b83\u4eec\u628a HTTP/1.1\u3001HTTP2 \u548c gRPC \u7b49\u6d41\u91cf\u53d1\u9001\u5230 hosts \u5b57\u6bb5\u6307\u5b9a\u7684\u76ee\u6807\uff0c\u4e00\u6761\u8def\u7531\u89c4\u5219\u5305\u542b\u4e86\u6307\u5b9a\u7684\u8bf7\u6c42\u8981\u6d41\u5411\u54ea\u4e2a\u76ee\u6807\u5730\u5740\uff0c\u53ef\u4ee5\u67090\u4e2a\u6216\u591a\u4e2a\u5339\u914d\u6761\u4ef6\u3002 \u6bd4\u5982\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684\u7b2c\u4e00\u4e2a\u8def\u7531\u89c4\u5219\u6709\u4e00\u4e2a\u6761\u4ef6\uff0c\u6240\u4ee5\u4f7f\u7528 match \u5b57\u6bb5\u5f00\u59cb\u5b9a\u4e49\uff0c\u6211\u4eec\u5e0c\u671b\u8be5\u8def\u7531\u5e94\u7528\u4e8e\u6765\u81ea jason \u7528\u6237\u7684\u6240\u6709\u8bf7\u6c42\uff0c\u6240\u4ee5\u4f7f\u7528 headers\u3001end-user \u548c exact \u5b57\u6bb5\u6765\u5339\u914d\u5408\u9002\u7684\u8bf7\u6c42 \u3002 - match: - headers: end-user: exact: jason \u7136\u540e\u540e\u9762\u7684 route \u90e8\u5206\u7684 destination \u5b57\u6bb5\u6307\u5b9a\u4e86\u7b26\u5408\u8be5\u6761\u4ef6\u7684\u6d41\u91cf\u7684\u5b9e\u9645\u76ee\u6807\u5730\u5740\uff0c\u4e0e\u865a\u62df\u670d\u52a1\u7684 hosts \u4e0d\u540c\uff0c destination \u7684 host \u5fc5\u987b\u662f\u5b58\u5728\u4e8e Istio \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\u7684\u5b9e\u9645\u76ee\u6807\u5730\u5740\uff0c\u5426\u5219 Envoy \u4e0d\u77e5\u9053\u8be5\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u54ea\u91cc\u3002 \u53ef\u4ee5\u662f\u4e00\u4e2a\u6709\u4ee3\u7406\u7684\u670d\u52a1\u7f51\u683c\uff0c\u6216\u8005\u662f\u4e00\u4e2a\u901a\u8fc7\u670d\u52a1\u5165\u53e3\u88ab\u6dfb\u52a0\u8fdb\u6765\u7684\u975e\u7f51\u683c\u670d\u52a1\u3002\u672c\u793a\u4f8b\u8fd0\u884c\u5728 Kubernetes \u73af\u5883\u4e2d\uff0chost \u540d\u4e3a\u4e00\u4e2a Kubernetes \u670d\u52a1\u540d\uff1a route: - destination: host: reviews # Kubernetes Service \u77ed\u540d\u79f0 subset: v2 \u6b64\u5916 destination \u4e0b\u9762\u8fd8\u6307\u5b9a\u4e86 Kubernetes \u670d\u52a1\u7684\u5b50\u96c6\uff0c\u5c06\u7b26\u5408\u6b64\u89c4\u5219\u6761\u4ef6\u7684\u8bf7\u6c42\u8f6c\u5165\u5176\u4e2d\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u5b50\u96c6\u540d\u79f0\u662f v2\uff0c\u6211\u4eec\u4f1a\u5728\u76ee\u6807\u89c4\u5219\u4e2d\u770b\u5230\u5982\u4f55\u5b9a\u4e49\u670d\u52a1\u5b50\u96c6\u3002 \u8def\u7531\u89c4\u5219\u662f\u6309\u4ece\u4e0a\u5230\u4e0b\u7684\u987a\u5e8f\u9009\u62e9\u7684\uff0c \u865a\u62df\u670d\u52a1\u4e2d\u5b9a\u4e49\u7684\u7b2c\u4e00\u6761\u89c4\u5219\u6709\u6700\u9ad8\u4f18\u5148\u7ea7 \u3002\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684\u865a\u62df\u670d\u52a1\u4e2d\uff0c\u4e0d\u6ee1\u8db3\u7b2c\u4e00\u4e2a\u8def\u7531\u89c4\u5219\u7684\u6d41\u91cf\u5747\u4f1a\u6d41\u5411\u4e00\u4e2a\u9ed8\u8ba4\u7684\u76ee\u6807\uff0c\u7b2c\u4e8c\u6761\u89c4\u5219\u6ca1\u6709\u914d\u7f6e match \u6761\u4ef6\uff0c\u76f4\u63a5\u5c06\u6d41\u91cf\u5bfc\u5411 v3 \u5b50\u96c6\u3002 - route: - destination: host: reviews subset: v3 \u4e00\u822c\u5efa\u8bae\u63d0\u4f9b\u4e00\u4e2a\u9ed8\u8ba4\u7684 \u65e0\u6761\u4ef6\u6216\u57fa\u4e8e\u6743\u91cd\u7684\u89c4\u5219 \u4f5c\u4e3a\u6bcf\u4e00\u4e2a\u865a\u62df\u670d\u52a1\u7684\u6700\u540e\u4e00\u6761\u89c4\u5219\uff0c\u4ece\u800c\u786e\u4fdd\u6d41\u7ecf\u865a\u62df\u670d\u52a1\u7684\u6d41\u91cf\u81f3\u5c11\u80fd\u591f\u5339\u914d\u5230\u4e00\u6761\u8def\u7531\u89c4\u5219\u3002 2\u3001DestinationRule \u4e0e\u865a\u62df\u670d\u52a1\u4e00\u6837\uff0cDestinationRule\uff08\u76ee\u6807\u89c4\u5219\uff09\u4e5f\u662f Istio \u6d41\u91cf\u8def\u7531\u529f\u80fd\u7684\u5173\u952e\u90e8\u5206\uff0c \u6211\u4eec\u53ef\u4ee5\u5c06\u865a\u62df\u670d\u52a1\u770b\u6210\u5c06\u6d41\u91cf\u5982\u4f55\u8def\u7531\u5230\u6307\u5b9a\u76ee\u6807\u5730\u5740\uff0c\u7136\u540e\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6765\u914d\u7f6e\u8be5\u76ee\u6807\u7684\u6d41\u91cf \u3002 \u5728\u8bc4\u4f30\u865a\u62df\u670d\u52a1\u8def\u7531\u89c4\u5219\u4e4b\u540e\uff0c\u76ee\u6807\u89c4\u5219\u5c06\u5e94\u7528\u4e8e\u6d41\u91cf\u7684\u201c\u771f\u5b9e\u201d\u76ee\u6807\u5730\u5740\u3002 \u53ef\u4ee5\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6765\u6307\u5b9a\u547d\u540d\u7684\u670d\u52a1\u5b50\u96c6\uff0c\u4f8b\u5982\u6309\u7248\u672c\u4e3a\u6240\u6709\u6307\u5b9a\u670d\u52a1\u7684\u5b9e\u4f8b\u5206\u7ec4\uff0c\u7136\u540e\u53ef\u4ee5\u5728\u865a\u62df\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u670d\u52a1\u5b50\u96c6\u6765\u63a7\u5236\u5230\u670d\u52a1\u4e0d\u540c\u5b9e\u4f8b\u7684\u6d41\u91cf\u3002 \u76ee\u6807\u89c4\u5219\u8fd8\u5141\u8bb8\u4f60\u5728\u8c03\u7528\u6574\u4e2a\u76ee\u7684\u670d\u52a1\u6216\u7279\u5b9a\u670d\u52a1\u5b50\u96c6\u65f6\u5b9a\u5236 Envoy \u7684\u6d41\u91cf\u7b56\u7565\uff0c\u6bd4\u5982\u8d1f\u8f7d\u5747\u8861\u6a21\u578b\u3001TLS \u5b89\u5168\u6a21\u5f0f\u6216\u7194\u65ad\u5668\u8bbe\u7f6e \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio \u4f7f\u7528\u8f6e\u8be2\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u5b9e\u4f8b\u6c60\u4e2d\u7684\u6bcf\u4e2a\u5b9e\u4f8b\u4f9d\u6b21\u83b7\u53d6\u8bf7\u6c42\u3002 Istio \u540c\u65f6\u652f\u6301\u5982\u4e0b\u7684\u8d1f\u8f7d\u5747\u8861\u6a21\u578b\uff0c\u53ef\u4ee5\u5728 DestinationRule \u4e2d\u4e3a\u6d41\u5411\u67d0\u4e2a\u7279\u5b9a\u670d\u52a1\u6216\u670d\u52a1\u5b50\u96c6\u7684\u6d41\u91cf\u6307\u5b9a\u8fd9\u4e9b\u6a21\u578b\u3002 \u968f\u673a \uff1a\u8bf7\u6c42\u4ee5\u968f\u673a\u7684\u65b9\u5f0f\u8f6c\u5230\u6c60\u4e2d\u7684\u5b9e\u4f8b\u3002 \u6743\u91cd \uff1a\u8bf7\u6c42\u6839\u636e\u6307\u5b9a\u7684\u767e\u5206\u6bd4\u8f6c\u5230\u5b9e\u4f8b\u3002 \u6700\u5c11\u8bf7\u6c42 \uff1a\u8bf7\u6c42\u88ab\u8f6c\u5230\u6700\u5c11\u88ab\u8bbf\u95ee\u7684\u5b9e\u4f8b\u3002 \u6bd4\u5982\u5728\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u76ee\u6807\u89c4\u5219\u4e3a my-svc \u76ee\u6807\u670d\u52a1\u914d\u7f6e\u4e86 3 \u4e2a\u5177\u6709\u4e0d\u540c\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u7684\u5b50\u96c6\uff1a apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: my-destination-rule spec: host: my-svc trafficPolicy: loadBalancer: simple: RANDOM # \u968f\u673a\u7684\u7b56\u7565 subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 trafficPolicy: loadBalancer: simple: ROUND_ROBIN # \u8f6e\u8be2 - name: v3 labels: version: v3 \u6bcf\u4e2a\u5b50\u96c6\u90fd\u662f\u57fa\u4e8e\u4e00\u4e2a\u6216\u591a\u4e2a labels \u5b9a\u4e49\u7684\uff0c\u5728 Kubernetes \u4e2d\u5b83\u662f\u9644\u52a0\u5230 Pod \u8fd9\u79cd\u5bf9\u8c61\u4e0a\u7684\u952e/\u503c\u5bf9\u3002 \u9664\u4e86\u5b9a\u4e49\u5b50\u96c6\u4e4b\u5916\uff0c\u76ee\u6807\u89c4\u5219\u5bf9\u4e8e\u6240\u6709\u5b50\u96c6\u90fd\u6709\u9ed8\u8ba4\u7684\u6d41\u91cf\u7b56\u7565\uff0c\u800c\u5bf9\u4e8e\u5177\u4f53\u7684\u5b50\u96c6\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u7279\u5b9a\u4e8e\u5b50\u96c6\u7684\u7b56\u7565\u6765\u8986\u76d6\u5b83\u3002 \u4e0a\u9762\u7684\u793a\u4f8b\u5b9a\u4e49\u5728 subsets \u4e0a\u7684\u9ed8\u8ba4\u7b56\u7565\uff0c\u4e3a v1 \u548c v3 \u5b50\u96c6\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u968f\u673a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u5728 v2 \u7b56\u7565\u4e2d\uff0c\u6307\u5b9a\u4e86\u4e00\u4e2a\u8f6e\u8be2\u8d1f\u8f7d\u5747\u8861\u5668\u3002 \u5728\u5bf9\u865a\u62df\u670d\u52a1\u548c\u76ee\u6807\u89c4\u5219\u6709\u4e86\u521d\u6b65\u4e86\u89e3\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5bf9 Bookinfo \u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fdb\u884c\u4fee\u6539\u3002 3\u3001\u4e0d\u540c\u670d\u52a1\u7248\u672c\u8bbf\u95ee\u89c4\u5219 \u5bf9 Reviews \u670d\u52a1\u6dfb\u52a0\u4e00\u6761\u8def\u7531\u89c4\u5219\uff0c\u542f\u7528 samples/bookinfo/networking/virtual-service-reviews-v3.yaml \u5b9a\u4e49\u7684 VirtualService \u89c4\u5219\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v3 \u8fd9\u6837\uff0c\u6240\u6709\u8bbf\u95ee reviews \u670d\u52a1\u7684\u6d41\u91cf\u5c31\u4f1a\u88ab\u5f15\u5bfc\u5230 reviews \u670d\u52a1\u5bf9\u5e94\u7684 subset \u4e3a v3 \u7684 Pod \u4e2d\u3002\u542f\u7528\u8fd9\u6761\u89c4\u5219\uff1a $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml virtualservice.networking.istio.io/reviews created \u7136\u540e\u67e5\u770b\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff1a $ kubectl get virtualservices NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 17h reviews [\"reviews\"] 35s \u6211\u4eec\u53ef\u4ee5\u770b\u5230 reviews \u7684 VirtualService \u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u6b64\u65f6\u6211\u4eec\u53bb\u5237\u65b0\u5e94\u7528\u7684\u9875\u9762\uff0c\u53d1\u73b0\u8bbf\u95ee Reviews \u5931\u8d25\u4e86\uff1a \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u521b\u5efa DestinationRule \u5bf9\u8c61\uff0c DestinationRule \u5bf9\u8c61\u662f VirtualService \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6\uff0c\u7528\u6765\u5c06 VirtualService \u4e2d\u6307\u5b9a\u7684 subset \u4e0e\u5bf9\u5e94\u7684 Pod \u5173\u8054\u8d77\u6765\u3002 \u5728 samples/bookinfo/networking/destination-rule-all.yaml \u6587\u4ef6\u4e2d\u6709\u5b9a\u4e49\u6240\u6709\u8be5\u5e94\u7528\u4e2d\u8981\u7528\u5230\u7684\u6240\u6709 DestinationRule \u8d44\u6e90\u5bf9\u8c61\uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5c31\u662f\u5bf9 Reviews \u76f8\u5173\u7684 DestinationRule \u7684\u5b9a\u4e49: --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 # \u5339\u914dversion=v3\u6807\u7b7e\u7684Pod \u6211\u4eec\u53ef\u4ee5\u770b\u5230 DestinationRule \u4e2d\u5b9a\u4e49\u4e86 subsets \u96c6\u5408\uff0c\u5176\u4e2d labels \u5c31\u548c\u6211\u4eec\u4e4b\u524d Service \u7684 labelselector \u4e00\u6837\u662f\u53bb\u5339\u914d Pod \u7684 labels \u6807\u7b7e\u7684\uff0c \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc subsets \u4e2d\u5c31\u5305\u542b\u4e00\u4e2a\u540d\u4e3a v3 \u7684 subset \uff0c\u800c\u8fd9\u4e2a subset \u5339\u914d\u7684\u5c31\u662f\u5177\u6709 version=v3 \u8fd9\u4e2a label \u6807\u7b7e\u7684 Pod \u96c6\u5408\uff0c\u524d\u9762\u6211\u4eec\u521b\u5efa\u7684 Bookinfo \u4e2d\u4e5f\u6709\u8fd9\u4e2a\u6807\u7b7e\u7684 Pod: $ kubectl get pods -l version=v3 NAME READY STATUS RESTARTS AGE reviews-v3-84779c7bbc-fnqbg 2/2 Running 2 20h \u8fd9\u6837\u6211\u4eec\u5c31\u901a\u8fc7 DestinationRule \u5c06 VirtualService \u4e0e Service \u4e0d\u540c\u7684\u7248\u672c\u5173\u8054\u8d77\u6765\u4e86\u3002\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa DestinationRule \u8d44\u6e90\uff1a $ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml destinationrule.networking.istio.io/productpage created destinationrule.networking.istio.io/reviews created destinationrule.networking.istio.io/ratings created destinationrule.networking.istio.io/details created \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u76ee\u524d\u6211\u4eec\u7f51\u683c\u4e2d\u7684 DestinationRules: $ kubectl get destinationrule NAME HOST AGE details details 30s productpage productpage 30s ratings ratings 30s reviews reviews 30s \u6b64\u65f6\u518d\u8bbf\u95ee\u5e94\u7528\u5c31\u6210\u529f\u4e86\uff0c \u591a\u6b21\u5237\u65b0\u9875\u9762\u53d1\u73b0 Reviews \u59cb\u7ec8\u90fd\u5c55\u793a\u7684\u662f v3 \u7248\u672c\uff08\u5e26\u7ea2\u8272\u661f\u7684\uff09\u7684 Ratings \u4e86\uff0c\u8bf4\u660e\u6211\u4eec VirtualService \u7684\u914d\u7f6e\u6210\u529f\u4e86 \u3002 4\u3001\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219 \u521a\u521a\u6211\u4eec\u6f14\u793a\u7684\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u7684\u670d\u52a1\u7f51\u683c\u7684\u63a7\u5236\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u6f14\u793a\u4e0b\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u3002 \u9996\u5148\u79fb\u9664\u521a\u521a\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\uff0c\u6392\u9664\u5bf9\u73af\u5883\u7684\u5f71\u54cd\uff1a $ kubectl delete virtualservice reviews virtualservice.networking.istio.io \"reviews\" deleted $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 18h \u73b0\u5728\u6211\u4eec\u518d\u53bb\u8bbf\u95ee Bookinfo \u5e94\u7528\u53c8\u56de\u5230\u6700\u521d\u968f\u673a\u8bbf\u95ee Reviews \u7684\u60c5\u51b5\u4e86\u3002\u73b0\u5728\u6211\u4eec\u67e5\u770b\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-80-20.yaml \u7684\u5b9a\u4e49\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 weight: 80 - destination: host: reviews subset: v2 weight: 20 \u8fd9\u4e2a\u89c4\u5219\u5b9a\u4e49\u4e86 80% \u7684\u5bf9 Reviews \u7684\u6d41\u91cf\u4f1a\u843d\u5165\u5230 v1\uff08\u6ca1\u6709 Ratings\uff09\u8fd9\u4e2a subset\uff0c20% \u4f1a\u843d\u5165 v2\uff08\u5e26\u9ed1\u8272 Ratings\uff09\u5b50\u96c6\uff0c\u7136\u540e\u6211\u4eec\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml virtualservice.networking.istio.io/reviews created $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 18h reviews [\"reviews\"] 6s \u6211\u4eec\u67e5\u770b\u5f53\u524d\u7f51\u683c\u4e2d\u7684 VirtualService \u5bf9\u8c61\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6709 reviews \u4e86\uff0c\u8bc1\u660e\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u5e94\u7528\u4e2d\u6240\u6709\u7684 DestinationRules \u90fd\u5df2\u7ecf\u521b\u5efa\u8fc7\u4e86\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u8bbf\u95ee\u5e94\u7528\u5c31\u53ef\u4ee5\u4e86\uff0c\u6211\u4eec\u591a\u6b21\u5237\u65b0\uff0c\u53ef\u4ee5\u53d1\u73b0\u6ca1\u6709\u51fa\u73b0 Ratings \u7684\u6b21\u6570\u4e0e\u51fa\u73b0\u9ed1\u8272\u661f Ratings \u7684\u6bd4\u4f8b\u5927\u6982\u57284:1\u5de6\u53f3\uff0c\u5e76\u4e14\u6ca1\u6709\u7ea2\u8272\u661f\u7684 Ratings \u7684\u60c5\u51b5\u51fa\u73b0\uff0c\u8bf4\u660e\u6211\u4eec\u914d\u7f6e\u7684\u57fa\u4e8e\u6743\u91cd\u7684 VirtualService \u8bbf\u95ee\u89c4\u5219\u914d\u7f6e\u751f\u6548\u4e86\u3002 80% 20% 5\u3001\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219 \u9664\u4e86\u4e0a\u9762\u57fa\u4e8e\u670d\u52a1\u7248\u672c\u548c\u670d\u52a1\u6743\u91cd\u7684\u65b9\u5f0f\u63a7\u5236\u670d\u52a1\u8bbf\u95ee\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u6765\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\u3002 \u540c\u6837\uff0c\u5c06\u4e0a\u9762\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\u5220\u9664\uff1a $ kubectl delete virtualservice reviews virtualservice.networking.istio.io \"reviews\" deleted $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 18h \u67e5\u770b\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-jason-v2-v3.yaml \u7684\u5b9a\u4e49\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: jason route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v3 \u8fd9\u4e2a VirtualService \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 reviews \u670d\u52a1\u8bbf\u95ee\u7684 match \u89c4\u5219\uff0c\u610f\u601d\u662f\u5982\u679c\u5f53\u524d\u8bf7\u6c42\u7684 header \u4e2d\u5305\u542b jason \u8fd9\u4e2a\u7528\u6237\u4fe1\u606f\uff0c\u5219\u53ea\u4f1a\u8bbf\u95ee\u5230 v2 \u7684 reviews \u8fd9\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u5373\u90fd\u5e26\u9ed1\u661f\u7684\u6837\u5f0f\uff0c\u5982\u679c\u4e0d\u5305\u542b\u8be5\u7528\u6237\u4fe1\u606f\uff0c\u5219\u90fd\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u53d1\u7ed9 v3 \u8fd9\u4e2a reviews \u7684\u670d\u52a1\u3002 \u6211\u4eec\u5148\u4e0d\u542f\u7528\u8fd9\u4e2a VirtualService\uff0c\u5148\u53bb\u8bbf\u95ee\u4e0b Bookinfo \u8fd9\u4e2a\u5e94\u7528\u3002 \u53f3\u4e0a\u89d2\u6709\u767b\u5f55\u6309\u94ae\uff0c\u5728\u6ca1\u6709\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u5237\u65b0\u9875\u9762\uff0creviews \u670d\u52a1\u662f\u88ab\u968f\u673a\u8bbf\u95ee\u7684\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u5e26\u661f\u4e0d\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u70b9\u51fb\u767b\u5f55\uff0c \u5728\u5f39\u7a97\u4e2d User Name \u8f93\u5165 jason\uff0cPassword \u4e3a\u7a7a \uff0c\u767b\u5f55\uff1a \u518d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u8ddf\u672a\u767b\u5f55\u524d\u7684\u8bbf\u95ee\u89c4\u5219\u4e00\u6837\uff0c\u4e5f\u662f\u968f\u673a\u7684 \u3002 \u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8fd9\u4e2a\u5bf9\u8c61: $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml virtualservice.networking.istio.io/reviews created $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 18h reviews [\"reviews\"] 3s \u6b64\u65f6\u518d\u56de\u53bb\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u4e00\u76f4\u90fd\u662f\u9ed1\u661f\u7684 Reviews \u7248\u672c(v2)\u88ab\u8bbf\u95ee\u5230\u4e86\uff0c\u6ce8\u9500\u9000\u51fa\u540e\u518d\u8bbf\u95ee\uff0c\u6b64\u65f6\u53c8\u4e00\u76f4\u662f\u7ea2\u661f\u7684\u7248\u672c(v3)\u88ab\u8bbf\u95ee\u4e86\u3002 \u8bf4\u660e\u6211\u4eec\u57fa\u4e8e headers->end-user->exact:jason \u7684\u63a7\u5236\u89c4\u5219\u751f\u6548\u4e86 \u3002 \u5728 productpage \u670d\u52a1\u8c03\u7528 reviews \u670d\u52a1\u65f6\uff0c\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u4f1a\u5728 header \u4e2d\u5e26\u4e0a\u7528\u6237\u4fe1\u606f\uff0c\u901a\u8fc7 exact \u89c4\u5219\u5339\u914d\u5230\u76f8\u5173\u4fe1\u606f\u540e\uff0c\u6d41\u91cf\u88ab\u5f15\u5411\u4e86\u4e0a\u9762\u914d\u7f6e\u7684 v2 \u7248\u672c\u4e2d\u3002 \u8fd9\u91cc\u8981\u8bf4\u660e\u4e00\u4e0b match \u7684\u5339\u914d\u89c4\u5219\uff1a All conditions inside a single match block have AND semantics, while the list of match blocks have OR semantics. The rule is matched if any one of the match blocks succeed. \u610f\u601d\u662f\u4e00\u4e2a match \u5757\u91cc\u7684\u6761\u4ef6\u662f\u9700\u8981\u540c\u65f6\u6ee1\u8db3\u624d\u7b97\u5339\u914d\u6210\u529f\u7684\uff0c\u5982\u4e0b\u9762\u662f url \u524d\u7f00\u548c\u7aef\u53e3\u90fd\u5fc5\u987b\u90fd\u6ee1\u8db3\u624d\u7b97\u6210\u529f\uff1a - match: - uri: prefix: \"/wpcatalog\" port: 443 \u591a\u4e2a match \u5757\u4e4b\u95f4\u662f\u53ea\u8981\u6709\u4e00\u4e2a match \u5339\u914d\u6210\u529f\u4e86\uff0c\u5c31\u4f1a\u88ab\u8def\u7531\u5230\u5b83\u6307\u5b9a\u7684\u670d\u52a1\u7248\u672c\u53bb\uff0c\u800c\u5ffd\u7565\u5176\u4ed6\u7684\u3002\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\u5728\u767b\u5f55\u7684\u6761\u4ef6\u4e0b\uff0c\u6ee1\u8db3\u7b2c\u4e00\u4e2a match\uff0c\u6240\u4ee5\u670d\u52a1\u4e00\u76f4\u4f1a\u8bbf\u95ee\u5230 v2 \u7248\u672c\u3002\u9000\u51fa\u767b\u5f55\u540e\uff0c\u6ca1\u6709 match \u89c4\u5219\u6ee1\u8db3\u5339\u914d\uff0c\u6240\u4ee5\u5c31\u8d70\u6700\u540e\u4e00\u4e2a route \u89c4\u5219\uff0c\u5373 v3 \u7248\u672c\u3002","title":"\u7b2c\u4e8c\u8282 \u4f7f\u7528 Istio \u5b9e\u73b0\u975e\u4fb5\u5165\u6d41\u91cf\u6cbb\u7406"},{"location":"chap4/2Istio_flow_control/#istio","text":"Istio \u4e2d\u4e24\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6d41\u91cf\u7ba1\u7406\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a VirtualService \uff08\u865a\u62df\u670d\u52a1\uff09\uff1a\u7528\u6765\u5728 Istio \u4e2d\u5b9a\u4e49\u8def\u7531\u89c4\u5219\uff0c \u63a7\u5236\u6d41\u91cf\u8def\u7531\u5230\u670d\u52a1\u4e0a\u7684\u5404\u79cd\u884c\u4e3a \u3002 DestinationRule \uff08\u76ee\u6807\u89c4\u5219\uff09\uff1a \u865a\u62df\u670d\u52a1\u89c6\u5b9a\u4e49\u5c06\u6d41\u91cf\u5982\u4f55\u8def\u7531\u5230\u6307\u5b9a\u76ee\u6807\u5730\u5740\uff0c\u7136\u540e\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6765\u914d\u7f6e\u8be5\u76ee\u6807\u7684\u6d41\u91cf\uff0c\u5728\u8bc4\u4f30\u865a\u62df\u670d\u52a1\u8def\u7531\u89c4\u5219\u4e4b\u540e\uff0c\u76ee\u6807\u89c4\u5219\u5c06\u5e94\u7528\u4e8e\u6d41\u91cf\u7684\u771f\u5b9e\u76ee\u6807\u5730\u5740\u3002","title":"\u7b2c\u4e8c\u8282 \u4f7f\u7528 Istio \u5b9e\u73b0\u975e\u4fb5\u5165\u6d41\u91cf\u6cbb\u7406"},{"location":"chap4/2Istio_flow_control/#1virtualservice","text":"\u865a\u62df\u670d\u52a1\uff08VirtualService\uff09\u548c\u76ee\u6807\u89c4\u5219\uff08Destination Rule\uff09\u662f Istio \u6d41\u91cf\u8def\u7531\u529f\u80fd\u7684\u5173\u952e\u5bf9\u8c61\uff0c \u865a\u62df\u670d\u52a1\u914d\u7f6e\u5982\u4f55\u5728 Istio \u5185\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u670d\u52a1 \uff0c\u6bcf\u4e2a\u865a\u62df\u670d\u52a1\u5305\u542b\u4e00\u7ec4 \u8def\u7531\u89c4\u5219 \uff0cIstio \u4f1a\u6309\u5b9a\u4e49\u7684\u987a\u5e8f\u6765\u8bc4\u4f30\u5b83\u4eec\uff0cIstio \u5c06\u6bcf\u4e2a\u6307\u5b9a\u7684\u8bf7\u6c42\u5339\u914d\u5230\u865a\u62df\u670d\u52a1\u6307\u5b9a\u7684\u5b9e\u9645\u76ee\u6807\u5730\u5740\u3002\u5728\u7f51\u683c\u4e2d\u53ef\u4ee5\u6709\u591a\u4e2a\u865a\u62df\u670d\u52a1\uff0c\u4e5f\u53ef\u4ee5\u6ca1\u6709\u3002 \u4f7f\u7528\u865a\u62df\u670d\u52a1\uff0c\u4f60\u53ef\u4ee5\u4e3a\u4e00\u4e2a\u6216\u591a\u4e2a\u4e3b\u673a\u540d\u6307\u5b9a\u6d41\u91cf\u884c\u4e3a\uff0c\u5728\u865a\u62df\u670d\u52a1\u4e2d\u4f7f\u7528\u8def\u7531\u89c4\u5219\uff0c\u544a\u8bc9 Envoy \u5982\u4f55\u53d1\u9001\u865a\u62df\u670d\u52a1\u7684\u6d41\u91cf\u5230\u5408\u9002\u7684\u76ee\u6807\uff0c\u8def\u7531\u76ee\u6807\u5730\u5740\u53ef\u4ee5\u662f\u540c\u4e00\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\uff0c\u4e5f\u53ef\u4ee5\u662f\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\u3002 \u4e00\u4e2a\u5178\u578b\u7684\u4f7f\u7528\u573a\u666f\u662f\u5c06\u6d41\u91cf\u53d1\u9001\u5230\u6307\u5b9a\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u3002 \u5ba2\u6237\u7aef\u4f1a\u5c06\u865a\u62df\u670d\u52a1\u89c6\u4e3a\u4e00\u4e2a\u5355\u4e00\u5b9e\u4f53\uff0c\u5c06\u8bf7\u6c42\u53d1\u9001\u81f3\u865a\u62df\u670d\u52a1\u4e3b\u673a\uff0c\u7136\u540e Envoy \u6839\u636e\u865a\u62df\u670d\u52a1\u89c4\u5219\u628a\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684\u7248\u672c\u3002 \u6bd4\u5982\u628a 20% \u7684\u6d41\u91cf\u8def\u7531\u5230\u65b0\u7248\u672c \u6216 \u5c06\u8fd9\u4e9b\u7528\u6237\u7684\u8bf7\u6c42\u8def\u7531\u5230\u7248\u672c 2\uff0c\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u7136\u540e\u9010\u6b65\u589e\u52a0\u53d1\u9001\u5230\u65b0\u7248\u672c\u670d\u52a1\u7684\u6d41\u91cf\u767e\u5206\u6bd4\u3002 \u6d41\u91cf\u8def\u7531\u5b8c\u5168\u72ec\u7acb\u4e8e\u5b9e\u4f8b\u90e8\u7f72\uff0c\u6240\u4ee5\u5b9e\u73b0\u65b0\u7248\u672c\u670d\u52a1\u7684\u5b9e\u4f8b\u53ef\u4ee5\u6839\u636e\u6d41\u91cf\u7684\u8d1f\u8f7d\u6765\u4f38\u7f29\uff0c\u5b8c\u5168\u4e0d\u5f71\u54cd\u6d41\u91cf\u8def\u7531\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0cKubernetes \u5219\u53ea\u652f\u6301\u57fa\u4e8e\u5b9e\u4f8b\u7f29\u653e\u7684\u6d41\u91cf\u5206\u53d1\uff0c\u8fd9\u4f1a\u66f4\u590d\u6742\u3002 \u5982\u4e0b\u6240\u793a\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u865a\u62df\u670d\u52a1\uff0c\u6839\u636e\u8bf7\u6c42\u662f\u5426\u6765\u81ea\u67d0\u4e2a\u7279\u5b9a\u7528\u6237\uff0c\u628a\u5b83\u4eec\u8def\u7531\u5230\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u53bb\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: # \u5217\u51faVirtualService\u7684hosts\uff0c\u53ef\u4ee5\u662fIP\u3001DNS\u540d\u79f0\u3001FQDN\u6216* - reviews http: # \u5728\u4e0b\u9762\u914d\u7f6eVirtualService\u7684\u8def\u7531\u89c4\u5219\uff0c\u6307\u5b9a\u7b26\u5408\u54ea\u4e9b\u89c4\u5219\u7684\u6d41\u91cf\u6253\u5230\u54ea\u4e9bDestination\uff0c\u652f\u6301HTTP/1.1\uff0cHTTP2\uff0c\u53cagRPC\u7b49\u534f\u8bae - match: # \u6307\u5b9a\u5177\u4f53\u7684\u5339\u914d\u89c4\u5219 - headers: end-user: exact: jason route: - destination: # \u6307\u5b9a\u6ee1\u8db3\u89c4\u5219\u540e\u5c06\u6d41\u91cf\u6253\u5230\u54ea\u4e2a\u5177\u4f53\u7684Destination host: reviews subset: v2 - route: # \u6d41\u91cf\u89c4\u5219\u6309\u4ece\u4e0a\u5230\u4e0b\u7684\u4f18\u5148\u7ea7\u53bb\u5339\u914d\uff0c\u82e5\u4e0d\u6ee1\u8db3\u4e0a\u8ff0\u89c4\u5219\u65f6\uff0c\u8fdb\u5165\u8be5\u9ed8\u8ba4\u89c4\u5219 - destination: host: reviews subset: v3 \u6211\u4eec\u4f7f\u7528 hosts \u5b57\u6bb5\u5217\u4e3e\u865a\u62df\u670d\u52a1\u7684\u4e3b\u673a\u2014\u2014\u5373\u7528\u6237\u6307\u5b9a\u7684\u76ee\u6807\u6216\u662f\u8def\u7531\u89c4\u5219\u8bbe\u5b9a\u7684\u76ee\u6807\uff0c\u8fd9\u662f\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\u65f6\u4f7f\u7528\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u5730\u5740\u3002 hosts: - reviews \u865a\u62df\u670d\u52a1\u4e3b\u673a\u540d\u53ef\u4ee5\u662f IP \u5730\u5740\u3001DNS \u540d\u79f0\uff0c\u6bd4\u5982 Kubernetes Service \u7684\u77ed\u540d\u79f0\uff0c\u9690\u5f0f\u6216\u663e\u5f0f\u5730\u6307\u5411\u4e00\u4e2a\u5b8c\u5168\u9650\u5b9a\u57df\u540d\uff08FQDN\uff09\u3002 \u4e5f\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26\uff08\u201c*\u201d\uff09\u524d\u7f00\uff0c\u521b\u5efa\u4e00\u7ec4\u5339\u914d\u6240\u6709\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\u3002\u865a\u62df\u670d\u52a1\u7684 hosts \u5b57\u6bb5\u5b9e\u9645\u4e0a\u4e0d\u5fc5\u662f Istio \u670d\u52a1\u6ce8\u518c\u7684\u4e00\u90e8\u5206\uff0c\u5b83\u53ea\u662f\u865a\u62df\u7684\u76ee\u6807\u5730\u5740\uff0c\u8fd9\u6837\u53ef\u4ee5\u4e3a\u6ca1\u6709\u8def\u7531\u5230\u7f51\u683c\u5185\u90e8\u7684\u865a\u62df\u4e3b\u673a\u5efa\u6a21\u3002 \u7136\u540e\u63a5\u7740\u5c31\u662f\u8def\u7531\u89c4\u5219\u7684\u5b9a\u4e49\uff0c\u8fd9\u91cc\u901a\u8fc7 http \u5b57\u6bb5\u6765\u5b9a\u4e49\u865a\u62df\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\uff0c\u7528\u6765\u63cf\u8ff0\u5339\u914d\u6761\u4ef6\u548c\u8def\u7531\u884c\u4e3a\uff0c\u5b83\u4eec\u628a HTTP/1.1\u3001HTTP2 \u548c gRPC \u7b49\u6d41\u91cf\u53d1\u9001\u5230 hosts \u5b57\u6bb5\u6307\u5b9a\u7684\u76ee\u6807\uff0c\u4e00\u6761\u8def\u7531\u89c4\u5219\u5305\u542b\u4e86\u6307\u5b9a\u7684\u8bf7\u6c42\u8981\u6d41\u5411\u54ea\u4e2a\u76ee\u6807\u5730\u5740\uff0c\u53ef\u4ee5\u67090\u4e2a\u6216\u591a\u4e2a\u5339\u914d\u6761\u4ef6\u3002 \u6bd4\u5982\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684\u7b2c\u4e00\u4e2a\u8def\u7531\u89c4\u5219\u6709\u4e00\u4e2a\u6761\u4ef6\uff0c\u6240\u4ee5\u4f7f\u7528 match \u5b57\u6bb5\u5f00\u59cb\u5b9a\u4e49\uff0c\u6211\u4eec\u5e0c\u671b\u8be5\u8def\u7531\u5e94\u7528\u4e8e\u6765\u81ea jason \u7528\u6237\u7684\u6240\u6709\u8bf7\u6c42\uff0c\u6240\u4ee5\u4f7f\u7528 headers\u3001end-user \u548c exact \u5b57\u6bb5\u6765\u5339\u914d\u5408\u9002\u7684\u8bf7\u6c42 \u3002 - match: - headers: end-user: exact: jason \u7136\u540e\u540e\u9762\u7684 route \u90e8\u5206\u7684 destination \u5b57\u6bb5\u6307\u5b9a\u4e86\u7b26\u5408\u8be5\u6761\u4ef6\u7684\u6d41\u91cf\u7684\u5b9e\u9645\u76ee\u6807\u5730\u5740\uff0c\u4e0e\u865a\u62df\u670d\u52a1\u7684 hosts \u4e0d\u540c\uff0c destination \u7684 host \u5fc5\u987b\u662f\u5b58\u5728\u4e8e Istio \u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\u7684\u5b9e\u9645\u76ee\u6807\u5730\u5740\uff0c\u5426\u5219 Envoy \u4e0d\u77e5\u9053\u8be5\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u54ea\u91cc\u3002 \u53ef\u4ee5\u662f\u4e00\u4e2a\u6709\u4ee3\u7406\u7684\u670d\u52a1\u7f51\u683c\uff0c\u6216\u8005\u662f\u4e00\u4e2a\u901a\u8fc7\u670d\u52a1\u5165\u53e3\u88ab\u6dfb\u52a0\u8fdb\u6765\u7684\u975e\u7f51\u683c\u670d\u52a1\u3002\u672c\u793a\u4f8b\u8fd0\u884c\u5728 Kubernetes \u73af\u5883\u4e2d\uff0chost \u540d\u4e3a\u4e00\u4e2a Kubernetes \u670d\u52a1\u540d\uff1a route: - destination: host: reviews # Kubernetes Service \u77ed\u540d\u79f0 subset: v2 \u6b64\u5916 destination \u4e0b\u9762\u8fd8\u6307\u5b9a\u4e86 Kubernetes \u670d\u52a1\u7684\u5b50\u96c6\uff0c\u5c06\u7b26\u5408\u6b64\u89c4\u5219\u6761\u4ef6\u7684\u8bf7\u6c42\u8f6c\u5165\u5176\u4e2d\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u5b50\u96c6\u540d\u79f0\u662f v2\uff0c\u6211\u4eec\u4f1a\u5728\u76ee\u6807\u89c4\u5219\u4e2d\u770b\u5230\u5982\u4f55\u5b9a\u4e49\u670d\u52a1\u5b50\u96c6\u3002 \u8def\u7531\u89c4\u5219\u662f\u6309\u4ece\u4e0a\u5230\u4e0b\u7684\u987a\u5e8f\u9009\u62e9\u7684\uff0c \u865a\u62df\u670d\u52a1\u4e2d\u5b9a\u4e49\u7684\u7b2c\u4e00\u6761\u89c4\u5219\u6709\u6700\u9ad8\u4f18\u5148\u7ea7 \u3002\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684\u865a\u62df\u670d\u52a1\u4e2d\uff0c\u4e0d\u6ee1\u8db3\u7b2c\u4e00\u4e2a\u8def\u7531\u89c4\u5219\u7684\u6d41\u91cf\u5747\u4f1a\u6d41\u5411\u4e00\u4e2a\u9ed8\u8ba4\u7684\u76ee\u6807\uff0c\u7b2c\u4e8c\u6761\u89c4\u5219\u6ca1\u6709\u914d\u7f6e match \u6761\u4ef6\uff0c\u76f4\u63a5\u5c06\u6d41\u91cf\u5bfc\u5411 v3 \u5b50\u96c6\u3002 - route: - destination: host: reviews subset: v3 \u4e00\u822c\u5efa\u8bae\u63d0\u4f9b\u4e00\u4e2a\u9ed8\u8ba4\u7684 \u65e0\u6761\u4ef6\u6216\u57fa\u4e8e\u6743\u91cd\u7684\u89c4\u5219 \u4f5c\u4e3a\u6bcf\u4e00\u4e2a\u865a\u62df\u670d\u52a1\u7684\u6700\u540e\u4e00\u6761\u89c4\u5219\uff0c\u4ece\u800c\u786e\u4fdd\u6d41\u7ecf\u865a\u62df\u670d\u52a1\u7684\u6d41\u91cf\u81f3\u5c11\u80fd\u591f\u5339\u914d\u5230\u4e00\u6761\u8def\u7531\u89c4\u5219\u3002","title":"1\u3001VirtualService"},{"location":"chap4/2Istio_flow_control/#2destinationrule","text":"\u4e0e\u865a\u62df\u670d\u52a1\u4e00\u6837\uff0cDestinationRule\uff08\u76ee\u6807\u89c4\u5219\uff09\u4e5f\u662f Istio \u6d41\u91cf\u8def\u7531\u529f\u80fd\u7684\u5173\u952e\u90e8\u5206\uff0c \u6211\u4eec\u53ef\u4ee5\u5c06\u865a\u62df\u670d\u52a1\u770b\u6210\u5c06\u6d41\u91cf\u5982\u4f55\u8def\u7531\u5230\u6307\u5b9a\u76ee\u6807\u5730\u5740\uff0c\u7136\u540e\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6765\u914d\u7f6e\u8be5\u76ee\u6807\u7684\u6d41\u91cf \u3002 \u5728\u8bc4\u4f30\u865a\u62df\u670d\u52a1\u8def\u7531\u89c4\u5219\u4e4b\u540e\uff0c\u76ee\u6807\u89c4\u5219\u5c06\u5e94\u7528\u4e8e\u6d41\u91cf\u7684\u201c\u771f\u5b9e\u201d\u76ee\u6807\u5730\u5740\u3002 \u53ef\u4ee5\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6765\u6307\u5b9a\u547d\u540d\u7684\u670d\u52a1\u5b50\u96c6\uff0c\u4f8b\u5982\u6309\u7248\u672c\u4e3a\u6240\u6709\u6307\u5b9a\u670d\u52a1\u7684\u5b9e\u4f8b\u5206\u7ec4\uff0c\u7136\u540e\u53ef\u4ee5\u5728\u865a\u62df\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u670d\u52a1\u5b50\u96c6\u6765\u63a7\u5236\u5230\u670d\u52a1\u4e0d\u540c\u5b9e\u4f8b\u7684\u6d41\u91cf\u3002 \u76ee\u6807\u89c4\u5219\u8fd8\u5141\u8bb8\u4f60\u5728\u8c03\u7528\u6574\u4e2a\u76ee\u7684\u670d\u52a1\u6216\u7279\u5b9a\u670d\u52a1\u5b50\u96c6\u65f6\u5b9a\u5236 Envoy \u7684\u6d41\u91cf\u7b56\u7565\uff0c\u6bd4\u5982\u8d1f\u8f7d\u5747\u8861\u6a21\u578b\u3001TLS \u5b89\u5168\u6a21\u5f0f\u6216\u7194\u65ad\u5668\u8bbe\u7f6e \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio \u4f7f\u7528\u8f6e\u8be2\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u5b9e\u4f8b\u6c60\u4e2d\u7684\u6bcf\u4e2a\u5b9e\u4f8b\u4f9d\u6b21\u83b7\u53d6\u8bf7\u6c42\u3002 Istio \u540c\u65f6\u652f\u6301\u5982\u4e0b\u7684\u8d1f\u8f7d\u5747\u8861\u6a21\u578b\uff0c\u53ef\u4ee5\u5728 DestinationRule \u4e2d\u4e3a\u6d41\u5411\u67d0\u4e2a\u7279\u5b9a\u670d\u52a1\u6216\u670d\u52a1\u5b50\u96c6\u7684\u6d41\u91cf\u6307\u5b9a\u8fd9\u4e9b\u6a21\u578b\u3002 \u968f\u673a \uff1a\u8bf7\u6c42\u4ee5\u968f\u673a\u7684\u65b9\u5f0f\u8f6c\u5230\u6c60\u4e2d\u7684\u5b9e\u4f8b\u3002 \u6743\u91cd \uff1a\u8bf7\u6c42\u6839\u636e\u6307\u5b9a\u7684\u767e\u5206\u6bd4\u8f6c\u5230\u5b9e\u4f8b\u3002 \u6700\u5c11\u8bf7\u6c42 \uff1a\u8bf7\u6c42\u88ab\u8f6c\u5230\u6700\u5c11\u88ab\u8bbf\u95ee\u7684\u5b9e\u4f8b\u3002 \u6bd4\u5982\u5728\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u76ee\u6807\u89c4\u5219\u4e3a my-svc \u76ee\u6807\u670d\u52a1\u914d\u7f6e\u4e86 3 \u4e2a\u5177\u6709\u4e0d\u540c\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u7684\u5b50\u96c6\uff1a apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: my-destination-rule spec: host: my-svc trafficPolicy: loadBalancer: simple: RANDOM # \u968f\u673a\u7684\u7b56\u7565 subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 trafficPolicy: loadBalancer: simple: ROUND_ROBIN # \u8f6e\u8be2 - name: v3 labels: version: v3 \u6bcf\u4e2a\u5b50\u96c6\u90fd\u662f\u57fa\u4e8e\u4e00\u4e2a\u6216\u591a\u4e2a labels \u5b9a\u4e49\u7684\uff0c\u5728 Kubernetes \u4e2d\u5b83\u662f\u9644\u52a0\u5230 Pod \u8fd9\u79cd\u5bf9\u8c61\u4e0a\u7684\u952e/\u503c\u5bf9\u3002 \u9664\u4e86\u5b9a\u4e49\u5b50\u96c6\u4e4b\u5916\uff0c\u76ee\u6807\u89c4\u5219\u5bf9\u4e8e\u6240\u6709\u5b50\u96c6\u90fd\u6709\u9ed8\u8ba4\u7684\u6d41\u91cf\u7b56\u7565\uff0c\u800c\u5bf9\u4e8e\u5177\u4f53\u7684\u5b50\u96c6\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u7279\u5b9a\u4e8e\u5b50\u96c6\u7684\u7b56\u7565\u6765\u8986\u76d6\u5b83\u3002 \u4e0a\u9762\u7684\u793a\u4f8b\u5b9a\u4e49\u5728 subsets \u4e0a\u7684\u9ed8\u8ba4\u7b56\u7565\uff0c\u4e3a v1 \u548c v3 \u5b50\u96c6\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u968f\u673a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u5728 v2 \u7b56\u7565\u4e2d\uff0c\u6307\u5b9a\u4e86\u4e00\u4e2a\u8f6e\u8be2\u8d1f\u8f7d\u5747\u8861\u5668\u3002 \u5728\u5bf9\u865a\u62df\u670d\u52a1\u548c\u76ee\u6807\u89c4\u5219\u6709\u4e86\u521d\u6b65\u4e86\u89e3\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5bf9 Bookinfo \u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fdb\u884c\u4fee\u6539\u3002","title":"2\u3001DestinationRule"},{"location":"chap4/2Istio_flow_control/#3","text":"\u5bf9 Reviews \u670d\u52a1\u6dfb\u52a0\u4e00\u6761\u8def\u7531\u89c4\u5219\uff0c\u542f\u7528 samples/bookinfo/networking/virtual-service-reviews-v3.yaml \u5b9a\u4e49\u7684 VirtualService \u89c4\u5219\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v3 \u8fd9\u6837\uff0c\u6240\u6709\u8bbf\u95ee reviews \u670d\u52a1\u7684\u6d41\u91cf\u5c31\u4f1a\u88ab\u5f15\u5bfc\u5230 reviews \u670d\u52a1\u5bf9\u5e94\u7684 subset \u4e3a v3 \u7684 Pod \u4e2d\u3002\u542f\u7528\u8fd9\u6761\u89c4\u5219\uff1a $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml virtualservice.networking.istio.io/reviews created \u7136\u540e\u67e5\u770b\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff1a $ kubectl get virtualservices NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 17h reviews [\"reviews\"] 35s \u6211\u4eec\u53ef\u4ee5\u770b\u5230 reviews \u7684 VirtualService \u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u6b64\u65f6\u6211\u4eec\u53bb\u5237\u65b0\u5e94\u7528\u7684\u9875\u9762\uff0c\u53d1\u73b0\u8bbf\u95ee Reviews \u5931\u8d25\u4e86\uff1a \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u521b\u5efa DestinationRule \u5bf9\u8c61\uff0c DestinationRule \u5bf9\u8c61\u662f VirtualService \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6\uff0c\u7528\u6765\u5c06 VirtualService \u4e2d\u6307\u5b9a\u7684 subset \u4e0e\u5bf9\u5e94\u7684 Pod \u5173\u8054\u8d77\u6765\u3002 \u5728 samples/bookinfo/networking/destination-rule-all.yaml \u6587\u4ef6\u4e2d\u6709\u5b9a\u4e49\u6240\u6709\u8be5\u5e94\u7528\u4e2d\u8981\u7528\u5230\u7684\u6240\u6709 DestinationRule \u8d44\u6e90\u5bf9\u8c61\uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5c31\u662f\u5bf9 Reviews \u76f8\u5173\u7684 DestinationRule \u7684\u5b9a\u4e49: --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 # \u5339\u914dversion=v3\u6807\u7b7e\u7684Pod \u6211\u4eec\u53ef\u4ee5\u770b\u5230 DestinationRule \u4e2d\u5b9a\u4e49\u4e86 subsets \u96c6\u5408\uff0c\u5176\u4e2d labels \u5c31\u548c\u6211\u4eec\u4e4b\u524d Service \u7684 labelselector \u4e00\u6837\u662f\u53bb\u5339\u914d Pod \u7684 labels \u6807\u7b7e\u7684\uff0c \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc subsets \u4e2d\u5c31\u5305\u542b\u4e00\u4e2a\u540d\u4e3a v3 \u7684 subset \uff0c\u800c\u8fd9\u4e2a subset \u5339\u914d\u7684\u5c31\u662f\u5177\u6709 version=v3 \u8fd9\u4e2a label \u6807\u7b7e\u7684 Pod \u96c6\u5408\uff0c\u524d\u9762\u6211\u4eec\u521b\u5efa\u7684 Bookinfo \u4e2d\u4e5f\u6709\u8fd9\u4e2a\u6807\u7b7e\u7684 Pod: $ kubectl get pods -l version=v3 NAME READY STATUS RESTARTS AGE reviews-v3-84779c7bbc-fnqbg 2/2 Running 2 20h \u8fd9\u6837\u6211\u4eec\u5c31\u901a\u8fc7 DestinationRule \u5c06 VirtualService \u4e0e Service \u4e0d\u540c\u7684\u7248\u672c\u5173\u8054\u8d77\u6765\u4e86\u3002\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa DestinationRule \u8d44\u6e90\uff1a $ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml destinationrule.networking.istio.io/productpage created destinationrule.networking.istio.io/reviews created destinationrule.networking.istio.io/ratings created destinationrule.networking.istio.io/details created \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u76ee\u524d\u6211\u4eec\u7f51\u683c\u4e2d\u7684 DestinationRules: $ kubectl get destinationrule NAME HOST AGE details details 30s productpage productpage 30s ratings ratings 30s reviews reviews 30s \u6b64\u65f6\u518d\u8bbf\u95ee\u5e94\u7528\u5c31\u6210\u529f\u4e86\uff0c \u591a\u6b21\u5237\u65b0\u9875\u9762\u53d1\u73b0 Reviews \u59cb\u7ec8\u90fd\u5c55\u793a\u7684\u662f v3 \u7248\u672c\uff08\u5e26\u7ea2\u8272\u661f\u7684\uff09\u7684 Ratings \u4e86\uff0c\u8bf4\u660e\u6211\u4eec VirtualService \u7684\u914d\u7f6e\u6210\u529f\u4e86 \u3002","title":"3\u3001\u4e0d\u540c\u670d\u52a1\u7248\u672c\u8bbf\u95ee\u89c4\u5219"},{"location":"chap4/2Istio_flow_control/#4","text":"\u521a\u521a\u6211\u4eec\u6f14\u793a\u7684\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u7684\u670d\u52a1\u7f51\u683c\u7684\u63a7\u5236\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u6f14\u793a\u4e0b\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u3002 \u9996\u5148\u79fb\u9664\u521a\u521a\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\uff0c\u6392\u9664\u5bf9\u73af\u5883\u7684\u5f71\u54cd\uff1a $ kubectl delete virtualservice reviews virtualservice.networking.istio.io \"reviews\" deleted $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 18h \u73b0\u5728\u6211\u4eec\u518d\u53bb\u8bbf\u95ee Bookinfo \u5e94\u7528\u53c8\u56de\u5230\u6700\u521d\u968f\u673a\u8bbf\u95ee Reviews \u7684\u60c5\u51b5\u4e86\u3002\u73b0\u5728\u6211\u4eec\u67e5\u770b\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-80-20.yaml \u7684\u5b9a\u4e49\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 weight: 80 - destination: host: reviews subset: v2 weight: 20 \u8fd9\u4e2a\u89c4\u5219\u5b9a\u4e49\u4e86 80% \u7684\u5bf9 Reviews \u7684\u6d41\u91cf\u4f1a\u843d\u5165\u5230 v1\uff08\u6ca1\u6709 Ratings\uff09\u8fd9\u4e2a subset\uff0c20% \u4f1a\u843d\u5165 v2\uff08\u5e26\u9ed1\u8272 Ratings\uff09\u5b50\u96c6\uff0c\u7136\u540e\u6211\u4eec\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml virtualservice.networking.istio.io/reviews created $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 18h reviews [\"reviews\"] 6s \u6211\u4eec\u67e5\u770b\u5f53\u524d\u7f51\u683c\u4e2d\u7684 VirtualService \u5bf9\u8c61\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6709 reviews \u4e86\uff0c\u8bc1\u660e\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u5e94\u7528\u4e2d\u6240\u6709\u7684 DestinationRules \u90fd\u5df2\u7ecf\u521b\u5efa\u8fc7\u4e86\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u8bbf\u95ee\u5e94\u7528\u5c31\u53ef\u4ee5\u4e86\uff0c\u6211\u4eec\u591a\u6b21\u5237\u65b0\uff0c\u53ef\u4ee5\u53d1\u73b0\u6ca1\u6709\u51fa\u73b0 Ratings \u7684\u6b21\u6570\u4e0e\u51fa\u73b0\u9ed1\u8272\u661f Ratings \u7684\u6bd4\u4f8b\u5927\u6982\u57284:1\u5de6\u53f3\uff0c\u5e76\u4e14\u6ca1\u6709\u7ea2\u8272\u661f\u7684 Ratings \u7684\u60c5\u51b5\u51fa\u73b0\uff0c\u8bf4\u660e\u6211\u4eec\u914d\u7f6e\u7684\u57fa\u4e8e\u6743\u91cd\u7684 VirtualService \u8bbf\u95ee\u89c4\u5219\u914d\u7f6e\u751f\u6548\u4e86\u3002 80% 20%","title":"4\u3001\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219"},{"location":"chap4/2Istio_flow_control/#5","text":"\u9664\u4e86\u4e0a\u9762\u57fa\u4e8e\u670d\u52a1\u7248\u672c\u548c\u670d\u52a1\u6743\u91cd\u7684\u65b9\u5f0f\u63a7\u5236\u670d\u52a1\u8bbf\u95ee\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u6765\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\u3002 \u540c\u6837\uff0c\u5c06\u4e0a\u9762\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\u5220\u9664\uff1a $ kubectl delete virtualservice reviews virtualservice.networking.istio.io \"reviews\" deleted $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 18h \u67e5\u770b\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-jason-v2-v3.yaml \u7684\u5b9a\u4e49\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: jason route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v3 \u8fd9\u4e2a VirtualService \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 reviews \u670d\u52a1\u8bbf\u95ee\u7684 match \u89c4\u5219\uff0c\u610f\u601d\u662f\u5982\u679c\u5f53\u524d\u8bf7\u6c42\u7684 header \u4e2d\u5305\u542b jason \u8fd9\u4e2a\u7528\u6237\u4fe1\u606f\uff0c\u5219\u53ea\u4f1a\u8bbf\u95ee\u5230 v2 \u7684 reviews \u8fd9\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u5373\u90fd\u5e26\u9ed1\u661f\u7684\u6837\u5f0f\uff0c\u5982\u679c\u4e0d\u5305\u542b\u8be5\u7528\u6237\u4fe1\u606f\uff0c\u5219\u90fd\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u53d1\u7ed9 v3 \u8fd9\u4e2a reviews \u7684\u670d\u52a1\u3002 \u6211\u4eec\u5148\u4e0d\u542f\u7528\u8fd9\u4e2a VirtualService\uff0c\u5148\u53bb\u8bbf\u95ee\u4e0b Bookinfo \u8fd9\u4e2a\u5e94\u7528\u3002 \u53f3\u4e0a\u89d2\u6709\u767b\u5f55\u6309\u94ae\uff0c\u5728\u6ca1\u6709\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u5237\u65b0\u9875\u9762\uff0creviews \u670d\u52a1\u662f\u88ab\u968f\u673a\u8bbf\u95ee\u7684\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u5e26\u661f\u4e0d\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u70b9\u51fb\u767b\u5f55\uff0c \u5728\u5f39\u7a97\u4e2d User Name \u8f93\u5165 jason\uff0cPassword \u4e3a\u7a7a \uff0c\u767b\u5f55\uff1a \u518d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u8ddf\u672a\u767b\u5f55\u524d\u7684\u8bbf\u95ee\u89c4\u5219\u4e00\u6837\uff0c\u4e5f\u662f\u968f\u673a\u7684 \u3002 \u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8fd9\u4e2a\u5bf9\u8c61: $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml virtualservice.networking.istio.io/reviews created $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 18h reviews [\"reviews\"] 3s \u6b64\u65f6\u518d\u56de\u53bb\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u4e00\u76f4\u90fd\u662f\u9ed1\u661f\u7684 Reviews \u7248\u672c(v2)\u88ab\u8bbf\u95ee\u5230\u4e86\uff0c\u6ce8\u9500\u9000\u51fa\u540e\u518d\u8bbf\u95ee\uff0c\u6b64\u65f6\u53c8\u4e00\u76f4\u662f\u7ea2\u661f\u7684\u7248\u672c(v3)\u88ab\u8bbf\u95ee\u4e86\u3002 \u8bf4\u660e\u6211\u4eec\u57fa\u4e8e headers->end-user->exact:jason \u7684\u63a7\u5236\u89c4\u5219\u751f\u6548\u4e86 \u3002 \u5728 productpage \u670d\u52a1\u8c03\u7528 reviews \u670d\u52a1\u65f6\uff0c\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u4f1a\u5728 header \u4e2d\u5e26\u4e0a\u7528\u6237\u4fe1\u606f\uff0c\u901a\u8fc7 exact \u89c4\u5219\u5339\u914d\u5230\u76f8\u5173\u4fe1\u606f\u540e\uff0c\u6d41\u91cf\u88ab\u5f15\u5411\u4e86\u4e0a\u9762\u914d\u7f6e\u7684 v2 \u7248\u672c\u4e2d\u3002 \u8fd9\u91cc\u8981\u8bf4\u660e\u4e00\u4e0b match \u7684\u5339\u914d\u89c4\u5219\uff1a All conditions inside a single match block have AND semantics, while the list of match blocks have OR semantics. The rule is matched if any one of the match blocks succeed. \u610f\u601d\u662f\u4e00\u4e2a match \u5757\u91cc\u7684\u6761\u4ef6\u662f\u9700\u8981\u540c\u65f6\u6ee1\u8db3\u624d\u7b97\u5339\u914d\u6210\u529f\u7684\uff0c\u5982\u4e0b\u9762\u662f url \u524d\u7f00\u548c\u7aef\u53e3\u90fd\u5fc5\u987b\u90fd\u6ee1\u8db3\u624d\u7b97\u6210\u529f\uff1a - match: - uri: prefix: \"/wpcatalog\" port: 443 \u591a\u4e2a match \u5757\u4e4b\u95f4\u662f\u53ea\u8981\u6709\u4e00\u4e2a match \u5339\u914d\u6210\u529f\u4e86\uff0c\u5c31\u4f1a\u88ab\u8def\u7531\u5230\u5b83\u6307\u5b9a\u7684\u670d\u52a1\u7248\u672c\u53bb\uff0c\u800c\u5ffd\u7565\u5176\u4ed6\u7684\u3002\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\u5728\u767b\u5f55\u7684\u6761\u4ef6\u4e0b\uff0c\u6ee1\u8db3\u7b2c\u4e00\u4e2a match\uff0c\u6240\u4ee5\u670d\u52a1\u4e00\u76f4\u4f1a\u8bbf\u95ee\u5230 v2 \u7248\u672c\u3002\u9000\u51fa\u767b\u5f55\u540e\uff0c\u6ca1\u6709 match \u89c4\u5219\u6ee1\u8db3\u5339\u914d\uff0c\u6240\u4ee5\u5c31\u8d70\u6700\u540e\u4e00\u4e2a route \u89c4\u5219\uff0c\u5373 v3 \u7248\u672c\u3002","title":"5\u3001\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219"},{"location":"chap4/3Istio_fault_inject/","text":"\u7b2c\u4e09\u8282 Istio \u6d41\u91cf\u7ba1\u7406\u4e4b\u6545\u969c\u6ce8\u5165 \u5bf9\u4e8e\u4e00\u4e2a\u7cfb\u7edf\uff0c\u5c24\u5176\u662f\u4e00\u4e2a\u590d\u6742\u7684\u7cfb\u7edf\uff0c\u91cd\u8981\u7684\u4e0d\u662f\u6545\u969c\u4f1a\u4e0d\u4f1a\u53d1\u751f\uff0c\u800c\u662f\u4ec0\u4e48\u65f6\u5019\u53d1\u751f\u3002 \u6545\u969c\u5904\u7406\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458\u548c\u6d4b\u8bd5\u4eba\u5458\u6765\u8bf4\u90fd\u7279\u522b\u8017\u8d39\u65f6\u95f4\u548c\u7cbe\u529b\uff1a\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458\u6765\u8bf4\uff0c\u4ed6\u4eec\u5728\u5f00\u53d1\u4ee3\u7801\u65f6\u9700\u8981\u752820%\u7684\u65f6\u95f4\u519980%\u7684\u4e3b\u8981\u903b\u8f91\uff0c\u7136\u540e\u7559\u51fa80%\u7684\u65f6\u95f4\u5904\u7406\u5404\u79cd\u975e\u6b63\u5e38\u573a\u666f\uff1b\u5bf9\u4e8e\u6d4b\u8bd5\u4eba\u5458\u6765\u8bf4\uff0c\u9664\u4e86\u9700\u8981\u752880%\u7684\u65f6\u95f4\u519920%\u7684\u5f02\u5e38\u6d4b\u8bd5\u9879\uff0c\u66f4\u8981\u7528\u8d85\u8fc780%\u7684\u65f6\u95f4\u6267\u884c\u8fd9\u4e9b\u5f02\u5e38\u6d4b\u8bd5\u9879\uff0c\u5e76\u6784\u9020\u5404\u79cd\u6545\u969c\u573a\u666f\uff0c\u5c24\u5176\u662f\u90a3\u79cd\u7406\u8bba\u4e0a\u624d\u51fa\u73b0\u7684\u6545\u969c\uff0c\u8ba9\u4eba\u82e6\u4e0d\u582a\u8a00\u3002 \u6545\u969c\u6ce8\u5165 \u662f\u4e00\u79cd\u8bc4\u4f30\u7cfb\u7edf\u53ef\u9760\u6027\u7684\u6709\u6548\u65b9\u6cd5\uff0c\u4f8b\u5982\u5f02\u5e38\u5904\u7406\u3001\u6545\u969c\u6062\u590d\u7b49\u3002 \u53ea\u6709\u5f53\u7cfb\u7edf\u7684\u6240\u6709\u670d\u52a1\u90fd\u7ecf\u8fc7\u6545\u969c\u6d4b\u8bd5\u4e14\u5177\u5907\u5bb9\u9519\u80fd\u529b\u65f6\uff0c\u6574\u4e2a\u5e94\u7528\u624d\u5065\u58ee\u53ef\u9760\u3002 \u6545\u969c\u6ce8\u5165\u4ece\u65b9\u6cd5\u4e0a\u6765\u8bf4\u6709\u7f16\u8bd1\u671f\u6545\u969c\u6ce8\u5165\u548c\u8fd0\u884c\u671f\u6545\u969c\u6ce8\u5165\uff0c\u524d\u8005\u8981\u901a\u8fc7\u4fee\u6539\u4ee3\u7801\u6765\u6a21\u62df\u6545\u969c\uff0c\u540e\u8005\u5728\u8fd0\u884c\u9636\u6bb5\u89e6\u53d1\u6545\u969c\u3002 Istio \u7684\u6545\u969c\u6ce8\u5165\u5c31\u662f\u5728\u7f51\u683c\u4e2d\u5bf9\u7279\u5b9a\u7684\u5e94\u7528\u5c42\u534f\u8bae\u8fdb\u884c\u6545\u969c\u6ce8\u5165\uff0c\u8fd9\u6837\uff0c\u57fa\u4e8e Istio \u7684\u6545\u969c\u6ce8\u5165\u5c31\u53ef\u4ee5\u6a21\u62df\u51fa\u5e94\u7528\u7684\u6545\u969c\u573a\u666f\u4e86\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u8bf4\u660e\u5982\u4f55\u6ce8\u5165\u6545\u969c\u5e76\u6d4b\u8bd5\u5e94\u7528\u7a0b\u5e8f\u7684\u5f39\u6027\u3002 1\u3001\u5ef6\u8fdf\u6545\u969c\u6ce8\u5165 \u4e3a\u4e86\u6d4b\u8bd5\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f Bookinfo \u7684\u5f39\u6027\uff0c\u6211\u4eec\u5c06\u4e3a\u7528\u6237 jason \u5728 reviews:v2 \u548c ratings \u670d\u52a1\u4e4b\u95f4\u6ce8\u5165\u4e00\u4e2a 7 \u79d2\u7684\u5ef6\u8fdf\uff0c\u8fd9\u4e2a\u6d4b\u8bd5\u5c06\u4f1a\u53d1\u73b0\u4e00\u4e2a\u6545\u610f\u5f15\u5165 Bookinfo \u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684 bug\u3002 \u9996\u5148\u79fb\u9664\u4e4b\u524d\u521b\u5efa\u7684 VirtualService: $ kubectl delete virtualservice reviews virtualservice.networking.istio.io \"reviews\" deleted $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 19h \u4e3a\u4e86\u80fd\u591f\u8ba9\u8bf7\u6c42\u7a33\u5b9a\uff0c\u8fd9\u91cc\u6211\u4eec\u5bf9 Reviews \u670d\u52a1\u914d\u7f6e\u8bf7\u6c42\u8def\u7531\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml \uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: jason route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v1 \u4e0a\u9762\u7684\u914d\u7f6e\u5e94\u7528\u8fc7\u540e jason \u7528\u6237\u4f1a\u88ab\u8def\u7531\u5230 reviews:v2 \u7248\u672c\u670d\u52a1\uff0c\u5176\u4ed6\u7528\u6237\u8def\u7531\u5230 reviews:v1 \u7248\u672c\u670d\u52a1\u3002\u521b\u5efa\u6545\u969c\u6ce8\u5165\u89c4\u5219\u4ee5\u5ef6\u8fdf\u6765\u81ea\u6d4b\u8bd5\u7528\u6237 jason \u7684\u6d41\u91cf\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u4e3a samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml \uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: ratings spec: hosts: - ratings http: - match: - headers: end-user: exact: jason fault: delay: percentage: value: 100.0 fixedDelay: 7s route: - destination: host: ratings subset: v1 - route: - destination: host: ratings subset: v1 \u8fd9\u4e2a VirtualService \u5b9a\u4e49\u4e86\u4e00\u4e2a\u5728 jason \u767b\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u8bbf\u95ee ratings \u670d\u52a1\u7684 100% \u7684 7s \u8bbf\u95ee\u5ef6\u8fdf\u3002 \u524d\u9762\u6211\u4eec\u77e5\u9053\uff0cBookinfo \u8fd9\u4e2a\u793a\u4f8b productpage \u670d\u52a1\u8c03\u7528 reviews\uff0creviews \u7684\u4e0d\u540c\u7248\u672c\u4f1a\u5bf9 ratings \u8fdb\u884c\u4e0d\u540c\u7684\u8c03\u7528\uff0c\u5176\u4e2d reviews-v1 \u4e0d\u8c03\u7528 ratings\uff0creviews-v2 \u548c reviews-v3 \u4f1a\u8c03\u7528 ratings\uff0c\u5e76\u505a\u4e0d\u540c\u6837\u5f0f\u7684\u6e32\u67d3\u3002 \u6ce8\u610f reviews:v2 \u670d\u52a1\u5bf9 ratings \u670d\u52a1\u7684\u8c03\u7528\u5177\u6709 10 \u79d2\u7684\u786c\u7f16\u7801\u8fde\u63a5\u8d85\u65f6\u3002\u56e0\u6b64\uff0c\u5c3d\u7ba1\u5f15\u5165\u4e86 7 \u79d2\u7684\u5ef6\u8fdf\uff0c\u6211\u4eec\u4ecd\u7136\u671f\u671b\u7aef\u5230\u7aef\u7684\u6d41\u7a0b\u662f\u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u7684 \u3002 \u4e86\u89e3\u8fd9\u4e00\u70b9\u540e\uff0c\u6211\u4eec\u73b0\u5728\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml virtualservice.networking.istio.io/reviews created $ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml virtualservice.networking.istio.io/ratings created $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 19h ratings [\"ratings\"] 21s reviews [\"reviews\"] 66s \u901a\u8fc7\u6d4f\u89c8\u5668\u6253\u5f00 Bookinfo \u5e94\u7528\uff0c\u4f7f\u7528\u7528\u6237 jason \u767b\u5f55\u5230 /productpage \u9875\u9762\u3002 \u6211\u4eec\u671f\u671b\u7684\u662f Bookinfo \u4e3b\u9875\u5728\u5927\u7ea6 7 \u79d2\u949f\u52a0\u8f7d\u5b8c\u6210\u5e76\u4e14\u6ca1\u6709\u9519\u8bef\uff0c\u4f46\u662f Reviews \u90e8\u5206\u663e\u793a\u4e86\u4e00\u4e2a\u9519\u8bef\u6d88\u606f\uff1aSorry, product reviews are currently unavailable for this book. \u800c\u4e14\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u9875\u9762\u52a0\u8f7d\u5b9e\u9645\u4e0a\u7528\u4e86\u5927\u7ea66s\uff0c\u6309\u7167\u9884\u671f\uff0c\u6211\u4eec\u5f15\u5165\u7684 7s \u5ef6\u8fdf\u4e0d\u4f1a\u5f71\u54cd\u5230 reviews \u670d\u52a1\uff0c\u56e0\u4e3a reviews \u548c ratings \u670d\u52a1\u95f4\u7684\u8d85\u65f6\u88ab\u786c\u7f16\u7801\u4e3a 10 \u79d2\uff0c\u4f46\u5b9e\u9645\u4e0a\u5728 productpage \u548c reviews \u670d\u52a1\u4e4b\u95f4\u4e5f\u6709\u4e00\u4e2a 3s \u7684\u786c\u7f16\u7801\u7684\u8d85\u65f6\uff0c\u518d\u52a0 1 \u6b21\u91cd\u8bd5\uff0c\u4e00\u5171 6s\uff0c\u6240\u4ee5 productpage \u5bf9 reviews \u7684\u8c03\u7528\u5728 6s \u540e\u63d0\u524d\u8d85\u65f6\u5e76\u629b\u51fa\u9519\u8bef\u4e86\u3002 \u8fd9\u79cd\u7c7b\u578b\u7684\u9519\u8bef\u5728\u4e0d\u540c\u7684\u56e2\u961f\u72ec\u7acb\u5f00\u53d1\u4e0d\u540c\u7684\u5fae\u670d\u52a1\u7684\u4f01\u4e1a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u662f\u53ef\u80fd\u4f1a\u51fa\u73b0\u7684\uff0cIstio \u7684\u6545\u969c\u6ce8\u5165\u89c4\u5219\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u8bc6\u522b\u6b64\u7c7b\u5f02\u5e38\uff0c\u800c\u4e0d\u4f1a\u5f71\u54cd\u6700\u7ec8\u7528\u6237\u3002 \u8bf7\u6ce8\u610f\uff0c\u6b64\u6b21\u6545\u969c\u6ce8\u5165\u9650\u5236\u4e3a\u4ec5\u5f71\u54cd\u7528\u6237 jason\uff0c\u5982\u679c\u4f60\u4ee5\u4efb\u4f55\u5176\u4ed6\u7528\u6237\u8eab\u4efd\u767b\u5f55\uff0c\u5219\u4e0d\u4f1a\u9047\u5230\u4efb\u4f55\u5ef6\u8fdf\u3002 \u6211\u4eec\u53ef\u4ee5\u589e\u52a0 productpage \u4e0e reviews \u670d\u52a1\u4e4b\u95f4\u7684\u8d85\u65f6\u6216\u964d\u4f4e reviews \u4e0e ratings \u7684\u8d85\u65f6\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728 reviews \u670d\u52a1\u7684 v3 \u7248\u672c\u4e2d\u5df2\u7ecf\u4fee\u590d\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c reviews:v3 \u670d\u52a1\u5df2\u5c06 reviews \u4e0e ratings \u7684\u8d85\u65f6\u65f6\u95f4\u4ece 10s \u964d\u4f4e\u4e3a 2.5s\uff0c\u56e0\u6b64\u5b83\u53ef\u4ee5\u517c\u5bb9\uff08\u5c0f\u4e8e\uff09\u4e0b\u6e38\u7684 productpage \u7684\u8bf7\u6c42\u3002 \u5982\u679c\u6211\u4eec\u5c06\u4e0a\u9762 Reviews \u7684\u6d41\u91cf\u8f6c\u79fb\u5230 reviews:v3 \u670d\u52a1\uff0c\u7136\u540e\u53ef\u4ee5\u5c1d\u8bd5\u4fee\u6539\u5ef6\u8fdf\u89c4\u5219\u4e3a\u4efb\u4f55\u4f4e\u4e8e 2.5s \u7684\u6570\u503c\uff0c\u4f8b\u5982 2s\uff0c\u7136\u540e\u53ef\u4ee5\u786e\u8ba4\u7aef\u5230\u7aef\u7684\u6d41\u7a0b\u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u3002 \u901a\u8fc7\u8fd9\u79cd\u8d85\u65f6\u6545\u969c\u6ce8\u5165\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u65b9\u4fbf\u5730\u53d1\u73b0\u670d\u52a1\u95f4\u76f8\u4e92\u8bbf\u95ee\u4e2d\u5b58\u5728\u7684\u6f5c\u5728\u95ee\u9898\u3002 2\u3001\u4e2d\u65ad\u8bbf\u95ee\u6545\u969c\u6ce8\u5165 \u6d4b\u8bd5\u5fae\u670d\u52a1\u5f39\u6027\u7684\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u5f15\u5165 HTTP abort \u6545\u969c\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u7ed9 ratings \u5fae\u670d\u52a1\u4e3a\u6d4b\u8bd5\u7528\u6237 jason \u5f15\u5165\u4e00\u4e2a HTTP abort\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5e0c\u671b\u9875\u9762\u80fd\u591f\u7acb\u5373\u52a0\u8f7d\uff0c\u540c\u65f6\u663e\u793a Ratings service is currently unavailable \u8fd9\u6837\u7684\u6d88\u606f\u3002 \u8fd9\u91cc\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5230\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e3a samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml \uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: ratings spec: hosts: - ratings http: - match: - headers: end-user: exact: jason fault: abort: percentage: value: 100.0 httpStatus: 500 route: - destination: host: ratings subset: v1 - route: - destination: host: ratings subset: v1 \u4e0a\u9762\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\u914d\u7f6e\u4e86\u5728 jason \u767b\u5f55\u65f6\uff0creviews \u5bf9 ratings \u8bbf\u95ee\u65f6 100% \u7684\u8fd4\u56de\u4e00\u4e2a500\u9519\u8bef\u54cd\u5e94\u3002\u7136\u540e\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml virtualservice.networking.istio.io/ratings configured $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 19h ratings [\"ratings\"] 10m reviews [\"reviews\"] 11m \u73b0\u5728\u6211\u4eec\u56de\u5230 BookInfo \u5e94\u7528\uff0c\u767b\u5f55 jason\uff0c\u5237\u65b0\u9875\u9762\uff0c\u6709\u65f6\u5019\u53ef\u4ee5\u5f88\u5feb\u5c31\u770b\u5230 Rating \u670d\u52a1\u4e0d\u53ef\u7528\u7684\u63d0\u793a\u4fe1\u606f\uff1a \u5982\u679c\u6ce8\u9500\u7528\u6237 jason\uff0c\u6211\u4eec\u5c06\u770b\u5230 /productpage \u4e3a\u9664 jason \u4ee5\u5916\u7684\u5176\u4ed6\u7528\u6237\u8c03\u7528\u4e86 reviews:v1 \uff08\u5b8c\u5168\u4e0d\u8c03\u7528 ratings\uff09\uff0c\u56e0\u6b64\uff0c\u4e0d\u4f1a\u770b\u5230\u4efb\u4f55\u9519\u8bef\u6d88\u606f\uff0c\u4e0d\u4f1a\u663e\u793a\u661f\u6807\u7684\u56fe\u5f62\u3002","title":"\u7b2c\u4e09\u8282 Istio \u6d41\u91cf\u7ba1\u7406\u4e4b\u6545\u969c\u6ce8\u5165"},{"location":"chap4/3Istio_fault_inject/#istio","text":"\u5bf9\u4e8e\u4e00\u4e2a\u7cfb\u7edf\uff0c\u5c24\u5176\u662f\u4e00\u4e2a\u590d\u6742\u7684\u7cfb\u7edf\uff0c\u91cd\u8981\u7684\u4e0d\u662f\u6545\u969c\u4f1a\u4e0d\u4f1a\u53d1\u751f\uff0c\u800c\u662f\u4ec0\u4e48\u65f6\u5019\u53d1\u751f\u3002 \u6545\u969c\u5904\u7406\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458\u548c\u6d4b\u8bd5\u4eba\u5458\u6765\u8bf4\u90fd\u7279\u522b\u8017\u8d39\u65f6\u95f4\u548c\u7cbe\u529b\uff1a\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458\u6765\u8bf4\uff0c\u4ed6\u4eec\u5728\u5f00\u53d1\u4ee3\u7801\u65f6\u9700\u8981\u752820%\u7684\u65f6\u95f4\u519980%\u7684\u4e3b\u8981\u903b\u8f91\uff0c\u7136\u540e\u7559\u51fa80%\u7684\u65f6\u95f4\u5904\u7406\u5404\u79cd\u975e\u6b63\u5e38\u573a\u666f\uff1b\u5bf9\u4e8e\u6d4b\u8bd5\u4eba\u5458\u6765\u8bf4\uff0c\u9664\u4e86\u9700\u8981\u752880%\u7684\u65f6\u95f4\u519920%\u7684\u5f02\u5e38\u6d4b\u8bd5\u9879\uff0c\u66f4\u8981\u7528\u8d85\u8fc780%\u7684\u65f6\u95f4\u6267\u884c\u8fd9\u4e9b\u5f02\u5e38\u6d4b\u8bd5\u9879\uff0c\u5e76\u6784\u9020\u5404\u79cd\u6545\u969c\u573a\u666f\uff0c\u5c24\u5176\u662f\u90a3\u79cd\u7406\u8bba\u4e0a\u624d\u51fa\u73b0\u7684\u6545\u969c\uff0c\u8ba9\u4eba\u82e6\u4e0d\u582a\u8a00\u3002 \u6545\u969c\u6ce8\u5165 \u662f\u4e00\u79cd\u8bc4\u4f30\u7cfb\u7edf\u53ef\u9760\u6027\u7684\u6709\u6548\u65b9\u6cd5\uff0c\u4f8b\u5982\u5f02\u5e38\u5904\u7406\u3001\u6545\u969c\u6062\u590d\u7b49\u3002 \u53ea\u6709\u5f53\u7cfb\u7edf\u7684\u6240\u6709\u670d\u52a1\u90fd\u7ecf\u8fc7\u6545\u969c\u6d4b\u8bd5\u4e14\u5177\u5907\u5bb9\u9519\u80fd\u529b\u65f6\uff0c\u6574\u4e2a\u5e94\u7528\u624d\u5065\u58ee\u53ef\u9760\u3002 \u6545\u969c\u6ce8\u5165\u4ece\u65b9\u6cd5\u4e0a\u6765\u8bf4\u6709\u7f16\u8bd1\u671f\u6545\u969c\u6ce8\u5165\u548c\u8fd0\u884c\u671f\u6545\u969c\u6ce8\u5165\uff0c\u524d\u8005\u8981\u901a\u8fc7\u4fee\u6539\u4ee3\u7801\u6765\u6a21\u62df\u6545\u969c\uff0c\u540e\u8005\u5728\u8fd0\u884c\u9636\u6bb5\u89e6\u53d1\u6545\u969c\u3002 Istio \u7684\u6545\u969c\u6ce8\u5165\u5c31\u662f\u5728\u7f51\u683c\u4e2d\u5bf9\u7279\u5b9a\u7684\u5e94\u7528\u5c42\u534f\u8bae\u8fdb\u884c\u6545\u969c\u6ce8\u5165\uff0c\u8fd9\u6837\uff0c\u57fa\u4e8e Istio \u7684\u6545\u969c\u6ce8\u5165\u5c31\u53ef\u4ee5\u6a21\u62df\u51fa\u5e94\u7528\u7684\u6545\u969c\u573a\u666f\u4e86\u3002 \u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u8bf4\u660e\u5982\u4f55\u6ce8\u5165\u6545\u969c\u5e76\u6d4b\u8bd5\u5e94\u7528\u7a0b\u5e8f\u7684\u5f39\u6027\u3002","title":"\u7b2c\u4e09\u8282 Istio \u6d41\u91cf\u7ba1\u7406\u4e4b\u6545\u969c\u6ce8\u5165"},{"location":"chap4/3Istio_fault_inject/#1","text":"\u4e3a\u4e86\u6d4b\u8bd5\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f Bookinfo \u7684\u5f39\u6027\uff0c\u6211\u4eec\u5c06\u4e3a\u7528\u6237 jason \u5728 reviews:v2 \u548c ratings \u670d\u52a1\u4e4b\u95f4\u6ce8\u5165\u4e00\u4e2a 7 \u79d2\u7684\u5ef6\u8fdf\uff0c\u8fd9\u4e2a\u6d4b\u8bd5\u5c06\u4f1a\u53d1\u73b0\u4e00\u4e2a\u6545\u610f\u5f15\u5165 Bookinfo \u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684 bug\u3002 \u9996\u5148\u79fb\u9664\u4e4b\u524d\u521b\u5efa\u7684 VirtualService: $ kubectl delete virtualservice reviews virtualservice.networking.istio.io \"reviews\" deleted $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 19h \u4e3a\u4e86\u80fd\u591f\u8ba9\u8bf7\u6c42\u7a33\u5b9a\uff0c\u8fd9\u91cc\u6211\u4eec\u5bf9 Reviews \u670d\u52a1\u914d\u7f6e\u8bf7\u6c42\u8def\u7531\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml \uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: jason route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v1 \u4e0a\u9762\u7684\u914d\u7f6e\u5e94\u7528\u8fc7\u540e jason \u7528\u6237\u4f1a\u88ab\u8def\u7531\u5230 reviews:v2 \u7248\u672c\u670d\u52a1\uff0c\u5176\u4ed6\u7528\u6237\u8def\u7531\u5230 reviews:v1 \u7248\u672c\u670d\u52a1\u3002\u521b\u5efa\u6545\u969c\u6ce8\u5165\u89c4\u5219\u4ee5\u5ef6\u8fdf\u6765\u81ea\u6d4b\u8bd5\u7528\u6237 jason \u7684\u6d41\u91cf\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u4e3a samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml \uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: ratings spec: hosts: - ratings http: - match: - headers: end-user: exact: jason fault: delay: percentage: value: 100.0 fixedDelay: 7s route: - destination: host: ratings subset: v1 - route: - destination: host: ratings subset: v1 \u8fd9\u4e2a VirtualService \u5b9a\u4e49\u4e86\u4e00\u4e2a\u5728 jason \u767b\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u8bbf\u95ee ratings \u670d\u52a1\u7684 100% \u7684 7s \u8bbf\u95ee\u5ef6\u8fdf\u3002 \u524d\u9762\u6211\u4eec\u77e5\u9053\uff0cBookinfo \u8fd9\u4e2a\u793a\u4f8b productpage \u670d\u52a1\u8c03\u7528 reviews\uff0creviews \u7684\u4e0d\u540c\u7248\u672c\u4f1a\u5bf9 ratings \u8fdb\u884c\u4e0d\u540c\u7684\u8c03\u7528\uff0c\u5176\u4e2d reviews-v1 \u4e0d\u8c03\u7528 ratings\uff0creviews-v2 \u548c reviews-v3 \u4f1a\u8c03\u7528 ratings\uff0c\u5e76\u505a\u4e0d\u540c\u6837\u5f0f\u7684\u6e32\u67d3\u3002 \u6ce8\u610f reviews:v2 \u670d\u52a1\u5bf9 ratings \u670d\u52a1\u7684\u8c03\u7528\u5177\u6709 10 \u79d2\u7684\u786c\u7f16\u7801\u8fde\u63a5\u8d85\u65f6\u3002\u56e0\u6b64\uff0c\u5c3d\u7ba1\u5f15\u5165\u4e86 7 \u79d2\u7684\u5ef6\u8fdf\uff0c\u6211\u4eec\u4ecd\u7136\u671f\u671b\u7aef\u5230\u7aef\u7684\u6d41\u7a0b\u662f\u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u7684 \u3002 \u4e86\u89e3\u8fd9\u4e00\u70b9\u540e\uff0c\u6211\u4eec\u73b0\u5728\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml virtualservice.networking.istio.io/reviews created $ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml virtualservice.networking.istio.io/ratings created $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 19h ratings [\"ratings\"] 21s reviews [\"reviews\"] 66s \u901a\u8fc7\u6d4f\u89c8\u5668\u6253\u5f00 Bookinfo \u5e94\u7528\uff0c\u4f7f\u7528\u7528\u6237 jason \u767b\u5f55\u5230 /productpage \u9875\u9762\u3002 \u6211\u4eec\u671f\u671b\u7684\u662f Bookinfo \u4e3b\u9875\u5728\u5927\u7ea6 7 \u79d2\u949f\u52a0\u8f7d\u5b8c\u6210\u5e76\u4e14\u6ca1\u6709\u9519\u8bef\uff0c\u4f46\u662f Reviews \u90e8\u5206\u663e\u793a\u4e86\u4e00\u4e2a\u9519\u8bef\u6d88\u606f\uff1aSorry, product reviews are currently unavailable for this book. \u800c\u4e14\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u9875\u9762\u52a0\u8f7d\u5b9e\u9645\u4e0a\u7528\u4e86\u5927\u7ea66s\uff0c\u6309\u7167\u9884\u671f\uff0c\u6211\u4eec\u5f15\u5165\u7684 7s \u5ef6\u8fdf\u4e0d\u4f1a\u5f71\u54cd\u5230 reviews \u670d\u52a1\uff0c\u56e0\u4e3a reviews \u548c ratings \u670d\u52a1\u95f4\u7684\u8d85\u65f6\u88ab\u786c\u7f16\u7801\u4e3a 10 \u79d2\uff0c\u4f46\u5b9e\u9645\u4e0a\u5728 productpage \u548c reviews \u670d\u52a1\u4e4b\u95f4\u4e5f\u6709\u4e00\u4e2a 3s \u7684\u786c\u7f16\u7801\u7684\u8d85\u65f6\uff0c\u518d\u52a0 1 \u6b21\u91cd\u8bd5\uff0c\u4e00\u5171 6s\uff0c\u6240\u4ee5 productpage \u5bf9 reviews \u7684\u8c03\u7528\u5728 6s \u540e\u63d0\u524d\u8d85\u65f6\u5e76\u629b\u51fa\u9519\u8bef\u4e86\u3002 \u8fd9\u79cd\u7c7b\u578b\u7684\u9519\u8bef\u5728\u4e0d\u540c\u7684\u56e2\u961f\u72ec\u7acb\u5f00\u53d1\u4e0d\u540c\u7684\u5fae\u670d\u52a1\u7684\u4f01\u4e1a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u662f\u53ef\u80fd\u4f1a\u51fa\u73b0\u7684\uff0cIstio \u7684\u6545\u969c\u6ce8\u5165\u89c4\u5219\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u8bc6\u522b\u6b64\u7c7b\u5f02\u5e38\uff0c\u800c\u4e0d\u4f1a\u5f71\u54cd\u6700\u7ec8\u7528\u6237\u3002 \u8bf7\u6ce8\u610f\uff0c\u6b64\u6b21\u6545\u969c\u6ce8\u5165\u9650\u5236\u4e3a\u4ec5\u5f71\u54cd\u7528\u6237 jason\uff0c\u5982\u679c\u4f60\u4ee5\u4efb\u4f55\u5176\u4ed6\u7528\u6237\u8eab\u4efd\u767b\u5f55\uff0c\u5219\u4e0d\u4f1a\u9047\u5230\u4efb\u4f55\u5ef6\u8fdf\u3002 \u6211\u4eec\u53ef\u4ee5\u589e\u52a0 productpage \u4e0e reviews \u670d\u52a1\u4e4b\u95f4\u7684\u8d85\u65f6\u6216\u964d\u4f4e reviews \u4e0e ratings \u7684\u8d85\u65f6\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728 reviews \u670d\u52a1\u7684 v3 \u7248\u672c\u4e2d\u5df2\u7ecf\u4fee\u590d\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c reviews:v3 \u670d\u52a1\u5df2\u5c06 reviews \u4e0e ratings \u7684\u8d85\u65f6\u65f6\u95f4\u4ece 10s \u964d\u4f4e\u4e3a 2.5s\uff0c\u56e0\u6b64\u5b83\u53ef\u4ee5\u517c\u5bb9\uff08\u5c0f\u4e8e\uff09\u4e0b\u6e38\u7684 productpage \u7684\u8bf7\u6c42\u3002 \u5982\u679c\u6211\u4eec\u5c06\u4e0a\u9762 Reviews \u7684\u6d41\u91cf\u8f6c\u79fb\u5230 reviews:v3 \u670d\u52a1\uff0c\u7136\u540e\u53ef\u4ee5\u5c1d\u8bd5\u4fee\u6539\u5ef6\u8fdf\u89c4\u5219\u4e3a\u4efb\u4f55\u4f4e\u4e8e 2.5s \u7684\u6570\u503c\uff0c\u4f8b\u5982 2s\uff0c\u7136\u540e\u53ef\u4ee5\u786e\u8ba4\u7aef\u5230\u7aef\u7684\u6d41\u7a0b\u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u3002 \u901a\u8fc7\u8fd9\u79cd\u8d85\u65f6\u6545\u969c\u6ce8\u5165\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u65b9\u4fbf\u5730\u53d1\u73b0\u670d\u52a1\u95f4\u76f8\u4e92\u8bbf\u95ee\u4e2d\u5b58\u5728\u7684\u6f5c\u5728\u95ee\u9898\u3002","title":"1\u3001\u5ef6\u8fdf\u6545\u969c\u6ce8\u5165"},{"location":"chap4/3Istio_fault_inject/#2","text":"\u6d4b\u8bd5\u5fae\u670d\u52a1\u5f39\u6027\u7684\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u5f15\u5165 HTTP abort \u6545\u969c\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u7ed9 ratings \u5fae\u670d\u52a1\u4e3a\u6d4b\u8bd5\u7528\u6237 jason \u5f15\u5165\u4e00\u4e2a HTTP abort\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5e0c\u671b\u9875\u9762\u80fd\u591f\u7acb\u5373\u52a0\u8f7d\uff0c\u540c\u65f6\u663e\u793a Ratings service is currently unavailable \u8fd9\u6837\u7684\u6d88\u606f\u3002 \u8fd9\u91cc\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5230\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e3a samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml \uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: ratings spec: hosts: - ratings http: - match: - headers: end-user: exact: jason fault: abort: percentage: value: 100.0 httpStatus: 500 route: - destination: host: ratings subset: v1 - route: - destination: host: ratings subset: v1 \u4e0a\u9762\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\u914d\u7f6e\u4e86\u5728 jason \u767b\u5f55\u65f6\uff0creviews \u5bf9 ratings \u8bbf\u95ee\u65f6 100% \u7684\u8fd4\u56de\u4e00\u4e2a500\u9519\u8bef\u54cd\u5e94\u3002\u7136\u540e\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml virtualservice.networking.istio.io/ratings configured $ kubectl get virtualservice NAME GATEWAYS HOSTS AGE bookinfo [\"bookinfo-gateway\"] [\"*\"] 19h ratings [\"ratings\"] 10m reviews [\"reviews\"] 11m \u73b0\u5728\u6211\u4eec\u56de\u5230 BookInfo \u5e94\u7528\uff0c\u767b\u5f55 jason\uff0c\u5237\u65b0\u9875\u9762\uff0c\u6709\u65f6\u5019\u53ef\u4ee5\u5f88\u5feb\u5c31\u770b\u5230 Rating \u670d\u52a1\u4e0d\u53ef\u7528\u7684\u63d0\u793a\u4fe1\u606f\uff1a \u5982\u679c\u6ce8\u9500\u7528\u6237 jason\uff0c\u6211\u4eec\u5c06\u770b\u5230 /productpage \u4e3a\u9664 jason \u4ee5\u5916\u7684\u5176\u4ed6\u7528\u6237\u8c03\u7528\u4e86 reviews:v1 \uff08\u5b8c\u5168\u4e0d\u8c03\u7528 ratings\uff09\uff0c\u56e0\u6b64\uff0c\u4e0d\u4f1a\u770b\u5230\u4efb\u4f55\u9519\u8bef\u6d88\u606f\uff0c\u4e0d\u4f1a\u663e\u793a\u661f\u6807\u7684\u56fe\u5f62\u3002","title":"2\u3001\u4e2d\u65ad\u8bbf\u95ee\u6545\u969c\u6ce8\u5165"},{"location":"chap4/4Istio_ServiceEntry_issue/","text":"\u7b2c\u56db\u8282 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def \u6700\u8fd1\u5728\u5f00\u59cb\u7814\u7a76 istio \u4f7f\u7528\uff0c\u5df2\u7ecf\u5728\u4e00\u4e2a\u672a\u5b89\u88c5 istio \u96c6\u7fa4\u7684\u73af\u5883\u4e2d\u6210\u529f\u641e\u5b9a istio \u5b89\u88c5\u914d\u7f6e\u4e14\u80fd\u6b63\u5e38\u4f7f\u7528\u3002 \u4f46\u662f\u6700\u8fd1\u5728\u4e00\u4e2a\u65b0\u5347\u7ea7\u7684 istio \u7248\u672c(1.11.0)\u7684\u96c6\u7fa4\u4e2d\uff0c\u6240\u6709\u88ab\u6ce8\u5165 istio sidecar \u7684 pod \u5747\u65e0\u6cd5\u5bf9\u5916\u8bbf\u95ee https \u3002\u5bfc\u81f4\u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u3002\u5177\u4f53\u8868\u73b0\u4e3a IP \u80fd\u901a\uff0c\u4f46\u662f\u65e0\u6cd5 tls \u63e1\u624b\u6210\u529f\u3002 \u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u7684\u521d\u671f\u8868\u73b0\u4e3a\u83b7\u53d6\u914d\u7f6e\u65f6\u63d0\u793a 404 \u3002 \u5728\u4e00\u6bb5\u65f6\u95f4\u540e\u7a81\u7136\u8868\u73b0\u4e3a\u65e0\u6cd5\u5efa\u7acb tls \uff0c\u8fd4\u56de 000 \u3002 \u6240\u6709\u5bf9\u5916\u7684 https \u670d\u52a1\u5747\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee \u3002 \u5728\u521d\u671f debug \u540e\uff0c\u8868\u73b0\u66f4\u4e3a\u8be1\u5f02\uff0c\u5728\u4e0d\u540c\u7684 pod \u4e2d\u6709\u4e0d\u540c\u7684\u8868\u73b0\uff1a \u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u7a81\u7136\u62d2\u7edd\u8fde\u63a5\u3002 \u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c \u670d\u52a1\u7aef\u8fd4\u56de\u4e0e\u670d\u52a1\u7aef\u672c\u8eab\u4e0d\u7b26\u5408\u7684\u8bc1\u4e66 \u3002\u4f8b\u5982\uff1a curl https://baidu.com \u63d0\u793a\u670d\u52a1\u7aef\u8bc1\u4e66\u4e3a *.example.com \u3002 \u5728\u8df3\u8fc7\u8bc1\u4e66\u9a8c\u8bc1\u540e\uff0c\u670d\u52a1\u7aef\u54cd\u5e94\u4e86\u975e\u9884\u671f\u7684\u5185\u5bb9\u3002 1\u3001\u521d\u6b65\u5206\u6790 \u7531\u4e8e\u65e0\u6cd5\u8bbf\u95ee\u5916\u90e8 https \uff0c\u521d\u671f\u731c\u60f3\u53ef\u80fd\u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u8bbf\u95ee\u7b56\u7565\u6216\u8005\u5176\u4ed6\u5b89\u5168\u76f8\u5173\u914d\u7f6e\uff0c\u6216\u8005\u5728 https \u4ee3\u7406\u4e0a\u51fa\u73b0\u4e86\u67d0\u4e9b\u914d\u7f6e\u9519\u8bef\u3002 \u5728\u95ee\u9898\u51fa\u73b0\u540e\u7684\u4e00\u6bb5\u65f6\u95f4\u4e2d\uff0c\u6211\u4eec\u5bf9\u6bd4\u4e86\u6b63\u5e38\u4f7f\u7528 istio \u96c6\u7fa4\u548c\u95ee\u9898\u96c6\u7fa4\u7684 istio \u914d\u7f6e\uff0c\u6240\u6709 crd\u3002\u5747\u672a\u53d1\u73b0\u7279\u6b8a\u914d\u7f6e\u3002 \u4f46\u662f\u989d\u5916\u7684\uff0c\u8be5\u96c6\u7fa4\u6709\u51e0\u4e2a\u6bd4\u8f83\u7279\u6b8a\u7684\u5730\u65b9\uff1a 1\u3001 \u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u5bf9\u5916\uff08\u516c\u7f51\u670d\u52a1\uff09\u8bbf\u95ee\u7684 serviceentry\uff0c\u5982\u4e0b \uff1a \u90e8\u5206\u9690\u79c1\u57df\u540d\u5df2\u7ecf\u5220\u9664\uff0c\u8fd9\u6761\u914d\u7f6e\u91cc\u9762\u7684\u57df\u540d\u603b\u6570\u591a\u8fbe\u51e0\u5341\u6761\u3002 \u7ecf\u8fc7\u8be2\u95ee\uff0c\u5f97\u5230\u7684\u7b54\u590d\u4e3a\uff1a \u9700\u8981\u5728 serviceentry \u4e2d\u52a0\u4e0a\u8fd9\u4e9b\u57df\u540d\u624d\u80fd\u4f7f mesh \u4e2d\u7684\u670d\u52a1\u6b63\u5e38\u5bf9\u5916\u8bbf\u95ee\u3002 2\u3001\u96c6\u7fa4\u4e2d\u8fd8\u8fd0\u884c\u4e86\u4e00\u4e2a dns-controller ,\u662f\u4e00\u4e2a\u548c istio \u6709\u5173\u7684\u63a7\u5236\u5668\u3002 \u7528\u4e8e\u8de8\u96c6\u7fa4\u7684 dns \u53d1\u73b0\u7b49\u3002\u5728\u8fd9\u91cc\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u5bf9 mesh \u7684\u57df\u540d\u505a\u4e86 CNAME \u7c7b\u4f3c\u7684\u64cd\u4f5c \u3002 \u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5728\u547d\u540d\u7a7a\u95f4 abc \u4e2d\u8fd0\u884c\u7740\u670d\u52a1 service-api \u9ed8\u8ba4\u8bbf\u95ee\u57df\u540d\u4e3a service-api.abc ,\u5728 istio \u4e2d\u9700\u8981\u5b9e\u73b0\u80fd\u591f\u901a\u8fc7 service-api.hello \u8bbf\u95ee\u3002\u4e8e\u662f\u8be5 controller \u5728\u7a7a\u95f4\u5185\u751f\u6210\u4e86\u670d\u52a1\u5bf9\u5e94\u7684 serviceentry \u7528\u4e8e \u201cCNAME\u201d \u3002 \u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f \u56e0\u4e3a istio \u9ed8\u8ba4\u4e0d\u9650\u5236 mesh \u5bf9\u516c\u7f51\u7684\u8bbf\u95ee\uff0c\u800c\u4e14\u5728\u6b63\u5e38\u7684\u96c6\u7fa4\u4e2d\u4e5f\u65e0\u9700\u8fd9\u4e2a\u914d\u7f6e\u3002 \u5728\u8fd9\u4e4b\u524d\uff0c\u7531\u4e8e\u9ed8\u8ba4 sidecar \u83b7\u53d6\u5168\u5c40\u7684 mesh \u914d\u7f6e\u5bfc\u81f4 sidecar \u5185\u5b58\u5360\u7528\u8d85 1GB\u3002\u6211\u4eec\u8fd8\u4f7f\u7528\u4e86 sidecar \u5c06\u914d\u7f6e\u9650\u5236\u5728\u5f53\u524d\u4e00\u4e2a\u7a7a\u95f4\u5185\u4ee5\u51cf\u5c11 sidecar \u5360\u7528\u3002 apiVersion: networking.istio.io/v1beta1 kind: Sidecar spec: egress: - hosts: - ./* \u5728\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u51e0\u4e2a\u65b9\u5411\uff1a 2\u3001\u5c1d\u8bd5\u89e3\u51b3 \u5728\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u51e0\u4e2a\u65b9\u5411\uff1a \u6709\u53cd\u9988\u8bf4 serviceentry \u6ca1\u6709\u52a0\u4e0a\u3002\u4e5f\u5c31\u662f\u4e0a\u9762\u8bf4\u7684\u5bf9\u516c\u7f51\u8bbf\u95ee\u7684 serviceentry \u3002\u4e5f\u5c1d\u8bd5\u589e\u52a0\u4e86\u5bf9\u5e94\u57df\u540d\u7684 serviceentry\uff0c\u95ee\u9898\u4f9d\u7136\u5b58\u5728\u3002\u4f46\u8fd9\u6bd4\u4e4b\u524d\u597d\u4e00\u70b9\uff0c\u88ab\u6dfb\u52a0\u7684\u57df\u540d\u80fd\u591f\u6210\u529f\u8bbf\u95ee\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761\u8def\u6709\u6548\uff0c\u4f46\u53c8\u4e0d\u5b8c\u5168\u6709\u6548\u3002\u7b2c\u4e00\u4e2a\u95ee\u9898\u4f9d\u65e7\u6ca1\u6709\u88ab\u89e3\u7b54\u3002 \u65b0\u5f00\u4e86\u4e00\u4e2a\u7a7a\u95f4 istio-demo \u5e76\u90e8\u7f72\u4e86 book-info \u793a\u4f8b\u7a0b\u5e8f\u3002\u5728\u90e8\u7f72\u6210\u529f\u7684\u793a\u4f8b\u7a0b\u5e8f\u4e2d\uff0c\u4e5f\u5b58\u5728\u4e0a\u8ff0\u95ee\u9898\u3002 \u5728\u540e\u6765\u7684 debug \u4e2d\uff0c\u6211\u4eec\u5728 pod \u4e2d\u5c1d\u8bd5\u5efa\u7acb tls \u8fde\u63a5\uff1a \u9664\u4e86\u76f4\u63a5\u5728\u63e1\u624b\u9636\u6bb5\u5c31\u88ab\u670d\u52a1\u7aef\u5173\u95ed\u8fde\u63a5\u7684\u60c5\u51b5\u5916\uff0c\u8fd8\u9047\u5230\u4e86\uff1a $ curl https://baidu.com SSL: certificate subject name '*.example.com' does not match target host name 'baidu.com' \u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff1a '*.example.com' \u662f\u54ea\u91cc\u6765\u7684\uff1f\u6709\u4e2d\u95f4\u4eba\u5417\uff1f\u4e2d\u95f4\u4eba\u662f\u8c01\uff0c\u8bc1\u4e66\u5728\u54ea\u91cc\u914d\u7f6e\u7684\uff1f 3\u3001\u8f6c\u6298\u70b9 \u56e0\u4e3a\u95ee\u9898\u51fa\u73b0\u4e8e https \u65e0\u6cd5\u5efa\u7acb\u8fde\u63a5\uff0c\u6240\u4ee5\u65b9\u5411\u4e00\u76f4\u88ab\u5f15\u5411\u4e86 tls \u4ee3\u7406\u4e4b\u7c7b\u7684\u95ee\u9898\u3002 \u76f4\u5230\uff1a $ curl -k https://baidu.com 404 page not found \u8fd9\u91cc\u662f\u8bbf\u95ee\u7684\u4f17\u6240\u5468\u77e5\u7684\u57df\u540d\uff0c\u4e3a\u4ec0\u4e48\u8fd4\u56de\u4e86 \"404 page not found\"\uff1f\u8fd9\u4e2a\u54cd\u5e94\u8bf4\u660e\u4e86\u8be5\u54cd\u5e94\u5e94\u8be5\u6765\u81ea\u4e8e\u67d0\u4e2a\u5185\u90e8 golang \u8bed\u8a00\u7f16\u5199\u7684\u670d\u52a1\u3002 \u5728\u8bbf\u95ee\u5176\u4ed6 https \u57df\u540d\u4e5f\u6709\u540c\u6837\u7684\u6548\u679c\uff0c\u4f3c\u4e4e\u6240\u6709 https \u8bbf\u95ee\u90fd\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u5185\u90e8\u7684\u670d\u52a1\u3002 \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u90fd\u662f\u4f7f\u7528\u5230\u7684 istio proxy-status \u547d\u4ee4\u6765\u67e5\u770b sidecar \u914d\u7f6e\u6ce8\u5165\u72b6\u6001\uff0c\u4e5f\u672a\u89c1\u660e\u663e\u5f02\u5e38\u3002 \u65e0\u5948\u4e4b\u4e0b\uff0c\u6211\u5c1d\u8bd5\u4f7f\u7528\u4e86 istioctl proxy-config \u67e5\u770b sidecar \u914d\u7f6e\uff0c\u4e5f\u5c31\u662f envoy \u7684\u914d\u7f6e\u3002 $ istioctl proxy-config all sample-c59f744df-8kq7m.istio-demo ... 0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com 0.0.0.0 443 SNI: i.xiaoi.com Cluster: outbound|443||i.xiaoi.com 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name 0.0.0.0 443 SNI: dict.baidu.com Cluster: outbound|443||dict.baidu.com 0.0.0.0 443 SNI: datarobotapi.bdia.com.cn Cluster: outbound|443||datarobotapi.bdia.com.cn ... Server Name Indication: SNI \u5728\u8fd9\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u4e2d\uff0c\u5728\u4e0a\u5343\u4e2a\u89c4\u5219\u4e2d\u53d1\u73b0\u4e86\u8fd9\u4e48\u4e00\u6761 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name \u76f4\u89c9\u5c31\u662f\u8fd9\u4e2a\u89c4\u5219\u6709\u95ee\u9898\u3002\u731c\u6d4b\u8fd9\u4e2a\u89c4\u5219\u7684\u5b58\u5728\u5c06\u5176\u5339\u914d\u7684 443 \u7aef\u53e3 ALL \u7684\u6d41\u91cf\u8f6c\u53d1\u81f3\u4e86 traefik.cutom-name ,\u8fd9\u4e2a traefik.cutom-name \u662f \u4e0a\u9762\u8bf4\u5230\u7684 dns-controller \u751f\u6210\u7684\u7528\u4e8e CNAME \u7684 serviceentry \u3002 \u56e0\u4e3a\u8fd8\u4e0d\u662f\u5f88\u4e86\u89e3 istio envoy \u7684\u89c4\u5219\uff0c\u6240\u4ee5\u4ec5\u731c\u6d4b\u3002\u5982\u679c\u662f\u719f\u6089\u7684\u8bdd\uff0c\u80fd\u591f\u4e00\u773c\u770b\u51fa\u95ee\u9898\u3002 $ curl -k -vvv https://baidu.com ... * Server certificate: * subject: ...=traefik... ... 404 page not found \u5728 curl \u7ed9\u51fa\u7684 debug \u4fe1\u606f\u4e2d\u53d1\u73b0\u4e86\u670d\u52a1\u7aef\u4f7f\u7528\u7684 tls \u8bc1\u4e66\uff0csubject \u4e2d\u5305\u542b\u4e86 traefik \u7b49\u5b57\u6bb5\u3002\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e2a\u8bc1\u4e66\u662f traefik \u81ea\u7b7e\u53d1\u7684\u3002\u5b9e\u9524\u4e86\u8fd9\u4e2a\u540e\u7aef\u670d\u52a1\u5c31\u662f traefik\u3002 \u53ef\u4ee5\u65ad\u5b9a\uff0c\u67d0\u4e2a\u9519\u8bef\u7684\u914d\u7f6e\u5bfc\u81f4\u751f\u6210\u4e86 0.0.0.0:433 -> traefik.cutom-name \u7684\u6620\u5c04\u3002 \u540e\u6765\u5728\u9605\u8bfb\u4e86 envoy \u7684\u6587\u6863LDS\u540e\uff0c\u89e3\u91ca\u4e86\u8fd9\u4e9b\u89c4\u5219\u7684\u7528\u9014\u3002 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name \u8868\u793a\u5339\u914d\u6240\u6709 IP \u5730\u5740 & 443 \u7aef\u53e3 & \u6240\u6709 SNI \u7684\u6d41\u91cf\u5747 mesh \u5230\u76ee\u7684\u670d\u52a1 traefik.cutom-name 4\u3001\u9010\u6e10\u6e05\u6670 \u65e2\u7136\u548c traefik.cutom-name \u6709\u5173\uff0c\u4e5f\u5c31\u662f\u548c\u4e0a\u9762\u8bf4\u5230\u7684 dns-controller \u6709\u5173\uff0c\u548c\u5176\u751f\u6210\u7684 serviceentry \u6709\u5173\u3002\u4ee5\u5176\u4e2d\u4e00\u6761\u4e3e\u4f8b\uff1a apiVersion: networking.istio.io/v1beta1 kind: ServiceEntry metadata: namespace: abc name: traefik-cutom-name spec: hosts: - traefik.cutom-name location: MESH_INTERNAL ports: - name: https-443 number: 443 protocol: TLS resolution: DNS dns-controller \u751f\u6210\u4e86\u4e0a\u8ff0\u7684 serviceentry\u3002\u4e4d\u770b\u8fd8\u672a\u5bdf\u89c9\u5230\u95ee\u9898\uff0c\u4f46\u80af\u5b9a\u6709\u95ee\u9898\u3002 \u5728\u7ffb\u9605 ServiceEntry \u6587\u6863 \u540e\u3002\u6700\u7ec8\u53d1\u73b0\u95ee\u9898\uff1a \u6ca1\u6709\u8bbe\u7f6e spec.addresses \u3002 \u5176\u8bbe\u7f6e\u4e3a MESH_INTERNAL \u4f46\u662f\u6ca1\u6709\u6307\u5b9a\u8be5 service \u7684\u540e\u7aef\u3002\u65e2\u6ca1\u6709\u6307\u5b9a\u5230\u671f\u671b\u670d\u52a1 DNS \u4e5f\u6ca1\u6709\u6307\u5b9a IP\u3002\u90a3\u4e48\u6b64\u65f6\u9ed8\u8ba4\u884c\u4e3a\u662f\uff0c\u5c06 dns traefik.cutom-name \u4f5c\u4e3a\u4e0a\u6e38\uff0c\u901a\u8fc7\u8be5 dns \u53bb\u53d1\u73b0\u670d\u52a1\u7684 endpoint\u3002\u7531\u4e8e\u66f4\u6539\u4e86 coredns \u7684\u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u6682\u65f6\u6ca1\u6709\u95ee\u9898\u3002envoy \u6839\u636e\u8fd9\u90e8\u5206\u751f\u6210 cluster \u5e76\u914d\u7f6e\u4f7f\u7528 DNS \u4f5c\u4e3a EDS\u3002 \u4f46\u5728\u6ca1\u6709\u8bbe\u7f6e spec.addresses \u65f6,\u8fd9\u4e2a addresses \u53ef\u4ee5\u586b\u5199 IP \u4e5f\u53ef\u586b\u5199 endpoint \u6240\u5728\u7684 CIDR\u3002envoy \u6839\u636e\u6b64\u90e8\u5206\u751f\u6210\u7684 listener \u5219\u4f1a\u4f7f\u7528 0.0.0.0 \u4f5c\u4e3a IP \u5730\u5740\u3002\u90a3\u8fd9\u4f1a\u4ea7\u751f\u4ec0\u4e48\u95ee\u9898\u5462\uff1f \u4e3e\u4e2a \ud83c\udf30 \u6817\u5b50\uff1a \u5982\u679c serviceentry A \u672a\u8bbe\u7f6e addresses \u5e76\u914d\u7f6e 443 \u7aef\u53e3\u670d\u52a1\uff0c\u90a3\u4e48\u5728 envoy \u751f\u6210 listener \u4e3a\uff1a 0.0.0.0:443 -> service A \u3002 \u6b64\u65f6\u8bbf\u95ee https://baidu.com \u65f6\u5219\u4f1a\u5339\u914d\u5230\u8be5 listener \uff0cenvoy \u5219\u5c06\u6570\u636e\u5305\u53d1\u5f80\u8be5\u670d\u52a1\u3002 \u4e5f\u5c31\u4f1a\u6536\u5230 tls \u8bc1\u4e66\u4e0e\u9884\u671f\u4e0d\u4e00\u81f4\u7684\u7ed3\u679c\u3002\u540c\u7406\u6240\u6709\u4f7f\u7528 443 \u7aef\u53e3\u7684\u670d\u52a1\u4e5f\u4f1a\u5982\u6b64\u3002\u5982\u679c\u6709\u591a\u4e2a serviceentry \u90fd\u4f7f\u7528 443 \u7aef\u53e3\uff0c\u5219\u5728\u751f\u6210 listener \u65f6\u4f1a\u968f\u673a\u9009\u62e9\u4e86\u4e00\u4e2a\u670d\u52a1(\u8be5\u903b\u8f91\u7531 listio \u63a7\u5236)\u3002 \u89e3\u51b3\u529e\u6cd5\uff1a \u6307\u5b9a address \u5230 k8s service clusterIP \u6307\u5b9a address \u5230 k8s service CIDR \u7531\u4e8e\u53ef\u4ee5\u76f4\u63a5\u62ff\u5230 service IP \u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u586b\u5199 service IP\u3002 5\u3001\u89e3\u51b3 \u5728\u66f4\u6539\u63a7\u5236\u5668\u903b\u8f91\u540e\uff1a apiVersion: networking.istio.io/v1beta1 kind: ServiceEntry metadata: name: traefik-cutom-name namespace: abc spec: addresses: - <service cluster IP> # \u6307\u5b9a\u4e86 addresses,\u8be6\u60c5\u53c2\u770bistio\u6587\u6863\u3002 endpoints: - address: traefik.abc hosts: - traefik.cutom-name location: MESH_INTERNAL ports: - name: https-443 number: 443 protocol: TLS resolution: DNS \u518d\u6b21\u67e5\u770b config-dump $istioctl proxy-config all sample-55c7969547-z92zk.istio-demo 0.0.0.0 80 ALL PassthroughCluster 0.0.0.0 443 ALL PassthroughCluster 0.0.0.0 443 SNI: traefik.custom-name Cluster: outbound|443||traefik.custom-name \u89c4\u5219\u4e00\u5207\u6b63\u5e38\u3002 PassthroughCluster \u662f\u4e00\u6761\u7279\u6b8a\u89c4\u5219\uff0c\u8868\u793a\u6d41\u91cf\u4e0d\u7ecf\u8fc7\u4fee\u6539\u76f4\u63a5\u51fa istio\u3002 6\u3001\u590d\u76d8 \u597d\u7684\uff0c\u73b0\u5728 debug \u7684\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u51e0\u4e2a\u95ee\u9898\u4e5f\u5f97\u5230\u89e3\u51b3\u3002 \u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f \u5728\u4e4b\u524d\u7684\u4f7f\u7528\u4e2d\uff0c\u7531\u4e8e\u8be5 bug \u7684\u5b58\u5728\uff0c\u4f7f\u5f97\u8bbf\u95ee\u5411\u516c\u7f51\u7684 https \u670d\u52a1\u5747\u88ab\u8f6c\u53d1\u5230\u4e86\u5185\u90e8\u67d0\u4e2a\u670d\u52a1\u3002\u6240\u4ee5\u65e0\u6cd5\u8bbf\u95ee\uff0c\u5728\u8fd9\u6837\u7684\u60c5\u51b5\u4e0b\u589e\u52a0 MESH_EXTERNAL serviceentry \u76f8\u5f53\u4e8e\u5728\u89c4\u5219\u4e2d\u589e\u52a0\u4e86\u7279\u6b8a\u5339\u914d\u7684\u89c4\u5219,\u4f7f\u5f97\u80fd\u591f\u5339\u914d\u6210\u529f\uff0c\u6d41\u91cf\u5f97\u4ee5\u51fa istio\u3002\u4e3e\u4f8b: 0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com \u5728\u8be5 bug \u4fee\u590d\u540e\uff0c\u4e0d\u518d\u9700\u8981\u5bf9\u516c\u7f51\u7684\u670d\u52a1\u505a\u914d\u7f6e\u4e86\u3002 *.example.com' \u662f\u54ea\u91cc\u6765\u7684\uff1f *.example.com \u5b9e\u9645\u662f\u540e\u7aef\u67d0\u4e2a\u670d\u52a1\u4e0a\u4f7f\u7528\u7684\u8bc1\u4e66\uff0c\u7531\u4e8e\u9519\u8bef\u7684\u914d\u7f6e,\u6570\u636e\u5305\u9519\u8bef\u5206\u53d1\u3002\u5b9e\u9645\u6240\u6709\u7684 https \u5747\u8fde\u5230\u4e86\u8fd9\u4e2a\u9519\u8bef\u7684\u540e\u7aef\u3002 \u4e3a\u4ec0\u4e48\u4e0d\u540c\u7684 pod \u4e0b\u8868\u73b0\u4e0d\u4e00\u81f4\uff0c\u6709\u7684\u63e1\u624b\u5931\u8d25\uff0c\u6709\u7684\u63d0\u793a\u8bc1\u4e66\u9519\u8bef\uff1f \u5728 sidecar \u914d\u7f6e\u7684\u8fc7\u7a0b\u4e2d\uff0c 0.0.0.0 443 AL L\u8fd9\u6837\u7684\u89c4\u5219(serviceentry)\u4f1a\u6709\u591a\u4e2a\uff0c\u5728\u751f\u6210\u89c4\u5219\u7684\u65f6\u5019\uff0c\u4f1a\u5e76\u53d1\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u540e\u7aef\u4f5c\u4e3a\u8be5\u5730\u5740\u4e0a\u7684\u670d\u52a1\u3002\u5982\u679c\u8fde\u63a5\u5230\u4e86 mysql \u8fd9\u7c7b\u7684\u670d\u52a1\uff0c\u5219\u65e0\u6cd5\u63e1\u624b\u6210\u529f\u3002 \u4e3a\u4ec0\u4e48\u672a\u6307\u5b9a address \u7684 serviceentry \u4f1a\u88ab\u5339\u914d\u5230 0.0.0.0 \uff1f \u8fd9\u662f istio \u7684\u8003\u8651\uff0c\u5728\u7ffb\u770b\u6e90\u7801 conversion.go#L57 \u540e\u53d1\u73b0 0.0.0.0 \u662f\u5176\u9ed8\u8ba4\u503c\u3002 \u4e3a\u4ec0\u4e48\u5728\u6b64\u6b21\u5347\u7ea7\u540e\u624d\u53d1\u73b0\u95ee\u9898\uff1f \u56e0\u4e3a sidecar \u914d\u7f6e\u7684\u5b58\u5728\u3002\u5728\u4e4b\u524d\u7684 istio \u4e5f\u5b58\u5728\u8be5\u95ee\u9898\uff0c\u53ea\u662f\u901a\u8fc7\u4e3a\u5916\u90e8 https \u8bbe\u7f6e serviceentry \u5f97\u4ee5\u89c4\u907f\u3002\u800c\u4e14\u8be5\u89c4\u5219\u5b58\u5728 default \u547d\u540d\u7a7a\u95f4\u5185\u3002 \u5728\u5347\u7ea7\u540e\uff0c\u6211\u4eec\u5bf9\u7a7a\u95f4\u8bbe\u7f6e\u4e86 sidecar \u3002\u4f7f\u5f97 default \u7a7a\u95f4\u7684 serviceentry \u65e0\u6cd5\u4f20\u64ad\u5230\u5176\u4ed6\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5176\u4ed6\u7a7a\u95f4\u7684 https \u5747\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u540e\u7aef\u670d\u52a1\u3002","title":"\u7b2c\u56db\u8282 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def"},{"location":"chap4/4Istio_ServiceEntry_issue/#istio-serviceentry","text":"\u6700\u8fd1\u5728\u5f00\u59cb\u7814\u7a76 istio \u4f7f\u7528\uff0c\u5df2\u7ecf\u5728\u4e00\u4e2a\u672a\u5b89\u88c5 istio \u96c6\u7fa4\u7684\u73af\u5883\u4e2d\u6210\u529f\u641e\u5b9a istio \u5b89\u88c5\u914d\u7f6e\u4e14\u80fd\u6b63\u5e38\u4f7f\u7528\u3002 \u4f46\u662f\u6700\u8fd1\u5728\u4e00\u4e2a\u65b0\u5347\u7ea7\u7684 istio \u7248\u672c(1.11.0)\u7684\u96c6\u7fa4\u4e2d\uff0c\u6240\u6709\u88ab\u6ce8\u5165 istio sidecar \u7684 pod \u5747\u65e0\u6cd5\u5bf9\u5916\u8bbf\u95ee https \u3002\u5bfc\u81f4\u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u3002\u5177\u4f53\u8868\u73b0\u4e3a IP \u80fd\u901a\uff0c\u4f46\u662f\u65e0\u6cd5 tls \u63e1\u624b\u6210\u529f\u3002 \u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u7684\u521d\u671f\u8868\u73b0\u4e3a\u83b7\u53d6\u914d\u7f6e\u65f6\u63d0\u793a 404 \u3002 \u5728\u4e00\u6bb5\u65f6\u95f4\u540e\u7a81\u7136\u8868\u73b0\u4e3a\u65e0\u6cd5\u5efa\u7acb tls \uff0c\u8fd4\u56de 000 \u3002 \u6240\u6709\u5bf9\u5916\u7684 https \u670d\u52a1\u5747\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee \u3002 \u5728\u521d\u671f debug \u540e\uff0c\u8868\u73b0\u66f4\u4e3a\u8be1\u5f02\uff0c\u5728\u4e0d\u540c\u7684 pod \u4e2d\u6709\u4e0d\u540c\u7684\u8868\u73b0\uff1a \u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u7a81\u7136\u62d2\u7edd\u8fde\u63a5\u3002 \u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c \u670d\u52a1\u7aef\u8fd4\u56de\u4e0e\u670d\u52a1\u7aef\u672c\u8eab\u4e0d\u7b26\u5408\u7684\u8bc1\u4e66 \u3002\u4f8b\u5982\uff1a curl https://baidu.com \u63d0\u793a\u670d\u52a1\u7aef\u8bc1\u4e66\u4e3a *.example.com \u3002 \u5728\u8df3\u8fc7\u8bc1\u4e66\u9a8c\u8bc1\u540e\uff0c\u670d\u52a1\u7aef\u54cd\u5e94\u4e86\u975e\u9884\u671f\u7684\u5185\u5bb9\u3002","title":"\u7b2c\u56db\u8282 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def"},{"location":"chap4/4Istio_ServiceEntry_issue/#1","text":"\u7531\u4e8e\u65e0\u6cd5\u8bbf\u95ee\u5916\u90e8 https \uff0c\u521d\u671f\u731c\u60f3\u53ef\u80fd\u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u8bbf\u95ee\u7b56\u7565\u6216\u8005\u5176\u4ed6\u5b89\u5168\u76f8\u5173\u914d\u7f6e\uff0c\u6216\u8005\u5728 https \u4ee3\u7406\u4e0a\u51fa\u73b0\u4e86\u67d0\u4e9b\u914d\u7f6e\u9519\u8bef\u3002 \u5728\u95ee\u9898\u51fa\u73b0\u540e\u7684\u4e00\u6bb5\u65f6\u95f4\u4e2d\uff0c\u6211\u4eec\u5bf9\u6bd4\u4e86\u6b63\u5e38\u4f7f\u7528 istio \u96c6\u7fa4\u548c\u95ee\u9898\u96c6\u7fa4\u7684 istio \u914d\u7f6e\uff0c\u6240\u6709 crd\u3002\u5747\u672a\u53d1\u73b0\u7279\u6b8a\u914d\u7f6e\u3002 \u4f46\u662f\u989d\u5916\u7684\uff0c\u8be5\u96c6\u7fa4\u6709\u51e0\u4e2a\u6bd4\u8f83\u7279\u6b8a\u7684\u5730\u65b9\uff1a 1\u3001 \u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u5bf9\u5916\uff08\u516c\u7f51\u670d\u52a1\uff09\u8bbf\u95ee\u7684 serviceentry\uff0c\u5982\u4e0b \uff1a \u90e8\u5206\u9690\u79c1\u57df\u540d\u5df2\u7ecf\u5220\u9664\uff0c\u8fd9\u6761\u914d\u7f6e\u91cc\u9762\u7684\u57df\u540d\u603b\u6570\u591a\u8fbe\u51e0\u5341\u6761\u3002 \u7ecf\u8fc7\u8be2\u95ee\uff0c\u5f97\u5230\u7684\u7b54\u590d\u4e3a\uff1a \u9700\u8981\u5728 serviceentry \u4e2d\u52a0\u4e0a\u8fd9\u4e9b\u57df\u540d\u624d\u80fd\u4f7f mesh \u4e2d\u7684\u670d\u52a1\u6b63\u5e38\u5bf9\u5916\u8bbf\u95ee\u3002 2\u3001\u96c6\u7fa4\u4e2d\u8fd8\u8fd0\u884c\u4e86\u4e00\u4e2a dns-controller ,\u662f\u4e00\u4e2a\u548c istio \u6709\u5173\u7684\u63a7\u5236\u5668\u3002 \u7528\u4e8e\u8de8\u96c6\u7fa4\u7684 dns \u53d1\u73b0\u7b49\u3002\u5728\u8fd9\u91cc\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u5bf9 mesh \u7684\u57df\u540d\u505a\u4e86 CNAME \u7c7b\u4f3c\u7684\u64cd\u4f5c \u3002 \u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5728\u547d\u540d\u7a7a\u95f4 abc \u4e2d\u8fd0\u884c\u7740\u670d\u52a1 service-api \u9ed8\u8ba4\u8bbf\u95ee\u57df\u540d\u4e3a service-api.abc ,\u5728 istio \u4e2d\u9700\u8981\u5b9e\u73b0\u80fd\u591f\u901a\u8fc7 service-api.hello \u8bbf\u95ee\u3002\u4e8e\u662f\u8be5 controller \u5728\u7a7a\u95f4\u5185\u751f\u6210\u4e86\u670d\u52a1\u5bf9\u5e94\u7684 serviceentry \u7528\u4e8e \u201cCNAME\u201d \u3002 \u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f \u56e0\u4e3a istio \u9ed8\u8ba4\u4e0d\u9650\u5236 mesh \u5bf9\u516c\u7f51\u7684\u8bbf\u95ee\uff0c\u800c\u4e14\u5728\u6b63\u5e38\u7684\u96c6\u7fa4\u4e2d\u4e5f\u65e0\u9700\u8fd9\u4e2a\u914d\u7f6e\u3002 \u5728\u8fd9\u4e4b\u524d\uff0c\u7531\u4e8e\u9ed8\u8ba4 sidecar \u83b7\u53d6\u5168\u5c40\u7684 mesh \u914d\u7f6e\u5bfc\u81f4 sidecar \u5185\u5b58\u5360\u7528\u8d85 1GB\u3002\u6211\u4eec\u8fd8\u4f7f\u7528\u4e86 sidecar \u5c06\u914d\u7f6e\u9650\u5236\u5728\u5f53\u524d\u4e00\u4e2a\u7a7a\u95f4\u5185\u4ee5\u51cf\u5c11 sidecar \u5360\u7528\u3002 apiVersion: networking.istio.io/v1beta1 kind: Sidecar spec: egress: - hosts: - ./* \u5728\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u51e0\u4e2a\u65b9\u5411\uff1a","title":"1\u3001\u521d\u6b65\u5206\u6790"},{"location":"chap4/4Istio_ServiceEntry_issue/#2","text":"\u5728\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u51e0\u4e2a\u65b9\u5411\uff1a \u6709\u53cd\u9988\u8bf4 serviceentry \u6ca1\u6709\u52a0\u4e0a\u3002\u4e5f\u5c31\u662f\u4e0a\u9762\u8bf4\u7684\u5bf9\u516c\u7f51\u8bbf\u95ee\u7684 serviceentry \u3002\u4e5f\u5c1d\u8bd5\u589e\u52a0\u4e86\u5bf9\u5e94\u57df\u540d\u7684 serviceentry\uff0c\u95ee\u9898\u4f9d\u7136\u5b58\u5728\u3002\u4f46\u8fd9\u6bd4\u4e4b\u524d\u597d\u4e00\u70b9\uff0c\u88ab\u6dfb\u52a0\u7684\u57df\u540d\u80fd\u591f\u6210\u529f\u8bbf\u95ee\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761\u8def\u6709\u6548\uff0c\u4f46\u53c8\u4e0d\u5b8c\u5168\u6709\u6548\u3002\u7b2c\u4e00\u4e2a\u95ee\u9898\u4f9d\u65e7\u6ca1\u6709\u88ab\u89e3\u7b54\u3002 \u65b0\u5f00\u4e86\u4e00\u4e2a\u7a7a\u95f4 istio-demo \u5e76\u90e8\u7f72\u4e86 book-info \u793a\u4f8b\u7a0b\u5e8f\u3002\u5728\u90e8\u7f72\u6210\u529f\u7684\u793a\u4f8b\u7a0b\u5e8f\u4e2d\uff0c\u4e5f\u5b58\u5728\u4e0a\u8ff0\u95ee\u9898\u3002 \u5728\u540e\u6765\u7684 debug \u4e2d\uff0c\u6211\u4eec\u5728 pod \u4e2d\u5c1d\u8bd5\u5efa\u7acb tls \u8fde\u63a5\uff1a \u9664\u4e86\u76f4\u63a5\u5728\u63e1\u624b\u9636\u6bb5\u5c31\u88ab\u670d\u52a1\u7aef\u5173\u95ed\u8fde\u63a5\u7684\u60c5\u51b5\u5916\uff0c\u8fd8\u9047\u5230\u4e86\uff1a $ curl https://baidu.com SSL: certificate subject name '*.example.com' does not match target host name 'baidu.com' \u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff1a '*.example.com' \u662f\u54ea\u91cc\u6765\u7684\uff1f\u6709\u4e2d\u95f4\u4eba\u5417\uff1f\u4e2d\u95f4\u4eba\u662f\u8c01\uff0c\u8bc1\u4e66\u5728\u54ea\u91cc\u914d\u7f6e\u7684\uff1f","title":"2\u3001\u5c1d\u8bd5\u89e3\u51b3"},{"location":"chap4/4Istio_ServiceEntry_issue/#3","text":"\u56e0\u4e3a\u95ee\u9898\u51fa\u73b0\u4e8e https \u65e0\u6cd5\u5efa\u7acb\u8fde\u63a5\uff0c\u6240\u4ee5\u65b9\u5411\u4e00\u76f4\u88ab\u5f15\u5411\u4e86 tls \u4ee3\u7406\u4e4b\u7c7b\u7684\u95ee\u9898\u3002 \u76f4\u5230\uff1a $ curl -k https://baidu.com 404 page not found \u8fd9\u91cc\u662f\u8bbf\u95ee\u7684\u4f17\u6240\u5468\u77e5\u7684\u57df\u540d\uff0c\u4e3a\u4ec0\u4e48\u8fd4\u56de\u4e86 \"404 page not found\"\uff1f\u8fd9\u4e2a\u54cd\u5e94\u8bf4\u660e\u4e86\u8be5\u54cd\u5e94\u5e94\u8be5\u6765\u81ea\u4e8e\u67d0\u4e2a\u5185\u90e8 golang \u8bed\u8a00\u7f16\u5199\u7684\u670d\u52a1\u3002 \u5728\u8bbf\u95ee\u5176\u4ed6 https \u57df\u540d\u4e5f\u6709\u540c\u6837\u7684\u6548\u679c\uff0c\u4f3c\u4e4e\u6240\u6709 https \u8bbf\u95ee\u90fd\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u5185\u90e8\u7684\u670d\u52a1\u3002 \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u90fd\u662f\u4f7f\u7528\u5230\u7684 istio proxy-status \u547d\u4ee4\u6765\u67e5\u770b sidecar \u914d\u7f6e\u6ce8\u5165\u72b6\u6001\uff0c\u4e5f\u672a\u89c1\u660e\u663e\u5f02\u5e38\u3002 \u65e0\u5948\u4e4b\u4e0b\uff0c\u6211\u5c1d\u8bd5\u4f7f\u7528\u4e86 istioctl proxy-config \u67e5\u770b sidecar \u914d\u7f6e\uff0c\u4e5f\u5c31\u662f envoy \u7684\u914d\u7f6e\u3002 $ istioctl proxy-config all sample-c59f744df-8kq7m.istio-demo ... 0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com 0.0.0.0 443 SNI: i.xiaoi.com Cluster: outbound|443||i.xiaoi.com 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name 0.0.0.0 443 SNI: dict.baidu.com Cluster: outbound|443||dict.baidu.com 0.0.0.0 443 SNI: datarobotapi.bdia.com.cn Cluster: outbound|443||datarobotapi.bdia.com.cn ... Server Name Indication: SNI \u5728\u8fd9\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u4e2d\uff0c\u5728\u4e0a\u5343\u4e2a\u89c4\u5219\u4e2d\u53d1\u73b0\u4e86\u8fd9\u4e48\u4e00\u6761 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name \u76f4\u89c9\u5c31\u662f\u8fd9\u4e2a\u89c4\u5219\u6709\u95ee\u9898\u3002\u731c\u6d4b\u8fd9\u4e2a\u89c4\u5219\u7684\u5b58\u5728\u5c06\u5176\u5339\u914d\u7684 443 \u7aef\u53e3 ALL \u7684\u6d41\u91cf\u8f6c\u53d1\u81f3\u4e86 traefik.cutom-name ,\u8fd9\u4e2a traefik.cutom-name \u662f \u4e0a\u9762\u8bf4\u5230\u7684 dns-controller \u751f\u6210\u7684\u7528\u4e8e CNAME \u7684 serviceentry \u3002 \u56e0\u4e3a\u8fd8\u4e0d\u662f\u5f88\u4e86\u89e3 istio envoy \u7684\u89c4\u5219\uff0c\u6240\u4ee5\u4ec5\u731c\u6d4b\u3002\u5982\u679c\u662f\u719f\u6089\u7684\u8bdd\uff0c\u80fd\u591f\u4e00\u773c\u770b\u51fa\u95ee\u9898\u3002 $ curl -k -vvv https://baidu.com ... * Server certificate: * subject: ...=traefik... ... 404 page not found \u5728 curl \u7ed9\u51fa\u7684 debug \u4fe1\u606f\u4e2d\u53d1\u73b0\u4e86\u670d\u52a1\u7aef\u4f7f\u7528\u7684 tls \u8bc1\u4e66\uff0csubject \u4e2d\u5305\u542b\u4e86 traefik \u7b49\u5b57\u6bb5\u3002\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e2a\u8bc1\u4e66\u662f traefik \u81ea\u7b7e\u53d1\u7684\u3002\u5b9e\u9524\u4e86\u8fd9\u4e2a\u540e\u7aef\u670d\u52a1\u5c31\u662f traefik\u3002 \u53ef\u4ee5\u65ad\u5b9a\uff0c\u67d0\u4e2a\u9519\u8bef\u7684\u914d\u7f6e\u5bfc\u81f4\u751f\u6210\u4e86 0.0.0.0:433 -> traefik.cutom-name \u7684\u6620\u5c04\u3002 \u540e\u6765\u5728\u9605\u8bfb\u4e86 envoy \u7684\u6587\u6863LDS\u540e\uff0c\u89e3\u91ca\u4e86\u8fd9\u4e9b\u89c4\u5219\u7684\u7528\u9014\u3002 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name \u8868\u793a\u5339\u914d\u6240\u6709 IP \u5730\u5740 & 443 \u7aef\u53e3 & \u6240\u6709 SNI \u7684\u6d41\u91cf\u5747 mesh \u5230\u76ee\u7684\u670d\u52a1 traefik.cutom-name","title":"3\u3001\u8f6c\u6298\u70b9"},{"location":"chap4/4Istio_ServiceEntry_issue/#4","text":"\u65e2\u7136\u548c traefik.cutom-name \u6709\u5173\uff0c\u4e5f\u5c31\u662f\u548c\u4e0a\u9762\u8bf4\u5230\u7684 dns-controller \u6709\u5173\uff0c\u548c\u5176\u751f\u6210\u7684 serviceentry \u6709\u5173\u3002\u4ee5\u5176\u4e2d\u4e00\u6761\u4e3e\u4f8b\uff1a apiVersion: networking.istio.io/v1beta1 kind: ServiceEntry metadata: namespace: abc name: traefik-cutom-name spec: hosts: - traefik.cutom-name location: MESH_INTERNAL ports: - name: https-443 number: 443 protocol: TLS resolution: DNS dns-controller \u751f\u6210\u4e86\u4e0a\u8ff0\u7684 serviceentry\u3002\u4e4d\u770b\u8fd8\u672a\u5bdf\u89c9\u5230\u95ee\u9898\uff0c\u4f46\u80af\u5b9a\u6709\u95ee\u9898\u3002 \u5728\u7ffb\u9605 ServiceEntry \u6587\u6863 \u540e\u3002\u6700\u7ec8\u53d1\u73b0\u95ee\u9898\uff1a \u6ca1\u6709\u8bbe\u7f6e spec.addresses \u3002 \u5176\u8bbe\u7f6e\u4e3a MESH_INTERNAL \u4f46\u662f\u6ca1\u6709\u6307\u5b9a\u8be5 service \u7684\u540e\u7aef\u3002\u65e2\u6ca1\u6709\u6307\u5b9a\u5230\u671f\u671b\u670d\u52a1 DNS \u4e5f\u6ca1\u6709\u6307\u5b9a IP\u3002\u90a3\u4e48\u6b64\u65f6\u9ed8\u8ba4\u884c\u4e3a\u662f\uff0c\u5c06 dns traefik.cutom-name \u4f5c\u4e3a\u4e0a\u6e38\uff0c\u901a\u8fc7\u8be5 dns \u53bb\u53d1\u73b0\u670d\u52a1\u7684 endpoint\u3002\u7531\u4e8e\u66f4\u6539\u4e86 coredns \u7684\u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u6682\u65f6\u6ca1\u6709\u95ee\u9898\u3002envoy \u6839\u636e\u8fd9\u90e8\u5206\u751f\u6210 cluster \u5e76\u914d\u7f6e\u4f7f\u7528 DNS \u4f5c\u4e3a EDS\u3002 \u4f46\u5728\u6ca1\u6709\u8bbe\u7f6e spec.addresses \u65f6,\u8fd9\u4e2a addresses \u53ef\u4ee5\u586b\u5199 IP \u4e5f\u53ef\u586b\u5199 endpoint \u6240\u5728\u7684 CIDR\u3002envoy \u6839\u636e\u6b64\u90e8\u5206\u751f\u6210\u7684 listener \u5219\u4f1a\u4f7f\u7528 0.0.0.0 \u4f5c\u4e3a IP \u5730\u5740\u3002\u90a3\u8fd9\u4f1a\u4ea7\u751f\u4ec0\u4e48\u95ee\u9898\u5462\uff1f \u4e3e\u4e2a \ud83c\udf30 \u6817\u5b50\uff1a \u5982\u679c serviceentry A \u672a\u8bbe\u7f6e addresses \u5e76\u914d\u7f6e 443 \u7aef\u53e3\u670d\u52a1\uff0c\u90a3\u4e48\u5728 envoy \u751f\u6210 listener \u4e3a\uff1a 0.0.0.0:443 -> service A \u3002 \u6b64\u65f6\u8bbf\u95ee https://baidu.com \u65f6\u5219\u4f1a\u5339\u914d\u5230\u8be5 listener \uff0cenvoy \u5219\u5c06\u6570\u636e\u5305\u53d1\u5f80\u8be5\u670d\u52a1\u3002 \u4e5f\u5c31\u4f1a\u6536\u5230 tls \u8bc1\u4e66\u4e0e\u9884\u671f\u4e0d\u4e00\u81f4\u7684\u7ed3\u679c\u3002\u540c\u7406\u6240\u6709\u4f7f\u7528 443 \u7aef\u53e3\u7684\u670d\u52a1\u4e5f\u4f1a\u5982\u6b64\u3002\u5982\u679c\u6709\u591a\u4e2a serviceentry \u90fd\u4f7f\u7528 443 \u7aef\u53e3\uff0c\u5219\u5728\u751f\u6210 listener \u65f6\u4f1a\u968f\u673a\u9009\u62e9\u4e86\u4e00\u4e2a\u670d\u52a1(\u8be5\u903b\u8f91\u7531 listio \u63a7\u5236)\u3002 \u89e3\u51b3\u529e\u6cd5\uff1a \u6307\u5b9a address \u5230 k8s service clusterIP \u6307\u5b9a address \u5230 k8s service CIDR \u7531\u4e8e\u53ef\u4ee5\u76f4\u63a5\u62ff\u5230 service IP \u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u586b\u5199 service IP\u3002","title":"4\u3001\u9010\u6e10\u6e05\u6670"},{"location":"chap4/4Istio_ServiceEntry_issue/#5","text":"\u5728\u66f4\u6539\u63a7\u5236\u5668\u903b\u8f91\u540e\uff1a apiVersion: networking.istio.io/v1beta1 kind: ServiceEntry metadata: name: traefik-cutom-name namespace: abc spec: addresses: - <service cluster IP> # \u6307\u5b9a\u4e86 addresses,\u8be6\u60c5\u53c2\u770bistio\u6587\u6863\u3002 endpoints: - address: traefik.abc hosts: - traefik.cutom-name location: MESH_INTERNAL ports: - name: https-443 number: 443 protocol: TLS resolution: DNS \u518d\u6b21\u67e5\u770b config-dump $istioctl proxy-config all sample-55c7969547-z92zk.istio-demo 0.0.0.0 80 ALL PassthroughCluster 0.0.0.0 443 ALL PassthroughCluster 0.0.0.0 443 SNI: traefik.custom-name Cluster: outbound|443||traefik.custom-name \u89c4\u5219\u4e00\u5207\u6b63\u5e38\u3002 PassthroughCluster \u662f\u4e00\u6761\u7279\u6b8a\u89c4\u5219\uff0c\u8868\u793a\u6d41\u91cf\u4e0d\u7ecf\u8fc7\u4fee\u6539\u76f4\u63a5\u51fa istio\u3002","title":"5\u3001\u89e3\u51b3"},{"location":"chap4/4Istio_ServiceEntry_issue/#6","text":"\u597d\u7684\uff0c\u73b0\u5728 debug \u7684\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u51e0\u4e2a\u95ee\u9898\u4e5f\u5f97\u5230\u89e3\u51b3\u3002 \u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f \u5728\u4e4b\u524d\u7684\u4f7f\u7528\u4e2d\uff0c\u7531\u4e8e\u8be5 bug \u7684\u5b58\u5728\uff0c\u4f7f\u5f97\u8bbf\u95ee\u5411\u516c\u7f51\u7684 https \u670d\u52a1\u5747\u88ab\u8f6c\u53d1\u5230\u4e86\u5185\u90e8\u67d0\u4e2a\u670d\u52a1\u3002\u6240\u4ee5\u65e0\u6cd5\u8bbf\u95ee\uff0c\u5728\u8fd9\u6837\u7684\u60c5\u51b5\u4e0b\u589e\u52a0 MESH_EXTERNAL serviceentry \u76f8\u5f53\u4e8e\u5728\u89c4\u5219\u4e2d\u589e\u52a0\u4e86\u7279\u6b8a\u5339\u914d\u7684\u89c4\u5219,\u4f7f\u5f97\u80fd\u591f\u5339\u914d\u6210\u529f\uff0c\u6d41\u91cf\u5f97\u4ee5\u51fa istio\u3002\u4e3e\u4f8b: 0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com \u5728\u8be5 bug \u4fee\u590d\u540e\uff0c\u4e0d\u518d\u9700\u8981\u5bf9\u516c\u7f51\u7684\u670d\u52a1\u505a\u914d\u7f6e\u4e86\u3002 *.example.com' \u662f\u54ea\u91cc\u6765\u7684\uff1f *.example.com \u5b9e\u9645\u662f\u540e\u7aef\u67d0\u4e2a\u670d\u52a1\u4e0a\u4f7f\u7528\u7684\u8bc1\u4e66\uff0c\u7531\u4e8e\u9519\u8bef\u7684\u914d\u7f6e,\u6570\u636e\u5305\u9519\u8bef\u5206\u53d1\u3002\u5b9e\u9645\u6240\u6709\u7684 https \u5747\u8fde\u5230\u4e86\u8fd9\u4e2a\u9519\u8bef\u7684\u540e\u7aef\u3002 \u4e3a\u4ec0\u4e48\u4e0d\u540c\u7684 pod \u4e0b\u8868\u73b0\u4e0d\u4e00\u81f4\uff0c\u6709\u7684\u63e1\u624b\u5931\u8d25\uff0c\u6709\u7684\u63d0\u793a\u8bc1\u4e66\u9519\u8bef\uff1f \u5728 sidecar \u914d\u7f6e\u7684\u8fc7\u7a0b\u4e2d\uff0c 0.0.0.0 443 AL L\u8fd9\u6837\u7684\u89c4\u5219(serviceentry)\u4f1a\u6709\u591a\u4e2a\uff0c\u5728\u751f\u6210\u89c4\u5219\u7684\u65f6\u5019\uff0c\u4f1a\u5e76\u53d1\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u540e\u7aef\u4f5c\u4e3a\u8be5\u5730\u5740\u4e0a\u7684\u670d\u52a1\u3002\u5982\u679c\u8fde\u63a5\u5230\u4e86 mysql \u8fd9\u7c7b\u7684\u670d\u52a1\uff0c\u5219\u65e0\u6cd5\u63e1\u624b\u6210\u529f\u3002 \u4e3a\u4ec0\u4e48\u672a\u6307\u5b9a address \u7684 serviceentry \u4f1a\u88ab\u5339\u914d\u5230 0.0.0.0 \uff1f \u8fd9\u662f istio \u7684\u8003\u8651\uff0c\u5728\u7ffb\u770b\u6e90\u7801 conversion.go#L57 \u540e\u53d1\u73b0 0.0.0.0 \u662f\u5176\u9ed8\u8ba4\u503c\u3002 \u4e3a\u4ec0\u4e48\u5728\u6b64\u6b21\u5347\u7ea7\u540e\u624d\u53d1\u73b0\u95ee\u9898\uff1f \u56e0\u4e3a sidecar \u914d\u7f6e\u7684\u5b58\u5728\u3002\u5728\u4e4b\u524d\u7684 istio \u4e5f\u5b58\u5728\u8be5\u95ee\u9898\uff0c\u53ea\u662f\u901a\u8fc7\u4e3a\u5916\u90e8 https \u8bbe\u7f6e serviceentry \u5f97\u4ee5\u89c4\u907f\u3002\u800c\u4e14\u8be5\u89c4\u5219\u5b58\u5728 default \u547d\u540d\u7a7a\u95f4\u5185\u3002 \u5728\u5347\u7ea7\u540e\uff0c\u6211\u4eec\u5bf9\u7a7a\u95f4\u8bbe\u7f6e\u4e86 sidecar \u3002\u4f7f\u5f97 default \u7a7a\u95f4\u7684 serviceentry \u65e0\u6cd5\u4f20\u64ad\u5230\u5176\u4ed6\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5176\u4ed6\u7a7a\u95f4\u7684 https \u5747\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u540e\u7aef\u670d\u52a1\u3002","title":"6\u3001\u590d\u76d8"},{"location":"chap5/10Istio_http2/","text":"\u7b2c\u5341\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u91d1\u4e1d\u96c0\u90e8\u7f72/\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531/URI\u8fdb\u884c\u91cd\u5b9a\u5411) 1 \u91d1\u4e1d\u96c0\u90e8\u7f72 2 \u6839\u636e\u6765\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531 3 \u5bf9 URI \u8fdb\u884c\u91cd\u5b9a\u5411 1\u3001\u91d1\u4e1d\u96c0\u90e8\u7f72 \u7b80\u5355\u8bf4\u6765\uff0c\u91d1\u4e1d\u96c0\u90e8\u7f72\u5c31\u662f\u5728\u53d1\u5e03\u65b0\u7248\u672c\u65f6\uff0c\u90e8\u7f72\u7684\u65b0\u7248\u672c\u5e76\u4e0d\u5bf9\u5916\u5f00\u653e\uff0c\u800c\u662f\u9009\u62e9\u4e00\u5c0f\u90e8\u5206\u7528\u6237\u4e3a\u6d4b\u8bd5\u76ee\u6807\uff0c\u8fd9\u90e8\u5206\u7528\u6237\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\u4f1a\u6307\u5411\u7279\u5b9a\u7684\u7248\u672c\uff0c\u901a\u8fc7\u5bf9\u8fd9\u4e9b\u91d1\u4e1d\u96c0\u7528\u6237\u7684\u4f7f\u7528\u60c5\u51b5\u7684\u89c2\u5bdf\uff0c\u6765\u786e\u5b9a\u65b0\u7248\u672c\u670d\u52a1\u7684\u53d1\u5e03\u6548\u679c\uff0c\u5728\u786e\u5b9a\u7ed3\u679c\u4e4b\u524d, \u6240\u6709\u5176\u4ed6\u7528\u6237\u90fd\u7ee7\u7eed\u4f7f\u7528\u539f\u6709\u7248\u672c\u3002 \u8fd9\u91cc\u8fd8\u662f\u4ee5 flaskapp \u4e3a\u4f8b\uff0c\u6309\u7167\u6848\u4f8b\u9700\u6c42\uff0c\u6211\u4eec\u5047\u5b9a v1 \u662f\u65e7\u7248\u672c\uff0c v2 \u662f\u65b0\u7248\u672c\u3002\u5728\u53d1\u5e03\u65b0\u7248\u672c\u65f6 , \u9009\u62e9\u4e00\u90e8\u5206\u7528\u6237\u4f5c\u4e3a\u91d1\u4e1d\u96c0\u7528\u6237\uff0c\u5728\u91d1\u4e1d\u96c0\u7528\u6237\u8bbf\u95ee flaskapp \u65f6\u4ea7\u751f\u6d41\u91cf\u7684 HTTP header \u4e2d\u4f1a\u6709\u4e00\u884c lab:canary , \u6211\u4eec\u4f1a\u7528\u8be5\u5185\u5bb9\u533a\u522b\u7528\u6237\uff0c \u5176\u4ed6\u767b\u5f55\u7528\u6237\u548c\u533f\u540d\u7528\u6237\u5168\u90e8\u8bbf\u95ee\u5c31\u7248\u672c flaskapp ,\u91d1\u4e1d\u96c0\u7528\u6237\u5728\u8bbf\u95ee flaskapp \u65f6\u4f1a\u8bbf\u95ee\u65b0\u7248\u672c\u7684 flaskapp \uff0c\u6574\u4f53\u573a\u666f\u5982\u4e0b \u6839\u636e HTTP \u5185\u5bb9\u8fdb\u884c\u8def\u7531\u7684\u80fd\u529b, \u8fd9\u91cc\u53ef\u4ee5\u9488\u5bf9\u91d1\u4e1d\u96c0\u7528\u6237\u7684\u9700\u6c42\uff0c\u518d\u6b21\u4fee\u6539\u6211\u4eec\u7684 VirtualService apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - match: - headers: lab: exact: canary route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 \u5c06 YAML \u5185\u5bb9\u4fdd\u5b58\u4e3a canary.virtualservice.yaml \u4f7f\u7528 kubectl apply \u547d\u4ee4\u5c06\u5176\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3001\u8fdb\u4eba sleep Pod \u5f00\u59cb\u6d4b\u8bd5\uff1a $ kubectl apply -f canary-virtualservice.yaml virtualservice.networking.istio.io/flaskapp created $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash bash-4.4# http --body http://flaskapp/env/version v1 \u91cd\u590d\u6267\u884c\u51e0\u904d\uff0c\u4f1a\u770b\u5230\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8bbf\u95ee\u7684\u90fd\u662f v1 \u7248\u672c\u7684 flaskapp \u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u8bf7\u6c42\u4e2d\u52a0\u5165 lab:canary Header \uff0c\u518d\u6b21\u8c03\u7528 flaskapp http --body http://flaskapp/env/version lab:canary v2 \u53ef\u4ee5\u770b\u5230\u8fd9\u6b21\u5f97\u5230\u7684\u662f v2 \u7248\u672c\u7684\u8fd4\u56de\u503c\u3002 \u628a canary \u6362\u6210 phoenix \u518d\u8bd5\u9a8c\u4e00\u4e0b bash-4.4# http --body http://flaskapp/env/version lab:phoenix v1 \u53ef\u4ee5\u53d1\u73b0\u4e0d\u7b26\u5408\u5224\u65ad\u6761\u4ef6\uff0c\u751f\u6548\u7684\u4ecd\u7136\u662fv1\u7248\u672c \u5bf9\u4e8e\u8fd9\u4e2a VirtualService \u6211\u4eec\u9700\u8981\u4e86\u89e3\u4ee5\u4e0b\u5185\u5bb9\u3002 \u8fd9\u91cc\u4e5f\u5728 http \u5b57\u6bb5\u5b9a\u4e49\u4e86\u4e24\u4e2a\u8def\u7531( HTTPRoute \u5bf9\u8c61\uff0c\u533a\u522b\u662f\u8fd9\u6b21\u52a0\u4eba\u4e86\u4e00\u4e2a match \u5b57\u6bb5match\u5b57\u6bb5\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u5339\u914d \u529f\u80fd\u5176\u5339\u914d\u8303\u56f4\u4e0d\u4ec5\u5305\u62ec HTTP Header ,\u8fd8\u5305\u62ec uri \u3001 scheme \u3001 method \u3001 authority ,\u7aef\u53e3\uff0c\u6765\u6e90\u6807\u7b7e\u548c gateway \u7b49 \u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u9488\u5bf9 http header \u7684\u5339\u914d\uff0c\u8981\u6c42lab\u7684\u53d6\u503c\u5fc5\u987b\u5b8c\u5168\u5339\u914d canary ,\u8fd9\u91cc\u9664\u4e86\u53ef\u4ee5\u4f7f\u7528\u4ee3\u8868\u5b8c\u5168\u76f8\u7b49\u7684 exact \u52a8\u8bcd\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528 prefix \u548c regex \uff0c\u5206\u522b\u4ee3\u8868\u524d\u7f00\u548c\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5339\u914d\u65b9\u5f0f 2\u3001\u6839\u636e\u6765\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531 \u6211\u4eec\u6839\u636e\u7528\u6237\u53d1\u51fa\u7684\u8bf7\u6c42\u4e2d\u7684 HTTP Header \u8fdb\u884c\u4e86\u8f6c\u53d1\u3002\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\u8fd8\u5b58\u5728\u53e6\u4e00\u79cd\u60c5\u51b5\uff1a \u6765\u81ea\u4e0d\u540c\u7248\u672c\u7684\u670d\u52a1\u8bbf\u95ee\u4e0d\u540c\u7248\u672c\u7684\u76ee\u6807\u670d\u52a1 \u6bd4\u5982 v1 \u7248\u672c\u7684 sleep \u5411 flaskapp \u53d1\u51fa\u7684\u8bf7\u6c42\u7531 flaskapp \u7684 v1 \u7248\u672c\u63d0\u4f9b\u54cd\u5e94\uff0c \u5176\u4ed6\u7248\u672c\u7531 flaskapp \u7684 v2 \u7248\u672c\u8d1f\u8d23\uff0c\u5982\u56fe\u6240\u793a\u3002 sourceLabels-virtualservice.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - match: - sourceLabels: app: sleep version: v1 route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 \u4f7f\u7528 kubectl apply \u66f4\u65b0 VirtualService \uff0c\u7136\u540e\u5206\u522b\u8fdb\u4eba\u4e24\u4e2a\u7248\u672c\u7684 sleep Pod \u8fdb\u884c $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http --body http://flaskapp/env/version v1 $ kubectl exec -it sleep-v2-7c6b874968-hl6dj -c sleep bash bash-4.4# http --body http://flaskapp/env/version v2 \u4fa7\u8bd5\u7ed3\u679c\u5f88\u6e05\u695a,\u4ece sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u53d1\u7ed9 flaskapp \u7684\u8bf7\u6c42\uff0c\u7531 flaskapp \u7684 v1 \u7248\u672c\u8fdb\u884c\u4e86\u5904\u7406\uff0c\u8ddf\u6211\u4eec\u7684\u9884\u671f\u662f\u4e00\u81f4\u7684\u3002 \u5728\u4e0a\u9762\u7684 VirtualService \u5b9a\u4e49\u91cc\uff0c\u7528 SourceLabels \u5bf9\u6765\u6e90\u8def\u7531\u8fdb\u884c\u4e86\u5339\u914d\uff0c app \u6807\u7b7e\u4e3a sleep \u6807\u7b7e\u4e3a version \u6807\u7b7e v1 \u7684\u8bf7\u6c42\uff0c\u4f1a\u88ab\u53d1\u9001\u7ed9 flaskapp \u7684 v1 \u7248\u672c\u8fdb\u884c\u5904\u7406, \u5176\u4ed6\u6765\u6e90\u7684\u8bf7\u6c42\u7531 V2 \u7248\u672c\u8fdb\u884c\u5339\u914d\u3002 3\u3001 \u5bf9 URI \u8fdb\u884c\u91cd\u5b9a\u5411 \u8fd8\u6709\u53e6\u5916\u4e00\u79cd\u5bf9\u76ee\u6807\u8def\u7531\u7684\u5206\u6d41\u65b9\u5f0f\uff0c\u5373\u6839\u636eURL\u8fdb\u884c\u91cd\u5b9a\u5411 \u4f8b\u5982\uff0c v2 \u7248\u672c\u7684 sleep \u670d\u52a1\u53d1\u8d77\u5bf9 flaskapp \u670d\u52a1 \"/env/HOSTNAME\" \u8def\u5f84\u7684\u8bf7\u6c42\uff0c \u90a3\u4e48\u5c06\u5176\u7167\u5b9e\u8fd4\u56de \uff1b \u5982\u679c\u8bf7\u6c42\u6765\u81ea v1 \u7248\u672c\u7684 sleep \u670d\u52a1,\u90a3\u4e48\u5c06\u5176\u8bf7\u6c42\u8def\u5f84\u7531 \"/env/HOSTNAME\" \u4fee\u6539\u4e3a \"/env/version\" \u3002\u5c06 flaskapp.virtualservice.yaml \u7684 spec \u5b57\u6bb5\u4fee\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9 \uff1a uri-virtualservice.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - match: - sourceLabels: app: sleep version: v1 uri: exact: \"/env/HOSTNAME\" redirect: uri: /env/version - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 \u5206\u522b\u8fdb\u5165\u4e24\u4e2a sleep pod v1 \uff0c v2 $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http http://flaskapp/env/HOSTNAME HTTP/1.1 301 Moved Permanently content-length: 0 date: Sun, 27 Oct 2019 07:54:40 GMT location: http://flaskapp/env/version server: envoy kubectl exec -it sleep-v2-7c6b874968-hl6dj -c sleep bash http http://flaskapp/env/HOSTNAME HTTP/1.1 200 OK content-length: 27 content-type: text/html; charset=utf-8 date: Sun, 27 Oct 2019 07:55:39 GMT server: envoy x-envoy-upstream-service-time: 1 flaskapp-v2-d5bc47bf5-5kk5k \u5728 v1 \u4e2d\u4f1a\u53d1\u73b0\u8fd4\u56de\u4e00\u4e2a301\u6307\u4ee4\uff0c\u6211\u4eec\u5728\u6307\u4ee4\u4e2d\u52a0\u5165\u91cd\u5b9a\u5411\u7684\u6307\u4ee4\u518d\u6b21\u5c1d\u8bd5 $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http --follow http://flaskapp/env/HOSTNAME HTTP/1.1 200 OK content-length: 2 content-type: text/html; charset=utf-8 date: Sun, 27 Oct 2019 07:59:25 GMT server: envoy x-envoy-upstream-service-time: 1 v2 \u8fd9\u4e00\u6b21\u6210\u529f\u770b\u5230\u53d1\u751f\u4e86\u91cd\u5b9a\u5411\uff0c\u5373\u6700\u7ec8\u7531 \u201c/env/version\u201d \u8def\u5f84\u5904\u7406\u4e86\u6211\u4eec\u7684\u8bf7\u6c42\u3002 \u5728\u8fd9\u6b21\u7684 VirtualService \u5b9a\u4e49\u4e2d\uff0c\u5c06\u7531 v1 \u7248\u672c\u7684 sleep \u670d\u52a1\u53d1\u8d77\u7684\u5230 http://flaskapp/env/HOSTNAME \u7684\u8bf7\u6c42\uff0c\u7528 301 \u6307\u4ee4\u8fdb\u884c\u4e86\u91cd\u5b9a\u5411\u3002 \u8fd9\u91cc\u8981\u6ce8\u610f\uff1a redirect \u6307\u4ee4\u4f1a\u628a URI \u8fdb\u884c\u6574\u4f53\u66ff\u6362\uff0c\u56e0\u6b64\u7075\u6d3b\u6027\u4e0d\u9ad8 \uff1b \u53e6\u5916 301 \u6307\u4ee4\u65e0\u6cd5\u652f\u6301 Post \u65b9\u6cd5\u3002 \u4f8b\u5982\u6211\u4eec\u60f3\u8981\u7ed9 httpbin \u8bbe\u7f6e\u4e00\u4e2a\u4f7f\u7528 Post \u65b9\u6cd5\u7684\u91cd\u5b9a\u5411\uff0c\u5219\u53ef\u7f16\u5199\u5982\u4e0b\u4ee3\u7801\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - flaskapp.default.svc.cluster.local http: - match: - uri: exact: \"get\" redirect: uri: /post - route: - destination: host: flaskapp.default.svc.cluster.local \u5c06\u8fd9\u4e00\u6bb5\u4ee3\u7801\u4fdd\u5b58\u5230 httpbin.virtualservice.yaml \u4e2d\uff0c\u5e76\u4f7f\u7528 kubectl apply \u5c06\u5176\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u91cc\u5b9a\u4e49\u4e86\u5c06\u5bf9 httpbin \u670d\u52a1 \u201c/get\u201d \u8def\u5f84\u7684\u8bbf\u95ee\u91cd\u5b9a\u5411\u5230 \u201c/post\" \u4e0a \uff0c\u4e0b\u9762\u7528 sleep Pod \u53d1\u8d77\u8bf7\u6c42\u6d4b\u8bd5\u4e00\u4e0b\uff1a $ kubectl get vs NAME GATEWAYS HOSTS AGE flaskapp [flaskapp.default.svc.cluster.local] 32m httpbin [flaskapp.default.svc.cluster.local] 5s \u6211\u9047\u5230\u7684\u95ee\u9898\uff1a bash-4.4# http -f POST http://httpbin:8000/post data=nothing HTTP/1.1 503 Service Unavailable content-length: 95 content-type: text/plain date: Sun, 27 Oct 2019 08:27:56 GMT server: envoy upstream connect error or disconnect/reset before headers. reset reason: connection termination \u539f\u56e0\u6211\u9519\u8bef\u7684\u4fee\u6539\u4e86 mlts \uff0c\u53d8\u6210\u4e86 global enabled $ kubectl get MeshPolicy default -oyaml apiVersion: authentication.istio.io/v1alpha1 kind: MeshPolicy metadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | {\"apiVersion\":\"authentication.istio.io/v1alpha1\",\"kind\":\"MeshPolicy\",\"metadata\":{\"annota tions\":{},\"name\":\"default\"},\"spec\":{\"peers\":[{\"mtls\":{}}]}} creationTimestamp: \"2019-10-18T09:23:09Z\" generation: 2 name: default resourceVersion: \"198498\" selfLink: /apis/authentication.istio.io/v1alpha1/meshpolicies/default uid: f1b9dc29-d94c-415d-b879-25c71a3d4769 spec: peers: - mtls: {} \u89e3\u51b3\u65b9\u5f0f\uff0c\u8be5\u56de\u5230 permissive , $ kubectl edit MeshPolicy default meshpolicy.authentication.istio.io/default edited peers: - mtls: mode: PERMISSIVE $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash http -f POST http://httpbin:8000/post data=nothing HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 586 content-type: application/json date: Sun, 27 Oct 2019 09:24:50 GMT server: envoy x-envoy-upstream-service-time: 6 { \"args\": {}, \"data\": \"\", \"files\": {}, \"form\": { \"data\": \"nothing\" }, \"headers\": { \"Accept\": \"*/*\", \"Accept-Encoding\": \"gzip, deflate\", \"Content-Length\": \"12\", \"Content-Type\": \"application/x-www-form-urlencoded; charset=utf-8\", \"Host\": \"httpbin:8000\", \"User-Agent\": \"HTTPie/0.9.9\", \"X-B3-Parentspanid\": \"159205ecd8ddc070\", \"X-B3-Sampled\": \"1\", \"X-B3-Spanid\": \"cda267c471801f5e\", \"X-B3-Traceid\": \"fda0d72802b78b9c159205ecd8ddc070\" }, \"json\": null, \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin:8000/post\" } \u53ef\u4ee5\u770b\u5230\uff0cPOST\u6210\u529f\u3002\u6211\u4eec\u518d\u6b21\u53d1\u8d77\u8bf7\u6c42\uff0c\u8fd9\u6b21\u8bf7\u6c42\u7684\u76ee\u6807\u662f \"/get\" : bash-4.4# http --follow -f POST http://httpbin:8000/get data=nothing HTTP/1.1 405 Method Not Allowed access-control-allow-credentials: true access-control-allow-origin: * allow: OPTIONS, POST content-length: 178 content-type: text/html date: Sun, 27 Oct 2019 09:32:51 GMT server: envoy x-envoy-upstream-service-time: 3 <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 3.2 Final//EN\"> <title>405 Method Not Allowed</title> <h1>Method Not Allowed</h1> <p>The method is not allowed for the requested URL.</p> \u8fd9\u6b21\u53d1\u751f\u4e86\u91cd\u5b9a\u5411\uff0c \u4f46\u662f\u5f88\u660e\u663e\uff0c \u5e76\u6ca1\u6709\u6ee1\u8db3\u6211\u4eec\u7684\u8981\u6c42\uff0c Istio \u8fd8\u63d0\u4f9b\u4e86 Rewrite \u7684\u65b9\u5f0f\u6765\u63d0\u4f9b\u8fd9\u79cd\u5728\u8c03\u7528\u524d\u8fdb\u884c URI \u91cd\u5199\u7684\u652f\u6301\u3002 \u4e0b\u9762\u518d\u6b21\u4fee\u6539 httpbin \u7684\u8def\u7531\u89c4\u5219\uff0c \u628a redirect \u4fee\u6539\u4e3a rewrite apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - match: - uri: exact: \"/get\" rewrite: uri: /post route: - destination: host: httpbin.default.svc.cluster.local - route: - destination: host: httpbin.default.svc.cluster.local \u5728\u63d0\u4ea4\u65b0\u7684\u89c4\u5219\u4e4b\u540e\uff0c\u518d\u6b21\u8fdb\u5165 Sleep Pod \u8fdb\u884c\u5c1d\u8bd5\uff1a bash-4.4# http -f POST http://httpbin:8000/get data=nothing HTTP/1.1 301 Moved Permanently connection: close content-length: 0 date: Sun, 27 Oct 2019 09:43:13 GMT location: http://httpbin:8000/post server: envoy \u8fd9\u6b21\u5b8c\u6210\u4e86\u5bf9 post \u65b9\u5f0f\u6539\u5199 rewrite \u65b9\u6cd5\u548c rediret \u65b9\u6cd5\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\uff0c \u5728 rewrite \u65b9\u6cd5\u7684 match \u4e00\u8282\u5fc5\u987b\u5305\u542b\u5bf9\u76ee\u6807\u7684\u5b9a\u4e49\u3002\u5e76\u4e14\uff0c rewrite \u65b9\u6cd5\u548c rediret \u65b9\u6cd5\u4e0d\u80fd\u5171\u5b58 \u3002","title":"\u7b2c\u5341\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u91d1\u4e1d\u96c0\u90e8\u7f72/\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531/URI\u8fdb\u884c\u91cd\u5b9a\u5411)"},{"location":"chap5/10Istio_http2/#httpsuri","text":"1 \u91d1\u4e1d\u96c0\u90e8\u7f72 2 \u6839\u636e\u6765\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531 3 \u5bf9 URI \u8fdb\u884c\u91cd\u5b9a\u5411","title":"\u7b2c\u5341\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u91d1\u4e1d\u96c0\u90e8\u7f72/\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531/URI\u8fdb\u884c\u91cd\u5b9a\u5411)"},{"location":"chap5/10Istio_http2/#1","text":"\u7b80\u5355\u8bf4\u6765\uff0c\u91d1\u4e1d\u96c0\u90e8\u7f72\u5c31\u662f\u5728\u53d1\u5e03\u65b0\u7248\u672c\u65f6\uff0c\u90e8\u7f72\u7684\u65b0\u7248\u672c\u5e76\u4e0d\u5bf9\u5916\u5f00\u653e\uff0c\u800c\u662f\u9009\u62e9\u4e00\u5c0f\u90e8\u5206\u7528\u6237\u4e3a\u6d4b\u8bd5\u76ee\u6807\uff0c\u8fd9\u90e8\u5206\u7528\u6237\u5bf9\u670d\u52a1\u7684\u8bbf\u95ee\u4f1a\u6307\u5411\u7279\u5b9a\u7684\u7248\u672c\uff0c\u901a\u8fc7\u5bf9\u8fd9\u4e9b\u91d1\u4e1d\u96c0\u7528\u6237\u7684\u4f7f\u7528\u60c5\u51b5\u7684\u89c2\u5bdf\uff0c\u6765\u786e\u5b9a\u65b0\u7248\u672c\u670d\u52a1\u7684\u53d1\u5e03\u6548\u679c\uff0c\u5728\u786e\u5b9a\u7ed3\u679c\u4e4b\u524d, \u6240\u6709\u5176\u4ed6\u7528\u6237\u90fd\u7ee7\u7eed\u4f7f\u7528\u539f\u6709\u7248\u672c\u3002 \u8fd9\u91cc\u8fd8\u662f\u4ee5 flaskapp \u4e3a\u4f8b\uff0c\u6309\u7167\u6848\u4f8b\u9700\u6c42\uff0c\u6211\u4eec\u5047\u5b9a v1 \u662f\u65e7\u7248\u672c\uff0c v2 \u662f\u65b0\u7248\u672c\u3002\u5728\u53d1\u5e03\u65b0\u7248\u672c\u65f6 , \u9009\u62e9\u4e00\u90e8\u5206\u7528\u6237\u4f5c\u4e3a\u91d1\u4e1d\u96c0\u7528\u6237\uff0c\u5728\u91d1\u4e1d\u96c0\u7528\u6237\u8bbf\u95ee flaskapp \u65f6\u4ea7\u751f\u6d41\u91cf\u7684 HTTP header \u4e2d\u4f1a\u6709\u4e00\u884c lab:canary , \u6211\u4eec\u4f1a\u7528\u8be5\u5185\u5bb9\u533a\u522b\u7528\u6237\uff0c \u5176\u4ed6\u767b\u5f55\u7528\u6237\u548c\u533f\u540d\u7528\u6237\u5168\u90e8\u8bbf\u95ee\u5c31\u7248\u672c flaskapp ,\u91d1\u4e1d\u96c0\u7528\u6237\u5728\u8bbf\u95ee flaskapp \u65f6\u4f1a\u8bbf\u95ee\u65b0\u7248\u672c\u7684 flaskapp \uff0c\u6574\u4f53\u573a\u666f\u5982\u4e0b \u6839\u636e HTTP \u5185\u5bb9\u8fdb\u884c\u8def\u7531\u7684\u80fd\u529b, \u8fd9\u91cc\u53ef\u4ee5\u9488\u5bf9\u91d1\u4e1d\u96c0\u7528\u6237\u7684\u9700\u6c42\uff0c\u518d\u6b21\u4fee\u6539\u6211\u4eec\u7684 VirtualService apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - match: - headers: lab: exact: canary route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 \u5c06 YAML \u5185\u5bb9\u4fdd\u5b58\u4e3a canary.virtualservice.yaml \u4f7f\u7528 kubectl apply \u547d\u4ee4\u5c06\u5176\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3001\u8fdb\u4eba sleep Pod \u5f00\u59cb\u6d4b\u8bd5\uff1a $ kubectl apply -f canary-virtualservice.yaml virtualservice.networking.istio.io/flaskapp created $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash bash-4.4# http --body http://flaskapp/env/version v1 \u91cd\u590d\u6267\u884c\u51e0\u904d\uff0c\u4f1a\u770b\u5230\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8bbf\u95ee\u7684\u90fd\u662f v1 \u7248\u672c\u7684 flaskapp \u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u8bf7\u6c42\u4e2d\u52a0\u5165 lab:canary Header \uff0c\u518d\u6b21\u8c03\u7528 flaskapp http --body http://flaskapp/env/version lab:canary v2 \u53ef\u4ee5\u770b\u5230\u8fd9\u6b21\u5f97\u5230\u7684\u662f v2 \u7248\u672c\u7684\u8fd4\u56de\u503c\u3002 \u628a canary \u6362\u6210 phoenix \u518d\u8bd5\u9a8c\u4e00\u4e0b bash-4.4# http --body http://flaskapp/env/version lab:phoenix v1 \u53ef\u4ee5\u53d1\u73b0\u4e0d\u7b26\u5408\u5224\u65ad\u6761\u4ef6\uff0c\u751f\u6548\u7684\u4ecd\u7136\u662fv1\u7248\u672c \u5bf9\u4e8e\u8fd9\u4e2a VirtualService \u6211\u4eec\u9700\u8981\u4e86\u89e3\u4ee5\u4e0b\u5185\u5bb9\u3002 \u8fd9\u91cc\u4e5f\u5728 http \u5b57\u6bb5\u5b9a\u4e49\u4e86\u4e24\u4e2a\u8def\u7531( HTTPRoute \u5bf9\u8c61\uff0c\u533a\u522b\u662f\u8fd9\u6b21\u52a0\u4eba\u4e86\u4e00\u4e2a match \u5b57\u6bb5match\u5b57\u6bb5\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u5339\u914d \u529f\u80fd\u5176\u5339\u914d\u8303\u56f4\u4e0d\u4ec5\u5305\u62ec HTTP Header ,\u8fd8\u5305\u62ec uri \u3001 scheme \u3001 method \u3001 authority ,\u7aef\u53e3\uff0c\u6765\u6e90\u6807\u7b7e\u548c gateway \u7b49 \u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u9488\u5bf9 http header \u7684\u5339\u914d\uff0c\u8981\u6c42lab\u7684\u53d6\u503c\u5fc5\u987b\u5b8c\u5168\u5339\u914d canary ,\u8fd9\u91cc\u9664\u4e86\u53ef\u4ee5\u4f7f\u7528\u4ee3\u8868\u5b8c\u5168\u76f8\u7b49\u7684 exact \u52a8\u8bcd\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528 prefix \u548c regex \uff0c\u5206\u522b\u4ee3\u8868\u524d\u7f00\u548c\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5339\u914d\u65b9\u5f0f","title":"1\u3001\u91d1\u4e1d\u96c0\u90e8\u7f72"},{"location":"chap5/10Istio_http2/#2","text":"\u6211\u4eec\u6839\u636e\u7528\u6237\u53d1\u51fa\u7684\u8bf7\u6c42\u4e2d\u7684 HTTP Header \u8fdb\u884c\u4e86\u8f6c\u53d1\u3002\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\u8fd8\u5b58\u5728\u53e6\u4e00\u79cd\u60c5\u51b5\uff1a \u6765\u81ea\u4e0d\u540c\u7248\u672c\u7684\u670d\u52a1\u8bbf\u95ee\u4e0d\u540c\u7248\u672c\u7684\u76ee\u6807\u670d\u52a1 \u6bd4\u5982 v1 \u7248\u672c\u7684 sleep \u5411 flaskapp \u53d1\u51fa\u7684\u8bf7\u6c42\u7531 flaskapp \u7684 v1 \u7248\u672c\u63d0\u4f9b\u54cd\u5e94\uff0c \u5176\u4ed6\u7248\u672c\u7531 flaskapp \u7684 v2 \u7248\u672c\u8d1f\u8d23\uff0c\u5982\u56fe\u6240\u793a\u3002 sourceLabels-virtualservice.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - match: - sourceLabels: app: sleep version: v1 route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 \u4f7f\u7528 kubectl apply \u66f4\u65b0 VirtualService \uff0c\u7136\u540e\u5206\u522b\u8fdb\u4eba\u4e24\u4e2a\u7248\u672c\u7684 sleep Pod \u8fdb\u884c $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http --body http://flaskapp/env/version v1 $ kubectl exec -it sleep-v2-7c6b874968-hl6dj -c sleep bash bash-4.4# http --body http://flaskapp/env/version v2 \u4fa7\u8bd5\u7ed3\u679c\u5f88\u6e05\u695a,\u4ece sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u53d1\u7ed9 flaskapp \u7684\u8bf7\u6c42\uff0c\u7531 flaskapp \u7684 v1 \u7248\u672c\u8fdb\u884c\u4e86\u5904\u7406\uff0c\u8ddf\u6211\u4eec\u7684\u9884\u671f\u662f\u4e00\u81f4\u7684\u3002 \u5728\u4e0a\u9762\u7684 VirtualService \u5b9a\u4e49\u91cc\uff0c\u7528 SourceLabels \u5bf9\u6765\u6e90\u8def\u7531\u8fdb\u884c\u4e86\u5339\u914d\uff0c app \u6807\u7b7e\u4e3a sleep \u6807\u7b7e\u4e3a version \u6807\u7b7e v1 \u7684\u8bf7\u6c42\uff0c\u4f1a\u88ab\u53d1\u9001\u7ed9 flaskapp \u7684 v1 \u7248\u672c\u8fdb\u884c\u5904\u7406, \u5176\u4ed6\u6765\u6e90\u7684\u8bf7\u6c42\u7531 V2 \u7248\u672c\u8fdb\u884c\u5339\u914d\u3002","title":"2\u3001\u6839\u636e\u6765\u6e90\u670d\u52a1\u8fdb\u884c\u8def\u7531"},{"location":"chap5/10Istio_http2/#3-uri","text":"\u8fd8\u6709\u53e6\u5916\u4e00\u79cd\u5bf9\u76ee\u6807\u8def\u7531\u7684\u5206\u6d41\u65b9\u5f0f\uff0c\u5373\u6839\u636eURL\u8fdb\u884c\u91cd\u5b9a\u5411 \u4f8b\u5982\uff0c v2 \u7248\u672c\u7684 sleep \u670d\u52a1\u53d1\u8d77\u5bf9 flaskapp \u670d\u52a1 \"/env/HOSTNAME\" \u8def\u5f84\u7684\u8bf7\u6c42\uff0c \u90a3\u4e48\u5c06\u5176\u7167\u5b9e\u8fd4\u56de \uff1b \u5982\u679c\u8bf7\u6c42\u6765\u81ea v1 \u7248\u672c\u7684 sleep \u670d\u52a1,\u90a3\u4e48\u5c06\u5176\u8bf7\u6c42\u8def\u5f84\u7531 \"/env/HOSTNAME\" \u4fee\u6539\u4e3a \"/env/version\" \u3002\u5c06 flaskapp.virtualservice.yaml \u7684 spec \u5b57\u6bb5\u4fee\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9 \uff1a uri-virtualservice.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - match: - sourceLabels: app: sleep version: v1 uri: exact: \"/env/HOSTNAME\" redirect: uri: /env/version - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 \u5206\u522b\u8fdb\u5165\u4e24\u4e2a sleep pod v1 \uff0c v2 $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http http://flaskapp/env/HOSTNAME HTTP/1.1 301 Moved Permanently content-length: 0 date: Sun, 27 Oct 2019 07:54:40 GMT location: http://flaskapp/env/version server: envoy kubectl exec -it sleep-v2-7c6b874968-hl6dj -c sleep bash http http://flaskapp/env/HOSTNAME HTTP/1.1 200 OK content-length: 27 content-type: text/html; charset=utf-8 date: Sun, 27 Oct 2019 07:55:39 GMT server: envoy x-envoy-upstream-service-time: 1 flaskapp-v2-d5bc47bf5-5kk5k \u5728 v1 \u4e2d\u4f1a\u53d1\u73b0\u8fd4\u56de\u4e00\u4e2a301\u6307\u4ee4\uff0c\u6211\u4eec\u5728\u6307\u4ee4\u4e2d\u52a0\u5165\u91cd\u5b9a\u5411\u7684\u6307\u4ee4\u518d\u6b21\u5c1d\u8bd5 $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http --follow http://flaskapp/env/HOSTNAME HTTP/1.1 200 OK content-length: 2 content-type: text/html; charset=utf-8 date: Sun, 27 Oct 2019 07:59:25 GMT server: envoy x-envoy-upstream-service-time: 1 v2 \u8fd9\u4e00\u6b21\u6210\u529f\u770b\u5230\u53d1\u751f\u4e86\u91cd\u5b9a\u5411\uff0c\u5373\u6700\u7ec8\u7531 \u201c/env/version\u201d \u8def\u5f84\u5904\u7406\u4e86\u6211\u4eec\u7684\u8bf7\u6c42\u3002 \u5728\u8fd9\u6b21\u7684 VirtualService \u5b9a\u4e49\u4e2d\uff0c\u5c06\u7531 v1 \u7248\u672c\u7684 sleep \u670d\u52a1\u53d1\u8d77\u7684\u5230 http://flaskapp/env/HOSTNAME \u7684\u8bf7\u6c42\uff0c\u7528 301 \u6307\u4ee4\u8fdb\u884c\u4e86\u91cd\u5b9a\u5411\u3002 \u8fd9\u91cc\u8981\u6ce8\u610f\uff1a redirect \u6307\u4ee4\u4f1a\u628a URI \u8fdb\u884c\u6574\u4f53\u66ff\u6362\uff0c\u56e0\u6b64\u7075\u6d3b\u6027\u4e0d\u9ad8 \uff1b \u53e6\u5916 301 \u6307\u4ee4\u65e0\u6cd5\u652f\u6301 Post \u65b9\u6cd5\u3002 \u4f8b\u5982\u6211\u4eec\u60f3\u8981\u7ed9 httpbin \u8bbe\u7f6e\u4e00\u4e2a\u4f7f\u7528 Post \u65b9\u6cd5\u7684\u91cd\u5b9a\u5411\uff0c\u5219\u53ef\u7f16\u5199\u5982\u4e0b\u4ee3\u7801\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - flaskapp.default.svc.cluster.local http: - match: - uri: exact: \"get\" redirect: uri: /post - route: - destination: host: flaskapp.default.svc.cluster.local \u5c06\u8fd9\u4e00\u6bb5\u4ee3\u7801\u4fdd\u5b58\u5230 httpbin.virtualservice.yaml \u4e2d\uff0c\u5e76\u4f7f\u7528 kubectl apply \u5c06\u5176\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u91cc\u5b9a\u4e49\u4e86\u5c06\u5bf9 httpbin \u670d\u52a1 \u201c/get\u201d \u8def\u5f84\u7684\u8bbf\u95ee\u91cd\u5b9a\u5411\u5230 \u201c/post\" \u4e0a \uff0c\u4e0b\u9762\u7528 sleep Pod \u53d1\u8d77\u8bf7\u6c42\u6d4b\u8bd5\u4e00\u4e0b\uff1a $ kubectl get vs NAME GATEWAYS HOSTS AGE flaskapp [flaskapp.default.svc.cluster.local] 32m httpbin [flaskapp.default.svc.cluster.local] 5s \u6211\u9047\u5230\u7684\u95ee\u9898\uff1a bash-4.4# http -f POST http://httpbin:8000/post data=nothing HTTP/1.1 503 Service Unavailable content-length: 95 content-type: text/plain date: Sun, 27 Oct 2019 08:27:56 GMT server: envoy upstream connect error or disconnect/reset before headers. reset reason: connection termination \u539f\u56e0\u6211\u9519\u8bef\u7684\u4fee\u6539\u4e86 mlts \uff0c\u53d8\u6210\u4e86 global enabled $ kubectl get MeshPolicy default -oyaml apiVersion: authentication.istio.io/v1alpha1 kind: MeshPolicy metadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | {\"apiVersion\":\"authentication.istio.io/v1alpha1\",\"kind\":\"MeshPolicy\",\"metadata\":{\"annota tions\":{},\"name\":\"default\"},\"spec\":{\"peers\":[{\"mtls\":{}}]}} creationTimestamp: \"2019-10-18T09:23:09Z\" generation: 2 name: default resourceVersion: \"198498\" selfLink: /apis/authentication.istio.io/v1alpha1/meshpolicies/default uid: f1b9dc29-d94c-415d-b879-25c71a3d4769 spec: peers: - mtls: {} \u89e3\u51b3\u65b9\u5f0f\uff0c\u8be5\u56de\u5230 permissive , $ kubectl edit MeshPolicy default meshpolicy.authentication.istio.io/default edited peers: - mtls: mode: PERMISSIVE $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash http -f POST http://httpbin:8000/post data=nothing HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 586 content-type: application/json date: Sun, 27 Oct 2019 09:24:50 GMT server: envoy x-envoy-upstream-service-time: 6 { \"args\": {}, \"data\": \"\", \"files\": {}, \"form\": { \"data\": \"nothing\" }, \"headers\": { \"Accept\": \"*/*\", \"Accept-Encoding\": \"gzip, deflate\", \"Content-Length\": \"12\", \"Content-Type\": \"application/x-www-form-urlencoded; charset=utf-8\", \"Host\": \"httpbin:8000\", \"User-Agent\": \"HTTPie/0.9.9\", \"X-B3-Parentspanid\": \"159205ecd8ddc070\", \"X-B3-Sampled\": \"1\", \"X-B3-Spanid\": \"cda267c471801f5e\", \"X-B3-Traceid\": \"fda0d72802b78b9c159205ecd8ddc070\" }, \"json\": null, \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin:8000/post\" } \u53ef\u4ee5\u770b\u5230\uff0cPOST\u6210\u529f\u3002\u6211\u4eec\u518d\u6b21\u53d1\u8d77\u8bf7\u6c42\uff0c\u8fd9\u6b21\u8bf7\u6c42\u7684\u76ee\u6807\u662f \"/get\" : bash-4.4# http --follow -f POST http://httpbin:8000/get data=nothing HTTP/1.1 405 Method Not Allowed access-control-allow-credentials: true access-control-allow-origin: * allow: OPTIONS, POST content-length: 178 content-type: text/html date: Sun, 27 Oct 2019 09:32:51 GMT server: envoy x-envoy-upstream-service-time: 3 <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 3.2 Final//EN\"> <title>405 Method Not Allowed</title> <h1>Method Not Allowed</h1> <p>The method is not allowed for the requested URL.</p> \u8fd9\u6b21\u53d1\u751f\u4e86\u91cd\u5b9a\u5411\uff0c \u4f46\u662f\u5f88\u660e\u663e\uff0c \u5e76\u6ca1\u6709\u6ee1\u8db3\u6211\u4eec\u7684\u8981\u6c42\uff0c Istio \u8fd8\u63d0\u4f9b\u4e86 Rewrite \u7684\u65b9\u5f0f\u6765\u63d0\u4f9b\u8fd9\u79cd\u5728\u8c03\u7528\u524d\u8fdb\u884c URI \u91cd\u5199\u7684\u652f\u6301\u3002 \u4e0b\u9762\u518d\u6b21\u4fee\u6539 httpbin \u7684\u8def\u7531\u89c4\u5219\uff0c \u628a redirect \u4fee\u6539\u4e3a rewrite apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - match: - uri: exact: \"/get\" rewrite: uri: /post route: - destination: host: httpbin.default.svc.cluster.local - route: - destination: host: httpbin.default.svc.cluster.local \u5728\u63d0\u4ea4\u65b0\u7684\u89c4\u5219\u4e4b\u540e\uff0c\u518d\u6b21\u8fdb\u5165 Sleep Pod \u8fdb\u884c\u5c1d\u8bd5\uff1a bash-4.4# http -f POST http://httpbin:8000/get data=nothing HTTP/1.1 301 Moved Permanently connection: close content-length: 0 date: Sun, 27 Oct 2019 09:43:13 GMT location: http://httpbin:8000/post server: envoy \u8fd9\u6b21\u5b8c\u6210\u4e86\u5bf9 post \u65b9\u5f0f\u6539\u5199 rewrite \u65b9\u6cd5\u548c rediret \u65b9\u6cd5\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\uff0c \u5728 rewrite \u65b9\u6cd5\u7684 match \u4e00\u8282\u5fc5\u987b\u5305\u542b\u5bf9\u76ee\u6807\u7684\u5b9a\u4e49\u3002\u5e76\u4e14\uff0c rewrite \u65b9\u6cd5\u548c rediret \u65b9\u6cd5\u4e0d\u80fd\u5171\u5b58 \u3002","title":"3\u3001 \u5bf9URI\u8fdb\u884c\u91cd\u5b9a\u5411"},{"location":"chap5/11Istio_http3/","text":"\u7b2c\u5341\u4e00\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u901a\u4fe1\u8d85\u65f6/\u6545\u969c\u91cd\u8bd5/\u5165\u53e3~\u51fa\u53e3\u6d41\u91cf\u7ba1\u7406\uff09 1 \u901a\u4fe1\u8d85\u65f6\u63a7\u5236 2 \u6545\u969c\u91cd\u8bd5\u63a7\u5236 3 \u5165\u53e3\u6d41\u91cf\u7ba1\u7406 4 \u51fa\u53e3\u6d41\u91cf\u7ba1\u7406 1\u3001 \u901a\u4fe1\u8d85\u65f6\u63a7\u5236 \u5728\u5fae\u670d\u52a1\u4e4b\u95f4\u8fdb\u884c\u76f8\u4e92\u8c03\u7528\u65f6\uff0c\u56e0\u4e3a\u670d\u52a1\u95ee\u9898\u6216\u8005\u7f51\u7edc\u6545\u969c\u7684\u5f71\u54cd\uff0c\u53d1\u751f\u8d85\u65f6 \u662f\u5728\u6240\u96be\u514d\u7684\u3002 \u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\u5982\u679c\u4e0d\u52a0\u63a7\u5236\uff0c\u5219\u901a\u5e38\u9700\u8981\u7b49\u5f85\u9ed8\u8ba4\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u4f1a\u5bfc\u81f4\u4e1a\u52a1\u5904\u7406\u65f6\u95f4\u5927\u5e45\u5ea6\u5ef6\u957f\uff1b\u5982\u679c\u6545\u969c\u6301\u7eed\u5b58\u5728\uff0c\u5219\u5f80\u5f80\u4f1a\u9020\u6210\u4e1a\u52a1\u79ef\u538b\uff0c\u5230\u4e86\u4e00\u5b9a\u7a0b\u5ea6\u4e4b\u540e\u751a\u81f3\u4f1a\u5bfc\u81f4\u6545\u969c\u6269\u4e00\u6563\uff0c\u9020\u6210\u5927\u9762\u79ef\u6545\u969c \u3002 \u5373\u4f7f\u5168\u90e8\u52a0\u4ee5\u63a7\u5236\uff08\u4f8b\u5982\uff0c\u5bf9\u4e8e\u67d0\u4e00\u670d\u52a1\u7684\u8c03\u7528\uff0c\u4e00\u65e6\u8d85\u8fc7\u4e00\u5b9a\u7684\u65f6\u95f4\u5219\u81ea\u52a8\u7ec8\u6b62\u8be5\u8c03\u7528\uff09\uff0c\u4f46\u56e0\u4e3a\u670d\u52a1\u548c\u4e1a\u52a1\u60c5\u51b5\u591a\u53d8\uff0c\u9700\u8981\u4e0d\u65ad\u8c03\u6574\u63a7\u5236\u8fc7\u7a0b\u6765\u8fdb\u884c\u8c03\u6574\u548c\u4f18\u5316\u3002\u4f8b\u5982\uff0c\u6709\u54ea\u4e9b\u8c03\u7528\u70b9\u9700\u8981\u63a7\u5236\uff1f \u6bcf\u4e2a\u8c03\u7528\u70b9\u7684\u8d85\u65f6\u5e94\u8be5\u8bbe\u7f6e\u4e3a\u591a\u5c11\uff1f\u4fee\u6539\u5176\u4e2d\u4e00\u70b9\u4e4b\u540e\uff0c\u4f1a\u5bf9\u5176\u4ed6\u8c03\u7528\u70b9\u7684\u8d85\u65f6\u8bbe\u7f6e\u4ea7\u751f\u4ec0\u4e48\u6837\u7684\u5f71\u54cd\uff1f\u8fd9\u79cd\u8c03\u6574\u610f\u5473\u7740\u5f88\u591a\u7684\u91cd\u590d\u5de5\u4f5c\uff0c\u5f80\u5f80\u9700\u8981\u975e\u5e38\u591a\u7684\u4eba\u529b\u548c\u65f6\u95f4\u6295\u4eba\u624d\u80fd\u8fbe\u5230\u8f83\u597d\u7684\u6548\u679c\u3002 \u901a\u8fc7 Istio \u7684\u6d41\u91cf\u63a7\u5236\u529f\u80fd\u53ef\u4ee5\u5bf9\u670d\u52a1\u95f4\u7684\u8d85\u65f6\u8fdb\u884c\u63a7\u5236\uff0c\u5728\u5e94\u7528\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u6839\u636e VirtualService \u7684\u914d\u7f6e\uff0c\u52a8\u6001\u8c03\u6574\u8c03\u7528\u8fc7\u7a0b\u4e2d\u7684\u8d85\u65f6\u4e0a\u9650\uff0c\u4ece\u800c\u8fbe\u5230\u63a7\u5236\u6545\u969c\u8303\u56f4\u7684\u76ee\u7684 \u3002 \u76f8\u5bf9\u4e8e\u4ee3\u7801\u4fee\u6539\uff0c\u8fd9\u79cd\u975e\u4eba\u4fb5\u7684\u8c03\u6574\u65b9\u5f0f\u80fd\u591f\u8282\u7701\u5927\u91cf\u7684\u6210\u672c\u3002 \u8fd9\u91cc\u4e3a httpbin \u670d\u52a1\u7f16\u5199\u4e00\u4e2a VirtualService \uff0c\u8bbe\u7f6e\u5b83\u7684\u8d85\u65f6\u4e0a\u9650\uff0c\u4f7f\u5bf9 httpbin \u670d\u52a1\u7684\u8c03\u7528\u4e00\u65e6\u8d85\u8fc7 3 \u79d2\uff0c\u5219\u5224\u5b9a\u4e3a\u8d85\u65f6\uff1a timeout: 3s httpbin.timeout.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local timeout: 3s $ kubectl apply -f httpbin.timeout.yaml virtualservice.networking.istio.io/httpbin created \u7136\u540e\u4f7f\u7528 sleep Pod \u8fdb\u884c\u6d4b\u8bd5\uff0c\u5728\u6d4b\u8bd5\u4e2d\u4f7f\u7528 httpbin \u7684 \"/delay\" \u8def\u5f84\uff0c\u8fd9\u4e2a\u8def\u5f84\u63a5\u6536\u4e00\u4e2a\u6574\u6570\u4f5c\u4e3a\u53c2\u6570\uff0c\u5728\u670d\u52a1\u5668\u5ef6\u65f6\u6307\u5b9a\u79d2\u6570\u4e4b\u540e\u624d\u8fd4\u56de\u54cd\u5e94 $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http --body http://httpbin:8000/delay/2 { \"args\": {}, \"data\": \"\", \"files\": {}, \"form\": {}, \"headers\": { \"Accept\": \"*/*\", \"Accept-Encoding\": \"gzip, deflate\", \"Content-Length\": \"0\", \"Host\": \"httpbin:8000\", \"User-Agent\": \"HTTPie/0.9.9\", \"X-B3-Parentspanid\": \"a35e61fc2a2adba8\", \"X-B3-Sampled\": \"1\", \"X-B3-Spanid\": \"8bbbca0d349b1326\", \"X-B3-Traceid\": \"66816ed2aa478250a35e61fc2a2adba8\" }, \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin:8000/delay/2\" } http --body http://httpbin:8000/delay/4 upstream request timeout bash-4.4# http --body http://httpbin:8000/delay/5 upstream request timeout \u5982\u6b64\u770b\u6765\u6211\u4eec\u7684\u8d85\u65f6\u8bbe\u7f6e\u5df2\u7ecf\u751f\u6548\uff0c\u5982\u679c\u5ef6\u8fdf\u4e862\u79d2\uff0c\u5219\u65b9\u6cd5\u53ef\u4ee5\u6b63\u5e38\u5b8c\u6210\u8c03\u7528, \u5982\u679c\u5ef6\u8fdf\u8d85\u8fc73\u79d2\u5219\u4f1a\u53d1\u751f\u8d85\u65f6\u3001\u5931\u8d25 \u53ef\u4ee5\u770b\u51fa\uff0c\u8d85\u65f6\u914d\u7f6e\u975e\u5e38\u7b80\u5355\uff0c\u800c\u4e14\u662f VirtualService \u7684\u4e00\u90e8\u5206\uff0c\u56e0\u6b64\u5404\u79cd\u8fc7\u6ee4\u548c\u8def\u7531\u4e5f\u662f\u6709\u6548\u7684\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bf7\u6c42\u7684\u6e90\u548c\u76ee\u7684\u3001\u6807\u7b7e\u7b49\u6d41\u91cf\u7279\u5f81\u6765\u52a8\u6001\u786e\u5b9a\u8d85\u65f6\u5185\u5bb9. 2\u3001 \u6545\u969c\u91cd\u8bd5\u63a7\u5236 \u5728\u670d\u52a1\u95f4\u8c03\u7528\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6709\u65f6\u4f1a\u53d1\u751f\u95ea\u65ad\u7684\u968b\u51b5\u76ee\u6807\u670d\u52a1\u5728\u77ed\u65f6\u95f4\u5185\u4e0d\u53ef\u7528\uff0c\u6b64\u65f6\u5982\u679c\u8fdb\u884c\u91cd\u8bd5\uff0c\u5219\u53ef\u80fd\u4f1a\u7ee7\u7eed\u987a\u5229\u5730\u5b8c\u6210\u8c03\u7528\u3002\u8fd9\u4e00\u529f\u80fd\u548c\u5728\u8d85\u65f6\u63a7\u5236\u4e00\u6837\uff0c\u90fd\u662f\u7528\u4e8e\u5e94\u5bf9\u6545\u969c\u7684\u5e38\u7528\u624b\u6bb5\u3002\u5728\u65e0\u987b\u5f00\u53d1\u4ecb\u5165\u7684\u60c5\u51b5\u4e0b\uff0c\u76f4\u63a5\u5728\u8fd0\u884c\u73af\u5883\u4e2d\u5bf9\u6545\u969c\u91cd\u8bd5\u884c\u4e3a\u8fdb\u884c\u8c03\u6574, \u80fd\u591f\u6781\u5927\u5730\u589e\u5f3a\u7cfb\u7edf\u5f39\u6027\u548c\u5065\u6027\u3002 \u4e0b\u9762\u7ee7\u7eed\u5229\u7528 httpbin \u670d\u52a1\uff0c\u8fd4\u56de\u4e00\u4e2a 500 \u9519\u8bef\uff0c\u770b\u770b\u91cd\u8bd5\u8fc7\u7a0b\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u3002 \u6539\u5199 httpbin virtualservice.yaml \uff0c\u5728\u5176\u4e2d\u52a0\u4eba\u91cd\u8bd5\u5b9a\u4e49 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local retries: attempts: 3 \u8fd9\u91cc\u5b9a\u4e49\uff1a \u5728\u5bf9 httpbin \u670d\u52a1\u7684\u8bbf\u95ee\u8fd4\u56de\u6545\u969c\u4e4b\u540e\uff0c\u53ef\u4ee5\u8fdb\u884c\u4e09\u6b21\u91cd\u8bd5 \u3002 \u5c06\u65b0\u5b9a\u4e49\u7684 Virtual Service \u89c4\u5219\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\uff0c\u4e4b\u540e\u4f7f\u7528 sleep Pod \u8fdb\u884c\u6d4b\u8bd5\uff1a $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http http://httpbin:8000/status/500 HTTP/1.1 500 Internal Server Error access-control-allow-credentials: true access-control-allow-origin: * content-length: 0 content-type: text/html; charset=utf-8 date: Sun, 27 Oct 2019 10:39:54 GMT server: envoy x-envoy-upstream-service-time: 6 \u7ed3\u679c\u6beb\u65e0\u60ac\u5ff5\u5730\u8fd4\u56de\u4e86\u5185\u90e8\u9519\u8bef\u3002\u5982\u4f55\u624d\u80fd\u77e5\u9053\u662f\u5426\u771f\u7684\u8fdb\u884c\u4e86\u91cd\u8bd5\uff1f\u53ef\u4ee5\u67e5\u770b httpbin pod \u4e2d istio-proxy \u5bb9\u5668\u8bbf\u95ee\u65e5\u5fd7 $ kubectl logs -f httpbin-7d9d5b55b9-kzt5k -c istio-proxy [2019-10-27T10:39:54.372Z] \"GET /status/500 HTTP/1.1\" 500 - \"-\" 0 0 5 3 \"-\" \"HTTPie/0.9.9\" \"0d1cc197-8376-9756-a3c9-7d7c5706ca6f\" \"httpbin:8000\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local - 10.1.0.120:80 10.1.0.122:41152 - [2019-10-27T10:39:54.372Z] \"GET /status/500 HTTP/1.1\" 500 - \"-\" 0 0 5 3 \"-\" \"HTTPie/0.9.9\" \"0d1cc197-8376-9756-a3c9-7d7c5706ca6f\" \"httpbin:8000\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local - 10.1.0.120:80 10.1.0.122:41152 - ... \u4f1a\u53d1\u73b0\uff0c\u6bcf\u6b21\u8bbf\u95ee\u90fd\u4ea7\u751f\u4e864\u6761\u8bbf\u95ee\u65e5\u5fd7\uff0c\u4e5f\u5c31\u662f\u8bf4\u53d1\u751f\u4e863\u6b21\u91cd\u8bd5 \u8d85\u65f6\u63a7\u5236\u5185\u5bb9\u95ee\u9898\u53d8\u5f97\u590d\u6742\u4e86\u8d77\u6765\uff1a \u91cd\u8bd5\u6709\u8d85\u65f6\u8bbe\u7f6e\uff0c \u670d\u52a1\u8c03\u7528\u672c\u8eab\u4e5f\u6709\u8d85\u65f6\u8bbe\u7f6e\uff0c \u4e24\u8005\u662f\u5982\u4f55\u534f\u8c03\u7684\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u63a5\u7740\u8fdb\u884c\u6d4b\u8bd5 \u5c06\u4e0a\u9762\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u4fee\u6539\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local # timeout: 3s retries: attempts: 3 perTryTimeout: 1s timeout: 7s retries: attempts: 3 perTryTimeout: 1s timeout: 7s \u8fd9\u91cc\u8bbe\u7f6e\u6bcf\u6b21\u91cd\u8bd5\u7684\u8d85\u65f6\u5bb9\u5fcd\u65f6\u95f4\u4e3a1\u79d2\uff0c\uff5b\u4fea\u6025\u4f53\u7684\u8d85\u65f6\u5bb9\u5fcd\u65f6\u95f4\u4e3a7\u79d2\uff0c\u5728\u5e94\u7528\u8fd9\u4e00\u89c4\u5219\u540e\u8fdb\u5165 sleep Pod \uff0c\u4f7f\u7528 http://httpbin:8000/delay/10 \u8fdb\u884c\u6d4b\u8bd5 # time http http://httpbin:8000/delay/10 HTTP/1.1 504 Gateway Timeout content-length: 24 content-type: text/plain date: Sun, 27 Oct 2019 11:09:09 GMT server: envoy upstream request timeout real 0m4.309s user 0m0.265s sys 0m0.037s bash-4.4# \u53ef\u4ee5\u770b\u5230\uff0c\u8fd4\u56de\u65f6\u95f4\u662f4\u79d2\u591a\uff0c\u53ef\u4ee5\u5224\u65ad\u662f\u91cd\u8bd5\u7684\u8d85\u65f6\u8bbe\u7f6e\u4ea7\u751f\u4e86\u4f5c\u7528. \u518d\u6b21\u4fee\u6539\u8def\u7531\u89c4\u5219\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local # timeout: 3s retries: attempts: 3 perTryTimeout: 1s timeout: 3s bash-4.4# time http http://httpbin:8000/delay/10 HTTP/1.1 504 Gateway Timeout content-length: 24 content-type: text/plain date: Sun, 27 Oct 2019 11:12:36 GMT server: envoy upstream request timeout real 0m3.337s user 0m0.297s sys 0m0.025s \u8fd9\u6b21\u751f\u6548\u7684\u5c31\u662f\u603b\u4f53\u7684\u8d85\u65f6\u65f6\u95f4\u4e86\u3002 \u53ef\u4ee5\u5f97\u7ed3\u8bba\uff1a \u5bf9\u4e8e\u91cd\u8bd5\u7684\u8d85\u65f6\u8bbe\u7f6e\u548c\u603b\u4f53\u7684\u8d85\u65f6\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u5c06\u91cd\u8bd5\u7684\u8d85\u65f6\u548c\u91cd\u8bd5\u6b21\u6570\u7684\u4e58\u79ef\u4e0e\u603b\u4f53\u7684\u8d85\u65f6\u8fdb\u884c\u6bd4\u8f83\uff0c\u54ea\u4e2a\u5c0f\uff0c\u54ea\u4e2a\u8bbe\u7f6e\u5c31\u4f1a\u4f18\u5148\u751f\u6548\u3002 3\u3001\u5165\u53e3\u6d41\u91cf\u7ba1\u7406 Kubernetes \u4e3a\u7b2c\u4e09\u65b9\u5382\u5546\u63d0\u4f9b\u4e86 Ingress Controller \u89c4\u8303\uff0c\u7528\u4e8e\u5165\u7ad9\u6d41\u91cf\u7ba1\u7406\u3002 Istio \u7684\u65e9\u671f\u7248\u672c\u4e5f\u636e\u6b64\u5b9e\u73b0\u4e86\u81ea\u5df1\u7684 Ingress Controller \uff0c\u53c8\u56e0 Ingress Controller \u5728\u540e\u6765\u65e0\u6cd5\u6ee1\u8db3\u4e0d\u65ad\u589e\u52a0\u7684\u9700\u6c42\uff0c\u6240\u4ee5 Istio \u53c8\u63a8\u51fa\u4e86 Gateway \u7684\u6982\u5ff5\uff0c\u7528\u4e8e\u5728\u7f51\u7edc\u8fb9\u7f18\u8fdb\u884c\u5165\u7ad9\u548c\u51fa\u7ad9\u7684\u6d41\u91cf\u7ba1\u7406\u3002 Ingress Gateway \u5728\u903b\u8f91\u4e0a\u76f8\u5f53\u4e8e\u7f51\u7edc\u8fb9\u7f18\u7684\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u7528\u4e8e\u63a5\u6536\u548c\u5904\u7406\u7f51\u683c\u8fb9\u7f18\u51fa\u7ad9\u548c\u5165\u7ad9\u7684\u7f51\u7edc\u8fde\u63a5\uff0c \u5176\u4e2d\u5305\u542b\u5f00\u653e\u7aef\u53e3\u548c TLS \u7684\u914d\u7f6e\u7b49\u5185\u5bb9\u3002 \u5728\u4f7f\u7528 Helm \u8fdb\u884c Istio \u90e8\u7f72\u65f6, \u9700\u8981\u901a\u8fc7\u4e0b\u9762\u7684\u8bbe\u7f6e\u6765\u542f\u7528 Ingress Gateway : gateways: enabled:true istio-ingressgateway: enabled\uff1atrue \u5b9e\u9645\u4e0a\uff0c\u5728\u524d\u9762\u7684\u6d41\u91cf\u7ba1\u7406\u63a2\u8ba8\u4e2d\u4f7f\u7528\u7684 VirtualService \u5bf9\u8c61\uff0c\u90fd\u9ed8\u8ba4\u5305\u542b gateways \u5b57\u6bb5\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a\uff0c\u90a3\u4e48\u5176\u9ed8\u8ba4\u503c\u662f\uff1a gatways: - mesh \u8fd9\u91cc\u7684 mesh \u662f Istio \u5185\u90e8\u7684\u865a\u62df Gateway \uff0c\u4ee3\u8868\u7f51\u683c\u5185\u90e8\u7684\u6240\u6709 Sidecar \uff0c \u6362\u53e5\u8bdd\u8bf4\uff1a \u6240\u6709\u7f51\u683c\u5185\u90e8\u670d\u52a1\u4e4b\u95f4\u7684\u4e92\u76f8\u901a\u4fe1\uff0c\u90fd\u662f\u901a\u8fc7\u8fd9\u4e2a\u7f51\u5173\u8fdb\u884c\u7684\u3002\u5982\u679c\u8981\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u5c31\u9700\u8981\u5b9a\u4e49 Gateway \u5bf9\u8c61\uff0c\u5e76\u5728 gateways \u5b57\u6bb5\u4e2d\u8fdb\u884c\u8d4b\u503c\u3002 \u4e00\u65e6\u5728 gateways \u4e2d\u586b\u5199\u4e86 mesh \u4e4b\u5916\u7684\u5bf9\u8c61\u540d\u79f0\uff0c\u5c31\u8981\u7ee7\u7eed\u5bf9\u5185\u90e8\u901a\u4fe1\u8fdb\u884c\u6d41\u91cf\u63a7\u5236\uff0c\u5e76\u5fc5 \u987b\u663e\u5f0f\u5730\u5c06\u5185\u7f6e\u7684 mesh \u5bf9\u8c61\u540d\u79f0\u4e5f\u52a0\u5165\u5217\u8868\u4e2d\u3002 3-1 \u4f7f\u7528Gateway\u5f00\u653e\u670d\u52a1 \u6211\u4eec\u9996\u5148\u5c1d\u8bd5\u4f7f\u7528 Gateway \u5f00\u653e\u670d\u52a1\u3002\u4e0e Kubernetes Ingress \u7c7b\u4f3c\uff0c\u6211\u4eec\u9996\u5148\u8981\u5b9a\u4e49\u4e00\u4e2a Gateway : apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: example-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*.microservice.rocks\" - \"*.microservice.xyz\" \u628a\u6587\u4ef6\u5185\u5bb9\u4fdd\u5b58\u4e3a example.gateway.yaml . \u5728\u8fd9\u4e2a\u5b9a\u4e49\u4e2d\u6709\u4ee5\u4e0b\u513f\u70b9\u9700\u8981\u6ce8\u610f\uff1a selector \u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u6807\u7b7e\u9009\u62e9\u5668\uff0c\u7528\u4e8e\u6307\u5b9a\u7531\u54ea\u4e9b Gateway Pod \u6765\u8d1f\u8d23\u8fd9\u4e2a Gateway \u5bf9\u8c61\u7684\u8fd0\u884c \u3002 \u5728 hosts \u5b57\u6bb5\u4e2d\u7528\u4e86\u4e00\u4e2a\u901a\u914d\u7279\u57df\u540d\u6765\u6307\u660e\u8fd9\u4e2a Gateway \u53ef\u80fd\u8981\u8d1f\u8d23\u7684\u4e3b\u673a\u540d \u3002 \u53ef\u4ee5\u4f7f\u7528 kubectl get svc -n istio-system istio-ingressgateway \u6765\u67e5\u770b\u8be5\u670d\u52a1 \u7684 IP , \u5e76\u5c06\u6d4b\u8bd5\u57df\u540d\u6620\u5c04\u8fd9\u4e2a IP \u5c06\u914d\u7f6e\u63d0\u4ea4\u7ed9 Kubernetes \u96c6\u7fa4 $ kubectl apply -f example.gateway.yaml gateway.networking.istio.io/example-gateway created $ kubectl get gw NAME AGE example-gateway 16s $ sudo vi /etc/hosts 127.0.0.1 flaskapp.microservice.xyz flaskapp.microservice.xyz 127.0.0.1 flaskapp.microservice.rocks flaskapp.microservice.rocks $ kubectl get svc -n istio-system istio-ingressgateway NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-ingressgateway LoadBalancer 10.104.0.103 localhost 15020:30047/TCP,80:31380/TC P,443:31390/TCP,31400:31400/TCP,15029:32144/TCP,15030:30106/TCP,15031:30007/TCP,15032:31464/TC P,15443:31744/TCP 9d $ pip3 install --upgrade httpie $ http flask.microservice.rocks HTTP/1.1 404 Not Found Age: 0 Connection: keep-alive Content-Encoding: gzip Content-Type: text/html Date: Mon, 28 Oct 2019 07:21:18 GMT Server: nginx/1.14.0 (Ubuntu) Transfer-Encoding: chunked Via: 1.1 akamai (ACE 5.10.3/5.10.3) \u56de\u8fc7\u5934\u770b Gateway \u7684\u6982\u5ff5\uff0c\u4e0d\u96be\u53d1\u73b0\uff0c\u5176\u4e2d\u5e76\u6ca1\u6709\u6307\u5b9a\u8d1f\u8d23\u54cd\u5e94\u8bf7\u6c42\u7684\u670d\u52a1\uff0c\u6211\u4eec\u9700\u8981\u5bf9 flaskapp \u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u4fee\u6539\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local - flaskapp.microservice.rocks gateways: - mesh - example-gateway http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 $ kubectl apply -f gatway-flaskapp-virtualservice.yaml virtualservice.networking.istio.io/flaskapp configured bash-4.4# http flaskapp.microservice.rocks/env/version HTTP/1.1 200 OK content-length: 2 content-type: text/html; charset=utf-8 date: Mon, 28 Oct 2019 07:18:49 GMT server: envoy x-envoy-upstream-service-time: 0 v2 3-2 \u4e3a gatwaway \u6dfb\u52a0\u8bc1\u4e66\u652f\u6301 \u5165\u53e3\u7f51\u5173\u901a\u5e38\u627f\u62c5\u7740\u6d41\u91cf\u52a0\u5bc6\u7684\u4efb\u52a1\uff0c Ingress Gateway \u4e5f\u5177\u5907\u8fd9\u6837\u7684\u80fd\u529b \u5728 Ingress Gateway \u4e2d\u7528\u53ef\u9009\u65b9\u5f0f\u52a0\u8f7d\u4e86\u4e00\u4e2a\u540d\u79f0\u4e3a istio-ingressgateway-certs \u7684 Secret , \u5e76\u5c06\u5176\u52a0\u8f7d\u5230\u4e86 /etc/istio/ingressgateway-ca-cert \u76ee\u5f55\u4e2d\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u8981\u4f7f\u7528\u8bc1\u4e66\u548c\u5bc6\u94a5\u521b\u5efa\u8fd9\u4e2a Secret \uff0c\u5c31\u53ef\u4ee5\u5c06\u5176\u63d0\u4f9b\u7ed9 Gateway \u4f7f\u7528\u4e86\u3002 \u5728 Gateway \u4e2d\u53ef\u4ee5\u4f7f\u7528 tls \u5b57\u6bb5\u6765\u5b9a\u4e49\u5bf9\u8bc1\u4e66\u7684\u4f7f\u7528\u3002 \u9996\u5148\u4f7f\u7528\u8bc1\u4e66\u6587\u4ef6\u521b\u5efa Secret : kubectl create -n istio-secret tls istio-ingressgateway-certs --key rocks/key.pem --cert rocks/cert.pem \u7136\u540e\u4fee\u6539 Gateway \u7684\u5b9a\u4e49 apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: example-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*.microservice.rocks\" - \"*.microservice.xyz\" - port: number: 443 name: https protocol: HTTPS tls: mode: SIMPLE serverCertificate: /etc/istio/ingressgateway-certs/tls.crt privateKey: /etc/istio/ingressgateway-certs/tls.key hosts: - \"flaskapp.microservice.rocks\" - \"flaskapp.microservice.xyz\" http https://flaskapp.microservice.rocks/env/version HTTP/1.1 200 OK ... server: envoy x-envoy-upstream-service-time: 1 v2 \u53ef\u4ee5\u770b\u5230\uff0c\u5bf9\u57df\u540d flaskapp.microservice.rocks \u7684 HTTPS \u8bbf\u95ee\u5df2\u7ecf\u751f\u6548\uff1a 3-3 \u4e3a gatwaway \u6dfb\u52a0\u591a\u4e2a\u8bc1\u4e66\u652f\u6301 \u53c2\u7167\u5b98\u65b9\u6587\u6863\u53ef\u4ee5\u53d1\u73b0\uff0c tls secret \u53ea\u80fd\u5305\u542b\u4e00\u4e2a\u8bc1\u4e66\u5bf9\uff0c\u56e0\u6b64\u4e00\u4e2a Gateway \u662f\u65e0\u6cd5\u5904\u7406\u4e24\u4e2a\u57df\u540d\u7684 HTTPS \u7684\uff0c\u53ef\u4ee5\u6362\u7528 Generic \u7c7b\u578b\u7684\u8bc1\u4e66, \u8fd9\u91cc\u9700\u8981\u5220\u9664\u539f\u6709\u7684 Secret \u5e76\u91cd\u65b0\u521b\u5efa\uff1a $ kubectl delete secret istio-ingressgateway-certs -n istio-system secret \"istio-ingressgateway-certs\" deleted $ kubectl create secret generic istio-ingressgateway-certs -n istio-system -from-file=rocks-cert.pem --from-file=rocks-key.pem --from-file=xyz-cert.pem --from-file=xyz-keys.pem secret/istio-ingressgateway-certs created \u5728\u65b0\u7684 Secret \u521b\u5efa\u597d\u4e4b\u540e\uff0c\u8fd8\u9700\u8981\u4fee\u6539 Gateway \u7684\u914d\u7f6e apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: example-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http-all protocol: HTTP hosts: - \"*.microservice.rocks\" - \"*.microservice.xyz\" - port: number: 443 name: https-rocks protocol: HTTPS tls: mode: SIMPLE serverCertificate: /etc/istio/ingressgateway-certs/rocks-cert.pem privateKey: /etc/istio/ingressgateway-certs/rocks-cert.pem hosts: - \"flaskapp.microservice.rocks\" - port: number: 443 name: https-xyz protocol: HTTPS tls: mode: SIMPLE serverCertificate: /etc/istio/ingressgateway-certs/xyz-cert.pem privateKey: /etc/istio/ingressgateway-certs/xyz-cert.pem hosts: - \"flaskapp.microservice.xyz\" \u5728\u63d0\u4ea4\u5230\u96c6\u7fa4\u4e4b\u540e\uff0c\u518d\u6b21\u8fdb\u884c\u6d4b\u8bd5\uff1a $ http --body https://flaskapp.microservice.xyz/env/version v2 $ http --body https://flaskapp.microservice.rocks/env/version v2 3-4 \u914d\u7f6e\u5165\u53e3\u6d41\u91cf\u7684\u8def\u7531 VirtualService \u4e2d\u7684\u8def\u7531\u5339\u914d\u529f\u80fd\u5bf9 ingress \u6d41\u91cf\u4e5f\u662f\u6709\u6548\u7684\uff0c \u4f8b\u5982\uff0c\u6211\u4eec\u5e0c\u671b\u6d41\u91cf\u6765\u81ea\u5916\u90e8\u6d41\u91cf\u7531 flaskapp \u670d\u52a1 v1 ,\u5219\u53ef\u4ee5\u8fd9\u6837\u4fee\u6539\u539f\u6709\u7684 VirtualService apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local - flaskapp.microservice.rocks - flaskapp.microservice.xyz gateways: - mesh - example-gateway http: - match: - gateways: - example-gateway route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 $ http --body http://flaskapp.microservice.xyz/env/version v1 $ http --body http://flaskapp.microservice.rocks/env/version v1 delete 127.0.0.1 flaskapp.microservice.rocks flaskapp.microservice.rocks from /etc/hosts $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash http --body http://flaskapp.microservice.xyz/env/version v2 \u53ef\u4ee5\u770b\u5230\uff0c\u6309\u7167\u6211\u4eec\u7684\u8bbe\u8ba1\uff0c\u6240\u6709\u4ece example-gateway \u8fdb\u4eba\u7684\u6d41\u91cf\uff0c\u90fd\u7531 flaskapp \u670d\u52a1\u7684 v \u7248\u672c\u8fdb\u884c\u5904\u7406 \u6765\u81ea\u5185\u90e8\u7684\u6d41\u91cf\u5219\u7531 flaskapp \u670d\u52a1\u7684 v2 \u7248\u672c\u8fdb\u884c\u5904\u7406\u3002 4\u3001 \u51fa\u53e3\u6d41\u91cf\u7ba1\u7406 Istio \u5728\u5bf9\u5e94\u7528\u8fdb\u884c\u6ce8\u5165\u7684\u65f6\u5019\uff0c\u4f1a\u52ab\u6301\u8be5\u5e94\u7528\u7684\u6240\u6709\u6d41\u91cf\uff0c\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7f51\u683c\u4e4b\u5185\u7684\u5e94\u7528\u662f\u65e0\u6cd5\u8bbf\u95ee\u7f51\u683c\u4e4b\u5916\u7684\u670d\u52a1\u7684, \u4f8b\u5982\u5c1d\u8bd5\u5728 Sleep Pod \u4e2d\u8bbf\u95ee http://api.jd.com $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http http://api.jd.com HTTP/1.1 200 OK age: 0 cache-control: max-age=0 content-encoding: gzip content-type: text/html date: Tue, 29 Oct 2019 09:03:50 GMT etag: W/\"131-1571644820000\" expires: Tue, 29 Oct 2019 09:03:51 GMT last-modified: Mon, 21 Oct 2019 08:00:20 GMT server: envoy transfer-encoding: chunked vary: Accept-Encoding x-envoy-upstream-service-time: 279 <html> <script type=\"text/javascript\"> window.location=\"http://jos.jd.com\"; </script> <body> <h2></h2> </body> </html> \u4f46\u662f\u4ece\u7f51\u683c\u5185\u90e8\u53d1\u8d77\u5bf9\u5916\u7684\u7f51\u7edc\u8bf7\u6c42\u662f\u5e38\u89c1\u7684\u9700\u6c42\uff0c Istio \u63d0\u4f9b\u4e86\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\u7528\u4e8e\u7f51\u683c\u5916\u90e8\u901a\u4fe1\u3002 \u8bbe\u7f6e Sidcar \u7684\u6d41\u91cf\u52ab\u6301\u8303\u56f4\u6839\u636e IP \u5730\u5740\u6765\u544a\u77e5 Sidecar \u54ea\u4e9b\u5916\u90e8\u8d44\u6e90\u53ef\u4ee5\u653e\u5f00\u8bbf\u95ee\u3002 \u6ce8\u518c ServiceEntry \uff1a\u628a\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u4f7f\u7528 ScrviceEntry \u7684\u65b9\u5f0f\u6ce8\u518c\u5230\u7f51\u683c\u5185\u90e8. \u4e0b\u9762\u5c06\u5206\u522b\u8fdb\u884c\u5b9e\u8df5\u3002 4-1 \u8bbe\u7f6e Sidecar \u7684\u6d41\u91cf\u52ab\u6301\u8303\u56f4 \u7f51\u683c\u5185\u90e8\u7684\u5e94\u7528\u6d41\u5740\u52ab\u6301\u662f\u7531 istio-init \u5bb9\u5668\u5b8c\u6210\u7684\u6709\u4ee5\u4e0b\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u5f71\u54cd\u5b83\u7684\u52ab\u6301\u8303\u56f4 \u7b2c1\u79cd\u8bbe\u7f6e values.yaml \u4e2d\u7684 proxy.includeIPRange \u53d8\u91cf \u3002 \u7b2c2\u79cd\u4f7f\u7528 Pod \u6ce8\u89e3 traffic.sidecar.istio.io/includeOutboundIPRanges \u8868\u660e\u52ab\u6301\u8303\u56f4 \u7b2c 1 \u79cd\u65b9\u5f0f\u548c\u4e4b\u524d\u4fee\u6539 HELM \u8f93\u4eba\u53d8\u91cf\u7684\u6240\u6709\u65b9\u5f0f\u57fa\u672c\u76f8\u540c\u4f46\u662f\uff0c \u9700\u8981\u91cd\u65b0\u521b\u5efa\u6240\u6709\u88ab\u6ce8\u4eba\u7684 Pod \u3002 \u4e0b\u9762\u6d4b\u8bd5\u4e00\u4e0b\u6ce8\u89e3\u65b9\u5f0f \u4f7f\u7528 kubectl \u7f16\u8f91 sleep-v1 \u5bf9\u8c61, \u5728 template \u4e2d\u52a0\u4eba\u65b0\u7684\u6ce8\u89e3\uff1a metadata: name: sleep-v1 annotations: traffic.sidecar.istio.io/includeOutboundIPRanges: 10.96.0.0/12 \u8fd9\u91cc\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u767d\u540d\u5355\u8981\u6c42\u521d\u59cb\u5316\u5bb9\u5668\u53ea\u5bf9\u81ea\u540d\u5355\u8303\u56f4\u5185\u7684\u62a4\u8fdb\u884c\u52ab\u6301\u8fd9 \u91cc\u8f93\u4eba\u7684 CIDR \u8303\u56f4\u5c31\u662f\u7b14\u8005\u7684\u6d4b\u8bd5\u96c6\u7fa4\u7684\u670d\u52a1\u5730\u5740\u8303\u56f4, \u901a\u8fc7 kubectl \u547d\u4ee4\u53ef\u4ee5\u770b\u5230 sleep-v1 \u7684 Pod \u4f1a\u88ab\u91cd\u5efa \u5728 Pod \u542f\u52a8\u5b8c\u6210\u4e4b\u540e\u6211\u4eec\u518d\u6b21\u8fdb\u884c\u6d4b\u8bd5 Get Services IPs range kubectl cluster-info dump | grep -m 1 service-cluster-ip-range \"--service-cluster-ip-range=10.96.0.0/12\", $ kubectl apply -f sleep.istio.yaml service/sleep configured deployment.extensions/sleep-v1 configured deployment.extensions/sleep-v2 unchanged $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sle ep bash bash-4.4# http http://api.jd.com HTTP/1.1 200 OK cache-control: max-age=0 content-encoding: gzip content-type: text/html date: Tue, 29 Oct 2019 09:42:01 GMT etag: W/\"131-1571644820000\" expires: Tue, 29 Oct 2019 09:42:01 GMT last-modified: Mon, 21 Oct 2019 08:00:20 GMT server: envoy transfer-encoding: chunked vary: Accept-Encoding x-envoy-upstream-service-time: 1792 <html> <script type=\"text/javascript\"> window.location=\"http://jos.jd.com\"; </script> <body> <h2></h2> </body> </html> \u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u4fee\u6539\u5df2\u7ecf\u751f\u6548. \u8fd9\u79cd\u65b9\u5f0f\u975e\u5e38\u76f4\u63a5\u4f46\u5b9e\u9645\u571f\u5728\u7f51\u683c\u5185\u90e8\u662f\u4e00\u4e2a\u4f8b\u5916\uff1a \u8bbf\u95ee\u5916\u90e8\u5730\u5740\u7684\u8bf7\u6c42\u4f1a\u7531\u4e1a\u52a1 Pod \u53d1\u51fa\u7ed5\u8fc7 Sidecar \u5b8c\u5168\u4e0d\u53d7 Istio \u7684\u76d1\u63a7\u548c\u7ba1\u7406 \u4e3a\u4e86\u8fdb\u884c\u6d4b\u8bd5\u627e\u4eec\u518d\u6b21\u7f16\u8f91 sleep-v1 \u53bb\u6389\u6ce8\u89e3\u7684\u5185\u5bb9 4-2 \u8bbe\u7f6e ServiceEntry \u53ef\u4ee5\u4e3a\u5916\u90e8\u670d\u52a1\u8bbe\u7f6e ServiceEntry \u76f8\u5f53\u4e8e\u5c06\u5916\u90e8\u670d\u52a1\u5728\u7f51\u683c\u5185\u90e8\u8fdb\u884c\u4e86\u6ce8\u518c. \u76f8\u5bf9\u4e8e\u4f7f\u7528 CIDR \u767d\u540d\u5355\u7684\u65b9\u5f0f\u8fd9\u79cd\u65b9\u5f0f\uff0c \u8ba9 Istio \u5bf9\u5916\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u6709\u4e86\u66f4\u5927\u7684\u7ba1\u7406\u80fd\u529b \u6211\u4eec\u9996\u5148\u4e3a httpbin.org \u8bbe\u7f6e\u4e00\u4e2a ServicerEntry apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: httpbin-ext spec: hosts: - httpbin.org ports: - number: 80 name: http protocol: HTTP resolution: DNS \u4e0a\u8ff0\u5185\u5bb9\u88ab\u4fdd\u5b58\u4e3a httpbin.entry.yaml \uff0c\u5e76\u4f7f\u7528 kubectL apply \u63d0\u4ea4\u5230\u96c6\u7fa4\uff0c\u7136\u540e\u5c1d\u8bd5\u8bbf\u95ee\uff1a $ kubectl apply -f httpbin.entry.yaml serviceentry.networking.istio.io/httpbin-ext created $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash http http://httpbin.org/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * age: 0 content-encoding: gzip content-length: 503 content-type: application/json date: Wed, 30 Oct 2019 01:59:25 GMT referrer-policy: no-referrer-when-downgrade server: envoy x-content-type-options: nosniff x-envoy-upstream-service-time: 615 x-frame-options: DENY x-xss-protection: 1; mode=block { \"args\": {}, \"headers\": { \"Accept\": \"*/*\", \"Accept-Encoding\": \"gzip, deflate\", \"Cache-Control\": \"max-stale=0\", \"Host\": \"httpbin.org\", \"User-Agent\": \"HTTPie/0.9.9\", \"X-B3-Sampled\": \"1\", \"X-B3-Spanid\": \"fbf90cdccaae19eb\", \"X-B3-Traceid\": \"6af3dc0f3e12e8f5fbf90cdccaae19eb\", \"X-Bluecoat-Via\": \"0aa8a714ac138a74\", \"X-Envoy-Decorator-Operation\": \"httpbin.org:80/*\", \"X-Istio-Attributes\": \"CikKGGRlc3RpbmF0aW9uLnNlcnZpY2UuaG9zdBINEgtodHRwYmluLm9yZwoqCh1 kZXN0aW5hdGlvbi5zZXJ2aWNlLm5hbWVzcGFjZRIJEgdkZWZhdWx0CikKGGRlc3RpbmF0aW9uLnNlcnZpY2UubmFtZRINE gtodHRwYmluLm9yZwo+Cgpzb3VyY2UudWlkEjASLmt1YmVybmV0ZXM6Ly9zbGVlcC12MS01NDhkODdjYzVjLXdmazd2LmR lZmF1bHQ=\" }, \"origin\": \"169.145.197.12, 169.145.197.12\", \"url\": \"https://httpbin.org/get\" } \u53ef\u4ee5\u770b\u5230\uff0c\u6ce8\u518c\u540e\u7684\u5185\u5bb9\u8bbf\u95ee\u6210\u529f\u4e86 \u4f7f\u7528 ServiceEntry \u7684\u4e00\u4e2a\u597d\u5904\u5c31\u662f\uff0c\u53ef\u4ee5\u5229\u7528\u6d41\u91cf\u7ba1\u7406\u7279\u80dc\uff0c\u5bf9\u5916\u90e8\u8bbf\u95ee\u8fdb\u884c\u76d1\u63a7\u548c\u7ba1\u7406\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u5bf9\u521a\u624d\u7684 ServiceEntry \u8bbe\u7f6e\u4e86\u4e00\u4e2a 3 \u79d2\u7684\u8d85\u65f6\u9650\u5236\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin-service spec: hosts: - httpbin.org http: - timeout: 3s route: - destination: host: httbin.org \u5c06\u6587\u672c\u4fdd\u5b58\u4e3a serviceentry.virtualservice.yaml ,\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u8fd0\u884c $ kubectl apply -f serviceentry.virtualservice.yaml virtualservice.networking.istio.io/httpbin-service created $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# time http --body http://httpbin.org/delay/10 real 0m0.302s user 0m0.262s sys 0m0.031s \u53ef\u4ee5\u770b\u5230\uff0c\u8d85\u65f6\u7b56\u7565\u5df2\u7ecf\u751f\u6548\uff0c\u5728\u8bf7\u6c42\u65f6\u95f4\u8fbe\u5230\u6211\u4eec\u8bbe\u7f6e\u7684\u8d85\u65f6\u65f6\u95f4\u4e4b\u540e\u4f1a\u76f4\u63a5\u8fd4\u56de\u5931\u8d25\u3002 4-3 \u65b0\u5efa Gateway \u63a7\u5236\u5668 \u53d7\u5230\u7f51\u7edc\u7b56\u7565\u6216\u8005\u5b89\u5168\u56e0\u7d20\u7684\u5f71\u54cd\uff0c\u6211\u4eec\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\u901a\u5e38\u9700\u8981\u8bbe\u7f6e\u591a\u4e2a\u4e0d\u540c \u7684\u8fb9\u7f18\u7f51\u5173\u6765\u5b8c\u6210\u4e0d\u540c\u7684\u4efb\u52a1\uff0c\u4f8b\u5982\uff0c\u53ea\u6709\u7279\u5b9a\u8282\u70b9\u63d0\u4f9b\u4e86\u51fa\u7ad9\u8fde\u63a5\u80fd\u529b\uff0c\u6216\u8005\u5916 \u90e8\u8d1f\u8f7d\u5747\u8861\u53ea\u80fd\u4e3a\u90e8\u5206\u670d\u52a1\u5668\u5206\u53d1\u8d1f\u8f7d\u7b49\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5bf9\u670d\u52a1\u7f51\u683c\u4e2d\u7684 Gateway \u63a7\u5236\u5668\u90e8\u7f72\u8fdb\u884c\u5b9a\u5236\u3002 \u4e0d\u540c\u7528\u9014\u7684 Gateway \u63a7\u5236\u5668\u53ef\u4ee5\u5206\u5e03\u5728\u4e0d\u540c\u7684\u8282\u70b9\uff0c\u6216\u8005\u4f7f\u7528\u4e0d\u540c\u6570\u91cf\u7684\u8d44\u6e90\u7b49\u3002 Istio \u5728 Helm chart \u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65b0\u5efa Gateway \u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u5728\u5bf9\u8f93\u4eba\u503c\u8fdb\u884c\u5b9a\u5236\u4e4b\u540e\uff0c\u9996\u5148\u4f7f\u7528 Helm \u6307\u4ee4\u751f\u6210\u65b0\u7684\u63a7\u5236\u5668\u3002 \u4e0b\u9762\u8fdb\u884c\u5b9e\u9645\u64cd\u4f5c\u3002 \u5728 values.yaml \u7684 gateways \u5b57\u6bb5\u52a0\u4eba\u5982\u4e0b\u5185\u5bb9\uff1a $ cd Istio/istio-1.1.16/install/kubernetes/helm/istio/charts/gateways $ values.yaml ... enabled: true istio-myingress: enabled: true labels: app: istio-ingressgateway istio: myingress replicaCount: 3 autoscaleMax: 5 resources: {} cpu: targetAverageUtilization: 80 loadBalancerIP: \"\" serviceAnnotations: {} # type: LoadBalancer type: NodePort ports: - port: 80 targetPort: 80 name: http-myingress istio-ingressgateway: enabled: true ... https://istio.io/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports Change from loadbalancer to NodePort \u8fd9\u91cc\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u65b0\u7684 Ingress Gateway \u63a7\u5236\u5668\uff0c\u5b83\u4f1a\u5efa\u7acb\u4e09\u4e2a Pod \uff0c\u5f00\u653e 80 \u7aef\u53e3\u4f9b\u5916\u754c\u8bbf\u95ee\u3002 \u4f7f\u7528 Helm \u6e32\u67d3\u5e76\u8fdb\u884c\u90e8\u7f72\uff1a $ cd Istio/istio-1.1.16/install/kubernetes/helm/ helm template istio --name istio -f istio/values.yaml --namespace istio-system | kubectl apply -f - $ kubectl get pod -n istio-system ... istio-myingress-5bbcddc954-8jvp7 1/1 Running 0 9m37s istio-myingress-5bbcddc954-f4k82 1/1 Running 0 9m37s istio-myingress-5bbcddc954-ftc6r 1/1 Running 0 9m37s ... \u5728\u5b8c\u6210\u4e4b\u540e\u53ef\u4ee5\u5c1d\u8bd5\u4e3a httpbin \u670d\u52a1\u521b\u5efa\u4e00\u4e2a Gateway \u5bf9\u8c61\u6765\u5bf9\u5916\u5f00\u653e\u670d\u52a1\uff1a http-bin-gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: httpbin-gateway spec: selector: istio: myingress servers: - port: number: 80 name: http-all protocol: HTTP hosts: - \"*\" $ kubectl apply -f httpbin-gateway.yaml gateway.networking.istio.io/httpbin-gateway created \u5728\u8fd9\u4e2a\u5b9a\u4e49\u4e2d\uff1a \u4ec5\u5f00\u653e\u4e86 80 \u7aef\u53e3\uff1b \u6ca1\u6709\u5bf9\u4e3b\u673a\u540d\u505a\u51fa\u8981\u6c42\uff0c\u4f7f\u7528\u4e86\u901a\u914d\u7b26\u201c*\u201d\u4f5c\u4e3a\u4e3b\u673a\u540d\uff1b selector \u7528\u4e8e\u9009\u62e9\u6211\u4eec\u65b0\u5efa\u7684 Gateway \u63a7\u5236\u5668\u3002 \u7136\u540e\uff0c\u4fee\u6539 httpbin.gatwayservice.yaml \uff0c\u8bbe\u7f6e\u5176\u4e2d\u7684 gateways \u5b57\u6bb5\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - \"*\" gateways: - httpbin-gateway http: - route: - destination: host: httpbin.default.svc.cluster.local timeouts: 5s $ kubectl delete vs httpbin virtualservice.networking.istio.io \"httpbin\" deleted $ kubectl create -f httpbin.gatwayservice.yaml virtualservice.networking.istio.io/httpbin created \u8fd9\u91cc\u8ba9 VirtualService \u4f7f\u7528\u65b0\u5efa\u7684 httbin-gateway \u5bf9\u8c61\u5bf9\u5916\u5f00\u653e\u670d\u52a1\u6211\u4eec\u6d4b\u8bd5\u4e00\u4e0b $ kubectl get svc -n istio-system ... istio-myingress NodePort 10.103.69.251 <none> 80:31472/TCP ... $ http 127.0.0.1/31472 HTTP/1.1 200 OK ... \u53ef\u4ee5\u770b\u5230\u8bbf\u95ee\u6210\u529f\u5f97\u5230\u4e86\u54cd\u5e94\u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u6210\u529f\u4f7f\u7528\u65b0\u5efa\u7684 GateWay \u63a7\u5236\u5668\u5b8c\u6210\u4e86\u670d\u52a1\u7684\u5bf9\u5916\u5f00\u653e","title":"\u7b2c\u5341\u4e00\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u901a\u4fe1\u8d85\u65f6/\u6545\u969c\u91cd\u8bd5/\u5165\u53e3~\u51fa\u53e3\u6d41\u91cf\u7ba1\u7406\uff09"},{"location":"chap5/11Istio_http3/#https","text":"1 \u901a\u4fe1\u8d85\u65f6\u63a7\u5236 2 \u6545\u969c\u91cd\u8bd5\u63a7\u5236 3 \u5165\u53e3\u6d41\u91cf\u7ba1\u7406 4 \u51fa\u53e3\u6d41\u91cf\u7ba1\u7406","title":"\u7b2c\u5341\u4e00\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u901a\u4fe1\u8d85\u65f6/\u6545\u969c\u91cd\u8bd5/\u5165\u53e3~\u51fa\u53e3\u6d41\u91cf\u7ba1\u7406\uff09"},{"location":"chap5/11Istio_http3/#1","text":"\u5728\u5fae\u670d\u52a1\u4e4b\u95f4\u8fdb\u884c\u76f8\u4e92\u8c03\u7528\u65f6\uff0c\u56e0\u4e3a\u670d\u52a1\u95ee\u9898\u6216\u8005\u7f51\u7edc\u6545\u969c\u7684\u5f71\u54cd\uff0c\u53d1\u751f\u8d85\u65f6 \u662f\u5728\u6240\u96be\u514d\u7684\u3002 \u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\u5982\u679c\u4e0d\u52a0\u63a7\u5236\uff0c\u5219\u901a\u5e38\u9700\u8981\u7b49\u5f85\u9ed8\u8ba4\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u4f1a\u5bfc\u81f4\u4e1a\u52a1\u5904\u7406\u65f6\u95f4\u5927\u5e45\u5ea6\u5ef6\u957f\uff1b\u5982\u679c\u6545\u969c\u6301\u7eed\u5b58\u5728\uff0c\u5219\u5f80\u5f80\u4f1a\u9020\u6210\u4e1a\u52a1\u79ef\u538b\uff0c\u5230\u4e86\u4e00\u5b9a\u7a0b\u5ea6\u4e4b\u540e\u751a\u81f3\u4f1a\u5bfc\u81f4\u6545\u969c\u6269\u4e00\u6563\uff0c\u9020\u6210\u5927\u9762\u79ef\u6545\u969c \u3002 \u5373\u4f7f\u5168\u90e8\u52a0\u4ee5\u63a7\u5236\uff08\u4f8b\u5982\uff0c\u5bf9\u4e8e\u67d0\u4e00\u670d\u52a1\u7684\u8c03\u7528\uff0c\u4e00\u65e6\u8d85\u8fc7\u4e00\u5b9a\u7684\u65f6\u95f4\u5219\u81ea\u52a8\u7ec8\u6b62\u8be5\u8c03\u7528\uff09\uff0c\u4f46\u56e0\u4e3a\u670d\u52a1\u548c\u4e1a\u52a1\u60c5\u51b5\u591a\u53d8\uff0c\u9700\u8981\u4e0d\u65ad\u8c03\u6574\u63a7\u5236\u8fc7\u7a0b\u6765\u8fdb\u884c\u8c03\u6574\u548c\u4f18\u5316\u3002\u4f8b\u5982\uff0c\u6709\u54ea\u4e9b\u8c03\u7528\u70b9\u9700\u8981\u63a7\u5236\uff1f \u6bcf\u4e2a\u8c03\u7528\u70b9\u7684\u8d85\u65f6\u5e94\u8be5\u8bbe\u7f6e\u4e3a\u591a\u5c11\uff1f\u4fee\u6539\u5176\u4e2d\u4e00\u70b9\u4e4b\u540e\uff0c\u4f1a\u5bf9\u5176\u4ed6\u8c03\u7528\u70b9\u7684\u8d85\u65f6\u8bbe\u7f6e\u4ea7\u751f\u4ec0\u4e48\u6837\u7684\u5f71\u54cd\uff1f\u8fd9\u79cd\u8c03\u6574\u610f\u5473\u7740\u5f88\u591a\u7684\u91cd\u590d\u5de5\u4f5c\uff0c\u5f80\u5f80\u9700\u8981\u975e\u5e38\u591a\u7684\u4eba\u529b\u548c\u65f6\u95f4\u6295\u4eba\u624d\u80fd\u8fbe\u5230\u8f83\u597d\u7684\u6548\u679c\u3002 \u901a\u8fc7 Istio \u7684\u6d41\u91cf\u63a7\u5236\u529f\u80fd\u53ef\u4ee5\u5bf9\u670d\u52a1\u95f4\u7684\u8d85\u65f6\u8fdb\u884c\u63a7\u5236\uff0c\u5728\u5e94\u7528\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u6839\u636e VirtualService \u7684\u914d\u7f6e\uff0c\u52a8\u6001\u8c03\u6574\u8c03\u7528\u8fc7\u7a0b\u4e2d\u7684\u8d85\u65f6\u4e0a\u9650\uff0c\u4ece\u800c\u8fbe\u5230\u63a7\u5236\u6545\u969c\u8303\u56f4\u7684\u76ee\u7684 \u3002 \u76f8\u5bf9\u4e8e\u4ee3\u7801\u4fee\u6539\uff0c\u8fd9\u79cd\u975e\u4eba\u4fb5\u7684\u8c03\u6574\u65b9\u5f0f\u80fd\u591f\u8282\u7701\u5927\u91cf\u7684\u6210\u672c\u3002 \u8fd9\u91cc\u4e3a httpbin \u670d\u52a1\u7f16\u5199\u4e00\u4e2a VirtualService \uff0c\u8bbe\u7f6e\u5b83\u7684\u8d85\u65f6\u4e0a\u9650\uff0c\u4f7f\u5bf9 httpbin \u670d\u52a1\u7684\u8c03\u7528\u4e00\u65e6\u8d85\u8fc7 3 \u79d2\uff0c\u5219\u5224\u5b9a\u4e3a\u8d85\u65f6\uff1a timeout: 3s httpbin.timeout.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local timeout: 3s $ kubectl apply -f httpbin.timeout.yaml virtualservice.networking.istio.io/httpbin created \u7136\u540e\u4f7f\u7528 sleep Pod \u8fdb\u884c\u6d4b\u8bd5\uff0c\u5728\u6d4b\u8bd5\u4e2d\u4f7f\u7528 httpbin \u7684 \"/delay\" \u8def\u5f84\uff0c\u8fd9\u4e2a\u8def\u5f84\u63a5\u6536\u4e00\u4e2a\u6574\u6570\u4f5c\u4e3a\u53c2\u6570\uff0c\u5728\u670d\u52a1\u5668\u5ef6\u65f6\u6307\u5b9a\u79d2\u6570\u4e4b\u540e\u624d\u8fd4\u56de\u54cd\u5e94 $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http --body http://httpbin:8000/delay/2 { \"args\": {}, \"data\": \"\", \"files\": {}, \"form\": {}, \"headers\": { \"Accept\": \"*/*\", \"Accept-Encoding\": \"gzip, deflate\", \"Content-Length\": \"0\", \"Host\": \"httpbin:8000\", \"User-Agent\": \"HTTPie/0.9.9\", \"X-B3-Parentspanid\": \"a35e61fc2a2adba8\", \"X-B3-Sampled\": \"1\", \"X-B3-Spanid\": \"8bbbca0d349b1326\", \"X-B3-Traceid\": \"66816ed2aa478250a35e61fc2a2adba8\" }, \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin:8000/delay/2\" } http --body http://httpbin:8000/delay/4 upstream request timeout bash-4.4# http --body http://httpbin:8000/delay/5 upstream request timeout \u5982\u6b64\u770b\u6765\u6211\u4eec\u7684\u8d85\u65f6\u8bbe\u7f6e\u5df2\u7ecf\u751f\u6548\uff0c\u5982\u679c\u5ef6\u8fdf\u4e862\u79d2\uff0c\u5219\u65b9\u6cd5\u53ef\u4ee5\u6b63\u5e38\u5b8c\u6210\u8c03\u7528, \u5982\u679c\u5ef6\u8fdf\u8d85\u8fc73\u79d2\u5219\u4f1a\u53d1\u751f\u8d85\u65f6\u3001\u5931\u8d25 \u53ef\u4ee5\u770b\u51fa\uff0c\u8d85\u65f6\u914d\u7f6e\u975e\u5e38\u7b80\u5355\uff0c\u800c\u4e14\u662f VirtualService \u7684\u4e00\u90e8\u5206\uff0c\u56e0\u6b64\u5404\u79cd\u8fc7\u6ee4\u548c\u8def\u7531\u4e5f\u662f\u6709\u6548\u7684\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bf7\u6c42\u7684\u6e90\u548c\u76ee\u7684\u3001\u6807\u7b7e\u7b49\u6d41\u91cf\u7279\u5f81\u6765\u52a8\u6001\u786e\u5b9a\u8d85\u65f6\u5185\u5bb9.","title":"1\u3001 \u901a\u4fe1\u8d85\u65f6\u63a7\u5236"},{"location":"chap5/11Istio_http3/#2","text":"\u5728\u670d\u52a1\u95f4\u8c03\u7528\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6709\u65f6\u4f1a\u53d1\u751f\u95ea\u65ad\u7684\u968b\u51b5\u76ee\u6807\u670d\u52a1\u5728\u77ed\u65f6\u95f4\u5185\u4e0d\u53ef\u7528\uff0c\u6b64\u65f6\u5982\u679c\u8fdb\u884c\u91cd\u8bd5\uff0c\u5219\u53ef\u80fd\u4f1a\u7ee7\u7eed\u987a\u5229\u5730\u5b8c\u6210\u8c03\u7528\u3002\u8fd9\u4e00\u529f\u80fd\u548c\u5728\u8d85\u65f6\u63a7\u5236\u4e00\u6837\uff0c\u90fd\u662f\u7528\u4e8e\u5e94\u5bf9\u6545\u969c\u7684\u5e38\u7528\u624b\u6bb5\u3002\u5728\u65e0\u987b\u5f00\u53d1\u4ecb\u5165\u7684\u60c5\u51b5\u4e0b\uff0c\u76f4\u63a5\u5728\u8fd0\u884c\u73af\u5883\u4e2d\u5bf9\u6545\u969c\u91cd\u8bd5\u884c\u4e3a\u8fdb\u884c\u8c03\u6574, \u80fd\u591f\u6781\u5927\u5730\u589e\u5f3a\u7cfb\u7edf\u5f39\u6027\u548c\u5065\u6027\u3002 \u4e0b\u9762\u7ee7\u7eed\u5229\u7528 httpbin \u670d\u52a1\uff0c\u8fd4\u56de\u4e00\u4e2a 500 \u9519\u8bef\uff0c\u770b\u770b\u91cd\u8bd5\u8fc7\u7a0b\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u3002 \u6539\u5199 httpbin virtualservice.yaml \uff0c\u5728\u5176\u4e2d\u52a0\u4eba\u91cd\u8bd5\u5b9a\u4e49 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local retries: attempts: 3 \u8fd9\u91cc\u5b9a\u4e49\uff1a \u5728\u5bf9 httpbin \u670d\u52a1\u7684\u8bbf\u95ee\u8fd4\u56de\u6545\u969c\u4e4b\u540e\uff0c\u53ef\u4ee5\u8fdb\u884c\u4e09\u6b21\u91cd\u8bd5 \u3002 \u5c06\u65b0\u5b9a\u4e49\u7684 Virtual Service \u89c4\u5219\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\uff0c\u4e4b\u540e\u4f7f\u7528 sleep Pod \u8fdb\u884c\u6d4b\u8bd5\uff1a $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http http://httpbin:8000/status/500 HTTP/1.1 500 Internal Server Error access-control-allow-credentials: true access-control-allow-origin: * content-length: 0 content-type: text/html; charset=utf-8 date: Sun, 27 Oct 2019 10:39:54 GMT server: envoy x-envoy-upstream-service-time: 6 \u7ed3\u679c\u6beb\u65e0\u60ac\u5ff5\u5730\u8fd4\u56de\u4e86\u5185\u90e8\u9519\u8bef\u3002\u5982\u4f55\u624d\u80fd\u77e5\u9053\u662f\u5426\u771f\u7684\u8fdb\u884c\u4e86\u91cd\u8bd5\uff1f\u53ef\u4ee5\u67e5\u770b httpbin pod \u4e2d istio-proxy \u5bb9\u5668\u8bbf\u95ee\u65e5\u5fd7 $ kubectl logs -f httpbin-7d9d5b55b9-kzt5k -c istio-proxy [2019-10-27T10:39:54.372Z] \"GET /status/500 HTTP/1.1\" 500 - \"-\" 0 0 5 3 \"-\" \"HTTPie/0.9.9\" \"0d1cc197-8376-9756-a3c9-7d7c5706ca6f\" \"httpbin:8000\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local - 10.1.0.120:80 10.1.0.122:41152 - [2019-10-27T10:39:54.372Z] \"GET /status/500 HTTP/1.1\" 500 - \"-\" 0 0 5 3 \"-\" \"HTTPie/0.9.9\" \"0d1cc197-8376-9756-a3c9-7d7c5706ca6f\" \"httpbin:8000\" \"127.0.0.1:80\" inbound|8000|http|httpbin.default.svc.cluster.local - 10.1.0.120:80 10.1.0.122:41152 - ... \u4f1a\u53d1\u73b0\uff0c\u6bcf\u6b21\u8bbf\u95ee\u90fd\u4ea7\u751f\u4e864\u6761\u8bbf\u95ee\u65e5\u5fd7\uff0c\u4e5f\u5c31\u662f\u8bf4\u53d1\u751f\u4e863\u6b21\u91cd\u8bd5 \u8d85\u65f6\u63a7\u5236\u5185\u5bb9\u95ee\u9898\u53d8\u5f97\u590d\u6742\u4e86\u8d77\u6765\uff1a \u91cd\u8bd5\u6709\u8d85\u65f6\u8bbe\u7f6e\uff0c \u670d\u52a1\u8c03\u7528\u672c\u8eab\u4e5f\u6709\u8d85\u65f6\u8bbe\u7f6e\uff0c \u4e24\u8005\u662f\u5982\u4f55\u534f\u8c03\u7684\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u63a5\u7740\u8fdb\u884c\u6d4b\u8bd5 \u5c06\u4e0a\u9762\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u4fee\u6539\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local # timeout: 3s retries: attempts: 3 perTryTimeout: 1s timeout: 7s retries: attempts: 3 perTryTimeout: 1s timeout: 7s \u8fd9\u91cc\u8bbe\u7f6e\u6bcf\u6b21\u91cd\u8bd5\u7684\u8d85\u65f6\u5bb9\u5fcd\u65f6\u95f4\u4e3a1\u79d2\uff0c\uff5b\u4fea\u6025\u4f53\u7684\u8d85\u65f6\u5bb9\u5fcd\u65f6\u95f4\u4e3a7\u79d2\uff0c\u5728\u5e94\u7528\u8fd9\u4e00\u89c4\u5219\u540e\u8fdb\u5165 sleep Pod \uff0c\u4f7f\u7528 http://httpbin:8000/delay/10 \u8fdb\u884c\u6d4b\u8bd5 # time http http://httpbin:8000/delay/10 HTTP/1.1 504 Gateway Timeout content-length: 24 content-type: text/plain date: Sun, 27 Oct 2019 11:09:09 GMT server: envoy upstream request timeout real 0m4.309s user 0m0.265s sys 0m0.037s bash-4.4# \u53ef\u4ee5\u770b\u5230\uff0c\u8fd4\u56de\u65f6\u95f4\u662f4\u79d2\u591a\uff0c\u53ef\u4ee5\u5224\u65ad\u662f\u91cd\u8bd5\u7684\u8d85\u65f6\u8bbe\u7f6e\u4ea7\u751f\u4e86\u4f5c\u7528. \u518d\u6b21\u4fee\u6539\u8def\u7531\u89c4\u5219\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local # timeout: 3s retries: attempts: 3 perTryTimeout: 1s timeout: 3s bash-4.4# time http http://httpbin:8000/delay/10 HTTP/1.1 504 Gateway Timeout content-length: 24 content-type: text/plain date: Sun, 27 Oct 2019 11:12:36 GMT server: envoy upstream request timeout real 0m3.337s user 0m0.297s sys 0m0.025s \u8fd9\u6b21\u751f\u6548\u7684\u5c31\u662f\u603b\u4f53\u7684\u8d85\u65f6\u65f6\u95f4\u4e86\u3002 \u53ef\u4ee5\u5f97\u7ed3\u8bba\uff1a \u5bf9\u4e8e\u91cd\u8bd5\u7684\u8d85\u65f6\u8bbe\u7f6e\u548c\u603b\u4f53\u7684\u8d85\u65f6\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u5c06\u91cd\u8bd5\u7684\u8d85\u65f6\u548c\u91cd\u8bd5\u6b21\u6570\u7684\u4e58\u79ef\u4e0e\u603b\u4f53\u7684\u8d85\u65f6\u8fdb\u884c\u6bd4\u8f83\uff0c\u54ea\u4e2a\u5c0f\uff0c\u54ea\u4e2a\u8bbe\u7f6e\u5c31\u4f1a\u4f18\u5148\u751f\u6548\u3002","title":"2\u3001 \u6545\u969c\u91cd\u8bd5\u63a7\u5236"},{"location":"chap5/11Istio_http3/#3","text":"Kubernetes \u4e3a\u7b2c\u4e09\u65b9\u5382\u5546\u63d0\u4f9b\u4e86 Ingress Controller \u89c4\u8303\uff0c\u7528\u4e8e\u5165\u7ad9\u6d41\u91cf\u7ba1\u7406\u3002 Istio \u7684\u65e9\u671f\u7248\u672c\u4e5f\u636e\u6b64\u5b9e\u73b0\u4e86\u81ea\u5df1\u7684 Ingress Controller \uff0c\u53c8\u56e0 Ingress Controller \u5728\u540e\u6765\u65e0\u6cd5\u6ee1\u8db3\u4e0d\u65ad\u589e\u52a0\u7684\u9700\u6c42\uff0c\u6240\u4ee5 Istio \u53c8\u63a8\u51fa\u4e86 Gateway \u7684\u6982\u5ff5\uff0c\u7528\u4e8e\u5728\u7f51\u7edc\u8fb9\u7f18\u8fdb\u884c\u5165\u7ad9\u548c\u51fa\u7ad9\u7684\u6d41\u91cf\u7ba1\u7406\u3002 Ingress Gateway \u5728\u903b\u8f91\u4e0a\u76f8\u5f53\u4e8e\u7f51\u7edc\u8fb9\u7f18\u7684\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u7528\u4e8e\u63a5\u6536\u548c\u5904\u7406\u7f51\u683c\u8fb9\u7f18\u51fa\u7ad9\u548c\u5165\u7ad9\u7684\u7f51\u7edc\u8fde\u63a5\uff0c \u5176\u4e2d\u5305\u542b\u5f00\u653e\u7aef\u53e3\u548c TLS \u7684\u914d\u7f6e\u7b49\u5185\u5bb9\u3002 \u5728\u4f7f\u7528 Helm \u8fdb\u884c Istio \u90e8\u7f72\u65f6, \u9700\u8981\u901a\u8fc7\u4e0b\u9762\u7684\u8bbe\u7f6e\u6765\u542f\u7528 Ingress Gateway : gateways: enabled:true istio-ingressgateway: enabled\uff1atrue \u5b9e\u9645\u4e0a\uff0c\u5728\u524d\u9762\u7684\u6d41\u91cf\u7ba1\u7406\u63a2\u8ba8\u4e2d\u4f7f\u7528\u7684 VirtualService \u5bf9\u8c61\uff0c\u90fd\u9ed8\u8ba4\u5305\u542b gateways \u5b57\u6bb5\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a\uff0c\u90a3\u4e48\u5176\u9ed8\u8ba4\u503c\u662f\uff1a gatways: - mesh \u8fd9\u91cc\u7684 mesh \u662f Istio \u5185\u90e8\u7684\u865a\u62df Gateway \uff0c\u4ee3\u8868\u7f51\u683c\u5185\u90e8\u7684\u6240\u6709 Sidecar \uff0c \u6362\u53e5\u8bdd\u8bf4\uff1a \u6240\u6709\u7f51\u683c\u5185\u90e8\u670d\u52a1\u4e4b\u95f4\u7684\u4e92\u76f8\u901a\u4fe1\uff0c\u90fd\u662f\u901a\u8fc7\u8fd9\u4e2a\u7f51\u5173\u8fdb\u884c\u7684\u3002\u5982\u679c\u8981\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u5c31\u9700\u8981\u5b9a\u4e49 Gateway \u5bf9\u8c61\uff0c\u5e76\u5728 gateways \u5b57\u6bb5\u4e2d\u8fdb\u884c\u8d4b\u503c\u3002 \u4e00\u65e6\u5728 gateways \u4e2d\u586b\u5199\u4e86 mesh \u4e4b\u5916\u7684\u5bf9\u8c61\u540d\u79f0\uff0c\u5c31\u8981\u7ee7\u7eed\u5bf9\u5185\u90e8\u901a\u4fe1\u8fdb\u884c\u6d41\u91cf\u63a7\u5236\uff0c\u5e76\u5fc5 \u987b\u663e\u5f0f\u5730\u5c06\u5185\u7f6e\u7684 mesh \u5bf9\u8c61\u540d\u79f0\u4e5f\u52a0\u5165\u5217\u8868\u4e2d\u3002","title":"3\u3001\u5165\u53e3\u6d41\u91cf\u7ba1\u7406"},{"location":"chap5/11Istio_http3/#3-1-gateway","text":"\u6211\u4eec\u9996\u5148\u5c1d\u8bd5\u4f7f\u7528 Gateway \u5f00\u653e\u670d\u52a1\u3002\u4e0e Kubernetes Ingress \u7c7b\u4f3c\uff0c\u6211\u4eec\u9996\u5148\u8981\u5b9a\u4e49\u4e00\u4e2a Gateway : apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: example-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*.microservice.rocks\" - \"*.microservice.xyz\" \u628a\u6587\u4ef6\u5185\u5bb9\u4fdd\u5b58\u4e3a example.gateway.yaml . \u5728\u8fd9\u4e2a\u5b9a\u4e49\u4e2d\u6709\u4ee5\u4e0b\u513f\u70b9\u9700\u8981\u6ce8\u610f\uff1a selector \u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u6807\u7b7e\u9009\u62e9\u5668\uff0c\u7528\u4e8e\u6307\u5b9a\u7531\u54ea\u4e9b Gateway Pod \u6765\u8d1f\u8d23\u8fd9\u4e2a Gateway \u5bf9\u8c61\u7684\u8fd0\u884c \u3002 \u5728 hosts \u5b57\u6bb5\u4e2d\u7528\u4e86\u4e00\u4e2a\u901a\u914d\u7279\u57df\u540d\u6765\u6307\u660e\u8fd9\u4e2a Gateway \u53ef\u80fd\u8981\u8d1f\u8d23\u7684\u4e3b\u673a\u540d \u3002 \u53ef\u4ee5\u4f7f\u7528 kubectl get svc -n istio-system istio-ingressgateway \u6765\u67e5\u770b\u8be5\u670d\u52a1 \u7684 IP , \u5e76\u5c06\u6d4b\u8bd5\u57df\u540d\u6620\u5c04\u8fd9\u4e2a IP \u5c06\u914d\u7f6e\u63d0\u4ea4\u7ed9 Kubernetes \u96c6\u7fa4 $ kubectl apply -f example.gateway.yaml gateway.networking.istio.io/example-gateway created $ kubectl get gw NAME AGE example-gateway 16s $ sudo vi /etc/hosts 127.0.0.1 flaskapp.microservice.xyz flaskapp.microservice.xyz 127.0.0.1 flaskapp.microservice.rocks flaskapp.microservice.rocks $ kubectl get svc -n istio-system istio-ingressgateway NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-ingressgateway LoadBalancer 10.104.0.103 localhost 15020:30047/TCP,80:31380/TC P,443:31390/TCP,31400:31400/TCP,15029:32144/TCP,15030:30106/TCP,15031:30007/TCP,15032:31464/TC P,15443:31744/TCP 9d $ pip3 install --upgrade httpie $ http flask.microservice.rocks HTTP/1.1 404 Not Found Age: 0 Connection: keep-alive Content-Encoding: gzip Content-Type: text/html Date: Mon, 28 Oct 2019 07:21:18 GMT Server: nginx/1.14.0 (Ubuntu) Transfer-Encoding: chunked Via: 1.1 akamai (ACE 5.10.3/5.10.3) \u56de\u8fc7\u5934\u770b Gateway \u7684\u6982\u5ff5\uff0c\u4e0d\u96be\u53d1\u73b0\uff0c\u5176\u4e2d\u5e76\u6ca1\u6709\u6307\u5b9a\u8d1f\u8d23\u54cd\u5e94\u8bf7\u6c42\u7684\u670d\u52a1\uff0c\u6211\u4eec\u9700\u8981\u5bf9 flaskapp \u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u4fee\u6539\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local - flaskapp.microservice.rocks gateways: - mesh - example-gateway http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 $ kubectl apply -f gatway-flaskapp-virtualservice.yaml virtualservice.networking.istio.io/flaskapp configured bash-4.4# http flaskapp.microservice.rocks/env/version HTTP/1.1 200 OK content-length: 2 content-type: text/html; charset=utf-8 date: Mon, 28 Oct 2019 07:18:49 GMT server: envoy x-envoy-upstream-service-time: 0 v2","title":"3-1 \u4f7f\u7528Gateway\u5f00\u653e\u670d\u52a1"},{"location":"chap5/11Istio_http3/#3-2-gatwaway","text":"\u5165\u53e3\u7f51\u5173\u901a\u5e38\u627f\u62c5\u7740\u6d41\u91cf\u52a0\u5bc6\u7684\u4efb\u52a1\uff0c Ingress Gateway \u4e5f\u5177\u5907\u8fd9\u6837\u7684\u80fd\u529b \u5728 Ingress Gateway \u4e2d\u7528\u53ef\u9009\u65b9\u5f0f\u52a0\u8f7d\u4e86\u4e00\u4e2a\u540d\u79f0\u4e3a istio-ingressgateway-certs \u7684 Secret , \u5e76\u5c06\u5176\u52a0\u8f7d\u5230\u4e86 /etc/istio/ingressgateway-ca-cert \u76ee\u5f55\u4e2d\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u8981\u4f7f\u7528\u8bc1\u4e66\u548c\u5bc6\u94a5\u521b\u5efa\u8fd9\u4e2a Secret \uff0c\u5c31\u53ef\u4ee5\u5c06\u5176\u63d0\u4f9b\u7ed9 Gateway \u4f7f\u7528\u4e86\u3002 \u5728 Gateway \u4e2d\u53ef\u4ee5\u4f7f\u7528 tls \u5b57\u6bb5\u6765\u5b9a\u4e49\u5bf9\u8bc1\u4e66\u7684\u4f7f\u7528\u3002 \u9996\u5148\u4f7f\u7528\u8bc1\u4e66\u6587\u4ef6\u521b\u5efa Secret : kubectl create -n istio-secret tls istio-ingressgateway-certs --key rocks/key.pem --cert rocks/cert.pem \u7136\u540e\u4fee\u6539 Gateway \u7684\u5b9a\u4e49 apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: example-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*.microservice.rocks\" - \"*.microservice.xyz\" - port: number: 443 name: https protocol: HTTPS tls: mode: SIMPLE serverCertificate: /etc/istio/ingressgateway-certs/tls.crt privateKey: /etc/istio/ingressgateway-certs/tls.key hosts: - \"flaskapp.microservice.rocks\" - \"flaskapp.microservice.xyz\" http https://flaskapp.microservice.rocks/env/version HTTP/1.1 200 OK ... server: envoy x-envoy-upstream-service-time: 1 v2 \u53ef\u4ee5\u770b\u5230\uff0c\u5bf9\u57df\u540d flaskapp.microservice.rocks \u7684 HTTPS \u8bbf\u95ee\u5df2\u7ecf\u751f\u6548\uff1a","title":"3-2 \u4e3agatwaway\u6dfb\u52a0\u8bc1\u4e66\u652f\u6301"},{"location":"chap5/11Istio_http3/#3-3-gatwaway","text":"\u53c2\u7167\u5b98\u65b9\u6587\u6863\u53ef\u4ee5\u53d1\u73b0\uff0c tls secret \u53ea\u80fd\u5305\u542b\u4e00\u4e2a\u8bc1\u4e66\u5bf9\uff0c\u56e0\u6b64\u4e00\u4e2a Gateway \u662f\u65e0\u6cd5\u5904\u7406\u4e24\u4e2a\u57df\u540d\u7684 HTTPS \u7684\uff0c\u53ef\u4ee5\u6362\u7528 Generic \u7c7b\u578b\u7684\u8bc1\u4e66, \u8fd9\u91cc\u9700\u8981\u5220\u9664\u539f\u6709\u7684 Secret \u5e76\u91cd\u65b0\u521b\u5efa\uff1a $ kubectl delete secret istio-ingressgateway-certs -n istio-system secret \"istio-ingressgateway-certs\" deleted $ kubectl create secret generic istio-ingressgateway-certs -n istio-system -from-file=rocks-cert.pem --from-file=rocks-key.pem --from-file=xyz-cert.pem --from-file=xyz-keys.pem secret/istio-ingressgateway-certs created \u5728\u65b0\u7684 Secret \u521b\u5efa\u597d\u4e4b\u540e\uff0c\u8fd8\u9700\u8981\u4fee\u6539 Gateway \u7684\u914d\u7f6e apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: example-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http-all protocol: HTTP hosts: - \"*.microservice.rocks\" - \"*.microservice.xyz\" - port: number: 443 name: https-rocks protocol: HTTPS tls: mode: SIMPLE serverCertificate: /etc/istio/ingressgateway-certs/rocks-cert.pem privateKey: /etc/istio/ingressgateway-certs/rocks-cert.pem hosts: - \"flaskapp.microservice.rocks\" - port: number: 443 name: https-xyz protocol: HTTPS tls: mode: SIMPLE serverCertificate: /etc/istio/ingressgateway-certs/xyz-cert.pem privateKey: /etc/istio/ingressgateway-certs/xyz-cert.pem hosts: - \"flaskapp.microservice.xyz\" \u5728\u63d0\u4ea4\u5230\u96c6\u7fa4\u4e4b\u540e\uff0c\u518d\u6b21\u8fdb\u884c\u6d4b\u8bd5\uff1a $ http --body https://flaskapp.microservice.xyz/env/version v2 $ http --body https://flaskapp.microservice.rocks/env/version v2","title":"3-3 \u4e3agatwaway\u6dfb\u52a0\u591a\u4e2a\u8bc1\u4e66\u652f\u6301"},{"location":"chap5/11Istio_http3/#3-4","text":"VirtualService \u4e2d\u7684\u8def\u7531\u5339\u914d\u529f\u80fd\u5bf9 ingress \u6d41\u91cf\u4e5f\u662f\u6709\u6548\u7684\uff0c \u4f8b\u5982\uff0c\u6211\u4eec\u5e0c\u671b\u6d41\u91cf\u6765\u81ea\u5916\u90e8\u6d41\u91cf\u7531 flaskapp \u670d\u52a1 v1 ,\u5219\u53ef\u4ee5\u8fd9\u6837\u4fee\u6539\u539f\u6709\u7684 VirtualService apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local - flaskapp.microservice.rocks - flaskapp.microservice.xyz gateways: - mesh - example-gateway http: - match: - gateways: - example-gateway route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 $ http --body http://flaskapp.microservice.xyz/env/version v1 $ http --body http://flaskapp.microservice.rocks/env/version v1 delete 127.0.0.1 flaskapp.microservice.rocks flaskapp.microservice.rocks from /etc/hosts $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash http --body http://flaskapp.microservice.xyz/env/version v2 \u53ef\u4ee5\u770b\u5230\uff0c\u6309\u7167\u6211\u4eec\u7684\u8bbe\u8ba1\uff0c\u6240\u6709\u4ece example-gateway \u8fdb\u4eba\u7684\u6d41\u91cf\uff0c\u90fd\u7531 flaskapp \u670d\u52a1\u7684 v \u7248\u672c\u8fdb\u884c\u5904\u7406 \u6765\u81ea\u5185\u90e8\u7684\u6d41\u91cf\u5219\u7531 flaskapp \u670d\u52a1\u7684 v2 \u7248\u672c\u8fdb\u884c\u5904\u7406\u3002","title":"3-4 \u914d\u7f6e\u5165\u53e3\u6d41\u91cf\u7684\u8def\u7531"},{"location":"chap5/11Istio_http3/#4","text":"Istio \u5728\u5bf9\u5e94\u7528\u8fdb\u884c\u6ce8\u5165\u7684\u65f6\u5019\uff0c\u4f1a\u52ab\u6301\u8be5\u5e94\u7528\u7684\u6240\u6709\u6d41\u91cf\uff0c\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7f51\u683c\u4e4b\u5185\u7684\u5e94\u7528\u662f\u65e0\u6cd5\u8bbf\u95ee\u7f51\u683c\u4e4b\u5916\u7684\u670d\u52a1\u7684, \u4f8b\u5982\u5c1d\u8bd5\u5728 Sleep Pod \u4e2d\u8bbf\u95ee http://api.jd.com $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http http://api.jd.com HTTP/1.1 200 OK age: 0 cache-control: max-age=0 content-encoding: gzip content-type: text/html date: Tue, 29 Oct 2019 09:03:50 GMT etag: W/\"131-1571644820000\" expires: Tue, 29 Oct 2019 09:03:51 GMT last-modified: Mon, 21 Oct 2019 08:00:20 GMT server: envoy transfer-encoding: chunked vary: Accept-Encoding x-envoy-upstream-service-time: 279 <html> <script type=\"text/javascript\"> window.location=\"http://jos.jd.com\"; </script> <body> <h2></h2> </body> </html> \u4f46\u662f\u4ece\u7f51\u683c\u5185\u90e8\u53d1\u8d77\u5bf9\u5916\u7684\u7f51\u7edc\u8bf7\u6c42\u662f\u5e38\u89c1\u7684\u9700\u6c42\uff0c Istio \u63d0\u4f9b\u4e86\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\u7528\u4e8e\u7f51\u683c\u5916\u90e8\u901a\u4fe1\u3002 \u8bbe\u7f6e Sidcar \u7684\u6d41\u91cf\u52ab\u6301\u8303\u56f4\u6839\u636e IP \u5730\u5740\u6765\u544a\u77e5 Sidecar \u54ea\u4e9b\u5916\u90e8\u8d44\u6e90\u53ef\u4ee5\u653e\u5f00\u8bbf\u95ee\u3002 \u6ce8\u518c ServiceEntry \uff1a\u628a\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u4f7f\u7528 ScrviceEntry \u7684\u65b9\u5f0f\u6ce8\u518c\u5230\u7f51\u683c\u5185\u90e8. \u4e0b\u9762\u5c06\u5206\u522b\u8fdb\u884c\u5b9e\u8df5\u3002","title":"4\u3001 \u51fa\u53e3\u6d41\u91cf\u7ba1\u7406"},{"location":"chap5/11Istio_http3/#4-1-sidecar","text":"\u7f51\u683c\u5185\u90e8\u7684\u5e94\u7528\u6d41\u5740\u52ab\u6301\u662f\u7531 istio-init \u5bb9\u5668\u5b8c\u6210\u7684\u6709\u4ee5\u4e0b\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u5f71\u54cd\u5b83\u7684\u52ab\u6301\u8303\u56f4 \u7b2c1\u79cd\u8bbe\u7f6e values.yaml \u4e2d\u7684 proxy.includeIPRange \u53d8\u91cf \u3002 \u7b2c2\u79cd\u4f7f\u7528 Pod \u6ce8\u89e3 traffic.sidecar.istio.io/includeOutboundIPRanges \u8868\u660e\u52ab\u6301\u8303\u56f4 \u7b2c 1 \u79cd\u65b9\u5f0f\u548c\u4e4b\u524d\u4fee\u6539 HELM \u8f93\u4eba\u53d8\u91cf\u7684\u6240\u6709\u65b9\u5f0f\u57fa\u672c\u76f8\u540c\u4f46\u662f\uff0c \u9700\u8981\u91cd\u65b0\u521b\u5efa\u6240\u6709\u88ab\u6ce8\u4eba\u7684 Pod \u3002 \u4e0b\u9762\u6d4b\u8bd5\u4e00\u4e0b\u6ce8\u89e3\u65b9\u5f0f \u4f7f\u7528 kubectl \u7f16\u8f91 sleep-v1 \u5bf9\u8c61, \u5728 template \u4e2d\u52a0\u4eba\u65b0\u7684\u6ce8\u89e3\uff1a metadata: name: sleep-v1 annotations: traffic.sidecar.istio.io/includeOutboundIPRanges: 10.96.0.0/12 \u8fd9\u91cc\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u767d\u540d\u5355\u8981\u6c42\u521d\u59cb\u5316\u5bb9\u5668\u53ea\u5bf9\u81ea\u540d\u5355\u8303\u56f4\u5185\u7684\u62a4\u8fdb\u884c\u52ab\u6301\u8fd9 \u91cc\u8f93\u4eba\u7684 CIDR \u8303\u56f4\u5c31\u662f\u7b14\u8005\u7684\u6d4b\u8bd5\u96c6\u7fa4\u7684\u670d\u52a1\u5730\u5740\u8303\u56f4, \u901a\u8fc7 kubectl \u547d\u4ee4\u53ef\u4ee5\u770b\u5230 sleep-v1 \u7684 Pod \u4f1a\u88ab\u91cd\u5efa \u5728 Pod \u542f\u52a8\u5b8c\u6210\u4e4b\u540e\u6211\u4eec\u518d\u6b21\u8fdb\u884c\u6d4b\u8bd5 Get Services IPs range kubectl cluster-info dump | grep -m 1 service-cluster-ip-range \"--service-cluster-ip-range=10.96.0.0/12\", $ kubectl apply -f sleep.istio.yaml service/sleep configured deployment.extensions/sleep-v1 configured deployment.extensions/sleep-v2 unchanged $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sle ep bash bash-4.4# http http://api.jd.com HTTP/1.1 200 OK cache-control: max-age=0 content-encoding: gzip content-type: text/html date: Tue, 29 Oct 2019 09:42:01 GMT etag: W/\"131-1571644820000\" expires: Tue, 29 Oct 2019 09:42:01 GMT last-modified: Mon, 21 Oct 2019 08:00:20 GMT server: envoy transfer-encoding: chunked vary: Accept-Encoding x-envoy-upstream-service-time: 1792 <html> <script type=\"text/javascript\"> window.location=\"http://jos.jd.com\"; </script> <body> <h2></h2> </body> </html> \u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u4fee\u6539\u5df2\u7ecf\u751f\u6548. \u8fd9\u79cd\u65b9\u5f0f\u975e\u5e38\u76f4\u63a5\u4f46\u5b9e\u9645\u571f\u5728\u7f51\u683c\u5185\u90e8\u662f\u4e00\u4e2a\u4f8b\u5916\uff1a \u8bbf\u95ee\u5916\u90e8\u5730\u5740\u7684\u8bf7\u6c42\u4f1a\u7531\u4e1a\u52a1 Pod \u53d1\u51fa\u7ed5\u8fc7 Sidecar \u5b8c\u5168\u4e0d\u53d7 Istio \u7684\u76d1\u63a7\u548c\u7ba1\u7406 \u4e3a\u4e86\u8fdb\u884c\u6d4b\u8bd5\u627e\u4eec\u518d\u6b21\u7f16\u8f91 sleep-v1 \u53bb\u6389\u6ce8\u89e3\u7684\u5185\u5bb9","title":"4-1 \u8bbe\u7f6eSidecar\u7684\u6d41\u91cf\u52ab\u6301\u8303\u56f4"},{"location":"chap5/11Istio_http3/#4-2-serviceentry","text":"\u53ef\u4ee5\u4e3a\u5916\u90e8\u670d\u52a1\u8bbe\u7f6e ServiceEntry \u76f8\u5f53\u4e8e\u5c06\u5916\u90e8\u670d\u52a1\u5728\u7f51\u683c\u5185\u90e8\u8fdb\u884c\u4e86\u6ce8\u518c. \u76f8\u5bf9\u4e8e\u4f7f\u7528 CIDR \u767d\u540d\u5355\u7684\u65b9\u5f0f\u8fd9\u79cd\u65b9\u5f0f\uff0c \u8ba9 Istio \u5bf9\u5916\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u6709\u4e86\u66f4\u5927\u7684\u7ba1\u7406\u80fd\u529b \u6211\u4eec\u9996\u5148\u4e3a httpbin.org \u8bbe\u7f6e\u4e00\u4e2a ServicerEntry apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: httpbin-ext spec: hosts: - httpbin.org ports: - number: 80 name: http protocol: HTTP resolution: DNS \u4e0a\u8ff0\u5185\u5bb9\u88ab\u4fdd\u5b58\u4e3a httpbin.entry.yaml \uff0c\u5e76\u4f7f\u7528 kubectL apply \u63d0\u4ea4\u5230\u96c6\u7fa4\uff0c\u7136\u540e\u5c1d\u8bd5\u8bbf\u95ee\uff1a $ kubectl apply -f httpbin.entry.yaml serviceentry.networking.istio.io/httpbin-ext created $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash http http://httpbin.org/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * age: 0 content-encoding: gzip content-length: 503 content-type: application/json date: Wed, 30 Oct 2019 01:59:25 GMT referrer-policy: no-referrer-when-downgrade server: envoy x-content-type-options: nosniff x-envoy-upstream-service-time: 615 x-frame-options: DENY x-xss-protection: 1; mode=block { \"args\": {}, \"headers\": { \"Accept\": \"*/*\", \"Accept-Encoding\": \"gzip, deflate\", \"Cache-Control\": \"max-stale=0\", \"Host\": \"httpbin.org\", \"User-Agent\": \"HTTPie/0.9.9\", \"X-B3-Sampled\": \"1\", \"X-B3-Spanid\": \"fbf90cdccaae19eb\", \"X-B3-Traceid\": \"6af3dc0f3e12e8f5fbf90cdccaae19eb\", \"X-Bluecoat-Via\": \"0aa8a714ac138a74\", \"X-Envoy-Decorator-Operation\": \"httpbin.org:80/*\", \"X-Istio-Attributes\": \"CikKGGRlc3RpbmF0aW9uLnNlcnZpY2UuaG9zdBINEgtodHRwYmluLm9yZwoqCh1 kZXN0aW5hdGlvbi5zZXJ2aWNlLm5hbWVzcGFjZRIJEgdkZWZhdWx0CikKGGRlc3RpbmF0aW9uLnNlcnZpY2UubmFtZRINE gtodHRwYmluLm9yZwo+Cgpzb3VyY2UudWlkEjASLmt1YmVybmV0ZXM6Ly9zbGVlcC12MS01NDhkODdjYzVjLXdmazd2LmR lZmF1bHQ=\" }, \"origin\": \"169.145.197.12, 169.145.197.12\", \"url\": \"https://httpbin.org/get\" } \u53ef\u4ee5\u770b\u5230\uff0c\u6ce8\u518c\u540e\u7684\u5185\u5bb9\u8bbf\u95ee\u6210\u529f\u4e86 \u4f7f\u7528 ServiceEntry \u7684\u4e00\u4e2a\u597d\u5904\u5c31\u662f\uff0c\u53ef\u4ee5\u5229\u7528\u6d41\u91cf\u7ba1\u7406\u7279\u80dc\uff0c\u5bf9\u5916\u90e8\u8bbf\u95ee\u8fdb\u884c\u76d1\u63a7\u548c\u7ba1\u7406\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u5bf9\u521a\u624d\u7684 ServiceEntry \u8bbe\u7f6e\u4e86\u4e00\u4e2a 3 \u79d2\u7684\u8d85\u65f6\u9650\u5236\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin-service spec: hosts: - httpbin.org http: - timeout: 3s route: - destination: host: httbin.org \u5c06\u6587\u672c\u4fdd\u5b58\u4e3a serviceentry.virtualservice.yaml ,\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u8fd0\u884c $ kubectl apply -f serviceentry.virtualservice.yaml virtualservice.networking.istio.io/httpbin-service created $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# time http --body http://httpbin.org/delay/10 real 0m0.302s user 0m0.262s sys 0m0.031s \u53ef\u4ee5\u770b\u5230\uff0c\u8d85\u65f6\u7b56\u7565\u5df2\u7ecf\u751f\u6548\uff0c\u5728\u8bf7\u6c42\u65f6\u95f4\u8fbe\u5230\u6211\u4eec\u8bbe\u7f6e\u7684\u8d85\u65f6\u65f6\u95f4\u4e4b\u540e\u4f1a\u76f4\u63a5\u8fd4\u56de\u5931\u8d25\u3002","title":"4-2 \u8bbe\u7f6eServiceEntry"},{"location":"chap5/11Istio_http3/#4-3-gateway","text":"\u53d7\u5230\u7f51\u7edc\u7b56\u7565\u6216\u8005\u5b89\u5168\u56e0\u7d20\u7684\u5f71\u54cd\uff0c\u6211\u4eec\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\u901a\u5e38\u9700\u8981\u8bbe\u7f6e\u591a\u4e2a\u4e0d\u540c \u7684\u8fb9\u7f18\u7f51\u5173\u6765\u5b8c\u6210\u4e0d\u540c\u7684\u4efb\u52a1\uff0c\u4f8b\u5982\uff0c\u53ea\u6709\u7279\u5b9a\u8282\u70b9\u63d0\u4f9b\u4e86\u51fa\u7ad9\u8fde\u63a5\u80fd\u529b\uff0c\u6216\u8005\u5916 \u90e8\u8d1f\u8f7d\u5747\u8861\u53ea\u80fd\u4e3a\u90e8\u5206\u670d\u52a1\u5668\u5206\u53d1\u8d1f\u8f7d\u7b49\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5bf9\u670d\u52a1\u7f51\u683c\u4e2d\u7684 Gateway \u63a7\u5236\u5668\u90e8\u7f72\u8fdb\u884c\u5b9a\u5236\u3002 \u4e0d\u540c\u7528\u9014\u7684 Gateway \u63a7\u5236\u5668\u53ef\u4ee5\u5206\u5e03\u5728\u4e0d\u540c\u7684\u8282\u70b9\uff0c\u6216\u8005\u4f7f\u7528\u4e0d\u540c\u6570\u91cf\u7684\u8d44\u6e90\u7b49\u3002 Istio \u5728 Helm chart \u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65b0\u5efa Gateway \u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u5728\u5bf9\u8f93\u4eba\u503c\u8fdb\u884c\u5b9a\u5236\u4e4b\u540e\uff0c\u9996\u5148\u4f7f\u7528 Helm \u6307\u4ee4\u751f\u6210\u65b0\u7684\u63a7\u5236\u5668\u3002 \u4e0b\u9762\u8fdb\u884c\u5b9e\u9645\u64cd\u4f5c\u3002 \u5728 values.yaml \u7684 gateways \u5b57\u6bb5\u52a0\u4eba\u5982\u4e0b\u5185\u5bb9\uff1a $ cd Istio/istio-1.1.16/install/kubernetes/helm/istio/charts/gateways $ values.yaml ... enabled: true istio-myingress: enabled: true labels: app: istio-ingressgateway istio: myingress replicaCount: 3 autoscaleMax: 5 resources: {} cpu: targetAverageUtilization: 80 loadBalancerIP: \"\" serviceAnnotations: {} # type: LoadBalancer type: NodePort ports: - port: 80 targetPort: 80 name: http-myingress istio-ingressgateway: enabled: true ... https://istio.io/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports Change from loadbalancer to NodePort \u8fd9\u91cc\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u65b0\u7684 Ingress Gateway \u63a7\u5236\u5668\uff0c\u5b83\u4f1a\u5efa\u7acb\u4e09\u4e2a Pod \uff0c\u5f00\u653e 80 \u7aef\u53e3\u4f9b\u5916\u754c\u8bbf\u95ee\u3002 \u4f7f\u7528 Helm \u6e32\u67d3\u5e76\u8fdb\u884c\u90e8\u7f72\uff1a $ cd Istio/istio-1.1.16/install/kubernetes/helm/ helm template istio --name istio -f istio/values.yaml --namespace istio-system | kubectl apply -f - $ kubectl get pod -n istio-system ... istio-myingress-5bbcddc954-8jvp7 1/1 Running 0 9m37s istio-myingress-5bbcddc954-f4k82 1/1 Running 0 9m37s istio-myingress-5bbcddc954-ftc6r 1/1 Running 0 9m37s ... \u5728\u5b8c\u6210\u4e4b\u540e\u53ef\u4ee5\u5c1d\u8bd5\u4e3a httpbin \u670d\u52a1\u521b\u5efa\u4e00\u4e2a Gateway \u5bf9\u8c61\u6765\u5bf9\u5916\u5f00\u653e\u670d\u52a1\uff1a http-bin-gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: httpbin-gateway spec: selector: istio: myingress servers: - port: number: 80 name: http-all protocol: HTTP hosts: - \"*\" $ kubectl apply -f httpbin-gateway.yaml gateway.networking.istio.io/httpbin-gateway created \u5728\u8fd9\u4e2a\u5b9a\u4e49\u4e2d\uff1a \u4ec5\u5f00\u653e\u4e86 80 \u7aef\u53e3\uff1b \u6ca1\u6709\u5bf9\u4e3b\u673a\u540d\u505a\u51fa\u8981\u6c42\uff0c\u4f7f\u7528\u4e86\u901a\u914d\u7b26\u201c*\u201d\u4f5c\u4e3a\u4e3b\u673a\u540d\uff1b selector \u7528\u4e8e\u9009\u62e9\u6211\u4eec\u65b0\u5efa\u7684 Gateway \u63a7\u5236\u5668\u3002 \u7136\u540e\uff0c\u4fee\u6539 httpbin.gatwayservice.yaml \uff0c\u8bbe\u7f6e\u5176\u4e2d\u7684 gateways \u5b57\u6bb5\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - \"*\" gateways: - httpbin-gateway http: - route: - destination: host: httpbin.default.svc.cluster.local timeouts: 5s $ kubectl delete vs httpbin virtualservice.networking.istio.io \"httpbin\" deleted $ kubectl create -f httpbin.gatwayservice.yaml virtualservice.networking.istio.io/httpbin created \u8fd9\u91cc\u8ba9 VirtualService \u4f7f\u7528\u65b0\u5efa\u7684 httbin-gateway \u5bf9\u8c61\u5bf9\u5916\u5f00\u653e\u670d\u52a1\u6211\u4eec\u6d4b\u8bd5\u4e00\u4e0b $ kubectl get svc -n istio-system ... istio-myingress NodePort 10.103.69.251 <none> 80:31472/TCP ... $ http 127.0.0.1/31472 HTTP/1.1 200 OK ... \u53ef\u4ee5\u770b\u5230\u8bbf\u95ee\u6210\u529f\u5f97\u5230\u4e86\u54cd\u5e94\u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u6210\u529f\u4f7f\u7528\u65b0\u5efa\u7684 GateWay \u63a7\u5236\u5668\u5b8c\u6210\u4e86\u670d\u52a1\u7684\u5bf9\u5916\u5f00\u653e","title":"4-3 \u65b0\u5efaGateway\u63a7\u5236\u5668"},{"location":"chap5/12Istio_http4/","text":"\u7b2c\u5341\u4e8c\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u670d\u52a1\u7194\u65ad/\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5/\u6ce8\u5165\u4e2d\u65ad/\u6d41\u91cf\u590d\u5236) 1 \u8bbe\u7f6e\u670d\u52a1\u7194\u65ad 2 \u6545\u969c\u6ce8\u5165\u6d4b\u8bd5 3 \u6ce8\u5165\u4e2d\u65ad 4 \u6d41\u91cf\u590d\u5236 1\u3001\u8bbe\u7f6e\u670d\u52a1\u7194\u65ad \u670d\u52a1\u7194\u65ad\u662f\u4e00\u79cd\u4fdd\u62a4\u6027\u63aa\u65bd\uff0c\u5373\u5728\u670d\u52a1\u5b9e\u4f8b\u65e0\u6cd5\u6b63\u5e38\u63d0\u4f9b\u670d\u52a1\u7684\u6e05\u51b5\u4e0b\u5c06\u5176\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u79fb\u9664\uff0c\u4e0d\u518d\u4e3a\u5176\u5206\u914d\u4efb\u52a1\uff0c\u907f\u514d\u5728\u6545\u969c\u5b9e\u4f8b\u4e0a\u79ef\u538b\u66f4\u591a\u7684\u4efb\u52a1\u5e76\u4e14\u53ef\u4ee5\u5728\u7b49\u5f85\u670d\u52a1\u80fd\u529b\u6062\u590d\u540e\uff0c\u91cd\u65b0\u5c06\u53d1\u751f\u6545\u969c\u7684 Pod \u52a0\u4eba\u8d1f\u8f7d\u5747\u8861\u6c60\u3002 \u8fd9\u4e5f\u662f\u4e00\u79cd\u5e38\u89c1\u7684\u670d\u52a1\u964d\u7ea7\u65b9\u6cd5\u3002 \u5728 Istio \u4e2d\u540c\u6837\u63d0\u4f9b\u4e86\u975e\u4fb5\u5165\u5f0f\u7684\u670d\u52a1\u7194\u65ad\u529f\u80fd\u3002 \u5bf9\u8fd9\u4e00\u529f\u80fd\u53ea\u9700\u8bbe\u7f6e DestinationRule \u5bf9\u8c61\u5373\u53ef\u5b8c\u6210\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u4e3a httpbin \u670d\u52a1\u8bbe\u7f6e\u4e00\u4e2a\u76ee\u6807\u89c4\u5219\uff1a httpbin-fuse-dr.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: httpbin spec: host: httpbin trafficPolicy: connectionPool: tcp: maxConnections: 1 http: http1MaxPendingRequests: 1 maxllequesisPerConnection: 1 outlierDetection: consecutiveErrors: 1 interval: 1s baseEjectionT1me: 1m maxejectiosPercent: 100 $ kubectl apply -f httpbin-fuse-dr.yaml destinationrule.networking.istio.io/httpbin created \u63a5\u4e0b\u6765\u4f7f\u7528 sleep Pod \u4e2d\u7684 wrk \u5de5\u5177\u6d4b\u8bd5\u7194\u65ad\u6548\u679c\uff1a $ kubectl exec sleep-6c9c898f6c-448v6 -it bash -c sleep bash-4.4# wrk -c 3 -t 3 http://httpbin:8000/ip Running 10s test @ http://httpbin:8000/ip 3 threads and 3 connections Thread Stats Avg Stdev Max +/- Stdev Latency 4.49ms 5.93ms 65.45ms 88.70% Req/Sec 338.84 298.81 1.20k 77.78% 10108 requests in 10.03s, 2.39MB read Non-2xx or 3xx responses: 6140 \u2764\ufe0f Requests/sec: 1007.53 Transfer/sec: 243.48KB \u53ef\u4ee5\u770b\u5230\uff0c\u975e\u6b63\u5e38\u7ed3\u679c\u5360\u4e86\u7edd\u5927\u591a\u6570\uff0c\u8868\u660e\u7194\u65ad\u5df2\u7ecf\u751f\u6548\u3002 \u63a5\u7740\u5220\u9664\u7194\u65ad\u8bbe\u7f6e\uff0c\u91cd\u65b0\u6d4b\u8bd5\uff1a $ kubectl delete dr httpbin destinationrule.networking.istio.io \"httpbin\" deleted $ kubectl exec sleep-6c9c898f6c-448v6 -it bash -c sleep bash-4.4# wrk -c 3 -t 3 http://httpbin:8000/ip Running 10s test @ http://httpbin:8000/ip 3 threads and 3 connections Thread Stats Avg Stdev Max +/- Stdev Latency 5.47ms 5.53ms 60.24ms 87.98% Req/Sec 229.36 71.43 440.00 69.70% 6861 requests in 10.04s, 1.68MB read Requests/sec: 683.52 Transfer/sec: 171.58KB \u5728\u5220\u6389\u7194\u65ad\u8bbe\u7f6e\u4e4b\u540e\uff0cwrk\u91cd\u65b0\u8fd0\u884c\uff0c\u6240\u6709\u8bf7\u6c42\u90fd\u4f1a\u5b8c\u6210\u3002 \u8fd9\u91cc\u4f7f\u7528\u7684\u7194\u65ad\u8bbe\u7f6e\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\uff0c\u6bd4\u8f83\u6781\u7aef\uff1a TCP \u548c HTTP \u8fde\u63a5\u6c60\u5927\u5c0f\u90fd\u88ab\u8bbe\u7f6e\u4e3a1; \u53ea\u5141\u8bb8\u51fa\u9519\u4e00\u6b21\uff1b \u6bcf\u79d2\u505a\u4e00\u6b21\u8bf7\u6c42\u8ba1\u6570\uff1b \u53ef\u4ee5\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u79fb\u9664 100\uff05 \u7684 Pod ; \u53d1\u751f\u6545\u969c\u7684 Pod \u6700\u5c11\u5728\u88ab\u79fb\u9664 3 \u5206\u949f\u540e\u624d\u80fd\u518d\u6b21\u52a0\u5165\u8d1f\u8f7d\u5747\u8861\u6c60\u3002 \u8fd9\u91cc\u7528 wrk \u5de5\u5177\u76f4\u63a5\u4f7f\u7528\u8d85\u51fa\u7194\u65ad\u6807\u51c6\u7684\u5e76\u884c\u6570\u91cf\u6765\u8bbf\u95ee httpbin \u670d\u52a1\uff0c\u5728\u5f15\u53d1\u7194\u65ad\u540e\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u5f02\u5e38\u54cd\u5e94\uff1b\u5728\u5220\u9664\u76ee\u6807\u89c4\u5219\u540e\uff0c\u7194\u65ad\u89c4\u5219\u4e0d\u590d\u5b58\u5728\uff0c\u518d\u6b21\u7528\u540c\u6837\u7684\u53c2\u6570\u8fd0\u884cwrk\uff0c\u5c31\u4f1a\u6062\u590d\u6b63\u5e38\u7684\u8bbf\u95ee\u80fd\u529b\u4e86\u3002 2\u3001\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5 \u5728\u5fae\u670d\u52a1\u7684\u6d4b\u8bd5\u8fc7\u7a0b\u4e2d\uff0c\u5f80\u5f80\u9700\u8981\u5bf9\u7f51\u7edc\u6545\u969c\u7684\u573a\u666f\u8fdb\u884c\u6a21\u62df\uff0c Istio \u4e5f\u5728\u8fd9\u65b9\u9762\u63d0\u4f9b\u4e86\u4e24\u79cd\u6545\u969c\u6ce8\u5165\u7684\u80fd\u529b\uff1a \u5ef6\u8fdf \u548c \u4e2d\u65ad \u3002 \u501f\u52a9 Istio \u7684\u6545\u969c\u6ce8\u4eba\u80fd\u529b\uff0c\u6d4b\u8bd5\u4eba\u5458\u53ef\u4ee5\u4f7f\u7528 VirtualService \u914d\u7f6e\u65b9\u5f0f\uff0c\u5728\u4efb\u610f\u8c03\u7528\u4e2d\u52a0\u5165\u6a21\u62df\u6545\u969c\uff0c\u4ece\u800c\u6d4b\u8bd5\u5e94\u7528\u5728\u6545\u969c\u72b6\u6001\u4e0b\u7684\u54cd\u5e94\u60c5\u51b5\uff0c\u751a\u81f3\u53ef\u4ee5\u5728\u8bf7\u6c42\u4e2d\u6ce8\u5165\u4e2d\u65ad\uff0c\u6765\u963b\u6b62\u67d0\u4e9b\u60c5\u51b5\u4e0b\u7684\u670d\u52a1\u8bbf\u95ee \u3002 2-1 \u6ce8\u5165\u5ef6\u8fdf \u9996\u5148\uff0c\u7f16\u8f91 httpbin \u7684 VirtualService \uff0c\u4e3a\u670d\u52a1\u52a0\u4eba\u4e00\u4e2a 3 \u79d2\u7684\u5ef6\u8fdf\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - \"httpbin.default.svc.cluster.local\" http: - route: - destination: host: httpbin.default.svc.cluster.local fault: delay: fixedDelay: 3s percent: 100 $ kubectl apply -f http-lag-virtualservice.yaml virtualservice.networking.istio.io/httpbin configure bash-4.4# http --body http://httpbin:8000/delay/1 ... real 0m 4.321s \u5b9e\u9645\u5ef6\u8fdf\u4e86 3 \u79d2\uff0c\u4e5f\u5c31\u662f\u8bf4\u6ce8\u4eba\u7684\u5ef6\u8fdf\u751f\u6548\u4e86\u3002 \u8fd9\u5f88\u81ea\u7136\u5c31\u8ba9\u4eba\u8054\u60f3\u5230\u524d\u9762\u63d0\u5230\u7684\u8d85\u65f6\u63a7\u5236\u3002 \u8fd9\u91cc\u4e3a httpbin \u670d\u52a1\u8bbe\u7f6e\u4e00\u4e2a\u4e24\u79d2\u7684\u8d85\u65f6\u9650\u5236\uff0c\u4e5f\u5c31\u662f\u5728\u8def\u7531\u89c4\u5219\u4e2d\u52a0\u5165 timeout: 2s\" ,\u518d\u6b21\u8fdb\u884c\u6d4b\u8bd5\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local timeout: 2s fault: delay: fixedDelay: 3s percent: 100 bash-4.4# time http --body http://httpbin:8000/ip ... real 0m 3.331s ... http --body http://httpbin:8000/delay/2 real 0m 5.45s \u7ed3\u679c\u4e00\u76ee\u4e86\u7136\uff0c\u6211\u4eec\u5728\u8bf7\u6c42\u4e2d\u6ce8\u5165\u7684\u5ef6\u65f6\u5e76\u4e0d\u4f1a\u89e6\u53d1\u8d85\u65f6\uff0c\u5bf9\u5ef6\u8fdf\u7684\u6ce8\u4eba\u7531\u4ee5\u4e0b\u4e24\u9879\u6784\u6210\u3002 percent \uff1a\u662f\u4e00\u4e2a\u767e\u5206\u6bd4\uff0c\u7528\u4e8e\u6307\u5b9a\u6ce8\u4eba\u5ef6\u8fdf\u7684\u6bd4\u7387\uff0c\u5176\u9ed8\u8ba4\u503c\u4e3a 1000 \u3002 fixedDelay \uff1a\u8868\u660e\u5ef6\u8fdf\u7684\u65f6\u95f4\u957f\u5ea6\uff0c\u5fc5\u987b\u5927\u4e8e 1 \u6beb\u79d2\u3002 3\u3001 \u6ce8\u5165\u4e2d\u65ad \u53ef\u4ee5\u901a\u8fc7\u5411\u670d\u52a1\u8c03\u7528\u8fc7\u7a0b\u4e2d\u6ce8\u4eba\u4e2d\u65ad\u7684\u65b9\u5f0f\u6d4b\u8bd5\u670d\u52a1\u901a\u4fe1\u4e2d\u65ad\u7684\u7ed3\u679c\u3002\u4ecd\u7136\u4ee5 httpbin \u670d\u52a1\u4e3a\u4f8b\u6211\u4eec\u5c06\u6237\u7684\u670d\u62df\u670d\u52a1\u5b9a\u4e49\u4fee\u6539\u4e3a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - \"httpbin.default.svc.cluster.local\" http: - fault: abort: httpStatus: 500 percent: 100 match: - sourceLabels: version: v1 route: - destination: host: httpbin.default.svc.cluster.local - route: - destination: host: httpbin.default.svc.cluster.local $ kubectl apply -f httpbin-abort-virtualservice.yaml virtualservice.networking.istio.io/httpbin created $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http --body http://httpbin:8000/ip fault filter abort $ kubectl exec -it sleep-v2-7c6b874968-hl6dj -c sleep bash bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } \u540c\u6211\u4eec\u8bbe\u8ba1\u7684\u6267\u884c\u8fc7\u7a0b\u4e00\u81f4\uff1a \u6765\u81ea sleep \u670d\u52a1 v1 \u7248\u672c\u7684\u6d41\u91cf\uff0c\u4f1a\u88ab\u6ce8\u4eba\u4e00\u4e2a HTTP 500 \u9519\u8bef\uff1b\u6765\u81ea sleep \u670d\u52a1 v2 \u7248\u672c\u7684\u6d41\u91cf\uff0c\u5219\u4e0d\u4f1a\u53d7\u5230\u5f71\u54cd\u3002\u548c\u5ef6\u8fdf\u6ce8\u4eba\u4e00\u6837\uff0c\u4e2d\u65ad\u6ce8\u4eba\u4e5f\u53ef\u4ee5\u4f7f\u7528 percent \u5b57\u6bb5\u6765\u8bbe\u7f6e\u6ce8\u5165\u767e\u5206\u6bd4\u3002 4\u3001 \u6d41\u91cf\u590d\u5236 \u6d41\u91cf\u590d\u5236\u662f\u53e6\u4e00\u4e2a\u7528\u4e8e\u6d4b\u8bd5\u7684\u5f3a\u5927\u529f\u80fd\uff0c\u5b83\u53ef\u4ee5\u628a\u6307\u5411\u4e00\u4e2a\u670d\u52a1\u7248\u672c\u7684\u6d41\u91cf\u590d\u5236\u4e00\u4efd\u51fa\u6765\uff0c\u53d1\u9001\u7ed9\u53e6\u4e00\u4e2a\u670d\u52a1\u7248\u672c\u3002 \u8fd9\u4e00\u529f\u80fd\u80fd\u591f\u5c06\u751f\u4ea7\u6d41\u91cf\u5bfc\u4eba\u6d4b\u8bd5\u5e94\u7528, \u5728\u590d\u5236\u51fa\u6765\u7684\u955c\u50cf\u6d41\u91cf\u53d1\u51fa\u4e4b\u540e\u4e0d\u4f1a\u7b49\u5f85\u54cd\u5e94 \uff0c\u56e0\u6b64\u5bf9\u6b63\u5e38\u5e94\u7528\u7684\u6027\u80fd\u5f71\u54cd\u8f83\u5c0f\uff0c\u53c8\u80fd\u5728\u4e0d\u5f71\u54cd\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\u7528\u66f4\u5b9e\u9645\u7684\u6570\u636e\u5bf9\u5e94\u7528\u8fdb\u884c\u6d4b\u8bd5\u3002 \u8fd9\u91cc\u5c06\u4f7f\u7528 flaskapp \u670d\u52a1\u4f5c\u4e3a\u6d4b\u8bd5\u76ee\u6807.\u5c06\u8bbf\u95ee\u6d41\u91cf\u90fd\u53d1\u7ed9\u5176 v1 \u7248\u672c, \u540c\u65f6\u590d\u5236\u4e00\u4efd\u5230\u5176 v2 \u7248\u672c \u8be5\u5de5\u4f5c\u540c\u6837\u5728 VirtualService \u4e2d\u5b8c\u6210\uff0c\u7f16\u8f91 flaskapp \u7684 VirtualService \uff0c\u5c06\u5176\u8bbe\u7f6e\u4e3a\u5982\u4e0b\u5185\u5bb9\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - fiaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 mirror: \u2764\ufe0f host: flaskapp.default.svc.cluster.local subset: v2 $ kubectl apply -f flaskapp-copy-virtualservice.yaml virtualservice.networking.istio.io/flaskapp created Source pod sleep-v1 $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http --body http://flaskapp/env/version v1 Dest pod 1 flask-v1 $ kubectl logs flaskapp-v1-578d79dbcf-74ptj -c flaskapp | tail -1 [pid: 12|app: 0|req: 488/790] 10.1.0.122 () {50 vars in 1085 bytes} [Fri Nov 1 07:28:47 2019] GET /env/version => generated 2 bytes in 24 msecs (HTTP/1.1 200) 2 headers in 78 bytes (1 switches on core Dest pod 2 flask-v2 $ kubectl logs flaskapp-v2 -c flaskapp | tail -1 [pid: 13|app: 0|req: 873/1441] 10.1.0.122 () {50 vars in 1085 bytes} [Fri Nov 1 07:26:53 2019] GET /env/version => generated 2 bytes in 29 msec s (HTTP/1.1 200) 2 headers in 78 bytes (1 switches on core 0) \u5728\u4ece sleep Pod \u53d1\u51fa\u6d4b\u8bd5\u4e4b\u540e\uff0c\u53ef\u4ee5\u770b\u5230,\u6309\u7167\u9ed8\u8ba4\u8def\u7531\u8c03\u7528\u4e86 flaskapp \u670d\u52a1\u7684 v1 \u7248\u672c\uff0c\u8fd4\u56de\u4e86\u6b63\u5e38\u7684\u7ed3\u679c\uff1b \u4f7f\u7528 kubectl logs \u547d\u4ee4\u67e5\u770b flaskapp \u670d\u52a1\u4e24\u4e2a\u4e0d\u7684 Pod \uff0c\u4f1a\u53d1\u73b0\u5728\u5176 v2 \u7248\u672c\u7684 Pod \u4e2d, \u5728\u540c\u4e00\u65f6\u95f4\u5185\u4e5f\u4ea7\u751f\u4e86\u540c\u6837\u7684\u8c03\u7528\u8bb0\u5f55\u3002","title":"\u7b2c\u5341\u4e8c\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u670d\u52a1\u7194\u65ad/\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5/\u6ce8\u5165\u4e2d\u65ad/\u6d41\u91cf\u590d\u5236)"},{"location":"chap5/12Istio_http4/#https","text":"1 \u8bbe\u7f6e\u670d\u52a1\u7194\u65ad 2 \u6545\u969c\u6ce8\u5165\u6d4b\u8bd5 3 \u6ce8\u5165\u4e2d\u65ad 4 \u6d41\u91cf\u590d\u5236","title":"\u7b2c\u5341\u4e8c\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406\uff08\u670d\u52a1\u7194\u65ad/\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5/\u6ce8\u5165\u4e2d\u65ad/\u6d41\u91cf\u590d\u5236)"},{"location":"chap5/12Istio_http4/#1","text":"\u670d\u52a1\u7194\u65ad\u662f\u4e00\u79cd\u4fdd\u62a4\u6027\u63aa\u65bd\uff0c\u5373\u5728\u670d\u52a1\u5b9e\u4f8b\u65e0\u6cd5\u6b63\u5e38\u63d0\u4f9b\u670d\u52a1\u7684\u6e05\u51b5\u4e0b\u5c06\u5176\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u79fb\u9664\uff0c\u4e0d\u518d\u4e3a\u5176\u5206\u914d\u4efb\u52a1\uff0c\u907f\u514d\u5728\u6545\u969c\u5b9e\u4f8b\u4e0a\u79ef\u538b\u66f4\u591a\u7684\u4efb\u52a1\u5e76\u4e14\u53ef\u4ee5\u5728\u7b49\u5f85\u670d\u52a1\u80fd\u529b\u6062\u590d\u540e\uff0c\u91cd\u65b0\u5c06\u53d1\u751f\u6545\u969c\u7684 Pod \u52a0\u4eba\u8d1f\u8f7d\u5747\u8861\u6c60\u3002 \u8fd9\u4e5f\u662f\u4e00\u79cd\u5e38\u89c1\u7684\u670d\u52a1\u964d\u7ea7\u65b9\u6cd5\u3002 \u5728 Istio \u4e2d\u540c\u6837\u63d0\u4f9b\u4e86\u975e\u4fb5\u5165\u5f0f\u7684\u670d\u52a1\u7194\u65ad\u529f\u80fd\u3002 \u5bf9\u8fd9\u4e00\u529f\u80fd\u53ea\u9700\u8bbe\u7f6e DestinationRule \u5bf9\u8c61\u5373\u53ef\u5b8c\u6210\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u4e3a httpbin \u670d\u52a1\u8bbe\u7f6e\u4e00\u4e2a\u76ee\u6807\u89c4\u5219\uff1a httpbin-fuse-dr.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: httpbin spec: host: httpbin trafficPolicy: connectionPool: tcp: maxConnections: 1 http: http1MaxPendingRequests: 1 maxllequesisPerConnection: 1 outlierDetection: consecutiveErrors: 1 interval: 1s baseEjectionT1me: 1m maxejectiosPercent: 100 $ kubectl apply -f httpbin-fuse-dr.yaml destinationrule.networking.istio.io/httpbin created \u63a5\u4e0b\u6765\u4f7f\u7528 sleep Pod \u4e2d\u7684 wrk \u5de5\u5177\u6d4b\u8bd5\u7194\u65ad\u6548\u679c\uff1a $ kubectl exec sleep-6c9c898f6c-448v6 -it bash -c sleep bash-4.4# wrk -c 3 -t 3 http://httpbin:8000/ip Running 10s test @ http://httpbin:8000/ip 3 threads and 3 connections Thread Stats Avg Stdev Max +/- Stdev Latency 4.49ms 5.93ms 65.45ms 88.70% Req/Sec 338.84 298.81 1.20k 77.78% 10108 requests in 10.03s, 2.39MB read Non-2xx or 3xx responses: 6140 \u2764\ufe0f Requests/sec: 1007.53 Transfer/sec: 243.48KB \u53ef\u4ee5\u770b\u5230\uff0c\u975e\u6b63\u5e38\u7ed3\u679c\u5360\u4e86\u7edd\u5927\u591a\u6570\uff0c\u8868\u660e\u7194\u65ad\u5df2\u7ecf\u751f\u6548\u3002 \u63a5\u7740\u5220\u9664\u7194\u65ad\u8bbe\u7f6e\uff0c\u91cd\u65b0\u6d4b\u8bd5\uff1a $ kubectl delete dr httpbin destinationrule.networking.istio.io \"httpbin\" deleted $ kubectl exec sleep-6c9c898f6c-448v6 -it bash -c sleep bash-4.4# wrk -c 3 -t 3 http://httpbin:8000/ip Running 10s test @ http://httpbin:8000/ip 3 threads and 3 connections Thread Stats Avg Stdev Max +/- Stdev Latency 5.47ms 5.53ms 60.24ms 87.98% Req/Sec 229.36 71.43 440.00 69.70% 6861 requests in 10.04s, 1.68MB read Requests/sec: 683.52 Transfer/sec: 171.58KB \u5728\u5220\u6389\u7194\u65ad\u8bbe\u7f6e\u4e4b\u540e\uff0cwrk\u91cd\u65b0\u8fd0\u884c\uff0c\u6240\u6709\u8bf7\u6c42\u90fd\u4f1a\u5b8c\u6210\u3002 \u8fd9\u91cc\u4f7f\u7528\u7684\u7194\u65ad\u8bbe\u7f6e\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\uff0c\u6bd4\u8f83\u6781\u7aef\uff1a TCP \u548c HTTP \u8fde\u63a5\u6c60\u5927\u5c0f\u90fd\u88ab\u8bbe\u7f6e\u4e3a1; \u53ea\u5141\u8bb8\u51fa\u9519\u4e00\u6b21\uff1b \u6bcf\u79d2\u505a\u4e00\u6b21\u8bf7\u6c42\u8ba1\u6570\uff1b \u53ef\u4ee5\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u79fb\u9664 100\uff05 \u7684 Pod ; \u53d1\u751f\u6545\u969c\u7684 Pod \u6700\u5c11\u5728\u88ab\u79fb\u9664 3 \u5206\u949f\u540e\u624d\u80fd\u518d\u6b21\u52a0\u5165\u8d1f\u8f7d\u5747\u8861\u6c60\u3002 \u8fd9\u91cc\u7528 wrk \u5de5\u5177\u76f4\u63a5\u4f7f\u7528\u8d85\u51fa\u7194\u65ad\u6807\u51c6\u7684\u5e76\u884c\u6570\u91cf\u6765\u8bbf\u95ee httpbin \u670d\u52a1\uff0c\u5728\u5f15\u53d1\u7194\u65ad\u540e\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u5f02\u5e38\u54cd\u5e94\uff1b\u5728\u5220\u9664\u76ee\u6807\u89c4\u5219\u540e\uff0c\u7194\u65ad\u89c4\u5219\u4e0d\u590d\u5b58\u5728\uff0c\u518d\u6b21\u7528\u540c\u6837\u7684\u53c2\u6570\u8fd0\u884cwrk\uff0c\u5c31\u4f1a\u6062\u590d\u6b63\u5e38\u7684\u8bbf\u95ee\u80fd\u529b\u4e86\u3002","title":"1\u3001\u8bbe\u7f6e\u670d\u52a1\u7194\u65ad"},{"location":"chap5/12Istio_http4/#2","text":"\u5728\u5fae\u670d\u52a1\u7684\u6d4b\u8bd5\u8fc7\u7a0b\u4e2d\uff0c\u5f80\u5f80\u9700\u8981\u5bf9\u7f51\u7edc\u6545\u969c\u7684\u573a\u666f\u8fdb\u884c\u6a21\u62df\uff0c Istio \u4e5f\u5728\u8fd9\u65b9\u9762\u63d0\u4f9b\u4e86\u4e24\u79cd\u6545\u969c\u6ce8\u5165\u7684\u80fd\u529b\uff1a \u5ef6\u8fdf \u548c \u4e2d\u65ad \u3002 \u501f\u52a9 Istio \u7684\u6545\u969c\u6ce8\u4eba\u80fd\u529b\uff0c\u6d4b\u8bd5\u4eba\u5458\u53ef\u4ee5\u4f7f\u7528 VirtualService \u914d\u7f6e\u65b9\u5f0f\uff0c\u5728\u4efb\u610f\u8c03\u7528\u4e2d\u52a0\u5165\u6a21\u62df\u6545\u969c\uff0c\u4ece\u800c\u6d4b\u8bd5\u5e94\u7528\u5728\u6545\u969c\u72b6\u6001\u4e0b\u7684\u54cd\u5e94\u60c5\u51b5\uff0c\u751a\u81f3\u53ef\u4ee5\u5728\u8bf7\u6c42\u4e2d\u6ce8\u5165\u4e2d\u65ad\uff0c\u6765\u963b\u6b62\u67d0\u4e9b\u60c5\u51b5\u4e0b\u7684\u670d\u52a1\u8bbf\u95ee \u3002","title":"2\u3001\u6545\u969c\u6ce8\u5165\u6d4b\u8bd5"},{"location":"chap5/12Istio_http4/#2-1","text":"\u9996\u5148\uff0c\u7f16\u8f91 httpbin \u7684 VirtualService \uff0c\u4e3a\u670d\u52a1\u52a0\u4eba\u4e00\u4e2a 3 \u79d2\u7684\u5ef6\u8fdf\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - \"httpbin.default.svc.cluster.local\" http: - route: - destination: host: httpbin.default.svc.cluster.local fault: delay: fixedDelay: 3s percent: 100 $ kubectl apply -f http-lag-virtualservice.yaml virtualservice.networking.istio.io/httpbin configure bash-4.4# http --body http://httpbin:8000/delay/1 ... real 0m 4.321s \u5b9e\u9645\u5ef6\u8fdf\u4e86 3 \u79d2\uff0c\u4e5f\u5c31\u662f\u8bf4\u6ce8\u4eba\u7684\u5ef6\u8fdf\u751f\u6548\u4e86\u3002 \u8fd9\u5f88\u81ea\u7136\u5c31\u8ba9\u4eba\u8054\u60f3\u5230\u524d\u9762\u63d0\u5230\u7684\u8d85\u65f6\u63a7\u5236\u3002 \u8fd9\u91cc\u4e3a httpbin \u670d\u52a1\u8bbe\u7f6e\u4e00\u4e2a\u4e24\u79d2\u7684\u8d85\u65f6\u9650\u5236\uff0c\u4e5f\u5c31\u662f\u5728\u8def\u7531\u89c4\u5219\u4e2d\u52a0\u5165 timeout: 2s\" ,\u518d\u6b21\u8fdb\u884c\u6d4b\u8bd5\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin.default.svc.cluster.local http: - route: - destination: host: httpbin.default.svc.cluster.local timeout: 2s fault: delay: fixedDelay: 3s percent: 100 bash-4.4# time http --body http://httpbin:8000/ip ... real 0m 3.331s ... http --body http://httpbin:8000/delay/2 real 0m 5.45s \u7ed3\u679c\u4e00\u76ee\u4e86\u7136\uff0c\u6211\u4eec\u5728\u8bf7\u6c42\u4e2d\u6ce8\u5165\u7684\u5ef6\u65f6\u5e76\u4e0d\u4f1a\u89e6\u53d1\u8d85\u65f6\uff0c\u5bf9\u5ef6\u8fdf\u7684\u6ce8\u4eba\u7531\u4ee5\u4e0b\u4e24\u9879\u6784\u6210\u3002 percent \uff1a\u662f\u4e00\u4e2a\u767e\u5206\u6bd4\uff0c\u7528\u4e8e\u6307\u5b9a\u6ce8\u4eba\u5ef6\u8fdf\u7684\u6bd4\u7387\uff0c\u5176\u9ed8\u8ba4\u503c\u4e3a 1000 \u3002 fixedDelay \uff1a\u8868\u660e\u5ef6\u8fdf\u7684\u65f6\u95f4\u957f\u5ea6\uff0c\u5fc5\u987b\u5927\u4e8e 1 \u6beb\u79d2\u3002","title":"2-1 \u6ce8\u5165\u5ef6\u8fdf"},{"location":"chap5/12Istio_http4/#3","text":"\u53ef\u4ee5\u901a\u8fc7\u5411\u670d\u52a1\u8c03\u7528\u8fc7\u7a0b\u4e2d\u6ce8\u4eba\u4e2d\u65ad\u7684\u65b9\u5f0f\u6d4b\u8bd5\u670d\u52a1\u901a\u4fe1\u4e2d\u65ad\u7684\u7ed3\u679c\u3002\u4ecd\u7136\u4ee5 httpbin \u670d\u52a1\u4e3a\u4f8b\u6211\u4eec\u5c06\u6237\u7684\u670d\u62df\u670d\u52a1\u5b9a\u4e49\u4fee\u6539\u4e3a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: httpbin spec: hosts: - \"httpbin.default.svc.cluster.local\" http: - fault: abort: httpStatus: 500 percent: 100 match: - sourceLabels: version: v1 route: - destination: host: httpbin.default.svc.cluster.local - route: - destination: host: httpbin.default.svc.cluster.local $ kubectl apply -f httpbin-abort-virtualservice.yaml virtualservice.networking.istio.io/httpbin created $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http --body http://httpbin:8000/ip fault filter abort $ kubectl exec -it sleep-v2-7c6b874968-hl6dj -c sleep bash bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } \u540c\u6211\u4eec\u8bbe\u8ba1\u7684\u6267\u884c\u8fc7\u7a0b\u4e00\u81f4\uff1a \u6765\u81ea sleep \u670d\u52a1 v1 \u7248\u672c\u7684\u6d41\u91cf\uff0c\u4f1a\u88ab\u6ce8\u4eba\u4e00\u4e2a HTTP 500 \u9519\u8bef\uff1b\u6765\u81ea sleep \u670d\u52a1 v2 \u7248\u672c\u7684\u6d41\u91cf\uff0c\u5219\u4e0d\u4f1a\u53d7\u5230\u5f71\u54cd\u3002\u548c\u5ef6\u8fdf\u6ce8\u4eba\u4e00\u6837\uff0c\u4e2d\u65ad\u6ce8\u4eba\u4e5f\u53ef\u4ee5\u4f7f\u7528 percent \u5b57\u6bb5\u6765\u8bbe\u7f6e\u6ce8\u5165\u767e\u5206\u6bd4\u3002","title":"3\u3001 \u6ce8\u5165\u4e2d\u65ad"},{"location":"chap5/12Istio_http4/#4","text":"\u6d41\u91cf\u590d\u5236\u662f\u53e6\u4e00\u4e2a\u7528\u4e8e\u6d4b\u8bd5\u7684\u5f3a\u5927\u529f\u80fd\uff0c\u5b83\u53ef\u4ee5\u628a\u6307\u5411\u4e00\u4e2a\u670d\u52a1\u7248\u672c\u7684\u6d41\u91cf\u590d\u5236\u4e00\u4efd\u51fa\u6765\uff0c\u53d1\u9001\u7ed9\u53e6\u4e00\u4e2a\u670d\u52a1\u7248\u672c\u3002 \u8fd9\u4e00\u529f\u80fd\u80fd\u591f\u5c06\u751f\u4ea7\u6d41\u91cf\u5bfc\u4eba\u6d4b\u8bd5\u5e94\u7528, \u5728\u590d\u5236\u51fa\u6765\u7684\u955c\u50cf\u6d41\u91cf\u53d1\u51fa\u4e4b\u540e\u4e0d\u4f1a\u7b49\u5f85\u54cd\u5e94 \uff0c\u56e0\u6b64\u5bf9\u6b63\u5e38\u5e94\u7528\u7684\u6027\u80fd\u5f71\u54cd\u8f83\u5c0f\uff0c\u53c8\u80fd\u5728\u4e0d\u5f71\u54cd\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\u7528\u66f4\u5b9e\u9645\u7684\u6570\u636e\u5bf9\u5e94\u7528\u8fdb\u884c\u6d4b\u8bd5\u3002 \u8fd9\u91cc\u5c06\u4f7f\u7528 flaskapp \u670d\u52a1\u4f5c\u4e3a\u6d4b\u8bd5\u76ee\u6807.\u5c06\u8bbf\u95ee\u6d41\u91cf\u90fd\u53d1\u7ed9\u5176 v1 \u7248\u672c, \u540c\u65f6\u590d\u5236\u4e00\u4efd\u5230\u5176 v2 \u7248\u672c \u8be5\u5de5\u4f5c\u540c\u6837\u5728 VirtualService \u4e2d\u5b8c\u6210\uff0c\u7f16\u8f91 flaskapp \u7684 VirtualService \uff0c\u5c06\u5176\u8bbe\u7f6e\u4e3a\u5982\u4e0b\u5185\u5bb9\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - fiaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 mirror: \u2764\ufe0f host: flaskapp.default.svc.cluster.local subset: v2 $ kubectl apply -f flaskapp-copy-virtualservice.yaml virtualservice.networking.istio.io/flaskapp created Source pod sleep-v1 $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# http --body http://flaskapp/env/version v1 Dest pod 1 flask-v1 $ kubectl logs flaskapp-v1-578d79dbcf-74ptj -c flaskapp | tail -1 [pid: 12|app: 0|req: 488/790] 10.1.0.122 () {50 vars in 1085 bytes} [Fri Nov 1 07:28:47 2019] GET /env/version => generated 2 bytes in 24 msecs (HTTP/1.1 200) 2 headers in 78 bytes (1 switches on core Dest pod 2 flask-v2 $ kubectl logs flaskapp-v2 -c flaskapp | tail -1 [pid: 13|app: 0|req: 873/1441] 10.1.0.122 () {50 vars in 1085 bytes} [Fri Nov 1 07:26:53 2019] GET /env/version => generated 2 bytes in 29 msec s (HTTP/1.1 200) 2 headers in 78 bytes (1 switches on core 0) \u5728\u4ece sleep Pod \u53d1\u51fa\u6d4b\u8bd5\u4e4b\u540e\uff0c\u53ef\u4ee5\u770b\u5230,\u6309\u7167\u9ed8\u8ba4\u8def\u7531\u8c03\u7528\u4e86 flaskapp \u670d\u52a1\u7684 v1 \u7248\u672c\uff0c\u8fd4\u56de\u4e86\u6b63\u5e38\u7684\u7ed3\u679c\uff1b \u4f7f\u7528 kubectl logs \u547d\u4ee4\u67e5\u770b flaskapp \u670d\u52a1\u4e24\u4e2a\u4e0d\u7684 Pod \uff0c\u4f1a\u53d1\u73b0\u5728\u5176 v2 \u7248\u672c\u7684 Pod \u4e2d, \u5728\u540c\u4e00\u65f6\u95f4\u5185\u4e5f\u4ea7\u751f\u4e86\u540c\u6837\u7684\u8c03\u7528\u8bb0\u5f55\u3002","title":"4\u3001 \u6d41\u91cf\u590d\u5236"},{"location":"chap5/13Istio_Mixer1/","text":"\u7b2c\u5341\u4e09\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(\u7b80\u4ecb/Denier\u8bbf\u95ee\u63a7\u5236/Listchecker\u8bbf\u95ee\u63a7\u5236) Istio \u9664\u4e86\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u6d41\u91cf\u63a7\u5236\u529f\u80fd\uff0c \u8fd8\u901a\u8fc7 Mixer \uff1a\u63d0\u4f9b\u4e86\u53ef\u6269\u5c55\u7684\u5916\u63a5\u529f\u80fd\u3002 Mixer \u201c\u77e5\u6653\u201d\u6bcf\u4e00\u6b21\u670d\u52a1\u95f4\u7684\u8c03\u7528\u8fc7\u7a0b\uff0c\u8fd9\u4e9b\u8c03\u7528\u8fc7\u7a0b\u4f1a\u4e3a Mixer \uff1a\u63d0\u4f9b\u4e30\u5bcc\u7684\u76f8\u5173\u4fe1\u606f\uff0c Mixer \u901a\u8fc7\u63a5\u4eba\u7684\u9002\u914d\u5668\u5bf9\u8fd9\u4e9b\u4fe1\u606f\u8fdb\u884c\u5904\u7406\uff0c\u80fd\u591f\u5728\u8c03\u7528\u7684\u9884\u68c0\uff08\u6267\u884c\u524d)\u548c\u62a5\u544a\uff08\u6267\u884c\u540e\uff09\u9636\u6bb5\u6267\u884c\u591a\u79cd\u4efb\u52a1 \u5e76\u4e14 Mixer \u7684\u9002\u914d\u5668\u6a21\u578b\u662f\u53ef\u4ee5\u6269\u5145\u7684\uff0c\u8fd9\u4e5f\u8d4b\u4e88\u4e86 Mixer \u66f4\u5927\u7684\u6269\u5c55\u80fd\u529b\u3002 1\u3001Mixer\u9002\u914d\u5668\u7b80\u4ecb Mixer\uff1a\u4e2d\u73b0\u6709\u7684\u9002\u914d\u5668\u5927\u81f4\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u4e24\u7c7b\u3002 \u4e00\u7c7b\u662f Istio \u5185\u90e8\u5b9e\u73b0\u7684\u9002\u914d\u5668\uff0c\u7528\u4e8e\u5b8c\u6210\u7f51\u683c\u7684\u5185\u90e8\u529f\u80fd \uff0c\u4f8b\u5982 Fluentd \u3001 Stdio \u3001 RedisQuota \u7b49\u3002 \u53e6\u4e00\u7c7b\u662f\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u9002\u914d\u5668\uff0c\u7528\u4e8e\u548c\u5916\u90e8\u7cfb\u7edf\u8fdb\u884c\u5bf9\u63a5 \uff0c\u4f8b\u5982 DataDog \u3001 StackDriver \u7b49\u3002 \u672c\u7ae0\u540c\u6837\u4ece\u5e94\u7528\u573a\u666f\u51fa\u53d1\uff0c\u4ecb\u7ecd\u5728 Istio \u4e2d\u4f7f\u7528 Mixer \uff1a\u80fd\u591f\u5b8c\u6210\u7684\u5404\u79cd\u4efb\u52a1\uff0c\u53ea\u6d89\u53ca\u7f51\u683c\u5185\u90e8\u529f\u80fd\u76f8\u5173\u7684\u9002\u914d\u5668\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 Denier \uff1a\u6839\u636e\u81ea\u5b9a\u4e49\u6761\u4ef6\u5224\u65ad\u662f\u5426\u62d2\u7edd\u670d\u52a1 \u3002 Fluentd : \u5411 Fluentd \u670d\u52a1\u63d0\u4ea4\u65e5\u5fd7\u3002 List \uff1a\u7528\u4e8e\u6267\u884c\u767d\u540d\u5355\u6216\u8005\u9ed1\u540d\u5355\u68c0\u67e5\u3002 MemQuota \uff1a\u4ee5\u5185\u5b58\u4e3a\u5b58\u50a8\u540e\u7aef\uff0c\u63d0\u4f9b\u7b80\u6613\u7684\u914d\u989d\u63a7\u5236\u529f\u80fd\u3002 Prometheus \uff1a\u4e3a Prometheus \u63d0\u4f9b Istio \u7684\u76d1\u63a7\u6307\u6807\u3002 RedisQuota \uff1a\u57fa\u4e8e Redis \u5b58\u50a8\u540e\u7aef\uff0c\u63d0\u4f9b\u914d\u989d\u7ba1\u7406\u529f\u80fd\u3002 StatsD \uff1a\u5411 StatsD \u53d1\u9001\u76d1\u63a7\u6307\u6807\u3002 Stdio \uff1a\u7528\u4e8e\u5728\u672c\u5730\u8f93\u51fa\u65e5\u5fd7\u548c\u6307\u6807\u3002 Mixer \uff1a\u7684\u914d\u7f6e\u901a\u5e38\u7531\u4ee5\u4e0b\u4e09\u90e8\u5206\u7ec4\u6210 \u3002 Handler : \u58f0\u660e\u4e00\u4e2a\u9002\u914d\u5668\u7684\u914d\u7f6e Instance : \u58f0\u660e\u4e00\u4e2a\u6a21\u677f\uff0c\u7528\u6a21\u677f\u5c06\u4f20\u7ed9 Mixer \u7684\u6570\u636e\u8f6c\u6362\u4e3a\u7279\u5b9a\u9002\u914d\u5668\u7684\u8f93\u51fa\u683c\u5f0f Rule : \u5c06 Instance \u548c Hanlder \u8fde\u63a5\u8d77\u6765\uff0c \u786e\u8ba4\u5904\u7406\u5173\u7cfb 2\u3001 \u57fa\u4e8e Denier \u9002\u914d\u5668\u7684\u8bbf\u95ee\u63a7\u5236 \u672c\u8282\u4f1a \u5229\u7528 Denier \u9002\u914d\u5668\u4e3a httpbin \u670d\u52a1\u521b\u5efa\u4e00\u4e2a Rule \u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u4f1a\u963b\u6b62\u6765\u81ea sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u7684\u8bf7\u6c42\u3002 \u8981\u4f7f\u7528 Denier \u9002\u914d\u5668, \u5219\u9996\u5148\u8981\u5b9a\u4e49\u5b83\u7684\u4e2a Handler \uff0c\u6bcf\u4e2a\u9002\u914d\u5668\u90fd\u4f1a\u81ea\u5df1\u7684\u914d\u7f6e\u683c\u5f0f\uff0c\u53ef\u524d\u5f80\u5b98\u65b9\u7f51\u7ad9 \uff08 https://istio.io/docs/reference/config/policy-and-telemetry/adapters/ \uff09\u8fdb\u884c\u67e5\u8be2\u3002 \u672c\u8282\u4e3a Denier \uff1a\u9002\u914d\u5668\u5b9a\u4e49\u7684 Handler \u7ed3\u6784\u5f88\u7b80\u5355\uff0c\u4ec5\u5305\u542b\u4e00\u4e2a\u9519\u8bef\u7801\u548c\u6d88\u606f\uff1a apiVersion: \"config.istio.io/v1alpha2\" kind: denier metadata: name: code-7 spec: status: code: 7 message: Not allowed \u8fd9\u6bb5\u4ee3\u7801\u610f\u5473\u7740\uff1a \u5982\u679c\u6709\u6d41\u91cf\u7684\u9884\u68c0\u8bf7\u6c42\u901a\u8fc7 Rule \u5bf9\u8c61\u4f20\u9012\u7ed9\u4e86\u8fd9\u4e2a Handler \u5c31\u4f1a\u8c03\u7528\u5931\u8d25\uff0c\u8fd4\u56de\u9519\u8bef\u7801 7 \u53ca\u9519\u8bef\u4fe1\u6025 Not allowed \u3002 \u5c06\u5176\u4fdd\u5b58\u4e3a denier.yaml \u7136\u540e\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4 $ kubectl apply -f denier.yaml denier.config.istio.io/code-7 created \u6211\u4eec\u73b0\u5728\u53ea\u60f3\u7981\u6b62\u4e00\u4e2a sleep \u670d\u52a1\u7684 v1 \u7248\u672c\uff0e\u4ec5\u901a\u8fc7 Rule \u5bf9\u8c61\u7684 match \u5b57\u6bb5\u5339\u914d\u5373\u53ef\u56e0\u6b64\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a checknonting \u7684\u6821\u677f\u6765\u5b9a\u4e49\u8f93\u5165\uff0e\u5c31\u662f\u8bf4\u65e0\u987b\u5bf9\u8fdb\u5165\u7684\u6570\u636e\u8fdb\u884c\u68c0\u67e5 apiVersion: \"config.istio.io/v1alpha2\" kind: checknothing metadata: name: place-holder spec: checknothing \u7684\u6a21\u677f\u56e0\u4e3a\u6ca1\u505a\u4efb\u4f55\u5904\u7406\uff0e\u6240\u4ee5\u4e5f\u662f\u76f8\u5f53\u7b80\u5355\u7684\u5c06\u5176\u6df1\u5b58\u4e3a checknothing.yaml \u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4 $ kubectl apply -f checknonthing.yaml --validate=false checknothing.config.istio.io/place-holder created \u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a Rule \u5bf9\u8c61\u628a\u4e8c\u8005\u8fde\u63a5\u8d77\u6765\u7f16\u8f91 denier.rule.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: rule metadata: name: deny-sleep-v1-to-httpbin spec: match: destination.labels[\"app\"] == \"httpbin\" && source.labels[\"app\"] == \"sleep\" && source.labels[\"version\"] == \"v1\" actions: - handler: code-7.denier instances: place-holder.checknothing \u6ce8\u610f\uff0c\u5728 instance \u548c handler \u4e24\u4e2a\u5b87\u6bb5\u4e2d\u5f15\u7528\u5bf9\u8c61\u7684\u65b9\u5f0f\u4e3a\u4e00 \u540d\u79f0.\u7c7b\u578b handler: code-7.denier instances: [place-holder.checknothing] \u5728 match \u5b57\u6bb5\u4e2d\u4f7f\u7528\u6e90\u548c\u76ee\u6807\u7684\u6807\u7b7e\u65f6\u670d\u8fdb\u884c\u9274\u522b\u3001\u6574\u4e2a\u8868\u8fbe\u5f0f\u5b9e\u73b0\u4e86\u5bf9\u6765\u81ea Sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u5411 httpbin \u670d\u52a1\u53d1\u8d77\u8c03\u7528\u7684\u6d41\u91cf\u7684\u8bc6\u522b $ kubectl apply -f denier.rule.yaml rule.config.istio.io/deny-sleep-v1-to-httpbin created $ kubectl exec -it sleep-v1-548d87cc5c-92lqk -c sleep bash bash-4.4# http --body http://httpbin:8000/ip PERMISSION DENIED:code\u4e007.denier.defau1t:Not allowed $ kubectl exec -it sleep-v2-7c6b874968-dx6ll -c sleep bash bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } \u6d4b\u8bd5\u7ed3\u679c\u8868\u660e\uff0c\u4ece sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u5411 httpbin \u670d\u52a1\u53d1\u8d77i\u8bf7\u6c42\uff0c\u4f1a\u5931\u8d25\u4e14\u8fd4\u56de \"PERMISSION DENIED:code\u4e007.denier.defau1t:Not allowed\" , \u4ece sleep \u670d\u52a1\u7684 v2 \u7248\u672c\u5411 httpbin \u670d\u52a1\u53d1\u8d77\u8bf7\u6c42\uff0c\u5c31\u4f1a\u6b63\u5e38\u8fd4\u56de\u7ed3\u679c\u3002 \u4e3a\u4e86\u540e\u7eed\u5185\u5bb9\u7684\u7ee7\u7eed\u8fdb\u884c\uff0c\u5220\u9664\u521a\u521a\u521b\u5efa\u7684\u4e09\u4e2a\u5bf9\u8c61\uff1a $ kubectl delete -f denier.rule.yaml -f checknonthing.yaml -f denier.yaml rule.config.istio.io \"deny-sleep-v1-to-httpbin\" deleted checknothing.config.istio.io \"place-holder\" deleted denier.config.istio.io \"code-7\" deleted 3\u3001 \u57fa\u4e8e Listchecker \u9002\u914d\u5668\u7684\u8bbf\u95ee\u63a7\u5236 \u4e0a\u9762\u63d0\u4f9b\u7684 Denier \u9002\u914d\u5668\u7684\u8bbf\u95ee\u63a7\u5236\u662f\u6bd4\u8f83\u6b7b\u677f\u7684\uff0c\u8868\u8fbe\u5f0f\u4fee\u6539\u4e5f\u7a0d\u663e\u70e6\u7410\uff0c\u5982\u679c\u60f3\u4f7f\u7528\u66f4\u7075\u6d3b\u7684\u63a7\u5236\u65b9\u5f0f\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 Listchecker \u9002\u914d\u5668\u3002 \u5728 Listechecker \u9002\u914d\u5668\u4e2d\u4f1a\u4fdd\u5b58\u4e00\u4e2a\u5217\u8868\uff0c\u5e76\u53ef\u4ee5\u58f0\u660e\u8fd9\u4e00\u5217\u8868\u662f\u9ed1\u540d\u5355\u8fd8\u662f\u767d\u540d\u5355\uff0c\u5728\u6709\u6570\u636e\u8f93\u5165\u540e\uff0c\u9996\u5148\u5224\u65ad\u8be5\u6570\u636e\u662f\u5426\u5c5e\u4e8e\u5217\u8868\u6210\u5458\uff0c\u7136\u540e\u6839\u636e\u5217\u8868\u7684\u9ed1\u540d\u5355\u6216\u767d\u540d\u5355\u5c5e\u6027\u6765\u8fd4\u56de\u662f\u5426\u8bb8\u53ef\u6b64\u6b21\u8c03\u7528\u3002 \u7136\u540e\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u7cfb\u5217\u5bf9\u8c61\u6765\u9a8c\u8bc1\u8fd9\u4e00\u5217\u8868\u662f\u5426\u6b63\u786e\u4e86\u3002\u4e3a Listchecker \u9002\u914d\u5668\u521b\u5efa\u4e00\u4e2a Handler \u5bf9\u8c61\uff0c\u5176\u4e2d\u7684\u6570\u636e\u5b9a\u4e49\u6765\u81ea\u8868\u7684\u7b2c 1 \u884c\uff1a apiVersion: config.istio.io/v1alpha2 kind: listchecker metadata: name: chaos spec: overrides: [\"v1\", \"v3\"] blacklist: true $ kubectl apply -f chaos-listchcker.yaml listchecker.config.istio.io/chaos created \u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86 overrides \u5b57\u6bb5\u4fdd\u5b58\u4e00\u4e2a\u5217\u8868\u7528\u4e8e\u68c0\u67e5\u5e76\u5728 blacklist \u5b57\u6bb5\u58f0\u660e\u8fd9\u4e00\u5217\u8868\u4e3a\u9ed1\u540d\u5355\u3002 Listchecker \u9002\u914d\u5668\u8fd8\u53ef\u4ee5\u4f7f\u7528 providerUrl \u5b57\u6bb5\u5f15\u7528\u4e00\u4e2a\u8fdc\u7a0b\u5217\u8868\u5e76\u5b9a\u65f6\u66f4\u65b0\uff0c\u4ee5\u83b7\u5f97\u66f4\u5927\u7684\u7075\u8bdd\u6027 \u63a5\u4e0b\u6765\u4f7f\u7528 listentry \u6a21\u677f\u4ece\u8f93\u5165\u6570\u636e\u4e2d\u63d0\u53d6\u5185\u5bb9\u5e76\u8f93\u51fa\u7ed9 Listchecker \u9002\u914d\u5668\u3002\u5c06\u4e0b\u9762\u4ee3\u7801\u4fdd\u5b58\u4e3a version.listentry.yaml apiVersion: config.istio.io/v1alpha2 kind: listentry metadata: name: version spec: value: source.labels[\"version\"] listentry \u53ea\u6709 value \u4e00\u4e2a\u5b57\u6bb5\u5728\u5176\u4e2d\u7528\u8868\u8fbe\u5f0f\u4ece\u8f93\u5165\u6570\u636e\u4e2d\u63d0\u53d6\u5185\u5bb9\u8fdb\u884c\u540e\u7eed\u8f93\u51fa $ kubectl apply -f version.listentry.yaml listentry.config.istio.io/version created \u6700\u540e\u521b\u5efa Rule \u5bf9\u8c61\u5c06 Instance \u548c Handler \u8fde\u63a5\u5728\u4e00\u8d77\u8fd9\u4e3a httpbin \u7684\u6d41\u5740\u8fdb\u884c\u6d4b\u8bd5\uff1a apiVersion: config.istio.io/v1alpha2 kind: rule metadata: name: checkversion spec: match: destination.labels[\"app\"] == \"httpbin\" actions: - handler: chaos.listchecker instances: - version.listentry listentry.rule.yaml $ kubectl apply -f listentry.rule.yaml rule.config.istio.io/checkversion created \u73b0\u5728 Handler \u3001 Instance , \u53ca Rule \u4e09\u4e2a\u5bf9\u8c61\u90fd\u5df2\u7ecf\u521b\u5efa\u5b8c\u6bd5\u4e86\uff0e\u6211\u4eec\u53ef\u4ee5\u8fdb\u884c\u6d4b\u8bd5\u4e86\uff1a $ kubectl exec -it sleep-v1-548d87cc5c-92lqk -c sleep bash bash-4.4# http --body http://httpbin:8000/ip PERMISSION DENIED:chaos.Iistchecker.default:v1 is blacklisted $ kubectl exec -it sleep-v2-7c6b874968-dx6ll -c sleep bash bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } \u53ef\u4ee5\u770b\u5230\uff0c\u5728\u4f7f\u7528 sleep Pod \u7684 v1 \u7248\u672c\u8bbf\u95f4 httpbin \u670d\u52a1\u65f6\uff0c\u8bbf\u95ee\u88ab\u62d2\u7edd\uff0c\u51fa\u73b0\u9519\u8bef\u4fe1\u606f \"PERMISSION DENIED:chaos.Iistchecker.default:v1 is blacklisted \uff1b \u800c\u4ece sleep \u670d\u52a1\u7684 v2 \u7248\u672c\u8fdb\u884c\u8bbf\u95ee\u65f6\u5c31\u53ef\u4ee5\u6210\u529f\u8fd4\u56de\u5411\u5e94\u7684\u5185\u5bb9\u8981\u9a8c\u8bc1\u767d\u540d\u5355\u4e5f\u5f88\u7b80\u5355\u3001\u53ea\u8981\u628a chaos.listchecker.yaml \u4e2d\u7684 blacklist: true \u6539\u6210 blacklist: false .\u7136\u540e\u91cd\u65b0\u63d0\u4ea4\u5373\u53ef\u3002 \u518d\u6b21\u6267\u884c\u6d4b\u8bd5\uff1a apiVersion: config.istio.io/v1alpha2 kind: listchecker metadata: name: chaos spec: overrides: [\"v1\", \"v3\"] blacklist: false $ kubectl apply -f chaos-listchcker.yaml listchecker.config.istio.io/chaos configured $ kubectl exec -it sleep-v1-548d87cc5c-92lqk -c sleep bash bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } $ kubectl exec -it sleep-v2-7c6b874968-dx6ll -c sleep bash bash-4.4# http --body http://httpbin:8000/ip NOT FOUND:chaoslistchecker.default:v2 is not whitelisted \u5728 Listchecker \u9002\u914d\u5668\u66f4\u65b0\u4e4b\u540e\u8fdb\u884c\u65b0\u4e00\u8f6e\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u770b\u5230\u6d4b\u8bd5\u7ed3\u679c\u53d1\u751f\u4e86\u53d8\u5316\uff0c \u4e0e\u4e2d\u7684 3:4 \u884c\u4e00\u81f4 sleep\u670d\u52a1\u7684 v2 \u7248\u672c\u5411httpbin\u53d1\u51fa\u7684\u8bbf\u95ee\u88ab\u62d2\u7edd\uff0c\u8fd4\u56de\u4fe1\u606f\u4e3a NOT FOUND:chaoslistchecker.default:v2 is not whitelisted","title":"\u7b2c\u5341\u4e09\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(\u7b80\u4ecb/Denier\u8bbf\u95ee\u63a7\u5236/Listchecker\u8bbf\u95ee\u63a7\u5236)"},{"location":"chap5/13Istio_Mixer1/#mixer-denierlistchecker","text":"Istio \u9664\u4e86\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u6d41\u91cf\u63a7\u5236\u529f\u80fd\uff0c \u8fd8\u901a\u8fc7 Mixer \uff1a\u63d0\u4f9b\u4e86\u53ef\u6269\u5c55\u7684\u5916\u63a5\u529f\u80fd\u3002 Mixer \u201c\u77e5\u6653\u201d\u6bcf\u4e00\u6b21\u670d\u52a1\u95f4\u7684\u8c03\u7528\u8fc7\u7a0b\uff0c\u8fd9\u4e9b\u8c03\u7528\u8fc7\u7a0b\u4f1a\u4e3a Mixer \uff1a\u63d0\u4f9b\u4e30\u5bcc\u7684\u76f8\u5173\u4fe1\u606f\uff0c Mixer \u901a\u8fc7\u63a5\u4eba\u7684\u9002\u914d\u5668\u5bf9\u8fd9\u4e9b\u4fe1\u606f\u8fdb\u884c\u5904\u7406\uff0c\u80fd\u591f\u5728\u8c03\u7528\u7684\u9884\u68c0\uff08\u6267\u884c\u524d)\u548c\u62a5\u544a\uff08\u6267\u884c\u540e\uff09\u9636\u6bb5\u6267\u884c\u591a\u79cd\u4efb\u52a1 \u5e76\u4e14 Mixer \u7684\u9002\u914d\u5668\u6a21\u578b\u662f\u53ef\u4ee5\u6269\u5145\u7684\uff0c\u8fd9\u4e5f\u8d4b\u4e88\u4e86 Mixer \u66f4\u5927\u7684\u6269\u5c55\u80fd\u529b\u3002","title":"\u7b2c\u5341\u4e09\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(\u7b80\u4ecb/Denier\u8bbf\u95ee\u63a7\u5236/Listchecker\u8bbf\u95ee\u63a7\u5236)"},{"location":"chap5/13Istio_Mixer1/#1mixer","text":"Mixer\uff1a\u4e2d\u73b0\u6709\u7684\u9002\u914d\u5668\u5927\u81f4\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u4e24\u7c7b\u3002 \u4e00\u7c7b\u662f Istio \u5185\u90e8\u5b9e\u73b0\u7684\u9002\u914d\u5668\uff0c\u7528\u4e8e\u5b8c\u6210\u7f51\u683c\u7684\u5185\u90e8\u529f\u80fd \uff0c\u4f8b\u5982 Fluentd \u3001 Stdio \u3001 RedisQuota \u7b49\u3002 \u53e6\u4e00\u7c7b\u662f\u7b2c\u4e09\u65b9\u670d\u52a1\u7684\u9002\u914d\u5668\uff0c\u7528\u4e8e\u548c\u5916\u90e8\u7cfb\u7edf\u8fdb\u884c\u5bf9\u63a5 \uff0c\u4f8b\u5982 DataDog \u3001 StackDriver \u7b49\u3002 \u672c\u7ae0\u540c\u6837\u4ece\u5e94\u7528\u573a\u666f\u51fa\u53d1\uff0c\u4ecb\u7ecd\u5728 Istio \u4e2d\u4f7f\u7528 Mixer \uff1a\u80fd\u591f\u5b8c\u6210\u7684\u5404\u79cd\u4efb\u52a1\uff0c\u53ea\u6d89\u53ca\u7f51\u683c\u5185\u90e8\u529f\u80fd\u76f8\u5173\u7684\u9002\u914d\u5668\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 Denier \uff1a\u6839\u636e\u81ea\u5b9a\u4e49\u6761\u4ef6\u5224\u65ad\u662f\u5426\u62d2\u7edd\u670d\u52a1 \u3002 Fluentd : \u5411 Fluentd \u670d\u52a1\u63d0\u4ea4\u65e5\u5fd7\u3002 List \uff1a\u7528\u4e8e\u6267\u884c\u767d\u540d\u5355\u6216\u8005\u9ed1\u540d\u5355\u68c0\u67e5\u3002 MemQuota \uff1a\u4ee5\u5185\u5b58\u4e3a\u5b58\u50a8\u540e\u7aef\uff0c\u63d0\u4f9b\u7b80\u6613\u7684\u914d\u989d\u63a7\u5236\u529f\u80fd\u3002 Prometheus \uff1a\u4e3a Prometheus \u63d0\u4f9b Istio \u7684\u76d1\u63a7\u6307\u6807\u3002 RedisQuota \uff1a\u57fa\u4e8e Redis \u5b58\u50a8\u540e\u7aef\uff0c\u63d0\u4f9b\u914d\u989d\u7ba1\u7406\u529f\u80fd\u3002 StatsD \uff1a\u5411 StatsD \u53d1\u9001\u76d1\u63a7\u6307\u6807\u3002 Stdio \uff1a\u7528\u4e8e\u5728\u672c\u5730\u8f93\u51fa\u65e5\u5fd7\u548c\u6307\u6807\u3002 Mixer \uff1a\u7684\u914d\u7f6e\u901a\u5e38\u7531\u4ee5\u4e0b\u4e09\u90e8\u5206\u7ec4\u6210 \u3002 Handler : \u58f0\u660e\u4e00\u4e2a\u9002\u914d\u5668\u7684\u914d\u7f6e Instance : \u58f0\u660e\u4e00\u4e2a\u6a21\u677f\uff0c\u7528\u6a21\u677f\u5c06\u4f20\u7ed9 Mixer \u7684\u6570\u636e\u8f6c\u6362\u4e3a\u7279\u5b9a\u9002\u914d\u5668\u7684\u8f93\u51fa\u683c\u5f0f Rule : \u5c06 Instance \u548c Hanlder \u8fde\u63a5\u8d77\u6765\uff0c \u786e\u8ba4\u5904\u7406\u5173\u7cfb","title":"1\u3001Mixer\u9002\u914d\u5668\u7b80\u4ecb"},{"location":"chap5/13Istio_Mixer1/#2-denier","text":"\u672c\u8282\u4f1a \u5229\u7528 Denier \u9002\u914d\u5668\u4e3a httpbin \u670d\u52a1\u521b\u5efa\u4e00\u4e2a Rule \u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u4f1a\u963b\u6b62\u6765\u81ea sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u7684\u8bf7\u6c42\u3002 \u8981\u4f7f\u7528 Denier \u9002\u914d\u5668, \u5219\u9996\u5148\u8981\u5b9a\u4e49\u5b83\u7684\u4e2a Handler \uff0c\u6bcf\u4e2a\u9002\u914d\u5668\u90fd\u4f1a\u81ea\u5df1\u7684\u914d\u7f6e\u683c\u5f0f\uff0c\u53ef\u524d\u5f80\u5b98\u65b9\u7f51\u7ad9 \uff08 https://istio.io/docs/reference/config/policy-and-telemetry/adapters/ \uff09\u8fdb\u884c\u67e5\u8be2\u3002 \u672c\u8282\u4e3a Denier \uff1a\u9002\u914d\u5668\u5b9a\u4e49\u7684 Handler \u7ed3\u6784\u5f88\u7b80\u5355\uff0c\u4ec5\u5305\u542b\u4e00\u4e2a\u9519\u8bef\u7801\u548c\u6d88\u606f\uff1a apiVersion: \"config.istio.io/v1alpha2\" kind: denier metadata: name: code-7 spec: status: code: 7 message: Not allowed \u8fd9\u6bb5\u4ee3\u7801\u610f\u5473\u7740\uff1a \u5982\u679c\u6709\u6d41\u91cf\u7684\u9884\u68c0\u8bf7\u6c42\u901a\u8fc7 Rule \u5bf9\u8c61\u4f20\u9012\u7ed9\u4e86\u8fd9\u4e2a Handler \u5c31\u4f1a\u8c03\u7528\u5931\u8d25\uff0c\u8fd4\u56de\u9519\u8bef\u7801 7 \u53ca\u9519\u8bef\u4fe1\u6025 Not allowed \u3002 \u5c06\u5176\u4fdd\u5b58\u4e3a denier.yaml \u7136\u540e\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4 $ kubectl apply -f denier.yaml denier.config.istio.io/code-7 created \u6211\u4eec\u73b0\u5728\u53ea\u60f3\u7981\u6b62\u4e00\u4e2a sleep \u670d\u52a1\u7684 v1 \u7248\u672c\uff0e\u4ec5\u901a\u8fc7 Rule \u5bf9\u8c61\u7684 match \u5b57\u6bb5\u5339\u914d\u5373\u53ef\u56e0\u6b64\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a checknonting \u7684\u6821\u677f\u6765\u5b9a\u4e49\u8f93\u5165\uff0e\u5c31\u662f\u8bf4\u65e0\u987b\u5bf9\u8fdb\u5165\u7684\u6570\u636e\u8fdb\u884c\u68c0\u67e5 apiVersion: \"config.istio.io/v1alpha2\" kind: checknothing metadata: name: place-holder spec: checknothing \u7684\u6a21\u677f\u56e0\u4e3a\u6ca1\u505a\u4efb\u4f55\u5904\u7406\uff0e\u6240\u4ee5\u4e5f\u662f\u76f8\u5f53\u7b80\u5355\u7684\u5c06\u5176\u6df1\u5b58\u4e3a checknothing.yaml \u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4 $ kubectl apply -f checknonthing.yaml --validate=false checknothing.config.istio.io/place-holder created \u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a Rule \u5bf9\u8c61\u628a\u4e8c\u8005\u8fde\u63a5\u8d77\u6765\u7f16\u8f91 denier.rule.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: rule metadata: name: deny-sleep-v1-to-httpbin spec: match: destination.labels[\"app\"] == \"httpbin\" && source.labels[\"app\"] == \"sleep\" && source.labels[\"version\"] == \"v1\" actions: - handler: code-7.denier instances: place-holder.checknothing \u6ce8\u610f\uff0c\u5728 instance \u548c handler \u4e24\u4e2a\u5b87\u6bb5\u4e2d\u5f15\u7528\u5bf9\u8c61\u7684\u65b9\u5f0f\u4e3a\u4e00 \u540d\u79f0.\u7c7b\u578b handler: code-7.denier instances: [place-holder.checknothing] \u5728 match \u5b57\u6bb5\u4e2d\u4f7f\u7528\u6e90\u548c\u76ee\u6807\u7684\u6807\u7b7e\u65f6\u670d\u8fdb\u884c\u9274\u522b\u3001\u6574\u4e2a\u8868\u8fbe\u5f0f\u5b9e\u73b0\u4e86\u5bf9\u6765\u81ea Sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u5411 httpbin \u670d\u52a1\u53d1\u8d77\u8c03\u7528\u7684\u6d41\u91cf\u7684\u8bc6\u522b $ kubectl apply -f denier.rule.yaml rule.config.istio.io/deny-sleep-v1-to-httpbin created $ kubectl exec -it sleep-v1-548d87cc5c-92lqk -c sleep bash bash-4.4# http --body http://httpbin:8000/ip PERMISSION DENIED:code\u4e007.denier.defau1t:Not allowed $ kubectl exec -it sleep-v2-7c6b874968-dx6ll -c sleep bash bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } \u6d4b\u8bd5\u7ed3\u679c\u8868\u660e\uff0c\u4ece sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u5411 httpbin \u670d\u52a1\u53d1\u8d77i\u8bf7\u6c42\uff0c\u4f1a\u5931\u8d25\u4e14\u8fd4\u56de \"PERMISSION DENIED:code\u4e007.denier.defau1t:Not allowed\" , \u4ece sleep \u670d\u52a1\u7684 v2 \u7248\u672c\u5411 httpbin \u670d\u52a1\u53d1\u8d77\u8bf7\u6c42\uff0c\u5c31\u4f1a\u6b63\u5e38\u8fd4\u56de\u7ed3\u679c\u3002 \u4e3a\u4e86\u540e\u7eed\u5185\u5bb9\u7684\u7ee7\u7eed\u8fdb\u884c\uff0c\u5220\u9664\u521a\u521a\u521b\u5efa\u7684\u4e09\u4e2a\u5bf9\u8c61\uff1a $ kubectl delete -f denier.rule.yaml -f checknonthing.yaml -f denier.yaml rule.config.istio.io \"deny-sleep-v1-to-httpbin\" deleted checknothing.config.istio.io \"place-holder\" deleted denier.config.istio.io \"code-7\" deleted","title":"2\u3001 \u57fa\u4e8eDenier\u9002\u914d\u5668\u7684\u8bbf\u95ee\u63a7\u5236"},{"location":"chap5/13Istio_Mixer1/#3-listchecker","text":"\u4e0a\u9762\u63d0\u4f9b\u7684 Denier \u9002\u914d\u5668\u7684\u8bbf\u95ee\u63a7\u5236\u662f\u6bd4\u8f83\u6b7b\u677f\u7684\uff0c\u8868\u8fbe\u5f0f\u4fee\u6539\u4e5f\u7a0d\u663e\u70e6\u7410\uff0c\u5982\u679c\u60f3\u4f7f\u7528\u66f4\u7075\u6d3b\u7684\u63a7\u5236\u65b9\u5f0f\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 Listchecker \u9002\u914d\u5668\u3002 \u5728 Listechecker \u9002\u914d\u5668\u4e2d\u4f1a\u4fdd\u5b58\u4e00\u4e2a\u5217\u8868\uff0c\u5e76\u53ef\u4ee5\u58f0\u660e\u8fd9\u4e00\u5217\u8868\u662f\u9ed1\u540d\u5355\u8fd8\u662f\u767d\u540d\u5355\uff0c\u5728\u6709\u6570\u636e\u8f93\u5165\u540e\uff0c\u9996\u5148\u5224\u65ad\u8be5\u6570\u636e\u662f\u5426\u5c5e\u4e8e\u5217\u8868\u6210\u5458\uff0c\u7136\u540e\u6839\u636e\u5217\u8868\u7684\u9ed1\u540d\u5355\u6216\u767d\u540d\u5355\u5c5e\u6027\u6765\u8fd4\u56de\u662f\u5426\u8bb8\u53ef\u6b64\u6b21\u8c03\u7528\u3002 \u7136\u540e\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u7cfb\u5217\u5bf9\u8c61\u6765\u9a8c\u8bc1\u8fd9\u4e00\u5217\u8868\u662f\u5426\u6b63\u786e\u4e86\u3002\u4e3a Listchecker \u9002\u914d\u5668\u521b\u5efa\u4e00\u4e2a Handler \u5bf9\u8c61\uff0c\u5176\u4e2d\u7684\u6570\u636e\u5b9a\u4e49\u6765\u81ea\u8868\u7684\u7b2c 1 \u884c\uff1a apiVersion: config.istio.io/v1alpha2 kind: listchecker metadata: name: chaos spec: overrides: [\"v1\", \"v3\"] blacklist: true $ kubectl apply -f chaos-listchcker.yaml listchecker.config.istio.io/chaos created \u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86 overrides \u5b57\u6bb5\u4fdd\u5b58\u4e00\u4e2a\u5217\u8868\u7528\u4e8e\u68c0\u67e5\u5e76\u5728 blacklist \u5b57\u6bb5\u58f0\u660e\u8fd9\u4e00\u5217\u8868\u4e3a\u9ed1\u540d\u5355\u3002 Listchecker \u9002\u914d\u5668\u8fd8\u53ef\u4ee5\u4f7f\u7528 providerUrl \u5b57\u6bb5\u5f15\u7528\u4e00\u4e2a\u8fdc\u7a0b\u5217\u8868\u5e76\u5b9a\u65f6\u66f4\u65b0\uff0c\u4ee5\u83b7\u5f97\u66f4\u5927\u7684\u7075\u8bdd\u6027 \u63a5\u4e0b\u6765\u4f7f\u7528 listentry \u6a21\u677f\u4ece\u8f93\u5165\u6570\u636e\u4e2d\u63d0\u53d6\u5185\u5bb9\u5e76\u8f93\u51fa\u7ed9 Listchecker \u9002\u914d\u5668\u3002\u5c06\u4e0b\u9762\u4ee3\u7801\u4fdd\u5b58\u4e3a version.listentry.yaml apiVersion: config.istio.io/v1alpha2 kind: listentry metadata: name: version spec: value: source.labels[\"version\"] listentry \u53ea\u6709 value \u4e00\u4e2a\u5b57\u6bb5\u5728\u5176\u4e2d\u7528\u8868\u8fbe\u5f0f\u4ece\u8f93\u5165\u6570\u636e\u4e2d\u63d0\u53d6\u5185\u5bb9\u8fdb\u884c\u540e\u7eed\u8f93\u51fa $ kubectl apply -f version.listentry.yaml listentry.config.istio.io/version created \u6700\u540e\u521b\u5efa Rule \u5bf9\u8c61\u5c06 Instance \u548c Handler \u8fde\u63a5\u5728\u4e00\u8d77\u8fd9\u4e3a httpbin \u7684\u6d41\u5740\u8fdb\u884c\u6d4b\u8bd5\uff1a apiVersion: config.istio.io/v1alpha2 kind: rule metadata: name: checkversion spec: match: destination.labels[\"app\"] == \"httpbin\" actions: - handler: chaos.listchecker instances: - version.listentry listentry.rule.yaml $ kubectl apply -f listentry.rule.yaml rule.config.istio.io/checkversion created \u73b0\u5728 Handler \u3001 Instance , \u53ca Rule \u4e09\u4e2a\u5bf9\u8c61\u90fd\u5df2\u7ecf\u521b\u5efa\u5b8c\u6bd5\u4e86\uff0e\u6211\u4eec\u53ef\u4ee5\u8fdb\u884c\u6d4b\u8bd5\u4e86\uff1a $ kubectl exec -it sleep-v1-548d87cc5c-92lqk -c sleep bash bash-4.4# http --body http://httpbin:8000/ip PERMISSION DENIED:chaos.Iistchecker.default:v1 is blacklisted $ kubectl exec -it sleep-v2-7c6b874968-dx6ll -c sleep bash bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } \u53ef\u4ee5\u770b\u5230\uff0c\u5728\u4f7f\u7528 sleep Pod \u7684 v1 \u7248\u672c\u8bbf\u95f4 httpbin \u670d\u52a1\u65f6\uff0c\u8bbf\u95ee\u88ab\u62d2\u7edd\uff0c\u51fa\u73b0\u9519\u8bef\u4fe1\u606f \"PERMISSION DENIED:chaos.Iistchecker.default:v1 is blacklisted \uff1b \u800c\u4ece sleep \u670d\u52a1\u7684 v2 \u7248\u672c\u8fdb\u884c\u8bbf\u95ee\u65f6\u5c31\u53ef\u4ee5\u6210\u529f\u8fd4\u56de\u5411\u5e94\u7684\u5185\u5bb9\u8981\u9a8c\u8bc1\u767d\u540d\u5355\u4e5f\u5f88\u7b80\u5355\u3001\u53ea\u8981\u628a chaos.listchecker.yaml \u4e2d\u7684 blacklist: true \u6539\u6210 blacklist: false .\u7136\u540e\u91cd\u65b0\u63d0\u4ea4\u5373\u53ef\u3002 \u518d\u6b21\u6267\u884c\u6d4b\u8bd5\uff1a apiVersion: config.istio.io/v1alpha2 kind: listchecker metadata: name: chaos spec: overrides: [\"v1\", \"v3\"] blacklist: false $ kubectl apply -f chaos-listchcker.yaml listchecker.config.istio.io/chaos configured $ kubectl exec -it sleep-v1-548d87cc5c-92lqk -c sleep bash bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } $ kubectl exec -it sleep-v2-7c6b874968-dx6ll -c sleep bash bash-4.4# http --body http://httpbin:8000/ip NOT FOUND:chaoslistchecker.default:v2 is not whitelisted \u5728 Listchecker \u9002\u914d\u5668\u66f4\u65b0\u4e4b\u540e\u8fdb\u884c\u65b0\u4e00\u8f6e\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u770b\u5230\u6d4b\u8bd5\u7ed3\u679c\u53d1\u751f\u4e86\u53d8\u5316\uff0c \u4e0e\u4e2d\u7684 3:4 \u884c\u4e00\u81f4 sleep\u670d\u52a1\u7684 v2 \u7248\u672c\u5411httpbin\u53d1\u51fa\u7684\u8bbf\u95ee\u88ab\u62d2\u7edd\uff0c\u8fd4\u56de\u4fe1\u606f\u4e3a NOT FOUND:chaoslistchecker.default:v2 is not whitelisted","title":"3\u3001 \u57fa\u4e8eListchecker\u9002\u914d\u5668\u7684\u8bbf\u95ee\u63a7\u5236"},{"location":"chap5/14Istio_Mixer2/","text":"\u7b2c\u5341\u56db\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(MemQuota\u670d\u52a1\u9650\u6d41/Mixer\u5bf9\u8c61\u7684\u5b9a\u4e49/RedisQuota\u670d\u52a1\u9650\u6d41) 1\u3001\u4f7f\u7528 MemQuota \u9002\u914d\u5668\u8fdb\u884c\u670d\u52a1\u9650\u6d41 \u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u95f4\u8c03\u7528\uff0c \u56e0\u4e3a\u5b58\u5728\u4e1a\u52a1\u4f18\u5148\u7ea7\u3001\u8d44\u6e90\u5206\u914d\u53ca\u670d\u52a1\u8d1f\u8f7d\u80fd\u529b\u7b49\u8981\u6c42 \uff0c\u6240\u4ee5\u5e38\u5e38\u9700\u8981\u5bf9\u7279\u5b9a\u7684\u670d\u52a1\u8c03\u7528\u8fdb\u884c\u9650\u5236\uff0c\u9632\u6b62\u670d\u52a1\u8fc7\u8f7d\u3002 \u5728 Istio \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528 Mixer \u7684 MemQuota \u6216 RedisQuota \u9002\u914d\u5668\uff0c\u5728\u9884\u68c0\u6bb5\u5bf9\u6d41\u91cf\u8fdb\u884c\u914d\u989d\u5224\u65ad\uff0c \u6839\u636e\u4e3a\u7279\u5b9a\u6d41\u91cf\u8bbe\u5b9a\u7684\u989d\u5ea6\u89c4\u5219\u6765\u5224\u65ad\u6d41\u91cf\u8bf7\u6c42\u662f\u5426\u5df2\u7ecf\u8d85\u8fc7\u6307\u5b9a\u7684\u989d\u5ea6\uff08\u7b80\u79f0\u8d85\u989d\uff09\uff0c\u5982\u679c\u53d1\u751f\u8d85\u989d\uff0c\u5c31\u8fdb\u884c\u9650\u6d41\u5904\u7406 \u3002 \u5728 Istio \u7684\u9650\u6d41\u529f\u80fd\u5b9e\u73b0\u4e2d\uff0c\u914d\u7f6e\u5de5\u4f5c\u5206\u4e3a \u5ba2\u6237\u7aef \u548c Mixer \u7aef\u4e24\u90e8\u5206\uff1a \u5ba2\u6237\u7aef\u4f7f\u7528 QuotaSpec \u5b9a\u4e49\u4e00\u4e2a\u9650\u989d\uff0c\u7528 QuotaSpecBinding \u5bf9\u8c61\u5c06 QuotaSpec \u7ed1\u5b9a\u5230\u7279\u5b9a\u7684\u670d\u52a1\u4e0a\uff1b Mixer \uff1a\u7aef\u9700\u8981\u5904\u7406\u9650\u989d\u7684\u5b9e\u73b0\u903b\u8f91\uff0c\u7528\u4e00\u4e2a quota \u5b9e\u4f8b\u5b9a\u4e49\u6d41\u91cf\u5904\u7406\u89c4\u5219,\u7528 MemQuota/RedisQuota \u7684 Handler \u6765\u5b9e\u9645\u5904\u7406\u6d41\u91cf\uff0c\u6700\u540e\u4f7f\u7528 Rule \u5bf9\u8c61\u5c06\u4e8c\u8005\u8fdb\u884c\u7ed1\u5b9a\uff1a \u672c\u8282\u4f9d\u7136\u4f1a\u4f7f\u7528 sleep \u670d\u52a1\u4f5c\u4e3a\u5ba2\u6237\u7aef\uff0c\u5e76\u4f7f\u7528 httpbin \u4f5c\u4e3a\u670d\u52a1\u7aef\u3002 1-1 Mixer \u5bf9\u8c61\u7684\u5b9a\u4e49 \u5728\u9650\u6d41\u8fc7\u7a0b\u4e2d\u7528\u5230\u7684\u670d\u52a1\u7aef\u5bf9\u8c61\u5e76\u65e0\u7279\u522b\uff0c\u548c\u6240\u6709\u7684 Mixer \u9002\u914d\u5668\u5e94\u7528\u4e00\u6837\uff0c \u7531 Handler , Instance \u7ed3\u5408 Rule \uff0c\u8fd9\u4e8c\u79cd\u5bf9\u8c61\u4e00\u8d77\u5b9a\u4e49\u8fd9\u4e00\u884c\u4e3a\u3002 \u9996\u5148\u5b9a\u4e49\u4e00\u4e2a MemQuota \u7c7b\u578b\u7684 Handler \uff0c\u901a\u8fc7\u5b83\u6765\u5b9a\u4e49 MemQuota \u9002\u914d\u5668\u7684\u884c\u4e3a \u8fd9\u91cc\u9996\u5148\u5b9a\u4e49\u4e86\u9ed8\u8ba4\u7684\u9650\u6d41\u89c4\u5b9a\uff0c\u6bcf\u79d2\u6700\u591a\u8c03\u7528 20 \u6b21\uff0c\u7136\u540e\u901a\u8fc7 overrides \u7684\u65b9\u5f0f\u4e3a httpbin \u670d\u52a1\u5b9a\u4e49\u4e00\u4e2a\u9650\u6d41\uff0c\u6bcf 5 \u79d2\u53ea\u80fd\u8c03\u7528\u4e00\u6b21\uff1a memquota-handler.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: memquota metadata: name: handler spec: quotas: - name: dent-quota.quota.default maxAmount: 20 validDuration: 10s overrides: - dimensions: destination: httpbin maxAmount: 1 validDuration : 5s $ kubectl apply -f memquota-handler.yaml memquota.config.istio.io/handler created \u628a\u4e0a\u8ff0\u6587\u4ef6\u547d\u540d\u4e3a memquota-handler.yaml \uff0c\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6bcf 10 \u79d2\u8c03\u7528 20 \u6b21\u7684\u9ed8\u8ba4\u8c03\u7528\u914d\u989d\uff0c\u53c8\u4e3a httpbin \u670d\u52a1\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7279\u4f8b: \u6bcf 5 \u79d2\u53ea\u5141\u8bb8\u8c03\u7528\u4e00\u6b21\u3002 \u63a5\u4e0b\u6765\u9700\u8981\u5b9a\u4e49\u7684\u662f\u57fa\u4e8e Quota \u6a21\u677f\u7684 Instance \u5bf9\u8c61\uff1a quota-instance.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: quota metadata: name: dest-quota spec: dimensions: destination: destination.labels[\"app\"] | destination.service | \"unknown\" $ kubectl apply -f quota-instance.yaml quota.config.istio.io/dest-quota created \u628a\u4ee3\u7801\u4fdd\u5b58\u4e3a quota-instance.yaml \uff0c\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u91cc\u4e3a quota \u6a21\u677f\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8f93\u5165\u9879 demensions \uff0c\u5176\u4e2d\u5305\u542b\u5bf9\u670d\u52a1\u76ee\u6807\u7684\u5b9a\u4e49\u3002 \u5bf9 destination \u5b57\u6bb5\u7684\u5b9a\u4e49\u662f\u4e00\u4e2a\u5c5e\u6027\u8868\u8fbe\u5f0f\uff0c\u5176\u53d6\u503c\u903b\u8f91\u662f\uff1a \u9996\u5148\u5224\u65ad\u6d41\u91cf\u76ee\u6807\u662f\u5426\u5177\u6709 app \u6807\u7b7e\uff0c \u5982\u679c\u6ca1\u6709\uff0c\u5219\u83b7\u53d6\u76ee\u6807\u670d\u52a1\u7684\u540d\u79f0\uff0c\u5426\u5219\u53d6\u503c\u4e3a \u201cunknown\" \u3002 \u63a5\u4e0b\u6765\u4f7f\u7528\u4e00\u4e2a Rule \u5bf9\u8c61\u5c06\u4e24\u8005\u5173\u8054\u8d77\u6765 \uff1a quota-rule.yaml apiVersion: config.istio.io/v1alpha2 kind: rule metadata: name: quota spec: actions: - handler: handler.memquota instances: - dest-quota.quota $ kubectl apply -f quota-rule.yaml rule.config.istio.io/quota created \u540c\u6837\uff0c\u5c06\u4ee3\u7801\u4fdd\u5b58\u4e3a\uff1a quota-rule.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u5bf9 Mixer \u7aef\u4e09\u4e2a\u5bf9\u8c61\u7684\u5b9a\u4e49\uff0c\u4e09\u4e2a\u5bf9\u8c61\u8054\u5408\u8d77\u6765\u5b8c\u6210\u4efb\u52a1\uff1a Rule \u5bf9\u8c61\u8d1f\u8d23\u8bc6\u522b\u6d41\u91cf\uff0c\u5bf9\u7b26\u5408\u6761\u4ef6\u5e76\u8fdb\u5165\u8be5 Rule \u5bf9\u8c61\u5904\u7406\u6d41\u7a0b\u7684\u6d41\u91cf \uff0c \u4f7f\u7528 dest-quota \u8fdb\u884c\u5904\u7406\uff0c\u5c06\u5904\u7406\u7ed3\u679c\u8f93\u51fa\u7ed9 MemQuota \u9002\u914d\u5668\u7684 Handler \u5bf9\u8c61\u8fdb\u884c\u5224\u65ad 1-2 \u5ba2\u6237\u7aef\u5bf9\u8c61\u5b9a\u4e49 Mixer \u7aef\u5df2\u7ecf\u5b9a\u4e49\u4e86 \u914d\u989d\u65b9\u5f0f \u548c \u5904\u7406\u65b9\u5f0f \uff0c\u800c\u5ba2\u6237\u7aef\u7684\u914d\u7f6e\u9700\u8981\u5b9a\u4e49\u4e24\u4e2a\u5185\u5bb9\uff1a \u53d7\u9650\u7684\u5e94\u7528\u548c\u914d\u989d\u7684\u6263\u51cf\u65b9\u5f0f\uff0c\u9700\u8981\u7528 QuotaSpec \u548c QuotaSpecBinding \u5bf9\u8c61\u6765\u5b8c\u6210 \uff1a \u521b\u5efa\u4e00\u4e2a QuotaSpec \u5bf9\u8c61\uff1a quotaspec.yaml apiVersion: config.istio.io/v1alpha2 kind: QuotaSpec metadata: name: request-count spec: rules: - quotas: - charge: 5 quota: dest-quota $ kubectl apply -f quotaspec.yaml quotaspec.config.istio.io/request-count created \u628a\u4e0a\u8ff0\u4ee3\u7801\u4fdd\u5b58\u4e3a quotaspec.yaml \uff0c\u4f7f\u7528 kubectl apply \u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a quota \u6263\u51cf\u65b9\u5f0f\uff0c\u5176\u4e2d\u7684 quota \u5bf9\u5e94\u7684\u662f\u521b\u5efa\u7684 dest-quota \u7136\u540e\u5b9a\u4e49 QuotaSpecBindng \u5bf9\u8c61\uff0c\u628a QuotaSpec \u7ed1\u5b9a\u5230\u670d\u52a1\u4e0a\uff1a quotaspec-binding.yaml apiVersion: config.istio.io/v1alpha2 kind: QuotaSpecBinding metadata: name: spec-sleep spec: quotaSpecs: - name: request-count namespace: default services: - name: httpbin namespace: default $ kubectl apply -f quotaspec-binding.yaml quotaspecbinding.config.istio.io/spec-sleep created 1-3 \u6d4b\u8bd5\u9650\u6d41\u529f\u80fd \u5728\u76f8\u5173\u7684 5 \u4e2a\u5bf9\u8c61\u90fd\u521b\u5efa\u6210\u529f\u540e\uff0c\u5c31\u53ef\u4ee5\u8fdb\u884c\u6d4b\u8bd5\u4e86\uff1a $ kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# for i in 'seq 10';do http --body http://httpbin:8000/ip; done { \"origin\": \"127.0.0.1\" } RESOURCE EXHAUSTED:Quota is exhausted for: dest-quota \u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u8fde\u7eed\u8c03\u7528\u4e86 httpbin \u670d\u52a1\uff0c\u5e76\u8fd4\u56de\u4e86\u8d85\u989d\u9519\u8bef\u3002 \u4e0b\u9762\u5c1d\u8bd5\u8c03\u7528 flaskapp \u670d\u52a1\uff1a bash-4.4# for i in 'seq 10'; do http --body http://flaskapp/env/version; done v2 \u53d1\u73b0 flaskapp \u5e76\u672a\u53d7\u5230\u5f71\u54cd 1-4 \u6ce8\u610f\u4e8b\u9879 \u901a\u8fc7\u4e0a\u9762\u7684\u5c1d\u8bd5\u80af\u5b9a\u6709\u4e0d\u5c11\u8bfb\u8005\u4f1a\u60f3\uff1a\u8fd9\u592a\u590d\u6742\u4e86\u800c\u4e14\u5bf9\u8c61\u4e4b\u95f4\u7684\u5f15\u7528\u592a\u6df7\u4e71 \u540c\u65f6\u3001\u5bf9\u670d\u52a1\u8eab\u4efd\u7684\u7ed1\u5b9a\u5173\u7cfb\u4e5f\u6563\u4e71\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u5bf9\u8c61\u4e2d\u3002 \u751a\u81f3\u5230\u76ee\u524d\u4e3a\u6b62 QuotaSpec \u548c QcotaSpecBinding \u8fd8\u6ca1\u6709\u63d0\u4f9b Reference \u7b14\u8005\u63a8\u6d4b\u8fd9\u90e8\u5206\u53d1\u751f\u53d8\u5316\u7684 \u53ef\u80fd\u6027\u975e\u5e38\u5927, \u5f3a\u70c8\u5efa\u8bae\u4e0d\u8981\u91c7\u7528 2\u3001 \u4f7f\u7528 RedisQuota \u9002\u914d\u5668\u8fdb\u884c\u670d\u52a1\u9650\u6d41 MemQuota \u9002\u914d\u5668\u9650\u6d41\uff0c\u662f\u4e00\u79cd\u5b9e\u9a8c\u6027\u8d28\u7684\u505a\u6cd5\uff0c\u5b83\u4ec5\u652f\u6301\u56fa\u5b9a\u7a97\u53e3\u7684\u9650\u6d41\u7b97\u6cd5\uff0c \u5e76\u4e14\u5728 Mixer \u662f\u591a\u526f\u672c\u7684\u8fd0\u884c\u72b6\u6001\u4e0b\u5185\u5b58\u8ba1\u6570\u4f1a\u5b8c\u5168\u5931\u6548, \u5fc5\u987b\u63d0\u4f9b\u4e00\u4e2a\u72ec\u7acb\u4e8e Mixer \u8fdb\u7a0b\u4e4b\u5916\u7684\u540e\u7aef\u670d\u52a1\u6765\u63d0\u4f9b\u6570\u636e\u652f\u6301, \u76ee\u524d\u5b98\u65b9\u5efa\u8bae\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528 RedisQuota \u5bf9\u8c61\u8fdb\u884c\u9650\u6d41. \u5176\u6574\u4f53\u73af\u8282\u548c MemQuota \u6d41\u7684\u6d41\u7a0b\u662f\u4e00\u81f4, \u7684\u53ea\u4e0d\u8fc7\u5176\u4e2d\u7684 MemQuota Handler \u8981\u66f4\u6362\u4e3a Redis \u7248\u672c\u8fd8\u9700\u8981\u4e00\u4e2a\u7528\u4e8e\u63d0\u4f9b\u6570\u636e\u540e\u7aef\u7684 Redis \u5e94\u7528\u3002 2-1 \u542f\u52a8 Redis \u670d\u52a1 \u9996\u5148\u6211\u4eec\u505a\u4e00\u4e0b\u51c6\u5907\u5de5\u4f5c\u542f\u7528\u4e00\u4e2a Redis \u670d\u52a1\u5668\u6765\u652f\u6301\u9650\u6d41\u64cd\u4f5c\uff0c\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u5148\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u542f\u52a8\u4e00\u4e2a\u5355\u5b9e\u4f8b\u670d\u52a1\u6765\u5b8c\u6210\u529f\u80fd\u5c55\u793a\u3002 \u8fd9\u91cc\u9009\u62e9\u4f7f\u7528 Redis \u7684\u5b98\u65b9\u955c\u50cf, \u521b\u5efa\u4e00\u4e2a\u5355\u5b9e\u4f8b\u7684 Deployment \u548c\u5bf9\u5e94\u7684 Service : apiVersion: v1 kind: ReplicationController metadata: name: redis labels: name: redis spec: replicas: 1 selector: name: redis template: metadata: labels: name: redis spec: containers: - name: redis image: k8s.gcr.io/redis:v1 ports: - containerPort: 6379 --- apiVersion: v1 kind: Service metadata: name: redis labels: name: redis spec: ports: - port: 6379 targetPort: 6379 selector: name: redis \u5c06\u4e0a\u8ff0\u6587\u4ef6\u4fdd\u5b58\u4e3a redis.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4 RC \u5728\u542f\u52a8\u4e4b\u540e\uff0c\u4f1a\u5728 6379 \u7aef\u53e3\u5f00\u653e\u4e00\u4e2a Redis \u670d\u52a1\u3002 2-2 \u5b9a\u4e49\u9650\u6d41\u76f8\u5173\u5bf9\u8c61 \u4e24\u79cd\u9650\u6d41\u65b9\u5f0f\u7684\u5bf9\u8c61\u5b9a\u4e49\u683c\u5f0f\u57fa\u672c\u662f\u4e00\u81f4\u7684\uff0c\u533a\u522b\u4ec5\u5728\u4e8e RedisQuota \u7684\u5b9a\u4e49\u8981\u6bd4 MemQuota \u7684\u5b9a\u4e49\u7ec6\u81f4\u4e00\u4e9b\u3002 \u8fd9\u91cc\u9996\u5148\u5b9a\u4e49 RedisQuota : redisquota.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: redisquota metadata: name: handler spec: redisServerUrl: \"10.245.90.154:6379\" quotas: - name: dest-quota.quota.default maxAmount: 20 bucketDuration: 1s validDuration: 10s rateLimitAlgorithm: ROLLING_WINDOW overrides: - dimensions: destination: httpbin maxAmount: 1 $ kubectl apply -f redisquota.yaml redisquota.config.istio.io/handler created \u5c06\u4e0a\u8ff0\u4ee3\u7801\u4fdd\u5b58\u4e3a redisquota.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230\u96c6\u7fa4\u3002 redisServerUrl \uff1a\u7528\u4e8e\u6307\u5b9a Redis \u670d\u52a1\u7684\u5730\u5740\u3002 quota.bucketDuratio n\uff1a\u5fc5\u987b\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5927\u4e8e\u96f6\u7684\u79d2\u6570\u3002 quota.rateLimitAlgorithm \uff1a\u53ef\u4ee5\u4e3a\u6bcf\u4e2a Quota \u6307\u5b9a\u5404\u81ea\u7684\u9650\u6d41\u7b97\u6cd5\uff0c\u5728 MemQuota \u4e2d\u91c7\u7528\u7684\u662f FIXED_ WINDOW\u7b97 \u6cd5\uff0c\u4e14\u4e0d\u53ef\u66f4\u6539\u3002 overrides.validDuration \uff1a\u8be5\u5b57\u6bb5\u65e0\u6cd5\u7ee7\u7eed\u4f7f\u7528\u3002 redis-rule.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: rule metadata: name: quota spec: actions: - handler: handler.redisquota instances: - dest-quota.quota $ kubectl apply -f redis-rule.yaml rule.config.istio.io/quota unchanged $ kubectl apply -f quotaspec.yaml quotaspec.config.istio.io/request-count created $ kubectl apply -f quotaspec-binding.yaml quotaspecbinding.config.istio.io/spec-sleep created 2-3 \u6d4b\u8bd5\u9650\u6d41\u529f\u80fd $ kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# for i in 'seq 10'; do http --body http://httpbin:8000/ip; done RESOURCE_EXHAUSTED:Quota is exhausted for. dest-quota { \"origin\": \"127.0.0.1\" } RESOURCE_EXHAUSTED:Quota is exhausted for. dest-quota \u53ef\u4ee5\u770b\u5230\uff0c\u548c MemQuota \u4e00\u6837\uff0c\u9650\u6d41\u5df2\u7ecf\u751f\u6548\uff0c\u8c03\u7528\u5931\u8d25\u3002","title":"\u7b2c\u5341\u56db\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(MemQuota\u670d\u52a1\u9650\u6d41/Mixer\u5bf9\u8c61\u7684\u5b9a\u4e49/RedisQuota\u670d\u52a1\u9650\u6d41)"},{"location":"chap5/14Istio_Mixer2/#mixer-memquotamixerredisquota","text":"","title":"\u7b2c\u5341\u56db\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528(MemQuota\u670d\u52a1\u9650\u6d41/Mixer\u5bf9\u8c61\u7684\u5b9a\u4e49/RedisQuota\u670d\u52a1\u9650\u6d41)"},{"location":"chap5/14Istio_Mixer2/#1memquota","text":"\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u95f4\u8c03\u7528\uff0c \u56e0\u4e3a\u5b58\u5728\u4e1a\u52a1\u4f18\u5148\u7ea7\u3001\u8d44\u6e90\u5206\u914d\u53ca\u670d\u52a1\u8d1f\u8f7d\u80fd\u529b\u7b49\u8981\u6c42 \uff0c\u6240\u4ee5\u5e38\u5e38\u9700\u8981\u5bf9\u7279\u5b9a\u7684\u670d\u52a1\u8c03\u7528\u8fdb\u884c\u9650\u5236\uff0c\u9632\u6b62\u670d\u52a1\u8fc7\u8f7d\u3002 \u5728 Istio \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528 Mixer \u7684 MemQuota \u6216 RedisQuota \u9002\u914d\u5668\uff0c\u5728\u9884\u68c0\u6bb5\u5bf9\u6d41\u91cf\u8fdb\u884c\u914d\u989d\u5224\u65ad\uff0c \u6839\u636e\u4e3a\u7279\u5b9a\u6d41\u91cf\u8bbe\u5b9a\u7684\u989d\u5ea6\u89c4\u5219\u6765\u5224\u65ad\u6d41\u91cf\u8bf7\u6c42\u662f\u5426\u5df2\u7ecf\u8d85\u8fc7\u6307\u5b9a\u7684\u989d\u5ea6\uff08\u7b80\u79f0\u8d85\u989d\uff09\uff0c\u5982\u679c\u53d1\u751f\u8d85\u989d\uff0c\u5c31\u8fdb\u884c\u9650\u6d41\u5904\u7406 \u3002 \u5728 Istio \u7684\u9650\u6d41\u529f\u80fd\u5b9e\u73b0\u4e2d\uff0c\u914d\u7f6e\u5de5\u4f5c\u5206\u4e3a \u5ba2\u6237\u7aef \u548c Mixer \u7aef\u4e24\u90e8\u5206\uff1a \u5ba2\u6237\u7aef\u4f7f\u7528 QuotaSpec \u5b9a\u4e49\u4e00\u4e2a\u9650\u989d\uff0c\u7528 QuotaSpecBinding \u5bf9\u8c61\u5c06 QuotaSpec \u7ed1\u5b9a\u5230\u7279\u5b9a\u7684\u670d\u52a1\u4e0a\uff1b Mixer \uff1a\u7aef\u9700\u8981\u5904\u7406\u9650\u989d\u7684\u5b9e\u73b0\u903b\u8f91\uff0c\u7528\u4e00\u4e2a quota \u5b9e\u4f8b\u5b9a\u4e49\u6d41\u91cf\u5904\u7406\u89c4\u5219,\u7528 MemQuota/RedisQuota \u7684 Handler \u6765\u5b9e\u9645\u5904\u7406\u6d41\u91cf\uff0c\u6700\u540e\u4f7f\u7528 Rule \u5bf9\u8c61\u5c06\u4e8c\u8005\u8fdb\u884c\u7ed1\u5b9a\uff1a \u672c\u8282\u4f9d\u7136\u4f1a\u4f7f\u7528 sleep \u670d\u52a1\u4f5c\u4e3a\u5ba2\u6237\u7aef\uff0c\u5e76\u4f7f\u7528 httpbin \u4f5c\u4e3a\u670d\u52a1\u7aef\u3002","title":"1\u3001\u4f7f\u7528MemQuota\u9002\u914d\u5668\u8fdb\u884c\u670d\u52a1\u9650\u6d41"},{"location":"chap5/14Istio_Mixer2/#1-1-mixer","text":"\u5728\u9650\u6d41\u8fc7\u7a0b\u4e2d\u7528\u5230\u7684\u670d\u52a1\u7aef\u5bf9\u8c61\u5e76\u65e0\u7279\u522b\uff0c\u548c\u6240\u6709\u7684 Mixer \u9002\u914d\u5668\u5e94\u7528\u4e00\u6837\uff0c \u7531 Handler , Instance \u7ed3\u5408 Rule \uff0c\u8fd9\u4e8c\u79cd\u5bf9\u8c61\u4e00\u8d77\u5b9a\u4e49\u8fd9\u4e00\u884c\u4e3a\u3002 \u9996\u5148\u5b9a\u4e49\u4e00\u4e2a MemQuota \u7c7b\u578b\u7684 Handler \uff0c\u901a\u8fc7\u5b83\u6765\u5b9a\u4e49 MemQuota \u9002\u914d\u5668\u7684\u884c\u4e3a \u8fd9\u91cc\u9996\u5148\u5b9a\u4e49\u4e86\u9ed8\u8ba4\u7684\u9650\u6d41\u89c4\u5b9a\uff0c\u6bcf\u79d2\u6700\u591a\u8c03\u7528 20 \u6b21\uff0c\u7136\u540e\u901a\u8fc7 overrides \u7684\u65b9\u5f0f\u4e3a httpbin \u670d\u52a1\u5b9a\u4e49\u4e00\u4e2a\u9650\u6d41\uff0c\u6bcf 5 \u79d2\u53ea\u80fd\u8c03\u7528\u4e00\u6b21\uff1a memquota-handler.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: memquota metadata: name: handler spec: quotas: - name: dent-quota.quota.default maxAmount: 20 validDuration: 10s overrides: - dimensions: destination: httpbin maxAmount: 1 validDuration : 5s $ kubectl apply -f memquota-handler.yaml memquota.config.istio.io/handler created \u628a\u4e0a\u8ff0\u6587\u4ef6\u547d\u540d\u4e3a memquota-handler.yaml \uff0c\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6bcf 10 \u79d2\u8c03\u7528 20 \u6b21\u7684\u9ed8\u8ba4\u8c03\u7528\u914d\u989d\uff0c\u53c8\u4e3a httpbin \u670d\u52a1\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7279\u4f8b: \u6bcf 5 \u79d2\u53ea\u5141\u8bb8\u8c03\u7528\u4e00\u6b21\u3002 \u63a5\u4e0b\u6765\u9700\u8981\u5b9a\u4e49\u7684\u662f\u57fa\u4e8e Quota \u6a21\u677f\u7684 Instance \u5bf9\u8c61\uff1a quota-instance.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: quota metadata: name: dest-quota spec: dimensions: destination: destination.labels[\"app\"] | destination.service | \"unknown\" $ kubectl apply -f quota-instance.yaml quota.config.istio.io/dest-quota created \u628a\u4ee3\u7801\u4fdd\u5b58\u4e3a quota-instance.yaml \uff0c\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u91cc\u4e3a quota \u6a21\u677f\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8f93\u5165\u9879 demensions \uff0c\u5176\u4e2d\u5305\u542b\u5bf9\u670d\u52a1\u76ee\u6807\u7684\u5b9a\u4e49\u3002 \u5bf9 destination \u5b57\u6bb5\u7684\u5b9a\u4e49\u662f\u4e00\u4e2a\u5c5e\u6027\u8868\u8fbe\u5f0f\uff0c\u5176\u53d6\u503c\u903b\u8f91\u662f\uff1a \u9996\u5148\u5224\u65ad\u6d41\u91cf\u76ee\u6807\u662f\u5426\u5177\u6709 app \u6807\u7b7e\uff0c \u5982\u679c\u6ca1\u6709\uff0c\u5219\u83b7\u53d6\u76ee\u6807\u670d\u52a1\u7684\u540d\u79f0\uff0c\u5426\u5219\u53d6\u503c\u4e3a \u201cunknown\" \u3002 \u63a5\u4e0b\u6765\u4f7f\u7528\u4e00\u4e2a Rule \u5bf9\u8c61\u5c06\u4e24\u8005\u5173\u8054\u8d77\u6765 \uff1a quota-rule.yaml apiVersion: config.istio.io/v1alpha2 kind: rule metadata: name: quota spec: actions: - handler: handler.memquota instances: - dest-quota.quota $ kubectl apply -f quota-rule.yaml rule.config.istio.io/quota created \u540c\u6837\uff0c\u5c06\u4ee3\u7801\u4fdd\u5b58\u4e3a\uff1a quota-rule.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u5bf9 Mixer \u7aef\u4e09\u4e2a\u5bf9\u8c61\u7684\u5b9a\u4e49\uff0c\u4e09\u4e2a\u5bf9\u8c61\u8054\u5408\u8d77\u6765\u5b8c\u6210\u4efb\u52a1\uff1a Rule \u5bf9\u8c61\u8d1f\u8d23\u8bc6\u522b\u6d41\u91cf\uff0c\u5bf9\u7b26\u5408\u6761\u4ef6\u5e76\u8fdb\u5165\u8be5 Rule \u5bf9\u8c61\u5904\u7406\u6d41\u7a0b\u7684\u6d41\u91cf \uff0c \u4f7f\u7528 dest-quota \u8fdb\u884c\u5904\u7406\uff0c\u5c06\u5904\u7406\u7ed3\u679c\u8f93\u51fa\u7ed9 MemQuota \u9002\u914d\u5668\u7684 Handler \u5bf9\u8c61\u8fdb\u884c\u5224\u65ad","title":"1-1 Mixer\u5bf9\u8c61\u7684\u5b9a\u4e49"},{"location":"chap5/14Istio_Mixer2/#1-2","text":"Mixer \u7aef\u5df2\u7ecf\u5b9a\u4e49\u4e86 \u914d\u989d\u65b9\u5f0f \u548c \u5904\u7406\u65b9\u5f0f \uff0c\u800c\u5ba2\u6237\u7aef\u7684\u914d\u7f6e\u9700\u8981\u5b9a\u4e49\u4e24\u4e2a\u5185\u5bb9\uff1a \u53d7\u9650\u7684\u5e94\u7528\u548c\u914d\u989d\u7684\u6263\u51cf\u65b9\u5f0f\uff0c\u9700\u8981\u7528 QuotaSpec \u548c QuotaSpecBinding \u5bf9\u8c61\u6765\u5b8c\u6210 \uff1a \u521b\u5efa\u4e00\u4e2a QuotaSpec \u5bf9\u8c61\uff1a quotaspec.yaml apiVersion: config.istio.io/v1alpha2 kind: QuotaSpec metadata: name: request-count spec: rules: - quotas: - charge: 5 quota: dest-quota $ kubectl apply -f quotaspec.yaml quotaspec.config.istio.io/request-count created \u628a\u4e0a\u8ff0\u4ee3\u7801\u4fdd\u5b58\u4e3a quotaspec.yaml \uff0c\u4f7f\u7528 kubectl apply \u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a quota \u6263\u51cf\u65b9\u5f0f\uff0c\u5176\u4e2d\u7684 quota \u5bf9\u5e94\u7684\u662f\u521b\u5efa\u7684 dest-quota \u7136\u540e\u5b9a\u4e49 QuotaSpecBindng \u5bf9\u8c61\uff0c\u628a QuotaSpec \u7ed1\u5b9a\u5230\u670d\u52a1\u4e0a\uff1a quotaspec-binding.yaml apiVersion: config.istio.io/v1alpha2 kind: QuotaSpecBinding metadata: name: spec-sleep spec: quotaSpecs: - name: request-count namespace: default services: - name: httpbin namespace: default $ kubectl apply -f quotaspec-binding.yaml quotaspecbinding.config.istio.io/spec-sleep created","title":"1-2 \u5ba2\u6237\u7aef\u5bf9\u8c61\u5b9a\u4e49"},{"location":"chap5/14Istio_Mixer2/#1-3","text":"\u5728\u76f8\u5173\u7684 5 \u4e2a\u5bf9\u8c61\u90fd\u521b\u5efa\u6210\u529f\u540e\uff0c\u5c31\u53ef\u4ee5\u8fdb\u884c\u6d4b\u8bd5\u4e86\uff1a $ kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# for i in 'seq 10';do http --body http://httpbin:8000/ip; done { \"origin\": \"127.0.0.1\" } RESOURCE EXHAUSTED:Quota is exhausted for: dest-quota \u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u8fde\u7eed\u8c03\u7528\u4e86 httpbin \u670d\u52a1\uff0c\u5e76\u8fd4\u56de\u4e86\u8d85\u989d\u9519\u8bef\u3002 \u4e0b\u9762\u5c1d\u8bd5\u8c03\u7528 flaskapp \u670d\u52a1\uff1a bash-4.4# for i in 'seq 10'; do http --body http://flaskapp/env/version; done v2 \u53d1\u73b0 flaskapp \u5e76\u672a\u53d7\u5230\u5f71\u54cd","title":"1-3 \u6d4b\u8bd5\u9650\u6d41\u529f\u80fd"},{"location":"chap5/14Istio_Mixer2/#1-4","text":"\u901a\u8fc7\u4e0a\u9762\u7684\u5c1d\u8bd5\u80af\u5b9a\u6709\u4e0d\u5c11\u8bfb\u8005\u4f1a\u60f3\uff1a\u8fd9\u592a\u590d\u6742\u4e86\u800c\u4e14\u5bf9\u8c61\u4e4b\u95f4\u7684\u5f15\u7528\u592a\u6df7\u4e71 \u540c\u65f6\u3001\u5bf9\u670d\u52a1\u8eab\u4efd\u7684\u7ed1\u5b9a\u5173\u7cfb\u4e5f\u6563\u4e71\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u5bf9\u8c61\u4e2d\u3002 \u751a\u81f3\u5230\u76ee\u524d\u4e3a\u6b62 QuotaSpec \u548c QcotaSpecBinding \u8fd8\u6ca1\u6709\u63d0\u4f9b Reference \u7b14\u8005\u63a8\u6d4b\u8fd9\u90e8\u5206\u53d1\u751f\u53d8\u5316\u7684 \u53ef\u80fd\u6027\u975e\u5e38\u5927, \u5f3a\u70c8\u5efa\u8bae\u4e0d\u8981\u91c7\u7528","title":"1-4 \u6ce8\u610f\u4e8b\u9879"},{"location":"chap5/14Istio_Mixer2/#2-redisquota","text":"MemQuota \u9002\u914d\u5668\u9650\u6d41\uff0c\u662f\u4e00\u79cd\u5b9e\u9a8c\u6027\u8d28\u7684\u505a\u6cd5\uff0c\u5b83\u4ec5\u652f\u6301\u56fa\u5b9a\u7a97\u53e3\u7684\u9650\u6d41\u7b97\u6cd5\uff0c \u5e76\u4e14\u5728 Mixer \u662f\u591a\u526f\u672c\u7684\u8fd0\u884c\u72b6\u6001\u4e0b\u5185\u5b58\u8ba1\u6570\u4f1a\u5b8c\u5168\u5931\u6548, \u5fc5\u987b\u63d0\u4f9b\u4e00\u4e2a\u72ec\u7acb\u4e8e Mixer \u8fdb\u7a0b\u4e4b\u5916\u7684\u540e\u7aef\u670d\u52a1\u6765\u63d0\u4f9b\u6570\u636e\u652f\u6301, \u76ee\u524d\u5b98\u65b9\u5efa\u8bae\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528 RedisQuota \u5bf9\u8c61\u8fdb\u884c\u9650\u6d41. \u5176\u6574\u4f53\u73af\u8282\u548c MemQuota \u6d41\u7684\u6d41\u7a0b\u662f\u4e00\u81f4, \u7684\u53ea\u4e0d\u8fc7\u5176\u4e2d\u7684 MemQuota Handler \u8981\u66f4\u6362\u4e3a Redis \u7248\u672c\u8fd8\u9700\u8981\u4e00\u4e2a\u7528\u4e8e\u63d0\u4f9b\u6570\u636e\u540e\u7aef\u7684 Redis \u5e94\u7528\u3002","title":"2\u3001 \u4f7f\u7528RedisQuota\u9002\u914d\u5668\u8fdb\u884c\u670d\u52a1\u9650\u6d41"},{"location":"chap5/14Istio_Mixer2/#2-1-redis","text":"\u9996\u5148\u6211\u4eec\u505a\u4e00\u4e0b\u51c6\u5907\u5de5\u4f5c\u542f\u7528\u4e00\u4e2a Redis \u670d\u52a1\u5668\u6765\u652f\u6301\u9650\u6d41\u64cd\u4f5c\uff0c\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u5148\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u542f\u52a8\u4e00\u4e2a\u5355\u5b9e\u4f8b\u670d\u52a1\u6765\u5b8c\u6210\u529f\u80fd\u5c55\u793a\u3002 \u8fd9\u91cc\u9009\u62e9\u4f7f\u7528 Redis \u7684\u5b98\u65b9\u955c\u50cf, \u521b\u5efa\u4e00\u4e2a\u5355\u5b9e\u4f8b\u7684 Deployment \u548c\u5bf9\u5e94\u7684 Service : apiVersion: v1 kind: ReplicationController metadata: name: redis labels: name: redis spec: replicas: 1 selector: name: redis template: metadata: labels: name: redis spec: containers: - name: redis image: k8s.gcr.io/redis:v1 ports: - containerPort: 6379 --- apiVersion: v1 kind: Service metadata: name: redis labels: name: redis spec: ports: - port: 6379 targetPort: 6379 selector: name: redis \u5c06\u4e0a\u8ff0\u6587\u4ef6\u4fdd\u5b58\u4e3a redis.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4 RC \u5728\u542f\u52a8\u4e4b\u540e\uff0c\u4f1a\u5728 6379 \u7aef\u53e3\u5f00\u653e\u4e00\u4e2a Redis \u670d\u52a1\u3002","title":"2-1 \u542f\u52a8Redis\u670d\u52a1"},{"location":"chap5/14Istio_Mixer2/#2-2","text":"\u4e24\u79cd\u9650\u6d41\u65b9\u5f0f\u7684\u5bf9\u8c61\u5b9a\u4e49\u683c\u5f0f\u57fa\u672c\u662f\u4e00\u81f4\u7684\uff0c\u533a\u522b\u4ec5\u5728\u4e8e RedisQuota \u7684\u5b9a\u4e49\u8981\u6bd4 MemQuota \u7684\u5b9a\u4e49\u7ec6\u81f4\u4e00\u4e9b\u3002 \u8fd9\u91cc\u9996\u5148\u5b9a\u4e49 RedisQuota : redisquota.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: redisquota metadata: name: handler spec: redisServerUrl: \"10.245.90.154:6379\" quotas: - name: dest-quota.quota.default maxAmount: 20 bucketDuration: 1s validDuration: 10s rateLimitAlgorithm: ROLLING_WINDOW overrides: - dimensions: destination: httpbin maxAmount: 1 $ kubectl apply -f redisquota.yaml redisquota.config.istio.io/handler created \u5c06\u4e0a\u8ff0\u4ee3\u7801\u4fdd\u5b58\u4e3a redisquota.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230\u96c6\u7fa4\u3002 redisServerUrl \uff1a\u7528\u4e8e\u6307\u5b9a Redis \u670d\u52a1\u7684\u5730\u5740\u3002 quota.bucketDuratio n\uff1a\u5fc5\u987b\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5927\u4e8e\u96f6\u7684\u79d2\u6570\u3002 quota.rateLimitAlgorithm \uff1a\u53ef\u4ee5\u4e3a\u6bcf\u4e2a Quota \u6307\u5b9a\u5404\u81ea\u7684\u9650\u6d41\u7b97\u6cd5\uff0c\u5728 MemQuota \u4e2d\u91c7\u7528\u7684\u662f FIXED_ WINDOW\u7b97 \u6cd5\uff0c\u4e14\u4e0d\u53ef\u66f4\u6539\u3002 overrides.validDuration \uff1a\u8be5\u5b57\u6bb5\u65e0\u6cd5\u7ee7\u7eed\u4f7f\u7528\u3002 redis-rule.yaml apiVersion: \"config.istio.io/v1alpha2\" kind: rule metadata: name: quota spec: actions: - handler: handler.redisquota instances: - dest-quota.quota $ kubectl apply -f redis-rule.yaml rule.config.istio.io/quota unchanged $ kubectl apply -f quotaspec.yaml quotaspec.config.istio.io/request-count created $ kubectl apply -f quotaspec-binding.yaml quotaspecbinding.config.istio.io/spec-sleep created","title":"2-2 \u5b9a\u4e49\u9650\u6d41\u76f8\u5173\u5bf9\u8c61"},{"location":"chap5/14Istio_Mixer2/#2-3","text":"$ kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# for i in 'seq 10'; do http --body http://httpbin:8000/ip; done RESOURCE_EXHAUSTED:Quota is exhausted for. dest-quota { \"origin\": \"127.0.0.1\" } RESOURCE_EXHAUSTED:Quota is exhausted for. dest-quota \u53ef\u4ee5\u770b\u5230\uff0c\u548c MemQuota \u4e00\u6837\uff0c\u9650\u6d41\u5df2\u7ecf\u751f\u6548\uff0c\u8c03\u7528\u5931\u8d25\u3002","title":"2-3 \u6d4b\u8bd5\u9650\u6d41\u529f\u80fd"},{"location":"chap5/15Istio_Mixer3_prometheus/","text":"\u7b2c\u5341\u4e94\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528 - \u4e3aPrometheus\u5b9a\u4e49\u76d1\u63a7\u6307\u6807 Mixe \uff1a\u63d0\u4f9b\u4e86\u5185\u7f6e\u7684 Prometheus \u9002\u914d\u5668\uff0c\u8be5\u9002\u914d\u5668\u4f1a\u5f00\u653e\u670d\u52a1\u7aef\u70b9\uff0c\u4f7f\u7528\u6765\u81ea metrics \u6a21\u677f\u5b9e\u4f8b\u7684\u6570\u636e\u4f9b Prometheus \u8fdb\u884c\u6307\u6807\u6293\u53d6\uff0c\u5de5\u4f5c\u6d41\u7a0b\u5927\u81f4\u5982\u56fe \u670d\u52a1\u95f4\u901a\u8fc7 Sidecar \u96a7\u9053\u8fdb\u884c\u76f8\u4e92\u8c03\u7528\u65f6\u3002 \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u4f1a\u5411 Mixer Telemetry \u670d\u52a1\u62a5\u544a\u6d41\u91cf\u4fe1\u606f\uff0c Mixer Telemetry \u4f1a\u6839\u636e\u6d41\u91cf\u4fe1\u606f\u5728\u6ce8\u518c\u7684 Rule \u5bf9\u8c61\u4e2d\u67e5\u627e\u7b26\u5408\u5176 match \u5b57\u6bb5\u7684\u5185\u5bb9\uff0c\u5982 \u679c\u6709\u7b26\u5408\u8981\u6c42\u7684\u7ed3\u679c\uff0c\u5219\u4f1a\u4f7f\u7528\u5728 Rule \u5bf9\u8c61\u4e2d\u6307\u5b9a\u7684 metrics \u6a21\u677f\u5b9e\u4f8b\u5904\u7406\u6d41\u91cf\u4fe1\u606f\uff0c\u5bf9\u4e8e\u5904\u7406\u540e\u7684\u8f93\u51fa\u5185\u5bb9\uff0c \u7531 Rule \u5bf9\u8c61\u4e2d\u6307\u5b9a\u7684 Prometheus Handler \u8fdb\u884c\u8f93\u51fa 1\u3001 \u9ed8\u8ba4\u76d1\u63a7\u6307\u6807 \u5728 Istio \u7684\u5b89\u88c5\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Prometheus Chart \u91cc templates/configmap.yaml \u63d0\u4f9b\u7684 Prometheus \u914d\u7f6e\u6a21\u677f\uff0c\u5176\u4e2d\u9664\u4e86\u63d0\u4f9b\u4e86 Kubernetes \u7684\u4efb\u52a1\uff0c\u8fd8\u63d0\u4f9b\u4e86\u51e0\u4e2a\u4e0d\u540c\u7684\u6293\u53d6\u4efb\u52a1\uff0c\u5982\u4e0b\u6240\u8ff0 istio-mesh \uff1a\u4ece Mixer \u7684 telemtry \u670d\u52a1\u4e2d\u6293\u53d6 Mixer \u751f\u6210\u7684\u7f51\u683c\u6307\u6807\u3002 envoy-stats \uff1a\u4ece\u7f51\u683c\u7684 Pod \u4e2d\u6293\u53d6 Envoy \u7684\u7edf\u8ba1\u6570\u636e\u3002 istio-policy :\u4ece Mixer \u7684 policy \u670d\u52a1\u4e2d\u6293\u53d6 Poicy \u7ec4\u4ef6\u7684\u76d1\u63a7\u6307\u6807\u3002 istio-telemetry \uff1a\u4ece Mixer \u7684 telemtry \u670d\u52a1\u4e2d\u6293\u53d6 Mixer \u670d\u52a1\u7684\u6307\u6807\u3002 pilot : Pilot \u7684\u81ea\u8eab\u6307\u6807\u3002 galley : Galley \u7ec4\u4ef6\u7684\u81ea\u8eab\u76d1\u63a7\u6307\u6807\u3002 \u672c\u8282\u8981\u8bb2\u7684\u81ea\u5b9a\u4e49\u6307\u6807\uff0c\u5c31\u4f1a\u88ab\u8f93\u51fa\u5230 istio-telernetry \u4efb\u52a1\u4e2d\u3002 \u5728\u5b89\u88c5\u5b8c\u6bd5 Istio \u4e4b\u540e\uff0c\u5728 Istio \u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u52a0\u4eba\u4e00\u4e9b\u521d\u59cb\u6307\u6807\uff1a $ kubectl get metrics -n istio-system NAME AGE requestcount 16d requestduration 16d requestsize 16d responsesize 16d tcpbytereceived 16d tcpbytesent 16d tcpconnectionsclosed 16d tcpconnectionsopened 16d \u4f8b\u5982 requestsize $ kubectl get metrics -n istio-system requestsize -oyaml apiVersion: config.istio.io/v1alpha2 kind: metric metadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | ... creationTimestamp: \"2019-10-18T09:23:04Z\" generation: 1 labels: app: mixer chart: mixer heritage: Tiller release: istio name: requestsize namespace: istio-system resourceVersion: \"39282\" selfLink: /apis/config.istio.io/v1alpha2/namespaces/istio-system/metrics/requestsize uid: d090508b-a9d2-4dad-a4e1-16a3494b3de9 spec: dimensions: connection_security_policy: conditional((context.reporter.kind | \"inbound\") == \"outbound\", \"unknown\", conditional(connection.mtls | false, \"mutual_tls\", \"none\")) destination_app: destination.labels[\"app\"] | \"unknown\" destination_principal: destination.principal | \"unknown\" destination_service: destination.service.host | \"unknown\" destination_service_name: destination.service.name | \"unknown\" destination_service_namespace: destination.service.namespace | \"unknown\" destination_version: destination.labels[\"version\"] | \"unknown\" destination_workload: destination.workload.name | \"unknown\" destination_workload_namespace: destination.workload.namespace | \"unknown\" permissive_response_code: rbac.permissive.response_code | \"none\" permissive_response_policyid: rbac.permissive.effective_policy_id | \"none\" reporter: conditional((context.reporter.kind | \"inbound\") == \"outbound\", \"source\", \"destination\") request_protocol: api.protocol | context.protocol | \"unknown\" response_code: response.code | 200 response_flags: context.proxy_error_code | \"-\" source_app: source.labels[\"app\"] | \"unknown\" source_principal: source.principal | \"unknown\" source_version: source.labels[\"version\"] | \"unknown\" source_workload: source.workload.name | \"unknown\" source_workload_namespace: source.workload.namespace | \"unknown\" monitored_resource_type: '\"UNSPECIFIED\"' value: request.size | 0 \u8fd9\u662f\u4e2a metric \u6a21\u677f\u7684\u5b9e\u4f8b\uff0c\u5728 dimensions \u5b57\u6bb5\u4f7f\u7528 Istio \u7684\u5c5e\u6027\u8868\u8fbe\u5f0f\u4e3a\u6307\u6807\u52a0\u4eba\u5404\u79cd\u6807\u7b7e\uff0c\u5e76\u51e0\u7528 request.size \u4f5c\u4e3a\u6307\u6807\u7684\u6570\u503c \u63a5\u4e0b\u6765\u81ea\u7136\u8981\u770b\u770b\u5bf9\u5e94\u7684\u9002\u914d\u5668\u914d\u7f6e $ kubectl get handler prometheus -n istio-system -oyaml apiVersion: config.istio.io/v1alpha2 kind: handler metadata: annotations: ... generation: 1 labels: app: mixer chart: mixer heritage: Tiller release: istio name: prometheus namespace: istio-system ... params: metrics: - instance_name: requestcount.metric.istio-system kind: COUNTER label_names: - reporter - source_app - source_principal - source_workload - source_workload_namespace - source_version ... \u53ef\u4ee5\u541e\u5230\u5728\u8fd9\u4e2a\u5bf9\u8c61\u4e3a Prometheus \u5b9a\u4e49\u4e86\u7cfb\u5217\u7684\u76d1\u63a7\u6307\u6807\u89c4\u5219 \u4e09\u8981\u7d20\u4e2d\u7684\u9002\u914d\u5668\u548c\u6a21\u677f\u90fd\u9f50\u5168\u4e86\uff0c\u5c31\u53ef\u4ee5\u770b\u770b rule \u5bf9\u8c61\u4e86\u5728 Istio-system \u547d\u540d\u7a7a\u95f4\uff0c \u9ed8\u8ba4\u5305\u542b\u4e24\u4e2a\u4e0e Prometheus \u76f8\u5173\u7684 Rule \u5bf9\u8c61\u5206\u522b\u662f promhttp \u548c promtcp \u5b83\u4eec\u4eec\u628a\u4e24\u7c7b\u4e0d\u540c\u7684 metric \u5b9e\u4f8b\u548c Prometheus Handler \u8fde\u63a5\u8d77\u6765 $ kubectl get rules -n istio-system NAME AGE kubeattrgenrulerule 16d promhttp 16d promtcp 16d ... \u8fd9\u6837\u4e00\u6765\uff0c Istio \u5c31\u901a\u8fc7 Mixer \u63d0\u4f9b\u7684\u529f\u80fd\uff0c\u518d\u7ed3\u5408 Prometheus \u5f62\u6210\u5b8c\u6574\u7684\u6570\u636e\u636e\u91c7\u96c6\u548c\u76d1\u63a7\u529f\u80fd\uff0c\u4e5f\u4e3a\u7528\u6237\u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807\u63d0\u4f9b\u4e86\u57fa\u7840\u3002 2\u3001 \u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807 \u8fd8\u53ef\u4ee5\u4f7f\u7528 Mixer \uff1a\u9002\u914d\u5668\u7684\u914d\u7f6e\u6765\u751f\u6210\u65b0\u7684\u76d1\u63a7\u6307\u6807\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u76d1\u63a7\u6307\u6807\u3002 \u5728\u73b0\u6709\u7684 requestsize \u6307\u6807\u4e2d\u662f\u4e0d\u5305\u542b Header \u5927\u5c0f\u7684 \u4e3a\u6b64\uff0c\u6211\u4eec\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u76d1\u63a7\u6307\u6807\u3002 \u9996\u5148\u5b9a\u4e49\u4e00\u4e2a\uff1a metric \u5bf9\u8c61\uff0c\u5728 value \u5b57\u6bb5\u4f7f\u7528 request.total_size \u6765\u83b7\u53d6 request \u7684\u5927\u5c0f\u5e76\u52a0\u4ee5\u76d1\u63a7\uff1a $ kubectl get metrics -n istio-system requestsize -oyaml > request.totalsize.yaml \u7f16\u8f91\u65b0\u751f\u6210\u7684 request.totalsize.yaml apiVersion: config.istio.io/v1alpha2 kind: metric metadata: annotations: ... name: requesttotalsize namespace: istio-system ... spec: dimensions: ... value: request.total_size | 0 $ kubectl apply -f request.totalsize.yaml metric.config.istio.io/requesttotalsize created \u63a5\u4e0b\u6765\u4fee\u6539 Prometheus Handler \u7684\u5b9a\u4e49\uff0c \u8ba9 Handler \u5bf9\u8c61\u5904\u7406\u65b0\u5efa\u7684\u6307\u6807 $ kubectl get handler prometheus -n istio-system -oyaml > prometheus_handler.yaml ... - buckets: exponentialBuckets: growthFactor: 10 numFiniteBuckets: 8 scale: 1 instance_name: requesttotalsize.metric.istio-system kind: DISTRIBUTION label_names: - reporter - source_app - source_principal - source_workload - source_workload_namespace - source_version - destination_app - destination_principal - destination_workload - destination_workload_namespace - destination_version - destination_service - destination_service_name - destination_service_namespace - request_protocol - response_code - response_flags - permissive_response_code - permissive_response_policyid - connection_security_policy name: request__total_bytes $ kubectl apply -f prometheus_handler.yaml handler.config.istio.io/prometheus configured \u5728\u7f16\u8f91\u7ed3\u675f\u4e4b\u540e\uff0c\u518d\u4f7f\u7528 kubectl edit \u547d\u4ee4\u4fee\u6539\u7cfb\u7edf\u539f\u6709\u7684 Rule \u5bf9\u8c61\uff08 promhttp ), $ kubectl edit rule promhttp -n istio-s ystem rule.config.istio.io/promhttp edited apiVersion: config.istio.io/v1alpha2 kind: rule metadata: annotations: ... name: promhttp namespace: istio-system resourceVersion: \"39293\" spec: actions: - handler: prometheus instances: - requestcount.metric - requestduration.metric - requestsize.metric - responsesize.metric - requesttotalsize.metric ... \u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u4f7f\u7528 sleep Pod \u4e2d\u7684\u8f93\u51fa\u6d41\u91cf\uff1a wrk \u5de5\u5177\u53d1\u8d77\u5bf9 httpbin \u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4ee5\u4fbf\u8f93\u51fa\u6d41\u91cf $ kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# wrk http://httpbin:8000/ip Running 10s test @ http://httpbin:8000/ip 2 threads and 10 connections Thread Stats Avg Stdev Max +/- Stdev Latency 12.44ms 7.56ms 58.04ms 78.43% Req/Sec 416.38 95.33 696.00 65.66% 8310 requests in 10.04s, 2.04MB read Requests/sec: 827.42 Transfer/sec: 207.95KB \u8fd9\u6837\u5c31\u751f\u6210\u4e86\u6d41\u91cf\u3002 \u63a5\u7740\u8bbf\u95ee Prometheus \u7684\u67e5\u8be2\u754c\u9762\uff0c\u8f93\u4eba\u6211\u4eec\u65b0\u5efa\u7684\u6307\u6807\uff0c\u5c31\u80fd\u770b\u5230\u6307\u6807\u6570\u636e\u4e86\uff08\u6307\u6807\u540d\u79f0\u4f1a\u81ea\u52a8\u52a0\u4eba\u201cistio_\u201d\u524d\u7f00\uff09 \u4e8b\u5b9e\u4e0a\uff0c\u76ee\u524d\u8fd9\u65b9\u9762\u80fd\u591f\u5b9a\u5236\u7684\u5185\u5bb9\u8fd8\u5f88\u6709\u9650\uff0c\u4e3b\u8981\u7684\u5b9a\u5236\u80fd\u529b\u53d6\u51b3\u4e8e Envoy \u548c\u5404\u79cd Mixer \u9002\u914d\u5668\u7684\u8f93\u51fa\u5185\u5bb9\u3002 kubectl -n istio-system port-forward prometheus-d44645598-xh8wn 9090:9090 Forwarding from 127.0.0.1:9090 -> 9090 Forwarding from [::1]:9090 -> 9090 istio_request_total_bytes_bucket","title":"\u7b2c\u5341\u4e94\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528 - \u4e3aPrometheus\u5b9a\u4e49\u76d1\u63a7\u6307\u6807"},{"location":"chap5/15Istio_Mixer3_prometheus/#mixer-prometheus","text":"Mixe \uff1a\u63d0\u4f9b\u4e86\u5185\u7f6e\u7684 Prometheus \u9002\u914d\u5668\uff0c\u8be5\u9002\u914d\u5668\u4f1a\u5f00\u653e\u670d\u52a1\u7aef\u70b9\uff0c\u4f7f\u7528\u6765\u81ea metrics \u6a21\u677f\u5b9e\u4f8b\u7684\u6570\u636e\u4f9b Prometheus \u8fdb\u884c\u6307\u6807\u6293\u53d6\uff0c\u5de5\u4f5c\u6d41\u7a0b\u5927\u81f4\u5982\u56fe \u670d\u52a1\u95f4\u901a\u8fc7 Sidecar \u96a7\u9053\u8fdb\u884c\u76f8\u4e92\u8c03\u7528\u65f6\u3002 \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u4f1a\u5411 Mixer Telemetry \u670d\u52a1\u62a5\u544a\u6d41\u91cf\u4fe1\u606f\uff0c Mixer Telemetry \u4f1a\u6839\u636e\u6d41\u91cf\u4fe1\u606f\u5728\u6ce8\u518c\u7684 Rule \u5bf9\u8c61\u4e2d\u67e5\u627e\u7b26\u5408\u5176 match \u5b57\u6bb5\u7684\u5185\u5bb9\uff0c\u5982 \u679c\u6709\u7b26\u5408\u8981\u6c42\u7684\u7ed3\u679c\uff0c\u5219\u4f1a\u4f7f\u7528\u5728 Rule \u5bf9\u8c61\u4e2d\u6307\u5b9a\u7684 metrics \u6a21\u677f\u5b9e\u4f8b\u5904\u7406\u6d41\u91cf\u4fe1\u606f\uff0c\u5bf9\u4e8e\u5904\u7406\u540e\u7684\u8f93\u51fa\u5185\u5bb9\uff0c \u7531 Rule \u5bf9\u8c61\u4e2d\u6307\u5b9a\u7684 Prometheus Handler \u8fdb\u884c\u8f93\u51fa","title":"\u7b2c\u5341\u4e94\u8282 Mixer \u9002\u914d\u5668\u7684\u5e94\u7528 - \u4e3aPrometheus\u5b9a\u4e49\u76d1\u63a7\u6307\u6807"},{"location":"chap5/15Istio_Mixer3_prometheus/#1","text":"\u5728 Istio \u7684\u5b89\u88c5\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Prometheus Chart \u91cc templates/configmap.yaml \u63d0\u4f9b\u7684 Prometheus \u914d\u7f6e\u6a21\u677f\uff0c\u5176\u4e2d\u9664\u4e86\u63d0\u4f9b\u4e86 Kubernetes \u7684\u4efb\u52a1\uff0c\u8fd8\u63d0\u4f9b\u4e86\u51e0\u4e2a\u4e0d\u540c\u7684\u6293\u53d6\u4efb\u52a1\uff0c\u5982\u4e0b\u6240\u8ff0 istio-mesh \uff1a\u4ece Mixer \u7684 telemtry \u670d\u52a1\u4e2d\u6293\u53d6 Mixer \u751f\u6210\u7684\u7f51\u683c\u6307\u6807\u3002 envoy-stats \uff1a\u4ece\u7f51\u683c\u7684 Pod \u4e2d\u6293\u53d6 Envoy \u7684\u7edf\u8ba1\u6570\u636e\u3002 istio-policy :\u4ece Mixer \u7684 policy \u670d\u52a1\u4e2d\u6293\u53d6 Poicy \u7ec4\u4ef6\u7684\u76d1\u63a7\u6307\u6807\u3002 istio-telemetry \uff1a\u4ece Mixer \u7684 telemtry \u670d\u52a1\u4e2d\u6293\u53d6 Mixer \u670d\u52a1\u7684\u6307\u6807\u3002 pilot : Pilot \u7684\u81ea\u8eab\u6307\u6807\u3002 galley : Galley \u7ec4\u4ef6\u7684\u81ea\u8eab\u76d1\u63a7\u6307\u6807\u3002 \u672c\u8282\u8981\u8bb2\u7684\u81ea\u5b9a\u4e49\u6307\u6807\uff0c\u5c31\u4f1a\u88ab\u8f93\u51fa\u5230 istio-telernetry \u4efb\u52a1\u4e2d\u3002 \u5728\u5b89\u88c5\u5b8c\u6bd5 Istio \u4e4b\u540e\uff0c\u5728 Istio \u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u52a0\u4eba\u4e00\u4e9b\u521d\u59cb\u6307\u6807\uff1a $ kubectl get metrics -n istio-system NAME AGE requestcount 16d requestduration 16d requestsize 16d responsesize 16d tcpbytereceived 16d tcpbytesent 16d tcpconnectionsclosed 16d tcpconnectionsopened 16d \u4f8b\u5982 requestsize $ kubectl get metrics -n istio-system requestsize -oyaml apiVersion: config.istio.io/v1alpha2 kind: metric metadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | ... creationTimestamp: \"2019-10-18T09:23:04Z\" generation: 1 labels: app: mixer chart: mixer heritage: Tiller release: istio name: requestsize namespace: istio-system resourceVersion: \"39282\" selfLink: /apis/config.istio.io/v1alpha2/namespaces/istio-system/metrics/requestsize uid: d090508b-a9d2-4dad-a4e1-16a3494b3de9 spec: dimensions: connection_security_policy: conditional((context.reporter.kind | \"inbound\") == \"outbound\", \"unknown\", conditional(connection.mtls | false, \"mutual_tls\", \"none\")) destination_app: destination.labels[\"app\"] | \"unknown\" destination_principal: destination.principal | \"unknown\" destination_service: destination.service.host | \"unknown\" destination_service_name: destination.service.name | \"unknown\" destination_service_namespace: destination.service.namespace | \"unknown\" destination_version: destination.labels[\"version\"] | \"unknown\" destination_workload: destination.workload.name | \"unknown\" destination_workload_namespace: destination.workload.namespace | \"unknown\" permissive_response_code: rbac.permissive.response_code | \"none\" permissive_response_policyid: rbac.permissive.effective_policy_id | \"none\" reporter: conditional((context.reporter.kind | \"inbound\") == \"outbound\", \"source\", \"destination\") request_protocol: api.protocol | context.protocol | \"unknown\" response_code: response.code | 200 response_flags: context.proxy_error_code | \"-\" source_app: source.labels[\"app\"] | \"unknown\" source_principal: source.principal | \"unknown\" source_version: source.labels[\"version\"] | \"unknown\" source_workload: source.workload.name | \"unknown\" source_workload_namespace: source.workload.namespace | \"unknown\" monitored_resource_type: '\"UNSPECIFIED\"' value: request.size | 0 \u8fd9\u662f\u4e2a metric \u6a21\u677f\u7684\u5b9e\u4f8b\uff0c\u5728 dimensions \u5b57\u6bb5\u4f7f\u7528 Istio \u7684\u5c5e\u6027\u8868\u8fbe\u5f0f\u4e3a\u6307\u6807\u52a0\u4eba\u5404\u79cd\u6807\u7b7e\uff0c\u5e76\u51e0\u7528 request.size \u4f5c\u4e3a\u6307\u6807\u7684\u6570\u503c \u63a5\u4e0b\u6765\u81ea\u7136\u8981\u770b\u770b\u5bf9\u5e94\u7684\u9002\u914d\u5668\u914d\u7f6e $ kubectl get handler prometheus -n istio-system -oyaml apiVersion: config.istio.io/v1alpha2 kind: handler metadata: annotations: ... generation: 1 labels: app: mixer chart: mixer heritage: Tiller release: istio name: prometheus namespace: istio-system ... params: metrics: - instance_name: requestcount.metric.istio-system kind: COUNTER label_names: - reporter - source_app - source_principal - source_workload - source_workload_namespace - source_version ... \u53ef\u4ee5\u541e\u5230\u5728\u8fd9\u4e2a\u5bf9\u8c61\u4e3a Prometheus \u5b9a\u4e49\u4e86\u7cfb\u5217\u7684\u76d1\u63a7\u6307\u6807\u89c4\u5219 \u4e09\u8981\u7d20\u4e2d\u7684\u9002\u914d\u5668\u548c\u6a21\u677f\u90fd\u9f50\u5168\u4e86\uff0c\u5c31\u53ef\u4ee5\u770b\u770b rule \u5bf9\u8c61\u4e86\u5728 Istio-system \u547d\u540d\u7a7a\u95f4\uff0c \u9ed8\u8ba4\u5305\u542b\u4e24\u4e2a\u4e0e Prometheus \u76f8\u5173\u7684 Rule \u5bf9\u8c61\u5206\u522b\u662f promhttp \u548c promtcp \u5b83\u4eec\u4eec\u628a\u4e24\u7c7b\u4e0d\u540c\u7684 metric \u5b9e\u4f8b\u548c Prometheus Handler \u8fde\u63a5\u8d77\u6765 $ kubectl get rules -n istio-system NAME AGE kubeattrgenrulerule 16d promhttp 16d promtcp 16d ... \u8fd9\u6837\u4e00\u6765\uff0c Istio \u5c31\u901a\u8fc7 Mixer \u63d0\u4f9b\u7684\u529f\u80fd\uff0c\u518d\u7ed3\u5408 Prometheus \u5f62\u6210\u5b8c\u6574\u7684\u6570\u636e\u636e\u91c7\u96c6\u548c\u76d1\u63a7\u529f\u80fd\uff0c\u4e5f\u4e3a\u7528\u6237\u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807\u63d0\u4f9b\u4e86\u57fa\u7840\u3002","title":"1\u3001 \u9ed8\u8ba4\u76d1\u63a7\u6307\u6807"},{"location":"chap5/15Istio_Mixer3_prometheus/#2","text":"\u8fd8\u53ef\u4ee5\u4f7f\u7528 Mixer \uff1a\u9002\u914d\u5668\u7684\u914d\u7f6e\u6765\u751f\u6210\u65b0\u7684\u76d1\u63a7\u6307\u6807\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u76d1\u63a7\u6307\u6807\u3002 \u5728\u73b0\u6709\u7684 requestsize \u6307\u6807\u4e2d\u662f\u4e0d\u5305\u542b Header \u5927\u5c0f\u7684 \u4e3a\u6b64\uff0c\u6211\u4eec\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u76d1\u63a7\u6307\u6807\u3002 \u9996\u5148\u5b9a\u4e49\u4e00\u4e2a\uff1a metric \u5bf9\u8c61\uff0c\u5728 value \u5b57\u6bb5\u4f7f\u7528 request.total_size \u6765\u83b7\u53d6 request \u7684\u5927\u5c0f\u5e76\u52a0\u4ee5\u76d1\u63a7\uff1a $ kubectl get metrics -n istio-system requestsize -oyaml > request.totalsize.yaml \u7f16\u8f91\u65b0\u751f\u6210\u7684 request.totalsize.yaml apiVersion: config.istio.io/v1alpha2 kind: metric metadata: annotations: ... name: requesttotalsize namespace: istio-system ... spec: dimensions: ... value: request.total_size | 0 $ kubectl apply -f request.totalsize.yaml metric.config.istio.io/requesttotalsize created \u63a5\u4e0b\u6765\u4fee\u6539 Prometheus Handler \u7684\u5b9a\u4e49\uff0c \u8ba9 Handler \u5bf9\u8c61\u5904\u7406\u65b0\u5efa\u7684\u6307\u6807 $ kubectl get handler prometheus -n istio-system -oyaml > prometheus_handler.yaml ... - buckets: exponentialBuckets: growthFactor: 10 numFiniteBuckets: 8 scale: 1 instance_name: requesttotalsize.metric.istio-system kind: DISTRIBUTION label_names: - reporter - source_app - source_principal - source_workload - source_workload_namespace - source_version - destination_app - destination_principal - destination_workload - destination_workload_namespace - destination_version - destination_service - destination_service_name - destination_service_namespace - request_protocol - response_code - response_flags - permissive_response_code - permissive_response_policyid - connection_security_policy name: request__total_bytes $ kubectl apply -f prometheus_handler.yaml handler.config.istio.io/prometheus configured \u5728\u7f16\u8f91\u7ed3\u675f\u4e4b\u540e\uff0c\u518d\u4f7f\u7528 kubectl edit \u547d\u4ee4\u4fee\u6539\u7cfb\u7edf\u539f\u6709\u7684 Rule \u5bf9\u8c61\uff08 promhttp ), $ kubectl edit rule promhttp -n istio-s ystem rule.config.istio.io/promhttp edited apiVersion: config.istio.io/v1alpha2 kind: rule metadata: annotations: ... name: promhttp namespace: istio-system resourceVersion: \"39293\" spec: actions: - handler: prometheus instances: - requestcount.metric - requestduration.metric - requestsize.metric - responsesize.metric - requesttotalsize.metric ... \u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u4f7f\u7528 sleep Pod \u4e2d\u7684\u8f93\u51fa\u6d41\u91cf\uff1a wrk \u5de5\u5177\u53d1\u8d77\u5bf9 httpbin \u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4ee5\u4fbf\u8f93\u51fa\u6d41\u91cf $ kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# wrk http://httpbin:8000/ip Running 10s test @ http://httpbin:8000/ip 2 threads and 10 connections Thread Stats Avg Stdev Max +/- Stdev Latency 12.44ms 7.56ms 58.04ms 78.43% Req/Sec 416.38 95.33 696.00 65.66% 8310 requests in 10.04s, 2.04MB read Requests/sec: 827.42 Transfer/sec: 207.95KB \u8fd9\u6837\u5c31\u751f\u6210\u4e86\u6d41\u91cf\u3002 \u63a5\u7740\u8bbf\u95ee Prometheus \u7684\u67e5\u8be2\u754c\u9762\uff0c\u8f93\u4eba\u6211\u4eec\u65b0\u5efa\u7684\u6307\u6807\uff0c\u5c31\u80fd\u770b\u5230\u6307\u6807\u6570\u636e\u4e86\uff08\u6307\u6807\u540d\u79f0\u4f1a\u81ea\u52a8\u52a0\u4eba\u201cistio_\u201d\u524d\u7f00\uff09 \u4e8b\u5b9e\u4e0a\uff0c\u76ee\u524d\u8fd9\u65b9\u9762\u80fd\u591f\u5b9a\u5236\u7684\u5185\u5bb9\u8fd8\u5f88\u6709\u9650\uff0c\u4e3b\u8981\u7684\u5b9a\u5236\u80fd\u529b\u53d6\u51b3\u4e8e Envoy \u548c\u5404\u79cd Mixer \u9002\u914d\u5668\u7684\u8f93\u51fa\u5185\u5bb9\u3002 kubectl -n istio-system port-forward prometheus-d44645598-xh8wn 9090:9090 Forwarding from 127.0.0.1:9090 -> 9090 Forwarding from [::1]:9090 -> 9090 istio_request_total_bytes_bucket","title":"2\u3001 \u81ea\u5b9a\u4e49\u76d1\u63a7\u6307\u6807"},{"location":"chap5/16Istio_Mixer4_stdio/","text":"\u7b2c\u5341\u516d\u8282 \u4f7f\u7528 stdio \u8f93\u51fa\u81ea\u5b9a\u4e49\u65e5\u5fd7 \u5e73\u53f0\u53ca\u8fd0\u884c\u5728\u5e73\u53f0\u4e4b\u4e0a\u7684\u5e94\u7528\u90fd\u4f1a\u6709\u5404\u81ea\u7684\u65e5\u5fd7\u8f93\u51fa , \u4f8b\u5982\uff0c Kubernetes \u4e2d\u5e38\u89c1\u7684\u4e00\u79cd\u65b9\u6848\u5982\u56fe\u6240\u793a\u3002 \u5176\u4e2d \u4e1a\u52a1\u5e94\u7528\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230\u5bb9\u5668\u81ea\u8eab\u7684 stdio \u8bbe\u5907\u4e0a\uff1b \u5bb9\u5668\u5f15\u64ce\u5c06 Pod \u7684 stdio \u6620\u5c04\u5230\u6240\u5728\u8282\u70b9\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff1b Fluentd \u7b49\u65e5\u5fd7\u6293\u53d6\u5de5\u5177 mount \u7684\u65b9\u5f0f\u52a0\u8f7d\u8282\u70b9\u6587\u4ef6\u7cfb\u7edf\uff1b \u65e5\u5fd7\u6293\u53d6\u5de5\u5177\u5728\u5904\u7406\u539f\u59cb\u65e5\u5fd7\u4e4b\u540e\u5c06\u5176\u53d1\u9001\u7ed9 Elasticsearch \u90a3\u4e48\uff0c\u4e3a\u4ec0\u4e48 Mixer \uff1a\u8fd8\u8981\u63d0\u4f9b\u989d\u5916\u7684\u65e5\u5fd7\u80fd\u529b\uff1f \u6709\u65f6\u6211\u4eec\u53ef\u80fd\u9700\u8981\u6839\u636e\u901a\u4fe1\u5185\u5bb9\u505a\u4e00\u4e9b\u8de8\u670d\u52a1\u7684\u65e5\u5fd7\u8bb0\u5f55\uff0c\u8fd9\u79cd\u9700\u6c42\u53ef\u80fd\u662f\u4e34\u63d0\u51fa\u7684\uff0c\u4e5f\u53ef\u80fd\u662f\u8c03\u8bd5\u9700\u8981\u7684\uff0c\u8fc7\u53bb\u5f80\u5f80\u9700\u8981\u901a\u8fc7\u5bf9\u5e94\u7528\u7684\u4ee3\u7801\u8fdb\u884c\u4fee\u6539\u6216\u8005\u91cd\u65b0\u914d\u7f6e\u6765\u5b8c\u6210\uff1b \u800c Istio \u53ef\u4ee5\u5728\u4e0d\u5f71\u54cd\u5e94\u7528\u8fd0\u884c\u7684\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7 Mixer \u7ec4\u4ef6\uff0e\u4f7f\u7528 logentry \u6a21\u677f\u7ed3\u5408 std io \u6216\u8005 Fluentd \u9002\u914d\u5668\u6765\u5b8c\u6210\u8fd9\u4e00\u4efb\u52a1 \u7f51\u683c\u5185\u90e8\u7684\u5e94\u7528\u5728\u901a\u8fc7 Sidecar \u8fdb\u884c\u4e92\u8bbf\u7684\u65f6\u5019, Sidecar \u4f1a\u53d1\u51fa\u62a5\u544a\u7ed9 Mixer Telemetry ,\u5176\u4e2d\u5305\u542b\u5927\u91cf\u7684\u4e0e\u672c\u6b21\u901a\u4fe1\u76f8\u5173\u7684\u4fe1\u606f \u3002 Mixer Telemetry Pod \u5728\u63a5\u6536\u5230\u8fd9\u4e9b\u4fe1\u606f\u4e4b\u540e\uff0c\u4f1a\u67e5\u8be2\u5df2\u6ce8\u518c\u7684 Rule \u5bf9\u8c61\uff0c\u5982\u679c\u6709\u7b26\u5408 match \u8981\u6c42\u7684\u6d41\u91cf\uff0e\u5219\u4f1a\u5c06\u6d41\u91cf\u4fe1\u606f\u8f6c\u53d1\u7ed9 Rule \u5bf9\u8c61\u7684 logentry Instance \u8fdb\u884c\u5904\u7406 \u5904\u7406\u540e\u4ea7\u751f\u7684\u6807\u51c6\u6570\u636e\u4f1a \u4ea4\u7531 stdio \u9002\u914d\u5668\u76f4\u63a5\u663e\u793a\u5728 Mixer Telemetry \u7684 stdio \u8bbe\u5907\u4e0a\uff0c\u53ef\u4ee5\u88ab Kebernetes \u7684\u6807\u51c6\u65e5\u5fd7\u91c7\u96c6\u65b9\u5f0f\u6240\u83b7\u53d6\uff0c \u6216\u8005\u7531 Fluentd \u9002\u914d\u5668\u63d0\u4ea4\u7ed9 Flutend \u8fdb\u7a0b\u8fdb\u884c\u540e\u7eed\u7684\u91c7\u96c6\u8fc7\u7a0b 1\u3001\u9ed8\u8ba4\u7684\u8bbf\u95ee\u65e5\u5fd7 istio \u9ed8\u8ba4\u5728\u5b89\u88c5\u65f6\u63d0\u4f9b accesslog \u548c tcpaccesslog \u4e24\u4e2a logentry \u5b9e\u4f8b \uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf accesslog \u7684\u914d\u7f6e\u65b9\u6cd5\uff1a $ kubectl get logentry -n istio-system NAME SEVERITY TIMESTAMP RES TYPE AGE accesslog \"Info\" request.time \"global\" 16d tcpaccesslog \"Info\" context.time |timestamp(\"2017-01-01T00:00:00Z\") \"global\" 16d $ kubectl get logentry -n istio-system accesslog -oyaml apiVersion: config.istio.io/v1alpha2 kind: logentry metadata: annotations: ... name: accesslog namespace: istio-system ... spec: monitored_resource_type: '\"global\"' severity: '\"Info\"' timestamp: request.time variables: apiClaims: request.auth.raw_claims | \"\" apiKey: request.api_key | request.headers[\"x-api-key\"] | \"\" clientTraceId: request.headers[\"x-client-trace-id\"] | \" ... \u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbf\u95ee\u65e5\u5fd7\u7684\u7ed3\u6784\uff0c\u5176\u4e2d\u9664\u4e86\u5e38\u89c1\u7684\u65e5\u5fd7\u7ea7\u522b\u3001\u65f6\u95f4\u6233\uff0c\u8fd8\u7528 variables \u5b57\u6bb5\u5b9a\u4e49\u4e86\u4e00\u7ec4\u590d\u6742\u7684\u6570\u636e\u7ed3\u6784\u3002 \u518d\u6765\u770b\u770b stdio \u7684\u9002\u914d\u5668\u914d\u7f6e\uff1a $ kubectl get handler stdio -n istio-system -oyaml apiVersion: config.istio.io/v1alpha2 kind: handler metadata: annotations: ... creationTimestamp: \"2019-10-18T09:23:04Z\" generation: 1 labels: app: mixer chart: mixer heritage: Tiller release: istio name: stdio namespace: istio-system resourceVersion: \"39273\" selfLink: /apis/config.istio.io/v1alpha2/namespaces/istio-system/handlers/stdio uid: 2a398bff-838d-44c1-9bfa-248b68a46033 spec: compiledAdapter: stdio params: outputAsJson: true $ kubectl get rule stdio -n istio-system -oyaml apiVersion: config.istio.io/v1alpha2 kind: rule metadata: annotations: ... creationTimestamp: \"2019-10-18T09:23:04Z\" generation: 1 labels: app: mixer chart: mixer heritage: Tiller release: istio name: stdio namespace: istio-system resourceVersion: \"39277\" selfLink: /apis/config.istio.io/v1alpha2/namespaces/istio-system/rules/stdio uid: c3236133-8dfa-46c8-a9d4-e5d1b060ed52 spec: actions: - handler: stdio instances: - accesslog.logentry match: context.protocol == \"http\" || context.protocol == \"grpc\" \u8fd9\u4e2a\u5bf9\u8c61\u4f7f\u7528\u901a\u4fe1\u534f\u8bae\u4f5c\u4e3a\u8fc7\u6ee4\u6807\u51c6\uff0c\u5982\u679c\u901a\u4fe1\u534f\u8bae\u662f HTTP \u6216\u8005 GRPC \uff0c\u5219\u4f7f\u7528 accesslog \u8fdb\u884c\u5904\u7406\uff0c\u6700\u540e\u4f20\u9012\u7ed9 stdio \u9002\u914d\u5668\uff0c\u5e76\u8f93\u51fa\u5230 Mixer \u7684 stdio \u8bbe\u5907\u4e2d \u3002 2\u3001 \u5b9a\u4e49\u65e5\u5fd7\u5bf9\u8c61 \u6709\u4e86\u81ea\u5b9a\u4e49\u65e5\u5fd7\u6761\u76ee\u7684\u80fd\u529b\u6211\u4eec\u5c31\u53ef\u4ee5\u4e13\u95e8\u4e3a sleep \u670d\u52a1\u5bf9\u5176\u4ed6\u670d\u52a1\u7684\u8bbf\u95ee\u8bbe\u7f6e\u4e00\u6761\u65e5\u5fd7, \u8bb0\u5f55\u5176\u6240\u6709\u5916\u53d1\u8bf7\u6c42 \u9996\u5148\u5b9a\u4e49\u4e00\u4e2a logentry \u6a21\u677f\u7684\u5b9e\u4f8b apiVersion: config.istio.io/v1alpha2 kind: logentry metadata: name: sleep-log spec: monitored_resource_type: '\"global\"' severity: '\"Info\"' timestamp: \"request.time\" variables: destinationApp: destination.labels[\"app\"] | \"\" dentinationIp: destination.ip | ip(\"0.0.0.0\") destinationName: destination.name | \"\" destinationNamespace: destination.namespace | \"\" destinationWorkload: destination.workload.name | \"\" message: \"Extra log\" $ kubectl apply -f logentry.yaml logentry.config.istio.io/sleep-log created $ kubectl get logentry NAME SEVERITY TIMESTAMP RES TYPE AGE sleep-log \"Info\" request.time \"global\" 10s \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a longentry \u5bf9\u8c61\u5176\u4e2d\u63cf\u8ff0\u7684\u662f\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\uff0c\u5305\u542b\u4e86\u8c03\u7528\u65f6\u95f4\uff0c\u65e5\u5fd7\u7ea7\u522b\u53ca\u4e00\u7cfb \u5217\u76ee\u6807\u4fe1\u606f\u7684\u76f8\u5173\u53d8\u91cf\u5c06\u5176\u4fdd\u5b58\u4e3a logentry.yaml \u4e95\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4 \u7136\u540e\u5b9a\u4e49\u4e00\u4e2a stdio \u9002\u914d\u5668\u7684 Handler \u6307\u5b9a JSON \u683c\u5f0f\u8f93\u51fa apiVersion: config.istio.io/v1alpha2 kind: stdio metadata: name: handler spec: outputAsJson: true handler.yaml kubectl apply -f handler.yaml handler.config.istio.io/handler created $ kubectl get handler NAME AGE handler 11s \u6700\u540e\u5b9a\u4e49\u4e00\u4e2a Rule \u5bf9\u8c61\uff0c\u52a0\u5165\u5bf9 sleep \u5e94\u7528\u7684\u6761\u4ef6\u9650\u5236\uff0c\u5e76\u628a\u65b0\u5efa\u7acb\u7684 Handler \u548c Instance \u8fdb\u884c\u7ed1\u5b9a\uff1a apiVersion: config.istio.io/v1alpha2 kind: rule metadata: name: stdio spec: actions: - handler: handler.stdio instances: - sleep-log.logentry match: context.protocol == \"http\" && sourceLabel[\"app\"] == \"sleep\" $ kubectl apply -f rule.yaml rule.config.istio.io/stdio created $ kubectl get rule NAME AGE quota 21h stdio 18s 3\u3001 \u6d4b\u8bd5\u8f93\u51fa \u63a5\u4e0b\u6765\u9a8c\u8bc1\u65e5\u5fd7\u662f\u5426\u80fd\u591f\u6210\u529f\u8f93\u51fa\uff1a 3-1 Source sleep-v1 : kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# wrk http://httpbin:8000/ip Running 10s test @ http://httpbin:8000/ip 2 threads and 10 connections Thread Stats Avg Stdev Max +/- Stdev Latency 12.66ms 8.37ms 63.15ms 80.17% Req/Sec 416.32 96.02 653.00 71.72% 8324 requests in 10.06s, 2.04MB read Requests/sec: 827.12 Transfer/sec: 207.86KB \u4f7f\u7528 grep \u8fc7\u6ee4\uff0c\u67e5\u770b itsio-telemetry \u4e2d\u7684\u65e5\u5fd7\uff1a 3-2 Destination itsio-telemetry : $ kubectl get pod -n istio-system | grep istio-telemetry istio-telemetry-7d7845478d-d2h5f 2/2 Running 1 5d1h $ kubectl logs -n istio-system istio-telemetry-7d7845478d-d2h5f -c mixer | grep sleep-log ...... {\"level\" : \"info\", \"time\" : \"2018-12-23T19:05: 06.897249Z\", \"instance\":\"sleep -log.logentry.default\", \"destinationApp\":\"httpbin\", \"destinationIp\" : \"10.244.4 7,9\", \"destinationName\" :\"httpbin-f455f64c4-k4c6x\", \"destinationNamespace\" : \"default\", \"destinationWorkload\" : \"httpbin\" } {\"level\" : \"info\", \"time\" : \"2018-12-23T19:05:06.898289Z\", \"instance\" : \"sleep -log. logentry . default\" \"destinationApp\" : \"httpbin\", \"destinationIp\" : \"10.244.4 7.9\", \"destinationName\" .\"httpbin-f455f64c4-k4c6x\", \"destinationNamespace\" : \"de fault\", \"destinationWorkload\" : \"httpbin\"} ... \u53ef\u4ee5\u770b\u5230\uff0c\u65e5\u5fd7\u5728 Mixer telemetry Po d\u4e2d\u6309\u7167\u6211\u4eec\u5b9a\u4e49\u7684\u6a21\u677f\u5b8c\u6210\u4e86\u8f93\u51fa\u3002\u5982\u679c\u5728\u96c6\u7fa4\u4e2d\u914d\u7f6e\u4e86\u5bb9\u5668\u65e5\u5fd7\u91c7\u96c6\uff0c\u5219\u8fd9\u90e8\u5206\u65e5\u5fd7\u4e5f\u4f1a\u88ab\u8bc6\u522b\u548c\u91c7\u96c6\u3002","title":"\u7b2c\u5341\u516d\u8282 \u4f7f\u7528stdio\u8f93\u51fa\u81ea\u5b9a\u4e49\u65e5\u5fd7"},{"location":"chap5/16Istio_Mixer4_stdio/#stdio","text":"\u5e73\u53f0\u53ca\u8fd0\u884c\u5728\u5e73\u53f0\u4e4b\u4e0a\u7684\u5e94\u7528\u90fd\u4f1a\u6709\u5404\u81ea\u7684\u65e5\u5fd7\u8f93\u51fa , \u4f8b\u5982\uff0c Kubernetes \u4e2d\u5e38\u89c1\u7684\u4e00\u79cd\u65b9\u6848\u5982\u56fe\u6240\u793a\u3002 \u5176\u4e2d \u4e1a\u52a1\u5e94\u7528\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230\u5bb9\u5668\u81ea\u8eab\u7684 stdio \u8bbe\u5907\u4e0a\uff1b \u5bb9\u5668\u5f15\u64ce\u5c06 Pod \u7684 stdio \u6620\u5c04\u5230\u6240\u5728\u8282\u70b9\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff1b Fluentd \u7b49\u65e5\u5fd7\u6293\u53d6\u5de5\u5177 mount \u7684\u65b9\u5f0f\u52a0\u8f7d\u8282\u70b9\u6587\u4ef6\u7cfb\u7edf\uff1b \u65e5\u5fd7\u6293\u53d6\u5de5\u5177\u5728\u5904\u7406\u539f\u59cb\u65e5\u5fd7\u4e4b\u540e\u5c06\u5176\u53d1\u9001\u7ed9 Elasticsearch \u90a3\u4e48\uff0c\u4e3a\u4ec0\u4e48 Mixer \uff1a\u8fd8\u8981\u63d0\u4f9b\u989d\u5916\u7684\u65e5\u5fd7\u80fd\u529b\uff1f \u6709\u65f6\u6211\u4eec\u53ef\u80fd\u9700\u8981\u6839\u636e\u901a\u4fe1\u5185\u5bb9\u505a\u4e00\u4e9b\u8de8\u670d\u52a1\u7684\u65e5\u5fd7\u8bb0\u5f55\uff0c\u8fd9\u79cd\u9700\u6c42\u53ef\u80fd\u662f\u4e34\u63d0\u51fa\u7684\uff0c\u4e5f\u53ef\u80fd\u662f\u8c03\u8bd5\u9700\u8981\u7684\uff0c\u8fc7\u53bb\u5f80\u5f80\u9700\u8981\u901a\u8fc7\u5bf9\u5e94\u7528\u7684\u4ee3\u7801\u8fdb\u884c\u4fee\u6539\u6216\u8005\u91cd\u65b0\u914d\u7f6e\u6765\u5b8c\u6210\uff1b \u800c Istio \u53ef\u4ee5\u5728\u4e0d\u5f71\u54cd\u5e94\u7528\u8fd0\u884c\u7684\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7 Mixer \u7ec4\u4ef6\uff0e\u4f7f\u7528 logentry \u6a21\u677f\u7ed3\u5408 std io \u6216\u8005 Fluentd \u9002\u914d\u5668\u6765\u5b8c\u6210\u8fd9\u4e00\u4efb\u52a1 \u7f51\u683c\u5185\u90e8\u7684\u5e94\u7528\u5728\u901a\u8fc7 Sidecar \u8fdb\u884c\u4e92\u8bbf\u7684\u65f6\u5019, Sidecar \u4f1a\u53d1\u51fa\u62a5\u544a\u7ed9 Mixer Telemetry ,\u5176\u4e2d\u5305\u542b\u5927\u91cf\u7684\u4e0e\u672c\u6b21\u901a\u4fe1\u76f8\u5173\u7684\u4fe1\u606f \u3002 Mixer Telemetry Pod \u5728\u63a5\u6536\u5230\u8fd9\u4e9b\u4fe1\u606f\u4e4b\u540e\uff0c\u4f1a\u67e5\u8be2\u5df2\u6ce8\u518c\u7684 Rule \u5bf9\u8c61\uff0c\u5982\u679c\u6709\u7b26\u5408 match \u8981\u6c42\u7684\u6d41\u91cf\uff0e\u5219\u4f1a\u5c06\u6d41\u91cf\u4fe1\u606f\u8f6c\u53d1\u7ed9 Rule \u5bf9\u8c61\u7684 logentry Instance \u8fdb\u884c\u5904\u7406 \u5904\u7406\u540e\u4ea7\u751f\u7684\u6807\u51c6\u6570\u636e\u4f1a \u4ea4\u7531 stdio \u9002\u914d\u5668\u76f4\u63a5\u663e\u793a\u5728 Mixer Telemetry \u7684 stdio \u8bbe\u5907\u4e0a\uff0c\u53ef\u4ee5\u88ab Kebernetes \u7684\u6807\u51c6\u65e5\u5fd7\u91c7\u96c6\u65b9\u5f0f\u6240\u83b7\u53d6\uff0c \u6216\u8005\u7531 Fluentd \u9002\u914d\u5668\u63d0\u4ea4\u7ed9 Flutend \u8fdb\u7a0b\u8fdb\u884c\u540e\u7eed\u7684\u91c7\u96c6\u8fc7\u7a0b","title":"\u7b2c\u5341\u516d\u8282 \u4f7f\u7528stdio\u8f93\u51fa\u81ea\u5b9a\u4e49\u65e5\u5fd7"},{"location":"chap5/16Istio_Mixer4_stdio/#1","text":"istio \u9ed8\u8ba4\u5728\u5b89\u88c5\u65f6\u63d0\u4f9b accesslog \u548c tcpaccesslog \u4e24\u4e2a logentry \u5b9e\u4f8b \uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf accesslog \u7684\u914d\u7f6e\u65b9\u6cd5\uff1a $ kubectl get logentry -n istio-system NAME SEVERITY TIMESTAMP RES TYPE AGE accesslog \"Info\" request.time \"global\" 16d tcpaccesslog \"Info\" context.time |timestamp(\"2017-01-01T00:00:00Z\") \"global\" 16d $ kubectl get logentry -n istio-system accesslog -oyaml apiVersion: config.istio.io/v1alpha2 kind: logentry metadata: annotations: ... name: accesslog namespace: istio-system ... spec: monitored_resource_type: '\"global\"' severity: '\"Info\"' timestamp: request.time variables: apiClaims: request.auth.raw_claims | \"\" apiKey: request.api_key | request.headers[\"x-api-key\"] | \"\" clientTraceId: request.headers[\"x-client-trace-id\"] | \" ... \u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbf\u95ee\u65e5\u5fd7\u7684\u7ed3\u6784\uff0c\u5176\u4e2d\u9664\u4e86\u5e38\u89c1\u7684\u65e5\u5fd7\u7ea7\u522b\u3001\u65f6\u95f4\u6233\uff0c\u8fd8\u7528 variables \u5b57\u6bb5\u5b9a\u4e49\u4e86\u4e00\u7ec4\u590d\u6742\u7684\u6570\u636e\u7ed3\u6784\u3002 \u518d\u6765\u770b\u770b stdio \u7684\u9002\u914d\u5668\u914d\u7f6e\uff1a $ kubectl get handler stdio -n istio-system -oyaml apiVersion: config.istio.io/v1alpha2 kind: handler metadata: annotations: ... creationTimestamp: \"2019-10-18T09:23:04Z\" generation: 1 labels: app: mixer chart: mixer heritage: Tiller release: istio name: stdio namespace: istio-system resourceVersion: \"39273\" selfLink: /apis/config.istio.io/v1alpha2/namespaces/istio-system/handlers/stdio uid: 2a398bff-838d-44c1-9bfa-248b68a46033 spec: compiledAdapter: stdio params: outputAsJson: true $ kubectl get rule stdio -n istio-system -oyaml apiVersion: config.istio.io/v1alpha2 kind: rule metadata: annotations: ... creationTimestamp: \"2019-10-18T09:23:04Z\" generation: 1 labels: app: mixer chart: mixer heritage: Tiller release: istio name: stdio namespace: istio-system resourceVersion: \"39277\" selfLink: /apis/config.istio.io/v1alpha2/namespaces/istio-system/rules/stdio uid: c3236133-8dfa-46c8-a9d4-e5d1b060ed52 spec: actions: - handler: stdio instances: - accesslog.logentry match: context.protocol == \"http\" || context.protocol == \"grpc\" \u8fd9\u4e2a\u5bf9\u8c61\u4f7f\u7528\u901a\u4fe1\u534f\u8bae\u4f5c\u4e3a\u8fc7\u6ee4\u6807\u51c6\uff0c\u5982\u679c\u901a\u4fe1\u534f\u8bae\u662f HTTP \u6216\u8005 GRPC \uff0c\u5219\u4f7f\u7528 accesslog \u8fdb\u884c\u5904\u7406\uff0c\u6700\u540e\u4f20\u9012\u7ed9 stdio \u9002\u914d\u5668\uff0c\u5e76\u8f93\u51fa\u5230 Mixer \u7684 stdio \u8bbe\u5907\u4e2d \u3002","title":"1\u3001\u9ed8\u8ba4\u7684\u8bbf\u95ee\u65e5\u5fd7"},{"location":"chap5/16Istio_Mixer4_stdio/#2","text":"\u6709\u4e86\u81ea\u5b9a\u4e49\u65e5\u5fd7\u6761\u76ee\u7684\u80fd\u529b\u6211\u4eec\u5c31\u53ef\u4ee5\u4e13\u95e8\u4e3a sleep \u670d\u52a1\u5bf9\u5176\u4ed6\u670d\u52a1\u7684\u8bbf\u95ee\u8bbe\u7f6e\u4e00\u6761\u65e5\u5fd7, \u8bb0\u5f55\u5176\u6240\u6709\u5916\u53d1\u8bf7\u6c42 \u9996\u5148\u5b9a\u4e49\u4e00\u4e2a logentry \u6a21\u677f\u7684\u5b9e\u4f8b apiVersion: config.istio.io/v1alpha2 kind: logentry metadata: name: sleep-log spec: monitored_resource_type: '\"global\"' severity: '\"Info\"' timestamp: \"request.time\" variables: destinationApp: destination.labels[\"app\"] | \"\" dentinationIp: destination.ip | ip(\"0.0.0.0\") destinationName: destination.name | \"\" destinationNamespace: destination.namespace | \"\" destinationWorkload: destination.workload.name | \"\" message: \"Extra log\" $ kubectl apply -f logentry.yaml logentry.config.istio.io/sleep-log created $ kubectl get logentry NAME SEVERITY TIMESTAMP RES TYPE AGE sleep-log \"Info\" request.time \"global\" 10s \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a longentry \u5bf9\u8c61\u5176\u4e2d\u63cf\u8ff0\u7684\u662f\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\uff0c\u5305\u542b\u4e86\u8c03\u7528\u65f6\u95f4\uff0c\u65e5\u5fd7\u7ea7\u522b\u53ca\u4e00\u7cfb \u5217\u76ee\u6807\u4fe1\u606f\u7684\u76f8\u5173\u53d8\u91cf\u5c06\u5176\u4fdd\u5b58\u4e3a logentry.yaml \u4e95\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4 \u7136\u540e\u5b9a\u4e49\u4e00\u4e2a stdio \u9002\u914d\u5668\u7684 Handler \u6307\u5b9a JSON \u683c\u5f0f\u8f93\u51fa apiVersion: config.istio.io/v1alpha2 kind: stdio metadata: name: handler spec: outputAsJson: true handler.yaml kubectl apply -f handler.yaml handler.config.istio.io/handler created $ kubectl get handler NAME AGE handler 11s \u6700\u540e\u5b9a\u4e49\u4e00\u4e2a Rule \u5bf9\u8c61\uff0c\u52a0\u5165\u5bf9 sleep \u5e94\u7528\u7684\u6761\u4ef6\u9650\u5236\uff0c\u5e76\u628a\u65b0\u5efa\u7acb\u7684 Handler \u548c Instance \u8fdb\u884c\u7ed1\u5b9a\uff1a apiVersion: config.istio.io/v1alpha2 kind: rule metadata: name: stdio spec: actions: - handler: handler.stdio instances: - sleep-log.logentry match: context.protocol == \"http\" && sourceLabel[\"app\"] == \"sleep\" $ kubectl apply -f rule.yaml rule.config.istio.io/stdio created $ kubectl get rule NAME AGE quota 21h stdio 18s","title":"2\u3001 \u5b9a\u4e49\u65e5\u5fd7\u5bf9\u8c61"},{"location":"chap5/16Istio_Mixer4_stdio/#3","text":"\u63a5\u4e0b\u6765\u9a8c\u8bc1\u65e5\u5fd7\u662f\u5426\u80fd\u591f\u6210\u529f\u8f93\u51fa\uff1a","title":"3\u3001 \u6d4b\u8bd5\u8f93\u51fa"},{"location":"chap5/16Istio_Mixer4_stdio/#3-1-source-sleep-v1","text":"kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# wrk http://httpbin:8000/ip Running 10s test @ http://httpbin:8000/ip 2 threads and 10 connections Thread Stats Avg Stdev Max +/- Stdev Latency 12.66ms 8.37ms 63.15ms 80.17% Req/Sec 416.32 96.02 653.00 71.72% 8324 requests in 10.06s, 2.04MB read Requests/sec: 827.12 Transfer/sec: 207.86KB \u4f7f\u7528 grep \u8fc7\u6ee4\uff0c\u67e5\u770b itsio-telemetry \u4e2d\u7684\u65e5\u5fd7\uff1a","title":"3-1 Source sleep-v1:"},{"location":"chap5/16Istio_Mixer4_stdio/#3-2-destination-itsio-telemetry","text":"$ kubectl get pod -n istio-system | grep istio-telemetry istio-telemetry-7d7845478d-d2h5f 2/2 Running 1 5d1h $ kubectl logs -n istio-system istio-telemetry-7d7845478d-d2h5f -c mixer | grep sleep-log ...... {\"level\" : \"info\", \"time\" : \"2018-12-23T19:05: 06.897249Z\", \"instance\":\"sleep -log.logentry.default\", \"destinationApp\":\"httpbin\", \"destinationIp\" : \"10.244.4 7,9\", \"destinationName\" :\"httpbin-f455f64c4-k4c6x\", \"destinationNamespace\" : \"default\", \"destinationWorkload\" : \"httpbin\" } {\"level\" : \"info\", \"time\" : \"2018-12-23T19:05:06.898289Z\", \"instance\" : \"sleep -log. logentry . default\" \"destinationApp\" : \"httpbin\", \"destinationIp\" : \"10.244.4 7.9\", \"destinationName\" .\"httpbin-f455f64c4-k4c6x\", \"destinationNamespace\" : \"de fault\", \"destinationWorkload\" : \"httpbin\"} ... \u53ef\u4ee5\u770b\u5230\uff0c\u65e5\u5fd7\u5728 Mixer telemetry Po d\u4e2d\u6309\u7167\u6211\u4eec\u5b9a\u4e49\u7684\u6a21\u677f\u5b8c\u6210\u4e86\u8f93\u51fa\u3002\u5982\u679c\u5728\u96c6\u7fa4\u4e2d\u914d\u7f6e\u4e86\u5bb9\u5668\u65e5\u5fd7\u91c7\u96c6\uff0c\u5219\u8fd9\u90e8\u5206\u65e5\u5fd7\u4e5f\u4f1a\u88ab\u8bc6\u522b\u548c\u91c7\u96c6\u3002","title":"3-2 Destination itsio-telemetry:"},{"location":"chap5/17Istio_Mixer5_fluentd/","text":"\u7b2c\u5341\u4e03\u8282 \u4f7f\u7528Fluentd\u8f93\u51fa\u65e5\u5fd7 \u5411 Mixer Telemetry \u7684 stdio \u8f93\u51fa\u65e5\u5fd7\u7684\u65b9\u6cd5\uff0c\u7136\u800c Mixer \u672c\u8eab\u5df2\u7ecf\u662f\u4e2a\u91cd\u8d1f\u8f7d\u7ec4\u4ef6\uff0c\u5982\u679c\u65e5\u5fd7\u8f93\u51fa\u91cf\u8f83\u5927\uff0c\u5219\u4f1a\u9020\u6210\u5927\u91cf\u7684 I/O \u8d1f\u8f7d\u3002\u56e0\u6b64\uff0c\u5c06\u8f93\u51fa\u65e5\u5fd7\u7684\u5de5\u4f5c\u4ea4\u7ed9 Fluentd \u53ef\u80fd\u662f\u4e2a\u66f4\u597d\u7684\u9009\u62e9\u3002 \u8fd9\u91cc\u505a\u4e00\u4e2a\u7b80\u5355\u7684 Fluentd \u7684 Deployment \u548c Service \u90e8\u7f72\uff0c\u5c1d\u8bd5\u5c06\u81ea\u5b9a\u4e49\u65e5\u5fd7\u8f93\u51fa\u5230 Fluentd \u4e2d\u3002 1\u3001 \u90e8\u7f72 Fluentd \u9996\u5148\u521b\u5efa Fluentd \u7684 Deployment \u548c Service \uff0c\u7528\u4e8e\u63a5\u6536\u65e5\u5fd7\uff1a # Fluentd Service apiVersion: v1 kind: Service metadata: name: fluentd-listener labels: app: fluentd-listener spec: ports: - name: fluentd-tcp port: 24224 protocol: TCP targetPort: 24224 - name: fluentd-udp port: 24224 protocol: UDP targetPort: 24224 selector: app: fluentd-listener --- # Fluentd Deployment apiVersion: apps/v1 kind: Deployment metadata: name: fluentd-listener labels: app: fluentd-listener spec: replicas: 1 selector: matchLabels: app: fluentd-listener template: metadata: labels: app: fluentd-listener annotations: sidecar.istio.io/inject: \"false\" spec: containers: - name: fluentd-listener image: rocklviv/fluentd $ kubectl get pod | grep fluentd fluentd-listener-76dcb45f49-74pqz 1/1 Running 0 63s handler apiVersion: config.istio.io/v1alpha2 kind: fluentd metadata: name: handler spec: address: \"fluentd-listener:24224\" $ kubectl apply -f fluentd.handler.yaml fluentd.config.istio.io/handler created \u5c06\u4fdd\u5b58\u4e3a fluentd.handler.yaml \uff0c\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u9002\u914d\u5668\u7684\u914d\u7f6e\u5f88\u7b80\u5355\uff0c \u53ea\u8981\u6307\u5b9a\u4e00\u4e2a\u5730\u5740\u5373\u53ef\uff0c\u8fd9\u91cc\u4f7f\u7528\u4e86\u6211\u4eec \u7136\u540e\u76f4\u63a5\u4f7f\u7528\u5728\u4e0a\u4e00\u8282\u4e2d\u5b9a\u4e49\u7684 logentry.yaml $ kubectl apply -f logentry.yaml logentry.config.istio.io/sleep-log created \u6700\u540e\u4f7f\u7528 Rule \u5bf9\u8c61\u5c06 handler \u548c sleep-log \u4e24\u4e2a\u5bf9\u8c61\u8fde\u63a5\u8d77\u6765 \uff1a apiVersion: config.istio.io/v1alpha2 kind: rule metadata: name: fluentd spec: actions: - handler: handler.fluentd instances: - sleep-log.logentry match: context.protocol == \"http\" && sourceLabel[\"app\"] == \"sleep\" fluentd-rule.yaml $ kubectl apply -f fluentd-rule.yaml rule.config.istio.io/fluentd created 2\u3001 \u6d4b\u8bd5\u8f93\u51fa \u63a5\u4e0b\u6765\u9a8c\u8bc1\u65e5\u5fd7\u662f\u5426\u80fd\u591f\u6210\u529f\u8f93\u51fa\uff1a 2-1 Source sleep-v1 : kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } \u8fd9\u91cc\u5728 sleep Pod \u4e2d\u53d1\u51fa HTT P\u8bf7\u6c42\uff0c\u8be5\u901a\u4fe1\u7b26\u5408 Rule \u5bf9\u8c61\u7684\u8981\u6c42\uff0c\u5e94\u8be5\u51fa\u73b0\u5728\u65e5\u5fd7\u4e2d\u3002 \u63a5\u4e0b\u6765\u67e5\u770b Fluentd Pod \u4e2d\u7684\u8f93\u51fa\uff1a $ kuebctl logs fluentd-listener-76dcb45f49-74pqz ... 1 2018-12-27 19:54:44.000000000 +0000 sleep-log.logentry.default: {\"severity\":\"info\",\"destinationName\":\"httpbin-7d67ccc9b-sdp8n\",\"destinatio Namespace\":\"default\",\"destinationWorkload\":\"httpbin\",\"destinationApp\":\"htt bin\",\"destinationIp\":[0,0,0,0,0,0,0,0,0,0,255,255,10,244,30,9]} \u53ef\u4ee5\u770b\u5230, Fluentd \u6210\u529f\u63a5\u6536\u5230\u4e86\u65e5\u5fd7\u5185\u5bb9\uff0c\u5176\u4e2d\u7684\u5185\u5bb9\u4e5f\u7b26\u5408\u6211\u4eec\u5bf9 logentry \u5bf9\u8c61\u7684\u5b9a\u4e49, \u6240\u4ee5\uff0c\u4f7f\u7528 Fluentd \u4ee3\u66ff Mixer Telementry \u8fdb\u884c\u65e5\u5fd7\u91c7\u96c6\u662f\u5b8c\u5168\u53ef\u884c\u7684","title":"\u7b2c\u5341\u4e03\u8282 \u4f7f\u7528Fluentd\u8f93\u51fa\u65e5\u5fd7"},{"location":"chap5/17Istio_Mixer5_fluentd/#fluentd","text":"\u5411 Mixer Telemetry \u7684 stdio \u8f93\u51fa\u65e5\u5fd7\u7684\u65b9\u6cd5\uff0c\u7136\u800c Mixer \u672c\u8eab\u5df2\u7ecf\u662f\u4e2a\u91cd\u8d1f\u8f7d\u7ec4\u4ef6\uff0c\u5982\u679c\u65e5\u5fd7\u8f93\u51fa\u91cf\u8f83\u5927\uff0c\u5219\u4f1a\u9020\u6210\u5927\u91cf\u7684 I/O \u8d1f\u8f7d\u3002\u56e0\u6b64\uff0c\u5c06\u8f93\u51fa\u65e5\u5fd7\u7684\u5de5\u4f5c\u4ea4\u7ed9 Fluentd \u53ef\u80fd\u662f\u4e2a\u66f4\u597d\u7684\u9009\u62e9\u3002 \u8fd9\u91cc\u505a\u4e00\u4e2a\u7b80\u5355\u7684 Fluentd \u7684 Deployment \u548c Service \u90e8\u7f72\uff0c\u5c1d\u8bd5\u5c06\u81ea\u5b9a\u4e49\u65e5\u5fd7\u8f93\u51fa\u5230 Fluentd \u4e2d\u3002","title":"\u7b2c\u5341\u4e03\u8282 \u4f7f\u7528Fluentd\u8f93\u51fa\u65e5\u5fd7"},{"location":"chap5/17Istio_Mixer5_fluentd/#1-fluentd","text":"\u9996\u5148\u521b\u5efa Fluentd \u7684 Deployment \u548c Service \uff0c\u7528\u4e8e\u63a5\u6536\u65e5\u5fd7\uff1a # Fluentd Service apiVersion: v1 kind: Service metadata: name: fluentd-listener labels: app: fluentd-listener spec: ports: - name: fluentd-tcp port: 24224 protocol: TCP targetPort: 24224 - name: fluentd-udp port: 24224 protocol: UDP targetPort: 24224 selector: app: fluentd-listener --- # Fluentd Deployment apiVersion: apps/v1 kind: Deployment metadata: name: fluentd-listener labels: app: fluentd-listener spec: replicas: 1 selector: matchLabels: app: fluentd-listener template: metadata: labels: app: fluentd-listener annotations: sidecar.istio.io/inject: \"false\" spec: containers: - name: fluentd-listener image: rocklviv/fluentd $ kubectl get pod | grep fluentd fluentd-listener-76dcb45f49-74pqz 1/1 Running 0 63s","title":"1\u3001 \u90e8\u7f72Fluentd"},{"location":"chap5/17Istio_Mixer5_fluentd/#handler","text":"apiVersion: config.istio.io/v1alpha2 kind: fluentd metadata: name: handler spec: address: \"fluentd-listener:24224\" $ kubectl apply -f fluentd.handler.yaml fluentd.config.istio.io/handler created \u5c06\u4fdd\u5b58\u4e3a fluentd.handler.yaml \uff0c\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u9002\u914d\u5668\u7684\u914d\u7f6e\u5f88\u7b80\u5355\uff0c \u53ea\u8981\u6307\u5b9a\u4e00\u4e2a\u5730\u5740\u5373\u53ef\uff0c\u8fd9\u91cc\u4f7f\u7528\u4e86\u6211\u4eec \u7136\u540e\u76f4\u63a5\u4f7f\u7528\u5728\u4e0a\u4e00\u8282\u4e2d\u5b9a\u4e49\u7684 logentry.yaml $ kubectl apply -f logentry.yaml logentry.config.istio.io/sleep-log created \u6700\u540e\u4f7f\u7528 Rule \u5bf9\u8c61\u5c06 handler \u548c sleep-log \u4e24\u4e2a\u5bf9\u8c61\u8fde\u63a5\u8d77\u6765 \uff1a apiVersion: config.istio.io/v1alpha2 kind: rule metadata: name: fluentd spec: actions: - handler: handler.fluentd instances: - sleep-log.logentry match: context.protocol == \"http\" && sourceLabel[\"app\"] == \"sleep\" fluentd-rule.yaml $ kubectl apply -f fluentd-rule.yaml rule.config.istio.io/fluentd created","title":"handler"},{"location":"chap5/17Istio_Mixer5_fluentd/#2","text":"\u63a5\u4e0b\u6765\u9a8c\u8bc1\u65e5\u5fd7\u662f\u5426\u80fd\u591f\u6210\u529f\u8f93\u51fa\uff1a","title":"2\u3001 \u6d4b\u8bd5\u8f93\u51fa"},{"location":"chap5/17Istio_Mixer5_fluentd/#2-1-source-sleep-v1","text":"kubectl exec sleep-v1-548d87cc5c-92lqk -it bash -c sleep bash-4.4# http --body http://httpbin:8000/ip { \"origin\": \"127.0.0.1\" } \u8fd9\u91cc\u5728 sleep Pod \u4e2d\u53d1\u51fa HTT P\u8bf7\u6c42\uff0c\u8be5\u901a\u4fe1\u7b26\u5408 Rule \u5bf9\u8c61\u7684\u8981\u6c42\uff0c\u5e94\u8be5\u51fa\u73b0\u5728\u65e5\u5fd7\u4e2d\u3002 \u63a5\u4e0b\u6765\u67e5\u770b Fluentd Pod \u4e2d\u7684\u8f93\u51fa\uff1a $ kuebctl logs fluentd-listener-76dcb45f49-74pqz ... 1 2018-12-27 19:54:44.000000000 +0000 sleep-log.logentry.default: {\"severity\":\"info\",\"destinationName\":\"httpbin-7d67ccc9b-sdp8n\",\"destinatio Namespace\":\"default\",\"destinationWorkload\":\"httpbin\",\"destinationApp\":\"htt bin\",\"destinationIp\":[0,0,0,0,0,0,0,0,0,0,255,255,10,244,30,9]} \u53ef\u4ee5\u770b\u5230, Fluentd \u6210\u529f\u63a5\u6536\u5230\u4e86\u65e5\u5fd7\u5185\u5bb9\uff0c\u5176\u4e2d\u7684\u5185\u5bb9\u4e5f\u7b26\u5408\u6211\u4eec\u5bf9 logentry \u5bf9\u8c61\u7684\u5b9a\u4e49, \u6240\u4ee5\uff0c\u4f7f\u7528 Fluentd \u4ee3\u66ff Mixer Telementry \u8fdb\u884c\u65e5\u5fd7\u91c7\u96c6\u662f\u5b8c\u5168\u53ef\u884c\u7684","title":"2-1 Source sleep-v1:"},{"location":"chap5/18Istio_Sec1/","text":"\u7b2c\u5341\u516b\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa\uff08\u542f\u7528mTLS\\\u52a0\u56fa\u6982\u8ff0) Istio \u4e3a\u8fd0\u884c\u5728\u4e0d\u53ef\u4fe1\u73af\u5883\u5185\u7684\u670d\u52a1\u7f51\u683c\u63d0\u4f9b\u65e0\u987b\u4ee3\u7801\u4fb5\u5165\u7684\u5b89\u5168\u52a0\u56fa\u80fd\u529b\u3002 \u5728\u5b8c\u6210\u5fae\u670d\u52a1\u6539\u9002\u4e4b\u540e\uff0c\u5728\u6d41\u91cf\u3001\u76d1\u63a7\u7b49\u57fa\u672c\u4e1a\u52a1\u76ee\u6807\u4e4b\u5916\uff0c\u5b89\u5168\u95ee\u9898\u4f1a\u9010\u6e10\u51f8\u663e \u539f\u672c\u5728\u5355\u4f53\u5e94\u7528\u5185\u901a\u8fc7\u8fdb\u7a0b\u5185\u8bbf\u95ee\u63a7\u5236\u63a7\u5236\u6846\u67b6\u5b8c\u6210\u7684\u4efb\u52a1\uff0c\u88ab\u5206\u6563\u5230\u5404\u4e2a\u5fae\u670d\u52a1\u4e2d \u5728\u5bb9\u5668\u96c6\u7fa4\u4e2d\u8fd8\u53ef\u80fd\u51fa\u73b0\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u53ca\u4e0d\u540c\u4e1a\u52a1\u57df\u7684\u8bbf\u95ee\u95ee\u9898 \u5728 Istio \u4e2d\u4e5f\u63d0\u4f9b\u4e86\u65e0\u4fb5\u5165\u7684\u5b89\u5168\u89e3\u51b3\u65b9\u6848\uff0c\u80fd\u591f\u63d0\u4f9b\u7f51\u683c\u5185\u90e8\u3001\u7f51\u683c\u548c\u8fb9\u7f18\u4e4b\u95f4\u7684\u5b89\u5168\u901a\u4fe1\u548c\u8bbf\u95ee\u63a7\u5236\u80fd\u529b\u3002 1\u3001Istio\u5b89\u5168\u52a0\u56fa\u6982\u8ff0 \u5b89\u5168\u52a0\u56fa\u80fd\u529b\u662f Istio \u5404\u4e2a\u7ec4\u4ef6\u534f\u4f5c\u5b8c\u6210\u7684\uff0c\u5982\u4e0b\u6240\u8ff0\uff1a Citadel \u63d0\u4f9b\u8bc1\u4e66\u548c\u8ba4\u8bc1\u7ba1\u7406\u529f\u80fd Sidecar \u5efa\u7acb\u52a0\u5bc6\u901a\u9053\uff0c\u4e3a\u5176\u4ee3\u7406\u7684\u5e94\u7528\u8fdb\u884c\u534f\u8bae\u5347\u7ea7\uff0c\u4e3a\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4e4b\u95f4\u63d0\u4f9b\u57fa\u4e8e mTLS \u7684\u52a0\u5bc6\u901a\u4fe1\uff1b Pilot \u8d1f\u8d23\u4f20\u64ad\u52a0\u5bc6\u8eab\u4efd\u548c\u8ba4\u8bc1\u7b56\u7565\u3002 \u603b\u4f53\u7684\u534f\u4f5c\u5173\u7cfb\u5927\u81f4\u5982\u56fe \u5176\u4e2d\uff1a Citadel \u4f1a\u76d1\u63a7 Kubernetes API Server \uff0c\u4e3a\u73b0\u5b58\u548c\u65b0\u5efa\u7684 Service Account \u7b7e\u53d1 \u8bc1\u4e66\uff0c\u5e76\u5c06\u5176\u4fdd\u5b58\u5728 Secret \u4e2d\uff0c\u5728 Pod \u542f\u52a8\u52a0\u8f7d\u65f6\u4f1a\u52a0\u8f7d\u8fd9\u4e9b Secret ; Pilot \u4f1a\u5c06\u8ba4\u8bc1\u76f8\u5173\u7684\u7b56\u7565\u53d1\u9001\u7ed9 Sidecar \uff0c\u5e76\u4e14\u7528\u76ee\u6807\u89c4\u5219\u6765\u4fdd\u969c\u5b9e\u65bd\u8fc7\u7a0b \uff1b \u4e1a\u52a1\u5bb9\u5668\u548c Sidecar \uff1a\u4e4b\u95f4\u7684\u660e\u6587\u901a\u4fe1\u4f1a\u88ab\u5347\u7ea7\u4e3a Sidecar \u4e4b\u95f4\u7684 mTLS \u901a\u4fe1\u3002 \u672c\u7ae0\u540c\u6837\u4f1a\u9009\u62e9\u4e24\u4e2a\u5178\u578b\u573a\u666f\u6765\u5c55\u793a Istio \u7684\u5b89\u5168\u52a0\u56fa\u80fd\u529b\u3002 2\u3001\u542f\u7528mTLS \u9996\u5148\u542f\u7528\u5168\u5c40 mTLS \u6765\u67e5\u770b\u6548\u679c\u3002 \u521b\u5efa\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u5206\u522b\u5c06\u5176\u547d\u540d\u4e3a mesh \u548c plain \uff0c\u5e76\u4e14\u4e3a mesh \u547d\u540d\u7a7a\u95f4\u5f00\u542f Istio sidecar \u81ea\u52a8\u6ce8\u5165\u529f\u80fd\uff1a $ kubectl create ns mesh namespace/mesh created $ kubectl create ns plain namespace/plain created $ kubectl label namespace mesh istio-injection=enabled namespace/mesh labeled \u63a5\u4e0b\u6765\u5206\u522b\u5728\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u6211\u4eec\u7684 Sleep \u548c httpbin \u5e94\u7528 $ kubectl apply -f sleep.istio.yaml -n mesh service/sleep created deployment.extensions/sleep-v1 created deployment.extensions/sleep-v2 created $ kubectl apply -f sleep.istio.yaml -n plain service/sleep created deployment.extensions/sleep-v1 created deployment.extensions/sleep-v2 created $ cd Istio/istio-1.1.16/samples/httpbin $ kubectl apply -f httpbin.yaml -n mesh service/httpbin created deployment.extensions/httpbin created $ kubectl apply -f httpbin.yaml -n plain service/httpbin created deployment.extensions/httpbin created \u5728\u90e8\u7f72\u5b8c\u6210\u4e4b\u540e\uff0c \u6709\u4e24\u7ec4\u5e94\u7528\u5728\u540c\u65f6\u8fd0\u884c\u8fd9\u4e24\u7ec4\u5e94\u7528\u5206\u522b\u5904\u4e8e\u7f51\u683c\u7684\u5185\u90e8\u548c\u5916\u90e8 , \u6211\u4eec\u5c1d\u8bd5\u8ba9\u4e8c\u8005\u4e92\u8bbf PLAIN_SLEEP $ kubectl get pods -n plain | grep sleep-v1 sleep-v1-548d87cc5c-gjqf4 1/1 Running 0 5m39s MESH_SLEEP $ kubectl get pods -n mesh | grep sleep-v1 sleep-v1-548d87cc5c-6vxmn 2/2 Running 0 6m23s $ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 387 content-type: application/json date: Tue, 05 Nov 2019 03:02:54 GMT server: istio-envoy x-envoy-decorator-operation: httpbin.mesh.svc.cluster.local:8000/* x-envoy-upstream-service-time: 3 ... }, \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin.mesh:8000/get\" } \u53ef\u4ee5\u770b\u5230 , \u6b64\u65f6\u7531\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1, \u4ee5\u53ca\u7531\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1, \u90fd\u662f\u6ca1\u6709\u95ee\u9898\u7684 \u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a MeshPolicy , \u5f3a\u5236\u7f51\u683c\u5185\u90e8\u7684\u6240\u6709\u670d\u52a1\u90fd\u9ed8\u8ba4\u5f00\u542f mTLS apiVersion: \"authentication.istio.io/v1alpha1\" kind: \"MeshPolicy\" metadata: name: \"default\" spec: peers: - mtls: {} $ kubectl apply -f meshpolicy.yaml meshpolicy.authentication.istio.io/default configured \u5728\u9ed8\u8ba4\u7b56\u7565\u521b\u5efa\u4e4b\u540e, \u91cd\u65b0\u5c1d\u8bd5\u521a\u624d\u7684\u4e92\u8bbf $ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get http: error: ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) while doing GET request to URL: http://httpbin.mesh:8000/get $ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn -c sleep bash bash-4.4# http http://httpbin.plain:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 855 content-type: application/json date: Tue, 05 Nov 2019 03:12:50 GMT server: envoy x-envoy-upstream-service-time: 3 ... } \u8fd9\u6b21\u53d1\u73b0\uff0c \u7531\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u53d1\u751f\u5931\u8d25 \u800c\u7531\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u53ef\u4ee5\u6b63\u5e38\u5b8c\u6210 \u540c\u4e00\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\uff0c \u7ed3\u679c\u4f1a\u662f\u600e\u6837\u5462\uff1f $ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get HTTP/1.1 503 Service Unavailable content-length: 95 content-type: text/plain date: Tue, 05 Nov 2019 03:12:34 GMT server: envoy upstream connect error or disconnect/reset before headers. reset reason: connection termination \u53ef\u4ee5\u53d1\u73b0\uff0c \u5373\u4fbf\u662f\u540c\u4e00\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\uff0c \u4e5f\u8fd8\u662f\u51fa\u4e86\u4e86\u95ee\u9898\u3002 \u8fd9\u662f\u56e0\u4e3a\u6240\u6709\u7684\u670d\u52a1\u7aef Sidecar \u90fd\u53ea\u63a5\u53d7 mTLS \u5ba2\u6237\u7aef\u7684\u63a5\u5165\uff0c\u5ba2\u6237\u7aef\u5374\u6ca1\u6709\u968f\u4e4b\u53d8\u5316\uff0c \u8981\u5e94\u5bf9\u8fd9\u79cd\u7684\u60c5\u51b5\uff0c \u5c31\u53ef\u4ee5\u4f7f\u7528 DestinationRule \u5bf9\u8c61\u6765\u663e\u793a\u58f0\u660e\u8fd9\u4e2a\u8981\u6c42 destinationrule.mtls.yaml apiVersion: networking.istio.io/v1alpha3 kind: \"DestinationRule\" metadata: name: \"httpbin\" namespace: mesh spec: host: httpbin.mesh.svc.cluster.local trafficPolicy: tls: mode: ISTIO_MUTUAL \u6ce8\u610f DestinationRule \u7684 namespace $ kubectl apply -f destinationrule.mtls.yaml destinationrule.networking.istio.io/httpbin created $ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get http: error: ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) while doing GET request to URL: http://httpbin.mesh:8000/get $ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn -c sleep bash bash-4.4# http http://httpbin:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 632 content-type: application/json date: Tue, 05 Nov 2019 05:43:20 GMT server: envoy x-envoy-upstream-service-time: 17 ... \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin:8000/get\" } \u53ef\u4ee5\u770b\u5230\uff0c\u6765\u81ea pain \u547d\u540d\u7a7a\u95f4\u7684\u8bbf\u95ee\u4f9d\u7136\u662f\u65e0\u6cd5\u5b8c\u6210\u7684\uff0c\u4f46\u662f\u5728\u5f00\u542f\u4e86 DestinationRule\u4e4b \u540e\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u5c31\u6062\u590d\u6b63\u5e38\u4e86 \u3002 \u5982\u6b64\u4e00\u6765\uff0c\u901a\u8fc7\u7b80\u5355\u7684 Policy \u548c DestinationRule \u5bf9\u8c61\u5b9a\u4e49\uff0c\u6211\u4eec\u5728\u5e94\u7528\u7a0b\u5e8f\u4e0d\u6539\u52a8, \u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\u5c06\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u95f4\u7684\u901a\u4fe1\u534f\u8bae\u4ece\u660e\u6587\u4f20\u8f93\u5347\u7ea7\u4e3a mTLS \u52a0\u5bc6 , \u5e76\u9650\u5236\u4e86\u5916\u90e8\u7684\u660e\u6587\u8bbf\u95ee \u3002 \u90a3\u4e48\uff0c \u5982\u679c\u53ea\u60f3\u542f\u7528 mTLS \u4f5c\u4e3a RBAC \u7684\u524d\u63d0\uff0c\u4f46\u662f\u5bf9\u5916\u90e8\u670d\u52a1\u65f6\u4e0d\u5e0c\u671b\u8bbf\u95ee\u53d7\u5230\u9650\u5236\u5219\u8be5\u5982\u4f55\u5b8c\u6210\u5462\uff1f \u53ea\u9700\u4fee\u6539\u4e00\u4e0b\u6211\u4eec\u7684 Mesh Policy apiVersion: \"authentication.istio.io/v1alpha1\" kind: \"MeshPolicy\" metadata: name: \"default\" spec: peers: # - mtls: {} - mtls: mode: PERMISSIVE \u4e3a mtls \u5b57\u6bb5\u52a0\u4eba mode:PERMISSIVE \u91cd\u65b0\u63d0\u4ea4 $ kubectl apply -f meshpolicy.yaml -n mesh meshpolicy.authentication.istio.io/default configured \u518d\u6b21\u4ece plain \u547d\u540d\u7a7a\u95f4\u53d1\u8d77\u8bbf\u95ee $ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 387 content-type: application/json date: Tue, 05 Nov 2019 05:52:33 GMT server: istio-envoy x-envoy-decorator-operation: httpbin.mesh.svc.cluster.local:8000/* x-envoy-upstream-service-time: 1 ... } $ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn -c sleep bash bash-4.4# http http://httpbin.plain:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true ... \u53ef\u4ee5\u770b\u5230\uff0c\u591a\u4e2a\u65b9\u5411\u7684\u4e92\u8bbf\u4e5f\u90fd\u6ca1\u6709\u95ee\u9898\uff0c\u8fd9\u79cd\u5bbd\u5bb9\u6a21\u5f0f\u5bf9\u4e8e\u8bd5\u70b9\u548c\u8fc1\u79fb\u8fc7\u7a0b\u4e2d\u7684\u6df7\u5408\u90e8\u7f72\u662f\u975e\u5e38\u6709\u5e2e\u52a9\u7684\u3002","title":"\u7b2c\u5341\u516b\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa\uff08\u542f\u7528mTLS\\\u52a0\u56fa\u6982\u8ff0)"},{"location":"chap5/18Istio_Sec1/#istiomtls","text":"Istio \u4e3a\u8fd0\u884c\u5728\u4e0d\u53ef\u4fe1\u73af\u5883\u5185\u7684\u670d\u52a1\u7f51\u683c\u63d0\u4f9b\u65e0\u987b\u4ee3\u7801\u4fb5\u5165\u7684\u5b89\u5168\u52a0\u56fa\u80fd\u529b\u3002 \u5728\u5b8c\u6210\u5fae\u670d\u52a1\u6539\u9002\u4e4b\u540e\uff0c\u5728\u6d41\u91cf\u3001\u76d1\u63a7\u7b49\u57fa\u672c\u4e1a\u52a1\u76ee\u6807\u4e4b\u5916\uff0c\u5b89\u5168\u95ee\u9898\u4f1a\u9010\u6e10\u51f8\u663e \u539f\u672c\u5728\u5355\u4f53\u5e94\u7528\u5185\u901a\u8fc7\u8fdb\u7a0b\u5185\u8bbf\u95ee\u63a7\u5236\u63a7\u5236\u6846\u67b6\u5b8c\u6210\u7684\u4efb\u52a1\uff0c\u88ab\u5206\u6563\u5230\u5404\u4e2a\u5fae\u670d\u52a1\u4e2d \u5728\u5bb9\u5668\u96c6\u7fa4\u4e2d\u8fd8\u53ef\u80fd\u51fa\u73b0\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u53ca\u4e0d\u540c\u4e1a\u52a1\u57df\u7684\u8bbf\u95ee\u95ee\u9898 \u5728 Istio \u4e2d\u4e5f\u63d0\u4f9b\u4e86\u65e0\u4fb5\u5165\u7684\u5b89\u5168\u89e3\u51b3\u65b9\u6848\uff0c\u80fd\u591f\u63d0\u4f9b\u7f51\u683c\u5185\u90e8\u3001\u7f51\u683c\u548c\u8fb9\u7f18\u4e4b\u95f4\u7684\u5b89\u5168\u901a\u4fe1\u548c\u8bbf\u95ee\u63a7\u5236\u80fd\u529b\u3002","title":"\u7b2c\u5341\u516b\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa\uff08\u542f\u7528mTLS\\\u52a0\u56fa\u6982\u8ff0)"},{"location":"chap5/18Istio_Sec1/#1istio","text":"\u5b89\u5168\u52a0\u56fa\u80fd\u529b\u662f Istio \u5404\u4e2a\u7ec4\u4ef6\u534f\u4f5c\u5b8c\u6210\u7684\uff0c\u5982\u4e0b\u6240\u8ff0\uff1a Citadel \u63d0\u4f9b\u8bc1\u4e66\u548c\u8ba4\u8bc1\u7ba1\u7406\u529f\u80fd Sidecar \u5efa\u7acb\u52a0\u5bc6\u901a\u9053\uff0c\u4e3a\u5176\u4ee3\u7406\u7684\u5e94\u7528\u8fdb\u884c\u534f\u8bae\u5347\u7ea7\uff0c\u4e3a\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4e4b\u95f4\u63d0\u4f9b\u57fa\u4e8e mTLS \u7684\u52a0\u5bc6\u901a\u4fe1\uff1b Pilot \u8d1f\u8d23\u4f20\u64ad\u52a0\u5bc6\u8eab\u4efd\u548c\u8ba4\u8bc1\u7b56\u7565\u3002 \u603b\u4f53\u7684\u534f\u4f5c\u5173\u7cfb\u5927\u81f4\u5982\u56fe \u5176\u4e2d\uff1a Citadel \u4f1a\u76d1\u63a7 Kubernetes API Server \uff0c\u4e3a\u73b0\u5b58\u548c\u65b0\u5efa\u7684 Service Account \u7b7e\u53d1 \u8bc1\u4e66\uff0c\u5e76\u5c06\u5176\u4fdd\u5b58\u5728 Secret \u4e2d\uff0c\u5728 Pod \u542f\u52a8\u52a0\u8f7d\u65f6\u4f1a\u52a0\u8f7d\u8fd9\u4e9b Secret ; Pilot \u4f1a\u5c06\u8ba4\u8bc1\u76f8\u5173\u7684\u7b56\u7565\u53d1\u9001\u7ed9 Sidecar \uff0c\u5e76\u4e14\u7528\u76ee\u6807\u89c4\u5219\u6765\u4fdd\u969c\u5b9e\u65bd\u8fc7\u7a0b \uff1b \u4e1a\u52a1\u5bb9\u5668\u548c Sidecar \uff1a\u4e4b\u95f4\u7684\u660e\u6587\u901a\u4fe1\u4f1a\u88ab\u5347\u7ea7\u4e3a Sidecar \u4e4b\u95f4\u7684 mTLS \u901a\u4fe1\u3002 \u672c\u7ae0\u540c\u6837\u4f1a\u9009\u62e9\u4e24\u4e2a\u5178\u578b\u573a\u666f\u6765\u5c55\u793a Istio \u7684\u5b89\u5168\u52a0\u56fa\u80fd\u529b\u3002","title":"1\u3001Istio\u5b89\u5168\u52a0\u56fa\u6982\u8ff0"},{"location":"chap5/18Istio_Sec1/#2mtls","text":"\u9996\u5148\u542f\u7528\u5168\u5c40 mTLS \u6765\u67e5\u770b\u6548\u679c\u3002 \u521b\u5efa\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u5206\u522b\u5c06\u5176\u547d\u540d\u4e3a mesh \u548c plain \uff0c\u5e76\u4e14\u4e3a mesh \u547d\u540d\u7a7a\u95f4\u5f00\u542f Istio sidecar \u81ea\u52a8\u6ce8\u5165\u529f\u80fd\uff1a $ kubectl create ns mesh namespace/mesh created $ kubectl create ns plain namespace/plain created $ kubectl label namespace mesh istio-injection=enabled namespace/mesh labeled \u63a5\u4e0b\u6765\u5206\u522b\u5728\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u6211\u4eec\u7684 Sleep \u548c httpbin \u5e94\u7528 $ kubectl apply -f sleep.istio.yaml -n mesh service/sleep created deployment.extensions/sleep-v1 created deployment.extensions/sleep-v2 created $ kubectl apply -f sleep.istio.yaml -n plain service/sleep created deployment.extensions/sleep-v1 created deployment.extensions/sleep-v2 created $ cd Istio/istio-1.1.16/samples/httpbin $ kubectl apply -f httpbin.yaml -n mesh service/httpbin created deployment.extensions/httpbin created $ kubectl apply -f httpbin.yaml -n plain service/httpbin created deployment.extensions/httpbin created \u5728\u90e8\u7f72\u5b8c\u6210\u4e4b\u540e\uff0c \u6709\u4e24\u7ec4\u5e94\u7528\u5728\u540c\u65f6\u8fd0\u884c\u8fd9\u4e24\u7ec4\u5e94\u7528\u5206\u522b\u5904\u4e8e\u7f51\u683c\u7684\u5185\u90e8\u548c\u5916\u90e8 , \u6211\u4eec\u5c1d\u8bd5\u8ba9\u4e8c\u8005\u4e92\u8bbf PLAIN_SLEEP $ kubectl get pods -n plain | grep sleep-v1 sleep-v1-548d87cc5c-gjqf4 1/1 Running 0 5m39s MESH_SLEEP $ kubectl get pods -n mesh | grep sleep-v1 sleep-v1-548d87cc5c-6vxmn 2/2 Running 0 6m23s $ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 387 content-type: application/json date: Tue, 05 Nov 2019 03:02:54 GMT server: istio-envoy x-envoy-decorator-operation: httpbin.mesh.svc.cluster.local:8000/* x-envoy-upstream-service-time: 3 ... }, \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin.mesh:8000/get\" } \u53ef\u4ee5\u770b\u5230 , \u6b64\u65f6\u7531\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1, \u4ee5\u53ca\u7531\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1, \u90fd\u662f\u6ca1\u6709\u95ee\u9898\u7684 \u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a MeshPolicy , \u5f3a\u5236\u7f51\u683c\u5185\u90e8\u7684\u6240\u6709\u670d\u52a1\u90fd\u9ed8\u8ba4\u5f00\u542f mTLS apiVersion: \"authentication.istio.io/v1alpha1\" kind: \"MeshPolicy\" metadata: name: \"default\" spec: peers: - mtls: {} $ kubectl apply -f meshpolicy.yaml meshpolicy.authentication.istio.io/default configured \u5728\u9ed8\u8ba4\u7b56\u7565\u521b\u5efa\u4e4b\u540e, \u91cd\u65b0\u5c1d\u8bd5\u521a\u624d\u7684\u4e92\u8bbf $ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get http: error: ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) while doing GET request to URL: http://httpbin.mesh:8000/get $ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn -c sleep bash bash-4.4# http http://httpbin.plain:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 855 content-type: application/json date: Tue, 05 Nov 2019 03:12:50 GMT server: envoy x-envoy-upstream-service-time: 3 ... } \u8fd9\u6b21\u53d1\u73b0\uff0c \u7531\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u53d1\u751f\u5931\u8d25 \u800c\u7531\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u7f51\u683c\u5916\u90e8\u7684\u670d\u52a1\u53ef\u4ee5\u6b63\u5e38\u5b8c\u6210 \u540c\u4e00\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\uff0c \u7ed3\u679c\u4f1a\u662f\u600e\u6837\u5462\uff1f $ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get HTTP/1.1 503 Service Unavailable content-length: 95 content-type: text/plain date: Tue, 05 Nov 2019 03:12:34 GMT server: envoy upstream connect error or disconnect/reset before headers. reset reason: connection termination \u53ef\u4ee5\u53d1\u73b0\uff0c \u5373\u4fbf\u662f\u540c\u4e00\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\uff0c \u4e5f\u8fd8\u662f\u51fa\u4e86\u4e86\u95ee\u9898\u3002 \u8fd9\u662f\u56e0\u4e3a\u6240\u6709\u7684\u670d\u52a1\u7aef Sidecar \u90fd\u53ea\u63a5\u53d7 mTLS \u5ba2\u6237\u7aef\u7684\u63a5\u5165\uff0c\u5ba2\u6237\u7aef\u5374\u6ca1\u6709\u968f\u4e4b\u53d8\u5316\uff0c \u8981\u5e94\u5bf9\u8fd9\u79cd\u7684\u60c5\u51b5\uff0c \u5c31\u53ef\u4ee5\u4f7f\u7528 DestinationRule \u5bf9\u8c61\u6765\u663e\u793a\u58f0\u660e\u8fd9\u4e2a\u8981\u6c42 destinationrule.mtls.yaml apiVersion: networking.istio.io/v1alpha3 kind: \"DestinationRule\" metadata: name: \"httpbin\" namespace: mesh spec: host: httpbin.mesh.svc.cluster.local trafficPolicy: tls: mode: ISTIO_MUTUAL \u6ce8\u610f DestinationRule \u7684 namespace $ kubectl apply -f destinationrule.mtls.yaml destinationrule.networking.istio.io/httpbin created $ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get http: error: ConnectionError: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) while doing GET request to URL: http://httpbin.mesh:8000/get $ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn -c sleep bash bash-4.4# http http://httpbin:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 632 content-type: application/json date: Tue, 05 Nov 2019 05:43:20 GMT server: envoy x-envoy-upstream-service-time: 17 ... \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin:8000/get\" } \u53ef\u4ee5\u770b\u5230\uff0c\u6765\u81ea pain \u547d\u540d\u7a7a\u95f4\u7684\u8bbf\u95ee\u4f9d\u7136\u662f\u65e0\u6cd5\u5b8c\u6210\u7684\uff0c\u4f46\u662f\u5728\u5f00\u542f\u4e86 DestinationRule\u4e4b \u540e\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u8bbf\u95ee\u5c31\u6062\u590d\u6b63\u5e38\u4e86 \u3002 \u5982\u6b64\u4e00\u6765\uff0c\u901a\u8fc7\u7b80\u5355\u7684 Policy \u548c DestinationRule \u5bf9\u8c61\u5b9a\u4e49\uff0c\u6211\u4eec\u5728\u5e94\u7528\u7a0b\u5e8f\u4e0d\u6539\u52a8, \u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\u5c06\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u95f4\u7684\u901a\u4fe1\u534f\u8bae\u4ece\u660e\u6587\u4f20\u8f93\u5347\u7ea7\u4e3a mTLS \u52a0\u5bc6 , \u5e76\u9650\u5236\u4e86\u5916\u90e8\u7684\u660e\u6587\u8bbf\u95ee \u3002 \u90a3\u4e48\uff0c \u5982\u679c\u53ea\u60f3\u542f\u7528 mTLS \u4f5c\u4e3a RBAC \u7684\u524d\u63d0\uff0c\u4f46\u662f\u5bf9\u5916\u90e8\u670d\u52a1\u65f6\u4e0d\u5e0c\u671b\u8bbf\u95ee\u53d7\u5230\u9650\u5236\u5219\u8be5\u5982\u4f55\u5b8c\u6210\u5462\uff1f \u53ea\u9700\u4fee\u6539\u4e00\u4e0b\u6211\u4eec\u7684 Mesh Policy apiVersion: \"authentication.istio.io/v1alpha1\" kind: \"MeshPolicy\" metadata: name: \"default\" spec: peers: # - mtls: {} - mtls: mode: PERMISSIVE \u4e3a mtls \u5b57\u6bb5\u52a0\u4eba mode:PERMISSIVE \u91cd\u65b0\u63d0\u4ea4 $ kubectl apply -f meshpolicy.yaml -n mesh meshpolicy.authentication.istio.io/default configured \u518d\u6b21\u4ece plain \u547d\u540d\u7a7a\u95f4\u53d1\u8d77\u8bbf\u95ee $ kubectl exec -n plain -it sleep-v1-548d87cc5c-gjqf4 -c sleep bash bash-4.4# http http://httpbin.mesh:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 387 content-type: application/json date: Tue, 05 Nov 2019 05:52:33 GMT server: istio-envoy x-envoy-decorator-operation: httpbin.mesh.svc.cluster.local:8000/* x-envoy-upstream-service-time: 1 ... } $ kubectl exec -n mesh -it sleep-v1-548d87cc5c-6vxmn -c sleep bash bash-4.4# http http://httpbin.plain:8000/get HTTP/1.1 200 OK access-control-allow-credentials: true ... \u53ef\u4ee5\u770b\u5230\uff0c\u591a\u4e2a\u65b9\u5411\u7684\u4e92\u8bbf\u4e5f\u90fd\u6ca1\u6709\u95ee\u9898\uff0c\u8fd9\u79cd\u5bbd\u5bb9\u6a21\u5f0f\u5bf9\u4e8e\u8bd5\u70b9\u548c\u8fc1\u79fb\u8fc7\u7a0b\u4e2d\u7684\u6df7\u5408\u90e8\u7f72\u662f\u975e\u5e38\u6709\u5e2e\u52a9\u7684\u3002","title":"2\u3001\u542f\u7528mTLS"},{"location":"chap5/19Istio_Sec2_RBAC/","text":"\u7b2c\u5341\u4e5d\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa(RBAC\u8bbe\u7f6e\\\u6392\u9519\uff09 1\u3001\u8bbe\u7f6e RBAC RBAC(Role Based Access Control\uff09 \u662f\u76ee\u524d\u8f83\u4e3a\u901a\u7528\u7684\u4e00\u79cd\u8bbf\u95ee\u63a7\u5236\u65b9\u6cd5\u3002 Istio \u4e5f\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u65b9\u5f0f\u6765\u652f\u6301\u670d\u52a1\u95f4\u7684\u6388\u6743\u548c\u9274\u6743\u3002 \u6ce8\u610f\uff0c\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u9996\u5148\u8981\u5728 values.yaml \u4e2d\u8bbe\u7f6e\uff1a apiVersion: \"authentication.istio.io/v1alpha1\" kind: \"MeshPolicy\" metadata: name: \"default\" namespace: \"default\" spec: peers: - mtls: {} \u5728\u90e8\u7f72\u6210\u529f\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u7f51\u683c\u4e2d\u542f\u52a8\u6211\u4eec\u7684 sleep \u5e94\u7528\u548c httpbin \u5e94\u7528\u4e86\u3002\u5728\u542f\u52a8\u5b8c\u6210\u540e\uff0c \u5c1d\u8bd5\u4f7f\u7528 sleep Pod \u8bbf\u95ee httpbin \u670d\u52a1\uff1a $ kubectl apply -f meshpolicy.yaml meshpolicy.authentication.istio.io/default configured $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http http://httpbin:8000/ip HTTP/1.1 200 OK access-control-allow-credentials: true ... defa-destinationrule.mtls.yaml apiVersion: networking.istio.io/v1alpha3 kind: \"DestinationRule\" metadata: name: \"httpbin\" namespace: default spec: host: httpbin.default.svc.cluster.local trafficPolicy: tls: mode: ISTIO_MUTUAL \u4e0d\u51fa\u610f\u5916\u8bbf\u95ee\u53ef\u4ee5\u6b63\u5e38\u5b8c\u6210 \u4e0b\u9762\u542f\u52a8\u4e00\u4e2a\u7b56\u7565\uff0c \u542f\u52a8 RBAC apiVersion: \"rbac.istio.io/v1alpha1\" kind: RbacConfig metadata: name: default spec: mode: 'ON_WITH_INCLUSION' inclusion: namespaces: [\"default\"] $ kubectl apply -f rbac.yaml rbacconfig.rbac.istio.io/default created \u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a rbac.yaml \uff0c\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4, \u8fd9\u4e00\u89c4\u5219\u7684\u610f\u4e49\u5728\u4e8e\uff0c\u4e3a\u6240\u6709 default \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u670d\u52a1\u90fd\u542f\u52a8RBAC\u7b56\u7565\u3002 \u518d\u6b21\u542f\u52a8\u6d4b\u8bd5\uff1a $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http http://httpbin:8000/ip HTTP/1.1 403 Forbidden content-length: 19 content-type: text/plain date: Tue, 05 Nov 2019 06:23:03 GMT server: envoy x-envoy-upstream-service-time: 1 RBAC: access denied \u95ee\u9898\u51fa\u73b0\u4e86\uff0c\u5728 RBAC \u542f\u52a8\u4e4b\u540e\uff0c\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u670d\u52a1\u7684\u8c03\u7528\u90fd\u4f1a\u88ab\u62d2\u7edd\u3002\u63a5\u4e0b\u6765\u9700\u8981\u505a\u7684\u5c31\u662f\u5236\u5b9a\u7b56\u7565\uff0c\u5f00\u653e\u5bf9 httpbin \u670d\u52a1\u7684\u8bbf\u95ee\u3002 \u4e00\u822c\u6765\u8bf4\uff0c RBAC \u7cfb\u7edf\u4e2d\u7684\u6388\u6743\u8fc7\u7a0b\u90fd\u662f\u901a\u8fc7\u4ee5\u4e0b\u51e0\u6b65\u8fdb\u884c\u8bbe\u7f6e\u7684\uff1a \u5728\u7cfb\u7edf\u4e2d\u5b9a\u4e49\u539f\u5b50\u7c92\u5ea6\u7684\u6743\u9650\uff1b \u5c06\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u6743\u9650\u7ec4\u5408\u4e3a\u89d2\u8272\uff1b \u5c06\u89d2\u8272\u548c\u7528\u6237\u8fdb\u884c\u7ed1\u5b9a\uff0c\u4ece\u800c\u8ba9\u7528\u6237\u5177\u5907\u7ed1\u5b9a\u7684\u89d2\u8272\u6240\u62e5\u6709\u7684\u6743\u9650\u3002 \u5728 Istio \u4e2d\u4f7f\u7528\u5728\u63d0\u5230\u7684 ServiceRole \u548c ServiceRoleBinding \u8fd9\u4e24\u4e2a\u5bf9\u8c61\u6765\u5b8c\u6210\u8fd9\u4e00\u8fc7\u7a0b\u3002 \u9996\u5148\u5b9a\u4e49\u4e00\u4e2a\u53ef\u4ee5\u4f7f\u7528 HTTP GET \u8bbf\u95ee\u6240\u6709\u670d\u52a1\u7684 ServiceRole : apiVersion: \"rbac.istio.io/v1alpha1\" kind: ServiceRole metadata: name: service-viewer spec: rules: - services: [\"*\"] methods: [\"GET\"] $ kubectl apply -f servicerole.yaml servicerole.rbac.istio.io/service-viewer created \u5c06\u5176\u4fdd\u5b58\u4e3a servicerole.yaml \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u79f0\u4e3a service-viewer \u7684\u89d2\u8272\uff0c\u5728 rules \u5b57\u6bb5\u4e2d\u8fdb\u884c\u6388\u6743\uff0c\u5141\u8bb8\u8be5\u89d2\u8272\u4f7f\u7528 GET \u65b9\u6cd5\u8bbf\u95ee\u6240\u6709\u670d\u52a1\u3002 \u7136\u540e\u5b9a\u4e49\u4e00\u4e2a ServiceRoleBinding \uff0c\u5c06\u4e0a\u9762\u7684\u89d2\u8272\u7ed1\u5b9a\u5230\u6240\u6709 default \u547d\u540d\u7a7a\u95f4\u7684 ServiceAccount \u4e0a\uff1a apiVersion: \"rbac.istio.io/v1alpha1\" kind: ServiceRoleBinding metadata: name: bind-service-viewer spec: subjects: - properties: source.namespace: \"default\" roleRef: kind: ServiceRole name: \"service-viewer\" $ kubectl apply -f servicerolebinding.yaml servicerolebinding.rbac.istio.io/bind-service-viewer created \u5c06\u5176\u4fdd\u5b58\u4e3a servicerolebinding.yaml \u3002 \u8fd9\u91cc\u7684 subject \u7528\u4e86\u4e00\u4e2a\u5c5e\u6027\u9650\u5236\u6765\u6307\u5b9a\u7ed1\u5b9a\u76ee\u6807\uff1a\u6240\u6709\u6765\u81ea default \u547d\u540d\u7a7a\u95f4\u7684\u8c03\u7528\u8005\u3002 \u7b26\u5408\u8fd9\u4e00\u6761\u4ef6\u7684\u7528\u6237\u90fd\u88ab\u7ed1\u5b9a\u5230 service-viewer \u8fd9\u4e2a\u89d2\u8272\u4e0a\u3002 \u6211\u4eec\u5c06\u8fd9\u4e24\u4e2a\u6587\u4ef6\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\uff1a $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http http://httpbin:8000/ip HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 28 content-type: application/json date: Tue, 05 Nov 2019 07:24:53 GMT ... \u8fdb\u4e00\u6b65\u5c1d\u8bd5 post \u65b9\u5f0f bash-4.4# http -f POST http://httpbin:8000/post name=ja HTTP/1.1 403 Forbidden content-length: 19 content-type: text/plain date: Tue, 05 Nov 2019 07:27:01 GMT server: envoy x-envoy-upstream-service-time: 0 RBAC: access denied \u56e0\u4e3a\u5728 ServiceRole \u4e2d\u4ec5\u8bbe\u7f6e\u4e86 GET \u65b9\u6cd5\u7684\u6388\u6743\uff0c\u56e0\u6b64 POST \u65b9\u6cd5\u8fd8\u662f\u65e0\u6cd5\u901a\u8fc7\u3002 \u4e0b\u9762\u5c06\u8fd9\u4e2a\u89d2\u8272\u8fdb\u884c\u7ec6\u5316\u3002\u5047\u8bbe\u6211\u4eec\u7684\u4e24\u4e2a\u7248\u672c\u7684 sleep \u5e94\u7528\u4f7f\u7528\u4e0d\u540c\u7684 ServiceAccount \u8fd0\u884c\uff1a v1 \u7248\u672c\u4f7f\u7528 sleep , v2 \u7248\u672c\u4f7f\u7528 sleep-v2 \u3002\u6211\u4eec\u5bf9 sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u5f00\u653e POST \u65b9\u6cd5\u3002 \u9996\u5148\u521b\u5efa\u65b0\u7684 Service Account : $ kubectl create sa sleep serviceaccount/sleep created $ kubectl create sa sleep-v2 serviceaccount/sleep-v2 created \u63a5\u4e0b\u6765\u66f4\u65b0 sleep.yaml \uff0c\u5728\u5176\u4e2d\u589e\u52a0 ServiceAccount : ... apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep-v1 # annotations: # traffic.sidecar.istio.io/includeOutboundIPRanges: 10.96.0.0/12 spec: replicas: 1 template: metadata: labels: app: sleep version: v1 spec: ServiceAccountName: sleep containers: - name: sleep image: dustise/sleep imagePullPolicy: Always --- ... labels: app: sleep version: v2 spec: ServiceAccountName: sleep-v2 containers: ... \u5220\u9664\u539f\u6709\u90e8\u7f72\uff0c\u91cd\u65b0\u542f\u52a8\u5e76\u6ce8\u4eba sleep \u5e94\u7528\uff0c\u7ee7\u7eed\u540e\u7eed\u7684\u6d4b\u8bd5\u64cd\u4f5c\uff1a $ kubectl exec -it sleep-v2-6b7d67797b-48pk6 -c sleep bash http -f POST http://httpbin:8000/post name=ja HTTP/1.1 403 Forbidden content-length: 19 content-type: text/plain date: Tue, 05 Nov 2019 08:01:33 GMT server: envoy x-envoy-upstream-service-time: 5 RBAC: access denied http -f http://httpbin:8000/ip HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 28 content-type: application/json date: Tue, 05 Nov 2019 08:02:05 GMT server: envoy x-envoy-upstream-service-time: 2 { \"origin\": \"127.0.0.1\" } \u53ef\u4ee5\u770b\u5230\uff0c sleep \u670d\u52a1\u7684 v2 \u7248\u672c\u76ee\u524d\u548c\u5176\u4ed6\u670d\u52a1\u6743\u9650\u662f\u4e00\u81f4\u7684\u3002 \u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Service Role : apiVersion: \"rbac.istio.io/v1alpha1\" kind: ServiceRole metadata: name: service-owner spec: rules: - services: [\"*\"] methods: [\"GET\",\"POST\"] servicerole-owner.yaml $ kubectl apply -f servicerole-owner.yaml servicerole.rbac.istio.io/service-owner created \u7136\u540e\u521b\u5efa\u65b0\u7684 servicerolebinding.yaml \u7684\u7ed1\u5b9a\u5173\u7cfb, \uff0c\u5c06 sleep-v2 \u548c service-owner \u5173\u8054\u8d77\u6765\uff1a apiVersion: \"rbac.istio.io/v1alpha1\" kind: ServiceRoleBinding metadata: name: bind-service-owner spec: subjects: - user: \"cluster.local/ns/default/sa/sleep\" roleRef: kind: ServiceRole name: \"service-owner\" $ kubectl apply -f servicerolebinding-owner.yaml servicerolebinding.rbac.istio.io/bind-service-owner created $ kubectl exec -it sleep-v2-6b7d67797b-48pk6 -c sleep bash bash-4.4# http -f POST http://httpbin:8000/post name=ja HTTP/1.1 403 Forbidden content-length: 19 content-type: text/plain ... RBAC: access denied $ kubectl exec -it sleep-v1-64fddd5d85-nmgl5 -c sleep bash bash-4.4# http -f POST http://httpbin:8000/post name=ja HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 793 ... \u5982\u6b64\u4e00\u6765\uff0c\u4f7f\u7528\u4e0d\u540c Service Account \u8fd0\u884c\u7684\u670d\u52a1\u7248\u672c\uff0c\u5c31\u5206\u522b\u5177\u5907\u4e86\u4e0d\u540c\u7684\u6743\u9650\u3002\u56e0\u4e3a\u670d\u52a1\u548c ServiceAccount \u7684\u5173\u7cfb\u53ef\u4ee5\u7531\u7ba1\u7406\u5458\u8fdb\u884c\u6307\u5b9a\u6709\u975e\u5e38\u5927\u7684\u7075\u6d3b\u6027\uff0c\u6240\u4ee5\u5728\u6388\u6743\u65b9\u9762\u4f1a 2\u3001 RBAC \u7684\u9664\u9519\u8fc7\u7a0b RBAC \u7684\u8bbe\u7f6e\u8fc7\u7a0b\u662f\u975e\u5e38\u5bb9\u6613\u51fa\u9519\u7684\uff0c\u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u4e49\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u5728 Mixer Telemetry \u4e2d\u76d1\u63a7 \u8fd9\u91cc\u7ed9\u51fa\u4e00\u4e2a\u7b80\u5355\u6837\u4f8b\uff1a apiVersion: \"config.istio.io/v1alpha2\" kind: logentry metadata: name: rbaclog spec: severity: '\"warning\"' timestamp: request.time variables: source: source.labels[\"app\"] | source.workload.name | \"unknown\" user: source.user | \"unknown\" destination: destination.labels[\"app\"] | destination.workload.name | \"unknown\" responseCode: response.code | 0 responseSize: response.size | 0 latency: response.duration | \"Oms\" monitored_resource_type: '\"UNSPECIFIED\"' --- apiVersion: \"config.istio.io/v1alpha2\" kind: stdio metadata: name: rbachandler spec: outputAsJson: true --- apiVersion: \"config.istio.io/v1alpha2\" kind: rule metadata: name: rabcstdio spec: actions: - handler: rbachandler.stdio instances: - rbaclog.logentry $ kubectl apply -f rbaclog.yaml logentry.config.istio.io/rbaclog unchanged stdio.config.istio.io/rbachandler unchanged rule.config.istio.io/rabcstdio created kubectl logs -n istio-system istio-telemetry-7d7845478d-d2h5f -c mixer | grep rbaclog ... \u6839\u636e\u65e5\u5fd7\u5185\u5bb9\u4e2d\u7684 source \u3001 destination \u7b49\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5c31\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230\u5728\u8bbf\u95ee\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u7684\u95ee\u9898\u4e86\u3002","title":"\u7b2c\u5341\u4e5d\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa(RBAC\u8bbe\u7f6e\\\u62cd\u9519\uff09"},{"location":"chap5/19Istio_Sec2_RBAC/#istiorbac","text":"","title":"\u7b2c\u5341\u4e5d\u8282 Istio\u7684\u5b89\u5168\u52a0\u56fa(RBAC\u8bbe\u7f6e\\\u6392\u9519\uff09"},{"location":"chap5/19Istio_Sec2_RBAC/#1rbac","text":"RBAC(Role Based Access Control\uff09 \u662f\u76ee\u524d\u8f83\u4e3a\u901a\u7528\u7684\u4e00\u79cd\u8bbf\u95ee\u63a7\u5236\u65b9\u6cd5\u3002 Istio \u4e5f\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u65b9\u5f0f\u6765\u652f\u6301\u670d\u52a1\u95f4\u7684\u6388\u6743\u548c\u9274\u6743\u3002 \u6ce8\u610f\uff0c\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u9996\u5148\u8981\u5728 values.yaml \u4e2d\u8bbe\u7f6e\uff1a apiVersion: \"authentication.istio.io/v1alpha1\" kind: \"MeshPolicy\" metadata: name: \"default\" namespace: \"default\" spec: peers: - mtls: {} \u5728\u90e8\u7f72\u6210\u529f\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u7f51\u683c\u4e2d\u542f\u52a8\u6211\u4eec\u7684 sleep \u5e94\u7528\u548c httpbin \u5e94\u7528\u4e86\u3002\u5728\u542f\u52a8\u5b8c\u6210\u540e\uff0c \u5c1d\u8bd5\u4f7f\u7528 sleep Pod \u8bbf\u95ee httpbin \u670d\u52a1\uff1a $ kubectl apply -f meshpolicy.yaml meshpolicy.authentication.istio.io/default configured $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http http://httpbin:8000/ip HTTP/1.1 200 OK access-control-allow-credentials: true ... defa-destinationrule.mtls.yaml apiVersion: networking.istio.io/v1alpha3 kind: \"DestinationRule\" metadata: name: \"httpbin\" namespace: default spec: host: httpbin.default.svc.cluster.local trafficPolicy: tls: mode: ISTIO_MUTUAL \u4e0d\u51fa\u610f\u5916\u8bbf\u95ee\u53ef\u4ee5\u6b63\u5e38\u5b8c\u6210 \u4e0b\u9762\u542f\u52a8\u4e00\u4e2a\u7b56\u7565\uff0c \u542f\u52a8 RBAC apiVersion: \"rbac.istio.io/v1alpha1\" kind: RbacConfig metadata: name: default spec: mode: 'ON_WITH_INCLUSION' inclusion: namespaces: [\"default\"] $ kubectl apply -f rbac.yaml rbacconfig.rbac.istio.io/default created \u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a rbac.yaml \uff0c\u5e76\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4, \u8fd9\u4e00\u89c4\u5219\u7684\u610f\u4e49\u5728\u4e8e\uff0c\u4e3a\u6240\u6709 default \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u670d\u52a1\u90fd\u542f\u52a8RBAC\u7b56\u7565\u3002 \u518d\u6b21\u542f\u52a8\u6d4b\u8bd5\uff1a $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http http://httpbin:8000/ip HTTP/1.1 403 Forbidden content-length: 19 content-type: text/plain date: Tue, 05 Nov 2019 06:23:03 GMT server: envoy x-envoy-upstream-service-time: 1 RBAC: access denied \u95ee\u9898\u51fa\u73b0\u4e86\uff0c\u5728 RBAC \u542f\u52a8\u4e4b\u540e\uff0c\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u670d\u52a1\u7684\u8c03\u7528\u90fd\u4f1a\u88ab\u62d2\u7edd\u3002\u63a5\u4e0b\u6765\u9700\u8981\u505a\u7684\u5c31\u662f\u5236\u5b9a\u7b56\u7565\uff0c\u5f00\u653e\u5bf9 httpbin \u670d\u52a1\u7684\u8bbf\u95ee\u3002 \u4e00\u822c\u6765\u8bf4\uff0c RBAC \u7cfb\u7edf\u4e2d\u7684\u6388\u6743\u8fc7\u7a0b\u90fd\u662f\u901a\u8fc7\u4ee5\u4e0b\u51e0\u6b65\u8fdb\u884c\u8bbe\u7f6e\u7684\uff1a \u5728\u7cfb\u7edf\u4e2d\u5b9a\u4e49\u539f\u5b50\u7c92\u5ea6\u7684\u6743\u9650\uff1b \u5c06\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u6743\u9650\u7ec4\u5408\u4e3a\u89d2\u8272\uff1b \u5c06\u89d2\u8272\u548c\u7528\u6237\u8fdb\u884c\u7ed1\u5b9a\uff0c\u4ece\u800c\u8ba9\u7528\u6237\u5177\u5907\u7ed1\u5b9a\u7684\u89d2\u8272\u6240\u62e5\u6709\u7684\u6743\u9650\u3002 \u5728 Istio \u4e2d\u4f7f\u7528\u5728\u63d0\u5230\u7684 ServiceRole \u548c ServiceRoleBinding \u8fd9\u4e24\u4e2a\u5bf9\u8c61\u6765\u5b8c\u6210\u8fd9\u4e00\u8fc7\u7a0b\u3002 \u9996\u5148\u5b9a\u4e49\u4e00\u4e2a\u53ef\u4ee5\u4f7f\u7528 HTTP GET \u8bbf\u95ee\u6240\u6709\u670d\u52a1\u7684 ServiceRole : apiVersion: \"rbac.istio.io/v1alpha1\" kind: ServiceRole metadata: name: service-viewer spec: rules: - services: [\"*\"] methods: [\"GET\"] $ kubectl apply -f servicerole.yaml servicerole.rbac.istio.io/service-viewer created \u5c06\u5176\u4fdd\u5b58\u4e3a servicerole.yaml \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u79f0\u4e3a service-viewer \u7684\u89d2\u8272\uff0c\u5728 rules \u5b57\u6bb5\u4e2d\u8fdb\u884c\u6388\u6743\uff0c\u5141\u8bb8\u8be5\u89d2\u8272\u4f7f\u7528 GET \u65b9\u6cd5\u8bbf\u95ee\u6240\u6709\u670d\u52a1\u3002 \u7136\u540e\u5b9a\u4e49\u4e00\u4e2a ServiceRoleBinding \uff0c\u5c06\u4e0a\u9762\u7684\u89d2\u8272\u7ed1\u5b9a\u5230\u6240\u6709 default \u547d\u540d\u7a7a\u95f4\u7684 ServiceAccount \u4e0a\uff1a apiVersion: \"rbac.istio.io/v1alpha1\" kind: ServiceRoleBinding metadata: name: bind-service-viewer spec: subjects: - properties: source.namespace: \"default\" roleRef: kind: ServiceRole name: \"service-viewer\" $ kubectl apply -f servicerolebinding.yaml servicerolebinding.rbac.istio.io/bind-service-viewer created \u5c06\u5176\u4fdd\u5b58\u4e3a servicerolebinding.yaml \u3002 \u8fd9\u91cc\u7684 subject \u7528\u4e86\u4e00\u4e2a\u5c5e\u6027\u9650\u5236\u6765\u6307\u5b9a\u7ed1\u5b9a\u76ee\u6807\uff1a\u6240\u6709\u6765\u81ea default \u547d\u540d\u7a7a\u95f4\u7684\u8c03\u7528\u8005\u3002 \u7b26\u5408\u8fd9\u4e00\u6761\u4ef6\u7684\u7528\u6237\u90fd\u88ab\u7ed1\u5b9a\u5230 service-viewer \u8fd9\u4e2a\u89d2\u8272\u4e0a\u3002 \u6211\u4eec\u5c06\u8fd9\u4e24\u4e2a\u6587\u4ef6\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\uff1a $ kubectl exec -it sleep-6c9c898f6c-448v6 -c sleep bash bash-4.4# http http://httpbin:8000/ip HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 28 content-type: application/json date: Tue, 05 Nov 2019 07:24:53 GMT ... \u8fdb\u4e00\u6b65\u5c1d\u8bd5 post \u65b9\u5f0f bash-4.4# http -f POST http://httpbin:8000/post name=ja HTTP/1.1 403 Forbidden content-length: 19 content-type: text/plain date: Tue, 05 Nov 2019 07:27:01 GMT server: envoy x-envoy-upstream-service-time: 0 RBAC: access denied \u56e0\u4e3a\u5728 ServiceRole \u4e2d\u4ec5\u8bbe\u7f6e\u4e86 GET \u65b9\u6cd5\u7684\u6388\u6743\uff0c\u56e0\u6b64 POST \u65b9\u6cd5\u8fd8\u662f\u65e0\u6cd5\u901a\u8fc7\u3002 \u4e0b\u9762\u5c06\u8fd9\u4e2a\u89d2\u8272\u8fdb\u884c\u7ec6\u5316\u3002\u5047\u8bbe\u6211\u4eec\u7684\u4e24\u4e2a\u7248\u672c\u7684 sleep \u5e94\u7528\u4f7f\u7528\u4e0d\u540c\u7684 ServiceAccount \u8fd0\u884c\uff1a v1 \u7248\u672c\u4f7f\u7528 sleep , v2 \u7248\u672c\u4f7f\u7528 sleep-v2 \u3002\u6211\u4eec\u5bf9 sleep \u670d\u52a1\u7684 v1 \u7248\u672c\u5f00\u653e POST \u65b9\u6cd5\u3002 \u9996\u5148\u521b\u5efa\u65b0\u7684 Service Account : $ kubectl create sa sleep serviceaccount/sleep created $ kubectl create sa sleep-v2 serviceaccount/sleep-v2 created \u63a5\u4e0b\u6765\u66f4\u65b0 sleep.yaml \uff0c\u5728\u5176\u4e2d\u589e\u52a0 ServiceAccount : ... apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep-v1 # annotations: # traffic.sidecar.istio.io/includeOutboundIPRanges: 10.96.0.0/12 spec: replicas: 1 template: metadata: labels: app: sleep version: v1 spec: ServiceAccountName: sleep containers: - name: sleep image: dustise/sleep imagePullPolicy: Always --- ... labels: app: sleep version: v2 spec: ServiceAccountName: sleep-v2 containers: ... \u5220\u9664\u539f\u6709\u90e8\u7f72\uff0c\u91cd\u65b0\u542f\u52a8\u5e76\u6ce8\u4eba sleep \u5e94\u7528\uff0c\u7ee7\u7eed\u540e\u7eed\u7684\u6d4b\u8bd5\u64cd\u4f5c\uff1a $ kubectl exec -it sleep-v2-6b7d67797b-48pk6 -c sleep bash http -f POST http://httpbin:8000/post name=ja HTTP/1.1 403 Forbidden content-length: 19 content-type: text/plain date: Tue, 05 Nov 2019 08:01:33 GMT server: envoy x-envoy-upstream-service-time: 5 RBAC: access denied http -f http://httpbin:8000/ip HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 28 content-type: application/json date: Tue, 05 Nov 2019 08:02:05 GMT server: envoy x-envoy-upstream-service-time: 2 { \"origin\": \"127.0.0.1\" } \u53ef\u4ee5\u770b\u5230\uff0c sleep \u670d\u52a1\u7684 v2 \u7248\u672c\u76ee\u524d\u548c\u5176\u4ed6\u670d\u52a1\u6743\u9650\u662f\u4e00\u81f4\u7684\u3002 \u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Service Role : apiVersion: \"rbac.istio.io/v1alpha1\" kind: ServiceRole metadata: name: service-owner spec: rules: - services: [\"*\"] methods: [\"GET\",\"POST\"] servicerole-owner.yaml $ kubectl apply -f servicerole-owner.yaml servicerole.rbac.istio.io/service-owner created \u7136\u540e\u521b\u5efa\u65b0\u7684 servicerolebinding.yaml \u7684\u7ed1\u5b9a\u5173\u7cfb, \uff0c\u5c06 sleep-v2 \u548c service-owner \u5173\u8054\u8d77\u6765\uff1a apiVersion: \"rbac.istio.io/v1alpha1\" kind: ServiceRoleBinding metadata: name: bind-service-owner spec: subjects: - user: \"cluster.local/ns/default/sa/sleep\" roleRef: kind: ServiceRole name: \"service-owner\" $ kubectl apply -f servicerolebinding-owner.yaml servicerolebinding.rbac.istio.io/bind-service-owner created $ kubectl exec -it sleep-v2-6b7d67797b-48pk6 -c sleep bash bash-4.4# http -f POST http://httpbin:8000/post name=ja HTTP/1.1 403 Forbidden content-length: 19 content-type: text/plain ... RBAC: access denied $ kubectl exec -it sleep-v1-64fddd5d85-nmgl5 -c sleep bash bash-4.4# http -f POST http://httpbin:8000/post name=ja HTTP/1.1 200 OK access-control-allow-credentials: true access-control-allow-origin: * content-length: 793 ... \u5982\u6b64\u4e00\u6765\uff0c\u4f7f\u7528\u4e0d\u540c Service Account \u8fd0\u884c\u7684\u670d\u52a1\u7248\u672c\uff0c\u5c31\u5206\u522b\u5177\u5907\u4e86\u4e0d\u540c\u7684\u6743\u9650\u3002\u56e0\u4e3a\u670d\u52a1\u548c ServiceAccount \u7684\u5173\u7cfb\u53ef\u4ee5\u7531\u7ba1\u7406\u5458\u8fdb\u884c\u6307\u5b9a\u6709\u975e\u5e38\u5927\u7684\u7075\u6d3b\u6027\uff0c\u6240\u4ee5\u5728\u6388\u6743\u65b9\u9762\u4f1a","title":"1\u3001\u8bbe\u7f6eRBAC"},{"location":"chap5/19Istio_Sec2_RBAC/#2-rbac","text":"RBAC \u7684\u8bbe\u7f6e\u8fc7\u7a0b\u662f\u975e\u5e38\u5bb9\u6613\u51fa\u9519\u7684\uff0c\u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u4e49\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u5728 Mixer Telemetry \u4e2d\u76d1\u63a7 \u8fd9\u91cc\u7ed9\u51fa\u4e00\u4e2a\u7b80\u5355\u6837\u4f8b\uff1a apiVersion: \"config.istio.io/v1alpha2\" kind: logentry metadata: name: rbaclog spec: severity: '\"warning\"' timestamp: request.time variables: source: source.labels[\"app\"] | source.workload.name | \"unknown\" user: source.user | \"unknown\" destination: destination.labels[\"app\"] | destination.workload.name | \"unknown\" responseCode: response.code | 0 responseSize: response.size | 0 latency: response.duration | \"Oms\" monitored_resource_type: '\"UNSPECIFIED\"' --- apiVersion: \"config.istio.io/v1alpha2\" kind: stdio metadata: name: rbachandler spec: outputAsJson: true --- apiVersion: \"config.istio.io/v1alpha2\" kind: rule metadata: name: rabcstdio spec: actions: - handler: rbachandler.stdio instances: - rbaclog.logentry $ kubectl apply -f rbaclog.yaml logentry.config.istio.io/rbaclog unchanged stdio.config.istio.io/rbachandler unchanged rule.config.istio.io/rabcstdio created kubectl logs -n istio-system istio-telemetry-7d7845478d-d2h5f -c mixer | grep rbaclog ... \u6839\u636e\u65e5\u5fd7\u5185\u5bb9\u4e2d\u7684 source \u3001 destination \u7b49\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5c31\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230\u5728\u8bbf\u95ee\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u7684\u95ee\u9898\u4e86\u3002","title":"2\u3001 RBAC\u7684\u9664\u9519\u8fc7\u7a0b"},{"location":"chap5/1Service_Mesh_Intro/","text":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u7684\u57fa\u672c\u7279\u5f81 Buoyant\u516c\u53f8\u7684CEO William,\u66fe\u7ecf\u7ed9\u51fa\u5bf9\u670d\u52a1\u7f51\u683c\u7684\u5b9a\u4e49\uff1a \u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u7528\u6765\u5904\u7406\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u3002 \u73b0\u4ee3\u7684\u4e91\u539f\u751f\u5e94\u7528\u662f\u7531\u5404\u79cd\u590d\u6742\u6280\u672f\u6784\u5efa\u7684\u670d\u52a1\u7ec4\u6210\u7684\uff0c\u670d\u52a1\u7f51\u683c\u8d1f\u8d23\u5728\u8fd9\u4e9b\u7ec4\u6210\u90e8\u5206\u4e4b\u95f4\u8fdb\u884c\u53ef\u9760\u7684\u8bf7\u6c42\u4f20\u9012\u3002\u76ee\u524d \u5178\u578b\u7684\u670d\u52a1\u7f51\u683c\u901a\u5e38\u63d0\u4f9b\u4e86\u4e00\u7ec4\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\uff0c\u8fd9\u4e9b\u4ee3\u7406\u4f1a\u5728\u5e94\u7528\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u540c\u5e94\u7528\u5e76\u884c\u90e8\u7f72\u3001\u8fd0\u884c\u3002 \u8fd9\u91cc\u5c06Istio\u7684\u7279\u6027\u603b\u7ed3\u5982\u4e0b\u3002 \u8fde\u63a5 \uff1a\u5bf9\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u6240\u4ea7\u751f\u7684\u6d41\u91cf\u8fdb\u884c\u667a\u80fd\u7ba1\u7406\uff0c\u5e76\u4ee5\u6b64\u4e3a\u57fa\u7840\uff0c\u4e3a\u5fae\u670d\u52a1\u7684\u90e8\u7f72\u3001\u6d4b\u8bd5\u548c\u5347\u7ea7\u7b49\u64cd\u4f5c\u63d0\u4f9b\u6709\u529b\u4fdd\u969c \u5b89\u5168 \uff1a\u4e3a\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u63d0\u4f9b\u8ba4\u8bc1\u3001\u52a0\u5bc6\u548c\u9274\u6743\u652f\u6301\uff0c\u5728\u4e0d\u4fb5\u4eba \u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\uff0c\u52a0\u56fa\u73b0\u6709\u670d\u52a1\uff0c\u63d0\u9ad8\u5176\u5b89\u5168\u6027\u3002 \u7b56\u7565 \uff1a\u5728\u63a7\u5236\u9762\u5b9a\u5236\u7b56\u7565\uff0c\u5e76\u5728\u670d\u52a1\u4e2d\u5b9e\u65bd\u3002 \u89c2\u5bdf \uff1a\u5bf9\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u8fdb\u884c\u8ddf\u8e2a\u548c\u6d4b\u91cf\uff0c\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u4fe1\u606f\u3002 \u4e0b\u9762\u5bf9\u8fd9\u4e9b\u7279\u6027\u5c55\u5f00\u8be6\u7ec6\u63cf\u8ff0\u3002 1.\u8fde\u63a5 \u5fae\u670d\u52a1\u9519\u7efc\u590d\u6742\uff0c\u8981\u5b8c\u6210\u5176\u4e1a\u52a1\u76ee\u6807\uff0c\u8fde\u63a5\u95ee\u9898\u662f\u9996\u8981\u95ee\u9898\u3002\u8fde\u63a5\u5b58\u5728\u4e8e\u6240\u6709 \u670d\u52a1\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\uff0c\u7528\u4e8e\u7ef4\u6301\u670d\u52a1\u7684\u8fd0\u884c\uff0c\u7b97\u5f97\u4e0a\u91cd\u4e2d\u4e4b\u91cd\u3002 \u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684\u5355\u4f53\u5e94\u7528\uff0c \u5fae\u670d\u52a1\u7684\u7aef\u70b9\u6570\u91cf\u4f1a\u6025\u5267\u589e\u52a0 \uff0c\u73b0\u4ee3\u7684\u5e94\u7528\u7cfb\u7edf\u5728\u90e8\u5206\u6216\u8005\u5168\u90e8\u751f\u547d\u5468\u671f\u4e2d\uff0c\u90fd\u5b58\u5728\u540c\u4e00\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\uff0c\u4e3a\u4e0d\u540c\u7684\u5ba2\u6237\u3001\u573a\u666f\u6216\u8005\u4e1a\u52a1\u63d0\u4f9b\u4e0d\u540c\u7684\u670d\u52a1\u3002 \u540c\u65f6\uff0c\u540c\u4e00\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u4e5f\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u8bbf\u95ee\u8981\u6c42\uff0c\u751a\u81f3\u4ea7 \u751f\u4e86\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u8fdb\u884c\u6d4b\u8bd5\u7684\u65b0\u65b9\u6cd5\u8bba\u3002\u9519\u7efc\u590d\u6742\u7684\u670d\u52a1\u5173\u7cfb\u5bf9\u6240\u6709\u76f8\u5173\u5206\u5de5\u6765\u8bf4 \u90fd\u662f\u5f88\u4e25\u5cfb\u7684\u8003\u9a8c\u3002\u9488\u5bf9\u76ee\u524d\u7684\u5e38\u89c1\u4e1a\u52a1\u5f62\u6001\uff0c\u8fd9\u91cc\u753b\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u610f\u56fe\u6765\u63cf\u8ff0 Service Mesh \u7684\u8fde\u63a5\u529f\u80fd \u5982\u56fe\u6240\u793a\uff0c \u4ece\u4e0d\u540c\u7684\u5916\u90e8\u7528\u6237\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u4ed6\u4eec\u8bbf\u95ee\u7684\u90fd\u662f\u540c\u4e00\u670d\u52a1\u7aef\u53e3\uff0c \u4f46\u5b9e\u9645\u4e0a\u4f1a\u56e0\u4e3a\u4e0d\u540c\u7684\u7528\u6237\u8bc6\u522b\uff0c\u5206\u522b\u8bbf\u95ee\u670d\u52a1A\u7684\u4e0d\u540c\u7248\u672c \uff1b\u5728\u7f51\u683c\u5185\u90e8\uff0c\u670d\u52a1A\u7684\u7248\u672c1\u53ef\u80fd\u4f1a\u8bbf\u95ee\u670d\u52a1B\u7684\u4e24\u4e2a\u7248\u672c\uff0c\u670d\u52a1A\u7684\u7248\u672c2\u5219\u53ea\u4f1a\u8bbf\u95ee\u670d\u52a1B\u7684\u7248\u672c1\uff1b\u670d\u52a1B\u7684\u7248\u672c1\u9700\u8981\u8bbf\u95ee\u5916\u90e8\u7684\u4e91\u670d\u52a1\uff0c\u7248\u672c2\u5219\u65e0\u6b64\u9700\u6c42\u3002 \u5728\u8fd9\u4e2a\u7b80\u5316\u7684\u6a21\u578b\u4e2d\uff0c\u5305\u542b\u4e86\u4ee5\u4e0b\u8bc9\u6c42\uff1a \u7f51\u683c\u5185\u90e8\u7684\u8c03\u7528\uff08\u670d\u52a1A -> \u670d\u52a1B) \u51fa\u7ad9\u8fde\u63a5\uff08\u670d\u52a1B \u4e00> \u5916\u90e8\u4e91\u670d\u52a1\uff09 \u5165\u7ad9\u8fde\u63a5\uff08\u7528\u6237 -> \u670d\u52a1A); \u6d41\u91cf\u5206\u5272\uff08\u670d\u52a1A\u7684\u7248\u672c1\u5206\u522b\u8c03\u7528\u4e86\u670d\u52a1B\u7684\u7248\u672c1\u548c\u7248\u672c2); \u6309\u8c03\u7528\u65b9\u7684\u670d\u52a1\u7248\u672c\u8fdb\u884c\u8def\u7531\uff1b \u6309\u7528\u6237\u8eab\u4efd\u8fdb\u884c\u8def\u7531\u3002 \u8fd9\u91cc\u9664\u4e86\u8fd9\u4e9b\u95ee\u9898\uff0c\u8fd8\u5b58\u5728\u4e00\u4e9b\u6f5c\u5728\u9700\u6c42\uff0e\u5982\u4e0b\u6240\u8ff0\u3002 (1) \u5728\u7f51\u683c\u5185\u7684\u670d\u52a1\u4e4b\u95f4\u5982\u4f55\u6839\u636e\u5b9e\u9645\u9700\u8981\u5bf9\u670d\u52a1\u95f4\u7684\u8c03\u7528\u8fdb\u884c\u8def\u7531\u3001\u6761\u4ef6\u53ef\u80fd\u5305\u62ec\uff1a \u8c03\u7528\u6e90\u548c\u76ee\u7684\u7684\u670d\u52a1 \u8c03\u7528\u5185\u5bb9\uff1b \u8ba4\u8bc1\u8eab\u4efd (2) \u5982\u4f55\u5e94\u5bf9\u7f51\u7edc\u6545\u969c\u6216\u8005\u670d\u52a1\u6545\u964d\u3002 (3\uff09\u5982\u4f55\u5904\u7406\u4e0d\u540c\u670d\u52a1\u4e0d\u540c\u7248\u672c\u4e4b\u95ee\u7684\u5173\u7cfb\u3002 (4\uff09\u600e\u6837\u5bf9\u51fa\u7ad9\u8fde\u63a5\u8fdb\u884c\u63a7\u5236\u3002 (5\uff09\u600e\u6837\u63a5\u6536\u5165\u7ad9\u8fde\u63a5\u6765\u542f\u52a8\u540e\u7eed\u7684\u6574\u4e2a\u670d\u52a1\u94fe\u6761 \u8fd9\u4e9b\u5f53\u7136\u4e0d\u662f\u95ee\u9898\u7684\u5168\u90e8\uff0c\u5176\u4e2d\uff0c\u4e0e\u6d41\u91cf\u76f8\u5173\u7684\u95ee\u9898\u8fd8\u5f15\u53d1\u4e86\u51e0\u4e2a\u5173\u952e\u7684\u529f\u80fd\u9700\u6c42\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 (1) \u670d\u52a1\u6ce8\u518c\u548c\u53d1\u73b0 \uff1a\u8981\u6c42\u80fd\u591f\u5bf9\u7f51\u683c\u4e2d\u4e0d\u540c\u7684\u670d\u52a1\u548c\u4e0d\u540c\u7248\u8fdb\u884c\u51c6\u786e\u6807\u8bc6\uff0c\u4e0d\u540c\u7684\u670d\u52a1\u53ef\u4ee5\u7ecf\u7531\u540c\u4e00\u6ce8\u518c\u673a\u6784\u4f7f\u7528\u516c\u8ba4\u7684\u65b9\u5f0f\u4e92\u76f8\u67e5\u627e\u3002 (2) \u8d1f\u8f7d\u5747\u8861\u7b56 \uff1a\u4e0d\u540c\u7c7b\u578b\u7684\u670d\u52a1\u5e94\u8be5\u7531\u4e0d\u540c\u7684\u7b56\u7565\u6765\u6ee1\u8db3\u4e0d\u540c\u7684\u9700\u6c42 (3) \u670d\u52a1\u6d41\u91cf\u7279\u5f81 \uff1a \u5728\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u7684\u57fa\u7840\u4e0a\uff0c\u6839\u636e\u53cc\u65b9\u7684\u670d\u52a1\u8eab\u4efd\uff0c\u4ee5\u53ca\u670d\u52a1\u6d41\u91cf\u7279\u5f81\u6765\u8c03\u7528\u8fc7\u7a0b\u60ca\u9192\u7504\u522b (4) \u52a8\u6001\u6d41\u91cf\u5206\u914d \uff1a \u6839\u636e\u5bf9\u6d41\u91cf\u7279\u5f81\u7684\u8bc6\u522b\uff0c\u5728\u4e0d\u540c\u7684\u670d\u52a1\u548c\u7248\u672c\u4e4b\u95f4\u5bf9\u6d41\u91cf\u8fdb\u884c\u5f15\u5bfc \u8fde\u63a5\u662f\u670d\u52a1\u7f51\u683c\u5e94\u7528\u8fc7\u7a0b\u4e2d\u4ece\u65e0\u5230\u6709\u7684\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u73af\u8282 2.\u5b89\u5168 \u5b89\u5168\u4e5f\u662f\u4e00\u4e2a\u5e38\u8c08\u5e38\u65b0\u7684\u8bdd\u9898\u5728\u8fc7\u53bb\u79c1\u6709\u57fa\u7840\u8bbe\u65bd\u7ed3\u5408\u5355\u5e94\u7528\u7684\u73af\u5883\u4e0b\uff0c\u8fd9\u4e00\u95ee\u9898\u5e76\u4e0d\u7a81\u51fa\uff0c\u7136\u800c\u8fdb\u4eba\u5bb9\u5668\u4e91\u65f6\u4ee3\u4e4b\u540e\uff0c\u4ee5\u4e0b\u95ee\u9898\u51fa\u73b0 \u6709\u5927\u91cf\u5bb9\u5668\u6f02\u6d6e\u5728\u5bb9\u5668\u4e91\u4e2d \uff0c\u91c7\u7528\u4f20\u7edf\u7684\u7f51\u7edc\u7b56\u7565\u5e94\u5bf9\u8fd9\u79cd\u6d6e\u52a8\u7684\u5e94\u7528\u6bd4\u8f83\u5403\u529b\u7684\u3002 \u5728\u7531\u4e0d\u540c\u7684\u8bed\u8a00\u3001\u5e73\u53f0\u6240\u5b9e\u73b0\u7684\u5fae\u670d\u52a1\u4e4b\u95f4\uff0c\u5b9e\u65bd\u4e00\u81f4\u7684\u8bbf\u95ee\u63a7\u5236\u4e5f\u7ecf\u5e38\u4f1a\u56e0\u4e3a\u5b9e\u73b0\u7684\u4e0d\u4e00\u81f4\u800c\u56f0\u96be\u91cd\u91cd\u3002 \u5982\u679c\u662f\u5171\u4eab\u96c6\u7fa4\uff0c\u5219\u670d\u52a1\u7684\u8ba4\u8bc1\u548c\u52a0\u5bc6\u53d8\u5f97\u5c24\u4e3a\u91cd\u8981\uff0c\u4f8b\u5982\uff1a \u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u8981\u9632\u6b62\u88ab\u5176\u4ed6\u670d\u52a1\u76d1\u542c \u53ea\u6709\u63d0\u4f9b\u6709\u6548\u8eab\u4efd\u7684\u5ba2\u6237\u7aef\u624d\u53ef\u4ee5\u8bbf\u95ee\u6307\u5b9a\u7684\u670d\u52a1 \u670d\u52a1\u4e4b\u95f4\u7684\u4e92\u8bbf\u5e94\u8be5\u63d0\u4f9b\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\u529f\u80fd \u603b\u4e4b\uff0c\u8981\u63d0\u4f9b\u7f51\u683c\u5185\u90e8\u7684\u5b89\u5168\u4fdd\u969c\uff0c\u5c31\u5e94\u5177\u5907\u670d\u52a1\u901a\u4fe1\u52a0\u5bc6\u3001\u670d\u52a1\u8eab\u4efd\u8be2\uff0c \u670d\u52a1\u8bbf\u95ee\u63a7\u5236\uff08\u6388\u6743\u548c\u9274\u6743\uff09\u529f\u80fd\u3002 \u4e0a\u8ff0\u529f\u80fd\u901a\u5e38\u9700\u8981\u6570\u5b57\u8bc1\u4e66\u7684\u652f\u6301\uff0c\u8fd9\u5c31\u9690\u85cf\u4e86\u5bf9 CA \u7684\u9700\u6c42\uff0c\u5373\u9700\u8981\u5b8c\u6210\u8bc1\u4e66\u7684\u7b7e\u53d1\u3001\u4f20\u64ad\u548c\u66f4\u65b0\u4e1a\u52a1\u3002 \u9664\u4e86\u4e0a\u8ff0\u6838\u5fc3\u8981\u6c42\uff0c\u8fd8\u5b58\u5728\u5bf9\u8ba4\u8bc1\u5931\u8d25\u7684\u5904\u7406\u3001\u5916\u90e8\u8bc1\u4e66\uff08\u7edf\u4e00CA\uff09\u7684\u63a5\u53e3\u7b49\u76f8\u5173\u652f\u6491\u5185\u5bb9\u3002 3.\u7b56\u7565 \u9664\u4e86\u524d\u9762\u63d0\u5230\u7684\u5b89\u5168\u95ee\u9898\uff0c\u5728\u7531\u5fae\u670d\u52a1\u6784\u6210\u7684\u7f51\u683c\u4e2d\uff0c\u6211\u4eec\u5e38\u5e38\u8fd8\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u63a7\u5236\uff0c\u4f8b\u5982\u5bf9\u8c03\u7528\u9891\u7387\u7684\u9650\u5236\u3001\u5bf9\u670d\u52a1\u4e92\u8bbf\u7684\u63a7\u5236\uff0c\u4ee5\u53ca\u9488\u5bf9\u6d41\u91cf\u7684\u4e00\u4e9b\u9650\u5236\u548c\u53d8\u66f4\u80fd\u529b\u7b49\u3002 \u5728 Istio \u4e2d\u4f7f\u7528 Mixer \u4f5c\u4e3a\u7b56\u7565\u7684\u6267\u884c\u8005\uff0c Envoy\u7684 \u6bcf\u6b21\u8c03\u7528\uff0c\u5728\u903b\u8f91\u4e0a\u90fd\u4f1a\u901a\u8fc7 Mixer \u8fdb\u884c\u4e8b\u5148\u9884\u68c0\u548c\u4e8b\u540e\u62a5\u544a\uff0c\u8fd9\u6837 Mixer \u5c31\u62e5\u6709\u4e86\u5bf9\u6d41\u91cf\u7684\u90e8\u5206\u63a7\u5236\u80fd\u529b \uff1b \u5728Istio\u3002\u4e2d\u8fd8\u6709\u4e3a\u6570\u4f17\u591a\u7684\u5185\u90e8\u9002\u914d\u5668\u53ca\u8fdb\u7a0b\u5916\u9002\u914d\u5668\uff0c\u53ef\u4ee5\u548c\u5916\u90e8\u8f6f\u4ef6\u8bbe\u65bd\u4e00\u540c\u5b8c \u6210\u7b56\u7565\u7684\u5236\u5b9a\u548c\u6267\u884c\u3002 4.\u89c2\u5bdf \u968f\u7740\u670d\u52a1\u6570\u91cf\u7684\u589e\u52a0\uff0c\u76d1\u63a7\u548c\u8ddf\u8e2a\u9700\u6c42\u81ea\u7136\u6c34\u6da8\u8239\u9ad8\u3002\u5728\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u53ef\u89c2\u5bdf \u7684\u4fdd\u969c\u90fd\u662f\u7cfb\u7edf\u529f\u80fd\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\uff0c\u662f\u7cfb\u7edf\u8fd0\u7ef4\u529f\u80fd\u7684\u91cd\u8981\u4fdd\u969c\u3002 \u968f\u7740\u5ec9\u4ef7\u670d\u52a1\u5668\uff08\u76f8\u5bf9\u4e8e\u4f20\u7edf\u5c0f\u578b\u673a\uff09\u7684\u6570\u91cf\u8d8a\u6765\u8d8a\u591a\uff0c\u670d\u52a1\u5668\u53d1\u751f\u6545\u969c\u7684\u9891\u7387\u4e5f\u8d8a\u6765\u8d8a\u9ad8\uff0c\u4eba\u4eec\u5f00\u59cb\u5bf9 Cattle vs. Cat \u4ea7\u751f\u4e89\u8bba\uff1a\u6211\u4eec\u5e94\u8be5\u5c06\u670d\u52a1\u5668\u89c6\u4e3a\u5bb6\u755c\u8fd8\u662f\u5ba0\u7269\uff1f\u5bb6\u755c\u7684\u7279\u70b9\u662f\u6709\u529f\u80fd\u3001\u65e0\u4e2a\u6027\u3001\u53ef\u66ff\u6362\uff1b\u800c\u5ba0\u7269\u7684\u7279\u70b9\u662f\u6709\u529f\u80fd\u3001\u6709\u4e2a\u6027\u3001\u96be\u66ff\u6362\u3002 \u6211\u4eec\u8d8a\u6765\u8d8a\u503e\u5411\u4e8e\u5c06\u670d\u52a1\u5668\u89c6\u4e3a\u65e0\u4e2a\u6027\u3001\u53ef\u66ff\u6362\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u5982\u679c\u4e3b\u673a\u53d1\u751f\u6545\u969c\uff0c\u90a3\u4e48\u76f4\u63a5\u5c06\u5176\u66ff\u6362\u5373\u53ef \uff1b\u5e76\u4e14\uff0c\u6211\u4eec\u66f4\u52a0\u5173\u6ce8\u7684\u662f\u670d\u52a1\u7684\u603b\u4f53\u8d28\u91cf\u3002\u56e0\u6b64\uff0c\u5fae\u670d\u52a1\u7cfb\u7edf\u76d1\u63a7\uff0c\u9664\u4e86\u6709\u4f20\u7edf\u7684\u4e3b\u673a\u76d1\u63a7\uff0c\u8fd8\u66f4\u52a0\u91cd\u89c6\u9ad8\u5c42\u6b21\u7684\u670d\u52a1\u5065\u5eb7\u76d1\u63a7\u3002 \u670d\u52a1\u7684\u5065\u5eb7\u60c5\u51b5\u5f80\u5f80\u4e0d\u662f\u975e\u9ed1\u5373\u767d\u7684\u79bb\u6563\u503c\uff0c\u800c\u662f\u4e00\u7cfb\u5217\u8fde\u7eed\u72b6\u6001\uff0c\u4f8b\u5982\u6211\u4eec\u7ecf\u5e38\u9700\u8981\u5173\u6ce8\u670d\u52a1\u7684\u8c03\u7528 \u6210\u529f\u7387\u3001\u54cd\u5e94\u65f6\u95f4\u3001\u8c03\u7528\u91cf\u3001\u4f20\u8f93\u91cf\u7b49\u8868\u73b0 \uff1a \u800c\u4e14\uff0c\u9762\u5bf9\u6570\u91cf\u4f17\u591a\u7684\u670d\u52a1\uff0c\u6211\u4eec\u5e94\u8be5\u80fd\u5bf9\u5404\u79cd\u7ea7\u522b\u548c\u5c42\u6b21\u7684\u6307\u6807\u8fdb\u884c\u91c7\u6837\u3001\u91c7\u96c6\u53ca\u6c47\u603b\uff0c\u83b7\u53d6\u8f83\u4e3a\u7cbe\u5bc6\u3001\u7fd4\u5b9e\u7684\u8fd0\u884c\u6570\u636e\uff0c\u6700\u7ec8\u901a\u8fc7\u4e00\u5b9a\u7684\u65b9\u6cd5\u8fdb\u884c\u5f52\u7eb3\u603b\u7ed3\u548c\u5c55\u793a\u3002 \u4e0e\u6b64\u540c\u65f6\uff0c\u670d\u52a1\u7f51\u683c\u8fd8\u5e94\u63d0\u4f9b\u5206\u5e03\u5f0f\u8ddf\u8e2a( Distributed Tracing \uff09\u529f\u80fd\u5bf9\u670d\u52a1\u7684\u8c03\u7528\u94fe\u8def\u8fdb\u884c\u8ddf\u8e2a\u3002","title":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u7684\u57fa\u672c\u7279\u5f81"},{"location":"chap5/1Service_Mesh_Intro/#_1","text":"Buoyant\u516c\u53f8\u7684CEO William,\u66fe\u7ecf\u7ed9\u51fa\u5bf9\u670d\u52a1\u7f51\u683c\u7684\u5b9a\u4e49\uff1a \u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u7528\u6765\u5904\u7406\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u3002 \u73b0\u4ee3\u7684\u4e91\u539f\u751f\u5e94\u7528\u662f\u7531\u5404\u79cd\u590d\u6742\u6280\u672f\u6784\u5efa\u7684\u670d\u52a1\u7ec4\u6210\u7684\uff0c\u670d\u52a1\u7f51\u683c\u8d1f\u8d23\u5728\u8fd9\u4e9b\u7ec4\u6210\u90e8\u5206\u4e4b\u95f4\u8fdb\u884c\u53ef\u9760\u7684\u8bf7\u6c42\u4f20\u9012\u3002\u76ee\u524d \u5178\u578b\u7684\u670d\u52a1\u7f51\u683c\u901a\u5e38\u63d0\u4f9b\u4e86\u4e00\u7ec4\u8f7b\u91cf\u7ea7\u7684\u7f51\u7edc\u4ee3\u7406\uff0c\u8fd9\u4e9b\u4ee3\u7406\u4f1a\u5728\u5e94\u7528\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u540c\u5e94\u7528\u5e76\u884c\u90e8\u7f72\u3001\u8fd0\u884c\u3002 \u8fd9\u91cc\u5c06Istio\u7684\u7279\u6027\u603b\u7ed3\u5982\u4e0b\u3002 \u8fde\u63a5 \uff1a\u5bf9\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u6240\u4ea7\u751f\u7684\u6d41\u91cf\u8fdb\u884c\u667a\u80fd\u7ba1\u7406\uff0c\u5e76\u4ee5\u6b64\u4e3a\u57fa\u7840\uff0c\u4e3a\u5fae\u670d\u52a1\u7684\u90e8\u7f72\u3001\u6d4b\u8bd5\u548c\u5347\u7ea7\u7b49\u64cd\u4f5c\u63d0\u4f9b\u6709\u529b\u4fdd\u969c \u5b89\u5168 \uff1a\u4e3a\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u63d0\u4f9b\u8ba4\u8bc1\u3001\u52a0\u5bc6\u548c\u9274\u6743\u652f\u6301\uff0c\u5728\u4e0d\u4fb5\u4eba \u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\uff0c\u52a0\u56fa\u73b0\u6709\u670d\u52a1\uff0c\u63d0\u9ad8\u5176\u5b89\u5168\u6027\u3002 \u7b56\u7565 \uff1a\u5728\u63a7\u5236\u9762\u5b9a\u5236\u7b56\u7565\uff0c\u5e76\u5728\u670d\u52a1\u4e2d\u5b9e\u65bd\u3002 \u89c2\u5bdf \uff1a\u5bf9\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u8fdb\u884c\u8ddf\u8e2a\u548c\u6d4b\u91cf\uff0c\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u4fe1\u606f\u3002 \u4e0b\u9762\u5bf9\u8fd9\u4e9b\u7279\u6027\u5c55\u5f00\u8be6\u7ec6\u63cf\u8ff0\u3002","title":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u7684\u57fa\u672c\u7279\u5f81"},{"location":"chap5/1Service_Mesh_Intro/#1","text":"\u5fae\u670d\u52a1\u9519\u7efc\u590d\u6742\uff0c\u8981\u5b8c\u6210\u5176\u4e1a\u52a1\u76ee\u6807\uff0c\u8fde\u63a5\u95ee\u9898\u662f\u9996\u8981\u95ee\u9898\u3002\u8fde\u63a5\u5b58\u5728\u4e8e\u6240\u6709 \u670d\u52a1\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\uff0c\u7528\u4e8e\u7ef4\u6301\u670d\u52a1\u7684\u8fd0\u884c\uff0c\u7b97\u5f97\u4e0a\u91cd\u4e2d\u4e4b\u91cd\u3002 \u76f8\u5bf9\u4e8e\u4f20\u7edf\u7684\u5355\u4f53\u5e94\u7528\uff0c \u5fae\u670d\u52a1\u7684\u7aef\u70b9\u6570\u91cf\u4f1a\u6025\u5267\u589e\u52a0 \uff0c\u73b0\u4ee3\u7684\u5e94\u7528\u7cfb\u7edf\u5728\u90e8\u5206\u6216\u8005\u5168\u90e8\u751f\u547d\u5468\u671f\u4e2d\uff0c\u90fd\u5b58\u5728\u540c\u4e00\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\uff0c\u4e3a\u4e0d\u540c\u7684\u5ba2\u6237\u3001\u573a\u666f\u6216\u8005\u4e1a\u52a1\u63d0\u4f9b\u4e0d\u540c\u7684\u670d\u52a1\u3002 \u540c\u65f6\uff0c\u540c\u4e00\u670d\u52a1\u7684\u4e0d\u540c\u7248\u672c\u4e5f\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u8bbf\u95ee\u8981\u6c42\uff0c\u751a\u81f3\u4ea7 \u751f\u4e86\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u8fdb\u884c\u6d4b\u8bd5\u7684\u65b0\u65b9\u6cd5\u8bba\u3002\u9519\u7efc\u590d\u6742\u7684\u670d\u52a1\u5173\u7cfb\u5bf9\u6240\u6709\u76f8\u5173\u5206\u5de5\u6765\u8bf4 \u90fd\u662f\u5f88\u4e25\u5cfb\u7684\u8003\u9a8c\u3002\u9488\u5bf9\u76ee\u524d\u7684\u5e38\u89c1\u4e1a\u52a1\u5f62\u6001\uff0c\u8fd9\u91cc\u753b\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u610f\u56fe\u6765\u63cf\u8ff0 Service Mesh \u7684\u8fde\u63a5\u529f\u80fd \u5982\u56fe\u6240\u793a\uff0c \u4ece\u4e0d\u540c\u7684\u5916\u90e8\u7528\u6237\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u4ed6\u4eec\u8bbf\u95ee\u7684\u90fd\u662f\u540c\u4e00\u670d\u52a1\u7aef\u53e3\uff0c \u4f46\u5b9e\u9645\u4e0a\u4f1a\u56e0\u4e3a\u4e0d\u540c\u7684\u7528\u6237\u8bc6\u522b\uff0c\u5206\u522b\u8bbf\u95ee\u670d\u52a1A\u7684\u4e0d\u540c\u7248\u672c \uff1b\u5728\u7f51\u683c\u5185\u90e8\uff0c\u670d\u52a1A\u7684\u7248\u672c1\u53ef\u80fd\u4f1a\u8bbf\u95ee\u670d\u52a1B\u7684\u4e24\u4e2a\u7248\u672c\uff0c\u670d\u52a1A\u7684\u7248\u672c2\u5219\u53ea\u4f1a\u8bbf\u95ee\u670d\u52a1B\u7684\u7248\u672c1\uff1b\u670d\u52a1B\u7684\u7248\u672c1\u9700\u8981\u8bbf\u95ee\u5916\u90e8\u7684\u4e91\u670d\u52a1\uff0c\u7248\u672c2\u5219\u65e0\u6b64\u9700\u6c42\u3002 \u5728\u8fd9\u4e2a\u7b80\u5316\u7684\u6a21\u578b\u4e2d\uff0c\u5305\u542b\u4e86\u4ee5\u4e0b\u8bc9\u6c42\uff1a \u7f51\u683c\u5185\u90e8\u7684\u8c03\u7528\uff08\u670d\u52a1A -> \u670d\u52a1B) \u51fa\u7ad9\u8fde\u63a5\uff08\u670d\u52a1B \u4e00> \u5916\u90e8\u4e91\u670d\u52a1\uff09 \u5165\u7ad9\u8fde\u63a5\uff08\u7528\u6237 -> \u670d\u52a1A); \u6d41\u91cf\u5206\u5272\uff08\u670d\u52a1A\u7684\u7248\u672c1\u5206\u522b\u8c03\u7528\u4e86\u670d\u52a1B\u7684\u7248\u672c1\u548c\u7248\u672c2); \u6309\u8c03\u7528\u65b9\u7684\u670d\u52a1\u7248\u672c\u8fdb\u884c\u8def\u7531\uff1b \u6309\u7528\u6237\u8eab\u4efd\u8fdb\u884c\u8def\u7531\u3002 \u8fd9\u91cc\u9664\u4e86\u8fd9\u4e9b\u95ee\u9898\uff0c\u8fd8\u5b58\u5728\u4e00\u4e9b\u6f5c\u5728\u9700\u6c42\uff0e\u5982\u4e0b\u6240\u8ff0\u3002 (1) \u5728\u7f51\u683c\u5185\u7684\u670d\u52a1\u4e4b\u95f4\u5982\u4f55\u6839\u636e\u5b9e\u9645\u9700\u8981\u5bf9\u670d\u52a1\u95f4\u7684\u8c03\u7528\u8fdb\u884c\u8def\u7531\u3001\u6761\u4ef6\u53ef\u80fd\u5305\u62ec\uff1a \u8c03\u7528\u6e90\u548c\u76ee\u7684\u7684\u670d\u52a1 \u8c03\u7528\u5185\u5bb9\uff1b \u8ba4\u8bc1\u8eab\u4efd (2) \u5982\u4f55\u5e94\u5bf9\u7f51\u7edc\u6545\u969c\u6216\u8005\u670d\u52a1\u6545\u964d\u3002 (3\uff09\u5982\u4f55\u5904\u7406\u4e0d\u540c\u670d\u52a1\u4e0d\u540c\u7248\u672c\u4e4b\u95ee\u7684\u5173\u7cfb\u3002 (4\uff09\u600e\u6837\u5bf9\u51fa\u7ad9\u8fde\u63a5\u8fdb\u884c\u63a7\u5236\u3002 (5\uff09\u600e\u6837\u63a5\u6536\u5165\u7ad9\u8fde\u63a5\u6765\u542f\u52a8\u540e\u7eed\u7684\u6574\u4e2a\u670d\u52a1\u94fe\u6761 \u8fd9\u4e9b\u5f53\u7136\u4e0d\u662f\u95ee\u9898\u7684\u5168\u90e8\uff0c\u5176\u4e2d\uff0c\u4e0e\u6d41\u91cf\u76f8\u5173\u7684\u95ee\u9898\u8fd8\u5f15\u53d1\u4e86\u51e0\u4e2a\u5173\u952e\u7684\u529f\u80fd\u9700\u6c42\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 (1) \u670d\u52a1\u6ce8\u518c\u548c\u53d1\u73b0 \uff1a\u8981\u6c42\u80fd\u591f\u5bf9\u7f51\u683c\u4e2d\u4e0d\u540c\u7684\u670d\u52a1\u548c\u4e0d\u540c\u7248\u8fdb\u884c\u51c6\u786e\u6807\u8bc6\uff0c\u4e0d\u540c\u7684\u670d\u52a1\u53ef\u4ee5\u7ecf\u7531\u540c\u4e00\u6ce8\u518c\u673a\u6784\u4f7f\u7528\u516c\u8ba4\u7684\u65b9\u5f0f\u4e92\u76f8\u67e5\u627e\u3002 (2) \u8d1f\u8f7d\u5747\u8861\u7b56 \uff1a\u4e0d\u540c\u7c7b\u578b\u7684\u670d\u52a1\u5e94\u8be5\u7531\u4e0d\u540c\u7684\u7b56\u7565\u6765\u6ee1\u8db3\u4e0d\u540c\u7684\u9700\u6c42 (3) \u670d\u52a1\u6d41\u91cf\u7279\u5f81 \uff1a \u5728\u670d\u52a1\u6ce8\u518c\u53d1\u73b0\u7684\u57fa\u7840\u4e0a\uff0c\u6839\u636e\u53cc\u65b9\u7684\u670d\u52a1\u8eab\u4efd\uff0c\u4ee5\u53ca\u670d\u52a1\u6d41\u91cf\u7279\u5f81\u6765\u8c03\u7528\u8fc7\u7a0b\u60ca\u9192\u7504\u522b (4) \u52a8\u6001\u6d41\u91cf\u5206\u914d \uff1a \u6839\u636e\u5bf9\u6d41\u91cf\u7279\u5f81\u7684\u8bc6\u522b\uff0c\u5728\u4e0d\u540c\u7684\u670d\u52a1\u548c\u7248\u672c\u4e4b\u95f4\u5bf9\u6d41\u91cf\u8fdb\u884c\u5f15\u5bfc \u8fde\u63a5\u662f\u670d\u52a1\u7f51\u683c\u5e94\u7528\u8fc7\u7a0b\u4e2d\u4ece\u65e0\u5230\u6709\u7684\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u73af\u8282","title":"1.\u8fde\u63a5"},{"location":"chap5/1Service_Mesh_Intro/#2","text":"\u5b89\u5168\u4e5f\u662f\u4e00\u4e2a\u5e38\u8c08\u5e38\u65b0\u7684\u8bdd\u9898\u5728\u8fc7\u53bb\u79c1\u6709\u57fa\u7840\u8bbe\u65bd\u7ed3\u5408\u5355\u5e94\u7528\u7684\u73af\u5883\u4e0b\uff0c\u8fd9\u4e00\u95ee\u9898\u5e76\u4e0d\u7a81\u51fa\uff0c\u7136\u800c\u8fdb\u4eba\u5bb9\u5668\u4e91\u65f6\u4ee3\u4e4b\u540e\uff0c\u4ee5\u4e0b\u95ee\u9898\u51fa\u73b0 \u6709\u5927\u91cf\u5bb9\u5668\u6f02\u6d6e\u5728\u5bb9\u5668\u4e91\u4e2d \uff0c\u91c7\u7528\u4f20\u7edf\u7684\u7f51\u7edc\u7b56\u7565\u5e94\u5bf9\u8fd9\u79cd\u6d6e\u52a8\u7684\u5e94\u7528\u6bd4\u8f83\u5403\u529b\u7684\u3002 \u5728\u7531\u4e0d\u540c\u7684\u8bed\u8a00\u3001\u5e73\u53f0\u6240\u5b9e\u73b0\u7684\u5fae\u670d\u52a1\u4e4b\u95f4\uff0c\u5b9e\u65bd\u4e00\u81f4\u7684\u8bbf\u95ee\u63a7\u5236\u4e5f\u7ecf\u5e38\u4f1a\u56e0\u4e3a\u5b9e\u73b0\u7684\u4e0d\u4e00\u81f4\u800c\u56f0\u96be\u91cd\u91cd\u3002 \u5982\u679c\u662f\u5171\u4eab\u96c6\u7fa4\uff0c\u5219\u670d\u52a1\u7684\u8ba4\u8bc1\u548c\u52a0\u5bc6\u53d8\u5f97\u5c24\u4e3a\u91cd\u8981\uff0c\u4f8b\u5982\uff1a \u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u8981\u9632\u6b62\u88ab\u5176\u4ed6\u670d\u52a1\u76d1\u542c \u53ea\u6709\u63d0\u4f9b\u6709\u6548\u8eab\u4efd\u7684\u5ba2\u6237\u7aef\u624d\u53ef\u4ee5\u8bbf\u95ee\u6307\u5b9a\u7684\u670d\u52a1 \u670d\u52a1\u4e4b\u95f4\u7684\u4e92\u8bbf\u5e94\u8be5\u63d0\u4f9b\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\u529f\u80fd \u603b\u4e4b\uff0c\u8981\u63d0\u4f9b\u7f51\u683c\u5185\u90e8\u7684\u5b89\u5168\u4fdd\u969c\uff0c\u5c31\u5e94\u5177\u5907\u670d\u52a1\u901a\u4fe1\u52a0\u5bc6\u3001\u670d\u52a1\u8eab\u4efd\u8be2\uff0c \u670d\u52a1\u8bbf\u95ee\u63a7\u5236\uff08\u6388\u6743\u548c\u9274\u6743\uff09\u529f\u80fd\u3002 \u4e0a\u8ff0\u529f\u80fd\u901a\u5e38\u9700\u8981\u6570\u5b57\u8bc1\u4e66\u7684\u652f\u6301\uff0c\u8fd9\u5c31\u9690\u85cf\u4e86\u5bf9 CA \u7684\u9700\u6c42\uff0c\u5373\u9700\u8981\u5b8c\u6210\u8bc1\u4e66\u7684\u7b7e\u53d1\u3001\u4f20\u64ad\u548c\u66f4\u65b0\u4e1a\u52a1\u3002 \u9664\u4e86\u4e0a\u8ff0\u6838\u5fc3\u8981\u6c42\uff0c\u8fd8\u5b58\u5728\u5bf9\u8ba4\u8bc1\u5931\u8d25\u7684\u5904\u7406\u3001\u5916\u90e8\u8bc1\u4e66\uff08\u7edf\u4e00CA\uff09\u7684\u63a5\u53e3\u7b49\u76f8\u5173\u652f\u6491\u5185\u5bb9\u3002","title":"2.\u5b89\u5168"},{"location":"chap5/1Service_Mesh_Intro/#3","text":"\u9664\u4e86\u524d\u9762\u63d0\u5230\u7684\u5b89\u5168\u95ee\u9898\uff0c\u5728\u7531\u5fae\u670d\u52a1\u6784\u6210\u7684\u7f51\u683c\u4e2d\uff0c\u6211\u4eec\u5e38\u5e38\u8fd8\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u63a7\u5236\uff0c\u4f8b\u5982\u5bf9\u8c03\u7528\u9891\u7387\u7684\u9650\u5236\u3001\u5bf9\u670d\u52a1\u4e92\u8bbf\u7684\u63a7\u5236\uff0c\u4ee5\u53ca\u9488\u5bf9\u6d41\u91cf\u7684\u4e00\u4e9b\u9650\u5236\u548c\u53d8\u66f4\u80fd\u529b\u7b49\u3002 \u5728 Istio \u4e2d\u4f7f\u7528 Mixer \u4f5c\u4e3a\u7b56\u7565\u7684\u6267\u884c\u8005\uff0c Envoy\u7684 \u6bcf\u6b21\u8c03\u7528\uff0c\u5728\u903b\u8f91\u4e0a\u90fd\u4f1a\u901a\u8fc7 Mixer \u8fdb\u884c\u4e8b\u5148\u9884\u68c0\u548c\u4e8b\u540e\u62a5\u544a\uff0c\u8fd9\u6837 Mixer \u5c31\u62e5\u6709\u4e86\u5bf9\u6d41\u91cf\u7684\u90e8\u5206\u63a7\u5236\u80fd\u529b \uff1b \u5728Istio\u3002\u4e2d\u8fd8\u6709\u4e3a\u6570\u4f17\u591a\u7684\u5185\u90e8\u9002\u914d\u5668\u53ca\u8fdb\u7a0b\u5916\u9002\u914d\u5668\uff0c\u53ef\u4ee5\u548c\u5916\u90e8\u8f6f\u4ef6\u8bbe\u65bd\u4e00\u540c\u5b8c \u6210\u7b56\u7565\u7684\u5236\u5b9a\u548c\u6267\u884c\u3002","title":"3.\u7b56\u7565"},{"location":"chap5/1Service_Mesh_Intro/#4","text":"\u968f\u7740\u670d\u52a1\u6570\u91cf\u7684\u589e\u52a0\uff0c\u76d1\u63a7\u548c\u8ddf\u8e2a\u9700\u6c42\u81ea\u7136\u6c34\u6da8\u8239\u9ad8\u3002\u5728\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u53ef\u89c2\u5bdf \u7684\u4fdd\u969c\u90fd\u662f\u7cfb\u7edf\u529f\u80fd\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\uff0c\u662f\u7cfb\u7edf\u8fd0\u7ef4\u529f\u80fd\u7684\u91cd\u8981\u4fdd\u969c\u3002 \u968f\u7740\u5ec9\u4ef7\u670d\u52a1\u5668\uff08\u76f8\u5bf9\u4e8e\u4f20\u7edf\u5c0f\u578b\u673a\uff09\u7684\u6570\u91cf\u8d8a\u6765\u8d8a\u591a\uff0c\u670d\u52a1\u5668\u53d1\u751f\u6545\u969c\u7684\u9891\u7387\u4e5f\u8d8a\u6765\u8d8a\u9ad8\uff0c\u4eba\u4eec\u5f00\u59cb\u5bf9 Cattle vs. Cat \u4ea7\u751f\u4e89\u8bba\uff1a\u6211\u4eec\u5e94\u8be5\u5c06\u670d\u52a1\u5668\u89c6\u4e3a\u5bb6\u755c\u8fd8\u662f\u5ba0\u7269\uff1f\u5bb6\u755c\u7684\u7279\u70b9\u662f\u6709\u529f\u80fd\u3001\u65e0\u4e2a\u6027\u3001\u53ef\u66ff\u6362\uff1b\u800c\u5ba0\u7269\u7684\u7279\u70b9\u662f\u6709\u529f\u80fd\u3001\u6709\u4e2a\u6027\u3001\u96be\u66ff\u6362\u3002 \u6211\u4eec\u8d8a\u6765\u8d8a\u503e\u5411\u4e8e\u5c06\u670d\u52a1\u5668\u89c6\u4e3a\u65e0\u4e2a\u6027\u3001\u53ef\u66ff\u6362\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u5982\u679c\u4e3b\u673a\u53d1\u751f\u6545\u969c\uff0c\u90a3\u4e48\u76f4\u63a5\u5c06\u5176\u66ff\u6362\u5373\u53ef \uff1b\u5e76\u4e14\uff0c\u6211\u4eec\u66f4\u52a0\u5173\u6ce8\u7684\u662f\u670d\u52a1\u7684\u603b\u4f53\u8d28\u91cf\u3002\u56e0\u6b64\uff0c\u5fae\u670d\u52a1\u7cfb\u7edf\u76d1\u63a7\uff0c\u9664\u4e86\u6709\u4f20\u7edf\u7684\u4e3b\u673a\u76d1\u63a7\uff0c\u8fd8\u66f4\u52a0\u91cd\u89c6\u9ad8\u5c42\u6b21\u7684\u670d\u52a1\u5065\u5eb7\u76d1\u63a7\u3002 \u670d\u52a1\u7684\u5065\u5eb7\u60c5\u51b5\u5f80\u5f80\u4e0d\u662f\u975e\u9ed1\u5373\u767d\u7684\u79bb\u6563\u503c\uff0c\u800c\u662f\u4e00\u7cfb\u5217\u8fde\u7eed\u72b6\u6001\uff0c\u4f8b\u5982\u6211\u4eec\u7ecf\u5e38\u9700\u8981\u5173\u6ce8\u670d\u52a1\u7684\u8c03\u7528 \u6210\u529f\u7387\u3001\u54cd\u5e94\u65f6\u95f4\u3001\u8c03\u7528\u91cf\u3001\u4f20\u8f93\u91cf\u7b49\u8868\u73b0 \uff1a \u800c\u4e14\uff0c\u9762\u5bf9\u6570\u91cf\u4f17\u591a\u7684\u670d\u52a1\uff0c\u6211\u4eec\u5e94\u8be5\u80fd\u5bf9\u5404\u79cd\u7ea7\u522b\u548c\u5c42\u6b21\u7684\u6307\u6807\u8fdb\u884c\u91c7\u6837\u3001\u91c7\u96c6\u53ca\u6c47\u603b\uff0c\u83b7\u53d6\u8f83\u4e3a\u7cbe\u5bc6\u3001\u7fd4\u5b9e\u7684\u8fd0\u884c\u6570\u636e\uff0c\u6700\u7ec8\u901a\u8fc7\u4e00\u5b9a\u7684\u65b9\u6cd5\u8fdb\u884c\u5f52\u7eb3\u603b\u7ed3\u548c\u5c55\u793a\u3002 \u4e0e\u6b64\u540c\u65f6\uff0c\u670d\u52a1\u7f51\u683c\u8fd8\u5e94\u63d0\u4f9b\u5206\u5e03\u5f0f\u8ddf\u8e2a( Distributed Tracing \uff09\u529f\u80fd\u5bf9\u670d\u52a1\u7684\u8c03\u7528\u94fe\u8def\u8fdb\u884c\u8ddf\u8e2a\u3002","title":"4.\u89c2\u5bdf"},{"location":"chap5/20Istio_Usage/","text":"\u7b2c\u4e8c\u5341\u8282 Istio\u7684\u8bd5\u7528\u5efa\u8bae \u524d\u9762\u5df2\u7ecf\u5c55\u793a\u4e86 istio \u7684\u5927\u591a\u6570\u529f\u80fd\uff0c\u5728\u65e0\u987b\u5bf9\u7a0b\u5e8f\u8fdb\u884c\u4fee\u6539\uff08\u5206\u5e03\u5f0f\u8ddf\u8e2a\u9664\u5916)\u7684\u60c5\u51b5\u4e0b\uff0c\u80fd\u5bf9\u5e94\u7528\u63d0\u4f9b\u5982\u6b64\u4e4b\u591a\u7684\u529f\u80fd\u652f\u6301\uff0c\u53ef\u4ee5\u8bc1\u660e Istio \u662f\u975e\u5e38\u6709\u5438\u5f15\u529b\u7684\u3002 Istio \u7684\u529f\u80fd\u96c6\u5b8c\u5168\u53ef\u4ee5\u8bf4\u662f\u670d\u52a1\u7f51\u683c\u6280\u672f\u7684\u5178\u8303\u3002 \u7136\u800c\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u65b0\u751f\u4e8b\u7269\uff0c Istio \u8fd8\u5f88\u521d\u7ea7\u7684\u3002\u867d\u7136\u524d\u9762\u8bb2\u4e86\u5f88\u591a\u529f\u80fd\uff0c\u4f46\u7b14\u8005\u8ba4\u4e3a\u5bf9\u4e8e\u9009\u578b\u51b3\u7b56\u6765\u8bf4\uff0c\u66f4\u91cd\u8981\u7684\u662f\uff1a \u8be5\u7cfb\u7edf\u5177\u6709\u4ec0\u4e48\u6837\u7684\u7f3a\u70b9\uff0c\u6211\u4eec\u80fd\u5426\u63a5\u53d7\uff0c \u5bf9\u4e8e\u65e0\u6cd5\u63a5\u53d7\u7684\u95ee\u9898\u662f\u5426\u53ef\u4ee5\u89c4\u907f\u3002\u4e0b\u9762\u4ec5\u5c31\u7b14\u8005\u4e2a\u4eba\u7684\u8ba4\u77e5\uff0c\u5217\u51fa Istio \u7684\u4e00\u4e9b\u95ee\u9898\uff0c\u540c\u65f6\u7ed3\u5408\u4ee5\u5f80\u7684\u7ecf\u9a8c\uff0c\u8c08\u8c08\u8bd5\u7528 Istio \u65f6\u7684\u4e00\u4e9b\u5efa\u8bae\u548c\u6ce8\u610f\u4e8b\u9879\u3002 \u7ed3\u5408 Istio \u7684\u73b0\u72b6\uff0c\u4ee5\u53ca\u591a\u6570\u4f01\u4e1a\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u4e2a\u4eba\u6d45\u89c1\uff1a Istio \u7684\u5e94\u7528\u5728\u73b0\u9636\u6bb5\u53ea\u80fd\u5c0f\u8303\u56f4\u8bd5\u63a2\u6027\u5730\u8fdb\u884c\uff0c\u5728\u8fdb\u884c\u8fc7\u7a0b\u4e2d\u8981\u4e25\u683c\u5b9a\u4e49\u8bd5\u7528\u8303\u56f4\uff0c\u4e25\u63a7\u5404\u4e2a\u6d41\u7a0b\u3002 \u6309\u7167\u4e2a\u4eba\u7ecf\u9a8c\uff0c\u7b14\u8005\u5c06\u8bd5\u7528\u8fc7\u7a0b\u5206\u4e3a\u5982\u4e0b4\u4e2a\u9636\u6bb5\u3002 \u8303\u56f4\u5b9a\u4e49 \uff1a\u9009\u62e9\u8fdb\u5165\u8bd5\u7528\u7684\u670d\u52a1\uff0c\u786e\u5b9a\u53d7\u5f71\u54cd\u7684\u8303\u56f4\uff0c\u5e76\u6839\u636e Istio \u9879\u76ee\u73b0\u72b6\u51b3\u5b9a\u9884\u5907\u4f7f\u7528\u7684 Istio \u76f8\u5173\u529f\u80fd\u3002\u56f4\u7ed5\u8fd9\u4e9b\u9700\u8981\uff0c\u5236\u5b9a\u8bd5\u7528\u9700\u6c42\u3002 \u65b9\u6848\u90e8\u7f72 \uff1a\u6839\u636e\u8303\u56f4\u5b9a\u4e49\u7684\u51b3\u7b56\uff0c\u5236\u5b9a\u548c\u6267\u884c\u76f8\u5173\u7684\u90e8\u7f72\u5de5\u4f5c\u3002\u5176\u4e2d\u5305\u542b Istio \u81ea\u8eab\u7684\u90e8\u7f72\u548c\u4e1a\u52a1\u670d\u52a1\u3001\u540e\u5907\u670d\u52a1\u7684\u90e8\u7f72\u5de5\u4f5c\u3002 \u6d4b\u8bd5\u9a8c\u8bc1 \uff1a\u6839\u636e\u65e2\u6709\u4e1a\u52a1\u76ee\u6807\u5bf9\u90e8\u7f72\u7ed3\u679c\u8fdb\u884c\u6d4b\u8bd5\u3002 \u5207\u6362\u6f14\u7ec3 \uff1a\u9632\u5fa1\u63aa\u65bd\uff0c\u7528\u4e8e\u5728\u4e1a\u52a1\u5931\u8d25\u65f6\u5207\u56de\u5230\u539f\u6709\u7684\u7a33\u5b9a\u73af\u5883\u3002\u4e0b\u9762\u4f1a\u6839\u636e\u8fd9\u51e0\u70b9\u5185\u5bb9\uff0c\u9010\u4e00\u5c55\u5f00\u8ba8\u8bba\uff09 1\u3001 Istio \u81ea\u8eab\u7684\u7a81\u51fa\u95ee\u9898 API \u7a33\u5b9a\u6027\u53ef\u80fd\u662f\u6700\u4e25\u91cd\u7684\u4e00\u4e2a\u95ee\u9898\u3002\u76ee\u524d\u6700\u6210\u719f\u7684\u529f\u80fd\u7ec4\u522b\u5e94\u8be5\u662f\u6d41\u91cf\u63a7\u5236\uff0c\u5176\u7248\u672c\u53f7\u4e5f\u4ec5\u662f v1alpha 3 \u3002\u4e00\u822c\u6765\u8bf4\uff0c alpha \u9636\u6bb5\u7684\u4ea7\u54c1\uff0c\u4e0d\u4f1a\u63d0\u4f9b\u5411\u540e\u517c\u5bb9\u7684\u627f\u8bfa\uff0c\u6d41\u91cf\u63a7\u5236 API \u5728\u4ece v1alpha 2 \u5347\u7ea7\u4e3a v1alpha 3 \u7684\u8fc7\u7a0b\u4e2d\uff0c API \u51e0\u4e4e\u5168\u90e8\u6539\u5199\uff0c\u4f7f\u5f97\u5f88\u591a\u65e9\u671f\u7528\u6237\u7684\u7cbe\u529b\u6295\u5165\u4ed8\u8bf8\u4e1c\u6d41\u3002\u6838\u5fc3\u529f\u80fd\u5c1a\u4e14\u5982\u6b64\uff0c\u66f4\u522b\u63d0\u76f8\u5bf9\u6bd4\u8f83\"\u8fb9\u7f18\u201d\u7684 Mixer , Citadel \u53ca Galley \u7ec4\u4ef6\u7684\u76f8\u5173\u5185\u5bb9\u3002 Istio \u7684\u53d1\u5e03\u8282\u594f\u548c\u53d1\u5e03\u8d28\u91cf\u65b9\u9762\u7684\u95ee\u9898\u4e5f\u76f8\u5f53\u4e25\u91cd\u3002\u5728 Istio \u5e76\u4e0d\u7b97\u957f\u7684\u5386\u53f2\u4e2d\u51fa\u73b0\u4e86\u591a\u6b21\u7248\u672c\u64a4\u56de\u3001\u5927\u7248\u672c\u4e25\u91cd\u5ef6\u671f\u3001\u53d1\u5e03\u8d28\u91cf\u4f4e\u4e0b\u65e0\u6cd5\u4f7f\u7528\u53ca Bug \u53cd\u590d\u7b49\u72b6\u51b5\uff0c\u8fd9\u65e0\u7591\u4f1a\u8ba9\u6bcf\u6b21\u5347\u7ea7\u5c1d\u8bd5\u90fd\u5145\u6ee1\u4e86\u4e0d\u786e\u5b9a\u6027\uff0c\u4f1a\u6781\u5927\u5f71\u54cd\u751f\u4ea7\u8fc7\u7a0b\u7684\u8fde\u7eed\u6027\u3002 Mixer \uff1a\u662f\u4e00\u4e2a\u95ee\u9898\u7126\u70b9\uff0c\u5176\u6570\u636e\u6a21\u578b\u8f83\u4e3a\u590d\u6742\uff0c\u5e76\u4e14\u5c06\u6240\u6709\u5e94\u7528\u7684\u6d41\u91cf\u96c6\u4e00\u70b9\uff0c\u867d\u7136\u5728\u5176\u4e2d\u52a0\u5165\u4e86\u5404\u79cd\u7f13\u5b58\u7b49\u6280\u672f\u6765\u51cf\u5c11\u5ef6\u8fdf\uff0c\u4f46\u662f\u5176\u72ec\u7279\u5730\u4f4d\u51b3\u5b9a\u4e86 Mixer \u59cb\u7ec8\u5904\u4e8e\u4e00\u4e2a\u9ad8\u98ce\u9669\u7684\u4f4d\u7f6e\u3002 Pilot \u5728\u6027\u80fd\u65b9\u9762\u4e5f\u7ecf\u5e38\u88ab\u4eba\u57a2\u75c5\uff0c\u867d\u7136\u7ecf\u8fc7\u51e0\u6b21\u5347\u7ea7\uff0c\u4f46\u4ecd\u5728 1.0 \u7248\u672c\u4e4b\u540e\uff0c\u51fa\u73b0\u4e86 Pilot \u5728\u96c6\u7fa4\u4e2d\u670d\u52a1\u6216 Pod \u8fc7\u591a\u7684\u60c5\u51b5\u4e0b\u4f1a\u8d85\u91cf\u6d88\u8017\u8d44\u6e90\u7684\u4e24\u6b21\u72b6\u51b5\u3002 \u5b89\u5168\u3001\u7269\u7406\u673a\u548c\u865a\u62df\u673a\u7684\u652f\u6301\u53ca\u7f51\u683c\u8fb9\u7f18\u901a\u4fe1\u8fd9\u4e8c\u7ec4\u529f\u80fd\u3002\u76ee\u524d\u7528\u6237\u8f83\u5c11\uff0c\u8d28\u91cf\u5c1a\u4e0d\u660e\u786e\u3002 \u6700\u540e\u5c31\u662f Istio sidecar \u6ce8\u4eba\u6a21\u5f0f\uff0c\u8fd9\u79cd\u6a21\u5f0f\u4e00\u5b9a\u4f1a\u589e\u52a0\u670d\u52a1\u95f4\u8c03\u7528\u7684\u7f51\u7edc\u5ef6\u8fdf\uff0c\u76ee\u524d\u662f\u4e00\u4e2a\u987d\u75be, Sidecar \u7684\u56fa\u5b9a\u5ef6\u8fdf\u548c Mixer \u7684\u4e0d\u786e\u5b9a\u884c\u4e3a\u76f8\u7ed3\u5408\uff0c\u6709\u53ef\u80fd\u4f1a\u4ea7\u751f\u4e25\u91cd\u540e\u679c \u3002 \u8fd9\u91cc\u63d0\u51fa\u7684\u53ea\u662f\u88ab\u53cd\u590d\u63d0\u53ca\u6216\u8005\u7ecf\u5e38\u51fa\u73b0\u5728 Issue \u5217\u8868\u4e2d\u7684\u95ee\u9898\uff0c\u4ece\u53d1\u5e03\u7684\u95ee\u9898\u6765\u770b\uff0c\u9762\u4e34\u7684\u98ce\u9669\u53ef\u80fd\u8fdc\u4e0d\u6b62\u8fd9\u4e9b\u3002 2\u3001\u786e\u5b9a\u529f\u80fd\u8303\u56f4 \u5728 Istio \u4e2d\u5305\u542b\u4e86\u975e\u5e38\u591a\u7684\u529f\u80fd\u70b9\uff0c\u4ece\u539f\u5219\u4e0a\u6765\u8bf4\uff0c\u5404\u79cd\u529f\u80fd\u90fd\u662f\u6709\u5176\u5b9e\u9645\u4f5c\u7528\u7684\u7136\u800c\uff0c Istio \u4f5c\u4e3a\u4e00\u4e2a\u65b0\u4ea7\u54c1\uff0c\u672c\u8eab\u4e5f\u6709\u5f88\u591a\u4e0d\u8db3. Istio \u63d0\u4f9b\u7684\u4f17\u591a\u529f\u80fd\u5bf9\u6bcf\u4e2a\u516c\u53f8\u6216\u8005\u9879\u76ee\uff0c\u90fd\u4f1a\u6709\u4e0d\u540c\u4ef7\u503c\u3002\u6211\u4eec\u5728\u91c7\u7528\u4e00\u4e2a \u65b0\u7cfb\u7edf\u65f6\uff0c\u9996\u5148\u8981\u8003\u8651\u7684\u5c31\u662f\u6027\u4ef7\u6bd4\u95ee\u9898\uff0c\u8fd9\u91cc\u7684\u201c\u4ef7\" \u5bf9\u4e1a\u52a1\u5e94\u7528\u7684\u5f71\u54cd\uff0c\u8fd8\u5305\u62ec\u53ef\u80fd\u51fa\u73b0\u7684\u670d\u52a1\u505c\u673a\u7b49\u95ee\u9898 \u4ee3\u8868\u7740 Istio \u5e26\u6765\u7684\u98ce\u9669\u3001 \u7b14\u8005\u66fe\u7ecf\u505a\u51fa\u8fd9\u6837\u4e00\u4e2a\u6027\u4ef7\u6bd4\u7684\u964d\u5e8f\u6392\u5217\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u670d\u52a1\u76d1\u63a7\u548c\u8ddf\u8e2a \uff1a\u5bf9\u5b58\u91cf\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\u8d28\u91cf\u53ef\u89c6\u5316\u652f\u6301\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u5b9e\u73b0\u6307\u6807\u548c\u65e5\u5fd7\u7684\u5b9a\u5236\uff0c\u6709\u6548\u5730\u6839\u636e\u670d\u52a1\u8d28\u91cf\u7684\u53d8\u5316\u63d0\u4f9b\u544a\u8b66\u548c\u5206\u6790\u652f\u6301\u3002 \u8def\u7531\u7ba1\u7406 \uff1a\u80fd\u6709\u6548\u5730\u652f\u6301\u7248\u672c\u66f4\u65b0\u548c\u56de\u6eda\u3001\u91d1\u4e1d\u96c0\u6d4b\u8bd5\u7b49\u53d1\u5e03\u76f8\u5173\u7684\u529f\u80fd\uff1b\u5e76\u4e14\u5176\u4e2d\u7684\u91cd\u8bd5\u63a7\u5236\u3001\u8d85\u65f6\u63a7\u5236\u5bf9\u5e94\u5bf9\u7f51\u7edc\u6ce2\u52a8\u975e\u5e38\u5177\u6709\u5b9e\u9645\u610f\u4e49\uff1b\u540c\u65f6\uff0c\u6545\u969c\u6ce8\u5165\u548c\u6d41\u91cf\u590d\u5236\u529f\u80fd\u5bf9\u6d4b\u8bd5\u6765\u8bf4\u4e5f\u662f\u5f88\u6709\u5e2e\u52a9\u7684\u3002 \u9650\u6d41\u548c\u9ed1\u767d\u540d\u5355\u529f\u80fd \uff1a\u80fd\u6709\u6548\u5730\u63d0\u9ad8\u670d\u52a1\u7684\u5065\u58ee\u6027\uff1b\u4f46\u662f\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c\u98ce\u9669\u5df2\u7ecf\u5f00\u59cb\u63d0\u9ad8\u4e86\u3002 mTLS \u548c RBAC \u529f\u80fd \uff1a\u5927\u5e45\u63d0\u9ad8\u5b89\u5168\u6027\uff0c\u5e26\u6765\u7684\u4ee3\u4ef7\u662f\u56e0\u4e3a\u914d\u7f6e\u9519\u8bef\u6216\u8005\u8bc1\u4e66\u8f6e\u8f6c\u7b49\u95ee\u9898\uff0c\u9020\u6210\u670d\u52a1\u4e2d\u65ad\u7684\u98ce\u9669\u3002 \u5f53\u7136\uff0c\u6bcf\u4e2a\u4e0d\u540c\u7684\u7ec4\u7ec7\u90fd\u53ef\u80fd\u4f1a\u6709\u81ea\u5df1\u7684\u8bc4\u5224\u65b9\u6cd5\uff0c\u8fd9\u91cc\u7684\u6392\u5217\u4ec5\u4f9b\u53c2\u8003\u3002 \u5728\u5236\u5b9a\u4e86\u4f18\u5148\u7ea7\u5217\u8868\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6839\u636e\u8fd9\u4e00\u5217\u8868\uff0c\u7ed3\u5408\u9879\u76ee\u7684\u5b9e\u9645\u9700\u6c42\uff0c\u6309\u7167\u6548\u679c\u660e\u663e\u3001\u529f\u80fd\u7a33\u5b9a\u3001\u90e8\u7f72\u6210\u672c\u4f4e\u3001\u5c11\u6539\u9020\u6216\u8005\u4e0d\u6539\u9020\u7684\u6807\u51c6\u6765\u8fdb\u884c\u9009\u62e9\uff0c\u6700\u7ec8\u786e\u5b9a\u5f85\u6d4b\u8bd5\u7684\u529f\u80fd\u70b9\u3002 \u5728\u9009\u5b9a\u529f\u80fd\u70b9\u4e4b\u540e\uff0c\u5e94\u8be5\u9075\u5faa\u76ee\u524d\u5df2\u6709\u7684 Istio \u6587\u6863\uff0c\u5bf9\u5404\u4e2a\u529f\u80fd\u70b9\u8fdb\u884c\u5355\u9879\u6d4b\u8bd5\u548c\u9a8c\u8bc1\uff0c\u4ee5\u786e\u4fdd\u5176\u6709\u6548\u6027\u3002\u5e76\u901a\u8fc7\u5b98\u65b9 GitHub \u7684 Issue \u5217\u8868\u53ca\u8ba8\u8bba\u7ec4\u5185\u5bb9\uff0c\u4e86\u89e3\u73b0\u6709\u529f\u80fd\u662f\u5426\u5b58\u5728\u5f85\u89e3\u51b3\u7684\u95ee\u9898\uff0c\u4ee5\u53ca\u76f8\u5173\u7684\u6ce8\u610f\u4e8b\u9879\u7b49\u3002 3\u3001\u9009\u62e9\u8bd5\u7528\u4e1a\u52a1 \u5728\u8bd5\u7528\u529f\u80fd\u70b9\u786e\u5b9a\u4e4b\u540e\uff0c\u5c31\u8981\u9009\u62e9\u7528\u4e8e\u8bd5\u7528\u7684\u4e1a\u52a1\u5e94\u7528\u4e86\u3002 Istio \u4f5c\u4e3a\u4e00\u4e2a\u76f8\u5bf9\u5e95\u5c42\u7684\u7cfb\u7edf\uff0c\u5176\u90e8\u7f72\u548c\u8c03\u8bd5\u8fc7\u7a0b\u5fc5\u7136\u4f1a\u5bf9\u4e1a\u52a1\u4ea7\u751f\u4e00\u5b9a\u7684\u5f71\u54cd\uff0c\u5728\u8fd0\u884c\u9636\u6bb5\u53c8\u6709 Sidecar \u548c\u5404\u4e2a\u7ec4\u4ef6\u9020\u6210\u7684\u635f\u8017\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u6240\u6709\u7f51\u683c\u4e4b\u95f4\u7684\u901a\u4fe1\u90fd\u8981\u7ecf\u8fc7 Sidecar \u7684\u4e2d\u8f6c\uff0c\u4f1a\u9020\u6210\u5927\u7ea6 10 \u6beb\u79d2\u7684\u5ef6\u8fdf\u3002 Pilot \u5bf9\u96c6\u7fa4\u89c4\u6a21\u654f\u611f\uff0c\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u6570\u91cf\u3001 Pod \u6570\u91cf\u90fd\u53ef\u80fd\u5bf9 Pilot \u9020\u6210\u8f83\u5927\u5f71\u54cd\uff0c\u4e5f\u4f1a\u5f71\u54cd\u5230 Istio \u5404\u79cd\u89c4\u5219\u5411 Pod \u7684\u4f20\u8f93\u8fc7\u7a0b\u3002 \u6240\u6709\u6d41\u91cf\u90fd\u4f1a\u7ecf\u7531 Mixer \u5904\u7406\uff0c\u4e5f\u6709\u9020\u6210\u74f6\u9888\u7684\u53ef\u80fd\u3002 \u5b89\u5168\u529f\u80fd\u8bbe\u7f6e\u4e0d\u5f53\u540c\u6837\u4f1a\u9020\u6210\u670d\u52a1\u4e2d\u65ad\u3002 \u5982\u4e0a\u6240\u8ff0\u8fd8\u53ea\u662f\u4e2a\u6982\u8981\uff0c\u5bf9\u4e1a\u52a1\u6765\u8bf4\uff0c\u5bf9\u8fd9\u4e9b\u98ce\u9669\u90fd\u662f\u5fc5\u987b\u6b63\u89c6\u5e76\u505a\u597d\u9884\u6848\u7684\u3002 \u4e3a\u4e86\u907f\u514d\u5f15\u8d77\u8fc7\u5927\u635f\u5931\uff0c\u5efa\u8bae\u5c06\u5982\u4e0b\u6807\u51c6\u4f5c\u4e3a\u9009\u62e9\u8bd5\u7528\u670d\u52a1\u7684\u4f9d\u636e\u3002 \u80fd\u591f\u5bb9\u5fcd\u4e00\u5b9a\u7684\u4e2d\u65ad\u65f6\u95f4\uff1a\u4e0d\u7ba1\u662f Istio \u8fd8\u662f\u5176\u4ed6\u65b0\u6280\u672f\u7684\u91c7\u7528\uff0c\u90fd\u53ef\u80fd\u4f1a\u9020\u6210\u670d\u52a1\u4e2d\u65ad\uff0c\u5e94\u8be5\u907f\u514d\u9009\u62e9\u4f7f\u7528\u5173\u952e\u4e1a\u52a1\u8fdb\u884c\u8bd5\u70b9 \u5bf9\u5ef6\u8fdf\u4e0d\u654f\u611f\uff1a\u5bf9\u4e8e\u9ad8\u9891\u5ea6\u3001\u4f4e\u5ef6\u8fdf\u7684\u670d\u52a1\u7c7b\u578b\uff0c Sidecar \u9020\u6210\u7684\u56fa\u5b9a\u5ef6\u8fdf\u603b\u4f53\u6765\u770b\u4f1a\u975e\u5e38\u53ef\u89c2\uff0c\u56e0\u6b64\u4e0d\u5efa\u8bae\u91c7\u7528\u8fd9\u79cd\u8d1f\u8f7d\u7c7b\u578b\u7684\u4e1a\u52a1\u4f5c\u4e3a\u8bd5\u7528\u670d\u52a1\u3002 \u8c03\u7528\u6df1\u5ea6\u8f83\u6d45\uff1a\u4e00\u4e2a\u8bd5\u7528\u670d\u52a1\u5982\u679c\u5305\u542b\u592a\u591a\u5c42\u6b21\uff0c\u5219\u6bcf\u4e2a\u5c42\u6b21\u4e4b\u95f4\u90fd\u4f1a\u56e0\u4e3a Sidecar \u7684\u5ef6\u8fdf\u53d8\u6162\u5c11\u8bb8\uff0c\u4f46\u662f\u53e0\u52a0\u8d77\u6765\u4f1a\u4f7f\u5f97\u6574\u4e2a\u4e1a\u52a1\u4ea7\u751f\u6bd4\u8f83\u660e\u663e\u7684\u5ef6\u8fdf\u3002 \u80fd\u591f\u65b9\u4fbf\u5730\u56de\u6eda\u548c\u5207\u6362\uff1a\u5e94\u8be5\u5728\u524d\u7aef\u8d1f\u8f7d\u5747\u8861\u5668\u3001\u53cd\u5411\u4ee3\u7406\u65b9\u800c\u505a\u597d\u5207\u6362\u51c6\u5907\uff0c\u5728\u670d\u52a1\u53d1\u751f\u4e2d\u65ad\u65f6\uff0c\u80fd\u591f\u8fc5\u901f\u5207\u56de\u539f\u6709\u73af\u5883\u3002 \u5177\u5907\u6210\u719f\u5b8c\u5584\u7684\u529f\u80fd\u3001\u6027\u80fd\u548c\u75b2\u52b3\u6d4b\u8bd5\u65b9\u6848\uff1a\u8bd5\u7528\u670d\u52a1\u7684\u4e0a\u7ebf\u5fc5\u987b\u6709\u4e00\u4e2a\u660e\u786e\u7684\u6807\u51c6\uff0c\u5e76\u4ee5\u7b26\u5408\u6807\u51c6\u7684\u6d4b\u8bd5\u7ed3\u679c\u6765\u5bf9\u6807\u51c6\u8fdb\u884c\u9a8c\u8bc1\u3002 4\u3001\u8c03\u7528\u8fc7\u7a0b \u5728\u9009\u62e9\u4e86 Istio \u529f\u80fd\u8fd9\u65b9\u9762\u7684\u5efa\u8bae\u3002\u80fd\u8303\u56f4\u548c\u8bd5\u7528\u670d\u52a1\u4e4b\u540e\uff0c\u5c31\u5e94\u8be5\u5f00\u59cb\u8bd5\u7528\u4e86\uff0c\u8fd9\u91cc\u5206\u4eab\u7b14\u8005\u5728 4-1 \u5236\u5ea6\u76ee\u6807 \u9996\u5148\u6309\u5206\u6790\u7c7b\u4f3c\uff0c \u7167\u73b0\u6709\u4e1a\u52a1\u7684\u5b9e\u9645\u9700\u8981\uff0c\u5bf9\u8bd5\u7528\u670d\u52a1\u8fdb\u884c\u529f\u80fd\u5206\u6790\u3002\u548c\u4f20\u7edf\u7684\u9700\u6c42\u529f\u80fd\u8981\u5728\u8be5\u8fc7\u7a0b\u4e2d\u660e\u786e\u4e00\u4e9b\u5177\u4f53\u7684\u9700\u6c42\u5185\u5bb9\u3002 \u73af\u5883\u9700\u6c42 \uff1a \u8bf4\u660e Istio \u90e8\u7f72\u6240\u9700\u7684 Kubernetes \u90e8\u7f72\u9700\u6c42\uff0c\u7684\u7cfb\u7edf\u8d44\u6e90\u9700\u6c42\uff0c\u5e76\u6839\u636e\u5b9e\u9645\u7684\u7ec4\u7ec7\u8fd0\u884c\u6d41\u7a0b\u8fdb\u884c\u7533\u8bf7\u3001\u4ee5\u53ca\u6574\u4f53\u529f\u80fd\u6240\u9700\u5206\u914d\uff0c\u5efa\u7acb\u73af\u5883\u9700\u6c42\u8bf4\u660e\u4e66\u4f9b\u540e\u7eed\u6b65\u9aa4\u6838\u5bf9\u3002 \u529f\u80fd\u6027\u9700\u6c42 \uff1a \u5728 Istio \u7684\u529f\u80fd\u4e2d\u9009\u62e9\u9700\u8981 Istio \u4e3a\u8bd5\u7528\u670d\u52a1\u63d0\u4f9b\u652f\u6491\u7684\u529f\u80fd\u5e94\u5f62\u6210\u529f\u80fd\u6d4b\u8bd5\u6848\u4f8b\u3002 \u670d\u52a1\u8d28\u91cf\u9700\u6c42 \uff1a \u6839\u636e\u73b0\u6709\u4e1a\u52a1\u7684\u8fd0\u884c\u72b6\u51b5\uff0c\u5bf9\u670d\u52a1\u8d28\u91cf\u63d0\u51fa\u5177\u4f53\u8981\u6c42\uff0c\u4f8b\u5982\u5e76\u53d1\u6570\u91cf\u3001\u54cd\u5e94\u65f6\u95f4\u3001\u6210\u529f\u7387\u7b49\uff0c\u5e94\u5f62\u6210\u6027\u80fd\u6d4b\u8bd5\u6848\u4f8b\u3002 \u6545\u969c\u5904\u7406\u9700\u6c42 \uff1a \u5bf9\u4e8e\u8bd5\u70b9\u5e94\u7528\u53d1\u751f\u6545\u969c\u65f6\uff0c\u5982\u4f55\u5728\u7f51\u683c\u548c\u975e\u7f51\u683c\u7248\u672c\u7684\u8bd5\u7528\u670d\u52a1\u4e4b\u95f4\u8fdb\u884c\u5207\u6362\u4ee5\u964d\u4f4e\u6545\u969c\u5f71\u54cd\uff0c\u5e94\u5f62\u6210\u6545\u969c\u9884\u6848\u3002 \u8fd9\u91cc\u9700\u8981\u91cd\u89c6\u7684\u4e00\u70b9\u662f\uff0c\u5728\u8bd5\u7528\u8fc7\u7a0b\u4e2d\uff0c\u975e\u5e38\u4e0d\u5efa\u8bae\"\u501f\u673a\u4f1a\"\u5bf9\u73b0\u6709\u8bd5\u70b9\u5e94\u7528\u8fdb\u884c\u4e1a\u52a1\u6216\u8005\u8d1f\u8f7d\u65b9\u9762\u7684\u6539\u52a8\uff0c\u4ee5\u514d\u8bd5\u7528\u8fc7\u7a0b\u9020\u6210\u5e72\u6270\uff0c\u6df7\u6dc6\u8bd5\u7528\u7ed3\u679c\u3002 \u53e6\u5916\uff0c\u5efa\u8bae\u5f62\u6210\u4e00\u4efd\u5173\u8054\u670d\u52a1\u5217\u8868, \u7528\u4e8e\u8bc4\u4f30\u8bd5\u7528\u670d\u52a1\u7684\u5f71\u54cd\u8303\u56f4\uff0c\u5c24\u5176\u662f\u5173\u7f51\u683c\u5916\u670d\u52a1\u7684\u5f15\u7528\u4f1a\u5f71\u54cd\u6ce8\u4eba\u884c\u4e3a\uff0c\u6709\u9700\u8981\u989d\u5916\u5173\u6ce8\u3002 4-2 \u65b9\u6848\u90e8\u7f72 \u8bd5\u7528\u65b9\u6848\u7684\u90e8\u7f72\u8fc7\u7a0b\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u513f\u6b65\u3002 Istio \u90e8\u7f72\u9996\u5148\u662f\u57fa\u672c\u73af\u5883\u7684\u51c6\u5907\uff0c\u6309\u7167\u5728\u4e0a\u8282\u4e2d\u5236\u5b9a\u7684\u73af\u5883\u9700\u6c42\uff0c\u590d\u67e5\u96c6\u7fa4\u73af\u5883\u3002 \u5982\u679c\u662f\u5185\u7f51\u90e8\u7f72\uff0c\u5219\u5e94\u8be5\u90e8\u7f72\u5185\u7f51\u53ef\u8fbe\u7684\u79c1\u6709\u955c\u50cf\u5e93\uff0c\u63a8\u9001\u5168\u90e8\u6240\u9700\u7684\u955c\u50cf\uff0c\u5e76\u5229 \u7528He In\uff1a\u53d8\u91cf\u8bbe\u7f6e\u5408\u7406\u7684\u955c\u50cf\u5730\u5740\u3002 \u63a5 \u4e0b\u6765\u6839\u636e\u8bd5\u7528\u9700\u6c42\uff0c\u5229\u7528 Helm \u5bf9 Istio \u90e8\u7f72\u8fdb\u884c\u8c03\u6574\uff0c\u8fd9\u65b9\u9762\u7684\u8c03\u6574\u4e3b\u8981\u5206\u4e3a\u4e24\u7c7b\uff1a \u8d44\u6e90\u8c03\u5ea6\u548c\u529f\u80fd\u88c1\u526a \uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u5148\u8bf4\u529f\u80fd\u8c03\u5ea6\uff0c Istio \u7684\u9ed8\u8ba4\u914d\u7f6e\u662f\u975e\u5e38\u4fdd\u5b88\u7684\uff0c\u7533\u8bf7\u7684 CPU \u548c\u5185\u5b58\u8d44\u6e90\u90fd\u5f88\u4f4e\uff0c \u5e76\u4e14\u6b8b\u7559\u4e86\u4e00\u90e8\u5206\u8c03\u8bd5\u4fe1\u606f\uff0c\u8fd9\u662f\u4e3a\u4e86\u8ba9\u6d4b\u8bd5\u7528\u6237\u5728\u5c3d\u91cf\u5c11\u6d88\u8017\u8d44\u6e90\u7684\u524d\u63d0\u4e0b\uff0c\u5c3d\u53ef\u80fd\u591a\u5730\u4f53\u9a8c Istio \u7684\u529f\u80fd\u800c\u8bbe\u8ba1\u7684\uff0c\u800c\u6211\u4eec\u7684\u76ee\u7684\u662f\u4e3a\u751f\u4ea7\u670d\u52a1\uff0c\u81ea\u7136\u5c31\u5e94\u8be5\u6839\u636e\u5b9e\u9645\u5e94\u7528\u8fdb\u884c\u8c03\u8282\u4e86\u3002 \u76ee\u524d\u53ef\u4ee5\u901a\u8fc7 values.yaml \u8fdb\u884c\u8c03\u6574\u7684\u8d44\u6e90\u9879\u76ee\u5982\u4e0b\u3002 proxy.resources \uff1a\u8d1f\u8d23\u6307\u5b9a Sidecar \u7684\u8d44\u6e90\u5206\u914d\u3002 defaultResources \uff1a\u8d1f\u8d23 Istio \u5404\u4e2a\u63a7\u5236\u9762\u7ec4\u4ef6\u7684\u9ed8\u8ba4\u8d44\u6e90\u5206\u914d\u3002 gateway.resources \uff1a\u8d1f\u8d23 Istio Gateway Controller \u7684\u8d44\u6e90\u5206\u914d\u3002 pilot.resources \uff1a\u8d1f\u8d23 Pilot \u7ec4\u4ef6\u7684\u8d44\u6e90\u5206\u914d\u3002 \u5728\u8bd5\u7528\u8fc7\u7a0b\u4e2d\uff0c\u5efa\u8bae\u8be6\u7ec6\u8c03\u6574\u5404\u4e2a\u7ec4\u4ef6\u53ca Sidecar \u7684\u8d44\u6e90\u8bbe\u7f6e\uff0c\u5e76\u542f\u7528 HPA . Istio \u5b98\u65b9\u7ed9\u51fa\u7684\u4e00\u4e9b\u8d44\u6e90\u5206\u914d\u5efa\u8bae\u5982\u4e0b \u3002 \u5728\u6bcf\u79d2\u6709 1000 \u4e2a\u8bf7\u6c42\u5e76\u6253\u5f00\u65e5\u5fd7\u7684\u60c5\u51b5\u4e0b\uff0c Sidecar \u9700\u8981 1 vCPU \u3002 Mixer \u9884\u68c0\u529f\u80fd\u5728\u6bcf\u79d2\u6709 1000 \u8bf7\u6c42\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u7f13\u5b58\u8fbe\u5230 80% \u7684\u547d\u4e2d\u7387\uff0c\u5219\u9700\u8981 0.5 vCPU \u3002 \u670d\u52a1\u95f4\u7684\u5ef6\u8fdf\u901a\u5e38\u4f1a\u589e\u52a0 10 \u6beb\u79d2\u3002 \u7b14\u8005\u7ed9\u51fa\u5982\u4e0b\u8865\u5145\u5efa\u8bae\u3002 \u5728\u8bd5\u7528\u8fc7\u7a0b\u4e2d\uff0c\u5c24\u5176\u662f\u5728\u538b\u529b\u6d4b\u8bd5\u6216\u4e1a\u52a1\u9ad8\u5cf0\u573a\u666f\u4e0b\uff0c\u5efa\u8bae\u5229\u7528\u8282\u70b9\u4eb2\u548c\u6027\u53ca Pod \u4eb2\u548c\u6027\u8bbe\u7f6e\uff0c\u5c06\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u5206\u79bb\uff0c\u4ee5\u5907\u5728\u51fa\u73b0\u6027\u80fd\u95ee\u9898\u65f6\u8fc5\u901f\u6392\u67e5\u3002 \u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u591a\u4e2a\u7ec4\u4ef6\u90fd\u5f00\u542f\u4e86\u8bbf\u95ee\u65e5\u5fd7\uff08\u53ef\u80fd\u6765\u81ea\u5404\u8fdb\u7a0b\u672c\u8eab\uff0c\u4e5f\u6709\u53ef\u80fd\u6765\u81ea stdio \u9002\u914d\u5668\uff09\uff0c\u8fd9\u800c\u53ef\u80fd\u4f1a\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff0c\u9700\u8981\u68c0\u67e5\u5e76\u8fdb\u884c\u8bbe\u7f6e\u3002 \u90e8\u5206\u7ec4\u4ef6\u5f00\u542f\u4e86\u8ddf\u8e2a\u529f\u80fd\uff0c\u4e5f\u53ef\u80fd\u4f1a\u5bf9\u6027\u80fd\u6709\u6240\u5f71\u54cd\u3002 \u5bf9\u670d\u52a1\u5668\u8282\u70b9\u7684 I/O \u8981\u4e25\u5bc6\u5173\u6ce8\uff0c\u4e5f\u5e94\u968f\u65f6\u6ce8\u610f Istio \u63a7\u5236\u9762\u5404\u5e94\u7528\u7684\u8d44\u6e90\u5360\u7528\u548cHPA\u5de5\u4f5c\u60c5\u51b5\u3002 \u5728\u8bbe\u7f6e\u597d\u8d44\u6e90\u53ca\u76f8\u5173\u9009\u9879\u4e4b\u540e\uff0c\u8fd8\u5e94\u6839\u636e\u8bd5\u7528\u76ee\u6807\u6765\u5bf9 Istio \u7ec4\u4ef6\u529f\u80fd\u8fdb\u884c\u88c1\u526a\uff0c\u4f8b\u5982: \u589e\u5220 Ingress Gateway Controller ; Prometheus , Grafana \u8fd9\u4e9b\u7b2c\u4e09\u65b9\u7ec4\u4ef6\u662f\u5426\u542f\u52a8\uff1b Galley \u6821\u9a8c Mixer \u9884\u68c0\u662f\u5426\u4f7f\u7528\u7b49\u3002 \u8fd8\u9700\u8981\u5bf9 Istio \u8fdb\u884c\u4e00\u4e9b\u4e2a\u6027\u5316\u914d\u7f6e\uff0c\u4f8b\u5982\u5f00\u653e\u7aef\u53e3\u3001Ingress\u8d44\u6e90\u7b49\u3002 \u4e0a \u8ff0\u8fd9\u4e9b\u5185\u5bb9\u90fd\u53ef\u4ee5\u5728 values.yarml \u4e2d\u8fdb\u884c\u914d\u7f6e\u3002 \u540e\u5907\u670d\u52a1\u90e8\u7f72 \u5728\u8fdb\u884c\u8bd5\u7528\u5e94\u7528\u7684\u6ce8\u5165\u4e4b\u524d\uff0c\u9996\u5148\u5e94\u8be5\u90e8\u7f72\u4e00\u7ec4\u5907\u4efd\u670d\u52a1\uff0c\u8fd9\u7ec4\u670d\u52a1\u9700\u8981\u548c\u6574\u4f53\u670d\u52a1\u7f51\u683c\u8fdb\u884c\u9694\u79bb\u3002\u8fd9\u4e00\u7ec4\u5907\u4efd\u670d\u52a1\u5e94\u5904\u4e8e\u5f85\u673a\u6a21\u5f0f\uff0c\u4ee5\u5907\u7f51\u683c\u7248\u672c\u7684\u5e94\u7528\u5728\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u8fdb\u884c\u6574\u4f53\u5207\u6362\u3002 \u57fa\u4e8e\u8fd9\u4e00\u70b9\u8003\u8651\uff0c\u8d1f\u8f7d\u5747\u8861\u7b49\u524d\u7aef\u63a7\u5236\u8bbe\u65bd\u4e5f\u5e94\u5907\u9f50\u3002 \u8bd5\u7528\u670d\u52a1\u90e8\u7f72 \u63a5\u4e0b\u6765\u8981\u628a\u8bd5\u7528\u670d\u52a1\u90e8\u7f72\u5230\u7f51\u683c\u4e2d\uff0c\u540c\u5176\u4ed6 Kubernetes \u4e00\u6837\uff0c\u7f51\u683c\u5e94\u7528\u7684\u90e8\u7f72\u4e5f\u662f\u4ece YAML \u4ee3\u7801\u5f00\u59cb\u7684\u3002\u539f\u6709\u5e94\u7528\u7684\u90e8\u7f72\u4ee3\u7801\u9700\u8981\u6839\u636e Istio \u6807\u51c6\u8fdb\u884c\u590d\u6838\uff0c\u68c0\u67e5\u5176\u4e2d\u7684\u7aef\u53e3\u547d\u540d\u3001\u6807\u7b7e\u8bbe\u7f6e\u3002 \u9664\u4e86\u5f85\u6ce8\u4eba\u7684\u5e94\u7528\u6e05\u5355\u6587\u4ef6\uff0c\u8fd8\u5e94\u8be5\u4e3a\u6bcf\u4e2a\u90e8\u7f72\u5355\u5143\u90fd\u63d0\u4f9b\u9ed8\u8ba4\u7684 VirtualService \u548c Destination Rule \uff0c\u5efa\u7acb\u57fa\u672c\u7684\u8def\u7531\u5173\u7cfb\uff0c\u63d0\u4f9b\u4e00\u4e2a\u8def\u7531\u57fa\u51c6\uff0c\u65b9\u4fbf \u5728\u8def\u7531\u8c03\u6574\u8fc7\u7a0b\u4e2d\u8fdb\u5bf9\u6bd4\u3002 \u5236\u5b9a\u7684\u5177\u4f53\u7f51\u683c\u9700\u6c42\u5217\u8868\uff0c\u9010\u4e2a\u7f16\u5199\u6240\u9700\u7684\u8def\u7531\u3001\u89c4\u5219\u7b49\u65b9\u9762\u7684\u914d\u7f6e\u5185\u5bb9\u3002 \u5728\u8fd9\u4e9b\u90fd\u5b8c\u6210\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6309\u7167\u987a\u5e8f\u9010\u4e2a\u63d0\u4ea4\u90e8\u7f72\u4e86\u3002 4. \u76d1\u63a7\u544a\u8b66\u90e8\u7f72 \u5728\u8bd5\u7528\u670d\u52a1\u90e8\u7f72\u4e4b\u540e\uff0c\u5c31\u6709\u66f4\u591a\u7684\u9879\u76ee\u53ef\u4ee5\u76d1\u6d4b\u4e86\uff0c\u8fd9\u91cc\u5efa\u8bae\u5c06\u5176\u81ea\u5e26\u7684 Prometheus \u8fdb\u884c\u53d8\u66f4\uff0c\u8fde\u63a5\u5230\u80fd\u591f\u6709\u6548\u53d1\u51fa\u544a\u8b66\u7684 Alertmanager \u7ec4\u4ef6\u4e0a\uff0c\u5e76\u4e3a\u4ee5\u4e0b\u51e0\u7ec4\u76ee\u6807\u8fdb\u884c\u76d1\u6d4b\u548c\u544a\u8b66\u3002 Pilot \u7684\u5185\u5b58\u548c Cpu \u5360\u7528\uff1a Pilot \u7684\u8d44\u6e90\u6d88\u8017\u95ee\u9898\u53cd\u590d\u51fa\u73b0\u591a\u6b21\uff0c\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u3002 Mixer \u7684\u5185\u5b58\u5360\u7528\uff1a Mixer \u7684\u7f13\u5b58\u5230\u76ee\u524d\u4e3a\u6b62\u8fd8\u5c1a\u672a\u5b8c\u5584\uff0c\u6709\u98ce\u9669\u3002 \u4e1a\u52a1\u5e94\u7528\u7684\u6210\u529f\u7387\uff1a\u5c24\u5176\u662f\u542f\u7528\u4e86 mTLS \u7684 Istio \u670d\u52a1\u7f51\u683c\uff0c\u5e94\u8be5\u7740\u91cd\u5173\u6ce8\u3002 \u4e1a\u52a1\u5e94\u7528\u7684\u54cd\u5e94\u65f6\u957f\uff1a\u54cd\u5e94\u65f6\u957f\u6709\u53ef\u80fd\u53d7\u5230 Envoy Sidecar \u548c Mixer/Adapter \u7684\u591a\u91cd\u5f71\u54cd\uff0c\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u3002 \u5173\u8054\u670d\u52a1\u5217\u8868\uff1a\u5e94\u6839\u636e\u5728\u4e0a\u8282\u4e2d\u5236\u5b9a\u7684\u5173\u8054\u670d\u52a1\u5217\u8868\uff0c\u63d0\u9ad8\u5bf9\u5f71\u54cd\u8303\u56f4\u5185\u7684\u670d\u52a1\u7684\u76d1\u63a7\u7ea7\u522b\u3002 4-3 \u6d4b\u8bd5\u9a8c\u8bc1 \u6839\u636e\u572820.4.1\u4e2d\u5236\u5b9a\u7684\u529f\u80fd\u9700\u6c42\u5bf9\u8bd5\u7528\u670d\u52a1\u8fdb\u884c\u529f\u80fd\u6d4b\u8bd5\uff0c\u5728\u6d4b\u8bd5\u901a\u8fc7\u4e4b\u8fdb\u884c\u6027\u80fd\u548c\u75b2\u52b3\u6d4b\u8bd5\uff0c\u89c2\u5bdf\u5404\u65b9\u9762\u7684\u6027\u80fd\u6307\u6807\u662f\u5426\u7b26\u5408\uff0c\u5982\u679c\u6027\u80fd\u51fa\u73b0\u4e0b\u964d\uff0c\u5219\u53ef\u4ee5\u5c1d\u8bd5\u6269\u5bb9\uff0c\u63d0\u9ad8\u8d44\u6e90\u5206\u914d\u7387\u3002\u5173\u952e\u7ec4\u4ef6\u53ef\u80fd\u662f Istio \u81ea\u8eab\u7684\u95ee\u9898, \u5e94\u68c0\u67e5\u793e\u533a Issue \u6216\u63d0\u51fa\u65b0\u7684 Issue \u3002 \u6b64\u5904\u662f\u4e00\u4e2a\u5173\u952e\u6b65\u9aa4\uff0c \u5982\u679c\u6d4b\u8bd5\u65b9\u6848\u4e0d\u7b26\u5408\u5b9e\u9645\u60c5\u51b5\u6216\u8005\u9884\u671f\u76ee\u6807\u65e0\u6cd5\u8fbe\u5230\uff0c\u5219\u5f3a\u70c8\u5efa\u8bae\u653e\u5f03\u8bd5\u7528\u3002 4-4 \u5207\u6362\u6f14\u7ec3 \u5728\u529f\u80fd \u548c\u6027\u80fd\u6d4b\u8bd5\u5168\u90e8\u901a\u8fc7\u4e4b\u540e\uff0c\u5c31\u5e94\u8be5\u8fdb\u884c\u8bd5\u7528\u670d\u52a1\u548c\u540e\u5907\u670d\u52a1\u4e4b\u95f4\u7684\u53cc\u5411\uff0c\u5728\u53cc\u65b9\u5207\u6362\u4e4b\u540e\u90fd\u5e94\u8be5\u91cd\u590d\u8fdb\u884c\u572820.4.3\u8282\u63d0\u5230\u7684\u9a8c\u8bc1\u8fc7\u7a0b\uff0c\u9632\u6b62\u6545\u969c\u53cd\u590d\u3002 \u5207\u6362\u6f14\u7ec3\u662f\u8bd5\u70b9\u5e94\u7528\u7684\u6700\u540e\u4e00\u9053\u4fdd\u9669\uff0c\u5728\u7f51\u683c\u4e25\u91cd\u6545\u969c\u4e4b\u540e\u80fd\u5426\u8fc5\u901f\u6062\u590d\u4e1a\u52a1\uff0c\u5168\u9760\u8fd9\u4e00\u6b65\u7684\u652f\u6301\u3002 4-5 \u8bd5\u70b9\u4e0a\u7ebf \u5728\u901a\u8fc7\u6d4b\u8bd5\u9a8c\u8bc1\u548c\u5207\u6362\u6f14\u7ec3\u7684\u8fc7\u7a0b\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5c06\u8bd5\u7528\u7684\u7f51\u683c\u5e94\u7528\u4e0a\u7ebf\u5230\u751f\u4ea7\u73af\u5883\u5f00\u59cb\u8bd5\u8fd0\u884c\u4e86\u3002\u548c\u6240\u6709\u5176\u4ed6\u4e0a\u7ebf\u6d3b\u52a8\u4e00\u6837\uff0c\u5728\u4e0a\u7ebf\u4e4b\u540e\u9700\u8981\u63d0\u9ad8\u76d1\u63a7\u7ea7\u522b\uff0c\u5173\u6ce8\u8bd5\u7528\u670d\u52a1\u81ea\u8eab\u548c\u8bd5\u7528\u670d\u52a1\u5f71\u54cd\u8303\u56f4\u5185\u7684\u76f8\u5173\u529f\u80fd\u7684\u5065\u5eb7\u60c5\u51b5\u3002","title":"\u7b2c\u4e8c\u5341\u8282 Istio\u7684\u8bd5\u7528\u5efa\u8bae"},{"location":"chap5/20Istio_Usage/#istio","text":"\u524d\u9762\u5df2\u7ecf\u5c55\u793a\u4e86 istio \u7684\u5927\u591a\u6570\u529f\u80fd\uff0c\u5728\u65e0\u987b\u5bf9\u7a0b\u5e8f\u8fdb\u884c\u4fee\u6539\uff08\u5206\u5e03\u5f0f\u8ddf\u8e2a\u9664\u5916)\u7684\u60c5\u51b5\u4e0b\uff0c\u80fd\u5bf9\u5e94\u7528\u63d0\u4f9b\u5982\u6b64\u4e4b\u591a\u7684\u529f\u80fd\u652f\u6301\uff0c\u53ef\u4ee5\u8bc1\u660e Istio \u662f\u975e\u5e38\u6709\u5438\u5f15\u529b\u7684\u3002 Istio \u7684\u529f\u80fd\u96c6\u5b8c\u5168\u53ef\u4ee5\u8bf4\u662f\u670d\u52a1\u7f51\u683c\u6280\u672f\u7684\u5178\u8303\u3002 \u7136\u800c\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u65b0\u751f\u4e8b\u7269\uff0c Istio \u8fd8\u5f88\u521d\u7ea7\u7684\u3002\u867d\u7136\u524d\u9762\u8bb2\u4e86\u5f88\u591a\u529f\u80fd\uff0c\u4f46\u7b14\u8005\u8ba4\u4e3a\u5bf9\u4e8e\u9009\u578b\u51b3\u7b56\u6765\u8bf4\uff0c\u66f4\u91cd\u8981\u7684\u662f\uff1a \u8be5\u7cfb\u7edf\u5177\u6709\u4ec0\u4e48\u6837\u7684\u7f3a\u70b9\uff0c\u6211\u4eec\u80fd\u5426\u63a5\u53d7\uff0c \u5bf9\u4e8e\u65e0\u6cd5\u63a5\u53d7\u7684\u95ee\u9898\u662f\u5426\u53ef\u4ee5\u89c4\u907f\u3002\u4e0b\u9762\u4ec5\u5c31\u7b14\u8005\u4e2a\u4eba\u7684\u8ba4\u77e5\uff0c\u5217\u51fa Istio \u7684\u4e00\u4e9b\u95ee\u9898\uff0c\u540c\u65f6\u7ed3\u5408\u4ee5\u5f80\u7684\u7ecf\u9a8c\uff0c\u8c08\u8c08\u8bd5\u7528 Istio \u65f6\u7684\u4e00\u4e9b\u5efa\u8bae\u548c\u6ce8\u610f\u4e8b\u9879\u3002 \u7ed3\u5408 Istio \u7684\u73b0\u72b6\uff0c\u4ee5\u53ca\u591a\u6570\u4f01\u4e1a\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u4e2a\u4eba\u6d45\u89c1\uff1a Istio \u7684\u5e94\u7528\u5728\u73b0\u9636\u6bb5\u53ea\u80fd\u5c0f\u8303\u56f4\u8bd5\u63a2\u6027\u5730\u8fdb\u884c\uff0c\u5728\u8fdb\u884c\u8fc7\u7a0b\u4e2d\u8981\u4e25\u683c\u5b9a\u4e49\u8bd5\u7528\u8303\u56f4\uff0c\u4e25\u63a7\u5404\u4e2a\u6d41\u7a0b\u3002 \u6309\u7167\u4e2a\u4eba\u7ecf\u9a8c\uff0c\u7b14\u8005\u5c06\u8bd5\u7528\u8fc7\u7a0b\u5206\u4e3a\u5982\u4e0b4\u4e2a\u9636\u6bb5\u3002 \u8303\u56f4\u5b9a\u4e49 \uff1a\u9009\u62e9\u8fdb\u5165\u8bd5\u7528\u7684\u670d\u52a1\uff0c\u786e\u5b9a\u53d7\u5f71\u54cd\u7684\u8303\u56f4\uff0c\u5e76\u6839\u636e Istio \u9879\u76ee\u73b0\u72b6\u51b3\u5b9a\u9884\u5907\u4f7f\u7528\u7684 Istio \u76f8\u5173\u529f\u80fd\u3002\u56f4\u7ed5\u8fd9\u4e9b\u9700\u8981\uff0c\u5236\u5b9a\u8bd5\u7528\u9700\u6c42\u3002 \u65b9\u6848\u90e8\u7f72 \uff1a\u6839\u636e\u8303\u56f4\u5b9a\u4e49\u7684\u51b3\u7b56\uff0c\u5236\u5b9a\u548c\u6267\u884c\u76f8\u5173\u7684\u90e8\u7f72\u5de5\u4f5c\u3002\u5176\u4e2d\u5305\u542b Istio \u81ea\u8eab\u7684\u90e8\u7f72\u548c\u4e1a\u52a1\u670d\u52a1\u3001\u540e\u5907\u670d\u52a1\u7684\u90e8\u7f72\u5de5\u4f5c\u3002 \u6d4b\u8bd5\u9a8c\u8bc1 \uff1a\u6839\u636e\u65e2\u6709\u4e1a\u52a1\u76ee\u6807\u5bf9\u90e8\u7f72\u7ed3\u679c\u8fdb\u884c\u6d4b\u8bd5\u3002 \u5207\u6362\u6f14\u7ec3 \uff1a\u9632\u5fa1\u63aa\u65bd\uff0c\u7528\u4e8e\u5728\u4e1a\u52a1\u5931\u8d25\u65f6\u5207\u56de\u5230\u539f\u6709\u7684\u7a33\u5b9a\u73af\u5883\u3002\u4e0b\u9762\u4f1a\u6839\u636e\u8fd9\u51e0\u70b9\u5185\u5bb9\uff0c\u9010\u4e00\u5c55\u5f00\u8ba8\u8bba\uff09","title":"\u7b2c\u4e8c\u5341\u8282 Istio\u7684\u8bd5\u7528\u5efa\u8bae"},{"location":"chap5/20Istio_Usage/#1istio","text":"API \u7a33\u5b9a\u6027\u53ef\u80fd\u662f\u6700\u4e25\u91cd\u7684\u4e00\u4e2a\u95ee\u9898\u3002\u76ee\u524d\u6700\u6210\u719f\u7684\u529f\u80fd\u7ec4\u522b\u5e94\u8be5\u662f\u6d41\u91cf\u63a7\u5236\uff0c\u5176\u7248\u672c\u53f7\u4e5f\u4ec5\u662f v1alpha 3 \u3002\u4e00\u822c\u6765\u8bf4\uff0c alpha \u9636\u6bb5\u7684\u4ea7\u54c1\uff0c\u4e0d\u4f1a\u63d0\u4f9b\u5411\u540e\u517c\u5bb9\u7684\u627f\u8bfa\uff0c\u6d41\u91cf\u63a7\u5236 API \u5728\u4ece v1alpha 2 \u5347\u7ea7\u4e3a v1alpha 3 \u7684\u8fc7\u7a0b\u4e2d\uff0c API \u51e0\u4e4e\u5168\u90e8\u6539\u5199\uff0c\u4f7f\u5f97\u5f88\u591a\u65e9\u671f\u7528\u6237\u7684\u7cbe\u529b\u6295\u5165\u4ed8\u8bf8\u4e1c\u6d41\u3002\u6838\u5fc3\u529f\u80fd\u5c1a\u4e14\u5982\u6b64\uff0c\u66f4\u522b\u63d0\u76f8\u5bf9\u6bd4\u8f83\"\u8fb9\u7f18\u201d\u7684 Mixer , Citadel \u53ca Galley \u7ec4\u4ef6\u7684\u76f8\u5173\u5185\u5bb9\u3002 Istio \u7684\u53d1\u5e03\u8282\u594f\u548c\u53d1\u5e03\u8d28\u91cf\u65b9\u9762\u7684\u95ee\u9898\u4e5f\u76f8\u5f53\u4e25\u91cd\u3002\u5728 Istio \u5e76\u4e0d\u7b97\u957f\u7684\u5386\u53f2\u4e2d\u51fa\u73b0\u4e86\u591a\u6b21\u7248\u672c\u64a4\u56de\u3001\u5927\u7248\u672c\u4e25\u91cd\u5ef6\u671f\u3001\u53d1\u5e03\u8d28\u91cf\u4f4e\u4e0b\u65e0\u6cd5\u4f7f\u7528\u53ca Bug \u53cd\u590d\u7b49\u72b6\u51b5\uff0c\u8fd9\u65e0\u7591\u4f1a\u8ba9\u6bcf\u6b21\u5347\u7ea7\u5c1d\u8bd5\u90fd\u5145\u6ee1\u4e86\u4e0d\u786e\u5b9a\u6027\uff0c\u4f1a\u6781\u5927\u5f71\u54cd\u751f\u4ea7\u8fc7\u7a0b\u7684\u8fde\u7eed\u6027\u3002 Mixer \uff1a\u662f\u4e00\u4e2a\u95ee\u9898\u7126\u70b9\uff0c\u5176\u6570\u636e\u6a21\u578b\u8f83\u4e3a\u590d\u6742\uff0c\u5e76\u4e14\u5c06\u6240\u6709\u5e94\u7528\u7684\u6d41\u91cf\u96c6\u4e00\u70b9\uff0c\u867d\u7136\u5728\u5176\u4e2d\u52a0\u5165\u4e86\u5404\u79cd\u7f13\u5b58\u7b49\u6280\u672f\u6765\u51cf\u5c11\u5ef6\u8fdf\uff0c\u4f46\u662f\u5176\u72ec\u7279\u5730\u4f4d\u51b3\u5b9a\u4e86 Mixer \u59cb\u7ec8\u5904\u4e8e\u4e00\u4e2a\u9ad8\u98ce\u9669\u7684\u4f4d\u7f6e\u3002 Pilot \u5728\u6027\u80fd\u65b9\u9762\u4e5f\u7ecf\u5e38\u88ab\u4eba\u57a2\u75c5\uff0c\u867d\u7136\u7ecf\u8fc7\u51e0\u6b21\u5347\u7ea7\uff0c\u4f46\u4ecd\u5728 1.0 \u7248\u672c\u4e4b\u540e\uff0c\u51fa\u73b0\u4e86 Pilot \u5728\u96c6\u7fa4\u4e2d\u670d\u52a1\u6216 Pod \u8fc7\u591a\u7684\u60c5\u51b5\u4e0b\u4f1a\u8d85\u91cf\u6d88\u8017\u8d44\u6e90\u7684\u4e24\u6b21\u72b6\u51b5\u3002 \u5b89\u5168\u3001\u7269\u7406\u673a\u548c\u865a\u62df\u673a\u7684\u652f\u6301\u53ca\u7f51\u683c\u8fb9\u7f18\u901a\u4fe1\u8fd9\u4e8c\u7ec4\u529f\u80fd\u3002\u76ee\u524d\u7528\u6237\u8f83\u5c11\uff0c\u8d28\u91cf\u5c1a\u4e0d\u660e\u786e\u3002 \u6700\u540e\u5c31\u662f Istio sidecar \u6ce8\u4eba\u6a21\u5f0f\uff0c\u8fd9\u79cd\u6a21\u5f0f\u4e00\u5b9a\u4f1a\u589e\u52a0\u670d\u52a1\u95f4\u8c03\u7528\u7684\u7f51\u7edc\u5ef6\u8fdf\uff0c\u76ee\u524d\u662f\u4e00\u4e2a\u987d\u75be, Sidecar \u7684\u56fa\u5b9a\u5ef6\u8fdf\u548c Mixer \u7684\u4e0d\u786e\u5b9a\u884c\u4e3a\u76f8\u7ed3\u5408\uff0c\u6709\u53ef\u80fd\u4f1a\u4ea7\u751f\u4e25\u91cd\u540e\u679c \u3002 \u8fd9\u91cc\u63d0\u51fa\u7684\u53ea\u662f\u88ab\u53cd\u590d\u63d0\u53ca\u6216\u8005\u7ecf\u5e38\u51fa\u73b0\u5728 Issue \u5217\u8868\u4e2d\u7684\u95ee\u9898\uff0c\u4ece\u53d1\u5e03\u7684\u95ee\u9898\u6765\u770b\uff0c\u9762\u4e34\u7684\u98ce\u9669\u53ef\u80fd\u8fdc\u4e0d\u6b62\u8fd9\u4e9b\u3002","title":"1\u3001Istio\u81ea\u8eab\u7684\u7a81\u51fa\u95ee\u9898"},{"location":"chap5/20Istio_Usage/#2","text":"\u5728 Istio \u4e2d\u5305\u542b\u4e86\u975e\u5e38\u591a\u7684\u529f\u80fd\u70b9\uff0c\u4ece\u539f\u5219\u4e0a\u6765\u8bf4\uff0c\u5404\u79cd\u529f\u80fd\u90fd\u662f\u6709\u5176\u5b9e\u9645\u4f5c\u7528\u7684\u7136\u800c\uff0c Istio \u4f5c\u4e3a\u4e00\u4e2a\u65b0\u4ea7\u54c1\uff0c\u672c\u8eab\u4e5f\u6709\u5f88\u591a\u4e0d\u8db3. Istio \u63d0\u4f9b\u7684\u4f17\u591a\u529f\u80fd\u5bf9\u6bcf\u4e2a\u516c\u53f8\u6216\u8005\u9879\u76ee\uff0c\u90fd\u4f1a\u6709\u4e0d\u540c\u4ef7\u503c\u3002\u6211\u4eec\u5728\u91c7\u7528\u4e00\u4e2a \u65b0\u7cfb\u7edf\u65f6\uff0c\u9996\u5148\u8981\u8003\u8651\u7684\u5c31\u662f\u6027\u4ef7\u6bd4\u95ee\u9898\uff0c\u8fd9\u91cc\u7684\u201c\u4ef7\" \u5bf9\u4e1a\u52a1\u5e94\u7528\u7684\u5f71\u54cd\uff0c\u8fd8\u5305\u62ec\u53ef\u80fd\u51fa\u73b0\u7684\u670d\u52a1\u505c\u673a\u7b49\u95ee\u9898 \u4ee3\u8868\u7740 Istio \u5e26\u6765\u7684\u98ce\u9669\u3001 \u7b14\u8005\u66fe\u7ecf\u505a\u51fa\u8fd9\u6837\u4e00\u4e2a\u6027\u4ef7\u6bd4\u7684\u964d\u5e8f\u6392\u5217\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u670d\u52a1\u76d1\u63a7\u548c\u8ddf\u8e2a \uff1a\u5bf9\u5b58\u91cf\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\u8d28\u91cf\u53ef\u89c6\u5316\u652f\u6301\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u5b9e\u73b0\u6307\u6807\u548c\u65e5\u5fd7\u7684\u5b9a\u5236\uff0c\u6709\u6548\u5730\u6839\u636e\u670d\u52a1\u8d28\u91cf\u7684\u53d8\u5316\u63d0\u4f9b\u544a\u8b66\u548c\u5206\u6790\u652f\u6301\u3002 \u8def\u7531\u7ba1\u7406 \uff1a\u80fd\u6709\u6548\u5730\u652f\u6301\u7248\u672c\u66f4\u65b0\u548c\u56de\u6eda\u3001\u91d1\u4e1d\u96c0\u6d4b\u8bd5\u7b49\u53d1\u5e03\u76f8\u5173\u7684\u529f\u80fd\uff1b\u5e76\u4e14\u5176\u4e2d\u7684\u91cd\u8bd5\u63a7\u5236\u3001\u8d85\u65f6\u63a7\u5236\u5bf9\u5e94\u5bf9\u7f51\u7edc\u6ce2\u52a8\u975e\u5e38\u5177\u6709\u5b9e\u9645\u610f\u4e49\uff1b\u540c\u65f6\uff0c\u6545\u969c\u6ce8\u5165\u548c\u6d41\u91cf\u590d\u5236\u529f\u80fd\u5bf9\u6d4b\u8bd5\u6765\u8bf4\u4e5f\u662f\u5f88\u6709\u5e2e\u52a9\u7684\u3002 \u9650\u6d41\u548c\u9ed1\u767d\u540d\u5355\u529f\u80fd \uff1a\u80fd\u6709\u6548\u5730\u63d0\u9ad8\u670d\u52a1\u7684\u5065\u58ee\u6027\uff1b\u4f46\u662f\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c\u98ce\u9669\u5df2\u7ecf\u5f00\u59cb\u63d0\u9ad8\u4e86\u3002 mTLS \u548c RBAC \u529f\u80fd \uff1a\u5927\u5e45\u63d0\u9ad8\u5b89\u5168\u6027\uff0c\u5e26\u6765\u7684\u4ee3\u4ef7\u662f\u56e0\u4e3a\u914d\u7f6e\u9519\u8bef\u6216\u8005\u8bc1\u4e66\u8f6e\u8f6c\u7b49\u95ee\u9898\uff0c\u9020\u6210\u670d\u52a1\u4e2d\u65ad\u7684\u98ce\u9669\u3002 \u5f53\u7136\uff0c\u6bcf\u4e2a\u4e0d\u540c\u7684\u7ec4\u7ec7\u90fd\u53ef\u80fd\u4f1a\u6709\u81ea\u5df1\u7684\u8bc4\u5224\u65b9\u6cd5\uff0c\u8fd9\u91cc\u7684\u6392\u5217\u4ec5\u4f9b\u53c2\u8003\u3002 \u5728\u5236\u5b9a\u4e86\u4f18\u5148\u7ea7\u5217\u8868\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6839\u636e\u8fd9\u4e00\u5217\u8868\uff0c\u7ed3\u5408\u9879\u76ee\u7684\u5b9e\u9645\u9700\u6c42\uff0c\u6309\u7167\u6548\u679c\u660e\u663e\u3001\u529f\u80fd\u7a33\u5b9a\u3001\u90e8\u7f72\u6210\u672c\u4f4e\u3001\u5c11\u6539\u9020\u6216\u8005\u4e0d\u6539\u9020\u7684\u6807\u51c6\u6765\u8fdb\u884c\u9009\u62e9\uff0c\u6700\u7ec8\u786e\u5b9a\u5f85\u6d4b\u8bd5\u7684\u529f\u80fd\u70b9\u3002 \u5728\u9009\u5b9a\u529f\u80fd\u70b9\u4e4b\u540e\uff0c\u5e94\u8be5\u9075\u5faa\u76ee\u524d\u5df2\u6709\u7684 Istio \u6587\u6863\uff0c\u5bf9\u5404\u4e2a\u529f\u80fd\u70b9\u8fdb\u884c\u5355\u9879\u6d4b\u8bd5\u548c\u9a8c\u8bc1\uff0c\u4ee5\u786e\u4fdd\u5176\u6709\u6548\u6027\u3002\u5e76\u901a\u8fc7\u5b98\u65b9 GitHub \u7684 Issue \u5217\u8868\u53ca\u8ba8\u8bba\u7ec4\u5185\u5bb9\uff0c\u4e86\u89e3\u73b0\u6709\u529f\u80fd\u662f\u5426\u5b58\u5728\u5f85\u89e3\u51b3\u7684\u95ee\u9898\uff0c\u4ee5\u53ca\u76f8\u5173\u7684\u6ce8\u610f\u4e8b\u9879\u7b49\u3002","title":"2\u3001\u786e\u5b9a\u529f\u80fd\u8303\u56f4"},{"location":"chap5/20Istio_Usage/#3","text":"\u5728\u8bd5\u7528\u529f\u80fd\u70b9\u786e\u5b9a\u4e4b\u540e\uff0c\u5c31\u8981\u9009\u62e9\u7528\u4e8e\u8bd5\u7528\u7684\u4e1a\u52a1\u5e94\u7528\u4e86\u3002 Istio \u4f5c\u4e3a\u4e00\u4e2a\u76f8\u5bf9\u5e95\u5c42\u7684\u7cfb\u7edf\uff0c\u5176\u90e8\u7f72\u548c\u8c03\u8bd5\u8fc7\u7a0b\u5fc5\u7136\u4f1a\u5bf9\u4e1a\u52a1\u4ea7\u751f\u4e00\u5b9a\u7684\u5f71\u54cd\uff0c\u5728\u8fd0\u884c\u9636\u6bb5\u53c8\u6709 Sidecar \u548c\u5404\u4e2a\u7ec4\u4ef6\u9020\u6210\u7684\u635f\u8017\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u6240\u6709\u7f51\u683c\u4e4b\u95f4\u7684\u901a\u4fe1\u90fd\u8981\u7ecf\u8fc7 Sidecar \u7684\u4e2d\u8f6c\uff0c\u4f1a\u9020\u6210\u5927\u7ea6 10 \u6beb\u79d2\u7684\u5ef6\u8fdf\u3002 Pilot \u5bf9\u96c6\u7fa4\u89c4\u6a21\u654f\u611f\uff0c\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u6570\u91cf\u3001 Pod \u6570\u91cf\u90fd\u53ef\u80fd\u5bf9 Pilot \u9020\u6210\u8f83\u5927\u5f71\u54cd\uff0c\u4e5f\u4f1a\u5f71\u54cd\u5230 Istio \u5404\u79cd\u89c4\u5219\u5411 Pod \u7684\u4f20\u8f93\u8fc7\u7a0b\u3002 \u6240\u6709\u6d41\u91cf\u90fd\u4f1a\u7ecf\u7531 Mixer \u5904\u7406\uff0c\u4e5f\u6709\u9020\u6210\u74f6\u9888\u7684\u53ef\u80fd\u3002 \u5b89\u5168\u529f\u80fd\u8bbe\u7f6e\u4e0d\u5f53\u540c\u6837\u4f1a\u9020\u6210\u670d\u52a1\u4e2d\u65ad\u3002 \u5982\u4e0a\u6240\u8ff0\u8fd8\u53ea\u662f\u4e2a\u6982\u8981\uff0c\u5bf9\u4e1a\u52a1\u6765\u8bf4\uff0c\u5bf9\u8fd9\u4e9b\u98ce\u9669\u90fd\u662f\u5fc5\u987b\u6b63\u89c6\u5e76\u505a\u597d\u9884\u6848\u7684\u3002 \u4e3a\u4e86\u907f\u514d\u5f15\u8d77\u8fc7\u5927\u635f\u5931\uff0c\u5efa\u8bae\u5c06\u5982\u4e0b\u6807\u51c6\u4f5c\u4e3a\u9009\u62e9\u8bd5\u7528\u670d\u52a1\u7684\u4f9d\u636e\u3002 \u80fd\u591f\u5bb9\u5fcd\u4e00\u5b9a\u7684\u4e2d\u65ad\u65f6\u95f4\uff1a\u4e0d\u7ba1\u662f Istio \u8fd8\u662f\u5176\u4ed6\u65b0\u6280\u672f\u7684\u91c7\u7528\uff0c\u90fd\u53ef\u80fd\u4f1a\u9020\u6210\u670d\u52a1\u4e2d\u65ad\uff0c\u5e94\u8be5\u907f\u514d\u9009\u62e9\u4f7f\u7528\u5173\u952e\u4e1a\u52a1\u8fdb\u884c\u8bd5\u70b9 \u5bf9\u5ef6\u8fdf\u4e0d\u654f\u611f\uff1a\u5bf9\u4e8e\u9ad8\u9891\u5ea6\u3001\u4f4e\u5ef6\u8fdf\u7684\u670d\u52a1\u7c7b\u578b\uff0c Sidecar \u9020\u6210\u7684\u56fa\u5b9a\u5ef6\u8fdf\u603b\u4f53\u6765\u770b\u4f1a\u975e\u5e38\u53ef\u89c2\uff0c\u56e0\u6b64\u4e0d\u5efa\u8bae\u91c7\u7528\u8fd9\u79cd\u8d1f\u8f7d\u7c7b\u578b\u7684\u4e1a\u52a1\u4f5c\u4e3a\u8bd5\u7528\u670d\u52a1\u3002 \u8c03\u7528\u6df1\u5ea6\u8f83\u6d45\uff1a\u4e00\u4e2a\u8bd5\u7528\u670d\u52a1\u5982\u679c\u5305\u542b\u592a\u591a\u5c42\u6b21\uff0c\u5219\u6bcf\u4e2a\u5c42\u6b21\u4e4b\u95f4\u90fd\u4f1a\u56e0\u4e3a Sidecar \u7684\u5ef6\u8fdf\u53d8\u6162\u5c11\u8bb8\uff0c\u4f46\u662f\u53e0\u52a0\u8d77\u6765\u4f1a\u4f7f\u5f97\u6574\u4e2a\u4e1a\u52a1\u4ea7\u751f\u6bd4\u8f83\u660e\u663e\u7684\u5ef6\u8fdf\u3002 \u80fd\u591f\u65b9\u4fbf\u5730\u56de\u6eda\u548c\u5207\u6362\uff1a\u5e94\u8be5\u5728\u524d\u7aef\u8d1f\u8f7d\u5747\u8861\u5668\u3001\u53cd\u5411\u4ee3\u7406\u65b9\u800c\u505a\u597d\u5207\u6362\u51c6\u5907\uff0c\u5728\u670d\u52a1\u53d1\u751f\u4e2d\u65ad\u65f6\uff0c\u80fd\u591f\u8fc5\u901f\u5207\u56de\u539f\u6709\u73af\u5883\u3002 \u5177\u5907\u6210\u719f\u5b8c\u5584\u7684\u529f\u80fd\u3001\u6027\u80fd\u548c\u75b2\u52b3\u6d4b\u8bd5\u65b9\u6848\uff1a\u8bd5\u7528\u670d\u52a1\u7684\u4e0a\u7ebf\u5fc5\u987b\u6709\u4e00\u4e2a\u660e\u786e\u7684\u6807\u51c6\uff0c\u5e76\u4ee5\u7b26\u5408\u6807\u51c6\u7684\u6d4b\u8bd5\u7ed3\u679c\u6765\u5bf9\u6807\u51c6\u8fdb\u884c\u9a8c\u8bc1\u3002","title":"3\u3001\u9009\u62e9\u8bd5\u7528\u4e1a\u52a1"},{"location":"chap5/20Istio_Usage/#4","text":"\u5728\u9009\u62e9\u4e86 Istio \u529f\u80fd\u8fd9\u65b9\u9762\u7684\u5efa\u8bae\u3002\u80fd\u8303\u56f4\u548c\u8bd5\u7528\u670d\u52a1\u4e4b\u540e\uff0c\u5c31\u5e94\u8be5\u5f00\u59cb\u8bd5\u7528\u4e86\uff0c\u8fd9\u91cc\u5206\u4eab\u7b14\u8005\u5728","title":"4\u3001\u8c03\u7528\u8fc7\u7a0b"},{"location":"chap5/20Istio_Usage/#4-1","text":"\u9996\u5148\u6309\u5206\u6790\u7c7b\u4f3c\uff0c \u7167\u73b0\u6709\u4e1a\u52a1\u7684\u5b9e\u9645\u9700\u8981\uff0c\u5bf9\u8bd5\u7528\u670d\u52a1\u8fdb\u884c\u529f\u80fd\u5206\u6790\u3002\u548c\u4f20\u7edf\u7684\u9700\u6c42\u529f\u80fd\u8981\u5728\u8be5\u8fc7\u7a0b\u4e2d\u660e\u786e\u4e00\u4e9b\u5177\u4f53\u7684\u9700\u6c42\u5185\u5bb9\u3002 \u73af\u5883\u9700\u6c42 \uff1a \u8bf4\u660e Istio \u90e8\u7f72\u6240\u9700\u7684 Kubernetes \u90e8\u7f72\u9700\u6c42\uff0c\u7684\u7cfb\u7edf\u8d44\u6e90\u9700\u6c42\uff0c\u5e76\u6839\u636e\u5b9e\u9645\u7684\u7ec4\u7ec7\u8fd0\u884c\u6d41\u7a0b\u8fdb\u884c\u7533\u8bf7\u3001\u4ee5\u53ca\u6574\u4f53\u529f\u80fd\u6240\u9700\u5206\u914d\uff0c\u5efa\u7acb\u73af\u5883\u9700\u6c42\u8bf4\u660e\u4e66\u4f9b\u540e\u7eed\u6b65\u9aa4\u6838\u5bf9\u3002 \u529f\u80fd\u6027\u9700\u6c42 \uff1a \u5728 Istio \u7684\u529f\u80fd\u4e2d\u9009\u62e9\u9700\u8981 Istio \u4e3a\u8bd5\u7528\u670d\u52a1\u63d0\u4f9b\u652f\u6491\u7684\u529f\u80fd\u5e94\u5f62\u6210\u529f\u80fd\u6d4b\u8bd5\u6848\u4f8b\u3002 \u670d\u52a1\u8d28\u91cf\u9700\u6c42 \uff1a \u6839\u636e\u73b0\u6709\u4e1a\u52a1\u7684\u8fd0\u884c\u72b6\u51b5\uff0c\u5bf9\u670d\u52a1\u8d28\u91cf\u63d0\u51fa\u5177\u4f53\u8981\u6c42\uff0c\u4f8b\u5982\u5e76\u53d1\u6570\u91cf\u3001\u54cd\u5e94\u65f6\u95f4\u3001\u6210\u529f\u7387\u7b49\uff0c\u5e94\u5f62\u6210\u6027\u80fd\u6d4b\u8bd5\u6848\u4f8b\u3002 \u6545\u969c\u5904\u7406\u9700\u6c42 \uff1a \u5bf9\u4e8e\u8bd5\u70b9\u5e94\u7528\u53d1\u751f\u6545\u969c\u65f6\uff0c\u5982\u4f55\u5728\u7f51\u683c\u548c\u975e\u7f51\u683c\u7248\u672c\u7684\u8bd5\u7528\u670d\u52a1\u4e4b\u95f4\u8fdb\u884c\u5207\u6362\u4ee5\u964d\u4f4e\u6545\u969c\u5f71\u54cd\uff0c\u5e94\u5f62\u6210\u6545\u969c\u9884\u6848\u3002 \u8fd9\u91cc\u9700\u8981\u91cd\u89c6\u7684\u4e00\u70b9\u662f\uff0c\u5728\u8bd5\u7528\u8fc7\u7a0b\u4e2d\uff0c\u975e\u5e38\u4e0d\u5efa\u8bae\"\u501f\u673a\u4f1a\"\u5bf9\u73b0\u6709\u8bd5\u70b9\u5e94\u7528\u8fdb\u884c\u4e1a\u52a1\u6216\u8005\u8d1f\u8f7d\u65b9\u9762\u7684\u6539\u52a8\uff0c\u4ee5\u514d\u8bd5\u7528\u8fc7\u7a0b\u9020\u6210\u5e72\u6270\uff0c\u6df7\u6dc6\u8bd5\u7528\u7ed3\u679c\u3002 \u53e6\u5916\uff0c\u5efa\u8bae\u5f62\u6210\u4e00\u4efd\u5173\u8054\u670d\u52a1\u5217\u8868, \u7528\u4e8e\u8bc4\u4f30\u8bd5\u7528\u670d\u52a1\u7684\u5f71\u54cd\u8303\u56f4\uff0c\u5c24\u5176\u662f\u5173\u7f51\u683c\u5916\u670d\u52a1\u7684\u5f15\u7528\u4f1a\u5f71\u54cd\u6ce8\u4eba\u884c\u4e3a\uff0c\u6709\u9700\u8981\u989d\u5916\u5173\u6ce8\u3002","title":"4-1 \u5236\u5ea6\u76ee\u6807"},{"location":"chap5/20Istio_Usage/#4-2","text":"\u8bd5\u7528\u65b9\u6848\u7684\u90e8\u7f72\u8fc7\u7a0b\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u513f\u6b65\u3002 Istio \u90e8\u7f72\u9996\u5148\u662f\u57fa\u672c\u73af\u5883\u7684\u51c6\u5907\uff0c\u6309\u7167\u5728\u4e0a\u8282\u4e2d\u5236\u5b9a\u7684\u73af\u5883\u9700\u6c42\uff0c\u590d\u67e5\u96c6\u7fa4\u73af\u5883\u3002 \u5982\u679c\u662f\u5185\u7f51\u90e8\u7f72\uff0c\u5219\u5e94\u8be5\u90e8\u7f72\u5185\u7f51\u53ef\u8fbe\u7684\u79c1\u6709\u955c\u50cf\u5e93\uff0c\u63a8\u9001\u5168\u90e8\u6240\u9700\u7684\u955c\u50cf\uff0c\u5e76\u5229 \u7528He In\uff1a\u53d8\u91cf\u8bbe\u7f6e\u5408\u7406\u7684\u955c\u50cf\u5730\u5740\u3002 \u63a5 \u4e0b\u6765\u6839\u636e\u8bd5\u7528\u9700\u6c42\uff0c\u5229\u7528 Helm \u5bf9 Istio \u90e8\u7f72\u8fdb\u884c\u8c03\u6574\uff0c\u8fd9\u65b9\u9762\u7684\u8c03\u6574\u4e3b\u8981\u5206\u4e3a\u4e24\u7c7b\uff1a \u8d44\u6e90\u8c03\u5ea6\u548c\u529f\u80fd\u88c1\u526a \uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u5148\u8bf4\u529f\u80fd\u8c03\u5ea6\uff0c Istio \u7684\u9ed8\u8ba4\u914d\u7f6e\u662f\u975e\u5e38\u4fdd\u5b88\u7684\uff0c\u7533\u8bf7\u7684 CPU \u548c\u5185\u5b58\u8d44\u6e90\u90fd\u5f88\u4f4e\uff0c \u5e76\u4e14\u6b8b\u7559\u4e86\u4e00\u90e8\u5206\u8c03\u8bd5\u4fe1\u606f\uff0c\u8fd9\u662f\u4e3a\u4e86\u8ba9\u6d4b\u8bd5\u7528\u6237\u5728\u5c3d\u91cf\u5c11\u6d88\u8017\u8d44\u6e90\u7684\u524d\u63d0\u4e0b\uff0c\u5c3d\u53ef\u80fd\u591a\u5730\u4f53\u9a8c Istio \u7684\u529f\u80fd\u800c\u8bbe\u8ba1\u7684\uff0c\u800c\u6211\u4eec\u7684\u76ee\u7684\u662f\u4e3a\u751f\u4ea7\u670d\u52a1\uff0c\u81ea\u7136\u5c31\u5e94\u8be5\u6839\u636e\u5b9e\u9645\u5e94\u7528\u8fdb\u884c\u8c03\u8282\u4e86\u3002 \u76ee\u524d\u53ef\u4ee5\u901a\u8fc7 values.yaml \u8fdb\u884c\u8c03\u6574\u7684\u8d44\u6e90\u9879\u76ee\u5982\u4e0b\u3002 proxy.resources \uff1a\u8d1f\u8d23\u6307\u5b9a Sidecar \u7684\u8d44\u6e90\u5206\u914d\u3002 defaultResources \uff1a\u8d1f\u8d23 Istio \u5404\u4e2a\u63a7\u5236\u9762\u7ec4\u4ef6\u7684\u9ed8\u8ba4\u8d44\u6e90\u5206\u914d\u3002 gateway.resources \uff1a\u8d1f\u8d23 Istio Gateway Controller \u7684\u8d44\u6e90\u5206\u914d\u3002 pilot.resources \uff1a\u8d1f\u8d23 Pilot \u7ec4\u4ef6\u7684\u8d44\u6e90\u5206\u914d\u3002 \u5728\u8bd5\u7528\u8fc7\u7a0b\u4e2d\uff0c\u5efa\u8bae\u8be6\u7ec6\u8c03\u6574\u5404\u4e2a\u7ec4\u4ef6\u53ca Sidecar \u7684\u8d44\u6e90\u8bbe\u7f6e\uff0c\u5e76\u542f\u7528 HPA . Istio \u5b98\u65b9\u7ed9\u51fa\u7684\u4e00\u4e9b\u8d44\u6e90\u5206\u914d\u5efa\u8bae\u5982\u4e0b \u3002 \u5728\u6bcf\u79d2\u6709 1000 \u4e2a\u8bf7\u6c42\u5e76\u6253\u5f00\u65e5\u5fd7\u7684\u60c5\u51b5\u4e0b\uff0c Sidecar \u9700\u8981 1 vCPU \u3002 Mixer \u9884\u68c0\u529f\u80fd\u5728\u6bcf\u79d2\u6709 1000 \u8bf7\u6c42\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u7f13\u5b58\u8fbe\u5230 80% \u7684\u547d\u4e2d\u7387\uff0c\u5219\u9700\u8981 0.5 vCPU \u3002 \u670d\u52a1\u95f4\u7684\u5ef6\u8fdf\u901a\u5e38\u4f1a\u589e\u52a0 10 \u6beb\u79d2\u3002 \u7b14\u8005\u7ed9\u51fa\u5982\u4e0b\u8865\u5145\u5efa\u8bae\u3002 \u5728\u8bd5\u7528\u8fc7\u7a0b\u4e2d\uff0c\u5c24\u5176\u662f\u5728\u538b\u529b\u6d4b\u8bd5\u6216\u4e1a\u52a1\u9ad8\u5cf0\u573a\u666f\u4e0b\uff0c\u5efa\u8bae\u5229\u7528\u8282\u70b9\u4eb2\u548c\u6027\u53ca Pod \u4eb2\u548c\u6027\u8bbe\u7f6e\uff0c\u5c06\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u5206\u79bb\uff0c\u4ee5\u5907\u5728\u51fa\u73b0\u6027\u80fd\u95ee\u9898\u65f6\u8fc5\u901f\u6392\u67e5\u3002 \u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u591a\u4e2a\u7ec4\u4ef6\u90fd\u5f00\u542f\u4e86\u8bbf\u95ee\u65e5\u5fd7\uff08\u53ef\u80fd\u6765\u81ea\u5404\u8fdb\u7a0b\u672c\u8eab\uff0c\u4e5f\u6709\u53ef\u80fd\u6765\u81ea stdio \u9002\u914d\u5668\uff09\uff0c\u8fd9\u800c\u53ef\u80fd\u4f1a\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff0c\u9700\u8981\u68c0\u67e5\u5e76\u8fdb\u884c\u8bbe\u7f6e\u3002 \u90e8\u5206\u7ec4\u4ef6\u5f00\u542f\u4e86\u8ddf\u8e2a\u529f\u80fd\uff0c\u4e5f\u53ef\u80fd\u4f1a\u5bf9\u6027\u80fd\u6709\u6240\u5f71\u54cd\u3002 \u5bf9\u670d\u52a1\u5668\u8282\u70b9\u7684 I/O \u8981\u4e25\u5bc6\u5173\u6ce8\uff0c\u4e5f\u5e94\u968f\u65f6\u6ce8\u610f Istio \u63a7\u5236\u9762\u5404\u5e94\u7528\u7684\u8d44\u6e90\u5360\u7528\u548cHPA\u5de5\u4f5c\u60c5\u51b5\u3002 \u5728\u8bbe\u7f6e\u597d\u8d44\u6e90\u53ca\u76f8\u5173\u9009\u9879\u4e4b\u540e\uff0c\u8fd8\u5e94\u6839\u636e\u8bd5\u7528\u76ee\u6807\u6765\u5bf9 Istio \u7ec4\u4ef6\u529f\u80fd\u8fdb\u884c\u88c1\u526a\uff0c\u4f8b\u5982: \u589e\u5220 Ingress Gateway Controller ; Prometheus , Grafana \u8fd9\u4e9b\u7b2c\u4e09\u65b9\u7ec4\u4ef6\u662f\u5426\u542f\u52a8\uff1b Galley \u6821\u9a8c Mixer \u9884\u68c0\u662f\u5426\u4f7f\u7528\u7b49\u3002 \u8fd8\u9700\u8981\u5bf9 Istio \u8fdb\u884c\u4e00\u4e9b\u4e2a\u6027\u5316\u914d\u7f6e\uff0c\u4f8b\u5982\u5f00\u653e\u7aef\u53e3\u3001Ingress\u8d44\u6e90\u7b49\u3002 \u4e0a \u8ff0\u8fd9\u4e9b\u5185\u5bb9\u90fd\u53ef\u4ee5\u5728 values.yarml \u4e2d\u8fdb\u884c\u914d\u7f6e\u3002 \u540e\u5907\u670d\u52a1\u90e8\u7f72 \u5728\u8fdb\u884c\u8bd5\u7528\u5e94\u7528\u7684\u6ce8\u5165\u4e4b\u524d\uff0c\u9996\u5148\u5e94\u8be5\u90e8\u7f72\u4e00\u7ec4\u5907\u4efd\u670d\u52a1\uff0c\u8fd9\u7ec4\u670d\u52a1\u9700\u8981\u548c\u6574\u4f53\u670d\u52a1\u7f51\u683c\u8fdb\u884c\u9694\u79bb\u3002\u8fd9\u4e00\u7ec4\u5907\u4efd\u670d\u52a1\u5e94\u5904\u4e8e\u5f85\u673a\u6a21\u5f0f\uff0c\u4ee5\u5907\u7f51\u683c\u7248\u672c\u7684\u5e94\u7528\u5728\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u8fdb\u884c\u6574\u4f53\u5207\u6362\u3002 \u57fa\u4e8e\u8fd9\u4e00\u70b9\u8003\u8651\uff0c\u8d1f\u8f7d\u5747\u8861\u7b49\u524d\u7aef\u63a7\u5236\u8bbe\u65bd\u4e5f\u5e94\u5907\u9f50\u3002 \u8bd5\u7528\u670d\u52a1\u90e8\u7f72 \u63a5\u4e0b\u6765\u8981\u628a\u8bd5\u7528\u670d\u52a1\u90e8\u7f72\u5230\u7f51\u683c\u4e2d\uff0c\u540c\u5176\u4ed6 Kubernetes \u4e00\u6837\uff0c\u7f51\u683c\u5e94\u7528\u7684\u90e8\u7f72\u4e5f\u662f\u4ece YAML \u4ee3\u7801\u5f00\u59cb\u7684\u3002\u539f\u6709\u5e94\u7528\u7684\u90e8\u7f72\u4ee3\u7801\u9700\u8981\u6839\u636e Istio \u6807\u51c6\u8fdb\u884c\u590d\u6838\uff0c\u68c0\u67e5\u5176\u4e2d\u7684\u7aef\u53e3\u547d\u540d\u3001\u6807\u7b7e\u8bbe\u7f6e\u3002 \u9664\u4e86\u5f85\u6ce8\u4eba\u7684\u5e94\u7528\u6e05\u5355\u6587\u4ef6\uff0c\u8fd8\u5e94\u8be5\u4e3a\u6bcf\u4e2a\u90e8\u7f72\u5355\u5143\u90fd\u63d0\u4f9b\u9ed8\u8ba4\u7684 VirtualService \u548c Destination Rule \uff0c\u5efa\u7acb\u57fa\u672c\u7684\u8def\u7531\u5173\u7cfb\uff0c\u63d0\u4f9b\u4e00\u4e2a\u8def\u7531\u57fa\u51c6\uff0c\u65b9\u4fbf \u5728\u8def\u7531\u8c03\u6574\u8fc7\u7a0b\u4e2d\u8fdb\u5bf9\u6bd4\u3002 \u5236\u5b9a\u7684\u5177\u4f53\u7f51\u683c\u9700\u6c42\u5217\u8868\uff0c\u9010\u4e2a\u7f16\u5199\u6240\u9700\u7684\u8def\u7531\u3001\u89c4\u5219\u7b49\u65b9\u9762\u7684\u914d\u7f6e\u5185\u5bb9\u3002 \u5728\u8fd9\u4e9b\u90fd\u5b8c\u6210\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6309\u7167\u987a\u5e8f\u9010\u4e2a\u63d0\u4ea4\u90e8\u7f72\u4e86\u3002 4. \u76d1\u63a7\u544a\u8b66\u90e8\u7f72 \u5728\u8bd5\u7528\u670d\u52a1\u90e8\u7f72\u4e4b\u540e\uff0c\u5c31\u6709\u66f4\u591a\u7684\u9879\u76ee\u53ef\u4ee5\u76d1\u6d4b\u4e86\uff0c\u8fd9\u91cc\u5efa\u8bae\u5c06\u5176\u81ea\u5e26\u7684 Prometheus \u8fdb\u884c\u53d8\u66f4\uff0c\u8fde\u63a5\u5230\u80fd\u591f\u6709\u6548\u53d1\u51fa\u544a\u8b66\u7684 Alertmanager \u7ec4\u4ef6\u4e0a\uff0c\u5e76\u4e3a\u4ee5\u4e0b\u51e0\u7ec4\u76ee\u6807\u8fdb\u884c\u76d1\u6d4b\u548c\u544a\u8b66\u3002 Pilot \u7684\u5185\u5b58\u548c Cpu \u5360\u7528\uff1a Pilot \u7684\u8d44\u6e90\u6d88\u8017\u95ee\u9898\u53cd\u590d\u51fa\u73b0\u591a\u6b21\uff0c\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u3002 Mixer \u7684\u5185\u5b58\u5360\u7528\uff1a Mixer \u7684\u7f13\u5b58\u5230\u76ee\u524d\u4e3a\u6b62\u8fd8\u5c1a\u672a\u5b8c\u5584\uff0c\u6709\u98ce\u9669\u3002 \u4e1a\u52a1\u5e94\u7528\u7684\u6210\u529f\u7387\uff1a\u5c24\u5176\u662f\u542f\u7528\u4e86 mTLS \u7684 Istio \u670d\u52a1\u7f51\u683c\uff0c\u5e94\u8be5\u7740\u91cd\u5173\u6ce8\u3002 \u4e1a\u52a1\u5e94\u7528\u7684\u54cd\u5e94\u65f6\u957f\uff1a\u54cd\u5e94\u65f6\u957f\u6709\u53ef\u80fd\u53d7\u5230 Envoy Sidecar \u548c Mixer/Adapter \u7684\u591a\u91cd\u5f71\u54cd\uff0c\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u3002 \u5173\u8054\u670d\u52a1\u5217\u8868\uff1a\u5e94\u6839\u636e\u5728\u4e0a\u8282\u4e2d\u5236\u5b9a\u7684\u5173\u8054\u670d\u52a1\u5217\u8868\uff0c\u63d0\u9ad8\u5bf9\u5f71\u54cd\u8303\u56f4\u5185\u7684\u670d\u52a1\u7684\u76d1\u63a7\u7ea7\u522b\u3002","title":"4-2 \u65b9\u6848\u90e8\u7f72"},{"location":"chap5/20Istio_Usage/#4-3","text":"\u6839\u636e\u572820.4.1\u4e2d\u5236\u5b9a\u7684\u529f\u80fd\u9700\u6c42\u5bf9\u8bd5\u7528\u670d\u52a1\u8fdb\u884c\u529f\u80fd\u6d4b\u8bd5\uff0c\u5728\u6d4b\u8bd5\u901a\u8fc7\u4e4b\u8fdb\u884c\u6027\u80fd\u548c\u75b2\u52b3\u6d4b\u8bd5\uff0c\u89c2\u5bdf\u5404\u65b9\u9762\u7684\u6027\u80fd\u6307\u6807\u662f\u5426\u7b26\u5408\uff0c\u5982\u679c\u6027\u80fd\u51fa\u73b0\u4e0b\u964d\uff0c\u5219\u53ef\u4ee5\u5c1d\u8bd5\u6269\u5bb9\uff0c\u63d0\u9ad8\u8d44\u6e90\u5206\u914d\u7387\u3002\u5173\u952e\u7ec4\u4ef6\u53ef\u80fd\u662f Istio \u81ea\u8eab\u7684\u95ee\u9898, \u5e94\u68c0\u67e5\u793e\u533a Issue \u6216\u63d0\u51fa\u65b0\u7684 Issue \u3002 \u6b64\u5904\u662f\u4e00\u4e2a\u5173\u952e\u6b65\u9aa4\uff0c \u5982\u679c\u6d4b\u8bd5\u65b9\u6848\u4e0d\u7b26\u5408\u5b9e\u9645\u60c5\u51b5\u6216\u8005\u9884\u671f\u76ee\u6807\u65e0\u6cd5\u8fbe\u5230\uff0c\u5219\u5f3a\u70c8\u5efa\u8bae\u653e\u5f03\u8bd5\u7528\u3002","title":"4-3 \u6d4b\u8bd5\u9a8c\u8bc1"},{"location":"chap5/20Istio_Usage/#4-4","text":"\u5728\u529f\u80fd \u548c\u6027\u80fd\u6d4b\u8bd5\u5168\u90e8\u901a\u8fc7\u4e4b\u540e\uff0c\u5c31\u5e94\u8be5\u8fdb\u884c\u8bd5\u7528\u670d\u52a1\u548c\u540e\u5907\u670d\u52a1\u4e4b\u95f4\u7684\u53cc\u5411\uff0c\u5728\u53cc\u65b9\u5207\u6362\u4e4b\u540e\u90fd\u5e94\u8be5\u91cd\u590d\u8fdb\u884c\u572820.4.3\u8282\u63d0\u5230\u7684\u9a8c\u8bc1\u8fc7\u7a0b\uff0c\u9632\u6b62\u6545\u969c\u53cd\u590d\u3002 \u5207\u6362\u6f14\u7ec3\u662f\u8bd5\u70b9\u5e94\u7528\u7684\u6700\u540e\u4e00\u9053\u4fdd\u9669\uff0c\u5728\u7f51\u683c\u4e25\u91cd\u6545\u969c\u4e4b\u540e\u80fd\u5426\u8fc5\u901f\u6062\u590d\u4e1a\u52a1\uff0c\u5168\u9760\u8fd9\u4e00\u6b65\u7684\u652f\u6301\u3002","title":"4-4 \u5207\u6362\u6f14\u7ec3"},{"location":"chap5/20Istio_Usage/#4-5","text":"\u5728\u901a\u8fc7\u6d4b\u8bd5\u9a8c\u8bc1\u548c\u5207\u6362\u6f14\u7ec3\u7684\u8fc7\u7a0b\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5c06\u8bd5\u7528\u7684\u7f51\u683c\u5e94\u7528\u4e0a\u7ebf\u5230\u751f\u4ea7\u73af\u5883\u5f00\u59cb\u8bd5\u8fd0\u884c\u4e86\u3002\u548c\u6240\u6709\u5176\u4ed6\u4e0a\u7ebf\u6d3b\u52a8\u4e00\u6837\uff0c\u5728\u4e0a\u7ebf\u4e4b\u540e\u9700\u8981\u63d0\u9ad8\u76d1\u63a7\u7ea7\u522b\uff0c\u5173\u6ce8\u8bd5\u7528\u670d\u52a1\u81ea\u8eab\u548c\u8bd5\u7528\u670d\u52a1\u5f71\u54cd\u8303\u56f4\u5185\u7684\u76f8\u5173\u529f\u80fd\u7684\u5065\u5eb7\u60c5\u51b5\u3002","title":"4-5 \u8bd5\u70b9\u4e0a\u7ebf"},{"location":"chap5/2Istio_Intro/","text":"\u7b2c\u4e8c\u8282 Istio \u57fa\u672c\u4ecb\u7ecd \u524d\u9762\u63d0\u5230\uff0cIstio\u51fa\u81ea\u540d\u95e8\uff0c\u7531Google. IBM\u548cLyft\u57282017\u5e745\u6708\u5408\u4f5c\u63a8\u51fa\uff0c\u5b83\u7684\u521d\u59cb\u8bbe\u8ba1\u76ee\u6807\u662f\u5728Kubernetes\u7684\u57fa\u7840\u4e0a\uff0c\u4ee5\u975e\u4fb5\u5165\u7684\u65b9\u5f0f\u4e3a\u8fd0\u884c\u5728\u96c6\u7fa4\u4e2d\u7684\u5fae\u670d\u52a1\u63d0\u4f9b \u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u52a0\u56fa\u3001\u670d\u52a1\u76d1\u63a7\u548c\u7b56\u7565\u7ba1\u7406 \u7b49\u529f\u80fd\u3002 \u9664\u4e86\u524d\u9762\u63d0\u5230\u7684\u670d\u52a1\u7f51\u683c\u57fa\u672c\u529f\u80fd\uff0cIstio\u8fd8\u63d0\u4f9b\u4e86\u5bf9\u7269\u7406\u673a\u548cConsul\u7684\u6ce8\u518c\u670d\u52a1\u7684\u652f\u6301\uff0c\u5e76\u63d0\u4f9b\u4e86\u63a5\u53e3\uff0c\u7528\u9002\u914d\u5668\u4e0e\u5916\u754c\u7684\u7b2c\u4e09\u65b9IT\u7cfb\u7edf\u8fdb\u884c\u5bf9\u63a5\u3002 Kubernetes \u662f\u5176\u4e3b\u8981\u652f\u6301\u7684\u5e73\u53f0\uff0c\u5bf9\u5176\u4ed6\u5e73\u53f0\u7684\u652f\u6301\u8fd8\u5f88\u521d\u7ea7\uff0e\u5982\u679c\u6ca1\u6709\u81ea\u7814\u529f\u80fd\uff0c\u5219\u4e0d\u5efa\u8bae \u5c1d\u8bd5\uff0c\u672c\u4e66\u4e5f\u4e0d\u4f1a\u63d0\u53ca\u8fd9\u4e00\u90e8\u5206\u5185\u5bb9\u3002 1\u3001 Istio\u7684\u6838\u5fc3\u7ec4\u4ef6\u53ca\u5176\u529f\u80fd Istio\u603b\u4f53\u6765\u8bf4\u5206\u4e3a\u4e24\u90e8\u5206\uff1a \u63a7\u5236\u9762 \u548c \u6570\u636e\u9762 \u5982\u4e0b\u6240\u8ff0\u3002 \u6570\u636e\u9762\u88ab\u79f0\u4e3a\u201cSidecar\"\uff0c\u53ef\u5c06\u5176\u7406\u89e3\u4e3a\u65e7\u5f0f\u4e09\u8f6e\u6469\u6258\u8f66\u7684\u6302\u6597\u3002Sidecar, \u901a\u8fc7\u6ce8\u4eba\u7684\u65b9\u5f0f\u548c\u4e1a\u52a1\u5bb9\u5668\u5171\u5b58\u4e8e\u4e00\u4e2a Pod \u4e2d\uff0c \u4f1a\u52ab\u6301\u4e1a\u52a1\u5e94\u7528\u5bb9\u5668\u7684\u6d41\u91cf \uff0c \u5e76\u63a5\u53d7\u63a7\u5236\u9762\u7ec4\u4ef6\u7684\u63a7\u5236\uff0c\u540c\u65f6\u4f1a\u5411\u63a7\u5236\u9762\u8f93\u51fa\u65e5\u5fd7\u3001\u8ddf\u8e2a\u53ca\u76d1\u63a7\u6570\u636e \u3002 \u63a7\u5236\u9762\u662f Istio \u7684\u6838\u5fc3\uff0c\u7ba1\u7406 Istio \u7684\u6240\u6709\u529f\u80fd \u3002 Istio \u7684\u4e3b\u8981\u7ec4\u4ef6\u53ca\u5176\u76f8\u4e92\u5173\u7cfb\u5927\u81f4\u5982\u56fe\u6240\u793a\uff0c\u4e0b\u9762\u5bf9\u8fd9\u4e9b\u5173\u952e\u7ec4\u4ef6\u8fdb\u884c\u8bb2\u89e3\u3002 1-1 Pilot Pilot \u662f Istio \u7684\u4e3b\u8981\u63a7\u5236\u70b9\uff0c Istio \u7684\u6d41\u91cf\u5c31\u662f\u7531 Pilot \u7ba1\u7406\u7684\uff08\u5177\u4f53\u6267\u884c\u662f\u7531 Sidecar \u5b8c\u6210\u7684\uff09 \u3002 \u5728\u6574\u4e2a\u7cfb\u7edf\u4e2d\uff0c Pilot \u5b8c\u6210\u4ee5\u4e0b\u4efb\u52a1\uff1a \u4ece Kubernetes \u6216\u8005\u5176\u4ed6\u5e73\u53f0\u7684\u6ce8\u518c\u4e2d\u5fc3\u83b7\u53d6\u670d\u52a1\u4fe1\u606f\uff0c\u5b8c\u6210\u670d\u52a1\u53d1\u73b0\u8fc7\u7a0b\uff1b \u8bfb\u53d6 Istio \u7684\u5404\u9879\u63a7\u5236\u914d\u7f6e\uff0c\u5728\u8fdb\u884c\u8f6c\u6362\u4e4b\u540e\uff0c\u5c06\u5176\u53d1\u7ed9\u6570\u636e\u9762\u8fdb\u884c\u5b9e\u65bd\u3002 Pilot \u7684\u914d\u7f6e\u5185\u5bb9\u4f1a\u88ab\u8f6c\u6362\u4e3a \u6570\u636e\u9762 \u80fd\u591f\u7406\u89e3\u7684\u683c\u5f0f\uff0c\u4e0b\u53d1\u7ed9\u6570\u636e\u9762\u7684 Sidecar , Sidecar \u6839\u636e Pilot \u6307\u4ee4\uff0c\u5c06\u8def\u7531\u3001\u670d\u52a1\u3001\u76d1\u542c\u3001\u96c6\u7fa4\u7b49\u5b9a\u4e49\u4fe1\u606f\u8f6c\u6362\u4e3a\u672c\u5730\u914d\u7f6e\uff0c\u5b8c\u6210\u63a7\u5236\u884c\u4e3a\u7684\u843d\u5730\u3002 \u7528\u6237\u901a\u8fc7 kubectl \u6216\u8005 istioctl \uff08\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7API\uff09\u5728Kubernetes \u4e0a\u521b\u5efa CRD \u8d44\u6e90\uff0c \u5bf9 Istio \u63a7\u5236\u5e73\u9762\u53d1\u51fa\u6307\u4ee4 Pilot \u76d1\u542c CRD \u4e2d\u7684 config , rbac , networking \uff0c \u5728\u68c0\u6d4b\u5230\u8d44\u6e90\u5bf9\u8c61\u7684\u53d8\u66f4\u4e4b\u540e,\u9488\u5bf9\u5176\u4e2d\u6d89\u53ca\u7684\u670d\u52a1\uff0c \u53d1\u51fa\u6307\u4ee4\u7ed9\u5bf9\u5e94\u7684 Sidecar Sidecar \u6839\u636e\u8fd9\u4e9b\u6307\u4ee4\u66f4\u65b0\u81ea\u8eab\u7684\u914d\u7f6e\uff0c\u6839\u636e\u914d\u7f6e\u4fee\u6b63\u901a\u4fe1\u7684\u884c\u4e3a 1-2 Mixer Mixer \u7684\u804c\u8d23\u4e3b\u8981\u6709\u4e24\u4e2a\uff0c \u9884\u68c0 \u548c \u56de\u62a5 , \u7b80\u5355\u7684\u793a\u610f\u56fe Mixer\u7684\u7b80\u5355\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\u3002 \u7528\u6237\u5c06 Mixer \uff1a\u914d\u7f6e\u53d1\u9001\u5230 Kubernetes \u4e2d\u3002 Mixer \uff1a\u901a\u8fc7\u5bf9 Kubernetes \u8d44\u6e90\u7684\u76d1\u542c\uff0c\u83b7\u77e5\u914d\u7f6e\u7684\u53d8\u5316 \u3002 \u7f51\u683c\u4e2d\u7684\u670d\u52a1\u5728\u6bcf\u6b21\u8c03\u7528\u4e4b\u524d\uff0c\u90fd\u5411 Mixer \u53d1\u51fa\u9884\u68c0\u8bf7\u6c42\uff0c\u67e5\u770b\u8c03\u7528\u662f\u5426\u5141\u8bb8\u6267\u884c\u3002\u5728\u6bcf\u6b21\u8c03\u7528\u4e4b\u540e\uff0c\u90fd\u53d1\u51fa\u62a5\u544a\u4fe1\u606f\uff0c\u5411 Mixer \u6c47\u62a5\u5728\u8c03\u7528\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u76d1\u63a7\u8ddf\u8e2a\u6570\u636e\u3002 \u5728 Mixer \u4e2d\u5305\u542b\u591a\u4e2a\u88ab\u79f0\u4e3a Adapter \u7684\u7ec4\u4ef6\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u7528\u6765\u5904\u7406 \u5728 Mixer \u4e2d\u63a5\u6536\u7684\u9884\u68c0\u548c\u62a5\u544a\u6570\u636e\uff0c\u4ece\u800c\u5b8c\u6210 Mixer \u7684\u5404\u79cd\u529f\u80fd\u3002 1-3 Citadel Citadel \u5728Istio\u7684\u65e9\u671f\u7248\u672c\u4e2d\u88ab\u79f0\u4e3a Istio-CA \uff0c\u4e0d\u96be\u770b\u51fa\uff0c\u5b83\u662f\u7528\u4e8e\u8bc1\u4e66\u7ba1\u7406\u7684\u3002 \u5728\u96c6\u7fa4\u4e2d\u542f\u7528\u4e86\u670d\u52a1\u4e4b\u95f4\u7684\u52a0\u5bc6\u4e4b\u540e\uff0c Citadel \u8d1f\u8d23\u4e3a\u96c6\u7fa4\u4e2d\u7684\u5404\u4e2a\u670d\u52a1\u5728\u7edf\u4e00 CA \u7684\u6761\u4ef6\u4e0b\u751f\u6210\u8bc1\u4e66\uff0c\u5e76\u4e0b\u53d1\u7ed9\u5404\u4e2a\u670d\u52a1\u4e2d\u7684 Sidecar \uff0c\u670d\u52a1\u4e4b\u95f4\u7684 TLS \u5c31\u4f9d\u8d56\u8fd9\u4e9b\u8bc1\u4e66\u5b8c\u6210\u6821\u9a8c\u8fc7\u7a0b\u3002 1-4 Sidecar(Envoy) Sidecar \u5c31\u662f Istio \u4e2d\u7684\u6570\u636e\u9762\uff0c\u8d1f\u8d23\u63a7\u5236\u9762\u5bf9\u7f51\u683c\u63a7\u5236\u7684\u5b9e\u9645\u6267\u884c\u3002 Istio \u4e2d\u7684\u9ed8\u8ba4 Sidecar \u662f\u7531 Envoy \u6d3e\u751f\u51fa\u6765\u7684\uff0c\u5728\u7406\u8bba\u4e0a\uff0c\u53ea\u8981\u652f\u6301 Envoy \u7684 xDS \u534f\u8bae\uff0c\u5176\u4ed6\u7c7b\u4f3c\u7684\u53cd\u5411\u4ee3\u7406\u8f6f\u4ef6\u5c31\u90fd\u53ef\u4ee5\u4ee3\u66ff Envoy \u6765\u62c5\u5f53\u8fd9\u4e00\u89d2\u8272\u3002 \u5728 Istio \u7684\u9ed8\u8ba4\u5b9e\u73b0\u4e2d\uff0c Istio \u5229\u7528 istio-init \u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u7684 iptables \u6307\u4ee4\uff0c\u5bf9\u4e00\u6240\u5728 Pod \u7684\u6d41\u91cf\u8fdb\u884c\u52ab\u6301\uff0c\u4ece\u800c\u63a5\u7ba1 Pod \u4e2d\u5e94\u7528\u7684\u901a\u4fe1\u8fc7\u7a0b\uff0c\u5982\u6b64\u4e00\u6765\uff0c\u5c31\u83b7\u5f97\u4e86\u901a\u4fe1\u7684\u63a7\u5236\u6743\uff0c\u63a7\u5236\u9762\u7684\u63a7\u5236\u76ee\u7684\u6700\u7ec8\u5f97\u4ee5\u5b9e\u73b0 \u3002 \u6ce8\u4eba Sidecar \u524d\u540e\u7684\u901a\u4fe1\u6a21\u5f0f\u53d8\u5316\u5982\u56fe\u6240\u793a\u3002 \u719f\u6089 Kubernetes \u7684\u5e94\u8be5\u90fd\u77e5\u9053\uff0c\u5728\u540c\u4e00\u4e2a Pod \u5185\u7684\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\uff0c\u7f51\u7edc\u6808\u662f\u5171\u4eab\u7684\uff0c\u8fd9\u6b63\u662f Sidecar \u6a21\u5f0f\u7684\u5b9e\u73b0\u57fa\u7840(Pause Pod)\u3002\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c Sidecar \u5728\u52a0\u4eba\u4e4b\u540e\uff0c\u539f\u6709\u7684\u6e90\u5bb9\u5668\u4e00\u76ee\u7684\u5bb9\u5668\u7684\u76f4\u63a5\u901a\u4fe1\u65b9\u5f0f\uff0c\u53d8\u6210\u4e86 \u6e90\u5bb9\u5668\u4e00>Sidecar->Sidecar\u4e00>\u76ee\u7684\u5bb9\u5668 \u7684\u6a21\u5f0f\u3002 \u800c Sidecar \u662f\u7528\u6765\u63a5\u53d7\u63a7\u5236\u9762\u7ec4\u4ef6\u7684\u64cd\u4f5c\u7684\uff0c\u8fd9\u6837\u4e00\u6765\uff0c\u5c31\u8ba9\u901a\u4fe1\u8fc7\u7a0b\u4e2d\u7684\u63a7\u5236\u548c\u89c2\u5bdf\u6210\u4e3a\u53ef\u80fd\u3002 2\u3001 \u6838\u5fc3\u914d\u7f6e\u5bf9\u8c61 Istio \u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4f1a\u8fdb\u884c CRD \u7684\u521d\u59cb\u5316\uff0c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u6ce8\u518c\u4e00\u7cfb\u5217\u7684 CRD . CRD \u5728\u6ce8\u518c\u6210\u529f\u4e4b\u540e\uff0c\u4f1a\u5efa\u7acb\u4e00\u4e9b\u57fa\u7840\u5bf9\u8c61\uff0c\u5b8c\u6210 Istio \u7684\u521d\u59cb\u8bbe\u7f6e\u3002 \u5728\u524d\u9762\u4ecb\u7ecd\u7ec4\u4ef6\u65f6\u66fe\u591a\u6b21\u63d0\u5230\uff0c\u7528\u6237\u5229\u7528 Istio \u63a7\u5236\u5fae\u670d\u52a1\u901a\u4fe1\uff0c\u662f\u901a\u8fc7\u5411 Kubernetes \u63d0\u4ea4 CRD \u8d44\u6e90\u7684\u65b9\u5f0f\u5b8c\u6210\u7684\u3002 Istio \u4e2d\u7684\u8d44\u6e90\u5206\u4e3a\u4e09\u7ec4\u8fdb\u884c\u7ba1\u7406\uff0c\u5206\u522b\u662f networking.istio.io . config.istio.io \u53ca authentication.istio.io \uff0c\u4e0b\u9762\u5c06\u5206\u522b\u8fdb\u884c\u4ecb\u7ecd \u3002 2-1 networking.istio networking.istio \u7cfb\u5217\u5bf9\u8c61\u5728 Istio \u4e2d\u53ef\u80fd\u662f\u4f7f\u7528\u9891\u7387\u6700\u9ad8\u7684 Istio \u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\u5c31\u662f\u7528\u8fd9\u4e00\u7ec4\u5bf9\u8c61\u5b8c\u6210\u7684\u8fd9\u91cc\u9009\u62e9\u5176\u5dfe\u6700\u5e38\u7528\u7684\u5bf9\u8c61\u8fdb\u884c\u7b80\u5355\u4ecb\u7ecd. \u5728 networking.istio,io \u7684\u4e0b\u5c5e\u8d44\u6e90\u4e2d Virtual Service \u662f\u4e00\u4e2a\u63a7\u5236\u4e2d\u5fc3\u5b83\u7684\u529f\u80fd \u7b80\u5355\u8bf4\u6765\u5c31\u662f\uff1b \u5b9a\u4e49\u4e00\u7ec4\u6761\u4ef6\uff0c\u5c06\u7b26\u5408\u8be5\u6761\u4ef6\u7684\u6d41\u91cf\u6309\u7167\u5728\u5bf9\u8c61\u4e2d\u914d\u7f6e\u7684\u5bf9\u5e94\u7b56\u7565 \u8fdb\u884c\u5904\u7406\uff0c\u6700\u540e\u5c06\u8def\u7531\u8f6c\u5230\u5339\u914d\u7684\u65e5\u6807\u4e2d\u3002\u4e0b\u9762\u5217\u51fa\u51e0\u4e2a\u5178\u578b\u7684\u5e94\u7528\u573a\u666f\u3002 (1\uff09\u6765\u81ea\u670d\u52a1 A \u7248\u672c 1 \u7684\u670d\u52a1\uff0c\u5982\u679c\u8981\u8bbf\u95ee\u670d\u52a1 B \uff0c\u5219\u8981\u5c06\u8def\u7531\u6307\u5411\u670d\u52a1 B \u7684\u7248\u672c 2 (2\uff09\u5728\u670d\u52a1 x \u53d1\u5f80\u670d\u52a1 Y \u7684 HTTP \u8bf7\u6c42\u4e2d\uff0c\u5982\u679c Header \u5305\u542b canary=true \u5219\u628a\u670d\u52a1\u76ee\u6807\u6307\u5411\u670d\u52a1 Y \u7684\u7248\u672c 3 .\u5426\u5219\u53d1\u7ed9\u670d\u52a1 Y \u7684\u7248\u672c 2 (3\uff09\u4e3a\u4ece\u670d\u52a1 M \u5230\u670d\u52a1 N \u7684\u6240\u6709\u8bbf\u95ee\u90fd\u52a0\u4eba\u5ef6\u8fdf\uff0c\u4ee5\u6d4b\u8bd5\u5728\u7f51\u7edc\u72b6\u51b5\u4e0d\u4f73\u65f6\u7684\u8868\u73b0\u3002 \u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u65b9\u9762\u7684\u529f\u80fd\u662f\u6bd4\u8f83\u590d\u6742\u7684 \u56e0\u6b64\u5176\u4e2d\u5305\u542b\u7684\u884c\u4e3a\u5b9a\u4e49\u4e5f\u4e00\u5b9a\u4e0d\u7b80\u5355\u3002 Istio \u5bf9\u8def\u7531\u7ba1\u7406\u505a\u4e86\u5f88\u597d\u7684\u62bd\u8c61\u3002\u56fe\u5c55\u793a\u4e86\u6d41\u91cf\u8bbf\u95ee\u6d41\u7a0b\u4e2d\u7684\u51e0\u4e2a\u5173\u952e\u5bf9\u8c61 1. Gateway \u5728\u8bbf\u95ee\u670d\u52a1\u65f6\uff0c\u4e0d\u8bba\u662f\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e92\u8bbf\uff0c\u8fd8\u662f\u901a\u8fc7 ingress \u8fdb\u4eba\u7f51\u683c\u7684\u5916\u90e8\u6d41\u91cf\uff0c\u9996\u5148\u8981\u7ecf\u8fc7\u7684\u8bbe\u65bd\u90fd\u662f Gateway . Gateway \u5bf9\u8c61\u63cf\u8ff0\u4e86\u8fb9\u7f18\u63a5\u4eba\u8bbe\u5907\u7684\u6982\u5ff5\uff0c \u5176\u4e2d\u5305\u542b\u5bf9\u5f00\u653e\u7aef\u53e3\u3001\u4e3b\u673a\u540d\u53ca\u53ef\u80fd\u5b58\u5728\u7684 TLS \u8bc1\u4e66\u7684\u5b9a\u4e49\u3002 \u7f51\u7edc\u8fb9\u7f18\u7684 ingress \u6d41\u91cf\uff0c\u4f1a\u901a\u8fc7\u5bf9\u5e94\u7684 Istio Ingress Gateway Controller \u8fdb\u5165\uff1b \u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e92\u8bbf\uff0c \u5219\u901a\u8fc7\u865a\u62df\u7684 mesh \u7f51\u5173\u8fdb\u884c\uff08 mesh \u7f51\u5173\u4ee3\u8868\u7f51\u683c\u5185\u90e8\u7684\u6240\u6709 Sidecar ) Pilot \u4f1a\u6839\u636e Gateway \u548c \u4e3b\u673a\u540d \u8fdb\u884c\u68c0\u7d22\uff0c\u5982\u679c\u5b58\u5728\u5bf9\u5e94\u7684 VirtualService \uff0c\u5219\u4ea4 \u7531 VirtualService \u5904\u7406\uff1b \u5982\u679c\u662f Mesh Gateway \u4e14\u4e0d\u5b58\u5728\u5bf9\u5e94\u8fd9\u4e00\u4e3b\u673a\u540d\u7684 VirtualService \uff0c\u5219\u5c1d\u8bd5\u8c03\u7528 Kubernetes Service (SVC)\uff1b\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u53d1\u751f 404 \u9519\u8bef\u3002 2 VirtualService Virtual Service \u5bf9\u8c61\u4e3b\u8981\u7531\u4ee5\u4e0b\u90e8\u5206\u7ec4\u6210\u3002 (1) Host \uff1a\u8be5\u5bf9\u8c61\u6240\u8d1f\u8d23\u7684\u4e3b\u673a\u540d\u79f0\uff0c\u5982\u679c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u5219\u8fd9\u4e2a\u4e3b\u673a\u540d\u53ef\u4ee5\u662f\u670d\u52a1\u540d\u3002 (2) Gateway \uff1a \u6d41\u91cf\u7684\u6765\u6e90\u7f51\u5173 \uff0c\u5728\u540e\u9762\u4f1a\u4ecb\u7ecd\u7f51\u5173\u7684\u6982\u5ff5\u3002\u5982\u679c\u8fd9\u4e00\u5b57\u6bb5\u88ab\u7701 \u7565\uff0c\u5219\u4ee3\u8868\u4f7f\u7528\u7684\u7f51\u5173\u540d\u4e3a \u201cmesh\" \uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u7684\u7f51\u683c\u5185\u90e8\u670d\u52a1\u4e92\u8054\u6240\u7528\u7684\u7f51\u5173\u3002 (3\uff09 \u8def\u7531\u5bf9\u8c61 \uff1a\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\uff0c\u5982\u679c\u7b26\u5408\u524d\u9762\u7684 Host \u548c Gateway \u7684\u6761\u4ef6\uff0c\u5c31\u9700\u8981\u6839\u636e\u5b9e\u9645\u534f\u8bae\u5bf9\u6d41\u91cf\u7684\u5904\u7406\u65b9\u5f0f\u8fdb\u884c\u7504\u522b\u3002\u5176\u539f\u56e0\u662f\uff1a HTTP \u662f\u4e00\u79cd\u900f\u660e\u534f\u8bae\uff0c\u53ef\u4ee5\u7ecf\u8fc7\u5bf9\u62a5\u6587\u7684\u89e3\u6790\uff0c\u5b8c\u6210\u66f4\u7ec6\u81f4\u7684\u63a7\u5236\uff1b\u800c\u5bf9\u4e8e\u539f\u59cb\u7684TCP\u6d41\u91cf\u6765\u8bf4\uff0c\u5c31\u65e0\u6cd5 \u5b8c\u6210\u8fc7\u4e8e\u590d\u6742\u7684\u4efb\u52a1\u4e86\u3002 3 TCP/TLS/HTTP Route \u8def\u7531\u5bf9\u8c61\u76ee\u524d\u53ef\u4ee5\u662f HTTP \u3001 TCP \u6216\u8005 TLS \u4e2d\u7684\u4e00\u4e2a\uff0c\u5206\u522b\u9488\u5bf9\u4e0d\u540c\u7684\u534f\u8bae\u8fdb\u884c\u5de5\u4f5c\u3002\u6bcf\u79cd\u8def\u7531\u5bf9\u8c61\u90fd\u81f3\u5c11\u5305\u542b\u4e24\u90e8\u5206\uff1a \u5339\u914d\u6761\u4ef6\u548c\u76ee\u7684\u8def\u7531\u3002 \u4f8b\u5982\uff0c\u5728 HTTPRoute \u3002 \u5bf9\u8c61\u4e2d\u5c31\u5305\u542b\u7528\u4e8e\u5339\u914d\u7684 HTTPMatchRequest \u5bf9\u8c61\u6570\u7ec4\uff0c\u4ee5\u53ca\u7528\u4e8e\u63cf\u8ff0\u76ee\u6807\u670d\u52a1\u7684 DestinationWeight \u5bf9\u8c61\uff0c\u5e76\u4e14 HTTPMatchRequest \u7684\u5339\u914d\u6761\u4ef6\u8f83\u4e3a\u4e30\u5bcc\uff0c\u4f8b\u5982\u524d\u9762\u63d0\u5230\u7684 http header \u6216\u8005 uri \u7b49\u9664\u6b64\u4e4b\u5916\uff0c HTTP \u8def\u7531\u5bf9\u8c61\u53d7\u76ca\u4e8e HTTP \u7684\u900f\u660e\u6027\uff0c\u5305\u542b\u5f88\u591a\u4e13\u5c5e\u7684\u989d\u5916\u7279\u6027\uff0c\u4f8b\u5982 \u8d85\u65f6\u63a7\u5236\u3001\u91cd\u8bd5\u3001\u9519\u8bef\u6ce8\u5165 \u7b49\u3002 \u76f8\u5bf9\u6765\u8bf4\uff0c TCPRoute \u3002 \u7b80\u5355\u5f88\u591a\uff0c\u5b83\u7684\u5339\u914d\u501f\u52a9\u8d44\u6e90 L4MatchAttributes \u5bf9\u8c61\u5b8c\u6210\uff0c\u5176\u4e2d\u9664 Istio \u56fa\u6709\u7684\u6807\u7b7e\u548c Gateway \u5916\uff0c\u4ec5\u5305\u542b\u5730\u5740\u548c\u7aef\u53e3\u3002 \u5728\u5339\u914d\u5b8c\u6210\u540e\uff0c\u81ea\u7136\u5c31\u662f\u9009\u62e9\u5408\u9002\u7684\u76ee\u6807\u4e86\u3002 4 DestinationWeight \u5404\u534f\u8bae\u8def\u7531\u7684\u76ee\u6807\u5b9a\u4e49\u662f\u4e00\u81f4\u7684\uff0c\u90fd \u7531Destination Weight \u5bf9\u8c61\u6570\u7ec4\u6765\u5b8c\u6210 Destination Weight \u6307\u5230\u67d0\u4e2a\u76ee\u6807\uff08 Destination \u5bf9\u8c61\uff09\u7684\u6d41\u91cf\u6743\u91cd\uff0c\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u591a\u4e2a\u76ee\u6807\u53ef\u4ee5\u540c\u65f6\u4e3a\u8be5 Virtual Service \u63d0\u4f9b\u670d\u52a1\uff0c\u5e76\u6309\u7167\u6743\u91cd\u8fdb\u884c\u6d41\u91cf\u5206\u914d\u3002 5 Destination \u76ee\u6807\u5bf9\u8c61\uff08 Destination \uff09\u7531 Subset \u548c Port \u4e24\u4e2a\u5143\u7d20\u7ec4\u6210\u3002 Subset \u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u6307\u670d\u52a1\u7684\u4e00\u4e2a\u5b50\u96c6\uff0c\u5b83\u5728 Kubernetes \u4e2d\u4ee3\u8868\u4f7f\u7528\u6807\u7b7e\u9009\u62e9\u5668\u533a\u5206\u7684\u4e0d\u540c Pod \uff08\u4f8b\u5982\u4e24\u4e2a Deployment )\u3002 Port \u4ee3\u8868\u7684\u5219\u662f\u670d\u52a1\u7684\u7aef\u53e3\u3002 6\uff0e\u5c0f\u7ed3 \u81f3\u6b64\uff0c\u6d41\u91cf\u7ecf\u8fc7\u591a\u4e2a\u5bf9\u8c61\u7684\u9010\u7ea7\u5904\u7406\uff0c\u6210\u529f\u5230\u8fbe\u4e86 Pod \uff0c 2-2 config.istio.io config.istio.io \u4e2d\u7684\u5bf9\u8c61\u7528\u4e8e\u4e3a Mixer \u7ec4\u4ef6\u63d0\u4f9b\u914d\u7f6e\u3002 Mixer \u4f9b\u4e86 \u9884\u68c0 \u548c \u62a5\u544a \u8fd9\u4e24\u4e2a\u529f\u80fd\uff0c\u8fd9\u4e24\u4e2a\u529f\u80fd\u770b\u4f3c\u7b80\u5355\uff0c\u4f46\u662f\u56e0\u4e3a\u5927\u91cf\u9002\u914d\u5668\u7684\u5b58\u5728\u3002\u53d8\u5f97\u76f8\u5f53\u590d\u6742\uff0c \u56fe\u5c55\u793a\u4e86 Mixer \u5bf9\u6570\u636e\u5904\u7406\u8fc7\u7a0b 1.Rule Rule \u5bf9\u8c61\u662f Mixer \u7684\u4eba\u53e3\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e2a match \u6210\u5458\u548c\u4e00\u4e2a\u903b\u8f91\u8868\u8fbe\u5f0f\uff0c\u53ea\u6709\u7b26\u5408\u8868\u8fbe\u5f0f\u5224\u65ad\u7684\u6570\u636e\u624d\u4f1a\u88ab\u4ea4\u7ed9 Action \u5904\u7406 \u3002 \u903b\u8f91\u8868\u8fbe\u5f0f\u4e2d\u7684\u53d8\u91cf\u88ab\u79f0\u4e3a attribute \uff08\u5c5e\u6027\uff09\uff0c\u5176\u4e2d\u7684\u5185\u5bb9\u6765\u81ea Envoy \u63d0\u4ea4\u7684\u6570\u636e\u3002 2.Action Action \u8d1f\u8d23\u89e3\u51b3\u7684\u95ee\u9898\u5c31\u662f\uff1a\u5c06\u7b26\u5408\u4eba\u53e3\u6807\u51c6\u7684\u6570\u636e\uff0c\u5728\u7528\u4ec0\u4e48\u65b9\u5f0f\u52a0\u5de5\u4e4b\u540e\uff0c\u4ea4\u7ed9\u54ea\u4e2a\u9002\u914d\u5668\u8fdb\u884c\u5904\u7406\u3002 Action \u5305\u542b\u4e24\u4e2a\u6210\u5458\u5bf9\u8c61\uff1a \u4e00\u4e2a\u662f Instance \uff0c\u4f7f\u7528 Template \u5bf9\u63a5\u6536\u5230\u7684\u6570\u636e\u8fdb\u884c\u5904\u7406\uff1b \u4e00\u4e2a\u662f Handler \uff0c\u4ee3\u8868\u4e00\u4e2a\u9002\u914d\u5668\u7684\u5b9e\u4f8b\uff0c\u7528\u4e8e\u63a5\u6536\u5904\u7406\u540e\u7684\u6570\u636e\u3002 3.Instance Instance \u4e3b\u8981\u7528\u4e8e\u4e3a\u8fdb\u5165\u7684\u6570\u636e\u9009\u62e9\u4e00\u4e2a\u6a21\u677f\uff0c\u5e76\u5728\u6570\u636e\u4e2d\u62bd\u53d6\u67d0\u4e9b\u5b57\u6bb5\u4f5c\u4e3a\u6a21\u677f\u7684\u53c2\u6570\uff0c\u4f20\u8f93\u7ed9\u6a21\u677f\u8fdb\u884c\u5904\u7406\u3002 4.Adapter Adapter \u5728 Istio \u53ea\u88ab\u5b9a\u4e49\u4e3a\u4e00\u4e2a\u884c\u4e3a\u89c4\u8303 \uff0c\u800c\u4e00\u4e9b\u5fc5\u8981\u7684\u5b9e\u4f8b\u5316\u6570\u636e\u662f\u9700\u8981\u518d\u6b21\u8fdb\u884c\u521d\u59cb\u5316\u7684\uff0c\u4f8b\u5982 RedisQuota \u9002\u914d\u5668\u4e2d\u7684 Redis \u5730\u5740\uff0c\u6216\u8005 Listchecker \u4e2d\u7684\u9ed1\u767d\u540d\u5355\u7b49\uff0c\u53ea\u6709\u8fd9\u4e9b\u6570\u636e\u5f97\u5230\u6b63\u5f0f\u7684\u521d\u59cb\u5316\uff0c Adapter \u624d\u80fd\u88ab\u6295\u4eba\u4f7f\u7528 \u7ecf\u8fc7 Handler \u5b9e\u4f8b\u5316\u4e4b\u540e\u7684\u00b7Adapter\u00b7\uff0c\u5c31\u5177\u5907\u4e86\u5de5\u4f5c\u529f\u80fd\u3002 \u6709\u4e9b Adapter \u662f Istio \u7684\u81ea\u8eab\u5b9e\u73b0\uff0c\u4f8b\u5982\u524d\u9762\u63d0\u5230\u7684 listcheck \u6216\u8005 memquota \uff1b \u6709\u4e9b Adapter \u662f\u7b2c\u4e09\u65b9\u670d\u52a1\uff0c\u4f8b\u5982 Prometheus \u6216\u8005 Datadog \u7b49\u3002 Envoy \u4f20\u51fa\u7684\u6570\u636e\u5c06\u4f1a\u901a\u8fc7\u8fd9\u4e9b\u5177\u4f53\u8fd0\u884c\u7684 Adapter \u7684\u5904\u7406\uff0c\u5f97\u5230\u9884\u68c0\u7ed3\u679c\uff0c\u6216\u8005\u8f93\u51fa\u5404\u79cd\u76d1\u63a7\u3001\u65e5\u5fd7\u53ca\u8ddf\u8e2a\u6570\u636e\u3002 5.Template \u987e\u540d\u601d\u4e49\uff0c Template \u662f\u4e00\u4e2a\u6a21\u677f\uff0c\u7528\u4e8e\u5bf9\u63a5\u6536\u5230\u7684\u6570\u636e\u8fdb\u884c\u518d\u52a0\u5de5. \u8fdb\u4eba Mixer \u4e2d\u7684\u6570\u636e\u90fd\u6765\u81ea Sidecar \uff0c\u4f46\u662f\u5404\u79cd\u9002\u914d\u5668\u5e94\u5bf9\u7684\u9700\u6c42\u5404\u6709\u5343\u79cb\uff0c\u751a\u81f3\u540c\u6837\u4e00\u4e2a\u9002\u914d\u5668\uff0c\u4e5f\u53ef\u80fd\u63a5\u6536\u5404\u79cd\u4e0d\u540c\u5f62\u5f0f\u7684\u6570\u636e\uff08\u4f8b\u5982 Prometheus \u53ef\u80fd\u4f1a\u5728\u540c\u6837\u4e00\u6279\u6570\u636e\u4e2d\u83b7\u53d6\u4e0d\u540c\u7684\u6307\u6807\uff09, Envoy \u63d0\u4f9b\u7684\u539f\u59cb\u6570\u636e\u548c\u9002\u914d\u5668\u6240\u9700\u8981\u7684\u8f93\u4eba\u6570\u636e\u5b58\u5728\u683c\u5f0f\u4e0a\u7684\u5dee\u522b\uff0c\u56e0\u6b64\u9700\u8981\u5bf9\u539f\u59cb\u6570\u636e\u8fdb\u884c\u518d\u52a0\u5de5\u3002 Template \u5c31\u662f\u8fd9\u6837\u4e00\u79cd\u5de5\u5177\uff0c\u5728\u7528\u6237\u7f16\u5236\u6a21\u677f\u5bf9\u8c61\u4e4b\u540e\uff0c\u7ecf\u8fc7\u6a21\u677f\u5904\u7406\u7684\u539f\u59cb\u6570\u636e\u4f1a\u88ab\u8f6c\u6362\u4e3a\u7b26\u5408\u9002\u914d\u5668\u8f93\u4eba\u8981\u6c42\u7684\u6570\u636e\u683c\u5f0f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728 Instance \u5b57\u6bb5\u4e2d\u5f15\u7528 6.Handler Handler \u5bf9\u8c61\u7528\u4e8e\u5bf9 Adapter \u8fdb\u884c\u5b9e\u4f8b\u5316\u3002 \u8fd9\u7ec4\u5bf9\u8c61\u7684\u547d\u540d\u975e\u5e38\u4ee4\u4eba\u8d39\u89e3\uff0c\u4f46\u662f\u4ece\u5176\u529f\u80fd\u5217\u8868\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c Mixer \u7ba1\u7406\u4e86\u6240\u6709\u7b2c\u4e09\u65b9\u8d44\u6e90\u7684\u63a5\u5165\uff0c\u5927\u5927\u6269\u5c55\u4e86 Istio \u7684\u4f5c\u7528\u8303\u56f4\uff0c\u5176\u5e94\u7528\u96be\u5ea6\u81ea\u7136\u6c34\u6da8\u8239\u9ad8\uff0c \u5e94\u8be5\u8bf4\u8fd8\u662f\u53ef\u4ee5\u7406\u89e3\u7684\u3002 2-3 authentication.istio.io \u8fd9\u4e00\u7ec4 API \u7528\u4e8e\u5b9a\u4e49\u8ba4\u8bc1\u7b56\u7565\u3002\u5b83\u5728\u7f51\u683c\u7ea7\u522b\u3001\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u53ca\u670d\u52a1\u7ea7\u522b\u90fd\u63d0 \u4f9b\u4e86\u8ba4\u8bc1\u7b56\u7565\u7684\u8981\u6c42\uff0c\u8981\u6c42\u5728\u5185\u5bb9\u4e2d\u5305\u542b\u670d\u52a1\u95f4\u7684\u901a\u4fe1\u8ba4\u8bc1\uff0c\u4ee5\u53ca\u57fa\u4e8e JWT \u7684\u7ec8\u7aef\u8ba4\u8bc1\u3002\u8fd9\u91cc\u7b80\u5355\u4ecb\u7ecd\u5176\u4e2d\u6d89\u53ca\u7684\u5bf9\u8c61\u3002 1.Policy Policy \u7528\u4e8e\u6307\u5b9a\u670d\u52a1\u4e00\u7ea7\u7684\u8ba4\u8bc1\u7b56\u7565\uff0c\u5982\u679c\u5c06\u5176\u547d\u540d\u4e3a \u201cdefault\" \uff0c\u90a3\u4e48\u8be5\u5bf9\u8c61\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u4f1a\u9ed8\u8ba4\u91c7\u7528\u8fd9\u4e00\u8ba4\u8bc1\u7b56\u7565\u3002 Policy \u5bf9\u8c61\u7531\u4e24\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a \u7b56\u7565\u65e5\u6807 \u548c \u8ba4\u8bc1\u65b9\u6cd5 \u3002 \u7b56\u7565\u76ee\u6807\u5305\u542b\u670d\u52a1\u540d\u79f0\uff08\u6216\u4e3b\u673a\u540d\u79f0)\u53ca\u670d\u52a1\u7aef\u53e3\u53f7\u3002 \u8ba4\u8bc1\u65b9\u6cd5\u7531\u4e24\u4e2a\u53ef\u9009\u90e8\u5206\u7ec4\u6210\uff0c\u5206\u522b\u662f\u7528\u4e8e\u8bbe\u7f6e\u670d\u52a1\u95f4\u8ba4\u8bc1\u7684 peers \u5b50\u5bf9\u8c61\uff0c\u4ee5\u53ca\u7528\u4e8e\u8bbe\u7f6e\u7ec8\u7aef\u8ba4\u8bc1\u7684origins\u5b50\u5bf9\u8c61\u3002 2.Mesh Policy MeshPolicy \u53ea\u80fd\u88ab\u547d\u540d\u4e3a \u201cdefault\" \uff0c\u5b83\u4ee3\u8868\u7684\u662f\u6240\u6709\u7f51\u683c\u5185\u90e8\u5e94\u7528\u7684\u9ed8\u8ba4\u8ba4\u8bc1\u7b56\u7565\uff0c\u5176\u4f59\u90e8\u5206\u5185\u5bb9\u548c\u00b7Policy\u00b7\u4e00\u81f4\u3002 2-4 rbac.istio.io \u5728 Istio \u4e2d\u5b9e\u73b0\u4e86\u4e00\u4e2a\u548c Kubernetes \u9887\u4e3a\u76f8\u4f3c\u7684 RBAC \uff08\u57fa\u4e8e\u89d2\u8272\u7684\uff09\u8bbf\u95ee\u63a7\u5236\u7cfb\u7edf\uff0c\u5176\u4e3b\u8981\u5bf9\u8c61\u4e3a ServiceRole \u548c ServiceRoleBinding . 1 Service Role ServiceRole \u7531\u4e00\u7cfb\u5217\u89c4\u5219\uff08rules\uff09\u7ec4\u6210\uff0c\u6bcf\u6761\u89c4\u5219\u90fd\u5bf9\u5e94\u4e00\u6761\u6743\u9650\uff0c\u5176\u4e2d\u63cf\u8ff0\u4e86\u6743\u9650\u6240\u5bf9\u5e94\u7684\u670d\u52a1\u3001\u670d\u52a1\u8def\u5f84\u53ca\u65b9\u6cd5\uff0c\u8fd8\u5305\u542b\u4e00\u7ec4\u53ef\u4ee5\u8fdb\u884c\u81ea\u5b9a\u4e49\u7684\u7ea6\u675f\u3002 2 Service Role Binding \u548c Kubernetes RBAC \u7c7b\u4f3c\uff0c\u8be5\u5bf9\u8c61\u7528\u4e8e\u5c06\u7528\u6237\u4e3b\u4f53\uff08\u53ef\u80fd\u662f\u7528\u6237\u6216\u8005\u670d\u52a1\uff09\u548c ServiceRole \u8fdb\u884c\u7ed1\u5b9a","title":"\u7b2c\u4e8c\u8282 Istio \u57fa\u672c\u4ecb\u7ecd"},{"location":"chap5/2Istio_Intro/#istio","text":"\u524d\u9762\u63d0\u5230\uff0cIstio\u51fa\u81ea\u540d\u95e8\uff0c\u7531Google. IBM\u548cLyft\u57282017\u5e745\u6708\u5408\u4f5c\u63a8\u51fa\uff0c\u5b83\u7684\u521d\u59cb\u8bbe\u8ba1\u76ee\u6807\u662f\u5728Kubernetes\u7684\u57fa\u7840\u4e0a\uff0c\u4ee5\u975e\u4fb5\u5165\u7684\u65b9\u5f0f\u4e3a\u8fd0\u884c\u5728\u96c6\u7fa4\u4e2d\u7684\u5fae\u670d\u52a1\u63d0\u4f9b \u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u52a0\u56fa\u3001\u670d\u52a1\u76d1\u63a7\u548c\u7b56\u7565\u7ba1\u7406 \u7b49\u529f\u80fd\u3002 \u9664\u4e86\u524d\u9762\u63d0\u5230\u7684\u670d\u52a1\u7f51\u683c\u57fa\u672c\u529f\u80fd\uff0cIstio\u8fd8\u63d0\u4f9b\u4e86\u5bf9\u7269\u7406\u673a\u548cConsul\u7684\u6ce8\u518c\u670d\u52a1\u7684\u652f\u6301\uff0c\u5e76\u63d0\u4f9b\u4e86\u63a5\u53e3\uff0c\u7528\u9002\u914d\u5668\u4e0e\u5916\u754c\u7684\u7b2c\u4e09\u65b9IT\u7cfb\u7edf\u8fdb\u884c\u5bf9\u63a5\u3002 Kubernetes \u662f\u5176\u4e3b\u8981\u652f\u6301\u7684\u5e73\u53f0\uff0c\u5bf9\u5176\u4ed6\u5e73\u53f0\u7684\u652f\u6301\u8fd8\u5f88\u521d\u7ea7\uff0e\u5982\u679c\u6ca1\u6709\u81ea\u7814\u529f\u80fd\uff0c\u5219\u4e0d\u5efa\u8bae \u5c1d\u8bd5\uff0c\u672c\u4e66\u4e5f\u4e0d\u4f1a\u63d0\u53ca\u8fd9\u4e00\u90e8\u5206\u5185\u5bb9\u3002","title":"\u7b2c\u4e8c\u8282 Istio \u57fa\u672c\u4ecb\u7ecd"},{"location":"chap5/2Istio_Intro/#1-istio","text":"Istio\u603b\u4f53\u6765\u8bf4\u5206\u4e3a\u4e24\u90e8\u5206\uff1a \u63a7\u5236\u9762 \u548c \u6570\u636e\u9762 \u5982\u4e0b\u6240\u8ff0\u3002 \u6570\u636e\u9762\u88ab\u79f0\u4e3a\u201cSidecar\"\uff0c\u53ef\u5c06\u5176\u7406\u89e3\u4e3a\u65e7\u5f0f\u4e09\u8f6e\u6469\u6258\u8f66\u7684\u6302\u6597\u3002Sidecar, \u901a\u8fc7\u6ce8\u4eba\u7684\u65b9\u5f0f\u548c\u4e1a\u52a1\u5bb9\u5668\u5171\u5b58\u4e8e\u4e00\u4e2a Pod \u4e2d\uff0c \u4f1a\u52ab\u6301\u4e1a\u52a1\u5e94\u7528\u5bb9\u5668\u7684\u6d41\u91cf \uff0c \u5e76\u63a5\u53d7\u63a7\u5236\u9762\u7ec4\u4ef6\u7684\u63a7\u5236\uff0c\u540c\u65f6\u4f1a\u5411\u63a7\u5236\u9762\u8f93\u51fa\u65e5\u5fd7\u3001\u8ddf\u8e2a\u53ca\u76d1\u63a7\u6570\u636e \u3002 \u63a7\u5236\u9762\u662f Istio \u7684\u6838\u5fc3\uff0c\u7ba1\u7406 Istio \u7684\u6240\u6709\u529f\u80fd \u3002 Istio \u7684\u4e3b\u8981\u7ec4\u4ef6\u53ca\u5176\u76f8\u4e92\u5173\u7cfb\u5927\u81f4\u5982\u56fe\u6240\u793a\uff0c\u4e0b\u9762\u5bf9\u8fd9\u4e9b\u5173\u952e\u7ec4\u4ef6\u8fdb\u884c\u8bb2\u89e3\u3002","title":"1\u3001 Istio\u7684\u6838\u5fc3\u7ec4\u4ef6\u53ca\u5176\u529f\u80fd"},{"location":"chap5/2Istio_Intro/#1-1-pilot","text":"Pilot \u662f Istio \u7684\u4e3b\u8981\u63a7\u5236\u70b9\uff0c Istio \u7684\u6d41\u91cf\u5c31\u662f\u7531 Pilot \u7ba1\u7406\u7684\uff08\u5177\u4f53\u6267\u884c\u662f\u7531 Sidecar \u5b8c\u6210\u7684\uff09 \u3002 \u5728\u6574\u4e2a\u7cfb\u7edf\u4e2d\uff0c Pilot \u5b8c\u6210\u4ee5\u4e0b\u4efb\u52a1\uff1a \u4ece Kubernetes \u6216\u8005\u5176\u4ed6\u5e73\u53f0\u7684\u6ce8\u518c\u4e2d\u5fc3\u83b7\u53d6\u670d\u52a1\u4fe1\u606f\uff0c\u5b8c\u6210\u670d\u52a1\u53d1\u73b0\u8fc7\u7a0b\uff1b \u8bfb\u53d6 Istio \u7684\u5404\u9879\u63a7\u5236\u914d\u7f6e\uff0c\u5728\u8fdb\u884c\u8f6c\u6362\u4e4b\u540e\uff0c\u5c06\u5176\u53d1\u7ed9\u6570\u636e\u9762\u8fdb\u884c\u5b9e\u65bd\u3002 Pilot \u7684\u914d\u7f6e\u5185\u5bb9\u4f1a\u88ab\u8f6c\u6362\u4e3a \u6570\u636e\u9762 \u80fd\u591f\u7406\u89e3\u7684\u683c\u5f0f\uff0c\u4e0b\u53d1\u7ed9\u6570\u636e\u9762\u7684 Sidecar , Sidecar \u6839\u636e Pilot \u6307\u4ee4\uff0c\u5c06\u8def\u7531\u3001\u670d\u52a1\u3001\u76d1\u542c\u3001\u96c6\u7fa4\u7b49\u5b9a\u4e49\u4fe1\u606f\u8f6c\u6362\u4e3a\u672c\u5730\u914d\u7f6e\uff0c\u5b8c\u6210\u63a7\u5236\u884c\u4e3a\u7684\u843d\u5730\u3002 \u7528\u6237\u901a\u8fc7 kubectl \u6216\u8005 istioctl \uff08\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7API\uff09\u5728Kubernetes \u4e0a\u521b\u5efa CRD \u8d44\u6e90\uff0c \u5bf9 Istio \u63a7\u5236\u5e73\u9762\u53d1\u51fa\u6307\u4ee4 Pilot \u76d1\u542c CRD \u4e2d\u7684 config , rbac , networking \uff0c \u5728\u68c0\u6d4b\u5230\u8d44\u6e90\u5bf9\u8c61\u7684\u53d8\u66f4\u4e4b\u540e,\u9488\u5bf9\u5176\u4e2d\u6d89\u53ca\u7684\u670d\u52a1\uff0c \u53d1\u51fa\u6307\u4ee4\u7ed9\u5bf9\u5e94\u7684 Sidecar Sidecar \u6839\u636e\u8fd9\u4e9b\u6307\u4ee4\u66f4\u65b0\u81ea\u8eab\u7684\u914d\u7f6e\uff0c\u6839\u636e\u914d\u7f6e\u4fee\u6b63\u901a\u4fe1\u7684\u884c\u4e3a","title":"1-1 Pilot"},{"location":"chap5/2Istio_Intro/#1-2-mixer","text":"Mixer \u7684\u804c\u8d23\u4e3b\u8981\u6709\u4e24\u4e2a\uff0c \u9884\u68c0 \u548c \u56de\u62a5 , \u7b80\u5355\u7684\u793a\u610f\u56fe Mixer\u7684\u7b80\u5355\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\u3002 \u7528\u6237\u5c06 Mixer \uff1a\u914d\u7f6e\u53d1\u9001\u5230 Kubernetes \u4e2d\u3002 Mixer \uff1a\u901a\u8fc7\u5bf9 Kubernetes \u8d44\u6e90\u7684\u76d1\u542c\uff0c\u83b7\u77e5\u914d\u7f6e\u7684\u53d8\u5316 \u3002 \u7f51\u683c\u4e2d\u7684\u670d\u52a1\u5728\u6bcf\u6b21\u8c03\u7528\u4e4b\u524d\uff0c\u90fd\u5411 Mixer \u53d1\u51fa\u9884\u68c0\u8bf7\u6c42\uff0c\u67e5\u770b\u8c03\u7528\u662f\u5426\u5141\u8bb8\u6267\u884c\u3002\u5728\u6bcf\u6b21\u8c03\u7528\u4e4b\u540e\uff0c\u90fd\u53d1\u51fa\u62a5\u544a\u4fe1\u606f\uff0c\u5411 Mixer \u6c47\u62a5\u5728\u8c03\u7528\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u76d1\u63a7\u8ddf\u8e2a\u6570\u636e\u3002 \u5728 Mixer \u4e2d\u5305\u542b\u591a\u4e2a\u88ab\u79f0\u4e3a Adapter \u7684\u7ec4\u4ef6\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u7528\u6765\u5904\u7406 \u5728 Mixer \u4e2d\u63a5\u6536\u7684\u9884\u68c0\u548c\u62a5\u544a\u6570\u636e\uff0c\u4ece\u800c\u5b8c\u6210 Mixer \u7684\u5404\u79cd\u529f\u80fd\u3002","title":"1-2 Mixer"},{"location":"chap5/2Istio_Intro/#1-3-citadel","text":"Citadel \u5728Istio\u7684\u65e9\u671f\u7248\u672c\u4e2d\u88ab\u79f0\u4e3a Istio-CA \uff0c\u4e0d\u96be\u770b\u51fa\uff0c\u5b83\u662f\u7528\u4e8e\u8bc1\u4e66\u7ba1\u7406\u7684\u3002 \u5728\u96c6\u7fa4\u4e2d\u542f\u7528\u4e86\u670d\u52a1\u4e4b\u95f4\u7684\u52a0\u5bc6\u4e4b\u540e\uff0c Citadel \u8d1f\u8d23\u4e3a\u96c6\u7fa4\u4e2d\u7684\u5404\u4e2a\u670d\u52a1\u5728\u7edf\u4e00 CA \u7684\u6761\u4ef6\u4e0b\u751f\u6210\u8bc1\u4e66\uff0c\u5e76\u4e0b\u53d1\u7ed9\u5404\u4e2a\u670d\u52a1\u4e2d\u7684 Sidecar \uff0c\u670d\u52a1\u4e4b\u95f4\u7684 TLS \u5c31\u4f9d\u8d56\u8fd9\u4e9b\u8bc1\u4e66\u5b8c\u6210\u6821\u9a8c\u8fc7\u7a0b\u3002","title":"1-3 Citadel"},{"location":"chap5/2Istio_Intro/#1-4-sidecarenvoy","text":"Sidecar \u5c31\u662f Istio \u4e2d\u7684\u6570\u636e\u9762\uff0c\u8d1f\u8d23\u63a7\u5236\u9762\u5bf9\u7f51\u683c\u63a7\u5236\u7684\u5b9e\u9645\u6267\u884c\u3002 Istio \u4e2d\u7684\u9ed8\u8ba4 Sidecar \u662f\u7531 Envoy \u6d3e\u751f\u51fa\u6765\u7684\uff0c\u5728\u7406\u8bba\u4e0a\uff0c\u53ea\u8981\u652f\u6301 Envoy \u7684 xDS \u534f\u8bae\uff0c\u5176\u4ed6\u7c7b\u4f3c\u7684\u53cd\u5411\u4ee3\u7406\u8f6f\u4ef6\u5c31\u90fd\u53ef\u4ee5\u4ee3\u66ff Envoy \u6765\u62c5\u5f53\u8fd9\u4e00\u89d2\u8272\u3002 \u5728 Istio \u7684\u9ed8\u8ba4\u5b9e\u73b0\u4e2d\uff0c Istio \u5229\u7528 istio-init \u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u7684 iptables \u6307\u4ee4\uff0c\u5bf9\u4e00\u6240\u5728 Pod \u7684\u6d41\u91cf\u8fdb\u884c\u52ab\u6301\uff0c\u4ece\u800c\u63a5\u7ba1 Pod \u4e2d\u5e94\u7528\u7684\u901a\u4fe1\u8fc7\u7a0b\uff0c\u5982\u6b64\u4e00\u6765\uff0c\u5c31\u83b7\u5f97\u4e86\u901a\u4fe1\u7684\u63a7\u5236\u6743\uff0c\u63a7\u5236\u9762\u7684\u63a7\u5236\u76ee\u7684\u6700\u7ec8\u5f97\u4ee5\u5b9e\u73b0 \u3002 \u6ce8\u4eba Sidecar \u524d\u540e\u7684\u901a\u4fe1\u6a21\u5f0f\u53d8\u5316\u5982\u56fe\u6240\u793a\u3002 \u719f\u6089 Kubernetes \u7684\u5e94\u8be5\u90fd\u77e5\u9053\uff0c\u5728\u540c\u4e00\u4e2a Pod \u5185\u7684\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\uff0c\u7f51\u7edc\u6808\u662f\u5171\u4eab\u7684\uff0c\u8fd9\u6b63\u662f Sidecar \u6a21\u5f0f\u7684\u5b9e\u73b0\u57fa\u7840(Pause Pod)\u3002\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c Sidecar \u5728\u52a0\u4eba\u4e4b\u540e\uff0c\u539f\u6709\u7684\u6e90\u5bb9\u5668\u4e00\u76ee\u7684\u5bb9\u5668\u7684\u76f4\u63a5\u901a\u4fe1\u65b9\u5f0f\uff0c\u53d8\u6210\u4e86 \u6e90\u5bb9\u5668\u4e00>Sidecar->Sidecar\u4e00>\u76ee\u7684\u5bb9\u5668 \u7684\u6a21\u5f0f\u3002 \u800c Sidecar \u662f\u7528\u6765\u63a5\u53d7\u63a7\u5236\u9762\u7ec4\u4ef6\u7684\u64cd\u4f5c\u7684\uff0c\u8fd9\u6837\u4e00\u6765\uff0c\u5c31\u8ba9\u901a\u4fe1\u8fc7\u7a0b\u4e2d\u7684\u63a7\u5236\u548c\u89c2\u5bdf\u6210\u4e3a\u53ef\u80fd\u3002","title":"1-4 Sidecar(Envoy)"},{"location":"chap5/2Istio_Intro/#2","text":"Istio \u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4f1a\u8fdb\u884c CRD \u7684\u521d\u59cb\u5316\uff0c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u6ce8\u518c\u4e00\u7cfb\u5217\u7684 CRD . CRD \u5728\u6ce8\u518c\u6210\u529f\u4e4b\u540e\uff0c\u4f1a\u5efa\u7acb\u4e00\u4e9b\u57fa\u7840\u5bf9\u8c61\uff0c\u5b8c\u6210 Istio \u7684\u521d\u59cb\u8bbe\u7f6e\u3002 \u5728\u524d\u9762\u4ecb\u7ecd\u7ec4\u4ef6\u65f6\u66fe\u591a\u6b21\u63d0\u5230\uff0c\u7528\u6237\u5229\u7528 Istio \u63a7\u5236\u5fae\u670d\u52a1\u901a\u4fe1\uff0c\u662f\u901a\u8fc7\u5411 Kubernetes \u63d0\u4ea4 CRD \u8d44\u6e90\u7684\u65b9\u5f0f\u5b8c\u6210\u7684\u3002 Istio \u4e2d\u7684\u8d44\u6e90\u5206\u4e3a\u4e09\u7ec4\u8fdb\u884c\u7ba1\u7406\uff0c\u5206\u522b\u662f networking.istio.io . config.istio.io \u53ca authentication.istio.io \uff0c\u4e0b\u9762\u5c06\u5206\u522b\u8fdb\u884c\u4ecb\u7ecd \u3002","title":"2\u3001 \u6838\u5fc3\u914d\u7f6e\u5bf9\u8c61"},{"location":"chap5/2Istio_Intro/#2-1-networkingistio","text":"networking.istio \u7cfb\u5217\u5bf9\u8c61\u5728 Istio \u4e2d\u53ef\u80fd\u662f\u4f7f\u7528\u9891\u7387\u6700\u9ad8\u7684 Istio \u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\u5c31\u662f\u7528\u8fd9\u4e00\u7ec4\u5bf9\u8c61\u5b8c\u6210\u7684\u8fd9\u91cc\u9009\u62e9\u5176\u5dfe\u6700\u5e38\u7528\u7684\u5bf9\u8c61\u8fdb\u884c\u7b80\u5355\u4ecb\u7ecd. \u5728 networking.istio,io \u7684\u4e0b\u5c5e\u8d44\u6e90\u4e2d Virtual Service \u662f\u4e00\u4e2a\u63a7\u5236\u4e2d\u5fc3\u5b83\u7684\u529f\u80fd \u7b80\u5355\u8bf4\u6765\u5c31\u662f\uff1b \u5b9a\u4e49\u4e00\u7ec4\u6761\u4ef6\uff0c\u5c06\u7b26\u5408\u8be5\u6761\u4ef6\u7684\u6d41\u91cf\u6309\u7167\u5728\u5bf9\u8c61\u4e2d\u914d\u7f6e\u7684\u5bf9\u5e94\u7b56\u7565 \u8fdb\u884c\u5904\u7406\uff0c\u6700\u540e\u5c06\u8def\u7531\u8f6c\u5230\u5339\u914d\u7684\u65e5\u6807\u4e2d\u3002\u4e0b\u9762\u5217\u51fa\u51e0\u4e2a\u5178\u578b\u7684\u5e94\u7528\u573a\u666f\u3002 (1\uff09\u6765\u81ea\u670d\u52a1 A \u7248\u672c 1 \u7684\u670d\u52a1\uff0c\u5982\u679c\u8981\u8bbf\u95ee\u670d\u52a1 B \uff0c\u5219\u8981\u5c06\u8def\u7531\u6307\u5411\u670d\u52a1 B \u7684\u7248\u672c 2 (2\uff09\u5728\u670d\u52a1 x \u53d1\u5f80\u670d\u52a1 Y \u7684 HTTP \u8bf7\u6c42\u4e2d\uff0c\u5982\u679c Header \u5305\u542b canary=true \u5219\u628a\u670d\u52a1\u76ee\u6807\u6307\u5411\u670d\u52a1 Y \u7684\u7248\u672c 3 .\u5426\u5219\u53d1\u7ed9\u670d\u52a1 Y \u7684\u7248\u672c 2 (3\uff09\u4e3a\u4ece\u670d\u52a1 M \u5230\u670d\u52a1 N \u7684\u6240\u6709\u8bbf\u95ee\u90fd\u52a0\u4eba\u5ef6\u8fdf\uff0c\u4ee5\u6d4b\u8bd5\u5728\u7f51\u7edc\u72b6\u51b5\u4e0d\u4f73\u65f6\u7684\u8868\u73b0\u3002 \u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u65b9\u9762\u7684\u529f\u80fd\u662f\u6bd4\u8f83\u590d\u6742\u7684 \u56e0\u6b64\u5176\u4e2d\u5305\u542b\u7684\u884c\u4e3a\u5b9a\u4e49\u4e5f\u4e00\u5b9a\u4e0d\u7b80\u5355\u3002 Istio \u5bf9\u8def\u7531\u7ba1\u7406\u505a\u4e86\u5f88\u597d\u7684\u62bd\u8c61\u3002\u56fe\u5c55\u793a\u4e86\u6d41\u91cf\u8bbf\u95ee\u6d41\u7a0b\u4e2d\u7684\u51e0\u4e2a\u5173\u952e\u5bf9\u8c61","title":"2-1 networking.istio"},{"location":"chap5/2Istio_Intro/#1-gateway","text":"\u5728\u8bbf\u95ee\u670d\u52a1\u65f6\uff0c\u4e0d\u8bba\u662f\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e92\u8bbf\uff0c\u8fd8\u662f\u901a\u8fc7 ingress \u8fdb\u4eba\u7f51\u683c\u7684\u5916\u90e8\u6d41\u91cf\uff0c\u9996\u5148\u8981\u7ecf\u8fc7\u7684\u8bbe\u65bd\u90fd\u662f Gateway . Gateway \u5bf9\u8c61\u63cf\u8ff0\u4e86\u8fb9\u7f18\u63a5\u4eba\u8bbe\u5907\u7684\u6982\u5ff5\uff0c \u5176\u4e2d\u5305\u542b\u5bf9\u5f00\u653e\u7aef\u53e3\u3001\u4e3b\u673a\u540d\u53ca\u53ef\u80fd\u5b58\u5728\u7684 TLS \u8bc1\u4e66\u7684\u5b9a\u4e49\u3002 \u7f51\u7edc\u8fb9\u7f18\u7684 ingress \u6d41\u91cf\uff0c\u4f1a\u901a\u8fc7\u5bf9\u5e94\u7684 Istio Ingress Gateway Controller \u8fdb\u5165\uff1b \u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u4e92\u8bbf\uff0c \u5219\u901a\u8fc7\u865a\u62df\u7684 mesh \u7f51\u5173\u8fdb\u884c\uff08 mesh \u7f51\u5173\u4ee3\u8868\u7f51\u683c\u5185\u90e8\u7684\u6240\u6709 Sidecar ) Pilot \u4f1a\u6839\u636e Gateway \u548c \u4e3b\u673a\u540d \u8fdb\u884c\u68c0\u7d22\uff0c\u5982\u679c\u5b58\u5728\u5bf9\u5e94\u7684 VirtualService \uff0c\u5219\u4ea4 \u7531 VirtualService \u5904\u7406\uff1b \u5982\u679c\u662f Mesh Gateway \u4e14\u4e0d\u5b58\u5728\u5bf9\u5e94\u8fd9\u4e00\u4e3b\u673a\u540d\u7684 VirtualService \uff0c\u5219\u5c1d\u8bd5\u8c03\u7528 Kubernetes Service (SVC)\uff1b\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u53d1\u751f 404 \u9519\u8bef\u3002","title":"1. Gateway"},{"location":"chap5/2Istio_Intro/#2-virtualservice","text":"Virtual Service \u5bf9\u8c61\u4e3b\u8981\u7531\u4ee5\u4e0b\u90e8\u5206\u7ec4\u6210\u3002 (1) Host \uff1a\u8be5\u5bf9\u8c61\u6240\u8d1f\u8d23\u7684\u4e3b\u673a\u540d\u79f0\uff0c\u5982\u679c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u5219\u8fd9\u4e2a\u4e3b\u673a\u540d\u53ef\u4ee5\u662f\u670d\u52a1\u540d\u3002 (2) Gateway \uff1a \u6d41\u91cf\u7684\u6765\u6e90\u7f51\u5173 \uff0c\u5728\u540e\u9762\u4f1a\u4ecb\u7ecd\u7f51\u5173\u7684\u6982\u5ff5\u3002\u5982\u679c\u8fd9\u4e00\u5b57\u6bb5\u88ab\u7701 \u7565\uff0c\u5219\u4ee3\u8868\u4f7f\u7528\u7684\u7f51\u5173\u540d\u4e3a \u201cmesh\" \uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u7684\u7f51\u683c\u5185\u90e8\u670d\u52a1\u4e92\u8054\u6240\u7528\u7684\u7f51\u5173\u3002 (3\uff09 \u8def\u7531\u5bf9\u8c61 \uff1a\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\uff0c\u5982\u679c\u7b26\u5408\u524d\u9762\u7684 Host \u548c Gateway \u7684\u6761\u4ef6\uff0c\u5c31\u9700\u8981\u6839\u636e\u5b9e\u9645\u534f\u8bae\u5bf9\u6d41\u91cf\u7684\u5904\u7406\u65b9\u5f0f\u8fdb\u884c\u7504\u522b\u3002\u5176\u539f\u56e0\u662f\uff1a HTTP \u662f\u4e00\u79cd\u900f\u660e\u534f\u8bae\uff0c\u53ef\u4ee5\u7ecf\u8fc7\u5bf9\u62a5\u6587\u7684\u89e3\u6790\uff0c\u5b8c\u6210\u66f4\u7ec6\u81f4\u7684\u63a7\u5236\uff1b\u800c\u5bf9\u4e8e\u539f\u59cb\u7684TCP\u6d41\u91cf\u6765\u8bf4\uff0c\u5c31\u65e0\u6cd5 \u5b8c\u6210\u8fc7\u4e8e\u590d\u6742\u7684\u4efb\u52a1\u4e86\u3002","title":"2 VirtualService"},{"location":"chap5/2Istio_Intro/#3-tcptlshttp-route","text":"\u8def\u7531\u5bf9\u8c61\u76ee\u524d\u53ef\u4ee5\u662f HTTP \u3001 TCP \u6216\u8005 TLS \u4e2d\u7684\u4e00\u4e2a\uff0c\u5206\u522b\u9488\u5bf9\u4e0d\u540c\u7684\u534f\u8bae\u8fdb\u884c\u5de5\u4f5c\u3002\u6bcf\u79cd\u8def\u7531\u5bf9\u8c61\u90fd\u81f3\u5c11\u5305\u542b\u4e24\u90e8\u5206\uff1a \u5339\u914d\u6761\u4ef6\u548c\u76ee\u7684\u8def\u7531\u3002 \u4f8b\u5982\uff0c\u5728 HTTPRoute \u3002 \u5bf9\u8c61\u4e2d\u5c31\u5305\u542b\u7528\u4e8e\u5339\u914d\u7684 HTTPMatchRequest \u5bf9\u8c61\u6570\u7ec4\uff0c\u4ee5\u53ca\u7528\u4e8e\u63cf\u8ff0\u76ee\u6807\u670d\u52a1\u7684 DestinationWeight \u5bf9\u8c61\uff0c\u5e76\u4e14 HTTPMatchRequest \u7684\u5339\u914d\u6761\u4ef6\u8f83\u4e3a\u4e30\u5bcc\uff0c\u4f8b\u5982\u524d\u9762\u63d0\u5230\u7684 http header \u6216\u8005 uri \u7b49\u9664\u6b64\u4e4b\u5916\uff0c HTTP \u8def\u7531\u5bf9\u8c61\u53d7\u76ca\u4e8e HTTP \u7684\u900f\u660e\u6027\uff0c\u5305\u542b\u5f88\u591a\u4e13\u5c5e\u7684\u989d\u5916\u7279\u6027\uff0c\u4f8b\u5982 \u8d85\u65f6\u63a7\u5236\u3001\u91cd\u8bd5\u3001\u9519\u8bef\u6ce8\u5165 \u7b49\u3002 \u76f8\u5bf9\u6765\u8bf4\uff0c TCPRoute \u3002 \u7b80\u5355\u5f88\u591a\uff0c\u5b83\u7684\u5339\u914d\u501f\u52a9\u8d44\u6e90 L4MatchAttributes \u5bf9\u8c61\u5b8c\u6210\uff0c\u5176\u4e2d\u9664 Istio \u56fa\u6709\u7684\u6807\u7b7e\u548c Gateway \u5916\uff0c\u4ec5\u5305\u542b\u5730\u5740\u548c\u7aef\u53e3\u3002 \u5728\u5339\u914d\u5b8c\u6210\u540e\uff0c\u81ea\u7136\u5c31\u662f\u9009\u62e9\u5408\u9002\u7684\u76ee\u6807\u4e86\u3002","title":"3 TCP/TLS/HTTP Route"},{"location":"chap5/2Istio_Intro/#4-destinationweight","text":"\u5404\u534f\u8bae\u8def\u7531\u7684\u76ee\u6807\u5b9a\u4e49\u662f\u4e00\u81f4\u7684\uff0c\u90fd \u7531Destination Weight \u5bf9\u8c61\u6570\u7ec4\u6765\u5b8c\u6210 Destination Weight \u6307\u5230\u67d0\u4e2a\u76ee\u6807\uff08 Destination \u5bf9\u8c61\uff09\u7684\u6d41\u91cf\u6743\u91cd\uff0c\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u591a\u4e2a\u76ee\u6807\u53ef\u4ee5\u540c\u65f6\u4e3a\u8be5 Virtual Service \u63d0\u4f9b\u670d\u52a1\uff0c\u5e76\u6309\u7167\u6743\u91cd\u8fdb\u884c\u6d41\u91cf\u5206\u914d\u3002","title":"4 DestinationWeight"},{"location":"chap5/2Istio_Intro/#5-destination","text":"\u76ee\u6807\u5bf9\u8c61\uff08 Destination \uff09\u7531 Subset \u548c Port \u4e24\u4e2a\u5143\u7d20\u7ec4\u6210\u3002 Subset \u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u6307\u670d\u52a1\u7684\u4e00\u4e2a\u5b50\u96c6\uff0c\u5b83\u5728 Kubernetes \u4e2d\u4ee3\u8868\u4f7f\u7528\u6807\u7b7e\u9009\u62e9\u5668\u533a\u5206\u7684\u4e0d\u540c Pod \uff08\u4f8b\u5982\u4e24\u4e2a Deployment )\u3002 Port \u4ee3\u8868\u7684\u5219\u662f\u670d\u52a1\u7684\u7aef\u53e3\u3002 6\uff0e\u5c0f\u7ed3 \u81f3\u6b64\uff0c\u6d41\u91cf\u7ecf\u8fc7\u591a\u4e2a\u5bf9\u8c61\u7684\u9010\u7ea7\u5904\u7406\uff0c\u6210\u529f\u5230\u8fbe\u4e86 Pod \uff0c","title":"5 Destination"},{"location":"chap5/2Istio_Intro/#2-2-configistioio","text":"config.istio.io \u4e2d\u7684\u5bf9\u8c61\u7528\u4e8e\u4e3a Mixer \u7ec4\u4ef6\u63d0\u4f9b\u914d\u7f6e\u3002 Mixer \u4f9b\u4e86 \u9884\u68c0 \u548c \u62a5\u544a \u8fd9\u4e24\u4e2a\u529f\u80fd\uff0c\u8fd9\u4e24\u4e2a\u529f\u80fd\u770b\u4f3c\u7b80\u5355\uff0c\u4f46\u662f\u56e0\u4e3a\u5927\u91cf\u9002\u914d\u5668\u7684\u5b58\u5728\u3002\u53d8\u5f97\u76f8\u5f53\u590d\u6742\uff0c \u56fe\u5c55\u793a\u4e86 Mixer \u5bf9\u6570\u636e\u5904\u7406\u8fc7\u7a0b 1.Rule Rule \u5bf9\u8c61\u662f Mixer \u7684\u4eba\u53e3\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e2a match \u6210\u5458\u548c\u4e00\u4e2a\u903b\u8f91\u8868\u8fbe\u5f0f\uff0c\u53ea\u6709\u7b26\u5408\u8868\u8fbe\u5f0f\u5224\u65ad\u7684\u6570\u636e\u624d\u4f1a\u88ab\u4ea4\u7ed9 Action \u5904\u7406 \u3002 \u903b\u8f91\u8868\u8fbe\u5f0f\u4e2d\u7684\u53d8\u91cf\u88ab\u79f0\u4e3a attribute \uff08\u5c5e\u6027\uff09\uff0c\u5176\u4e2d\u7684\u5185\u5bb9\u6765\u81ea Envoy \u63d0\u4ea4\u7684\u6570\u636e\u3002 2.Action Action \u8d1f\u8d23\u89e3\u51b3\u7684\u95ee\u9898\u5c31\u662f\uff1a\u5c06\u7b26\u5408\u4eba\u53e3\u6807\u51c6\u7684\u6570\u636e\uff0c\u5728\u7528\u4ec0\u4e48\u65b9\u5f0f\u52a0\u5de5\u4e4b\u540e\uff0c\u4ea4\u7ed9\u54ea\u4e2a\u9002\u914d\u5668\u8fdb\u884c\u5904\u7406\u3002 Action \u5305\u542b\u4e24\u4e2a\u6210\u5458\u5bf9\u8c61\uff1a \u4e00\u4e2a\u662f Instance \uff0c\u4f7f\u7528 Template \u5bf9\u63a5\u6536\u5230\u7684\u6570\u636e\u8fdb\u884c\u5904\u7406\uff1b \u4e00\u4e2a\u662f Handler \uff0c\u4ee3\u8868\u4e00\u4e2a\u9002\u914d\u5668\u7684\u5b9e\u4f8b\uff0c\u7528\u4e8e\u63a5\u6536\u5904\u7406\u540e\u7684\u6570\u636e\u3002 3.Instance Instance \u4e3b\u8981\u7528\u4e8e\u4e3a\u8fdb\u5165\u7684\u6570\u636e\u9009\u62e9\u4e00\u4e2a\u6a21\u677f\uff0c\u5e76\u5728\u6570\u636e\u4e2d\u62bd\u53d6\u67d0\u4e9b\u5b57\u6bb5\u4f5c\u4e3a\u6a21\u677f\u7684\u53c2\u6570\uff0c\u4f20\u8f93\u7ed9\u6a21\u677f\u8fdb\u884c\u5904\u7406\u3002 4.Adapter Adapter \u5728 Istio \u53ea\u88ab\u5b9a\u4e49\u4e3a\u4e00\u4e2a\u884c\u4e3a\u89c4\u8303 \uff0c\u800c\u4e00\u4e9b\u5fc5\u8981\u7684\u5b9e\u4f8b\u5316\u6570\u636e\u662f\u9700\u8981\u518d\u6b21\u8fdb\u884c\u521d\u59cb\u5316\u7684\uff0c\u4f8b\u5982 RedisQuota \u9002\u914d\u5668\u4e2d\u7684 Redis \u5730\u5740\uff0c\u6216\u8005 Listchecker \u4e2d\u7684\u9ed1\u767d\u540d\u5355\u7b49\uff0c\u53ea\u6709\u8fd9\u4e9b\u6570\u636e\u5f97\u5230\u6b63\u5f0f\u7684\u521d\u59cb\u5316\uff0c Adapter \u624d\u80fd\u88ab\u6295\u4eba\u4f7f\u7528 \u7ecf\u8fc7 Handler \u5b9e\u4f8b\u5316\u4e4b\u540e\u7684\u00b7Adapter\u00b7\uff0c\u5c31\u5177\u5907\u4e86\u5de5\u4f5c\u529f\u80fd\u3002 \u6709\u4e9b Adapter \u662f Istio \u7684\u81ea\u8eab\u5b9e\u73b0\uff0c\u4f8b\u5982\u524d\u9762\u63d0\u5230\u7684 listcheck \u6216\u8005 memquota \uff1b \u6709\u4e9b Adapter \u662f\u7b2c\u4e09\u65b9\u670d\u52a1\uff0c\u4f8b\u5982 Prometheus \u6216\u8005 Datadog \u7b49\u3002 Envoy \u4f20\u51fa\u7684\u6570\u636e\u5c06\u4f1a\u901a\u8fc7\u8fd9\u4e9b\u5177\u4f53\u8fd0\u884c\u7684 Adapter \u7684\u5904\u7406\uff0c\u5f97\u5230\u9884\u68c0\u7ed3\u679c\uff0c\u6216\u8005\u8f93\u51fa\u5404\u79cd\u76d1\u63a7\u3001\u65e5\u5fd7\u53ca\u8ddf\u8e2a\u6570\u636e\u3002 5.Template \u987e\u540d\u601d\u4e49\uff0c Template \u662f\u4e00\u4e2a\u6a21\u677f\uff0c\u7528\u4e8e\u5bf9\u63a5\u6536\u5230\u7684\u6570\u636e\u8fdb\u884c\u518d\u52a0\u5de5. \u8fdb\u4eba Mixer \u4e2d\u7684\u6570\u636e\u90fd\u6765\u81ea Sidecar \uff0c\u4f46\u662f\u5404\u79cd\u9002\u914d\u5668\u5e94\u5bf9\u7684\u9700\u6c42\u5404\u6709\u5343\u79cb\uff0c\u751a\u81f3\u540c\u6837\u4e00\u4e2a\u9002\u914d\u5668\uff0c\u4e5f\u53ef\u80fd\u63a5\u6536\u5404\u79cd\u4e0d\u540c\u5f62\u5f0f\u7684\u6570\u636e\uff08\u4f8b\u5982 Prometheus \u53ef\u80fd\u4f1a\u5728\u540c\u6837\u4e00\u6279\u6570\u636e\u4e2d\u83b7\u53d6\u4e0d\u540c\u7684\u6307\u6807\uff09, Envoy \u63d0\u4f9b\u7684\u539f\u59cb\u6570\u636e\u548c\u9002\u914d\u5668\u6240\u9700\u8981\u7684\u8f93\u4eba\u6570\u636e\u5b58\u5728\u683c\u5f0f\u4e0a\u7684\u5dee\u522b\uff0c\u56e0\u6b64\u9700\u8981\u5bf9\u539f\u59cb\u6570\u636e\u8fdb\u884c\u518d\u52a0\u5de5\u3002 Template \u5c31\u662f\u8fd9\u6837\u4e00\u79cd\u5de5\u5177\uff0c\u5728\u7528\u6237\u7f16\u5236\u6a21\u677f\u5bf9\u8c61\u4e4b\u540e\uff0c\u7ecf\u8fc7\u6a21\u677f\u5904\u7406\u7684\u539f\u59cb\u6570\u636e\u4f1a\u88ab\u8f6c\u6362\u4e3a\u7b26\u5408\u9002\u914d\u5668\u8f93\u4eba\u8981\u6c42\u7684\u6570\u636e\u683c\u5f0f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728 Instance \u5b57\u6bb5\u4e2d\u5f15\u7528 6.Handler Handler \u5bf9\u8c61\u7528\u4e8e\u5bf9 Adapter \u8fdb\u884c\u5b9e\u4f8b\u5316\u3002 \u8fd9\u7ec4\u5bf9\u8c61\u7684\u547d\u540d\u975e\u5e38\u4ee4\u4eba\u8d39\u89e3\uff0c\u4f46\u662f\u4ece\u5176\u529f\u80fd\u5217\u8868\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c Mixer \u7ba1\u7406\u4e86\u6240\u6709\u7b2c\u4e09\u65b9\u8d44\u6e90\u7684\u63a5\u5165\uff0c\u5927\u5927\u6269\u5c55\u4e86 Istio \u7684\u4f5c\u7528\u8303\u56f4\uff0c\u5176\u5e94\u7528\u96be\u5ea6\u81ea\u7136\u6c34\u6da8\u8239\u9ad8\uff0c \u5e94\u8be5\u8bf4\u8fd8\u662f\u53ef\u4ee5\u7406\u89e3\u7684\u3002","title":"2-2 config.istio.io"},{"location":"chap5/2Istio_Intro/#2-3-authenticationistioio","text":"\u8fd9\u4e00\u7ec4 API \u7528\u4e8e\u5b9a\u4e49\u8ba4\u8bc1\u7b56\u7565\u3002\u5b83\u5728\u7f51\u683c\u7ea7\u522b\u3001\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u53ca\u670d\u52a1\u7ea7\u522b\u90fd\u63d0 \u4f9b\u4e86\u8ba4\u8bc1\u7b56\u7565\u7684\u8981\u6c42\uff0c\u8981\u6c42\u5728\u5185\u5bb9\u4e2d\u5305\u542b\u670d\u52a1\u95f4\u7684\u901a\u4fe1\u8ba4\u8bc1\uff0c\u4ee5\u53ca\u57fa\u4e8e JWT \u7684\u7ec8\u7aef\u8ba4\u8bc1\u3002\u8fd9\u91cc\u7b80\u5355\u4ecb\u7ecd\u5176\u4e2d\u6d89\u53ca\u7684\u5bf9\u8c61\u3002 1.Policy Policy \u7528\u4e8e\u6307\u5b9a\u670d\u52a1\u4e00\u7ea7\u7684\u8ba4\u8bc1\u7b56\u7565\uff0c\u5982\u679c\u5c06\u5176\u547d\u540d\u4e3a \u201cdefault\" \uff0c\u90a3\u4e48\u8be5\u5bf9\u8c61\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u4f1a\u9ed8\u8ba4\u91c7\u7528\u8fd9\u4e00\u8ba4\u8bc1\u7b56\u7565\u3002 Policy \u5bf9\u8c61\u7531\u4e24\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a \u7b56\u7565\u65e5\u6807 \u548c \u8ba4\u8bc1\u65b9\u6cd5 \u3002 \u7b56\u7565\u76ee\u6807\u5305\u542b\u670d\u52a1\u540d\u79f0\uff08\u6216\u4e3b\u673a\u540d\u79f0)\u53ca\u670d\u52a1\u7aef\u53e3\u53f7\u3002 \u8ba4\u8bc1\u65b9\u6cd5\u7531\u4e24\u4e2a\u53ef\u9009\u90e8\u5206\u7ec4\u6210\uff0c\u5206\u522b\u662f\u7528\u4e8e\u8bbe\u7f6e\u670d\u52a1\u95f4\u8ba4\u8bc1\u7684 peers \u5b50\u5bf9\u8c61\uff0c\u4ee5\u53ca\u7528\u4e8e\u8bbe\u7f6e\u7ec8\u7aef\u8ba4\u8bc1\u7684origins\u5b50\u5bf9\u8c61\u3002 2.Mesh Policy MeshPolicy \u53ea\u80fd\u88ab\u547d\u540d\u4e3a \u201cdefault\" \uff0c\u5b83\u4ee3\u8868\u7684\u662f\u6240\u6709\u7f51\u683c\u5185\u90e8\u5e94\u7528\u7684\u9ed8\u8ba4\u8ba4\u8bc1\u7b56\u7565\uff0c\u5176\u4f59\u90e8\u5206\u5185\u5bb9\u548c\u00b7Policy\u00b7\u4e00\u81f4\u3002","title":"2-3 authentication.istio.io"},{"location":"chap5/2Istio_Intro/#2-4-rbacistioio","text":"\u5728 Istio \u4e2d\u5b9e\u73b0\u4e86\u4e00\u4e2a\u548c Kubernetes \u9887\u4e3a\u76f8\u4f3c\u7684 RBAC \uff08\u57fa\u4e8e\u89d2\u8272\u7684\uff09\u8bbf\u95ee\u63a7\u5236\u7cfb\u7edf\uff0c\u5176\u4e3b\u8981\u5bf9\u8c61\u4e3a ServiceRole \u548c ServiceRoleBinding . 1 Service Role ServiceRole \u7531\u4e00\u7cfb\u5217\u89c4\u5219\uff08rules\uff09\u7ec4\u6210\uff0c\u6bcf\u6761\u89c4\u5219\u90fd\u5bf9\u5e94\u4e00\u6761\u6743\u9650\uff0c\u5176\u4e2d\u63cf\u8ff0\u4e86\u6743\u9650\u6240\u5bf9\u5e94\u7684\u670d\u52a1\u3001\u670d\u52a1\u8def\u5f84\u53ca\u65b9\u6cd5\uff0c\u8fd8\u5305\u542b\u4e00\u7ec4\u53ef\u4ee5\u8fdb\u884c\u81ea\u5b9a\u4e49\u7684\u7ea6\u675f\u3002 2 Service Role Binding \u548c Kubernetes RBAC \u7c7b\u4f3c\uff0c\u8be5\u5bf9\u8c61\u7528\u4e8e\u5c06\u7528\u6237\u4e3b\u4f53\uff08\u53ef\u80fd\u662f\u7528\u6237\u6216\u8005\u670d\u52a1\uff09\u548c ServiceRole \u8fdb\u884c\u7ed1\u5b9a","title":"2-4 rbac.istio.io"},{"location":"chap5/3Istro_ServiceM_Prac/","text":"\u7b2c\u4e09\u8282 Istio, Service Mesh \u5feb\u901f\u5165\u95e8\uff08Istio 1.1.16\uff09 \u672c\u7ae0\u5c06\u4f1a\u7528\u4e00\u4e2a\u5c0f\u4f8b\u5b50\u6765\u5c55\u793a Istio \u5728\u6d41\u7ae5\u7ba1\u7406\u65b9\u9762\u7684\u80fd\u529b\uff0c\u5c55\u793a\u6d41\u7a0b\u5982\u4e0b \u4f7f\u7528\u4e00\u4e2a\u73b0\u6709\u7684 Istio \u90e8\u7f72\u6587\u4ef6\u7684\u9ed8\u8ba4\u914d\u7f6e\u6765\u5b8c\u6210 Istio \u7684\u5b89\u88c5\uff1b \u4f7f\u7528 Deployment \u5c06\u4e00\u4e2a\u5e94\u7528\u7684\u4e24\u4e2a\u7248\u672c\u4f5c\u4e3a\u6d4b\u8bd5\u670d\u52a1\u90e8\u7f72\u5230\u7f51\u683c\u4e2d\uff1b \u5c06\u4e00\u4e2a\u5ba2\u6237\u7aef\u670d\u52a1\u90e8\u7f72\u5230\u7f51\u683c\u4e2d\u8fdb\u884c\u6d4b\u8bd5\uff1b \u4e3a\u6211\u4eec\u7684\u76ee\u6807\u670d\u52a1\u7f16\u5199\u7b56\u7565\u6587\u4ef6\uff0c\u5bf9\u76ee\u6807\u670d\u52a1\u7684\u6d41\u91cf\u8fdb\u884c\u7ba1\u7406\uff1b \u5728\u6d4b\u8bd5\u670d\u52a1\u4e2d\u7528\u4e0d\u540c\u7684 HTTP \u5934\u8c03\u7528\u76ee\u6807\u670d\u52a1\uff0c\u9a8c\u8bc1\u8fd4\u56de\u7684\u5185\u5bb9\u662f\u5426\u7b26\u5408\u6211\u4eec\u5728\u7b2c3\u6b65\u4e2d\u5b9a\u4e49\u7684\u6d41\u91cf\u7ba1\u7406\u7b56\u7565\u3002 \u5728 Istio \u5b98\u7f51\u4e5f\u63d0\u4f9b \u4e86Bookinfo \u5e94\u7528\u8fdb\u884c\u6f14\u793a\uff0c\u7136\u800c\u8fd9\u4e2a\u5e94\u7528\u672c\u8eab\u5c31\u8f83\u4e3a\u590d\u6742\u5f88\u591a\u7ed3\u679c\u9a8c\u8bc1\u90fd\u9700\u8981\u4f7f\u7528\u6d4f\u89c8\u5668\u91cd\u590d\u5237\u65b0\u6765\u5b8c\u6210\uff0c\u56e0\u6b64\u672c\u4e66\u5bf9\u6d4b\u8bd5\u6848\u4f8b\u8fdb\u884c\u4e86\u91cd\u65b0\u8bbe\u8ba1\u3002 1.\u73af\u5883\u4ecb\u7ecd \u672c\u4e66\u4ec5\u56f4\u7ed5 Kubernetes \u73af\u5883\u4e0b\u7684 Istio \u5b89\u88c5\u548c\u4f7f\u7528\u8fdb\u884c\u8bb2\u89e3\uff0c\u8fd9\u91cc\u4e5f\u4ec5\u7ed9\u51fa\u5bf9 Kubernetes\u73af\u5883\u7684\u8981\u6c42\uff1a Kubernetes1.9 \u6216\u4ee5\u4e0a\u7248\u672c\uff1b \u5177\u5907\u7ba1\u7406\u6743\u9650\u7684 kubectl \u53ca\u5176\u914d\u7f6e\u6587\u4ef6\uff0c\u80fd\u591f\u64cd\u4f5c\u6d4b\u8bd5\u96c6\u7fa4\uff1b Kubernetes\u96c6\u7fa4\u8981\u6709\u83b7\u53d6\u4e92\u8054\u7f51\u955c\u50cf\u7684\u80fd\u529b \u8981\u652f\u6301 Istio \u7684\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff0c\u9700\u8981\u68c0\u67e5 Kubernetes API Server \u7684\u542f\u52a8\u53c2\u6570\uff0c \u4fdd\u8bc1\u5176\u4e2d\u7684 admission control \u90e8\u5206\u6309\u987a\u5e8f\u542f\u7528 MutatingAdmissionWebhhook \u548c ValidatingAdmission Webhook 2.\u5feb\u901f\u90e8\u7f72 https://github.com/istio/istio/releases \u7248\u672c\u9009\u62e9 Istio 1.1.16 \u5b89\u88c5\u5305 istio-1.1.16-mac.tar.gz K8S\u73af\u5883 NAME STATUS ROLES AGE VERSION docker-desktop Ready master 32d v1.14.6 2-1 \u5b89\u88c5 istioctl export PATH=\"$HOME/Istio/istio-1.1.16/bin:$PATH\" \u5feb\u901f\u5b89\u88c5 (Quick Start Evaluation Install) https://istio.io/docs/setup/install/kubernetes/ $ cd Istio/istio-1.1.16/install/kubernetes $ ls -l README.md istio-citadel-plugin-certs.yaml istio-demo.yaml ansible istio-citadel-standalone.yaml mesh-expansion.yaml global-default-sidecar-scope.yaml istio-citadel-with-health-check.yaml namespace.yaml helm istio-demo-auth.yaml Install CRD( optional ) $ for i in helm/istio-init/files/crd*yaml; do kubectl apply -f $i; done customresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io created customresourcedefinition.apiextensions.k8s.io/destinationrules.networking.istio.io created customresourcedefinition.apiextensions.k8s.io/serviceentries.networking.istio.io crea ... customresourcedefinition.apiextensions.k8s.io/orders.certmanager.k8s.io created customresourcedefinition.apiextensions.k8s.io/challenges.certmanager.k8s.io created Install Istio-demo kubectl apply -f istio-demo.yaml secret/kiali created configmap/istio-galley-configuration created configmap/istio-grafana-custom-resources created configmap/istio-grafana-configuration-dashboards-galley-dashboard created configmap/istio-grafana-configuration-dashboards-istio-mesh-dashboard created ... rule.config.istio.io/kubeattrgenrulerule created rule.config.istio.io/tcpkubeattrgenrulerule created kubernetes.config.istio.io/attributes created destinationrule.networking.istio.io/istio-policy created destinationrule.networking.istio.io/istio-telemetry created \u4e0d\u96be\u770b\u51fa\uff0c Kubernetes \u5bf9\u8c61\u9664\u4e86\u5e38\u4e00\u89c1\u7684 Deployment \u3001 Service \u3001 Configmap \u3001 ServiceAccount \u7b49\u8fd9\u91cc\u8fd8\u521b\u5efa\u4e86\u5927\u91cf\u7684 CRD \u53ca\u5404\u79cd CRD \u7684\u4e0b\u5c5e\u8d44\u6e90\u3002 Verifying the installation $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.97.103.25 <none> 3000/TCP 3m21s istio-citadel ClusterIP 10.100.168.139 <none> 8060/TCP,15014/TCP 3m21s istio-egressgateway ClusterIP 10.106.95.123 <none> 80/TCP,443/TCP,15443/TCP 3m22s istio-galley ClusterIP 10.108.209.18 <none> 443/TCP,15014/TCP,9901/TCP 3m22s istio-ingressgateway LoadBalancer 10.107.84.164 localhost 15020:31984/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32733/TCP,15030:31365/TCP,15031:31173/TCP,15032:31320/TCP,15443:32343/TCP 3m21s istio-pilot ClusterIP 10.107.118.185 <none> 15010/TCP,15011/TCP,8080/TCP,15014/TCP 3m21s istio-policy ClusterIP 10.111.42.225 <none> 9091/TCP,15004/TCP,15014/TCP 3m21s istio-sidecar-injector ClusterIP 10.107.211.88 <none> 443/TCP 3m21s istio-telemetry ClusterIP 10.98.81.13 <none> 9091/TCP,15004/TCP,15014/TCP,42422/TCP 3m21s jaeger-agent ClusterIP None <none> 5775/UDP,6831/UDP,6832/UDP 3m20s jaeger-collector ClusterIP 10.103.140.100 <none> 14267/TCP,14268/TCP 3m20s jaeger-query ClusterIP 10.107.110.32 <none> 16686/TCP 3m20s kiali ClusterIP 10.100.10.115 <none> 20001/TCP 3m21s prometheus ClusterIP 10.108.193.251 <none> 9090/TCP 3m21s tracing ClusterIP 10.102.103.34 <none> 80/TCP 3m20s zipkin ClusterIP 10.111.148.171 <none> 9411/TCP 3m20s \u8fd0\u884c\u5982\u4e0b\u547d\u4ee4\uff0c\u67e5\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u7684Pod\u542f\u52a8\u72b6\u51b5\uff0c\u5176\u4e2d\u7684 -w \u53c2\u6570 \u7528\u4e8e\u6301\u7eed\u67e5\u8be2 Pod \u72b6\u6001\u7684\u53d8\u5316\uff1a $ kubectl get pods -n istio-sysem tem -w NAME READY STATUS RESTARTS AGE grafana-67c69bb567-sxtrt 1/1 Running 0 93m istio-citadel-5966cb6796-67zz5 1/1 Running 0 93m istio-cleanup-secrets-1.1.16-7mrdr 0/1 Completed 0 93m istio-egressgateway-65559f6769-5qzpq 1/1 Running 0 93m istio-galley-84c585d695-52jvg 1/1 Running 0 93m istio-grafana-post-install-1.1.16-wcpd9 0/1 Completed 0 93m istio-ingressgateway-6499cc6d8b-qpj8d 1/1 Running 0 93m istio-pilot-5546948cf8-6rf2p 2/2 Running 0 93m istio-policy-68c98f8464-tvz8c 2/2 Running 7 93m istio-security-post-install-1.1.16-f49mn 0/1 Completed 0 93m istio-sidecar-injector-766758654c-8gpj4 1/1 Running 0 93m istio-telemetry-579cfdb5b-h7l64 2/2 Running 7 93m istio-tracing-5d8f57c8ff-j7xrn 1/1 Running 0 93m kiali-d4d886dd7-whm5w 1/1 Running 0 93m prometheus-d8d46c5b5-tjhbb 1/1 Running 0 93m 3.\u90e8\u7f72\u4e24\u4e2a\u7248\u672c\u7684\u670d\u52a1 3-1 \u4e00\u4e2a\u7b80\u5355\u7684Python\u811a\u672c\u4f5c\u4e3a\u670d\u52a1\u7aef \u8fd9\u6bb5\u811a\u672c\u662f\u4e00\u4e2aFlask\u5e94\u7528\uff0c \u63d0\u4f9b\u8fde\u4e2aURL\u8def\u5f84\uff0c \u4e00\u4e2a\u662f /env \u7528\u4e8e\u83b7\u53d6\u5bb9\u5668\u4e2d\u7684\u73af\u5883\u53d8\u91cf\uff0c \u4f8b\u5982 http://flaskapp/env/version ; \u53e6\u5916\u4e00\u4e2a\u662f /fetch \u7528\u4e8e\u83b7\u53d6\u53c2\u6570url\u4e2d\u6307\u5b9a\u7684\u7f51\u5740\u5185\u5bb9\uff0c \u4f8b\u5982 http://flaskapp/fetch?url=https://weibo.com #!/usr/bin/env python3 from flask import Flask, request import os import url lib.request app=Flask(__name__) @app.route('/env/<env>') def showenv(env): return os.environ.get(env) @app.route\uff08'/fetch'\uff09 def fetch_env(): url=request.args.get('url','') with urllib.request.urlopen(url) as reponse: return reponse.read if __name__ == \"__main__\": app.run(host=\"0,0,0,0\", port=80, debug=True) \u6211\u4eec\u4e3a\u8fd9\u4e2a App \u521b\u5efa\u4e24\u4e2a Deployment \uff0c\u5c06\u5176\u5206\u522b\u547d\u540d\u4e3a flaskapp-v1 \u548c flaskapp-v2 ; \u540c\u65f6\u521b\u5efa\u4e00\u4e2a Service \uff0c\u5c06\u5176\u547d\u540d\u4e3a flask app \uff0c\u5c06\u4e0b\u9762\u7684\u5185\u5bb9\u4fdd\u5b58\u4e3a flaskapp.istio.yaml : apiVersion: v1 kind: Service metadata: name: flaskapp labels: app: flaskapp spec: selector: app: flaskapp ports: - name: http port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: flaskapp-v1 spec: replicas: 1 template: metadata: labels: app: flaskapp version: v1 spec: containers: - name: flaskapp image: dustise/flaskapp imagePullPolicy: IfNotPresent env: - name: version value: v1 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: flaskapp-v2 spec: replicas: 1 template: metadata: labels: app: flaskapp version: v1 spec: containers: - name: flaskapp image: dustise/flaskapp imagePullPolicy: IfNotPresent env: - name: version value: v2 \u5728\u4e0a\u9762\u7684YAML\u6e90\u7801\u4e2d\u6709\u4ee5\u4e0b\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u3002 \u4e24\u4e2a\u7248\u672c\u7684 Deployment \u7684\u955c\u50cf\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u4f7f\u7528\u4e86\u4e0d\u540c\u7684 version \u6807\u7b7e\u8fdb\u884c\u533a\u5206\uff0c\u5206\u522b\u662f v1 \u548c v2 \u5728\u4e24\u4e2a\u7248\u672c\u7684 Deployment \u5bb9\u5668\u4e2d\u90fd\u6ce8\u518c\u4e86\u4e00\u4e2a\u88ab\u547d\u540d\u4e3a version \u7684\u73af\u5883\u53d8\u91cf\u53d6\u503c\u5206\u522b\u4e3a v1 \u548c v2 \u4e24\u4e2a Deployment \u90fd\u4f7f\u7528\u4e86 app \u548c version \u6807\u7b7e, \u5728 Istio \u7f51\u683c\u5e94\u7528\u4e2d\u901a\u5e38\u4f1a\u4f7f\u7528\u8fd9\u4e24\u4e2a\u6807\u7b7e\u4f5c\u4e3a\u5e94\u7528\u548c\u7248\u672c\u7684\u6807\u8bc6 Service \u4e2d\u7684 Selector \u4ec5\u4f7f\u7528\u4e86\u4e00\u4e2a app \u6807\u7b7e Deployment \u90fd\u662f\u6709\u6548\u7684\u3002 \u63a5\u4e0b\u6765\u4f7f\u7528 istioctl \u8fdb\u884c\u6ce8\u5165\u3002\u4e4b\u540e\u4f1a\u4e00\u76f4\u7528\u5230 istioctl \u547d\u4ee4\uff0c\u5b83\u7684\u57fa\u672c\u4f5c\u7528\u5c31\u8d77\u4fee\u6539 Kubernetes Deployment \uff0c\u5728Pod\u4e2d\u6ce8\u5165\u5728\u524d\u9762\u63d0\u5230\u7684 Sidecar \u5bb9\u5668\uff0c\u901a\u5e38\u4e3a\u4e86\u65b9\u4fbf\uff0c\u6211\u4eec\u4f1a\u4f7f\u7528\u4e00\u4e2a\u7ba1\u9053\u547d\u4ee4\uff0c\u5728\u5c06 YAML \u6587\u4eec \u901a\u8fc7 istioctl \u5904\u7406\u4e4b\u540e\uff0c\u901a\u8fc7\u547d\u4ee4\u884c\u7ba1\u9053\u8f93\u51fa\u7ed9 kubectl \uff0c\u6700\u7ec8\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u547d\u4ee4\u5982\u4e0b\uff1a $ cd ~/Devops_sap/Istio/flaskapp $ istioctl kube-inject -f flask.istio.yaml | kubectl apply -f - service/flaskapp unchanged deployment.extensions/flaskapp-v1 created deployment.extensions/flaskapp-v2 created $ kubectl get pods NAME READY STATUS RESTARTS AGE flaskapp-v1-bc4679d-cd54v 2/2 Running 0 50s flaskapp-v2-89866b97c-4zsqf 2/2 Running 0 50s \u53ef\u4ee5\u770b\u5230\uff0c\u6bcf\u4e2aPod\u90fd\u53d8\u6210\u4e86\u4e24\u4e2a\u5bb9\u5668\uff0c \u4e5f\u5c31\u662f\u662f Istio \u6ce8\u5165 Sidecar \u7684\u7ed3\u679c\uff0c \u53ef\u4ee5\u4f7f\u7528 kubectl describe pod \u547d\u4ee4\u67e5\u770b Pod \u7684\u5bb9\u5668 $ kubectl describe pod flaskapp-v1-74cbbdbdf6-8wxvn ... Init Containers: istio-init: Container ID: ... istio-proxy: Container ID: ... \u4e0d\u96be\u53d1\u73b0\uff0c\u5728\u8fd9\u4e2a Pod \u4e2d\u591a\u4e86\u4e00\u4e2a\u5bb9\u5668\uff0c\u540d\u79f0\u4e3a istio-proxy \uff0c\u8fd9\u5c31\u662f\u6ce8\u4eba\u7684\u7ed3\u679c \u3002\u53e6\u5916\uff0c\u524d\u9762\u8fd8\u6709\u4e00\u4e2a\u540d\u79f0\u4e3a istio-init \u7684\u521d\u59cb\u5316\u5bb9\u5668(job)\uff0c\u8fd9\u4e2a\u5bb9\u5668\u662f\u7528\u4e8e\u521d\u59cb\u5316\u52ab\u6301\u7684\u3002 kubectl get pods -o=jsonpath='{range .items[*]}{\"\\n\"}{.metadata.name}{\":\\t\"}{range .spec.containers[*]}{.image}{\", \"}{end}{end}' |\\sort $ kubectl get pods -o custom-columns='NAME:metadata.name,ImageName:spec.containers[*].image' NAME ImageName flaskapp-v1-bc4679d-cd54v dustise/flaskapp,docker.io/istio/proxyv2:1.1.16 flaskapp-v2-89866b97c-4zsqf dustise/flaskapp,docker.io/istio/proxyv2:1.1.16 sleep-6c9b45d956-5hjl6 dustise/sleep,docker.io/istio/proxyv2:1.1.16 3-2 istioctl kube-inject -h kube-inject manually injects the Envoy sidecar into Kubernetes workloads. Usage: istioctl kube-inject [flags] Examples: # Update resources on the fly before applying. kubectl apply -f <(istioctl kube-inject -f <resource.yaml>) # Create a persistent version of the deployment with Envoy sidecar injected. istioctl kube-inject -f deployment.yaml -o deployment-injected.yaml # Update an existing deployment. kubectl get deployment -o yaml | istioctl kube-inject -f - | kubectl apply -f - # Create a persistent version of the deployment with Envoy sidecar # injected configuration from Kubernetes configmap 'istio-inject' istioctl kube-inject -f deployment.yaml -o deployment-injected.yaml --injectConfigMapName istio-inject 4.\u90e8\u7f72\u5ba2\u6237\u7aef\u670d\u52a1 \u5ba2\u6237\u7aef\u670d\u52a1\u5f88\u7b80\u5355\u53ea\u662f\u4f7f\u7528\u4e86\u4e00\u4e2a\u5df2\u5b89\u88c5\u597d\u5404\u79cd\u6d4b\u8bd5\u5de5\u5177\u7684\u955c\u50cf\uff0c\u5177\u4f53\u7684\u6d4b\u8bd5\u53ef\u4ee5\u5728\u5176\u5185\u90e8\u7684 Shell \u4e2d\u5b8c\u6210\u3002\u540c\u6837\uff0c\u7f16\u5199\u4e00\u4e2a\u3001 YAML \u6587\u4ef6\u5c06\u5176\u547d\u540d\u4e3a sleep.yaml apiVersion: v1 kind: Service metadata: name: sleep labels: app: sleep version: v1 spec: selector: app: sleep version: v1 ports: - name: ssh port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep spec: replicas: 1 template: metadata: labels: app: sleep version: v1 spec: containers: - name: sleep image: dustise/sleep imagePullPolicy: IfNotPresent \u8fd9\u4e2a\u5e94\u7528\u5e76\u6ca1\u6709\u63d0\u4f9b\u5bf9\u5916\u670d\u52a1\u7684\u80fd\u529b, \u6211\u4eec\u7ed9\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a Service \u3002\u65f6\u8c61\u8fd9\u540c\u6837\u662fIstio\u7684\u6ce8\u4eba\u8981\u6c42\uff1a 4-1 \u6ca1\u6709 Service \u7684 Deployment \u662f\u65e0\u6cd5\u88ab Istio \u53d1\u73b0\u4e95\u8fdb\u884c\u64cd\u4f5c\u7684 \u540c\u6837\u5bf9\u8be5\u6587\u4ef6\u8fdb\u884c\u6ce8\u4eba\u5e76\u63d0\u4ea4\u5230 Kubernetes \u8fd0\u884c $ istioctl kube-inject -f sleep.yaml | kubectl apply -f - service/sleep created deployment.extensions/sleep created $ kubectl get pod NAME READY STATUS RESTARTS AGE flaskapp-v1-74cbbdbdf6-4mbb8 1/1 Running 0 12s flaskapp-v2-74cbbdbdf6-zp79g 1/1 Running 0 12s sleep-6c9b45d956-5hjl6 2/2 Running 0 4m31s \u53ef\u4ee5\u770b\u5230\uff0c sleep \u5e94\u7528\u7684 Pod \u5df2\u7ecf\u5f00\u59cb\u4e86 5.\u9a8c\u8bc1\u670d\u52a1 \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 kubectl exec -it \u670d\u52a1\u7684\u5177\u4f53\u8868\u73b0\u3002 \u547d\u4ee4\u8fdb\u4eba\u5ba2\u6237\u7aef Pod \uff0c\u6765\u6d4b\u8bd5 flaskapp \u4f7f\u7528\u4e00\u4e2a\u7b80\u5355\u7684 for \u5faa\u73af\uff0c\u91cd\u590d\u83b7\u53d6 http://flaskapp/env/version \u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u8c03\u7528 flaskapp \u670d\u52a1\uff0c\u67e5\u770b\u5176\u8fd4\u56de\u7ed3\u679c\uff1a kubectl exec -it sleep-6c9b45d956-5hjl6 -c sleep bash # -c, --container='': Container name. If omitted, the first container in the pod will be chosen bash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done v2 v1 v2 v1 v2 v1 v1 v2 v1 v2 \u4ece\u4e0a\u9762\u7684\u8fd0\u884c\u7ed3\u679c\u4e2d\u53ef\u4ee5\u770b\u5230 \u8fd9\u5f88\u5bb9\u6613\u7406\u89e3\uff0c v2 \u548c v1 \u8fd9\u4e24\u79cd\u7ed3\u679c\u968f\u673a\u51fa\u73b0\uff0c\u5927\u7ea6\u5404\u5360\u4e00\u534a\u3002 \u56e0\u4e3a\u6211\u4eec\u7684 flaskapp \u670d\u52a1\u7684\u9009\u62e9\u5668\u88ab\u5b9a\u4e49\u4e3a\u53ea\u6839\u636e App \u6807\u7b7e\u8fdb\u884c\u9009\u62e9\uff0c\u4e24\u4e2a\u7248\u672c\u7684\u670d\u52a1 Pod \u6570\u91cf\u76f8\u540c\uff0c\u56e0\u6b64\u4f1a\u51fa\u73b0\u8f6e\u6d41\u8f93\u51fa\u7684\u6548\u679c\u3002 6.\u521b\u5efa\u76ee\u6807\u89c4\u5219\u548c\u9ed8\u8ba4\u8def\u7531 \u63a5\u4e0b\u6765\u4f7f\u7528 Istio \u6765\u7ba1\u7406\u8fd9\u4e24\u4e2a\u670d\u52a1\u7684\u6d41\u91cf \u9996\u5148\u521b\u5efa flaskapp \u5e94\u7528\u7684\u76ee\u6807\u89c4\u5219\uff0c\u8f93\u5165\u4e00\u4e0b\u5185\u5bb9\u5e76\u5c06\u5176\u4fdd\u5b58\u4e3a flask-detinationrule.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: flaskapp spec: host: flaskapp subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 \u53ef\u4ee5\u770b\u5230\u8be5\u6587\u4ef6\u8fd8\u662f\u5e38\u89c1\u7684 YAML \u683c\u5f0f,\u5b9e\u9645\u4e0a\u4e5f\u53ef\u4ee5\u4f7f\u7528 kubectl \u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u79f0\u4e3a flaskapp \u7684 DestinationRule ,\u5b83\u5229\u7528 Pod \u6807\u7b7e\u628a\u670d\u52a1\u5206\u6210\u4e24\u4e2a subset , \u5c06\u5199\u5206\u522b\u547d\u540d\u4e3a v1 \u548c v2 \u4e0b\u9762\u5c06 flask-detinationrule.yaml \u63d0\u4ea4\u5230\u96c6\u7fa4 $ kubectl apply -f flask-detinationrule.yaml destinationrule.networking.istio.io/flaskapp created $ kubectl get destinationrule NAME HOST AGE flaskapp flaskapp 4m52s \u63a5\u4e0b\u6765\u5c31\u9700\u8981\u4e3a flaskapp \u670d\u52a1\u521b\u5efa\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\u4e86, \u4e0d\u8bba\u662f\u5426\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u6d41\u91cf\u63a7\u5236, \u90fd\u5efa\u8bae\u4e3a\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u521b\u5efa\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\uff0c \u4ee5\u9632\u53d1\u751f\u610f\u6599\u4e4b\u5916\u7684\u8bbf\u95ee\u7ed3\u679c \u4fbf\u7528\u4e0b\u9762\u7684\u5185\u5bb9\u521b\u5efa\u6587\u672c\u6587\u4ef6 flask-default-vs-v2.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp-default-v2 spec: hosts: - flaskapp http: - route: - destination: host: flaskapp subset: v2 \u5728\u8be5\u6587\u672c\u6587\u4ef6\u4e2d\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a VirtualService \u5bf9\u8c61, \u5c06\u5176\u547d\u540d\u4e3a flaskapp-default-v2 , \u5b83\u8d1f\u8d23\u63a5\u7ba1 flaskapp \u8fd9\u4e00\u4e3b\u673a\u540d\u7684\u8bbf\u95ee,\u4f1a\u5c06\u6240\u6709\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230 DestinationRule \u5b9a\u4e49\u7684 v2 subset \u4e0a \u518d\u6b21\u6267\u884c kubectl \u5c06 VirtualService \u63d0\u4ea4\u5230\u96c6\u7fa4 kubectl apply -f flask-default-vs-v2.yaml virtualservice.networking.istio.io/flaskapp-default-v2 created $ kubectl get vs NAME GATEWAYS HOSTS AGE flaskapp-default-v2 [flaskapp] 48s \u5728\u521b\u5efa\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u518d\u6b21\u8fdb\u5165\u5ba2\u6237\u7aef\u7684Pod, \u770b\u770b\u65b0\u5b9a\u4e49\u7684\u6d41\u91cf\u89c4\u5219\u662f\u5426\u751f\u6548 $ kubectl exec -it sleep-85cfc95c7-tvlxq -c sleep bash bash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done v2 v2 v2 v2 v2 v2 v2 v2 v2 v2 \u53ef\u4ee5\u770b\u5230, \u9ed8\u8ba4\u7684\u8def\u7531\u5df1\u7ecf\u751f, \u73b0\u5728\u590d\u591a\u6b21\u8bbf\u95ee\uff0c \u8fd4\u56de\u7684\u5185\u5bb9\u6765\u81ea\u73af\u5883\u53d8\u91cf version \u88ab\u8bbe\u7f6e\u4e3a v2 \u7684\u7248\u672c.","title":"\u7b2c\u4e09\u8282 Istio, Service Mesh \u5feb\u901f\u5165\u95e8\uff08Istio 1.1.16\uff09"},{"location":"chap5/3Istro_ServiceM_Prac/#istio-service-mesh-istio-1116","text":"\u672c\u7ae0\u5c06\u4f1a\u7528\u4e00\u4e2a\u5c0f\u4f8b\u5b50\u6765\u5c55\u793a Istio \u5728\u6d41\u7ae5\u7ba1\u7406\u65b9\u9762\u7684\u80fd\u529b\uff0c\u5c55\u793a\u6d41\u7a0b\u5982\u4e0b \u4f7f\u7528\u4e00\u4e2a\u73b0\u6709\u7684 Istio \u90e8\u7f72\u6587\u4ef6\u7684\u9ed8\u8ba4\u914d\u7f6e\u6765\u5b8c\u6210 Istio \u7684\u5b89\u88c5\uff1b \u4f7f\u7528 Deployment \u5c06\u4e00\u4e2a\u5e94\u7528\u7684\u4e24\u4e2a\u7248\u672c\u4f5c\u4e3a\u6d4b\u8bd5\u670d\u52a1\u90e8\u7f72\u5230\u7f51\u683c\u4e2d\uff1b \u5c06\u4e00\u4e2a\u5ba2\u6237\u7aef\u670d\u52a1\u90e8\u7f72\u5230\u7f51\u683c\u4e2d\u8fdb\u884c\u6d4b\u8bd5\uff1b \u4e3a\u6211\u4eec\u7684\u76ee\u6807\u670d\u52a1\u7f16\u5199\u7b56\u7565\u6587\u4ef6\uff0c\u5bf9\u76ee\u6807\u670d\u52a1\u7684\u6d41\u91cf\u8fdb\u884c\u7ba1\u7406\uff1b \u5728\u6d4b\u8bd5\u670d\u52a1\u4e2d\u7528\u4e0d\u540c\u7684 HTTP \u5934\u8c03\u7528\u76ee\u6807\u670d\u52a1\uff0c\u9a8c\u8bc1\u8fd4\u56de\u7684\u5185\u5bb9\u662f\u5426\u7b26\u5408\u6211\u4eec\u5728\u7b2c3\u6b65\u4e2d\u5b9a\u4e49\u7684\u6d41\u91cf\u7ba1\u7406\u7b56\u7565\u3002 \u5728 Istio \u5b98\u7f51\u4e5f\u63d0\u4f9b \u4e86Bookinfo \u5e94\u7528\u8fdb\u884c\u6f14\u793a\uff0c\u7136\u800c\u8fd9\u4e2a\u5e94\u7528\u672c\u8eab\u5c31\u8f83\u4e3a\u590d\u6742\u5f88\u591a\u7ed3\u679c\u9a8c\u8bc1\u90fd\u9700\u8981\u4f7f\u7528\u6d4f\u89c8\u5668\u91cd\u590d\u5237\u65b0\u6765\u5b8c\u6210\uff0c\u56e0\u6b64\u672c\u4e66\u5bf9\u6d4b\u8bd5\u6848\u4f8b\u8fdb\u884c\u4e86\u91cd\u65b0\u8bbe\u8ba1\u3002","title":"\u7b2c\u4e09\u8282 Istio, Service Mesh \u5feb\u901f\u5165\u95e8\uff08Istio 1.1.16\uff09"},{"location":"chap5/3Istro_ServiceM_Prac/#1","text":"\u672c\u4e66\u4ec5\u56f4\u7ed5 Kubernetes \u73af\u5883\u4e0b\u7684 Istio \u5b89\u88c5\u548c\u4f7f\u7528\u8fdb\u884c\u8bb2\u89e3\uff0c\u8fd9\u91cc\u4e5f\u4ec5\u7ed9\u51fa\u5bf9 Kubernetes\u73af\u5883\u7684\u8981\u6c42\uff1a Kubernetes1.9 \u6216\u4ee5\u4e0a\u7248\u672c\uff1b \u5177\u5907\u7ba1\u7406\u6743\u9650\u7684 kubectl \u53ca\u5176\u914d\u7f6e\u6587\u4ef6\uff0c\u80fd\u591f\u64cd\u4f5c\u6d4b\u8bd5\u96c6\u7fa4\uff1b Kubernetes\u96c6\u7fa4\u8981\u6709\u83b7\u53d6\u4e92\u8054\u7f51\u955c\u50cf\u7684\u80fd\u529b \u8981\u652f\u6301 Istio \u7684\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff0c\u9700\u8981\u68c0\u67e5 Kubernetes API Server \u7684\u542f\u52a8\u53c2\u6570\uff0c \u4fdd\u8bc1\u5176\u4e2d\u7684 admission control \u90e8\u5206\u6309\u987a\u5e8f\u542f\u7528 MutatingAdmissionWebhhook \u548c ValidatingAdmission Webhook","title":"1.\u73af\u5883\u4ecb\u7ecd"},{"location":"chap5/3Istro_ServiceM_Prac/#2","text":"https://github.com/istio/istio/releases \u7248\u672c\u9009\u62e9 Istio 1.1.16 \u5b89\u88c5\u5305 istio-1.1.16-mac.tar.gz K8S\u73af\u5883 NAME STATUS ROLES AGE VERSION docker-desktop Ready master 32d v1.14.6","title":"2.\u5feb\u901f\u90e8\u7f72"},{"location":"chap5/3Istro_ServiceM_Prac/#2-1-istioctl","text":"export PATH=\"$HOME/Istio/istio-1.1.16/bin:$PATH\" \u5feb\u901f\u5b89\u88c5 (Quick Start Evaluation Install) https://istio.io/docs/setup/install/kubernetes/ $ cd Istio/istio-1.1.16/install/kubernetes $ ls -l README.md istio-citadel-plugin-certs.yaml istio-demo.yaml ansible istio-citadel-standalone.yaml mesh-expansion.yaml global-default-sidecar-scope.yaml istio-citadel-with-health-check.yaml namespace.yaml helm istio-demo-auth.yaml Install CRD( optional ) $ for i in helm/istio-init/files/crd*yaml; do kubectl apply -f $i; done customresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io created customresourcedefinition.apiextensions.k8s.io/destinationrules.networking.istio.io created customresourcedefinition.apiextensions.k8s.io/serviceentries.networking.istio.io crea ... customresourcedefinition.apiextensions.k8s.io/orders.certmanager.k8s.io created customresourcedefinition.apiextensions.k8s.io/challenges.certmanager.k8s.io created Install Istio-demo kubectl apply -f istio-demo.yaml secret/kiali created configmap/istio-galley-configuration created configmap/istio-grafana-custom-resources created configmap/istio-grafana-configuration-dashboards-galley-dashboard created configmap/istio-grafana-configuration-dashboards-istio-mesh-dashboard created ... rule.config.istio.io/kubeattrgenrulerule created rule.config.istio.io/tcpkubeattrgenrulerule created kubernetes.config.istio.io/attributes created destinationrule.networking.istio.io/istio-policy created destinationrule.networking.istio.io/istio-telemetry created \u4e0d\u96be\u770b\u51fa\uff0c Kubernetes \u5bf9\u8c61\u9664\u4e86\u5e38\u4e00\u89c1\u7684 Deployment \u3001 Service \u3001 Configmap \u3001 ServiceAccount \u7b49\u8fd9\u91cc\u8fd8\u521b\u5efa\u4e86\u5927\u91cf\u7684 CRD \u53ca\u5404\u79cd CRD \u7684\u4e0b\u5c5e\u8d44\u6e90\u3002 Verifying the installation $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.97.103.25 <none> 3000/TCP 3m21s istio-citadel ClusterIP 10.100.168.139 <none> 8060/TCP,15014/TCP 3m21s istio-egressgateway ClusterIP 10.106.95.123 <none> 80/TCP,443/TCP,15443/TCP 3m22s istio-galley ClusterIP 10.108.209.18 <none> 443/TCP,15014/TCP,9901/TCP 3m22s istio-ingressgateway LoadBalancer 10.107.84.164 localhost 15020:31984/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32733/TCP,15030:31365/TCP,15031:31173/TCP,15032:31320/TCP,15443:32343/TCP 3m21s istio-pilot ClusterIP 10.107.118.185 <none> 15010/TCP,15011/TCP,8080/TCP,15014/TCP 3m21s istio-policy ClusterIP 10.111.42.225 <none> 9091/TCP,15004/TCP,15014/TCP 3m21s istio-sidecar-injector ClusterIP 10.107.211.88 <none> 443/TCP 3m21s istio-telemetry ClusterIP 10.98.81.13 <none> 9091/TCP,15004/TCP,15014/TCP,42422/TCP 3m21s jaeger-agent ClusterIP None <none> 5775/UDP,6831/UDP,6832/UDP 3m20s jaeger-collector ClusterIP 10.103.140.100 <none> 14267/TCP,14268/TCP 3m20s jaeger-query ClusterIP 10.107.110.32 <none> 16686/TCP 3m20s kiali ClusterIP 10.100.10.115 <none> 20001/TCP 3m21s prometheus ClusterIP 10.108.193.251 <none> 9090/TCP 3m21s tracing ClusterIP 10.102.103.34 <none> 80/TCP 3m20s zipkin ClusterIP 10.111.148.171 <none> 9411/TCP 3m20s \u8fd0\u884c\u5982\u4e0b\u547d\u4ee4\uff0c\u67e5\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u7684Pod\u542f\u52a8\u72b6\u51b5\uff0c\u5176\u4e2d\u7684 -w \u53c2\u6570 \u7528\u4e8e\u6301\u7eed\u67e5\u8be2 Pod \u72b6\u6001\u7684\u53d8\u5316\uff1a $ kubectl get pods -n istio-sysem tem -w NAME READY STATUS RESTARTS AGE grafana-67c69bb567-sxtrt 1/1 Running 0 93m istio-citadel-5966cb6796-67zz5 1/1 Running 0 93m istio-cleanup-secrets-1.1.16-7mrdr 0/1 Completed 0 93m istio-egressgateway-65559f6769-5qzpq 1/1 Running 0 93m istio-galley-84c585d695-52jvg 1/1 Running 0 93m istio-grafana-post-install-1.1.16-wcpd9 0/1 Completed 0 93m istio-ingressgateway-6499cc6d8b-qpj8d 1/1 Running 0 93m istio-pilot-5546948cf8-6rf2p 2/2 Running 0 93m istio-policy-68c98f8464-tvz8c 2/2 Running 7 93m istio-security-post-install-1.1.16-f49mn 0/1 Completed 0 93m istio-sidecar-injector-766758654c-8gpj4 1/1 Running 0 93m istio-telemetry-579cfdb5b-h7l64 2/2 Running 7 93m istio-tracing-5d8f57c8ff-j7xrn 1/1 Running 0 93m kiali-d4d886dd7-whm5w 1/1 Running 0 93m prometheus-d8d46c5b5-tjhbb 1/1 Running 0 93m","title":"2-1 \u5b89\u88c5istioctl"},{"location":"chap5/3Istro_ServiceM_Prac/#3","text":"","title":"3.\u90e8\u7f72\u4e24\u4e2a\u7248\u672c\u7684\u670d\u52a1"},{"location":"chap5/3Istro_ServiceM_Prac/#3-1-python","text":"\u8fd9\u6bb5\u811a\u672c\u662f\u4e00\u4e2aFlask\u5e94\u7528\uff0c \u63d0\u4f9b\u8fde\u4e2aURL\u8def\u5f84\uff0c \u4e00\u4e2a\u662f /env \u7528\u4e8e\u83b7\u53d6\u5bb9\u5668\u4e2d\u7684\u73af\u5883\u53d8\u91cf\uff0c \u4f8b\u5982 http://flaskapp/env/version ; \u53e6\u5916\u4e00\u4e2a\u662f /fetch \u7528\u4e8e\u83b7\u53d6\u53c2\u6570url\u4e2d\u6307\u5b9a\u7684\u7f51\u5740\u5185\u5bb9\uff0c \u4f8b\u5982 http://flaskapp/fetch?url=https://weibo.com #!/usr/bin/env python3 from flask import Flask, request import os import url lib.request app=Flask(__name__) @app.route('/env/<env>') def showenv(env): return os.environ.get(env) @app.route\uff08'/fetch'\uff09 def fetch_env(): url=request.args.get('url','') with urllib.request.urlopen(url) as reponse: return reponse.read if __name__ == \"__main__\": app.run(host=\"0,0,0,0\", port=80, debug=True) \u6211\u4eec\u4e3a\u8fd9\u4e2a App \u521b\u5efa\u4e24\u4e2a Deployment \uff0c\u5c06\u5176\u5206\u522b\u547d\u540d\u4e3a flaskapp-v1 \u548c flaskapp-v2 ; \u540c\u65f6\u521b\u5efa\u4e00\u4e2a Service \uff0c\u5c06\u5176\u547d\u540d\u4e3a flask app \uff0c\u5c06\u4e0b\u9762\u7684\u5185\u5bb9\u4fdd\u5b58\u4e3a flaskapp.istio.yaml : apiVersion: v1 kind: Service metadata: name: flaskapp labels: app: flaskapp spec: selector: app: flaskapp ports: - name: http port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: flaskapp-v1 spec: replicas: 1 template: metadata: labels: app: flaskapp version: v1 spec: containers: - name: flaskapp image: dustise/flaskapp imagePullPolicy: IfNotPresent env: - name: version value: v1 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: flaskapp-v2 spec: replicas: 1 template: metadata: labels: app: flaskapp version: v1 spec: containers: - name: flaskapp image: dustise/flaskapp imagePullPolicy: IfNotPresent env: - name: version value: v2 \u5728\u4e0a\u9762\u7684YAML\u6e90\u7801\u4e2d\u6709\u4ee5\u4e0b\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u3002 \u4e24\u4e2a\u7248\u672c\u7684 Deployment \u7684\u955c\u50cf\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u4f7f\u7528\u4e86\u4e0d\u540c\u7684 version \u6807\u7b7e\u8fdb\u884c\u533a\u5206\uff0c\u5206\u522b\u662f v1 \u548c v2 \u5728\u4e24\u4e2a\u7248\u672c\u7684 Deployment \u5bb9\u5668\u4e2d\u90fd\u6ce8\u518c\u4e86\u4e00\u4e2a\u88ab\u547d\u540d\u4e3a version \u7684\u73af\u5883\u53d8\u91cf\u53d6\u503c\u5206\u522b\u4e3a v1 \u548c v2 \u4e24\u4e2a Deployment \u90fd\u4f7f\u7528\u4e86 app \u548c version \u6807\u7b7e, \u5728 Istio \u7f51\u683c\u5e94\u7528\u4e2d\u901a\u5e38\u4f1a\u4f7f\u7528\u8fd9\u4e24\u4e2a\u6807\u7b7e\u4f5c\u4e3a\u5e94\u7528\u548c\u7248\u672c\u7684\u6807\u8bc6 Service \u4e2d\u7684 Selector \u4ec5\u4f7f\u7528\u4e86\u4e00\u4e2a app \u6807\u7b7e Deployment \u90fd\u662f\u6709\u6548\u7684\u3002 \u63a5\u4e0b\u6765\u4f7f\u7528 istioctl \u8fdb\u884c\u6ce8\u5165\u3002\u4e4b\u540e\u4f1a\u4e00\u76f4\u7528\u5230 istioctl \u547d\u4ee4\uff0c\u5b83\u7684\u57fa\u672c\u4f5c\u7528\u5c31\u8d77\u4fee\u6539 Kubernetes Deployment \uff0c\u5728Pod\u4e2d\u6ce8\u5165\u5728\u524d\u9762\u63d0\u5230\u7684 Sidecar \u5bb9\u5668\uff0c\u901a\u5e38\u4e3a\u4e86\u65b9\u4fbf\uff0c\u6211\u4eec\u4f1a\u4f7f\u7528\u4e00\u4e2a\u7ba1\u9053\u547d\u4ee4\uff0c\u5728\u5c06 YAML \u6587\u4eec \u901a\u8fc7 istioctl \u5904\u7406\u4e4b\u540e\uff0c\u901a\u8fc7\u547d\u4ee4\u884c\u7ba1\u9053\u8f93\u51fa\u7ed9 kubectl \uff0c\u6700\u7ec8\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\u3002 \u547d\u4ee4\u5982\u4e0b\uff1a $ cd ~/Devops_sap/Istio/flaskapp $ istioctl kube-inject -f flask.istio.yaml | kubectl apply -f - service/flaskapp unchanged deployment.extensions/flaskapp-v1 created deployment.extensions/flaskapp-v2 created $ kubectl get pods NAME READY STATUS RESTARTS AGE flaskapp-v1-bc4679d-cd54v 2/2 Running 0 50s flaskapp-v2-89866b97c-4zsqf 2/2 Running 0 50s \u53ef\u4ee5\u770b\u5230\uff0c\u6bcf\u4e2aPod\u90fd\u53d8\u6210\u4e86\u4e24\u4e2a\u5bb9\u5668\uff0c \u4e5f\u5c31\u662f\u662f Istio \u6ce8\u5165 Sidecar \u7684\u7ed3\u679c\uff0c \u53ef\u4ee5\u4f7f\u7528 kubectl describe pod \u547d\u4ee4\u67e5\u770b Pod \u7684\u5bb9\u5668 $ kubectl describe pod flaskapp-v1-74cbbdbdf6-8wxvn ... Init Containers: istio-init: Container ID: ... istio-proxy: Container ID: ... \u4e0d\u96be\u53d1\u73b0\uff0c\u5728\u8fd9\u4e2a Pod \u4e2d\u591a\u4e86\u4e00\u4e2a\u5bb9\u5668\uff0c\u540d\u79f0\u4e3a istio-proxy \uff0c\u8fd9\u5c31\u662f\u6ce8\u4eba\u7684\u7ed3\u679c \u3002\u53e6\u5916\uff0c\u524d\u9762\u8fd8\u6709\u4e00\u4e2a\u540d\u79f0\u4e3a istio-init \u7684\u521d\u59cb\u5316\u5bb9\u5668(job)\uff0c\u8fd9\u4e2a\u5bb9\u5668\u662f\u7528\u4e8e\u521d\u59cb\u5316\u52ab\u6301\u7684\u3002 kubectl get pods -o=jsonpath='{range .items[*]}{\"\\n\"}{.metadata.name}{\":\\t\"}{range .spec.containers[*]}{.image}{\", \"}{end}{end}' |\\sort $ kubectl get pods -o custom-columns='NAME:metadata.name,ImageName:spec.containers[*].image' NAME ImageName flaskapp-v1-bc4679d-cd54v dustise/flaskapp,docker.io/istio/proxyv2:1.1.16 flaskapp-v2-89866b97c-4zsqf dustise/flaskapp,docker.io/istio/proxyv2:1.1.16 sleep-6c9b45d956-5hjl6 dustise/sleep,docker.io/istio/proxyv2:1.1.16","title":"3-1 \u4e00\u4e2a\u7b80\u5355\u7684Python\u811a\u672c\u4f5c\u4e3a\u670d\u52a1\u7aef"},{"location":"chap5/3Istro_ServiceM_Prac/#3-2-istioctl-kube-inject-h","text":"kube-inject manually injects the Envoy sidecar into Kubernetes workloads. Usage: istioctl kube-inject [flags] Examples: # Update resources on the fly before applying. kubectl apply -f <(istioctl kube-inject -f <resource.yaml>) # Create a persistent version of the deployment with Envoy sidecar injected. istioctl kube-inject -f deployment.yaml -o deployment-injected.yaml # Update an existing deployment. kubectl get deployment -o yaml | istioctl kube-inject -f - | kubectl apply -f - # Create a persistent version of the deployment with Envoy sidecar # injected configuration from Kubernetes configmap 'istio-inject' istioctl kube-inject -f deployment.yaml -o deployment-injected.yaml --injectConfigMapName istio-inject","title":"3-2 istioctl kube-inject -h"},{"location":"chap5/3Istro_ServiceM_Prac/#4","text":"\u5ba2\u6237\u7aef\u670d\u52a1\u5f88\u7b80\u5355\u53ea\u662f\u4f7f\u7528\u4e86\u4e00\u4e2a\u5df2\u5b89\u88c5\u597d\u5404\u79cd\u6d4b\u8bd5\u5de5\u5177\u7684\u955c\u50cf\uff0c\u5177\u4f53\u7684\u6d4b\u8bd5\u53ef\u4ee5\u5728\u5176\u5185\u90e8\u7684 Shell \u4e2d\u5b8c\u6210\u3002\u540c\u6837\uff0c\u7f16\u5199\u4e00\u4e2a\u3001 YAML \u6587\u4ef6\u5c06\u5176\u547d\u540d\u4e3a sleep.yaml apiVersion: v1 kind: Service metadata: name: sleep labels: app: sleep version: v1 spec: selector: app: sleep version: v1 ports: - name: ssh port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep spec: replicas: 1 template: metadata: labels: app: sleep version: v1 spec: containers: - name: sleep image: dustise/sleep imagePullPolicy: IfNotPresent \u8fd9\u4e2a\u5e94\u7528\u5e76\u6ca1\u6709\u63d0\u4f9b\u5bf9\u5916\u670d\u52a1\u7684\u80fd\u529b, \u6211\u4eec\u7ed9\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a Service \u3002\u65f6\u8c61\u8fd9\u540c\u6837\u662fIstio\u7684\u6ce8\u4eba\u8981\u6c42\uff1a","title":"4.\u90e8\u7f72\u5ba2\u6237\u7aef\u670d\u52a1"},{"location":"chap5/3Istro_ServiceM_Prac/#4-1-servicedeploymentistio","text":"\u540c\u6837\u5bf9\u8be5\u6587\u4ef6\u8fdb\u884c\u6ce8\u4eba\u5e76\u63d0\u4ea4\u5230 Kubernetes \u8fd0\u884c $ istioctl kube-inject -f sleep.yaml | kubectl apply -f - service/sleep created deployment.extensions/sleep created $ kubectl get pod NAME READY STATUS RESTARTS AGE flaskapp-v1-74cbbdbdf6-4mbb8 1/1 Running 0 12s flaskapp-v2-74cbbdbdf6-zp79g 1/1 Running 0 12s sleep-6c9b45d956-5hjl6 2/2 Running 0 4m31s \u53ef\u4ee5\u770b\u5230\uff0c sleep \u5e94\u7528\u7684 Pod \u5df2\u7ecf\u5f00\u59cb\u4e86","title":"4-1 \u6ca1\u6709Service\u7684Deployment\u662f\u65e0\u6cd5\u88abIstio\u53d1\u73b0\u4e95\u8fdb\u884c\u64cd\u4f5c\u7684"},{"location":"chap5/3Istro_ServiceM_Prac/#5","text":"\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 kubectl exec -it \u670d\u52a1\u7684\u5177\u4f53\u8868\u73b0\u3002 \u547d\u4ee4\u8fdb\u4eba\u5ba2\u6237\u7aef Pod \uff0c\u6765\u6d4b\u8bd5 flaskapp \u4f7f\u7528\u4e00\u4e2a\u7b80\u5355\u7684 for \u5faa\u73af\uff0c\u91cd\u590d\u83b7\u53d6 http://flaskapp/env/version \u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u8c03\u7528 flaskapp \u670d\u52a1\uff0c\u67e5\u770b\u5176\u8fd4\u56de\u7ed3\u679c\uff1a kubectl exec -it sleep-6c9b45d956-5hjl6 -c sleep bash # -c, --container='': Container name. If omitted, the first container in the pod will be chosen bash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done v2 v1 v2 v1 v2 v1 v1 v2 v1 v2 \u4ece\u4e0a\u9762\u7684\u8fd0\u884c\u7ed3\u679c\u4e2d\u53ef\u4ee5\u770b\u5230 \u8fd9\u5f88\u5bb9\u6613\u7406\u89e3\uff0c v2 \u548c v1 \u8fd9\u4e24\u79cd\u7ed3\u679c\u968f\u673a\u51fa\u73b0\uff0c\u5927\u7ea6\u5404\u5360\u4e00\u534a\u3002 \u56e0\u4e3a\u6211\u4eec\u7684 flaskapp \u670d\u52a1\u7684\u9009\u62e9\u5668\u88ab\u5b9a\u4e49\u4e3a\u53ea\u6839\u636e App \u6807\u7b7e\u8fdb\u884c\u9009\u62e9\uff0c\u4e24\u4e2a\u7248\u672c\u7684\u670d\u52a1 Pod \u6570\u91cf\u76f8\u540c\uff0c\u56e0\u6b64\u4f1a\u51fa\u73b0\u8f6e\u6d41\u8f93\u51fa\u7684\u6548\u679c\u3002","title":"5.\u9a8c\u8bc1\u670d\u52a1"},{"location":"chap5/3Istro_ServiceM_Prac/#6","text":"\u63a5\u4e0b\u6765\u4f7f\u7528 Istio \u6765\u7ba1\u7406\u8fd9\u4e24\u4e2a\u670d\u52a1\u7684\u6d41\u91cf \u9996\u5148\u521b\u5efa flaskapp \u5e94\u7528\u7684\u76ee\u6807\u89c4\u5219\uff0c\u8f93\u5165\u4e00\u4e0b\u5185\u5bb9\u5e76\u5c06\u5176\u4fdd\u5b58\u4e3a flask-detinationrule.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: flaskapp spec: host: flaskapp subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 \u53ef\u4ee5\u770b\u5230\u8be5\u6587\u4ef6\u8fd8\u662f\u5e38\u89c1\u7684 YAML \u683c\u5f0f,\u5b9e\u9645\u4e0a\u4e5f\u53ef\u4ee5\u4f7f\u7528 kubectl \u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c \u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u79f0\u4e3a flaskapp \u7684 DestinationRule ,\u5b83\u5229\u7528 Pod \u6807\u7b7e\u628a\u670d\u52a1\u5206\u6210\u4e24\u4e2a subset , \u5c06\u5199\u5206\u522b\u547d\u540d\u4e3a v1 \u548c v2 \u4e0b\u9762\u5c06 flask-detinationrule.yaml \u63d0\u4ea4\u5230\u96c6\u7fa4 $ kubectl apply -f flask-detinationrule.yaml destinationrule.networking.istio.io/flaskapp created $ kubectl get destinationrule NAME HOST AGE flaskapp flaskapp 4m52s \u63a5\u4e0b\u6765\u5c31\u9700\u8981\u4e3a flaskapp \u670d\u52a1\u521b\u5efa\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\u4e86, \u4e0d\u8bba\u662f\u5426\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u6d41\u91cf\u63a7\u5236, \u90fd\u5efa\u8bae\u4e3a\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u521b\u5efa\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\uff0c \u4ee5\u9632\u53d1\u751f\u610f\u6599\u4e4b\u5916\u7684\u8bbf\u95ee\u7ed3\u679c \u4fbf\u7528\u4e0b\u9762\u7684\u5185\u5bb9\u521b\u5efa\u6587\u672c\u6587\u4ef6 flask-default-vs-v2.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp-default-v2 spec: hosts: - flaskapp http: - route: - destination: host: flaskapp subset: v2 \u5728\u8be5\u6587\u672c\u6587\u4ef6\u4e2d\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a VirtualService \u5bf9\u8c61, \u5c06\u5176\u547d\u540d\u4e3a flaskapp-default-v2 , \u5b83\u8d1f\u8d23\u63a5\u7ba1 flaskapp \u8fd9\u4e00\u4e3b\u673a\u540d\u7684\u8bbf\u95ee,\u4f1a\u5c06\u6240\u6709\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230 DestinationRule \u5b9a\u4e49\u7684 v2 subset \u4e0a \u518d\u6b21\u6267\u884c kubectl \u5c06 VirtualService \u63d0\u4ea4\u5230\u96c6\u7fa4 kubectl apply -f flask-default-vs-v2.yaml virtualservice.networking.istio.io/flaskapp-default-v2 created $ kubectl get vs NAME GATEWAYS HOSTS AGE flaskapp-default-v2 [flaskapp] 48s \u5728\u521b\u5efa\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u518d\u6b21\u8fdb\u5165\u5ba2\u6237\u7aef\u7684Pod, \u770b\u770b\u65b0\u5b9a\u4e49\u7684\u6d41\u91cf\u89c4\u5219\u662f\u5426\u751f\u6548 $ kubectl exec -it sleep-85cfc95c7-tvlxq -c sleep bash bash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done v2 v2 v2 v2 v2 v2 v2 v2 v2 v2 \u53ef\u4ee5\u770b\u5230, \u9ed8\u8ba4\u7684\u8def\u7531\u5df1\u7ecf\u751f, \u73b0\u5728\u590d\u591a\u6b21\u8bbf\u95ee\uff0c \u8fd4\u56de\u7684\u5185\u5bb9\u6765\u81ea\u73af\u5883\u53d8\u91cf version \u88ab\u8bbe\u7f6e\u4e3a v2 \u7684\u7248\u672c.","title":"6.\u521b\u5efa\u76ee\u6807\u89c4\u5219\u548c\u9ed8\u8ba4\u8def\u7531"},{"location":"chap5/4Istio_Helm/","text":"\u7b2c\u56db\u8282 \u7528 Helm \u90e8\u7f72 Istio Istio \u662f\u7531\u591a\u4e2a\u7ec4\u4ef6\u6784\u6210\u7684\uff0c\u4e95\u4e14\u53ef\u4ee5\u901a\u8fc7 kubectl \u547d\u4ee4\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u8fdb\u884c\u90e8\u7f72\uff0c\u90e8\u7f72\u65f6\u4f1a\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u521b\u5efa\u5927\u91cf\u7684\u5bf9\u8c61\u3002 Istio \u4e0e Kubernetes \u8fdb\u884c\u4e86\u6df1\u5ea6\u96c6\u6210\uff0c\u6784\u6210 Istio \u7684\u5404\u4e2a\u7ec4\u4ef6\u90fd\u4ee5 Deployment \u7684\u5f62\u5f0f\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u8fd0\u884c\uff0c\u5e76\u4e14\u5176\u5728\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u6240\u9700\u7684\u914d\u7f6e\u6570\u636e\u4e5f\u9700\u8981\u4f9d\u8d56\u5404\u79cd CRD \u53ca ConfigMap \u3001 Secret \u7b49\u6765\u8fdb\u884c\u5b58\u50a8\u3002\u8fd9\u79cd\u5305\u542b\u590d\u6742\u4f9d\u8d56\u5173\u7cfb\u7684\u5e94\u7528\u90e8\u7f72 \u8fc7\u7a0b\uff0c\u9700\u8981\u7531\u529f\u80fd\u8db3\u591f\u5f3a\u5927\u7684\u6a21\u677f\u7cfb\u7edf\u63d0\u4f9b\u652f\u6301\uff0c\u56e0\u6b64 Istio \u5b98\u65b9\u63a8\u8350\u4f7f\u7528 Helm \u5bf9 Istio \u8fdb\u884c\u90e8\u7f72\u3002 \u672c\u7ae0\u5c06\u4f1a\u8f83\u4e3a\u8be6\u7ec6\u5730\u5bf9\u4e00 Istio \u7684 Helm Chart \u90e8\u7f72\u65b9\u5f0f\u8fdb\u884c\u8bb2\u89e3\u3002 1\u3001Istio Chart\u6982\u8ff0 Helm \u662f\u76ee\u524d Istio \u5b98\u65b9\u63a8\u8350\u7684\u5b89\u88c5\u65b9\u5f0f\u3002\u9664\u53bb\u5b89\u88c5\u540e\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5bf9\u8f93\u4eba\u503c\u8fdb\u884c\u4e00\u4e9b\u8c03\u6574\uff0c\u5b8c\u6210\u5bf9 Istio \u7684\u90e8\u5206\u914d\u7f6eT\u4f5c\u3002 Istio Chart \u662f\u4e00\u4e2a\u603b\u5206\u7ed3\u6784\uff0c\u5176\u5206\u7ea7\u7ed3\u6784\u548c\u8bbe\u8ba1\u7ed3\u6784\u662f\u4e00\u81f4\u7684. Istio \u4e2d Chart \u7684\u5206\u7ea7\u7ed3\u6784\u548c\u76ee\u5f55\u7ed3\u6784\u662f\u5bf9\u7b49\u7684\uff0c\u4e0b\u9762\u8fdb\u884c\u7b80\u8981\u8bf4\u660e\u3002 1-1 Chart.yaml \u8be5\u6587\u4ef6\u662f Chart \u7684\u57fa\u7840\u4fe1\u606f\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u7248\u672c\u53f7\u3001\u540d\u79f0\u3001\u5173\u952e\u5b57\u7b49\u5143\u6570\u636e\u4fe1\u606f\u3002 1-2 values\u4e00*.yaml \u5728 Istio \u7684\u53d1\u884c\u5305\u4e2d\u5305\u542b\u4e00\u7ec4 values \u6587\u4ef6\uff0c\u63d0\u4f9b Istio \u5728\u5404\u79cd\u573a\u666f\u4e0b\u7684\u5173\u952e\u914d\u7f6e\u8303\u672c\uff0c\u8fd9\u4e9b\u8303\u672c\u6587\u4ef6\u53ef\u4ee5\u4f5c\u4e3a Helm \u7684\u8f93\u5165\u6587\u4ef6\uff0c\u6765\u5bf9 Istio \u8fdb\u884c\u5178\u578b\u5b9a\u5236\u3002\u5bf9 Istio \u7684\u5b9a\u5236\u53ef\u4ee5\u4ece\u5bf9\u8fd9\u4e9b\u8f93\u4eba\u6587\u4ef6\u7684\u6539\u5199\u5f00\u59cb\uff0c\u5728\u6539\u5199\u5b8c\u6210\u540e\u4f7f\u7528 helm template \u547d\u4ee4\u751f\u6210\u6700\u7ec8\u7684\u90e8\u7f72\u6587\u4ef6\uff0c\u8fd9\u6837\u5c31\u80fd\u7528 kubectl \u5b8c\u6210\u90e8\u7f72\u4e86\u3002 \u4e0b\u9762\u5217\u4e3e\u8fd9\u4e9b\u5178\u578b\u8f93\u4eba\u6587\u4ef6\u7684\u4f5c\u7528\u3002 values_istio_auth-galley.yaml \uff1a\u542f\u7528\u63a7\u5236\u9762 mTLS ,\u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 mTLS , \u542f\u7528 Galley values-istio-multicluster.yaml \uff1a\u591a\u96c6\u7fa4\u914d\u7f6e\u3002 values-istio-auth-multicluster.yaml \uff1a\u591a\u96c6\u7fa4\u914d\u7f6e\uff0c\u542f\u7528\u63a7\u5236\u9762 mTLS \uff0c\u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 mTLS \u7981\u7528\u81ea\u7b7e\u7f72\u8bc1\u4e66 \u3002 values-isito-demo-auth.yml : \u542f\u7528\u63a7\u5236\u9762 mTLS \u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 mTLs values-istio-auth.yaml : \u542f\u7528\u63a7\u5236\u9762 mTLS \u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 Grafana , Jaeger ServiceGraph \u53ca Galley ,\u5141\u8bb8\u81ea\u52a8\u6ce8\u5165 values-istio-galley.yaml : \u542f\u7528 Galley \u548c Prometheus values-istio-gateways.yaml : \u8fd9\u662f\u4e00\u4e2a\u6837\u4f8b\u53ef\u4ee5\u7528\u8fd9\u79cd\u5f62\u5f0f\u5b9a\u4e49\u65b0\u7684 Gateway \u3002 values-istio-one-namespace.yaml : \u5355\u547d\u540d\u7a7a\u95f4\u90e8\u7f72, \u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 mTLS values-istio-one-namespace-auth.yaml : \u5355\u547d\u540d\u7a7a\u95f4\u90e8\u7f72\uff0c \u542f\u7528\u63a7\u5236\u9762 mTLS values.yaml : \u7f57\u5217\u4e86\u7edd\u5927\u591a\u6570\u5e38\u7528\u53d8\u91cf\uff0c\u4e5f\u662f\u6211\u4eec\u505a\u5b9a\u5236\u7684\u57fa\u7840 1-3 requirements.yaml \u8be5\u6587\u4ef6\u7528\u4e8e\u7ba1\u7406\u5bf9\u5b50 Chart \u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u5176\u4e2d\u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217\u5f00\u5173\u53d8\u91cf\u3002 \u5728 Helm \u7684\u8f93\u4eba\u5185\u5bb9\u4e2d\u5bf9\u76f8\u5173\u53d8\u91cf\u8fdb\u884c\u5b9a\u4e49\uff0c\u5c31\u53ef\u4ee5\u5bf9 Istio \u7684\u90e8\u7f72\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\uff0c\u6765\u63a7\u5236\u5bf9\u5e94\u7ec4\u4ef6\u7684\u542f\u7528\u72b6\u6001\u3002\u4f8b\u5982\uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5bf9 Grafana \u7684\u63a7\u5236\u4ee3\u7801\uff1a - name: grafana version: 1.0.3 condition:grafana.enabled \u8fd9\u6bb5\u63a7\u5236\u4ee3\u7801\u4ee3\u8868\uff1a\u5982\u679c\u4fee\u6539\u5168\u5c40\u53d8\u91cf grafana.enabled \u4e3a False ,\u5c31\u4e0d\u4f1a\u5b89\u88c5 Grafana \u4e86\u3002 1-4 template/_affinity.tpl \u8be5\u6587\u4ef6\u4f1a\u751f\u6210\u4e00\u7ec4\u8282\u70b9\u4eb2\u548c\u6216\u4e92\u65a5\u5143\u7d20\uff0c\u4f9b\u5404\u4e2a\u7ec4\u4ef6\u5728\u6e32\u67d3YAML\u65f6\u4f7f\u7528\u8be5\u6587\u4ef6\u91cc\u4f7f\u7528\u4e86\u4e00\u7cfb\u5217\u53d8\u91cf\uff0c\u7528\u4e8e\u63a7\u5236 Istio \u7ec4\u4ef6\u7684\u8282\u70b9\u4eb2\u548c\u6027 \uff08\u4e5f\u5c31\u662f\u9650\u5236\u5728\u90e8\u7f72\u65f6\u5bf9\u8282\u70b9\u7684\u9009\u62e9\u3002 \u5728\u6a21\u677f\u4e2d\u5f15\u7528\u4e86\u5168\u5c40\u53d8\u91cf arch \uff0c\u9ed8\u8ba4\u5185\u5bb9\u662f\uff1a arch: amd64:2 s390x:2 ppc64le:2 \u8fd9\u91cc\u5b9a\u4e49\u5982\u4e0b\u4e24\u4e2a\u5c40\u90e8\u6a21\u677f\uff1a nodeAffinityRequiredDuringScheduling \uff1a\u4f1a\u6839\u636e\u5168\u5c40\u53d8\u91cf\u4e2d\u7684 arch \u53c2\u6570\u5bf9\u90e8\u7f72\u8282\u70b9\u8fdb\u884c\u9650\u5236\u3002 Istio \u7ec4\u4ef6\u7684 Pod \u4f1a\u6839\u636e arch \u53c2\u6570\u4e2d\u7684\u670d\u52a1\u5668\u7c7b\u578b\u5217\u8868\u6765\u51b3\u5b9a\u662f\u5426\u90e8\u7f72\u5230\u67d0\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\uff0c\u5e76\u6839\u636e\u5404\u79cd\u670d\u52a1\u5668\u7c7b\u578b\u7684\u4e0d\u540c\u6743\u91cd\u6765\u51b3\u5b9a\u4f18\u5148\u7ea7\u3002 nodeAffinityPreferredDuringScheduling \uff1a\u8ddf\u4e0a\u4e00\u4e2a\u53d8\u91cf\u7684\u4f5c\u7528\u7c7b\u4f3c\uff0c\u4e0d\u540c\u7684\u662f\uff0c\u8fd9\u4e00\u4e2a\u8f6f\u9650\u5236\u3002 \u63a5\u4e0b\u6765\u4f1a\u4f7f\u7528\u5728\u4e0a\u9762\u5b9a\u4e49\u7684\u4e24\u4e2a\u6a21\u677f\u751f\u6210\u65b0\u6a21\u677f\uff0c\u5c06\u5176\u547d\u540d\u4e3a nodeaffinity \uff0c\u5e76\u63d0\u4f9b\u7ed9\u5176\u4ed6\u7ec4\u4ef6\u5f15\u7528\uff0c\u7528\u4e8e\u751f\u6210\u5404\u4e2a\u7ec4\u4ef6 Deployment \u5bf9\u8c61\u7684\u8282\u70b9\u4eb2\u548c\u6027\u9650\u5236\u3002 1-5 templates/sidecar-injector-configmap.yaml \u6839\u636e\u6587\u4ef6\u540d\u5c31\u53ef\u4ee5\u5224\u65ad\u51fa\u6765\uff0c\u8be5\u6587\u4ef6\u6700\u7ec8\u4f1a\u7528\u4e8e\u751f\u6210\u4e00\u4e2a ConfigMap \u5bf9\u8c61\uff0c\u5728\u8be5\u5bf9\u8c61\u4e2d\u4fdd\u5b58\u7684\u914d\u7f6e\u6570\u636e\u88ab\u7528\u4e8e\u8fdb\u884c Sidecar \u6ce8\u5165\u3002 istioctl \u5b8c\u6210\u7684\u624b\u5de5\u6ce8\u4eba\uff0c\u6216\u8005 Istioctl \u7684\u81ea\u52a8\u6ce8\u4eba\uff0c\u90fd\u4f1a\u5f15\u7528\u8fd9\u4e2a ConfigMap \uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u5982\u679c\u5e0c\u671b\u4fee\u6539 Istio \u7684 Sidecar \u7684\u6ce8\u4eba\u8fc7\u7a0b\u53ca\u5177\u4f53\u884c\u4e3a\uff0c\u5c31\u53ef\u4ee5\u4ece\u8be5\u6587\u4ef6\u6216\u8005\u5bf9\u5e94\u7684 ConfigMap \u4eba\u624b\u4e86\u3002 1-6 templates/configmap.yaml \u8be5\u6587\u4ef6\u4e5f\u4f1a\u751f\u6210\u4e00\u4e2a ConfigMap \uff0c\u540d\u79f0\u4e3a istio \uff0c\u8fd9\u4e2a\u5bf9\u8c61\u7528\u4e8e\u4e3a Pilot \u63d0\u4f9b\u542f\u52a8\u914d\u7f6e\u6570\u636e\u3002 1-7 templates/crds.yaml \u8be5\u6587\u4ef6\u5305\u542b\u4e86 Istio \u6240\u9700\u7684 CRD \u5b9a\u4e49\uff0c\u5b83\u7684\u90e8\u7f72\u65b9\u5f0f\u8f83\u4e3a\u7279\u6b8a\uff1a \u5982\u679c\u4f7f\u7528 Helm 2.10 \u4e4b\u524d\u7684\u7248\u672c\u8fdb\u884c\u5b89\u88c5\uff0c\u5219\u9700\u8981\u5148\u4f7f\u7528 kubectl \u63d0\u4ea4\u8be5\u6587\u4ef6\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff1b \u5982\u679c\u4f7f\u7528 Helm 2.10 \u4e4b\u540e\u7684\u7248\u672c\uff0c\u5219\u5176\u4e2d\u7684 Helm hook \u4f1a\u81ea\u52a8\u63d0\u524d\u5b89\u88c5\uff0c\u65e0\u987b\u7279\u522b\u6ce8\u610f\u3002 1-8 charts \u8fd9\u4e2a\u76ee\u5f55\u4e2d\u7684\u5b50\u76ee\u5f55\u5c31\u662f Istio \u7684\u7ec4\u4ef6\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 certrnanager \uff1a\u4e00\u4e2a\u57fa\u4e8e Jetstack Cert-Manager \u9879\u76ee\u7684 ACME \u8bc1\u4e66\u5ba2\u6237\u7aef\uff0c\u7528\u4e8e\u81ea\u52a8\u8fdb\u884c\u8bc1\u4e66\u7684\u7533\u8bf7\u3001\u83b7\u53d6\u53ca\u5206\u53d1\u3002 galley : Istio \u5229\u7528 Galley \u8fdb\u884c\u914d\u7f6e\u7ba1\u7406\u5de5\u4f5c \u3002 gateways \uff1a \u5bf9 Gateways Chart \u8fdb\u884c\u914d\u7f6e\uff0c\u53ef\u4ee5\u5b89\u88c5\u591a\u4e2a Gateway Controller , grafana \uff1a\u56fe\u5f62\u5316\u7684 Istio Dashboard ingress \uff1a\u4e00\u4e2a\u9057\u7559\u8bbe\u8ba1\uff0c\u9ed8\u8ba4\u5173\u95ed\uff0c\u5728\u6d41\u91cf\u63a7\u5236\u534f\u8bae\u5347\u7ea7\u5230 network.istio.io/vlalpha3 \u4e4b\u540e\uff0c\u5df2\u7ecf\u5efa\u8bae\u5f03\u7528\u3002 kiali \uff1a \u5e26\u6709\u5206\u5e03\u5f0f\u8ddf\u8e2a\u3001\u914d\u7f6e\u6821\u9a8c\u7b49\u591a\u9879\u529f\u80fd\u7684 Dashboard \u3002 mixer : Istio \u7684\u7b56\u7565\u5b9e\u65bd\u7ec4\u4ef6\u3002 pilot : Istio \u7684\u6d41\u91cf\u7ba1\u7406\u7ec4\u4ef6\u3002 prometheus \uff1a \u76d1\u63a7\u8f6f\u4ef6 Prometheus ,\u5176\u4e2d\u5305\u542b Istio \u7279\u5b9a\u7684\u6307\u6807\u6293\u53d6\u8bbe\u7f6e\u3002 security : Citadel \u7ec4\u4ef6\uff0c\u7528\u4e8e\u8bc1\u4e66\u7684\u81ea\u52a8\u7ba1\u7406 servicegraph \uff1a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7ec4\u4ef6\uff0c\u7528\u4e8e\u83b7\u53d6\u548c\u5c55\u793a\u670d\u52a1\u8c03\u7528\u5173\u7cfb\u56fe\uff0c\u5373\u5c06\u5e9f\u9664 sidecarInjectorWebhook : \u81ea\u52a8\u6ce8\u4eba Webhook \u7684\u76f8\u5173\u914d\u7f6e\uff1b tracing \uff1a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7ec4\u4ef6\uff0c\u4f7f\u7528 Jaeger \u5b9e\u73b0\uff0c\u66ff\u4ee3\u539f\u6709\u7684 Service Graph \u7ec4\u4ef6\u3002 2\u3001 charts \u5168\u5c40\u53d8\u91cf\u4ecb\u7ecd \u6211\u4eec\u5728\u4f7f\u7528\u73b0\u6709 Chart \u7684\u65f6\u5019\uff0c\u901a\u5e38\u90fd\u4e0d\u4f1a\u4fee\u6539 Chart \u7684\u672c\u4f53\uff0c\u4ec5\u901a\u8fc7\u5bf9\u53d8\u91cf\u7684\u63a7\u5236\u6765\u5b9e\u73b0\u5bf9\u90e8\u7f72\u8fc7\u7a0b\u7684\u5b9a\u5236\u3002 Istio Helm Chart \u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u53d8\u91cf\u6765\u5e2e\u52a9\u7528\u6237\u5bf9 Istio \u7684\u5b89\u88c5\u8fdb\u884c\u5b9a\u5236\u3002 Istio Chart \u5206\u4e3a\u7236\u5b50\u4e24\u5c42\uff0c\u56e0\u6b64\u53d8\u91cf\u4e5f\u5177\u6709\u5168\u5c40\u548c\u672c\u5730\u4e24\u7ea7\u3002 \u5168\u5c40\u53d8\u91cf\u4f7f\u7528\u4fdd\u7559\u5b57 global \u8fdb\u884c\u5b9a\u4e49\uff0c\u5b50 Chart \u53ef\u4ee5\u901a\u8fc7 Values.global \u7684\u65b9\u5f0f\u5f15\u7528\u5168\u5c40\u53d8\u91cf\uff0c\u800c\u5728\u4e3b Chart \u4e2d\u4e5f\u53ef\u4ee5\u7528 chart.var \u7684\u65b9\u5f0f\u4e3a\u5b50 Chart \u6307\u5b9a\u53d8\u91cf\u503c\u3002 2-1 hub \u548c tag \u5728\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e24\u4e2a\u53d8\u91cf\u4ee3\u8868\u6240\u6709\u955c\u50cf\u7684\u5730\u5740\uff0c\u5177\u4f53\u540d\u79f0\u4e00\u822c\u4ee5 \uff5b{ .Values. global.hub}}/[component]/:{{ .Values.global.tag }\uff5d \u7684\u5f62\u5f0f\u62fc\u63a5\u800c\u6210\u3002 \u5728 proxy_init \u3001 Mixer \u3001 Grafana \u548c Pilot \u7684 Deployment \u6a21\u677f\u4e2d, \u4e00\u65e6\u5728\u5176 image \u53d8\u91cf\u4e2d \u5305\u542b\u8def\u5f84\u7b26 \u201c/\" ,\u5219\u4f1a\u5f03\u7528 global.hub \uff0c\u76f4\u63a5\u91c7\u7528 image \u7684\u5b9a\u4e49\uff0c \u4ee3\u7801\u5982\u4e0b\uff1a {{- if contains \"/\" .Values.image }} image: \"{{ .Values.image }}\" {{- else }} image: \"{{ $.Values.global.hub }}/{{ $.Values.image }}:{{ $.Values.global.tag }}\" {{- end }} \u8fd9\u4e24\u4e2a\u53d8\u91cf\u5bf9\u4e8e\u5185\u7f51\u90e8\u7f72\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\uff0c\u5c06 istio \u7684\u955c\u50cf\u62c9\u53d6\u56de\u6765\uff0c\u4e95\u63a8\u9001\u81f3\u79c1\u5e93\u4e4b\u540e\uff0e\u53ea\u8981\u5728 Values.yaml \u4e2d\u8fdb\u884c\u4fee\u6539\u3001\u5c31\u53ef\u4ee5\u5c06 Istio \u6240\u9700\u955c\u50cf\u7684\u5f15\u7528\u6307\u5411\u5185\u7f51\u79c1\u5e93\uff0e\u7701\u53bb\u4e86\u9010\u4e2a\u4fee\u6539 Deployment \u6587\u6863\u7684\u9ebb\u70e6 2-2 ingress.enabled \u8fd9\u4e2a\u5f00\u5173\u7528\u6765\u63a7\u5236\u662f\u5426\u542f\u7528 Istio \u7684 Ingress Controller . \u5982\u679c\u8fd9\u4e2a\u503c\u88ab\u8bbe\u7f6e\u4e3a True \u5c31\u4f1a\u542f\u7528\u65f6 Kubernetes Ingress \u8d44\u6e90\u7684\u652f\u6301\uff0c\u8fd9\u662f\u4e00\u4e2a\u517c\u5bb9\u7684\u529f\u80fd 2-3 Istio \u5e76\u4e0d\u63a8\u8350 ingress \u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u5efa\u8bae\u4f7f\u7528 Ingress Gateway , \u53d6\u800c\u4ee3\u4e4b \u6709\u4e24\u4e2a\u53d8\u91cf\u4f1a\u53d7\u5230\u8fd9\u4e2a\u5f00\u5173\u7684\u5f71\u554a\uff0c\u8fd9\u4e24\u4e2a\u53d8\u91cf\u5206\u522b\u662f k8sIngressSelector \u548c k8sIngressHttps \u53ea\u6709\u5728 ingress.enabled \u88ab\u8bbe\u7f6e\u4e3a True \u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e24\u4e2a\u53d8\u91cf\u7684\u76f8\u5173\u5185\u5bb9\u624d\u4f1a\u751f\u6548 \u3002 k8sIngresSelector \u4f1a\u5229\u7528 Pod \u6807\u7b7e\u9009\u62e9\u4e00\u4e2a Gateway \uff0c\u4f5c\u4e3a Ingress Controller \u5982\u679c\u5c06 k8sIngressHttps \u53d8\u91cf\u8d4b\u503c\u4e3a True \uff0c\u5c31\u4f1a\u5728 istio-autogenerated-k8s-in gress \u8fd9\u4e2a Gateway \u5b9a\u4e49\u4e2d\u52a0\u5165 443 \u7aef\u53e3\u53ca\u5176 TLS \u914d\u7f6e. k8sIngressHttps \u7684\u76f8\u5173\u5f15\u7528\u5bf9 Ingress Gateway Pod \u7684 /etc/istio/ingress/certs\uff0f \u4e0b\u7684\u8bc1\u4e66\u6587\u4ef6\u6709\u4f9d\u8d56\uff0e \u56e0\u6b64\u9700\u8981\u542f\u7528\u8fd9\u4e00\u9009\u9879\uff1a\u9700\u8981\u628a ingress.enabled \u8bbe\u7f6e\u4e3a true \u3002 \u4ece\u800c\u6210\u529f\u521b\u5efa ingress Chart \u7684 Deployment \uff1b \u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u88ab\u547d\u540d\u4e3a Ingress-certs \u7684 tls secret \u7ed9 istio-ingress Deployment \u8fdb\u884c\u52a0\u8f7d\u3002\u5982\u679c\u6ca1\u6709\u6ee1\u8db3\u8fd9\u4e9b\u6761\u4ef6\uff0c LDS \u5c31\u4f1a\u62d2\u7edd\u670d\u52a1\uff0c\u4ece\u800c\u65e0\u6cd5\u63d0\u4f9b Ingress \u529f\u80fd. 2-4 Proxy\u76f8\u5173\u53c2\u6570 \u5728 values.yaml \u4e2d\u5b9a\u4e49\u4e00\u7ec4 Proxy \u53d8\u91cf, \u7528\u4e8e\u5bf9 Sidecar \u8fdb\u884c\u63a7\u5236\u3002 1. proxy.resources \u7528\u4e8e\u4e3a Sidecar \u5206\u914d\u8d44\u6e90\u3002\u7528\u6237\u53ef\u4ee5\u6839\u636e\u4e1a\u52a1Pod\u7684\u8d1f\u8f7d\u60c5\u51b5, \u4e3a Sidecar \u6307\u5b9a CPU \u548c\u5185\u5b58\u8d44\u6e90\u3002 2. proxy.concurrency Proxy worker \u6570\u91cf\u8fdb\u884c\u5206\u914d\u3002\u5982\u679c\u88ab\u8bbe\u7f6e\u4e3a0\uff08\u9ed8\u8ba4\u503c\uff09\uff0c\u5219\u6839\u636e CPU \u7ebf\u7a0b\u6216\u6838\u7684\u6570\u91cf\u8fdb\u884c\u5206\u914d\u3002 3. Proxy.accessLogFi1e Sidecar \u7684\u8bbf\u95ee\u65e5\u5fd7\u4f4d\u7f6e\u3002 \u5982\u679c\u88ab\u8bbe\u7f6e\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u5219\u5173\u95ed\u8bbf\u95ee\u65e5\u5fd7\u529f\u80fd\u3002\u9ed8\u8ba4\u503c\u4e3a /dev/stdout \u3002 4. proxy.privileged istio-init \u3001 istio-proxy \u7684\u7279\u6743\u6a21\u5f0f\u5f00\u5173\u3002\u9ed8\u8ba4\u503c\u4e3a false \u3002 5. Proxy.enableCoreDump \u5982\u679c\u6253\u5f00, \u5219\u65b0\u6ce8\u4eba\u7684 Sidecar \u4f1a\u542f\u52a8 CoreDump \u529f\u80fd\uff0c \u5728 Pod \u4e2d\u52a0\u4eba\u521d\u59cb\u5316\u5bb9\u5668 enable-core-dump \u9ed8\u8ba4\u503c\u4e3a false 6. proxy.includeIPRanges \u52ab\u6301 IP \u8303\u56f4\u7684\u767d\u540d\u5355\u3002\u9ed8\u8ba4\u503c\u4e3a \u201c*\" \uff0c\u4e5f\u5c31\u662f\u52ab\u6301\u6240\u6709\u5730\u5740\u7684\u6d41\u91cf\u3002 \u5728 sidecar-injector-configmap.yaml \u4e2d\u5e94\u7528\u4e86\u8fd9\u4e00\u53d8\u91cf\uff0c\u7528\u4e8e\u751f\u6210 istio-sidecar-injector \u8fd9\u4e2a ConfigMap \uff0c\u8fd9\u4e2a ConfigMap \u8bbe\u7f6e\u4e86 istio-init \u7684\u8fd0\u884c\u53c2\u6570\uff0c\u901a\u8fc7\u5bf9 istio-init \u7684 \"-i\u201d \u53c2\u6570\u8fdb\u884c\u4fee\u6539\u6765\u5b8c\u6210\u8fd9\u4e00\u4efb\u52a1\u3002 7. Proxy.excludeIPRanges \u52ab\u6301 IP \u8303\u56f4\u7684\u9ed1\u540d\u5355\u3002\u9ed8\u8ba4\u503c\u4e3a\u7a7a\u5b57\u7b26\u4e32, \u4e5f\u5c31\u52ab\u6301\u8303\u56f4\u4ee5\u5916\u7684IP\u3002\u540c proxy.includeIPRanges \u7684\u60c5\u51b5\u7c7b\u4f3c\u3002\u5b83\u5f71\u54cd\u7684\u662f istio-init \u7684 -x \u53c2\u6570 8. Proxy.includeInboundPorts \u5165\u7ad9\u6d41\u91cf\u7684\u7aef\u53e3\u52ab\u6301\u767d\u540d\u5355\u3002\u6240\u6709\u4ece\u8303\u56f4\u5185\u7684\u7aef\u53e3\u8fdb\u5165Pod\u7684\u6d41\u91cf\u90fd\u4f1a\u88ab\u52ab\u6301\u3002\u5b83\u5f71\u54cd\u7684\u662f istio-init \u7684 \"-b\" \u53c2\u6570 9. proxy.excludeInboundports \u5165\u7ad9\u6d41\u91cf\u7684\u7aef\u53e3\u52ab\u6301\u9ed1\u540d\u5355\u3002\u8fd9\u4e00\u7aef\u53e3\u8303\u56f4\u4e4b\u5916\u7684\u5165\u7ad9\u6d41\u91cf\u624d\u4f1a\u88ab\u52ab\u6301\u3002 \u5b83\u5f71\u54cd\u7684\u662f Istio-init \u7684 \u201c-d\u201d \u53c2\u6570\u3002 10. proxy.autoInject \u7528\u4e8e\u63a7\u5236\u662f\u5426\u81ea\u52a8\u5b8c\u6210 Sidecar \u7684\u6ce8\u5165\u5de5\u4f5c\u3002 11. proxy.envoyStatsd \u8be5\u53d8\u91cf\u7684\u9ed8\u8ba4\u503c\u5982\u4e0b\u3002 enabled:true host:istio-statsd-prom-bridge port:9125 \u5b83\u4f1a\u8bbe\u7f6e Envoy \u7684 \u201c--statsdUdpAddress\u201d \u53c2\u6570\uff0c\u5728\u67d0\u4e9b\u53c2\u6570\u4e0b\uff08\u4f8b\u5982\u6ca1\u6709\u5b89\u88c5 Mixer \uff09\u53ef\u4ee5\u5173\u95ed\u3002 2-4 proxy_init.image \u7f51\u683c\u4e2d\u7684\u670d\u52a1 Pod \u5728\u542f\u52a8\u4e4b\u524d\uff0c\u9996\u5148\u4f1a\u8fd0\u884c\u4e00\u4e2a\u521d\u59cb\u5316\u955c\u50cf\u6765\u5b8c\u6210\u6d41\u91cf\u52ab\u6301\u5de5\u4f5c\uff0c\u8fd9\u4e2a\u53d8\u91cf\u53ef\u4ee5\u7528\u4e8e\u6307\u5b9a\u521d\u59cb\u5316\u5bb9\u5668\u955c\u50cf\u3002 2-5 imagePullPolicy \u955c\u50cf\u7684\u62c9\u53d6\u7b56\u7565\u3002\u9ed8\u8ba4\u503c\u4e3a \u201cIfNotPresent\" . 2-6 controlPlaneSecurityEnabled \u6307\u5b9a\u662f\u5426\u5728 Istio \u63a7\u5236\u9762\u7ec4\u4ef6\u4e0a\u542f\u7528 mTLS \u901a\u4fe1\u3002 \u5728\u542f\u7528\u4e4b\u540e\uff0c Sidecar \u548c\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u4e4b\u95f4\uff0c\u4ee5\u53ca\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u4e4b\u95f4\u7684\u901a\u4fe1\uff0c\u90fd\u4f1a\u88ab\u6539\u4e3a mTLS \u65b9\u5f0f\u3002\u53d7\u5f71\u54cd\u7684\u7ec4\u4ef6\u5305\u62ec Ingress . Mixer , Pilot \u53ca Sidecar . 2-7 disablePolicyChecks \u5982\u679c\u628a\u8fd9\u4e2a\u5f00\u5173\u53d8\u91cf\u8bbe\u7f6e\u4e3a true \uff0c\u5219\u4f1a\u7981\u7528 Mixer \u7684\u9884\u68c0\u529f\u80fd\u3002\u9884\u68c0\u529f\u80fd\u662f\u4e00\u4e2a\u540c\u6b65\u8fc7\u7a0b\uff0c\u6709\u53ef\u80fd\u56e0\u4e3a\u9884\u68c0\u7f13\u6162\u9020\u6210\u4e1a\u52a1\u5e94\u7528\u7684\u963b\u585e\u3002 2-8 enableTracing \u662f\u5426\u542f\u7528\u5206\u5e03\u5f0f\u8ddf\u8e2a\u529f\u80fd\uff0c\u9ed8\u8ba4\u503c\u4e3a true 2-9 mtls.enabled \u6240\u6709\u670d\u52a1\u4e4b\u95ee\u7684\u901a\u4fe1\u90fd\u4f1a\u4f7f\u7528 mTLS \u8fdb\u884c\u5b89\u5168\u52a0\u56fa\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u4e00\u53d8\u91cf\u7684\u8bbe\u7f6e\u662f\u5168\u5c40\u7684\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u670d\u52a1\u8fd8\u4ee5\u5355\u72ec\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6216\u8005\u670d\u52a1\u6ce8\u89e3\u7684\u65b9\u5f0f\uff0c\u81ea\u884c\u8bc0\u5b9a\u662f\u5426\u91c7\u7528 mTLS \u52a0\u56fa 2-10 imagePullSecrets \u7528\u4e8e\u4e3a ServiceAccount \u5206\u914d\u5728\u955c\u50cf\u62c9\u53d6\u8fc7\u7a0b\u4e2d\u6240\u9700\u7684\u8ba4\u8bc1\u51ed\u636e\u3002\u9ed8\u8ba4\u503c\u4e3a\u7a7a\u503c 2-11 arch \u5728\u8bbe\u7f6e Istio \u7ec4\u4ef6\u7684\u8282\u70b9\u4eb2\u548c\u6027\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u4f7f\u7528\u8fd9\u4e00\u53d8\u91cf\u7684\u5217\u8868\u5185\u5bb9\u6765\u786e\u5b9a\u53ef\u4ee5\u7528\u4e8e\u90e8\u7f72\u7684\u8282\u70b9\u8303\u56f4\uff0c\u5e76\u6309\u7167\u4e0d\u540c\u7684\u670d\u52a1\u5668\u67b6\u6784\u8bbe\u7f6e\u4e86\u4f18\u5148\u987a\u5e8f\u3002\u5b83\u7684\u9ed8\u8ba4\u5217\u8868\u5185\u5bb9\u5982\u4e0b\uff1a amd64:2 s390x:2 ppc64le:2 2-12 oneNamespace \u9ed8\u8ba4\u503c\u4e3a false , Pilot \u4f1a\u76d1\u63a7\u6240\u6709\u547d\u540d\u7a7a\u95f4\u5185\u7684\u670d\u52a1\u53d8\u5316\u5982\u679c\u8fd9\u4e2a\u53d8\u91cf\u88ab\u8bbe\u7f6e\u4e3a true \uff0c\u5219\u4f1a\u5728 Pilot \u7684\u670d\u52a1\u53d1\u73b0\u53c2\u6570\u4e2d\u52a0\u5165 \"-a\" , \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c Pilot \u53ea\u4f1a\u5bf9 Istio \u7ec4\u4ef6\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u8fdb\u884c\u76d1\u63a7\u3002 2-13 configValidation \u7528\u4e8e\u914d\u7f6e\u662f\u5426\u5f00\u542f\u670d\u52a1\u7aef\u7684\u914d\u7f6e\u9a8c\u8bc1\u3002\u9ed8\u8ba4\u503c\u4e3a true . \u8be5\u9009\u9879\u5728\u5f00\u542f\u4e4b\u540e\uff0c \u4f1a\u751f\u6210\u4e00\u4e2a ValidatingWebhook Configuration \u5bf9\u8c61\uff0c\u5e76\u88ab\u5305\u542b\u5230 Galley \u7684\u914d\u7f6e\u4e2d\uff0c\u4ece\u800c\u542f\u7528\u6821\u9a8c\u529f\u80fd\u3002 2-14 meshExpansion \u8981\u5c06\u670d\u52a1\u7f51\u683c\u6269\u5c55\u5230\u7269\u7406\u673a\u6216\u8005\u865a\u62df\u673a\u4e0a\uff0c\u5c31\u4f1a\u4f7f\u7528\u5230\u8fd9\u4e00\u53d8\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a false \u5982\u679c\u88ab\u8bbe\u7f6e\u4e3a true \uff0c\u5219\u4f1a\u5728 Ingress Gateway \u4e0a\u516c\u5f00 Pilot \u548c Citadel \u7684\u670d\u52a1\u3002 2-15 meshExpansionILB \u662f\u5426\u5728\u5185\u90e8\u7f51\u5173\u4e2d\u516c\u5f00 Pilot \u548c Citadel \u7684\u7aef\u53e3\u3002 \u9ed8\u8ba4\u503c\u4e3a false \uff0c\u4ec5\u5728\u670d\u52a1\u7f51\u683c\u6269\u5c55\u65f6\u4f1a\u4f7f\u7528\u5230\u8fd9\u4e00\u53d8\u91cf\u3002 2-16 defaultResources \u4e3a\u6240\u6709 Istio \u7ec4\u4ef6\u90fd\u63d0\u4f9b\u4e00\u4e2a\u6700\u5c0f\u8d44\u6e90\u9650\u5236\u3002\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53ea\u8bbe\u7f6e\u4e00\u4e2a\u8bf7\u6c42 10m Cpu \u8d44\u6e90\u7684\u503c\u3002\u53ef\u4ee5\u5728\u5404\u4e2a Chart \u7684\u5c40\u90e8\u53d8\u91cf\u4e2d\u5206\u522b\u8bbe\u7f6e\u8d44\u6e90\u9700\u6c42\u3002 2-17 hyperkube \u5728 Istio \u7684\u8bbe\u7f6e\u8fc7\u7a0b\u4f1a\u4f7f\u7528\u4e00\u4e2a\u955c\u50cf\u6267\u884c\u4e00\u4e9b Job \uff0c\u4f8b\u5982\u5728\u65e9\u671f\u7248\u672c\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u7684 CRD \u521d\u59cb\u5316\uff0c\u6216\u8005\u73b0\u5728\u7684\u6e05\u7406\u8fc7\u671f\u8bc1\u4e66\u7b49\u4efb\u52a1\u3002\u8fd9\u4e2a\u955c\u50cf\u9ed8\u8ba4\u4f7f\u7528\u7684\u662f quay.io/coreos:v1.7.6_coreos.0 \uff0c\u5728\u5185\u7f51\u4e2d\u540c\u6837\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u8986\u76d6\u3002 2-18 priorityClassName Kubernetes \u5728 1.11.0 \u4ee5\u4e0a\u7248\u672c\u4e2d\u63d0\u51fa\u4e86 PriorityClass \u7684\u6982\u5ff5\uff0c \u5177\u6709\u4f18\u5148\u7ea7\u7684 Pod \u4e0d\u4f1a\u88ab\u9a71\u9010\u6216\u62a2\u5360\u8d44\u6e90\u3002\u8be5\u53d8\u91cf\u7684\u9ed8\u8ba4\u503c\u4e3a\u7a7a\uff0c\u53ef\u9009\u503c\u5305\u62ec \u201csystem-cluster-critical\" \u548c \"system-node-critical\" \u3002 2-19 crds \u8be5\u53d8\u91cf\u7528\u4e8e\u51b3\u5b9a\u662f\u5426\u5305\u542b CRD \u5b9a\u4e49\u3002\u5982\u679c\u4f7f\u7528 helm templat e\u547d\u4ee4\uff0c\u6216\u8005\u662f 2.10 \u4ee5\u571f\u7248\u672c\u7684 helm install \u547d\u4ee4\uff0c\u5219\u5e94\u8be5\u5c06\u5176\u8bbe\u7f6e\u4e3a true ; \u5426\u5219\u5728\u5b89\u88c5\u4e4b\u524d\u9996\u5148\u8981\u6267\u884c kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml \uff0c\u5e76\u5c06\u8be5\u53d8\u91cf\u8bbe\u7f6e\u4e3a false \u3002 3\u3001Istio \u5b89\u88c5\u6e05\u5355\u7684\u751f\u6210\u548c\u90e8\u7f72 3-1 \u7f16\u8f91 values.yaml \u6211\u4eec\u9700\u8981\u5148\u6839\u636e\u5b9e\u9645\u9700\u6c42\u5bf9 Istio \u8fdb\u884c\u5b9a\u5236\uff0c values.yaml \u3002\u6700\u5e38\u89c1\u7684\u4fee\u6539\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\u3002 \u955c\u50cf\u5730\u5740 \u5982\u679c\u662f\u5185\u7f51\u90e8\u7f72\uff0c\u90a3\u4e48\u9700\u8981\u5148\u89e3\u51b3\u955c\u50cf\u5730\u5740\u95ee\u9898\u3002\u6211\u4eec\u901a\u5e38\u4f1a\u5728\u5177\u5907\u5916\u7f51\u8fde\u63a5\u6761\u4ef6\u7684\u670d\u52a1\u5668\u4e0a\u62c9\u53d6\u6240\u9700\u955c\u50cf\uff0c\u7136\u540e\u5bfc\u51fa\u955c\u50cf\uff0c\u5c06\u5176\u63a8\u9001\u5230\u672c\u5730\u79c1\u6709\u955c\u50cf\u5e93\u3002\u90a3\u4e48\uff0c \u5982\u4f55\u77e5\u9053\u6211\u4eec\u9700\u8981\u54ea\u4e9b\u955c\u50cf\uff1f \u6211\u4eec\u53ef\u4ee5 grep istio-demo.yaml $ cd Istio/istio-1.1.16/install/kubernetes $ grep -r image: istio-demo.yaml | egrep -o -e \"image:.*\" | sort | uniq image: \"docker.io/istio/citadel:1.1.16\" image: \"docker.io/istio/galley:1.1.16\" image: \"docker.io/istio/kubectl:1.1.16\" image: \"docker.io/istio/kubectl:1.1.16\" image: \"docker.io/istio/mixer:1.1.16\" image: \"docker.io/istio/pilot:1.1.16\" image: \"docker.io/istio/proxy_init:1.1.16\" image: \"docker.io/istio/proxyv2:1.1.16\" image: \"docker.io/istio/sidecar_injector:1.1.16\" image: \"docker.io/jaegertracing/all-in-one:1.9\" image: \"docker.io/kiali/kiali:v0.16\" image: \"docker.io/prom/prometheus:v2.3.1\" image: \"grafana/grafana:6.0.2\" image: [[ annotation .ObjectMeta `sidecar.istio.io/proxyImage` \"docker.io/istio/proxyv2:1.1.16\" ]] \u5728\u5f97\u5230\u8fd9\u4e9b\u955c\u50cf\u540d\u79f0\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u9010\u4e2a\u8fdb\u884c\u955c\u50cf\u7684\u62c9\u53d6\u548c\u63a8\u9001\u64cd\u4f5c\u4e86\u3002 \u63a5\u4e0b\u6765\u6839\u636e\u79c1\u5e93\u5730\u5740\uff0c\u4fee\u6539 values.yaml \u4e2d\u5404\u4e2a\u955c\u50cf\u7684\u5730\u5740\uff0c\u751f\u6210\u65b0\u7684\u5b89\u88c5\u6e05\u5355\u6587\u4ef6\uff0c\u7136\u540e\u91cd\u65b0\u7528\u4e0a\u8ff0\u547d\u4ee4\u8fdb\u884c\u68c0\u67e5\u5373\u53ef\u3002 3-2 \u7cfb\u7edf\u8d44\u6e90 Values.yaml \u4e2d\u7684\u7cfb\u7edf\u8d44\u6e90\u8bbe\u7f6e\u662f\u975e\u5e38\u4fdd\u5b88\u7684\uff0c\u5e76\u4e14\u4e0d\u591f\u5b8c\u6574\uff0c\u56e0\u6b64\u8fd9\u91cc\u5efa\u8bae\u6839\u636e\u5b9e\u9645\u968b\u51b5\u8c03\u6574\u5404\u4e2a\u7ec4\u4ef6\u7684\u8d44\u6e90\u5206\u914d\u3002 3-3 \u670d\u52a1\u7c7b\u578b Istio \u7684 Istio-ingressgateWay \u670d\u52a1\u7684\u9ed8\u8ba4\u7c7b\u578b\u662f Loadbalancer \uff0c\u5982\u679c\u5728\u8981\u90e8\u7f72\u7684 \u76ee\u6807 Kubernetes \u96c6\u7fa4\u4e2d\u6ca1\u6709\u8d1f\u8f7d\u5747\u8861\u652f\u6301\uff0c\u5c31\u9700\u8981\u5bf9\u670d\u52a1\u7c7b\u578b\u8fdb\u884c\u4fee\u6539\u4e86 3-4 \u53ef\u89c6\u5316\u7ec4\u4ef6\u7684\u670d\u52a1\u5f00\u653e \u5728 Istio \u4e2d\u5305\u542b\u4e86 Prometheus , Grafana \u53ca Kiali \u7b49\u53ef\u89c6\u5316\u7ec4\u4ef6\uff0c\u5728\u9ed8\u8ba4\u72b6\u6001\u4e0b\u90fd\u662f ClusterIP \u7c7b\u578b\u7684\uff0c\u8981\u987a\u5229\u4f7f\u7528\uff0c\u5219\u53ef\u80fd\u9700\u8981\u4e3a\u5176\u5206\u914d Ingress \u6216\u8005\u4fee\u6539\u670d\u52a1\u7c7b\u578b\u3002 4\u3001\u751f\u6210\u90e8\u7f72\u6e05\u5355 \u5728\u5b8c\u6210\u5bf9 values.yaml \u7684\u7f16\u8f91\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528 helm template \u547d\u4ee4\u6765\u751f\u6210\u6700\u7ec8\u7684 \\\u90e8\u7f72\u6e05\u5355\u6587\u4ef6\u4e86\uff0c\u4f8b\u5982\u6211\u4eec\u751f\u6210\u7684\u8f93\u4eba\u6587\u4ef6\u4e3a my-values.yaml \uff0c\u90a3\u4e48\u53ef\u4ee5\u7528\u5982\u4e0b\u547d\u4ee4\u751f\u6210\u6211\u4eec\u9700\u8981\u7684YAML\u6587\u4ef6\uff1a $ helm template install/kubernetes/helm/istio \\ --namespace istio\u4e00system \\ -f my-values.yaml>my-istio.yaml \u8fd9\u4e2a\u547d\u4ee4\u5047\u8bbe\u6211\u4eec\u7684\u5f53\u524d\u76ee\u5f55\u662f Istio \u53d1\u884c\u5305\u7684\u6839\u76ee\u5f55\uff0c\u5176\u4e2d\uff1a \"--name istio\u201d \u4ee3\u8868\u751f\u6210\u7684\u90e8\u7f72\u5185\u5bb9\u7684\u57fa\u7840\u540d\u79f0\u4e3a\u201cistio\"; \"--namespace istio-system\u201d \u4ee3\u8868\u5c06 Istlo \u90e8\u7f72\u5230\u547d\u540d\u7a7a\u95f4 \"istio-system\u201d\u4e2d\uff1b \"-f my-values.yaml\u201d \u4ee3\u8868\u4ece my-values.yaml \u6587\u4ef6\u4e2d\u83b7\u53d6\u8f93\u4eba\u7684\u5185\u5bb9\u3002 \u8be5\u547d\u4ee4\u5728\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\uff0c\u4f1a\u751f\u6210\u90e8\u7f72\u6e05\u5355\u6587\u4ef6 my-istio.yaml \uff0c\u53ef\u4ee5\u6253\u5f00\u8be5\u6587\u4ef6\uff0c\u68c0\u67e5\u5176\u4e2d\u7684\u5185\u5bb9\u662f\u5426\u7b26\u5408\u9884\u671f\u3002 5\u3001\u90e8\u7f72Istio \u5728\u90e8\u7f72\u6e05\u5355\u751f\u6210\u5e76\u68c0\u67e5\u5b8c\u6bd5\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5f00\u59cb\u90e8\u7f72\u4e86\u3002 \u6211\u4eec\u751f\u6210\u7684 my-istio.yaml \u662f\u8981\u6c42\u90e8\u7f72\u5230 istio-system \u547d\u540d\u7a7a\u95f4\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f7f\u7528 kubectl \u547d\u4ee4\u6765\u521b\u5efa\u5b83\uff1a $ kubectl create ns istio-system namespace/istio-system created kubectl apply -f my-istio.yaml configmap/istio-galley-configuration created configmap/istio-statsd-prom-bridge created configmap/prometheus created configmap/istio-security-custom-resources created \u7b49\u8fd0\u884c\u7ed3\u675f\u4e4b\u540e\uff0c\u540c\u6837\u53ef\u4ee5\u4f7f\u7528 \u201ckubecti get po -n istio-system -w\u201d \u547d\u4ee4\u6765\u67e5\u770b Pod \u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u76f4\u5230\u5168\u90e8 Pod \u6210\u529f\u8fdb\u4eba Running \u6216\u8005 Completed \u72b6\u6001\uff0c Istio \u7684\u5b89\u88c5\u90e8\u7f72\u5de5\u4f5c\u5c31\u5b8c\u6210\u4e86\u3002 6\u3001\u5c0f\u7ed3 Helm\u8fd8\u6709\u4e00\u79cd\u5e38\u89c1\u7684\u90e8\u7f72\u65b9\u5f0f\uff0c\u5c31\u662f\u901a\u8fc7 helm install \u547d\u4ee4\u8fdb\u884c\u90e8\u7f72\u3002\u4f46\u662f\uff0c\u91c7\u7528\u8fd9\u79cd\u90e8\u7f72\u65b9\u5f0f\u65f6\uff0c\u9700\u8981\u5728 Kubernetes \u4e2d\u90e8\u7f72 Tiller \uff1a\u670d\u52a1\u7aef\uff0c\u800c\u4e14\u4e0d\u4f1a\u751f\u6210\u90e8\u7f72\u6e05\u5355\u6587\u4ef6\uff0c \u8fd9\u5bf9\u4e8e\u914d\u7f6e\u7ba1\u7406\u6765\u8bf4\u662f\u5f88\u4e0d\u65b9\u4fbf\u7684\uff0c\u56e0\u6b64\u8fd9\u91cc\u4e0d\u505a\u63a8\u8350\u3002 \u53e6\u5916\uff0c\u5728 Helm \u7684 template \u6216\u8005 install \u547d\u4ee4\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 \u201c--set\u201d \u7684\u65b9\u5f0f\u6765\u8bbe\u7f6e \u53d8\u91cf\u503c\u3002\u8fd9\u91cc\u6ca1\u6709\u63d0\u53ca\u8fd9\u79cd\u65b9\u5f0f\uff0c\u539f\u56e0\u5f88\u7b80\u5355\uff1a Istio \u90e8\u7f72\u8fc7\u7a0b\u4e2d\u6d89\u53ca\u7684\u53d8\u91cf\u592a\u591a\uff0c\u547d\u4ee4\u884c\u65b9\u5f0f\u66f4\u663e\u7b28\u91cd\u3002","title":"\u7b2c\u56db\u8282 \u7528Helm\u90e8\u7f72Istio"},{"location":"chap5/4Istio_Helm/#helmistio","text":"Istio \u662f\u7531\u591a\u4e2a\u7ec4\u4ef6\u6784\u6210\u7684\uff0c\u4e95\u4e14\u53ef\u4ee5\u901a\u8fc7 kubectl \u547d\u4ee4\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u8fdb\u884c\u90e8\u7f72\uff0c\u90e8\u7f72\u65f6\u4f1a\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u521b\u5efa\u5927\u91cf\u7684\u5bf9\u8c61\u3002 Istio \u4e0e Kubernetes \u8fdb\u884c\u4e86\u6df1\u5ea6\u96c6\u6210\uff0c\u6784\u6210 Istio \u7684\u5404\u4e2a\u7ec4\u4ef6\u90fd\u4ee5 Deployment \u7684\u5f62\u5f0f\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u8fd0\u884c\uff0c\u5e76\u4e14\u5176\u5728\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u6240\u9700\u7684\u914d\u7f6e\u6570\u636e\u4e5f\u9700\u8981\u4f9d\u8d56\u5404\u79cd CRD \u53ca ConfigMap \u3001 Secret \u7b49\u6765\u8fdb\u884c\u5b58\u50a8\u3002\u8fd9\u79cd\u5305\u542b\u590d\u6742\u4f9d\u8d56\u5173\u7cfb\u7684\u5e94\u7528\u90e8\u7f72 \u8fc7\u7a0b\uff0c\u9700\u8981\u7531\u529f\u80fd\u8db3\u591f\u5f3a\u5927\u7684\u6a21\u677f\u7cfb\u7edf\u63d0\u4f9b\u652f\u6301\uff0c\u56e0\u6b64 Istio \u5b98\u65b9\u63a8\u8350\u4f7f\u7528 Helm \u5bf9 Istio \u8fdb\u884c\u90e8\u7f72\u3002 \u672c\u7ae0\u5c06\u4f1a\u8f83\u4e3a\u8be6\u7ec6\u5730\u5bf9\u4e00 Istio \u7684 Helm Chart \u90e8\u7f72\u65b9\u5f0f\u8fdb\u884c\u8bb2\u89e3\u3002","title":"\u7b2c\u56db\u8282 \u7528Helm\u90e8\u7f72Istio"},{"location":"chap5/4Istio_Helm/#1istio-chart","text":"Helm \u662f\u76ee\u524d Istio \u5b98\u65b9\u63a8\u8350\u7684\u5b89\u88c5\u65b9\u5f0f\u3002\u9664\u53bb\u5b89\u88c5\u540e\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5bf9\u8f93\u4eba\u503c\u8fdb\u884c\u4e00\u4e9b\u8c03\u6574\uff0c\u5b8c\u6210\u5bf9 Istio \u7684\u90e8\u5206\u914d\u7f6eT\u4f5c\u3002 Istio Chart \u662f\u4e00\u4e2a\u603b\u5206\u7ed3\u6784\uff0c\u5176\u5206\u7ea7\u7ed3\u6784\u548c\u8bbe\u8ba1\u7ed3\u6784\u662f\u4e00\u81f4\u7684. Istio \u4e2d Chart \u7684\u5206\u7ea7\u7ed3\u6784\u548c\u76ee\u5f55\u7ed3\u6784\u662f\u5bf9\u7b49\u7684\uff0c\u4e0b\u9762\u8fdb\u884c\u7b80\u8981\u8bf4\u660e\u3002","title":"1\u3001Istio Chart\u6982\u8ff0"},{"location":"chap5/4Istio_Helm/#1-1-chartyaml","text":"\u8be5\u6587\u4ef6\u662f Chart \u7684\u57fa\u7840\u4fe1\u606f\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u7248\u672c\u53f7\u3001\u540d\u79f0\u3001\u5173\u952e\u5b57\u7b49\u5143\u6570\u636e\u4fe1\u606f\u3002","title":"1-1 Chart.yaml"},{"location":"chap5/4Istio_Helm/#1-2-valuesyaml","text":"\u5728 Istio \u7684\u53d1\u884c\u5305\u4e2d\u5305\u542b\u4e00\u7ec4 values \u6587\u4ef6\uff0c\u63d0\u4f9b Istio \u5728\u5404\u79cd\u573a\u666f\u4e0b\u7684\u5173\u952e\u914d\u7f6e\u8303\u672c\uff0c\u8fd9\u4e9b\u8303\u672c\u6587\u4ef6\u53ef\u4ee5\u4f5c\u4e3a Helm \u7684\u8f93\u5165\u6587\u4ef6\uff0c\u6765\u5bf9 Istio \u8fdb\u884c\u5178\u578b\u5b9a\u5236\u3002\u5bf9 Istio \u7684\u5b9a\u5236\u53ef\u4ee5\u4ece\u5bf9\u8fd9\u4e9b\u8f93\u4eba\u6587\u4ef6\u7684\u6539\u5199\u5f00\u59cb\uff0c\u5728\u6539\u5199\u5b8c\u6210\u540e\u4f7f\u7528 helm template \u547d\u4ee4\u751f\u6210\u6700\u7ec8\u7684\u90e8\u7f72\u6587\u4ef6\uff0c\u8fd9\u6837\u5c31\u80fd\u7528 kubectl \u5b8c\u6210\u90e8\u7f72\u4e86\u3002 \u4e0b\u9762\u5217\u4e3e\u8fd9\u4e9b\u5178\u578b\u8f93\u4eba\u6587\u4ef6\u7684\u4f5c\u7528\u3002 values_istio_auth-galley.yaml \uff1a\u542f\u7528\u63a7\u5236\u9762 mTLS ,\u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 mTLS , \u542f\u7528 Galley values-istio-multicluster.yaml \uff1a\u591a\u96c6\u7fa4\u914d\u7f6e\u3002 values-istio-auth-multicluster.yaml \uff1a\u591a\u96c6\u7fa4\u914d\u7f6e\uff0c\u542f\u7528\u63a7\u5236\u9762 mTLS \uff0c\u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 mTLS \u7981\u7528\u81ea\u7b7e\u7f72\u8bc1\u4e66 \u3002 values-isito-demo-auth.yml : \u542f\u7528\u63a7\u5236\u9762 mTLS \u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 mTLs values-istio-auth.yaml : \u542f\u7528\u63a7\u5236\u9762 mTLS \u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 Grafana , Jaeger ServiceGraph \u53ca Galley ,\u5141\u8bb8\u81ea\u52a8\u6ce8\u5165 values-istio-galley.yaml : \u542f\u7528 Galley \u548c Prometheus values-istio-gateways.yaml : \u8fd9\u662f\u4e00\u4e2a\u6837\u4f8b\u53ef\u4ee5\u7528\u8fd9\u79cd\u5f62\u5f0f\u5b9a\u4e49\u65b0\u7684 Gateway \u3002 values-istio-one-namespace.yaml : \u5355\u547d\u540d\u7a7a\u95f4\u90e8\u7f72, \u9ed8\u8ba4\u6253\u5f00\u7f51\u683c\u5185\u90e8\u7684 mTLS values-istio-one-namespace-auth.yaml : \u5355\u547d\u540d\u7a7a\u95f4\u90e8\u7f72\uff0c \u542f\u7528\u63a7\u5236\u9762 mTLS values.yaml : \u7f57\u5217\u4e86\u7edd\u5927\u591a\u6570\u5e38\u7528\u53d8\u91cf\uff0c\u4e5f\u662f\u6211\u4eec\u505a\u5b9a\u5236\u7684\u57fa\u7840","title":"1-2 values\u4e00*.yaml"},{"location":"chap5/4Istio_Helm/#1-3-requirementsyaml","text":"\u8be5\u6587\u4ef6\u7528\u4e8e\u7ba1\u7406\u5bf9\u5b50 Chart \u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u5176\u4e2d\u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217\u5f00\u5173\u53d8\u91cf\u3002 \u5728 Helm \u7684\u8f93\u4eba\u5185\u5bb9\u4e2d\u5bf9\u76f8\u5173\u53d8\u91cf\u8fdb\u884c\u5b9a\u4e49\uff0c\u5c31\u53ef\u4ee5\u5bf9 Istio \u7684\u90e8\u7f72\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\uff0c\u6765\u63a7\u5236\u5bf9\u5e94\u7ec4\u4ef6\u7684\u542f\u7528\u72b6\u6001\u3002\u4f8b\u5982\uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5bf9 Grafana \u7684\u63a7\u5236\u4ee3\u7801\uff1a - name: grafana version: 1.0.3 condition:grafana.enabled \u8fd9\u6bb5\u63a7\u5236\u4ee3\u7801\u4ee3\u8868\uff1a\u5982\u679c\u4fee\u6539\u5168\u5c40\u53d8\u91cf grafana.enabled \u4e3a False ,\u5c31\u4e0d\u4f1a\u5b89\u88c5 Grafana \u4e86\u3002","title":"1-3 requirements.yaml"},{"location":"chap5/4Istio_Helm/#1-4-template_affinitytpl","text":"\u8be5\u6587\u4ef6\u4f1a\u751f\u6210\u4e00\u7ec4\u8282\u70b9\u4eb2\u548c\u6216\u4e92\u65a5\u5143\u7d20\uff0c\u4f9b\u5404\u4e2a\u7ec4\u4ef6\u5728\u6e32\u67d3YAML\u65f6\u4f7f\u7528\u8be5\u6587\u4ef6\u91cc\u4f7f\u7528\u4e86\u4e00\u7cfb\u5217\u53d8\u91cf\uff0c\u7528\u4e8e\u63a7\u5236 Istio \u7ec4\u4ef6\u7684\u8282\u70b9\u4eb2\u548c\u6027 \uff08\u4e5f\u5c31\u662f\u9650\u5236\u5728\u90e8\u7f72\u65f6\u5bf9\u8282\u70b9\u7684\u9009\u62e9\u3002 \u5728\u6a21\u677f\u4e2d\u5f15\u7528\u4e86\u5168\u5c40\u53d8\u91cf arch \uff0c\u9ed8\u8ba4\u5185\u5bb9\u662f\uff1a arch: amd64:2 s390x:2 ppc64le:2 \u8fd9\u91cc\u5b9a\u4e49\u5982\u4e0b\u4e24\u4e2a\u5c40\u90e8\u6a21\u677f\uff1a nodeAffinityRequiredDuringScheduling \uff1a\u4f1a\u6839\u636e\u5168\u5c40\u53d8\u91cf\u4e2d\u7684 arch \u53c2\u6570\u5bf9\u90e8\u7f72\u8282\u70b9\u8fdb\u884c\u9650\u5236\u3002 Istio \u7ec4\u4ef6\u7684 Pod \u4f1a\u6839\u636e arch \u53c2\u6570\u4e2d\u7684\u670d\u52a1\u5668\u7c7b\u578b\u5217\u8868\u6765\u51b3\u5b9a\u662f\u5426\u90e8\u7f72\u5230\u67d0\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\uff0c\u5e76\u6839\u636e\u5404\u79cd\u670d\u52a1\u5668\u7c7b\u578b\u7684\u4e0d\u540c\u6743\u91cd\u6765\u51b3\u5b9a\u4f18\u5148\u7ea7\u3002 nodeAffinityPreferredDuringScheduling \uff1a\u8ddf\u4e0a\u4e00\u4e2a\u53d8\u91cf\u7684\u4f5c\u7528\u7c7b\u4f3c\uff0c\u4e0d\u540c\u7684\u662f\uff0c\u8fd9\u4e00\u4e2a\u8f6f\u9650\u5236\u3002 \u63a5\u4e0b\u6765\u4f1a\u4f7f\u7528\u5728\u4e0a\u9762\u5b9a\u4e49\u7684\u4e24\u4e2a\u6a21\u677f\u751f\u6210\u65b0\u6a21\u677f\uff0c\u5c06\u5176\u547d\u540d\u4e3a nodeaffinity \uff0c\u5e76\u63d0\u4f9b\u7ed9\u5176\u4ed6\u7ec4\u4ef6\u5f15\u7528\uff0c\u7528\u4e8e\u751f\u6210\u5404\u4e2a\u7ec4\u4ef6 Deployment \u5bf9\u8c61\u7684\u8282\u70b9\u4eb2\u548c\u6027\u9650\u5236\u3002","title":"1-4 template/_affinity.tpl"},{"location":"chap5/4Istio_Helm/#1-5-templatessidecar-injector-configmapyaml","text":"\u6839\u636e\u6587\u4ef6\u540d\u5c31\u53ef\u4ee5\u5224\u65ad\u51fa\u6765\uff0c\u8be5\u6587\u4ef6\u6700\u7ec8\u4f1a\u7528\u4e8e\u751f\u6210\u4e00\u4e2a ConfigMap \u5bf9\u8c61\uff0c\u5728\u8be5\u5bf9\u8c61\u4e2d\u4fdd\u5b58\u7684\u914d\u7f6e\u6570\u636e\u88ab\u7528\u4e8e\u8fdb\u884c Sidecar \u6ce8\u5165\u3002 istioctl \u5b8c\u6210\u7684\u624b\u5de5\u6ce8\u4eba\uff0c\u6216\u8005 Istioctl \u7684\u81ea\u52a8\u6ce8\u4eba\uff0c\u90fd\u4f1a\u5f15\u7528\u8fd9\u4e2a ConfigMap \uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u5982\u679c\u5e0c\u671b\u4fee\u6539 Istio \u7684 Sidecar \u7684\u6ce8\u4eba\u8fc7\u7a0b\u53ca\u5177\u4f53\u884c\u4e3a\uff0c\u5c31\u53ef\u4ee5\u4ece\u8be5\u6587\u4ef6\u6216\u8005\u5bf9\u5e94\u7684 ConfigMap \u4eba\u624b\u4e86\u3002","title":"1-5 templates/sidecar-injector-configmap.yaml"},{"location":"chap5/4Istio_Helm/#1-6-templatesconfigmapyaml","text":"\u8be5\u6587\u4ef6\u4e5f\u4f1a\u751f\u6210\u4e00\u4e2a ConfigMap \uff0c\u540d\u79f0\u4e3a istio \uff0c\u8fd9\u4e2a\u5bf9\u8c61\u7528\u4e8e\u4e3a Pilot \u63d0\u4f9b\u542f\u52a8\u914d\u7f6e\u6570\u636e\u3002","title":"1-6 templates/configmap.yaml"},{"location":"chap5/4Istio_Helm/#1-7-templatescrdsyaml","text":"\u8be5\u6587\u4ef6\u5305\u542b\u4e86 Istio \u6240\u9700\u7684 CRD \u5b9a\u4e49\uff0c\u5b83\u7684\u90e8\u7f72\u65b9\u5f0f\u8f83\u4e3a\u7279\u6b8a\uff1a \u5982\u679c\u4f7f\u7528 Helm 2.10 \u4e4b\u524d\u7684\u7248\u672c\u8fdb\u884c\u5b89\u88c5\uff0c\u5219\u9700\u8981\u5148\u4f7f\u7528 kubectl \u63d0\u4ea4\u8be5\u6587\u4ef6\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff1b \u5982\u679c\u4f7f\u7528 Helm 2.10 \u4e4b\u540e\u7684\u7248\u672c\uff0c\u5219\u5176\u4e2d\u7684 Helm hook \u4f1a\u81ea\u52a8\u63d0\u524d\u5b89\u88c5\uff0c\u65e0\u987b\u7279\u522b\u6ce8\u610f\u3002","title":"1-7 templates/crds.yaml"},{"location":"chap5/4Istio_Helm/#1-8-charts","text":"\u8fd9\u4e2a\u76ee\u5f55\u4e2d\u7684\u5b50\u76ee\u5f55\u5c31\u662f Istio \u7684\u7ec4\u4ef6\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 certrnanager \uff1a\u4e00\u4e2a\u57fa\u4e8e Jetstack Cert-Manager \u9879\u76ee\u7684 ACME \u8bc1\u4e66\u5ba2\u6237\u7aef\uff0c\u7528\u4e8e\u81ea\u52a8\u8fdb\u884c\u8bc1\u4e66\u7684\u7533\u8bf7\u3001\u83b7\u53d6\u53ca\u5206\u53d1\u3002 galley : Istio \u5229\u7528 Galley \u8fdb\u884c\u914d\u7f6e\u7ba1\u7406\u5de5\u4f5c \u3002 gateways \uff1a \u5bf9 Gateways Chart \u8fdb\u884c\u914d\u7f6e\uff0c\u53ef\u4ee5\u5b89\u88c5\u591a\u4e2a Gateway Controller , grafana \uff1a\u56fe\u5f62\u5316\u7684 Istio Dashboard ingress \uff1a\u4e00\u4e2a\u9057\u7559\u8bbe\u8ba1\uff0c\u9ed8\u8ba4\u5173\u95ed\uff0c\u5728\u6d41\u91cf\u63a7\u5236\u534f\u8bae\u5347\u7ea7\u5230 network.istio.io/vlalpha3 \u4e4b\u540e\uff0c\u5df2\u7ecf\u5efa\u8bae\u5f03\u7528\u3002 kiali \uff1a \u5e26\u6709\u5206\u5e03\u5f0f\u8ddf\u8e2a\u3001\u914d\u7f6e\u6821\u9a8c\u7b49\u591a\u9879\u529f\u80fd\u7684 Dashboard \u3002 mixer : Istio \u7684\u7b56\u7565\u5b9e\u65bd\u7ec4\u4ef6\u3002 pilot : Istio \u7684\u6d41\u91cf\u7ba1\u7406\u7ec4\u4ef6\u3002 prometheus \uff1a \u76d1\u63a7\u8f6f\u4ef6 Prometheus ,\u5176\u4e2d\u5305\u542b Istio \u7279\u5b9a\u7684\u6307\u6807\u6293\u53d6\u8bbe\u7f6e\u3002 security : Citadel \u7ec4\u4ef6\uff0c\u7528\u4e8e\u8bc1\u4e66\u7684\u81ea\u52a8\u7ba1\u7406 servicegraph \uff1a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7ec4\u4ef6\uff0c\u7528\u4e8e\u83b7\u53d6\u548c\u5c55\u793a\u670d\u52a1\u8c03\u7528\u5173\u7cfb\u56fe\uff0c\u5373\u5c06\u5e9f\u9664 sidecarInjectorWebhook : \u81ea\u52a8\u6ce8\u4eba Webhook \u7684\u76f8\u5173\u914d\u7f6e\uff1b tracing \uff1a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7ec4\u4ef6\uff0c\u4f7f\u7528 Jaeger \u5b9e\u73b0\uff0c\u66ff\u4ee3\u539f\u6709\u7684 Service Graph \u7ec4\u4ef6\u3002","title":"1-8 charts"},{"location":"chap5/4Istio_Helm/#2-charts","text":"\u6211\u4eec\u5728\u4f7f\u7528\u73b0\u6709 Chart \u7684\u65f6\u5019\uff0c\u901a\u5e38\u90fd\u4e0d\u4f1a\u4fee\u6539 Chart \u7684\u672c\u4f53\uff0c\u4ec5\u901a\u8fc7\u5bf9\u53d8\u91cf\u7684\u63a7\u5236\u6765\u5b9e\u73b0\u5bf9\u90e8\u7f72\u8fc7\u7a0b\u7684\u5b9a\u5236\u3002 Istio Helm Chart \u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u53d8\u91cf\u6765\u5e2e\u52a9\u7528\u6237\u5bf9 Istio \u7684\u5b89\u88c5\u8fdb\u884c\u5b9a\u5236\u3002 Istio Chart \u5206\u4e3a\u7236\u5b50\u4e24\u5c42\uff0c\u56e0\u6b64\u53d8\u91cf\u4e5f\u5177\u6709\u5168\u5c40\u548c\u672c\u5730\u4e24\u7ea7\u3002 \u5168\u5c40\u53d8\u91cf\u4f7f\u7528\u4fdd\u7559\u5b57 global \u8fdb\u884c\u5b9a\u4e49\uff0c\u5b50 Chart \u53ef\u4ee5\u901a\u8fc7 Values.global \u7684\u65b9\u5f0f\u5f15\u7528\u5168\u5c40\u53d8\u91cf\uff0c\u800c\u5728\u4e3b Chart \u4e2d\u4e5f\u53ef\u4ee5\u7528 chart.var \u7684\u65b9\u5f0f\u4e3a\u5b50 Chart \u6307\u5b9a\u53d8\u91cf\u503c\u3002","title":"2\u3001 charts\u5168\u5c40\u53d8\u91cf\u4ecb\u7ecd"},{"location":"chap5/4Istio_Helm/#2-1-hubtag","text":"\u5728\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e24\u4e2a\u53d8\u91cf\u4ee3\u8868\u6240\u6709\u955c\u50cf\u7684\u5730\u5740\uff0c\u5177\u4f53\u540d\u79f0\u4e00\u822c\u4ee5 \uff5b{ .Values. global.hub}}/[component]/:{{ .Values.global.tag }\uff5d \u7684\u5f62\u5f0f\u62fc\u63a5\u800c\u6210\u3002 \u5728 proxy_init \u3001 Mixer \u3001 Grafana \u548c Pilot \u7684 Deployment \u6a21\u677f\u4e2d, \u4e00\u65e6\u5728\u5176 image \u53d8\u91cf\u4e2d \u5305\u542b\u8def\u5f84\u7b26 \u201c/\" ,\u5219\u4f1a\u5f03\u7528 global.hub \uff0c\u76f4\u63a5\u91c7\u7528 image \u7684\u5b9a\u4e49\uff0c \u4ee3\u7801\u5982\u4e0b\uff1a {{- if contains \"/\" .Values.image }} image: \"{{ .Values.image }}\" {{- else }} image: \"{{ $.Values.global.hub }}/{{ $.Values.image }}:{{ $.Values.global.tag }}\" {{- end }} \u8fd9\u4e24\u4e2a\u53d8\u91cf\u5bf9\u4e8e\u5185\u7f51\u90e8\u7f72\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\uff0c\u5c06 istio \u7684\u955c\u50cf\u62c9\u53d6\u56de\u6765\uff0c\u4e95\u63a8\u9001\u81f3\u79c1\u5e93\u4e4b\u540e\uff0e\u53ea\u8981\u5728 Values.yaml \u4e2d\u8fdb\u884c\u4fee\u6539\u3001\u5c31\u53ef\u4ee5\u5c06 Istio \u6240\u9700\u955c\u50cf\u7684\u5f15\u7528\u6307\u5411\u5185\u7f51\u79c1\u5e93\uff0e\u7701\u53bb\u4e86\u9010\u4e2a\u4fee\u6539 Deployment \u6587\u6863\u7684\u9ebb\u70e6","title":"2-1 hub\u548ctag"},{"location":"chap5/4Istio_Helm/#2-2-ingressenabled","text":"\u8fd9\u4e2a\u5f00\u5173\u7528\u6765\u63a7\u5236\u662f\u5426\u542f\u7528 Istio \u7684 Ingress Controller . \u5982\u679c\u8fd9\u4e2a\u503c\u88ab\u8bbe\u7f6e\u4e3a True \u5c31\u4f1a\u542f\u7528\u65f6 Kubernetes Ingress \u8d44\u6e90\u7684\u652f\u6301\uff0c\u8fd9\u662f\u4e00\u4e2a\u517c\u5bb9\u7684\u529f\u80fd","title":"2-2 ingress.enabled"},{"location":"chap5/4Istio_Helm/#2-3-istio-ingressingress-gateway","text":"\u6709\u4e24\u4e2a\u53d8\u91cf\u4f1a\u53d7\u5230\u8fd9\u4e2a\u5f00\u5173\u7684\u5f71\u554a\uff0c\u8fd9\u4e24\u4e2a\u53d8\u91cf\u5206\u522b\u662f k8sIngressSelector \u548c k8sIngressHttps \u53ea\u6709\u5728 ingress.enabled \u88ab\u8bbe\u7f6e\u4e3a True \u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e24\u4e2a\u53d8\u91cf\u7684\u76f8\u5173\u5185\u5bb9\u624d\u4f1a\u751f\u6548 \u3002 k8sIngresSelector \u4f1a\u5229\u7528 Pod \u6807\u7b7e\u9009\u62e9\u4e00\u4e2a Gateway \uff0c\u4f5c\u4e3a Ingress Controller \u5982\u679c\u5c06 k8sIngressHttps \u53d8\u91cf\u8d4b\u503c\u4e3a True \uff0c\u5c31\u4f1a\u5728 istio-autogenerated-k8s-in gress \u8fd9\u4e2a Gateway \u5b9a\u4e49\u4e2d\u52a0\u5165 443 \u7aef\u53e3\u53ca\u5176 TLS \u914d\u7f6e. k8sIngressHttps \u7684\u76f8\u5173\u5f15\u7528\u5bf9 Ingress Gateway Pod \u7684 /etc/istio/ingress/certs\uff0f \u4e0b\u7684\u8bc1\u4e66\u6587\u4ef6\u6709\u4f9d\u8d56\uff0e \u56e0\u6b64\u9700\u8981\u542f\u7528\u8fd9\u4e00\u9009\u9879\uff1a\u9700\u8981\u628a ingress.enabled \u8bbe\u7f6e\u4e3a true \u3002 \u4ece\u800c\u6210\u529f\u521b\u5efa ingress Chart \u7684 Deployment \uff1b \u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u88ab\u547d\u540d\u4e3a Ingress-certs \u7684 tls secret \u7ed9 istio-ingress Deployment \u8fdb\u884c\u52a0\u8f7d\u3002\u5982\u679c\u6ca1\u6709\u6ee1\u8db3\u8fd9\u4e9b\u6761\u4ef6\uff0c LDS \u5c31\u4f1a\u62d2\u7edd\u670d\u52a1\uff0c\u4ece\u800c\u65e0\u6cd5\u63d0\u4f9b Ingress \u529f\u80fd.","title":"2-3 Istio\u5e76\u4e0d\u63a8\u8350 ingress\u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u5efa\u8bae\u4f7f\u7528Ingress Gateway, \u53d6\u800c\u4ee3\u4e4b"},{"location":"chap5/4Istio_Helm/#2-4-proxy","text":"\u5728 values.yaml \u4e2d\u5b9a\u4e49\u4e00\u7ec4 Proxy \u53d8\u91cf, \u7528\u4e8e\u5bf9 Sidecar \u8fdb\u884c\u63a7\u5236\u3002","title":"2-4 Proxy\u76f8\u5173\u53c2\u6570"},{"location":"chap5/4Istio_Helm/#1proxyresources","text":"\u7528\u4e8e\u4e3a Sidecar \u5206\u914d\u8d44\u6e90\u3002\u7528\u6237\u53ef\u4ee5\u6839\u636e\u4e1a\u52a1Pod\u7684\u8d1f\u8f7d\u60c5\u51b5, \u4e3a Sidecar \u6307\u5b9a CPU \u548c\u5185\u5b58\u8d44\u6e90\u3002","title":"1.proxy.resources"},{"location":"chap5/4Istio_Helm/#2proxyconcurrency","text":"Proxy worker \u6570\u91cf\u8fdb\u884c\u5206\u914d\u3002\u5982\u679c\u88ab\u8bbe\u7f6e\u4e3a0\uff08\u9ed8\u8ba4\u503c\uff09\uff0c\u5219\u6839\u636e CPU \u7ebf\u7a0b\u6216\u6838\u7684\u6570\u91cf\u8fdb\u884c\u5206\u914d\u3002","title":"2.proxy.concurrency"},{"location":"chap5/4Istio_Helm/#3proxyaccesslogfi1e","text":"Sidecar \u7684\u8bbf\u95ee\u65e5\u5fd7\u4f4d\u7f6e\u3002 \u5982\u679c\u88ab\u8bbe\u7f6e\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u5219\u5173\u95ed\u8bbf\u95ee\u65e5\u5fd7\u529f\u80fd\u3002\u9ed8\u8ba4\u503c\u4e3a /dev/stdout \u3002","title":"3.Proxy.accessLogFi1e"},{"location":"chap5/4Istio_Helm/#4-proxyprivileged","text":"istio-init \u3001 istio-proxy \u7684\u7279\u6743\u6a21\u5f0f\u5f00\u5173\u3002\u9ed8\u8ba4\u503c\u4e3a false \u3002","title":"4. proxy.privileged"},{"location":"chap5/4Istio_Helm/#5proxyenablecoredump","text":"\u5982\u679c\u6253\u5f00, \u5219\u65b0\u6ce8\u4eba\u7684 Sidecar \u4f1a\u542f\u52a8 CoreDump \u529f\u80fd\uff0c \u5728 Pod \u4e2d\u52a0\u4eba\u521d\u59cb\u5316\u5bb9\u5668 enable-core-dump \u9ed8\u8ba4\u503c\u4e3a false","title":"5.Proxy.enableCoreDump"},{"location":"chap5/4Istio_Helm/#6proxyincludeipranges","text":"\u52ab\u6301 IP \u8303\u56f4\u7684\u767d\u540d\u5355\u3002\u9ed8\u8ba4\u503c\u4e3a \u201c*\" \uff0c\u4e5f\u5c31\u662f\u52ab\u6301\u6240\u6709\u5730\u5740\u7684\u6d41\u91cf\u3002 \u5728 sidecar-injector-configmap.yaml \u4e2d\u5e94\u7528\u4e86\u8fd9\u4e00\u53d8\u91cf\uff0c\u7528\u4e8e\u751f\u6210 istio-sidecar-injector \u8fd9\u4e2a ConfigMap \uff0c\u8fd9\u4e2a ConfigMap \u8bbe\u7f6e\u4e86 istio-init \u7684\u8fd0\u884c\u53c2\u6570\uff0c\u901a\u8fc7\u5bf9 istio-init \u7684 \"-i\u201d \u53c2\u6570\u8fdb\u884c\u4fee\u6539\u6765\u5b8c\u6210\u8fd9\u4e00\u4efb\u52a1\u3002","title":"6.proxy.includeIPRanges"},{"location":"chap5/4Istio_Helm/#7-proxyexcludeipranges","text":"\u52ab\u6301 IP \u8303\u56f4\u7684\u9ed1\u540d\u5355\u3002\u9ed8\u8ba4\u503c\u4e3a\u7a7a\u5b57\u7b26\u4e32, \u4e5f\u5c31\u52ab\u6301\u8303\u56f4\u4ee5\u5916\u7684IP\u3002\u540c proxy.includeIPRanges \u7684\u60c5\u51b5\u7c7b\u4f3c\u3002\u5b83\u5f71\u54cd\u7684\u662f istio-init \u7684 -x \u53c2\u6570","title":"7. Proxy.excludeIPRanges"},{"location":"chap5/4Istio_Helm/#8proxyincludeinboundports","text":"\u5165\u7ad9\u6d41\u91cf\u7684\u7aef\u53e3\u52ab\u6301\u767d\u540d\u5355\u3002\u6240\u6709\u4ece\u8303\u56f4\u5185\u7684\u7aef\u53e3\u8fdb\u5165Pod\u7684\u6d41\u91cf\u90fd\u4f1a\u88ab\u52ab\u6301\u3002\u5b83\u5f71\u54cd\u7684\u662f istio-init \u7684 \"-b\" \u53c2\u6570","title":"8.Proxy.includeInboundPorts"},{"location":"chap5/4Istio_Helm/#9proxyexcludeinboundports","text":"\u5165\u7ad9\u6d41\u91cf\u7684\u7aef\u53e3\u52ab\u6301\u9ed1\u540d\u5355\u3002\u8fd9\u4e00\u7aef\u53e3\u8303\u56f4\u4e4b\u5916\u7684\u5165\u7ad9\u6d41\u91cf\u624d\u4f1a\u88ab\u52ab\u6301\u3002 \u5b83\u5f71\u54cd\u7684\u662f Istio-init \u7684 \u201c-d\u201d \u53c2\u6570\u3002","title":"9.proxy.excludeInboundports"},{"location":"chap5/4Istio_Helm/#10proxyautoinject","text":"\u7528\u4e8e\u63a7\u5236\u662f\u5426\u81ea\u52a8\u5b8c\u6210 Sidecar \u7684\u6ce8\u5165\u5de5\u4f5c\u3002","title":"10.proxy.autoInject"},{"location":"chap5/4Istio_Helm/#11-proxyenvoystatsd","text":"\u8be5\u53d8\u91cf\u7684\u9ed8\u8ba4\u503c\u5982\u4e0b\u3002 enabled:true host:istio-statsd-prom-bridge port:9125 \u5b83\u4f1a\u8bbe\u7f6e Envoy \u7684 \u201c--statsdUdpAddress\u201d \u53c2\u6570\uff0c\u5728\u67d0\u4e9b\u53c2\u6570\u4e0b\uff08\u4f8b\u5982\u6ca1\u6709\u5b89\u88c5 Mixer \uff09\u53ef\u4ee5\u5173\u95ed\u3002","title":"11. proxy.envoyStatsd"},{"location":"chap5/4Istio_Helm/#2-4-proxy_initimage","text":"\u7f51\u683c\u4e2d\u7684\u670d\u52a1 Pod \u5728\u542f\u52a8\u4e4b\u524d\uff0c\u9996\u5148\u4f1a\u8fd0\u884c\u4e00\u4e2a\u521d\u59cb\u5316\u955c\u50cf\u6765\u5b8c\u6210\u6d41\u91cf\u52ab\u6301\u5de5\u4f5c\uff0c\u8fd9\u4e2a\u53d8\u91cf\u53ef\u4ee5\u7528\u4e8e\u6307\u5b9a\u521d\u59cb\u5316\u5bb9\u5668\u955c\u50cf\u3002","title":"2-4 proxy_init.image"},{"location":"chap5/4Istio_Helm/#2-5-imagepullpolicy","text":"\u955c\u50cf\u7684\u62c9\u53d6\u7b56\u7565\u3002\u9ed8\u8ba4\u503c\u4e3a \u201cIfNotPresent\" .","title":"2-5 imagePullPolicy"},{"location":"chap5/4Istio_Helm/#2-6-controlplanesecurityenabled","text":"\u6307\u5b9a\u662f\u5426\u5728 Istio \u63a7\u5236\u9762\u7ec4\u4ef6\u4e0a\u542f\u7528 mTLS \u901a\u4fe1\u3002 \u5728\u542f\u7528\u4e4b\u540e\uff0c Sidecar \u548c\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u4e4b\u95f4\uff0c\u4ee5\u53ca\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\u4e4b\u95f4\u7684\u901a\u4fe1\uff0c\u90fd\u4f1a\u88ab\u6539\u4e3a mTLS \u65b9\u5f0f\u3002\u53d7\u5f71\u54cd\u7684\u7ec4\u4ef6\u5305\u62ec Ingress . Mixer , Pilot \u53ca Sidecar .","title":"2-6 controlPlaneSecurityEnabled"},{"location":"chap5/4Istio_Helm/#2-7-disablepolicychecks","text":"\u5982\u679c\u628a\u8fd9\u4e2a\u5f00\u5173\u53d8\u91cf\u8bbe\u7f6e\u4e3a true \uff0c\u5219\u4f1a\u7981\u7528 Mixer \u7684\u9884\u68c0\u529f\u80fd\u3002\u9884\u68c0\u529f\u80fd\u662f\u4e00\u4e2a\u540c\u6b65\u8fc7\u7a0b\uff0c\u6709\u53ef\u80fd\u56e0\u4e3a\u9884\u68c0\u7f13\u6162\u9020\u6210\u4e1a\u52a1\u5e94\u7528\u7684\u963b\u585e\u3002","title":"2-7 disablePolicyChecks"},{"location":"chap5/4Istio_Helm/#2-8-enabletracing","text":"\u662f\u5426\u542f\u7528\u5206\u5e03\u5f0f\u8ddf\u8e2a\u529f\u80fd\uff0c\u9ed8\u8ba4\u503c\u4e3a true","title":"2-8 enableTracing"},{"location":"chap5/4Istio_Helm/#2-9-mtlsenabled","text":"\u6240\u6709\u670d\u52a1\u4e4b\u95ee\u7684\u901a\u4fe1\u90fd\u4f1a\u4f7f\u7528 mTLS \u8fdb\u884c\u5b89\u5168\u52a0\u56fa\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u4e00\u53d8\u91cf\u7684\u8bbe\u7f6e\u662f\u5168\u5c40\u7684\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u670d\u52a1\u8fd8\u4ee5\u5355\u72ec\u4f7f\u7528\u76ee\u6807\u89c4\u5219\u6216\u8005\u670d\u52a1\u6ce8\u89e3\u7684\u65b9\u5f0f\uff0c\u81ea\u884c\u8bc0\u5b9a\u662f\u5426\u91c7\u7528 mTLS \u52a0\u56fa","title":"2-9 mtls.enabled"},{"location":"chap5/4Istio_Helm/#2-10-imagepullsecrets","text":"\u7528\u4e8e\u4e3a ServiceAccount \u5206\u914d\u5728\u955c\u50cf\u62c9\u53d6\u8fc7\u7a0b\u4e2d\u6240\u9700\u7684\u8ba4\u8bc1\u51ed\u636e\u3002\u9ed8\u8ba4\u503c\u4e3a\u7a7a\u503c","title":"2-10 imagePullSecrets"},{"location":"chap5/4Istio_Helm/#2-11-arch","text":"\u5728\u8bbe\u7f6e Istio \u7ec4\u4ef6\u7684\u8282\u70b9\u4eb2\u548c\u6027\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u4f7f\u7528\u8fd9\u4e00\u53d8\u91cf\u7684\u5217\u8868\u5185\u5bb9\u6765\u786e\u5b9a\u53ef\u4ee5\u7528\u4e8e\u90e8\u7f72\u7684\u8282\u70b9\u8303\u56f4\uff0c\u5e76\u6309\u7167\u4e0d\u540c\u7684\u670d\u52a1\u5668\u67b6\u6784\u8bbe\u7f6e\u4e86\u4f18\u5148\u987a\u5e8f\u3002\u5b83\u7684\u9ed8\u8ba4\u5217\u8868\u5185\u5bb9\u5982\u4e0b\uff1a amd64:2 s390x:2 ppc64le:2","title":"2-11 arch"},{"location":"chap5/4Istio_Helm/#2-12-onenamespace","text":"\u9ed8\u8ba4\u503c\u4e3a false , Pilot \u4f1a\u76d1\u63a7\u6240\u6709\u547d\u540d\u7a7a\u95f4\u5185\u7684\u670d\u52a1\u53d8\u5316\u5982\u679c\u8fd9\u4e2a\u53d8\u91cf\u88ab\u8bbe\u7f6e\u4e3a true \uff0c\u5219\u4f1a\u5728 Pilot \u7684\u670d\u52a1\u53d1\u73b0\u53c2\u6570\u4e2d\u52a0\u5165 \"-a\" , \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c Pilot \u53ea\u4f1a\u5bf9 Istio \u7ec4\u4ef6\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u8fdb\u884c\u76d1\u63a7\u3002","title":"2-12 oneNamespace"},{"location":"chap5/4Istio_Helm/#2-13-configvalidation","text":"\u7528\u4e8e\u914d\u7f6e\u662f\u5426\u5f00\u542f\u670d\u52a1\u7aef\u7684\u914d\u7f6e\u9a8c\u8bc1\u3002\u9ed8\u8ba4\u503c\u4e3a true . \u8be5\u9009\u9879\u5728\u5f00\u542f\u4e4b\u540e\uff0c \u4f1a\u751f\u6210\u4e00\u4e2a ValidatingWebhook Configuration \u5bf9\u8c61\uff0c\u5e76\u88ab\u5305\u542b\u5230 Galley \u7684\u914d\u7f6e\u4e2d\uff0c\u4ece\u800c\u542f\u7528\u6821\u9a8c\u529f\u80fd\u3002","title":"2-13 configValidation"},{"location":"chap5/4Istio_Helm/#2-14-meshexpansion","text":"\u8981\u5c06\u670d\u52a1\u7f51\u683c\u6269\u5c55\u5230\u7269\u7406\u673a\u6216\u8005\u865a\u62df\u673a\u4e0a\uff0c\u5c31\u4f1a\u4f7f\u7528\u5230\u8fd9\u4e00\u53d8\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a false \u5982\u679c\u88ab\u8bbe\u7f6e\u4e3a true \uff0c\u5219\u4f1a\u5728 Ingress Gateway \u4e0a\u516c\u5f00 Pilot \u548c Citadel \u7684\u670d\u52a1\u3002","title":"2-14 meshExpansion"},{"location":"chap5/4Istio_Helm/#2-15-meshexpansionilb","text":"\u662f\u5426\u5728\u5185\u90e8\u7f51\u5173\u4e2d\u516c\u5f00 Pilot \u548c Citadel \u7684\u7aef\u53e3\u3002 \u9ed8\u8ba4\u503c\u4e3a false \uff0c\u4ec5\u5728\u670d\u52a1\u7f51\u683c\u6269\u5c55\u65f6\u4f1a\u4f7f\u7528\u5230\u8fd9\u4e00\u53d8\u91cf\u3002","title":"2-15 meshExpansionILB"},{"location":"chap5/4Istio_Helm/#2-16-defaultresources","text":"\u4e3a\u6240\u6709 Istio \u7ec4\u4ef6\u90fd\u63d0\u4f9b\u4e00\u4e2a\u6700\u5c0f\u8d44\u6e90\u9650\u5236\u3002\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53ea\u8bbe\u7f6e\u4e00\u4e2a\u8bf7\u6c42 10m Cpu \u8d44\u6e90\u7684\u503c\u3002\u53ef\u4ee5\u5728\u5404\u4e2a Chart \u7684\u5c40\u90e8\u53d8\u91cf\u4e2d\u5206\u522b\u8bbe\u7f6e\u8d44\u6e90\u9700\u6c42\u3002","title":"2-16 defaultResources"},{"location":"chap5/4Istio_Helm/#2-17-hyperkube","text":"\u5728 Istio \u7684\u8bbe\u7f6e\u8fc7\u7a0b\u4f1a\u4f7f\u7528\u4e00\u4e2a\u955c\u50cf\u6267\u884c\u4e00\u4e9b Job \uff0c\u4f8b\u5982\u5728\u65e9\u671f\u7248\u672c\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u7684 CRD \u521d\u59cb\u5316\uff0c\u6216\u8005\u73b0\u5728\u7684\u6e05\u7406\u8fc7\u671f\u8bc1\u4e66\u7b49\u4efb\u52a1\u3002\u8fd9\u4e2a\u955c\u50cf\u9ed8\u8ba4\u4f7f\u7528\u7684\u662f quay.io/coreos:v1.7.6_coreos.0 \uff0c\u5728\u5185\u7f51\u4e2d\u540c\u6837\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u8986\u76d6\u3002","title":"2-17 hyperkube"},{"location":"chap5/4Istio_Helm/#2-18-priorityclassname","text":"Kubernetes \u5728 1.11.0 \u4ee5\u4e0a\u7248\u672c\u4e2d\u63d0\u51fa\u4e86 PriorityClass \u7684\u6982\u5ff5\uff0c \u5177\u6709\u4f18\u5148\u7ea7\u7684 Pod \u4e0d\u4f1a\u88ab\u9a71\u9010\u6216\u62a2\u5360\u8d44\u6e90\u3002\u8be5\u53d8\u91cf\u7684\u9ed8\u8ba4\u503c\u4e3a\u7a7a\uff0c\u53ef\u9009\u503c\u5305\u62ec \u201csystem-cluster-critical\" \u548c \"system-node-critical\" \u3002","title":"2-18 priorityClassName"},{"location":"chap5/4Istio_Helm/#2-19-crds","text":"\u8be5\u53d8\u91cf\u7528\u4e8e\u51b3\u5b9a\u662f\u5426\u5305\u542b CRD \u5b9a\u4e49\u3002\u5982\u679c\u4f7f\u7528 helm templat e\u547d\u4ee4\uff0c\u6216\u8005\u662f 2.10 \u4ee5\u571f\u7248\u672c\u7684 helm install \u547d\u4ee4\uff0c\u5219\u5e94\u8be5\u5c06\u5176\u8bbe\u7f6e\u4e3a true ; \u5426\u5219\u5728\u5b89\u88c5\u4e4b\u524d\u9996\u5148\u8981\u6267\u884c kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml \uff0c\u5e76\u5c06\u8be5\u53d8\u91cf\u8bbe\u7f6e\u4e3a false \u3002","title":"2-19 crds"},{"location":"chap5/4Istio_Helm/#3istio","text":"","title":"3\u3001Istio \u5b89\u88c5\u6e05\u5355\u7684\u751f\u6210\u548c\u90e8\u7f72"},{"location":"chap5/4Istio_Helm/#3-1-valuesyaml","text":"\u6211\u4eec\u9700\u8981\u5148\u6839\u636e\u5b9e\u9645\u9700\u6c42\u5bf9 Istio \u8fdb\u884c\u5b9a\u5236\uff0c values.yaml \u3002\u6700\u5e38\u89c1\u7684\u4fee\u6539\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\u3002 \u955c\u50cf\u5730\u5740 \u5982\u679c\u662f\u5185\u7f51\u90e8\u7f72\uff0c\u90a3\u4e48\u9700\u8981\u5148\u89e3\u51b3\u955c\u50cf\u5730\u5740\u95ee\u9898\u3002\u6211\u4eec\u901a\u5e38\u4f1a\u5728\u5177\u5907\u5916\u7f51\u8fde\u63a5\u6761\u4ef6\u7684\u670d\u52a1\u5668\u4e0a\u62c9\u53d6\u6240\u9700\u955c\u50cf\uff0c\u7136\u540e\u5bfc\u51fa\u955c\u50cf\uff0c\u5c06\u5176\u63a8\u9001\u5230\u672c\u5730\u79c1\u6709\u955c\u50cf\u5e93\u3002\u90a3\u4e48\uff0c \u5982\u4f55\u77e5\u9053\u6211\u4eec\u9700\u8981\u54ea\u4e9b\u955c\u50cf\uff1f \u6211\u4eec\u53ef\u4ee5 grep istio-demo.yaml $ cd Istio/istio-1.1.16/install/kubernetes $ grep -r image: istio-demo.yaml | egrep -o -e \"image:.*\" | sort | uniq image: \"docker.io/istio/citadel:1.1.16\" image: \"docker.io/istio/galley:1.1.16\" image: \"docker.io/istio/kubectl:1.1.16\" image: \"docker.io/istio/kubectl:1.1.16\" image: \"docker.io/istio/mixer:1.1.16\" image: \"docker.io/istio/pilot:1.1.16\" image: \"docker.io/istio/proxy_init:1.1.16\" image: \"docker.io/istio/proxyv2:1.1.16\" image: \"docker.io/istio/sidecar_injector:1.1.16\" image: \"docker.io/jaegertracing/all-in-one:1.9\" image: \"docker.io/kiali/kiali:v0.16\" image: \"docker.io/prom/prometheus:v2.3.1\" image: \"grafana/grafana:6.0.2\" image: [[ annotation .ObjectMeta `sidecar.istio.io/proxyImage` \"docker.io/istio/proxyv2:1.1.16\" ]] \u5728\u5f97\u5230\u8fd9\u4e9b\u955c\u50cf\u540d\u79f0\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u9010\u4e2a\u8fdb\u884c\u955c\u50cf\u7684\u62c9\u53d6\u548c\u63a8\u9001\u64cd\u4f5c\u4e86\u3002 \u63a5\u4e0b\u6765\u6839\u636e\u79c1\u5e93\u5730\u5740\uff0c\u4fee\u6539 values.yaml \u4e2d\u5404\u4e2a\u955c\u50cf\u7684\u5730\u5740\uff0c\u751f\u6210\u65b0\u7684\u5b89\u88c5\u6e05\u5355\u6587\u4ef6\uff0c\u7136\u540e\u91cd\u65b0\u7528\u4e0a\u8ff0\u547d\u4ee4\u8fdb\u884c\u68c0\u67e5\u5373\u53ef\u3002","title":"3-1 \u7f16\u8f91values.yaml"},{"location":"chap5/4Istio_Helm/#3-2","text":"Values.yaml \u4e2d\u7684\u7cfb\u7edf\u8d44\u6e90\u8bbe\u7f6e\u662f\u975e\u5e38\u4fdd\u5b88\u7684\uff0c\u5e76\u4e14\u4e0d\u591f\u5b8c\u6574\uff0c\u56e0\u6b64\u8fd9\u91cc\u5efa\u8bae\u6839\u636e\u5b9e\u9645\u968b\u51b5\u8c03\u6574\u5404\u4e2a\u7ec4\u4ef6\u7684\u8d44\u6e90\u5206\u914d\u3002","title":"3-2 \u7cfb\u7edf\u8d44\u6e90"},{"location":"chap5/4Istio_Helm/#3-3","text":"Istio \u7684 Istio-ingressgateWay \u670d\u52a1\u7684\u9ed8\u8ba4\u7c7b\u578b\u662f Loadbalancer \uff0c\u5982\u679c\u5728\u8981\u90e8\u7f72\u7684 \u76ee\u6807 Kubernetes \u96c6\u7fa4\u4e2d\u6ca1\u6709\u8d1f\u8f7d\u5747\u8861\u652f\u6301\uff0c\u5c31\u9700\u8981\u5bf9\u670d\u52a1\u7c7b\u578b\u8fdb\u884c\u4fee\u6539\u4e86","title":"3-3 \u670d\u52a1\u7c7b\u578b"},{"location":"chap5/4Istio_Helm/#3-4","text":"\u5728 Istio \u4e2d\u5305\u542b\u4e86 Prometheus , Grafana \u53ca Kiali \u7b49\u53ef\u89c6\u5316\u7ec4\u4ef6\uff0c\u5728\u9ed8\u8ba4\u72b6\u6001\u4e0b\u90fd\u662f ClusterIP \u7c7b\u578b\u7684\uff0c\u8981\u987a\u5229\u4f7f\u7528\uff0c\u5219\u53ef\u80fd\u9700\u8981\u4e3a\u5176\u5206\u914d Ingress \u6216\u8005\u4fee\u6539\u670d\u52a1\u7c7b\u578b\u3002","title":"3-4 \u53ef\u89c6\u5316\u7ec4\u4ef6\u7684\u670d\u52a1\u5f00\u653e"},{"location":"chap5/4Istio_Helm/#4","text":"\u5728\u5b8c\u6210\u5bf9 values.yaml \u7684\u7f16\u8f91\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528 helm template \u547d\u4ee4\u6765\u751f\u6210\u6700\u7ec8\u7684 \\\u90e8\u7f72\u6e05\u5355\u6587\u4ef6\u4e86\uff0c\u4f8b\u5982\u6211\u4eec\u751f\u6210\u7684\u8f93\u4eba\u6587\u4ef6\u4e3a my-values.yaml \uff0c\u90a3\u4e48\u53ef\u4ee5\u7528\u5982\u4e0b\u547d\u4ee4\u751f\u6210\u6211\u4eec\u9700\u8981\u7684YAML\u6587\u4ef6\uff1a $ helm template install/kubernetes/helm/istio \\ --namespace istio\u4e00system \\ -f my-values.yaml>my-istio.yaml \u8fd9\u4e2a\u547d\u4ee4\u5047\u8bbe\u6211\u4eec\u7684\u5f53\u524d\u76ee\u5f55\u662f Istio \u53d1\u884c\u5305\u7684\u6839\u76ee\u5f55\uff0c\u5176\u4e2d\uff1a \"--name istio\u201d \u4ee3\u8868\u751f\u6210\u7684\u90e8\u7f72\u5185\u5bb9\u7684\u57fa\u7840\u540d\u79f0\u4e3a\u201cistio\"; \"--namespace istio-system\u201d \u4ee3\u8868\u5c06 Istlo \u90e8\u7f72\u5230\u547d\u540d\u7a7a\u95f4 \"istio-system\u201d\u4e2d\uff1b \"-f my-values.yaml\u201d \u4ee3\u8868\u4ece my-values.yaml \u6587\u4ef6\u4e2d\u83b7\u53d6\u8f93\u4eba\u7684\u5185\u5bb9\u3002 \u8be5\u547d\u4ee4\u5728\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\uff0c\u4f1a\u751f\u6210\u90e8\u7f72\u6e05\u5355\u6587\u4ef6 my-istio.yaml \uff0c\u53ef\u4ee5\u6253\u5f00\u8be5\u6587\u4ef6\uff0c\u68c0\u67e5\u5176\u4e2d\u7684\u5185\u5bb9\u662f\u5426\u7b26\u5408\u9884\u671f\u3002","title":"4\u3001\u751f\u6210\u90e8\u7f72\u6e05\u5355"},{"location":"chap5/4Istio_Helm/#5istio","text":"\u5728\u90e8\u7f72\u6e05\u5355\u751f\u6210\u5e76\u68c0\u67e5\u5b8c\u6bd5\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5f00\u59cb\u90e8\u7f72\u4e86\u3002 \u6211\u4eec\u751f\u6210\u7684 my-istio.yaml \u662f\u8981\u6c42\u90e8\u7f72\u5230 istio-system \u547d\u540d\u7a7a\u95f4\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f7f\u7528 kubectl \u547d\u4ee4\u6765\u521b\u5efa\u5b83\uff1a $ kubectl create ns istio-system namespace/istio-system created kubectl apply -f my-istio.yaml configmap/istio-galley-configuration created configmap/istio-statsd-prom-bridge created configmap/prometheus created configmap/istio-security-custom-resources created \u7b49\u8fd0\u884c\u7ed3\u675f\u4e4b\u540e\uff0c\u540c\u6837\u53ef\u4ee5\u4f7f\u7528 \u201ckubecti get po -n istio-system -w\u201d \u547d\u4ee4\u6765\u67e5\u770b Pod \u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u76f4\u5230\u5168\u90e8 Pod \u6210\u529f\u8fdb\u4eba Running \u6216\u8005 Completed \u72b6\u6001\uff0c Istio \u7684\u5b89\u88c5\u90e8\u7f72\u5de5\u4f5c\u5c31\u5b8c\u6210\u4e86\u3002","title":"5\u3001\u90e8\u7f72Istio"},{"location":"chap5/4Istio_Helm/#6","text":"Helm\u8fd8\u6709\u4e00\u79cd\u5e38\u89c1\u7684\u90e8\u7f72\u65b9\u5f0f\uff0c\u5c31\u662f\u901a\u8fc7 helm install \u547d\u4ee4\u8fdb\u884c\u90e8\u7f72\u3002\u4f46\u662f\uff0c\u91c7\u7528\u8fd9\u79cd\u90e8\u7f72\u65b9\u5f0f\u65f6\uff0c\u9700\u8981\u5728 Kubernetes \u4e2d\u90e8\u7f72 Tiller \uff1a\u670d\u52a1\u7aef\uff0c\u800c\u4e14\u4e0d\u4f1a\u751f\u6210\u90e8\u7f72\u6e05\u5355\u6587\u4ef6\uff0c \u8fd9\u5bf9\u4e8e\u914d\u7f6e\u7ba1\u7406\u6765\u8bf4\u662f\u5f88\u4e0d\u65b9\u4fbf\u7684\uff0c\u56e0\u6b64\u8fd9\u91cc\u4e0d\u505a\u63a8\u8350\u3002 \u53e6\u5916\uff0c\u5728 Helm \u7684 template \u6216\u8005 install \u547d\u4ee4\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 \u201c--set\u201d \u7684\u65b9\u5f0f\u6765\u8bbe\u7f6e \u53d8\u91cf\u503c\u3002\u8fd9\u91cc\u6ca1\u6709\u63d0\u53ca\u8fd9\u79cd\u65b9\u5f0f\uff0c\u539f\u56e0\u5f88\u7b80\u5355\uff1a Istio \u90e8\u7f72\u8fc7\u7a0b\u4e2d\u6d89\u53ca\u7684\u53d8\u91cf\u592a\u591a\uff0c\u547d\u4ee4\u884c\u65b9\u5f0f\u66f4\u663e\u7b28\u91cd\u3002","title":"6\u3001\u5c0f\u7ed3"},{"location":"chap5/5Istio_funcs/","text":"\u7b2c\u4e94\u8282 Istio \u5e38\u7528\u529f\u80fd \uff08\u81ea\u52a8/\u624b\u52a8\u90e8\u7f72 Istio \u5e94\u7528\uff09 Istio \u5728\u5fae\u670d\u52a1\u4f53\u7cfb\u4e2d\u63d0\u4f9b\u4e86\u4e3a\u6570\u4f17\u591a\u7684\u5404\u79cd\u529f\u80fd\uff0c\u8fd9\u4e48\u591a\u529f\u80fd\u96be\u514d\u8ba9\u4eba\u773c\u82b1\u7f2d\u4e71\uff0c\u672c\u7ae0\u5c06\u4f1a\u4ece\u5728\u7f51\u683c\u4e2d\u90e8\u7f72\u5e94\u7528\u5f00\u59cb\uff0c\u5c55\u793a Istio \u7684\u5e38\u7528\u529f\u80fd\uff0c\u5305\u62ec\u57fa\u672c\u7684\u6d41\u91cf\u63a7\u5236\u3001\u5f00\u7bb1\u5373\u7528\u7684\u53ef\u89c6\u5316\u529f\u80fd\u7b49\u3002 \u672c\u7ae0\u5185\u5bb9\u6d89\u53ca Grafana , Prometheus , Jaeger \u53ca Kiali \uff0c\u90fd\u662f\u72ec\u7acb\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u5404 \u9879\u76ee\u6240\u6d89\u53ca\u7684\u5185\u5bb9\u90fd\u975e\u5e38\u4e30\u5bcc\u548c\u6df1\u5165\u3002 1\u3001\u5728\u7f51\u683c\u4e2d\u90e8\u7f72\u5e94\u7528 \u6211\u4eec\u5728\u7b2c3\u7ae0\u4e2d\u5df2\u7ecf\u4f7f\u7528\u8fc7 istioctl kube-inject \u547d\u4ee4\u6765\u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u6ce8\u4eba Istio Sidecar \uff0c\u672c\u8282\u4f1a\u7a0d\u5fae\u6df1\u4eba\u5730\u63a2\u8ba8\u8fd9\u4e2a\u529f\u80fd\u3002 \u6dfb\u52a0\u4e00\u4e2a \"-o\" \u53c2\u6570\uff0c\u5c06\u6ce8\u4eba\u7ed3\u679c\u8f93\u51fa\u4e3a\u6587\u4ef6\uff0c\u4ee5\u4fbf\u89c2\u5bdf\uff1a istioctl kube-inject -f flask.istio.yaml -o flask.istio.injected.yaml \u5728\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u591a\u51fa\u4e86\u4e00\u4e2a flask.istio.injected.yaml \u6587\u4ef6\u3002 \u6253\u5f00\u8be5\u6587\u4ef6\uff0c\u5c06\u5176\u548c\u6e90\u6587\u4ef6 flask.istio.yaml \u8fdb\u884c\u5bf9\u6bd4\uff0c\u4e0d\u96be\u53d1\u73b0\u5176\u4e2d\u7684 Service \u5bf9\u8c61\u6ca1 \u6709\u53d1\u751f\u4efb\u4f55\u53d8\u5316\uff0c\u4e24\u4e2a Deployment \u5bf9\u8c61\u5219\u6709\u5f88\u5927\u7684\u6539\u53d8\uff1a apiVersion: v1 kind: Service metadata: name: flaskapp labels: app: flaskapp spec: selector: app: flaskapp ports: - name: http port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: creationTimestamp: null name: flaskapp-v1 spec: ... sidecar.istio.io/status: '{\"version\":\"4457e141f44dbeb1708490f938c6723acfa1090eef4a5becb97e6329952a2d8d\",\"initContainers\":[\"istio-init\"],\"containers\":[\"istio-proxy\"],\"volumes\":[\"istio-envoy\",\"istio-certs\"],\"imagePullSecrets\":null}' ... spec: containers: ... - args: - proxy - sidecar ... env: ... image: docker.io/istio/proxyv2:1.1.16 imagePullPolicy: IfNotPresent name: istio-proxy ... image: docker.io/istio/proxy_init:1.1.16 imagePullPolicy: IfNotPresent name: istio-init resources: limits: cpu: 100m memory: 50Mi requests: cpu: 10m memory: 10Mi securityContext: capabilities: add: - NET_ADMIN runAsNonRoot: false runAsUser: 0 volumes: - emptyDir: medium: Memory name: istio-envoy - name: istio-certs secret: optional: true secretName: istio.default status: {} ... \u6211\u4eec\u4f1a\u53d1\u73b0\u591a,\u4e00\u4e2a\u88ab\u5c61\u6b21\u63d0\u5230\u7684 sidecar \u5bb9\u5668\u4e95\u4e14\u51fa\u73b0\u4e86\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668 (init-containers) \u8fd9\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u5c31\u662f\u7528\u6765\u52ab\u6301\u5e94\u7528\u5230 Sidecar \u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u4f7f\u7528 kubectl \u5c06\u6ce8\u4eba\u540e\u7684YAML\u6e05\u5355\u6587\u4ef6\u63d0\u4ea4\u5230\u96c6\u7fa4\u91cc\u4e0a\u8fd0\u884c\u4e86 $ kubectl apply -f flask.istio.injected.yaml service/flaskapp unchanged deployment.extensions/flaskapp-v1 configured deployment.extensions/flaskapp-v2 configured \u9664\u4e86\u652f\u6301\u624b\u5de5\u6ce8\u4eba, Istio \u8fd8\u652f\u6301\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u81ea\u52a8\u6ce8\u4eba,\u5e76\u5bf9\u5f85\u6ce8\u4eba\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6709\u4e00\u5b9a\u7684\u8981\u6c42 \u56e0\u4e3a istioctl \u8981\u6839\u636e configmap \u6765\u83b7\u53d6\u6ce8\u5165\u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u8bf4\u6267\u884c Istioctl \u7684\u7528\u6237\u5fc5\u987b\u80fd\u591f\u8bbf\u95ee\u5b89\u88c5\u4e86Istio\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u8fd9\u4e2a ConfigMap \u3002 \u5982\u679c\u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u65e0\u6cd5\u8bbf\u95ee\uff0c\u5219\u8fd8\u53ef\u4ee5\u5728 istioctl \u4e2d\u4f7f\u7528\u4e00\u4e2a\u672c\u5730\u7684\u914d\u7f6e\u6587\u4ef6\u3002 \u9996\u5148\u7528\u6709 ConfigMap \u83b7\u53d6\u6743\u9650\u7684\u7528\u6237\u8eab\u4efd\u8fd0\u884c\u5982\u4e0b\u547d\u4ee4 \uff1a $ kubectl -n istio-system get configmap istio-sidecar-injector -o=jsonpath='{.data.config}' > inject-config.yaml \u7136\u540e\u53ef\u4ee5\u5bf9\u8be5\u6587\u4ef6\u8fdb\u884c\u4efb\u610f\u4fee\u6539\uff0c\u5c31\u53ef\u4ee5\u5728 istioctl \u4e2d\u4f7f\u7528\u4e86\uff1a $ istioctl kube-inject --injectConfigFile inject-config.yaml 1-1 \u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8981\u6c42 \u76ee\u524d\u652f\u6301\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7c7b\u578b\u5305\u62ec\uff1a Job \u3001 DaemonSet \u3001 ReplicaSet \u3001 Pod \u53ca Deployment . \u5bf9\u8fd9\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8981\u6c42\u5982\u4e0b\u3002 1.\u8981\u6b63\u786e\u547d\u540d\u670d\u52a1\u7aef\u53e3 Service \u5bf9\u8c61\u4e2d\u7684 Port \u90e8\u5206\u5fc5\u987b\u4ee5\u201c\u534f\u8bae\u540d\u201d\u4e3a\u524d\u7f00\uff0c\u76ee\u524d\u652f\u6301\u7684\u534f\u8bae\u540d\u5305\u62ec http \u3001 http2 \u3001 mongo \u3001 redis \u548c grpc \uff0c\u4f8b\u5982\uff0c\u6211\u4eec\u7684 flaskapp \u4e2d\u7684\u670d\u52a1\u7aef\u53e3\u5c31\u88ab\u547d\u540d \u4e3a \u201chttp\" \u3002 Istio \u4f1a\u6839\u636e\u8fd9\u4e9b\u547d\u540d\u6765\u786e\u5b9a\u4e3a\u8fd9\u4e9b\u7aef\u53e3\u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u670d\u52a1\uff0c\u4e0d\u7b26\u5408\u547d\u540d\u89c4\u8303\u7684\u7aef\u53e3\u4f1a\u88ab\u5f53\u4f5c TCP \u670d\u52a1\uff0c\u5176\u529f\u80fd\u652f\u6301\u8303\u56f4\u4f1a\u5927\u5e45\u7f29\u5c0f\u3002 \u76ee\u524d\u7684 Istio \u7248\u672c\u5bf9 HTTP , HTTP2 \u53ca gRPC \u534f\u8bae\u90fd\u63d0\u4f9b\u4e86\u6700\u5927\u8303\u56f4\u7684\u652f\u6301\u3002 2.\u5de5\u4f5c\u8d1f\u8f7d\u7684Pod\u5fc5\u987b\u6709\u5173\u8054\u7684 Service \u4e3a\u4e86\u6ee1\u8db3\u670d\u52a1\u53d1\u73b0\u7684\u9700\u8981\uff0c\u6240\u6709 Pod \u90fd\u5fc5\u987b\u6709\u5173\u8054\u7684\u670d\u52a1\uff0c\u56e0\u6b64\u6211\u4eec\u7684\u5ba2\u6237\u7aef\u5e94\u7528 sleep \u867d\u7136\u6ca1\u6709\u5f00\u653e\u4efb\u4f55\u7aef\u53e3\uff0c\u4f46\u8fd8\u662f\u8981\u6ce8\u518c\u4e00\u4e2a Service \u5bf9\u8c61\u3002 \u53e6\u5916\uff0c\u5b98\u65b9\u5efa\u8bae\u4e3a Pod \u6a21\u677f\u52a0\u5165\u4e24\u4e2a\u6807\u7b7e\uff1a app \u548c version \uff0c\u5206\u522b\u6807\u6ce8\u5e94\u7528\u540d\u79f0\u548c\u7248\u672c\u3002\u8fd9\u4ec5\u4ec5\u662f\u4e2a\u5efa\u8bae\uff0c\u4f46\u662f Istio \u7684\u5f88\u591a\u9ed8\u8ba4\u7b56\u7565\u90fd\u4f1a\u5f15\u7528\u8fd9\u4e24\u4e2a\u6807\u7b7e\uff1b\u5982\u679c\u6ca1\u6709\u8fd9\u4e24\u4e2a\u6807\u7b7e\uff0c\u5c31\u4f1a\u5f15\u53d1\u5f88\u591a\u4e0d\u5fc5\u8981\u7684\u9ebb\u70e6\u3002 1-2 \u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8981\u6c42\u4f7f\u7528\u81ea\u52a8\u6ce8\u5165 \u9664\u4e86\u4f7f\u7528 istioctl \u8fdb\u884c\u624b\u5de5\u6ce8\u5165\uff0c Istio \u8fd8\u63d0\u4f9b\u4e86\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff0c\u8be5\u529f\u80fd\u63d0\u4f9b\u4e86\u8f83\u4e3a\u4e30\u5bcc\u7684\u5fae\u8c03\u9009\u9879\uff0c\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u66f4\u7075\u6d3b\u5730\u9009\u62e9\u6ce8\u4eba\u76ee\u6807\u3002 \u5728 values.yaml \u4e2d\u9ed8\u8ba4\u5305\u542b\u5982\u4e0b\u6240\u793a\u7684\u7c7b\u4f3c\u4ee3\u7801\uff0c\u53ef\u4ee5\u7528\u4e8e\u8c03\u6574\u81ea\u52a8\u6ce8\u4eba\u7684\u5c5e\u6027\uff1a autoInject: enabled sidecarInjectorWebhook: enabled: true replicaCount: 1 image: sidecar_injector enableNamespacesByDefault: false \u4e0b\u9762\u5bf9\u4ee5\u4e0a\u8fd9\u6bb5\u4ee3\u7801\u8fdb\u884c\u8bb2\u89e3\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u5982\u679c\u5c06 sidecarInjectorWebhook.enabled \u8bbe\u7f6e\u4e3a true \uff0c\u5c31\u4f1a\u5f00\u542f Sidecar \u7684\u81ea\u52a8\u6ce8\u5165\u7279\u6027\u3002 \u5982\u679c\u5c06 enableNamespacesByDefault \u53d8\u91cf\u8d4b\u503c\u4e3a true \uff0c\u5c31\u4f1a\u4e3a\u6240\u6709\u547d\u540d\u7a7a\u95f4\u5f00\u542f\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff1b\u5982\u679c\u8d4b\u503c\u4e3a false \uff0c\u5219\u53ea\u6709\u6807\u7b7e\u4e3a istio-injection: enabled \u7684\u547d\u540d\u7a7a\u95f4\u624d\u4f1a\u5f00\u542f\u81ea\u52a8\u6ce8\u5165\u529f\u80fd\u3002 autoInject \u8fd9\u4e2a\u53d8\u91cf\u547d\u540d\u6709\u6b67\u4e49\uff0c\u5b83\u7684 enabled/disabled \u8d4b\u503c\uff0c\u8bbe\u7f6e\u7684\u5e76\u4e0d\u662f\u662f\u5426\u5f00\u542f\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff0c\u800c\u662f\u5728\u542f\u7528\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\u4e4b\u540e\uff0c\u5bf9\u4e8e\u6307\u5b9a\u7684\u547d\u540d\u7a7a\u95f4\u5185\u65b0\u5efa\u7684 Pod \u662f\u5426\u8fdb\u884c\u81ea\u52a8\u6ce8\u5165\u3002 \u5982\u679c\u53d6\u503c\u4e3a enabled \uff0c\u5219\u8be5\u547d\u540d\u7a7a\u95f4\u5185\u7684 Pod \u53ea\u8981\u6ca1\u6709\u88ab\u6ce8\u89e3\u4e3a sidecar.istio.io/inject: \"false\" \uff0c\u5c31\u4f1a\u81ea\u52a8\u5b8c\u6210\u6ce8\u4eba\uff1b \u5982\u679c\u53d6\u503c\u4e3a disabled \uff0c\u5219\u9700\u8981\u4e3a Pod \u8bbe\u7f6e\u6ce8\u89e3 sidecar.istio.io/inject: \"true\" , \u624d\u4f1a\u8fdb\u884c\u6ce8\u5165\u3002 autoInject \u3001\u547d\u540d\u7a7a\u95f4\u6807\u7b7e\u53ca Pod \u6ce8\u89e3\u76f8\u4e92\u5173\u8054\uff0c\u5f62\u6210\u4e86\u975e\u5e38\u7075\u6d3b\u7684\u6ce8\u5165\u89c4\u5219\u3002\u5982\u56fe\u6240\u793a\u4e3a\u5404\u79cd\u7ec4\u5408\u4ea7\u751f\u7684\u6548\u679c\u5217\u8868\uff08\u547d\u540d\u7a7a\u95f4\u7b26\u5408\u6761\u4ef6\u6307\u7684\u662f\u547d\u540d\u7a7a\u95f4\u88ab\u8bbe\u7f6e\u4e86\u6ce8\u5165\u6807\u7b7e\uff0c\u6216\u8005 enableNamespacesByDefault: true ) \u63a5\u4e0b\u6765\u6d4b\u8bd5\u8fd9\u4e2a\u529f\u80fd\u3002\u9ed8\u8ba4\u5b89\u88c5\u7684 Istio (\u4e5f\u5c31\u662f\u4f7f\u7528 \"-f istio/valus.yaml \u9009\u9879\u751f\u6210\u7684\u5b89\u88c5\u6e05\u5355\uff09\u542f\u7528\u4e86\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd, \u53ea\u8981\u4e3a\u547d\u540d\u7a7a\u95f4\u8bbe\u7f6e\u6ce8\u4eba\u6807\u7b7e, \u5e76\u4e14\u5c06 autoInject \u8bbe\u7f6e\u4e3a enabled \u3002\u6839\u636e\u5728\u8be5\u547d\u540d\u7a7a\u5bc2\u4e2d\u521b\u5efa\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5c31\u4f1a\u88ab\u81ea\u52a8\u6ce8\u4eba Sidecar \u4e86 $ kubectl create ns auto namespace/auto created $ kubectl label namespaces auto istio-injection=enabled \u2764\ufe0f\u2764\ufe0f\u2764\ufe0f namespace/auto labeled $ kubectl create ns manually namespace/manually created \u8fd9\u6837\u5c31\u521b\u5efa\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u5176\u4e2d\u7684 auto \u547d\u540d\u7a7a\u95f4\u88ab\u8bbe\u7f6e\u4e86 istio-injction=enabled \u6807\u7b7e \u63a5\u4e0b\u6765\u5206\u522b\u5728\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u4f7f\u7528 sleep.yaml \u521b\u5efa\u5de5\u4f5c\u8d1f\u8f7d\u770b\u770b\u4ea7\u751f\u7684 Pod apiVersion: v1 kind: Service metadata: name: sleep labels: app: sleep version: v1 spec: selector: app: sleep version: v1 ports: - name: ssh port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep spec: replicas: 1 template: metadata: labels: app: sleep version: v1 spec: containers: - name: sleep image: dustise/sleep imagePullPolicy: Always --- $ kubectl create -f sleep.yaml -n auto service/sleep created deployment.extensions/sleep created $ kubectl get pod -n auto NAME READY STATUS RESTARTS AGE sleep-6c9c898f6c-b7scw 2/2 Running 0 28s $ kubectl create -f sleep.yaml -n manually service/sleep created deployment.extensions/sleep created \u901a\u8fc7\u5bf9\u6bd4\u53ef\u4ee5\u770b\u51fa, auto \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fc7\u7a0b\uff1b Pod \u88ab\u6ce8\u4eba\u4e86 Sidecar \u5e76\u5f00\u59cb\u4e86\u521d\u59cb\u8fc7\u7a0b; \u800c manually \u547d\u540d\u7a7a\u95f4\u7684 Pod \u4fdd\u6301\u539f\u6837 \uff0c\u6ca1\u6709\u8fdb\u884c\u6ce8\u5165 \u4e0d\u7ba1\u662f\u624b\u5de5\u6ce8\u4eba\u8fd8\u662f\u81ea\u52a8\u6ce8\u4eba\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u7f16\u8f91 Istio system \u547d\u540d\u7a7a\u95f4\u4e2d ConfigMap istio-sidecar-injector \uff0c\u6765\u5f71\u54cd\u6ce8\u4eba\u7684\u6548\u679c \u4f8b\u5982\u5728 1.1.0 \u7248\u672c\u4e2d Istio \u81ea\u52a8\u6ce8\u4eba\u53ef\u4ee5\u62a5\u636e\u6807\u7b7e\u4f8b\u5916\u8bbe\u7f6e. \u4e0d\u7ba1\u547d\u540d\u7a7a\u95f4\u6807\u7b7e\u53ca\u7b56\u7565\u5982\u4f55, \u5bf9\u7b26\u5408\u6807\u7b7e\u9009\u62e9\u5668\u8981\u6c42\u7684 Pod \u90fd\u4e0d\u8fdb\u884c\u6ce8\u5165 \u53ef\u4ee5\u5728 istio-sidecar-injector Configmap \u4e2d\u52a0\u5165\u8fd9\u4e00\u4f8b\u5916\u8bbe\u7f72 istio/templates/sidecar-injector-configmap.yaml $ kubectl -n istio-system describe configmap istio-sidecar-injector apiVersion: v1 kind: ConfigMap metadata: name: istio-sidecar-injector data: config: |- policy: enabled neverInjectSelector: - matchExpressions: - {key: openshift.io/build.name, operator: Exists} - matchExpressions: - {key: openshift.io/deployer-pod-for.name, operator: Exists} template: |- initContainers: ... \u5982\u4e0a\u6240\u793a\u7684 neverInjectSelector \u5b57\u6bb5\u662f\u4e00\u4e2a Kubernetes \u6807\u7b7e\u9009\u62e9\u5668\u7684\u6570\u7ec4\u3002 \u4e0d\u540c\u5143\u7d20\u4e4b\u95f4\u662f \u201c\u6216\u201d \u7684\u5173\u7cfb\uff0c\u5728\u7b2c\u4e00\u6b21\u53d1\u73b0\u6709\u7b26\u5408\u6761\u4ef6\u7684\u6807\u7b7e\u4e4b\u540e\u4f1a\u8df3\u8fc7\u5176\u4ed6\u5224\u65ad\u3002 \u4e0a\u9762\u7684\u8bed\u53e5\u610f\u5473\u7740\uff1a\u5bf9\u4e8e\u5305\u542b openshift.io/build.name \u6216\u8005 openshift.io/deployer-pod-for.name \u6807\u7b7e\u7684 Pod \uff0c\u4e0d\u7ba1\u6807\u7b7e\u53d6\u503c\u662f\u4ec0\u4e48\uff0c\u90fd\u4e0d\u4f1a\u8fdb\u884c\u6ce8\u5165\u3002 \u4e0e\u4e4b\u76f8\u5bf9\u7684\u8fd8\u6709\u4e00\u4e2a alwaysInjectSelector \u6807\u7b7e\uff0c\u7b26\u5408\u8fd9\u4e00\u9009\u62e9\u5668\u7684 Pod \uff0c\u4e0d\u7ba1\u5168\u5c40\u7b56\u7565\u5982\u4f55\uff0c\u90fd\u4f1a\u88ab\u6ce8\u4eba Sidecar . \u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c Pod \u6ce8\u89e3\u8fd8\u6709\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7\uff0c\u4e00\u5982\u679c Pod \u6ce8\u89e3\u5305\u542b sidecar.istio.io/inject: \"true/false\" \uff0c\u5219\u4f1a\u88ab\u4f18\u5148\u5904\u7406\u3002 \u6240\u4ee5\uff0c\u81ea\u52a8\u6ce8\u4eba\u7684\u8bc4\u4f30\u987a\u5e8f\u662f\uff1a Pod\u6ce8\u89e3 -> NeverInjectSelector \u4e00> Always InjsectSelector \u4e00> \u547d\u540d\u7a7a\u95f4\u7b56\u7565 \u5982\u679c\u6309\u7167\u524d\u9762\u7684\u4ecb\u7ecd\u8fdb\u884c\u64cd\u4f5c\uff0c\u4f8b\u5982\u7ed9\u547d\u540d\u7a7a\u95f4\u6253\u6807\u7b7e\uff0c\u5219\u7ed3\u679c\u662fPod\u6ca1\u6709\u88ab\u6ce8\u4eba\u3002\u6216\u8005\u521a\u597d\u76f8\u53cd\uff0c Pod \u660e\u660e\u88ab\u6ce8\u89e3\u4e3a sidecar.istio.io/inject: \"false\" \uff0c\u8fd8\u662f\u88ab\u6ce8\u4eba\u4e86\u3002\u8fd9\u662f\u4e3a\u4ec0\u4e48\uff1f \u53ef\u4ee5\u770b\u770b sidecar-injector Pod \u7684\u65e5\u5fd7\uff1a $ pod=$(kubectl -n istio-system get pods -l istio=sidecar-injector -o jsonpath='{.items[0].metadata.name}') $ echo $pod istio-sidecar-injector-6b57b9cbd-dd4qt $ kubectl logs $pod -n istio-system \u7136\u540e\u53ef\u4ee5\u521b\u5efa\u4e1a\u52a1Pod\u770b\u770b\u65e5\u5fd7\u8f93\u51fa\u7684\u5176\u4f53\u5185\u5bb9, \u8981\u770b\u5230\u66f4\u8be6\u7ec6\u7684\u65e5\u5fd7\uff08\u7ecf\u5e38\u4f1a\u5f88\u6709\u7528\uff09\u5219\u53ef\u4ee5\u7f16\u8f91 sidecar-iniector Deployment \u5bf9\u8c61, \u7ed9\u5b83\u52a0\u4e0a\u53c2\u6570 \"--log_output_level=default:debug\" ; $ kubectl -n istio-system edit deployment istio-sidecar-injector ... containers: - args: - --caCertFile=/etc/istio/certs/root-cert.pem - --tlsCertFile=/etc/istio/certs/cert-chain.pem - --tlsKeyFile=/etc/istio/certs/key.pem - --injectConfig=/etc/istio/inject/config - --meshConfig=/etc/istio/config/mesh - --healthCheckInterval=2s - --healthCheckFile=/health - --log_output_level=default:debug ... \u7f16\u8f91\u6210\u529f\u540e pod \u4f1a\u91cd\u542f $ pod=$(kubectl -n istio-system get pods -l istio=sidec ar-injector -o jsonpath='{.items[0].metadata.name}') $ echo $pod istio-sidecar-injector-77dfb5c66b-lzb8p $ kubectl logs $pod -n istio-system ... :{\\\"matchLabels\\\":{\\\"istio-injection\\\":\\\"enabled\\\"}},\\ ... \u5982\u679c\u5728\u65e5\u5fd7\u4e2d\u8fd8\u662f\u627e\u4e0d\u5230\u53d1\u751f\u95ee\u9898\u7684\u539f\u56e0\uff0c\u5c31\u4ee3\u8868 side-injector \u6ca1\u6709\u6536\u5230Pod\u521b\u5efa\u7684\u901a\u77e5\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u89e6\u53d1\u81ea\u52a8\u6ce8\u5165\u7684\u64cd\u4f5c\u4e86 \u8fd9\u53ef\u80fd\u662f\u56e0\u4e3a\u547d\u540d\u7a7a\u95f4\u6ca1\u6709\u6b63\u786e\u8bbe\u7f6e\u6807\u7b7e\u5bfc\u81f4\u7684\uff0c\u56e0\u6b64\u9700\u8981\u68c0\u67e5\u547d\u540d\u7a7a\u95f4\u7684\u6807\u7b7e\u53ca MutatingWebhookConfiguration \u7684\u914d\u7f6e \u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u547d\u540d\u7a7a\u95f4\u5e94\u8be5\u8bbe\u7f6e istio-injection=enabled \uff0c\u53ef\u4ee5\u4f7f\u7528 $ kubectl -n istio-system edit MutatinWebhookConfiguration isitio-sidecar-injector \u547d\u4ee4\u68c0\u67e5 namespaceSelecor \u5b57\u6bb5\u7684\u5185\u5bb9 \u5728\u5b8c\u6210\u6392\u67e5\u4e4b\u540e\uff0c \u53ef\u4ee5\u518d\u6b21\u7f16\u8f91 Sidecar-injector Deployment \u5bf9\u8c61\uff0c\u6e05\u9664\u65b0\u52a0\u4eba\u7684\u53c2\u6570. 1-3 \u51c6\u5907\u6d4b\u8bd5\u5e94\u7528 \u628a default namespace \u8bbe\u7f6e\u4e3a\u81ea\u52a8\u6ce8\u5165 , \u5e76\u5728\u5176\u4e2d\u8fd0\u884c flaskapp \u4ee5\u53ca sleep \u4e24\u4e2a\u7248\u672c $ kubectl label namespace default istio-injection=enabled namespace/default labeled sleep.istio.yaml apiVersion: v1 kind: Service metadata: name: sleep labels: app: sleep spec: selector: app: sleep ports: - name: ssh port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep-v1 spec: replicas: 1 template: metadata: labels: app: sleep version: v1 spec: containers: - name: sleep image: dustise/sleep imagePullPolicy: Always --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep-v2 spec: replicas: 1 template: metadata: labels: app: sleep version: v2 spec: containers: - name: sleep image: dustise/sleep imagePullPolicy: Always $ kubectl apply -f sleep.istio.yaml service/sleep created deployment.extensions/sleep-v1 created deployment.extensions/sleep-v2 created $ kubectl get pods | grep sleep sleep-v1-548d87cc5c-fg9ng 2/2 Running 0 21s sleep-v2-7c6b874968-qfkvt 2/2 Running 0 21s 2\u3001\u4fee\u6539 Istio \u914d\u7f6e Istio\u7ecf\u5e38\u6709\u53d8\u66f4\u914d\u7f6e\u7684\u9700\u6c42\uff0c \u8fd9\u65f6\u53ef\u4ee5\u7528\u201dHelm\u201c \u7684 --set \u7684\u53c2\u6570\u6765\u5b8c\u6210\u8fd9\u4e00\u4efb\u52a1 \u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\u4f1a\u5c06\u53d8\u91cf sidecarInjectorWebhook.enabled \u8d4b\u503c\u4e3a true \u4e5f\u5c31\u662f\u542f\u7528\u81ea\u52a8\u6ce8\u5165\u529f\u80fd \u5982\u679c\u60f3\u5173\u95ed\uff0c\u5219\u5728\u4e4b\u524d\u4f7f\u7528 Helm \u5b89\u88c5 Istio \u7684\u547d\u4ee4\u4e2d\u52a0\u5165 sidecarInjectorWebhook.enabled=false \u7684\u53c2\u6570\u5373\u53ef\u3002\u4f8b\u5982 $ helm template istio \\ --name istio --namespace istio-system \\ --set sidecarInjectorWebhook.enabled=false \u4ee5\u4e0a\u662f\u5bf9\u5b98\u65b9\u8bf4\u6cd5\u7684\u4e00\u4e2a\u6025\u7ed3\u4f46\u662f\u4e8b\u5b9e\u4e0a\u5e76\u6ca1\u6709\u8fd9\u4e48\u7b80\u5355, Istio \u7684 Sidecar \u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\u662f\u901a\u8fc7 Kubernetes \u7684 mutating \u63a7\u5236\u5668\u6765\u5b8c\u6210\u7684, \u5982\u679c\u542f\u7528\u4e86\u81ea\u52a8\u751f\u6548\u7684 Istio \u5b89\u88c5\u6e05\u5355\u5c31\u4f1a\u751f\u6210\u4e00\u4e2a\u540d\u79f0\u4e3a Istio-sidecar-injector \u7684 mutatingwebhookconfigurations \u7684\u5bf9\u8c61\uff0c \u5728\u8fd9\u4e2a\u5bf9\u8c61\u4e2d\u4fdd\u5b58\u7684\u5c31\u662f\u81ea\u52a8\u6ce8\u4eba\u7684\u914d\u7f6e \u62a5\u636e Helm \u548c Kubernetes \u7684\u4e0b\u4f5c\u539f\u7406\u91cd\u590d\u6267\u884c kubecet apply \u547d\u4ee4\u662f\u4e0d\u4f1a\u8fdb\u884c\u5220\u9664\u64cd\u4f5c\u7684, \u56e0\u6b64\u901a\u8fc7\u4e0a\u9762\u7684\u64cd\u4f5c\u751f\u6210\u7684\u6e05\u5355\u4e00\u65e6\u88ab\u63d0\u4ea4\uff0c \u540e\u679c\u5c31\u662f mutating \u63a7\u5236\u5668\u7ee7\u7eed\u4f7f\u7528 istio-sidecar-injector \u7684\u914d\u7f6e\u8fdb\u884c\u4e0b\u4f5c \u56e0\u6b64\u8fd9\u79cd\u65b9\u5f0f\u53ea\u9488\u5bf9\u65b0\u589e\u6216\u4fee\u6539\u64cd\u4f5c\u751f\u6548,\u5bf9\u4e8e\u5220\u9664\u64cd\u4f5c\u662f\u65e0\u6548\u7684","title":"\u7b2c\u4e94\u8282 Istio \u5e38\u7528\u529f\u80fd \uff08\u81ea\u52a8/\u624b\u52a8\u90e8\u7f72Istio\u5e94\u7528\uff09"},{"location":"chap5/5Istio_funcs/#istio-istio","text":"Istio \u5728\u5fae\u670d\u52a1\u4f53\u7cfb\u4e2d\u63d0\u4f9b\u4e86\u4e3a\u6570\u4f17\u591a\u7684\u5404\u79cd\u529f\u80fd\uff0c\u8fd9\u4e48\u591a\u529f\u80fd\u96be\u514d\u8ba9\u4eba\u773c\u82b1\u7f2d\u4e71\uff0c\u672c\u7ae0\u5c06\u4f1a\u4ece\u5728\u7f51\u683c\u4e2d\u90e8\u7f72\u5e94\u7528\u5f00\u59cb\uff0c\u5c55\u793a Istio \u7684\u5e38\u7528\u529f\u80fd\uff0c\u5305\u62ec\u57fa\u672c\u7684\u6d41\u91cf\u63a7\u5236\u3001\u5f00\u7bb1\u5373\u7528\u7684\u53ef\u89c6\u5316\u529f\u80fd\u7b49\u3002 \u672c\u7ae0\u5185\u5bb9\u6d89\u53ca Grafana , Prometheus , Jaeger \u53ca Kiali \uff0c\u90fd\u662f\u72ec\u7acb\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u5404 \u9879\u76ee\u6240\u6d89\u53ca\u7684\u5185\u5bb9\u90fd\u975e\u5e38\u4e30\u5bcc\u548c\u6df1\u5165\u3002","title":"\u7b2c\u4e94\u8282 Istio \u5e38\u7528\u529f\u80fd \uff08\u81ea\u52a8/\u624b\u52a8\u90e8\u7f72Istio\u5e94\u7528\uff09"},{"location":"chap5/5Istio_funcs/#1","text":"\u6211\u4eec\u5728\u7b2c3\u7ae0\u4e2d\u5df2\u7ecf\u4f7f\u7528\u8fc7 istioctl kube-inject \u547d\u4ee4\u6765\u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u6ce8\u4eba Istio Sidecar \uff0c\u672c\u8282\u4f1a\u7a0d\u5fae\u6df1\u4eba\u5730\u63a2\u8ba8\u8fd9\u4e2a\u529f\u80fd\u3002 \u6dfb\u52a0\u4e00\u4e2a \"-o\" \u53c2\u6570\uff0c\u5c06\u6ce8\u4eba\u7ed3\u679c\u8f93\u51fa\u4e3a\u6587\u4ef6\uff0c\u4ee5\u4fbf\u89c2\u5bdf\uff1a istioctl kube-inject -f flask.istio.yaml -o flask.istio.injected.yaml \u5728\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u591a\u51fa\u4e86\u4e00\u4e2a flask.istio.injected.yaml \u6587\u4ef6\u3002 \u6253\u5f00\u8be5\u6587\u4ef6\uff0c\u5c06\u5176\u548c\u6e90\u6587\u4ef6 flask.istio.yaml \u8fdb\u884c\u5bf9\u6bd4\uff0c\u4e0d\u96be\u53d1\u73b0\u5176\u4e2d\u7684 Service \u5bf9\u8c61\u6ca1 \u6709\u53d1\u751f\u4efb\u4f55\u53d8\u5316\uff0c\u4e24\u4e2a Deployment \u5bf9\u8c61\u5219\u6709\u5f88\u5927\u7684\u6539\u53d8\uff1a apiVersion: v1 kind: Service metadata: name: flaskapp labels: app: flaskapp spec: selector: app: flaskapp ports: - name: http port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: creationTimestamp: null name: flaskapp-v1 spec: ... sidecar.istio.io/status: '{\"version\":\"4457e141f44dbeb1708490f938c6723acfa1090eef4a5becb97e6329952a2d8d\",\"initContainers\":[\"istio-init\"],\"containers\":[\"istio-proxy\"],\"volumes\":[\"istio-envoy\",\"istio-certs\"],\"imagePullSecrets\":null}' ... spec: containers: ... - args: - proxy - sidecar ... env: ... image: docker.io/istio/proxyv2:1.1.16 imagePullPolicy: IfNotPresent name: istio-proxy ... image: docker.io/istio/proxy_init:1.1.16 imagePullPolicy: IfNotPresent name: istio-init resources: limits: cpu: 100m memory: 50Mi requests: cpu: 10m memory: 10Mi securityContext: capabilities: add: - NET_ADMIN runAsNonRoot: false runAsUser: 0 volumes: - emptyDir: medium: Memory name: istio-envoy - name: istio-certs secret: optional: true secretName: istio.default status: {} ... \u6211\u4eec\u4f1a\u53d1\u73b0\u591a,\u4e00\u4e2a\u88ab\u5c61\u6b21\u63d0\u5230\u7684 sidecar \u5bb9\u5668\u4e95\u4e14\u51fa\u73b0\u4e86\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668 (init-containers) \u8fd9\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u5c31\u662f\u7528\u6765\u52ab\u6301\u5e94\u7528\u5230 Sidecar \u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u4f7f\u7528 kubectl \u5c06\u6ce8\u4eba\u540e\u7684YAML\u6e05\u5355\u6587\u4ef6\u63d0\u4ea4\u5230\u96c6\u7fa4\u91cc\u4e0a\u8fd0\u884c\u4e86 $ kubectl apply -f flask.istio.injected.yaml service/flaskapp unchanged deployment.extensions/flaskapp-v1 configured deployment.extensions/flaskapp-v2 configured \u9664\u4e86\u652f\u6301\u624b\u5de5\u6ce8\u4eba, Istio \u8fd8\u652f\u6301\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u81ea\u52a8\u6ce8\u4eba,\u5e76\u5bf9\u5f85\u6ce8\u4eba\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6709\u4e00\u5b9a\u7684\u8981\u6c42 \u56e0\u4e3a istioctl \u8981\u6839\u636e configmap \u6765\u83b7\u53d6\u6ce8\u5165\u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u8bf4\u6267\u884c Istioctl \u7684\u7528\u6237\u5fc5\u987b\u80fd\u591f\u8bbf\u95ee\u5b89\u88c5\u4e86Istio\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u8fd9\u4e2a ConfigMap \u3002 \u5982\u679c\u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u65e0\u6cd5\u8bbf\u95ee\uff0c\u5219\u8fd8\u53ef\u4ee5\u5728 istioctl \u4e2d\u4f7f\u7528\u4e00\u4e2a\u672c\u5730\u7684\u914d\u7f6e\u6587\u4ef6\u3002 \u9996\u5148\u7528\u6709 ConfigMap \u83b7\u53d6\u6743\u9650\u7684\u7528\u6237\u8eab\u4efd\u8fd0\u884c\u5982\u4e0b\u547d\u4ee4 \uff1a $ kubectl -n istio-system get configmap istio-sidecar-injector -o=jsonpath='{.data.config}' > inject-config.yaml \u7136\u540e\u53ef\u4ee5\u5bf9\u8be5\u6587\u4ef6\u8fdb\u884c\u4efb\u610f\u4fee\u6539\uff0c\u5c31\u53ef\u4ee5\u5728 istioctl \u4e2d\u4f7f\u7528\u4e86\uff1a $ istioctl kube-inject --injectConfigFile inject-config.yaml","title":"1\u3001\u5728\u7f51\u683c\u4e2d\u90e8\u7f72\u5e94\u7528"},{"location":"chap5/5Istio_funcs/#1-1","text":"\u76ee\u524d\u652f\u6301\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7c7b\u578b\u5305\u62ec\uff1a Job \u3001 DaemonSet \u3001 ReplicaSet \u3001 Pod \u53ca Deployment . \u5bf9\u8fd9\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8981\u6c42\u5982\u4e0b\u3002 1.\u8981\u6b63\u786e\u547d\u540d\u670d\u52a1\u7aef\u53e3 Service \u5bf9\u8c61\u4e2d\u7684 Port \u90e8\u5206\u5fc5\u987b\u4ee5\u201c\u534f\u8bae\u540d\u201d\u4e3a\u524d\u7f00\uff0c\u76ee\u524d\u652f\u6301\u7684\u534f\u8bae\u540d\u5305\u62ec http \u3001 http2 \u3001 mongo \u3001 redis \u548c grpc \uff0c\u4f8b\u5982\uff0c\u6211\u4eec\u7684 flaskapp \u4e2d\u7684\u670d\u52a1\u7aef\u53e3\u5c31\u88ab\u547d\u540d \u4e3a \u201chttp\" \u3002 Istio \u4f1a\u6839\u636e\u8fd9\u4e9b\u547d\u540d\u6765\u786e\u5b9a\u4e3a\u8fd9\u4e9b\u7aef\u53e3\u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u670d\u52a1\uff0c\u4e0d\u7b26\u5408\u547d\u540d\u89c4\u8303\u7684\u7aef\u53e3\u4f1a\u88ab\u5f53\u4f5c TCP \u670d\u52a1\uff0c\u5176\u529f\u80fd\u652f\u6301\u8303\u56f4\u4f1a\u5927\u5e45\u7f29\u5c0f\u3002 \u76ee\u524d\u7684 Istio \u7248\u672c\u5bf9 HTTP , HTTP2 \u53ca gRPC \u534f\u8bae\u90fd\u63d0\u4f9b\u4e86\u6700\u5927\u8303\u56f4\u7684\u652f\u6301\u3002 2.\u5de5\u4f5c\u8d1f\u8f7d\u7684Pod\u5fc5\u987b\u6709\u5173\u8054\u7684 Service \u4e3a\u4e86\u6ee1\u8db3\u670d\u52a1\u53d1\u73b0\u7684\u9700\u8981\uff0c\u6240\u6709 Pod \u90fd\u5fc5\u987b\u6709\u5173\u8054\u7684\u670d\u52a1\uff0c\u56e0\u6b64\u6211\u4eec\u7684\u5ba2\u6237\u7aef\u5e94\u7528 sleep \u867d\u7136\u6ca1\u6709\u5f00\u653e\u4efb\u4f55\u7aef\u53e3\uff0c\u4f46\u8fd8\u662f\u8981\u6ce8\u518c\u4e00\u4e2a Service \u5bf9\u8c61\u3002 \u53e6\u5916\uff0c\u5b98\u65b9\u5efa\u8bae\u4e3a Pod \u6a21\u677f\u52a0\u5165\u4e24\u4e2a\u6807\u7b7e\uff1a app \u548c version \uff0c\u5206\u522b\u6807\u6ce8\u5e94\u7528\u540d\u79f0\u548c\u7248\u672c\u3002\u8fd9\u4ec5\u4ec5\u662f\u4e2a\u5efa\u8bae\uff0c\u4f46\u662f Istio \u7684\u5f88\u591a\u9ed8\u8ba4\u7b56\u7565\u90fd\u4f1a\u5f15\u7528\u8fd9\u4e24\u4e2a\u6807\u7b7e\uff1b\u5982\u679c\u6ca1\u6709\u8fd9\u4e24\u4e2a\u6807\u7b7e\uff0c\u5c31\u4f1a\u5f15\u53d1\u5f88\u591a\u4e0d\u5fc5\u8981\u7684\u9ebb\u70e6\u3002","title":"1-1 \u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8981\u6c42"},{"location":"chap5/5Istio_funcs/#1-2","text":"\u9664\u4e86\u4f7f\u7528 istioctl \u8fdb\u884c\u624b\u5de5\u6ce8\u5165\uff0c Istio \u8fd8\u63d0\u4f9b\u4e86\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff0c\u8be5\u529f\u80fd\u63d0\u4f9b\u4e86\u8f83\u4e3a\u4e30\u5bcc\u7684\u5fae\u8c03\u9009\u9879\uff0c\u53ef\u4ee5\u5e2e\u52a9\u7528\u6237\u66f4\u7075\u6d3b\u5730\u9009\u62e9\u6ce8\u4eba\u76ee\u6807\u3002 \u5728 values.yaml \u4e2d\u9ed8\u8ba4\u5305\u542b\u5982\u4e0b\u6240\u793a\u7684\u7c7b\u4f3c\u4ee3\u7801\uff0c\u53ef\u4ee5\u7528\u4e8e\u8c03\u6574\u81ea\u52a8\u6ce8\u4eba\u7684\u5c5e\u6027\uff1a autoInject: enabled sidecarInjectorWebhook: enabled: true replicaCount: 1 image: sidecar_injector enableNamespacesByDefault: false \u4e0b\u9762\u5bf9\u4ee5\u4e0a\u8fd9\u6bb5\u4ee3\u7801\u8fdb\u884c\u8bb2\u89e3\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u5982\u679c\u5c06 sidecarInjectorWebhook.enabled \u8bbe\u7f6e\u4e3a true \uff0c\u5c31\u4f1a\u5f00\u542f Sidecar \u7684\u81ea\u52a8\u6ce8\u5165\u7279\u6027\u3002 \u5982\u679c\u5c06 enableNamespacesByDefault \u53d8\u91cf\u8d4b\u503c\u4e3a true \uff0c\u5c31\u4f1a\u4e3a\u6240\u6709\u547d\u540d\u7a7a\u95f4\u5f00\u542f\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff1b\u5982\u679c\u8d4b\u503c\u4e3a false \uff0c\u5219\u53ea\u6709\u6807\u7b7e\u4e3a istio-injection: enabled \u7684\u547d\u540d\u7a7a\u95f4\u624d\u4f1a\u5f00\u542f\u81ea\u52a8\u6ce8\u5165\u529f\u80fd\u3002 autoInject \u8fd9\u4e2a\u53d8\u91cf\u547d\u540d\u6709\u6b67\u4e49\uff0c\u5b83\u7684 enabled/disabled \u8d4b\u503c\uff0c\u8bbe\u7f6e\u7684\u5e76\u4e0d\u662f\u662f\u5426\u5f00\u542f\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\uff0c\u800c\u662f\u5728\u542f\u7528\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\u4e4b\u540e\uff0c\u5bf9\u4e8e\u6307\u5b9a\u7684\u547d\u540d\u7a7a\u95f4\u5185\u65b0\u5efa\u7684 Pod \u662f\u5426\u8fdb\u884c\u81ea\u52a8\u6ce8\u5165\u3002 \u5982\u679c\u53d6\u503c\u4e3a enabled \uff0c\u5219\u8be5\u547d\u540d\u7a7a\u95f4\u5185\u7684 Pod \u53ea\u8981\u6ca1\u6709\u88ab\u6ce8\u89e3\u4e3a sidecar.istio.io/inject: \"false\" \uff0c\u5c31\u4f1a\u81ea\u52a8\u5b8c\u6210\u6ce8\u4eba\uff1b \u5982\u679c\u53d6\u503c\u4e3a disabled \uff0c\u5219\u9700\u8981\u4e3a Pod \u8bbe\u7f6e\u6ce8\u89e3 sidecar.istio.io/inject: \"true\" , \u624d\u4f1a\u8fdb\u884c\u6ce8\u5165\u3002 autoInject \u3001\u547d\u540d\u7a7a\u95f4\u6807\u7b7e\u53ca Pod \u6ce8\u89e3\u76f8\u4e92\u5173\u8054\uff0c\u5f62\u6210\u4e86\u975e\u5e38\u7075\u6d3b\u7684\u6ce8\u5165\u89c4\u5219\u3002\u5982\u56fe\u6240\u793a\u4e3a\u5404\u79cd\u7ec4\u5408\u4ea7\u751f\u7684\u6548\u679c\u5217\u8868\uff08\u547d\u540d\u7a7a\u95f4\u7b26\u5408\u6761\u4ef6\u6307\u7684\u662f\u547d\u540d\u7a7a\u95f4\u88ab\u8bbe\u7f6e\u4e86\u6ce8\u5165\u6807\u7b7e\uff0c\u6216\u8005 enableNamespacesByDefault: true ) \u63a5\u4e0b\u6765\u6d4b\u8bd5\u8fd9\u4e2a\u529f\u80fd\u3002\u9ed8\u8ba4\u5b89\u88c5\u7684 Istio (\u4e5f\u5c31\u662f\u4f7f\u7528 \"-f istio/valus.yaml \u9009\u9879\u751f\u6210\u7684\u5b89\u88c5\u6e05\u5355\uff09\u542f\u7528\u4e86\u81ea\u52a8\u6ce8\u4eba\u529f\u80fd, \u53ea\u8981\u4e3a\u547d\u540d\u7a7a\u95f4\u8bbe\u7f6e\u6ce8\u4eba\u6807\u7b7e, \u5e76\u4e14\u5c06 autoInject \u8bbe\u7f6e\u4e3a enabled \u3002\u6839\u636e\u5728\u8be5\u547d\u540d\u7a7a\u5bc2\u4e2d\u521b\u5efa\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5c31\u4f1a\u88ab\u81ea\u52a8\u6ce8\u4eba Sidecar \u4e86 $ kubectl create ns auto namespace/auto created $ kubectl label namespaces auto istio-injection=enabled \u2764\ufe0f\u2764\ufe0f\u2764\ufe0f namespace/auto labeled $ kubectl create ns manually namespace/manually created \u8fd9\u6837\u5c31\u521b\u5efa\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u5176\u4e2d\u7684 auto \u547d\u540d\u7a7a\u95f4\u88ab\u8bbe\u7f6e\u4e86 istio-injction=enabled \u6807\u7b7e \u63a5\u4e0b\u6765\u5206\u522b\u5728\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u4f7f\u7528 sleep.yaml \u521b\u5efa\u5de5\u4f5c\u8d1f\u8f7d\u770b\u770b\u4ea7\u751f\u7684 Pod apiVersion: v1 kind: Service metadata: name: sleep labels: app: sleep version: v1 spec: selector: app: sleep version: v1 ports: - name: ssh port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep spec: replicas: 1 template: metadata: labels: app: sleep version: v1 spec: containers: - name: sleep image: dustise/sleep imagePullPolicy: Always --- $ kubectl create -f sleep.yaml -n auto service/sleep created deployment.extensions/sleep created $ kubectl get pod -n auto NAME READY STATUS RESTARTS AGE sleep-6c9c898f6c-b7scw 2/2 Running 0 28s $ kubectl create -f sleep.yaml -n manually service/sleep created deployment.extensions/sleep created \u901a\u8fc7\u5bf9\u6bd4\u53ef\u4ee5\u770b\u51fa, auto \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fc7\u7a0b\uff1b Pod \u88ab\u6ce8\u4eba\u4e86 Sidecar \u5e76\u5f00\u59cb\u4e86\u521d\u59cb\u8fc7\u7a0b; \u800c manually \u547d\u540d\u7a7a\u95f4\u7684 Pod \u4fdd\u6301\u539f\u6837 \uff0c\u6ca1\u6709\u8fdb\u884c\u6ce8\u5165 \u4e0d\u7ba1\u662f\u624b\u5de5\u6ce8\u4eba\u8fd8\u662f\u81ea\u52a8\u6ce8\u4eba\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u7f16\u8f91 Istio system \u547d\u540d\u7a7a\u95f4\u4e2d ConfigMap istio-sidecar-injector \uff0c\u6765\u5f71\u54cd\u6ce8\u4eba\u7684\u6548\u679c \u4f8b\u5982\u5728 1.1.0 \u7248\u672c\u4e2d Istio \u81ea\u52a8\u6ce8\u4eba\u53ef\u4ee5\u62a5\u636e\u6807\u7b7e\u4f8b\u5916\u8bbe\u7f6e. \u4e0d\u7ba1\u547d\u540d\u7a7a\u95f4\u6807\u7b7e\u53ca\u7b56\u7565\u5982\u4f55, \u5bf9\u7b26\u5408\u6807\u7b7e\u9009\u62e9\u5668\u8981\u6c42\u7684 Pod \u90fd\u4e0d\u8fdb\u884c\u6ce8\u5165 \u53ef\u4ee5\u5728 istio-sidecar-injector Configmap \u4e2d\u52a0\u5165\u8fd9\u4e00\u4f8b\u5916\u8bbe\u7f72 istio/templates/sidecar-injector-configmap.yaml $ kubectl -n istio-system describe configmap istio-sidecar-injector apiVersion: v1 kind: ConfigMap metadata: name: istio-sidecar-injector data: config: |- policy: enabled neverInjectSelector: - matchExpressions: - {key: openshift.io/build.name, operator: Exists} - matchExpressions: - {key: openshift.io/deployer-pod-for.name, operator: Exists} template: |- initContainers: ... \u5982\u4e0a\u6240\u793a\u7684 neverInjectSelector \u5b57\u6bb5\u662f\u4e00\u4e2a Kubernetes \u6807\u7b7e\u9009\u62e9\u5668\u7684\u6570\u7ec4\u3002 \u4e0d\u540c\u5143\u7d20\u4e4b\u95f4\u662f \u201c\u6216\u201d \u7684\u5173\u7cfb\uff0c\u5728\u7b2c\u4e00\u6b21\u53d1\u73b0\u6709\u7b26\u5408\u6761\u4ef6\u7684\u6807\u7b7e\u4e4b\u540e\u4f1a\u8df3\u8fc7\u5176\u4ed6\u5224\u65ad\u3002 \u4e0a\u9762\u7684\u8bed\u53e5\u610f\u5473\u7740\uff1a\u5bf9\u4e8e\u5305\u542b openshift.io/build.name \u6216\u8005 openshift.io/deployer-pod-for.name \u6807\u7b7e\u7684 Pod \uff0c\u4e0d\u7ba1\u6807\u7b7e\u53d6\u503c\u662f\u4ec0\u4e48\uff0c\u90fd\u4e0d\u4f1a\u8fdb\u884c\u6ce8\u5165\u3002 \u4e0e\u4e4b\u76f8\u5bf9\u7684\u8fd8\u6709\u4e00\u4e2a alwaysInjectSelector \u6807\u7b7e\uff0c\u7b26\u5408\u8fd9\u4e00\u9009\u62e9\u5668\u7684 Pod \uff0c\u4e0d\u7ba1\u5168\u5c40\u7b56\u7565\u5982\u4f55\uff0c\u90fd\u4f1a\u88ab\u6ce8\u4eba Sidecar . \u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c Pod \u6ce8\u89e3\u8fd8\u6709\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7\uff0c\u4e00\u5982\u679c Pod \u6ce8\u89e3\u5305\u542b sidecar.istio.io/inject: \"true/false\" \uff0c\u5219\u4f1a\u88ab\u4f18\u5148\u5904\u7406\u3002 \u6240\u4ee5\uff0c\u81ea\u52a8\u6ce8\u4eba\u7684\u8bc4\u4f30\u987a\u5e8f\u662f\uff1a Pod\u6ce8\u89e3 -> NeverInjectSelector \u4e00> Always InjsectSelector \u4e00> \u547d\u540d\u7a7a\u95f4\u7b56\u7565 \u5982\u679c\u6309\u7167\u524d\u9762\u7684\u4ecb\u7ecd\u8fdb\u884c\u64cd\u4f5c\uff0c\u4f8b\u5982\u7ed9\u547d\u540d\u7a7a\u95f4\u6253\u6807\u7b7e\uff0c\u5219\u7ed3\u679c\u662fPod\u6ca1\u6709\u88ab\u6ce8\u4eba\u3002\u6216\u8005\u521a\u597d\u76f8\u53cd\uff0c Pod \u660e\u660e\u88ab\u6ce8\u89e3\u4e3a sidecar.istio.io/inject: \"false\" \uff0c\u8fd8\u662f\u88ab\u6ce8\u4eba\u4e86\u3002\u8fd9\u662f\u4e3a\u4ec0\u4e48\uff1f \u53ef\u4ee5\u770b\u770b sidecar-injector Pod \u7684\u65e5\u5fd7\uff1a $ pod=$(kubectl -n istio-system get pods -l istio=sidecar-injector -o jsonpath='{.items[0].metadata.name}') $ echo $pod istio-sidecar-injector-6b57b9cbd-dd4qt $ kubectl logs $pod -n istio-system \u7136\u540e\u53ef\u4ee5\u521b\u5efa\u4e1a\u52a1Pod\u770b\u770b\u65e5\u5fd7\u8f93\u51fa\u7684\u5176\u4f53\u5185\u5bb9, \u8981\u770b\u5230\u66f4\u8be6\u7ec6\u7684\u65e5\u5fd7\uff08\u7ecf\u5e38\u4f1a\u5f88\u6709\u7528\uff09\u5219\u53ef\u4ee5\u7f16\u8f91 sidecar-iniector Deployment \u5bf9\u8c61, \u7ed9\u5b83\u52a0\u4e0a\u53c2\u6570 \"--log_output_level=default:debug\" ; $ kubectl -n istio-system edit deployment istio-sidecar-injector ... containers: - args: - --caCertFile=/etc/istio/certs/root-cert.pem - --tlsCertFile=/etc/istio/certs/cert-chain.pem - --tlsKeyFile=/etc/istio/certs/key.pem - --injectConfig=/etc/istio/inject/config - --meshConfig=/etc/istio/config/mesh - --healthCheckInterval=2s - --healthCheckFile=/health - --log_output_level=default:debug ... \u7f16\u8f91\u6210\u529f\u540e pod \u4f1a\u91cd\u542f $ pod=$(kubectl -n istio-system get pods -l istio=sidec ar-injector -o jsonpath='{.items[0].metadata.name}') $ echo $pod istio-sidecar-injector-77dfb5c66b-lzb8p $ kubectl logs $pod -n istio-system ... :{\\\"matchLabels\\\":{\\\"istio-injection\\\":\\\"enabled\\\"}},\\ ... \u5982\u679c\u5728\u65e5\u5fd7\u4e2d\u8fd8\u662f\u627e\u4e0d\u5230\u53d1\u751f\u95ee\u9898\u7684\u539f\u56e0\uff0c\u5c31\u4ee3\u8868 side-injector \u6ca1\u6709\u6536\u5230Pod\u521b\u5efa\u7684\u901a\u77e5\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u89e6\u53d1\u81ea\u52a8\u6ce8\u5165\u7684\u64cd\u4f5c\u4e86 \u8fd9\u53ef\u80fd\u662f\u56e0\u4e3a\u547d\u540d\u7a7a\u95f4\u6ca1\u6709\u6b63\u786e\u8bbe\u7f6e\u6807\u7b7e\u5bfc\u81f4\u7684\uff0c\u56e0\u6b64\u9700\u8981\u68c0\u67e5\u547d\u540d\u7a7a\u95f4\u7684\u6807\u7b7e\u53ca MutatingWebhookConfiguration \u7684\u914d\u7f6e \u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u547d\u540d\u7a7a\u95f4\u5e94\u8be5\u8bbe\u7f6e istio-injection=enabled \uff0c\u53ef\u4ee5\u4f7f\u7528 $ kubectl -n istio-system edit MutatinWebhookConfiguration isitio-sidecar-injector \u547d\u4ee4\u68c0\u67e5 namespaceSelecor \u5b57\u6bb5\u7684\u5185\u5bb9 \u5728\u5b8c\u6210\u6392\u67e5\u4e4b\u540e\uff0c \u53ef\u4ee5\u518d\u6b21\u7f16\u8f91 Sidecar-injector Deployment \u5bf9\u8c61\uff0c\u6e05\u9664\u65b0\u52a0\u4eba\u7684\u53c2\u6570.","title":"1-2 \u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8981\u6c42\u4f7f\u7528\u81ea\u52a8\u6ce8\u5165"},{"location":"chap5/5Istio_funcs/#1-3","text":"\u628a default namespace \u8bbe\u7f6e\u4e3a\u81ea\u52a8\u6ce8\u5165 , \u5e76\u5728\u5176\u4e2d\u8fd0\u884c flaskapp \u4ee5\u53ca sleep \u4e24\u4e2a\u7248\u672c $ kubectl label namespace default istio-injection=enabled namespace/default labeled sleep.istio.yaml apiVersion: v1 kind: Service metadata: name: sleep labels: app: sleep spec: selector: app: sleep ports: - name: ssh port: 80 --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep-v1 spec: replicas: 1 template: metadata: labels: app: sleep version: v1 spec: containers: - name: sleep image: dustise/sleep imagePullPolicy: Always --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep-v2 spec: replicas: 1 template: metadata: labels: app: sleep version: v2 spec: containers: - name: sleep image: dustise/sleep imagePullPolicy: Always $ kubectl apply -f sleep.istio.yaml service/sleep created deployment.extensions/sleep-v1 created deployment.extensions/sleep-v2 created $ kubectl get pods | grep sleep sleep-v1-548d87cc5c-fg9ng 2/2 Running 0 21s sleep-v2-7c6b874968-qfkvt 2/2 Running 0 21s","title":"1-3 \u51c6\u5907\u6d4b\u8bd5\u5e94\u7528"},{"location":"chap5/5Istio_funcs/#2istio","text":"Istio\u7ecf\u5e38\u6709\u53d8\u66f4\u914d\u7f6e\u7684\u9700\u6c42\uff0c \u8fd9\u65f6\u53ef\u4ee5\u7528\u201dHelm\u201c \u7684 --set \u7684\u53c2\u6570\u6765\u5b8c\u6210\u8fd9\u4e00\u4efb\u52a1 \u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\u4f1a\u5c06\u53d8\u91cf sidecarInjectorWebhook.enabled \u8d4b\u503c\u4e3a true \u4e5f\u5c31\u662f\u542f\u7528\u81ea\u52a8\u6ce8\u5165\u529f\u80fd \u5982\u679c\u60f3\u5173\u95ed\uff0c\u5219\u5728\u4e4b\u524d\u4f7f\u7528 Helm \u5b89\u88c5 Istio \u7684\u547d\u4ee4\u4e2d\u52a0\u5165 sidecarInjectorWebhook.enabled=false \u7684\u53c2\u6570\u5373\u53ef\u3002\u4f8b\u5982 $ helm template istio \\ --name istio --namespace istio-system \\ --set sidecarInjectorWebhook.enabled=false \u4ee5\u4e0a\u662f\u5bf9\u5b98\u65b9\u8bf4\u6cd5\u7684\u4e00\u4e2a\u6025\u7ed3\u4f46\u662f\u4e8b\u5b9e\u4e0a\u5e76\u6ca1\u6709\u8fd9\u4e48\u7b80\u5355, Istio \u7684 Sidecar \u81ea\u52a8\u6ce8\u4eba\u529f\u80fd\u662f\u901a\u8fc7 Kubernetes \u7684 mutating \u63a7\u5236\u5668\u6765\u5b8c\u6210\u7684, \u5982\u679c\u542f\u7528\u4e86\u81ea\u52a8\u751f\u6548\u7684 Istio \u5b89\u88c5\u6e05\u5355\u5c31\u4f1a\u751f\u6210\u4e00\u4e2a\u540d\u79f0\u4e3a Istio-sidecar-injector \u7684 mutatingwebhookconfigurations \u7684\u5bf9\u8c61\uff0c \u5728\u8fd9\u4e2a\u5bf9\u8c61\u4e2d\u4fdd\u5b58\u7684\u5c31\u662f\u81ea\u52a8\u6ce8\u4eba\u7684\u914d\u7f6e \u62a5\u636e Helm \u548c Kubernetes \u7684\u4e0b\u4f5c\u539f\u7406\u91cd\u590d\u6267\u884c kubecet apply \u547d\u4ee4\u662f\u4e0d\u4f1a\u8fdb\u884c\u5220\u9664\u64cd\u4f5c\u7684, \u56e0\u6b64\u901a\u8fc7\u4e0a\u9762\u7684\u64cd\u4f5c\u751f\u6210\u7684\u6e05\u5355\u4e00\u65e6\u88ab\u63d0\u4ea4\uff0c \u540e\u679c\u5c31\u662f mutating \u63a7\u5236\u5668\u7ee7\u7eed\u4f7f\u7528 istio-sidecar-injector \u7684\u914d\u7f6e\u8fdb\u884c\u4e0b\u4f5c \u56e0\u6b64\u8fd9\u79cd\u65b9\u5f0f\u53ea\u9488\u5bf9\u65b0\u589e\u6216\u4fee\u6539\u64cd\u4f5c\u751f\u6548,\u5bf9\u4e8e\u5220\u9664\u64cd\u4f5c\u662f\u65e0\u6548\u7684","title":"2\u3001\u4fee\u6539Istio\u914d\u7f6e"},{"location":"chap5/6Istio_func2_grafana_prometheus/","text":"\u7b2c\u516d\u8282 \u4f7f\u7528 Istio Dashboard Grafana / Prometheus 1\u3001\u4f7f\u7528 Istio Dashboard Istio \u4e3a\u670d\u52a1\u7f51\u683c\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u89c2\u5bdf\u80fd\u529b Istio Dashboard \u662f\u4e00\u4e2a\u5305\u542b Istio \u5b9a\u5236\u6a21\u677f\u7684 Grafana(https://grafanacom/)\u3002 Grafana \u662f\u4e00\u4e2a\u901a\u7528\u7684 Dashboard \u6e90\u8f6f\u4ef6\uff0c\u652f\u6301 Elasticsearch , Zabbix \u3001 Prometheus , InfluxDB \u7b49\u591a\u79cd\u6570\u636e\u6e90\uff0c\u5e76\u63d0\u4f9b\u4e86\u6761\u5f62\u56fe\u3001\u997c\u56fe\u3001\u8868\u683c\u3001\u6298\u7ebf\u56fe\u7b49\u4e30\u5bcc\u7684\u53ef\u89c6\u5316\u7ec4\u4ef6\uff0c\u5bf9\u5176\u4e2d\u7684\u6570\u636e\u6e90\u548c\u53ef\u89c6\u5316\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\uff0c\u7528\u6237\u53ef\u4ee5\u5c06\u6570\u636e\u6e90\u548c\u53ef\u89c6\u5316\u7ec4\u4ef6\u7ed3\u5408\u8d77\u6765\u5b9a\u5236\u81ea\u5df1\u7684 Dashboard 1-1 \u542f\u7528 Grafana Istio \u5728\u9ed8\u8ba4\u6e05\u51b5\u4e0b\u662f\u6ca1\u6709\u542f\u7528 Grafana \u7684\uff0c $ helm template istio \\ --name istio --set grafana.enabled=true \\ --namespace istio-system > default-grafana.yaml $ kubectl apply -f default-grafana.yaml ... configmap/istio-grafana-custom-resources created configmap/istio-grafana-configuration-dashboards created configmap/istio-grafana created configmap/istio-statsd-prom-bridge unchanged ... 1-2 \u8bbf\u95eeGrafana \u5728\u521b\u5efa\u6210\u529f\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 kubectl port-forward \u6307\u4ee4\u5bf9 Grafana pod \u8fdb\u884c\u7aef\u53e3\u8f6c\u53d1\uff0c \u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u4e0d\u5bf9\u5916\u7f51\u5f00\u653e\u670d\u52a1\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528 Grafana $ kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}' $ kubectl -n istio-system port-forward grafana-86f89dbd84-v7rrn 3000:3000 Forwarding from 127.0.0.1:3000 -> 3000 Forwarding from [::1]:3000 -> 3000 \u63a5\u4e0b\u6765\u53ef\u4ee5\u4f7f\u7528\u6d4f\u89c8\u5668\u6253\u5f00 http://localhost:3000/ \uff0c\u5355\u51fb\u5de6\u4e0a\u89d2\u7684 Home \u94fe\u63a5\uff0c\u5728\u51fa\u73b0\u7684\u9875\u9762\u4e2d\u5355\u51fb Istio \u6587\u4ef6\u5939\uff0c\u4f1a\u5217\u51fa Istio \u7684\u5185\u7f6e Dashboard \uff0c \u5355\u51fb Istio Mesh Dashboard \u56e0\u4e3a\u6ca1\u6709\u4ea7\u751f\u4efb\u4f55\u6d41\u91cf\uff0c\u6240\u4ee5\u8fd9\u91cc\u6240\u6709\u7684\u6570\u636e\u90fd\u662f\u7a7a\u7684\uff0c\u6211\u4eec\u8fdb\u5165 sleep pod \u53bb\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf $ kubectl get pod -l app=sleep,version=v1 -o custom-columns=' Name:metadata.name' Name sleep-v1-548d87cc5c-fg9ng $ kubectl exec -it -c sleep sleep-v1-548d87cc5c-fg9ng bash bash-4.4# for i in 'seq 100';do http --body http://flaskapp/fetch?url=http://flaskapp/env/version >> /dev/null;done 1-3 \u5f00\u653e Grafana \u670d\u52a1 kubectl \u7684\u7aef\u53e3\u8f6c\u53d1\u65b9\u5f0f\u662f\u5f88\u4e0d\u7a33\u5b9a\u7684\u957f\u671f\u4f7f\u7528\u7684\u8bdd\uff0c\u53ef\u4ee5\u8003\u8651\u5bf9 Grafana \u670d \u52a1\u8fdb\u884c\u5b9a\u5236\uff0c\u4f8b\u5982\u5728 values.yaml \u4e2d\u7684 grafana \u4e00\u8282\u6709\u5982\u4e0b\u5b9a\u4e49 Grafana: enabled: false replicaCount: 1 image: repository: grafana/grafana tag: 5.2.3 persist: false storageClassName: \"\" security: enabled: false adminUser: admin adminpassword: admin service: annotations: {} name: http type: ClusterIP externalport: 3000 internalPort: 3000 \u6211\u4eec\u53ef\u4ee5\u5c06\u670d\u52a1\u7c7b\u578b\u4fee\u6539\u4e3a LoadBalancer ,\u6216\u8005\u4e3a\u5176\u521b\u5efa Ingress \u5bf9\u8c61\uff0c\u5e76\u8bbe\u7f6e\u7528\u6237\u540d\u548c\u5bc6\u7801 1-4 \u5b66\u4e60\u548c\u5b9a\u5236 Istio \u63d0\u4f9b\u4e3a\u6570\u4f17\u591a\u7684 Darsboord \u6a21\u677f\u6570\u636e\u6765\u81ea Prometheus \u670d\u52a1\u3002\u4e86\u89e3\u8fd9\u4e9b Dashboard \u7684\u6e90\u7801\u65f6\u53ef\u4ee5\u53d1\u73b0\u5f88\u591a\u6709\u7528\u7684\u67e5\u8be2\u8bed\u53e5, \u65b9\u4fbf\u65e5\u540e\u5efa\u7acb\u81ea\u5df1\u7684\u76d1\u63a7\u4f53\u7cfb, \u4f8b\u5982\u6211\u4eec\u53ef\u80fd\u66f4\u52a0\u5173\u6ce8\u7684 Istio Server Dashboard \u5c31\u5305\u542b\u4e86\u4e1a\u52a1\u5e94\u7528\u7684\u76f8\u5173\u4fe1\u606f \u5982\u679c\u6211\u4eec\u5173\u5fc3 Incoming Requests by Source And Reponse Code \u8fd9\u4e2a\u6298\u7ebf\u56fe\u7684\u7a7a\u73b0\u5c31\u53ef\u4ee5\u5355\u51fb\u8fd9\u4e2a\u533a\u57df\u6807\u9898\u53f3\u4fa7\u7684\u4e09\u89d2\u7b26\u53f7\uff0c \u5728\u5f39\u51fa\u7684\u83dc\u5355\u4e2d\u9009\u62e9 Edit ,\u4f1a\u663e\u793a\u4e00\u7ec4\u4ef6\u7684\u5b9a\u5236\u5185\u5bb9\u3002 \u663e\u793a\u7684\u5185\u5bb9\u8868\u660e\u6570\u636e\u6765\u81ea\u540d\u4e3a Prometheus \u7684\u6570\u636e\u6e90, \u4e24\u4e2a\u6307\u6807\u5217\u7684\u516c\u5f0f\u4e4b\u4e5f\u90fd\u6e05\u695a\u5730\u5c55\u793a\u51fa\u6765\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u8fbe\u4e9b\u5185\u5bb9\uff0c \u5b66\u4e60\u5404\u79cd Istio \u76d1\u63a7\u6307\u6807\u7684\u7528\u6cd5,\u516c\u5f0f\u548c\u5c55\u793a\u65b9\u6cd5\u4ee5\u4f7f\u5b9a\u5236\u81ea\u5df1\u7684 Dashboad \u5982\u679c\u5728\u4ecd\u7fa4\u5dfe\u5df2\u7ecf\u5b89\u88c5 Grafana , \u5219\u8fd8\u53ef\u4ee5\u901a\u8fc7\u53f3\u4e0a\u89d2\u5de5\u5177\u680f\u7684\u7b2c\u4e8c\u4e2a\u6309\u94ae(Share Dashboad)\u83b7\u53d6 Dashboard \u7684\u4ee3\u7801\u6e90\uff0c\u5c06\u5176\u5012\u5165\u5176\u4ed6 Grafana 2\u3001\u4f7f\u7528 Prometheus Prometheus ( https//Pprometheus.io \uff09\u662fCNCF\u4e2d\u7684\u4e00\u4e2a\u6807\u5fd7\u6027\u7684\u76d1\u63a7\u8f6f\u4ef6\u76ee\u524d\u5df2\u7ecf\u662f\u4e91\u539f\u751f\u9635\u8425\u4e2d\u76d1\u63a7\u7cfb\u7edf\u7684\u4e8b\u5b9e\u6807\u51c6\u3002\u5728 Istio \u3002\u4e2d\u5df2\u7ecf\u96c6\u6210\u4e86 Prometheus \u5c06\u5176\u7528\u4f5c\u7cfb\u7edf\u7684\u76d1\u63a7\u7ec4\u4ef6 Grafana \u53ea\u662f\u4e00\u4e2a\u53ef\u89c6\u5316\u7684\u524d\u7aef\u5176\u6570\u636e\u90fd\u6765\u81ea\u6211\u4eec\u4e5f\u9700\u8981\u76f4\u63a5\u5230 Prometheus \u4e2d\u8fdb\u884c\u4e00\u4e9b\u67e5\u8be2 Prometheus \u6765\u83b7\u53d6\u4e00\u6b64\uff0c\u6765 Dashboard \u4e2d\u6ca1\u6709\u4f53\u73b0\u7684\u4fe1\u606f\u3002 2-1 \u8bbf\u95ee Prometheus Prometheus \u670d\u52a1\u662f\u9ed8\u8ba4\u542f\u7528\u7684\u56e0\u6b64\u5728\u901a\u5e38\u6084\u51b5\u4e0b\u65e0\u987b\u989d\u5916\u64cd\u4f5c\u76f4\u63a5\u4f7f\u7528\u7aef\u53e3\u8f6c\u53d1\u5373\u53ef\u8bbf\u95ee\uff1a $ kubectl -n istio-system get pod -l app=prometheus -o custom-columns='Name:metadata.name' Name prometheus-d44645598-xh8wn $ kubectl -n istio-system port-forward prometheus-d44645598-xh8wn 9090:9090 \u7136\u540e\u7528\u6d4f\u89c8\u5668\u6253\u5f00 http://localhost:9O9O \u4f1a\u5f97\u5230 prometheus \u7684\u67e5\u8be2\u754c\u800c\u5728\u5176\u4e2d\u8f93\u4eba isito_requests_total \u5c31\u80fd\u6392\u5230\u4e00\u7cfb\u5217\u8bf7\u6c42\u7684\u603b\u6570\u6307\u6807\u503c \u70b9\u51fb Graph 2-2 \u5f00\u653ePrometheus\u670d\u52a1 \u548c Grafana \u4e00\u6837\uff0c Prometheus \u7684 Service \u4e5f\u53ef\u4ee5\u901a\u8fc7 values.yaml \u5b9a\u5236\u5bf9\u670d\u52a1\u5f00\u653e\u65b9\u5f0f\u3002","title":"\u7b2c\u516d\u8282 \u4f7f\u7528 Istio Dashboard Grafana / Prometheus"},{"location":"chap5/6Istio_func2_grafana_prometheus/#istio-dashboard-grafana-prometheus","text":"","title":"\u7b2c\u516d\u8282 \u4f7f\u7528 Istio Dashboard Grafana / Prometheus"},{"location":"chap5/6Istio_func2_grafana_prometheus/#1istio-dashboard","text":"Istio \u4e3a\u670d\u52a1\u7f51\u683c\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u89c2\u5bdf\u80fd\u529b Istio Dashboard \u662f\u4e00\u4e2a\u5305\u542b Istio \u5b9a\u5236\u6a21\u677f\u7684 Grafana(https://grafanacom/)\u3002 Grafana \u662f\u4e00\u4e2a\u901a\u7528\u7684 Dashboard \u6e90\u8f6f\u4ef6\uff0c\u652f\u6301 Elasticsearch , Zabbix \u3001 Prometheus , InfluxDB \u7b49\u591a\u79cd\u6570\u636e\u6e90\uff0c\u5e76\u63d0\u4f9b\u4e86\u6761\u5f62\u56fe\u3001\u997c\u56fe\u3001\u8868\u683c\u3001\u6298\u7ebf\u56fe\u7b49\u4e30\u5bcc\u7684\u53ef\u89c6\u5316\u7ec4\u4ef6\uff0c\u5bf9\u5176\u4e2d\u7684\u6570\u636e\u6e90\u548c\u53ef\u89c6\u5316\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u8fdb\u884c\u4e8c\u6b21\u5f00\u53d1\uff0c\u7528\u6237\u53ef\u4ee5\u5c06\u6570\u636e\u6e90\u548c\u53ef\u89c6\u5316\u7ec4\u4ef6\u7ed3\u5408\u8d77\u6765\u5b9a\u5236\u81ea\u5df1\u7684 Dashboard","title":"1\u3001\u4f7f\u7528Istio Dashboard"},{"location":"chap5/6Istio_func2_grafana_prometheus/#1-1-grafana","text":"Istio \u5728\u9ed8\u8ba4\u6e05\u51b5\u4e0b\u662f\u6ca1\u6709\u542f\u7528 Grafana \u7684\uff0c $ helm template istio \\ --name istio --set grafana.enabled=true \\ --namespace istio-system > default-grafana.yaml $ kubectl apply -f default-grafana.yaml ... configmap/istio-grafana-custom-resources created configmap/istio-grafana-configuration-dashboards created configmap/istio-grafana created configmap/istio-statsd-prom-bridge unchanged ...","title":"1-1 \u542f\u7528Grafana"},{"location":"chap5/6Istio_func2_grafana_prometheus/#1-2-grafana","text":"\u5728\u521b\u5efa\u6210\u529f\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 kubectl port-forward \u6307\u4ee4\u5bf9 Grafana pod \u8fdb\u884c\u7aef\u53e3\u8f6c\u53d1\uff0c \u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u4e0d\u5bf9\u5916\u7f51\u5f00\u653e\u670d\u52a1\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528 Grafana $ kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}' $ kubectl -n istio-system port-forward grafana-86f89dbd84-v7rrn 3000:3000 Forwarding from 127.0.0.1:3000 -> 3000 Forwarding from [::1]:3000 -> 3000 \u63a5\u4e0b\u6765\u53ef\u4ee5\u4f7f\u7528\u6d4f\u89c8\u5668\u6253\u5f00 http://localhost:3000/ \uff0c\u5355\u51fb\u5de6\u4e0a\u89d2\u7684 Home \u94fe\u63a5\uff0c\u5728\u51fa\u73b0\u7684\u9875\u9762\u4e2d\u5355\u51fb Istio \u6587\u4ef6\u5939\uff0c\u4f1a\u5217\u51fa Istio \u7684\u5185\u7f6e Dashboard \uff0c \u5355\u51fb Istio Mesh Dashboard \u56e0\u4e3a\u6ca1\u6709\u4ea7\u751f\u4efb\u4f55\u6d41\u91cf\uff0c\u6240\u4ee5\u8fd9\u91cc\u6240\u6709\u7684\u6570\u636e\u90fd\u662f\u7a7a\u7684\uff0c\u6211\u4eec\u8fdb\u5165 sleep pod \u53bb\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf $ kubectl get pod -l app=sleep,version=v1 -o custom-columns=' Name:metadata.name' Name sleep-v1-548d87cc5c-fg9ng $ kubectl exec -it -c sleep sleep-v1-548d87cc5c-fg9ng bash bash-4.4# for i in 'seq 100';do http --body http://flaskapp/fetch?url=http://flaskapp/env/version >> /dev/null;done","title":"1-2 \u8bbf\u95eeGrafana"},{"location":"chap5/6Istio_func2_grafana_prometheus/#1-3-grafana","text":"kubectl \u7684\u7aef\u53e3\u8f6c\u53d1\u65b9\u5f0f\u662f\u5f88\u4e0d\u7a33\u5b9a\u7684\u957f\u671f\u4f7f\u7528\u7684\u8bdd\uff0c\u53ef\u4ee5\u8003\u8651\u5bf9 Grafana \u670d \u52a1\u8fdb\u884c\u5b9a\u5236\uff0c\u4f8b\u5982\u5728 values.yaml \u4e2d\u7684 grafana \u4e00\u8282\u6709\u5982\u4e0b\u5b9a\u4e49 Grafana: enabled: false replicaCount: 1 image: repository: grafana/grafana tag: 5.2.3 persist: false storageClassName: \"\" security: enabled: false adminUser: admin adminpassword: admin service: annotations: {} name: http type: ClusterIP externalport: 3000 internalPort: 3000 \u6211\u4eec\u53ef\u4ee5\u5c06\u670d\u52a1\u7c7b\u578b\u4fee\u6539\u4e3a LoadBalancer ,\u6216\u8005\u4e3a\u5176\u521b\u5efa Ingress \u5bf9\u8c61\uff0c\u5e76\u8bbe\u7f6e\u7528\u6237\u540d\u548c\u5bc6\u7801","title":"1-3 \u5f00\u653eGrafana\u670d\u52a1"},{"location":"chap5/6Istio_func2_grafana_prometheus/#1-4","text":"Istio \u63d0\u4f9b\u4e3a\u6570\u4f17\u591a\u7684 Darsboord \u6a21\u677f\u6570\u636e\u6765\u81ea Prometheus \u670d\u52a1\u3002\u4e86\u89e3\u8fd9\u4e9b Dashboard \u7684\u6e90\u7801\u65f6\u53ef\u4ee5\u53d1\u73b0\u5f88\u591a\u6709\u7528\u7684\u67e5\u8be2\u8bed\u53e5, \u65b9\u4fbf\u65e5\u540e\u5efa\u7acb\u81ea\u5df1\u7684\u76d1\u63a7\u4f53\u7cfb, \u4f8b\u5982\u6211\u4eec\u53ef\u80fd\u66f4\u52a0\u5173\u6ce8\u7684 Istio Server Dashboard \u5c31\u5305\u542b\u4e86\u4e1a\u52a1\u5e94\u7528\u7684\u76f8\u5173\u4fe1\u606f \u5982\u679c\u6211\u4eec\u5173\u5fc3 Incoming Requests by Source And Reponse Code \u8fd9\u4e2a\u6298\u7ebf\u56fe\u7684\u7a7a\u73b0\u5c31\u53ef\u4ee5\u5355\u51fb\u8fd9\u4e2a\u533a\u57df\u6807\u9898\u53f3\u4fa7\u7684\u4e09\u89d2\u7b26\u53f7\uff0c \u5728\u5f39\u51fa\u7684\u83dc\u5355\u4e2d\u9009\u62e9 Edit ,\u4f1a\u663e\u793a\u4e00\u7ec4\u4ef6\u7684\u5b9a\u5236\u5185\u5bb9\u3002 \u663e\u793a\u7684\u5185\u5bb9\u8868\u660e\u6570\u636e\u6765\u81ea\u540d\u4e3a Prometheus \u7684\u6570\u636e\u6e90, \u4e24\u4e2a\u6307\u6807\u5217\u7684\u516c\u5f0f\u4e4b\u4e5f\u90fd\u6e05\u695a\u5730\u5c55\u793a\u51fa\u6765\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u8fbe\u4e9b\u5185\u5bb9\uff0c \u5b66\u4e60\u5404\u79cd Istio \u76d1\u63a7\u6307\u6807\u7684\u7528\u6cd5,\u516c\u5f0f\u548c\u5c55\u793a\u65b9\u6cd5\u4ee5\u4f7f\u5b9a\u5236\u81ea\u5df1\u7684 Dashboad \u5982\u679c\u5728\u4ecd\u7fa4\u5dfe\u5df2\u7ecf\u5b89\u88c5 Grafana , \u5219\u8fd8\u53ef\u4ee5\u901a\u8fc7\u53f3\u4e0a\u89d2\u5de5\u5177\u680f\u7684\u7b2c\u4e8c\u4e2a\u6309\u94ae(Share Dashboad)\u83b7\u53d6 Dashboard \u7684\u4ee3\u7801\u6e90\uff0c\u5c06\u5176\u5012\u5165\u5176\u4ed6 Grafana","title":"1-4 \u5b66\u4e60\u548c\u5b9a\u5236"},{"location":"chap5/6Istio_func2_grafana_prometheus/#2prometheus","text":"Prometheus ( https//Pprometheus.io \uff09\u662fCNCF\u4e2d\u7684\u4e00\u4e2a\u6807\u5fd7\u6027\u7684\u76d1\u63a7\u8f6f\u4ef6\u76ee\u524d\u5df2\u7ecf\u662f\u4e91\u539f\u751f\u9635\u8425\u4e2d\u76d1\u63a7\u7cfb\u7edf\u7684\u4e8b\u5b9e\u6807\u51c6\u3002\u5728 Istio \u3002\u4e2d\u5df2\u7ecf\u96c6\u6210\u4e86 Prometheus \u5c06\u5176\u7528\u4f5c\u7cfb\u7edf\u7684\u76d1\u63a7\u7ec4\u4ef6 Grafana \u53ea\u662f\u4e00\u4e2a\u53ef\u89c6\u5316\u7684\u524d\u7aef\u5176\u6570\u636e\u90fd\u6765\u81ea\u6211\u4eec\u4e5f\u9700\u8981\u76f4\u63a5\u5230 Prometheus \u4e2d\u8fdb\u884c\u4e00\u4e9b\u67e5\u8be2 Prometheus \u6765\u83b7\u53d6\u4e00\u6b64\uff0c\u6765 Dashboard \u4e2d\u6ca1\u6709\u4f53\u73b0\u7684\u4fe1\u606f\u3002","title":"2\u3001\u4f7f\u7528Prometheus"},{"location":"chap5/6Istio_func2_grafana_prometheus/#2-1-prometheus","text":"Prometheus \u670d\u52a1\u662f\u9ed8\u8ba4\u542f\u7528\u7684\u56e0\u6b64\u5728\u901a\u5e38\u6084\u51b5\u4e0b\u65e0\u987b\u989d\u5916\u64cd\u4f5c\u76f4\u63a5\u4f7f\u7528\u7aef\u53e3\u8f6c\u53d1\u5373\u53ef\u8bbf\u95ee\uff1a $ kubectl -n istio-system get pod -l app=prometheus -o custom-columns='Name:metadata.name' Name prometheus-d44645598-xh8wn $ kubectl -n istio-system port-forward prometheus-d44645598-xh8wn 9090:9090 \u7136\u540e\u7528\u6d4f\u89c8\u5668\u6253\u5f00 http://localhost:9O9O \u4f1a\u5f97\u5230 prometheus \u7684\u67e5\u8be2\u754c\u800c\u5728\u5176\u4e2d\u8f93\u4eba isito_requests_total \u5c31\u80fd\u6392\u5230\u4e00\u7cfb\u5217\u8bf7\u6c42\u7684\u603b\u6570\u6307\u6807\u503c \u70b9\u51fb Graph","title":"2-1 \u8bbf\u95eePrometheus"},{"location":"chap5/6Istio_func2_grafana_prometheus/#2-2-prometheus","text":"\u548c Grafana \u4e00\u6837\uff0c Prometheus \u7684 Service \u4e5f\u53ef\u4ee5\u901a\u8fc7 values.yaml \u5b9a\u5236\u5bf9\u670d\u52a1\u5f00\u653e\u65b9\u5f0f\u3002","title":"2-2 \u5f00\u653ePrometheus\u670d\u52a1"},{"location":"chap5/7Istio_fun3_Jager/","text":"\u7b2c\u4e03\u8282 \u4f7f\u7528 Istio Dashboard Jaeger ( https://github.com/jaegertracing/jaeger \uff09\u662f\u4e00\u4e2a\u7528\u4e8e\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7684\u5f00\u6e90\u8f6f\u4ef6\u3002 \u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u5f80\u5f80\u6bd4\u8f83\u590d\u6742\uff0c\u5728\u6df1\u5ea6\u548c\u5e7f\u5ea6\u65b9\u9762\u90fd\u4f1a\u6709\u8f83\u957f\u7684\u8c03\u7528\u8def\u7ebf\uff0c\u56e0\u6b64\u9700\u8981\u6709\u8de8\u670d\u52a1\u7684\u8ddf\u8e2a\u80fd\u529b\u3002 \u5728 Istio \u4e2d\u63d0\u4f9b\u4e86 Jaeger \u4f5c\u4e3a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7ec4\u4ef6\u3002 Jaeger \u4e5f\u662fCNCF\u7684\u6210\u5458\uff0c\u662f\u4e00 \u4e2a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u5de5\u5177\uff0c\u63d0\u4f9b\u4e86\u539f\u751f\u7684 OpenTracing \u652f\u6301\uff0c\u5411\u4e0b\u517c\u5bb9 ZipKin \uff0c\u540c\u65f6\u652f\u6301\u591a\u79cd\u5b58\u50a8\u540e\u7aef\u3002 \u7b80\u5355\u8bf4\u660e\u5728 Istio \u4e2d\u5982\u4f55\u67e5\u770b\u8c03\u7528\u94fe\u8def\uff0c\u4ee5\u53ca\u5982\u4f55\u8ba9\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u652f\u6301\u5206\u5e03 \u9700\u8981\u6ce8\u5ff5\u7684\u662f IstioSidecar \u4e3a\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u63d0\u4f9b\u8c03\u7528\u73af\u8282\u7684\u6570\u636e\uff0c\u8981\u652f\u6301\u6574\u6761\u94fe\u8def\uff0c \u8fd8\u9700\u8981\u6839\u636e OpenTracing \u89c4\u8303\u5bf9\u5e94\u7528\u8fdb\u884c\u6539\u5199 1\u3001 \u542f\u7528 Jaeger Jager \u9ed8\u8ba4\u5144\u4e0d\u542f\u7528\u7684 \u56e0\u6b64\u9700\u8981\u4f7f\u7528\u542f\u7528 Grafana \u7684\u7c7b\u4f3c\u65b9\u5f0f\uff0c\u8bbe\u7f6e tracing.enabled \u4e3a True $ helm init $HELM_HOME has been configured at /Users/i515190/.helm. Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster. Please note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy. To prevent this, run `helm init` with the --tiller-tls-verify flag. For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation $ helm version Client: &version.Version{SemVer:\"v2.14.2\", GitCommit:\"a8b13cc5ab6a7dbef0a58f5061bcc7c0c61598e7\", GitTreeState:\"clean\"} Server: &version.Version{SemVer:\"v2.14.2\", GitCommit:\"a8b13cc5ab6a7dbef0a58f5061bcc7c0c61598e7\", GitTreeState:\"clean\"} $ cd Istio/istio-1.1.16/install/kubernetes/helm/istio $ helm template istio --name istio --set tracing.enabled=true --namespace istio-system > default-tracing.yaml $ grep -C 2 \"enableTracing\" default-tracing.yaml disablePolicyChecks: true # Set enableTracing to false to disable request tracing. enableTracing: true # Set accessLogFile to empty string to disable access log. $ kubectl apply -f default-tracing.yaml $ kubectl get pod -n istio-system ... istio-tracing-555cf644d-h9hr9 1/1 Running 1 3d21 ... \u53ef\u4ee5\u770b\u5230\uff0c\u8be5\u670d\u52a1\u7684 Pod \u5df2\u7ecf\u5f00\u59cb\u8fd0\u884c 2\u3001 \u8bbf\u95ee Jaeger \u540c\u6837\u53ef\u4ee5\u4f7f\u7528\u7aef\u53e3 kubectl -n istio-system get pod -l app=jaeger -o custom-columns='Name:metadata.name' Name istio-tracing-555cf644d-h9hr9 $ kubectl -n istio-system port-forward istio-tracing-555cf644d-h9hr9 16686:16686 \u63a5\u4e0b\u6765\u65e2\u53ef\u4ee5\u8bbf\u95ee http://127.0.0.1:16686 ,\u6765\u67e5\u770b jaeger \u7684\u754c\u9762\uff0c \u5176\u521d\u59cb\u754c\u9762\u5982\u56fe\u6240\u793a \u53ef\u4ee5\u770b\u5230 Jaeger \u521a\u521a\u542f\u52a8, service \u65e2\u5217\u8868\u4e2d\u7684\u6570\u91cc\u662f O \u3002\u8fd9\u540c\u6837\u662f\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709\u8fd0\u884c\u6ca1\u6709\u4ea7\u751f\u8ddf\u8e2a\u7684\u6570\u636e\u5bfc\u81f4 \u53ef\u4ee5\u8fdb\u4eba sleep Pod \u4f7f\u7528\u4e4b\u524d\u7684\u65b9\u6cd5\u6765\u751f\u6210\u8d1f\u8f7d $ kubectl exec -it sleep-6c9c898f6c-gvqng -c sleep bash bash-4.4# for i in 'seq 100';do http --body http://flaskapp/env/version; done 3\u3001\u8ddf\u8e2a\u53c2\u6570\u7684\u4f20\u9012 \u524d\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u8ddf\u8e2a\u6d3b\u52a8\u5305\u542b\u4e00\u4e2a\u670d\u52a1\u7aef\u548c\u4e00\u4e2a\u5ba2\u6237\u7aef\u3002 \u5982\u679c\u8ba9\u4eec flaskapp \u518d\u6b21\u83b7\u53d6\u53e6\u4e00\u4e2a\u670d\u52a1\u7684\u5185\u5bb9\u5219\u4f1a\u53d1\u751f\u4ec0\u4e48\u5462\uff0c\u6211\u4eec\u518d\u5f15\u4eba\u4e00\u4e2a httpbin \u670d\u52a1\u6765\u8bd5\u8bd5 \u9996\u5148\u542f\u52a8\u8fd9\u4e2a\u670d\u52a1\u5e76\u7b49\u5f85\u6210\u529f\u8fd0\u884c $ cd Istio/istio-1.1.16/samples/httpbin $ kubectl apply -f httpbin.yaml service/httpbin created deployment.extensions/httpbin created $ kubectl get pods | grep httpbin httpbin-7d9d5b55b9-kzt5k 2/2 Running 0 9m36s \u63a5\u4e0b\u6765\u5728 sleep \u670d\u52a1\u7684 Pod \u53d1\u8d77\u8bf7\u6c42,\u8981\u6c42 flaskapp \u8c03\u7528 httpbin \u670d\u52a1\u7684 /get \u8def\u5f84, \u5e76\u8fd4\u56de httpbin \u7ed9\u51fa\u54cd\u5e94\uff0c \u540c\u65f6\u8981\u663e\u793a sleep \u53d1\u51fa\u7684\u8bf7\u6c42 Header \u7684\u5185\u5bb9 /# http --debug http://flaskapp/fetch_with_header?url=http://httpbin:8000/get \u6b64\u65f6\u4f1a\u53d1\u73b0\uff0c httpie \u5ba2\u6237\u7aef\u53d1\u51fa\u7684\u8bf7\u6c42 Header \u7684\u539f\u59cb\u5185\u5bb9\u4e3a requests.request(**{ \"allow_redirects\": false, \"auth\": \"None\", \"cert\": \"None\", \"data\": {}, \"files\": {}, \"headers\": { \"User-Agent\": \"HTTPie/0.9.9\" }, \"method\": \"get\", \"params\": {}, \"proxies\": {}, \"stream\": true, \"timeout\": 30, \"url\": \"http://flaskapp/fetch_with_header?url=http://httpbin:8000/get\", flaskapp \u6536\u5230\u7684\u8bf7\u6c42\u8981\u6bd4 Header \u7684\u5185\u5bb9\u590d\u6742\u7684\u591a {\"Content-Length\": \"0\", \"Host\": \"flaskapp\", \"User-Agent\": \"HTTPie/0.9.9\", \"Accept-Encoding\": \"gzip, deflate\", \"Accept\": \"*/*\", \"X-Forwarded-Proto\": \"http\", \"X-Request-Id\": \"999b9783-0b10-4140-8226-62ae1f5b15fd\", \"X-Envoy-Decorator-Operation\": \"flaskapp.default.svc.cluster.local:80/*\", \"X-Istio-Attributes\": \"....\" \"X-B3-Traceid\": \"efbd625ec2a1de04df63cf6195b6646f\", \"X-B3-Spanid\": \"df63cf6195b6646f\", \"X-B3-Sampled\": \"0\"} \"X-Envoy-Decorator-Operation\": \"flaskapp.default.svc.cluster.local:80/*\" \u4e0d\u96be\u770b\u51fa, \u591a\u51fa\u4e86\u4e00\u7cfb\u5217\u7684 X-\uff0a \u7684\u8bf7\u6c42 Header , \u5e94\u8be5\u662f Envoy \u4ee3\u7406\u5bf9\u8be5\u8bf7\u6c42\u8fdb\u884c\u4e86\u4fee\u6539\u5176\u4e2d\u5c31\u5305\u542b\u5206\u5e03\u5f0f\u8ddf\u8e2a\u6240\u9700\u8981\u7684 Request ID \u7b49\u8bf7\u6c42 Header \u540c\u65f6, \u5728\u7ecf\u8fc7\u591a\u6b21\u8bbf\u95ee\u540e,\u5982\u679c\u56de\u5230 Japer \u7684 web \u754c\u9762\uff0c\u5c31\u4f1a\u53d1\u73b0sleep\u5e94\u7528\u7684\u8ddf\u8e2a\u8bb0\u5f55\u975e\u5e38\u5c11 \u6211\u4eec\u5f53\u7136\u5e0c\u671b\u770b\u5230 sleep->flaskapp->httpbin \u7684\u5b8c\u6574\u8ddf\u8e2a\u4fe1\u606f\uff0c \u4f46\u662f OpenTracing \u6240\u4f9d\u8d56 Header \u6ca1\u6709\u4f20\u9012\uff0c \u56e0\u6b64 jager \u65e0\u6cd5\u786e\u5b9a\u8c03\u7528\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c \u53ea\u4f1a\u6709 sleep->flask \u548c flaskapp->httbin \u4e24\u7aef\u9f13\u52b1\u7684\u8ddf\u8e2a\u4fe1\u606f \u8981\u628a\u5b64\u7acb\u7684\u8ddf\u8e2a\u4fe1\u606f\u878d\u5408\u8d77\u6765\uff0c\u539f\u5219\u4e0a\u6bd4\u8f83\u7b80\u5355\uff1a\u5bf9\u4e8e\u4e2d\u95f4\u670d\u52a1\u6536\u5230\u7684\u8bf7\u6c42\uff0c \u5728\u8fdb\u884c\u4e0b\u4e00\u7ea7\u8bf7\u6c42\u65f6\uff0c\u5c06\u5176\u4e2d\u7528\u4e8e\u8ddf\u8e2a\u7684 Header \u4f20\u9012\u4e0b\u53bb\u5c31\u53ef\u4ee5\u4e86\u3002 \u7b80\u5355\u6765\u8bf4\uff0c\u5982\u679c\u5728\u8bf7\u6c42\u4e2d\u5b58\u5728\u5982\u4e0b Header \uff0c\u5c31\u9700\u8981\u8fdb\u884c\u8f6c\u53d1\uff1a x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context \u56e0\u6b64\uff0c\u6211\u4eec\u7ed9 flaskapp \u7684 Python \u3002\u4ee3\u7801\u52a0\u4eba\u4e00\u70b9\u65b0\u4e1c\u897f\uff0c\u6765\u4f20\u9012\u8fd9\u4e9b\u5185\u5bb9\uff1a ... TRACE_HEADERS = [ 'x-request-id', 'x-b3-traceid', 'x-b3-spanid', 'x-b3-parentspanid', 'x-b3-sampled', 'x-b3-flags', 'x-ot-span-context' ] ... req = Request(url, headers = new_header) res = urlopen(req).read() ... \u6211\u4eec\u65b0\u5efa\u4e86\u4e00\u4e2a URL \u8def\u5f84 \u201cfetch_with_trace\" \uff0c\u5728 flaskapp \u7684\u4ee3\u7801\u4e2d\u52a0\u4eba\u4e86\u3001 Header \u7684\u8bc6\u522b\uff0c\u4e00\u65e6\u5728\u63a5\u53d7\u7684\u8bf7\u6c42\u4e2d\u5305\u542b\u7279\u5b9a\u7684 Header \uff0c\u5c31\u5c06\u5176\u4fdd\u5b58\u4e0b\u6765\uff0c\u5e76\u5728\u4e0b\u4e00\u6b21\u8bf7\u6c42\u4e2d\u53d1\u9001\u51fa\u53bb\u3002 \u4e0b\u9762\u5c31\u7528\u8fd9\u4e2a\u65b0\u65b9\u6cd5\u6765\u6d4b\u8bd5\u4e00\u4e0b\uff0c\u770b\u770b\u7528\u65b0\u65b9\u6cd5\u5b8c\u6210\u7684\u8c03\u7528\u662f\u5426\u4f1a\u5728 Jaeger \u4e2d\u5c55\u793a\u5b8c\u6574\u7684\u8ddf\u8e2a\u4fe1\u606f\uff1a for i in 'seq 100';do http --debug http://flaskapp/fetch_with_trace?url=http://httpbin:8000/ip;done \u5355\u51fb\u8fdb\u5165\u67e5\u770b\u8be6\u7ec6\u8bb0\u5f55 \u8fd9\u6837\u5c31\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230 sleep \u7684\u8c03\u7528\u5148\u540e\u5f15\u53d1\u4e86 flaskapp \u548c httpbin \u7684\u8ddf\u8e2a\u8bb0\u5f55\u94fe\u8def\u53d8\u5f97\u5b8c\u6574\u4e86 \u5728 flaskapp \u4e2d\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a URL:\"/fetch_with_header\" \u3002\u5229\u7528\u8fd9\u4e00\u65b9\u6cd5\uff0c\u53ef\u4ee5\u770b\u5230 Header \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u53d1\u751f\u7684\u53d8\u5316 \u6211\u4eec\u53ef\u4ee5\u5728 sleep \u5bb9\u5668\u4e2d\u6d4b\u8bd5\u8fd9\u4e2a\u65b9\u6cd5\uff1a ... \"X-Request-Id\": \"b4706d04-b01a-4b46-a8a6-49969fd69412\", \"X-Envoy-Decorator-Operation\": \"flaskapp.default.svc.cluster.local:80/*\", \"X-Istio-Attributes\": \"..\", \"X-B3-Traceid\": \"bf6812da453a130b41700b913f6cd354\", \"X-B3-Spanid\": \"41700b913f6cd354\", \"X-B3-Sampled\": \"0\" ... \"X-B3-Parentspanid\": \"c47b04e9488308e5\", \"X-B3-Sampled\": \"0\" \"X-B3-Spanid\": \"037db9a260a2ede6\", \"X-B3-Traceid\": \"bf6812da453a130b41700b913f6cd354\" \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin:8000/get\" \u5728\u8f93\u51fa\u5185\u5bb9\u4e2d\u4f1a\u5305\u542b\u4e24\u7ec4 HTTP Header \uff1a \u7b2c1\u7ec4\u6765\u81ea flaskapp \uff0c\u8868\u793a sleep->flaskapp \u7684\u8bf7\u6c42\u5185\u5bb9\uff1b \u7b2c2\u7ec4\u6765\u81ea httpbin \uff0c\u8868\u793a flaskapp->httpbin \u7684\u5185\u5bb9 \u4e0d\u96be\u53d1\u73b0 : \u6211\u4eec\u6307\u5b9a\u7684 Header \u5728\u4e24\u6bb5\u8def\u5f84\u4e2d\u91cd\u590d\u51fa\u73b0\uff1b X-Request-Id \u548c X-B3-Traceid \u662f\u76f4\u63a5\u4e0b\u53d1\u7684\uff0c\u4e24\u4e2a\u670d\u52a1\u6536\u5230\u7684\u5185\u5bb9\u662f\u4e00\u81f4\u7684\uff1b \u5728 httpbin \u6536\u5230\u7684\u8ddf\u8e2a\u4fe1\u606f\u4ef6, X-B3-Parentspanid \u5c31\u7b49\u540c\u4e8e flaskapp \u53d1\u51fa X-B3-Spanid \uff0c\u8fd9\u8868\u660e\u4e86\u7236\u5b50\u5173\u7cfb\u3002 4\u3001\u5f00\u653eJaeger\u670d\u52a1 \u548c Grafana \u3001 Prometheus \u4e00\u6837\uff0c Jaege r\u540c\u6837\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u670d\u52a1\u7c7b\u578b\u7b49\u65b9\u5f0f\u5c06\u670d\u52a1\u516c\u5f00\u5230\u7f51\u683c\u5916\u90e8\uff1b\u4e0d\u540c\u7684\u662f\uff0c Jaeger \u8fd8\u76f4\u63a5\u5728 Chart \u4e2d\u63d0\u4f9b\u4e86 Ingress \u7684\u8bbe\u7f6e\u65b9\u5f0f\u3002 \u5982\u679c\u5df1\u7ecf\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e86 Ingress Controller ,\u53ef\u4ee5\u5728 values.yaml \u4e2d\u76f4\u63a5\u8bbe\u7f6e\uff1a ingress: enabled: false # Used to create an Ingress record. hosts: - jaeger.local annotations: # kubernetes.io/ingress.class: nginx # kubernetes.io/tls-acme: \"true\" tls: # Secrets must be manually created in the namespace. # - secretName: chart-example-tls # hosts: # - chart-example.local helm template \u547d\u4ee4\u4f1a\u4e3a\u8fd9\u4e9b\u8bbe\u7f6e\u751f\u6210 Ingress \u8d44\u6e90\u4ece\u800c\u5b8c\u6210 Jaeger \u670d\u52a1\u7684\u5f00\u653e","title":"\u7b2c\u4e03\u8282 \u4f7f\u7528 Istio Dashboard"},{"location":"chap5/7Istio_fun3_Jager/#istio-dashboard","text":"Jaeger ( https://github.com/jaegertracing/jaeger \uff09\u662f\u4e00\u4e2a\u7528\u4e8e\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7684\u5f00\u6e90\u8f6f\u4ef6\u3002 \u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u5f80\u5f80\u6bd4\u8f83\u590d\u6742\uff0c\u5728\u6df1\u5ea6\u548c\u5e7f\u5ea6\u65b9\u9762\u90fd\u4f1a\u6709\u8f83\u957f\u7684\u8c03\u7528\u8def\u7ebf\uff0c\u56e0\u6b64\u9700\u8981\u6709\u8de8\u670d\u52a1\u7684\u8ddf\u8e2a\u80fd\u529b\u3002 \u5728 Istio \u4e2d\u63d0\u4f9b\u4e86 Jaeger \u4f5c\u4e3a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7ec4\u4ef6\u3002 Jaeger \u4e5f\u662fCNCF\u7684\u6210\u5458\uff0c\u662f\u4e00 \u4e2a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u5de5\u5177\uff0c\u63d0\u4f9b\u4e86\u539f\u751f\u7684 OpenTracing \u652f\u6301\uff0c\u5411\u4e0b\u517c\u5bb9 ZipKin \uff0c\u540c\u65f6\u652f\u6301\u591a\u79cd\u5b58\u50a8\u540e\u7aef\u3002 \u7b80\u5355\u8bf4\u660e\u5728 Istio \u4e2d\u5982\u4f55\u67e5\u770b\u8c03\u7528\u94fe\u8def\uff0c\u4ee5\u53ca\u5982\u4f55\u8ba9\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u652f\u6301\u5206\u5e03 \u9700\u8981\u6ce8\u5ff5\u7684\u662f IstioSidecar \u4e3a\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u63d0\u4f9b\u8c03\u7528\u73af\u8282\u7684\u6570\u636e\uff0c\u8981\u652f\u6301\u6574\u6761\u94fe\u8def\uff0c \u8fd8\u9700\u8981\u6839\u636e OpenTracing \u89c4\u8303\u5bf9\u5e94\u7528\u8fdb\u884c\u6539\u5199","title":"\u7b2c\u4e03\u8282 \u4f7f\u7528 Istio Dashboard"},{"location":"chap5/7Istio_fun3_Jager/#1-jaeger","text":"Jager \u9ed8\u8ba4\u5144\u4e0d\u542f\u7528\u7684 \u56e0\u6b64\u9700\u8981\u4f7f\u7528\u542f\u7528 Grafana \u7684\u7c7b\u4f3c\u65b9\u5f0f\uff0c\u8bbe\u7f6e tracing.enabled \u4e3a True $ helm init $HELM_HOME has been configured at /Users/i515190/.helm. Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster. Please note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy. To prevent this, run `helm init` with the --tiller-tls-verify flag. For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation $ helm version Client: &version.Version{SemVer:\"v2.14.2\", GitCommit:\"a8b13cc5ab6a7dbef0a58f5061bcc7c0c61598e7\", GitTreeState:\"clean\"} Server: &version.Version{SemVer:\"v2.14.2\", GitCommit:\"a8b13cc5ab6a7dbef0a58f5061bcc7c0c61598e7\", GitTreeState:\"clean\"} $ cd Istio/istio-1.1.16/install/kubernetes/helm/istio $ helm template istio --name istio --set tracing.enabled=true --namespace istio-system > default-tracing.yaml $ grep -C 2 \"enableTracing\" default-tracing.yaml disablePolicyChecks: true # Set enableTracing to false to disable request tracing. enableTracing: true # Set accessLogFile to empty string to disable access log. $ kubectl apply -f default-tracing.yaml $ kubectl get pod -n istio-system ... istio-tracing-555cf644d-h9hr9 1/1 Running 1 3d21 ... \u53ef\u4ee5\u770b\u5230\uff0c\u8be5\u670d\u52a1\u7684 Pod \u5df2\u7ecf\u5f00\u59cb\u8fd0\u884c","title":"1\u3001 \u542f\u7528Jaeger"},{"location":"chap5/7Istio_fun3_Jager/#2-jaeger","text":"\u540c\u6837\u53ef\u4ee5\u4f7f\u7528\u7aef\u53e3 kubectl -n istio-system get pod -l app=jaeger -o custom-columns='Name:metadata.name' Name istio-tracing-555cf644d-h9hr9 $ kubectl -n istio-system port-forward istio-tracing-555cf644d-h9hr9 16686:16686 \u63a5\u4e0b\u6765\u65e2\u53ef\u4ee5\u8bbf\u95ee http://127.0.0.1:16686 ,\u6765\u67e5\u770b jaeger \u7684\u754c\u9762\uff0c \u5176\u521d\u59cb\u754c\u9762\u5982\u56fe\u6240\u793a \u53ef\u4ee5\u770b\u5230 Jaeger \u521a\u521a\u542f\u52a8, service \u65e2\u5217\u8868\u4e2d\u7684\u6570\u91cc\u662f O \u3002\u8fd9\u540c\u6837\u662f\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709\u8fd0\u884c\u6ca1\u6709\u4ea7\u751f\u8ddf\u8e2a\u7684\u6570\u636e\u5bfc\u81f4 \u53ef\u4ee5\u8fdb\u4eba sleep Pod \u4f7f\u7528\u4e4b\u524d\u7684\u65b9\u6cd5\u6765\u751f\u6210\u8d1f\u8f7d $ kubectl exec -it sleep-6c9c898f6c-gvqng -c sleep bash bash-4.4# for i in 'seq 100';do http --body http://flaskapp/env/version; done","title":"2\u3001 \u8bbf\u95eeJaeger"},{"location":"chap5/7Istio_fun3_Jager/#3","text":"\u524d\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u8ddf\u8e2a\u6d3b\u52a8\u5305\u542b\u4e00\u4e2a\u670d\u52a1\u7aef\u548c\u4e00\u4e2a\u5ba2\u6237\u7aef\u3002 \u5982\u679c\u8ba9\u4eec flaskapp \u518d\u6b21\u83b7\u53d6\u53e6\u4e00\u4e2a\u670d\u52a1\u7684\u5185\u5bb9\u5219\u4f1a\u53d1\u751f\u4ec0\u4e48\u5462\uff0c\u6211\u4eec\u518d\u5f15\u4eba\u4e00\u4e2a httpbin \u670d\u52a1\u6765\u8bd5\u8bd5 \u9996\u5148\u542f\u52a8\u8fd9\u4e2a\u670d\u52a1\u5e76\u7b49\u5f85\u6210\u529f\u8fd0\u884c $ cd Istio/istio-1.1.16/samples/httpbin $ kubectl apply -f httpbin.yaml service/httpbin created deployment.extensions/httpbin created $ kubectl get pods | grep httpbin httpbin-7d9d5b55b9-kzt5k 2/2 Running 0 9m36s \u63a5\u4e0b\u6765\u5728 sleep \u670d\u52a1\u7684 Pod \u53d1\u8d77\u8bf7\u6c42,\u8981\u6c42 flaskapp \u8c03\u7528 httpbin \u670d\u52a1\u7684 /get \u8def\u5f84, \u5e76\u8fd4\u56de httpbin \u7ed9\u51fa\u54cd\u5e94\uff0c \u540c\u65f6\u8981\u663e\u793a sleep \u53d1\u51fa\u7684\u8bf7\u6c42 Header \u7684\u5185\u5bb9 /# http --debug http://flaskapp/fetch_with_header?url=http://httpbin:8000/get \u6b64\u65f6\u4f1a\u53d1\u73b0\uff0c httpie \u5ba2\u6237\u7aef\u53d1\u51fa\u7684\u8bf7\u6c42 Header \u7684\u539f\u59cb\u5185\u5bb9\u4e3a requests.request(**{ \"allow_redirects\": false, \"auth\": \"None\", \"cert\": \"None\", \"data\": {}, \"files\": {}, \"headers\": { \"User-Agent\": \"HTTPie/0.9.9\" }, \"method\": \"get\", \"params\": {}, \"proxies\": {}, \"stream\": true, \"timeout\": 30, \"url\": \"http://flaskapp/fetch_with_header?url=http://httpbin:8000/get\", flaskapp \u6536\u5230\u7684\u8bf7\u6c42\u8981\u6bd4 Header \u7684\u5185\u5bb9\u590d\u6742\u7684\u591a {\"Content-Length\": \"0\", \"Host\": \"flaskapp\", \"User-Agent\": \"HTTPie/0.9.9\", \"Accept-Encoding\": \"gzip, deflate\", \"Accept\": \"*/*\", \"X-Forwarded-Proto\": \"http\", \"X-Request-Id\": \"999b9783-0b10-4140-8226-62ae1f5b15fd\", \"X-Envoy-Decorator-Operation\": \"flaskapp.default.svc.cluster.local:80/*\", \"X-Istio-Attributes\": \"....\" \"X-B3-Traceid\": \"efbd625ec2a1de04df63cf6195b6646f\", \"X-B3-Spanid\": \"df63cf6195b6646f\", \"X-B3-Sampled\": \"0\"} \"X-Envoy-Decorator-Operation\": \"flaskapp.default.svc.cluster.local:80/*\" \u4e0d\u96be\u770b\u51fa, \u591a\u51fa\u4e86\u4e00\u7cfb\u5217\u7684 X-\uff0a \u7684\u8bf7\u6c42 Header , \u5e94\u8be5\u662f Envoy \u4ee3\u7406\u5bf9\u8be5\u8bf7\u6c42\u8fdb\u884c\u4e86\u4fee\u6539\u5176\u4e2d\u5c31\u5305\u542b\u5206\u5e03\u5f0f\u8ddf\u8e2a\u6240\u9700\u8981\u7684 Request ID \u7b49\u8bf7\u6c42 Header \u540c\u65f6, \u5728\u7ecf\u8fc7\u591a\u6b21\u8bbf\u95ee\u540e,\u5982\u679c\u56de\u5230 Japer \u7684 web \u754c\u9762\uff0c\u5c31\u4f1a\u53d1\u73b0sleep\u5e94\u7528\u7684\u8ddf\u8e2a\u8bb0\u5f55\u975e\u5e38\u5c11 \u6211\u4eec\u5f53\u7136\u5e0c\u671b\u770b\u5230 sleep->flaskapp->httpbin \u7684\u5b8c\u6574\u8ddf\u8e2a\u4fe1\u606f\uff0c \u4f46\u662f OpenTracing \u6240\u4f9d\u8d56 Header \u6ca1\u6709\u4f20\u9012\uff0c \u56e0\u6b64 jager \u65e0\u6cd5\u786e\u5b9a\u8c03\u7528\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c \u53ea\u4f1a\u6709 sleep->flask \u548c flaskapp->httbin \u4e24\u7aef\u9f13\u52b1\u7684\u8ddf\u8e2a\u4fe1\u606f \u8981\u628a\u5b64\u7acb\u7684\u8ddf\u8e2a\u4fe1\u606f\u878d\u5408\u8d77\u6765\uff0c\u539f\u5219\u4e0a\u6bd4\u8f83\u7b80\u5355\uff1a\u5bf9\u4e8e\u4e2d\u95f4\u670d\u52a1\u6536\u5230\u7684\u8bf7\u6c42\uff0c \u5728\u8fdb\u884c\u4e0b\u4e00\u7ea7\u8bf7\u6c42\u65f6\uff0c\u5c06\u5176\u4e2d\u7528\u4e8e\u8ddf\u8e2a\u7684 Header \u4f20\u9012\u4e0b\u53bb\u5c31\u53ef\u4ee5\u4e86\u3002 \u7b80\u5355\u6765\u8bf4\uff0c\u5982\u679c\u5728\u8bf7\u6c42\u4e2d\u5b58\u5728\u5982\u4e0b Header \uff0c\u5c31\u9700\u8981\u8fdb\u884c\u8f6c\u53d1\uff1a x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context \u56e0\u6b64\uff0c\u6211\u4eec\u7ed9 flaskapp \u7684 Python \u3002\u4ee3\u7801\u52a0\u4eba\u4e00\u70b9\u65b0\u4e1c\u897f\uff0c\u6765\u4f20\u9012\u8fd9\u4e9b\u5185\u5bb9\uff1a ... TRACE_HEADERS = [ 'x-request-id', 'x-b3-traceid', 'x-b3-spanid', 'x-b3-parentspanid', 'x-b3-sampled', 'x-b3-flags', 'x-ot-span-context' ] ... req = Request(url, headers = new_header) res = urlopen(req).read() ... \u6211\u4eec\u65b0\u5efa\u4e86\u4e00\u4e2a URL \u8def\u5f84 \u201cfetch_with_trace\" \uff0c\u5728 flaskapp \u7684\u4ee3\u7801\u4e2d\u52a0\u4eba\u4e86\u3001 Header \u7684\u8bc6\u522b\uff0c\u4e00\u65e6\u5728\u63a5\u53d7\u7684\u8bf7\u6c42\u4e2d\u5305\u542b\u7279\u5b9a\u7684 Header \uff0c\u5c31\u5c06\u5176\u4fdd\u5b58\u4e0b\u6765\uff0c\u5e76\u5728\u4e0b\u4e00\u6b21\u8bf7\u6c42\u4e2d\u53d1\u9001\u51fa\u53bb\u3002 \u4e0b\u9762\u5c31\u7528\u8fd9\u4e2a\u65b0\u65b9\u6cd5\u6765\u6d4b\u8bd5\u4e00\u4e0b\uff0c\u770b\u770b\u7528\u65b0\u65b9\u6cd5\u5b8c\u6210\u7684\u8c03\u7528\u662f\u5426\u4f1a\u5728 Jaeger \u4e2d\u5c55\u793a\u5b8c\u6574\u7684\u8ddf\u8e2a\u4fe1\u606f\uff1a for i in 'seq 100';do http --debug http://flaskapp/fetch_with_trace?url=http://httpbin:8000/ip;done \u5355\u51fb\u8fdb\u5165\u67e5\u770b\u8be6\u7ec6\u8bb0\u5f55 \u8fd9\u6837\u5c31\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230 sleep \u7684\u8c03\u7528\u5148\u540e\u5f15\u53d1\u4e86 flaskapp \u548c httpbin \u7684\u8ddf\u8e2a\u8bb0\u5f55\u94fe\u8def\u53d8\u5f97\u5b8c\u6574\u4e86 \u5728 flaskapp \u4e2d\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a URL:\"/fetch_with_header\" \u3002\u5229\u7528\u8fd9\u4e00\u65b9\u6cd5\uff0c\u53ef\u4ee5\u770b\u5230 Header \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u53d1\u751f\u7684\u53d8\u5316 \u6211\u4eec\u53ef\u4ee5\u5728 sleep \u5bb9\u5668\u4e2d\u6d4b\u8bd5\u8fd9\u4e2a\u65b9\u6cd5\uff1a ... \"X-Request-Id\": \"b4706d04-b01a-4b46-a8a6-49969fd69412\", \"X-Envoy-Decorator-Operation\": \"flaskapp.default.svc.cluster.local:80/*\", \"X-Istio-Attributes\": \"..\", \"X-B3-Traceid\": \"bf6812da453a130b41700b913f6cd354\", \"X-B3-Spanid\": \"41700b913f6cd354\", \"X-B3-Sampled\": \"0\" ... \"X-B3-Parentspanid\": \"c47b04e9488308e5\", \"X-B3-Sampled\": \"0\" \"X-B3-Spanid\": \"037db9a260a2ede6\", \"X-B3-Traceid\": \"bf6812da453a130b41700b913f6cd354\" \"origin\": \"127.0.0.1\", \"url\": \"http://httpbin:8000/get\" \u5728\u8f93\u51fa\u5185\u5bb9\u4e2d\u4f1a\u5305\u542b\u4e24\u7ec4 HTTP Header \uff1a \u7b2c1\u7ec4\u6765\u81ea flaskapp \uff0c\u8868\u793a sleep->flaskapp \u7684\u8bf7\u6c42\u5185\u5bb9\uff1b \u7b2c2\u7ec4\u6765\u81ea httpbin \uff0c\u8868\u793a flaskapp->httpbin \u7684\u5185\u5bb9 \u4e0d\u96be\u53d1\u73b0 : \u6211\u4eec\u6307\u5b9a\u7684 Header \u5728\u4e24\u6bb5\u8def\u5f84\u4e2d\u91cd\u590d\u51fa\u73b0\uff1b X-Request-Id \u548c X-B3-Traceid \u662f\u76f4\u63a5\u4e0b\u53d1\u7684\uff0c\u4e24\u4e2a\u670d\u52a1\u6536\u5230\u7684\u5185\u5bb9\u662f\u4e00\u81f4\u7684\uff1b \u5728 httpbin \u6536\u5230\u7684\u8ddf\u8e2a\u4fe1\u606f\u4ef6, X-B3-Parentspanid \u5c31\u7b49\u540c\u4e8e flaskapp \u53d1\u51fa X-B3-Spanid \uff0c\u8fd9\u8868\u660e\u4e86\u7236\u5b50\u5173\u7cfb\u3002","title":"3\u3001\u8ddf\u8e2a\u53c2\u6570\u7684\u4f20\u9012"},{"location":"chap5/7Istio_fun3_Jager/#4jaeger","text":"\u548c Grafana \u3001 Prometheus \u4e00\u6837\uff0c Jaege r\u540c\u6837\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u670d\u52a1\u7c7b\u578b\u7b49\u65b9\u5f0f\u5c06\u670d\u52a1\u516c\u5f00\u5230\u7f51\u683c\u5916\u90e8\uff1b\u4e0d\u540c\u7684\u662f\uff0c Jaeger \u8fd8\u76f4\u63a5\u5728 Chart \u4e2d\u63d0\u4f9b\u4e86 Ingress \u7684\u8bbe\u7f6e\u65b9\u5f0f\u3002 \u5982\u679c\u5df1\u7ecf\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e86 Ingress Controller ,\u53ef\u4ee5\u5728 values.yaml \u4e2d\u76f4\u63a5\u8bbe\u7f6e\uff1a ingress: enabled: false # Used to create an Ingress record. hosts: - jaeger.local annotations: # kubernetes.io/ingress.class: nginx # kubernetes.io/tls-acme: \"true\" tls: # Secrets must be manually created in the namespace. # - secretName: chart-example-tls # hosts: # - chart-example.local helm template \u547d\u4ee4\u4f1a\u4e3a\u8fd9\u4e9b\u8bbe\u7f6e\u751f\u6210 Ingress \u8d44\u6e90\u4ece\u800c\u5b8c\u6210 Jaeger \u670d\u52a1\u7684\u5f00\u653e","title":"4\u3001\u5f00\u653eJaeger\u670d\u52a1"},{"location":"chap5/8Istio_func4_Kiali/","text":"\u7b2c\u516b\u8282 \u4f7f\u7528Kiali Kiali \u4ee5( https://www.kiali.com \uff09\u4e5f\u662f\u4e00\u4e2a\u7528\u4e8e Istio \u53ef\u89c6\u5316\u7684\u8f6f\u4ef6\uff0c\u540c\u524d\u9762\u7684 Grafana , Promtheus \u7b49\u901a\u7528\u8f6f\u4ef6\u4e0d\u540c Kiali \u76ee\u524d\u662f\u4e13\u7528\u4e8e Istio \u7cfb\u7edf\u7684, \u53ef\u89c6\u5316\u53ca\u8ddf\u8e2a\u7b49\u901a\u7528\u529f\u80fd, \u8fd8\u4e13\u95e8\u63d0\u4f9b\u4e86 Istio \u7684\u914d\u7f6e\u9a8c\u8bc1\uff0c\u5065\u5eb7\u8bc4\u4f30\u7684\u7b49\u9ad8\u7ea7\u529f\u80fd 1\u3001 \u542f\u7528 Kiali \u5728\u542f\u7528 Kiali \u65f6\u540c\u6837\u9700\u8981\u5bf9 values.yaml \u8fdb\u884c\u4fee\u6539\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c06 Kiali \u7684\u76f8\u5173\u53d8\u91cf\u8bbe\u7f6e\u5982\u4e0b\uff1b istio/charts/kiali/values.yaml # # addon kiali # enabled: false # Note that if using the demo or demo-auth yaml when installing via Helm, this default will be `true`. replicaCount: 1 hub: docker.io/kiali tag: v0.16 contextPath: /kiali # The root context path to access the Kiali UI. nodeSelector: {} podAntiAffinityLabelSelector: [] podAntiAffinityTermLabelSelector: [] ingress: enabled: false ## Used to create an Ingress record. hosts: - kiali.local annotations: # kubernetes.io/ingress.class: nginx # kubernetes.io/tls-acme: \"true\" tls: # Secrets must be manually created in the namespace. # - secretName: kiali-tls # hosts: # - kiali.local dashboard: secretName: kiali # You must create a secret with this name - one is not provided out-of-box. grafanaURL: # If you have Grafana installed and it is accessible to client browsers, then set this to its external URL. Kiali will redirect users to this URL when Grafana metrics are to be shown. jaegerURL: # If you have Jaeger installed and it is accessible to client browsers, then set this property to its external URL. Kiali will redirect users to this URL when Jaeger tracing is to be shown. prometheusAddr: http://prometheus:9090 # When true, a secret will be created with a default username and password. Useful for demos. createDemoSecret: false \u8981\u7b80\u5355\u542f\u7528 Kiali , \u5219\u53ea\u8bbe\u7f6e\u5176 enabled \u4e3a true \u5373\u53ef\uff0c \u4f46\u6709\u4e9b\u5730\u65b9\u9700\u8981\u7279\u522b\u6ce8\u610f\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u4e0e Jaeger \u4e00\u6837,\u53ef\u4ee5\u4e3a Kiali \u8bbe\u7f6e Ingress \u51fa\u53e3 \u548c\u5176\u4ed6\u7ec4\u4ef6\u4e00\u6837\uff0c \u5728\u8bbe\u7f6e enabled \u4e3atrue\u4e4b\u540e\u4f7f\u7528 helm template \u6e32\u67d3\uff0c kubectl apply \u547d\u4ee4\u8fdb\u884c\u5b89\u88c5 ,\u7b49\u5f85 Pod \u542f\u52a8\u6210\u529f\u5373\u53ef\u3002 \u6211\u4eec\u5728\u8fd9\u91cc\u4fee\u6539 kiali \u7684image\u5230\u6700\u65b0\u7684\u7248\u672c image: \"docker.io/kiali/kiali:v0.16\" => image: \"docker.io/kiali/kiali:v1.4.0\" $ kubectl apply -f istio-demo.yaml 2\u3001\u8bbf\u95ee Kiali \u901a\u8fc7\u7aef\u53e3\u8f6c\u53d1\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee $ kubectl -n istio-system get pod -l app=kiali -o custom-columns='Name:metadata.name' Name kiali-785fc9f67b-gc42t $ kubectl -n istio-system port-forward kiali-785fc9f67b-gc42t 20001:20001 \u4f7f\u7528\u6d4f\u89c8\u5668\u6253\u5f00\u9875\u9762\uff0c \u767b\u5f55\u9875\u9762\u7684\u9ed8\u8ba4\u7528\u6237\u540d\u548c\u5bc6\u7801\u4e3a values.yaml \u7684 tracing \u4e00\u8282\u4fee\u6539\u3002 \u5728\u767b\u5f55\u6210\u529f\u4e4b\u540e\u8fdb\u4eba\u9996\u9875\uff0c admin:admin \uff0c\u4e5f\u53ef\u4ee5\u5728\u9996\u9875\u5c55\u793a\u4e86\u76ee\u524d\u7684\u547d\u540d\u7a7a\u95f4\u4e2a\u548c\u5176\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u60c5\u51b5 http://127.0.0.1:20001/kiali/console \u5355\u51fb\u5176\u4e2d\u7684 default \u547d\u540d\u7a7a\u95ee\u4f1a\u770b\u5230\u5404\u4e2a\u670d\u52a1\u7684\u60c5\u51b5\uff0c\u5305\u62ec\u5065\u5eb7\u72b6\u51b5\u3001\u662f\u5426\u6ce8\u5165 \u5355\u51fb\u5177\u4f53\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u770b\u5230\u670d\u52a1\u76f8\u5173\u7684\u4e00\u4e9b\u6307\u6807\u5c55\u793a\uff0c\u4f8b\u5982\u67e5\u770b flaskapp-v1 \u7684\u51fa\u7ad9\u8bf7\u6c42 \u6ce8\u610f\uff0c\u8fd9\u4e9b\u56fe\u5f62\u662f\u6839\u636e\u8bbf\u95ee\u5f97\u51fa\u7684\uff0c\u5982\u679c\u4e3a\u7a7a\uff0c\u5219\u53ef\u80fd\u662f\u56e0\u4e3a\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u8303\u56f4\u5185\u6ca1\u6709\u6d41\u91cf\u6d69\u6210\u7684\u3002 \u5c1d\u8bd5\u9009\u62e9\u5408\u9002\u7684\u65f6\u95f4\u8de8\u5ea6\uff0c\u770b\u770b\u662f\u5426\u6b63\u786e\u663e\u793a\u3002 \u53ef\u4ee5\u8fdb\u4eba sleep Pod \u4f7f\u7528\u4e4b\u524d\u7684\u65b9\u6cd5\u6765\u751f\u6210\u8d1f\u8f7d $ kubectl exec -it sleep-6c9c898f6c-gvqng -c sleep bash bash-4.4# for i in 'seq 1000';do http --body http://flaskapp/env/version; done Workloads -> sleep -> Outbound Metrics \u5728 Graph \u83dc\u5355\u4e2d\u4f1a\u663e\u793a\u670d\u52a1\u7684\u62d3\u6251\u5173\u7cfb\u4f8b\u5982\u6211\u4eec\u5728\u524d\u800c\u8fdb\u884c\u6d4b\u8bd5\u65f6\u4f7f\u7528\u7684, \u51e0\u4e2a\u670d\u52a1\u90fd\u4f1a\u6709\u5982\u56fe\u6240\u793a\u7684\u663e\u793a\u6548\u679c \u8fd9\u91cc\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230\u5404\u4e2a\u670d\u52a1\u7684\u8c03\u7528\u5173\u7cfb\u548c\u6d41\u91cf\u72b6\u51b5\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u5728\u524d\u9762\u4f7f\u7528 sleep pod \u7684 Shell \u4e2d\uff0c\u4f7f\u7528 HTTP \u5ba2\u6237\u7aef\u4e00\u5de5\u5177\u901a\u8fc7 flaskapp \u5e94\u7528\u8c03\u7528 httpbin \u7684\u8fc7\u7a0b\uff0c \u5728\u8fd9\u5f20\u56fe\u4e2d\u7684\u8868\u73b0\u5c31\u5f88\u660e\u663e\u3002 \u53e6\u5916\uff0c\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u529f\u80fd\u5c31\u662fKiali\u83dc\u5355\u5de6\u4fa7\u7684 Istio Confi g\u9879\u3002\u5355\u51fb\u8fd9\u4e00\u9879\uff0c \u9009\u62e9 istio-system\u547d \u540d\u7a7a\u95f4\uff0c\u4f1a\u770b\u5230 Istio \u9ed8\u8ba4\u7684\u5404\u79cd\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684\u8bbe\u7f6e\u60c5\u51b5 \u5355\u51fb\u5176\u4e2d\u7684\u5404\u4e2a\u9879\u76ee, \u4f1a\u5c55\u793a\u8be5\u5bf9\u8c61\u7684\u5b9a\u4e49\u6587\u672c,\u5176\u4e2d\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e9b\u914d\u7f6e\u6821\u9a8c\u65b9\u9762\u7684\u529f\u80fd\u3002\u5982\u6240\u793a\u7684\u662f istio-policy \u7684 destinationrules \u3002 \u5f00\u653eKiali\u670d\u52a1 \u5728 values.yaml \u4e2d\u4e5f\u4e3a Kiali \u63d0\u4f9b\u4e86 Ingress \u7684\u914d\u7f6e\u9879\u76ee\uff0c\u56e0\u6b64\u5f00\u653e Kiali \u670d\u52a1\u7684 \u65b9\u5f0f\u548c Jaeger \u4e00\u6837\uff0c\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u670d\u52a1\u7c7b\u578b\u6216\u8bbe\u7f6e Ingress \u5c06\u670d\u52a1\u5f00\u653e\u3002 3\u3001\u5c0f\u7ed3 \u672c\u7ae0\u8bb2\u89e3\u4e86\u5982\u4f55\u5728\u7f51\u683c\u4e2d\u8fdb\u884c\u5e94\u7528\u90e8\u7f72\uff0c\u8fd8\u9010\u4e2a\u5c55\u793a\u4e86 Istio \u5e38\u7528\u53ef\u89c6\u5316\u7ec4\u4ef6\u7684\u542f\u52a8\u548c\u4f7f\u7528\u65b9\u6cd5\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u5bf9 Istio \u670d\u52a1\u7f51\u683c\u7684\u8fd0\u7ef4\u6709\u5f88\u91cd\u8981\u7684\u610f\u4e49\uff0c\u662f\u670d\u52a1\u7f51\u683c\u53ef\u89c2\u5bdf\u6027\u7684\u5177\u4f53\u8868\u73b0\u3002 Grafana , Prometheus \u53ca Jaeger \u8fd9\u4e9b\u7b2c\u4e09\u65b9\u7ec4\u4ef6\u90fd\u76f8\u5bf9\u6210\u719f\u548c\u7a33\u5b9a\uff1b Kiali \u76ee\u524d\u8fd8\u76f8\u5bf9\u5e7c\u7a1a\uff0c\u4f46\u662f\u4e5f\u770b\u5f97\u51fa\u6765 Istio \u5bf9\u5176\u529f\u80fd\u7684\u501f\u91cd\u548c\u671f\u5f85\u3002","title":"\u7b2c\u516b\u8282 \u4f7f\u7528Kiali"},{"location":"chap5/8Istio_func4_Kiali/#kiali","text":"Kiali \u4ee5( https://www.kiali.com \uff09\u4e5f\u662f\u4e00\u4e2a\u7528\u4e8e Istio \u53ef\u89c6\u5316\u7684\u8f6f\u4ef6\uff0c\u540c\u524d\u9762\u7684 Grafana , Promtheus \u7b49\u901a\u7528\u8f6f\u4ef6\u4e0d\u540c Kiali \u76ee\u524d\u662f\u4e13\u7528\u4e8e Istio \u7cfb\u7edf\u7684, \u53ef\u89c6\u5316\u53ca\u8ddf\u8e2a\u7b49\u901a\u7528\u529f\u80fd, \u8fd8\u4e13\u95e8\u63d0\u4f9b\u4e86 Istio \u7684\u914d\u7f6e\u9a8c\u8bc1\uff0c\u5065\u5eb7\u8bc4\u4f30\u7684\u7b49\u9ad8\u7ea7\u529f\u80fd","title":"\u7b2c\u516b\u8282 \u4f7f\u7528Kiali"},{"location":"chap5/8Istio_func4_Kiali/#1-kiali","text":"\u5728\u542f\u7528 Kiali \u65f6\u540c\u6837\u9700\u8981\u5bf9 values.yaml \u8fdb\u884c\u4fee\u6539\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c06 Kiali \u7684\u76f8\u5173\u53d8\u91cf\u8bbe\u7f6e\u5982\u4e0b\uff1b istio/charts/kiali/values.yaml # # addon kiali # enabled: false # Note that if using the demo or demo-auth yaml when installing via Helm, this default will be `true`. replicaCount: 1 hub: docker.io/kiali tag: v0.16 contextPath: /kiali # The root context path to access the Kiali UI. nodeSelector: {} podAntiAffinityLabelSelector: [] podAntiAffinityTermLabelSelector: [] ingress: enabled: false ## Used to create an Ingress record. hosts: - kiali.local annotations: # kubernetes.io/ingress.class: nginx # kubernetes.io/tls-acme: \"true\" tls: # Secrets must be manually created in the namespace. # - secretName: kiali-tls # hosts: # - kiali.local dashboard: secretName: kiali # You must create a secret with this name - one is not provided out-of-box. grafanaURL: # If you have Grafana installed and it is accessible to client browsers, then set this to its external URL. Kiali will redirect users to this URL when Grafana metrics are to be shown. jaegerURL: # If you have Jaeger installed and it is accessible to client browsers, then set this property to its external URL. Kiali will redirect users to this URL when Jaeger tracing is to be shown. prometheusAddr: http://prometheus:9090 # When true, a secret will be created with a default username and password. Useful for demos. createDemoSecret: false \u8981\u7b80\u5355\u542f\u7528 Kiali , \u5219\u53ea\u8bbe\u7f6e\u5176 enabled \u4e3a true \u5373\u53ef\uff0c \u4f46\u6709\u4e9b\u5730\u65b9\u9700\u8981\u7279\u522b\u6ce8\u610f\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 \u4e0e Jaeger \u4e00\u6837,\u53ef\u4ee5\u4e3a Kiali \u8bbe\u7f6e Ingress \u51fa\u53e3 \u548c\u5176\u4ed6\u7ec4\u4ef6\u4e00\u6837\uff0c \u5728\u8bbe\u7f6e enabled \u4e3atrue\u4e4b\u540e\u4f7f\u7528 helm template \u6e32\u67d3\uff0c kubectl apply \u547d\u4ee4\u8fdb\u884c\u5b89\u88c5 ,\u7b49\u5f85 Pod \u542f\u52a8\u6210\u529f\u5373\u53ef\u3002 \u6211\u4eec\u5728\u8fd9\u91cc\u4fee\u6539 kiali \u7684image\u5230\u6700\u65b0\u7684\u7248\u672c image: \"docker.io/kiali/kiali:v0.16\" => image: \"docker.io/kiali/kiali:v1.4.0\" $ kubectl apply -f istio-demo.yaml","title":"1\u3001 \u542f\u7528Kiali"},{"location":"chap5/8Istio_func4_Kiali/#2kiali","text":"\u901a\u8fc7\u7aef\u53e3\u8f6c\u53d1\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee $ kubectl -n istio-system get pod -l app=kiali -o custom-columns='Name:metadata.name' Name kiali-785fc9f67b-gc42t $ kubectl -n istio-system port-forward kiali-785fc9f67b-gc42t 20001:20001 \u4f7f\u7528\u6d4f\u89c8\u5668\u6253\u5f00\u9875\u9762\uff0c \u767b\u5f55\u9875\u9762\u7684\u9ed8\u8ba4\u7528\u6237\u540d\u548c\u5bc6\u7801\u4e3a values.yaml \u7684 tracing \u4e00\u8282\u4fee\u6539\u3002 \u5728\u767b\u5f55\u6210\u529f\u4e4b\u540e\u8fdb\u4eba\u9996\u9875\uff0c admin:admin \uff0c\u4e5f\u53ef\u4ee5\u5728\u9996\u9875\u5c55\u793a\u4e86\u76ee\u524d\u7684\u547d\u540d\u7a7a\u95f4\u4e2a\u548c\u5176\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u60c5\u51b5 http://127.0.0.1:20001/kiali/console \u5355\u51fb\u5176\u4e2d\u7684 default \u547d\u540d\u7a7a\u95ee\u4f1a\u770b\u5230\u5404\u4e2a\u670d\u52a1\u7684\u60c5\u51b5\uff0c\u5305\u62ec\u5065\u5eb7\u72b6\u51b5\u3001\u662f\u5426\u6ce8\u5165 \u5355\u51fb\u5177\u4f53\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u770b\u5230\u670d\u52a1\u76f8\u5173\u7684\u4e00\u4e9b\u6307\u6807\u5c55\u793a\uff0c\u4f8b\u5982\u67e5\u770b flaskapp-v1 \u7684\u51fa\u7ad9\u8bf7\u6c42 \u6ce8\u610f\uff0c\u8fd9\u4e9b\u56fe\u5f62\u662f\u6839\u636e\u8bbf\u95ee\u5f97\u51fa\u7684\uff0c\u5982\u679c\u4e3a\u7a7a\uff0c\u5219\u53ef\u80fd\u662f\u56e0\u4e3a\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u8303\u56f4\u5185\u6ca1\u6709\u6d41\u91cf\u6d69\u6210\u7684\u3002 \u5c1d\u8bd5\u9009\u62e9\u5408\u9002\u7684\u65f6\u95f4\u8de8\u5ea6\uff0c\u770b\u770b\u662f\u5426\u6b63\u786e\u663e\u793a\u3002 \u53ef\u4ee5\u8fdb\u4eba sleep Pod \u4f7f\u7528\u4e4b\u524d\u7684\u65b9\u6cd5\u6765\u751f\u6210\u8d1f\u8f7d $ kubectl exec -it sleep-6c9c898f6c-gvqng -c sleep bash bash-4.4# for i in 'seq 1000';do http --body http://flaskapp/env/version; done Workloads -> sleep -> Outbound Metrics \u5728 Graph \u83dc\u5355\u4e2d\u4f1a\u663e\u793a\u670d\u52a1\u7684\u62d3\u6251\u5173\u7cfb\u4f8b\u5982\u6211\u4eec\u5728\u524d\u800c\u8fdb\u884c\u6d4b\u8bd5\u65f6\u4f7f\u7528\u7684, \u51e0\u4e2a\u670d\u52a1\u90fd\u4f1a\u6709\u5982\u56fe\u6240\u793a\u7684\u663e\u793a\u6548\u679c \u8fd9\u91cc\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230\u5404\u4e2a\u670d\u52a1\u7684\u8c03\u7528\u5173\u7cfb\u548c\u6d41\u91cf\u72b6\u51b5\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u5728\u524d\u9762\u4f7f\u7528 sleep pod \u7684 Shell \u4e2d\uff0c\u4f7f\u7528 HTTP \u5ba2\u6237\u7aef\u4e00\u5de5\u5177\u901a\u8fc7 flaskapp \u5e94\u7528\u8c03\u7528 httpbin \u7684\u8fc7\u7a0b\uff0c \u5728\u8fd9\u5f20\u56fe\u4e2d\u7684\u8868\u73b0\u5c31\u5f88\u660e\u663e\u3002 \u53e6\u5916\uff0c\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u529f\u80fd\u5c31\u662fKiali\u83dc\u5355\u5de6\u4fa7\u7684 Istio Confi g\u9879\u3002\u5355\u51fb\u8fd9\u4e00\u9879\uff0c \u9009\u62e9 istio-system\u547d \u540d\u7a7a\u95f4\uff0c\u4f1a\u770b\u5230 Istio \u9ed8\u8ba4\u7684\u5404\u79cd\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684\u8bbe\u7f6e\u60c5\u51b5 \u5355\u51fb\u5176\u4e2d\u7684\u5404\u4e2a\u9879\u76ee, \u4f1a\u5c55\u793a\u8be5\u5bf9\u8c61\u7684\u5b9a\u4e49\u6587\u672c,\u5176\u4e2d\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e9b\u914d\u7f6e\u6821\u9a8c\u65b9\u9762\u7684\u529f\u80fd\u3002\u5982\u6240\u793a\u7684\u662f istio-policy \u7684 destinationrules \u3002","title":"2\u3001\u8bbf\u95eeKiali"},{"location":"chap5/8Istio_func4_Kiali/#kiali_1","text":"\u5728 values.yaml \u4e2d\u4e5f\u4e3a Kiali \u63d0\u4f9b\u4e86 Ingress \u7684\u914d\u7f6e\u9879\u76ee\uff0c\u56e0\u6b64\u5f00\u653e Kiali \u670d\u52a1\u7684 \u65b9\u5f0f\u548c Jaeger \u4e00\u6837\uff0c\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u670d\u52a1\u7c7b\u578b\u6216\u8bbe\u7f6e Ingress \u5c06\u670d\u52a1\u5f00\u653e\u3002","title":"\u5f00\u653eKiali\u670d\u52a1"},{"location":"chap5/8Istio_func4_Kiali/#3","text":"\u672c\u7ae0\u8bb2\u89e3\u4e86\u5982\u4f55\u5728\u7f51\u683c\u4e2d\u8fdb\u884c\u5e94\u7528\u90e8\u7f72\uff0c\u8fd8\u9010\u4e2a\u5c55\u793a\u4e86 Istio \u5e38\u7528\u53ef\u89c6\u5316\u7ec4\u4ef6\u7684\u542f\u52a8\u548c\u4f7f\u7528\u65b9\u6cd5\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u5bf9 Istio \u670d\u52a1\u7f51\u683c\u7684\u8fd0\u7ef4\u6709\u5f88\u91cd\u8981\u7684\u610f\u4e49\uff0c\u662f\u670d\u52a1\u7f51\u683c\u53ef\u89c2\u5bdf\u6027\u7684\u5177\u4f53\u8868\u73b0\u3002 Grafana , Prometheus \u53ca Jaeger \u8fd9\u4e9b\u7b2c\u4e09\u65b9\u7ec4\u4ef6\u90fd\u76f8\u5bf9\u6210\u719f\u548c\u7a33\u5b9a\uff1b Kiali \u76ee\u524d\u8fd8\u76f8\u5bf9\u5e7c\u7a1a\uff0c\u4f46\u662f\u4e5f\u770b\u5f97\u51fa\u6765 Istio \u5bf9\u5176\u529f\u80fd\u7684\u501f\u91cd\u548c\u671f\u5f85\u3002","title":"3\u3001\u5c0f\u7ed3"},{"location":"chap5/9Istio_http1/","text":"\u7b2c\u4e5d\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u76ee\u6807\u89c4\u5219/\u9ed8\u8ba4\u8def\u7531/\u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb) 9.1 \u5b9a\u4e49\u76ee\u6807\u89c4\u5219 9.2 \u5b9a\u4e49\u9ed8\u8ba4\u8def\u7531 9.3 \u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb \u5728\u7b2c2\u7ae0\u4e2d\u63d0\u5230\u8fc7\uff0c\u8fde\u63a5\u80fd\u529b\u662f Istio \u7684\u6838\u5fc3\u529f\u80fd\u4e4b\u4e00\uff0c\u5982\u4e0b\u6240\u793a \u5728\u5fae\u670d\u52a1\u73af\u5883\u4e2d\uff0c\u5982\u4f55\u5c06\u5927\u91cf\u7684\u5fae\u670d\u52a1\u94fe\u63a5\u5728\u4e00\u8d77\uff0c \u8fdb\u884c\u6709\u6548\u7684\u8fdc\u7a0b\u670d\u52a1\u8c03\u7528\uff0c\u662f\u4e1a\u52a1\u8fd0\u8f6c\u7684\u57fa\u672c\u8981\u6c42 \u5728\u4e0d\u53ef\u9760\u7684\u7f51\u7edc\u72b6\u51b5\u4e0b\uff0c\u5982\u4f55\u4fdd\u8bc1\u670d\u52a1\u6b63\u786e\u5e94\u5bf9\u7f51\u7edc\u8fc7\u8d26\uff0c\u4fdd\u8bc1\u670d\u52a1\u8d28\u91cf\uff0c\u4e5f\u662f\u5fc5\u987b\u8003\u8651\u7684\u95ee\u9898 \u5728\u5347\u7ea7\uff0c\u6d4b\u8bd5\u548c\u6269\u7f29\u5bb9\u7684\u573a\u666f\u4e2d\uff0c\u8fdb\u884c\u6709\u5e8f\u53ef\u9760\u7684\u6d41\u91cf\u5f15\u5bfc\u548c\u8f6c\u79fb\uff0c\u540c\u6837\u662f\u5f88\u73b0\u5b9e\u7684\u8981\u6c42 \u5728\u5fae\u670d\u52a1\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u80fd\u591f\u91c7\u53d6\u63aa\u65bd\u8fdb\u884c\u6545\u969c\u9694\u79bb\uff0c\u9632\u6b62\u6545\u969c\u6269\u6563\u5f71\u54cd\u6574\u4f53\u5e94\u7528\u7684\u8fd0\u884c\uff0c \u5bf9\u4e1a\u52a1\u5065\u58ee\u6027\u662f\u4e00\u4e2a\u91cd\u8981\u4fdd\u969c Istio\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u6d41\u91cf\u63a7\u5236\u80fd\u529b\uff0c\u53ef\u4ee5\u5728\u4e1a\u52a1\u53ef\u4ee5\u5728\u4e1a\u52a1\u5e94\u7528\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u5bf9\u5e94\u7528\u7684\u901a\u4fe1\u8fdb\u884c\u914d\u7f6e\u548c\u7ba1\u7406\uff0c \u80fd\u591f\u6709\u6548\u964d\u4f4e\u5f00\u53d1\u548c\u8fd0\u7ef4\u6210\u672c\uff0c\u5e76\u63d0\u9ad8\u670d\u52a1\u7684\u63a7\u5236\u80fd\u529b 1\u3001\u5b9a\u4e49\u76ee\u6807\u89c4\u5219 \u5728\u8fdb\u884c\u6d41\u91cf\u7ba1\u7406\u5b9e\u8df5\u4e4b\u524d\uff0c\u9996\u5148\u8981\u4e86\u89e3 Istio \u5bf9\u6d41\u91cf\u8bbf\u95ee\u76ee\u6807\u7684\u5b9a\u4e49\u901a\u5e38\u6765\u8bf4\uff0c\u5728 Kubernetes \u4e2d\u8bbf\u95ee\u4e00\u4e2a\u670d\u52a1\u65f6\uff0c\u9700\u8981\u6307\u5b9a\u5176\u534f\u8bae\u3001\u670d\u52a1\u540d\u53ca\u7aef\u53e3 \u4f8b\u5982 http://httpbin:8000 \u3002 \u800c\u5728 Istio \u7684\u670d\u52a1\u7f51\u683c\u4e2d\u5bf9\u670d\u52a1\u8fdb\u884c\u4e86\u8fdb\u4e00\u6b65\u62bd\u8c61\uff1a \u53ef\u4ee5\u4f7f\u7528 Pod \u6807\u7b7e\u5bf9\u5177\u4f53\u7684\u670d\u52a1\u8fdb\u7a0b\u8fdb\u884c\u5206\u7ec4\uff1b \u53ef\u4ee5\u5b9a\u4e49\u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff1b \u53ef\u4ee5\u4e3a\u670d\u52a1\u6307\u5b9a TLS \u8981\u6c42\uff1b \u53ef\u4ee5\u4e3a\u670d\u52a1\u8bbe\u7f6e\u8fde\u63a5\u6c60\u5927\u5c0f\u3002 \u6211\u4eec\u7528\u5230\u7684 flaskapp.istio.yaml \u901a\u8fc7\u4e2a Servie \u5bf9\u5e94\u4e24\u4e2a\u4e0d\u540c\u7248 Deployment \u4e24\u4e2a Deployment \u4e2d\u7684Pod\u4f7f\u7528\u4e86\u4e0d\u540c\u7684\u6807\u7b7e\u8fdb\u884c\u533a\u5206 \u5728 Kubernetes \u4e2d Service \u548c Deployment \u6216\u8005\u5176\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5173\u7cfb\u901a\u5e38\u662f\u4e00\u5bf9\u4e00\u7684\u3002 \u800c\u5728 Istio \u4e2d Service \u7ecf\u5e38\u4f1a\u5bf9\u5e94\u4e0d\u540c\u7684 Deployment \u8fd9\u4e2a\u5dee\u5f02\u770b\u8d77\u6765\u4f3c\u4e4e\u5fae\u4e0d\u8db3\u9053\uff0c\u4f46\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u4e24\u79cd\u6a21\u5f0f\u7684\u7075\u6d3b\u6027\u9ad8\u4e0b\u7acb\u5224\uff0c \u5982\u4e0b\u6240\u8ff0 \u5728 Istio \u4e2d\uff0c\u5ba2\u6237\u7aef\u53ea\u4f7f\u7528\u4e00\u4e2a\u670d\u52a1\u5165\u53e3\u5c31\u53ef\u4ee5\u8bbf\u95ee\u591a\u4e0d\u540c\u7684\u670d\u52a1\uff0c\u65e0\u987b\u5ba2\u6237\u7aef\u5e72\u9884\u3002 \u4f46\u5ba2\u6237\u7aef\u5982\u679c\u76f4\u63a5\u4f7f\u7528 Kubernetes Service \uff0c\u5c31\u5fc5\u987b\u4f7f\u7528\u4e24\u4e2a\u4e0d\u540c\u7684\u670d\u52a1\u5165\u53e3\u3002 Istio \u53ef\u4ee5\u901a\u8fc7\u6d41\u91cf\u7279\u5f81\u6765\u5b8c\u6210\u5bf9\u540e\u7aef\u670d\u52a1\u7684\u9009\u62e9 , \u5b83\u7684\u6d41\u91cf\u63a7\u5236\u529f\u80fd\u4f1a\u6839\u636e\u6bcf\u6b21\u8bbf\u95ee\u4ea7\u751f\u7684\u6d41\u91cf\u8fdb\u884c\u5224\u65ad\uff0c \u6839\u636e\u5224\u65ad\u7ed3\u679c\u6765\u9009\u62e9\u4e00\u4e2a\u540e\u7aef\u8d1f\u8d23\u672c\u6b21\u8bbf\u95ee\u7684\u54cd\u5e94 \u3002 Kubernetes \u5f53\u7136\u4e5f\u53ef\u4ee5\u8fd9\u6837\u505a, \u4f46\u662f\u56e0\u4e3a Kubernetes \u7684 Service \u4e0d \u5177\u5907\u9009\u62e9\u540e\u7aef\u7684\u80fd\u529b\uff0c\u6240\u4ee5\u5982\u679c\u5b83\u4f7f\u7528\u4e86 Istio \u8fd9\u79cd\u4e00\u5bf9\u591a\u7684\u6a21\u5f0f, \u5219\u540e\u679c\u53ea\u80fd\u662f\u4f7f\u7528\u8f6e\u8be2\u65b9\u5f0f\u968f\u673a\u8c03\u7528\u4e24\u4e2a\u4e0d\u540c\u7684\u5de5\u4f5c\u8d1f\u8f7d \u800c\u5728 Istio \u4e2d\uff0c \u8fd9\u79cd\u540c\u4e00\u670d\u52a1\u4e0d\u540c\u7ec4\u522b\u7684\u540e\u7aef\u88ab\u79f0\u4e3a\u5b50\u96c6(Subset) \uff0c\u4e5f\u7ecf\u5e38\u88ab\u79f0\u4e3a\u670d\u52a1\u7248\u672c\u3002 \u5728 Istio \u4e2d\u5efa\u8bae\u4e3a\u6bcf\u4e2a\u7f51\u683c\u90fd\u8bbe\u7f6e\u660e\u786e\u7684\u76ee\u6807\u8bbf\u95ee\u89c4\u5219\u3002 \u5728\u901a\u8fc7 Istio \u6d41\u91cf\u63a7\u5236\u4e4b\u540e\u4f1a\u9009\u62e9\u660e\u786e\u7684\u5b50\u96c6, \u6839\u636e\u8be5\u89c4\u5219\u6216\u8005\u5728\u5b50\u96c6\u4e2d\u89c4\u5b9a\u7684\u6d41\u91cf\u7b56\u7565\u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u8fd9\u79cd\u89c4\u5219\u5728 Istio \u88ab\u79f0\u4e3a DestionationRule \u4f8b\u5982\u6211\u4eec\u4e3a flaskapp \u5efa\u7acb\u4e00\u4e2a\u76ee\u6807\u89c4\u5219\u5b9a\u4e49 apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: flaskapp spec: host: flaskapp.default.svc.cluster.local trafficPolicy: loadBalancer: simple: LEAST_CONN subsets: - name: v1 labels: version: v1 trafficPolicy: loadBalancer: simple: ROUND_ROBIN - name: v2 labels: version: v2 DestinationRule trafficPolicy / loadBalancer / simple: LEAST_CONN subsets \u8be5\u89c4\u5219\u6709\u4ee5\u4e0b\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u3002 host \uff1a\u662f\u4e00\u4e2a\u5fc5\u8981\u5b57\u6bb5\uff0c \u4ee3\u8868 Kubernetes \u4e2d\u7684\u4e00\u4e2a Service \u8d44\u6e90\uff0c\u6216\u8005\u4e00\u4e2a \u7531 ServiceEntry \u5b9a\u4e49\u7684\u5916\u90e8\u670d\u52a1\u3002 \u4e3a\u4e86\u9632\u6b62 Kubernetes \u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u670d\u52a1\u91cd\u540d, \u8fd9\u91cc\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528\u5b8c\u5168\u9650\u5b9a\u540d\uff0c\u4e5f\u5c31\u662f\u4f7f\u7528 FQDN \u6765\u8d4b\u503c\u3002 trafficPolicy \uff1a\u662f\u6d41\u91cf\u7b56\u7565 \u3002\u5728 DestinationRule \u548c Subsets \u4e24\u7ea7\u4e2d\u90fd\u53ef\u4ee5\u5b9a\u4e49 trafficPolicy \uff0c\u5728 Subset \u4e2d\u8bbe\u7f6e\u7684\u7ea7\u522b\u9ad8\u3002 subsets \uff1a\u5728\u8be5\u5b57\u6bb5\u4e2d\u4f7f\u7528\u6807\u7b7e\u9009\u62e9\u5668\u6765\u5b9a\u4e49\u4e0d\u540c\u7684\u5b50\u96c6\u3002 \u7efc\u4e0a\u6240\u8ff0\uff0c \u6211\u4eec\u4e3a flaskapp \u5efa\u7acb\u4e86 v1 \u548c v2 \u8fd9\u4e24\u4e2a\u5b50\u96c6\uff0c\u5e76\u4e14 v1 \u5b50\u96c6\u4f7f\u7528\u4e86\u72ec\u7acb\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u3002 \u4e3a\u4e86\u540e\u7eed\u73af\u8282\u7684\u987a\u5229\u8fdb\u884c\uff0c\u521b\u5efa\u7684 flaskapp \u670d\u52a1\uff08 Service \u548c Deployment \u521b\u5efa\u76ee\u6807\u89c4\u5219\uff0c\u5c06\u5176\u5206\u6210 v1 \u548c v2 \u4e24\u4e2a\u7248\u672c\uff1a apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: flaskapp spec: host: flaskapp.default.svc.cluster.local subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 \u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a flaskapp-dr.yaml \u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 kubernetes \u96c6\u7fa4\uff1b $ kubectl apply -f flaskapp-dr.yaml destinationrule.networking.istio.io/flaskapp configured $ kubectl get dr NAME HOST AGE flaskapp flaskapp.default.svc.cluster.local 6d23h \u8fd9\u6837, \u6211\u4eec\u5c31\u5bf9\u5177\u4f53\u8d1f\u8d23\u6267\u884c\u670d\u52a1\u7684\u4e0b\u4f5c\u8d1f\u8f7d\u6709\u4e86\u4e00\u4e2a\u660e\u786e\u7684\u5b9a\u4e49, \u5e76\u53ef\u4ee5\u5c06\u5176\u5f53\u4f5c\u6d41\u91cf\u63a7\u5236\u7684\u57fa\u7840 2\u3001\u5b9a\u4e49\u9ed8\u8ba4\u8def\u7531 \u5728\u670d\u52a1\u90e8\u7f72\u5b8c\u6210\u4e4b\u540e, \u6211\u4eec\u4e3a\u5176\u5b9a\u4e49\u4e86\u76ee\u6807\u89c4\u5219\u8282, \u63a5\u4e0b\u6765\u9762\u4e34\u4e00\u4e2a\u95ee\u9898: \u5728\u6ca1\u6709\u4efb\u4f55\u7279\u5b9a\u8def\u7531\u89c4\u5219\u7684\u60c5\u51b5\u4e0b, \u5bf9 flaskpp \u670d\u52a1\u7684\u8bbf\u95ee\u4f1a\u5230\u8fbe\u54ea\u4e2a\u5b50\u96c6\uff08\u6216\u79f0\u7248\u672c\uff09\u5462\uff1f $ kubectl get pod -l app=sleep,version=v1 -o custom-columns='Name:metadata.name' Name sleep-6c9c898f6c-snzx5 sleep-v1-548d87cc5c-wfk7v $ kubectl delete vs flaskapp-default-v2 virtualservice.networking.istio.io \"flaskapp-default-v2\" deleted $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done v2 v2 v1 v1 v2 v2 v1 v1 v2 v2 \u5728\u91cd\u590d\u6267\u884c\u540e\u4e0d\u96be\u53d1\u73b0\uff0c\u6211\u4eec\u5b9a\u4e49\u7684\u76ee\u6807\u89c4\u5219\u5e76\u672a\u5f71\u54cd\u901a\u4fe1\u8fc7\u7a0b\uff0c\u8fd8\u662f\u6309\u7167 kube-proxy \u7684\u9ed8\u8ba4\u968f\u673a\u884c\u4e3a\u8fdb\u884c\u8bbf\u95ee\u7684\uff0c\u8fd4\u56de\u7ed3\u679c\u5206\u522b\u6765\u81ea\u4e24\u4e2a\u4e0d\u540c\u7684\u7248\u672c\u3002 Istio \u5efa\u8bae\u4e3a\u6bcf\u4e2a\u670d\u52a1\u90fd\u521b\u5efa\u4e00\u4e2a\u9ed8\u8ba4\u8def\u7531\uff0c\u5728\u8bbf\u95ee\u67d0\u4e00\u670d\u52a1\u7684\u65f6\u5019\uff0c\u5982\u679c\u6ca1\u6709\u7279\u5b9a\u7684\u8def\u7531\u5219\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\u6765\u8bbf\u95ee\u6307\u5b9a\u7684\u5b50\u96c6\uff0c\u4ee5\u6b64\u6765\u786e\u4fdd\u670d\u52a1\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u7684\u884c\u4e3a\u7a33\u5b9a\u6027\u3002 \u9996\u5148\u521b\u5efa\u4e00\u4e2a\u9ed8\u8ba4\u8bbf\u95ee v1 \u7248\u672c\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u6d4b\u8bd5\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 \u8fd9\u662f\u6700\u7b80\u5355\u7684\u4e00\u4e2a VirtualService \u5b9a\u4e49\u3002 VirtualService \u662f Istio \u6d41\u5740\u63a7\u5236\u8fc7\u7a0b\u4e2d\u7684\u4e00\u4e2a\u67a2\u7ebd\u8d1f\u8d23\u5bf9\u6d41\u91cf\u8fdb\u884c\u7504\u522b\u548c\u8f6c\u53d1 \u3002 \u4e0b\u9762\u5bf9\u672c\u8282\u6d89\u53ca\u7684\u6982\u5ff5\u8fdb\u884c\u8bb2\u89e3\u3002 VirtualService \u540c\u6837\u662f\u9488\u5bf9\u4e3b\u673a\u540d\u5de5\u4f5c\u7684\uff0c\u4f46\u6ce8\u610f\u8fd9\u4e2a\u5b57\u6bb5\u662f\u4e00\u4e2a\u6570\u7ec4\u5185\u5bb9\uff0c\u56e0\u6b64\u5b83\u53ef\u4ee5\u9488\u5bf9\u591a\u4e2a\u4e3b\u673a\u540d\u8fdb\u884c\u5de5\u4f5c \uff0c VirtualService \u53ef\u4ee5\u4e3a\u591a\u79cd\u534f\u8bae\u7684\u6d41\u91cf\u63d0\u4f9b\u670d\u52a1\uff0c \u9664\u4e86\u652f\u6301\u672c\u6587\u4f7f\u7528\u7684\u662f HTTP \u8fd8\u652f\u6301 TCP \u548c TLS \u3002 \u5728 http \u5b57\u6bb5\u7684\u4e0b\u4e00\u7ea7, \u5c31\u662f\u5177\u4f53\u7684\u8def\u7531\u89c4\u5219\u4e86\u3002\u4e0d\u96be\u770b\u51fa\uff0c\u8fd9\u91cc\u662f\u652f\u6301\u591a\u7684\u8def\u7531\u7684 \uff0c \u6211\u4eec\u7b80\u5355\u5b9a\u4e49\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u76ee\u6807\uff1a flaskapp.default.svc.cluster.local \u4e5f\u5c31\u662f\u8bf4, flaskapp \u9ed8\u8ba4\u4f7f\u7528 v1 \u7248\u672c\u6765\u5904\u7406\u8bf7\u6c42 \u63a5\u4e0b\u6765\u6d4b\u8bd5\u4e00\u4e0b\u3002 \u9996\u5148\u5c06\u4e0a\u8ff0 YAML \u4ee3\u7801\u4fdd\u5b58\u4e3a flask-default-vs-v1.yaml \uff0c\u7136\u540e\u4f7f\u7528 kubectl apply \u547d\u4ee4\u5c06\u5176\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\uff1a $ kubectl apply -f flask-default-vs-v1.yaml virtualservice.networking.istio.io/flaskapp created \u518d\u6b21\u8fdb\u5165 sleep pod \u8fdb\u884c\u6d4b\u8bd5 kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash bash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done v1 v1 v1 v1 v1 v1 v1 v1 v1 v1 \u91cd\u590d\u6267\u884c\u547d\u4ee4\u5c31\u4f1a\u53d1\u73b0\u6240\u6709\u8bbf\u95ee\u90fd\u4ece v1 \u7248\u672c\u8fd4\u56de\u4e86, \u8fd9\u8868\u660e\u627e\u4eec\u5b9a\u5236\u7684\u9ed8\u8ba4\u8def\u7531\u5df1\u7ecf\u751f\u6548\u6548 \u5728\u8bbf\u95ee\u8fc7\u7a0b\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95ee kiali \u6765\u67e5\u770b\u6d41\u91cf\u7684\u53ef\u89c6\u5316\u7ed3\u679c\uff0c kiali \u4f1a\u901a\u8fc7\u52a8\u753b\u7684\u5f62\u5f0f\u5448\u73b0\u8bbf\u95ee\u6e05\u51b5 http://127.0.0.1:20001/kiali/console/graph/namespaces/?edges=noEdgeLabels&graphType=versionedApp&namespaces=default&injectServiceNodes=true&duration=60&pi=10000&layout=dagre&unusedNodes=false \u8fd9\u91cc\u7a0d\u4f5c\u56de\u987e\uff0c\u5728 Istio \u4e2d\u90e8\u7f72\u4e00\u4e2a\u4e1a\u52a1\u5e94\u7528\u65f6\uff0c\u5efa\u8bae\u505a\u5230\u4ee5\u4e0b\u51e0\u70b9 \u4f7f\u7528 app \u6807\u7b7e\u8868\u660e\u5e94\u7528\u8eab\u4efd\uff1b \u4f7f\u7528 version \u6807\u7b7e\u8868\u660e\u5e94\u7528\u7248\u672c\uff1b \u521b\u5efa\u76ee\u6807\u89c4\u5219(DestinationRule) \uff1b \u521b\u5efa\u9ed8\u8ba4\u8def\u7531\u89c4\u5219(VirtualService) \u3002 \u9ed8\u8ba4\u8def\u7531\u9664\u4e86\u53ef\u4ee5\u4fdd\u8bc1\u5e94\u7528\u884c\u4e3a\u7684\u7a33\u5b9a\u6027\uff0c \u4e5f\u662f Istio \u7684\u4e00\u4e9b\u914d\u7f6e\u5bf9\u8c61\u7684\u6784\u5efa\u57fa\u7840\u3002 \u56e0\u6b64\u548c\u65e5\u5e38\u7684 Dockerfile \u3001 Service \u3001 Deployment \u7b49\u6e05\u5355\u6587\u4ef6\u4e00\u6837\u9ed8\u8ba4\u8def\u7531\u7684\u914d\u7f6e\u6e05\u5355\u5e94\u8be5\u6210\u4e3a\u670d\u52a1\u7f51\u683c\u73af\u5883\u4e0b\u7684\u5fc5\u8981\u90e8\u7f72\u5185\u5bb9 3\u3001 \u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb \u4e0a\u4e00\u8282\u4e2d\u6709\u8fc7\u63d0\u793a VirtualService \u7684 http \u5b57\u6bb5\u7684\u4e0b\u4e00\u7ea7\u6210\u5458\u662f\u4e00\u4e2a\u6570\u7ec4, \u4ee3\u8868\u591a\u6761\u8def\u7531\u89c4\u5219\u3002 \u8fd9\u5f88\u81ea\u7136\u4f1a\u8ba9\u6211\u4eec\u60f3\u5230\uff1a\u5728\u591a\u7248\u672c\u5e76\u5b58\u7684\u60c5\u51b5\u4e0b\u662f\u5426\u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u7684\u7248\u672c\u8fdb\u884c\u6d41\u5740\u5206\u914d\u5462? \u8fd9\u79cd\u7279\u6027\u5728\u6d4b\u8bd5\u548c\u7248\u672c\u66f4\u65b0\u7684\u6e05\u51b5\u4e0b\u662f\u5f88\u6709\u7528\u7684\uff0c \u4f8b\u5982\u5728\u6211\u4eec\u7684\u65b0\u7248\u672c\u8fd8\u6ca1\u6709\u5b8c\u5168\u901a\u8fc7\u751f\u4ea7\u9a8c\u8bc1\u4e4b\u524d\u6211\u4eec\u53ea\u5e0c\u671b\u5df2\u627f\u62c5\u5c11\u90e8\u5206\u6d41\u91cf\uff0c \u6765\u89c2\u5bdf\u5b83\u5728\u751f\u4ea7\u73af\u5883\u7684\u7a33\u5b9a\u6027\u3002 \u56e0\u4e3a\u6837\u672c\u91cf\u592a\u5c11\uff0c\u6240\u4ee5\u6211\u4eec\u4f1a\u770b\u5230\u5728\u8c03\u7528\u8fc7\u7a0b\u4e2d\u8fd4\u56de\u7684\u5185\u5bb9\u8fd8\u662f\u968f\u673a\u5206\u5e03\u7684\uff0c \u56e0\u6b64\u8fd9\u91cc\u7528\u4e00\u4e2a for \u5faa\u73af\u8fdb\u884c\u591a\u6b21\u6d4b\u8bd5\uff0c\u67e5\u770b\u201cv1\u201d\u5728\u5176\u4e2d\u51fa\u73b0\u7684\u6b21\u6570\uff1a \u5148\u5220\u6389\u539f\u6765\u7684\u5efa\u7acb\u7684 VS ,\u7136\u540e\u8fdb\u5165 sleep pod , \u53ef\u89c1\u5206\u914d\u6bd4\u7387\u63a5\u8fd1 50% $ kubectl get vs NAME GATEWAYS HOSTS AGE flaskapp [flaskapp.default.svc.cluster.local] 22h $ kubectl delete vs flaskapp virtualservice.networking.istio.io \"flaskapp\" deleted $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash for i in `seq 10`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 4 for i in `seq 100`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 50 for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 151 \u4e0b\u9762\u5b9a\u4e49\u4e00\u4e2a\u5206\u6d41\u89c4\u5219\uff1a\u5bf9 flaskpp \u670d\u52a1\u7684\u8bbf\u95ee, \u6709 70\uff05 \u8fdb\u4eba v1 \u7248\u672c, \u6709 30% \u8fdb\u4eba v2 \u7248\u672c. \u76f4\u63a5\u4fee\u6539 flaskapp.virtualservice.yaml ,\u6dfb\u52a0\u5bf9 v2 \u7248\u672c\u7684\u76ee\u6807\u652f\u6301\uff0c \u5e76\u5b9a\u4e49\u5206\u914d\u6743\u91cd apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 weight: 70 - destination: host: flaskapp.default.svc.cluster.local subset: v2 weight: 30 \u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u66f4\u65b0\u540e\u7684\u89c4\u5219\uff0c \u5e76\u6d4b\u8bd5\u5176\u5b9e\u9645\u7ed3\u679c $ kubectl apply -f flaskapp.virtualservice.yaml virtualservice.networking.istio.io/flaskapp created \u8fdb\u4eba Sleep Pod \u8fde\u7eed\u5bf9 flaskapp \u53d1\u51fa\u8bf7\u6c42\u5e76\u7edf\u8ba1\u8fd4\u56de\u7ed3\u679c $ kubectl get vs NAME GATEWAYS HOSTS AGE flaskapp [flaskapp.default.svc.cluster.local] 2m39s $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash for i in `seq 10`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{pr int NF-1}' 8 bash-4.4# for i in `seq 100`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{p rint NF-1}' 59 bash-4.4# for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{p rint NF-1}' 215 \u53ef\u4ee5\u770b\u51fa, \u968f\u82e5\u6d4b\u8bd5\u6b21\u6570\u7684\u589e\u52a0 v1 \u51fa\u73b0\u7684\u6b21\u6570\u4f1a\u9010\u6b65\u63a5\u8fd1\u6211\u4eec\u5b9a\u4e49\u7684\u5206\u914d\u6bd4\u7387\u3002 \u56de\u5230\u73b0\u5b9e\u573a\u666f\u4e2d,\u5982\u679c\u6d4b\u8bd5\u7ed3\u679c\u4e50\u89c2, \u5219\u6211\u4eec\u4f1a\u5e0c\u671b\u4e3a\u65b0\u7248\u672c\u5206\u914d\u66f4\u591a\u7684\u6d41\u5740\u3002 \u8fd9\u65f6\u8be5\u5982\u4f55\u5904\u7406\uff1f \u5f88\u7b80\u5355\uff0c\u4fee\u6539\u8def\u7531\u5373\u53ef\u3002\u6211\u4eec\u7ee7\u7eed\u4fee\u6539\u5e76\u63d0\u4ea4 flaskapp.virtualservice.yaml \u6587\u4ef6 \u4e0d\u540c\u7684\u662f\u8fd9\u6b21v1\u548cv2\u7684\u6bd4\u4f8b\u4ece 70: 30 \u4fee\u6539\u4e3a 10:90 , \u5728\u4fee\u6539\u4e4b\u540e\u91cd\u65b0\u8fdb sleep pod \u884c\u6d4b\u8bd5 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 weight: 10 - destination: host: flaskapp.default.svc.cluster.local subset: v2 weight: 90 $ kubectl apply -f flaskapp.virtualservice.yaml virtualservice.networking.istio.io/flaskapp configured $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash $ bash-4.4# for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 32 \u53ef\u4ee5\u770b\u5230\uff0c \u6211\u4eec\u5b9a\u4e49\u7684\u6d41\u867d\u5206\u914d\u539f\u5219\u5df2\u7ecf\u751f\u6548\u4e86 \u66f4\u8fdb\u4e00\u6b65\uff0c \u5982\u679c v2 \u7248\u672c\u6d4b\u8bd5\u6210\u529f,\u5219\u53ef\u4ee5\u518d\u6b21\u4fee\u6539\u5220\u9664 v1 \u7248\u672c\u7684\u8def\u7531\uff0c\u8ba9\u5168\u90e8\u6d41\u91cf\u90fd\u8fdb\u5165 v2 \u7248\u672c. \u4e5f\u5c31\u662f\u4f7f\u7528 v2 \u7248\u672c\u5b8c\u5168\u66ff\u4ee3\u539f\u6709\u7684 v1 \u7248\u672c, \u5b8c\u6210\u6700\u7ec8\u7684\u5347\u7ea7\u3002 \u7ee7\u7eed\u4fee\u6539 flaskapp.virtualservice.yaml ,\u5c06\u5176\u4e2d\u7684 http \u90e8\u5206\u4fee\u6539\u4e3a\u4ec5\u5305\u542b v2 \u7684\u5185\u5bb9 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 weight: 100 $ kubectl apply -f flaskapp.virtualservice.yaml virtualservice.networking.istio.io/flaskapp configured \u518d\u6b21\u6d4b\u8bd5\u6d41\u91cf\u5206\u914d\u60c5\u51b5 $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash bash-4.4# for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 0 \u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u5df2\u7ecf\u5b8c\u5168\u6ca1\u6709\u6765\u81ea v1 \u7248\u672c\u7684\u54cd\u5e94\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4\u6240\u6709\u6d41\u91cf\u90fd\u5df2\u7ecf\u6309\u8ba1\u5212\u8fdb\u4eba v2 \u7248\u672c\uff0c v1 \u7248\u672c\u53ef\u4ee5\u4e0b\u7ebf \u3002 \u672c\u8282\u6709\u4ee5\u4e0b\u51e0\u70b9\u9700\u8981\u6ce8\u610f\u3002 \u6d41\u91cf\u5206\u914d\u662f\u6709\u6743\u91cd\u7684\uff0c\u5e76\u4e14\u6743\u91cd\u603b\u548c\u5fc5\u987b\u662f 100 \u3002 \u5982\u679c\u4e0d\u663e\u5f0f\u58f0\u660e\u6743\u91cd, \u5219\u5176\u9ed8\u8ba4\u503c\u4e3a 100 \u3002 \u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u7f51\u683c\u73b0\u6709\u7684\u8def\u7531\u89c4\u5219\u6216\u8005\u5176\u4ed6 Istio \u5bf9\u8c61\u5462\uff1f\u65b9\u6cd5\u6709\u4ee5\u4e0b\u4e24\u79cd\u3002 \u4f7f\u7528 kubectl get . Istio \u7684\u8d44\u6e90\u548c Kubernetes \u5185\u7f6e\u7684\u8d44\u6e90\u4e00\u6837\uff0c\u90fd\u80fd\u901a\u8fc7 kubectl \u83b7\u53d6\uff0e\u5e76\u80fd\u591f\u5c55\u793a\u5f53\u524d\u5b58\u5728\u7684 VirtualService \uff1b\u8fd8\u53ef\u4ee5\u4f7f\u7528 kubectl api-resources \u547d\u4ee4\uff0c \u5217\u51fa\u5f53\u524d\u96c6\u7fa4\u652f\u6301\u7684\u6240\u6709\u5bf9\u8c61\u7c7b\u578b\u3002 \u4f7f\u7528 Kiali \u3002\u9009\u62e9\u5de6\u4fa7\u83dc\u5355\u4e2d\u7684 Istio Config \uff0c\u5982\u56fe\u6240\u793a\u4e3a\u6211\u4eec\u65b0\u5efa\u7684\u8def\u7531\u89c4\u5219\u548c\u76ee\u6807\u89c4\u5219\u3002","title":"\u7b2c\u4e5d\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u76ee\u6807\u89c4\u5219/\u9ed8\u8ba4\u8def\u7531/\u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb)"},{"location":"chap5/9Istio_http1/#https","text":"9.1 \u5b9a\u4e49\u76ee\u6807\u89c4\u5219 9.2 \u5b9a\u4e49\u9ed8\u8ba4\u8def\u7531 9.3 \u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb \u5728\u7b2c2\u7ae0\u4e2d\u63d0\u5230\u8fc7\uff0c\u8fde\u63a5\u80fd\u529b\u662f Istio \u7684\u6838\u5fc3\u529f\u80fd\u4e4b\u4e00\uff0c\u5982\u4e0b\u6240\u793a \u5728\u5fae\u670d\u52a1\u73af\u5883\u4e2d\uff0c\u5982\u4f55\u5c06\u5927\u91cf\u7684\u5fae\u670d\u52a1\u94fe\u63a5\u5728\u4e00\u8d77\uff0c \u8fdb\u884c\u6709\u6548\u7684\u8fdc\u7a0b\u670d\u52a1\u8c03\u7528\uff0c\u662f\u4e1a\u52a1\u8fd0\u8f6c\u7684\u57fa\u672c\u8981\u6c42 \u5728\u4e0d\u53ef\u9760\u7684\u7f51\u7edc\u72b6\u51b5\u4e0b\uff0c\u5982\u4f55\u4fdd\u8bc1\u670d\u52a1\u6b63\u786e\u5e94\u5bf9\u7f51\u7edc\u8fc7\u8d26\uff0c\u4fdd\u8bc1\u670d\u52a1\u8d28\u91cf\uff0c\u4e5f\u662f\u5fc5\u987b\u8003\u8651\u7684\u95ee\u9898 \u5728\u5347\u7ea7\uff0c\u6d4b\u8bd5\u548c\u6269\u7f29\u5bb9\u7684\u573a\u666f\u4e2d\uff0c\u8fdb\u884c\u6709\u5e8f\u53ef\u9760\u7684\u6d41\u91cf\u5f15\u5bfc\u548c\u8f6c\u79fb\uff0c\u540c\u6837\u662f\u5f88\u73b0\u5b9e\u7684\u8981\u6c42 \u5728\u5fae\u670d\u52a1\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u80fd\u591f\u91c7\u53d6\u63aa\u65bd\u8fdb\u884c\u6545\u969c\u9694\u79bb\uff0c\u9632\u6b62\u6545\u969c\u6269\u6563\u5f71\u54cd\u6574\u4f53\u5e94\u7528\u7684\u8fd0\u884c\uff0c \u5bf9\u4e1a\u52a1\u5065\u58ee\u6027\u662f\u4e00\u4e2a\u91cd\u8981\u4fdd\u969c Istio\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u6d41\u91cf\u63a7\u5236\u80fd\u529b\uff0c\u53ef\u4ee5\u5728\u4e1a\u52a1\u53ef\u4ee5\u5728\u4e1a\u52a1\u5e94\u7528\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u5bf9\u5e94\u7528\u7684\u901a\u4fe1\u8fdb\u884c\u914d\u7f6e\u548c\u7ba1\u7406\uff0c \u80fd\u591f\u6709\u6548\u964d\u4f4e\u5f00\u53d1\u548c\u8fd0\u7ef4\u6210\u672c\uff0c\u5e76\u63d0\u9ad8\u670d\u52a1\u7684\u63a7\u5236\u80fd\u529b","title":"\u7b2c\u4e5d\u8282 HTTPS\u6d41\u91cf\u7ba1\u7406(\u76ee\u6807\u89c4\u5219/\u9ed8\u8ba4\u8def\u7531/\u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb)"},{"location":"chap5/9Istio_http1/#1","text":"\u5728\u8fdb\u884c\u6d41\u91cf\u7ba1\u7406\u5b9e\u8df5\u4e4b\u524d\uff0c\u9996\u5148\u8981\u4e86\u89e3 Istio \u5bf9\u6d41\u91cf\u8bbf\u95ee\u76ee\u6807\u7684\u5b9a\u4e49\u901a\u5e38\u6765\u8bf4\uff0c\u5728 Kubernetes \u4e2d\u8bbf\u95ee\u4e00\u4e2a\u670d\u52a1\u65f6\uff0c\u9700\u8981\u6307\u5b9a\u5176\u534f\u8bae\u3001\u670d\u52a1\u540d\u53ca\u7aef\u53e3 \u4f8b\u5982 http://httpbin:8000 \u3002 \u800c\u5728 Istio \u7684\u670d\u52a1\u7f51\u683c\u4e2d\u5bf9\u670d\u52a1\u8fdb\u884c\u4e86\u8fdb\u4e00\u6b65\u62bd\u8c61\uff1a \u53ef\u4ee5\u4f7f\u7528 Pod \u6807\u7b7e\u5bf9\u5177\u4f53\u7684\u670d\u52a1\u8fdb\u7a0b\u8fdb\u884c\u5206\u7ec4\uff1b \u53ef\u4ee5\u5b9a\u4e49\u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff1b \u53ef\u4ee5\u4e3a\u670d\u52a1\u6307\u5b9a TLS \u8981\u6c42\uff1b \u53ef\u4ee5\u4e3a\u670d\u52a1\u8bbe\u7f6e\u8fde\u63a5\u6c60\u5927\u5c0f\u3002 \u6211\u4eec\u7528\u5230\u7684 flaskapp.istio.yaml \u901a\u8fc7\u4e2a Servie \u5bf9\u5e94\u4e24\u4e2a\u4e0d\u540c\u7248 Deployment \u4e24\u4e2a Deployment \u4e2d\u7684Pod\u4f7f\u7528\u4e86\u4e0d\u540c\u7684\u6807\u7b7e\u8fdb\u884c\u533a\u5206 \u5728 Kubernetes \u4e2d Service \u548c Deployment \u6216\u8005\u5176\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5173\u7cfb\u901a\u5e38\u662f\u4e00\u5bf9\u4e00\u7684\u3002 \u800c\u5728 Istio \u4e2d Service \u7ecf\u5e38\u4f1a\u5bf9\u5e94\u4e0d\u540c\u7684 Deployment \u8fd9\u4e2a\u5dee\u5f02\u770b\u8d77\u6765\u4f3c\u4e4e\u5fae\u4e0d\u8db3\u9053\uff0c\u4f46\u5728\u5b9e\u9645\u751f\u4ea7\u4e2d\uff0c\u4e24\u79cd\u6a21\u5f0f\u7684\u7075\u6d3b\u6027\u9ad8\u4e0b\u7acb\u5224\uff0c \u5982\u4e0b\u6240\u8ff0 \u5728 Istio \u4e2d\uff0c\u5ba2\u6237\u7aef\u53ea\u4f7f\u7528\u4e00\u4e2a\u670d\u52a1\u5165\u53e3\u5c31\u53ef\u4ee5\u8bbf\u95ee\u591a\u4e0d\u540c\u7684\u670d\u52a1\uff0c\u65e0\u987b\u5ba2\u6237\u7aef\u5e72\u9884\u3002 \u4f46\u5ba2\u6237\u7aef\u5982\u679c\u76f4\u63a5\u4f7f\u7528 Kubernetes Service \uff0c\u5c31\u5fc5\u987b\u4f7f\u7528\u4e24\u4e2a\u4e0d\u540c\u7684\u670d\u52a1\u5165\u53e3\u3002 Istio \u53ef\u4ee5\u901a\u8fc7\u6d41\u91cf\u7279\u5f81\u6765\u5b8c\u6210\u5bf9\u540e\u7aef\u670d\u52a1\u7684\u9009\u62e9 , \u5b83\u7684\u6d41\u91cf\u63a7\u5236\u529f\u80fd\u4f1a\u6839\u636e\u6bcf\u6b21\u8bbf\u95ee\u4ea7\u751f\u7684\u6d41\u91cf\u8fdb\u884c\u5224\u65ad\uff0c \u6839\u636e\u5224\u65ad\u7ed3\u679c\u6765\u9009\u62e9\u4e00\u4e2a\u540e\u7aef\u8d1f\u8d23\u672c\u6b21\u8bbf\u95ee\u7684\u54cd\u5e94 \u3002 Kubernetes \u5f53\u7136\u4e5f\u53ef\u4ee5\u8fd9\u6837\u505a, \u4f46\u662f\u56e0\u4e3a Kubernetes \u7684 Service \u4e0d \u5177\u5907\u9009\u62e9\u540e\u7aef\u7684\u80fd\u529b\uff0c\u6240\u4ee5\u5982\u679c\u5b83\u4f7f\u7528\u4e86 Istio \u8fd9\u79cd\u4e00\u5bf9\u591a\u7684\u6a21\u5f0f, \u5219\u540e\u679c\u53ea\u80fd\u662f\u4f7f\u7528\u8f6e\u8be2\u65b9\u5f0f\u968f\u673a\u8c03\u7528\u4e24\u4e2a\u4e0d\u540c\u7684\u5de5\u4f5c\u8d1f\u8f7d \u800c\u5728 Istio \u4e2d\uff0c \u8fd9\u79cd\u540c\u4e00\u670d\u52a1\u4e0d\u540c\u7ec4\u522b\u7684\u540e\u7aef\u88ab\u79f0\u4e3a\u5b50\u96c6(Subset) \uff0c\u4e5f\u7ecf\u5e38\u88ab\u79f0\u4e3a\u670d\u52a1\u7248\u672c\u3002 \u5728 Istio \u4e2d\u5efa\u8bae\u4e3a\u6bcf\u4e2a\u7f51\u683c\u90fd\u8bbe\u7f6e\u660e\u786e\u7684\u76ee\u6807\u8bbf\u95ee\u89c4\u5219\u3002 \u5728\u901a\u8fc7 Istio \u6d41\u91cf\u63a7\u5236\u4e4b\u540e\u4f1a\u9009\u62e9\u660e\u786e\u7684\u5b50\u96c6, \u6839\u636e\u8be5\u89c4\u5219\u6216\u8005\u5728\u5b50\u96c6\u4e2d\u89c4\u5b9a\u7684\u6d41\u91cf\u7b56\u7565\u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u8fd9\u79cd\u89c4\u5219\u5728 Istio \u88ab\u79f0\u4e3a DestionationRule \u4f8b\u5982\u6211\u4eec\u4e3a flaskapp \u5efa\u7acb\u4e00\u4e2a\u76ee\u6807\u89c4\u5219\u5b9a\u4e49 apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: flaskapp spec: host: flaskapp.default.svc.cluster.local trafficPolicy: loadBalancer: simple: LEAST_CONN subsets: - name: v1 labels: version: v1 trafficPolicy: loadBalancer: simple: ROUND_ROBIN - name: v2 labels: version: v2 DestinationRule trafficPolicy / loadBalancer / simple: LEAST_CONN subsets \u8be5\u89c4\u5219\u6709\u4ee5\u4e0b\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u3002 host \uff1a\u662f\u4e00\u4e2a\u5fc5\u8981\u5b57\u6bb5\uff0c \u4ee3\u8868 Kubernetes \u4e2d\u7684\u4e00\u4e2a Service \u8d44\u6e90\uff0c\u6216\u8005\u4e00\u4e2a \u7531 ServiceEntry \u5b9a\u4e49\u7684\u5916\u90e8\u670d\u52a1\u3002 \u4e3a\u4e86\u9632\u6b62 Kubernetes \u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u670d\u52a1\u91cd\u540d, \u8fd9\u91cc\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528\u5b8c\u5168\u9650\u5b9a\u540d\uff0c\u4e5f\u5c31\u662f\u4f7f\u7528 FQDN \u6765\u8d4b\u503c\u3002 trafficPolicy \uff1a\u662f\u6d41\u91cf\u7b56\u7565 \u3002\u5728 DestinationRule \u548c Subsets \u4e24\u7ea7\u4e2d\u90fd\u53ef\u4ee5\u5b9a\u4e49 trafficPolicy \uff0c\u5728 Subset \u4e2d\u8bbe\u7f6e\u7684\u7ea7\u522b\u9ad8\u3002 subsets \uff1a\u5728\u8be5\u5b57\u6bb5\u4e2d\u4f7f\u7528\u6807\u7b7e\u9009\u62e9\u5668\u6765\u5b9a\u4e49\u4e0d\u540c\u7684\u5b50\u96c6\u3002 \u7efc\u4e0a\u6240\u8ff0\uff0c \u6211\u4eec\u4e3a flaskapp \u5efa\u7acb\u4e86 v1 \u548c v2 \u8fd9\u4e24\u4e2a\u5b50\u96c6\uff0c\u5e76\u4e14 v1 \u5b50\u96c6\u4f7f\u7528\u4e86\u72ec\u7acb\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u3002 \u4e3a\u4e86\u540e\u7eed\u73af\u8282\u7684\u987a\u5229\u8fdb\u884c\uff0c\u521b\u5efa\u7684 flaskapp \u670d\u52a1\uff08 Service \u548c Deployment \u521b\u5efa\u76ee\u6807\u89c4\u5219\uff0c\u5c06\u5176\u5206\u6210 v1 \u548c v2 \u4e24\u4e2a\u7248\u672c\uff1a apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: flaskapp spec: host: flaskapp.default.svc.cluster.local subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 \u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a flaskapp-dr.yaml \u5e76\u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u5230 kubernetes \u96c6\u7fa4\uff1b $ kubectl apply -f flaskapp-dr.yaml destinationrule.networking.istio.io/flaskapp configured $ kubectl get dr NAME HOST AGE flaskapp flaskapp.default.svc.cluster.local 6d23h \u8fd9\u6837, \u6211\u4eec\u5c31\u5bf9\u5177\u4f53\u8d1f\u8d23\u6267\u884c\u670d\u52a1\u7684\u4e0b\u4f5c\u8d1f\u8f7d\u6709\u4e86\u4e00\u4e2a\u660e\u786e\u7684\u5b9a\u4e49, \u5e76\u53ef\u4ee5\u5c06\u5176\u5f53\u4f5c\u6d41\u91cf\u63a7\u5236\u7684\u57fa\u7840","title":"1\u3001\u5b9a\u4e49\u76ee\u6807\u89c4\u5219"},{"location":"chap5/9Istio_http1/#2","text":"\u5728\u670d\u52a1\u90e8\u7f72\u5b8c\u6210\u4e4b\u540e, \u6211\u4eec\u4e3a\u5176\u5b9a\u4e49\u4e86\u76ee\u6807\u89c4\u5219\u8282, \u63a5\u4e0b\u6765\u9762\u4e34\u4e00\u4e2a\u95ee\u9898: \u5728\u6ca1\u6709\u4efb\u4f55\u7279\u5b9a\u8def\u7531\u89c4\u5219\u7684\u60c5\u51b5\u4e0b, \u5bf9 flaskpp \u670d\u52a1\u7684\u8bbf\u95ee\u4f1a\u5230\u8fbe\u54ea\u4e2a\u5b50\u96c6\uff08\u6216\u79f0\u7248\u672c\uff09\u5462\uff1f $ kubectl get pod -l app=sleep,version=v1 -o custom-columns='Name:metadata.name' Name sleep-6c9c898f6c-snzx5 sleep-v1-548d87cc5c-wfk7v $ kubectl delete vs flaskapp-default-v2 virtualservice.networking.istio.io \"flaskapp-default-v2\" deleted $ kubectl exec -it sleep-v1-548d87cc5c-wfk7v -c sleep bash bash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done v2 v2 v1 v1 v2 v2 v1 v1 v2 v2 \u5728\u91cd\u590d\u6267\u884c\u540e\u4e0d\u96be\u53d1\u73b0\uff0c\u6211\u4eec\u5b9a\u4e49\u7684\u76ee\u6807\u89c4\u5219\u5e76\u672a\u5f71\u54cd\u901a\u4fe1\u8fc7\u7a0b\uff0c\u8fd8\u662f\u6309\u7167 kube-proxy \u7684\u9ed8\u8ba4\u968f\u673a\u884c\u4e3a\u8fdb\u884c\u8bbf\u95ee\u7684\uff0c\u8fd4\u56de\u7ed3\u679c\u5206\u522b\u6765\u81ea\u4e24\u4e2a\u4e0d\u540c\u7684\u7248\u672c\u3002 Istio \u5efa\u8bae\u4e3a\u6bcf\u4e2a\u670d\u52a1\u90fd\u521b\u5efa\u4e00\u4e2a\u9ed8\u8ba4\u8def\u7531\uff0c\u5728\u8bbf\u95ee\u67d0\u4e00\u670d\u52a1\u7684\u65f6\u5019\uff0c\u5982\u679c\u6ca1\u6709\u7279\u5b9a\u7684\u8def\u7531\u5219\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\u6765\u8bbf\u95ee\u6307\u5b9a\u7684\u5b50\u96c6\uff0c\u4ee5\u6b64\u6765\u786e\u4fdd\u670d\u52a1\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u7684\u884c\u4e3a\u7a33\u5b9a\u6027\u3002 \u9996\u5148\u521b\u5efa\u4e00\u4e2a\u9ed8\u8ba4\u8bbf\u95ee v1 \u7248\u672c\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u6d4b\u8bd5\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 \u8fd9\u662f\u6700\u7b80\u5355\u7684\u4e00\u4e2a VirtualService \u5b9a\u4e49\u3002 VirtualService \u662f Istio \u6d41\u5740\u63a7\u5236\u8fc7\u7a0b\u4e2d\u7684\u4e00\u4e2a\u67a2\u7ebd\u8d1f\u8d23\u5bf9\u6d41\u91cf\u8fdb\u884c\u7504\u522b\u548c\u8f6c\u53d1 \u3002 \u4e0b\u9762\u5bf9\u672c\u8282\u6d89\u53ca\u7684\u6982\u5ff5\u8fdb\u884c\u8bb2\u89e3\u3002 VirtualService \u540c\u6837\u662f\u9488\u5bf9\u4e3b\u673a\u540d\u5de5\u4f5c\u7684\uff0c\u4f46\u6ce8\u610f\u8fd9\u4e2a\u5b57\u6bb5\u662f\u4e00\u4e2a\u6570\u7ec4\u5185\u5bb9\uff0c\u56e0\u6b64\u5b83\u53ef\u4ee5\u9488\u5bf9\u591a\u4e2a\u4e3b\u673a\u540d\u8fdb\u884c\u5de5\u4f5c \uff0c VirtualService \u53ef\u4ee5\u4e3a\u591a\u79cd\u534f\u8bae\u7684\u6d41\u91cf\u63d0\u4f9b\u670d\u52a1\uff0c \u9664\u4e86\u652f\u6301\u672c\u6587\u4f7f\u7528\u7684\u662f HTTP \u8fd8\u652f\u6301 TCP \u548c TLS \u3002 \u5728 http \u5b57\u6bb5\u7684\u4e0b\u4e00\u7ea7, \u5c31\u662f\u5177\u4f53\u7684\u8def\u7531\u89c4\u5219\u4e86\u3002\u4e0d\u96be\u770b\u51fa\uff0c\u8fd9\u91cc\u662f\u652f\u6301\u591a\u7684\u8def\u7531\u7684 \uff0c \u6211\u4eec\u7b80\u5355\u5b9a\u4e49\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u76ee\u6807\uff1a flaskapp.default.svc.cluster.local \u4e5f\u5c31\u662f\u8bf4, flaskapp \u9ed8\u8ba4\u4f7f\u7528 v1 \u7248\u672c\u6765\u5904\u7406\u8bf7\u6c42 \u63a5\u4e0b\u6765\u6d4b\u8bd5\u4e00\u4e0b\u3002 \u9996\u5148\u5c06\u4e0a\u8ff0 YAML \u4ee3\u7801\u4fdd\u5b58\u4e3a flask-default-vs-v1.yaml \uff0c\u7136\u540e\u4f7f\u7528 kubectl apply \u547d\u4ee4\u5c06\u5176\u63d0\u4ea4\u5230 Kubernetes \u96c6\u7fa4\uff1a $ kubectl apply -f flask-default-vs-v1.yaml virtualservice.networking.istio.io/flaskapp created \u518d\u6b21\u8fdb\u5165 sleep pod \u8fdb\u884c\u6d4b\u8bd5 kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash bash-4.4# for i in `seq 10`;do http --body http://flaskapp/env/version;done v1 v1 v1 v1 v1 v1 v1 v1 v1 v1 \u91cd\u590d\u6267\u884c\u547d\u4ee4\u5c31\u4f1a\u53d1\u73b0\u6240\u6709\u8bbf\u95ee\u90fd\u4ece v1 \u7248\u672c\u8fd4\u56de\u4e86, \u8fd9\u8868\u660e\u627e\u4eec\u5b9a\u5236\u7684\u9ed8\u8ba4\u8def\u7531\u5df1\u7ecf\u751f\u6548\u6548 \u5728\u8bbf\u95ee\u8fc7\u7a0b\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95ee kiali \u6765\u67e5\u770b\u6d41\u91cf\u7684\u53ef\u89c6\u5316\u7ed3\u679c\uff0c kiali \u4f1a\u901a\u8fc7\u52a8\u753b\u7684\u5f62\u5f0f\u5448\u73b0\u8bbf\u95ee\u6e05\u51b5 http://127.0.0.1:20001/kiali/console/graph/namespaces/?edges=noEdgeLabels&graphType=versionedApp&namespaces=default&injectServiceNodes=true&duration=60&pi=10000&layout=dagre&unusedNodes=false \u8fd9\u91cc\u7a0d\u4f5c\u56de\u987e\uff0c\u5728 Istio \u4e2d\u90e8\u7f72\u4e00\u4e2a\u4e1a\u52a1\u5e94\u7528\u65f6\uff0c\u5efa\u8bae\u505a\u5230\u4ee5\u4e0b\u51e0\u70b9 \u4f7f\u7528 app \u6807\u7b7e\u8868\u660e\u5e94\u7528\u8eab\u4efd\uff1b \u4f7f\u7528 version \u6807\u7b7e\u8868\u660e\u5e94\u7528\u7248\u672c\uff1b \u521b\u5efa\u76ee\u6807\u89c4\u5219(DestinationRule) \uff1b \u521b\u5efa\u9ed8\u8ba4\u8def\u7531\u89c4\u5219(VirtualService) \u3002 \u9ed8\u8ba4\u8def\u7531\u9664\u4e86\u53ef\u4ee5\u4fdd\u8bc1\u5e94\u7528\u884c\u4e3a\u7684\u7a33\u5b9a\u6027\uff0c \u4e5f\u662f Istio \u7684\u4e00\u4e9b\u914d\u7f6e\u5bf9\u8c61\u7684\u6784\u5efa\u57fa\u7840\u3002 \u56e0\u6b64\u548c\u65e5\u5e38\u7684 Dockerfile \u3001 Service \u3001 Deployment \u7b49\u6e05\u5355\u6587\u4ef6\u4e00\u6837\u9ed8\u8ba4\u8def\u7531\u7684\u914d\u7f6e\u6e05\u5355\u5e94\u8be5\u6210\u4e3a\u670d\u52a1\u7f51\u683c\u73af\u5883\u4e0b\u7684\u5fc5\u8981\u90e8\u7f72\u5185\u5bb9","title":"2\u3001\u5b9a\u4e49\u9ed8\u8ba4\u8def\u7531"},{"location":"chap5/9Istio_http1/#3","text":"\u4e0a\u4e00\u8282\u4e2d\u6709\u8fc7\u63d0\u793a VirtualService \u7684 http \u5b57\u6bb5\u7684\u4e0b\u4e00\u7ea7\u6210\u5458\u662f\u4e00\u4e2a\u6570\u7ec4, \u4ee3\u8868\u591a\u6761\u8def\u7531\u89c4\u5219\u3002 \u8fd9\u5f88\u81ea\u7136\u4f1a\u8ba9\u6211\u4eec\u60f3\u5230\uff1a\u5728\u591a\u7248\u672c\u5e76\u5b58\u7684\u60c5\u51b5\u4e0b\u662f\u5426\u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u7684\u7248\u672c\u8fdb\u884c\u6d41\u5740\u5206\u914d\u5462? \u8fd9\u79cd\u7279\u6027\u5728\u6d4b\u8bd5\u548c\u7248\u672c\u66f4\u65b0\u7684\u6e05\u51b5\u4e0b\u662f\u5f88\u6709\u7528\u7684\uff0c \u4f8b\u5982\u5728\u6211\u4eec\u7684\u65b0\u7248\u672c\u8fd8\u6ca1\u6709\u5b8c\u5168\u901a\u8fc7\u751f\u4ea7\u9a8c\u8bc1\u4e4b\u524d\u6211\u4eec\u53ea\u5e0c\u671b\u5df2\u627f\u62c5\u5c11\u90e8\u5206\u6d41\u91cf\uff0c \u6765\u89c2\u5bdf\u5b83\u5728\u751f\u4ea7\u73af\u5883\u7684\u7a33\u5b9a\u6027\u3002 \u56e0\u4e3a\u6837\u672c\u91cf\u592a\u5c11\uff0c\u6240\u4ee5\u6211\u4eec\u4f1a\u770b\u5230\u5728\u8c03\u7528\u8fc7\u7a0b\u4e2d\u8fd4\u56de\u7684\u5185\u5bb9\u8fd8\u662f\u968f\u673a\u5206\u5e03\u7684\uff0c \u56e0\u6b64\u8fd9\u91cc\u7528\u4e00\u4e2a for \u5faa\u73af\u8fdb\u884c\u591a\u6b21\u6d4b\u8bd5\uff0c\u67e5\u770b\u201cv1\u201d\u5728\u5176\u4e2d\u51fa\u73b0\u7684\u6b21\u6570\uff1a \u5148\u5220\u6389\u539f\u6765\u7684\u5efa\u7acb\u7684 VS ,\u7136\u540e\u8fdb\u5165 sleep pod , \u53ef\u89c1\u5206\u914d\u6bd4\u7387\u63a5\u8fd1 50% $ kubectl get vs NAME GATEWAYS HOSTS AGE flaskapp [flaskapp.default.svc.cluster.local] 22h $ kubectl delete vs flaskapp virtualservice.networking.istio.io \"flaskapp\" deleted $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash for i in `seq 10`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 4 for i in `seq 100`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 50 for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 151 \u4e0b\u9762\u5b9a\u4e49\u4e00\u4e2a\u5206\u6d41\u89c4\u5219\uff1a\u5bf9 flaskpp \u670d\u52a1\u7684\u8bbf\u95ee, \u6709 70\uff05 \u8fdb\u4eba v1 \u7248\u672c, \u6709 30% \u8fdb\u4eba v2 \u7248\u672c. \u76f4\u63a5\u4fee\u6539 flaskapp.virtualservice.yaml ,\u6dfb\u52a0\u5bf9 v2 \u7248\u672c\u7684\u76ee\u6807\u652f\u6301\uff0c \u5e76\u5b9a\u4e49\u5206\u914d\u6743\u91cd apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 weight: 70 - destination: host: flaskapp.default.svc.cluster.local subset: v2 weight: 30 \u4f7f\u7528 kubectl apply \u547d\u4ee4\u63d0\u4ea4\u66f4\u65b0\u540e\u7684\u89c4\u5219\uff0c \u5e76\u6d4b\u8bd5\u5176\u5b9e\u9645\u7ed3\u679c $ kubectl apply -f flaskapp.virtualservice.yaml virtualservice.networking.istio.io/flaskapp created \u8fdb\u4eba Sleep Pod \u8fde\u7eed\u5bf9 flaskapp \u53d1\u51fa\u8bf7\u6c42\u5e76\u7edf\u8ba1\u8fd4\u56de\u7ed3\u679c $ kubectl get vs NAME GATEWAYS HOSTS AGE flaskapp [flaskapp.default.svc.cluster.local] 2m39s $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash for i in `seq 10`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{pr int NF-1}' 8 bash-4.4# for i in `seq 100`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{p rint NF-1}' 59 bash-4.4# for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{p rint NF-1}' 215 \u53ef\u4ee5\u770b\u51fa, \u968f\u82e5\u6d4b\u8bd5\u6b21\u6570\u7684\u589e\u52a0 v1 \u51fa\u73b0\u7684\u6b21\u6570\u4f1a\u9010\u6b65\u63a5\u8fd1\u6211\u4eec\u5b9a\u4e49\u7684\u5206\u914d\u6bd4\u7387\u3002 \u56de\u5230\u73b0\u5b9e\u573a\u666f\u4e2d,\u5982\u679c\u6d4b\u8bd5\u7ed3\u679c\u4e50\u89c2, \u5219\u6211\u4eec\u4f1a\u5e0c\u671b\u4e3a\u65b0\u7248\u672c\u5206\u914d\u66f4\u591a\u7684\u6d41\u5740\u3002 \u8fd9\u65f6\u8be5\u5982\u4f55\u5904\u7406\uff1f \u5f88\u7b80\u5355\uff0c\u4fee\u6539\u8def\u7531\u5373\u53ef\u3002\u6211\u4eec\u7ee7\u7eed\u4fee\u6539\u5e76\u63d0\u4ea4 flaskapp.virtualservice.yaml \u6587\u4ef6 \u4e0d\u540c\u7684\u662f\u8fd9\u6b21v1\u548cv2\u7684\u6bd4\u4f8b\u4ece 70: 30 \u4fee\u6539\u4e3a 10:90 , \u5728\u4fee\u6539\u4e4b\u540e\u91cd\u65b0\u8fdb sleep pod \u884c\u6d4b\u8bd5 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v1 weight: 10 - destination: host: flaskapp.default.svc.cluster.local subset: v2 weight: 90 $ kubectl apply -f flaskapp.virtualservice.yaml virtualservice.networking.istio.io/flaskapp configured $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash $ bash-4.4# for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 32 \u53ef\u4ee5\u770b\u5230\uff0c \u6211\u4eec\u5b9a\u4e49\u7684\u6d41\u867d\u5206\u914d\u539f\u5219\u5df2\u7ecf\u751f\u6548\u4e86 \u66f4\u8fdb\u4e00\u6b65\uff0c \u5982\u679c v2 \u7248\u672c\u6d4b\u8bd5\u6210\u529f,\u5219\u53ef\u4ee5\u518d\u6b21\u4fee\u6539\u5220\u9664 v1 \u7248\u672c\u7684\u8def\u7531\uff0c\u8ba9\u5168\u90e8\u6d41\u91cf\u90fd\u8fdb\u5165 v2 \u7248\u672c. \u4e5f\u5c31\u662f\u4f7f\u7528 v2 \u7248\u672c\u5b8c\u5168\u66ff\u4ee3\u539f\u6709\u7684 v1 \u7248\u672c, \u5b8c\u6210\u6700\u7ec8\u7684\u5347\u7ea7\u3002 \u7ee7\u7eed\u4fee\u6539 flaskapp.virtualservice.yaml ,\u5c06\u5176\u4e2d\u7684 http \u90e8\u5206\u4fee\u6539\u4e3a\u4ec5\u5305\u542b v2 \u7684\u5185\u5bb9 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: flaskapp spec: hosts: - flaskapp.default.svc.cluster.local http: - route: - destination: host: flaskapp.default.svc.cluster.local subset: v2 weight: 100 $ kubectl apply -f flaskapp.virtualservice.yaml virtualservice.networking.istio.io/flaskapp configured \u518d\u6b21\u6d4b\u8bd5\u6d41\u91cf\u5206\u914d\u60c5\u51b5 $ kubectl exec -it sleep-6c9c898f6c-snzx5 -c sleep bash bash-4.4# for i in `seq 300`;do http --body http://flaskapp/env/version; done | awk -F\"v1\" '{print NF-1}' 0 \u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u5df2\u7ecf\u5b8c\u5168\u6ca1\u6709\u6765\u81ea v1 \u7248\u672c\u7684\u54cd\u5e94\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4\u6240\u6709\u6d41\u91cf\u90fd\u5df2\u7ecf\u6309\u8ba1\u5212\u8fdb\u4eba v2 \u7248\u672c\uff0c v1 \u7248\u672c\u53ef\u4ee5\u4e0b\u7ebf \u3002 \u672c\u8282\u6709\u4ee5\u4e0b\u51e0\u70b9\u9700\u8981\u6ce8\u610f\u3002 \u6d41\u91cf\u5206\u914d\u662f\u6709\u6743\u91cd\u7684\uff0c\u5e76\u4e14\u6743\u91cd\u603b\u548c\u5fc5\u987b\u662f 100 \u3002 \u5982\u679c\u4e0d\u663e\u5f0f\u58f0\u660e\u6743\u91cd, \u5219\u5176\u9ed8\u8ba4\u503c\u4e3a 100 \u3002 \u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u7f51\u683c\u73b0\u6709\u7684\u8def\u7531\u89c4\u5219\u6216\u8005\u5176\u4ed6 Istio \u5bf9\u8c61\u5462\uff1f\u65b9\u6cd5\u6709\u4ee5\u4e0b\u4e24\u79cd\u3002 \u4f7f\u7528 kubectl get . Istio \u7684\u8d44\u6e90\u548c Kubernetes \u5185\u7f6e\u7684\u8d44\u6e90\u4e00\u6837\uff0c\u90fd\u80fd\u901a\u8fc7 kubectl \u83b7\u53d6\uff0e\u5e76\u80fd\u591f\u5c55\u793a\u5f53\u524d\u5b58\u5728\u7684 VirtualService \uff1b\u8fd8\u53ef\u4ee5\u4f7f\u7528 kubectl api-resources \u547d\u4ee4\uff0c \u5217\u51fa\u5f53\u524d\u96c6\u7fa4\u652f\u6301\u7684\u6240\u6709\u5bf9\u8c61\u7c7b\u578b\u3002 \u4f7f\u7528 Kiali \u3002\u9009\u62e9\u5de6\u4fa7\u83dc\u5355\u4e2d\u7684 Istio Config \uff0c\u5982\u56fe\u6240\u793a\u4e3a\u6211\u4eec\u65b0\u5efa\u7684\u8def\u7531\u89c4\u5219\u548c\u76ee\u6807\u89c4\u5219\u3002","title":"3\u3001 \u6d41\u91cf\u7684\u62c6\u5206\u548c\u8fc1\u79fb"},{"location":"chap6/1Istio_install_docker/","text":"L1 Docker for Mac\u5b89\u88c5istio(k8s-1.10/istio-1.3) \u4ece\u4eca\u5929\u8d77\uff0c\u6211\u4eec\u5c06\u63a8\u51fa\u4e00\u8d77\u5b66 istio \u7684\u7cfb\u5217\u8bfe\u7a0b\uff0c\u548c\u5927\u5bb6\u4e00\u8d77\u5b66\u4e60\u70ed\u95e8\u7684 Servie Mesh \u6280\u672f\uff1aistio\uff0c\u4eca\u5929\u7b2c\u4e00\u7bc7\u5185\u5bb9\uff1a\u5728 Docker for Mac \u4e0a\u9762\u5b89\u88c5 istio\u3002 1\u3001\u5b89\u88c5 docker \u548c k8s \u6211\u8fd9\u91cc\u5b89\u88c5\u7684\u662f Stable \u7248\u672c\uff0c\u6700\u65b0\u7684\u7a33\u5b9a\u7248\u672c\u4e4b\u4e2d\u4e5f\u81ea\u5e26\u4e86 Kubernetes\uff0c\u4e4b\u524d\u7684\u7248\u672c\u4e2d\u9700\u8981 Edge \u7248\u672c\u624d\u884c\u3002 docker for mac \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u76f4\u63a5\u901a\u8fc7\u4e0b\u9762\u7684\u754c\u9762\u542f\u7528 Kubernetes \u5373\u53ef\u5b89\u88c5\u4e0a Kubernetes: Kubernetes -> preference -> Kubernetes \u7531\u4e8e\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u9700\u8981\u62c9\u53d6\u4e00\u7cfb\u5217\u955c\u50cf\uff0c\u6240\u4ee5\u53ef\u80fd\u9700\u8981\u82b1\u8d39\u51e0\u5206\u949f\u65f6\u95f4\uff0c\u5f53\u53f3\u4e0b\u89d2\u51fa\u73b0\u6807\u8bc6 kubernetes is running \u65f6\u5219\u8bc1\u660e\u5b89\u88c5\u6210\u529f\u4e86\u3002 \u5f53\u524d\u7248\u672c\u5b89\u88c5\u7684 Kubernetes \u7248\u672c\u662f v1.10.3\uff0c\u6d89\u53ca\u5230\u7684\u4e00\u4e9b\u955c\u50cf\u5982\u4e0b\uff1a $ docker ../images/exp |grep k8s k8s.gcr.io/kubernetes-dashboard-amd64 v1.10.0 0dab2435c100 3 weeks ago 122MB k8s.gcr.io/kube-proxy-amd64 v1.10.3 4261d315109d 4 months ago 97.1MB k8s.gcr.io/kube-apiserver-amd64 v1.10.3 e03746fe22c3 4 months ago 225MB k8s.gcr.io/kube-controller-manager-amd64 v1.10.3 40c8d10b2d11 4 months ago 148MB k8s.gcr.io/kube-scheduler-amd64 v1.10.3 353b8f1d102e 4 months ago 50.4MB k8s.gcr.io/etcd-amd64 3.1.12 52920ad46f5b 6 months ago 193MB k8s.gcr.io/k8s-dns-dnsmasq-nanny-amd64 1.14.8 c2ce1ffb51ed 8 months ago 41MB k8s.gcr.io/k8s-dns-sidecar-amd64 1.14.8 6f7f2dc7fab5 8 months ago 42.2MB k8s.gcr.io/k8s-dns-kube-dns-amd64 1.14.8 80cc5ea4b547 8 months ago 50.5MB k8s.gcr.io/pause-amd64 3.1 da86e6ba6ca1 9 months ago 742kB \u53e6\u5916\uff0c\u7531\u4e8e\u5b89\u88c5 istio \u9700\u8981\u7528\u5230\u7684\u8d44\u6e90\u8f83\u591a\uff0c\u5efa\u8bae\u589e\u5927 CPU \u548c\u5185\u5b58\u7684\u4f7f\u7528\u9650\u5236\uff1a 2\u3001\u5b89\u88c5 kubectl Kubernetes \u96c6\u7fa4\u542f\u7528\u6210\u529f\u4e86\uff0c\u73b0\u5728\u8981\u53bb\u64cd\u4f5c\u8be5\u96c6\u7fa4\u7684\u8bdd\u5c31\u5f97\u5b89\u88c5\u4e00\u4e2a kubectl \u5de5\u5177\uff0c\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d kubectl \u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u5230\u672c\u5730\u76f4\u63a5\u4f7f\u7528\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Mac \u4e0a\u5b89\u88c5\u8f6f\u4ef6\u7684\u5e38\u7528\u5de5\u5177 Homebrew\uff1a $ kubectl version Client Version: version.Info{Major:\"1\", Minor:\"13\", GitVersion:\"v1.13.2\", GitCommit:\"cff46ab41ff0bb44d8584413b598ad8360ec1def\", GitTreeState:\"clean\", BuildDate:\"2019-01-13T23:15:13Z\", GoVersion:\"go1.11.4\", Compiler:\"gc\", Platform:\"darwin/amd64\"} Server Version: version.Info{Major:\"1\", Minor:\"10\", GitVersion:\"v1.10.11\", GitCommit:\"637c7e288581ee40ab4ca210618a89a555b6e7e9\", GitTreeState:\"clean\", BuildDate:\"2018-11-26T14:25:46Z\", GoVersion:\"go1.9.3\", Compiler:\"gc\", Platform:\"linux/amd64\"} \u6ce8\u610f docker for mac \u7684 k8s \u7684 context \u662f docker-for-desktop \uff0c \u5982\u679c\u76ee\u524d\u5df2\u6709\u5176\u4ed6\u96c6\u7fa4\u73af\u5883\uff0c\u9700\u8981\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u5207\u6362 \uff1a $ kubectl config get-contexts CURRENT NAME CLUSTER AUTHINFO NAMESPACE * docker-for-desktop docker-for-desktop-cluster docker-for-desktop If not docker-for-desktop $ kubectl config use-context docker-for-desktop kubectl \u5de5\u5177\u5b89\u88c5\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u6267\u884c\u547d\u4ee4\u9a8c\u8bc1\u4e0b\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u64cd\u4f5c\u96c6\u7fa4\uff1a $ kubectl get ns NAME STATUS AGE default Active 4d docker Active 4d kube-public Active 4d kube-system Active 4d $ kubectl get nodes NAME STATUS ROLES AGE VERSION docker-for-desktop Ready master 4d v1.10.11 $ kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE etcd-docker-for-desktop 1/1 Running 0 4d kube-apiserver-docker-for-desktop 1/1 Running 0 4d kube-controller-manager-docker-for-desktop 1/1 Running 0 4d kube-dns-86f4d74b45-57fmt 3/3 Running 0 4d kube-proxy-zlc2n 1/1 Running 0 4d kube-scheduler-docker-for-desktop 1/1 Running 0 4d \u80fd\u591f\u6b63\u5e38\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u8bc1\u660e Kubernetes \u96c6\u7fa4\u4e00\u5207\u6b63\u5e38\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 kubectl \u5de5\u5177\u64cd\u4f5c\u96c6\u7fa4\uff0c\u8fd9\u4e00\u6b65\u975e\u5e38\u91cd\u8981\u3002 3\u3001\u5b89\u88c5 kubernetes dashboard https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/ \u76f4\u63a5\u4e0b\u8f7d\u5b98\u65b9\u63a8\u8350\u7684 dashboard yaml \u6587\u4ef6\uff1a $ wget https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml --2019-04-19 10:00:01-- https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml Resolving raw.githubusercontent.com... 151.101.248.133 Connecting to raw.githubusercontent.com|151.101.248.133|:443... connected. HTTP request sent, awaiting response... 200 OK Length: 1454 (1.4K) [text/plain] Saving to: 'kubernetes-dashboard.yaml' kubernetes-dashboard.yaml 100%[===============================================================>] 1.42K --.-KB/s in 0s 2019-04-19 10:00:02 (53.3 MB/s) - 'kubernetes-dashboard.yaml' saved [4784] \u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\uff0c\u6211\u4eec\u5c06 kubernetes-dashboard.yaml \u6587\u4ef6\u4e2d \u7684 Service \u6539\u6210 NodePort \u7c7b\u578b\u7684\u670d\u52a1\uff1a apiVersion: v1 kind: Secret metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard-certs namespace: kube-system type: Opaque --- ... # ------------------- Dashboard Service ------------------- # kind: Service apiVersion: v1 metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kube-system spec: ports: - port: 443 targetPort: 8443 type: NodePort selector: k8s-app: kubernetes-dashboard $ kubectl create -f kubernetes-dashboard.yaml $ kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE ... kubernetes-dashboard-669f9bbd46-6vlng 1/1 Running 0 59s $ kubectl get svc -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 10.96.0.10 <none> 53/UDP,53/TCP 4d kubernetes-dashboard NodePort 10.100.124.180 <none> 443:30771/TCP 20s \u73b0\u5728\u76f4\u63a5\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee https://localhost:30771 \u5373\u53ef\uff0c \u8bb0\u4f4f\u4e00\u5b9a\u8981\u52a0\u4e0a https \uff0c\u5728\u767b\u5f55\u9875\u9762\u76f4\u63a5\u8df3\u8fc7\u6743\u9650\u9a8c\u8bc1\u5373\u53ef\uff1a How to get token from dashboard $ kubectl get secret,sa,role,rolebinding,services,deployments -n kube-system | grep dashboard secret/kubernetes-dashboard-certs Opaque 0 7m secret/kubernetes-dashboard-csrf Opaque 1 7m secret/kubernetes-dashboard-key-holder Opaque 2 6m secret/kubernetes-dashboard-token-sl5kb kubernetes.io/service-account-token 3 7m serviceaccount/kubernetes-dashboard 1 7m role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal 7m2s rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal 7m2s service/kubernetes-dashboard NodePort 10.100.124.180 <none> 443:30771/TCP 7m deployment.extensions/kubernetes-dashboard 1 $ kubectl describe secret kubernetes-dashboard-token-sl5kb -n kube-system Name: kubernetes-dashboard-token-sl5kb Namespace: kube-system Labels: <none> Annotations: kubernetes.io/service-account.name: kubernetes-dashboard kubernetes.io/service-account.uid: dc0660b1-6248-11e9-a3d8-025000000001 Type: kubernetes.io/service-account-token Data ==== namespace: 11 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1zbDVrYiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImRjMDY2MGIxLTYyNDgtMTFlOS1hM2Q4LTAyNTAwMDAwMDAwMSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.fttRDpKfmLY7oozOuwgYIGnm-WLre-RbpY5rM0qHTsihl7gNsOwUtlGwPHGfK7SQADlvTMElAVScdEUGg665HCrglQubl-DfVKEBGZiYcmjdi1E2fhp7cdsbL3hJpZi6iW126ykoH9q7q_EzNrLiUfnCGIaXlGGIHch1Y8xdnNjo5HpSwH7wknX9sWyi0dEI5LR5MYMQ1IiqqKqW5whC9Kr4RvD8h-h7SkuvymGydSEEQefIhTgjZhpP2wmmY__QKzz4JdykHu5a94lqu5CZWpDvoSHtCPooOKau71K8bUqAatG487ov31dmQxcP9TaWHFOnSyynJMGfv4Rlwbag1A ca.crt: 1025 bytes Put the token into the dashboard 3\u3001\u5b89\u88c5 Helm https://istio.io/docs/setup/kubernetes/install/helm/ istio \u5b98\u65b9\u7ed9\u51fa\u4e86\u51e0\u79cd\u5b89\u88c5\u7684\u65b9\u5f0f\uff0c\u624b\u52a8\u901a\u8fc7 yaml \u6587\u4ef6\u53bb\u5b89\u88c5\u4e5f\u6bd4\u8f83\u65b9\u4fbf\uff0c\u4f46\u662f\u8fd8\u662f\u9700\u8981\u5fcd\u53d7\u955c\u50cf\u7ffb\u5899\u7684\u95ee\u9898\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u5b98\u65b9\u66f4\u52a0\u63a8\u8350\u7684 Helm \u65b9\u5f0f\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u800c\u4e14\u8be5\u65b9\u5f0f\u6d89\u53ca\u5230\u7684\u955c\u50cf\u90fd\u5728 docker hub \u4e0a\u9762\uff0c\u4e0d\u9700\u8981\u7ffb\u5899\u5c31\u53ef\u4ee5\u62c9\u53d6\u3002 3-1 \u9996\u5148\u5b89\u88c5 Helm \u5305\u7ba1\u5de5\u5177 \u901a\u8fc7 Homebrew \u5b89\u88c5 Helm \u7684\u5ba2\u6237\u7aef\uff1a $ brew install kubernetes-helm ... $ helm version Client: &version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"} Error: could not find tiller \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u9700\u8981\u521d\u59cb\u5316 Helm \u5bf9\u5e94\u7684\u670d\u52a1\u7aef\u7a0b\u5e8f Tiller Server \uff1a $ helm init Creating /Users/jxi/.helm Creating /Users/jxi/.helm/repository Creating /Users/jxi/.helm/repository/cache Creating /Users/jxi/.helm/repository/local Creating /Users/jxi/.helm/plugins Creating /Users/jxi/.helm/starters Creating /Users/jxi/.helm/cache/archive Creating /Users/jxi/.helm/repository/repositories.yaml Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com Adding local repo with URL: http://127.0.0.1:8879/charts $HELM_HOME has been configured at /Users/jxi/.helm. Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster. Please note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy. To prevent this, run `helm init` with the --tiller-tls-verify flag. For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation Happy Helming! \u53e6\u5916\u6211\u4eec\u8fd8\u9700\u8981\u4e3a Tiller \u521b\u5efa\u4e00\u4e2a ServiceAccount \uff0c\u8ba9\u4ed6\u6709\u6743\u9650\u53bb\u64cd\u4f5c\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e9b\u8d44\u6e90\uff1a $ kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE tiller-deploy-78c6868dd6-bcpb5 1/1 Running 0 1m tiller-rbac.yaml apiVersion: v1 kind: ServiceAccount metadata: name: tiller namespace: kube-system --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata: name: tiller roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: tiller namespace: kube-system \u4fdd\u5b58\u4e3a tiller-rbac.yaml \u7136\u540e\u521b\u5efa\uff1a $ kubectl apply -f tiller-rbac.yaml serviceaccount/tiller created clusterrolebinding.rbac.authorization.k8s.io/tiller created $ kubectl get sa,secret,role,rolebinding -n kube-system | grep tiller NAME SECRETS AGE serviceaccount/tiller 1 1m secret/tiller-token-9krvm kubernetes.io/service-account-token 3 1m \u521b\u5efa\u4e86 tiller \u7684 ServceAccount \u540e\u8fd8\u6ca1\u5b8c\uff0c\u56e0\u4e3a\u6211\u4eec\u7684 Tiller \u4e4b\u524d\u5df2\u7ecf\u5c31\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u800c\u4e14\u662f\u6ca1\u6709\u6307\u5b9a ServiceAccount \u7684\uff0c \u6240\u4ee5\u6211\u4eec\u9700\u8981\u7ed9 Tiller \u6253\u4e0a\u4e00\u4e2a ServiceAccount \u7684\u8865\u4e01 \uff1a $ kubectl patch deploy --namespace kube-system tiller-deploy -p '{\"spec\":{\"template\":{\"spec\":{\"serviceAccount\":\"tiller\"}}}}' deployment.extensions/tiller-deploy patched \u81f3\u6b64, Helm \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u914d\u7f6e\u5b8c\u6210\u4e86\uff1a $ helm version Client: &version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"} Server: &version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"} 4\u3001\u5b89\u88c5 istio \u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684 istio\uff1ahttps://github.com/istio/istio/releases/ \uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 istio-1.1.3-osx.tar.gz \uff0c\u7136\u540e\u89e3\u538b\uff0c\u5c06 bin/ \u4e2d\u7684 istioctl \u53ef\u6267\u884c\u6587\u4ef6\u62f7\u8d1d\u5230 $PATH \u5305\u542b\u7684\u76ee\u5f55\u4e2d\u3002 $ echo $PATH /usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin ... $ cd $ ls -la | grep istio -rwxr-xr-x@ 1 jxi 660531311 62307200 Apr 13 06:36 istioctl \u9a8c\u8bc1\u662f\u5426\u751f\u6548\uff1a $ istioctl version version.BuildInfo{Version:\"1.1.3\", GitRevision:\"d19179769183541c5db473ae8d062ca899abb3be\", User:\"root\", Host:\"fbd493e1-5d72-11e9-b00d-0a580a2c0205\", GolangVersion:\"go1.10.4\", DockerHub:\"docker.io/istio\", BuildStatus:\"Clean\", GitTag:\"1.1.2-56-gd191797\"} 4-1 \u7136\u540e\u4f7f\u7528 helm \u547d\u4ee4\u76f4\u63a5\u5b89\u88c5 cd /Users/jxi/Devops/bookinfo/istio-1.1.3 https://istio.io/docs/setup/kubernetes/install/helm/ Option 2: Install the istio-init chart to bootstrap all the Istio\u2019s CRDs $ helm install install/kubernetes/helm/istio-init --name istio-init --namespace istio-system NAME: istio-init LAST DEPLOYED: Fri Apr 19 11:19:08 2019 NAMESPACE: istio-system STATUS: DEPLOYED RESOURCES: ==> v1/ClusterRole NAME AGE istio-init-istio-system 0s ==> v1/ClusterRoleBinding NAME AGE istio-init-admin-role-binding-istio-system 0s ==> v1/ConfigMap NAME DATA AGE istio-crd-10 1 0s istio-crd-11 1 0s ==> v1/Job NAME COMPLETIONS DURATION AGE istio-init-crd-10 0/1 0s 0s istio-init-crd-11 0/1 0s 0s ==> v1/Pod(related) NAME READY STATUS RESTARTS AGE istio-init-crd-10-p84cq 0/1 ContainerCreating 0 0s istio-init-crd-11-g9vfx 0/1 ContainerCreating 0 0s ==> v1/ServiceAccount NAME SECRETS AGE istio-init-service-account 1 0s $ kubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE istio-init-crd-10-p84cq 0/1 Completed 0 6s istio-init-crd-11-g9vfx 0/1 Completed 0 6s $ kubectl get crds | grep 'istio.io\\|certmanager.k8s.io' | wc -l 53 \u7136\u540e\u4f7f\u7528 helm \u547d\u4ee4\u76f4\u63a5\u5b89\u88c5\uff1a $ helm install install/kubernetes/helm/istio --name istio --namespace istio-system --set tracing.enabled=true --set kiali.enabled=true --set grafana.enabled=true NAME: istio LAST DEPLOYED: Fri Apr 19 11:21:24 2019 NAMESPACE: istio-system STATUS: DEPLOYED RESOURCES: ==> v1/ClusterRole NAME AGE istio-citadel-istio-system 22s istio-galley-istio-system 23s istio-grafana-post-install-istio-system 23s istio-ingressgateway-istio-system 23s istio-mixer-istio-system 23s istio-pilot-istio-system 23s istio-reader 22s istio-sidecar-injector-istio-system 22s kiali 23s prometheus-istio-system 22s ==> v1/ClusterRoleBinding NAME AGE istio-citadel-istio-system 22s istio-galley-admin-role-binding-istio-system 22s istio-grafana-post-install-role-binding-istio-system 22s istio-ingressgateway-istio-system 22s istio-kiali-admin-role-binding-istio-system 22s istio-mixer-admin-role-binding-istio-system 22s istio-multi 22s istio-pilot-istio-system 22s istio-sidecar-injector-admin-role-binding-istio-system 22s prometheus-istio-system 22s ==> v1/ConfigMap NAME DATA AGE istio 2 23s istio-galley-configuration 1 23s istio-grafana 2 23s istio-grafana-configuration-dashboards-galley-dashboard 1 23s istio-grafana-configuration-dashboards-istio-mesh-dashboard 1 23s istio-grafana-configuration-dashboards-istio-performance-dashboard 1 23s istio-grafana-configuration-dashboards-istio-service-dashboard 1 23s istio-grafana-configuration-dashboards-istio-workload-dashboard 1 23s istio-grafana-configuration-dashboards-mixer-dashboard 1 23s istio-grafana-configuration-dashboards-pilot-dashboard 1 23s istio-grafana-custom-resources 2 23s istio-security-custom-resources 2 23s istio-sidecar-injector 1 23s kiali 1 23s prometheus 1 23s ==> v1/Pod(related) NAME READY STATUS RESTARTS AGE grafana-7f8d4cdd9-btb24 0/1 ContainerCreating 0 22s istio-citadel-f55646d75-cq7fn 0/1 ContainerCreating 0 22s istio-galley-76c4fcb6d5-f546l 0/1 ContainerCreating 0 22s istio-ingressgateway-5c94457876-txblr 0/1 ContainerCreating 0 22s istio-pilot-77f7d5b9f-lrx5r 0/2 ContainerCreating 0 22s istio-policy-56d88f4f86-464zx 0/2 ContainerCreating 0 22s istio-sidecar-injector-5cb4cfdbc8-cr4nd 0/1 ContainerCreating 0 22s istio-telemetry-78967c7b9b-kdkn4 0/2 ContainerCreating 0 22s istio-tracing-79c7955c98-6jtsg 0/1 ContainerCreating 0 21s kiali-7677969794-kvsxs 1/1 Running 0 22s prometheus-5b59764bb9-qvqgj 0/1 Init:0/1 0 22s ==> v1/Role NAME AGE istio-ingressgateway-sds 22s ==> v1/RoleBinding NAME AGE istio-ingressgateway-sds 22s ==> v1/Service NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.111.237.238 <none> 3000/TCP 22s istio-citadel ClusterIP 10.96.74.209 <none> 8060/TCP,15014/TCP 22s istio-galley ClusterIP 10.105.161.220 <none> 443/TCP,15014/TCP,9901/TCP 22s istio-ingressgateway LoadBalancer 10.99.227.74 localhost 15020:32340/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30713/TCP,15030:32699/TCP,15031:30774/TCP,15032:31966/TCP,15443:32409/TCP 22s istio-pilot ClusterIP 10.98.254.224 <none> 15010/TCP,15011/TCP,8080/TCP,15014/TCP 22s istio-policy ClusterIP 10.110.112.240 <none> 9091/TCP,15004/TCP,15014/TCP 22s istio-sidecar-injector ClusterIP 10.100.107.179 <none> 443/TCP 22s istio-telemetry ClusterIP 10.102.207.93 <none> 9091/TCP,15004/TCP,15014/TCP,42422/TCP 22s jaeger-agent ClusterIP None <none> 5775/UDP,6831/UDP,6832/UDP 22s jaeger-collector ClusterIP 10.98.27.207 <none> 14267/TCP,14268/TCP 22s jaeger-query ClusterIP 10.96.49.6 <none> 16686/TCP 22s kiali ClusterIP 10.96.89.238 <none> 20001/TCP 22s prometheus ClusterIP 10.110.170.226 <none> 9090/TCP 22s tracing ClusterIP 10.106.179.73 <none> 80/TCP 22s zipkin ClusterIP 10.108.211.139 <none> 9411/TCP 22s ==> v1/ServiceAccount NAME SECRETS AGE istio-citadel-service-account 1 23s istio-galley-service-account 1 23s istio-grafana-post-install-account 1 23s istio-ingressgateway-service-account 1 23s istio-mixer-service-account 1 23s istio-multi 1 23s istio-pilot-service-account 1 23s istio-security-post-install-account 1 23s istio-sidecar-injector-service-account 1 23s kiali-service-account 1 23s prometheus 1 23s ==> v1alpha2/attributemanifest NAME AGE istioproxy 22s kubernetes 22s ==> v1alpha2/handler NAME AGE kubernetesenv 22s prometheus 22s ==> v1alpha2/kubernetes NAME AGE attributes 22s ==> v1alpha2/metric NAME AGE requestcount 22s requestduration 22s requestsize 22s responsesize 22s tcpbytereceived 22s tcpbytesent 22s tcpconnectionsclosed 22s tcpconnectionsopened 22s ==> v1alpha2/rule NAME AGE kubeattrgenrulerule 22s promhttp 22s promtcp 22s promtcpconnectionclosed 22s promtcpconnectionopen 22s tcpkubeattrgenrulerule 22s ==> v1alpha3/DestinationRule NAME AGE istio-policy 22s istio-telemetry 22s ==> v1beta1/ClusterRole NAME AGE istio-security-post-install-istio-system 22s ==> v1beta1/ClusterRoleBinding NAME AGE istio-security-post-install-role-binding-istio-system 22s ==> v1beta1/Deployment NAME READY UP-TO-DATE AVAILABLE AGE grafana 0/1 1 0 22s istio-citadel 0/1 1 0 22s istio-galley 0/1 1 0 22s istio-ingressgateway 0/1 1 0 22s istio-pilot 0/1 1 0 22s istio-policy 0/1 1 0 22s istio-sidecar-injector 0/1 1 0 22s istio-telemetry 0/1 1 0 22s istio-tracing 0/1 1 0 22s kiali 1/1 1 1 22s prometheus 0/1 1 0 22s ==> v1beta1/MutatingWebhookConfiguration NAME AGE istio-sidecar-injector 22s ==> v1beta1/PodDisruptionBudget NAME MIN AVAILABLE MAX UNAVAILABLE ALLOWED DISRUPTIONS AGE istio-galley 1 N/A 0 23s istio-ingressgateway 1 N/A 0 23s istio-pilot 1 N/A 0 23s istio-policy 1 N/A 0 23s istio-telemetry 1 N/A 0 23s ==> v2beta1/HorizontalPodAutoscaler NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE istio-ingressgateway Deployment/istio-ingressgateway <unknown>/80% 1 5 0 22s istio-pilot Deployment/istio-pilot <unknown>/80% 1 5 0 22s istio-policy Deployment/istio-policy <unknown>/80% 1 5 0 22s istio-telemetry Deployment/istio-telemetry <unknown>/80% 1 5 0 22s NOTES: Thank you for installing istio. Your release is named istio. To get started running application with Istio, execute the following steps: 1. Label namespace that application object will be deployed to by the following command (take default namespace as an example) $ kubectl label namespace default istio-injection=enabled $ kubectl get namespace -L istio-injection 2. Deploy your applications $ kubectl apply -f <your-application>.yaml For more information on running Istio, visit: https://istio.io/ \u9ed8\u8ba4 tracing \u3001 kiali \u3001 grafana \u5e76\u4e0d\u4f1a\u5f00\u542f\uff0c\u8fd9\u91cc\u9700\u8981\u5728\u5b89\u88c5\u65f6\u624b\u52a8 \u2013set xxx.enabled=true \u8fdb\u884c\u5f00\u542f\u3002\u914d\u7f6e\u8bf4\u660e\u53ef\u67e5\u770b\u6587\u6863\uff1a install/kubernetes/helm/istio/README.md \u7531\u4e8e\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u6d89\u53ca\u5230\u7684\u955c\u50cf\u6bd4\u8f83\u591a\uff0c\u7136\u540e\u9694\u4e00\u4f1a\u513f\u518d\u67e5\u770b Kubernets \u4e2d\u7684 istio-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a: $ kubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE grafana-7f8d4cdd9-btb24 1/1 Running 0 4m istio-citadel-f55646d75-cq7fn 1/1 Running 0 4m istio-galley-76c4fcb6d5-f546l 1/1 Running 0 4m istio-ingressgateway-5c94457876-txblr 1/1 Running 0 4m istio-init-crd-10-p84cq 0/1 Completed 0 6m istio-init-crd-11-g9vfx 0/1 Completed 0 6m istio-pilot-77f7d5b9f-lrx5r 2/2 Running 0 4m istio-policy-56d88f4f86-464zx 2/2 Running 3 4m istio-sidecar-injector-5cb4cfdbc8-cr4nd 1/1 Running 0 4m istio-telemetry-78967c7b9b-kdkn4 2/2 Running 4 4m istio-tracing-79c7955c98-6jtsg 1/1 Running 0 4m kiali-7677969794-kvsxs 1/1 Running 0 4m prometheus-5b59764bb9-qvqgj 1/1 Running 0 4m $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.111.237.238 <none> 3000/TCP 5m istio-citadel ClusterIP 10.96.74.209 <none> 8060/TCP,15014/TCP 5m istio-galley ClusterIP 10.105.161.220 <none> 443/TCP,15014/TCP,9901/TCP 5m istio-ingressgateway LoadBalancer 10.99.227.74 localhost 15020:32340/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30713/TCP,15030:32699/TCP,15031:30774/TCP,15032:31966/TCP,15443:32409/TCP 5m istio-pilot ClusterIP 10.98.254.224 <none> 15010/TCP,15011/TCP,8080/TCP,15014/TCP 5m istio-policy ClusterIP 10.110.112.240 <none> 9091/TCP,15004/TCP,15014/TCP 5m istio-sidecar-injector ClusterIP 10.100.107.179 <none> 443/TCP 5m istio-telemetry ClusterIP 10.102.207.93 <none> 9091/TCP,15004/TCP,15014/TCP,42422/TCP 5m jaeger-agent ClusterIP None <none> 5775/UDP,6831/UDP,6832/UDP 5m jaeger-collector ClusterIP 10.98.27.207 <none> 14267/TCP,14268/TCP 5m jaeger-query ClusterIP 10.96.49.6 <none> 16686/TCP 5m kiali ClusterIP 10.96.89.238 <none> 20001/TCP 5m prometheus ClusterIP 10.110.170.226 <none> 9090/TCP 5m tracing ClusterIP 10.106.179.73 <none> 80/TCP 5m zipkin ClusterIP 10.108.211.139 <none> 9411/TCP \u5230\u8fd9\u91cc istio \u5c31\u7b97\u90e8\u7f72\u6210\u529f\u4e86\u3002 5\u3001\u5b89\u88c5\u793a\u4f8b \u76ee\u524d\u5927\u90e8\u5206 istio \u7684\u4f7f\u7528\u793a\u4f8b\u90fd\u662f\u4f7f\u7528\u7684\u5b98\u65b9\u7684 Bookinfo \u5e94\u7528\u793a\u4f8b: \u8fd9\u4e2a\u793a\u4f8b\u662f\u4e00\u4e2a\u591a\u8bed\u8a00\u5f00\u53d1\u7684\u5fae\u670d\u52a1\u5e94\u7528\u3002\u9996\u5148\u6709\u4e00\u4e2a python \u5b9e\u73b0\u7684 ProductPage \u5165\u53e3\u5e94\u7528\u5c55\u793a\u4e66\u7c4d\u7684\u8be6\u7ec6\u4fe1\u606f\u548c\u8bc4\u4ef7\uff0c\u5b83\u4f1a\u8c03\u7528 Ruby \u5b9e\u73b0\u7684 Detail \u5e94\u7528\u83b7\u53d6\u4e66\u7c4d\u8be6\u60c5\uff0c\u540c\u65f6\u8c03\u7528 Java \u5b9e\u73b0\u7684\u8bc4\u4ef7\u5e94\u7528\u83b7\u53d6\u4e66\u7c4d\u7684\u8bc4\u4ef7\u3002 \u4e0a\u56fe\u5c55\u793a\u4e86\u4f7f\u7528 istio \u540e\uff0c\u6574\u4e2a\u5e94\u7528\u5b9e\u9645\u7684\u7ed3\u6784\u3002\u6240\u6709\u7684\u5fae\u670d\u52a1\u90fd\u548c\u4e00\u4e2a Envoy sidecar \u5c01\u88c5\u5230\u4e00\u8d77\uff0c sidecar \u62e6\u622a\u6240\u6709\u5230\u8fbe\u548c\u79bb\u5f00\u670d\u52a1\u7684\u8bf7\u6c42\u3002 \u9996\u5148\u8fdb\u5165\u89e3\u538b\u7684 istio \u76ee\u5f55\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a $ kubectl apply -f <(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml) service/details created deployment.extensions/details-v1 created service/ratings created deployment.extensions/ratings-v1 created service/reviews created deployment.extensions/reviews-v1 created deployment.extensions/reviews-v2 created deployment.extensions/reviews-v3 created service/productpage created deployment.extensions/productpage-v1 created \u5176\u4e2d bookinfo.yaml \u5c31\u662f\u666e\u901a\u7684 k8s \u7684 Deployment \u548c Service \u7684 yaml \u6587\u4ef6\uff0c \u800c istioctl kube-inject \u4f1a\u5728\u8fd9\u4e2a\u6587\u4ef6\u7684\u57fa\u7840\u4e0a\u5411\u5176\u4e2d\u7684 Deployment \u8ffd\u52a0\u5185\u5bb9\uff0c\u901a\u5e38\u4f1a\u8ffd\u52a0\u4e00\u4e2a initContainer(image:docker.io/istio/proxy_init) \u4f5c\u4e3a sidecar \u7684\u5f62\u5f0f\u4e0e\u5e94\u7528\u7684\u5bb9\u5668\u8fd0\u884c\u5728\u540c\u4e00\u4e2a pod \u4e2d\u3002 \u8fc7\u4e00\u4f1a\u513f\u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b service \u548c pod \u542f\u52a8: $ kubectl get po NAME READY STATUS RESTARTS AGE details-v1-7988597495-mvh8s 2/2 Running 0 2m productpage-v1-5447c894b9-m89r7 2/2 Running 0 2m ratings-v1-5cfbb7d4c5-5l6fl 2/2 Running 0 2m reviews-v1-b65dfcc76-9tgtt 2/2 Running 0 2m reviews-v2-5dd8bf9bcc-ql2b8 2/2 Running 0 2m reviews-v3-7bd5bb9786-tzbtz 2/2 Running 0 2m $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE details ClusterIP 10.105.227.220 <none> 9080/TCP 2m kubernetes ClusterIP 10.96.0.1 <none> 443/TCP 4d productpage ClusterIP 10.108.78.109 <none> 9080/TCP 2m ratings ClusterIP 10.109.154.91 <none> 9080/TCP 2m reviews ClusterIP 10.99.40.241 <none> 9080/TCP 2m \u73b0\u5728\u5e94\u7528\u7684\u670d\u52a1\u90fd\u90e8\u7f72\u6210\u529f\u5e76\u542f\u52a8\u4e86\uff0c\u73b0\u5728\u9700\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\uff0c\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a istio gateway \u3002 gateway \u76f8\u5f53\u4e8e k8s \u7684 ingress controller \u548c ingress \u3002 \u5b83\u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e load balancer \uff0c\u901a\u5e38\u5728\u670d\u52a1\u7f51\u683c\u8fb9\u7f18\u4f5c\u4e3a\u5e94\u7528\u7684 ingress trafic \u7ba1\u7406\u3002 \u7136\u540e\u521b\u5efa\u4e00\u4e2a gateway: $ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml gateway.networking.istio.io/bookinfo-gateway created virtualservice.networking.istio.io/bookinfo created \u9a8c\u8bc1 gateway \u662f\u5426\u542f\u52a8\u6210\u529f: $ istioctl get gateway Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) GATEWAY NAME HOSTS NAMESPACE AGE bookinfo-gateway * default 12s $ kubectl get gateway NAME CREATED AT bookinfo-gateway 38s \u5b98\u65b9\u6587\u6863\u4e2d\u540e\u9762\u8fd8\u4f1a\u53bb\u83b7\u53d6 ingress \u7684 ip \u548c\u7aef\u53e3\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 docker for mac \u5b9e\u9645\u4e0a\u4e0d\u9700\u8981\u4e86\uff0c\u5728 service \u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u8fd9\u6837\u7684\u4e00\u6761 service \u4fe1\u606f\uff1a $ kubectl get service -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) istio-ingressgateway LoadBalancer 10.99.227.74 localhost 15020:32340/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30713/TCP,15030:32699/TCP,15031:30774/TCP,15032:31966/TCP,15443:32409/TCP 20m \u8fd9\u91cc\u4f7f\u7528\u7684\u662f LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u5b9e\u9645\u4e0a\u662f\u7528\u6765\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684 \uff0c\u5982\u679c\u6211\u4eec\u6ca1\u6709\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\u8bdd\uff0c\u53ef\u4ee5\u5c06\u8fd9\u91cc\u7c7b\u578b\u6539\u6210 NodePort \uff0c\u4f46\u662f\u8fd9\u6837\u6211\u4eec\u8981\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u5c31\u5f97\u52a0\u4e0a nodePort \u7aef\u53e3\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u5176\u5b9e\u76f4\u63a5\u4f7f\u7528 localhost \u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 Bookinfo \uff0c \u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u5730\u5740\uff1a http://localhost/productpage \u5373\u53ef \u5237\u65b0\u9875\u9762\u53ef\u4ee5 \u770b\u5230 Book Reviews \u53d1\u751f\u4e86\u6539\u53d8\uff0c\u56e0\u4e3a\u8c03\u7528\u5230\u4e86\u4e0d\u540c\u7684 Reviews\u670d\u52a1\uff1a","title":"L1 Docker for Mac\u5b89\u88c5istio(istio-1.3)"},{"location":"chap6/1Istio_install_docker/#l1-docker-for-macistiok8s-110istio-13","text":"\u4ece\u4eca\u5929\u8d77\uff0c\u6211\u4eec\u5c06\u63a8\u51fa\u4e00\u8d77\u5b66 istio \u7684\u7cfb\u5217\u8bfe\u7a0b\uff0c\u548c\u5927\u5bb6\u4e00\u8d77\u5b66\u4e60\u70ed\u95e8\u7684 Servie Mesh \u6280\u672f\uff1aistio\uff0c\u4eca\u5929\u7b2c\u4e00\u7bc7\u5185\u5bb9\uff1a\u5728 Docker for Mac \u4e0a\u9762\u5b89\u88c5 istio\u3002","title":"L1 Docker for Mac\u5b89\u88c5istio(k8s-1.10/istio-1.3)"},{"location":"chap6/1Istio_install_docker/#1-docker-k8s","text":"\u6211\u8fd9\u91cc\u5b89\u88c5\u7684\u662f Stable \u7248\u672c\uff0c\u6700\u65b0\u7684\u7a33\u5b9a\u7248\u672c\u4e4b\u4e2d\u4e5f\u81ea\u5e26\u4e86 Kubernetes\uff0c\u4e4b\u524d\u7684\u7248\u672c\u4e2d\u9700\u8981 Edge \u7248\u672c\u624d\u884c\u3002 docker for mac \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u76f4\u63a5\u901a\u8fc7\u4e0b\u9762\u7684\u754c\u9762\u542f\u7528 Kubernetes \u5373\u53ef\u5b89\u88c5\u4e0a Kubernetes: Kubernetes -> preference -> Kubernetes \u7531\u4e8e\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u9700\u8981\u62c9\u53d6\u4e00\u7cfb\u5217\u955c\u50cf\uff0c\u6240\u4ee5\u53ef\u80fd\u9700\u8981\u82b1\u8d39\u51e0\u5206\u949f\u65f6\u95f4\uff0c\u5f53\u53f3\u4e0b\u89d2\u51fa\u73b0\u6807\u8bc6 kubernetes is running \u65f6\u5219\u8bc1\u660e\u5b89\u88c5\u6210\u529f\u4e86\u3002 \u5f53\u524d\u7248\u672c\u5b89\u88c5\u7684 Kubernetes \u7248\u672c\u662f v1.10.3\uff0c\u6d89\u53ca\u5230\u7684\u4e00\u4e9b\u955c\u50cf\u5982\u4e0b\uff1a $ docker ../images/exp |grep k8s k8s.gcr.io/kubernetes-dashboard-amd64 v1.10.0 0dab2435c100 3 weeks ago 122MB k8s.gcr.io/kube-proxy-amd64 v1.10.3 4261d315109d 4 months ago 97.1MB k8s.gcr.io/kube-apiserver-amd64 v1.10.3 e03746fe22c3 4 months ago 225MB k8s.gcr.io/kube-controller-manager-amd64 v1.10.3 40c8d10b2d11 4 months ago 148MB k8s.gcr.io/kube-scheduler-amd64 v1.10.3 353b8f1d102e 4 months ago 50.4MB k8s.gcr.io/etcd-amd64 3.1.12 52920ad46f5b 6 months ago 193MB k8s.gcr.io/k8s-dns-dnsmasq-nanny-amd64 1.14.8 c2ce1ffb51ed 8 months ago 41MB k8s.gcr.io/k8s-dns-sidecar-amd64 1.14.8 6f7f2dc7fab5 8 months ago 42.2MB k8s.gcr.io/k8s-dns-kube-dns-amd64 1.14.8 80cc5ea4b547 8 months ago 50.5MB k8s.gcr.io/pause-amd64 3.1 da86e6ba6ca1 9 months ago 742kB \u53e6\u5916\uff0c\u7531\u4e8e\u5b89\u88c5 istio \u9700\u8981\u7528\u5230\u7684\u8d44\u6e90\u8f83\u591a\uff0c\u5efa\u8bae\u589e\u5927 CPU \u548c\u5185\u5b58\u7684\u4f7f\u7528\u9650\u5236\uff1a","title":"1\u3001\u5b89\u88c5 docker \u548c k8s"},{"location":"chap6/1Istio_install_docker/#2-kubectl","text":"Kubernetes \u96c6\u7fa4\u542f\u7528\u6210\u529f\u4e86\uff0c\u73b0\u5728\u8981\u53bb\u64cd\u4f5c\u8be5\u96c6\u7fa4\u7684\u8bdd\u5c31\u5f97\u5b89\u88c5\u4e00\u4e2a kubectl \u5de5\u5177\uff0c\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d kubectl \u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u5230\u672c\u5730\u76f4\u63a5\u4f7f\u7528\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Mac \u4e0a\u5b89\u88c5\u8f6f\u4ef6\u7684\u5e38\u7528\u5de5\u5177 Homebrew\uff1a $ kubectl version Client Version: version.Info{Major:\"1\", Minor:\"13\", GitVersion:\"v1.13.2\", GitCommit:\"cff46ab41ff0bb44d8584413b598ad8360ec1def\", GitTreeState:\"clean\", BuildDate:\"2019-01-13T23:15:13Z\", GoVersion:\"go1.11.4\", Compiler:\"gc\", Platform:\"darwin/amd64\"} Server Version: version.Info{Major:\"1\", Minor:\"10\", GitVersion:\"v1.10.11\", GitCommit:\"637c7e288581ee40ab4ca210618a89a555b6e7e9\", GitTreeState:\"clean\", BuildDate:\"2018-11-26T14:25:46Z\", GoVersion:\"go1.9.3\", Compiler:\"gc\", Platform:\"linux/amd64\"} \u6ce8\u610f docker for mac \u7684 k8s \u7684 context \u662f docker-for-desktop \uff0c \u5982\u679c\u76ee\u524d\u5df2\u6709\u5176\u4ed6\u96c6\u7fa4\u73af\u5883\uff0c\u9700\u8981\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u5207\u6362 \uff1a $ kubectl config get-contexts CURRENT NAME CLUSTER AUTHINFO NAMESPACE * docker-for-desktop docker-for-desktop-cluster docker-for-desktop If not docker-for-desktop $ kubectl config use-context docker-for-desktop kubectl \u5de5\u5177\u5b89\u88c5\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u6267\u884c\u547d\u4ee4\u9a8c\u8bc1\u4e0b\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u64cd\u4f5c\u96c6\u7fa4\uff1a $ kubectl get ns NAME STATUS AGE default Active 4d docker Active 4d kube-public Active 4d kube-system Active 4d $ kubectl get nodes NAME STATUS ROLES AGE VERSION docker-for-desktop Ready master 4d v1.10.11 $ kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE etcd-docker-for-desktop 1/1 Running 0 4d kube-apiserver-docker-for-desktop 1/1 Running 0 4d kube-controller-manager-docker-for-desktop 1/1 Running 0 4d kube-dns-86f4d74b45-57fmt 3/3 Running 0 4d kube-proxy-zlc2n 1/1 Running 0 4d kube-scheduler-docker-for-desktop 1/1 Running 0 4d \u80fd\u591f\u6b63\u5e38\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u8bc1\u660e Kubernetes \u96c6\u7fa4\u4e00\u5207\u6b63\u5e38\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 kubectl \u5de5\u5177\u64cd\u4f5c\u96c6\u7fa4\uff0c\u8fd9\u4e00\u6b65\u975e\u5e38\u91cd\u8981\u3002","title":"2\u3001\u5b89\u88c5 kubectl"},{"location":"chap6/1Istio_install_docker/#3-kubernetes-dashboard","text":"https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/ \u76f4\u63a5\u4e0b\u8f7d\u5b98\u65b9\u63a8\u8350\u7684 dashboard yaml \u6587\u4ef6\uff1a $ wget https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml --2019-04-19 10:00:01-- https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml Resolving raw.githubusercontent.com... 151.101.248.133 Connecting to raw.githubusercontent.com|151.101.248.133|:443... connected. HTTP request sent, awaiting response... 200 OK Length: 1454 (1.4K) [text/plain] Saving to: 'kubernetes-dashboard.yaml' kubernetes-dashboard.yaml 100%[===============================================================>] 1.42K --.-KB/s in 0s 2019-04-19 10:00:02 (53.3 MB/s) - 'kubernetes-dashboard.yaml' saved [4784] \u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\uff0c\u6211\u4eec\u5c06 kubernetes-dashboard.yaml \u6587\u4ef6\u4e2d \u7684 Service \u6539\u6210 NodePort \u7c7b\u578b\u7684\u670d\u52a1\uff1a apiVersion: v1 kind: Secret metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard-certs namespace: kube-system type: Opaque --- ... # ------------------- Dashboard Service ------------------- # kind: Service apiVersion: v1 metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kube-system spec: ports: - port: 443 targetPort: 8443 type: NodePort selector: k8s-app: kubernetes-dashboard $ kubectl create -f kubernetes-dashboard.yaml $ kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE ... kubernetes-dashboard-669f9bbd46-6vlng 1/1 Running 0 59s $ kubectl get svc -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 10.96.0.10 <none> 53/UDP,53/TCP 4d kubernetes-dashboard NodePort 10.100.124.180 <none> 443:30771/TCP 20s \u73b0\u5728\u76f4\u63a5\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee https://localhost:30771 \u5373\u53ef\uff0c \u8bb0\u4f4f\u4e00\u5b9a\u8981\u52a0\u4e0a https \uff0c\u5728\u767b\u5f55\u9875\u9762\u76f4\u63a5\u8df3\u8fc7\u6743\u9650\u9a8c\u8bc1\u5373\u53ef\uff1a How to get token from dashboard $ kubectl get secret,sa,role,rolebinding,services,deployments -n kube-system | grep dashboard secret/kubernetes-dashboard-certs Opaque 0 7m secret/kubernetes-dashboard-csrf Opaque 1 7m secret/kubernetes-dashboard-key-holder Opaque 2 6m secret/kubernetes-dashboard-token-sl5kb kubernetes.io/service-account-token 3 7m serviceaccount/kubernetes-dashboard 1 7m role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal 7m2s rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal 7m2s service/kubernetes-dashboard NodePort 10.100.124.180 <none> 443:30771/TCP 7m deployment.extensions/kubernetes-dashboard 1 $ kubectl describe secret kubernetes-dashboard-token-sl5kb -n kube-system Name: kubernetes-dashboard-token-sl5kb Namespace: kube-system Labels: <none> Annotations: kubernetes.io/service-account.name: kubernetes-dashboard kubernetes.io/service-account.uid: dc0660b1-6248-11e9-a3d8-025000000001 Type: kubernetes.io/service-account-token Data ==== namespace: 11 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1zbDVrYiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImRjMDY2MGIxLTYyNDgtMTFlOS1hM2Q4LTAyNTAwMDAwMDAwMSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.fttRDpKfmLY7oozOuwgYIGnm-WLre-RbpY5rM0qHTsihl7gNsOwUtlGwPHGfK7SQADlvTMElAVScdEUGg665HCrglQubl-DfVKEBGZiYcmjdi1E2fhp7cdsbL3hJpZi6iW126ykoH9q7q_EzNrLiUfnCGIaXlGGIHch1Y8xdnNjo5HpSwH7wknX9sWyi0dEI5LR5MYMQ1IiqqKqW5whC9Kr4RvD8h-h7SkuvymGydSEEQefIhTgjZhpP2wmmY__QKzz4JdykHu5a94lqu5CZWpDvoSHtCPooOKau71K8bUqAatG487ov31dmQxcP9TaWHFOnSyynJMGfv4Rlwbag1A ca.crt: 1025 bytes Put the token into the dashboard","title":"3\u3001\u5b89\u88c5 kubernetes dashboard"},{"location":"chap6/1Istio_install_docker/#3-helm","text":"https://istio.io/docs/setup/kubernetes/install/helm/ istio \u5b98\u65b9\u7ed9\u51fa\u4e86\u51e0\u79cd\u5b89\u88c5\u7684\u65b9\u5f0f\uff0c\u624b\u52a8\u901a\u8fc7 yaml \u6587\u4ef6\u53bb\u5b89\u88c5\u4e5f\u6bd4\u8f83\u65b9\u4fbf\uff0c\u4f46\u662f\u8fd8\u662f\u9700\u8981\u5fcd\u53d7\u955c\u50cf\u7ffb\u5899\u7684\u95ee\u9898\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u5b98\u65b9\u66f4\u52a0\u63a8\u8350\u7684 Helm \u65b9\u5f0f\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u800c\u4e14\u8be5\u65b9\u5f0f\u6d89\u53ca\u5230\u7684\u955c\u50cf\u90fd\u5728 docker hub \u4e0a\u9762\uff0c\u4e0d\u9700\u8981\u7ffb\u5899\u5c31\u53ef\u4ee5\u62c9\u53d6\u3002","title":"3\u3001\u5b89\u88c5 Helm"},{"location":"chap6/1Istio_install_docker/#3-1-helm","text":"\u901a\u8fc7 Homebrew \u5b89\u88c5 Helm \u7684\u5ba2\u6237\u7aef\uff1a $ brew install kubernetes-helm ... $ helm version Client: &version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"} Error: could not find tiller \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u9700\u8981\u521d\u59cb\u5316 Helm \u5bf9\u5e94\u7684\u670d\u52a1\u7aef\u7a0b\u5e8f Tiller Server \uff1a $ helm init Creating /Users/jxi/.helm Creating /Users/jxi/.helm/repository Creating /Users/jxi/.helm/repository/cache Creating /Users/jxi/.helm/repository/local Creating /Users/jxi/.helm/plugins Creating /Users/jxi/.helm/starters Creating /Users/jxi/.helm/cache/archive Creating /Users/jxi/.helm/repository/repositories.yaml Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com Adding local repo with URL: http://127.0.0.1:8879/charts $HELM_HOME has been configured at /Users/jxi/.helm. Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster. Please note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy. To prevent this, run `helm init` with the --tiller-tls-verify flag. For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation Happy Helming! \u53e6\u5916\u6211\u4eec\u8fd8\u9700\u8981\u4e3a Tiller \u521b\u5efa\u4e00\u4e2a ServiceAccount \uff0c\u8ba9\u4ed6\u6709\u6743\u9650\u53bb\u64cd\u4f5c\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e9b\u8d44\u6e90\uff1a $ kubectl get pods -n kube-system NAME READY STATUS RESTARTS AGE tiller-deploy-78c6868dd6-bcpb5 1/1 Running 0 1m tiller-rbac.yaml apiVersion: v1 kind: ServiceAccount metadata: name: tiller namespace: kube-system --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata: name: tiller roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: tiller namespace: kube-system \u4fdd\u5b58\u4e3a tiller-rbac.yaml \u7136\u540e\u521b\u5efa\uff1a $ kubectl apply -f tiller-rbac.yaml serviceaccount/tiller created clusterrolebinding.rbac.authorization.k8s.io/tiller created $ kubectl get sa,secret,role,rolebinding -n kube-system | grep tiller NAME SECRETS AGE serviceaccount/tiller 1 1m secret/tiller-token-9krvm kubernetes.io/service-account-token 3 1m \u521b\u5efa\u4e86 tiller \u7684 ServceAccount \u540e\u8fd8\u6ca1\u5b8c\uff0c\u56e0\u4e3a\u6211\u4eec\u7684 Tiller \u4e4b\u524d\u5df2\u7ecf\u5c31\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u800c\u4e14\u662f\u6ca1\u6709\u6307\u5b9a ServiceAccount \u7684\uff0c \u6240\u4ee5\u6211\u4eec\u9700\u8981\u7ed9 Tiller \u6253\u4e0a\u4e00\u4e2a ServiceAccount \u7684\u8865\u4e01 \uff1a $ kubectl patch deploy --namespace kube-system tiller-deploy -p '{\"spec\":{\"template\":{\"spec\":{\"serviceAccount\":\"tiller\"}}}}' deployment.extensions/tiller-deploy patched \u81f3\u6b64, Helm \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u914d\u7f6e\u5b8c\u6210\u4e86\uff1a $ helm version Client: &version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"} Server: &version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"}","title":"3-1 \u9996\u5148\u5b89\u88c5 Helm \u5305\u7ba1\u5de5\u5177"},{"location":"chap6/1Istio_install_docker/#4-istio","text":"\u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684 istio\uff1ahttps://github.com/istio/istio/releases/ \uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 istio-1.1.3-osx.tar.gz \uff0c\u7136\u540e\u89e3\u538b\uff0c\u5c06 bin/ \u4e2d\u7684 istioctl \u53ef\u6267\u884c\u6587\u4ef6\u62f7\u8d1d\u5230 $PATH \u5305\u542b\u7684\u76ee\u5f55\u4e2d\u3002 $ echo $PATH /usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin ... $ cd $ ls -la | grep istio -rwxr-xr-x@ 1 jxi 660531311 62307200 Apr 13 06:36 istioctl \u9a8c\u8bc1\u662f\u5426\u751f\u6548\uff1a $ istioctl version version.BuildInfo{Version:\"1.1.3\", GitRevision:\"d19179769183541c5db473ae8d062ca899abb3be\", User:\"root\", Host:\"fbd493e1-5d72-11e9-b00d-0a580a2c0205\", GolangVersion:\"go1.10.4\", DockerHub:\"docker.io/istio\", BuildStatus:\"Clean\", GitTag:\"1.1.2-56-gd191797\"}","title":"4\u3001\u5b89\u88c5 istio"},{"location":"chap6/1Istio_install_docker/#4-1-helm","text":"cd /Users/jxi/Devops/bookinfo/istio-1.1.3 https://istio.io/docs/setup/kubernetes/install/helm/ Option 2: Install the istio-init chart to bootstrap all the Istio\u2019s CRDs $ helm install install/kubernetes/helm/istio-init --name istio-init --namespace istio-system NAME: istio-init LAST DEPLOYED: Fri Apr 19 11:19:08 2019 NAMESPACE: istio-system STATUS: DEPLOYED RESOURCES: ==> v1/ClusterRole NAME AGE istio-init-istio-system 0s ==> v1/ClusterRoleBinding NAME AGE istio-init-admin-role-binding-istio-system 0s ==> v1/ConfigMap NAME DATA AGE istio-crd-10 1 0s istio-crd-11 1 0s ==> v1/Job NAME COMPLETIONS DURATION AGE istio-init-crd-10 0/1 0s 0s istio-init-crd-11 0/1 0s 0s ==> v1/Pod(related) NAME READY STATUS RESTARTS AGE istio-init-crd-10-p84cq 0/1 ContainerCreating 0 0s istio-init-crd-11-g9vfx 0/1 ContainerCreating 0 0s ==> v1/ServiceAccount NAME SECRETS AGE istio-init-service-account 1 0s $ kubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE istio-init-crd-10-p84cq 0/1 Completed 0 6s istio-init-crd-11-g9vfx 0/1 Completed 0 6s $ kubectl get crds | grep 'istio.io\\|certmanager.k8s.io' | wc -l 53 \u7136\u540e\u4f7f\u7528 helm \u547d\u4ee4\u76f4\u63a5\u5b89\u88c5\uff1a $ helm install install/kubernetes/helm/istio --name istio --namespace istio-system --set tracing.enabled=true --set kiali.enabled=true --set grafana.enabled=true NAME: istio LAST DEPLOYED: Fri Apr 19 11:21:24 2019 NAMESPACE: istio-system STATUS: DEPLOYED RESOURCES: ==> v1/ClusterRole NAME AGE istio-citadel-istio-system 22s istio-galley-istio-system 23s istio-grafana-post-install-istio-system 23s istio-ingressgateway-istio-system 23s istio-mixer-istio-system 23s istio-pilot-istio-system 23s istio-reader 22s istio-sidecar-injector-istio-system 22s kiali 23s prometheus-istio-system 22s ==> v1/ClusterRoleBinding NAME AGE istio-citadel-istio-system 22s istio-galley-admin-role-binding-istio-system 22s istio-grafana-post-install-role-binding-istio-system 22s istio-ingressgateway-istio-system 22s istio-kiali-admin-role-binding-istio-system 22s istio-mixer-admin-role-binding-istio-system 22s istio-multi 22s istio-pilot-istio-system 22s istio-sidecar-injector-admin-role-binding-istio-system 22s prometheus-istio-system 22s ==> v1/ConfigMap NAME DATA AGE istio 2 23s istio-galley-configuration 1 23s istio-grafana 2 23s istio-grafana-configuration-dashboards-galley-dashboard 1 23s istio-grafana-configuration-dashboards-istio-mesh-dashboard 1 23s istio-grafana-configuration-dashboards-istio-performance-dashboard 1 23s istio-grafana-configuration-dashboards-istio-service-dashboard 1 23s istio-grafana-configuration-dashboards-istio-workload-dashboard 1 23s istio-grafana-configuration-dashboards-mixer-dashboard 1 23s istio-grafana-configuration-dashboards-pilot-dashboard 1 23s istio-grafana-custom-resources 2 23s istio-security-custom-resources 2 23s istio-sidecar-injector 1 23s kiali 1 23s prometheus 1 23s ==> v1/Pod(related) NAME READY STATUS RESTARTS AGE grafana-7f8d4cdd9-btb24 0/1 ContainerCreating 0 22s istio-citadel-f55646d75-cq7fn 0/1 ContainerCreating 0 22s istio-galley-76c4fcb6d5-f546l 0/1 ContainerCreating 0 22s istio-ingressgateway-5c94457876-txblr 0/1 ContainerCreating 0 22s istio-pilot-77f7d5b9f-lrx5r 0/2 ContainerCreating 0 22s istio-policy-56d88f4f86-464zx 0/2 ContainerCreating 0 22s istio-sidecar-injector-5cb4cfdbc8-cr4nd 0/1 ContainerCreating 0 22s istio-telemetry-78967c7b9b-kdkn4 0/2 ContainerCreating 0 22s istio-tracing-79c7955c98-6jtsg 0/1 ContainerCreating 0 21s kiali-7677969794-kvsxs 1/1 Running 0 22s prometheus-5b59764bb9-qvqgj 0/1 Init:0/1 0 22s ==> v1/Role NAME AGE istio-ingressgateway-sds 22s ==> v1/RoleBinding NAME AGE istio-ingressgateway-sds 22s ==> v1/Service NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.111.237.238 <none> 3000/TCP 22s istio-citadel ClusterIP 10.96.74.209 <none> 8060/TCP,15014/TCP 22s istio-galley ClusterIP 10.105.161.220 <none> 443/TCP,15014/TCP,9901/TCP 22s istio-ingressgateway LoadBalancer 10.99.227.74 localhost 15020:32340/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30713/TCP,15030:32699/TCP,15031:30774/TCP,15032:31966/TCP,15443:32409/TCP 22s istio-pilot ClusterIP 10.98.254.224 <none> 15010/TCP,15011/TCP,8080/TCP,15014/TCP 22s istio-policy ClusterIP 10.110.112.240 <none> 9091/TCP,15004/TCP,15014/TCP 22s istio-sidecar-injector ClusterIP 10.100.107.179 <none> 443/TCP 22s istio-telemetry ClusterIP 10.102.207.93 <none> 9091/TCP,15004/TCP,15014/TCP,42422/TCP 22s jaeger-agent ClusterIP None <none> 5775/UDP,6831/UDP,6832/UDP 22s jaeger-collector ClusterIP 10.98.27.207 <none> 14267/TCP,14268/TCP 22s jaeger-query ClusterIP 10.96.49.6 <none> 16686/TCP 22s kiali ClusterIP 10.96.89.238 <none> 20001/TCP 22s prometheus ClusterIP 10.110.170.226 <none> 9090/TCP 22s tracing ClusterIP 10.106.179.73 <none> 80/TCP 22s zipkin ClusterIP 10.108.211.139 <none> 9411/TCP 22s ==> v1/ServiceAccount NAME SECRETS AGE istio-citadel-service-account 1 23s istio-galley-service-account 1 23s istio-grafana-post-install-account 1 23s istio-ingressgateway-service-account 1 23s istio-mixer-service-account 1 23s istio-multi 1 23s istio-pilot-service-account 1 23s istio-security-post-install-account 1 23s istio-sidecar-injector-service-account 1 23s kiali-service-account 1 23s prometheus 1 23s ==> v1alpha2/attributemanifest NAME AGE istioproxy 22s kubernetes 22s ==> v1alpha2/handler NAME AGE kubernetesenv 22s prometheus 22s ==> v1alpha2/kubernetes NAME AGE attributes 22s ==> v1alpha2/metric NAME AGE requestcount 22s requestduration 22s requestsize 22s responsesize 22s tcpbytereceived 22s tcpbytesent 22s tcpconnectionsclosed 22s tcpconnectionsopened 22s ==> v1alpha2/rule NAME AGE kubeattrgenrulerule 22s promhttp 22s promtcp 22s promtcpconnectionclosed 22s promtcpconnectionopen 22s tcpkubeattrgenrulerule 22s ==> v1alpha3/DestinationRule NAME AGE istio-policy 22s istio-telemetry 22s ==> v1beta1/ClusterRole NAME AGE istio-security-post-install-istio-system 22s ==> v1beta1/ClusterRoleBinding NAME AGE istio-security-post-install-role-binding-istio-system 22s ==> v1beta1/Deployment NAME READY UP-TO-DATE AVAILABLE AGE grafana 0/1 1 0 22s istio-citadel 0/1 1 0 22s istio-galley 0/1 1 0 22s istio-ingressgateway 0/1 1 0 22s istio-pilot 0/1 1 0 22s istio-policy 0/1 1 0 22s istio-sidecar-injector 0/1 1 0 22s istio-telemetry 0/1 1 0 22s istio-tracing 0/1 1 0 22s kiali 1/1 1 1 22s prometheus 0/1 1 0 22s ==> v1beta1/MutatingWebhookConfiguration NAME AGE istio-sidecar-injector 22s ==> v1beta1/PodDisruptionBudget NAME MIN AVAILABLE MAX UNAVAILABLE ALLOWED DISRUPTIONS AGE istio-galley 1 N/A 0 23s istio-ingressgateway 1 N/A 0 23s istio-pilot 1 N/A 0 23s istio-policy 1 N/A 0 23s istio-telemetry 1 N/A 0 23s ==> v2beta1/HorizontalPodAutoscaler NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE istio-ingressgateway Deployment/istio-ingressgateway <unknown>/80% 1 5 0 22s istio-pilot Deployment/istio-pilot <unknown>/80% 1 5 0 22s istio-policy Deployment/istio-policy <unknown>/80% 1 5 0 22s istio-telemetry Deployment/istio-telemetry <unknown>/80% 1 5 0 22s NOTES: Thank you for installing istio. Your release is named istio. To get started running application with Istio, execute the following steps: 1. Label namespace that application object will be deployed to by the following command (take default namespace as an example) $ kubectl label namespace default istio-injection=enabled $ kubectl get namespace -L istio-injection 2. Deploy your applications $ kubectl apply -f <your-application>.yaml For more information on running Istio, visit: https://istio.io/ \u9ed8\u8ba4 tracing \u3001 kiali \u3001 grafana \u5e76\u4e0d\u4f1a\u5f00\u542f\uff0c\u8fd9\u91cc\u9700\u8981\u5728\u5b89\u88c5\u65f6\u624b\u52a8 \u2013set xxx.enabled=true \u8fdb\u884c\u5f00\u542f\u3002\u914d\u7f6e\u8bf4\u660e\u53ef\u67e5\u770b\u6587\u6863\uff1a install/kubernetes/helm/istio/README.md \u7531\u4e8e\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u6d89\u53ca\u5230\u7684\u955c\u50cf\u6bd4\u8f83\u591a\uff0c\u7136\u540e\u9694\u4e00\u4f1a\u513f\u518d\u67e5\u770b Kubernets \u4e2d\u7684 istio-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a: $ kubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE grafana-7f8d4cdd9-btb24 1/1 Running 0 4m istio-citadel-f55646d75-cq7fn 1/1 Running 0 4m istio-galley-76c4fcb6d5-f546l 1/1 Running 0 4m istio-ingressgateway-5c94457876-txblr 1/1 Running 0 4m istio-init-crd-10-p84cq 0/1 Completed 0 6m istio-init-crd-11-g9vfx 0/1 Completed 0 6m istio-pilot-77f7d5b9f-lrx5r 2/2 Running 0 4m istio-policy-56d88f4f86-464zx 2/2 Running 3 4m istio-sidecar-injector-5cb4cfdbc8-cr4nd 1/1 Running 0 4m istio-telemetry-78967c7b9b-kdkn4 2/2 Running 4 4m istio-tracing-79c7955c98-6jtsg 1/1 Running 0 4m kiali-7677969794-kvsxs 1/1 Running 0 4m prometheus-5b59764bb9-qvqgj 1/1 Running 0 4m $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.111.237.238 <none> 3000/TCP 5m istio-citadel ClusterIP 10.96.74.209 <none> 8060/TCP,15014/TCP 5m istio-galley ClusterIP 10.105.161.220 <none> 443/TCP,15014/TCP,9901/TCP 5m istio-ingressgateway LoadBalancer 10.99.227.74 localhost 15020:32340/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30713/TCP,15030:32699/TCP,15031:30774/TCP,15032:31966/TCP,15443:32409/TCP 5m istio-pilot ClusterIP 10.98.254.224 <none> 15010/TCP,15011/TCP,8080/TCP,15014/TCP 5m istio-policy ClusterIP 10.110.112.240 <none> 9091/TCP,15004/TCP,15014/TCP 5m istio-sidecar-injector ClusterIP 10.100.107.179 <none> 443/TCP 5m istio-telemetry ClusterIP 10.102.207.93 <none> 9091/TCP,15004/TCP,15014/TCP,42422/TCP 5m jaeger-agent ClusterIP None <none> 5775/UDP,6831/UDP,6832/UDP 5m jaeger-collector ClusterIP 10.98.27.207 <none> 14267/TCP,14268/TCP 5m jaeger-query ClusterIP 10.96.49.6 <none> 16686/TCP 5m kiali ClusterIP 10.96.89.238 <none> 20001/TCP 5m prometheus ClusterIP 10.110.170.226 <none> 9090/TCP 5m tracing ClusterIP 10.106.179.73 <none> 80/TCP 5m zipkin ClusterIP 10.108.211.139 <none> 9411/TCP \u5230\u8fd9\u91cc istio \u5c31\u7b97\u90e8\u7f72\u6210\u529f\u4e86\u3002","title":"4-1 \u7136\u540e\u4f7f\u7528 helm \u547d\u4ee4\u76f4\u63a5\u5b89\u88c5"},{"location":"chap6/1Istio_install_docker/#5","text":"\u76ee\u524d\u5927\u90e8\u5206 istio \u7684\u4f7f\u7528\u793a\u4f8b\u90fd\u662f\u4f7f\u7528\u7684\u5b98\u65b9\u7684 Bookinfo \u5e94\u7528\u793a\u4f8b: \u8fd9\u4e2a\u793a\u4f8b\u662f\u4e00\u4e2a\u591a\u8bed\u8a00\u5f00\u53d1\u7684\u5fae\u670d\u52a1\u5e94\u7528\u3002\u9996\u5148\u6709\u4e00\u4e2a python \u5b9e\u73b0\u7684 ProductPage \u5165\u53e3\u5e94\u7528\u5c55\u793a\u4e66\u7c4d\u7684\u8be6\u7ec6\u4fe1\u606f\u548c\u8bc4\u4ef7\uff0c\u5b83\u4f1a\u8c03\u7528 Ruby \u5b9e\u73b0\u7684 Detail \u5e94\u7528\u83b7\u53d6\u4e66\u7c4d\u8be6\u60c5\uff0c\u540c\u65f6\u8c03\u7528 Java \u5b9e\u73b0\u7684\u8bc4\u4ef7\u5e94\u7528\u83b7\u53d6\u4e66\u7c4d\u7684\u8bc4\u4ef7\u3002 \u4e0a\u56fe\u5c55\u793a\u4e86\u4f7f\u7528 istio \u540e\uff0c\u6574\u4e2a\u5e94\u7528\u5b9e\u9645\u7684\u7ed3\u6784\u3002\u6240\u6709\u7684\u5fae\u670d\u52a1\u90fd\u548c\u4e00\u4e2a Envoy sidecar \u5c01\u88c5\u5230\u4e00\u8d77\uff0c sidecar \u62e6\u622a\u6240\u6709\u5230\u8fbe\u548c\u79bb\u5f00\u670d\u52a1\u7684\u8bf7\u6c42\u3002 \u9996\u5148\u8fdb\u5165\u89e3\u538b\u7684 istio \u76ee\u5f55\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a $ kubectl apply -f <(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml) service/details created deployment.extensions/details-v1 created service/ratings created deployment.extensions/ratings-v1 created service/reviews created deployment.extensions/reviews-v1 created deployment.extensions/reviews-v2 created deployment.extensions/reviews-v3 created service/productpage created deployment.extensions/productpage-v1 created \u5176\u4e2d bookinfo.yaml \u5c31\u662f\u666e\u901a\u7684 k8s \u7684 Deployment \u548c Service \u7684 yaml \u6587\u4ef6\uff0c \u800c istioctl kube-inject \u4f1a\u5728\u8fd9\u4e2a\u6587\u4ef6\u7684\u57fa\u7840\u4e0a\u5411\u5176\u4e2d\u7684 Deployment \u8ffd\u52a0\u5185\u5bb9\uff0c\u901a\u5e38\u4f1a\u8ffd\u52a0\u4e00\u4e2a initContainer(image:docker.io/istio/proxy_init) \u4f5c\u4e3a sidecar \u7684\u5f62\u5f0f\u4e0e\u5e94\u7528\u7684\u5bb9\u5668\u8fd0\u884c\u5728\u540c\u4e00\u4e2a pod \u4e2d\u3002 \u8fc7\u4e00\u4f1a\u513f\u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b service \u548c pod \u542f\u52a8: $ kubectl get po NAME READY STATUS RESTARTS AGE details-v1-7988597495-mvh8s 2/2 Running 0 2m productpage-v1-5447c894b9-m89r7 2/2 Running 0 2m ratings-v1-5cfbb7d4c5-5l6fl 2/2 Running 0 2m reviews-v1-b65dfcc76-9tgtt 2/2 Running 0 2m reviews-v2-5dd8bf9bcc-ql2b8 2/2 Running 0 2m reviews-v3-7bd5bb9786-tzbtz 2/2 Running 0 2m $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE details ClusterIP 10.105.227.220 <none> 9080/TCP 2m kubernetes ClusterIP 10.96.0.1 <none> 443/TCP 4d productpage ClusterIP 10.108.78.109 <none> 9080/TCP 2m ratings ClusterIP 10.109.154.91 <none> 9080/TCP 2m reviews ClusterIP 10.99.40.241 <none> 9080/TCP 2m \u73b0\u5728\u5e94\u7528\u7684\u670d\u52a1\u90fd\u90e8\u7f72\u6210\u529f\u5e76\u542f\u52a8\u4e86\uff0c\u73b0\u5728\u9700\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\uff0c\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a istio gateway \u3002","title":"5\u3001\u5b89\u88c5\u793a\u4f8b"},{"location":"chap6/1Istio_install_docker/#gateway-k8s-ingress-controller-ingress","text":"","title":"gateway \u76f8\u5f53\u4e8e k8s \u7684 ingress controller \u548c ingress\u3002"},{"location":"chap6/1Istio_install_docker/#httptcp-load-balancer-ingress-trafic","text":"\u7136\u540e\u521b\u5efa\u4e00\u4e2a gateway: $ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml gateway.networking.istio.io/bookinfo-gateway created virtualservice.networking.istio.io/bookinfo created \u9a8c\u8bc1 gateway \u662f\u5426\u542f\u52a8\u6210\u529f: $ istioctl get gateway Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) GATEWAY NAME HOSTS NAMESPACE AGE bookinfo-gateway * default 12s $ kubectl get gateway NAME CREATED AT bookinfo-gateway 38s \u5b98\u65b9\u6587\u6863\u4e2d\u540e\u9762\u8fd8\u4f1a\u53bb\u83b7\u53d6 ingress \u7684 ip \u548c\u7aef\u53e3\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 docker for mac \u5b9e\u9645\u4e0a\u4e0d\u9700\u8981\u4e86\uff0c\u5728 service \u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u8fd9\u6837\u7684\u4e00\u6761 service \u4fe1\u606f\uff1a $ kubectl get service -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) istio-ingressgateway LoadBalancer 10.99.227.74 localhost 15020:32340/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30713/TCP,15030:32699/TCP,15031:30774/TCP,15032:31966/TCP,15443:32409/TCP 20m \u8fd9\u91cc\u4f7f\u7528\u7684\u662f LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u5b9e\u9645\u4e0a\u662f\u7528\u6765\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684 \uff0c\u5982\u679c\u6211\u4eec\u6ca1\u6709\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\u8bdd\uff0c\u53ef\u4ee5\u5c06\u8fd9\u91cc\u7c7b\u578b\u6539\u6210 NodePort \uff0c\u4f46\u662f\u8fd9\u6837\u6211\u4eec\u8981\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u5c31\u5f97\u52a0\u4e0a nodePort \u7aef\u53e3\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u5176\u5b9e\u76f4\u63a5\u4f7f\u7528 localhost \u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 Bookinfo \uff0c \u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u5730\u5740\uff1a http://localhost/productpage \u5373\u53ef \u5237\u65b0\u9875\u9762\u53ef\u4ee5 \u770b\u5230 Book Reviews \u53d1\u751f\u4e86\u6539\u53d8\uff0c\u56e0\u4e3a\u8c03\u7528\u5230\u4e86\u4e0d\u540c\u7684 Reviews\u670d\u52a1\uff1a","title":"\u5b83\u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e load balancer\uff0c\u901a\u5e38\u5728\u670d\u52a1\u7f51\u683c\u8fb9\u7f18\u4f5c\u4e3a\u5e94\u7528\u7684 ingress trafic\u7ba1\u7406\u3002"},{"location":"chap6/2BookInfo_1/","text":"L2 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u670d\u52a1\u7248\u672c/\u57fa\u4e8e\u6743\u91cd/\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9) \u5728\u524d\u9762\u6211\u4eec\u6210\u529f\u642d\u5efa\u5e76\u90e8\u7f72\u4e86 istio \u53ca\u5176\u5176 Bookinfo \u793a\u4f8b\u5e94\u7528\uff1a \u76ee\u524d\u642d\u5efa Bookinfo \u5e94\u7528\u6211\u4eec\u53ea\u7528\u5230\u4e86\u4e0b\u9762\u4e24\u4e2a\u8d44\u6e90\u6587\u4ef6\uff1a samples/bookinfo/platform/kube/bookinfo.yaml samples/bookinfo/networking/bookinfo-gateway.yaml \u524d\u8005\u5c31\u662f\u901a\u5e38\u7684 k8s \u5b9a\u4e49\u7684 Deployment \u548c Service \u7684 yaml \u6587\u4ef6\uff0c\u53ea\u662f\u5728\u90e8\u7f72\u65f6\u4f7f\u7528 istioctl kube-inject \u5bf9\u8fd9\u4e2a\u6587\u4ef6\u5b9a\u4e49\u7684 pod \u6ce8\u5165\u4e86 sidecar \u4ee3\u7406. \u540e\u8005\u5b9a\u4e49\u4e86\u8fd9\u4e2a\u5e94\u7528\u7684\u5916\u90e8\u8bbf\u95ee\u5165\u53e3 gateway \uff0c\u4ee5\u53ca\u5e94\u7528\u5185\u90e8 productpage \u670d\u52a1\u7684 VirtualService \u89c4\u5219\uff0c\u800c\u5176\u4ed6\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fd8\u6ca1\u6709\u88ab\u5b9a\u4e49\u3002 $ istioctl --help Istio configuration command line utility for service operators to debug and diagnose their Istio mesh. Usage: istioctl [command] Available Commands: authn Interact with Istio authentication policies deregister De-registers a service instance experimental Experimental commands that may be modified or deprecated help Help about any command kube-inject Inject Envoy sidecar into Kubernetes pod resources proxy-config Retrieve information about proxy configuration from Envoy [kube only] proxy-status Retrieves the synchronization status of each Envoy in the mesh [kube only] register Registers a service instance (e.g. VM) joining the mesh validate Validate Istio policy and rules version Prints out build version information \u53ef\u4ee5\u770b\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684 gateway : $ kubectl get gateway --all-namespaces NAMESPACE NAME CREATED AT default bookinfo-gateway 4h $ istioctl get gateway Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) GATEWAY NAME HOSTS NAMESPACE AGE bookinfo-gateway * default 4h $ kubectl get virtualservices NAME CREATED AT bookinfo 4h \u73b0\u5728\u8bbf\u95ee\u5e94\u7528\u754c\u9762\u5e76\u5237\u65b0\uff0c\u4f1a\u770b\u5230 Reviews \u6709\u65f6\u4e0d\u4f1a\u663e\u793a\u8bc4\u5206\uff0c\u6709\u65f6\u5019\u4f1a\u663e\u793a\u4e0d\u540c\u6837\u5f0f\u7684\u8bc4\u5206\uff0c\u56e0\u4e3a\u540e\u9762\u6709 3 \u4e2a\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\uff0c \u800c\u6ca1\u6709\u914d\u7f6e\u8be5\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219 route rule \u7684\u60c5\u51b5\u4e0b\uff0c\u8be5\u670d\u52a1\u7684\u51e0\u4e2a\u5b9e\u4f8b\u4f1a\u88ab\u968f\u673a\u8bbf\u95ee\u5230 \uff0c\u6709\u7684\u7248\u672c\u670d\u52a1\u4f1a\u8fdb\u4e00\u6b65\u8c03\u7528 Ratings \u670d\u52a1\uff0c\u6709\u7684\u4e0d\u4f1a\u3002 1\u3001\u4e0d\u540c\u670d\u52a1\u7248\u672c\u8bbf\u95ee\u89c4\u5219\u7684\u57fa\u672c\u4f7f\u7528 $ cd /Users/jxi/Devops/bookinfo/istio-1.1.3 \u73b0\u5728\u6211\u4eec\u6765\u5bf9 Reviews \u670d\u52a1\u6dfb\u52a0\u4e00\u6761\u8def\u7531\u89c4\u5219\uff0c\u542f\u7528 samples/bookinfo/networking/virtual-service-reviews-v3.yaml \u5b9a\u4e49\u7684 VirtualService \u89c4\u5219\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v3 \u8fd9\u6837\uff0c\u6240\u6709\u8bbf\u95ee reviews \u670d\u52a1\u7684\u6d41\u91cf\u5c31\u4f1a\u88ab\u5f15\u5bfc\u5230 reviews \u670d\u52a1\u5bf9\u5e94\u7684 subset \u4e3a v3 \u7684 Pod \u4e2d\u3002\u542f\u7528\u8fd9\u6761\u89c4\u5219\uff1a $ istioctl create -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config virtual-service/default/reviews at revision 23414 \u7136\u540e\u67e5\u770b\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff1a $ kubectl get virtualservices NAME CREATED AT bookinfo 4h reviews 48s \u6211\u4eec\u53ef\u4ee5\u770b\u5230 reviews \u7684 VirtualService \u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u4f46\u662f\u6b64\u65f6\u5237\u65b0\u5e94\u7528\u9875\u9762\uff0c \u53d1\u73b0\u8bbf\u95ee Reviews \u5931\u8d25\u4e86 \uff1a \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u521b\u5efa DestinationRule DestinationRule \u5c06 VirtualService \u4e2d\u6307\u5b9a\u7684 subset \u4e0e pod \u7684 {labels:{version: v3}} \u5173\u8054\u8d77\u6765\u3002 \u5728 samples/bookinfo/networking/destination-rule-all.yaml \u6587\u4ef6\u4e2d\u6709\u5b9a\u4e49\u6240\u6709\u8be5\u5e94\u7528\u4e2d\u8981\u7528\u5230\u7684\u6240\u6709 DestinationRule \uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5c31\u662f\u5bf9 Reviews \u76f8\u5173\u7684 DestinationRule \u7684\u5b9a\u4e49: --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 \u6211\u4eec\u53ef\u4ee5\u770b\u5230 DestinationRule \u4e2d\u5b9a\u4e49\u4e86 subsets \u96c6\u5408\uff0c\u5176\u4e2d labels \u5c31\u548c\u6211\u4eec\u4e4b\u524d service \u7684 labelselector \u4e00\u6837\u662f\u53bb\u5339\u914d Pod \u7684 labels \u6807\u7b7e\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc subsets \u4e2d\u5c31\u5305\u542b\u4e00\u4e2a\u540d\u4e3a v3 \u7684 subset \uff0c\u800c\u8fd9\u4e2a subset \u5339\u914d\u7684\u5c31\u662f\u5177\u6709 version=v3 \u8fd9\u4e2a label \u6807\u7b7e\u7684 Pod \u96c6\u5408. \u518d\u56de\u5230\u4e4b\u524d\u7684 samples/bookinfo/platform/kube/bookinfo.yaml \u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 reviews \u7684 Deployment \u786e\u5b9e\u6709\u58f0\u660e\u4e0d\u540c\u7684 labels->version : --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: reviews-v3 spec: replicas: 1 template: metadata: labels: app: reviews version: v3 spec: containers: - name: reviews image: istio/examples-bookinfo-reviews-v3:1.8.0 imagePullPolicy: IfNotPresent ports: - containerPort: 9080 \u8fd9\u6837\u6211\u4eec\u5c31\u901a\u8fc7 DestinationRule \u5c06 VirtualService \u4e0e service \u4e0d\u540c\u7684\u7248\u672c\u5173\u8054\u8d77\u6765\u4e86\u3002 \u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa DestinationRule \u8d44\u6e90\uff1a $ istioctl create -f samples/bookinfo/networking/destination-rule-all.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config destination-rule/default/productpage at revision 24074 Created config destination-rule/default/reviews at revision 24075 Created config destination-rule/default/ratings at revision 24076 Created config destination-rule/default/details at revision 24077 \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u76ee\u524d\u6211\u4eec\u7f51\u683c\u4e2d\u7684 DestinationRules : $ istioctl get destinationrule Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) DESTINATION-RULE NAME HOST SUBSETS NAMESPACE AGE details details v1,v2 default 13s productpage productpage v1 default 13s ratings ratings v1,v2,v2-mysql,v2-mysql-vm default 13s reviews reviews v1,v2,v3 default 13s \u6b64\u65f6\u518d\u8bbf\u95ee\u5e94\u7528\u5c31\u6210\u529f\u4e86\uff0c \u591a\u6b21\u5237\u65b0\u9875\u9762\u53d1\u73b0 Reviews \u90fd\u5c55\u793a\u7684\u662f v3 \u7248\u672c\u5e26\u7ea2\u8272\u661f\u7684 Ratings \uff0c\u8bf4\u660e\u6211\u4eec VirtualService \u7684\u914d\u7f6e\u6210\u529f\u4e86\u3002 2\u3001\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u4f7f\u7528 \u521a\u521a\u6211\u4eec\u6f14\u793a\u7684\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u7684\u670d\u52a1\u7f51\u683c\u7684\u63a7\u5236\uff0c\u73b0\u5728\u6211\u4eec\u6765\u6f14\u793a\u4e0b\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u3002 \u9996\u5148\u79fb\u9664\u521a\u521a\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61: $ istioctl delete virtualservice reviews Command \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Deleted config: virtualservice reviews $ istioctl get virtualservices Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 4h \u73b0\u5728\u6211\u4eec\u518d\u53bb\u8bbf\u95ee Bookinfo \u5e94\u7528\u53c8\u56de\u5230\u6700\u521d\u968f\u673a\u8bbf\u95ee Reviews \u7684\u60c5\u51b5\u4e86\u3002\u73b0\u5728\u6211\u4eec\u67e5\u770b\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-80-20.yaml \u7684\u5b9a\u4e49\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 weight: 80 - destination: host: reviews subset: v2 weight: 20 \u8fd9\u4e2a\u89c4\u5219\u5b9a\u4e49\u4e86: 80% \u7684\u5bf9 Reviews \u7684\u6d41\u91cf\u4f1a\u843d\u5165 v1 \u8fd9\u4e2a subset \uff0c\u5c31\u662f\u6ca1\u6709 Ratings \u7684\u8fd9\u4e2a\u670d\u52a1\uff0c 20% \u4f1a\u843d\u5165 v2 \u5e26\u9ed1\u8272 Ratings \u7684\u8fd9\u4e2a\u670d\u52a1\uff0c\u7136\u540e\u6211\u4eec\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl create -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml virtualservice.networking.istio.io/reviews created $ istioctl get virtualservices Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 4h reviews reviews 1 0 default 11s \u6211\u4eec\u67e5\u770b\u5f53\u524d\u7f51\u683c\u4e2d\u7684 virtualservices \u5bf9\u8c61\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6709 reviews \u4e86\uff0c\u8bc1\u660e\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u5e94\u7528\u4e2d\u6240\u6709\u7684 DestinationRules \u90fd\u5df2\u7ecf\u521b\u5efa\u8fc7\u4e86\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u8bbf\u95ee\u5e94\u7528\u5c31\u53ef\u4ee5\u4e86\uff0c \u6211\u4eec\u591a\u6b21\u5237\u65b0\uff0c\u53ef\u4ee5\u53d1\u73b0\u6ca1\u6709\u51fa\u73b0 Ratings \u7684\u6b21\u6570\u4e0e\u51fa\u73b0\u9ed1\u8272\u661f Ratings \u7684\u6bd4\u4f8b\u5927\u6982\u5728 4:1 \u5de6\u53f3\uff0c\u5e76\u4e14\u6ca1\u6709\u7ea2\u8272\u661f\u7684 Ratings \u7684\u60c5\u51b5\u51fa\u73b0\uff0c\u8bf4\u660e\u6211\u4eec\u914d\u7f6e\u7684 VirtualService \u89c4\u5219\u751f\u6548\u4e86\u3002 \u8fd9\u5c31\u662f\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u65b9\u6cd5\u3002 3\u3001\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u4f7f\u7528 \u9664\u4e86\u4e0a\u9762\u57fa\u4e8e\u670d\u52a1\u7248\u672c\u548c\u670d\u52a1\u6743\u91cd\u7684\u65b9\u5f0f\u63a7\u5236\u670d\u52a1\u8bbf\u95ee\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u6765\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\u3002 \u540c\u6837\uff0c\u5c06\u4e0a\u9762\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\u5220\u9664\uff1a $ istioctl delete virtualservice reviews Command \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Deleted config: virtualservice reviews $ istioctl get virtualservices Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 4h \u67e5\u770b\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-jason-v2-v3.yaml \u7684\u5b9a\u4e49\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: jason route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v3 \u8fd9\u4e2a VirtualService \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 reviews \u670d\u52a1\u8bbf\u95ee\u7684 match \u89c4\u5219\u3002 \u610f\u601d\u662f\u5982\u679c\u5f53\u524d\u8bf7\u6c42\u7684 header \u4e2d\u5305\u542b jason \u8fd9\u4e2a\u7528\u6237\u4fe1\u606f\uff0c\u5219\u53ea\u4f1a\u8bbf\u95ee\u5230 v2 \u7684 reviews \u8fd9\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u5373\u90fd\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u5982\u679c\u4e0d\u5305\u542b\u8be5\u7528\u6237\u4fe1\u606f\uff0c\u5219\u90fd\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u53d1\u7ed9 v3 \u8fd9\u4e2a reviews \u7684\u670d\u52a1\u3002 \u6211\u4eec\u5148\u4e0d\u542f\u7528\u8fd9\u4e2a VirtualService \uff0c\u73b0\u5728\u6211\u4eec\u53bb\u8bbf\u95ee\u4e0b Bookinfo \u8fd9\u4e2a\u5e94\u7528\uff1a \u53f3\u4e0a\u89d2\u6709\u767b\u5f55\u6309\u94ae\uff0c\u5728\u6ca1\u6709\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u5237\u65b0\u9875\u9762\uff0c reviews \u670d\u52a1\u662f\u88ab\u968f\u673a\u8bbf\u95ee\u7684\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u5e26\u661f\u4e0d\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u70b9\u51fb\u767b\u5f55\uff0c \u5728\u5f39\u7a97\u4e2d User Name \u8f93\u5165 jason \uff0c Password \u4e3a\u7a7a \uff0c\u767b\u5f55\uff1a \u518d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u8ddf\u672a\u767b\u5f55\u524d\u7684\u8bbf\u95ee\u89c4\u5219\u4e00\u6837\uff0c\u4e5f\u662f\u968f\u673a\u7684\u3002 \u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8fd9\u4e2a\u5bf9\u8c61: $ kubectl create -f samples/bookinfo/networking/virtual-service-reviews-jason-v2-v3.yaml virtualservice.networking.istio.io/reviews created $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 4h reviews \u6b64\u65f6\u518d\u56de\u53bb\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u4e00\u76f4\u90fd\u662f\u9ed1\u661f\u7684 Reviews \u7248\u672c (v2) \u88ab\u8bbf\u95ee\u5230\u4e86\u3002 \u6ce8\u9500\u9000\u51fa\u540e\u518d\u8bbf\u95ee\uff0c\u6b64\u65f6\u53c8\u4e00\u76f4\u662f\u7ea2\u8272\u661f\u7684\u7248\u672c (v3) \u88ab\u8bbf\u95ee\u4e86\u3002 \u8bf4\u660e\u6211\u4eec\u57fa\u4e8e headers->end-user->exact:jason \u7684\u63a7\u5236\u89c4\u5219\u751f\u6548\u4e86\u3002\u5728 productpage \u670d\u52a1\u8c03\u7528 reviews \u670d\u52a1\u65f6\uff0c\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u4f1a\u5728 header \u4e2d\u5e26\u4e0a\u7528\u6237\u4fe1\u606f\uff0c\u901a\u8fc7 exact \u89c4\u5219\u5339\u914d\u5230\u76f8\u5173\u4fe1\u606f\u540e\uff0c\u6d41\u91cf\u88ab\u5f15\u5411\u4e86\u4e0a\u9762\u914d\u7f6e\u7684v2\u7248\u672c\u4e2d\u3002 \u8fd9\u91cc\u8981\u8bf4\u660e\u4e00\u4e0bmatch\u7684\u5339\u914d\u89c4\u5219\uff1a All conditions inside a single match block have AND semantics, while the list of match blocks have OR semantics. The rule is matched if any one of the match blocks succeed. \u610f\u601d\u662f\u4e00\u4e2a match \u5757\u91cc\u7684\u6761\u4ef6\u662f\u9700\u8981\u540c\u65f6\u6ee1\u8db3\u624d\u7b97\u5339\u914d\u6210\u529f\u7684\uff0c\u5982: - match: - uri: prefix: \"/wpcatalog\" port: 443 \u591a\u4e2a match \u5757\u4e4b\u95f4\u662f\u53ea\u8981\u6709\u4e00\u4e2a match \u5339\u914d\u6210\u529f\u4e86\uff0c\u5c31\u4f1a\u8d70\u5411\u5b83\u6307\u5b9a\u7684\u670d\u52a1\u7248\u672c\u53bb\uff0c\u800c\u5ffd\u7565\u5176\u4ed6\u7684\u3002 \u6211\u4eec\u7684\u793a\u4f8b\u4e2d\u5728\u767b\u5f55\u7684\u6761\u4ef6\u4e0b\uff0c\u6ee1\u8db3\u7b2c\u4e00\u4e2a match \uff0c\u6240\u4ee5\u670d\u52a1\u4e00\u76f4\u4f1a\u8bbf\u95ee\u5230 v2 \u7248\u672c\u3002\u9000\u51fa\u767b\u5f55\u540e\uff0c\u6ca1\u6709 match \u89c4\u5219\u6ee1\u8db3\u5339\u914d\uff0c\u4f1a\u8d70\u5411\u6700\u540e\u4e00\u4e2a route \u89c4\u5219\uff0c\u5373 v3 \u7248\u672c\u3002 \u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c31\u548c\u5927\u5bb6\u4e00\u8d77\u5b66\u4e60\u4e86\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u3001\u6743\u91cd\u4ee5\u53ca\u8bf7\u6c42\u5185\u5bb9\u6765\u63a7\u5236\u670d\u52a1\u6d41\u91cf\u7684\u914d\u7f6e\uff0c\u540e\u9762\u6211\u4eec\u5c06\u8fdb\u4e00\u6b65\u5b66\u4e60\u6d41\u91cf\u7ba1\u7406\u7684\u5176\u4ed6\u7528\u6cd5\u3002","title":"L2 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u670d\u52a1\u7248\u672c/\u57fa\u4e8e\u6743\u91cd/\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9)"},{"location":"chap6/2BookInfo_1/#l2-bookinfo","text":"\u5728\u524d\u9762\u6211\u4eec\u6210\u529f\u642d\u5efa\u5e76\u90e8\u7f72\u4e86 istio \u53ca\u5176\u5176 Bookinfo \u793a\u4f8b\u5e94\u7528\uff1a \u76ee\u524d\u642d\u5efa Bookinfo \u5e94\u7528\u6211\u4eec\u53ea\u7528\u5230\u4e86\u4e0b\u9762\u4e24\u4e2a\u8d44\u6e90\u6587\u4ef6\uff1a samples/bookinfo/platform/kube/bookinfo.yaml samples/bookinfo/networking/bookinfo-gateway.yaml \u524d\u8005\u5c31\u662f\u901a\u5e38\u7684 k8s \u5b9a\u4e49\u7684 Deployment \u548c Service \u7684 yaml \u6587\u4ef6\uff0c\u53ea\u662f\u5728\u90e8\u7f72\u65f6\u4f7f\u7528 istioctl kube-inject \u5bf9\u8fd9\u4e2a\u6587\u4ef6\u5b9a\u4e49\u7684 pod \u6ce8\u5165\u4e86 sidecar \u4ee3\u7406. \u540e\u8005\u5b9a\u4e49\u4e86\u8fd9\u4e2a\u5e94\u7528\u7684\u5916\u90e8\u8bbf\u95ee\u5165\u53e3 gateway \uff0c\u4ee5\u53ca\u5e94\u7528\u5185\u90e8 productpage \u670d\u52a1\u7684 VirtualService \u89c4\u5219\uff0c\u800c\u5176\u4ed6\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fd8\u6ca1\u6709\u88ab\u5b9a\u4e49\u3002 $ istioctl --help Istio configuration command line utility for service operators to debug and diagnose their Istio mesh. Usage: istioctl [command] Available Commands: authn Interact with Istio authentication policies deregister De-registers a service instance experimental Experimental commands that may be modified or deprecated help Help about any command kube-inject Inject Envoy sidecar into Kubernetes pod resources proxy-config Retrieve information about proxy configuration from Envoy [kube only] proxy-status Retrieves the synchronization status of each Envoy in the mesh [kube only] register Registers a service instance (e.g. VM) joining the mesh validate Validate Istio policy and rules version Prints out build version information \u53ef\u4ee5\u770b\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684 gateway : $ kubectl get gateway --all-namespaces NAMESPACE NAME CREATED AT default bookinfo-gateway 4h $ istioctl get gateway Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) GATEWAY NAME HOSTS NAMESPACE AGE bookinfo-gateway * default 4h $ kubectl get virtualservices NAME CREATED AT bookinfo 4h \u73b0\u5728\u8bbf\u95ee\u5e94\u7528\u754c\u9762\u5e76\u5237\u65b0\uff0c\u4f1a\u770b\u5230 Reviews \u6709\u65f6\u4e0d\u4f1a\u663e\u793a\u8bc4\u5206\uff0c\u6709\u65f6\u5019\u4f1a\u663e\u793a\u4e0d\u540c\u6837\u5f0f\u7684\u8bc4\u5206\uff0c\u56e0\u4e3a\u540e\u9762\u6709 3 \u4e2a\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\uff0c \u800c\u6ca1\u6709\u914d\u7f6e\u8be5\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219 route rule \u7684\u60c5\u51b5\u4e0b\uff0c\u8be5\u670d\u52a1\u7684\u51e0\u4e2a\u5b9e\u4f8b\u4f1a\u88ab\u968f\u673a\u8bbf\u95ee\u5230 \uff0c\u6709\u7684\u7248\u672c\u670d\u52a1\u4f1a\u8fdb\u4e00\u6b65\u8c03\u7528 Ratings \u670d\u52a1\uff0c\u6709\u7684\u4e0d\u4f1a\u3002","title":"L2 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u670d\u52a1\u7248\u672c/\u57fa\u4e8e\u6743\u91cd/\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9)"},{"location":"chap6/2BookInfo_1/#1","text":"$ cd /Users/jxi/Devops/bookinfo/istio-1.1.3 \u73b0\u5728\u6211\u4eec\u6765\u5bf9 Reviews \u670d\u52a1\u6dfb\u52a0\u4e00\u6761\u8def\u7531\u89c4\u5219\uff0c\u542f\u7528 samples/bookinfo/networking/virtual-service-reviews-v3.yaml \u5b9a\u4e49\u7684 VirtualService \u89c4\u5219\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v3 \u8fd9\u6837\uff0c\u6240\u6709\u8bbf\u95ee reviews \u670d\u52a1\u7684\u6d41\u91cf\u5c31\u4f1a\u88ab\u5f15\u5bfc\u5230 reviews \u670d\u52a1\u5bf9\u5e94\u7684 subset \u4e3a v3 \u7684 Pod \u4e2d\u3002\u542f\u7528\u8fd9\u6761\u89c4\u5219\uff1a $ istioctl create -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config virtual-service/default/reviews at revision 23414 \u7136\u540e\u67e5\u770b\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff1a $ kubectl get virtualservices NAME CREATED AT bookinfo 4h reviews 48s \u6211\u4eec\u53ef\u4ee5\u770b\u5230 reviews \u7684 VirtualService \u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u4f46\u662f\u6b64\u65f6\u5237\u65b0\u5e94\u7528\u9875\u9762\uff0c \u53d1\u73b0\u8bbf\u95ee Reviews \u5931\u8d25\u4e86 \uff1a \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u521b\u5efa DestinationRule DestinationRule \u5c06 VirtualService \u4e2d\u6307\u5b9a\u7684 subset \u4e0e pod \u7684 {labels:{version: v3}} \u5173\u8054\u8d77\u6765\u3002 \u5728 samples/bookinfo/networking/destination-rule-all.yaml \u6587\u4ef6\u4e2d\u6709\u5b9a\u4e49\u6240\u6709\u8be5\u5e94\u7528\u4e2d\u8981\u7528\u5230\u7684\u6240\u6709 DestinationRule \uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5c31\u662f\u5bf9 Reviews \u76f8\u5173\u7684 DestinationRule \u7684\u5b9a\u4e49: --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: reviews spec: host: reviews subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 - name: v3 labels: version: v3 \u6211\u4eec\u53ef\u4ee5\u770b\u5230 DestinationRule \u4e2d\u5b9a\u4e49\u4e86 subsets \u96c6\u5408\uff0c\u5176\u4e2d labels \u5c31\u548c\u6211\u4eec\u4e4b\u524d service \u7684 labelselector \u4e00\u6837\u662f\u53bb\u5339\u914d Pod \u7684 labels \u6807\u7b7e\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc subsets \u4e2d\u5c31\u5305\u542b\u4e00\u4e2a\u540d\u4e3a v3 \u7684 subset \uff0c\u800c\u8fd9\u4e2a subset \u5339\u914d\u7684\u5c31\u662f\u5177\u6709 version=v3 \u8fd9\u4e2a label \u6807\u7b7e\u7684 Pod \u96c6\u5408. \u518d\u56de\u5230\u4e4b\u524d\u7684 samples/bookinfo/platform/kube/bookinfo.yaml \u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 reviews \u7684 Deployment \u786e\u5b9e\u6709\u58f0\u660e\u4e0d\u540c\u7684 labels->version : --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: reviews-v3 spec: replicas: 1 template: metadata: labels: app: reviews version: v3 spec: containers: - name: reviews image: istio/examples-bookinfo-reviews-v3:1.8.0 imagePullPolicy: IfNotPresent ports: - containerPort: 9080 \u8fd9\u6837\u6211\u4eec\u5c31\u901a\u8fc7 DestinationRule \u5c06 VirtualService \u4e0e service \u4e0d\u540c\u7684\u7248\u672c\u5173\u8054\u8d77\u6765\u4e86\u3002 \u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa DestinationRule \u8d44\u6e90\uff1a $ istioctl create -f samples/bookinfo/networking/destination-rule-all.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config destination-rule/default/productpage at revision 24074 Created config destination-rule/default/reviews at revision 24075 Created config destination-rule/default/ratings at revision 24076 Created config destination-rule/default/details at revision 24077 \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u76ee\u524d\u6211\u4eec\u7f51\u683c\u4e2d\u7684 DestinationRules : $ istioctl get destinationrule Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) DESTINATION-RULE NAME HOST SUBSETS NAMESPACE AGE details details v1,v2 default 13s productpage productpage v1 default 13s ratings ratings v1,v2,v2-mysql,v2-mysql-vm default 13s reviews reviews v1,v2,v3 default 13s \u6b64\u65f6\u518d\u8bbf\u95ee\u5e94\u7528\u5c31\u6210\u529f\u4e86\uff0c \u591a\u6b21\u5237\u65b0\u9875\u9762\u53d1\u73b0 Reviews \u90fd\u5c55\u793a\u7684\u662f v3 \u7248\u672c\u5e26\u7ea2\u8272\u661f\u7684 Ratings \uff0c\u8bf4\u660e\u6211\u4eec VirtualService \u7684\u914d\u7f6e\u6210\u529f\u4e86\u3002","title":"1\u3001\u4e0d\u540c\u670d\u52a1\u7248\u672c\u8bbf\u95ee\u89c4\u5219\u7684\u57fa\u672c\u4f7f\u7528"},{"location":"chap6/2BookInfo_1/#2","text":"\u521a\u521a\u6211\u4eec\u6f14\u793a\u7684\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u7684\u670d\u52a1\u7f51\u683c\u7684\u63a7\u5236\uff0c\u73b0\u5728\u6211\u4eec\u6765\u6f14\u793a\u4e0b\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u3002 \u9996\u5148\u79fb\u9664\u521a\u521a\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61: $ istioctl delete virtualservice reviews Command \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Deleted config: virtualservice reviews $ istioctl get virtualservices Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 4h \u73b0\u5728\u6211\u4eec\u518d\u53bb\u8bbf\u95ee Bookinfo \u5e94\u7528\u53c8\u56de\u5230\u6700\u521d\u968f\u673a\u8bbf\u95ee Reviews \u7684\u60c5\u51b5\u4e86\u3002\u73b0\u5728\u6211\u4eec\u67e5\u770b\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-80-20.yaml \u7684\u5b9a\u4e49\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - route: - destination: host: reviews subset: v1 weight: 80 - destination: host: reviews subset: v2 weight: 20 \u8fd9\u4e2a\u89c4\u5219\u5b9a\u4e49\u4e86: 80% \u7684\u5bf9 Reviews \u7684\u6d41\u91cf\u4f1a\u843d\u5165 v1 \u8fd9\u4e2a subset \uff0c\u5c31\u662f\u6ca1\u6709 Ratings \u7684\u8fd9\u4e2a\u670d\u52a1\uff0c 20% \u4f1a\u843d\u5165 v2 \u5e26\u9ed1\u8272 Ratings \u7684\u8fd9\u4e2a\u670d\u52a1\uff0c\u7136\u540e\u6211\u4eec\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl create -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml virtualservice.networking.istio.io/reviews created $ istioctl get virtualservices Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 4h reviews reviews 1 0 default 11s \u6211\u4eec\u67e5\u770b\u5f53\u524d\u7f51\u683c\u4e2d\u7684 virtualservices \u5bf9\u8c61\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6709 reviews \u4e86\uff0c\u8bc1\u660e\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u5e94\u7528\u4e2d\u6240\u6709\u7684 DestinationRules \u90fd\u5df2\u7ecf\u521b\u5efa\u8fc7\u4e86\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u8bbf\u95ee\u5e94\u7528\u5c31\u53ef\u4ee5\u4e86\uff0c \u6211\u4eec\u591a\u6b21\u5237\u65b0\uff0c\u53ef\u4ee5\u53d1\u73b0\u6ca1\u6709\u51fa\u73b0 Ratings \u7684\u6b21\u6570\u4e0e\u51fa\u73b0\u9ed1\u8272\u661f Ratings \u7684\u6bd4\u4f8b\u5927\u6982\u5728 4:1 \u5de6\u53f3\uff0c\u5e76\u4e14\u6ca1\u6709\u7ea2\u8272\u661f\u7684 Ratings \u7684\u60c5\u51b5\u51fa\u73b0\uff0c\u8bf4\u660e\u6211\u4eec\u914d\u7f6e\u7684 VirtualService \u89c4\u5219\u751f\u6548\u4e86\u3002 \u8fd9\u5c31\u662f\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u65b9\u6cd5\u3002","title":"2\u3001\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u4f7f\u7528"},{"location":"chap6/2BookInfo_1/#3","text":"\u9664\u4e86\u4e0a\u9762\u57fa\u4e8e\u670d\u52a1\u7248\u672c\u548c\u670d\u52a1\u6743\u91cd\u7684\u65b9\u5f0f\u63a7\u5236\u670d\u52a1\u8bbf\u95ee\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u6765\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\u3002 \u540c\u6837\uff0c\u5c06\u4e0a\u9762\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\u5220\u9664\uff1a $ istioctl delete virtualservice reviews Command \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Deleted config: virtualservice reviews $ istioctl get virtualservices Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 4h \u67e5\u770b\u6587\u4ef6 samples/bookinfo/networking/virtual-service-reviews-jason-v2-v3.yaml \u7684\u5b9a\u4e49\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: end-user: exact: jason route: - destination: host: reviews subset: v2 - route: - destination: host: reviews subset: v3 \u8fd9\u4e2a VirtualService \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 reviews \u670d\u52a1\u8bbf\u95ee\u7684 match \u89c4\u5219\u3002 \u610f\u601d\u662f\u5982\u679c\u5f53\u524d\u8bf7\u6c42\u7684 header \u4e2d\u5305\u542b jason \u8fd9\u4e2a\u7528\u6237\u4fe1\u606f\uff0c\u5219\u53ea\u4f1a\u8bbf\u95ee\u5230 v2 \u7684 reviews \u8fd9\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u5373\u90fd\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u5982\u679c\u4e0d\u5305\u542b\u8be5\u7528\u6237\u4fe1\u606f\uff0c\u5219\u90fd\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u53d1\u7ed9 v3 \u8fd9\u4e2a reviews \u7684\u670d\u52a1\u3002 \u6211\u4eec\u5148\u4e0d\u542f\u7528\u8fd9\u4e2a VirtualService \uff0c\u73b0\u5728\u6211\u4eec\u53bb\u8bbf\u95ee\u4e0b Bookinfo \u8fd9\u4e2a\u5e94\u7528\uff1a \u53f3\u4e0a\u89d2\u6709\u767b\u5f55\u6309\u94ae\uff0c\u5728\u6ca1\u6709\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u5237\u65b0\u9875\u9762\uff0c reviews \u670d\u52a1\u662f\u88ab\u968f\u673a\u8bbf\u95ee\u7684\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u5e26\u661f\u4e0d\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u70b9\u51fb\u767b\u5f55\uff0c \u5728\u5f39\u7a97\u4e2d User Name \u8f93\u5165 jason \uff0c Password \u4e3a\u7a7a \uff0c\u767b\u5f55\uff1a \u518d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u8ddf\u672a\u767b\u5f55\u524d\u7684\u8bbf\u95ee\u89c4\u5219\u4e00\u6837\uff0c\u4e5f\u662f\u968f\u673a\u7684\u3002 \u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8fd9\u4e2a\u5bf9\u8c61: $ kubectl create -f samples/bookinfo/networking/virtual-service-reviews-jason-v2-v3.yaml virtualservice.networking.istio.io/reviews created $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 4h reviews \u6b64\u65f6\u518d\u56de\u53bb\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u4e00\u76f4\u90fd\u662f\u9ed1\u661f\u7684 Reviews \u7248\u672c (v2) \u88ab\u8bbf\u95ee\u5230\u4e86\u3002 \u6ce8\u9500\u9000\u51fa\u540e\u518d\u8bbf\u95ee\uff0c\u6b64\u65f6\u53c8\u4e00\u76f4\u662f\u7ea2\u8272\u661f\u7684\u7248\u672c (v3) \u88ab\u8bbf\u95ee\u4e86\u3002 \u8bf4\u660e\u6211\u4eec\u57fa\u4e8e headers->end-user->exact:jason \u7684\u63a7\u5236\u89c4\u5219\u751f\u6548\u4e86\u3002\u5728 productpage \u670d\u52a1\u8c03\u7528 reviews \u670d\u52a1\u65f6\uff0c\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u4f1a\u5728 header \u4e2d\u5e26\u4e0a\u7528\u6237\u4fe1\u606f\uff0c\u901a\u8fc7 exact \u89c4\u5219\u5339\u914d\u5230\u76f8\u5173\u4fe1\u606f\u540e\uff0c\u6d41\u91cf\u88ab\u5f15\u5411\u4e86\u4e0a\u9762\u914d\u7f6e\u7684v2\u7248\u672c\u4e2d\u3002 \u8fd9\u91cc\u8981\u8bf4\u660e\u4e00\u4e0bmatch\u7684\u5339\u914d\u89c4\u5219\uff1a All conditions inside a single match block have AND semantics, while the list of match blocks have OR semantics. The rule is matched if any one of the match blocks succeed. \u610f\u601d\u662f\u4e00\u4e2a match \u5757\u91cc\u7684\u6761\u4ef6\u662f\u9700\u8981\u540c\u65f6\u6ee1\u8db3\u624d\u7b97\u5339\u914d\u6210\u529f\u7684\uff0c\u5982: - match: - uri: prefix: \"/wpcatalog\" port: 443 \u591a\u4e2a match \u5757\u4e4b\u95f4\u662f\u53ea\u8981\u6709\u4e00\u4e2a match \u5339\u914d\u6210\u529f\u4e86\uff0c\u5c31\u4f1a\u8d70\u5411\u5b83\u6307\u5b9a\u7684\u670d\u52a1\u7248\u672c\u53bb\uff0c\u800c\u5ffd\u7565\u5176\u4ed6\u7684\u3002 \u6211\u4eec\u7684\u793a\u4f8b\u4e2d\u5728\u767b\u5f55\u7684\u6761\u4ef6\u4e0b\uff0c\u6ee1\u8db3\u7b2c\u4e00\u4e2a match \uff0c\u6240\u4ee5\u670d\u52a1\u4e00\u76f4\u4f1a\u8bbf\u95ee\u5230 v2 \u7248\u672c\u3002\u9000\u51fa\u767b\u5f55\u540e\uff0c\u6ca1\u6709 match \u89c4\u5219\u6ee1\u8db3\u5339\u914d\uff0c\u4f1a\u8d70\u5411\u6700\u540e\u4e00\u4e2a route \u89c4\u5219\uff0c\u5373 v3 \u7248\u672c\u3002 \u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c31\u548c\u5927\u5bb6\u4e00\u8d77\u5b66\u4e60\u4e86\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u3001\u6743\u91cd\u4ee5\u53ca\u8bf7\u6c42\u5185\u5bb9\u6765\u63a7\u5236\u670d\u52a1\u6d41\u91cf\u7684\u914d\u7f6e\uff0c\u540e\u9762\u6211\u4eec\u5c06\u8fdb\u4e00\u6b65\u5b66\u4e60\u6d41\u91cf\u7ba1\u7406\u7684\u5176\u4ed6\u7528\u6cd5\u3002","title":"3\u3001\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u4f7f\u7528"},{"location":"chap6/3BookInfo_2/","text":"L3 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u5ef6\u8fdf\u8bbf\u95ee/\u4e2d\u65ad\u8bbf\u95ee/\u4e0d\u540c\u73af\u5883/\u670d\u52a1\u7f51\u683c\u5916) 1\u3001\u5ef6\u8fdf\u8bbf\u95ee\u6545\u969c\u6ce8\u5165 \u63a5\u4e0a\u8282\u8bfe\u7684\u5185\u5bb9\uff0c\u7b2c\u4e00\u6b65\u8fd8\u662f\u9700\u8981\u79fb\u9664\u4e4b\u524d\u521b\u5efa\u7684 VirtualService : $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 23h reviews $ istioctl delete virtualservice reviews Command \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Deleted config: virtualservice reviews $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 23h cd /Users/jxi/Devops/bookinfo/istio-1.1.3 \u7136\u540e\u6211\u4eec\u67e5\u770b istio \u6837\u4f8b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6\uff1a samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml \u7684\u5185\u5bb9 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: ratings spec: hosts: - ratings http: - match: - headers: end-user: exact: jason fault: delay: percent: 100 fixedDelay: 7s route: - destination: host: ratings subset: v1 - route: - destination: host: ratings subset: v1 \u8fd9\u4e2a VirtualService \u5b9a\u4e49\u4e86\u4e00\u4e2a\u5728 jason \u767b\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u8bbf\u95ee ratings \u670d\u52a1\u7684 100% \u7684 7s \u8bbf\u95ee\u5ef6\u8fdf\u3002 \u524d\u9762\u6211\u4eec\u77e5\u9053\uff0c Bookinfo \u8fd9\u4e2a\u793a\u4f8b productpage \u670d\u52a1\u8c03\u7528 reviews \uff0c reviews \u7684\u4e0d\u540c\u7248\u672c\u4f1a\u5bf9 ratings \u8fdb\u884c\u4e0d\u540c\u7684\u8c03\u7528\uff0c \u5176\u4e2d reviews-v1 \u4e0d\u8c03\u7528 ratings \uff0c reviews-v2 \u548c reviews-v3 \u4f1a\u8c03\u7528 ratings \uff0c\u5e76\u505a\u4e0d\u540c\u6837\u5f0f\u7684\u6e32\u67d3\u3002 \u5e76\u4e14\u5728 productpage \u8bbf\u95ee reviews \u65f6\uff0c\u4ee3\u7801\u4e2d\u6709\u786c\u7f16\u7801 6s \u4e2d\u7684\u8bbf\u95ee\u8d85\u65f6\u9650\u5236\uff0c \u800c reviews \u8bbf\u95ee ratings \u7f16\u7801\u4e86 10s \u7684\u8bbf\u95ee\u8d85\u65f6\u9650\u5236\u3002 \u4e86\u89e3\u8fd9\u4e00\u70b9\u540e\uff0c\u6211\u4eec\u73b0\u5728\u6765\u521b\u5efa\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl create -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml virtualservice.networking.istio.io/ratings created $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 23h ratings \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u524d\u5f80 Bookinfo \u5e94\u7528\uff0c\u767b\u5f55 jason \uff0c\u6253\u5f00\u6d4f\u89c8\u5668\u7684 Network \uff0c\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u8bf7\u6c42\u52a0\u8f7d\u5f88\u6162\uff0c\u5927\u7ea6 6s \u540e\uff0c\u51fa\u73b0\u5982\u4e0b\u754c\u9762 \u770b\u5230 productpage \u7684\u8bf7\u6c42\u5927\u7ea6\u8017\u65f6 6s \uff0c Reviews \u663e\u793a unavailable \u7684\u9519\u8bef\u3002 \u56e0\u4e3a\u6b64\u65f6 reviews \u8bf7\u6c42 ratings \u7684\u8bbf\u95ee\u8d85\u8fc7\u4e86 6s \u8fd8\u6ca1\u6709\u54cd\u5e94\uff0c\u4f7f\u5f97 productpage \u4e2d\u7684\u786c\u7f16\u7801\u7684\u8d85\u65f6\u8bbe\u7f6e\u751f\u6548\u4e86\u3002 \u901a\u8fc7\u8fd9\u79cd \u8d85\u65f6\u6545\u969c\u6ce8\u5165 \uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u65b9\u4fbf\u5730\u53d1\u73b0\u670d\u52a1\u95f4\u76f8\u4e92\u8bbf\u95ee\u4e2d\u5b58\u5728\u7684\u6f5c\u5728\u95ee\u9898\u3002 2\u3001\u4e2d\u65ad\u8bbf\u95ee\u6545\u969c\u6ce8\u5165 \u540c\u6837\u79fb\u9664\u521a\u624d\u7684 VirutualService \u8d44\u6e90\u5bf9\u8c61\uff1a $ istioctl delete virtualservice ratings Command \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Deleted config: virtualservice ratings $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 23h \u7136\u540e\u6211\u4eec\u67e5\u770b istio \u6837\u4f8b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6\uff1a samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml \u7684\u5185\u5bb9 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: ratings spec: hosts: - ratings http: - match: - headers: end-user: exact: jason fault: abort: percent: 100 httpStatus: 500 route: - destination: host: ratings subset: v1 - route: - destination: host: ratings subset: v1 \u901a\u8fc7\u4e0a\u9762\u7684\u8fd9\u4e2a yaml \u6587\u4ef6\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\u914d\u7f6e\u4e86\u5728 jason \u767b\u5f55\u65f6\uff0c reviews \u5bf9 ratings \u8bbf\u95ee\u65f6 100% \u7684\u8fd4\u56de\u4e00\u4e2a 500 \u9519\u8bef\u54cd\u5e94\u3002 \u7136\u540e\u540c\u6837\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a(\u7528 kubectl \u6216\u8005 istioctl \u5de5\u5177\u90fd\u662f\u53ef\u4ee5\u7684) $ istioctl create -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml Created config virtual-service/default/ratings at revision 32143909 $ istioctl get virtualservice VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 6d ratings ratings 2 0 default 4s \u73b0\u5728\u6211\u4eec\u56de\u5230 BookInfo \u5e94\u7528\uff0c\u767b\u5f55 jason \uff0c\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u4e0b\u9762\u7684\u73b0\u8c61\uff1a \u6211\u4eec\u53ef\u4ee5\u770b\u5230 reviews \u5bf9 ratings \u7684\u8bbf\u95ee\u5931\u8d25\u4e86\uff0c\u670d\u52a1\u4e0a\u9762\u6211\u4eec VirtualService \u8d44\u6e90\u5bf9\u8c61\u7684\u914d\u7f6e\u3002 3\u3001\u4e0d\u540c\u73af\u5883\u670d\u52a1\u8bbf\u95ee \u4f7f\u7528 istio \u7684\u8def\u7531\u89c4\u5219\u7ba1\u7406\uff0c\u8fd8\u53ef\u4ee5\u914d\u7f6e\u5bf9\u4e0d\u540c\u73af\u5883( prod, staging, dev \u7b49)\u7684\u540c\u4e00\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u3002\u7531\u4e8e\u6211\u7684\u5b9e\u9a8c\u73af\u5883\u6ca1\u6709\u642d\u5efa\u591a\u73af\u5883\u7684\u96c6\u7fa4\uff0c \u8fd9\u91cc\u6307\u4f7f\u7528\u5b98\u65b9\u7684demo\u6765\u505a\u63cf\u8ff0 \u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: my-productpage-rule namespace: istio-system spec: hosts: - productpage.prod.svc.cluster.local # ignores rule namespace http: - timeout: 5s route: - destination: host: productpage.prod.svc.cluster.local \u901a\u5e38\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u5982\u679c\u642d\u5efa\u591a\u73af\u5883\u7684\u60c5\u51b5\u53ef\u4ee5\u4f7f\u7528 namespace \u6765\u8fdb\u884c\u5212\u5206\uff0c\u800c\u4f7f\u7528\u4e0a\u9762\u7684\u65b9\u5f0f\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u5176\u4ed6 namepaces \u7684\u670d\u52a1\u7684\u8bbf\u95ee\u3002 \u4e0a\u9762\u7684 VirtualService \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 namespace \u4e3a prod \u4e2d\u7684 productpage \u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4f1a\u5728 5s \u7684 timeout \u540e\u624d\u4f1a\u8c03\u7528\u8be5\u670d\u52a1\u3002 \u8fd9\u4e2a\u8bbf\u95ee\u89c4\u5219\u6ca1\u6709\u5b9a\u4e49 subset \uff0cistio \u4f1a\u83b7\u53d6 productpage.prod.svc.cluster.local \u670d\u52a1\u5bf9\u5e94\u7684\u6240\u6709\u5b9e\u4f8b\u5e76\u5411\u5176\u4ed6\u670d\u52a1\u5b9e\u4f8b\u6ce8\u5165\u8fd9\u4e9b\u5b9e\u4f8b\u7684\u4fe1\u606f\u5230\u4ed6\u4eec\u7684 load balancing pool \u4e2d\u53bb\u3002 \u540c\u65f6\u6ce8\u610f\u8fd9\u4e2a VirtualService \u662f\u5b9a\u4e49\u5728 istio-system \u7684 namespace \u4e2d\u7684\uff0c\u6b64\u65f6\u8981\u4f7f\u7528\u5b8c\u6574\u7684\u670d\u52a1\u57df\u540d\uff1a productpage.prod.svc.cluster.local \uff0c\u8fd9\u6837\u8fd9\u6761\u89c4\u5219\u6240\u5c5e\u7684 namespace \u624d\u4f1a\u89e3\u6790\u5230\u5176\u4ed6 namespace \u7684\u670d\u52a1\u3002 4\u3001\u670d\u52a1\u7f51\u683c\u5916\u7684\u6d41\u91cf\u7ba1\u7406 \u4e3a\u4e86\u63a7\u5236\u670d\u52a1\u7f51\u683c\u5916\u7684\u670d\u52a1\u7684\u6d41\u91cf\u8bbf\u95ee\uff0c \u5916\u90e8\u7684\u670d\u52a1\u5fc5\u987b\u9996\u5148\u4f7f\u7528\u4e00\u4e2a ServiceEntry \u5bf9\u8c61\u52a0\u5165\u5230 istio \u7684\u5185\u90e8 service registry \u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u624d\u4f1a\u77e5\u9053\u5982\u4f55\u5bfc\u5411\u8fd9\u4e9b\u5916\u90e8\u670d\u52a1\u7684\u6d41\u91cf\u3002 \u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e2a\u529f\u80fd\uff0c\u6211\u4eec\u4f7f\u7528 istio \u6837\u4f8b\u4e2d\u7684 sleep \u5e94\u7528\u6765\u9a8c\u8bc1\u6539\u529f\u80fd\uff0c\u67e5\u770b samples/sleep/sleep.yaml \u6587\u4ef6\u5185\u5bb9\uff1a apiVersion: v1 kind: Service metadata: name: sleep labels: app: sleep spec: ports: - port: 80 name: http selector: app: sleep --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep spec: replicas: 1 template: metadata: labels: app: sleep spec: containers: - name: sleep image: tutum/curl command: [\"/bin/sleep\",\"infinity\"] imagePullPolicy: IfNotPresent --- \u8fd9\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5e94\u7528\uff0c\u901a\u8fc7 Deployment \u8fdb\u884c\u63a7\u5236\uff0c\u901a\u8fc7 Service \u66b4\u9732\u670d\u52a1\uff0c\u73b0\u5728\u6211\u4eec\u6765\u90e8\u7f72\u8be5\u5e94\u7528\uff1a $ kubectl apply -f <(istioctl kube-inject -f samples/sleep/sleep.yaml) service \"sleep\" created deployment.extensions \"sleep\" created \u5f85\u5e94\u7528\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u8fdb\u5165\u8be5\u5e94\u7528\u5bb9\u5668\u5185\u90e8\u6267\u884c\u4e00\u4e9b\u6d4b\u8bd5\u64cd\u4f5c\uff1a $ export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name}) $ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics HTTP/1.1 404 Not Found date: Sat, 20 Apr 2019 03:08:34 GMT server: envoy content-length: 0 \u53ef\u4ee5\u770b\u5230\u4f1a\u8fd4\u56de\u4e0a\u9762\u7684 404 \u7684\u4fe1\u606f\uff0c\u56e0\u4e3a\u8be5\u57df\u540d\u4e0d\u5728\u5f53\u524d\u7684\u670d\u52a1\u7f51\u683c\u4e2d\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b istio \u4e0d\u5141\u8bb8\u8bbf\u95ee\u670d\u52a1\u7f51\u683c\u5916\u90e8\u7684 URL\uff0c\u5373\u670d\u52a1\u7f51\u683c\u4e2d\u5bf9\u672a\u77e5\u7684\u670d\u52a1\u8bf7\u6c42\u4f1a\u88ab\u4e22\u5f03\u3002 \u8fd9\u5c31\u9700\u8981\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a ServiceEntry \u5bf9\u8c61\uff0c\u5c06\u5916\u90e8\u7684\u8bbf\u95ee\u670d\u52a1\u5f15\u5165\u5230\u670d\u52a1\u7f51\u683c\u4e2d\u6765\u3002 \u4f8b\u5982\u4e0b\u9762\u7684\u89c4\u5219\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbf\u95ee edition.cnn.com \u7684\u670d\u52a1\u7684 ServiceEntry :\uff08 cnn-service-entry.yaml \uff09 apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: cnn spec: hosts: - edition.cnn.com ports: - number: 80 name: http-port protocol: HTTP - number: 443 name: https protocol: HTTPS resolution: DNS \u73b0\u5728\u6211\u4eec\u6765\u90e8\u7f72\u4e0a\u9762\u7684 ServiceEntry \u8d44\u6e90\uff1a $ istioctl create -f cnn-service-entry.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config service-entry/default/cnn at revision 37978 $ istioctl get serviceentry Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) SERVICE-ENTRY NAME HOSTS PORTS NAMESPACE AGE cnn edition.cnn.com HTTP/80,HTTPS/443 default 13s \u73b0\u5728\u6211\u4eec\u518d\u53bb\u4e0a\u9762\u7684 sleep \u5bb9\u5668\u4e2d\u6267\u884c\u4e0a\u9762\u7684\u6d4b\u8bd5\u8bf7\u6c42\uff1a $ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics HTTP/1.1 301 Moved Permanently server: envoy retry-after: 0 content-length: 0 cache-control: public, max-age=600 location: https://edition.cnn.com/politics accept-ranges: bytes date: Sat, 20 Apr 2019 03:10:47 GMT via: 1.1 varnish set-cookie: countryCode=JP; Domain=.cnn.com; Path=/ set-cookie: geoData=minato|13|105-0001|JP|AS|900|broadband; Domain=.cnn.com; Path=/ x-served-by: cache-hnd18731-HND x-cache: HIT x-cache-hits: 0 x-envoy-upstream-service-time: 608 HTTP/2 200 content-type: text/html; charset=utf-8 x-servedbyhost: ::ffff:127.0.0.1 access-control-allow-origin: * cache-control: max-age=60 content-security-policy: default-src 'self' blob: https://*.cnn.com:* http://*.cnn.com:* *.cnn.io:* *.cnn.net:* *.turner.com:* *.turner.io:* *.ugdturner.com:* courageousstudio.com *.vgtf.net:*; script-src 'unsafe-eval' 'unsafe-inline' 'self' *; style-src 'unsafe-inline' 'self' blob: *; child-src 'self' blob: *; frame-src 'self' *; object-src 'self' *; img-src 'self' data: blob: *; media-src 'self' data: blob: *; font-src 'self' data: *; connect-src 'self' *; frame-ancestors 'self' https://*.cnn.com:* http://*.cnn.com https://*.cnn.io:* http://*.cnn.io:* *.turner.com:* courageousstudio.com; x-content-type-options: nosniff x-xss-protection: 1; mode=block via: 1.1 varnish accept-ranges: bytes date: Sat, 20 Apr 2019 03:10:48 GMT via: 1.1 varnish age: 156 set-cookie: countryCode=JP; Domain=.cnn.com; Path=/ set-cookie: geoData=minato|13|105-0001|JP|AS|900|broadband; Domain=.cnn.com; Path=/ set-cookie: tryThing00=0110; Domain=.cnn.com; Path=/; Expires=Mon Jul 01 2019 00:00:00 GMT set-cookie: tryThing01=7956; Domain=.cnn.com; Path=/; Expires=Sun Mar 01 2020 00:00:00 GMT set-cookie: tryThing02=3144; Domain=.cnn.com; Path=/; Expires=Wed Jan 01 2020 00:00:00 GMT x-served-by: cache-iad2121-IAD, cache-hnd18726-HND x-cache: HIT, MISS x-cache-hits: 3, 0 x-timer: S1555729848.352917,VS0,VE542 vary: Accept-Encoding content-length: 1247678 \u73b0\u5728\u6211\u4eec\u53d1\u73b0\u53ef\u4ee5\u6b63\u5e38\u8fd4\u56de\u5185\u5bb9\u4e86\uff0c\u8fd4\u56de200\uff0c\u8bc1\u660e\u8bf7\u6c42\u6210\u529f\u4e86\u3002 \u8bf4\u660e\uff1a -L \u8ba9 curl \u8ddf\u968f\u8fde\u63a5\u8fdb\u884c\u91cd\u5b9a\u5411\u3002 \u8fd9\u91cc\u670d\u52a1\u5668\u76f4\u63a5\u8fd4\u56de\u7684 30 1 \u91cd\u5b9a\u5411\u54cd\u5e94 \uff0c\u8981\u6c42\u5ba2\u6237\u7aef\u518d\u4f7f\u7528HTTPS\u7684\u65b9\u5f0f\u5bf9 https://edition.cnn.com/ politics \u5730\u5740\u8fdb\u884c\u8bbf\u95ee\uff0c\u7b2c\u4e8c\u6b21\u8bbf\u95ee\u624d\u8fd4\u56de\u4e86 200 \u7684\u6210\u529f\u7801\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u8fdb\u4e00\u6b65\u914d\u7f6e egress gateway \uff0c\u4f7f\u8fd9\u4e9b\u5bf9\u5916\u90e8\u7684\u6d41\u91cf\u8bbf\u95ee\u7ecf\u7531 egress \u53bb\u5230\u5916\u90e8\u3002 \u73b0\u5728\u6211\u4eec\u5728 istio \u4e2d\u5b9a\u4e49\u4e00\u4e2a egress gateway \u5bf9\u8c61\u6765\u6ce8\u518c\u5141\u8bb8\u4ece\u670d\u52a1\u7f51\u683c\u51fa\u53bb\u7684\u670d\u52a1\uff0c\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e edition.cnn.com \u7684 egress gateway \u5bf9\u8c61:( cnn-egress-gateway.yaml ) apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: istio-egressgateway spec: selector: istio: egressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - edition.cnn.com \u9664\u4e86\u4e0a\u9762\u7684 engress gateway \u5bf9\u8c61\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa VirtualService \u548c DestinationRule \u8fd9\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61:\uff08 cnn-virtual-rule.yaml \uff09 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: direct-cnn-through-egress-gateway spec: hosts: - edition.cnn.com gateways: - istio-egressgateway - mesh http: - match: - gateways: - mesh port: 80 route: - destination: host: istio-egressgateway.istio-system.svc.cluster.local subset: cnn port: number: 80 weight: 100 - match: - gateways: - istio-egressgateway port: 80 route: - destination: host: edition.cnn.com port: number: 80 weight: 100 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: egressgateway-for-cnn spec: host: istio-egressgateway.istio-system.svc.cluster.local subsets: - name: cnn \u7136\u540e\u521b\u5efa\u4e0a\u97623\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a $ istioctl create -f cnn-virtual-rule.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config virtual-service/default/direct-cnn-through-egress-gateway at revision 38205 Created config destination-rule/default/egressgateway-for-cnn at revision 38206 $ istioctl create -f cnn-egress-gateway.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config gateway/default/istio-egressgateway at revision 38218 \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u73b0\u5728\u6211\u4eec\u518d\u53bb sleep \u5bb9\u5668\u6267\u884c\u4e0b\u4e0a\u9762\u7684\u8bf7\u6c42\uff1a $ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics HTTP/1.1 301 Moved Permanently server: envoy retry-after: 0 content-length: 0 cache-control: public, max-age=600 location: https://edition.cnn.com/politics accept-ranges: bytes date: Mon, 15 Oct 2018 17:33:57 GMT via: 1.1 varnish set-cookie: countryCode=CN; Domain=.cnn.com; Path=/ set-cookie: geoData=beijing|BJ|100000|CN|AS; Domain=.cnn.com; Path=/ x-served-by: cache-nrt6151-NRT x-cache: HIT x-cache-hits: 0 x-envoy-upstream-service-time: 439 HTTP/1.1 200 OK Content-Type: text/html; charset=utf-8 x-servedByHost: ::ffff:172.17.25.25 access-control-allow-origin: * cache-control: max-age=60 content-security-policy: default-src 'self' blob: https://*.cnn.com:* http://*.cnn.com:* *.cnn.io:* *.cnn.net:* *.turner.com:* *.turner.io:* *.ugdturner.com:* courageousstudio.com *.vgtf.net:*; script-src 'unsafe-eval' 'unsafe-inline' 'self' *; style-src 'unsafe-inline' 'self' blob: *; child-src 'self' blob: *; frame-src 'self' *; object-src 'self' *; img-src 'self' data: blob: *; media-src 'self' data: blob: *; font-src 'self' data: *; connect-src 'self' *; frame-ancestors 'self' https://*.cnn.com:* http://*.cnn.com https://*.cnn.io:* http://*.cnn.io:* *.turner.com:* courageousstudio.com; x-content-type-options: nosniff x-xss-protection: 1; mode=block Via: 1.1 varnish Content-Length: 1704385 Accept-Ranges: bytes Date: Mon, 15 Oct 2018 09:34:01 GMT Via: 1.1 varnish Age: 127 Connection: keep-alive Set-Cookie: countryCode=CN; Domain=.cnn.com; Path=/ Set-Cookie: geoData=beijing|BJ|100000|CN|AS; Domain=.cnn.com; Path=/ Set-Cookie: tryThing00=6048; Domain=.cnn.com; Path=/; Expires=Mon Jul 01 2019 00:00:00 GMT Set-Cookie: tryThing01=0013; Domain=.cnn.com; Path=/; Expires=Fri Mar 01 2019 00:00:00 GMT Set-Cookie: tryThing02=9990; Domain=.cnn.com; Path=/; Expires=Wed Jan 01 2020 00:00:00 GMT X-Served-By: cache-iad2127-IAD, cache-tyo19949-TYO X-Cache: HIT, MISS X-Cache-Hits: 1, 0 X-Timer: S1539596041.954017,VS0,VE471 Vary: Accept-Encoding \u73b0\u5728\u6211\u4eec\u53d1\u73b0\u53ef\u4ee5\u6b63\u5e38\u8fd4\u56de\u5185\u5bb9\uff0c\u8fd9\u65f6\u6211\u4eec\u53bb\u67e5\u770b egressgateway \u7684 Pod \u4e2d\u7684\u5bb9\u5668\u65e5\u5fd7\uff1a $ kubectl logs $(kubectl get pod -l istio=egressgateway -n istio-system -o jsonpath='{.items[0].metadata.name}') -n istio-system | tail ...... [2019-04-20T17:33:57.261Z] \"GET /politics HTTP/2\" 301 - 0 0 437 429 \"10.244.4.206\" \"curl/7.35.0\" \"6d4f2ac3-0957-97a5-961a-241c7fd72536\" \"edition.cnn.com\" \"151.101.129.67:80\" ...... \u53ef\u4ee5\u770b\u5230\u6709\u4e00\u6761\u4e0a\u9762\u7684 GET /politics \u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u8bf4\u660e\u8bbf\u95ee\u7ecf\u8fc7\u4e86 egress gateway \u51fa\u53bb\u4e86\u3002 5\u3001 VirtualService & DestinationRule \u89c4\u5219\u8bf4\u660e \u6700\u540e\u7b80\u5355\u603b\u7ed3\u4e0b VirtualService \u548c DestinationRule \u7684\u4e00\u4e9b\u914d\u7f6e\u89c4\u5219\u3002 5-1 VirtualService \u7684\u914d\u7f6e\u89c4\u5219\u8bf4\u660e 5-2 DestinationRule \u7684\u914d\u7f6e\u89c4\u5219\u8bf4\u660e \uff1a \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u628a\u57fa\u4e8e BookInfo \u793a\u4f8b\u7684\u6d41\u91cf\u63a7\u5236\u7ba1\u7406\u7684\u914d\u7f6e\u548c\u5927\u5bb6\u8bb2\u89e3\u5b8c\u4e86\u3002 6\u3001\u6536\u4e2a\u5c3e $ kubectl delete namespace istio-system namespace \"istio-system\" deleted $ kubectl delete --all pods --namespace=default $ kubectl delete --all deployments --namespace=default $ kubectl delete --all services --namespace=default","title":"L3 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u5ef6\u8fdf\u8bbf\u95ee/\u4e2d\u65ad\u8bbf\u95ee/\u4e0d\u540c\u73af\u5883/\u670d\u52a1\u7f51\u683c\u5916)"},{"location":"chap6/3BookInfo_2/#l3-bookinfo","text":"","title":"L3 \u57fa\u4e8eBookinfo\u7684\u6d41\u91cf\u7ba1\u7406\u914d\u7f6e(\u5ef6\u8fdf\u8bbf\u95ee/\u4e2d\u65ad\u8bbf\u95ee/\u4e0d\u540c\u73af\u5883/\u670d\u52a1\u7f51\u683c\u5916)"},{"location":"chap6/3BookInfo_2/#1","text":"\u63a5\u4e0a\u8282\u8bfe\u7684\u5185\u5bb9\uff0c\u7b2c\u4e00\u6b65\u8fd8\u662f\u9700\u8981\u79fb\u9664\u4e4b\u524d\u521b\u5efa\u7684 VirtualService : $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 23h reviews $ istioctl delete virtualservice reviews Command \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Deleted config: virtualservice reviews $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 23h cd /Users/jxi/Devops/bookinfo/istio-1.1.3 \u7136\u540e\u6211\u4eec\u67e5\u770b istio \u6837\u4f8b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6\uff1a samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml \u7684\u5185\u5bb9 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: ratings spec: hosts: - ratings http: - match: - headers: end-user: exact: jason fault: delay: percent: 100 fixedDelay: 7s route: - destination: host: ratings subset: v1 - route: - destination: host: ratings subset: v1 \u8fd9\u4e2a VirtualService \u5b9a\u4e49\u4e86\u4e00\u4e2a\u5728 jason \u767b\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u8bbf\u95ee ratings \u670d\u52a1\u7684 100% \u7684 7s \u8bbf\u95ee\u5ef6\u8fdf\u3002 \u524d\u9762\u6211\u4eec\u77e5\u9053\uff0c Bookinfo \u8fd9\u4e2a\u793a\u4f8b productpage \u670d\u52a1\u8c03\u7528 reviews \uff0c reviews \u7684\u4e0d\u540c\u7248\u672c\u4f1a\u5bf9 ratings \u8fdb\u884c\u4e0d\u540c\u7684\u8c03\u7528\uff0c \u5176\u4e2d reviews-v1 \u4e0d\u8c03\u7528 ratings \uff0c reviews-v2 \u548c reviews-v3 \u4f1a\u8c03\u7528 ratings \uff0c\u5e76\u505a\u4e0d\u540c\u6837\u5f0f\u7684\u6e32\u67d3\u3002 \u5e76\u4e14\u5728 productpage \u8bbf\u95ee reviews \u65f6\uff0c\u4ee3\u7801\u4e2d\u6709\u786c\u7f16\u7801 6s \u4e2d\u7684\u8bbf\u95ee\u8d85\u65f6\u9650\u5236\uff0c \u800c reviews \u8bbf\u95ee ratings \u7f16\u7801\u4e86 10s \u7684\u8bbf\u95ee\u8d85\u65f6\u9650\u5236\u3002 \u4e86\u89e3\u8fd9\u4e00\u70b9\u540e\uff0c\u6211\u4eec\u73b0\u5728\u6765\u521b\u5efa\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\uff1a $ kubectl create -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml virtualservice.networking.istio.io/ratings created $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 23h ratings \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u524d\u5f80 Bookinfo \u5e94\u7528\uff0c\u767b\u5f55 jason \uff0c\u6253\u5f00\u6d4f\u89c8\u5668\u7684 Network \uff0c\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u8bf7\u6c42\u52a0\u8f7d\u5f88\u6162\uff0c\u5927\u7ea6 6s \u540e\uff0c\u51fa\u73b0\u5982\u4e0b\u754c\u9762 \u770b\u5230 productpage \u7684\u8bf7\u6c42\u5927\u7ea6\u8017\u65f6 6s \uff0c Reviews \u663e\u793a unavailable \u7684\u9519\u8bef\u3002 \u56e0\u4e3a\u6b64\u65f6 reviews \u8bf7\u6c42 ratings \u7684\u8bbf\u95ee\u8d85\u8fc7\u4e86 6s \u8fd8\u6ca1\u6709\u54cd\u5e94\uff0c\u4f7f\u5f97 productpage \u4e2d\u7684\u786c\u7f16\u7801\u7684\u8d85\u65f6\u8bbe\u7f6e\u751f\u6548\u4e86\u3002 \u901a\u8fc7\u8fd9\u79cd \u8d85\u65f6\u6545\u969c\u6ce8\u5165 \uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u65b9\u4fbf\u5730\u53d1\u73b0\u670d\u52a1\u95f4\u76f8\u4e92\u8bbf\u95ee\u4e2d\u5b58\u5728\u7684\u6f5c\u5728\u95ee\u9898\u3002","title":"1\u3001\u5ef6\u8fdf\u8bbf\u95ee\u6545\u969c\u6ce8\u5165"},{"location":"chap6/3BookInfo_2/#2","text":"\u540c\u6837\u79fb\u9664\u521a\u624d\u7684 VirutualService \u8d44\u6e90\u5bf9\u8c61\uff1a $ istioctl delete virtualservice ratings Command \"delete\" is deprecated, Use `kubectl delete` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Deleted config: virtualservice ratings $ istioctl get virtualservice Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 23h \u7136\u540e\u6211\u4eec\u67e5\u770b istio \u6837\u4f8b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6\uff1a samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml \u7684\u5185\u5bb9 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: ratings spec: hosts: - ratings http: - match: - headers: end-user: exact: jason fault: abort: percent: 100 httpStatus: 500 route: - destination: host: ratings subset: v1 - route: - destination: host: ratings subset: v1 \u901a\u8fc7\u4e0a\u9762\u7684\u8fd9\u4e2a yaml \u6587\u4ef6\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\u914d\u7f6e\u4e86\u5728 jason \u767b\u5f55\u65f6\uff0c reviews \u5bf9 ratings \u8bbf\u95ee\u65f6 100% \u7684\u8fd4\u56de\u4e00\u4e2a 500 \u9519\u8bef\u54cd\u5e94\u3002 \u7136\u540e\u540c\u6837\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a(\u7528 kubectl \u6216\u8005 istioctl \u5de5\u5177\u90fd\u662f\u53ef\u4ee5\u7684) $ istioctl create -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml Created config virtual-service/default/ratings at revision 32143909 $ istioctl get virtualservice VIRTUAL-SERVICE NAME GATEWAYS HOSTS #HTTP #TCP NAMESPACE AGE bookinfo bookinfo-gateway * 1 0 default 6d ratings ratings 2 0 default 4s \u73b0\u5728\u6211\u4eec\u56de\u5230 BookInfo \u5e94\u7528\uff0c\u767b\u5f55 jason \uff0c\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u4e0b\u9762\u7684\u73b0\u8c61\uff1a \u6211\u4eec\u53ef\u4ee5\u770b\u5230 reviews \u5bf9 ratings \u7684\u8bbf\u95ee\u5931\u8d25\u4e86\uff0c\u670d\u52a1\u4e0a\u9762\u6211\u4eec VirtualService \u8d44\u6e90\u5bf9\u8c61\u7684\u914d\u7f6e\u3002","title":"2\u3001\u4e2d\u65ad\u8bbf\u95ee\u6545\u969c\u6ce8\u5165"},{"location":"chap6/3BookInfo_2/#3","text":"\u4f7f\u7528 istio \u7684\u8def\u7531\u89c4\u5219\u7ba1\u7406\uff0c\u8fd8\u53ef\u4ee5\u914d\u7f6e\u5bf9\u4e0d\u540c\u73af\u5883( prod, staging, dev \u7b49)\u7684\u540c\u4e00\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u3002\u7531\u4e8e\u6211\u7684\u5b9e\u9a8c\u73af\u5883\u6ca1\u6709\u642d\u5efa\u591a\u73af\u5883\u7684\u96c6\u7fa4\uff0c \u8fd9\u91cc\u6307\u4f7f\u7528\u5b98\u65b9\u7684demo\u6765\u505a\u63cf\u8ff0 \u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: my-productpage-rule namespace: istio-system spec: hosts: - productpage.prod.svc.cluster.local # ignores rule namespace http: - timeout: 5s route: - destination: host: productpage.prod.svc.cluster.local \u901a\u5e38\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u5982\u679c\u642d\u5efa\u591a\u73af\u5883\u7684\u60c5\u51b5\u53ef\u4ee5\u4f7f\u7528 namespace \u6765\u8fdb\u884c\u5212\u5206\uff0c\u800c\u4f7f\u7528\u4e0a\u9762\u7684\u65b9\u5f0f\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u5176\u4ed6 namepaces \u7684\u670d\u52a1\u7684\u8bbf\u95ee\u3002 \u4e0a\u9762\u7684 VirtualService \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 namespace \u4e3a prod \u4e2d\u7684 productpage \u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4f1a\u5728 5s \u7684 timeout \u540e\u624d\u4f1a\u8c03\u7528\u8be5\u670d\u52a1\u3002 \u8fd9\u4e2a\u8bbf\u95ee\u89c4\u5219\u6ca1\u6709\u5b9a\u4e49 subset \uff0cistio \u4f1a\u83b7\u53d6 productpage.prod.svc.cluster.local \u670d\u52a1\u5bf9\u5e94\u7684\u6240\u6709\u5b9e\u4f8b\u5e76\u5411\u5176\u4ed6\u670d\u52a1\u5b9e\u4f8b\u6ce8\u5165\u8fd9\u4e9b\u5b9e\u4f8b\u7684\u4fe1\u606f\u5230\u4ed6\u4eec\u7684 load balancing pool \u4e2d\u53bb\u3002 \u540c\u65f6\u6ce8\u610f\u8fd9\u4e2a VirtualService \u662f\u5b9a\u4e49\u5728 istio-system \u7684 namespace \u4e2d\u7684\uff0c\u6b64\u65f6\u8981\u4f7f\u7528\u5b8c\u6574\u7684\u670d\u52a1\u57df\u540d\uff1a productpage.prod.svc.cluster.local \uff0c\u8fd9\u6837\u8fd9\u6761\u89c4\u5219\u6240\u5c5e\u7684 namespace \u624d\u4f1a\u89e3\u6790\u5230\u5176\u4ed6 namespace \u7684\u670d\u52a1\u3002","title":"3\u3001\u4e0d\u540c\u73af\u5883\u670d\u52a1\u8bbf\u95ee"},{"location":"chap6/3BookInfo_2/#4","text":"\u4e3a\u4e86\u63a7\u5236\u670d\u52a1\u7f51\u683c\u5916\u7684\u670d\u52a1\u7684\u6d41\u91cf\u8bbf\u95ee\uff0c \u5916\u90e8\u7684\u670d\u52a1\u5fc5\u987b\u9996\u5148\u4f7f\u7528\u4e00\u4e2a ServiceEntry \u5bf9\u8c61\u52a0\u5165\u5230 istio \u7684\u5185\u90e8 service registry \u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u624d\u4f1a\u77e5\u9053\u5982\u4f55\u5bfc\u5411\u8fd9\u4e9b\u5916\u90e8\u670d\u52a1\u7684\u6d41\u91cf\u3002 \u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e2a\u529f\u80fd\uff0c\u6211\u4eec\u4f7f\u7528 istio \u6837\u4f8b\u4e2d\u7684 sleep \u5e94\u7528\u6765\u9a8c\u8bc1\u6539\u529f\u80fd\uff0c\u67e5\u770b samples/sleep/sleep.yaml \u6587\u4ef6\u5185\u5bb9\uff1a apiVersion: v1 kind: Service metadata: name: sleep labels: app: sleep spec: ports: - port: 80 name: http selector: app: sleep --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep spec: replicas: 1 template: metadata: labels: app: sleep spec: containers: - name: sleep image: tutum/curl command: [\"/bin/sleep\",\"infinity\"] imagePullPolicy: IfNotPresent --- \u8fd9\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5e94\u7528\uff0c\u901a\u8fc7 Deployment \u8fdb\u884c\u63a7\u5236\uff0c\u901a\u8fc7 Service \u66b4\u9732\u670d\u52a1\uff0c\u73b0\u5728\u6211\u4eec\u6765\u90e8\u7f72\u8be5\u5e94\u7528\uff1a $ kubectl apply -f <(istioctl kube-inject -f samples/sleep/sleep.yaml) service \"sleep\" created deployment.extensions \"sleep\" created \u5f85\u5e94\u7528\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u8fdb\u5165\u8be5\u5e94\u7528\u5bb9\u5668\u5185\u90e8\u6267\u884c\u4e00\u4e9b\u6d4b\u8bd5\u64cd\u4f5c\uff1a $ export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name}) $ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics HTTP/1.1 404 Not Found date: Sat, 20 Apr 2019 03:08:34 GMT server: envoy content-length: 0 \u53ef\u4ee5\u770b\u5230\u4f1a\u8fd4\u56de\u4e0a\u9762\u7684 404 \u7684\u4fe1\u606f\uff0c\u56e0\u4e3a\u8be5\u57df\u540d\u4e0d\u5728\u5f53\u524d\u7684\u670d\u52a1\u7f51\u683c\u4e2d\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b istio \u4e0d\u5141\u8bb8\u8bbf\u95ee\u670d\u52a1\u7f51\u683c\u5916\u90e8\u7684 URL\uff0c\u5373\u670d\u52a1\u7f51\u683c\u4e2d\u5bf9\u672a\u77e5\u7684\u670d\u52a1\u8bf7\u6c42\u4f1a\u88ab\u4e22\u5f03\u3002 \u8fd9\u5c31\u9700\u8981\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a ServiceEntry \u5bf9\u8c61\uff0c\u5c06\u5916\u90e8\u7684\u8bbf\u95ee\u670d\u52a1\u5f15\u5165\u5230\u670d\u52a1\u7f51\u683c\u4e2d\u6765\u3002 \u4f8b\u5982\u4e0b\u9762\u7684\u89c4\u5219\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbf\u95ee edition.cnn.com \u7684\u670d\u52a1\u7684 ServiceEntry :\uff08 cnn-service-entry.yaml \uff09 apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: cnn spec: hosts: - edition.cnn.com ports: - number: 80 name: http-port protocol: HTTP - number: 443 name: https protocol: HTTPS resolution: DNS \u73b0\u5728\u6211\u4eec\u6765\u90e8\u7f72\u4e0a\u9762\u7684 ServiceEntry \u8d44\u6e90\uff1a $ istioctl create -f cnn-service-entry.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config service-entry/default/cnn at revision 37978 $ istioctl get serviceentry Command \"get\" is deprecated, Use `kubectl get` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) SERVICE-ENTRY NAME HOSTS PORTS NAMESPACE AGE cnn edition.cnn.com HTTP/80,HTTPS/443 default 13s \u73b0\u5728\u6211\u4eec\u518d\u53bb\u4e0a\u9762\u7684 sleep \u5bb9\u5668\u4e2d\u6267\u884c\u4e0a\u9762\u7684\u6d4b\u8bd5\u8bf7\u6c42\uff1a $ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics HTTP/1.1 301 Moved Permanently server: envoy retry-after: 0 content-length: 0 cache-control: public, max-age=600 location: https://edition.cnn.com/politics accept-ranges: bytes date: Sat, 20 Apr 2019 03:10:47 GMT via: 1.1 varnish set-cookie: countryCode=JP; Domain=.cnn.com; Path=/ set-cookie: geoData=minato|13|105-0001|JP|AS|900|broadband; Domain=.cnn.com; Path=/ x-served-by: cache-hnd18731-HND x-cache: HIT x-cache-hits: 0 x-envoy-upstream-service-time: 608 HTTP/2 200 content-type: text/html; charset=utf-8 x-servedbyhost: ::ffff:127.0.0.1 access-control-allow-origin: * cache-control: max-age=60 content-security-policy: default-src 'self' blob: https://*.cnn.com:* http://*.cnn.com:* *.cnn.io:* *.cnn.net:* *.turner.com:* *.turner.io:* *.ugdturner.com:* courageousstudio.com *.vgtf.net:*; script-src 'unsafe-eval' 'unsafe-inline' 'self' *; style-src 'unsafe-inline' 'self' blob: *; child-src 'self' blob: *; frame-src 'self' *; object-src 'self' *; img-src 'self' data: blob: *; media-src 'self' data: blob: *; font-src 'self' data: *; connect-src 'self' *; frame-ancestors 'self' https://*.cnn.com:* http://*.cnn.com https://*.cnn.io:* http://*.cnn.io:* *.turner.com:* courageousstudio.com; x-content-type-options: nosniff x-xss-protection: 1; mode=block via: 1.1 varnish accept-ranges: bytes date: Sat, 20 Apr 2019 03:10:48 GMT via: 1.1 varnish age: 156 set-cookie: countryCode=JP; Domain=.cnn.com; Path=/ set-cookie: geoData=minato|13|105-0001|JP|AS|900|broadband; Domain=.cnn.com; Path=/ set-cookie: tryThing00=0110; Domain=.cnn.com; Path=/; Expires=Mon Jul 01 2019 00:00:00 GMT set-cookie: tryThing01=7956; Domain=.cnn.com; Path=/; Expires=Sun Mar 01 2020 00:00:00 GMT set-cookie: tryThing02=3144; Domain=.cnn.com; Path=/; Expires=Wed Jan 01 2020 00:00:00 GMT x-served-by: cache-iad2121-IAD, cache-hnd18726-HND x-cache: HIT, MISS x-cache-hits: 3, 0 x-timer: S1555729848.352917,VS0,VE542 vary: Accept-Encoding content-length: 1247678 \u73b0\u5728\u6211\u4eec\u53d1\u73b0\u53ef\u4ee5\u6b63\u5e38\u8fd4\u56de\u5185\u5bb9\u4e86\uff0c\u8fd4\u56de200\uff0c\u8bc1\u660e\u8bf7\u6c42\u6210\u529f\u4e86\u3002 \u8bf4\u660e\uff1a -L \u8ba9 curl \u8ddf\u968f\u8fde\u63a5\u8fdb\u884c\u91cd\u5b9a\u5411\u3002 \u8fd9\u91cc\u670d\u52a1\u5668\u76f4\u63a5\u8fd4\u56de\u7684 30 1 \u91cd\u5b9a\u5411\u54cd\u5e94 \uff0c\u8981\u6c42\u5ba2\u6237\u7aef\u518d\u4f7f\u7528HTTPS\u7684\u65b9\u5f0f\u5bf9 https://edition.cnn.com/ politics \u5730\u5740\u8fdb\u884c\u8bbf\u95ee\uff0c\u7b2c\u4e8c\u6b21\u8bbf\u95ee\u624d\u8fd4\u56de\u4e86 200 \u7684\u6210\u529f\u7801\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u8fdb\u4e00\u6b65\u914d\u7f6e egress gateway \uff0c\u4f7f\u8fd9\u4e9b\u5bf9\u5916\u90e8\u7684\u6d41\u91cf\u8bbf\u95ee\u7ecf\u7531 egress \u53bb\u5230\u5916\u90e8\u3002 \u73b0\u5728\u6211\u4eec\u5728 istio \u4e2d\u5b9a\u4e49\u4e00\u4e2a egress gateway \u5bf9\u8c61\u6765\u6ce8\u518c\u5141\u8bb8\u4ece\u670d\u52a1\u7f51\u683c\u51fa\u53bb\u7684\u670d\u52a1\uff0c\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e edition.cnn.com \u7684 egress gateway \u5bf9\u8c61:( cnn-egress-gateway.yaml ) apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: istio-egressgateway spec: selector: istio: egressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - edition.cnn.com \u9664\u4e86\u4e0a\u9762\u7684 engress gateway \u5bf9\u8c61\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa VirtualService \u548c DestinationRule \u8fd9\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61:\uff08 cnn-virtual-rule.yaml \uff09 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: direct-cnn-through-egress-gateway spec: hosts: - edition.cnn.com gateways: - istio-egressgateway - mesh http: - match: - gateways: - mesh port: 80 route: - destination: host: istio-egressgateway.istio-system.svc.cluster.local subset: cnn port: number: 80 weight: 100 - match: - gateways: - istio-egressgateway port: 80 route: - destination: host: edition.cnn.com port: number: 80 weight: 100 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: egressgateway-for-cnn spec: host: istio-egressgateway.istio-system.svc.cluster.local subsets: - name: cnn \u7136\u540e\u521b\u5efa\u4e0a\u97623\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a $ istioctl create -f cnn-virtual-rule.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config virtual-service/default/direct-cnn-through-egress-gateway at revision 38205 Created config destination-rule/default/egressgateway-for-cnn at revision 38206 $ istioctl create -f cnn-egress-gateway.yaml Command \"create\" is deprecated, Use `kubectl create` instead (see https://kubernetes.io/docs/tasks/tools/install-kubectl) Created config gateway/default/istio-egressgateway at revision 38218 \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u73b0\u5728\u6211\u4eec\u518d\u53bb sleep \u5bb9\u5668\u6267\u884c\u4e0b\u4e0a\u9762\u7684\u8bf7\u6c42\uff1a $ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics HTTP/1.1 301 Moved Permanently server: envoy retry-after: 0 content-length: 0 cache-control: public, max-age=600 location: https://edition.cnn.com/politics accept-ranges: bytes date: Mon, 15 Oct 2018 17:33:57 GMT via: 1.1 varnish set-cookie: countryCode=CN; Domain=.cnn.com; Path=/ set-cookie: geoData=beijing|BJ|100000|CN|AS; Domain=.cnn.com; Path=/ x-served-by: cache-nrt6151-NRT x-cache: HIT x-cache-hits: 0 x-envoy-upstream-service-time: 439 HTTP/1.1 200 OK Content-Type: text/html; charset=utf-8 x-servedByHost: ::ffff:172.17.25.25 access-control-allow-origin: * cache-control: max-age=60 content-security-policy: default-src 'self' blob: https://*.cnn.com:* http://*.cnn.com:* *.cnn.io:* *.cnn.net:* *.turner.com:* *.turner.io:* *.ugdturner.com:* courageousstudio.com *.vgtf.net:*; script-src 'unsafe-eval' 'unsafe-inline' 'self' *; style-src 'unsafe-inline' 'self' blob: *; child-src 'self' blob: *; frame-src 'self' *; object-src 'self' *; img-src 'self' data: blob: *; media-src 'self' data: blob: *; font-src 'self' data: *; connect-src 'self' *; frame-ancestors 'self' https://*.cnn.com:* http://*.cnn.com https://*.cnn.io:* http://*.cnn.io:* *.turner.com:* courageousstudio.com; x-content-type-options: nosniff x-xss-protection: 1; mode=block Via: 1.1 varnish Content-Length: 1704385 Accept-Ranges: bytes Date: Mon, 15 Oct 2018 09:34:01 GMT Via: 1.1 varnish Age: 127 Connection: keep-alive Set-Cookie: countryCode=CN; Domain=.cnn.com; Path=/ Set-Cookie: geoData=beijing|BJ|100000|CN|AS; Domain=.cnn.com; Path=/ Set-Cookie: tryThing00=6048; Domain=.cnn.com; Path=/; Expires=Mon Jul 01 2019 00:00:00 GMT Set-Cookie: tryThing01=0013; Domain=.cnn.com; Path=/; Expires=Fri Mar 01 2019 00:00:00 GMT Set-Cookie: tryThing02=9990; Domain=.cnn.com; Path=/; Expires=Wed Jan 01 2020 00:00:00 GMT X-Served-By: cache-iad2127-IAD, cache-tyo19949-TYO X-Cache: HIT, MISS X-Cache-Hits: 1, 0 X-Timer: S1539596041.954017,VS0,VE471 Vary: Accept-Encoding \u73b0\u5728\u6211\u4eec\u53d1\u73b0\u53ef\u4ee5\u6b63\u5e38\u8fd4\u56de\u5185\u5bb9\uff0c\u8fd9\u65f6\u6211\u4eec\u53bb\u67e5\u770b egressgateway \u7684 Pod \u4e2d\u7684\u5bb9\u5668\u65e5\u5fd7\uff1a $ kubectl logs $(kubectl get pod -l istio=egressgateway -n istio-system -o jsonpath='{.items[0].metadata.name}') -n istio-system | tail ...... [2019-04-20T17:33:57.261Z] \"GET /politics HTTP/2\" 301 - 0 0 437 429 \"10.244.4.206\" \"curl/7.35.0\" \"6d4f2ac3-0957-97a5-961a-241c7fd72536\" \"edition.cnn.com\" \"151.101.129.67:80\" ...... \u53ef\u4ee5\u770b\u5230\u6709\u4e00\u6761\u4e0a\u9762\u7684 GET /politics \u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u8bf4\u660e\u8bbf\u95ee\u7ecf\u8fc7\u4e86 egress gateway \u51fa\u53bb\u4e86\u3002","title":"4\u3001\u670d\u52a1\u7f51\u683c\u5916\u7684\u6d41\u91cf\u7ba1\u7406"},{"location":"chap6/3BookInfo_2/#5virtualservice-destinationrule","text":"\u6700\u540e\u7b80\u5355\u603b\u7ed3\u4e0b VirtualService \u548c DestinationRule \u7684\u4e00\u4e9b\u914d\u7f6e\u89c4\u5219\u3002","title":"5\u3001VirtualService &amp; DestinationRule \u89c4\u5219\u8bf4\u660e"},{"location":"chap6/3BookInfo_2/#5-1-virtualservice","text":"","title":"5-1 VirtualService \u7684\u914d\u7f6e\u89c4\u5219\u8bf4\u660e"},{"location":"chap6/3BookInfo_2/#5-2-destinationrule","text":"\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u628a\u57fa\u4e8e BookInfo \u793a\u4f8b\u7684\u6d41\u91cf\u63a7\u5236\u7ba1\u7406\u7684\u914d\u7f6e\u548c\u5927\u5bb6\u8bb2\u89e3\u5b8c\u4e86\u3002","title":"5-2 DestinationRule \u7684\u914d\u7f6e\u89c4\u5219\u8bf4\u660e\uff1a"},{"location":"chap6/3BookInfo_2/#6","text":"$ kubectl delete namespace istio-system namespace \"istio-system\" deleted $ kubectl delete --all pods --namespace=default $ kubectl delete --all deployments --namespace=default $ kubectl delete --all services --namespace=default","title":"6\u3001\u6536\u4e2a\u5c3e"},{"location":"chap7/k8s_adv54_release/","text":"L1 Kubernetes \u4e2d\u7684\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u84dd\u7eff\u90e8\u7f72\u548c\u91d1\u4e1d\u96c0\u90e8\u7f72, shipper, Istio, Flagger \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u662f\u6301\u7eed\u4ea4\u4ed8\u7684\u4e0b\u4e00\u6b65 \uff0c \u5b83\u5c06\u65b0\u7248\u672c\u90e8\u7f72\u5230\u7528\u6237\u7684\u4e00\u4e2a\u5b50\u96c6\uff0c\u5e76\u5728\u5c06\u5176\u6eda\u52a8\u5230\u5168\u90e8\u7528\u6237\u4e4b\u524d\u5bf9\u5176\u6b63\u786e\u6027\u548c\u6027\u80fd\u8fdb\u884c\u8bc4\u4f30\uff0c \u5982\u679c\u4e0d\u5339\u914d\u67d0\u4e9b\u5173\u952e\u6307\u6807\uff0c\u5219\u8fdb\u884c\u56de\u6eda\u3002 \u8fd9\u91cc\u6709\u4e00\u4e9b\u6709\u8da3\u7684\u9879\u76ee\uff0c\u4f7f\u5f97\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u5728 Kubernetes \u4e2d\u53d8\u5f97\u66f4\u7b80\u5355\u3002\u6211\u5c06\u4f7f\u7528\u4e00\u4e2a Jenkins X \u793a\u4f8b\u9879\u76ee \u5bf9\u5b83\u4eec\u4e4b\u4e2d\u7684\u4e09\u4e2a\u8fdb\u884c\u8ba8\u8bba\uff1a Shipper \u3001 Istio \u4ee5\u53ca Flagger \u3002 1\u3001Shipper shipper \u662f\u6765\u81ea booking.com \u7684\u4e00\u4e2a\u9879\u76ee\uff0c \u5b83\u5bf9 Kubernetes \u8fdb\u884c\u4e86\u6269\u5c55\uff0c\u6dfb\u52a0\u4e86\u590d\u6742\u7684\u90e8\u7f72\u7b56\u7565\u548c\u591a\u96c6\u7fa4\u7f16\u6392\uff08\u6587\u6863\uff09\u3002\u5b83\u652f\u6301\u4ece\u4e00\u4e2a\u96c6\u7fa4\u5230\u591a\u4e2a\u96c6\u7fa4\u7684\u90e8\u7f72\uff0c\u5141\u8bb8\u591a\u533a\u57df\u90e8\u7f72\u3002 Shipper \u901a\u8fc7\u4e00\u4e2a shipperctl \u547d\u4ee4\u884c\u8fdb\u884c\u5b89\u88c5\u3002\u5b83\u589e\u52a0\u4e0d\u540c\u96c6\u7fa4\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u8fdb\u884c\u7ba1\u7406\u3002\u8bf7\u6ce8\u610f\u8fd9\u4e2a\u4e0e GKE \u4e0a\u4e0b\u6587\u76f8\u5173\u7684\u95ee\u9898\u3002 Shipper \u4f7f\u7528 Helm \u5305\u6765\u90e8\u7f72\uff0c\u4f46\u662f\u5b83\u4eec\u6ca1\u6709\u968f\u7740 Helm \u4e00\u8d77\u5b89\u88c5\uff0c\u5b83\u4eec\u4e0d\u4f1a\u5728 helm list \u7684\u8f93\u51fa\u663e\u793a\u3002 \u540c\u6837\u5730\uff0c deployments \u7684\u7248\u672c\u5fc5\u987b\u662f apps/v1 \uff0c \u5426\u5219 shipper \u5c06\u4e0d\u80fd\u7f16\u8f91 deployment \u6765\u6dfb\u52a0\u6b63\u786e\u7684\u6807\u7b7e\u548c\u526f\u672c\u6570\u91cf\u3002 \u4f7f\u7528 shipper \u90e8\u7f72\u90fd\u662f\u4e0e\u4ece \u65e7\u7248\u672c(\u73b0\u6709\u7248\u672c) \u8fc7\u6e21\u5230 \u65b0\u7248\u672c(\u7ade\u4e89\u7248\u672c) \u76f8\u5173\u3002\u8fd9\u662f\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5e94\u7528\u5bf9\u8c61\u5b9e\u73b0\u7684\uff0c \u5b83\u5b9a\u4e49\u4e86\u90e8\u7f72\u9700\u8981\u901a\u8fc7\u7684\u591a\u4e2a\u9636\u6bb5\u3002\u4f8b\u5982\u4e0b\u9762 3 \u4e2a\u6b65\u9aa4\u8fc7\u7a0b\uff1a Staging \uff1a\u90e8\u7f72\u65b0\u7248\u672c\u5230\u4e00\u4e2a pod \uff0c\u6ca1\u6709\u6d41\u91cf 50 / 50 \uff1a\u90e8\u7f72\u65b0\u7248\u672c\u5230 50% \u7684 pods \uff0c 50% \u7684\u6d41\u91cf Full on \uff1a\u90e8\u7f72\u65b0\u7248\u672c\u5230\u5168\u90e8\u7684 pods \uff0c\u5168\u90e8\u7684\u6d41\u91cf strategy: steps: - name: staging capacity: contender: 1 incumbent: 100 traffic: contender: 0 incumbent: 100 - name: 50/50 capacity: contender: 50 incumbent: 50 traffic: contender: 50 incumbent: 50 - name: full on capacity: contender: 100 incumbent: 0 traffic: contender: 100 incumbent: 0 \u5982\u679c\u53d1\u5e03\u7684\u67d0\u4e2a\u6b65\u9aa4\u6ca1\u6709\u5c06\u6d41\u91cf\u53d1\u9001\u5230 pods \uff0c \u5219\u53ef\u4ee5\u4f7f\u7528 kubectl port-forward \u8bbf\u95ee\u5b83\u4eec\uff0c\u5982\uff1a kubectl port-forward mypod 8080:8080 \uff0c \u8fd9\u5bf9\u4e8e\u5728\u7528\u6237\u770b\u5230\u65b0\u7248\u672c\u4e4b\u524d\u8fdb\u884c\u6d4b\u8bd5\u975e\u5e38\u6709\u7528\u3002 Shipper \u652f\u6301\u591a\u96c6\u7fa4\u7684\u6982\u5ff5\uff0c\u4f46\u662f\u4ee5\u76f8\u540c\u7684\u65b9\u5f0f\u5bf9\u5f85\u6240\u6709\u96c6\u7fa4\uff0c\u4ec5\u4f7f\u7528\u533a\u57df\u5e76\u901a\u8fc7 capabilities \uff08\u914d\u7f6e\u5728\u96c6\u7fa4\u5bf9\u8c61\u4e2d\uff09\u8fdb\u884c\u7b5b\u9009\uff0c \u6240\u6709\u5bf9\u4e00\u4e2a\u5e94\u7528\u5bf9\u8c61\u6765\u8bf4\uff0c\u8fd9\u91cc\u6ca1\u6709\u4e00\u4e2a dev , staging , prod \u96c6\u7fa4\u7684\u9009\u9879\u3002\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u6709\u4e24\u4e2a\u5e94\u7528\u5bf9\u8c61\uff1a myapp-staging \u90e8\u7f72\u5230 \"staging\" \u533a\u57df myapp \u90e8\u7f72\u5230\u5176\u5b83\u533a\u57df \u5728 GKE \u4e2d\uff0c\u4f60\u53ef\u4ee5\u8f7b\u677e\u5730\u914d\u7f6e \u591a\u96c6\u7fa4 ingress \uff0c \u8be5\u5165\u53e3\u5c06\u516c\u5f00\u5728\u591a\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684\u670d\u52a1\uff0c\u5e76\u4ece\u79bb\u4f60\u6240\u5728\u4f4d\u7f6e\u6700\u8fd1\u7684\u96c6\u7fa4\u63d0\u4f9b\u670d\u52a1\u3002 1-1 \u5c40\u9650\u6027 Shipper \u4e2d\u7684\u4e3b\u8981\u7684\u5c40\u9650\u6027\u6709\uff1a Chart \u9650\u5236\uff1aChart \u5fc5\u987b\u6709\u4e00\u4e2a\u90e8\u7f72\u5bf9\u8c61\u3002 Deployment \u7684\u540d\u79f0\u5fc5\u987b\u4f7f\u7528 {{.Release.Name}} \u6a21\u677f\u5316\u3002 Deployment \u5bf9\u8c61\u5e94\u8be5\u6709 apiVersion\uff1aapps/v1 \u3002 \u57fa\u4e8e Pod \u7684\u6d41\u91cf\u5207\u6362\uff1a\u8fd9\u91cc\u6ca1\u6709\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u8def\u7531\uff0c\u4f8b\u5982\uff1a\u53d1\u9001 1% \u7684\u6d41\u91cf\u5230\u65b0\u7248\u672c\uff0c\u5b83\u57fa\u4e8e\u6b63\u5728\u8fd0\u884c\u7684 Pod \u6570\u91cf\u3002 \u5982\u679c Shipper \u4e0d\u5de5\u4f5c\u4e86\uff0c\u65b0\u7684 Pod \u5c06\u83b7\u53d6\u4e0d\u5230\u6d41\u91cf\u3002 2\u3001Istio Istio \u4e0d\u662f\u4e00\u4e2a\u90e8\u7f72\u5de5\u5177\uff0c\u800c\u662f\u4e00\u4e2a \u670d\u52a1\u7f51\u683c \u3002\u7136\u800c\uff0c\u5b83\u5f88\u4ee4\u4eba\u611f\u5174\u8da3\uff0c\u56e0\u4e3a\u5b83\u5df2\u7ecf\u53d8\u5f97\u975e\u5e38\u6d41\u884c\uff0c\u5e76\u4e14\u5141\u8bb8\u6d41\u91cf\u7ba1\u7406\uff0c\u4f8b\u5982\uff0c\u5c06\u4e00\u5b9a\u6bd4\u4f8b\u7684\u6d41\u91cf\u53d1\u9001\u5230\u4e0d\u540c\u7684\u670d\u52a1\u548c\u5176\u4ed6\u9ad8\u7ea7\u7f51\u7edc\u3002 \u5728 GKE \u4e2d\uff0c\u53ea\u9700\u5728\u96c6\u7fa4\u914d\u7f6e\u4e2d\u9009\u4e2d\u590d\u9009\u6846\u5373\u53ef\u542f\u7528 Istio \u3002\u5728\u5176\u5b83\u96c6\u7fa4\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 Helm \u624b\u52a8\u5b89\u88c5\u3002 \u6709\u4e86 Istio \uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u7f51\u5173\uff0c\u901a\u8fc7 Ingress \u7f51\u5173\u5904\u7406\u6240\u6709\u5916\u90e8\u6d41\u91cf\uff0c\u5e76\u521b\u5efa\u865a\u62df\u670d\u52a1\u6765\u7ba1\u7406\u5230\u6211\u4eec\u670d\u52a1\u7684\u8def\u7531\u3002 \u4e3a\u6b64\uff0c \u53ea\u9700\u627e\u5230 ingress \u7f51\u5173\u7684 ip \u5730\u5740 \u5e76\u4e3a\u5176\u914d\u7f6e\u901a\u914d\u7b26 DNS \u3002\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u7f51\u5173\uff0c\u901a\u8fc7 Ingress \u7f51\u5173\u8def\u7531\u6240\u6709\u5916\u90e8\u6d41\u91cf\u3002 apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: public-gateway namespace: istio-system spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*\" Isito \u4e0d\u7ba1\u7406\u5e94\u7528\u7684\u751f\u547d\u5468\u671f\uff0c\u53ea\u7ba1\u7406\u7f51\u7edc\u3002 \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u670d\u52a1\uff0c\u4e3a\u6240\u6709\u8fdb\u5165 ingress \u7f51\u5173\u7684\u8bf7\u6c42 \u5411 pull request \u6216 master \u5206\u652f\u4e2d\u90e8\u7f72\u7684\u670d\u52a1\u53d1\u9001 1% \u7684\u6d41\u91cf\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: croc-hunter-jenkinsx namespace: jx-production spec: gateways: - public-gateway.istio-system.svc.cluster.local - mesh hosts: - croc-hunter.istio.example.org http: - route: - destination: host: croc-hunter-jenkinsx.jx-production.svc.cluster.local port: number: 80 weight: 99 - destination: host: croc-hunter-jenkinsx.jx-staging.svc.cluster.local port: number: 80 weight: 1 3\u3001Flagger Flagger \u662f\u4e00\u4e2a\u7531 Weaveworks \u8d5e\u52a9\u7684\u4f7f\u7528\u4e86 Istio \u7684\u9879\u76ee\uff0c \u8be5\u9879\u76ee\u4f7f\u7528 Prometheus \u7684\u6307\u6807\u8fdb\u884c\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u53d1\u5e03\u548c\u56de\u6eda\u3002\u5b83\u8d85\u8d8a\u4e86 Isito \u63d0\u4f9b\u4e86\u57fa\u4e8e\u6307\u6807\u7684\u81ea\u52a8\u5316\u6e10\u8fdb\u5f0f\u53d1\u5e03\u548c\u56de\u6eda\u3002 Flager \u9700\u8981\u5c06 Istio \u4e0e Prometheus \u3001 Servicegraph \u548c\u67d0\u4e9b\u7cfb\u7edf\u7684\u914d\u7f6e\u4e00\u8d77\u5b89\u88c5\uff0c \u53e6\u5916\u8fd8\u8981\u5b89\u88c5 Flager \u63a7\u5236\u5668\u672c\u8eab\u3002\u5b83\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a Grfana \u9762\u677f\u6765\u76d1\u63a7\u90e8\u7f72\u8fdb\u5ea6\u3002 \u90e8\u7f72 rollout \u901a\u8fc7 Canary \u5bf9\u8c61\u5b9a\u4e49\uff0c \u5b83\u4f1a\u751f\u6210\u4e3b\u8981\u7684\u548c\u91d1\u4e1d\u96c0 Deployment \u5bf9\u8c61\u3002\u7f16\u8f91 Deployment \u65f6\uff0c\u4f8b\u5982\u8981\u4f7f\u7528\u65b0\u7684\u955c\u50cf\u7248\u672c\uff0c Flagger \u63a7\u5236\u5668\u5c06\u8d1f\u8f7d\u4ece 0% \u5207\u6362\u5230 50% \uff0c\u6bcf\u5206\u949f\u589e\u52a0 10% \uff0c\u7136\u540e\u5b83\u5c06\u5207\u6362\u5230\u65b0\u7684 deployment \u6216\u8005\u5982\u679c\u54cd\u5e94\u9519\u8bef\u548c\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u7b49\u6307\u6807\u5931\u8d25\u5219\u8fdb\u884c\u56de\u6eda\u3002 4\u3001\u6bd4\u8f83 \u6b64\u8868\u603b\u7ed3\u4e86 Shipper \u548c Flagger \u5728\u51e0\u4e2a\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u7279\u6027\u65b9\u9762\u7684\u4f18\u52bf\u548c\u52a3\u52bf\u3002 \u7efc\u4e0a\u6240\u8ff0\uff0c\u6211\u770b\u5230\u4e86 Shipper \u5728\u591a\u96c6\u7fa4\u7ba1\u7406\u548c\u7b80\u5355\u6027\u65b9\u9762\u7684\u4ef7\u503c\uff0c\u5b83\u4e0d\u9700\u8981 Kubernetes \u4ee5\u5916\u7684\u4efb\u4f55\u4e1c\u897f\uff0c\u4f46\u662f\u5b83\u6709\u4e00\u4e9b\u4e25\u91cd\u7684\u5c40\u9650\u6027\u3002","title":"L1 Kubernetes\u4e2d\u7684\u6e10\u8fdb\u5f0f\u4ea4\u4ed8:\u84dd\u7eff\u90e8\u7f72\u548c\u91d1\u4e1d\u96c0\u90e8\u7f72shipper/Istio/Flagger"},{"location":"chap7/k8s_adv54_release/#l1-kubernetes-shipper-istio-flagger","text":"\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u662f\u6301\u7eed\u4ea4\u4ed8\u7684\u4e0b\u4e00\u6b65 \uff0c \u5b83\u5c06\u65b0\u7248\u672c\u90e8\u7f72\u5230\u7528\u6237\u7684\u4e00\u4e2a\u5b50\u96c6\uff0c\u5e76\u5728\u5c06\u5176\u6eda\u52a8\u5230\u5168\u90e8\u7528\u6237\u4e4b\u524d\u5bf9\u5176\u6b63\u786e\u6027\u548c\u6027\u80fd\u8fdb\u884c\u8bc4\u4f30\uff0c \u5982\u679c\u4e0d\u5339\u914d\u67d0\u4e9b\u5173\u952e\u6307\u6807\uff0c\u5219\u8fdb\u884c\u56de\u6eda\u3002 \u8fd9\u91cc\u6709\u4e00\u4e9b\u6709\u8da3\u7684\u9879\u76ee\uff0c\u4f7f\u5f97\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u5728 Kubernetes \u4e2d\u53d8\u5f97\u66f4\u7b80\u5355\u3002\u6211\u5c06\u4f7f\u7528\u4e00\u4e2a Jenkins X \u793a\u4f8b\u9879\u76ee \u5bf9\u5b83\u4eec\u4e4b\u4e2d\u7684\u4e09\u4e2a\u8fdb\u884c\u8ba8\u8bba\uff1a Shipper \u3001 Istio \u4ee5\u53ca Flagger \u3002","title":"L1 Kubernetes \u4e2d\u7684\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u84dd\u7eff\u90e8\u7f72\u548c\u91d1\u4e1d\u96c0\u90e8\u7f72, shipper, Istio, Flagger"},{"location":"chap7/k8s_adv54_release/#1shipper","text":"shipper \u662f\u6765\u81ea booking.com \u7684\u4e00\u4e2a\u9879\u76ee\uff0c \u5b83\u5bf9 Kubernetes \u8fdb\u884c\u4e86\u6269\u5c55\uff0c\u6dfb\u52a0\u4e86\u590d\u6742\u7684\u90e8\u7f72\u7b56\u7565\u548c\u591a\u96c6\u7fa4\u7f16\u6392\uff08\u6587\u6863\uff09\u3002\u5b83\u652f\u6301\u4ece\u4e00\u4e2a\u96c6\u7fa4\u5230\u591a\u4e2a\u96c6\u7fa4\u7684\u90e8\u7f72\uff0c\u5141\u8bb8\u591a\u533a\u57df\u90e8\u7f72\u3002 Shipper \u901a\u8fc7\u4e00\u4e2a shipperctl \u547d\u4ee4\u884c\u8fdb\u884c\u5b89\u88c5\u3002\u5b83\u589e\u52a0\u4e0d\u540c\u96c6\u7fa4\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u8fdb\u884c\u7ba1\u7406\u3002\u8bf7\u6ce8\u610f\u8fd9\u4e2a\u4e0e GKE \u4e0a\u4e0b\u6587\u76f8\u5173\u7684\u95ee\u9898\u3002 Shipper \u4f7f\u7528 Helm \u5305\u6765\u90e8\u7f72\uff0c\u4f46\u662f\u5b83\u4eec\u6ca1\u6709\u968f\u7740 Helm \u4e00\u8d77\u5b89\u88c5\uff0c\u5b83\u4eec\u4e0d\u4f1a\u5728 helm list \u7684\u8f93\u51fa\u663e\u793a\u3002 \u540c\u6837\u5730\uff0c deployments \u7684\u7248\u672c\u5fc5\u987b\u662f apps/v1 \uff0c \u5426\u5219 shipper \u5c06\u4e0d\u80fd\u7f16\u8f91 deployment \u6765\u6dfb\u52a0\u6b63\u786e\u7684\u6807\u7b7e\u548c\u526f\u672c\u6570\u91cf\u3002 \u4f7f\u7528 shipper \u90e8\u7f72\u90fd\u662f\u4e0e\u4ece \u65e7\u7248\u672c(\u73b0\u6709\u7248\u672c) \u8fc7\u6e21\u5230 \u65b0\u7248\u672c(\u7ade\u4e89\u7248\u672c) \u76f8\u5173\u3002\u8fd9\u662f\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5e94\u7528\u5bf9\u8c61\u5b9e\u73b0\u7684\uff0c \u5b83\u5b9a\u4e49\u4e86\u90e8\u7f72\u9700\u8981\u901a\u8fc7\u7684\u591a\u4e2a\u9636\u6bb5\u3002\u4f8b\u5982\u4e0b\u9762 3 \u4e2a\u6b65\u9aa4\u8fc7\u7a0b\uff1a Staging \uff1a\u90e8\u7f72\u65b0\u7248\u672c\u5230\u4e00\u4e2a pod \uff0c\u6ca1\u6709\u6d41\u91cf 50 / 50 \uff1a\u90e8\u7f72\u65b0\u7248\u672c\u5230 50% \u7684 pods \uff0c 50% \u7684\u6d41\u91cf Full on \uff1a\u90e8\u7f72\u65b0\u7248\u672c\u5230\u5168\u90e8\u7684 pods \uff0c\u5168\u90e8\u7684\u6d41\u91cf strategy: steps: - name: staging capacity: contender: 1 incumbent: 100 traffic: contender: 0 incumbent: 100 - name: 50/50 capacity: contender: 50 incumbent: 50 traffic: contender: 50 incumbent: 50 - name: full on capacity: contender: 100 incumbent: 0 traffic: contender: 100 incumbent: 0 \u5982\u679c\u53d1\u5e03\u7684\u67d0\u4e2a\u6b65\u9aa4\u6ca1\u6709\u5c06\u6d41\u91cf\u53d1\u9001\u5230 pods \uff0c \u5219\u53ef\u4ee5\u4f7f\u7528 kubectl port-forward \u8bbf\u95ee\u5b83\u4eec\uff0c\u5982\uff1a kubectl port-forward mypod 8080:8080 \uff0c \u8fd9\u5bf9\u4e8e\u5728\u7528\u6237\u770b\u5230\u65b0\u7248\u672c\u4e4b\u524d\u8fdb\u884c\u6d4b\u8bd5\u975e\u5e38\u6709\u7528\u3002 Shipper \u652f\u6301\u591a\u96c6\u7fa4\u7684\u6982\u5ff5\uff0c\u4f46\u662f\u4ee5\u76f8\u540c\u7684\u65b9\u5f0f\u5bf9\u5f85\u6240\u6709\u96c6\u7fa4\uff0c\u4ec5\u4f7f\u7528\u533a\u57df\u5e76\u901a\u8fc7 capabilities \uff08\u914d\u7f6e\u5728\u96c6\u7fa4\u5bf9\u8c61\u4e2d\uff09\u8fdb\u884c\u7b5b\u9009\uff0c \u6240\u6709\u5bf9\u4e00\u4e2a\u5e94\u7528\u5bf9\u8c61\u6765\u8bf4\uff0c\u8fd9\u91cc\u6ca1\u6709\u4e00\u4e2a dev , staging , prod \u96c6\u7fa4\u7684\u9009\u9879\u3002\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u6709\u4e24\u4e2a\u5e94\u7528\u5bf9\u8c61\uff1a myapp-staging \u90e8\u7f72\u5230 \"staging\" \u533a\u57df myapp \u90e8\u7f72\u5230\u5176\u5b83\u533a\u57df \u5728 GKE \u4e2d\uff0c\u4f60\u53ef\u4ee5\u8f7b\u677e\u5730\u914d\u7f6e \u591a\u96c6\u7fa4 ingress \uff0c \u8be5\u5165\u53e3\u5c06\u516c\u5f00\u5728\u591a\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684\u670d\u52a1\uff0c\u5e76\u4ece\u79bb\u4f60\u6240\u5728\u4f4d\u7f6e\u6700\u8fd1\u7684\u96c6\u7fa4\u63d0\u4f9b\u670d\u52a1\u3002","title":"1\u3001Shipper"},{"location":"chap7/k8s_adv54_release/#1-1","text":"Shipper \u4e2d\u7684\u4e3b\u8981\u7684\u5c40\u9650\u6027\u6709\uff1a Chart \u9650\u5236\uff1aChart \u5fc5\u987b\u6709\u4e00\u4e2a\u90e8\u7f72\u5bf9\u8c61\u3002 Deployment \u7684\u540d\u79f0\u5fc5\u987b\u4f7f\u7528 {{.Release.Name}} \u6a21\u677f\u5316\u3002 Deployment \u5bf9\u8c61\u5e94\u8be5\u6709 apiVersion\uff1aapps/v1 \u3002 \u57fa\u4e8e Pod \u7684\u6d41\u91cf\u5207\u6362\uff1a\u8fd9\u91cc\u6ca1\u6709\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u8def\u7531\uff0c\u4f8b\u5982\uff1a\u53d1\u9001 1% \u7684\u6d41\u91cf\u5230\u65b0\u7248\u672c\uff0c\u5b83\u57fa\u4e8e\u6b63\u5728\u8fd0\u884c\u7684 Pod \u6570\u91cf\u3002 \u5982\u679c Shipper \u4e0d\u5de5\u4f5c\u4e86\uff0c\u65b0\u7684 Pod \u5c06\u83b7\u53d6\u4e0d\u5230\u6d41\u91cf\u3002","title":"1-1 \u5c40\u9650\u6027"},{"location":"chap7/k8s_adv54_release/#2istio","text":"Istio \u4e0d\u662f\u4e00\u4e2a\u90e8\u7f72\u5de5\u5177\uff0c\u800c\u662f\u4e00\u4e2a \u670d\u52a1\u7f51\u683c \u3002\u7136\u800c\uff0c\u5b83\u5f88\u4ee4\u4eba\u611f\u5174\u8da3\uff0c\u56e0\u4e3a\u5b83\u5df2\u7ecf\u53d8\u5f97\u975e\u5e38\u6d41\u884c\uff0c\u5e76\u4e14\u5141\u8bb8\u6d41\u91cf\u7ba1\u7406\uff0c\u4f8b\u5982\uff0c\u5c06\u4e00\u5b9a\u6bd4\u4f8b\u7684\u6d41\u91cf\u53d1\u9001\u5230\u4e0d\u540c\u7684\u670d\u52a1\u548c\u5176\u4ed6\u9ad8\u7ea7\u7f51\u7edc\u3002 \u5728 GKE \u4e2d\uff0c\u53ea\u9700\u5728\u96c6\u7fa4\u914d\u7f6e\u4e2d\u9009\u4e2d\u590d\u9009\u6846\u5373\u53ef\u542f\u7528 Istio \u3002\u5728\u5176\u5b83\u96c6\u7fa4\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 Helm \u624b\u52a8\u5b89\u88c5\u3002 \u6709\u4e86 Istio \uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u7f51\u5173\uff0c\u901a\u8fc7 Ingress \u7f51\u5173\u5904\u7406\u6240\u6709\u5916\u90e8\u6d41\u91cf\uff0c\u5e76\u521b\u5efa\u865a\u62df\u670d\u52a1\u6765\u7ba1\u7406\u5230\u6211\u4eec\u670d\u52a1\u7684\u8def\u7531\u3002 \u4e3a\u6b64\uff0c \u53ea\u9700\u627e\u5230 ingress \u7f51\u5173\u7684 ip \u5730\u5740 \u5e76\u4e3a\u5176\u914d\u7f6e\u901a\u914d\u7b26 DNS \u3002\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u7f51\u5173\uff0c\u901a\u8fc7 Ingress \u7f51\u5173\u8def\u7531\u6240\u6709\u5916\u90e8\u6d41\u91cf\u3002 apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: public-gateway namespace: istio-system spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*\" Isito \u4e0d\u7ba1\u7406\u5e94\u7528\u7684\u751f\u547d\u5468\u671f\uff0c\u53ea\u7ba1\u7406\u7f51\u7edc\u3002 \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u670d\u52a1\uff0c\u4e3a\u6240\u6709\u8fdb\u5165 ingress \u7f51\u5173\u7684\u8bf7\u6c42 \u5411 pull request \u6216 master \u5206\u652f\u4e2d\u90e8\u7f72\u7684\u670d\u52a1\u53d1\u9001 1% \u7684\u6d41\u91cf\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: croc-hunter-jenkinsx namespace: jx-production spec: gateways: - public-gateway.istio-system.svc.cluster.local - mesh hosts: - croc-hunter.istio.example.org http: - route: - destination: host: croc-hunter-jenkinsx.jx-production.svc.cluster.local port: number: 80 weight: 99 - destination: host: croc-hunter-jenkinsx.jx-staging.svc.cluster.local port: number: 80 weight: 1","title":"2\u3001Istio"},{"location":"chap7/k8s_adv54_release/#3flagger","text":"Flagger \u662f\u4e00\u4e2a\u7531 Weaveworks \u8d5e\u52a9\u7684\u4f7f\u7528\u4e86 Istio \u7684\u9879\u76ee\uff0c \u8be5\u9879\u76ee\u4f7f\u7528 Prometheus \u7684\u6307\u6807\u8fdb\u884c\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u53d1\u5e03\u548c\u56de\u6eda\u3002\u5b83\u8d85\u8d8a\u4e86 Isito \u63d0\u4f9b\u4e86\u57fa\u4e8e\u6307\u6807\u7684\u81ea\u52a8\u5316\u6e10\u8fdb\u5f0f\u53d1\u5e03\u548c\u56de\u6eda\u3002 Flager \u9700\u8981\u5c06 Istio \u4e0e Prometheus \u3001 Servicegraph \u548c\u67d0\u4e9b\u7cfb\u7edf\u7684\u914d\u7f6e\u4e00\u8d77\u5b89\u88c5\uff0c \u53e6\u5916\u8fd8\u8981\u5b89\u88c5 Flager \u63a7\u5236\u5668\u672c\u8eab\u3002\u5b83\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a Grfana \u9762\u677f\u6765\u76d1\u63a7\u90e8\u7f72\u8fdb\u5ea6\u3002 \u90e8\u7f72 rollout \u901a\u8fc7 Canary \u5bf9\u8c61\u5b9a\u4e49\uff0c \u5b83\u4f1a\u751f\u6210\u4e3b\u8981\u7684\u548c\u91d1\u4e1d\u96c0 Deployment \u5bf9\u8c61\u3002\u7f16\u8f91 Deployment \u65f6\uff0c\u4f8b\u5982\u8981\u4f7f\u7528\u65b0\u7684\u955c\u50cf\u7248\u672c\uff0c Flagger \u63a7\u5236\u5668\u5c06\u8d1f\u8f7d\u4ece 0% \u5207\u6362\u5230 50% \uff0c\u6bcf\u5206\u949f\u589e\u52a0 10% \uff0c\u7136\u540e\u5b83\u5c06\u5207\u6362\u5230\u65b0\u7684 deployment \u6216\u8005\u5982\u679c\u54cd\u5e94\u9519\u8bef\u548c\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u7b49\u6307\u6807\u5931\u8d25\u5219\u8fdb\u884c\u56de\u6eda\u3002","title":"3\u3001Flagger"},{"location":"chap7/k8s_adv54_release/#4","text":"\u6b64\u8868\u603b\u7ed3\u4e86 Shipper \u548c Flagger \u5728\u51e0\u4e2a\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u7279\u6027\u65b9\u9762\u7684\u4f18\u52bf\u548c\u52a3\u52bf\u3002 \u7efc\u4e0a\u6240\u8ff0\uff0c\u6211\u770b\u5230\u4e86 Shipper \u5728\u591a\u96c6\u7fa4\u7ba1\u7406\u548c\u7b80\u5355\u6027\u65b9\u9762\u7684\u4ef7\u503c\uff0c\u5b83\u4e0d\u9700\u8981 Kubernetes \u4ee5\u5916\u7684\u4efb\u4f55\u4e1c\u897f\uff0c\u4f46\u662f\u5b83\u6709\u4e00\u4e9b\u4e25\u91cd\u7684\u5c40\u9650\u6027\u3002","title":"4\u3001\u6bd4\u8f83"},{"location":"chap7/k8s_adv56_jenkinsX/","text":"L2 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8 Jenkins X \u4e2d\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u84dd\u7eff\u8272\u90e8\u7f72\u7684\u4e09\u79cd\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u65b9\u6848\u3002 Shipper \u4e3a Jenkins X \u6784\u5efa\u7684 Helm \u56fe\u8868\u542f\u7528\u4e86\u84dd\u7eff\u90e8\u7f72\u548c\u591a\u96c6\u7fa4\u90e8\u7f72\uff0c\u4f46\u662f\u5bf9\u56fe\u8868\u7684\u5185\u5bb9\u6709\u9650\u5236\u3002\u4f60\u53ef\u4ee5\u5728 staging \u548c\u751f\u4ea7\u73af\u5883\u4e4b\u95f4\u505a\u84dd\u7eff\u90e8\u7f72\u3002 Istio \u5141\u8bb8\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u670d\u52a1\u5c06\u4e00\u5b9a\u6bd4\u4f8b\u7684\u6d41\u91cf\u53d1\u9001\u5230 staging \u6216\u9884\u89c8\u73af\u5883\u3002 Flagger \u6784\u5efa\u5728 Istio \u4e4b\u4e0a\uff0c\u5e76\u6dfb\u52a0\u4e86\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0c\u53ef\u4ee5\u6839\u636e\u6307\u6807\u81ea\u52a8\u8fdb\u884c\u6eda\u52a8\u90e8\u7f72\u548c\u56de\u6eda\u3002 Jenkins X \u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a Canary \u5bf9\u8c61\u81ea\u52a8\u542f\u7528\u91d1\u4e1d\u96c0\u529f\u80fd\uff0c\u4ece\u800c\u5b9e\u73b0\u4f18\u96c5\u7684\u6eda\u52a8\u90e8\u7f72\uff0c\u4ee5\u5347\u7ea7\u5230\u751f\u4ea7\u73af\u5883\u3002 \u8fd9\u91cc\u53ef\u4ee5\u67e5\u770b Shipper\u3001Isito \u548c Flager \u7684\u793a\u4f8b\u4ee3\u7801\u3002 1\u3001Shipper \u7531\u4e8e Shipper \u5bf9\u521b\u5efa\u7684 Helm Chart \u6709\u591a\u4e2a\u9650\u5236\uff0c\u56e0\u6b64\u6211\u5fc5\u987b\u5bf9\u5e94\u7528\u505a\u4e00\u4e9b\u66f4\u6539\u3002\u800c\u4e14 Jenkins X \u53ea\u4ece master \u5206\u652f\u6784\u5efa Helm \u5305\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u80fd\u505a PRs \u7684\u6eda\u52a8\u90e8\u7f72\uff0c\u53ea\u80fd\u5bf9 master \u5206\u652f\u505a\u6eda\u52a8\u90e8\u7f72\u3002 \u5e94\u7528\u6807\u7b7e\u4e0d\u80fd\u5305\u542b\u53d1\u5e03\u540d\u79f0\uff0c\u4f8b\u5982\uff1a app: {{ template \u201cfullname\u201d . }} \u4e0d\u8d77\u4f5c\u7528\uff0c \u9700\u8981\u4e00\u4e9b\u7c7b\u4f3c\u8fd9\u6837\u7684\u6807\u7b7e\uff1a app: {{ .Values.appLabel }} \u3002 \u7531 Jenkins X \u751f\u6210\u7684\u56fe\u8868\u5bfc\u81f4\u5e94\u7528\u6eda\u52a8\u5931\u8d25\uff0c\u5f52\u56e0\u4e8e\u751f\u6210\u7684 templates/release.yaml \u53ef\u80fd\u548c jenkins.io/releases CRD \u51b2\u7a81\u3002 Chart croc-hunter-jenkinsx-0.0.58 failed to render: could not decode manifest: no kind \"Release\" is registered for version \"jenkins.io/v1\" \u6211\u4eec\u53ea\u9700\u8981\u5c06 jx step changelog \u66f4\u6539\u4e3a jx step changelog -generate-yaml =false \uff0c\u8fd9\u6837\u5c31\u4e0d\u4f1a\u751f\u6210\u6587\u4ef6\u3002 \u5728\u591a\u96c6\u7fa4\u73af\u5883\uff0c\u9700\u8981\u5728 shipper \u5e94\u7528 yaml \u4e2d\u4e3a chartmuseum \u548c docker registry \u4f7f\u7528\u516c\u5f00\u7684 url \uff0c\u4ee5\u4fbf\u5176\u4ed6\u96c6\u7fa4\u53ef\u4ee5\u53d1\u73b0\u7ba1\u7406\u96c6\u7fa4\u670d\u52a1\u6765\u4e0b\u8f7d\u56fe\u8868\u3002 2\u3001Istio \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u8fd9\u4e2a\u865a\u62df\u670d\u52a1\uff0c \u5c06\u6240\u6709\u8fdb\u5165 Ingress \u7f51\u5173\u7684\u4e3b\u673a\u4e3a croc-hunter.istio.example.org \u7684\u8bf7\u6c42\u7684 1% \u7684\u6d41\u91cf\u53d1\u9001\u5230 Jenkins X \u9884\u89c8\u73af\u5883( PR \u53f7\u4e3a 35 )\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: croc-hunter-jenkinsx namespace: jx-production spec: gateways: - public-gateway.istio-system.svc.cluster.local - mesh hosts: - croc-hunter.istio.example.com http: - route: - destination: host: croc-hunter-jenkinsx.jx-production.svc.cluster.local port: number: 80 weight: 99 - destination: host: croc-hunter-jenkinsx.jx-carlossg-croc-hunter-jenkinsx-serverless-pr-35.svc.cluster.local port: number: 80 3\u3001Flagger \u6211\u4eec\u53ef\u4ee5\u4e3a Jenkins X \u5728 jx-production \u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u7684\u56fe\u8868\u521b\u5efa\u4e00\u4e2a Canary \u5bf9\u8c61\uff0c \u6240\u6709\u65b0\u7684 Jenkins X \u5bf9 jx-production \u7684 promotions \u6bcf\u6b21\u5c06\u81ea\u52a8\u6eda\u52a8 10% \uff0c \u5982\u679c\u51fa\u73b0\u4efb\u4f55\u5931\u8d25\uff0c\u5c06\u81ea\u52a8\u56de\u6eda\u3002 apiVersion: flagger.app/v1alpha2 kind: Canary metadata: # canary name must match deployment name name: jx-production-croc-hunter-jenkinsx namespace: jx-production spec: # deployment reference targetRef: apiVersion: apps/v1 kind: Deployment name: jx-production-croc-hunter-jenkinsx # HPA reference (optional) # autoscalerRef: # apiVersion: autoscaling/v2beta1 # kind: HorizontalPodAutoscaler # name: jx-production-croc-hunter-jenkinsx # the maximum time in seconds for the canary deployment # to make progress before it is rollback (default 600s) progressDeadlineSeconds: 60 service: # container port port: 8080 # Istio gateways (optional) gateways: - public-gateway.istio-system.svc.cluster.local # Istio virtual service host names (optional) hosts: - croc-hunter.istio.example.com canaryAnalysis: # schedule interval (default 60s) interval: 15s # max number of failed metric checks before rollback threshold: 5 # max traffic percentage routed to canary # percentage (0-100) maxWeight: 50 # canary increment step # percentage (0-100) stepWeight: 10 metrics: - name: istio_requests_total # minimum req success rate (non 5xx responses) # percentage (0-100) threshold: 99 interval: 1m - name: istio_request_duration_seconds_bucket # maximum req duration P99 # milliseconds threshold: 500 interval: 30s","title":"L2 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8"},{"location":"chap7/k8s_adv56_jenkinsX/#l2-jenkins-x","text":"Jenkins X \u4e2d\u91d1\u4e1d\u96c0\u90e8\u7f72\u548c\u84dd\u7eff\u8272\u90e8\u7f72\u7684\u4e09\u79cd\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u65b9\u6848\u3002 Shipper \u4e3a Jenkins X \u6784\u5efa\u7684 Helm \u56fe\u8868\u542f\u7528\u4e86\u84dd\u7eff\u90e8\u7f72\u548c\u591a\u96c6\u7fa4\u90e8\u7f72\uff0c\u4f46\u662f\u5bf9\u56fe\u8868\u7684\u5185\u5bb9\u6709\u9650\u5236\u3002\u4f60\u53ef\u4ee5\u5728 staging \u548c\u751f\u4ea7\u73af\u5883\u4e4b\u95f4\u505a\u84dd\u7eff\u90e8\u7f72\u3002 Istio \u5141\u8bb8\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u670d\u52a1\u5c06\u4e00\u5b9a\u6bd4\u4f8b\u7684\u6d41\u91cf\u53d1\u9001\u5230 staging \u6216\u9884\u89c8\u73af\u5883\u3002 Flagger \u6784\u5efa\u5728 Istio \u4e4b\u4e0a\uff0c\u5e76\u6dfb\u52a0\u4e86\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0c\u53ef\u4ee5\u6839\u636e\u6307\u6807\u81ea\u52a8\u8fdb\u884c\u6eda\u52a8\u90e8\u7f72\u548c\u56de\u6eda\u3002 Jenkins X \u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a Canary \u5bf9\u8c61\u81ea\u52a8\u542f\u7528\u91d1\u4e1d\u96c0\u529f\u80fd\uff0c\u4ece\u800c\u5b9e\u73b0\u4f18\u96c5\u7684\u6eda\u52a8\u90e8\u7f72\uff0c\u4ee5\u5347\u7ea7\u5230\u751f\u4ea7\u73af\u5883\u3002 \u8fd9\u91cc\u53ef\u4ee5\u67e5\u770b Shipper\u3001Isito \u548c Flager \u7684\u793a\u4f8b\u4ee3\u7801\u3002","title":"L2 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8"},{"location":"chap7/k8s_adv56_jenkinsX/#1shipper","text":"\u7531\u4e8e Shipper \u5bf9\u521b\u5efa\u7684 Helm Chart \u6709\u591a\u4e2a\u9650\u5236\uff0c\u56e0\u6b64\u6211\u5fc5\u987b\u5bf9\u5e94\u7528\u505a\u4e00\u4e9b\u66f4\u6539\u3002\u800c\u4e14 Jenkins X \u53ea\u4ece master \u5206\u652f\u6784\u5efa Helm \u5305\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u80fd\u505a PRs \u7684\u6eda\u52a8\u90e8\u7f72\uff0c\u53ea\u80fd\u5bf9 master \u5206\u652f\u505a\u6eda\u52a8\u90e8\u7f72\u3002 \u5e94\u7528\u6807\u7b7e\u4e0d\u80fd\u5305\u542b\u53d1\u5e03\u540d\u79f0\uff0c\u4f8b\u5982\uff1a app: {{ template \u201cfullname\u201d . }} \u4e0d\u8d77\u4f5c\u7528\uff0c \u9700\u8981\u4e00\u4e9b\u7c7b\u4f3c\u8fd9\u6837\u7684\u6807\u7b7e\uff1a app: {{ .Values.appLabel }} \u3002 \u7531 Jenkins X \u751f\u6210\u7684\u56fe\u8868\u5bfc\u81f4\u5e94\u7528\u6eda\u52a8\u5931\u8d25\uff0c\u5f52\u56e0\u4e8e\u751f\u6210\u7684 templates/release.yaml \u53ef\u80fd\u548c jenkins.io/releases CRD \u51b2\u7a81\u3002 Chart croc-hunter-jenkinsx-0.0.58 failed to render: could not decode manifest: no kind \"Release\" is registered for version \"jenkins.io/v1\" \u6211\u4eec\u53ea\u9700\u8981\u5c06 jx step changelog \u66f4\u6539\u4e3a jx step changelog -generate-yaml =false \uff0c\u8fd9\u6837\u5c31\u4e0d\u4f1a\u751f\u6210\u6587\u4ef6\u3002 \u5728\u591a\u96c6\u7fa4\u73af\u5883\uff0c\u9700\u8981\u5728 shipper \u5e94\u7528 yaml \u4e2d\u4e3a chartmuseum \u548c docker registry \u4f7f\u7528\u516c\u5f00\u7684 url \uff0c\u4ee5\u4fbf\u5176\u4ed6\u96c6\u7fa4\u53ef\u4ee5\u53d1\u73b0\u7ba1\u7406\u96c6\u7fa4\u670d\u52a1\u6765\u4e0b\u8f7d\u56fe\u8868\u3002","title":"1\u3001Shipper"},{"location":"chap7/k8s_adv56_jenkinsX/#2istio","text":"\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u8fd9\u4e2a\u865a\u62df\u670d\u52a1\uff0c \u5c06\u6240\u6709\u8fdb\u5165 Ingress \u7f51\u5173\u7684\u4e3b\u673a\u4e3a croc-hunter.istio.example.org \u7684\u8bf7\u6c42\u7684 1% \u7684\u6d41\u91cf\u53d1\u9001\u5230 Jenkins X \u9884\u89c8\u73af\u5883( PR \u53f7\u4e3a 35 )\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: croc-hunter-jenkinsx namespace: jx-production spec: gateways: - public-gateway.istio-system.svc.cluster.local - mesh hosts: - croc-hunter.istio.example.com http: - route: - destination: host: croc-hunter-jenkinsx.jx-production.svc.cluster.local port: number: 80 weight: 99 - destination: host: croc-hunter-jenkinsx.jx-carlossg-croc-hunter-jenkinsx-serverless-pr-35.svc.cluster.local port: number: 80","title":"2\u3001Istio"},{"location":"chap7/k8s_adv56_jenkinsX/#3flagger","text":"\u6211\u4eec\u53ef\u4ee5\u4e3a Jenkins X \u5728 jx-production \u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u7684\u56fe\u8868\u521b\u5efa\u4e00\u4e2a Canary \u5bf9\u8c61\uff0c \u6240\u6709\u65b0\u7684 Jenkins X \u5bf9 jx-production \u7684 promotions \u6bcf\u6b21\u5c06\u81ea\u52a8\u6eda\u52a8 10% \uff0c \u5982\u679c\u51fa\u73b0\u4efb\u4f55\u5931\u8d25\uff0c\u5c06\u81ea\u52a8\u56de\u6eda\u3002 apiVersion: flagger.app/v1alpha2 kind: Canary metadata: # canary name must match deployment name name: jx-production-croc-hunter-jenkinsx namespace: jx-production spec: # deployment reference targetRef: apiVersion: apps/v1 kind: Deployment name: jx-production-croc-hunter-jenkinsx # HPA reference (optional) # autoscalerRef: # apiVersion: autoscaling/v2beta1 # kind: HorizontalPodAutoscaler # name: jx-production-croc-hunter-jenkinsx # the maximum time in seconds for the canary deployment # to make progress before it is rollback (default 600s) progressDeadlineSeconds: 60 service: # container port port: 8080 # Istio gateways (optional) gateways: - public-gateway.istio-system.svc.cluster.local # Istio virtual service host names (optional) hosts: - croc-hunter.istio.example.com canaryAnalysis: # schedule interval (default 60s) interval: 15s # max number of failed metric checks before rollback threshold: 5 # max traffic percentage routed to canary # percentage (0-100) maxWeight: 50 # canary increment step # percentage (0-100) stepWeight: 10 metrics: - name: istio_requests_total # minimum req success rate (non 5xx responses) # percentage (0-100) threshold: 99 interval: 1m - name: istio_request_duration_seconds_bucket # maximum req duration P99 # milliseconds threshold: 500 interval: 30s","title":"3\u3001Flagger"},{"location":"chap7/k8s_adv57_Auto_Canary/","text":"L3 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u90e8\u7f72 \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u88ab Netflix\uff0c Facebook \u4ee5\u53ca\u5176\u5b83\u516c\u53f8\u4f7f\u7528\u7528\u6765\u51cf\u8f7b\u90e8\u7f72\u7684\u98ce\u9669\u3002 \u4f46\u662f\u73b0\u5728\u4f60\u53ef\u4ee5\u5728\u4f7f\u7528 Jenkins X \u65f6\u91c7\u7528\u5b83\u3002 \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u662f\u6301\u7eed\u4ea4\u4ed8\u7684\u4e0b\u4e00\u6b65\uff0c\u5b83\u5c06\u65b0\u7248\u672c\u90e8\u7f72\u5230\u7528\u6237\u7684\u4e00\u4e2a\u5b50\u96c6\uff0c\u5e76\u5728\u5c06\u5176\u6eda\u52a8\u5230\u5168\u90e8\u7528\u6237\u4e4b\u524d\u5bf9\u5176\u6b63\u786e\u6027\u548c\u6027\u80fd\u8fdb\u884c\u8bc4\u4f30\uff0c\u5982\u679c\u4e0d\u5339\u914d\u67d0\u4e9b\u5173\u952e\u6307\u6807\uff0c\u5219\u8fdb\u884c\u56de\u6eda\u3002 \u5c24\u5176\u662f\uff0c\u6211\u4eec\u805a\u7126\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u5e76\u8ba9\u5b83\u5728\u4f60\u7684 Jenkins X \u5e94\u7528\u4e2d\u53d8\u5f97\u6613\u4e8e\u91c7\u7528\u3002 \u91d1\u4e1d\u96c0\u53d1\u5e03\u5305\u62ec\u5411\u5e94\u7528\u7a0b\u5e8f\u7684\u65b0\u7248\u672c\u53d1\u9001\u4e00\u5c0f\u90e8\u5206\u6d41\u91cf\uff0c\u5e76\u5728\u5411\u5176\u4ed6\u7528\u6237\u53d1\u5e03\u4e4b\u524d\u9a8c\u8bc1\u8fd9\u91cc\u6ca1\u6709\u9519\u8bef \u3002 Facebook \u5c31\u662f\u8fd9\u6837\u505a\u7684\uff0c\u9996\u5148\u5411\u5185\u90e8\u5458\u5de5\u63d0\u4f9b\u65b0\u7248\u672c\uff0c\u7136\u540e\u662f\u4e00\u5c0f\u90e8\u5206\u7528\u6237\uff0c\u7136\u540e\u662f\u5176\u4ed6\u6240\u6709\u7528\u6237\uff0c\u4f46\u662f\u4f60\u8981\u91c7\u7528\u5b83\u5e76\u4e0d\u9700\u8981\u6210\u4e3a Facebook \uff01 \u4f60\u53ef\u4ee5\u5728 Martin Fowler \u7684\u7f51\u7ad9\u9605\u8bfb\u66f4\u591a\u4e0e\u91d1\u4e1d\u96c0\u53d1\u5e03\u76f8\u5173\u4fe1\u606f\u3002 1\u3001Jenkins X \u5982\u679c\u5728 Jenkins X \u4e2d\u4f60\u5df2\u7ecf\u6709\u4e00\u4e2a\u5e94\u7528\uff0c\u90a3\u4e48\u4f60\u77e5\u9053\u7684\u4f60\u53ef\u4ee5 \u901a\u8fc7 jx promote myapp --version 1.0 --env production \u547d\u4ee4 promote \u5b83\u5230\"\u751f\u4ea7\"\u73af\u5883\u3002 \u4f46\u662f\uff0c\u5728\u68c0\u67e5\u65b0\u7248\u672c\u662f\u5426\u5931\u8d25\u7684\u540c\u65f6\uff0c\u5b83\u4e5f\u53ef\u4ee5\u81ea\u52a8\u5e76\u9010\u6b65\u5730\u5411\u4e00\u5b9a\u6bd4\u4f8b\u7684\u7528\u6237\u63a8\u51fa\u3002 \u5982\u679c\u53d1\u751f\u5931\u8d25\uff0c\u5e94\u7528\u7a0b\u5e8f\u5c06\u81ea\u52a8\u56de\u6eda\u3002 \u6574\u4e2a\u8fc7\u7a0b\u4e2d\u5b8c\u5168\u6ca1\u6709\u4eba\u4e3a\u5e72\u9884\u3002 \u6ce8\u610f\uff1a\u8fd9\u4e2a\u65b0\u529f\u80fd\u662f\u975e\u5e38\u65b0\u7684\uff0c\u5728\u5c06\u6765\u8fd9\u4e9b\u6b65\u9aa4\u5c06\u4e0d\u518d\u9700\u8981\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e5f\u5c06\u7531 Jenkins X \u81ea\u52a8\u5316\u4e86\u3002 1-1 \u4f5c\u4e3a\u7b2c\u4e00\u6b65\uff0c\u4e09\u4e2a Jenkins X \u63d2\u4ef6\u9700\u8981\u88ab\u5b89\u88c5 \uff1a Istio : \u4e00\u79cd\u670d\u52a1\u7f51\u683c\u5bb9\u8bb8\u6211\u4eec\u7ba1\u7406\u6211\u4eec\u670d\u52a1\u7684\u6d41\u91cf\u3002 Prometheus \uff1a Kubernetes \u4e2d\u6700\u6d41\u884c\u7684\u76d1\u63a7\u7cfb\u7edf\u3002 Flagger \uff1a\u4e00\u4e2a\u4f7f\u7528 Istio \u7684\u9879\u76ee\uff0c\u8be5\u9879\u76ee\u4f7f\u7528 Prometheus \u7684\u6307\u6807\u81ea\u52a8\u5316\u8fdb\u884c\u91d1\u4e1d\u96c0\u53d1\u5e03\u548c\u56de\u6eda\u3002 \u63d2\u4ef6\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5b89\u88c5\uff08\u4f7f\u7528\u4e00\u4e2a\u6700\u8fd1\u7248\u672c\u7684 jx CLI \uff09\uff1a jx create addon istio jx create addon prometheus jx create addon flagger \u8fd9\u5c06\u5728 jx-production \u547d\u540d\u7a7a\u95f4\u542f\u52a8 Istio \u6765\u8fdb\u884c\u6307\u6807\u6536\u96c6\u3002 \u73b0\u5728\u83b7\u53d6 Istio ingress \u7684 IP \uff0c\u5e76\u5c06\u4e00\u4e2a\u901a\u914d\u7b26\u57df\u540d\uff08\u5982\uff1a *.example.com \uff09\u6307\u5411\u5b83\uff0c\u4ee5\u4fbf\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5b83\u6839\u636e\u4e3b\u673a\u540d\u8def\u7531\u591a\u4e2a\u670d\u52a1\u3002 Istio ingress \u63d0\u4f9b\u4e86\u91d1\u4e1d\u96c0\u53d1\u5e03\u9700\u8981\u7684\u8def\u7531\u80fd\u529b\uff08\u6d41\u91cf\u8f6c\u79fb\uff09\uff0c\u4f20\u7edf\u7684 Kubernetes ingress \u5bf9\u8c61\u4e0d\u652f\u6301\u8be5\u529f\u80fd\u3002 \u96c6\u7fa4\u88ab\u914d\u7f6e\u540e\uff0c\u662f\u65f6\u5019\u914d\u7f6e\u6211\u4eec\u7684\u5e94\u7528\u4e86\u3002 \u5728 charts/myapp/templates \u76ee\u5f55\u4e0b\u5411\u4f60\u7684 helm chart \u6dfb\u52a0\u4e00\u4e2a canary.yaml \u3002 \u7136\u540e\u5f80 charts/myapp/values.yaml \u8ffd\u52a0\u5982\u4e0b\u5185\u5bb9\uff0c\u5c06 myapp.example.com \u4fee\u6539\u4e3a\u4f60\u7684\u4e3b\u673a\u540d\u6216\u57df\u540d\uff1a \u4e0d\u4e45\uff0c\u5f53\u4f60\u4ece Jenkins X \u5feb\u901f\u5f00\u59cb\u521b\u5efa\u4f60\u7684\u5e94\u7528\uff0c\u5c06\u4e0d\u518d\u9700\u8981\u4fee\u6539 canary.yaml \u548c values.yaml \u8fd9\u4e24\u4e2a\u6587\u4ef6\uff0c\u56e0\u4e3a\u5b83\u4eec\u9ed8\u8ba4\u542f\u7528\u91d1\u4e1d\u96c0\u90e8\u7f72\u3002 \u5c31\u8fd9\u6837\uff01\u73b0\u5728\u5f53\u4f7f\u7528 jx promote myapp --version 1.0 --env production \u5c06\u4f60\u7684\u5e94\u7528 promote \u5230\u751f\u4ea7\u73af\u5883\uff0c\u5b83\u5c06\u6267\u884c\u4e00\u6b21\u91d1\u4e1d\u96c0\u90e8\u7f72\u3002 \u8bf7\u6ce8\u610f\uff0c\u7b2c\u4e00\u6b21\u88ab promote \u65f6\uff0c\u5b83\u4e0d\u4f1a\u6267\u884c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0c\u56e0\u4e3a\u5b83\u9700\u8981\u4e0e\u4ee5\u524d\u7684\u7248\u672c\u6570\u636e\u8fdb\u884c\u6bd4\u8f83\uff0c\u4f46\u4ece\u7b2c\u4e8c\u6b21 promotion \u5f00\u59cb\uff0c\u5b83\u5c06\u8d77\u4f5c\u7528\u3002 \u6839\u636e\u4e0a\u9762 values.yaml \u6587\u4ef6\u4e2d\u7684\u914d\u7f6e\uff0c\u5b83\u770b\u8d77\u6765\u50cf\uff1a \u7b2c 1 \u5206\u949f\uff1a\u5c06 10% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u7b2c 2 \u5206\u949f\uff1a\u5c06 20% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u7b2c 3 \u5206\u949f\uff1a\u5c06 30% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u7b2c 4 \u5206\u949f\uff1a\u5c06 40% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u7b2c 5 \u5206\u949f\uff1a\u5c06 100% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u5982\u679c\u6211\u4eec\u914d\u7f6e\u7684\u6307\u6807\uff08\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u8d85\u8fc7 500 \u6beb\u79d2\u6216\u8d85\u8fc7 1% \u7684\u54cd\u5e94\u8fd4\u56de 500 \u9519\u8bef\uff09\u5931\u8d25\uff0c Flagger \u5c06\u6ce8\u610f\u5230\u5931\u8d25\uff0c\u5e76\u4e14\u5982\u679c\u91cd\u590d 5 \u6b21\uff0c\u5b83\u5c06\u56de\u6eda\u8fd9\u6b21\u53d1\u5e03\uff0c\u5c06 100% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65e7\u7248\u672c\u3002 \u83b7\u5f97\u91d1\u4e1d\u96c0\u4e8b\u4ef6\u8f93\u51fa\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a $ kubectl -n jx-production get events --watch\\ --field-selector involvedObject.kind=Canary 23m ... New revision detected! Scaling up jx-production-myapp.jx-production 22m ... Starting canary analysis forjx-production-myapp.jx-production 22m ... Advance jx-production-myapp.jx-production canary weight 10 21m ... Advance jx-production-myapp.jx-production canary weight 20 20m ... Advance jx-production-myapp.jx-production canary weight 30 19m ... Advance jx-production-myapp.jx-production canary weight 40 18m ... Advance jx-production-myapp.jx-production canary weight 50 18m ... Copying jx-production-myapp.jx-production template spec to jx-production-myapp-primary.jx-production 17m ... Promotion completed! Scaling down jx-production-myapp.jx-production 2\u3001\u4eea\u8868\u76d8 \u4e3a\u4e86\u53ef\u89c6\u5316\u7684\u76ee\u7684\uff0cFlagger \u5305\u542b\u4e00\u4e2a Grafana \u9762\u677f\uff0c\u5c3d\u7ba1\u5b83\u5728\u91d1\u4e1d\u96c0\u53d1\u5e03\u4e2d\u4e0d\u9700\u8981\u3002 \u53ef\u4ee5\u5728\u672c\u5730\u901a\u8fc7 Kubernetes \u7aef\u53e3\u8f6c\u53d1\u8bbf\u95ee\u5b83\u3002 \u7136\u540e\u4f7f\u7528 admin/admin \u8bbf\u95ee http://localhost:3000 /\uff0c\u9009\u62e9 canary-analysis \u9762\u677f\u4ee5\u53ca namespace \u9009\u62e9 jx-production primary \u9009\u62e9 jx-production-myapp-primary canary \u9009\u62e9 jx-production-myapp \u5b83\u5c06\u4e3a\u6211\u4eec\u63d0\u4f9b\u5f53\u524d\u7248\u672c\u548c\u65b0\u7248\u672c\u7684\u5bf9\u6bd4\u89c6\u56fe\uff0c\u89c6\u56fe\u4e2d\u5305\u542b\u4e0d\u540c\u6307\u6807\uff08CPU\uff0c\u5185\u5b58\uff0c\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\uff0c\u54cd\u5e94\u9519\u8bef\u2026\u2026\uff09\u3002 \u5982\u679c\u56e0\u4e3a\u6307\u6807\u5931\u8d25\u51fa\u73b0\u81ea\u52a8\u56de\u6eda\uff0c\u751f\u4ea7\u73af\u5883\u7684 Jenkins X GitOps \u4ed3\u5e93\u4f1a\u8fc7\u65f6\uff0c\u4ecd\u7136\u4f7f\u7528\u65b0\u7248\u672c\u800c\u4e0d\u662f\u65e7\u7248\u672c\u3002 \u8fd9\u662f\u8ba1\u5212\u5728\u5373\u5c06\u53d1\u5e03\u7684\u7248\u672c\u4e2d\u4fee\u590d\u7684\u5185\u5bb9\u3002","title":"L3 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8:\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u90e8\u7f72"},{"location":"chap7/k8s_adv57_Auto_Canary/#l3-jenkins-x","text":"\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u88ab Netflix\uff0c Facebook \u4ee5\u53ca\u5176\u5b83\u516c\u53f8\u4f7f\u7528\u7528\u6765\u51cf\u8f7b\u90e8\u7f72\u7684\u98ce\u9669\u3002 \u4f46\u662f\u73b0\u5728\u4f60\u53ef\u4ee5\u5728\u4f7f\u7528 Jenkins X \u65f6\u91c7\u7528\u5b83\u3002 \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u662f\u6301\u7eed\u4ea4\u4ed8\u7684\u4e0b\u4e00\u6b65\uff0c\u5b83\u5c06\u65b0\u7248\u672c\u90e8\u7f72\u5230\u7528\u6237\u7684\u4e00\u4e2a\u5b50\u96c6\uff0c\u5e76\u5728\u5c06\u5176\u6eda\u52a8\u5230\u5168\u90e8\u7528\u6237\u4e4b\u524d\u5bf9\u5176\u6b63\u786e\u6027\u548c\u6027\u80fd\u8fdb\u884c\u8bc4\u4f30\uff0c\u5982\u679c\u4e0d\u5339\u914d\u67d0\u4e9b\u5173\u952e\u6307\u6807\uff0c\u5219\u8fdb\u884c\u56de\u6eda\u3002 \u5c24\u5176\u662f\uff0c\u6211\u4eec\u805a\u7126\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u5e76\u8ba9\u5b83\u5728\u4f60\u7684 Jenkins X \u5e94\u7528\u4e2d\u53d8\u5f97\u6613\u4e8e\u91c7\u7528\u3002 \u91d1\u4e1d\u96c0\u53d1\u5e03\u5305\u62ec\u5411\u5e94\u7528\u7a0b\u5e8f\u7684\u65b0\u7248\u672c\u53d1\u9001\u4e00\u5c0f\u90e8\u5206\u6d41\u91cf\uff0c\u5e76\u5728\u5411\u5176\u4ed6\u7528\u6237\u53d1\u5e03\u4e4b\u524d\u9a8c\u8bc1\u8fd9\u91cc\u6ca1\u6709\u9519\u8bef \u3002 Facebook \u5c31\u662f\u8fd9\u6837\u505a\u7684\uff0c\u9996\u5148\u5411\u5185\u90e8\u5458\u5de5\u63d0\u4f9b\u65b0\u7248\u672c\uff0c\u7136\u540e\u662f\u4e00\u5c0f\u90e8\u5206\u7528\u6237\uff0c\u7136\u540e\u662f\u5176\u4ed6\u6240\u6709\u7528\u6237\uff0c\u4f46\u662f\u4f60\u8981\u91c7\u7528\u5b83\u5e76\u4e0d\u9700\u8981\u6210\u4e3a Facebook \uff01 \u4f60\u53ef\u4ee5\u5728 Martin Fowler \u7684\u7f51\u7ad9\u9605\u8bfb\u66f4\u591a\u4e0e\u91d1\u4e1d\u96c0\u53d1\u5e03\u76f8\u5173\u4fe1\u606f\u3002","title":"L3 \u4f7f\u7528 Jenkins X \u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff1a\u81ea\u52a8\u5316\u91d1\u4e1d\u96c0\u90e8\u7f72"},{"location":"chap7/k8s_adv57_Auto_Canary/#1jenkins-x","text":"\u5982\u679c\u5728 Jenkins X \u4e2d\u4f60\u5df2\u7ecf\u6709\u4e00\u4e2a\u5e94\u7528\uff0c\u90a3\u4e48\u4f60\u77e5\u9053\u7684\u4f60\u53ef\u4ee5 \u901a\u8fc7 jx promote myapp --version 1.0 --env production \u547d\u4ee4 promote \u5b83\u5230\"\u751f\u4ea7\"\u73af\u5883\u3002 \u4f46\u662f\uff0c\u5728\u68c0\u67e5\u65b0\u7248\u672c\u662f\u5426\u5931\u8d25\u7684\u540c\u65f6\uff0c\u5b83\u4e5f\u53ef\u4ee5\u81ea\u52a8\u5e76\u9010\u6b65\u5730\u5411\u4e00\u5b9a\u6bd4\u4f8b\u7684\u7528\u6237\u63a8\u51fa\u3002 \u5982\u679c\u53d1\u751f\u5931\u8d25\uff0c\u5e94\u7528\u7a0b\u5e8f\u5c06\u81ea\u52a8\u56de\u6eda\u3002 \u6574\u4e2a\u8fc7\u7a0b\u4e2d\u5b8c\u5168\u6ca1\u6709\u4eba\u4e3a\u5e72\u9884\u3002 \u6ce8\u610f\uff1a\u8fd9\u4e2a\u65b0\u529f\u80fd\u662f\u975e\u5e38\u65b0\u7684\uff0c\u5728\u5c06\u6765\u8fd9\u4e9b\u6b65\u9aa4\u5c06\u4e0d\u518d\u9700\u8981\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e5f\u5c06\u7531 Jenkins X \u81ea\u52a8\u5316\u4e86\u3002","title":"1\u3001Jenkins X"},{"location":"chap7/k8s_adv57_Auto_Canary/#1-1-jenkins-x","text":"Istio : \u4e00\u79cd\u670d\u52a1\u7f51\u683c\u5bb9\u8bb8\u6211\u4eec\u7ba1\u7406\u6211\u4eec\u670d\u52a1\u7684\u6d41\u91cf\u3002 Prometheus \uff1a Kubernetes \u4e2d\u6700\u6d41\u884c\u7684\u76d1\u63a7\u7cfb\u7edf\u3002 Flagger \uff1a\u4e00\u4e2a\u4f7f\u7528 Istio \u7684\u9879\u76ee\uff0c\u8be5\u9879\u76ee\u4f7f\u7528 Prometheus \u7684\u6307\u6807\u81ea\u52a8\u5316\u8fdb\u884c\u91d1\u4e1d\u96c0\u53d1\u5e03\u548c\u56de\u6eda\u3002 \u63d2\u4ef6\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5b89\u88c5\uff08\u4f7f\u7528\u4e00\u4e2a\u6700\u8fd1\u7248\u672c\u7684 jx CLI \uff09\uff1a jx create addon istio jx create addon prometheus jx create addon flagger \u8fd9\u5c06\u5728 jx-production \u547d\u540d\u7a7a\u95f4\u542f\u52a8 Istio \u6765\u8fdb\u884c\u6307\u6807\u6536\u96c6\u3002 \u73b0\u5728\u83b7\u53d6 Istio ingress \u7684 IP \uff0c\u5e76\u5c06\u4e00\u4e2a\u901a\u914d\u7b26\u57df\u540d\uff08\u5982\uff1a *.example.com \uff09\u6307\u5411\u5b83\uff0c\u4ee5\u4fbf\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5b83\u6839\u636e\u4e3b\u673a\u540d\u8def\u7531\u591a\u4e2a\u670d\u52a1\u3002 Istio ingress \u63d0\u4f9b\u4e86\u91d1\u4e1d\u96c0\u53d1\u5e03\u9700\u8981\u7684\u8def\u7531\u80fd\u529b\uff08\u6d41\u91cf\u8f6c\u79fb\uff09\uff0c\u4f20\u7edf\u7684 Kubernetes ingress \u5bf9\u8c61\u4e0d\u652f\u6301\u8be5\u529f\u80fd\u3002 \u96c6\u7fa4\u88ab\u914d\u7f6e\u540e\uff0c\u662f\u65f6\u5019\u914d\u7f6e\u6211\u4eec\u7684\u5e94\u7528\u4e86\u3002 \u5728 charts/myapp/templates \u76ee\u5f55\u4e0b\u5411\u4f60\u7684 helm chart \u6dfb\u52a0\u4e00\u4e2a canary.yaml \u3002 \u7136\u540e\u5f80 charts/myapp/values.yaml \u8ffd\u52a0\u5982\u4e0b\u5185\u5bb9\uff0c\u5c06 myapp.example.com \u4fee\u6539\u4e3a\u4f60\u7684\u4e3b\u673a\u540d\u6216\u57df\u540d\uff1a \u4e0d\u4e45\uff0c\u5f53\u4f60\u4ece Jenkins X \u5feb\u901f\u5f00\u59cb\u521b\u5efa\u4f60\u7684\u5e94\u7528\uff0c\u5c06\u4e0d\u518d\u9700\u8981\u4fee\u6539 canary.yaml \u548c values.yaml \u8fd9\u4e24\u4e2a\u6587\u4ef6\uff0c\u56e0\u4e3a\u5b83\u4eec\u9ed8\u8ba4\u542f\u7528\u91d1\u4e1d\u96c0\u90e8\u7f72\u3002 \u5c31\u8fd9\u6837\uff01\u73b0\u5728\u5f53\u4f7f\u7528 jx promote myapp --version 1.0 --env production \u5c06\u4f60\u7684\u5e94\u7528 promote \u5230\u751f\u4ea7\u73af\u5883\uff0c\u5b83\u5c06\u6267\u884c\u4e00\u6b21\u91d1\u4e1d\u96c0\u90e8\u7f72\u3002 \u8bf7\u6ce8\u610f\uff0c\u7b2c\u4e00\u6b21\u88ab promote \u65f6\uff0c\u5b83\u4e0d\u4f1a\u6267\u884c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0c\u56e0\u4e3a\u5b83\u9700\u8981\u4e0e\u4ee5\u524d\u7684\u7248\u672c\u6570\u636e\u8fdb\u884c\u6bd4\u8f83\uff0c\u4f46\u4ece\u7b2c\u4e8c\u6b21 promotion \u5f00\u59cb\uff0c\u5b83\u5c06\u8d77\u4f5c\u7528\u3002 \u6839\u636e\u4e0a\u9762 values.yaml \u6587\u4ef6\u4e2d\u7684\u914d\u7f6e\uff0c\u5b83\u770b\u8d77\u6765\u50cf\uff1a \u7b2c 1 \u5206\u949f\uff1a\u5c06 10% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u7b2c 2 \u5206\u949f\uff1a\u5c06 20% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u7b2c 3 \u5206\u949f\uff1a\u5c06 30% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u7b2c 4 \u5206\u949f\uff1a\u5c06 40% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u7b2c 5 \u5206\u949f\uff1a\u5c06 100% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65b0\u7248\u672c \u5982\u679c\u6211\u4eec\u914d\u7f6e\u7684\u6307\u6807\uff08\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u8d85\u8fc7 500 \u6beb\u79d2\u6216\u8d85\u8fc7 1% \u7684\u54cd\u5e94\u8fd4\u56de 500 \u9519\u8bef\uff09\u5931\u8d25\uff0c Flagger \u5c06\u6ce8\u610f\u5230\u5931\u8d25\uff0c\u5e76\u4e14\u5982\u679c\u91cd\u590d 5 \u6b21\uff0c\u5b83\u5c06\u56de\u6eda\u8fd9\u6b21\u53d1\u5e03\uff0c\u5c06 100% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u65e7\u7248\u672c\u3002 \u83b7\u5f97\u91d1\u4e1d\u96c0\u4e8b\u4ef6\u8f93\u51fa\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a $ kubectl -n jx-production get events --watch\\ --field-selector involvedObject.kind=Canary 23m ... New revision detected! Scaling up jx-production-myapp.jx-production 22m ... Starting canary analysis forjx-production-myapp.jx-production 22m ... Advance jx-production-myapp.jx-production canary weight 10 21m ... Advance jx-production-myapp.jx-production canary weight 20 20m ... Advance jx-production-myapp.jx-production canary weight 30 19m ... Advance jx-production-myapp.jx-production canary weight 40 18m ... Advance jx-production-myapp.jx-production canary weight 50 18m ... Copying jx-production-myapp.jx-production template spec to jx-production-myapp-primary.jx-production 17m ... Promotion completed! Scaling down jx-production-myapp.jx-production","title":"1-1 \u4f5c\u4e3a\u7b2c\u4e00\u6b65\uff0c\u4e09\u4e2a Jenkins X \u63d2\u4ef6\u9700\u8981\u88ab\u5b89\u88c5\uff1a"},{"location":"chap7/k8s_adv57_Auto_Canary/#2","text":"\u4e3a\u4e86\u53ef\u89c6\u5316\u7684\u76ee\u7684\uff0cFlagger \u5305\u542b\u4e00\u4e2a Grafana \u9762\u677f\uff0c\u5c3d\u7ba1\u5b83\u5728\u91d1\u4e1d\u96c0\u53d1\u5e03\u4e2d\u4e0d\u9700\u8981\u3002 \u53ef\u4ee5\u5728\u672c\u5730\u901a\u8fc7 Kubernetes \u7aef\u53e3\u8f6c\u53d1\u8bbf\u95ee\u5b83\u3002 \u7136\u540e\u4f7f\u7528 admin/admin \u8bbf\u95ee http://localhost:3000 /\uff0c\u9009\u62e9 canary-analysis \u9762\u677f\u4ee5\u53ca namespace \u9009\u62e9 jx-production primary \u9009\u62e9 jx-production-myapp-primary canary \u9009\u62e9 jx-production-myapp \u5b83\u5c06\u4e3a\u6211\u4eec\u63d0\u4f9b\u5f53\u524d\u7248\u672c\u548c\u65b0\u7248\u672c\u7684\u5bf9\u6bd4\u89c6\u56fe\uff0c\u89c6\u56fe\u4e2d\u5305\u542b\u4e0d\u540c\u6307\u6807\uff08CPU\uff0c\u5185\u5b58\uff0c\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\uff0c\u54cd\u5e94\u9519\u8bef\u2026\u2026\uff09\u3002 \u5982\u679c\u56e0\u4e3a\u6307\u6807\u5931\u8d25\u51fa\u73b0\u81ea\u52a8\u56de\u6eda\uff0c\u751f\u4ea7\u73af\u5883\u7684 Jenkins X GitOps \u4ed3\u5e93\u4f1a\u8fc7\u65f6\uff0c\u4ecd\u7136\u4f7f\u7528\u65b0\u7248\u672c\u800c\u4e0d\u662f\u65e7\u7248\u672c\u3002 \u8fd9\u662f\u8ba1\u5212\u5728\u5373\u5c06\u53d1\u5e03\u7684\u7248\u672c\u4e2d\u4fee\u590d\u7684\u5185\u5bb9\u3002","title":"2\u3001\u4eea\u8868\u76d8"},{"location":"chap7/k8s_isitio_gray/","text":"\u4f7f\u7528Rainbond+Istio\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03 Kubernetes \u4f5c\u4e3a\u57fa\u7840\u5e73\u53f0\uff0c\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u5bb9\u5668\u7f16\u6392\u80fd\u529b\u3002\u4f46\u662f\u5728\u5176\u4e0a\u90e8\u7f72\u4e1a\u52a1\u548c\u670d\u52a1\u6cbb\u7406\u4e0a\uff0c\u4ecd\u7136\u4f1a\u9762\u5bf9\u4e00\u4e9b\u590d\u6742\u6027\u548c\u5c40\u9650\u6027\u3002 \u5728\u670d\u52a1\u6cbb\u7406\u4e0a\uff0c\u5df2\u7ecf\u6709\u8bb8\u591a\u6210\u719f\u7684 ServiceMesh \u6846\u67b6\u7528\u4e8e\u6269\u5145\u5176\u80fd\u529b\uff0c\u5982 Istio\u3001Linkerd\u3001Dapr \u7b49\u3002\u672c\u6587\u5c06\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528 Istio \u6269\u5145 Kubernetes \u7070\u5ea6\u53d1\u5e03\u7684\u80fd\u529b\u3002 \u800c\u5728\u90e8\u7f72\u4e0a\uff0c\u5219\u4f1a\u5229\u7528\u5f00\u6e90\u9879\u76ee Rainbond \u4f5c\u4e3a\u57fa\u7840\u5e73\u53f0\u6765\u8fdb\u884c\u5b9e\u8df5\u3002Rainbond \u662f\u4e00\u4e2a\u4e91\u539f\u751f\u5e94\u7528\u7ba1\u7406\u5e73\u53f0\uff0c\u5b83\u4f7f\u7528\u300c\u4ee5\u5e94\u7528\u4e3a\u4e2d\u5fc3\u300d\u7684\u8bbe\u8ba1\u6a21\u5f0f\u3002\u57fa\u4e8e\u8fd9\u4e00\u8bbe\u8ba1\u6a21\u5f0f\u62bd\u8c61\u51fa\u4e86\u6807\u51c6\u5316\u7684\u5e94\u7528\u6a21\u578b\u3002 \u4ece\u4f7f\u7528\u7684\u4f53\u9a8c\u4e0a\u4e0d\u9700\u8981\u5b66\u4e60\u548c\u7f16\u5199YAML\uff0c\u5373\u53ef\u5b9e\u73b0\u4e1a\u52a1\u5e94\u7528\u7684\u5168\u751f\u547d\u5468\u671f\u7ba1\u7406\u3002\u56e0\u6b64\u4f7f\u7528\u5b83\u7b80\u5316\u4e1a\u52a1\u7684\u90e8\u7f72\u548c\u7ba1\u7406\u3002\u540c\u65f6 Rainbond \u652f\u6301 ServiceMesh \u6846\u67b6\u7684\u66ff\u6362\uff0c\u4f7f\u6211\u4eec\u53ef\u4ee5\u6309\u9700\u9009\u62e9\u4e0e\u4e1a\u52a1\u6700\u5339\u914d\u7684 ServiceMesh \u6846\u67b6\u8fdb\u884c\u670d\u52a1\u6cbb\u7406\u3002 Kubernetes \u4e2d\u5982\u4f55\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03 \u5f53\u4f60\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e1a\u52a1\u65f6\uff0c\u53ef\u4ee5\u5229\u7528 Kubernetes \u539f\u751f\u63d0\u4f9b\u7684\u7070\u5ea6\u53d1\u5e03\u7684\u65b9\u5f0f\u53bb\u4e0a\u7ebf\u4e1a\u52a1\u3002 \u8fd9\u79cd\u65b9\u5f0f\u662f\u901a\u8fc7\u5728\u65e7\u7248\u672c\u548c\u65b0\u7248\u672c\u7684\u670d\u52a1\u4e4b\u95f4\uff0c\u5b9a\u4e49\u4e00\u4e2a\u5dee\u5f02\u5316\u7684 Label\uff0c\u6839\u636e\u4e0d\u540c\u7248\u672c\u4e4b\u95f4\u7684\u516c\u5171 Label \u8d1f\u8f7d\u6d41\u91cf\u5230\u540e\u7aef Pod\uff0c\u6700\u7ec8\u5b9e\u73b0\u6839\u636e Pod \u7684\u526f\u672c\u6570\u63a7\u5236\u6d41\u91cf\u7684\u767e\u5206\u6bd4 \u3002 \u5982\u4e0b\u56fe\u6240\u793a\uff1a\u7528\u6237\u5b9a\u4e49\u4e86\u4e24\u4e2a Deployment \u5bf9\u8c61\uff0c\u5176\u4e2d\u65e7\u7248\u672c\u540d\u4e3a frontend-stable\uff0c\u67093\u4e2a\u526f\u672c\u3002 \u65b0\u7248\u672c\u4e3a frontend-canary\uff0c\u67091\u4e2a\u526f\u672c\u3002\u6b64\u65f6\u5b9a\u4e49\u4e86\u4e00\u4e2a Service \u5bf9\u8c61\uff0c\u4f7f\u7528\u5b83\u4eec\u4e4b\u95f4\u516c\u5171\u7684 Label \u8fdb\u884c\u9009\u62e9\u3002\u8fd9\u5c31\u4f7f\u5f97\u7528\u6237\u8bbf\u95ee frontend \u8fd9\u4e2a Service \u65f6\uff0c\u80fd\u4ee5 3:1 \u7684\u6bd4\u4f8b\u540c\u65f6\u8bbf\u95ee\u5230\u4e24\u4e2a\u7248\u672c\u3002\u5e76\u4e14\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8c03\u6574\u526f\u672c\u6570\u6301\u7eed\u63a7\u5236\u6d41\u91cf\u6bd4\u4f8b\uff0c\u6700\u7ec8\u8fbe\u5230\u5b8c\u6574\u4e0a\u7ebf\u3002 Kubernetes \u9ed8\u8ba4\u7684\u5b9e\u73b0\u65b9\u5f0f\u5728\u7b80\u5355\u7684\u90e8\u7f72\u573a\u666f\u4e0b\u5f88\u6709\u6548\uff0c\u4f46\u662f\u5728\u4e00\u4e9b\u590d\u6742\u573a\u666f\u4e2d\uff0c\u4ecd\u7136\u4f1a\u6709\u8f83\u5927\u7684\u5c40\u9650\uff0c\u5982\uff1a \u4e1a\u52a1\u914d\u7f6e\u81ea\u52a8\u4f38\u7f29\u540e\uff0c\u4f1a\u76f4\u63a5\u5f71\u54cd\u7070\u5ea6\u53d1\u5e03\u7684\u6d41\u91cf\u6bd4\u4f8b \u4f4e\u767e\u5206\u6bd4\u7684\u6d41\u91cf\u63a7\u5236\u5360\u7528\u8d44\u6e90\u9ad8\uff0c\u5982 1 % \u7684\u6d41\u91cf\u5230\u8fbe\u65b0\u7248\u672c\uff0c\u5219\u81f3\u5c11\u9700\u8981 100 \u4e2a\u526f\u672c \u7cbe\u786e\u7684\u6d41\u91cf\u5206\u53d1\u63a7\u5236\uff0c\u4f7f\u8bbf\u95ee\u5230\u65b0\u7248\u672c\u4e2d\u7684\u7528\u6237\u4e00\u76f4\u662f\u540c\u4e00\u6279\uff0c\u800c\u4e0d\u662f\u67d0\u4e2a\u7528\u6237\u8bbf\u95ee\u65f6\u968f\u673a\u5207\u6362 Istio \u7070\u5ea6\u53d1\u5e03\u7b80\u8ff0 \u7531\u4e8e Kubernetes \u63d0\u4f9b\u7684\u7070\u5ea6\u53d1\u5e03\u65b9\u5f0f\u7684\u5c40\u9650\u6027\uff0c\u5728\u4e00\u4e9b\u590d\u6742\u573a\u666f\u4e0b\uff0c\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528 Istio \u6765\u5b9e\u73b0\u66f4\u7cbe\u7ec6\u7684\u7070\u5ea6\u53d1\u5e03\u7b56\u7565\u3002\u5728\u4f7f\u7528 Istio \u8fdb\u884c\u7070\u5ea6\u53d1\u5e03\u65f6\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3\u4e24\u4e2a\u91cd\u8981\u6982\u5ff5\uff1a Virtual services: \u865a\u62df\u670d\u52a1\u5b9a\u4e49\u4e86\u8bf7\u6c42\u5230\u670d\u52a1\u7684\u8def\u5f84 \u3002\u53ef\u4ee5\u5305\u542b\u4e00\u7ec4\u8def\u7531\u89c4\u5219\uff0c\u4f7f\u5339\u914d\u5230\u5bf9\u5e94\u89c4\u5219\u7684\u8bf7\u6c42\u80fd\u5230\u8fbe\u6307\u5b9a\u76ee\u6807\u3002 Destination rules: \u76ee\u6807\u89c4\u5219\u53ef\u4ee5\u7ba1\u7406\u5230\u8fbe\u8be5\u76ee\u6807\u7684\u6d41\u91cf\uff0c\u5982\u5bf9\u670d\u52a1\u540e\u7aef\u6240\u5bf9\u5e94\u7684\u5b9e\u4f8b\u6c60\u8fdb\u884c\u5206\u7ec4\uff0c\u518d\u7ed3\u5408 Virtual services \u5b9a\u4e49\u7684\u8def\u7531\u89c4\u5219\uff0c\u6700\u7ec8\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u6b63\u786e\u7684\u5b9e\u4f8b\u4e0a \u3002 \u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4ee5 istio \u5b98\u7f51\u63d0\u4f9b\u7684 Bookinfo \u793a\u4f8b\u7a0b\u5e8f\u4e3a\u4f8b\uff0c\u7ed9\u51fa\u4e86 virtual services \u548c destination rules \u7684\u4e3b\u8981\u5b9a\u4e49\u3002 \u5176\u4e2d virtual services \u4e3b\u8981\u5206\u4e3a\u4e24\u5757\uff0c\u4e3b\u673a\u540d\u548c\u8def\u7531\u89c4\u5219\u3002\u4e3b\u673a\u540d\u662f\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\u65f6\u4f7f\u7528\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u5730\u5740\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe virtual services \u65f6\uff0c\u5219\u4f1a\u6839\u636e\u5176\u5b9a\u4e49\u7684\u8def\u7531\u89c4\u5219\u5339\u914d\u3002 \u56fe\u4e2d\u5c31\u5b9a\u4e49\u4e86\u90ae\u7bb1\u4ee5 gmail.com \u7ed3\u5c3e\u7684\u7528\u6237\u6d41\u91cf\u53ea\u4f1a\u5230\u8fbe v3 \u7248\u672c\u7684\u5b9e\u4f8b\u4e0a\u3002\u800c\u5176\u4ed6\u7528\u6237\u5219\u4ee5 1:9 \u7684\u6bd4\u4f8b\u5206\u522b\u8bbf\u95ee\u5230 v1 \u548c v2 \u7248\u672c\u7684\u670d\u52a1\u3002\u8fd9\u79cd\u65b9\u5f0f\u5b9e\u73b0\u4e86\u7cbe\u786e\u7684\u6d41\u91cf\u5206\u53d1\u63a7\u5236\u3002 \u5f53\u7528\u6237\u6d41\u91cf\u6765\u5230 reviews.demo.svc.cluster.local \u8fd9\u4e2a Service \u4e0a\u65f6\uff0c\u53ef\u4ee5\u770b\u5230 destination rules \u7684\u89c4\u5219\u5b9a\u4e49\u4e2d\u6839\u636e version \u8fd9\u4e2a label \u5b9a\u4e49\u4e86\u4e0d\u540c\u7684\u5b9e\u4f8b\u96c6\uff0c\u5b9e\u73b0\u4e86\u6d41\u91cf\u6bd4\u4f8b\u4e0e\u526f\u672c\u6570\u7684\u89e3\u8026\u3002 \u4e0d\u7ba1 reviews-v1 \u6709\u591a\u5c11\u5b9e\u4f8b\u3002\u59cb\u7ec8\u53ea\u6709 10% \u7684\u6d41\u91cf\u5230\u8fbe destination rules \u7684 v1 \u5b50\u96c6\u4e2d\u3002\u8fd9\u5c31\u89e3\u51b3\u4e86\u4e1a\u52a1\u526f\u672c\u6570\u4e0e\u6d41\u91cf\u6bd4\u4f8b\u7684\u51b2\u7a81\u95ee\u9898\uff0c\u4e5f\u4f7f\u5f97\u8d44\u6e90\u4f7f\u7528\u66f4\u52a0\u5408\u7406\u3002 Istio \u7070\u5ea6\u53d1\u5e03\u5728 Rainbond \u4e0a\u7684\u5b9e\u8df5 \u57fa\u4e8e\u4ee5\u4e0a\u7406\u89e3\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u4ee5 BookInfo \u4e3a\u4f8b\u6765\u4f53\u9a8c Istio \u7684\u7070\u5ea6\u53d1\u5e03\u3002 1. \u51c6\u5907\u5de5\u4f5c\uff1a \u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u63d0\u524d\u5b89\u88c5\u597d\u6240\u9700\u8981\u7684\u73af\u5883\u3002 \u300c\u5b89\u88c5 Rainbond\u300d \u53c2\u8003 Rainbond \u5b98\u65b9\u6587\u6863 \u5feb\u901f\u5b89\u88c5\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u901a\u8fc7\u5bf9\u63a5 Helm \u5546\u5e97\u4e00\u952e\u5b89\u88c5 Istio \u4ee5\u53ca\u76f8\u5e94\u7ec4\u4ef6\u3002 \u300c\u5b89\u88c5 Istio \u4ee5\u53ca Kiali\u300d \u767b\u5f55\u5230 Rainbond \u63a7\u5236\u53f0\u540e\uff0c\u5148\u521b\u5efa\u4e00\u4e2a\u56e2\u961f\uff0c\u56e2\u961f\u82f1\u6587\u540d\u5bf9\u5e94 Kubernetes \u4e2d\u7684\u547d\u540d\u7a7a\u95f4\uff0cIstio \u9ed8\u8ba4\u5b89\u88c5\u7684\u547d\u540d\u7a7a\u95f4\u4e3a istio-system \uff0c\u56e0\u6b64\u56e2\u961f\u82f1\u6587\u540d\u586b\u5199istio-system\uff0c\u540d\u79f0\u53ef\u4ee5\u586b\u5199\u4e3a istio\u9879\u76ee\u3002\u63a5\u4e0b\u6765\u5bf9\u63a5 Helm \u5546\u5e97\uff0c\u901a\u8fc7 \u5e94\u7528\u5e02\u573a -> \u70b9\u51fb\u2795\u53f7 -> Helm \u5546\u5e97 \u5bf9\u63a5\u3002\u5546\u5e97\u540d\u79f0\u968f\u610f\u586b\u5199\uff0c\u5730\u5740\u586b\u5199 https://openchart.goodrain.com/goodrain/rainbond \u3002\u5546\u5e97\u5bf9\u63a5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5373\u53ef\u70b9\u51fb\u5b89\u88c5 istio\u3001kiali \u7b49\u5e94\u7528\u3002\u8be6\u7ec6\u53ef\u53c2\u8003 Istio \u5b89\u88c5\u3002 2. \u90e8\u7f72 BookInfo \u5e94\u7528 \u5728\u90e8\u7f72 BookInfo \u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5728 Rainbond \u4e2d\u521b\u5efa\u4e00\u4e2a\u56e2\u961f\u548c\u5e94\u7528\uff0c\u5e76\u5c06\u5e94\u7528\u7684\u6cbb\u7406\u6a21\u5f0f\u5207\u6362\u4e3a Istio \u6cbb\u7406\u6a21\u5f0f\u3002\u5728 Rainbond \u4e2d\u5e94\u7528\u6cbb\u7406\u6a21\u5f0f\u5207\u6362\u662f\u6307\u53ef\u4ee5\u65e0\u4fb5\u5165\u5730\u53d8\u66f4\u5e94\u7528\u4e0b\u7ec4\u4ef6\u95f4\u901a\u4fe1\u6cbb\u7406\u6a21\u5f0f\u3002 \u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4e00\u4e2a\u5b8c\u6574\u5e94\u7528\u4f1a\u5305\u542b\u591a\u4e2a\u5fae\u670d\u52a1\u6a21\u5757\uff0c\u800c ServiceMesh \u6846\u67b6\u5219\u662f\u5bf9\u6240\u6709\u4e1a\u52a1\u5bb9\u5668\u6ce8\u5165 Proxy\uff0c\u6839\u636e\u6ce8\u5165Proxy\u7684\u5dee\u5f02\u53ef\u4ee5\u652f\u6301\u591a\u79cd\u7c7b\u578b\u7684 ServiceMesh \u5b9e\u73b0\uff0c \u6bd4\u5982\uff1aIstio\u3001Linkerd\u3001Dapr\uff0c\u5e94\u7528\u53ef\u4ee5\u6309\u9700\u5f00\u542f ServiceMesh \u80fd\u529b\uff0c\u6216\u66f4\u6362\u5b9e\u73b0\u6846\u67b6 \u3002 \u4e3a\u4e86\u8ba9 BookInfo \u8fd9\u4e2a\u5e94\u7528\u4f7f\u7528\u5230 Istio \u7684\u6cbb\u7406\u80fd\u529b\uff0c\u6240\u4ee5\u9700\u8981\u5207\u6362\u5230 Istio \u6cbb\u7406\u6a21\u5f0f\u3002 \u300c2.1 \u51c6\u5907\u955c\u50cf\u300d BookInfo \u8fd9\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7531 6 \u4e2a\u5fae\u670d\u52a1\u7ec4\u6210\uff0c\u5b83\u4eec\u4e4b\u95f4\u7684\u4f9d\u8d56\u5982\u4e0b\u56fe\u6240\u793a\u3002\u5176\u4e2d Productpage \u8fd9\u4e2a\u670d\u52a1\u63d0\u4f9b\u4e86\u8bbf\u95ee\u9875\u9762\uff0c\u4ece Details \u8fd9\u4e2a\u670d\u52a1\u4e2d\u83b7\u5f97\u4e66\u7c4d\u8be6\u7ec6\u4fe1\u606f\u3002\u4ece Reviews \u670d\u52a1\u4e2d\u83b7\u5f97\u4e66\u7c4d\u8bc4\u4ef7\u3002 \u5176\u4e2d Reviews-v2 \u548c Reviews-v3 \u4f1a\u4ece Ratings \u8fd9\u4e2a\u670d\u52a1\u4e2d\u83b7\u5f97\u4e66\u7c4d\u7684\u8bc4\u7ea7\u4fe1\u606f\u3002\u8fd9\u516d\u4e2a\u5fae\u670d\u52a1\u7684\u955c\u50cf\u5982\u4e0b docker.io/istio/examples-bookinfo-productpage-v1:1.17.0 docker.io/istio/examples-bookinfo-details-v1:1.17.0 docker.io/istio/examples-bookinfo-reviews-v1:1.17.0 docker.io/istio/examples-bookinfo-reviews-v2:1.17.0 docker.io/istio/examples-bookinfo-reviews-v3:1.17.0 docker.io/istio/examples-bookinfo-ratings-v1:1.17.0 \u300c2.2 \u90e8\u7f72\u7ec4\u4ef6\u300d \u6211\u4eec\u5728\u5e94\u7528\u4e0b\uff0c\u9009\u62e9\u6dfb\u52a0\u7ec4\u4ef6 -> \u6307\u5b9a\u955c\u50cf -> \u586b\u5199\u955c\u50cf\u5730\u5740 -> \u65b0\u5efa\u7ec4\u4ef6 -> \u786e\u8ba4\u521b\u5efa\uff0c\u5373\u53ef\u4f9d\u6b21\u521b\u5efa\u51fa\u8fd9 5 \u4e2a\u5fae\u670d\u52a1\u5bf9\u5e94\u7684\u7ec4\u4ef6\u3002 \u300c2.3 \u751f\u6210\u53ef\u7528\u7684 Service\u300d \u521a\u521a\u6211\u4eec\u4ec5\u5b8c\u6210\u4e86\u6240\u6709\u670d\u52a1\u7684\u90e8\u7f72\uff0c\u8fd8\u672a\u5b9a\u4e49\u8fd9\u4e9b\u5fae\u670d\u52a1\u7684\u8bbf\u95ee\u7b56\u7565\u3002\u4ee5 Productpage \u4e3a\u4f8b\uff0c\u6211\u4eec\u901a\u8fc7\u70b9\u51fb\u62d3\u6251\u56fe\u4e2d Productpage \u8fd9\u4e2a\u7ec4\u4ef6\uff0c\u5373\u53ef\u8fdb\u5165\u8fd9\u4e2a\u670d\u52a1\u7684\u7ba1\u7406\u9875\u9762\u3002\u627e\u5230 \u7aef\u53e3 -> \u6dfb\u52a0\u7aef\u53e3 -> \u7aef\u53e3\u53f7\u586b\u51999080 -> \u6253\u5f00\u5bf9\u5916\u670d\u52a1 -> \u70b9\u51fb\u751f\u6210\u7684\u8def\u7531\uff0c\u5373\u53ef\u8bbf\u95ee\u6210\u529f\u3002\u6b64\u65f6\u4f1a\u53d1\u73b0 Productpage \u8fd9\u4e2a\u7ec4\u4ef6\u7684\u9875\u9762\u8fd8\u65e0\u6cd5\u62c9\u53d6\u5230\u4e66\u7c4d\u8bc4\u4ef7\u4fe1\u606f\u3002\u8fd9\u662f\u7531\u4e8e\u5b83\u9ed8\u8ba4\u4f7f\u7528 details \u548c reviews \u8fd9\u4e24\u4e2a Service \u540d\u79f0\u8fde\u63a5\u5230\u5b83\u4f9d\u8d56\u7684\u7ec4\u4ef6\u3002\u6b64\u65f6\u6211\u4eec\u90e8\u7f72\u7684 Reviews-v1 \u7b49\u7ec4\u4ef6\u8fd8\u6ca1\u6709\u6b63\u786e\u7684 Service \u540d\u79f0\u3002\u56e0\u6b64\u8fd8\u662f\u8fdb\u5165\u7ec4\u4ef6\u7ba1\u7406\u9875\u9762\uff0c\u7ec4\u4ef6\u7aef\u53e3 -> \u6dfb\u52a0\u7aef\u53e3 -> \u7aef\u53e3\u53f7\u586b\u51999080 -> \u4fee\u6539\u4f7f\u7528\u522b\u540d -> \u5185\u90e8\u57df\u540d\u586b\u5199\u4e3a reviews-v1 -> \u6253\u5f00\u5bf9\u5185\u670d\u52a1\u3002details\u3001reviews-v2\u3001ratings \u7b49\u7ec4\u4ef6\u90fd\u662f\u5982\u6b64\uff0c\u586b\u5199\u5176\u5bf9\u5e94\u7684 Service \u540d\u79f0\u540e\uff0c\u6253\u5f00\u5bf9\u5185\u670d\u52a1\u5373\u53ef\u3002 \u6700\u540e\u5728\u5e94\u7528\u7684 K8s \u8d44\u6e90\u4e0b\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u7684 Service\uff0c\u7528\u6765\u5728 Reviews \u7684\u4e09\u4e2a\u7248\u672c\u4e4b\u95f4\u8d1f\u8f7d\u6d41\u91cf\u3002 apiVersion: v1 kind: Service metadata: labels: app: reviews service: reviews name: reviews spec: ports: - name: http port: 9080 protocol: TCP targetPort: 9080 selector: component: reviews # \u9700\u8981\u5728 Reviews \u4e09\u4e2a\u7248\u672c\u4e2d\uff0c\u5747\u6dfb\u52a0 Kubernetes \u5c5e\u6027\uff0c\u8bbe\u7f6e\u4e0a\u8be5 Label\uff0c\u624d\u80fd\u6b63\u786e\u751f\u6548 sessionAffinity: None type: ClusterIP \u300c2.4 \u7f16\u6392\u4f9d\u8d56\u5173\u7cfb\u300d \u5b8c\u6210\u4ee5\u4e0a\u64cd\u4f5c\u540e\uff0c\u8bbf\u95ee Productpage \u5e94\u7528\uff0c\u53ef\u4ee5\u770b\u5230\u4e66\u7c4d\u8bc4\u8bba\u80fd\u6b63\u786e\u5728\u4e09\u4e2a\u7248\u672c\u4e2d\u5207\u6362\u4e86\u3002 \u6b64\u65f6\uff0c\u53ef\u4ee5\u5728\u5e94\u7528\u89c6\u56fe\u4e0b\uff0c\u5207\u6362\u5230\u7f16\u6392\u6a21\u5f0f\uff0c\u6839\u636e\u4e0a\u8ff0 BookInfo \u5e94\u7528\u7684\u67b6\u6784\u56fe\u8fdb\u884c\u8fde\u7ebf\uff0c\u5b9e\u73b0\u62d3\u6251\u56fe\u7684\u7f16\u6392\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u8fd9\u6837\u7f16\u6392\u7684\u597d\u5904\u662f\u540e\u671f\u53ef\u4ee5\u5c06\u8fd9\u4e2a\u5e94\u7528\u6574\u4f53\u53d1\u5e03\u51fa\u53bb\uff0c\u5176\u4ed6\u7528\u6237\u76f4\u63a5\u5b89\u88c5\u4e0b\u6765\u5373\u53ef\u5f97\u5230\u4e00\u6837\u7684\u62d3\u6251\u5173\u7cfb\uff0c\u518d\u4e5f\u4e0d\u7528\u62c5\u5fc3\u627e\u4e0d\u5230\u5404\u4e2a\u670d\u52a1\u4f9d\u8d56\u7684\u7ec4\u4ef6\u3002 3. \u7070\u5ea6\u53d1\u5e03 \u5728\u5b8c\u6210\u4ee5\u4e0a\u90e8\u7f72\u64cd\u4f5c\u540e\uff0c\u6211\u4eec\u5f97\u5230\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684 BookInfo \u7a0b\u5e8f\uff0c\u4f46\u6b64\u65f6\u8fd8\u672a\u5b9a\u4e49 Istio \u76f8\u5173\u914d\u7f6e\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u901a\u8fc7 Kiali \u53bb\u5b9a\u4e49\u6d41\u91cf\u89c4\u5219\u3002\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03\u3002 \u300c3.1 \u914d\u7f6e\u8def\u7531\u89c4\u5219\u300d \u8bbf\u95ee Kiali \u7ba1\u7406\u9875\u9762\uff0c\u5373\u53ef\u770b\u5230\u8be5\u5e94\u7528\u3002\u5728\u5de6\u4fa7\u8fb9\u680f\u9009\u62e9 Services\uff0c\u627e\u5230 reviews \u8fd9\u4e2a Service\uff0c\u70b9\u51fb\u8fdb\u5165\uff0c\u53f3\u4e0a\u89d2 Actions \u9009\u62e9 Traffic Shifting\uff0c\u5373\u53ef\u770b\u5230\u5982\u4e0b\u914d\u7f6e\uff1a\u62d6\u52a8\u6ed1\u5757\u9009\u62e9\u6d41\u91cf\u6bd4\u4f8b\u3002\u4e0b\u56fe\u4e2d 30% \u7684\u6d41\u91cf\u5c06\u4f1a\u8bbf\u95ee\u5230 reviews-v1 \u4e0a\uff0c70% \u7684\u6d41\u91cf\u8bbf\u95ee\u5230 reviews-v2\u4e0a\u3002\u70b9\u51fb\u521b\u5efa\u540e\uff0c\u5373\u53ef\u770b\u89c1\u9875\u9762\u5de6\u4e0b\u89d2\uff0cKiali \u81ea\u52a8\u4e3a\u4f60\u751f\u6210\u4e86 virtual services \u548c destination rules \u8d44\u6e90\u3002\u4f60\u53ef\u4ee5\u70b9\u51fb\u8fdb\u53bb\u6839\u636e\u81ea\u5df1\u9700\u6c42\u518d\u6b21\u7f16\u8f91\u3002 \u300c3.2 \u9a8c\u8bc1\u8def\u7531\u89c4\u5219\u662f\u5426\u751f\u6548\u300d \u627e\u5230\u6700\u5f00\u59cb\u90e8\u7f72\u7684\u7ec4\u4ef6 Productpage\uff0c\u8fdb\u5165\u7ec4\u4ef6\u7ba1\u7406\u9875\u9762\uff0c\u70b9\u51fb\u53f3\u4e0a\u89d2\u8bbf\u95ee\u5165\u53e3\uff0c\u53ef\u4ee5\u770b\u5230\u4e66\u7c4d\u8be6\u60c5\u548c\u8bc4\u7ea7\uff0c\u53cd\u590d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u5e26\u661f\u7ea7\u7684\u8bc4\u4ef7\u4fe1\u606f(reviews-v1)\u4e0e\u9ed1\u8272\u661f\u7ea7\u8bc4\u4ef7\u4fe1\u606f(reviews-v2)\u51fa\u73b0\u7684\u6bd4\u4f8b\u5927\u6982\u662f 3:7\u3002\u7ea2\u8272\u661f\u7ea7\u8bc4\u4ef7\u4fe1\u606f(reviews-v3)\u4ece\u672a\u51fa\u73b0\u3002 \u300c3.3 \u9a8c\u8bc1\u7ec4\u4ef6\u6269\u5bb9\u5bf9\u6d41\u91cf\u7684\u5f71\u54cd\u300d \u627e\u5230\u90e8\u7f72\u7684\u7ec4\u4ef6 reviews-v1 \uff0c\u8fdb\u5165\u7ec4\u4ef6\u7ba1\u7406\u9875\u9762 -> \u4f38\u7f29 -> \u5b9e\u4f8b\u6570\u91cf\u8bbe\u7f6e\u4e3a4\uff0c\u6b64\u65f6\u518d\u6b21\u8bbf\u95ee Productpage \u9875\u9762\uff0c\u53cd\u590d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230 reviews-v1 \u6269\u5bb9\u540e\uff0c\u8bbf\u95ee\u5230 reviews-v1 \u4e0e reviews-v2 \u7684\u6bd4\u4f8b\u4ecd\u4e3a 3:7\uff0c\u7ec4\u4ef6\u5b9e\u4f8b\u6570\u7684\u591a\u5c11\u5bf9\u6d41\u91cf\u5206\u53d1\u7b56\u7565\u6ca1\u6709\u5f71\u54cd\u3002","title":"L4 \u4f7f\u7528Rainbond+Istio\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03"},{"location":"chap7/k8s_isitio_gray/#rainbondistio","text":"Kubernetes \u4f5c\u4e3a\u57fa\u7840\u5e73\u53f0\uff0c\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u5bb9\u5668\u7f16\u6392\u80fd\u529b\u3002\u4f46\u662f\u5728\u5176\u4e0a\u90e8\u7f72\u4e1a\u52a1\u548c\u670d\u52a1\u6cbb\u7406\u4e0a\uff0c\u4ecd\u7136\u4f1a\u9762\u5bf9\u4e00\u4e9b\u590d\u6742\u6027\u548c\u5c40\u9650\u6027\u3002 \u5728\u670d\u52a1\u6cbb\u7406\u4e0a\uff0c\u5df2\u7ecf\u6709\u8bb8\u591a\u6210\u719f\u7684 ServiceMesh \u6846\u67b6\u7528\u4e8e\u6269\u5145\u5176\u80fd\u529b\uff0c\u5982 Istio\u3001Linkerd\u3001Dapr \u7b49\u3002\u672c\u6587\u5c06\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528 Istio \u6269\u5145 Kubernetes \u7070\u5ea6\u53d1\u5e03\u7684\u80fd\u529b\u3002 \u800c\u5728\u90e8\u7f72\u4e0a\uff0c\u5219\u4f1a\u5229\u7528\u5f00\u6e90\u9879\u76ee Rainbond \u4f5c\u4e3a\u57fa\u7840\u5e73\u53f0\u6765\u8fdb\u884c\u5b9e\u8df5\u3002Rainbond \u662f\u4e00\u4e2a\u4e91\u539f\u751f\u5e94\u7528\u7ba1\u7406\u5e73\u53f0\uff0c\u5b83\u4f7f\u7528\u300c\u4ee5\u5e94\u7528\u4e3a\u4e2d\u5fc3\u300d\u7684\u8bbe\u8ba1\u6a21\u5f0f\u3002\u57fa\u4e8e\u8fd9\u4e00\u8bbe\u8ba1\u6a21\u5f0f\u62bd\u8c61\u51fa\u4e86\u6807\u51c6\u5316\u7684\u5e94\u7528\u6a21\u578b\u3002 \u4ece\u4f7f\u7528\u7684\u4f53\u9a8c\u4e0a\u4e0d\u9700\u8981\u5b66\u4e60\u548c\u7f16\u5199YAML\uff0c\u5373\u53ef\u5b9e\u73b0\u4e1a\u52a1\u5e94\u7528\u7684\u5168\u751f\u547d\u5468\u671f\u7ba1\u7406\u3002\u56e0\u6b64\u4f7f\u7528\u5b83\u7b80\u5316\u4e1a\u52a1\u7684\u90e8\u7f72\u548c\u7ba1\u7406\u3002\u540c\u65f6 Rainbond \u652f\u6301 ServiceMesh \u6846\u67b6\u7684\u66ff\u6362\uff0c\u4f7f\u6211\u4eec\u53ef\u4ee5\u6309\u9700\u9009\u62e9\u4e0e\u4e1a\u52a1\u6700\u5339\u914d\u7684 ServiceMesh \u6846\u67b6\u8fdb\u884c\u670d\u52a1\u6cbb\u7406\u3002","title":"\u4f7f\u7528Rainbond+Istio\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03"},{"location":"chap7/k8s_isitio_gray/#kubernetes","text":"\u5f53\u4f60\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e1a\u52a1\u65f6\uff0c\u53ef\u4ee5\u5229\u7528 Kubernetes \u539f\u751f\u63d0\u4f9b\u7684\u7070\u5ea6\u53d1\u5e03\u7684\u65b9\u5f0f\u53bb\u4e0a\u7ebf\u4e1a\u52a1\u3002 \u8fd9\u79cd\u65b9\u5f0f\u662f\u901a\u8fc7\u5728\u65e7\u7248\u672c\u548c\u65b0\u7248\u672c\u7684\u670d\u52a1\u4e4b\u95f4\uff0c\u5b9a\u4e49\u4e00\u4e2a\u5dee\u5f02\u5316\u7684 Label\uff0c\u6839\u636e\u4e0d\u540c\u7248\u672c\u4e4b\u95f4\u7684\u516c\u5171 Label \u8d1f\u8f7d\u6d41\u91cf\u5230\u540e\u7aef Pod\uff0c\u6700\u7ec8\u5b9e\u73b0\u6839\u636e Pod \u7684\u526f\u672c\u6570\u63a7\u5236\u6d41\u91cf\u7684\u767e\u5206\u6bd4 \u3002 \u5982\u4e0b\u56fe\u6240\u793a\uff1a\u7528\u6237\u5b9a\u4e49\u4e86\u4e24\u4e2a Deployment \u5bf9\u8c61\uff0c\u5176\u4e2d\u65e7\u7248\u672c\u540d\u4e3a frontend-stable\uff0c\u67093\u4e2a\u526f\u672c\u3002 \u65b0\u7248\u672c\u4e3a frontend-canary\uff0c\u67091\u4e2a\u526f\u672c\u3002\u6b64\u65f6\u5b9a\u4e49\u4e86\u4e00\u4e2a Service \u5bf9\u8c61\uff0c\u4f7f\u7528\u5b83\u4eec\u4e4b\u95f4\u516c\u5171\u7684 Label \u8fdb\u884c\u9009\u62e9\u3002\u8fd9\u5c31\u4f7f\u5f97\u7528\u6237\u8bbf\u95ee frontend \u8fd9\u4e2a Service \u65f6\uff0c\u80fd\u4ee5 3:1 \u7684\u6bd4\u4f8b\u540c\u65f6\u8bbf\u95ee\u5230\u4e24\u4e2a\u7248\u672c\u3002\u5e76\u4e14\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8c03\u6574\u526f\u672c\u6570\u6301\u7eed\u63a7\u5236\u6d41\u91cf\u6bd4\u4f8b\uff0c\u6700\u7ec8\u8fbe\u5230\u5b8c\u6574\u4e0a\u7ebf\u3002 Kubernetes \u9ed8\u8ba4\u7684\u5b9e\u73b0\u65b9\u5f0f\u5728\u7b80\u5355\u7684\u90e8\u7f72\u573a\u666f\u4e0b\u5f88\u6709\u6548\uff0c\u4f46\u662f\u5728\u4e00\u4e9b\u590d\u6742\u573a\u666f\u4e2d\uff0c\u4ecd\u7136\u4f1a\u6709\u8f83\u5927\u7684\u5c40\u9650\uff0c\u5982\uff1a \u4e1a\u52a1\u914d\u7f6e\u81ea\u52a8\u4f38\u7f29\u540e\uff0c\u4f1a\u76f4\u63a5\u5f71\u54cd\u7070\u5ea6\u53d1\u5e03\u7684\u6d41\u91cf\u6bd4\u4f8b \u4f4e\u767e\u5206\u6bd4\u7684\u6d41\u91cf\u63a7\u5236\u5360\u7528\u8d44\u6e90\u9ad8\uff0c\u5982 1 % \u7684\u6d41\u91cf\u5230\u8fbe\u65b0\u7248\u672c\uff0c\u5219\u81f3\u5c11\u9700\u8981 100 \u4e2a\u526f\u672c \u7cbe\u786e\u7684\u6d41\u91cf\u5206\u53d1\u63a7\u5236\uff0c\u4f7f\u8bbf\u95ee\u5230\u65b0\u7248\u672c\u4e2d\u7684\u7528\u6237\u4e00\u76f4\u662f\u540c\u4e00\u6279\uff0c\u800c\u4e0d\u662f\u67d0\u4e2a\u7528\u6237\u8bbf\u95ee\u65f6\u968f\u673a\u5207\u6362","title":"Kubernetes \u4e2d\u5982\u4f55\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03"},{"location":"chap7/k8s_isitio_gray/#istio","text":"\u7531\u4e8e Kubernetes \u63d0\u4f9b\u7684\u7070\u5ea6\u53d1\u5e03\u65b9\u5f0f\u7684\u5c40\u9650\u6027\uff0c\u5728\u4e00\u4e9b\u590d\u6742\u573a\u666f\u4e0b\uff0c\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528 Istio \u6765\u5b9e\u73b0\u66f4\u7cbe\u7ec6\u7684\u7070\u5ea6\u53d1\u5e03\u7b56\u7565\u3002\u5728\u4f7f\u7528 Istio \u8fdb\u884c\u7070\u5ea6\u53d1\u5e03\u65f6\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3\u4e24\u4e2a\u91cd\u8981\u6982\u5ff5\uff1a Virtual services: \u865a\u62df\u670d\u52a1\u5b9a\u4e49\u4e86\u8bf7\u6c42\u5230\u670d\u52a1\u7684\u8def\u5f84 \u3002\u53ef\u4ee5\u5305\u542b\u4e00\u7ec4\u8def\u7531\u89c4\u5219\uff0c\u4f7f\u5339\u914d\u5230\u5bf9\u5e94\u89c4\u5219\u7684\u8bf7\u6c42\u80fd\u5230\u8fbe\u6307\u5b9a\u76ee\u6807\u3002 Destination rules: \u76ee\u6807\u89c4\u5219\u53ef\u4ee5\u7ba1\u7406\u5230\u8fbe\u8be5\u76ee\u6807\u7684\u6d41\u91cf\uff0c\u5982\u5bf9\u670d\u52a1\u540e\u7aef\u6240\u5bf9\u5e94\u7684\u5b9e\u4f8b\u6c60\u8fdb\u884c\u5206\u7ec4\uff0c\u518d\u7ed3\u5408 Virtual services \u5b9a\u4e49\u7684\u8def\u7531\u89c4\u5219\uff0c\u6700\u7ec8\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u6b63\u786e\u7684\u5b9e\u4f8b\u4e0a \u3002 \u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4ee5 istio \u5b98\u7f51\u63d0\u4f9b\u7684 Bookinfo \u793a\u4f8b\u7a0b\u5e8f\u4e3a\u4f8b\uff0c\u7ed9\u51fa\u4e86 virtual services \u548c destination rules \u7684\u4e3b\u8981\u5b9a\u4e49\u3002 \u5176\u4e2d virtual services \u4e3b\u8981\u5206\u4e3a\u4e24\u5757\uff0c\u4e3b\u673a\u540d\u548c\u8def\u7531\u89c4\u5219\u3002\u4e3b\u673a\u540d\u662f\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\u65f6\u4f7f\u7528\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u5730\u5740\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe virtual services \u65f6\uff0c\u5219\u4f1a\u6839\u636e\u5176\u5b9a\u4e49\u7684\u8def\u7531\u89c4\u5219\u5339\u914d\u3002 \u56fe\u4e2d\u5c31\u5b9a\u4e49\u4e86\u90ae\u7bb1\u4ee5 gmail.com \u7ed3\u5c3e\u7684\u7528\u6237\u6d41\u91cf\u53ea\u4f1a\u5230\u8fbe v3 \u7248\u672c\u7684\u5b9e\u4f8b\u4e0a\u3002\u800c\u5176\u4ed6\u7528\u6237\u5219\u4ee5 1:9 \u7684\u6bd4\u4f8b\u5206\u522b\u8bbf\u95ee\u5230 v1 \u548c v2 \u7248\u672c\u7684\u670d\u52a1\u3002\u8fd9\u79cd\u65b9\u5f0f\u5b9e\u73b0\u4e86\u7cbe\u786e\u7684\u6d41\u91cf\u5206\u53d1\u63a7\u5236\u3002 \u5f53\u7528\u6237\u6d41\u91cf\u6765\u5230 reviews.demo.svc.cluster.local \u8fd9\u4e2a Service \u4e0a\u65f6\uff0c\u53ef\u4ee5\u770b\u5230 destination rules \u7684\u89c4\u5219\u5b9a\u4e49\u4e2d\u6839\u636e version \u8fd9\u4e2a label \u5b9a\u4e49\u4e86\u4e0d\u540c\u7684\u5b9e\u4f8b\u96c6\uff0c\u5b9e\u73b0\u4e86\u6d41\u91cf\u6bd4\u4f8b\u4e0e\u526f\u672c\u6570\u7684\u89e3\u8026\u3002 \u4e0d\u7ba1 reviews-v1 \u6709\u591a\u5c11\u5b9e\u4f8b\u3002\u59cb\u7ec8\u53ea\u6709 10% \u7684\u6d41\u91cf\u5230\u8fbe destination rules \u7684 v1 \u5b50\u96c6\u4e2d\u3002\u8fd9\u5c31\u89e3\u51b3\u4e86\u4e1a\u52a1\u526f\u672c\u6570\u4e0e\u6d41\u91cf\u6bd4\u4f8b\u7684\u51b2\u7a81\u95ee\u9898\uff0c\u4e5f\u4f7f\u5f97\u8d44\u6e90\u4f7f\u7528\u66f4\u52a0\u5408\u7406\u3002","title":"Istio \u7070\u5ea6\u53d1\u5e03\u7b80\u8ff0"},{"location":"chap7/k8s_isitio_gray/#istio-rainbond","text":"\u57fa\u4e8e\u4ee5\u4e0a\u7406\u89e3\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u4ee5 BookInfo \u4e3a\u4f8b\u6765\u4f53\u9a8c Istio \u7684\u7070\u5ea6\u53d1\u5e03\u3002","title":"Istio \u7070\u5ea6\u53d1\u5e03\u5728 Rainbond \u4e0a\u7684\u5b9e\u8df5"},{"location":"chap7/k8s_isitio_gray/#1","text":"\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u63d0\u524d\u5b89\u88c5\u597d\u6240\u9700\u8981\u7684\u73af\u5883\u3002 \u300c\u5b89\u88c5 Rainbond\u300d \u53c2\u8003 Rainbond \u5b98\u65b9\u6587\u6863 \u5feb\u901f\u5b89\u88c5\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u901a\u8fc7\u5bf9\u63a5 Helm \u5546\u5e97\u4e00\u952e\u5b89\u88c5 Istio \u4ee5\u53ca\u76f8\u5e94\u7ec4\u4ef6\u3002 \u300c\u5b89\u88c5 Istio \u4ee5\u53ca Kiali\u300d \u767b\u5f55\u5230 Rainbond \u63a7\u5236\u53f0\u540e\uff0c\u5148\u521b\u5efa\u4e00\u4e2a\u56e2\u961f\uff0c\u56e2\u961f\u82f1\u6587\u540d\u5bf9\u5e94 Kubernetes \u4e2d\u7684\u547d\u540d\u7a7a\u95f4\uff0cIstio \u9ed8\u8ba4\u5b89\u88c5\u7684\u547d\u540d\u7a7a\u95f4\u4e3a istio-system \uff0c\u56e0\u6b64\u56e2\u961f\u82f1\u6587\u540d\u586b\u5199istio-system\uff0c\u540d\u79f0\u53ef\u4ee5\u586b\u5199\u4e3a istio\u9879\u76ee\u3002\u63a5\u4e0b\u6765\u5bf9\u63a5 Helm \u5546\u5e97\uff0c\u901a\u8fc7 \u5e94\u7528\u5e02\u573a -> \u70b9\u51fb\u2795\u53f7 -> Helm \u5546\u5e97 \u5bf9\u63a5\u3002\u5546\u5e97\u540d\u79f0\u968f\u610f\u586b\u5199\uff0c\u5730\u5740\u586b\u5199 https://openchart.goodrain.com/goodrain/rainbond \u3002\u5546\u5e97\u5bf9\u63a5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5373\u53ef\u70b9\u51fb\u5b89\u88c5 istio\u3001kiali \u7b49\u5e94\u7528\u3002\u8be6\u7ec6\u53ef\u53c2\u8003 Istio \u5b89\u88c5\u3002","title":"1. \u51c6\u5907\u5de5\u4f5c\uff1a"},{"location":"chap7/k8s_isitio_gray/#2-bookinfo","text":"\u5728\u90e8\u7f72 BookInfo \u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5728 Rainbond \u4e2d\u521b\u5efa\u4e00\u4e2a\u56e2\u961f\u548c\u5e94\u7528\uff0c\u5e76\u5c06\u5e94\u7528\u7684\u6cbb\u7406\u6a21\u5f0f\u5207\u6362\u4e3a Istio \u6cbb\u7406\u6a21\u5f0f\u3002\u5728 Rainbond \u4e2d\u5e94\u7528\u6cbb\u7406\u6a21\u5f0f\u5207\u6362\u662f\u6307\u53ef\u4ee5\u65e0\u4fb5\u5165\u5730\u53d8\u66f4\u5e94\u7528\u4e0b\u7ec4\u4ef6\u95f4\u901a\u4fe1\u6cbb\u7406\u6a21\u5f0f\u3002 \u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4e00\u4e2a\u5b8c\u6574\u5e94\u7528\u4f1a\u5305\u542b\u591a\u4e2a\u5fae\u670d\u52a1\u6a21\u5757\uff0c\u800c ServiceMesh \u6846\u67b6\u5219\u662f\u5bf9\u6240\u6709\u4e1a\u52a1\u5bb9\u5668\u6ce8\u5165 Proxy\uff0c\u6839\u636e\u6ce8\u5165Proxy\u7684\u5dee\u5f02\u53ef\u4ee5\u652f\u6301\u591a\u79cd\u7c7b\u578b\u7684 ServiceMesh \u5b9e\u73b0\uff0c \u6bd4\u5982\uff1aIstio\u3001Linkerd\u3001Dapr\uff0c\u5e94\u7528\u53ef\u4ee5\u6309\u9700\u5f00\u542f ServiceMesh \u80fd\u529b\uff0c\u6216\u66f4\u6362\u5b9e\u73b0\u6846\u67b6 \u3002 \u4e3a\u4e86\u8ba9 BookInfo \u8fd9\u4e2a\u5e94\u7528\u4f7f\u7528\u5230 Istio \u7684\u6cbb\u7406\u80fd\u529b\uff0c\u6240\u4ee5\u9700\u8981\u5207\u6362\u5230 Istio \u6cbb\u7406\u6a21\u5f0f\u3002 \u300c2.1 \u51c6\u5907\u955c\u50cf\u300d BookInfo \u8fd9\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7531 6 \u4e2a\u5fae\u670d\u52a1\u7ec4\u6210\uff0c\u5b83\u4eec\u4e4b\u95f4\u7684\u4f9d\u8d56\u5982\u4e0b\u56fe\u6240\u793a\u3002\u5176\u4e2d Productpage \u8fd9\u4e2a\u670d\u52a1\u63d0\u4f9b\u4e86\u8bbf\u95ee\u9875\u9762\uff0c\u4ece Details \u8fd9\u4e2a\u670d\u52a1\u4e2d\u83b7\u5f97\u4e66\u7c4d\u8be6\u7ec6\u4fe1\u606f\u3002\u4ece Reviews \u670d\u52a1\u4e2d\u83b7\u5f97\u4e66\u7c4d\u8bc4\u4ef7\u3002 \u5176\u4e2d Reviews-v2 \u548c Reviews-v3 \u4f1a\u4ece Ratings \u8fd9\u4e2a\u670d\u52a1\u4e2d\u83b7\u5f97\u4e66\u7c4d\u7684\u8bc4\u7ea7\u4fe1\u606f\u3002\u8fd9\u516d\u4e2a\u5fae\u670d\u52a1\u7684\u955c\u50cf\u5982\u4e0b docker.io/istio/examples-bookinfo-productpage-v1:1.17.0 docker.io/istio/examples-bookinfo-details-v1:1.17.0 docker.io/istio/examples-bookinfo-reviews-v1:1.17.0 docker.io/istio/examples-bookinfo-reviews-v2:1.17.0 docker.io/istio/examples-bookinfo-reviews-v3:1.17.0 docker.io/istio/examples-bookinfo-ratings-v1:1.17.0 \u300c2.2 \u90e8\u7f72\u7ec4\u4ef6\u300d \u6211\u4eec\u5728\u5e94\u7528\u4e0b\uff0c\u9009\u62e9\u6dfb\u52a0\u7ec4\u4ef6 -> \u6307\u5b9a\u955c\u50cf -> \u586b\u5199\u955c\u50cf\u5730\u5740 -> \u65b0\u5efa\u7ec4\u4ef6 -> \u786e\u8ba4\u521b\u5efa\uff0c\u5373\u53ef\u4f9d\u6b21\u521b\u5efa\u51fa\u8fd9 5 \u4e2a\u5fae\u670d\u52a1\u5bf9\u5e94\u7684\u7ec4\u4ef6\u3002 \u300c2.3 \u751f\u6210\u53ef\u7528\u7684 Service\u300d \u521a\u521a\u6211\u4eec\u4ec5\u5b8c\u6210\u4e86\u6240\u6709\u670d\u52a1\u7684\u90e8\u7f72\uff0c\u8fd8\u672a\u5b9a\u4e49\u8fd9\u4e9b\u5fae\u670d\u52a1\u7684\u8bbf\u95ee\u7b56\u7565\u3002\u4ee5 Productpage \u4e3a\u4f8b\uff0c\u6211\u4eec\u901a\u8fc7\u70b9\u51fb\u62d3\u6251\u56fe\u4e2d Productpage \u8fd9\u4e2a\u7ec4\u4ef6\uff0c\u5373\u53ef\u8fdb\u5165\u8fd9\u4e2a\u670d\u52a1\u7684\u7ba1\u7406\u9875\u9762\u3002\u627e\u5230 \u7aef\u53e3 -> \u6dfb\u52a0\u7aef\u53e3 -> \u7aef\u53e3\u53f7\u586b\u51999080 -> \u6253\u5f00\u5bf9\u5916\u670d\u52a1 -> \u70b9\u51fb\u751f\u6210\u7684\u8def\u7531\uff0c\u5373\u53ef\u8bbf\u95ee\u6210\u529f\u3002\u6b64\u65f6\u4f1a\u53d1\u73b0 Productpage \u8fd9\u4e2a\u7ec4\u4ef6\u7684\u9875\u9762\u8fd8\u65e0\u6cd5\u62c9\u53d6\u5230\u4e66\u7c4d\u8bc4\u4ef7\u4fe1\u606f\u3002\u8fd9\u662f\u7531\u4e8e\u5b83\u9ed8\u8ba4\u4f7f\u7528 details \u548c reviews \u8fd9\u4e24\u4e2a Service \u540d\u79f0\u8fde\u63a5\u5230\u5b83\u4f9d\u8d56\u7684\u7ec4\u4ef6\u3002\u6b64\u65f6\u6211\u4eec\u90e8\u7f72\u7684 Reviews-v1 \u7b49\u7ec4\u4ef6\u8fd8\u6ca1\u6709\u6b63\u786e\u7684 Service \u540d\u79f0\u3002\u56e0\u6b64\u8fd8\u662f\u8fdb\u5165\u7ec4\u4ef6\u7ba1\u7406\u9875\u9762\uff0c\u7ec4\u4ef6\u7aef\u53e3 -> \u6dfb\u52a0\u7aef\u53e3 -> \u7aef\u53e3\u53f7\u586b\u51999080 -> \u4fee\u6539\u4f7f\u7528\u522b\u540d -> \u5185\u90e8\u57df\u540d\u586b\u5199\u4e3a reviews-v1 -> \u6253\u5f00\u5bf9\u5185\u670d\u52a1\u3002details\u3001reviews-v2\u3001ratings \u7b49\u7ec4\u4ef6\u90fd\u662f\u5982\u6b64\uff0c\u586b\u5199\u5176\u5bf9\u5e94\u7684 Service \u540d\u79f0\u540e\uff0c\u6253\u5f00\u5bf9\u5185\u670d\u52a1\u5373\u53ef\u3002 \u6700\u540e\u5728\u5e94\u7528\u7684 K8s \u8d44\u6e90\u4e0b\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u7684 Service\uff0c\u7528\u6765\u5728 Reviews \u7684\u4e09\u4e2a\u7248\u672c\u4e4b\u95f4\u8d1f\u8f7d\u6d41\u91cf\u3002 apiVersion: v1 kind: Service metadata: labels: app: reviews service: reviews name: reviews spec: ports: - name: http port: 9080 protocol: TCP targetPort: 9080 selector: component: reviews # \u9700\u8981\u5728 Reviews \u4e09\u4e2a\u7248\u672c\u4e2d\uff0c\u5747\u6dfb\u52a0 Kubernetes \u5c5e\u6027\uff0c\u8bbe\u7f6e\u4e0a\u8be5 Label\uff0c\u624d\u80fd\u6b63\u786e\u751f\u6548 sessionAffinity: None type: ClusterIP \u300c2.4 \u7f16\u6392\u4f9d\u8d56\u5173\u7cfb\u300d \u5b8c\u6210\u4ee5\u4e0a\u64cd\u4f5c\u540e\uff0c\u8bbf\u95ee Productpage \u5e94\u7528\uff0c\u53ef\u4ee5\u770b\u5230\u4e66\u7c4d\u8bc4\u8bba\u80fd\u6b63\u786e\u5728\u4e09\u4e2a\u7248\u672c\u4e2d\u5207\u6362\u4e86\u3002 \u6b64\u65f6\uff0c\u53ef\u4ee5\u5728\u5e94\u7528\u89c6\u56fe\u4e0b\uff0c\u5207\u6362\u5230\u7f16\u6392\u6a21\u5f0f\uff0c\u6839\u636e\u4e0a\u8ff0 BookInfo \u5e94\u7528\u7684\u67b6\u6784\u56fe\u8fdb\u884c\u8fde\u7ebf\uff0c\u5b9e\u73b0\u62d3\u6251\u56fe\u7684\u7f16\u6392\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u8fd9\u6837\u7f16\u6392\u7684\u597d\u5904\u662f\u540e\u671f\u53ef\u4ee5\u5c06\u8fd9\u4e2a\u5e94\u7528\u6574\u4f53\u53d1\u5e03\u51fa\u53bb\uff0c\u5176\u4ed6\u7528\u6237\u76f4\u63a5\u5b89\u88c5\u4e0b\u6765\u5373\u53ef\u5f97\u5230\u4e00\u6837\u7684\u62d3\u6251\u5173\u7cfb\uff0c\u518d\u4e5f\u4e0d\u7528\u62c5\u5fc3\u627e\u4e0d\u5230\u5404\u4e2a\u670d\u52a1\u4f9d\u8d56\u7684\u7ec4\u4ef6\u3002","title":"2. \u90e8\u7f72 BookInfo \u5e94\u7528"},{"location":"chap7/k8s_isitio_gray/#3","text":"\u5728\u5b8c\u6210\u4ee5\u4e0a\u90e8\u7f72\u64cd\u4f5c\u540e\uff0c\u6211\u4eec\u5f97\u5230\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684 BookInfo \u7a0b\u5e8f\uff0c\u4f46\u6b64\u65f6\u8fd8\u672a\u5b9a\u4e49 Istio \u76f8\u5173\u914d\u7f6e\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u901a\u8fc7 Kiali \u53bb\u5b9a\u4e49\u6d41\u91cf\u89c4\u5219\u3002\u5b9e\u73b0\u7070\u5ea6\u53d1\u5e03\u3002 \u300c3.1 \u914d\u7f6e\u8def\u7531\u89c4\u5219\u300d \u8bbf\u95ee Kiali \u7ba1\u7406\u9875\u9762\uff0c\u5373\u53ef\u770b\u5230\u8be5\u5e94\u7528\u3002\u5728\u5de6\u4fa7\u8fb9\u680f\u9009\u62e9 Services\uff0c\u627e\u5230 reviews \u8fd9\u4e2a Service\uff0c\u70b9\u51fb\u8fdb\u5165\uff0c\u53f3\u4e0a\u89d2 Actions \u9009\u62e9 Traffic Shifting\uff0c\u5373\u53ef\u770b\u5230\u5982\u4e0b\u914d\u7f6e\uff1a\u62d6\u52a8\u6ed1\u5757\u9009\u62e9\u6d41\u91cf\u6bd4\u4f8b\u3002\u4e0b\u56fe\u4e2d 30% \u7684\u6d41\u91cf\u5c06\u4f1a\u8bbf\u95ee\u5230 reviews-v1 \u4e0a\uff0c70% \u7684\u6d41\u91cf\u8bbf\u95ee\u5230 reviews-v2\u4e0a\u3002\u70b9\u51fb\u521b\u5efa\u540e\uff0c\u5373\u53ef\u770b\u89c1\u9875\u9762\u5de6\u4e0b\u89d2\uff0cKiali \u81ea\u52a8\u4e3a\u4f60\u751f\u6210\u4e86 virtual services \u548c destination rules \u8d44\u6e90\u3002\u4f60\u53ef\u4ee5\u70b9\u51fb\u8fdb\u53bb\u6839\u636e\u81ea\u5df1\u9700\u6c42\u518d\u6b21\u7f16\u8f91\u3002 \u300c3.2 \u9a8c\u8bc1\u8def\u7531\u89c4\u5219\u662f\u5426\u751f\u6548\u300d \u627e\u5230\u6700\u5f00\u59cb\u90e8\u7f72\u7684\u7ec4\u4ef6 Productpage\uff0c\u8fdb\u5165\u7ec4\u4ef6\u7ba1\u7406\u9875\u9762\uff0c\u70b9\u51fb\u53f3\u4e0a\u89d2\u8bbf\u95ee\u5165\u53e3\uff0c\u53ef\u4ee5\u770b\u5230\u4e66\u7c4d\u8be6\u60c5\u548c\u8bc4\u7ea7\uff0c\u53cd\u590d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u4e0d\u5e26\u661f\u7ea7\u7684\u8bc4\u4ef7\u4fe1\u606f(reviews-v1)\u4e0e\u9ed1\u8272\u661f\u7ea7\u8bc4\u4ef7\u4fe1\u606f(reviews-v2)\u51fa\u73b0\u7684\u6bd4\u4f8b\u5927\u6982\u662f 3:7\u3002\u7ea2\u8272\u661f\u7ea7\u8bc4\u4ef7\u4fe1\u606f(reviews-v3)\u4ece\u672a\u51fa\u73b0\u3002 \u300c3.3 \u9a8c\u8bc1\u7ec4\u4ef6\u6269\u5bb9\u5bf9\u6d41\u91cf\u7684\u5f71\u54cd\u300d \u627e\u5230\u90e8\u7f72\u7684\u7ec4\u4ef6 reviews-v1 \uff0c\u8fdb\u5165\u7ec4\u4ef6\u7ba1\u7406\u9875\u9762 -> \u4f38\u7f29 -> \u5b9e\u4f8b\u6570\u91cf\u8bbe\u7f6e\u4e3a4\uff0c\u6b64\u65f6\u518d\u6b21\u8bbf\u95ee Productpage \u9875\u9762\uff0c\u53cd\u590d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230 reviews-v1 \u6269\u5bb9\u540e\uff0c\u8bbf\u95ee\u5230 reviews-v1 \u4e0e reviews-v2 \u7684\u6bd4\u4f8b\u4ecd\u4e3a 3:7\uff0c\u7ec4\u4ef6\u5b9e\u4f8b\u6570\u7684\u591a\u5c11\u5bf9\u6d41\u91cf\u5206\u53d1\u7b56\u7565\u6ca1\u6709\u5f71\u54cd\u3002","title":"3. \u7070\u5ea6\u53d1\u5e03"},{"location":"chap8/10Istio_terms/","text":"\u7b2c\u5341\u8282 \u672f\u8bed\u8868 1\u3001\u5bb9\u5668\uff0f\u5bb9\u5668\u955c\u50cf \u5bb9\u5668\u5c06\u4f60\u7684\u4ee3\u7801\u548c\u6240\u6709\u7684\u4f9d\u8d56\u5173\u7cfb\u6253\u5305\u3002\u8fd9\u4f7f\u5f97\u5f97\u5bb9\u5668\u5316\u7684\u5e94\u7528\u7a0b\u5e8f\u80fd\u5668\u66f4\u5feb\uff0c\u66f4\u53ef\u9760\u5730\u8fd0\u884c\u800c\u4e0d\u53d7\u8ba1\u7b97\u673a\u5468\u73af\u5883\u7684\u5f71\u54cd\u3002\u5bb9\u5668\u9540\u50cf\u662f\u4e2a\u8f7b\u91cf\u7ea7\u7684\u72ec\u7acb\u7684\u53ef\u6267\u884c\u7684\u8f6f\u4ef6\u5305\u5305\u62ec\u8fd0\u884c\u5e94\u7528\uff0c\u7a0b\u5e8f\u6240\u9700\u7684\u4e00\u5207\uff1a \u4ee3\u7801\uff0c\u5de5\u5177\uff0c\u7cfb\u7edf\u5e93\u548c\u8bbe\u7f6e 2\u3001\u63a7\u5236\u5e73\u9762 \u670d\u52a1\u7f51\u683c\u4e2d\u7684\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\u914d\u7f6e\u5e76\u63a7\u5236\u6570\u636e\u5e73\u9762\u3002 \u5b83\u7531API\u548c\u5de5\u5177\u7ec4\u6210\u7528\u4e8e\u7ba1\u7406\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002 \u670d\u52a1\u7f51\u683c\u8fd0\u7ef4\u53ef\u4ee5\u8bbf\u95ee\u63a7\u5236\u5e73\u9762\u4ee5\u914d\u7f6e\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002\u4f8b\u5982\uff0c\u5c06\u6d41\u91cf\u914d\u7f6e\u5e94\u7528\u4e8e\u63a7\u5236\u5e73\u9762\u7ffb\u8bd1\u914d\u7f6e\u5e76\u5c06\u5176\u63a8\u9001\u5230\u6570\u636e\u5e73\u9762 3\u3001\u6570\u636e\u5e73\u9762 \u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531\u8d1f\u8d23\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u53d1\u73b0\u3001\u5065\u5eb7\u68c0\u67e5\u548c\u6388\u6743/\u8ba4\u8bc1\u7684Envoy\u4ee3\u7406\u3002\u8fd9\u4e9b\u4ee3\u7406\u6bcf\u4e2a\u5b9e\u4f8b\u670d\u52a1\u5b9e\u4f8b\u8981\u8fb9\u8fd0\u884c\uff0c\u62e6\u622a\u6240\u6709\u4f20\u5165\u548c\u4f20\u51fa\u7684\u7528\u6237\u6d41\u91cf 4\u3001Envoy Envoy\u4ee3\u7406\u662f\u4e2a\u73b0\u4ee3\u7684\u3001\u9ad8\u6027\u80fd\u8fb9\u7f18\u7684\u3001\u5c0f\u578b\u7684L7\u4ee3\u7406\u3002Envoy\u662f\u4e3a\u5927\u578b\u73b0\u4ee3\u9762\u5411\u670d\u52a1\u67b6\u6784\u8bbe\u8ba1\u7684\u3002\u5b83\u53ef\u4ee5\u4e0eNginx\u548cHAproxy\u7b49\u8f6f\u4ef6\u8d1f\u622a\u5747\u8857\u5668\u76f8\u5ab2\u7f8e\u3002 5\u3001\u5fae\u670d\u52a1 \u5fae\u670d\u52a1\u6216\u5fae\u670d\u52a1\u67b6\u6784\u662f\u4e00\u79cd\u67b6\u6784\u98ce\u683c\u3002\u5b83\u5c06\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6784\u5efa\u4e3a\u670d\u52a1\u7684\u96c6\u5408\u3002\u677e\u6563\u8026\u5408\u7684\u5fae\u670d\u52a1\u96c6\u5408\u63d0\u4f9b\u4e86\u4e0e\u5355\u4e2a\u5355\u4f53\u5e94\u7528\u76f8\u540c\u7684\u529f\u80fd\uff0c \u4f46\u6709\u989d\u5916\u7684\u4f18\u52bf\u3002\u5fae\u670d\u52a1\u53ef\u4ee5\u62bd\u7acb\u4e8e\u5176\u4ed6\u670d\u52a1\u8fdb\u884c\u5f00\u53d1\u548c\u90e8\u7f72\u3002\u5b83\u4eec\u662f\u56f4\u7ed5\u4e1a\u52a1\u80fd\u529b\u7ec4\u7ec7\u7684\uff0c \u7531\u8f83\u5c0f\u7684\u56e2\u961f\u62e5\u6709\u3002\u5b83\u4eec\u5728\u90e8\u7f72\u5f00\u53d1\u4e2d\u66f4\u5c0f\u3001\u66f4\u72ec\u7acb\u53ef\u4ee5\u66f4\u597d\u5730\u7ef4\u62a4\u548c\u6d4b\u8bd5 6\u3001\u4ee3\u7406 \u5728\u7f51\u7edc\u4e2d\uff0c\u4ee3\u7406\u670d\u52a1\u5668\u4f5c\u4e3a\u4e24\u65b9\u4e4b\u95f4\u7684\u4e00\u4e2a\u7f51\u5173\u3002\u5b83\u662f\u4e00\u4e2a\u4e2d\u95f4\u670d\u52a1\u5668\u4f4d\u5e72\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4e4b\u95f4\uff0c\u53ef\u4ee5\u7ba1\u7406\u8bf7\u6c42\u548c\u54cd\u5e94\u3002\u5728\u670d\u52a1\u7f51\u683c\u7684\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u4ee3\u7406(Envoy\uff09\u5728\u6bcf\u4e2a\u5e94\u7528\u5b9e\u4f8b\u524d\u9762\u8fd0\u884c \u5f53\u4f60\u5411\u5e94\u7528\u7a0b\u5e8f\u53d1\u51fa\u8bf7\u6c42\u65f6\uff0c\u4ee3\u7406\u62e6\u622a\u8be5\u8c13\u6c42\u5e76\u5c06\u5176\u8f6c\u53d1\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5b9e\u4f8b\u3002\u540c\u6837\u5730\uff0c\u5f53\u7a0b\u5e8f\u8bd5\u56fe\u53d1\u51fa\u8bf7\u5f55\u65f6\uff0c\u4ee3\u7406\u62e6\u622a\u51fa\u7ad9\u8c13\u6c42\u5e76\u5c06\u5176\u53d1\u8fed\u5230\u76ee\u7684\u5730\u3002\u7531\u4e8e\u4ee3\u7406\u62e6\u622a\u4e86\u6240\u6709\u7684\u6d41\u91cf\u3002 \u5b83\u4e5f\u53ef\u4ee5\u4fee\u6539\u8bf7\u6c42\u2014\u2014\u8fd9\u4f7f\u5f97\u6d41\u91cf\u8def\u7531\uff0c\u6545\u969c\u6ce8\u5165\u548c\u6388\u6743\u7b49\u529f\u80fd\u5f97\u4ee5\u5b9e\u73b0 7\u3001L7\u4ee3\u7406 L7(\u7b2c\u4e03\u5c42)\u4ee3\u7406\u5728OSI\u5f15\u6a21\u578b\u7684\u5e94\u7528\u5c42\u5de5\u4f5c\u3002\u5728\u8fd9\u4e00\u5c42\u4ee3\u7406\u53ef\u4ee5\u5916\u56db\u6bcf\u4e2a\u8bf7\u6c42\u7684\u5185\u5bb9\u3002\u4e00\u4e2a\u6d41\u884c\u7684L7\u534f\u8bae\u662fHTTP,\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u8bbf\u95ee\u8c13\u6c42\u7684\u6570\u636e\uff0cL7\u4ee3\u7406\u53ef\u4ee5\u6839\u636e\u8c13\u6c42\u5185\u5bb9(URL\u3001cookies)\u505a\u51fa\u8d1f\u8f7d\u5747\u8861\u7684\u51b3\u5b9a","title":"\u7b2c\u5341\u8282 \u672f\u8bed\u8868"},{"location":"chap8/10Istio_terms/#_1","text":"","title":"\u7b2c\u5341\u8282 \u672f\u8bed\u8868"},{"location":"chap8/10Istio_terms/#1","text":"\u5bb9\u5668\u5c06\u4f60\u7684\u4ee3\u7801\u548c\u6240\u6709\u7684\u4f9d\u8d56\u5173\u7cfb\u6253\u5305\u3002\u8fd9\u4f7f\u5f97\u5f97\u5bb9\u5668\u5316\u7684\u5e94\u7528\u7a0b\u5e8f\u80fd\u5668\u66f4\u5feb\uff0c\u66f4\u53ef\u9760\u5730\u8fd0\u884c\u800c\u4e0d\u53d7\u8ba1\u7b97\u673a\u5468\u73af\u5883\u7684\u5f71\u54cd\u3002\u5bb9\u5668\u9540\u50cf\u662f\u4e2a\u8f7b\u91cf\u7ea7\u7684\u72ec\u7acb\u7684\u53ef\u6267\u884c\u7684\u8f6f\u4ef6\u5305\u5305\u62ec\u8fd0\u884c\u5e94\u7528\uff0c\u7a0b\u5e8f\u6240\u9700\u7684\u4e00\u5207\uff1a \u4ee3\u7801\uff0c\u5de5\u5177\uff0c\u7cfb\u7edf\u5e93\u548c\u8bbe\u7f6e","title":"1\u3001\u5bb9\u5668\uff0f\u5bb9\u5668\u955c\u50cf"},{"location":"chap8/10Istio_terms/#2","text":"\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\u914d\u7f6e\u5e76\u63a7\u5236\u6570\u636e\u5e73\u9762\u3002 \u5b83\u7531API\u548c\u5de5\u5177\u7ec4\u6210\u7528\u4e8e\u7ba1\u7406\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002 \u670d\u52a1\u7f51\u683c\u8fd0\u7ef4\u53ef\u4ee5\u8bbf\u95ee\u63a7\u5236\u5e73\u9762\u4ee5\u914d\u7f6e\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002\u4f8b\u5982\uff0c\u5c06\u6d41\u91cf\u914d\u7f6e\u5e94\u7528\u4e8e\u63a7\u5236\u5e73\u9762\u7ffb\u8bd1\u914d\u7f6e\u5e76\u5c06\u5176\u63a8\u9001\u5230\u6570\u636e\u5e73\u9762","title":"2\u3001\u63a7\u5236\u5e73\u9762"},{"location":"chap8/10Istio_terms/#3","text":"\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531\u8d1f\u8d23\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u53d1\u73b0\u3001\u5065\u5eb7\u68c0\u67e5\u548c\u6388\u6743/\u8ba4\u8bc1\u7684Envoy\u4ee3\u7406\u3002\u8fd9\u4e9b\u4ee3\u7406\u6bcf\u4e2a\u5b9e\u4f8b\u670d\u52a1\u5b9e\u4f8b\u8981\u8fb9\u8fd0\u884c\uff0c\u62e6\u622a\u6240\u6709\u4f20\u5165\u548c\u4f20\u51fa\u7684\u7528\u6237\u6d41\u91cf","title":"3\u3001\u6570\u636e\u5e73\u9762"},{"location":"chap8/10Istio_terms/#4envoy","text":"Envoy\u4ee3\u7406\u662f\u4e2a\u73b0\u4ee3\u7684\u3001\u9ad8\u6027\u80fd\u8fb9\u7f18\u7684\u3001\u5c0f\u578b\u7684L7\u4ee3\u7406\u3002Envoy\u662f\u4e3a\u5927\u578b\u73b0\u4ee3\u9762\u5411\u670d\u52a1\u67b6\u6784\u8bbe\u8ba1\u7684\u3002\u5b83\u53ef\u4ee5\u4e0eNginx\u548cHAproxy\u7b49\u8f6f\u4ef6\u8d1f\u622a\u5747\u8857\u5668\u76f8\u5ab2\u7f8e\u3002","title":"4\u3001Envoy"},{"location":"chap8/10Istio_terms/#5","text":"\u5fae\u670d\u52a1\u6216\u5fae\u670d\u52a1\u67b6\u6784\u662f\u4e00\u79cd\u67b6\u6784\u98ce\u683c\u3002\u5b83\u5c06\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6784\u5efa\u4e3a\u670d\u52a1\u7684\u96c6\u5408\u3002\u677e\u6563\u8026\u5408\u7684\u5fae\u670d\u52a1\u96c6\u5408\u63d0\u4f9b\u4e86\u4e0e\u5355\u4e2a\u5355\u4f53\u5e94\u7528\u76f8\u540c\u7684\u529f\u80fd\uff0c \u4f46\u6709\u989d\u5916\u7684\u4f18\u52bf\u3002\u5fae\u670d\u52a1\u53ef\u4ee5\u62bd\u7acb\u4e8e\u5176\u4ed6\u670d\u52a1\u8fdb\u884c\u5f00\u53d1\u548c\u90e8\u7f72\u3002\u5b83\u4eec\u662f\u56f4\u7ed5\u4e1a\u52a1\u80fd\u529b\u7ec4\u7ec7\u7684\uff0c \u7531\u8f83\u5c0f\u7684\u56e2\u961f\u62e5\u6709\u3002\u5b83\u4eec\u5728\u90e8\u7f72\u5f00\u53d1\u4e2d\u66f4\u5c0f\u3001\u66f4\u72ec\u7acb\u53ef\u4ee5\u66f4\u597d\u5730\u7ef4\u62a4\u548c\u6d4b\u8bd5","title":"5\u3001\u5fae\u670d\u52a1"},{"location":"chap8/10Istio_terms/#6","text":"\u5728\u7f51\u7edc\u4e2d\uff0c\u4ee3\u7406\u670d\u52a1\u5668\u4f5c\u4e3a\u4e24\u65b9\u4e4b\u95f4\u7684\u4e00\u4e2a\u7f51\u5173\u3002\u5b83\u662f\u4e00\u4e2a\u4e2d\u95f4\u670d\u52a1\u5668\u4f4d\u5e72\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4e4b\u95f4\uff0c\u53ef\u4ee5\u7ba1\u7406\u8bf7\u6c42\u548c\u54cd\u5e94\u3002\u5728\u670d\u52a1\u7f51\u683c\u7684\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u4ee3\u7406(Envoy\uff09\u5728\u6bcf\u4e2a\u5e94\u7528\u5b9e\u4f8b\u524d\u9762\u8fd0\u884c \u5f53\u4f60\u5411\u5e94\u7528\u7a0b\u5e8f\u53d1\u51fa\u8bf7\u6c42\u65f6\uff0c\u4ee3\u7406\u62e6\u622a\u8be5\u8c13\u6c42\u5e76\u5c06\u5176\u8f6c\u53d1\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5b9e\u4f8b\u3002\u540c\u6837\u5730\uff0c\u5f53\u7a0b\u5e8f\u8bd5\u56fe\u53d1\u51fa\u8bf7\u5f55\u65f6\uff0c\u4ee3\u7406\u62e6\u622a\u51fa\u7ad9\u8c13\u6c42\u5e76\u5c06\u5176\u53d1\u8fed\u5230\u76ee\u7684\u5730\u3002\u7531\u4e8e\u4ee3\u7406\u62e6\u622a\u4e86\u6240\u6709\u7684\u6d41\u91cf\u3002 \u5b83\u4e5f\u53ef\u4ee5\u4fee\u6539\u8bf7\u6c42\u2014\u2014\u8fd9\u4f7f\u5f97\u6d41\u91cf\u8def\u7531\uff0c\u6545\u969c\u6ce8\u5165\u548c\u6388\u6743\u7b49\u529f\u80fd\u5f97\u4ee5\u5b9e\u73b0","title":"6\u3001\u4ee3\u7406"},{"location":"chap8/10Istio_terms/#7l7","text":"L7(\u7b2c\u4e03\u5c42)\u4ee3\u7406\u5728OSI\u5f15\u6a21\u578b\u7684\u5e94\u7528\u5c42\u5de5\u4f5c\u3002\u5728\u8fd9\u4e00\u5c42\u4ee3\u7406\u53ef\u4ee5\u5916\u56db\u6bcf\u4e2a\u8bf7\u6c42\u7684\u5185\u5bb9\u3002\u4e00\u4e2a\u6d41\u884c\u7684L7\u534f\u8bae\u662fHTTP,\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u8bbf\u95ee\u8c13\u6c42\u7684\u6570\u636e\uff0cL7\u4ee3\u7406\u53ef\u4ee5\u6839\u636e\u8c13\u6c42\u5185\u5bb9(URL\u3001cookies)\u505a\u51fa\u8d1f\u8f7d\u5747\u8861\u7684\u51b3\u5b9a","title":"7\u3001L7\u4ee3\u7406"},{"location":"chap8/1service_mesh/","text":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8 1\u3001\u670d\u52a1\u7f51\u683c\u6982\u8ff0 Service Mesh Dedicated infrastructure layer for managing service-to-service communication to make it manageable, visible, and controlled. Communication logic move out of the service Infrastructure layer = array of network proxies Network proxies deal with all communication between srvices Why Do I need Service Mesh Mutual TLS and automatic certificate rotation Identify performance and reliability issues using metrics Visualize metrics Debug services and tracing Traffic routing and mirroring Chaos testing Circuit breakers \u670d\u52a1\u7f51\u683c\u6240\u505a\u7684\u662f\uff0c\u5b83\u5c06\u8fd9\u79cd\u901a\u4fe1\u903b\u8f91\u3001\u91cd\u8bd5\u3001\u8d85\u65f6\u7b49\u4ece\u5355\u4e2a\u670d\u52a1\u4e2d\u5206\u79bb\u51fa\u6765\uff0c\u5e76\u5c06\u5176\u79fb\u5230\u4e00\u4e2a\u5355\u72ec\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\u3002 \u5728\u670d\u52a1\u7f51\u683c\u7684\u60c5\u51b5\u4e0b\uff0c\u57fa\u7840\u8bbe\u65bd\u5c42\u662f\u4e00\u4e2a\u7f51\u7edc\u4ee3\u7406\u7684\u9635\u5217\u3002\u8fd9\u4e9b\u7f51\u7edc\u4ee3\u7406\u7684\u96c6\u5408\uff08\u6bcf\u4e2a\u670d\u52a1\u5b9e\u4f8b\u65c1\u8fb9\u90fd\u6709\u4e00\u4e2a\uff09\u5904\u7406\u4f60\u7684\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u903b\u8f91\u3002\u6211\u4eec\u79f0\u8fd9\u4e9b\u4ee3\u7406 \u4e3asidecar\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0e\u6bcf\u4e2a\u670d\u52a1\u5e76\u5b58\u3002 \u4e3a\u4ec0\u4e48\u9700\u8981\u670d\u52a1\u7f51\u683c \u670d\u52a1\u7f51\u683c\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u79cd\u4e00\u81f4\u7684\u65b9\u5f0f\u6765\u8fde\u63a5\u3001\u4fdd\u62a4\u548c\u89c2\u5bdf\u5fae\u670d\u52a1\u3002\u7f51\u683c\u5185\u7684\u4ee3\u7406\u6355\u83b7\u4e86\u7f51\u683c \u5185\u6240\u6709\u901a\u4fe1\u7684\u8bf7\u6c42\u548c\u6307\u6807\u3002\u6bcf\u4e00\u6b21\u5931\u8d25\u3001\u6bcf\u4e00\u6b21\u6210\u529f\u7684\u8c03\u7528\u3001\u91cd\u8bd5\u6216\u8d85\u65f6\u90fd\u53ef\u4ee5\u88ab\u6355\u83b7\u3001\u53ef\u89c6\u5316\uff0c\u5e76\u53d1\u51fa\u8b66\u62a5\u3002\u6b64\u5916\uff0c\u53ef\u4ee5\u6839\u636e\u8bf7\u6c42\u5c5e\u6027\u505a\u51fa\u51b3\u5b9a\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u67e5\u5165\u7ad9\uff08\u6216\u51fa\u7ad9\uff09\u8bf7\u6c42\u5e76\u7f16\u5199\u89c4\u5219\uff0c\u5c06\u6240\u6709\u5177\u6709\u7279\u5b9a\u5934\u503c\u7684\u8bf7\u6c42\u8def\u7531\u5230\u4e0d\u540c\u7684\u670d\u52a1\u7248\u672c\u3002 \u6240\u6709\u8fd9\u4e9b\u4fe1\u606f\u548c\u6536\u96c6\u5230\u7684\u6307\u6807\u4f7f\u5f97\u4e00\u4e9b\u573a\u666f\u53ef\u4ee5\u5408\u7406\u5730\u76f4\u63a5\u5b9e\u73b0\u3002\u5f00\u53d1\u4eba\u5458\u548c\u8fd0\u8425\u5546\u53ef\u4ee5\u914d\u7f6e\u548c\u6267\u884c\u4ee5\u4e0b\u65b9\u6848\uff0c\u800c\u4e0d\u9700\u8981\u5bf9\u670d\u52a1\u8fdb\u884c\u4efb\u4f55\u4ee3\u7801\u4fee\u6539\u3002 mTLS\u548c\u81ea\u52a8\u8bc1\u4e66\u8f6e\u6362 \u4f7f\u7528\u6307\u6807\u8bc6\u522b\uff0c\u6027\u80fd\u548c\u53ef\u9760\u6027\u95ee\u9898 \u5728Grafana\u7b49\u5de5\u5177\u4e2d\u5b9e\u73b0\u6307\u6807\u7684\u53ef\u89c6\u5316\uff1b\u8fd9\u8fdb\u4e00\u6b65\u5141\u8bb8\u6539\u53d8\u5e76\u4e0ePagerDuty\u6574\u5408 \u4f7f\u7528Jaeger\u6216Zipkin\u5bf9\u670d\u52a1\u8fdb\u884c\u8c03\u8bd5\u548c\u8ffd\u8e2a \u57fa\u4e8e\u6743\u91cd\u548c\u8bf7\u6c42\u7684\u6d41\u91cf\u8def\u7531\uff0c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0cA/B\u6d4b\u8bd5 \u6d41\u91cf\u955c\u50cf \u901a\u8fc7\u8d85\u65f6\u548c\u91cd\u8bd5\u63d0\u9ad8\u670d\u52a1\u7684\u5f39\u6027 \u901a\u8fc7\u5728\u670d\u52a1\u4e4b\u95f4\u6ce8\u5165\u6545\u969c\u548c\u5ef6\u8fdf\u6765\u8fdb\u884c\u6df7\u6c8c\u6d4b\u8bd5 \u68c0\u6d4b\u548c\u5f39\u51fa\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u5b9e\u4f8b\u7684\u65ad\u8def\u5668\u3002 2\u3001Istio \u7b80\u4ecb Istio Features Traffic management Control flow of traffic between service Circuit breakers, timeouts, and retries Observability Tracing, monitoring, and logging Security Authentication, authorization, and encryption Enforce policies Envoy (data plane) High-performance proxy (C++) Injected next to application containers Intercepts all traffic for the service Pluggable extension model based on WebAssembly Istiod (control plane) Service discovery Configuration Certificate management Converts YAML to Envoy-readable configuration propagates it to all sidecars in the mesh Istlo\u7b80\u4ecb Istio\u662f\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\u7684\u5f00\u6e90\u5b9e\u73b0\u3002\u4ece\u5b8f\u89c2\u4e0a\u6765\u770bIstio\u652f\u6301\u4ee5\u4e0b\u529f\u80fd\u3002 1\uff0e\u6d41\u91cf\u7ba1\u7406 \u5229\u7528\u914d\u7f6e\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u670d\u52a1\u95f4\u7684\u6d41\u91cf\u3002\u8bbe\u7f6e\u65ad\u8def\u5668\u3001\u8d85\u65f6\u6216\u91cd\u8bd5\u90fd\u53ef\u4ee5\u901a\u8fc7\u7b80\u5355\u7684\u914d\u7f6e\u6539\u53d8 \u6765\u5b8c\u6210\u3002 2\uff0e\u53ef\u89c2\u5bdf\u6027 Istio\u901a\u8fc7\u8ddf\u8e2a\u3001\u76d1\u63a7\u548c\u8bb0\u5f55\u8ba9\u6211\u4eec\u66f4\u597d\u5730\u4e86\u89e3\u670d\u52a1\uff0c\u8ba9\u6211\u4eec\u80fd\u591f\u5feb\u901f\u53d1\u73b0\u548c\u4fee\u590d\u95ee\u9898\u3002 3\uff0e\u5b89\u5168\u6027 Istio\u53ef\u4ee5\u5728\u4ee3\u7406\u5c42\u9762\u4e0a\u7ba1\u7406\u8ba4\u8bc1\u3001\u6388\u6743\u548c\u901a\u4fe1\u7684\u52a0\u5bc6\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5feb\u901f\u7684\u914d\u7f6e\u53d8\u66f4\u5728\u5404\u4e2a\u670d \u52a1\u4e2d\u6267\u884c\u7b56\u7565\u3002 Istio\u7ec4\u4ef6 Istio\u670d\u52a1\u7f51\u683c\u6709\u4e24\u4e2a\u90e8\u5206\uff1a \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 \u3002 \u5728\u6784\u5efa\u5206\u5e03\u5f0f\u7cfb\u7edf\u65f6\uff0c\u5c06\u7ec4\u4ef6\u5206\u79bb\u6210\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u662f\u4e00\u79cd\u5e38\u89c1\u7684\u6a21\u5f0f\u3002 \u6570\u636e\u5e73\u9762\u7684\u7ec4\u4ef6\u5728\u8bf7\u6c42\u8def\u5f84\u4e0a\uff0c\u800c\u63a7\u5236\u5e73\u9762\u7684\u7ec4\u4ef6\u5219\u5e2e\u52a9\u6570\u636e\u5e73\u9762\u5b8c\u6210\u5176\u5de5\u4f5c\u3002 Istio\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531Envoy\u4ee3\u7406\u7ec4\u6210\uff0c\u63a7\u5236\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u3002\u7f51\u683c\u7684\u63a7\u5236\u5e73\u9762\u90e8\u5206\u8d1f\u8d23\u7ba1\u7406\u4e0d\u53e3\u914d\u7f6e\u4ee3\u7406\u3002 Envoy\uff08\u6570\u636e\u5e73\u9762\uff09 Envoy\u662f\u4e00\u4e2a\u7528C+\uff0b\u5f00\u53d1\u7684\u9ad8\u6027\u80fd\u4ee3\u7406\u3002Istio\u670d\u52a1\u7f51\u683c\u5c06Envoy\u4ee3\u7406\u4f5c\u4e3a\u4e00\u4e2a sidecar\u5bb9\u5668\u6ce8\u5165\u5230\u4f60\u7684\u5e94\u7528\u5bb9\u5668\u65c1\u8fb9\u3002\u7136\u540e\u8be5\u4ee3\u7406\u62e6\u622a\u8be5\u670d\u52a1\u7684\u6240\u6709\u5165\u7ad9\u548c\u51fa\u7ad9 \u6d41\u91cf\u3002\u6ce8\u5165\u7684\u4ee3\u7406\u4e00\u8d77\u6784\u6210\u4e86\u670d\u52a1\u7f51\u683c\u7684\u6570\u636e\u5e73\u9762\u3002 Envoy\u4ee3\u7406\u4e5f\u662f\u552f\u4e00\u4e0e\u6d41\u91cf\u8fdb\u884c\u4ea4\u4e92\u7684\u7ec4\u4ef6\u3002\u9664\u4e86\u524d\u9762\u63d0\u5230\u7684\u529f\u80fd\u2015\u8d1f\u8f7d\u5747\u8861\u3001\u65ad\u8def\u5668\u3001\u6545\u969c\u6ce8\u5165\u7b49\u3002Envoy\u8fd8\u652f\u6301\u57fa\u4e8eWebAssembly (WASM\uff09\u7684\u53ef\u63d2\u62d4\u6269\u5c55\u6a21\u578b\u3002\u8fd9\u79cd\u53ef\u6269\u5c55\u6027\u4f7f\u6211\u4eec\u80fd\u591f\u6267\u884c\u81ea\u5b9a\u4e49\u7b56\u7565\uff0c\u5e76\u4e3a\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\u751f\u6210\u9065\u6d4b\u6570\u636e\u3002 Istiod\uff08\u63a7\u5236\u5e73\u9762) Istiod\u662f\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\uff0c\u63d0\u4f9b\u670d\u52a1\u53d1\u73b0\u3001\u914d\u7f6e\u548c\u8bc1\u4e66\u7ba1\u7406\u529f\u80fd\u3002 Istiod\u91c7\u7528YAML\u7f16\u5199\u7684\u9ad8\u7ea7\u89c4\u5219\uff0c\u5e76\u5c06\u5176\u8f6c\u6362\u4e3aEnvoy\u7684\u53ef\u64cd\u4f5c\u914d\u7f6e\u3002\u7136\u540e\uff0c\u5b83\u628a\u8fd9\u4e2a\u914d\u7f6e\u4f20\u64ad\u7ed9 \u7f51\u683c\u4e2d\u7684\u6240\u6709sidecar Istiod\u5185\u90e8\u7684Pilot\u7ec4\u4ef6\u62bd\u8c61\u51fa\u7279\u5b9a\u5e73\u53f0\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236 \uff08Kubernetes\u3001 Consul \u6216VM)\uff0c\u5e76\u5c06\u5176\u8f6c\u6362\u4e3asidecar\u53ef\u4ee5\u4f7f\u7528\u7684\u6807\u51c6\u683c\u5f0f\u3002 \u4f7f\u7528\u5185\u7f6e\u7684\u8eab\u4efd\u548c\u51ed\u8bc1\u7ba1\u7406\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9e\u73b0\u5f3a\u5927\u7684\u670d\u52a1\u95f4\u548c\u7ec8\u7aef\u7528\u6237\u8ba4\u8bc1\u3002\u901a\u8fc7\u6388 \u6743\u529f\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u8c01\u53ef\u4ee5\u8bbf\u95ee\u670d\u52a1\u3002 \u63a7\u5236\u5e73\u9762\u7684\u90e8\u5206\u4ee5\u524d\u88ab\u79f0\u4e3aCitadel\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u8bc1\u4e66\u6388\u6743\u673a\u6784\uff0c\u751f\u6210\u8bc1\u4e66\uff0c\u5141\u8bb8\u6570\u636e\u5e73\u9762\u4e2d\u7684\u4ee3\u7406\u4e4b\u95f4\u8fdb\u884c\u5b89\u5168\u7684mTLS\u901a\u4fe1 \u3002 3\u3001\u6d4b\u9a8c\uff1a\u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8 1.\u670d\u52a1\u7f51\u683c\u5982\u4f55\u5e2e\u52a9\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u903b\u8f91\uff1f A \u964d\u4f4e\u5ef6\u8fdf B \u53ef\u4ee5\u8ba9\u4f60\u66f4\u5feb\u7684\u4f38\u7f29\u670d\u52a1 C \u5c06\u903b\u8f91\u5206\u79bb\u5230\u57fa\u7840\u5b9e\u65bd\u5c42 D \u8ba9\u90e8\u7f72\u66f4\u52a0\u8fc5\u901f 2.\u4ece\u5b8f\u89c2\u4e0a\u770b\uff0cIstio\u670d\u52a1\u7f51\u683c\u7531\u54ea\u4e24\u90e8\u5206\u7ec4\u6210\uff1f \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 Istio Pilot\u548cEnvoy \u6570\u636e\u5e73\u9762\u548cEnvoy\u4ee3\u7406 Envoy\u4ee3\u7406\u548c\u914d\u7f6e 3.\u670d\u52a1\u7f51\u683c\u7684\u4ee3\u7406\u4e5f\u53eb\u505a\u4ec0\u4e48\uff1f A Ambassador B Adapter C Interface D Sidecar 4.Istio\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531\u7528\u6237\u7684\u670d\u52a1\u7ec4\u6210\u3002\u5bf9\u8fd8\u662f\u9519\uff1f \u5bf9 \u9519 6.Istio\u4e2d\u7684\u54ea\u4e2a\u7ec4\u4ef6\u53ef\u4ee5\u5c06YAML\u89c4\u5219\u8f6c\u6362\u4e3aEnvoy\u914d\u7f6e\uff1f A Envoy B Istiod C Sidecar D Citadel 7.\u4ece\u4e0b\u9762\u7684\u5217\u8868\u4e2d\u9009\u51fa\u5fae\u670d\u52a1\u67b6\u6784\u7684\u4e24\u4e2a\u597d\u5904\uff1f A \u53ef\u4f38\u7f29\u6027 B \u66f4\u5c0f\u7684\u56e2\u961f C \u7b80\u5316\u670d\u52a1\u4e4b\u95f4\u7684\u6c9f\u901a D \u4fbf\u4e8e\u8c03\u8bd5 E \u4fbf\u4e8e\u6d4b\u8bd5","title":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8"},{"location":"chap8/1service_mesh/#istio","text":"","title":"\u7b2c\u4e00\u8282 \u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8"},{"location":"chap8/1service_mesh/#1","text":"Service Mesh Dedicated infrastructure layer for managing service-to-service communication to make it manageable, visible, and controlled. Communication logic move out of the service Infrastructure layer = array of network proxies Network proxies deal with all communication between srvices Why Do I need Service Mesh Mutual TLS and automatic certificate rotation Identify performance and reliability issues using metrics Visualize metrics Debug services and tracing Traffic routing and mirroring Chaos testing Circuit breakers \u670d\u52a1\u7f51\u683c\u6240\u505a\u7684\u662f\uff0c\u5b83\u5c06\u8fd9\u79cd\u901a\u4fe1\u903b\u8f91\u3001\u91cd\u8bd5\u3001\u8d85\u65f6\u7b49\u4ece\u5355\u4e2a\u670d\u52a1\u4e2d\u5206\u79bb\u51fa\u6765\uff0c\u5e76\u5c06\u5176\u79fb\u5230\u4e00\u4e2a\u5355\u72ec\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\u3002 \u5728\u670d\u52a1\u7f51\u683c\u7684\u60c5\u51b5\u4e0b\uff0c\u57fa\u7840\u8bbe\u65bd\u5c42\u662f\u4e00\u4e2a\u7f51\u7edc\u4ee3\u7406\u7684\u9635\u5217\u3002\u8fd9\u4e9b\u7f51\u7edc\u4ee3\u7406\u7684\u96c6\u5408\uff08\u6bcf\u4e2a\u670d\u52a1\u5b9e\u4f8b\u65c1\u8fb9\u90fd\u6709\u4e00\u4e2a\uff09\u5904\u7406\u4f60\u7684\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u903b\u8f91\u3002\u6211\u4eec\u79f0\u8fd9\u4e9b\u4ee3\u7406 \u4e3asidecar\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0e\u6bcf\u4e2a\u670d\u52a1\u5e76\u5b58\u3002","title":"1\u3001\u670d\u52a1\u7f51\u683c\u6982\u8ff0"},{"location":"chap8/1service_mesh/#_1","text":"\u670d\u52a1\u7f51\u683c\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u79cd\u4e00\u81f4\u7684\u65b9\u5f0f\u6765\u8fde\u63a5\u3001\u4fdd\u62a4\u548c\u89c2\u5bdf\u5fae\u670d\u52a1\u3002\u7f51\u683c\u5185\u7684\u4ee3\u7406\u6355\u83b7\u4e86\u7f51\u683c \u5185\u6240\u6709\u901a\u4fe1\u7684\u8bf7\u6c42\u548c\u6307\u6807\u3002\u6bcf\u4e00\u6b21\u5931\u8d25\u3001\u6bcf\u4e00\u6b21\u6210\u529f\u7684\u8c03\u7528\u3001\u91cd\u8bd5\u6216\u8d85\u65f6\u90fd\u53ef\u4ee5\u88ab\u6355\u83b7\u3001\u53ef\u89c6\u5316\uff0c\u5e76\u53d1\u51fa\u8b66\u62a5\u3002\u6b64\u5916\uff0c\u53ef\u4ee5\u6839\u636e\u8bf7\u6c42\u5c5e\u6027\u505a\u51fa\u51b3\u5b9a\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u67e5\u5165\u7ad9\uff08\u6216\u51fa\u7ad9\uff09\u8bf7\u6c42\u5e76\u7f16\u5199\u89c4\u5219\uff0c\u5c06\u6240\u6709\u5177\u6709\u7279\u5b9a\u5934\u503c\u7684\u8bf7\u6c42\u8def\u7531\u5230\u4e0d\u540c\u7684\u670d\u52a1\u7248\u672c\u3002 \u6240\u6709\u8fd9\u4e9b\u4fe1\u606f\u548c\u6536\u96c6\u5230\u7684\u6307\u6807\u4f7f\u5f97\u4e00\u4e9b\u573a\u666f\u53ef\u4ee5\u5408\u7406\u5730\u76f4\u63a5\u5b9e\u73b0\u3002\u5f00\u53d1\u4eba\u5458\u548c\u8fd0\u8425\u5546\u53ef\u4ee5\u914d\u7f6e\u548c\u6267\u884c\u4ee5\u4e0b\u65b9\u6848\uff0c\u800c\u4e0d\u9700\u8981\u5bf9\u670d\u52a1\u8fdb\u884c\u4efb\u4f55\u4ee3\u7801\u4fee\u6539\u3002 mTLS\u548c\u81ea\u52a8\u8bc1\u4e66\u8f6e\u6362 \u4f7f\u7528\u6307\u6807\u8bc6\u522b\uff0c\u6027\u80fd\u548c\u53ef\u9760\u6027\u95ee\u9898 \u5728Grafana\u7b49\u5de5\u5177\u4e2d\u5b9e\u73b0\u6307\u6807\u7684\u53ef\u89c6\u5316\uff1b\u8fd9\u8fdb\u4e00\u6b65\u5141\u8bb8\u6539\u53d8\u5e76\u4e0ePagerDuty\u6574\u5408 \u4f7f\u7528Jaeger\u6216Zipkin\u5bf9\u670d\u52a1\u8fdb\u884c\u8c03\u8bd5\u548c\u8ffd\u8e2a \u57fa\u4e8e\u6743\u91cd\u548c\u8bf7\u6c42\u7684\u6d41\u91cf\u8def\u7531\uff0c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0cA/B\u6d4b\u8bd5 \u6d41\u91cf\u955c\u50cf \u901a\u8fc7\u8d85\u65f6\u548c\u91cd\u8bd5\u63d0\u9ad8\u670d\u52a1\u7684\u5f39\u6027 \u901a\u8fc7\u5728\u670d\u52a1\u4e4b\u95f4\u6ce8\u5165\u6545\u969c\u548c\u5ef6\u8fdf\u6765\u8fdb\u884c\u6df7\u6c8c\u6d4b\u8bd5 \u68c0\u6d4b\u548c\u5f39\u51fa\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u5b9e\u4f8b\u7684\u65ad\u8def\u5668\u3002","title":"\u4e3a\u4ec0\u4e48\u9700\u8981\u670d\u52a1\u7f51\u683c"},{"location":"chap8/1service_mesh/#2istio","text":"","title":"2\u3001Istio \u7b80\u4ecb"},{"location":"chap8/1service_mesh/#istio-features","text":"Traffic management Control flow of traffic between service Circuit breakers, timeouts, and retries Observability Tracing, monitoring, and logging Security Authentication, authorization, and encryption Enforce policies","title":"Istio Features"},{"location":"chap8/1service_mesh/#envoy-data-plane","text":"High-performance proxy (C++) Injected next to application containers Intercepts all traffic for the service Pluggable extension model based on WebAssembly","title":"Envoy (data plane)"},{"location":"chap8/1service_mesh/#istiod-control-plane","text":"Service discovery Configuration Certificate management Converts YAML to Envoy-readable configuration propagates it to all sidecars in the mesh","title":"Istiod (control plane)"},{"location":"chap8/1service_mesh/#istlo","text":"Istio\u662f\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\u7684\u5f00\u6e90\u5b9e\u73b0\u3002\u4ece\u5b8f\u89c2\u4e0a\u6765\u770bIstio\u652f\u6301\u4ee5\u4e0b\u529f\u80fd\u3002 1\uff0e\u6d41\u91cf\u7ba1\u7406 \u5229\u7528\u914d\u7f6e\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u670d\u52a1\u95f4\u7684\u6d41\u91cf\u3002\u8bbe\u7f6e\u65ad\u8def\u5668\u3001\u8d85\u65f6\u6216\u91cd\u8bd5\u90fd\u53ef\u4ee5\u901a\u8fc7\u7b80\u5355\u7684\u914d\u7f6e\u6539\u53d8 \u6765\u5b8c\u6210\u3002 2\uff0e\u53ef\u89c2\u5bdf\u6027 Istio\u901a\u8fc7\u8ddf\u8e2a\u3001\u76d1\u63a7\u548c\u8bb0\u5f55\u8ba9\u6211\u4eec\u66f4\u597d\u5730\u4e86\u89e3\u670d\u52a1\uff0c\u8ba9\u6211\u4eec\u80fd\u591f\u5feb\u901f\u53d1\u73b0\u548c\u4fee\u590d\u95ee\u9898\u3002 3\uff0e\u5b89\u5168\u6027 Istio\u53ef\u4ee5\u5728\u4ee3\u7406\u5c42\u9762\u4e0a\u7ba1\u7406\u8ba4\u8bc1\u3001\u6388\u6743\u548c\u901a\u4fe1\u7684\u52a0\u5bc6\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5feb\u901f\u7684\u914d\u7f6e\u53d8\u66f4\u5728\u5404\u4e2a\u670d \u52a1\u4e2d\u6267\u884c\u7b56\u7565\u3002","title":"Istlo\u7b80\u4ecb"},{"location":"chap8/1service_mesh/#istio_1","text":"Istio\u670d\u52a1\u7f51\u683c\u6709\u4e24\u4e2a\u90e8\u5206\uff1a \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 \u3002 \u5728\u6784\u5efa\u5206\u5e03\u5f0f\u7cfb\u7edf\u65f6\uff0c\u5c06\u7ec4\u4ef6\u5206\u79bb\u6210\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u662f\u4e00\u79cd\u5e38\u89c1\u7684\u6a21\u5f0f\u3002 \u6570\u636e\u5e73\u9762\u7684\u7ec4\u4ef6\u5728\u8bf7\u6c42\u8def\u5f84\u4e0a\uff0c\u800c\u63a7\u5236\u5e73\u9762\u7684\u7ec4\u4ef6\u5219\u5e2e\u52a9\u6570\u636e\u5e73\u9762\u5b8c\u6210\u5176\u5de5\u4f5c\u3002 Istio\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531Envoy\u4ee3\u7406\u7ec4\u6210\uff0c\u63a7\u5236\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u3002\u7f51\u683c\u7684\u63a7\u5236\u5e73\u9762\u90e8\u5206\u8d1f\u8d23\u7ba1\u7406\u4e0d\u53e3\u914d\u7f6e\u4ee3\u7406\u3002","title":"Istio\u7ec4\u4ef6"},{"location":"chap8/1service_mesh/#envoy","text":"Envoy\u662f\u4e00\u4e2a\u7528C+\uff0b\u5f00\u53d1\u7684\u9ad8\u6027\u80fd\u4ee3\u7406\u3002Istio\u670d\u52a1\u7f51\u683c\u5c06Envoy\u4ee3\u7406\u4f5c\u4e3a\u4e00\u4e2a sidecar\u5bb9\u5668\u6ce8\u5165\u5230\u4f60\u7684\u5e94\u7528\u5bb9\u5668\u65c1\u8fb9\u3002\u7136\u540e\u8be5\u4ee3\u7406\u62e6\u622a\u8be5\u670d\u52a1\u7684\u6240\u6709\u5165\u7ad9\u548c\u51fa\u7ad9 \u6d41\u91cf\u3002\u6ce8\u5165\u7684\u4ee3\u7406\u4e00\u8d77\u6784\u6210\u4e86\u670d\u52a1\u7f51\u683c\u7684\u6570\u636e\u5e73\u9762\u3002 Envoy\u4ee3\u7406\u4e5f\u662f\u552f\u4e00\u4e0e\u6d41\u91cf\u8fdb\u884c\u4ea4\u4e92\u7684\u7ec4\u4ef6\u3002\u9664\u4e86\u524d\u9762\u63d0\u5230\u7684\u529f\u80fd\u2015\u8d1f\u8f7d\u5747\u8861\u3001\u65ad\u8def\u5668\u3001\u6545\u969c\u6ce8\u5165\u7b49\u3002Envoy\u8fd8\u652f\u6301\u57fa\u4e8eWebAssembly (WASM\uff09\u7684\u53ef\u63d2\u62d4\u6269\u5c55\u6a21\u578b\u3002\u8fd9\u79cd\u53ef\u6269\u5c55\u6027\u4f7f\u6211\u4eec\u80fd\u591f\u6267\u884c\u81ea\u5b9a\u4e49\u7b56\u7565\uff0c\u5e76\u4e3a\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\u751f\u6210\u9065\u6d4b\u6570\u636e\u3002","title":"Envoy\uff08\u6570\u636e\u5e73\u9762\uff09"},{"location":"chap8/1service_mesh/#istiod","text":"Istiod\u662f\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\uff0c\u63d0\u4f9b\u670d\u52a1\u53d1\u73b0\u3001\u914d\u7f6e\u548c\u8bc1\u4e66\u7ba1\u7406\u529f\u80fd\u3002 Istiod\u91c7\u7528YAML\u7f16\u5199\u7684\u9ad8\u7ea7\u89c4\u5219\uff0c\u5e76\u5c06\u5176\u8f6c\u6362\u4e3aEnvoy\u7684\u53ef\u64cd\u4f5c\u914d\u7f6e\u3002\u7136\u540e\uff0c\u5b83\u628a\u8fd9\u4e2a\u914d\u7f6e\u4f20\u64ad\u7ed9 \u7f51\u683c\u4e2d\u7684\u6240\u6709sidecar Istiod\u5185\u90e8\u7684Pilot\u7ec4\u4ef6\u62bd\u8c61\u51fa\u7279\u5b9a\u5e73\u53f0\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236 \uff08Kubernetes\u3001 Consul \u6216VM)\uff0c\u5e76\u5c06\u5176\u8f6c\u6362\u4e3asidecar\u53ef\u4ee5\u4f7f\u7528\u7684\u6807\u51c6\u683c\u5f0f\u3002 \u4f7f\u7528\u5185\u7f6e\u7684\u8eab\u4efd\u548c\u51ed\u8bc1\u7ba1\u7406\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9e\u73b0\u5f3a\u5927\u7684\u670d\u52a1\u95f4\u548c\u7ec8\u7aef\u7528\u6237\u8ba4\u8bc1\u3002\u901a\u8fc7\u6388 \u6743\u529f\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u8c01\u53ef\u4ee5\u8bbf\u95ee\u670d\u52a1\u3002 \u63a7\u5236\u5e73\u9762\u7684\u90e8\u5206\u4ee5\u524d\u88ab\u79f0\u4e3aCitadel\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u8bc1\u4e66\u6388\u6743\u673a\u6784\uff0c\u751f\u6210\u8bc1\u4e66\uff0c\u5141\u8bb8\u6570\u636e\u5e73\u9762\u4e2d\u7684\u4ee3\u7406\u4e4b\u95f4\u8fdb\u884c\u5b89\u5168\u7684mTLS\u901a\u4fe1 \u3002","title":"Istiod\uff08\u63a7\u5236\u5e73\u9762)"},{"location":"chap8/1service_mesh/#3-istio","text":"1.\u670d\u52a1\u7f51\u683c\u5982\u4f55\u5e2e\u52a9\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u903b\u8f91\uff1f A \u964d\u4f4e\u5ef6\u8fdf B \u53ef\u4ee5\u8ba9\u4f60\u66f4\u5feb\u7684\u4f38\u7f29\u670d\u52a1 C \u5c06\u903b\u8f91\u5206\u79bb\u5230\u57fa\u7840\u5b9e\u65bd\u5c42 D \u8ba9\u90e8\u7f72\u66f4\u52a0\u8fc5\u901f 2.\u4ece\u5b8f\u89c2\u4e0a\u770b\uff0cIstio\u670d\u52a1\u7f51\u683c\u7531\u54ea\u4e24\u90e8\u5206\u7ec4\u6210\uff1f \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 Istio Pilot\u548cEnvoy \u6570\u636e\u5e73\u9762\u548cEnvoy\u4ee3\u7406 Envoy\u4ee3\u7406\u548c\u914d\u7f6e 3.\u670d\u52a1\u7f51\u683c\u7684\u4ee3\u7406\u4e5f\u53eb\u505a\u4ec0\u4e48\uff1f A Ambassador B Adapter C Interface D Sidecar 4.Istio\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531\u7528\u6237\u7684\u670d\u52a1\u7ec4\u6210\u3002\u5bf9\u8fd8\u662f\u9519\uff1f \u5bf9 \u9519 6.Istio\u4e2d\u7684\u54ea\u4e2a\u7ec4\u4ef6\u53ef\u4ee5\u5c06YAML\u89c4\u5219\u8f6c\u6362\u4e3aEnvoy\u914d\u7f6e\uff1f A Envoy B Istiod C Sidecar D Citadel 7.\u4ece\u4e0b\u9762\u7684\u5217\u8868\u4e2d\u9009\u51fa\u5fae\u670d\u52a1\u67b6\u6784\u7684\u4e24\u4e2a\u597d\u5904\uff1f A \u53ef\u4f38\u7f29\u6027 B \u66f4\u5c0f\u7684\u56e2\u961f C \u7b80\u5316\u670d\u52a1\u4e4b\u95f4\u7684\u6c9f\u901a D \u4fbf\u4e8e\u8c03\u8bd5 E \u4fbf\u4e8e\u6d4b\u8bd5","title":"3\u3001\u6d4b\u9a8c\uff1a\u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8"},{"location":"chap8/2Istio_install/","text":"\u7b2c\u4e8c\u8282 \u5b89\u88c5 Istio 1\u3001\u5b89\u88c5 Istio istioctl Command-line utilitiy Istio Operator Uses a custom resource Deals with Istio upgrades Configuration profiles Istio configuration profiles: default demo empty minimal preview remote \u6211\u4eec\u6709\u4e24\u79cd\u65b9\u6cd5\u53ef\u4ee5\u5728\u5355\u4e2aKubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5Istio\uff1a\u4f7f\u7528Istiocti (istiocti)\u6216\u4f7f\u7528 Istio Operator\u3002\u5728\u672c\u6a21\u5757\u4e2d\uff0c\u6211\u4eec\u5c06\u4f7f\u7528Istio Operator\u5728\u4e00\u4e2aKubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5 Istio\u3002 \u4f7f\u7528Istioctl\u5b89\u88c5 Istioctl \u662f\u4e00\u4e2a\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u5b89\u88c5\u548c\u5b9a\u5236Istio\u7684\u5b89\u88c5\u3002\u4f7f\u7528\u8be5\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u6211\u4eec\u751f\u6210\u4e00\u4e2a\u5305\u542b\u6240\u6709Istio\u8d44\u6e90\u7684YAML\u6587\u4ef6\uff0c\u7136\u540e\u5c06\u5176\u90e8\u7f72\u5230Kubernetes\u96c6\u7fa4\u4e0a\u3002 \u4f7f\u7528Istio Operator\u5b89\u88c5 \u4e0eistioctl\u76f8\u6bd4\uff0cIstio Operator\u5b89\u88c5\u7684\u4f18\u52bf\u5728\u4e8e\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u624b\u52a8\u5347\u7ea7Istio\u3002\u76f8\u53cd\uff0c\u6211\u4eec\u53ef \u4ee5\u90e8\u7f72Istio Operator\uff0c\u4e3a\u4f60\u7ba1\u7406\u5b89\u88c5\u3002\u6211\u4eec\u901a\u8fc7\u66f4\u65b0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u8d44\u6e90\u6765\u63a7\u5236Operator\uff0c\u800c Operator\u5219\u4e3a\u4f60\u5e94\u7528\u914d\u7f6e\u53d8\u5316\u3002 \u751f\u4ea7\u90e8\u7f72\u60c5\u51b5\u5982\u4f55\uff1f \u5728\u51b3\u5b9aIstio\u7684\u751f\u4ea7\u90e8\u7f72\u6a21\u5f0f\u65f6\uff0c\u8fd8\u6709\u4e00\u4e9b\u989d\u5916\u7684\u8003\u8651\u56e0\u7d20\u9700\u8981\u7262\u8bb0\u3002\u6211\u4eec\u53ef\u4ee5\u914d\u7f6eIstio\u5728\u4e0d\u540c\u7684\u90e8\u7f72\u6a21\u578b\u4e2d\u8fd0\u884c\u2015\u53ef\u80fd\u8de8\u8d8a\u591a\u4e2a\u96c6\u7fa4\u548c\u7f51\u7edc\uff0c\u5e76\u4f7f\u7528\u591a\u4e2a\u63a7\u5236\u5e73\u9762\u3002\u6211\u4eec\u5c06\u5728\u9ad8\u7ea7\u529f\u80fd \u6a21\u5757\u4e2d\u4e86\u89e3\u5176\u4ed6\u90e8\u7f72\u6a21\u5f0f\u3001\u591a\u96c6\u7fa4\u5b89\u88c5\u4ee5\u53ca\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u5de5\u4f5c\u8d1f\u8f7d\u3002 2\u3001GetMesh Istio\u662f\u6700\u53d7\u6b22\u8fce\u548c\u53d1\u5c55\u6700\u5feb\u7684\u5f00\u6e90\u9879\u76ee\u4e4b\u4e00\u3002\u5b83\u7684\u53d1\u5e03\u65f6\u95f4\u8868\u5bf9\u4f01\u4e1a\u7684\u751f\u547d\u5468\u671f\u548c\u53d8\u66f4\u7ba1\u7406\u5b9e \u8df5\u6765\u8bf4\u53ef\u80fd\u975e\u5e38\u6fc0\u8fdb\u3002GetMesh\u901a\u8fc7\u9488\u5bf9\u4e0d\u540c\u7684Ku bernetes\u5206\u53d1\u7248\u6d4b\u8bd5\u6240\u6709Istio\u7248\u672c\u4ee5\u786e\u4fdd\u529f\u80fd\u7684\u5b8c\u6574\u6027\u6765\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u3002 GetMesh\u7684Istio\u7248\u672c\u5728\u5b89\u5168\u8865\u4e01\u548c\u5176\u4ed6\u9519\u8bef\u66f4\u65b0\u65b9\u9762\u5f97\u5230 \u79ef\u6781\u7684\u652f\u6301\uff0c\u5e76\u62e5\u6709\u6bd4\u4e0a\u6e38Istio\u63d0\u4f9b\u7684\u66f4\u957f\u7684\u652f\u6301\u671f\u3002 \u4e00\u4e9b\u670d\u52a1\u7f51\u683c\u5ba2\u6237\u9700\u8981\u652f\u6301\u66f4\u9ad8\u7684\u5b89\u5168\u8981\u6c42\u3002 \u5982\u4f55\u5f00\u59cb\uff1f \u7b2c\u4e00\u6b65\u662f\u4e0b\u8f7dGetMesh CLI\u3002\u4f60\u53ef\u4ee5\u5728macOS\u548cLinux\u5e73\u53f0\u4e0a\u5b89\u88c5GetMesh\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684GetMesh\u5e76\u8ba4\u8bc1Istio0 curl -sL https://istio.tetratelabs.io/getmesh/install.sh | bash $ getmesh version getmesh version: 1.1.3 active istioctl: 1.10.3-tetrate-v0 no running Istio pods in \"istio-system\" 1.10.3-tetrate-v0 \u7248\u672c\u547d\u4ee4\u8f93\u51fa GetMesh \u7684\u7248\u672c\u3001\u6d3b\u8dc3\u7684Istio CLI\u7684\u7248\u672c\u4ee5\u53caKubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5\u7684 Istio\u7684\u7248\u672c\u3002 \u4f7f\u7528GetMesh\u5b89\u88c5Istio GetMesh\u901a\u8fc7Kubernetes\u914d\u7f6e\u6587\u4ef6\u4e0e\u6d3b\u8dc3\u7684Kubernetes\u96c6\u7fa4\u8fdb\u884c\u901a\u4fe1\u3002 \u8981\u5728\u5f53\u524d\u6d3b\u8dc3\u7684Kubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5Istio\u7684\u6f14\u793a\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u50cf\u8fd9\u6837\u4f7f\u7528 getmesh istioctl \u547d\u4ee4\uff1a getmesh istioctl install --set profile=demo \u8be5\u547d\u4ee4\u5c06\u68c0\u67e5\u96c6\u7fa4\uff0c\u4ee5\u786e\u4fdd\u5b83\u51c6\u5907\u597d\u5b89\u88c5Istio\uff0c\u4e00\u65e6\u4f60\u786e\u8ba4\uff0c\u5b89\u88c5\u7a0b\u5e8f\u5c06\u7ee7\u7eed\u4f7f\u7528\u9009\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u5b89\u88c5Istio \u5982\u679c\u6211\u4eec\u73b0\u5728\u68c0\u67e5\u7248\u672c\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u8f93\u51fa\u663e\u793a\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u7684\u7248\u672c\u3002 \u9a8c\u8bc1\u914d\u7f6e config-validate \u547d\u4ee4\u5141\u8bb8\u4f60\u5bf9\u5f53\u524d\u914d\u7f6e\u548c\u4efb\u4f55\u5c1a\u672a\u5e94\u7528\u7684YAML\u6e05\u5355\u8fdb\u884c\u9a8c\u8bc1\u3002 \u8be5\u547d\u4ee4\u4f7f\u7528\u5916\u90e8\u8d44\u6e90\u8c03\u7528\u4e00\u7cfb\u5217\u9a8c\u8bc1\uff0c\u5982\u4e0a\u6e38Istio\u9a8c\u8bc1\u3001Kiali\u5e93\u548cGetMesh\u81ea\u5b9a\u4e49\u914d\u7f6e\u68c0\u67e5\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u547d\u4ee4\u8f93\u51fa\u7684\u4f8b\u5b50\uff0c\u5982\u679c\u6ca1\u6709\u6807\u8bb0\u4e3aIstio\u6ce8\u5165\u7684\u547d\u540d\u7a7a\u95f4\u3002 $ getmesh config-validate Running the config validator. This may take some time... Resource PeerAuthentication not found in the cluster. Maybe Istio has not been installed in your cluster. Please make sure Istio is installed before execute \"getmesh config-validate\" getmesh config-validate my-resource.yaml \u7ba1\u7406\u591a\u4e2a Istio CLI \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 show \u547d\u4ee4\u6765\u5217\u51fa\u5f53\u524d\u4e0b\u8f7d\u7684 Istio \u7248\u672c $ getmesh show 1.10.3-tetrate-v0 (Active) \u5982\u679c\u7535\u8111\u4e0a\u6ca1\u6709\u6211\u4eec\u60f3\u4f7f\u7528\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528 getmesh list \u547d\u4ee4\u6765\u5217\u51fa\u6240\u6709\u53ef\u4fe1\u7684 Istio \u7248\u672c\uff1a $ getmesh list ISTIO VERSION FLAVOR FLAVOR VERSION K8S VERSIONS *1.10.3 tetrate 0 1.17,1.18,1.19,1.20 1.10.3 tetratefips 0 1.17,1.18,1.19,1.20 1.10.3 istio 0 1.17,1.18,1.19,1.20 1.9.7 tetrate 0 1.17,1.18,1.19,1.20 1.9.7 tetratefips 0 1.17,1.18,1.19,1.20 1.9.7 istio 0 1.17,1.18,1.19,1.20 1.9.5 tetrate 0 1.17,1.18,1.19,1.20 1.9.5 istio 0 1.17,1.18,1.19,1.20 1.9.4 tetrate 0 1.17,1.18,1.19,1.20 1.9.4 istio 0 1.17,1.18,1.19,1.20 1.9.0 tetrate 0 1.17,1.18,1.19,1.20 1.9.0 tetratefips 1 1.17,1.18,1.19,1.20 1.9.0 istio 0 1.17,1.18,1.19,1.20 1.8.6 tetrate 0 1.16,1.17,1.18,1.19 1.8.6 istio 0 1.16,1.17,1.18,1.19 1.8.5 tetrate 0 1.16,1.17,1.18,1.19 1.8.5 istio 0 1.16,1.17,1.18,1.19 1.8.3 tetrate 0 1.16,1.17,1.18,1.19 1.8.3 tetratefips 1 1.16,1.17,1.18,1.19 1.8.3 istio 0 1.16,1.17,1.18,1.19 1.7.8 tetrate 0 1.16,1.17,1.18 1.7.8 istio 0 1.16,1.17,1.18 \u8981\u83b7\u53d6\u4e00\u4e2a\u7279\u5b9a\u7684\u7248\u672c getmesh fetch --version 1.9.0 --flavor tetratefips --flavor-version 1 $ getmesh show 1.9.0-tetratefips-v1 (Active) 1.9.5-tetrate-v0 \u540c\u6837\uff0c\u5982\u679c\u6211\u4eec\u8fd0\u884c getmesh istioctl version \uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6b63\u5728\u4f7f\u7528\u7684 Istio CLI \u7684\u7248\u672c\uff1a $ getmesh istioctl version client version: 1.9.0-tetratefips-v1 control plane version: 1.9.5-tetrate-v0 data plane version: 1.9.5-tetrate-v0 (2 proxies) \u8981\u5207\u6362\u5230\u4e0d\u540c\u7248\u672c\u7684 Istio CLI\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c getmesh switch \u547d\u4ee4 getmesh switch --version 1.9.5 --flavor tetrate --flavor-version 0 CA \u96c6\u6210 \u6211\u4eec\u6ca1\u6709\u4f7f\u7528\u81ea\u7b7e\u7684\u6839\u8bc1\u4e66\uff0c\u800c\u662f\u4ece GCP CAS\uff08\u8bc1\u4e66\u6388\u6743\u670d\u52a1\uff09\u83b7\u5f97\u4e00\u4e2a\u4e2d\u95f4\u7684 Istio \u8bc1\u4e66\u6388\u6743\uff08CA\uff09\u6765\u7b7e\u7f72\u5de5\u4f5c\u8d1f\u8f7d\u8bc1\u4e66 \u5047\u8bbe\u4f60\u5df2\u7ecf\u914d\u7f6e\u4e86\u81ea\u5df1\u7684 CAS \u5b9e\u4f8b\uff0c \u53ef\u4ee5\u7528 CA \u7684\u53c2\u6570\u521b\u5efa\u4e00\u4e2a YAML \u914d\u7f6e\u3002\u4e0b\u9762\u662f YAML \u914d\u7f6e\u7684\u4e00\u4e2a\u4f8b\u5b50\uff1a providerName: \"gcp\" providerConfig: gcp: # \u4f60\u5728 GCP \u4e0a\u521b\u5efa\u7684\u8bc1\u4e66\u6388\u6743\u7684\u5b8c\u6574 CA \u540d\u79f0 casCAName: \"projects/tetrate-io-istio/locations/us-west1/certificateAuthorities/tetrate-example-io\" certificateParameters: secretOptions: istioCANamespace: \"istio-system\" # cacerts secret \u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4 overrideExistingCACertsSecret: true # \u91cd\u5199\u5df2\u5b58\u5728\u7684 cacerts secret\uff0c\u4f7f\u7528\u65b0\u7684\u66ff\u6362 caOptions: validityDays: 365 # CA \u5230\u671f\u524d\u7684\u6709\u6548\u5929\u6570 keyLength: 2048 # \u521b\u5efa\u7684 key \u7684\u6bd4\u7279\u6570 certSigningRequestParams: # x509.CertificateRequest\uff1b\u5927\u90e8\u5206\u5b57\u6bb5\u7701\u7565 subject: commonname: \"tetrate.example.io\" country: - \"US\" locality: - \"Sunnyvale\" organization: - \"Istio\" organizationunit: - \"engineering\" emailaddresses: - \"youremail@example.io\" \u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 gen-ca \u547d\u4ee4\u6765\u521b\u5efa cacert getmesh gen-ca --config-file gcp-cas-config.yaml \u8be5\u547d\u4ee4\u5728 istio-system \u4e2d\u521b\u5efa cacert Kubernetes Secret \u4e3a\u4e86\u8ba9 istiod \u63a5\u53d7\u65b0\u7684 cert\uff0c\u4f60\u5fc5\u987b\u91cd\u65b0\u542f\u52a8 istiod\u3002 \u5982\u679c\u4f60\u521b\u5efa\u4e00\u4e2a sample \u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5e76\u68c0\u67e5\u6240\u4f7f\u7528\u7684\u8bc1\u4e66\uff0c\u4f60\u4f1a\u53d1\u73b0\u662f CA \u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u53d1\u5e03\u7684\u8bc1\u4e66\u3002 3\u3001\u53d1\u73b0\u9009\u62e9\u5668 Discovery selectors Introduced in Istio 1.10 Which namespaces to watch&send configuration updates for All proxies configured with information about all other services Configuring discovery selectors At the mesh level List of Kubernetes selectors(e.g.hello=world,version=v1 ...) Use discoverySelectors to limit the watched & processed items \u53d1\u73b0\u9009\u62e9\u5668\u662fIstio 1.10\u4e2d\u5f15\u5165\u7684\u65b0\u529f\u80fd\u4e4b\u4e00\u3002 \u53d1\u73b0\u9009\u62e9\u5668\u5141\u8bb8\u6211\u4eec\u63a7\u5236Istio\u63a7\u5236\u5e73\u9762\u89c2\u5bdf\u548c\u53d1\u9001\u914d\u7f6e\u66f4\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstlo\u63a7\u5236\u5e73\u9762\u4f1a\u89c2\u5bdf\u548c\u5904\u7406\u96c6\u7fa4\u4e2d\u6240\u6709Ku bernetes\u8d44\u6e90\u7684\u66f4\u65b0\u3002\u670d\u52a1\u7f51\u683c\u4e2d\u65f7 \u6240\u6709Envoy\u4ee3\u7406\u7684\u914d\u7f6e\u65b9\u5f0f\u662f\uff0c\u5b83\u4eec\u53ef\u4ee5\u5230\u8fbe\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5e76\u63a5\u53d7\u4e0e\u5de5\u4f5c\u8d1f\u8f7d\u76f8\u5173\u7684\u6240\u6709\u7aef\u53e3\u7684\u6d41\u91cf\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u5728\u4e0d\u540c\u7684\u547d\u540d\u7a7a\u95f4\u90e8\u7f72\u4e86\u4e24\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u2015foo\u548cbar \u3002 \u5c3d\u7ba1\u6211\u4eec\u77e5\u9053foo\u6c38\u8fdc\u4e0d\u4f1a\u4e0ebar\u901a\u4fe1\uff0c\u53cd\u4e4b\u4ea6\u7136\uff0c\u4f46\u4e00\u4e2a\u670d\u52a1\u7684\u7aef\u70b9\u5c06\u88ab\u5305\u542b\u5728\u53e6\u4e00\u4e2a\u670d\u52a1\u7684\u5df2\u53d1\u73b0\u7aef\u70b9\u5217\u8868\u4e2d\u3002 \u5982\u679c\u6211\u4eec\u8fd0\u884c istioctl proxy-config \u547d\u4ee4 \uff0c\u5217\u51fafoo\u547d\u540d\u7a7a\u95f4\u7684foo\u5de5\u4f5c\u8d1f\u8f7d\u53ef\u4ee5\u770b\u5230\u7684\u6240\u6709\u7aef\u70b9\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u4e00\u4e2a\u540d\u4e3abar\u7684\u670d\u52a1\u6761\u76ee\uff1a $ istioctl proxy-config endpoints deploy/foo.foo \u5982\u679cIstio\u4e0d\u65ad\u7528\u96c6\u7fa4\u4e2d\u6bcf\u4e2a\u670d\u52a1\u7684\u4fe1\u606f\u6765\u66f4\u65b0\u4ee3\u7406\uff0c\u5373\u4f7f\u8fd9\u4e9b\u670d\u52a1\u662f\u4e0d\u76f8\u5173\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u60f3\u8c61\u8fd9\u5c06\u5982\u4f55\u62d6\u7d2f\u4e8b\u60c5\u3002 \u5982\u679c\u8fd9\u542c\u8d77\u6765\u5f88\u719f\u6089\uff0c\u4f60\u53ef\u80fd\u77e5\u9053\u5df2\u7ecf\u6709\u4e00\u4e2a\u89e3\u51b3\u65b9\u6848\u4e86 - Sidecar\u8d44\u6e90\u3002 \u914d\u7f6e\u53d1\u73b0\u9009\u62e9\u5668 \u53d1\u73b0\u9009\u62e9\u5668\u53ef\u4ee5\u5728 MeshConfig \u4e2d\u7684Mesh\u5c42\u9762\u4e0a\u8fdb\u884c\u914d\u7f6e\u3002\u5b83\u4eec\u662f\u4e00\u4e2aKubernetes\u9009\u62e9\u5668\u7684\u5217\u8868\uff0c\u6307\u5b9a\u4e86Istio\u5728\u5411sidecar\u63a8\u9001\u914d\u7f6e\u65f6\u89c2\u5bdf\u548c\u66f4\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u7684\u96c6\u5408\u3002 \u5c31\u50cfSidecar\u8d44\u6e90\u4e00\u6837, discoverySelectors\u53ef\u4ee5\u7528\u6765\u9650\u5236\u88ab Istio \u89c2\u5bdf\u548c\u5904\u7406\u7684\u9879\u76ee\u6570\u91cf \u6211\u4eec\u53ef\u4ee5\u66f4\u65b0 IstioOperator \u4ee5\u5305\u62ec discoverySelectors \u5b57\u6bb5\uff0c\u5982\u4e0b\u6240\u793a\uff1a apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata: namespace: istio-system name: istio-demo spec: meshConfig: discoverySelectors: - matchLabels: env: test \u4e0a\u9762\u7684\u4f8b\u5b50\u5c06 env=test \u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5339\u914d\u6807\u7b7e\u3002\u8fd9\u610f\u6627\u7740\u6807\u6709 env=test \u6807\u7b7e\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5c06\u88ab\u5305\u542b\u5728Istio\u76d1\u63a7\u548c\u66f4\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u5217\u8868\u4e2d\u3002 \u5982\u679c\u6211\u4eec\u7ed9foo\u547d\u540d\u7a7a\u95f4\u8d34\u4e0a env=test \u6807\u7b7e\uff0c\u7136\u540e\u5217\u51fa\u7aef\u70b9\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u73b0\u5728\u914d\u7f6e\u4e2d\u5217\u51fa\u7684\u7aef\u70b9\u6ca1\u6709\u90a3\u4e48\u591a\u3002 \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u6807\u6ce8\u7684\u552f\u4e00\u547d\u540d\u7a7a\u95f4\u662ffoo\u547d\u540d\u7a7a\u95f4\uff0c\u8fd9\u4e5f\u662fIstlo\u63a7\u5236\u5e73\u9762\u89c2\u5bdf\u548c\u53d1\u9001\u66f4\u65b0\u7684\u552f\u4e00\u547d\u540d\u7a7a\u95f4\u3002 $ istioctl proxy-config endpoints deploy/foo.foo \u5982\u679c\u6211\u4eec\u628a\u547d\u540d\u7a7a\u95f4bar\u4e5f\u8d34\u4e0a\u6807\u7b7e \uff0c\u7136\u540e\u91cd\u65b0\u8fd0\u884c istiocti proxy-config \u547d\u4ee4\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0bar\u7aef\u70b9\u663e\u793a\u4e3afoo\u670d\u52a1\u914d\u7f6e\u7684\u4e00\u90e8\u5206\u3002 $ istioctl proxy-config endpoints deploy/foo.foo 4\u3001\u5b9e\u9a8cIstio\u5b89\u88c5 $ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh - $ cd istio-1.10.3 $ sudo cp bin/istioctl /usr/local/bin/istioctl $ istioctl version no running Istio pods in \"istio-system\" 1.10.3 Istlo\u652f\u6301\u591a\u4e2a\u914d\u7f6e\u6587\u4ef6\uff08 profile )\u3002\u914d\u7f6e\u6587\u4ef6\u4e4b\u95f4\u7684\u533a\u522b\u5728\u4e8e\u6240\u5b89\u88c5\u7684\u7ec4\u4ef6\u3002 $ istioctl profile list Istio configuration profiles: default demo empty external minimal openshift preview remote \u63a8\u8350\u7528\u4e8e\u751f\u4ea7\u90e8\u7f72\u7684\u914d\u7f6e\u6587\u4ef6\u662fdefault\u914d\u7f6e\u6587\u4ef6\u3002 \u6211\u4eec\u5c06\u5b89\u88c5demo\u914d\u7f6e\u6587\u4ef6\uff0c\u56e0\u4e3a\u5b83\u5305\u542b\u6240\u6709\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u542f\u7528\u4e86\u8ddf\u8e2a\u548c\u65e5\u5fd7\u8bb0\u5f55\uff0c\u4fbf\u4e8e\u5b66\u4e60\u4e0d\u540c\u7684Istio\u529f\u80fd\u3002 \u6211\u4eec\u4e5f\u53ef\u4ee5\u4eceminimal\u7684\u7ec4\u4ef6\u5f00\u59cb\uff0c\u4ee5\u540e\u5355\u72ec\u5b89\u88c5\u5176\u4ed6\u529f\u80fd\uff0c\u5982ingress\u548cegress\u7f51\u5173\u3002 \u56e0\u4e3a\u6211\u4eec\u5c06\u4f7f\u7528Istio Operator\u8fdb\u884c\u5b89\u88c5\uff0c\u6240\u4ee5\u6211\u4eec\u5fc5\u987b\u5148\u90e8\u7f72Operator0 \u8981\u90e8\u7f72 Istio Operator \uff0c\u8bf7\u8fd0\u884c $ istioctl operator init Installing operator controller in namespace: istio-operator using image: docker.io/istio/operator:1.10.3 Operator controller will watch namespaces: istio-system \u2714 Istio operator installed \u2714 Installation complete init\u547d\u4ee4\u521b\u5efa\u4e86 istio-operator \u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u90e8\u7f72\u4e86CRD\u3001Operator Deployment\u4ee5\u53caoperator\u5de5\u4f5c\u6240\u9700\u7684\u5176\u4ed6\u8d44\u6e90\u3002\u5b89\u88c5\u5b8c\u6210\u540e\uff0cOperator\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e86\u3002 \u8981\u5b89\u88c5Istio\uff0c\u6211\u4eec\u5fc5\u987b\u521b\u5efa IstioOperator \u8d44\u6e90\uff0c\u5e76\u6307\u5b9a\u6211\u4eec\u8981\u4f7f\u7528\u7684\u914d\u7f6e\u914d\u7f6e\u6587\u4ef6\u3002 \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a demo-profile.yaml \u7684\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: v1 kind: Namespace metadata: name: istio-system --- apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata: namespace: istio-system name: demo-istio-install spec: profile: demo \u5b89\u88c5 istio \u7684\u5de5\u5177\u548c\u6587\u4ef6\u51c6\u5907\u597d\u8fc7\u540e\uff0c\u76f4\u63a5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u5b89\u88c5\u547d\u4ee4\u5373\u53ef\uff0c\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u7684\u662f demo \u914d\u7f6e\u7ec4\u5408\u7684\u5f62\u5f0f\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u5305\u542b\u4e86\u4e00\u7ec4\u4e13\u4e3a\u6d4b\u8bd5\u51c6\u5907\u7684\u529f\u80fd\u96c6\u5408\uff0c\u53e6\u5916\u8fd8\u6709\u7528\u4e8e\u751f\u4ea7\u6216\u6027\u80fd\u6d4b\u8bd5\u7684\u914d\u7f6e\u7ec4\u5408\u3002 $ istioctl install --set profile=demo -y \u2714 Istio core installed \u2714 Istiod installed \u2714 Ingress gateways installed \u2714 Egress gateways installed \u2714 Installation complete Thank you for installing Istio 1.10. Please take a few minutes to tell us about your install/upgrade experience! https://forms.gle /KjkrDnMPByq7akrYA $ kubectl apply -f demo-profile.yaml namespace/istio-system unchanged istiooperator.install.istio.io/demo-istio-install created \u4e00\u65e6Operator\u68c0\u6d4b\u5230 IstioOperator \u8d44\u6e90\uff0c\u5b83\u5c06\u5f00\u59cb\u5b89\u88c5Istio\u3002\u6574\u4e2a\u8fc7\u7a0b\u53ef\u80fd\u9700\u89815\u5206\u949f\u5de6\u53f3\u3002 \u4e3a\u4e86\u68c0\u67e5\u5b89\u88c5\u7684\u72b6\u6001\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u7684Pod\u7684\u72b6\u6001\u3002 $ kubectl get pod -n istio-operator NAME READY STATUS RESTARTS AGE istio-operator-dbc5db55-wjngn 1/1 Running 0 8m16s $ kubectl get pod -n istio-system NAME READY STATUS RESTARTS AGE istio-egressgateway-5547fcc8fc-7kj9c 1/1 Running 0 7m17s istio-ingressgateway-8f568d595-zj9bs 1/1 Running 0 7m17s istiod-6659979bdf-l7kgk 1/1 Running 0 7m23s \u5f53\u6240\u6709\u7684Pod\u90fd\u5728\u8fd0\u884c\u65f6\uff0cOperator\u5df2\u7ecf\u5b8c\u6210\u4e86Istio\u7684\u5b89\u88c5\u3002 \u542f\u7528sidecar\u6ce8\u5165 \u670d\u52a1\u7f51\u683c\u9700\u8981\u8ba9\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u540c\u65f6\u8fd0\u884csidecar\u4ee3\u7406\u3002 \u8981\u5c06sidecar\u4ee3\u7406\u6ce8\u5165\u5230\u73b0\u6709\u7684Kubernetes\u90e8\u7f72\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 istioctl \u547d\u4ee4\u4e2d\u7684 kube-inject \u52a8\u4f5c\u3002 \u7136\u800c\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728\u4efb\u610fKubernetes\u547d\u540d\u7a7a\u95f4\u4e0a\u542f\u7528sidecar\u81ea\u52a8\u6ce8\u5165\u3002\u5982\u679c\u6211\u4eec\u7528 istio-injection=enabled \u6807\u8bb0\u547d\u540d\u7a7a\u95f4\uff0cIstio\u4f1a\u81ea\u52a8\u4e3a\u6211\u4eec\u5728\u8be5\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u7684\u6240\u6709 Kubernetes Pod \u6ce8\u5165 sidecar \u8ba9\u6211\u4eec\u901a\u8fc7\u6dfb\u52a0\u6807\u7b7e\u6765\u542f\u7528default\u547d\u540d\u7a7a\u95f4\u7684sidecar\u81ea\u52a8\u6ce8\u5165\u3002 $ kubectl label namespace default istio-injection=enabled namespace/default labeled \u8981\u68c0\u67e5\u547d\u540d\u7a7a\u95f4\u662f\u5426\u88ab\u6807\u8bb0\uff0c\u8bf7\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u3002defaul\u4e03\u547d\u540d\u7a7a\u95f4\u5e94\u8be5\u662f\u552f\u4e00\u4e00\u4e2a\u542f\u7528\u4e86\u8be5\u503c\u7684\u547d\u540d\u7a7a\u95f4\u3002 $ kubectl get namespace -L istio-injection NAME STATUS AGE ISTIO-INJECTION default Active 12d enabled istio-operator Active 22m disabled istio-system Active 30m kube-demo Active 12d kube-node-lease Active 12d kube-public Active 12d kube-system Active 12d velero Active 12d \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5728defaul\u4e03\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u4e00\u4e2aDeployment\uff0c\u5e76\u89c2\u5bdf\u6ce8\u5165\u7684\u4ee3\u7406\u3002\u6211\u4eec\u5c06 \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a my-nginx \u7684 Deployment \uff0c\u4f7f\u7528nginx\u955c\u50cf\u7684\u5355\u4e00\u5bb9\u5668\u3002 kubectl create deploy my-nginx --image=nginx kubectl get pod NAME READY STATUS RESTARTS AGE my-nginx-6b74b79f57-ps779 2/2 Running 0 111s $ kubectl describe pod my-nginx-6b74b79f57-ps779 Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 2m27s default-scheduler Successfully assigned default/my-nginx-6b74b79f57-ps779 to docker-desktop Normal Pulled 2m24s kubelet, docker-desktop Container image \"docker.io/istio/proxyv2:1.10.3\" already present on machine Normal Created 2m23s kubelet, docker-desktop Created container istio-init Normal Started 2m23s kubelet, docker-desktop Started container istio-init Normal Pulling 2m22s kubelet, docker-desktop Pulling image \"nginx\" Normal Pulled 98s kubelet, docker-desktop Successfully pulled image \"nginx\" in 44.2681088s Normal Created 98s kubelet, docker-desktop Created container nginx Normal Started 98s kubelet, docker-desktop Started container nginx Normal Pulled 98s kubelet, docker-desktop Container image \"docker.io/istio/proxyv2:1.10.3\" already present on machine Normal Created 98s kubelet, docker-desktop Created container istio-proxy Normal Started 98s kubelet, docker-desktop Started container istio-proxy 4\u3001\u6d4b\u9a8c\uff1a\u5b89\u88c5 Istio 1.\u5b89\u88c5\u540e\uff0cIstio\u4f1a\u81ea\u52a8\u5c06Envoy\u4ee3\u7406\u6ce8\u5165\u6240\u6709\u5728default\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u7684Kubernetes\u90e8\u7f72\u4e2d\u3002\u5bf9\u8fd8\u662f\u9519\uff1f A \u5bf9 B \u9519 2.Istio\u6709\u591a\u4e2a\u914d\u7f6e\u6587\u4ef6\u3002\u54ea\u79cd\u914d\u7f6e\u6587\u4ef6\u6700\u9002\u5408\u751f\u4ea7\u90e8\u7f72\uff1f Choose only ONE best answer. Default profile Production profile Minimal Demo 3.\u4f60\u53ef\u4ee5\u7528\u54ea\u4e2a\u6807\u7b7e\u6765\u542f\u7528\u81ea\u52a8sidecar\u6ce8\u5165\uff1f Choose only ONE best answer. A injection=enabled B sidecar-injection=1 C istio-injection=enabled D inject\uff1dtrue 4.\u8fd0\u884cEnvoy\u4ee3\u7406sidecar\u7684\u5bb9\u5668\u7684\u540d\u79f0\u662f\u4ec0\u4e48\uff1f Choose only ONE best answer. A istio-proxy B sidecar C envoy-proxy D proxy 5\u3002\u53ea\u53ef\u4ee5\u4f7f\u7528Istio CLI (istiocti\uff09\u6765\u5b89\u88c5Istio\uff0c\u5bf9\u8fd8\u662f\u9519\uff1f Choose only ONE best answer. A \u5bf9 B \u9519","title":"\u7b2c\u4e8c\u8282 \u5b89\u88c5 Istio"},{"location":"chap8/2Istio_install/#istio","text":"","title":"\u7b2c\u4e8c\u8282 \u5b89\u88c5 Istio"},{"location":"chap8/2Istio_install/#1-istio","text":"istioctl Command-line utilitiy Istio Operator Uses a custom resource Deals with Istio upgrades Configuration profiles Istio configuration profiles: default demo empty minimal preview remote \u6211\u4eec\u6709\u4e24\u79cd\u65b9\u6cd5\u53ef\u4ee5\u5728\u5355\u4e2aKubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5Istio\uff1a\u4f7f\u7528Istiocti (istiocti)\u6216\u4f7f\u7528 Istio Operator\u3002\u5728\u672c\u6a21\u5757\u4e2d\uff0c\u6211\u4eec\u5c06\u4f7f\u7528Istio Operator\u5728\u4e00\u4e2aKubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5 Istio\u3002","title":"1\u3001\u5b89\u88c5 Istio"},{"location":"chap8/2Istio_install/#istioctl","text":"Istioctl \u662f\u4e00\u4e2a\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u5b89\u88c5\u548c\u5b9a\u5236Istio\u7684\u5b89\u88c5\u3002\u4f7f\u7528\u8be5\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u6211\u4eec\u751f\u6210\u4e00\u4e2a\u5305\u542b\u6240\u6709Istio\u8d44\u6e90\u7684YAML\u6587\u4ef6\uff0c\u7136\u540e\u5c06\u5176\u90e8\u7f72\u5230Kubernetes\u96c6\u7fa4\u4e0a\u3002","title":"\u4f7f\u7528Istioctl\u5b89\u88c5"},{"location":"chap8/2Istio_install/#istio-operator","text":"\u4e0eistioctl\u76f8\u6bd4\uff0cIstio Operator\u5b89\u88c5\u7684\u4f18\u52bf\u5728\u4e8e\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u624b\u52a8\u5347\u7ea7Istio\u3002\u76f8\u53cd\uff0c\u6211\u4eec\u53ef \u4ee5\u90e8\u7f72Istio Operator\uff0c\u4e3a\u4f60\u7ba1\u7406\u5b89\u88c5\u3002\u6211\u4eec\u901a\u8fc7\u66f4\u65b0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u8d44\u6e90\u6765\u63a7\u5236Operator\uff0c\u800c Operator\u5219\u4e3a\u4f60\u5e94\u7528\u914d\u7f6e\u53d8\u5316\u3002","title":"\u4f7f\u7528Istio Operator\u5b89\u88c5"},{"location":"chap8/2Istio_install/#_1","text":"\u5728\u51b3\u5b9aIstio\u7684\u751f\u4ea7\u90e8\u7f72\u6a21\u5f0f\u65f6\uff0c\u8fd8\u6709\u4e00\u4e9b\u989d\u5916\u7684\u8003\u8651\u56e0\u7d20\u9700\u8981\u7262\u8bb0\u3002\u6211\u4eec\u53ef\u4ee5\u914d\u7f6eIstio\u5728\u4e0d\u540c\u7684\u90e8\u7f72\u6a21\u578b\u4e2d\u8fd0\u884c\u2015\u53ef\u80fd\u8de8\u8d8a\u591a\u4e2a\u96c6\u7fa4\u548c\u7f51\u7edc\uff0c\u5e76\u4f7f\u7528\u591a\u4e2a\u63a7\u5236\u5e73\u9762\u3002\u6211\u4eec\u5c06\u5728\u9ad8\u7ea7\u529f\u80fd \u6a21\u5757\u4e2d\u4e86\u89e3\u5176\u4ed6\u90e8\u7f72\u6a21\u5f0f\u3001\u591a\u96c6\u7fa4\u5b89\u88c5\u4ee5\u53ca\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u5de5\u4f5c\u8d1f\u8f7d\u3002","title":"\u751f\u4ea7\u90e8\u7f72\u60c5\u51b5\u5982\u4f55\uff1f"},{"location":"chap8/2Istio_install/#2getmesh","text":"Istio\u662f\u6700\u53d7\u6b22\u8fce\u548c\u53d1\u5c55\u6700\u5feb\u7684\u5f00\u6e90\u9879\u76ee\u4e4b\u4e00\u3002\u5b83\u7684\u53d1\u5e03\u65f6\u95f4\u8868\u5bf9\u4f01\u4e1a\u7684\u751f\u547d\u5468\u671f\u548c\u53d8\u66f4\u7ba1\u7406\u5b9e \u8df5\u6765\u8bf4\u53ef\u80fd\u975e\u5e38\u6fc0\u8fdb\u3002GetMesh\u901a\u8fc7\u9488\u5bf9\u4e0d\u540c\u7684Ku bernetes\u5206\u53d1\u7248\u6d4b\u8bd5\u6240\u6709Istio\u7248\u672c\u4ee5\u786e\u4fdd\u529f\u80fd\u7684\u5b8c\u6574\u6027\u6765\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u3002 GetMesh\u7684Istio\u7248\u672c\u5728\u5b89\u5168\u8865\u4e01\u548c\u5176\u4ed6\u9519\u8bef\u66f4\u65b0\u65b9\u9762\u5f97\u5230 \u79ef\u6781\u7684\u652f\u6301\uff0c\u5e76\u62e5\u6709\u6bd4\u4e0a\u6e38Istio\u63d0\u4f9b\u7684\u66f4\u957f\u7684\u652f\u6301\u671f\u3002 \u4e00\u4e9b\u670d\u52a1\u7f51\u683c\u5ba2\u6237\u9700\u8981\u652f\u6301\u66f4\u9ad8\u7684\u5b89\u5168\u8981\u6c42\u3002","title":"2\u3001GetMesh"},{"location":"chap8/2Istio_install/#_2","text":"\u7b2c\u4e00\u6b65\u662f\u4e0b\u8f7dGetMesh CLI\u3002\u4f60\u53ef\u4ee5\u5728macOS\u548cLinux\u5e73\u53f0\u4e0a\u5b89\u88c5GetMesh\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684GetMesh\u5e76\u8ba4\u8bc1Istio0 curl -sL https://istio.tetratelabs.io/getmesh/install.sh | bash $ getmesh version getmesh version: 1.1.3 active istioctl: 1.10.3-tetrate-v0 no running Istio pods in \"istio-system\" 1.10.3-tetrate-v0 \u7248\u672c\u547d\u4ee4\u8f93\u51fa GetMesh \u7684\u7248\u672c\u3001\u6d3b\u8dc3\u7684Istio CLI\u7684\u7248\u672c\u4ee5\u53caKubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5\u7684 Istio\u7684\u7248\u672c\u3002","title":"\u5982\u4f55\u5f00\u59cb\uff1f"},{"location":"chap8/2Istio_install/#getmeshistio","text":"GetMesh\u901a\u8fc7Kubernetes\u914d\u7f6e\u6587\u4ef6\u4e0e\u6d3b\u8dc3\u7684Kubernetes\u96c6\u7fa4\u8fdb\u884c\u901a\u4fe1\u3002 \u8981\u5728\u5f53\u524d\u6d3b\u8dc3\u7684Kubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5Istio\u7684\u6f14\u793a\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u50cf\u8fd9\u6837\u4f7f\u7528 getmesh istioctl \u547d\u4ee4\uff1a getmesh istioctl install --set profile=demo \u8be5\u547d\u4ee4\u5c06\u68c0\u67e5\u96c6\u7fa4\uff0c\u4ee5\u786e\u4fdd\u5b83\u51c6\u5907\u597d\u5b89\u88c5Istio\uff0c\u4e00\u65e6\u4f60\u786e\u8ba4\uff0c\u5b89\u88c5\u7a0b\u5e8f\u5c06\u7ee7\u7eed\u4f7f\u7528\u9009\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u5b89\u88c5Istio \u5982\u679c\u6211\u4eec\u73b0\u5728\u68c0\u67e5\u7248\u672c\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u8f93\u51fa\u663e\u793a\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u7684\u7248\u672c\u3002","title":"\u4f7f\u7528GetMesh\u5b89\u88c5Istio"},{"location":"chap8/2Istio_install/#_3","text":"config-validate \u547d\u4ee4\u5141\u8bb8\u4f60\u5bf9\u5f53\u524d\u914d\u7f6e\u548c\u4efb\u4f55\u5c1a\u672a\u5e94\u7528\u7684YAML\u6e05\u5355\u8fdb\u884c\u9a8c\u8bc1\u3002 \u8be5\u547d\u4ee4\u4f7f\u7528\u5916\u90e8\u8d44\u6e90\u8c03\u7528\u4e00\u7cfb\u5217\u9a8c\u8bc1\uff0c\u5982\u4e0a\u6e38Istio\u9a8c\u8bc1\u3001Kiali\u5e93\u548cGetMesh\u81ea\u5b9a\u4e49\u914d\u7f6e\u68c0\u67e5\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u547d\u4ee4\u8f93\u51fa\u7684\u4f8b\u5b50\uff0c\u5982\u679c\u6ca1\u6709\u6807\u8bb0\u4e3aIstio\u6ce8\u5165\u7684\u547d\u540d\u7a7a\u95f4\u3002 $ getmesh config-validate Running the config validator. This may take some time... Resource PeerAuthentication not found in the cluster. Maybe Istio has not been installed in your cluster. Please make sure Istio is installed before execute \"getmesh config-validate\" getmesh config-validate my-resource.yaml","title":"\u9a8c\u8bc1\u914d\u7f6e"},{"location":"chap8/2Istio_install/#istio-cli","text":"\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 show \u547d\u4ee4\u6765\u5217\u51fa\u5f53\u524d\u4e0b\u8f7d\u7684 Istio \u7248\u672c $ getmesh show 1.10.3-tetrate-v0 (Active) \u5982\u679c\u7535\u8111\u4e0a\u6ca1\u6709\u6211\u4eec\u60f3\u4f7f\u7528\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528 getmesh list \u547d\u4ee4\u6765\u5217\u51fa\u6240\u6709\u53ef\u4fe1\u7684 Istio \u7248\u672c\uff1a $ getmesh list ISTIO VERSION FLAVOR FLAVOR VERSION K8S VERSIONS *1.10.3 tetrate 0 1.17,1.18,1.19,1.20 1.10.3 tetratefips 0 1.17,1.18,1.19,1.20 1.10.3 istio 0 1.17,1.18,1.19,1.20 1.9.7 tetrate 0 1.17,1.18,1.19,1.20 1.9.7 tetratefips 0 1.17,1.18,1.19,1.20 1.9.7 istio 0 1.17,1.18,1.19,1.20 1.9.5 tetrate 0 1.17,1.18,1.19,1.20 1.9.5 istio 0 1.17,1.18,1.19,1.20 1.9.4 tetrate 0 1.17,1.18,1.19,1.20 1.9.4 istio 0 1.17,1.18,1.19,1.20 1.9.0 tetrate 0 1.17,1.18,1.19,1.20 1.9.0 tetratefips 1 1.17,1.18,1.19,1.20 1.9.0 istio 0 1.17,1.18,1.19,1.20 1.8.6 tetrate 0 1.16,1.17,1.18,1.19 1.8.6 istio 0 1.16,1.17,1.18,1.19 1.8.5 tetrate 0 1.16,1.17,1.18,1.19 1.8.5 istio 0 1.16,1.17,1.18,1.19 1.8.3 tetrate 0 1.16,1.17,1.18,1.19 1.8.3 tetratefips 1 1.16,1.17,1.18,1.19 1.8.3 istio 0 1.16,1.17,1.18,1.19 1.7.8 tetrate 0 1.16,1.17,1.18 1.7.8 istio 0 1.16,1.17,1.18 \u8981\u83b7\u53d6\u4e00\u4e2a\u7279\u5b9a\u7684\u7248\u672c getmesh fetch --version 1.9.0 --flavor tetratefips --flavor-version 1 $ getmesh show 1.9.0-tetratefips-v1 (Active) 1.9.5-tetrate-v0 \u540c\u6837\uff0c\u5982\u679c\u6211\u4eec\u8fd0\u884c getmesh istioctl version \uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6b63\u5728\u4f7f\u7528\u7684 Istio CLI \u7684\u7248\u672c\uff1a $ getmesh istioctl version client version: 1.9.0-tetratefips-v1 control plane version: 1.9.5-tetrate-v0 data plane version: 1.9.5-tetrate-v0 (2 proxies) \u8981\u5207\u6362\u5230\u4e0d\u540c\u7248\u672c\u7684 Istio CLI\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c getmesh switch \u547d\u4ee4 getmesh switch --version 1.9.5 --flavor tetrate --flavor-version 0","title":"\u7ba1\u7406\u591a\u4e2a Istio CLI"},{"location":"chap8/2Istio_install/#ca","text":"\u6211\u4eec\u6ca1\u6709\u4f7f\u7528\u81ea\u7b7e\u7684\u6839\u8bc1\u4e66\uff0c\u800c\u662f\u4ece GCP CAS\uff08\u8bc1\u4e66\u6388\u6743\u670d\u52a1\uff09\u83b7\u5f97\u4e00\u4e2a\u4e2d\u95f4\u7684 Istio \u8bc1\u4e66\u6388\u6743\uff08CA\uff09\u6765\u7b7e\u7f72\u5de5\u4f5c\u8d1f\u8f7d\u8bc1\u4e66 \u5047\u8bbe\u4f60\u5df2\u7ecf\u914d\u7f6e\u4e86\u81ea\u5df1\u7684 CAS \u5b9e\u4f8b\uff0c \u53ef\u4ee5\u7528 CA \u7684\u53c2\u6570\u521b\u5efa\u4e00\u4e2a YAML \u914d\u7f6e\u3002\u4e0b\u9762\u662f YAML \u914d\u7f6e\u7684\u4e00\u4e2a\u4f8b\u5b50\uff1a providerName: \"gcp\" providerConfig: gcp: # \u4f60\u5728 GCP \u4e0a\u521b\u5efa\u7684\u8bc1\u4e66\u6388\u6743\u7684\u5b8c\u6574 CA \u540d\u79f0 casCAName: \"projects/tetrate-io-istio/locations/us-west1/certificateAuthorities/tetrate-example-io\" certificateParameters: secretOptions: istioCANamespace: \"istio-system\" # cacerts secret \u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4 overrideExistingCACertsSecret: true # \u91cd\u5199\u5df2\u5b58\u5728\u7684 cacerts secret\uff0c\u4f7f\u7528\u65b0\u7684\u66ff\u6362 caOptions: validityDays: 365 # CA \u5230\u671f\u524d\u7684\u6709\u6548\u5929\u6570 keyLength: 2048 # \u521b\u5efa\u7684 key \u7684\u6bd4\u7279\u6570 certSigningRequestParams: # x509.CertificateRequest\uff1b\u5927\u90e8\u5206\u5b57\u6bb5\u7701\u7565 subject: commonname: \"tetrate.example.io\" country: - \"US\" locality: - \"Sunnyvale\" organization: - \"Istio\" organizationunit: - \"engineering\" emailaddresses: - \"youremail@example.io\" \u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 gen-ca \u547d\u4ee4\u6765\u521b\u5efa cacert getmesh gen-ca --config-file gcp-cas-config.yaml \u8be5\u547d\u4ee4\u5728 istio-system \u4e2d\u521b\u5efa cacert Kubernetes Secret \u4e3a\u4e86\u8ba9 istiod \u63a5\u53d7\u65b0\u7684 cert\uff0c\u4f60\u5fc5\u987b\u91cd\u65b0\u542f\u52a8 istiod\u3002 \u5982\u679c\u4f60\u521b\u5efa\u4e00\u4e2a sample \u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5e76\u68c0\u67e5\u6240\u4f7f\u7528\u7684\u8bc1\u4e66\uff0c\u4f60\u4f1a\u53d1\u73b0\u662f CA \u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u53d1\u5e03\u7684\u8bc1\u4e66\u3002","title":"CA \u96c6\u6210"},{"location":"chap8/2Istio_install/#3","text":"Discovery selectors Introduced in Istio 1.10 Which namespaces to watch&send configuration updates for All proxies configured with information about all other services Configuring discovery selectors At the mesh level List of Kubernetes selectors(e.g.hello=world,version=v1 ...) Use discoverySelectors to limit the watched & processed items \u53d1\u73b0\u9009\u62e9\u5668\u662fIstio 1.10\u4e2d\u5f15\u5165\u7684\u65b0\u529f\u80fd\u4e4b\u4e00\u3002 \u53d1\u73b0\u9009\u62e9\u5668\u5141\u8bb8\u6211\u4eec\u63a7\u5236Istio\u63a7\u5236\u5e73\u9762\u89c2\u5bdf\u548c\u53d1\u9001\u914d\u7f6e\u66f4\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstlo\u63a7\u5236\u5e73\u9762\u4f1a\u89c2\u5bdf\u548c\u5904\u7406\u96c6\u7fa4\u4e2d\u6240\u6709Ku bernetes\u8d44\u6e90\u7684\u66f4\u65b0\u3002\u670d\u52a1\u7f51\u683c\u4e2d\u65f7 \u6240\u6709Envoy\u4ee3\u7406\u7684\u914d\u7f6e\u65b9\u5f0f\u662f\uff0c\u5b83\u4eec\u53ef\u4ee5\u5230\u8fbe\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5e76\u63a5\u53d7\u4e0e\u5de5\u4f5c\u8d1f\u8f7d\u76f8\u5173\u7684\u6240\u6709\u7aef\u53e3\u7684\u6d41\u91cf\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u5728\u4e0d\u540c\u7684\u547d\u540d\u7a7a\u95f4\u90e8\u7f72\u4e86\u4e24\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u2015foo\u548cbar \u3002 \u5c3d\u7ba1\u6211\u4eec\u77e5\u9053foo\u6c38\u8fdc\u4e0d\u4f1a\u4e0ebar\u901a\u4fe1\uff0c\u53cd\u4e4b\u4ea6\u7136\uff0c\u4f46\u4e00\u4e2a\u670d\u52a1\u7684\u7aef\u70b9\u5c06\u88ab\u5305\u542b\u5728\u53e6\u4e00\u4e2a\u670d\u52a1\u7684\u5df2\u53d1\u73b0\u7aef\u70b9\u5217\u8868\u4e2d\u3002 \u5982\u679c\u6211\u4eec\u8fd0\u884c istioctl proxy-config \u547d\u4ee4 \uff0c\u5217\u51fafoo\u547d\u540d\u7a7a\u95f4\u7684foo\u5de5\u4f5c\u8d1f\u8f7d\u53ef\u4ee5\u770b\u5230\u7684\u6240\u6709\u7aef\u70b9\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u4e00\u4e2a\u540d\u4e3abar\u7684\u670d\u52a1\u6761\u76ee\uff1a $ istioctl proxy-config endpoints deploy/foo.foo \u5982\u679cIstio\u4e0d\u65ad\u7528\u96c6\u7fa4\u4e2d\u6bcf\u4e2a\u670d\u52a1\u7684\u4fe1\u606f\u6765\u66f4\u65b0\u4ee3\u7406\uff0c\u5373\u4f7f\u8fd9\u4e9b\u670d\u52a1\u662f\u4e0d\u76f8\u5173\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u60f3\u8c61\u8fd9\u5c06\u5982\u4f55\u62d6\u7d2f\u4e8b\u60c5\u3002 \u5982\u679c\u8fd9\u542c\u8d77\u6765\u5f88\u719f\u6089\uff0c\u4f60\u53ef\u80fd\u77e5\u9053\u5df2\u7ecf\u6709\u4e00\u4e2a\u89e3\u51b3\u65b9\u6848\u4e86 - Sidecar\u8d44\u6e90\u3002","title":"3\u3001\u53d1\u73b0\u9009\u62e9\u5668"},{"location":"chap8/2Istio_install/#_4","text":"\u53d1\u73b0\u9009\u62e9\u5668\u53ef\u4ee5\u5728 MeshConfig \u4e2d\u7684Mesh\u5c42\u9762\u4e0a\u8fdb\u884c\u914d\u7f6e\u3002\u5b83\u4eec\u662f\u4e00\u4e2aKubernetes\u9009\u62e9\u5668\u7684\u5217\u8868\uff0c\u6307\u5b9a\u4e86Istio\u5728\u5411sidecar\u63a8\u9001\u914d\u7f6e\u65f6\u89c2\u5bdf\u548c\u66f4\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u7684\u96c6\u5408\u3002 \u5c31\u50cfSidecar\u8d44\u6e90\u4e00\u6837, discoverySelectors\u53ef\u4ee5\u7528\u6765\u9650\u5236\u88ab Istio \u89c2\u5bdf\u548c\u5904\u7406\u7684\u9879\u76ee\u6570\u91cf \u6211\u4eec\u53ef\u4ee5\u66f4\u65b0 IstioOperator \u4ee5\u5305\u62ec discoverySelectors \u5b57\u6bb5\uff0c\u5982\u4e0b\u6240\u793a\uff1a apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata: namespace: istio-system name: istio-demo spec: meshConfig: discoverySelectors: - matchLabels: env: test \u4e0a\u9762\u7684\u4f8b\u5b50\u5c06 env=test \u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5339\u914d\u6807\u7b7e\u3002\u8fd9\u610f\u6627\u7740\u6807\u6709 env=test \u6807\u7b7e\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5c06\u88ab\u5305\u542b\u5728Istio\u76d1\u63a7\u548c\u66f4\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u5217\u8868\u4e2d\u3002 \u5982\u679c\u6211\u4eec\u7ed9foo\u547d\u540d\u7a7a\u95f4\u8d34\u4e0a env=test \u6807\u7b7e\uff0c\u7136\u540e\u5217\u51fa\u7aef\u70b9\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u73b0\u5728\u914d\u7f6e\u4e2d\u5217\u51fa\u7684\u7aef\u70b9\u6ca1\u6709\u90a3\u4e48\u591a\u3002 \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u6807\u6ce8\u7684\u552f\u4e00\u547d\u540d\u7a7a\u95f4\u662ffoo\u547d\u540d\u7a7a\u95f4\uff0c\u8fd9\u4e5f\u662fIstlo\u63a7\u5236\u5e73\u9762\u89c2\u5bdf\u548c\u53d1\u9001\u66f4\u65b0\u7684\u552f\u4e00\u547d\u540d\u7a7a\u95f4\u3002 $ istioctl proxy-config endpoints deploy/foo.foo \u5982\u679c\u6211\u4eec\u628a\u547d\u540d\u7a7a\u95f4bar\u4e5f\u8d34\u4e0a\u6807\u7b7e \uff0c\u7136\u540e\u91cd\u65b0\u8fd0\u884c istiocti proxy-config \u547d\u4ee4\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0bar\u7aef\u70b9\u663e\u793a\u4e3afoo\u670d\u52a1\u914d\u7f6e\u7684\u4e00\u90e8\u5206\u3002 $ istioctl proxy-config endpoints deploy/foo.foo","title":"\u914d\u7f6e\u53d1\u73b0\u9009\u62e9\u5668"},{"location":"chap8/2Istio_install/#4istio","text":"$ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh - $ cd istio-1.10.3 $ sudo cp bin/istioctl /usr/local/bin/istioctl $ istioctl version no running Istio pods in \"istio-system\" 1.10.3 Istlo\u652f\u6301\u591a\u4e2a\u914d\u7f6e\u6587\u4ef6\uff08 profile )\u3002\u914d\u7f6e\u6587\u4ef6\u4e4b\u95f4\u7684\u533a\u522b\u5728\u4e8e\u6240\u5b89\u88c5\u7684\u7ec4\u4ef6\u3002 $ istioctl profile list Istio configuration profiles: default demo empty external minimal openshift preview remote \u63a8\u8350\u7528\u4e8e\u751f\u4ea7\u90e8\u7f72\u7684\u914d\u7f6e\u6587\u4ef6\u662fdefault\u914d\u7f6e\u6587\u4ef6\u3002 \u6211\u4eec\u5c06\u5b89\u88c5demo\u914d\u7f6e\u6587\u4ef6\uff0c\u56e0\u4e3a\u5b83\u5305\u542b\u6240\u6709\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u542f\u7528\u4e86\u8ddf\u8e2a\u548c\u65e5\u5fd7\u8bb0\u5f55\uff0c\u4fbf\u4e8e\u5b66\u4e60\u4e0d\u540c\u7684Istio\u529f\u80fd\u3002 \u6211\u4eec\u4e5f\u53ef\u4ee5\u4eceminimal\u7684\u7ec4\u4ef6\u5f00\u59cb\uff0c\u4ee5\u540e\u5355\u72ec\u5b89\u88c5\u5176\u4ed6\u529f\u80fd\uff0c\u5982ingress\u548cegress\u7f51\u5173\u3002 \u56e0\u4e3a\u6211\u4eec\u5c06\u4f7f\u7528Istio Operator\u8fdb\u884c\u5b89\u88c5\uff0c\u6240\u4ee5\u6211\u4eec\u5fc5\u987b\u5148\u90e8\u7f72Operator0 \u8981\u90e8\u7f72 Istio Operator \uff0c\u8bf7\u8fd0\u884c $ istioctl operator init Installing operator controller in namespace: istio-operator using image: docker.io/istio/operator:1.10.3 Operator controller will watch namespaces: istio-system \u2714 Istio operator installed \u2714 Installation complete init\u547d\u4ee4\u521b\u5efa\u4e86 istio-operator \u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u90e8\u7f72\u4e86CRD\u3001Operator Deployment\u4ee5\u53caoperator\u5de5\u4f5c\u6240\u9700\u7684\u5176\u4ed6\u8d44\u6e90\u3002\u5b89\u88c5\u5b8c\u6210\u540e\uff0cOperator\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e86\u3002 \u8981\u5b89\u88c5Istio\uff0c\u6211\u4eec\u5fc5\u987b\u521b\u5efa IstioOperator \u8d44\u6e90\uff0c\u5e76\u6307\u5b9a\u6211\u4eec\u8981\u4f7f\u7528\u7684\u914d\u7f6e\u914d\u7f6e\u6587\u4ef6\u3002 \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a demo-profile.yaml \u7684\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: v1 kind: Namespace metadata: name: istio-system --- apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata: namespace: istio-system name: demo-istio-install spec: profile: demo \u5b89\u88c5 istio \u7684\u5de5\u5177\u548c\u6587\u4ef6\u51c6\u5907\u597d\u8fc7\u540e\uff0c\u76f4\u63a5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u5b89\u88c5\u547d\u4ee4\u5373\u53ef\uff0c\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u7684\u662f demo \u914d\u7f6e\u7ec4\u5408\u7684\u5f62\u5f0f\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u5305\u542b\u4e86\u4e00\u7ec4\u4e13\u4e3a\u6d4b\u8bd5\u51c6\u5907\u7684\u529f\u80fd\u96c6\u5408\uff0c\u53e6\u5916\u8fd8\u6709\u7528\u4e8e\u751f\u4ea7\u6216\u6027\u80fd\u6d4b\u8bd5\u7684\u914d\u7f6e\u7ec4\u5408\u3002 $ istioctl install --set profile=demo -y \u2714 Istio core installed \u2714 Istiod installed \u2714 Ingress gateways installed \u2714 Egress gateways installed \u2714 Installation complete Thank you for installing Istio 1.10. Please take a few minutes to tell us about your install/upgrade experience! https://forms.gle /KjkrDnMPByq7akrYA $ kubectl apply -f demo-profile.yaml namespace/istio-system unchanged istiooperator.install.istio.io/demo-istio-install created \u4e00\u65e6Operator\u68c0\u6d4b\u5230 IstioOperator \u8d44\u6e90\uff0c\u5b83\u5c06\u5f00\u59cb\u5b89\u88c5Istio\u3002\u6574\u4e2a\u8fc7\u7a0b\u53ef\u80fd\u9700\u89815\u5206\u949f\u5de6\u53f3\u3002 \u4e3a\u4e86\u68c0\u67e5\u5b89\u88c5\u7684\u72b6\u6001\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u7684Pod\u7684\u72b6\u6001\u3002 $ kubectl get pod -n istio-operator NAME READY STATUS RESTARTS AGE istio-operator-dbc5db55-wjngn 1/1 Running 0 8m16s $ kubectl get pod -n istio-system NAME READY STATUS RESTARTS AGE istio-egressgateway-5547fcc8fc-7kj9c 1/1 Running 0 7m17s istio-ingressgateway-8f568d595-zj9bs 1/1 Running 0 7m17s istiod-6659979bdf-l7kgk 1/1 Running 0 7m23s \u5f53\u6240\u6709\u7684Pod\u90fd\u5728\u8fd0\u884c\u65f6\uff0cOperator\u5df2\u7ecf\u5b8c\u6210\u4e86Istio\u7684\u5b89\u88c5\u3002","title":"4\u3001\u5b9e\u9a8cIstio\u5b89\u88c5"},{"location":"chap8/2Istio_install/#sidecar","text":"\u670d\u52a1\u7f51\u683c\u9700\u8981\u8ba9\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u540c\u65f6\u8fd0\u884csidecar\u4ee3\u7406\u3002 \u8981\u5c06sidecar\u4ee3\u7406\u6ce8\u5165\u5230\u73b0\u6709\u7684Kubernetes\u90e8\u7f72\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 istioctl \u547d\u4ee4\u4e2d\u7684 kube-inject \u52a8\u4f5c\u3002 \u7136\u800c\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728\u4efb\u610fKubernetes\u547d\u540d\u7a7a\u95f4\u4e0a\u542f\u7528sidecar\u81ea\u52a8\u6ce8\u5165\u3002\u5982\u679c\u6211\u4eec\u7528 istio-injection=enabled \u6807\u8bb0\u547d\u540d\u7a7a\u95f4\uff0cIstio\u4f1a\u81ea\u52a8\u4e3a\u6211\u4eec\u5728\u8be5\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u7684\u6240\u6709 Kubernetes Pod \u6ce8\u5165 sidecar \u8ba9\u6211\u4eec\u901a\u8fc7\u6dfb\u52a0\u6807\u7b7e\u6765\u542f\u7528default\u547d\u540d\u7a7a\u95f4\u7684sidecar\u81ea\u52a8\u6ce8\u5165\u3002 $ kubectl label namespace default istio-injection=enabled namespace/default labeled \u8981\u68c0\u67e5\u547d\u540d\u7a7a\u95f4\u662f\u5426\u88ab\u6807\u8bb0\uff0c\u8bf7\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u3002defaul\u4e03\u547d\u540d\u7a7a\u95f4\u5e94\u8be5\u662f\u552f\u4e00\u4e00\u4e2a\u542f\u7528\u4e86\u8be5\u503c\u7684\u547d\u540d\u7a7a\u95f4\u3002 $ kubectl get namespace -L istio-injection NAME STATUS AGE ISTIO-INJECTION default Active 12d enabled istio-operator Active 22m disabled istio-system Active 30m kube-demo Active 12d kube-node-lease Active 12d kube-public Active 12d kube-system Active 12d velero Active 12d \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5728defaul\u4e03\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u4e00\u4e2aDeployment\uff0c\u5e76\u89c2\u5bdf\u6ce8\u5165\u7684\u4ee3\u7406\u3002\u6211\u4eec\u5c06 \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a my-nginx \u7684 Deployment \uff0c\u4f7f\u7528nginx\u955c\u50cf\u7684\u5355\u4e00\u5bb9\u5668\u3002 kubectl create deploy my-nginx --image=nginx kubectl get pod NAME READY STATUS RESTARTS AGE my-nginx-6b74b79f57-ps779 2/2 Running 0 111s $ kubectl describe pod my-nginx-6b74b79f57-ps779 Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 2m27s default-scheduler Successfully assigned default/my-nginx-6b74b79f57-ps779 to docker-desktop Normal Pulled 2m24s kubelet, docker-desktop Container image \"docker.io/istio/proxyv2:1.10.3\" already present on machine Normal Created 2m23s kubelet, docker-desktop Created container istio-init Normal Started 2m23s kubelet, docker-desktop Started container istio-init Normal Pulling 2m22s kubelet, docker-desktop Pulling image \"nginx\" Normal Pulled 98s kubelet, docker-desktop Successfully pulled image \"nginx\" in 44.2681088s Normal Created 98s kubelet, docker-desktop Created container nginx Normal Started 98s kubelet, docker-desktop Started container nginx Normal Pulled 98s kubelet, docker-desktop Container image \"docker.io/istio/proxyv2:1.10.3\" already present on machine Normal Created 98s kubelet, docker-desktop Created container istio-proxy Normal Started 98s kubelet, docker-desktop Started container istio-proxy","title":"\u542f\u7528sidecar\u6ce8\u5165"},{"location":"chap8/2Istio_install/#4-istio","text":"1.\u5b89\u88c5\u540e\uff0cIstio\u4f1a\u81ea\u52a8\u5c06Envoy\u4ee3\u7406\u6ce8\u5165\u6240\u6709\u5728default\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u7684Kubernetes\u90e8\u7f72\u4e2d\u3002\u5bf9\u8fd8\u662f\u9519\uff1f A \u5bf9 B \u9519 2.Istio\u6709\u591a\u4e2a\u914d\u7f6e\u6587\u4ef6\u3002\u54ea\u79cd\u914d\u7f6e\u6587\u4ef6\u6700\u9002\u5408\u751f\u4ea7\u90e8\u7f72\uff1f Choose only ONE best answer. Default profile Production profile Minimal Demo 3.\u4f60\u53ef\u4ee5\u7528\u54ea\u4e2a\u6807\u7b7e\u6765\u542f\u7528\u81ea\u52a8sidecar\u6ce8\u5165\uff1f Choose only ONE best answer. A injection=enabled B sidecar-injection=1 C istio-injection=enabled D inject\uff1dtrue 4.\u8fd0\u884cEnvoy\u4ee3\u7406sidecar\u7684\u5bb9\u5668\u7684\u540d\u79f0\u662f\u4ec0\u4e48\uff1f Choose only ONE best answer. A istio-proxy B sidecar C envoy-proxy D proxy 5\u3002\u53ea\u53ef\u4ee5\u4f7f\u7528Istio CLI (istiocti\uff09\u6765\u5b89\u88c5Istio\uff0c\u5bf9\u8fd8\u662f\u9519\uff1f Choose only ONE best answer. A \u5bf9 B \u9519","title":"4\u3001\u6d4b\u9a8c\uff1a\u5b89\u88c5 Istio"},{"location":"chap8/3Istio_mon/","text":"\u7b2c\u4e09\u8282 \u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7 1\u3001\u6a21\u5757\u6982\u5ff5 \u5728\u8fd9\u4e2a\u6a21\u5757\u4e2d\uff0c\u5b66\u4e60\u4e00\u4e9b\u76d1\u63a7\uff08Prometheus)\u3001\u8ffd\u8e2a\uff08Zipkin)\u548c\u6570\u636e\u53ef\u89c6\u5316\u5de5\u5177 (Grafana)\u3002 \u4e3a\u4e86\u8ba9 Grafana \u548c Kiali \u5de5\u4f5c\uff0c\u6211\u4eec\u9996\u5148\u8981\u5b89\u88c5Prometheus\u63d2\u4ef6\u3002 1-1 \u53ef\u89c2\u5bdf\u6027 \u7531\u4e8e\u91c7\u7528\u4e86sidecar\u90e8\u7f72\u6a21\u5f0f\uff0c \u5373Envoy\u4ee3\u7406\u8fd0\u884c\u5728\u5e94\u7528\u5b9e\u4f8b\u65c1\u8fb9\u5e76\u62e6\u622a\u6d41\u91cf\uff0c\u8fd9\u4e9b\u4ee3\u7406\u4e5f\u6536\u96c6\u6307\u6807 \u3002 Envoy\u4ee3\u7406\u6536\u96c6\u7684\u6307\u6807\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u83b7\u5f97\u7cfb\u7edf\u72b6\u6001\u7684\u53ef\u89c1\u6027\u3002 \u83b7\u5f97\u7cfb\u7edf\u7684\u8fd9\u79cd\u53ef\u89c1\u6027\u662f\u81f3\u5173\u91cd\u8981\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u4e86\u89e3\u6b63\u5728\u53d1\u751f\u7684\u4e8b\u60c5\uff0c\u5e76\u6388\u6743\u8fd0\u7ef4\u4eba\u5458\u5bf9\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u6545\u969c\u6392\u9664\u3001\u7ef4\u62a4\u548c\u4f18\u5316\u3002 Istio\u751f\u6210\u4e09\u79cd\u7c7b\u578b\u7684\u9065\u6d4b\u6570\u636e\uff0c\u4e3a\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b\u53ef\u89c2\u5bdf\u6027 \uff1a \u6307\u6807\u5ea6\u91cf\uff08Metric) \u5206\u5e03\u5f0f\u8ffd\u8e2a \u8bbf\u95ee\u65e5\u5fd7 1-2 \u6307\u6807 Istlo\u57fa\u4e8e\u56db\u4e2a\u9ec4\u91d1\u4fe1\u53f7\u751f\u6210\u6307\u6807\uff1a \u5ef6\u8fdf\u3001\u6d41\u91cf\u3001\u9519\u8bef\u548c\u9971\u548c\u5ea6 \u3002 Latency : the time it takes to service a request Traffic : how much demand is placed on the system Errors : rate of failed requests Saturation : how full the most constrained resources of service are Collected at Envoy proxy, service, and control plane \u5ef6\u8fdf\u8868\u793a\u670d\u52a1\u4e00\u4e2a\u8bf7\u6c42\u6240\u9700\u7684\u65f6\u95f4\u3002\u8fd9\u4e2a\u6307\u6807\u5e94\u8be5\u5206\u6210\u6210\u529f\u8bf7\u6c42\uff08\u5982\u65e5I 1P200)\u548c\u5931\u8d25\u8bf7\u6c42 \uff08\u5982HTTP 500\uff09\u7684\u5ef6\u8fdf\u3002 \u6d41\u91cf\u662f\u8861\u91cf\u5bf9\u7cfb\u7edf\u7684\u9700\u6c42\u6709\u591a\u5927\uff0c\u5b83\u662f\u4ee5\u7cfb\u7edf\u7684\u5177\u4f53\u6307\u6807\u6765\u8861\u91cf\u7684\u3002\u4f8b\u5982\uff0c\u6bcf\u79d2\u7684HTTP\u8bf7\u6c42\uff0c\u6216\u5e76\u53d1\u4f1a\u8bdd\uff0c\u6bcf\u79d2\u7684\u68c0\u7d22\u91cf\uff0c\u7b49\u7b49 \u3002 \u9519\u8bef\u7528\u6765\u8861\u91cf\u8bf7\u6c42\u5931\u8d25\u7684\u6bd4\u7387 \uff08\u4f8b\u5982HTTP 500)\u3002 \u9971\u548c\u5ea6\u8861\u91cf\u4e00\u4e2a\u670d\u52a1\u4e2d\u6700\u7d27\u5f20\u7684\u8d44\u6e90\u6709\u591a\u6ee1\u3002\u4f8b\u5982\uff0c\u7ebf\u7a0b\u6c60\u7684\u5229\u7528\u7387 \u3002 \u8fd9\u4e9b\u6307\u6807\u662f\u5728\u4e0d\u540c\u7684\u5c42\u9762\u4e0a\u6536\u96c6\u7684\uff0c \u9996\u5148\u662f\u6700\u7ec6\u7684\uff0c\u5373Envoy\u4ee3\u7406\u5c42\u9762\uff0c\u7136\u540e\u662f\u670d\u52a1\u5c42\u9762\u548c\u63a7\u5236\u5e73\u9762\u7684\u6307\u6807 \u3002 1-3 \u4ee3\u7406\u7ea7\u6307\u6807 \u751f\u6210\u6307\u6807\u7684\u5173\u952e\u89d2\u8272\u662fEnvoy\uff0c\u5b83\u751f\u6210\u4e86\u4e00\u5957\u5173\u4e8e\u6240\u6709\u901a\u8fc7\u4ee3\u7406\u7684\u6d41\u91cf\u7684\u4e30\u5bcc\u6307\u6807\u3002\u4f7f\u7528 Envoy\u751f\u6210\u7684\u6307\u6807\uff0c\u6211\u4eec\u53ef\u4ee5\u4ee5\u6700\u4f4e\u7684\u7c92\u5ea6\u6765\u76d1\u63a7\u670d\u52a1\u7f51\u683c\uff0c\u4f8b\u5982Envoy\u4ee3\u7406\u4e2d\u7684\u6bcf\u4e2a\u76d1\u542c \u5668\u548c\u96c6\u7fa4\u7684\u6307\u6807\u3002 \u4f5c\u4e3a\u7f51\u683c\u8fd0\u7ef4\u4eba\u5458\uff0c\u6211\u4eec\u6709\u80fd\u529b\u63a7\u5236\u751f\u6210\u548c\u6536\u96c6\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u4f8b\u4e2d\u7684\u54ea\u4e9bEnvoy\u6307\u6807\u3002 \u4e0b\u9762\u662f\u51e0\u4e2a\u4ee3\u7406\u7ea7\u6307\u6807\u7684\u4f8b\u5b50\u3002 envoy_cluster_internal_upstream_rq{response_code_class=\"2xx\",cluster_name=\"xds-grpc\"} 7163 envoy_cluster_upstream_rq_completed{cluster_name=\"xds-grpc\"} 7164 envoy_cluster_ssl_connection_error{cluster_name=\"xds-grpc\"} 0 envoy_cluster_lb_subsets_removed{cluster_name=\"xds-grpc\"} 0 envoy_cluster_internal_upstream_rq{response_code=\"503\",cluster_name=\"xds-grpc\"} 1 \u6ce8\u610f\u4f60\u53ef\u4ee5\u4ece\u6bcf\u4e2a\u538bEnvoy\u4ee3\u7406\u5b9e\u4f8b\u7684\uff0fStats \u7aef\u70b9\u67e5\u770b\u4ee3\u7406\u7ea7\u6307\u6807\u3002 1-4 \u670d\u52a1\u7ea7\u6307\u6807 \u670d\u52a1\u7ea7\u522b\u7684\u6307\u6807\u6db5\u76d6\u4e86\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u56db\u4e2a\u9ec4\u91d1\u4fe1\u53f7\u3002 \u8fd9\u4e9b\u6307\u6807\u4f7f\u6211\u4eec\u80fd\u591f\u76d1\u63a7\u670d\u52a1\u4e0e\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u3002\u6b64\u5916\uff0cIstlo\u8fd8\u63d0\u4f9b\u4e86\u4e00\u7ec4\u4eea\u8868\u76d8\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u8fd9\u4e9b\u6307\u6807\u6765\u76d1\u63a7\u670d\u52a1\u884c\u4e3a \u3002 \u5c31\u50cf\u4ee3\u7406\u7ea7\u522b\u7684\u6307\u6807\u4e00\u6837\uff0c\u8fd0\u7ef4\u4eba\u5458\u53ef\u4ee5\u81ea\u5b9a\u4e49\u6536\u96c6\u54ea\u4e9b\u670d\u52a1\u7ea7\u522b\u7684\u6307\u6807\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\u7684\u6807\u51c6\u6307\u6807\u96c6\u4f1a\u88ab\u5bfc\u51fa\u5230Prometheus \u4e0b\u9762\u662f\u51e0\u4e2a\u670d\u52a1\u7ea7\u6307\u6807\u7684\u4f8b\u5b50\uff1a istio_requests_total{ connection_security_policy=\"mutual_tls\", destination_app=\"hello-world\", destination_canonical_service=\"hello-world\", destination_canonical_revision=\"v1\", destination_principal=\"cluster.local/ns/default/sa/default\", destination_service=\"hello-world.default.svc.cluster.local\", destination_service_name=\"hello-world\", destination_service_namespace=\"default\", destination_version=\"v1\", destination_workload=\"hello-world-v1\", destination_workload_namespace=\"default\", reporter=\"destination\", request_protocol=\"http\", response_code=\"200\", response_flags=\"-\", source_app=\"hello-web\", source_canonical_service=\"hello-web\", source_canonical_revision=\"v1\", source_principal=\"cluster.local/ns/default/sa/default\", source_version=\"v1\", source_workload=\"hello-web-v1\", source_workload_namespace=\"default\" } 981 1-5 \u63a7\u5236\u5e73\u9762\u5ea6\u91cf Istio\u4e5f\u4f1a\u751f\u6210\u63a7\u5236\u5e73\u9762\u6307\u6807\uff0c\u7528\u4e8e\u76d1\u63a7Istio\u7684\u63a7\u5236\u5e73\u9762\uff0c\u800c\u4e0d\u662f\u7528\u6237\u670d\u52a1\u3002 \u8f93\u51fa\u7684\u63a7\u5236\u5e73\u9762\u6307\u6807\u7684\u5b8c\u6574\u5217\u8868\u53ef\u4ee5\u5728 \u8fd9\u91cc \u627e\u5230\u3002 \u63a7\u5236\u5e73\u9762\u6307\u6807\u5305\u62ec\u51b2\u7a81\u7684\u5165\u7ad9\uff0f\u51fa\u7ad9\u76d1\u542c\u5668\u7684\u6570\u91cf\u3001\u6ca1\u6709\u5b9e\u4f8b\u7684\u96c6\u7fa4\u6570\u91cf\u3001\u88ab\u62d2\u7edd\u6216\u88ab\u5ffd\u7565\u7684\u914d\u7f6e\u7b49\u6307\u6807\u3002 2\u3001Prometheus Prometheus Open-source monitoring system and time series DB Records metrics: Track mesh health Track application health Install from /samples/addons folder istioctl dashboard prometheus Prometheus\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u76d1\u63a7\u7cfb\u7edf\u548c\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\u3002Istlo\u4f7f\u7528Prometheus\u6765\u8bb0\u5f55\u6307\u6807\uff0c\u8ddf\u8e2aIstio\u548c\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5\u3002 \u8981\u5b89\u88c5Prometheus\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Istio\u5b89\u88c5\u5305\u4e2d\uff0fsamples/addons \u6587\u4ef6\u5939\u4e2d\u7684\u793a\u4f8b\u5b89\u88c5\u3002 $ kubectl apply -f istio-1.10.3/samples/addons/prometheus.yaml serviceaccount/prometheus created configmap/prometheus created clusterrole.rbac.authorization.k8s.io/prometheus created clusterrolebinding.rbac.authorization.k8s.io/prometheus created service/prometheus created deployment.apps/prometheus created $ kubectl get pod -n istio-system NAME READY STATUS RESTARTS AGE istio-egressgateway-5547fcc8fc-7kj9c 1/1 Running 0 4h31m istio-ingressgateway-8f568d595-zj9bs 1/1 Running 0 4h31m istiod-6659979bdf-l7kgk 1/1 Running 0 4h31m prometheus-8958b965-hpp2v 2/2 Running 0 2m11s \u8981\u6253\u5f00 Prometheus \u4eea\u8868\u677f\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Istio CLI \u4e2d\u7684 $ Istioctl dashboard prometheus http://localhost:9090 \u90e8\u7f72\u5b9e\u4f8b\u5e94\u7528 \u4e3a\u4e86\u80fd\u591f\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf\u5e76\u8bbf\u95eeNginx Pod\uff0c\u6211\u4eec\u9700\u8981\u4ee5\u67d0\u79cd\u65b9\u5f0f\u8ba9\u5b83\u53ef\u4ee5\u88ab\u8bbf\u95ee\u3002 \u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u5c06Nginx\u90e8\u7f72\u4f5c\u4e3a\u670d\u52a1\u516c\u5f00\uff1a kubectl create deploy my-nginx --image=ngix kubectl expose deployment my-nginx --type=NodePort --name=my-nginx --port 80 service/my-nginx exposed \u6ce8\u610f\uff1a \u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528Istio\u8d44\u6e90\u5e76\u901a\u8fc7Istio\u7684\u5165\u53e3\u7f51\u5173\u66b4\u9732\u670d \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c kubectl get services \uff0c\u83b7\u5f97 my-nginx \u670d\u52a1\u7684\u5916\u90e8IP\u5730\u5740\uff1a $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 <none> 443/TCP 13d my-nginx NodePort 10.109.102.197 <none> 80:31837/TCP 2s $ curl 127.0.0.1:$(kubectl get service my-nginx -o jsonpath='{.spec.ports[0].nodePort}') <!DOCTYPE html> <html> <head> <title>Welcome to nginx!</title> <style> html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } </style> </head> <body> <h1>Welcome to nginx!</h1> <p>If you see this page, the nginx web server is successfully installed and working. Further configuration is required.</p> <p>For online documentation and support please refer to <a href=\"http://nginx.org/\">nginx.org</a>.<br/> Commercial support is available at <a href=\"http://nginx.com/\">nginx.com</a>.</p> <p><em>Thank you for using nginx.</em></p> </body> </html> \u7136\u540e\uff0c\u4ece Prometheus UI \u4e2d\uff0c\u4f60\u53ef\u4ee5\u641c\u7d22Istio\u7684\u4e00\u4e2a\u6307\u6807\uff08\u4f8b\u5982 istio_requests_total{app=\"my-nginx\"} )\uff0c\u4ee5\u4e86\u89e3\u54ea\u4e9b\u6570\u636e\u70b9\u6b63\u5728\u88ab\u6536\u96c6\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u6765\u81eaPrometheus\u7528\u6237\u754c\u9762\u7684\u793a\u4f8b\u5143\u7d20\uff1a $ istio_requests_total{app=\"my-nginx\"} istio_requests_total{app=\"my-nginx\", connection_security_policy=\"none\", destination_app=\"my-nginx\", destination_canonical_revision=\"latest\", destination_canonical_service=\"my-nginx\", destination_cluster=\"Kubernetes\", destination_principal=\"unknown\", destination_service=\"my-nginx.default.svc.cluster.local\", destination_service_name=\"my-nginx\", destination_service_namespace=\"default\", destination_version=\"unknown\", destination_workload=\"my-nginx\", destination_workload_namespace=\"default\", instance=\"10.1.0.221:15020\", istio_io_rev=\"default\", job=\"kubernetes-pods\", kubernetes_namespace=\"default\", kubernetes_pod_name=\"my-nginx-6b74b79f57-6spkz\", pod_template_hash=\"6b74b79f57\", reporter=\"destination\", request_protocol=\"http\", response_code=\"200\", response_flags=\"-\", security_istio_io_tlsMode=\"istio\", service_istio_io_canonical_name=\"my-nginx\", service_istio_io_canonical_revision=\"latest\", source_app=\"unknown\", source_canonical_revision=\"latest\", source_canonical_service=\"unknown\", source_cluster=\"unknown\", source_principal=\"unknown\", source_version=\"unknown\", source_workload=\"unknown\", source_workload_namespace=\"unknown\"} 2 3\u3001Grafana 3-1 Grafana Open platform for analytics and monitoring Connects to Prometheus (and other sources) Monitor health of lstio and apps in the mesh Install from /samples/addons folder istioctl dashboard grafana Grafana\u662f\u4e00\u4e2a\u7528\u4e8e\u5206\u6790\u548c\u76d1\u63a7\u7684\u5f00\u653e\u5e73\u53f0\u3002Grafana\u53ef\u4ee5\u8fde\u63a5\u5230\u5404\u79cd\u6570\u636e\u6e90\uff0c\u5e76\u4f7f\u7528\u56fe\u5f62\u3001 \u8868\u683c\u3001\u70ed\u56fe\u7b49\u5c06\u6570\u636e\u53ef\u89c6\u5316\u3002\u901a\u8fc7\u5f3a\u5927\u7684\u67e5\u8be2\u8bed\u8a00\uff0c\u4f60\u53ef\u4ee5\u5b9a\u5236\u73b0\u6709\u7684\u4eea\u8868\u76d8\u5e76\u521b\u5efa\u66f4\u9ad8\u7ea7\u7684\u53ef\u89c6\u5316\u3002 \u901a\u8fc7Grafana\uff0c\u6211\u4eec\u53ef\u4ee5\u76d1\u63a7Istio\u5b89\u88c5\u548c\u670d\u52a1\u7f51\u683c\u4e2d\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5\u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528grafana . yami\u6765\u90e8\u7f72\u5e26\u6709\u9884\u914d\u7f6e\u4eea\u8868\u76d8\u7684Grafana\u793a\u4f8b\u5b89\u88c5\u3002\u8be5YAML\u6587\u4ef6\u5728Istio\u5b89\u88c5\u5305\u7684 /samples /addons \u4e0b\u3002 \u786e\u4fdd\u5728\u90e8\u7f72Grafana\u4e4b\u524d\u90e8\u7f72 Promeheus \u63d2\u4ef6\uff0c\u56e0\u4e3a Grafana \u4f7f\u7528 Prometheus \u4f5c\u4e3a\u5176\u6570\u636e\u6e90\u3002 \u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u90e8\u7f72 Grafana \u548c\u9884\u914d\u7f6e\u7684\u4eea\u8868\u76d8\uff1a $ kubectl apply -f istio-1.10.3/samples/addons/grafana.yaml serviceaccount/grafana created configmap/grafana created service/grafana created deployment.apps/grafana created configmap/istio-grafana-dashboards created configmap/istio-services-grafana-dashboards created $ kubectl get pod -n istio-system NAME READY STATUS RESTARTS AGE grafana-56d978ff77-d6m4w 1/1 Running 0 64s istio-egressgateway-5547fcc8fc-7kj9c 1/1 Running 0 2d4h istio-ingressgateway-8f568d595-zj9bs 1/1 Running 0 2d4h istiod-6659979bdf-l7kgk 1/1 Running 0 2d4h prometheus-8958b965-hpp2v 2/2 Running 0 47h \u8fd9\u4e2aGrafana\u3002\u5b89\u88c5\u4e0d\u6253\u7b97\u5728\u751f\u4ea7\u4e2d\u8fd0\u884c\uff0c\u56e0\u4e3a\u5b83\u6ca1\u6709\u7ecf\u8fc7\u6027\u80fd\u6216\u5b89\u5168\u65b9\u9762\u7684\u8c03\u6574\u3002 Kubernetes\u5c06Grafana\u90e8\u7f72\u5728 istio-System \u547d\u540d\u7a7a\u95f4\u3002\u8981\u8bbf\u95eeGrafana\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 istioctl dashboard $ istioctl dashboard grafana http://localhost:3000 \u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 http://localhost:3000 \uff0c\u8fdb\u5165Grafana\u3002\u7136\u540e\uff0c\u70b9\u51fb\u9996\u9875\u548cistlo\u6587\u4ef6\u5939\uff0c\u67e5\u770b\u5df2\u5b89\u88c5\u7684\u4eea\u8868\u76d8\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 Istio Grafana\u5b89\u88c5\u65f6\u9884\u914d\u7f6e\u4e86\u4ee5\u4e0b\u4eea\u8868\u76d8\uff1a 1.Istlo\u63a7\u5236\u5e73\u9762\u4eea\u8868\u76d8 \u4eceIstio\u63a7\u5236\u5e73\u9762\u4eea\u8868\u76d8\uff0c\u6211\u4eec\u53ef\u4ee5\u76d1\u63a7Istio\u63a7\u5236\u5e73\u9762\u7684\u5065\u5eb7\u548c\u6027\u80fd\u3002 \u8fd9\u4e2a\u4eea\u8868\u76d8\u5c06\u5411\u6211\u4eec\u5c55\u793a\u63a7\u5236\u5e73\u9762\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff08\u5185\u5b58\u3001CPU'\u78c1\u76d8\u3001Go routines)\uff0c\u4ee5\u53ca\u5173\u4e8ePiIot\u3001 Envoy\u548cWebhook\u7684\u4fe1\u606f\u3002 2.Istio\u7f51\u683c\u4eea\u8868\u76d8 \u7f51\u683c\u4eea\u8868\u76d8\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u5728\u7f51\u683c\u4e2d\u8fd0\u884c\u7684\u6240\u6709\u670d\u52a1\u7684\u6982\u89c8\u3002\u4eea\u8868\u76d8\u5305\u62ec\u5168\u5c40\u8bf7\u6c42\u91cf\u3001\u6210\u529f\u7387\u4ee5\u53ca 4xx\u548c 5xx \u54cd\u5e94\u7684\u6570\u91cf\u3002 3. Istlo\u6027\u80fd\u4eea\u8868\u76d8 \u6027\u80fd\u4eea\u8868\u76d8\u5411\u6211\u4eec\u5c55\u793a\u4e86Istio\u4e3b\u8981\u7ec4\u4ef6\u5728\u7a33\u5b9a\u8d1f\u8f7d\u4e0b\u7684\u8d44\u6e90\u5229\u7528\u7387\u3002 4.Istlo\u670d\u52a1\u4eea\u8868\u76d8 \u670d\u52a1\u4eea\u8868\u76d8\u5141\u8bb8\u6211\u4eec\u5728\u7f51\u683c\u4e2d\u67e5\u770b\u670d\u52a1\u7684\u7ec6\u8282\u3002 \u6211\u4eec\u53ef\u4ee5\u83b7\u5f97\u5173\u4e8e\u8bf7\u6c42\u91cf\u3001\u6210\u529f\u7387\u3001\u6301\u7eed\u65f6\u95f4\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u663e\u793a\u6309\u6765\u6e90\u548c\u54cd\u5e94\u4ee3\u7801\u3001\u6301\u7eed\u65f6\u95f4\u548c\u5927\u5c0f\u7684\u4f20\u5165\u8bf7\u6c42\u7684\u8be6\u7ec6\u56fe\u8868\u3002 5. Istlo Wasm\u6269\u5c55\u4eea\u8868\u76d8 Istlo Wasm\u6269\u5c55\u4eea\u8868\u76d8\u663e\u793a\u4e0eWebAssembly\u6a21\u5757\u6709\u5173\u7684\u6307\u6807\u3002\u4ece\u8fd9\u4e2a\u4eea\u8868\u76d8\uff0c\u6211\u4eec\u53ef\u4ee5\u76d1\u63a7\u6d3b\u52a8\u7684\u548c\u521b\u5efa\u7684Wasm\u865a\u62df\u673a\uff0c\u5173\u4e8e\u83b7\u53d6\u5220\u9664Wasm\u6a21\u5757\u548c\u4ee3\u7406\u8d44\u6e90\u4f7f\u7528\u7684\u6570\u636e\u3002 6. Istlo\u5de5\u4f5c\u8d1f\u8f7d\u4eea\u8868\u76d8 \u8fd9\u4e2a\u4eea\u8868\u76d8\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8be6\u7ec6\u6307\u6807\u5206\u7c7b\u3002 4\u3001Zipkin 4-1 Trace and spans Trace : collection of spans Span : name, start/finish timestamp, tags, context Tags : applied to all spans, used for querying/filtering Spans are sent to the collector to validate, index & store the data \u5206\u5e03\u5f0f\u8ffd\u8e2a\u662f\u4e00\u79cd\u76d1\u6d4b\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u7684\u65b9\u6cd5\u3002 \u4f7f\u7528\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8bf7\u6c42\u901a\u8fc7\u88ab\u76d1\u63a7\u7cfb\u7edf\u7684\u4e0d\u540c\u90e8\u5206\u65f6\u8ffd\u8e2a\u5b83\u4eec \u3002 \u6bcf\u5f53\u4e00\u4e2a\u8bf7\u6c42\u8fdb\u5165\u670d\u52a1\u7f51\u683c\u65f6\uff0cEnvoy\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a\u552f\u4e00\u7684\u8bf7\u6c42ID\u548c\u8ffd\u8e2a\u4fe1\u606f\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3aHTTP\u5934\u7684\u4e00\u90e8\u5206\u6765\u5b58\u50a8 \u3002\u4efb\u4f55\u5e94\u7528\u7a0b\u5e8f\u90fd\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u5934\u4fe1\u606f\u8f6c\u53d1\u7ed9\u5b83\u6240\u8c03\u7528\u7684\u5176\u4ed6\u670d\u52a1\uff0c\u4ee5\u4fbf\u5728\u7cfb\u7edf\u4e2d\u521b\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684\u8ffd\u8e2a\u3002 \u5206\u5e03\u5f0f\u8ffd\u8e2a\u662f\u4e00\u4e2a\u8de8\u5ea6\uff08span)\u7684\u96c6\u5408\u3002 \u5f53\u8bf7\u6c42\u6d41\u7ecf\u4e0d\u540c\u7684\u7cfb\u7edf\u7ec4\u4ef6\u65f6\uff0c\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\u8de8\u5ea6\u3002\u6bcf\u4e2a\u8de8\u5ea6\u90fd\u6709\u4e00\u4e2a\u540d\u79f0\uff0c\u5f00\u59cb\u548c\u7ed3\u675f\u7684\u65f6\u95f4\u6233\uff0c\u4e00\u7ec4\u79f0\u4e3a\u6807\u7b7e\uff08tag\uff09\u548c\u65e5\u5fd7\uff08log) \u7684\u952e\u503c\u5bf9\uff0c\u4ee5\u53ca\u4e00\u4e2a\u8de8\u5ea6\u4e0a\u4e0b\u6587\u3002 \u6807\u7b7e\u88ab\u5e94\u7528\u4e8e\u6574\u4e2a\u8de8\u5ea6\uff0c\u5e76\u7528\u4e8e\u67e5\u8be2\u548c\u8fc7\u6ee4\u3002\u4e0b\u9762\u662f\u6211\u4eec\u5728\u4f7f\u7528Zipkin\u65f6\u5c06\u770b\u5230\u7684\u51e0\u4e2a\u6807\u7b7e\u7684\u4f8b\u5b50\u3002\u6ce8\u610f\uff0c\u5176\u4e2d\u6709\u4e9b\u662f\u901a\u7528\u7684\uff0c\u6709\u4e9b\u662flstio\u7279\u6709\u7684\uff1a Examples: istio.mesh_id istio.canonical_service upstream_cluster http.url http.status_code zone \u5355\u4e2a\u8de8\u5ea6\u4e0e\u8bc6\u522b\u8de8\u5ea6\u3001\u7236\u8de8\u5ea6\u3001\u8ffd\u8e2aID\u7684\u4e0a\u4e0b\u6587\u5934\u4e00\u8d77\u88ab\u53d1\u9001\u5230\u4e00\u4e2a\u53eb\u505a\u91c7\u96c6\u5668\u7684\u7ec4\u4ef6\u3002\u91c7\u96c6\u5668\u5bf9\u6570\u636e\u8fdb\u884c\u9a8c\u8bc1\u3001\u7d22\u5f15\u548c\u5b58\u50a8\u3002 \u5f53\u8bf7\u6c42\u6d41\u7ecfEnvoy\u4ee3\u7406\u65f6\uff0cEnvoy\u4ee3\u7406\u4f1a\u81ea\u52a8\u53d1\u9001\u5404\u4e2a\u8de8\u5ea6\u3002 \u8bf7\u6ce8\u610f\uff0cEnvoy\u53ea\u80fd\u5728\u8fb9\u7f18\u6536\u96c6\u8de8\u5ea6\u3002\u6211\u4eec\u8981\u8d1f\u8d23\u5728\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u751f\u6210\u4efb\u4f55\u989d\u5916\u7684\u8de8\u5ea6\uff0c\u5e76\u786e\u4fdd\u6211\u4eec\u5728\u8c03\u7528\u5176\u4ed6\u670d\u52a1\u65f6\u8f6c\u53d1\u8ffd\u8e2a\u5934\u4fe1\u606f\u3002\u8fd9\u6837\u4e00\u6765\uff0c\u5404\u4e2a\u8de8\u5ea6\u5c31\u53ef\u4ee5\u6b63\u786e\u5730\u5173\u8054\u5230\u4e00\u4e2a\u5355\u4e00\u7684\u8ffd\u8e2a\u4e2d\u3002 4-2 Distributed Tracing with Zipkin Zipkin = distributed tracing system Discover latency and performance issues Requirements: propagate HTTP headers (B3 and Envoy request ID) Traces captured at service boundaries Instrument your applications Install from /samples/addons/extras folder istioctl dashboard zipkin 5\u3001\u4f7f\u7528Zipkin\u8fdb\u884c\u5206\u5e03\u5f0f\u8ffd\u8e2a Zipkin\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf\u3002\u6211\u4eec\u53ef\u4ee5\u8f7b\u677e\u5730\u76d1\u63a7\u670d\u52a1\u7f51\u683c\u4e2d\u53d1\u751f\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\uff0c\u53d1\u73b0\u4efb\u4f55\u6027\u80fd\u6216\u5ef6\u8fdf\u95ee\u9898\u3002 \u4e3a\u4e86\u8ba9\u6211\u4eec\u7684\u670d\u52a1\u53c2\u4e0e\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff0c\u6211\u4eec\u9700\u8981\u5728\u8fdb\u884c\u4efb\u4f55\u4e0b\u6e38\u670d\u52a1\u8c03\u7528\u65f6\u4f20\u64ad\u670d\u52a1\u7684HTTP\u5934\u4fe1\u606f\u3002\u5c3d\u7ba1\u6240\u6709\u7684\u8bf7\u6c42\u90fd\u8981\u7ecf\u8fc7 Istio sidecar \uff0c \u4f46 Istio \u6ca1\u6709\u529e\u6cd5\u5c06\u51fa\u7ad9\u8bf7\u6c42\u4e0e\u4ea7\u751f\u8fd9\u4e9b\u8bf7\u6c42\u7684\u5165\u7ad9\u8bf7\u6c42\u8054\u7cfb\u8d77\u6765\u3002\u901a\u8fc7\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4f20\u64ad\u76f8\u5173\u7684\u5934\u4fe1\u606f\u53ef\u4ee5\u5e2e\u52a9Zipkin\u5c06\u8fd9\u4e9b\u8ddf\u8e2a\u4fe1\u606f\u62fc\u63a5\u8d77\u6765\u3002 Istio\u4f9d\u8d56\u4e8eB3\u8ddf\u8e2a\u5934\uff08\u4ee5 x-b3 \u5f00\u5934\u7684header) \u548cEnvoy\u751f\u6210\u7684\u8bf7\u6c42ID ( x-request-Id )\u3002B3\u5934\u4fe1\u606f\u7528\u4e8e\u8de8\u670d\u52a1\u8fb9\u754c\u7684\u8ddf\u8e2a\u4e0a\u4e0b\u6587\u4f20\u64ad\u3002 \u4ee5\u4e0b\u662f\u6211\u4eec\u9700\u8981\u5728\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5bf9\u6bcf\u4e2a\u53d1\u51fa\u7684\u8bf7\u6c42\u8fdb\u884c\u4f20\u64ad\u7684\u7279\u5b9a\u5934\u6587\u4ef6\u540d\u79f0 \uff1a x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid ` x-b3-sampled x-b3-flags b3 \u5982\u679c\u4f60\u4f7f\u7528Lightstep\uff0c\u4f60\u8fd8\u9700\u8981\u8f6c\u53d1\u540d\u4e3a x-ot-span-context \u7684\u5934\u3002 \u4f20\u64ad\u5934\u4fe1\u606f\u6700\u5e38\u89c1\u7684\u65b9\u6cd5\u662f\u4ece\u4f20\u5165\u7684\u8bf7\u6c42\u4e2d\u590d\u5236\u5b83\u4eec\uff0c\u5e76\u5c06\u5b83\u4eec\u5305\u542b\u5728\u6240\u6709\u4ece\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u53d1\u51fa\u7684\u8bf7\u6c42\u4e2d \u4f60\u7528Istio\u670d\u52a1\u7f51\u683c\u5f97\u5230\u7684\u8ddf\u8e2a\u53ea\u5728\u670d\u52a1\u8fb9\u754c\u6355\u83b7\u3002\u4e3a\u4e86\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u7684\u884c\u4e3a\u5e76\u6392\u9664\u6545\u969c\uff0c\u4f60\u9700\u8981\u901a\u8fc7\u521b\u5efa\u989d\u5916\u7684\u8de8\u5ea6\uff08span)\u6765\u6b63\u786e\u68c0\u6d4b\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u3002 \u8981\u5b89\u88c5Zipkin\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528addons\u6587\u4ef6\u5939\u4e2d\u7684\uff1a zipkin.yaml \u6587\u4ef6\u3002 $ kubectl apply -f istio-1.10.3/samples/addons/extras/zipkin.yaml deployment.apps/zipkin created service/tracing created service/zipkin created \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c getmesh istioctl dashboard zipkin \u6765\u6253\u5f00Zipkin\u4eea\u8868\u677f\u3002\u5728\u7528\u6237\u754c\u9762\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u8ddf\u8e2a\u67e5\u8be2\u7684\u6807\u51c6\u3002\u70b9\u51fb\u6309\u94ae\uff0c\u4ece\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9 serviceName \uff0c\u7136\u540e\u9009\u62e9 customers. default service\uff0c\u70b9\u51fb\u641c\u7d22\u6309\u94ae\uff08\u6216\u6309\u56de\u8f66\u952e\uff09\uff0c\u5c31\u53ef\u4ee5\u641c\u7d22\u5230 trace \u4fe1\u606f\u3002 \u6211\u4eec\u53ef\u4ee5\u70b9\u51fb\u4e2a\u522btrace\u6765\u6df1\u5165\u6316\u6398\u4e0d\u540c\u7684\u8de8\u5ea6\u3002\u8be6\u7ec6\u7684\u89c6\u56fe\u5c06\u663e\u793a\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u65f6\u95f4\uff0c\u4ee5\u53ca\u8bf7\u6c42\u7684\u7ec6\u8282\uff0c\u5982\u65b9\u6cd5\u3001\u534f\u8bae\u3001\u72b6\u6001\u7801\u7b49\u3002 \u7531\u4e8e\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u670d\u52a1\u5728\u8fd0\u884c\uff08Nginx)\uff0c\u6240\u4ee5\u4f60\u4e0d\u4f1a\u770b\u5230\u5f88\u591a\u7ec6\u8282\u3002\u7a0d\u540e\uff0c\u6211\u4eec\u5c06\u56de\u5230Zipkin\uff0c\u66f4\u8be6\u7ec6\u5730\u63a2\u7d22\u8fd9\u4e9btrace 6\u3001Kiali Kiali\u662f\u4e00\u4e2a\u57fa\u4e8eIstio\u7684\u670d\u52a1\u7f51\u683c\u7684\u7ba1\u7406\u63a7\u5236\u53f0 \u3002\u5b83\u63d0\u4f9b\u4e86\u4eea\u8868\u76d8\u3001\u53ef\u89c2\u5bdf\u6027\uff0c\u5e76\u8ba9\u6211\u4eec\u901a\u8fc7\u5f3a\u5927\u7684\u914d\u7f6e\u548c\u9a8c\u8bc1\u80fd\u529b\u6765\u64cd\u4f5c\u7f51\u683c\u3002\u5b83\u901a\u8fc7\u63a8\u65ad\u6d41\u91cf\u62d3\u6251\u6765\u663e\u793a\u670d\u52a1\u7f51\u683c\uff0c\u5e76\u663e\u793a\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u51b5\u3002 Kiali\u63d0\u4f9b\u4e86\u8be6\u7ec6\u7684\u6307\u6807\uff0c\u5f3a\u5927\u7684\u9a8c\u8bc1\uff0cGrafana\u8bbf\u95ee\uff0c\u4ee5\u53ca\u4e0e Jaeger \u7684\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7684\u5f3a\u5927\u96c6\u6210\u3002 \u8981\u5b89\u88c5Kiali\uff0c\u8bf7\u4f7f\u7528 addons \u6587\u4ef6\u5939\u4e2d\u7684 kiali.yaml \u6587\u4ef6\uff1a kubectl apply -f istio-1.10.3/samples/addons/kiali.yaml \u6ce8\u610f\uff0c\u5982\u679c\u4f60\u770b\u5230\u4efb\u4f55\u9519\u8bef\uff0c\u4f8b\u5982\u5728\u7248\u672c monitoringkiali/vlalpha \u4e2d\u6ca1\u6709\u5339\u914d\u7684 MonitoringDashboard , \u8bf7\u91cd\u65b0\u8fd0\u884c kubectl apply \u547d\u4ee4\u3002\u95ee\u9898\u662f\uff0c\u5728\u5b89\u88c5CRD\uff08\u81ea\u5b9a \u5b9a\u4e49\u7684\u8d44\u6e90\u65f6\uff0c\u53ef\u80fd\u5b58\u5728\u4e00\u4e2a\u5339\u914d\u6761\u4ef6)\u3002 \u6211\u4eec\u53ef\u4ee5\u7528 getmesh istioctl dashboard kiali \u6253\u5f00 Kiali Kiali\u53ef\u4ee5\u751f\u6210\u4e00\u4e2a\u50cf\u4e0b\u56fe\u8fd9\u6837\u7684\u670d\u52a1\u56fe\u3002 \u8be5\u56fe\u5411\u6211\u4eec\u5c55\u793a\u4e86\u670d\u52a1\u7684\u62d3\u6251\u7ed3\u6784\uff0c\u5e76\u5c06\u670d\u52a1\u7684\u901a\u4fe1\u65b9\u5f0f\u53ef\u89c6\u5316\u3002\u5b83\u8fd8\u663e\u793a\u4e86\u5165\u7ad9\u548c\u51fa\u7ad9\u7684\u6307 \u6807\uff0c\u4ee5\u53ca\u901a\u8fc7\u8fde\u63a5Jaeger\u548cGrafana\uff08\u5982\u679c\u5b89\u88c5\u4e86\uff09\u7684\u8ffd\u8e2a\u3002\u56fe\u4e2d\u7684\u989c\u8272\u4ee3\u8868\u670d\u52a1\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u51b5\u3002\u7ea2\u8272\u6216\u6a59\u8272\u7684\u8282\u70b9\u53ef\u80fd\u9700\u8981\u6ce8\u610f\u3002\u7ec4\u4ef6\u4e4b\u95f4\u7684\u8fb9\u7684\u989c\u8272\u4ee3\u8868\u8fd9\u4e9b\u7ec4\u4ef6\u4e4b\u95f4\u7684\u8bf7\u6c42\u7684\u5065\u5eb7\u72b6\u51b5\u3002\u8282\u70b9\u5f62\u72b6\u8868\u793a\u7ec4\u4ef6\u7684\u7c7b\u578b\uff0c\u5982\u670d\u52a1\u3001\u5de5\u4f5c\u8d1f\u8f7d\u6216\u5e94\u7528\u7a0b\u5e8f\u3002 \u8282\u70b9\u548c\u8fb9\u7684\u5065\u5eb7\u72b6\u51b5\u4f1a\u6839\u636e\u7528\u6237\u7684\u504f\u597d\u81ea\u52a8\u5237\u65b0\u3002\u8be5\u56fe\u4e5f\u53ef\u4ee5\u6682\u505c\u4ee5\u68c0\u67e5\u4e00\u4e2a\u7279\u5b9a\u7684\u72b6\u6001\uff0c\u6216\u56de\u653e\u4ee5\u91cd\u65b0\u68c0\u67e5\u4e00\u4e2a\u7279\u5b9a\u7684\u65f6\u671f\u3002 Kiali\u63d0\u4f9b\u521b\u5efa\u3001\u66f4\u65b0\u548c\u5220\u9664Istio\u914d\u7f6e\u7684\u64cd\u4f5c\uff0c\u7531\u5411\u5bfc\u9a71\u52a8\u3002\u6211\u4eec\u53ef\u4ee5\u914d\u7f6e\u8bf7\u6c42\u8def\u7531\u3001\u6545\u969c\u6ce8\u5165\u3001\u6d41\u91cf\u8f6c\u79fb\u548c\u8bf7\u6c42\u8d85\u65f6\uff0c\u6240\u6709\u8fd9\u4e9b\u90fd\u6765\u81ea\u7528\u6237\u754c\u9762\u3002\u5982\u679c\u6211\u4eec\u6709\u4efb\u4f55\u73b0\u6709\u7684Istio\u914d\u7f6e\u5df2\u7ecf\u90e8\u7f72, Kiali\u53ef\u4ee5\u9a8c\u8bc1\u5b83\u5e76\u62a5\u544a\u4efb\u4f55\u8b66\u544a\u6216\u9519\u8bef\u3002 7\u3001\u53ef\u89c2\u6d4b\u6027\u6d4b\u8bd5 1\u3001Prometheus\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684\uff1f A \u8bb0\u5f55\u6307\u6807\uff0c\u8ddf\u8e2aIstio\u548c\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5 B \u53ef\u89c6\u5316\u670d\u52a1\u4e4b\u95f4\u7684\u6d41\u91cf C \u91c7\u96c6\u5206\u5e03\u5f0f\u8ddf\u8e2a D \u90e8\u7f72\u5206\u5e03\u5f0f\u5e94\u7528 2\u3001\u4ec0\u4e48\u662fZipkin? A \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf B \u53ef\u89c6\u5316\u6d41\u91cf\u7684\u5e73\u53f0 C \u6536\u96c6\u670d\u52a1\u65e5\u5fd7\u7684\u6846\u67b6 D \u8bb0\u5f55Istio\u670d\u52a1\u5065\u5eb7\u7684\u51ed\u6761 3\u3001\u4ec0\u4e48\u662fKiali? A \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf B Grafana\u63d2\u4ef6 C Istio\u53ef\u89c2\u6d4b\u6027\u9762\u677f D \u65e5\u5fd7\u6536\u96c6\u5de5\u5177 4\u3001\u4f60\u53ef\u4ee5\u4f7f\u7528Istio CLI\u4e2d\u7684\u54ea\u4e2a\u8f85\u52a9\u547d\u4ee4\u6765\u6253\u5f00 Prometheus/Grafana/Jaeger/Zipkin? A istioctl open dash B istiocti dashboard open C istioctl --dashboard D istioctl dashboard 5\u3001Istio\u4f9d\u9760\u54ea\u4e9b\u5934\u4fe1\u606f\u6765\u8fdb\u884c\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1f A X-headers B B3 header\u548cEnvoy requestID C Host\u548cUser header D Request ID header 6\u3001\u4ec0\u4e48\u662fGrafana? A \u50a8\u5b58\u591a\u4e2a\u6765\u6e90\u7684\u65e5\u5fd7\u7684\u89e3\u51b3\u65b9\u6848 B Prometheus\u548c\u5176\u4ed6\u6765\u6e90\u7684\u6570\u636e\u7684\u53ef\u89c6\u5316\u5e73\u53f0 C \u6536\u96c6\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7684\u6846\u67b6 D \u7528\u4e8e\u53ef\u89c6\u5316\u6570\u636e\u7684Prometheus\u63d2\u4ef6","title":"\u7b2c\u4e09\u8282 \u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7"},{"location":"chap8/3Istio_mon/#_1","text":"","title":"\u7b2c\u4e09\u8282 \u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7"},{"location":"chap8/3Istio_mon/#1","text":"\u5728\u8fd9\u4e2a\u6a21\u5757\u4e2d\uff0c\u5b66\u4e60\u4e00\u4e9b\u76d1\u63a7\uff08Prometheus)\u3001\u8ffd\u8e2a\uff08Zipkin)\u548c\u6570\u636e\u53ef\u89c6\u5316\u5de5\u5177 (Grafana)\u3002 \u4e3a\u4e86\u8ba9 Grafana \u548c Kiali \u5de5\u4f5c\uff0c\u6211\u4eec\u9996\u5148\u8981\u5b89\u88c5Prometheus\u63d2\u4ef6\u3002","title":"1\u3001\u6a21\u5757\u6982\u5ff5"},{"location":"chap8/3Istio_mon/#1-1","text":"\u7531\u4e8e\u91c7\u7528\u4e86sidecar\u90e8\u7f72\u6a21\u5f0f\uff0c \u5373Envoy\u4ee3\u7406\u8fd0\u884c\u5728\u5e94\u7528\u5b9e\u4f8b\u65c1\u8fb9\u5e76\u62e6\u622a\u6d41\u91cf\uff0c\u8fd9\u4e9b\u4ee3\u7406\u4e5f\u6536\u96c6\u6307\u6807 \u3002 Envoy\u4ee3\u7406\u6536\u96c6\u7684\u6307\u6807\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u83b7\u5f97\u7cfb\u7edf\u72b6\u6001\u7684\u53ef\u89c1\u6027\u3002 \u83b7\u5f97\u7cfb\u7edf\u7684\u8fd9\u79cd\u53ef\u89c1\u6027\u662f\u81f3\u5173\u91cd\u8981\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u4e86\u89e3\u6b63\u5728\u53d1\u751f\u7684\u4e8b\u60c5\uff0c\u5e76\u6388\u6743\u8fd0\u7ef4\u4eba\u5458\u5bf9\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u6545\u969c\u6392\u9664\u3001\u7ef4\u62a4\u548c\u4f18\u5316\u3002 Istio\u751f\u6210\u4e09\u79cd\u7c7b\u578b\u7684\u9065\u6d4b\u6570\u636e\uff0c\u4e3a\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b\u53ef\u89c2\u5bdf\u6027 \uff1a \u6307\u6807\u5ea6\u91cf\uff08Metric) \u5206\u5e03\u5f0f\u8ffd\u8e2a \u8bbf\u95ee\u65e5\u5fd7","title":"1-1 \u53ef\u89c2\u5bdf\u6027"},{"location":"chap8/3Istio_mon/#1-2","text":"Istlo\u57fa\u4e8e\u56db\u4e2a\u9ec4\u91d1\u4fe1\u53f7\u751f\u6210\u6307\u6807\uff1a \u5ef6\u8fdf\u3001\u6d41\u91cf\u3001\u9519\u8bef\u548c\u9971\u548c\u5ea6 \u3002 Latency : the time it takes to service a request Traffic : how much demand is placed on the system Errors : rate of failed requests Saturation : how full the most constrained resources of service are Collected at Envoy proxy, service, and control plane \u5ef6\u8fdf\u8868\u793a\u670d\u52a1\u4e00\u4e2a\u8bf7\u6c42\u6240\u9700\u7684\u65f6\u95f4\u3002\u8fd9\u4e2a\u6307\u6807\u5e94\u8be5\u5206\u6210\u6210\u529f\u8bf7\u6c42\uff08\u5982\u65e5I 1P200)\u548c\u5931\u8d25\u8bf7\u6c42 \uff08\u5982HTTP 500\uff09\u7684\u5ef6\u8fdf\u3002 \u6d41\u91cf\u662f\u8861\u91cf\u5bf9\u7cfb\u7edf\u7684\u9700\u6c42\u6709\u591a\u5927\uff0c\u5b83\u662f\u4ee5\u7cfb\u7edf\u7684\u5177\u4f53\u6307\u6807\u6765\u8861\u91cf\u7684\u3002\u4f8b\u5982\uff0c\u6bcf\u79d2\u7684HTTP\u8bf7\u6c42\uff0c\u6216\u5e76\u53d1\u4f1a\u8bdd\uff0c\u6bcf\u79d2\u7684\u68c0\u7d22\u91cf\uff0c\u7b49\u7b49 \u3002 \u9519\u8bef\u7528\u6765\u8861\u91cf\u8bf7\u6c42\u5931\u8d25\u7684\u6bd4\u7387 \uff08\u4f8b\u5982HTTP 500)\u3002 \u9971\u548c\u5ea6\u8861\u91cf\u4e00\u4e2a\u670d\u52a1\u4e2d\u6700\u7d27\u5f20\u7684\u8d44\u6e90\u6709\u591a\u6ee1\u3002\u4f8b\u5982\uff0c\u7ebf\u7a0b\u6c60\u7684\u5229\u7528\u7387 \u3002 \u8fd9\u4e9b\u6307\u6807\u662f\u5728\u4e0d\u540c\u7684\u5c42\u9762\u4e0a\u6536\u96c6\u7684\uff0c \u9996\u5148\u662f\u6700\u7ec6\u7684\uff0c\u5373Envoy\u4ee3\u7406\u5c42\u9762\uff0c\u7136\u540e\u662f\u670d\u52a1\u5c42\u9762\u548c\u63a7\u5236\u5e73\u9762\u7684\u6307\u6807 \u3002","title":"1-2 \u6307\u6807"},{"location":"chap8/3Istio_mon/#1-3","text":"\u751f\u6210\u6307\u6807\u7684\u5173\u952e\u89d2\u8272\u662fEnvoy\uff0c\u5b83\u751f\u6210\u4e86\u4e00\u5957\u5173\u4e8e\u6240\u6709\u901a\u8fc7\u4ee3\u7406\u7684\u6d41\u91cf\u7684\u4e30\u5bcc\u6307\u6807\u3002\u4f7f\u7528 Envoy\u751f\u6210\u7684\u6307\u6807\uff0c\u6211\u4eec\u53ef\u4ee5\u4ee5\u6700\u4f4e\u7684\u7c92\u5ea6\u6765\u76d1\u63a7\u670d\u52a1\u7f51\u683c\uff0c\u4f8b\u5982Envoy\u4ee3\u7406\u4e2d\u7684\u6bcf\u4e2a\u76d1\u542c \u5668\u548c\u96c6\u7fa4\u7684\u6307\u6807\u3002 \u4f5c\u4e3a\u7f51\u683c\u8fd0\u7ef4\u4eba\u5458\uff0c\u6211\u4eec\u6709\u80fd\u529b\u63a7\u5236\u751f\u6210\u548c\u6536\u96c6\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u4f8b\u4e2d\u7684\u54ea\u4e9bEnvoy\u6307\u6807\u3002 \u4e0b\u9762\u662f\u51e0\u4e2a\u4ee3\u7406\u7ea7\u6307\u6807\u7684\u4f8b\u5b50\u3002 envoy_cluster_internal_upstream_rq{response_code_class=\"2xx\",cluster_name=\"xds-grpc\"} 7163 envoy_cluster_upstream_rq_completed{cluster_name=\"xds-grpc\"} 7164 envoy_cluster_ssl_connection_error{cluster_name=\"xds-grpc\"} 0 envoy_cluster_lb_subsets_removed{cluster_name=\"xds-grpc\"} 0 envoy_cluster_internal_upstream_rq{response_code=\"503\",cluster_name=\"xds-grpc\"} 1 \u6ce8\u610f\u4f60\u53ef\u4ee5\u4ece\u6bcf\u4e2a\u538bEnvoy\u4ee3\u7406\u5b9e\u4f8b\u7684\uff0fStats \u7aef\u70b9\u67e5\u770b\u4ee3\u7406\u7ea7\u6307\u6807\u3002","title":"1-3 \u4ee3\u7406\u7ea7\u6307\u6807"},{"location":"chap8/3Istio_mon/#1-4","text":"\u670d\u52a1\u7ea7\u522b\u7684\u6307\u6807\u6db5\u76d6\u4e86\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u56db\u4e2a\u9ec4\u91d1\u4fe1\u53f7\u3002 \u8fd9\u4e9b\u6307\u6807\u4f7f\u6211\u4eec\u80fd\u591f\u76d1\u63a7\u670d\u52a1\u4e0e\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u3002\u6b64\u5916\uff0cIstlo\u8fd8\u63d0\u4f9b\u4e86\u4e00\u7ec4\u4eea\u8868\u76d8\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u8fd9\u4e9b\u6307\u6807\u6765\u76d1\u63a7\u670d\u52a1\u884c\u4e3a \u3002 \u5c31\u50cf\u4ee3\u7406\u7ea7\u522b\u7684\u6307\u6807\u4e00\u6837\uff0c\u8fd0\u7ef4\u4eba\u5458\u53ef\u4ee5\u81ea\u5b9a\u4e49\u6536\u96c6\u54ea\u4e9b\u670d\u52a1\u7ea7\u522b\u7684\u6307\u6807\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\u7684\u6807\u51c6\u6307\u6807\u96c6\u4f1a\u88ab\u5bfc\u51fa\u5230Prometheus \u4e0b\u9762\u662f\u51e0\u4e2a\u670d\u52a1\u7ea7\u6307\u6807\u7684\u4f8b\u5b50\uff1a istio_requests_total{ connection_security_policy=\"mutual_tls\", destination_app=\"hello-world\", destination_canonical_service=\"hello-world\", destination_canonical_revision=\"v1\", destination_principal=\"cluster.local/ns/default/sa/default\", destination_service=\"hello-world.default.svc.cluster.local\", destination_service_name=\"hello-world\", destination_service_namespace=\"default\", destination_version=\"v1\", destination_workload=\"hello-world-v1\", destination_workload_namespace=\"default\", reporter=\"destination\", request_protocol=\"http\", response_code=\"200\", response_flags=\"-\", source_app=\"hello-web\", source_canonical_service=\"hello-web\", source_canonical_revision=\"v1\", source_principal=\"cluster.local/ns/default/sa/default\", source_version=\"v1\", source_workload=\"hello-web-v1\", source_workload_namespace=\"default\" } 981","title":"1-4 \u670d\u52a1\u7ea7\u6307\u6807"},{"location":"chap8/3Istio_mon/#1-5","text":"Istio\u4e5f\u4f1a\u751f\u6210\u63a7\u5236\u5e73\u9762\u6307\u6807\uff0c\u7528\u4e8e\u76d1\u63a7Istio\u7684\u63a7\u5236\u5e73\u9762\uff0c\u800c\u4e0d\u662f\u7528\u6237\u670d\u52a1\u3002 \u8f93\u51fa\u7684\u63a7\u5236\u5e73\u9762\u6307\u6807\u7684\u5b8c\u6574\u5217\u8868\u53ef\u4ee5\u5728 \u8fd9\u91cc \u627e\u5230\u3002 \u63a7\u5236\u5e73\u9762\u6307\u6807\u5305\u62ec\u51b2\u7a81\u7684\u5165\u7ad9\uff0f\u51fa\u7ad9\u76d1\u542c\u5668\u7684\u6570\u91cf\u3001\u6ca1\u6709\u5b9e\u4f8b\u7684\u96c6\u7fa4\u6570\u91cf\u3001\u88ab\u62d2\u7edd\u6216\u88ab\u5ffd\u7565\u7684\u914d\u7f6e\u7b49\u6307\u6807\u3002","title":"1-5 \u63a7\u5236\u5e73\u9762\u5ea6\u91cf"},{"location":"chap8/3Istio_mon/#2prometheus","text":"","title":"2\u3001Prometheus"},{"location":"chap8/3Istio_mon/#prometheus","text":"Open-source monitoring system and time series DB Records metrics: Track mesh health Track application health Install from /samples/addons folder istioctl dashboard prometheus Prometheus\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u76d1\u63a7\u7cfb\u7edf\u548c\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\u3002Istlo\u4f7f\u7528Prometheus\u6765\u8bb0\u5f55\u6307\u6807\uff0c\u8ddf\u8e2aIstio\u548c\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5\u3002 \u8981\u5b89\u88c5Prometheus\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Istio\u5b89\u88c5\u5305\u4e2d\uff0fsamples/addons \u6587\u4ef6\u5939\u4e2d\u7684\u793a\u4f8b\u5b89\u88c5\u3002 $ kubectl apply -f istio-1.10.3/samples/addons/prometheus.yaml serviceaccount/prometheus created configmap/prometheus created clusterrole.rbac.authorization.k8s.io/prometheus created clusterrolebinding.rbac.authorization.k8s.io/prometheus created service/prometheus created deployment.apps/prometheus created $ kubectl get pod -n istio-system NAME READY STATUS RESTARTS AGE istio-egressgateway-5547fcc8fc-7kj9c 1/1 Running 0 4h31m istio-ingressgateway-8f568d595-zj9bs 1/1 Running 0 4h31m istiod-6659979bdf-l7kgk 1/1 Running 0 4h31m prometheus-8958b965-hpp2v 2/2 Running 0 2m11s \u8981\u6253\u5f00 Prometheus \u4eea\u8868\u677f\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Istio CLI \u4e2d\u7684 $ Istioctl dashboard prometheus http://localhost:9090","title":"Prometheus"},{"location":"chap8/3Istio_mon/#_2","text":"\u4e3a\u4e86\u80fd\u591f\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf\u5e76\u8bbf\u95eeNginx Pod\uff0c\u6211\u4eec\u9700\u8981\u4ee5\u67d0\u79cd\u65b9\u5f0f\u8ba9\u5b83\u53ef\u4ee5\u88ab\u8bbf\u95ee\u3002 \u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u5c06Nginx\u90e8\u7f72\u4f5c\u4e3a\u670d\u52a1\u516c\u5f00\uff1a kubectl create deploy my-nginx --image=ngix kubectl expose deployment my-nginx --type=NodePort --name=my-nginx --port 80 service/my-nginx exposed \u6ce8\u610f\uff1a \u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528Istio\u8d44\u6e90\u5e76\u901a\u8fc7Istio\u7684\u5165\u53e3\u7f51\u5173\u66b4\u9732\u670d \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c kubectl get services \uff0c\u83b7\u5f97 my-nginx \u670d\u52a1\u7684\u5916\u90e8IP\u5730\u5740\uff1a $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 <none> 443/TCP 13d my-nginx NodePort 10.109.102.197 <none> 80:31837/TCP 2s $ curl 127.0.0.1:$(kubectl get service my-nginx -o jsonpath='{.spec.ports[0].nodePort}') <!DOCTYPE html> <html> <head> <title>Welcome to nginx!</title> <style> html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } </style> </head> <body> <h1>Welcome to nginx!</h1> <p>If you see this page, the nginx web server is successfully installed and working. Further configuration is required.</p> <p>For online documentation and support please refer to <a href=\"http://nginx.org/\">nginx.org</a>.<br/> Commercial support is available at <a href=\"http://nginx.com/\">nginx.com</a>.</p> <p><em>Thank you for using nginx.</em></p> </body> </html> \u7136\u540e\uff0c\u4ece Prometheus UI \u4e2d\uff0c\u4f60\u53ef\u4ee5\u641c\u7d22Istio\u7684\u4e00\u4e2a\u6307\u6807\uff08\u4f8b\u5982 istio_requests_total{app=\"my-nginx\"} )\uff0c\u4ee5\u4e86\u89e3\u54ea\u4e9b\u6570\u636e\u70b9\u6b63\u5728\u88ab\u6536\u96c6\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u6765\u81eaPrometheus\u7528\u6237\u754c\u9762\u7684\u793a\u4f8b\u5143\u7d20\uff1a $ istio_requests_total{app=\"my-nginx\"} istio_requests_total{app=\"my-nginx\", connection_security_policy=\"none\", destination_app=\"my-nginx\", destination_canonical_revision=\"latest\", destination_canonical_service=\"my-nginx\", destination_cluster=\"Kubernetes\", destination_principal=\"unknown\", destination_service=\"my-nginx.default.svc.cluster.local\", destination_service_name=\"my-nginx\", destination_service_namespace=\"default\", destination_version=\"unknown\", destination_workload=\"my-nginx\", destination_workload_namespace=\"default\", instance=\"10.1.0.221:15020\", istio_io_rev=\"default\", job=\"kubernetes-pods\", kubernetes_namespace=\"default\", kubernetes_pod_name=\"my-nginx-6b74b79f57-6spkz\", pod_template_hash=\"6b74b79f57\", reporter=\"destination\", request_protocol=\"http\", response_code=\"200\", response_flags=\"-\", security_istio_io_tlsMode=\"istio\", service_istio_io_canonical_name=\"my-nginx\", service_istio_io_canonical_revision=\"latest\", source_app=\"unknown\", source_canonical_revision=\"latest\", source_canonical_service=\"unknown\", source_cluster=\"unknown\", source_principal=\"unknown\", source_version=\"unknown\", source_workload=\"unknown\", source_workload_namespace=\"unknown\"} 2","title":"\u90e8\u7f72\u5b9e\u4f8b\u5e94\u7528"},{"location":"chap8/3Istio_mon/#3grafana","text":"","title":"3\u3001Grafana"},{"location":"chap8/3Istio_mon/#3-1-grafana","text":"Open platform for analytics and monitoring Connects to Prometheus (and other sources) Monitor health of lstio and apps in the mesh Install from /samples/addons folder istioctl dashboard grafana Grafana\u662f\u4e00\u4e2a\u7528\u4e8e\u5206\u6790\u548c\u76d1\u63a7\u7684\u5f00\u653e\u5e73\u53f0\u3002Grafana\u53ef\u4ee5\u8fde\u63a5\u5230\u5404\u79cd\u6570\u636e\u6e90\uff0c\u5e76\u4f7f\u7528\u56fe\u5f62\u3001 \u8868\u683c\u3001\u70ed\u56fe\u7b49\u5c06\u6570\u636e\u53ef\u89c6\u5316\u3002\u901a\u8fc7\u5f3a\u5927\u7684\u67e5\u8be2\u8bed\u8a00\uff0c\u4f60\u53ef\u4ee5\u5b9a\u5236\u73b0\u6709\u7684\u4eea\u8868\u76d8\u5e76\u521b\u5efa\u66f4\u9ad8\u7ea7\u7684\u53ef\u89c6\u5316\u3002 \u901a\u8fc7Grafana\uff0c\u6211\u4eec\u53ef\u4ee5\u76d1\u63a7Istio\u5b89\u88c5\u548c\u670d\u52a1\u7f51\u683c\u4e2d\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5\u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528grafana . yami\u6765\u90e8\u7f72\u5e26\u6709\u9884\u914d\u7f6e\u4eea\u8868\u76d8\u7684Grafana\u793a\u4f8b\u5b89\u88c5\u3002\u8be5YAML\u6587\u4ef6\u5728Istio\u5b89\u88c5\u5305\u7684 /samples /addons \u4e0b\u3002 \u786e\u4fdd\u5728\u90e8\u7f72Grafana\u4e4b\u524d\u90e8\u7f72 Promeheus \u63d2\u4ef6\uff0c\u56e0\u4e3a Grafana \u4f7f\u7528 Prometheus \u4f5c\u4e3a\u5176\u6570\u636e\u6e90\u3002 \u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u90e8\u7f72 Grafana \u548c\u9884\u914d\u7f6e\u7684\u4eea\u8868\u76d8\uff1a $ kubectl apply -f istio-1.10.3/samples/addons/grafana.yaml serviceaccount/grafana created configmap/grafana created service/grafana created deployment.apps/grafana created configmap/istio-grafana-dashboards created configmap/istio-services-grafana-dashboards created $ kubectl get pod -n istio-system NAME READY STATUS RESTARTS AGE grafana-56d978ff77-d6m4w 1/1 Running 0 64s istio-egressgateway-5547fcc8fc-7kj9c 1/1 Running 0 2d4h istio-ingressgateway-8f568d595-zj9bs 1/1 Running 0 2d4h istiod-6659979bdf-l7kgk 1/1 Running 0 2d4h prometheus-8958b965-hpp2v 2/2 Running 0 47h \u8fd9\u4e2aGrafana\u3002\u5b89\u88c5\u4e0d\u6253\u7b97\u5728\u751f\u4ea7\u4e2d\u8fd0\u884c\uff0c\u56e0\u4e3a\u5b83\u6ca1\u6709\u7ecf\u8fc7\u6027\u80fd\u6216\u5b89\u5168\u65b9\u9762\u7684\u8c03\u6574\u3002 Kubernetes\u5c06Grafana\u90e8\u7f72\u5728 istio-System \u547d\u540d\u7a7a\u95f4\u3002\u8981\u8bbf\u95eeGrafana\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 istioctl dashboard $ istioctl dashboard grafana http://localhost:3000 \u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 http://localhost:3000 \uff0c\u8fdb\u5165Grafana\u3002\u7136\u540e\uff0c\u70b9\u51fb\u9996\u9875\u548cistlo\u6587\u4ef6\u5939\uff0c\u67e5\u770b\u5df2\u5b89\u88c5\u7684\u4eea\u8868\u76d8\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 Istio Grafana\u5b89\u88c5\u65f6\u9884\u914d\u7f6e\u4e86\u4ee5\u4e0b\u4eea\u8868\u76d8\uff1a 1.Istlo\u63a7\u5236\u5e73\u9762\u4eea\u8868\u76d8 \u4eceIstio\u63a7\u5236\u5e73\u9762\u4eea\u8868\u76d8\uff0c\u6211\u4eec\u53ef\u4ee5\u76d1\u63a7Istio\u63a7\u5236\u5e73\u9762\u7684\u5065\u5eb7\u548c\u6027\u80fd\u3002 \u8fd9\u4e2a\u4eea\u8868\u76d8\u5c06\u5411\u6211\u4eec\u5c55\u793a\u63a7\u5236\u5e73\u9762\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff08\u5185\u5b58\u3001CPU'\u78c1\u76d8\u3001Go routines)\uff0c\u4ee5\u53ca\u5173\u4e8ePiIot\u3001 Envoy\u548cWebhook\u7684\u4fe1\u606f\u3002 2.Istio\u7f51\u683c\u4eea\u8868\u76d8 \u7f51\u683c\u4eea\u8868\u76d8\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u5728\u7f51\u683c\u4e2d\u8fd0\u884c\u7684\u6240\u6709\u670d\u52a1\u7684\u6982\u89c8\u3002\u4eea\u8868\u76d8\u5305\u62ec\u5168\u5c40\u8bf7\u6c42\u91cf\u3001\u6210\u529f\u7387\u4ee5\u53ca 4xx\u548c 5xx \u54cd\u5e94\u7684\u6570\u91cf\u3002 3. Istlo\u6027\u80fd\u4eea\u8868\u76d8 \u6027\u80fd\u4eea\u8868\u76d8\u5411\u6211\u4eec\u5c55\u793a\u4e86Istio\u4e3b\u8981\u7ec4\u4ef6\u5728\u7a33\u5b9a\u8d1f\u8f7d\u4e0b\u7684\u8d44\u6e90\u5229\u7528\u7387\u3002 4.Istlo\u670d\u52a1\u4eea\u8868\u76d8 \u670d\u52a1\u4eea\u8868\u76d8\u5141\u8bb8\u6211\u4eec\u5728\u7f51\u683c\u4e2d\u67e5\u770b\u670d\u52a1\u7684\u7ec6\u8282\u3002 \u6211\u4eec\u53ef\u4ee5\u83b7\u5f97\u5173\u4e8e\u8bf7\u6c42\u91cf\u3001\u6210\u529f\u7387\u3001\u6301\u7eed\u65f6\u95f4\u7684\u4fe1\u606f\uff0c\u4ee5\u53ca\u663e\u793a\u6309\u6765\u6e90\u548c\u54cd\u5e94\u4ee3\u7801\u3001\u6301\u7eed\u65f6\u95f4\u548c\u5927\u5c0f\u7684\u4f20\u5165\u8bf7\u6c42\u7684\u8be6\u7ec6\u56fe\u8868\u3002 5. Istlo Wasm\u6269\u5c55\u4eea\u8868\u76d8 Istlo Wasm\u6269\u5c55\u4eea\u8868\u76d8\u663e\u793a\u4e0eWebAssembly\u6a21\u5757\u6709\u5173\u7684\u6307\u6807\u3002\u4ece\u8fd9\u4e2a\u4eea\u8868\u76d8\uff0c\u6211\u4eec\u53ef\u4ee5\u76d1\u63a7\u6d3b\u52a8\u7684\u548c\u521b\u5efa\u7684Wasm\u865a\u62df\u673a\uff0c\u5173\u4e8e\u83b7\u53d6\u5220\u9664Wasm\u6a21\u5757\u548c\u4ee3\u7406\u8d44\u6e90\u4f7f\u7528\u7684\u6570\u636e\u3002 6. Istlo\u5de5\u4f5c\u8d1f\u8f7d\u4eea\u8868\u76d8 \u8fd9\u4e2a\u4eea\u8868\u76d8\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8be6\u7ec6\u6307\u6807\u5206\u7c7b\u3002","title":"3-1 Grafana"},{"location":"chap8/3Istio_mon/#4zipkin","text":"","title":"4\u3001Zipkin"},{"location":"chap8/3Istio_mon/#4-1-trace-and-spans","text":"Trace : collection of spans Span : name, start/finish timestamp, tags, context Tags : applied to all spans, used for querying/filtering Spans are sent to the collector to validate, index & store the data \u5206\u5e03\u5f0f\u8ffd\u8e2a\u662f\u4e00\u79cd\u76d1\u6d4b\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u7684\u65b9\u6cd5\u3002 \u4f7f\u7528\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8bf7\u6c42\u901a\u8fc7\u88ab\u76d1\u63a7\u7cfb\u7edf\u7684\u4e0d\u540c\u90e8\u5206\u65f6\u8ffd\u8e2a\u5b83\u4eec \u3002 \u6bcf\u5f53\u4e00\u4e2a\u8bf7\u6c42\u8fdb\u5165\u670d\u52a1\u7f51\u683c\u65f6\uff0cEnvoy\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a\u552f\u4e00\u7684\u8bf7\u6c42ID\u548c\u8ffd\u8e2a\u4fe1\u606f\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3aHTTP\u5934\u7684\u4e00\u90e8\u5206\u6765\u5b58\u50a8 \u3002\u4efb\u4f55\u5e94\u7528\u7a0b\u5e8f\u90fd\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u5934\u4fe1\u606f\u8f6c\u53d1\u7ed9\u5b83\u6240\u8c03\u7528\u7684\u5176\u4ed6\u670d\u52a1\uff0c\u4ee5\u4fbf\u5728\u7cfb\u7edf\u4e2d\u521b\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684\u8ffd\u8e2a\u3002","title":"4-1 Trace and spans"},{"location":"chap8/3Istio_mon/#span","text":"\u5f53\u8bf7\u6c42\u6d41\u7ecf\u4e0d\u540c\u7684\u7cfb\u7edf\u7ec4\u4ef6\u65f6\uff0c\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\u8de8\u5ea6\u3002\u6bcf\u4e2a\u8de8\u5ea6\u90fd\u6709\u4e00\u4e2a\u540d\u79f0\uff0c\u5f00\u59cb\u548c\u7ed3\u675f\u7684\u65f6\u95f4\u6233\uff0c\u4e00\u7ec4\u79f0\u4e3a\u6807\u7b7e\uff08tag\uff09\u548c\u65e5\u5fd7\uff08log) \u7684\u952e\u503c\u5bf9\uff0c\u4ee5\u53ca\u4e00\u4e2a\u8de8\u5ea6\u4e0a\u4e0b\u6587\u3002 \u6807\u7b7e\u88ab\u5e94\u7528\u4e8e\u6574\u4e2a\u8de8\u5ea6\uff0c\u5e76\u7528\u4e8e\u67e5\u8be2\u548c\u8fc7\u6ee4\u3002\u4e0b\u9762\u662f\u6211\u4eec\u5728\u4f7f\u7528Zipkin\u65f6\u5c06\u770b\u5230\u7684\u51e0\u4e2a\u6807\u7b7e\u7684\u4f8b\u5b50\u3002\u6ce8\u610f\uff0c\u5176\u4e2d\u6709\u4e9b\u662f\u901a\u7528\u7684\uff0c\u6709\u4e9b\u662flstio\u7279\u6709\u7684\uff1a Examples: istio.mesh_id istio.canonical_service upstream_cluster http.url http.status_code zone \u5355\u4e2a\u8de8\u5ea6\u4e0e\u8bc6\u522b\u8de8\u5ea6\u3001\u7236\u8de8\u5ea6\u3001\u8ffd\u8e2aID\u7684\u4e0a\u4e0b\u6587\u5934\u4e00\u8d77\u88ab\u53d1\u9001\u5230\u4e00\u4e2a\u53eb\u505a\u91c7\u96c6\u5668\u7684\u7ec4\u4ef6\u3002\u91c7\u96c6\u5668\u5bf9\u6570\u636e\u8fdb\u884c\u9a8c\u8bc1\u3001\u7d22\u5f15\u548c\u5b58\u50a8\u3002 \u5f53\u8bf7\u6c42\u6d41\u7ecfEnvoy\u4ee3\u7406\u65f6\uff0cEnvoy\u4ee3\u7406\u4f1a\u81ea\u52a8\u53d1\u9001\u5404\u4e2a\u8de8\u5ea6\u3002 \u8bf7\u6ce8\u610f\uff0cEnvoy\u53ea\u80fd\u5728\u8fb9\u7f18\u6536\u96c6\u8de8\u5ea6\u3002\u6211\u4eec\u8981\u8d1f\u8d23\u5728\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u751f\u6210\u4efb\u4f55\u989d\u5916\u7684\u8de8\u5ea6\uff0c\u5e76\u786e\u4fdd\u6211\u4eec\u5728\u8c03\u7528\u5176\u4ed6\u670d\u52a1\u65f6\u8f6c\u53d1\u8ffd\u8e2a\u5934\u4fe1\u606f\u3002\u8fd9\u6837\u4e00\u6765\uff0c\u5404\u4e2a\u8de8\u5ea6\u5c31\u53ef\u4ee5\u6b63\u786e\u5730\u5173\u8054\u5230\u4e00\u4e2a\u5355\u4e00\u7684\u8ffd\u8e2a\u4e2d\u3002","title":"\u5206\u5e03\u5f0f\u8ffd\u8e2a\u662f\u4e00\u4e2a\u8de8\u5ea6\uff08span)\u7684\u96c6\u5408\u3002"},{"location":"chap8/3Istio_mon/#4-2-distributed-tracing-with-zipkin","text":"Zipkin = distributed tracing system Discover latency and performance issues Requirements: propagate HTTP headers (B3 and Envoy request ID) Traces captured at service boundaries Instrument your applications Install from /samples/addons/extras folder istioctl dashboard zipkin","title":"4-2 Distributed Tracing with Zipkin"},{"location":"chap8/3Istio_mon/#5zipkin","text":"Zipkin\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf\u3002\u6211\u4eec\u53ef\u4ee5\u8f7b\u677e\u5730\u76d1\u63a7\u670d\u52a1\u7f51\u683c\u4e2d\u53d1\u751f\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\uff0c\u53d1\u73b0\u4efb\u4f55\u6027\u80fd\u6216\u5ef6\u8fdf\u95ee\u9898\u3002 \u4e3a\u4e86\u8ba9\u6211\u4eec\u7684\u670d\u52a1\u53c2\u4e0e\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff0c\u6211\u4eec\u9700\u8981\u5728\u8fdb\u884c\u4efb\u4f55\u4e0b\u6e38\u670d\u52a1\u8c03\u7528\u65f6\u4f20\u64ad\u670d\u52a1\u7684HTTP\u5934\u4fe1\u606f\u3002\u5c3d\u7ba1\u6240\u6709\u7684\u8bf7\u6c42\u90fd\u8981\u7ecf\u8fc7 Istio sidecar \uff0c \u4f46 Istio \u6ca1\u6709\u529e\u6cd5\u5c06\u51fa\u7ad9\u8bf7\u6c42\u4e0e\u4ea7\u751f\u8fd9\u4e9b\u8bf7\u6c42\u7684\u5165\u7ad9\u8bf7\u6c42\u8054\u7cfb\u8d77\u6765\u3002\u901a\u8fc7\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4f20\u64ad\u76f8\u5173\u7684\u5934\u4fe1\u606f\u53ef\u4ee5\u5e2e\u52a9Zipkin\u5c06\u8fd9\u4e9b\u8ddf\u8e2a\u4fe1\u606f\u62fc\u63a5\u8d77\u6765\u3002 Istio\u4f9d\u8d56\u4e8eB3\u8ddf\u8e2a\u5934\uff08\u4ee5 x-b3 \u5f00\u5934\u7684header) \u548cEnvoy\u751f\u6210\u7684\u8bf7\u6c42ID ( x-request-Id )\u3002B3\u5934\u4fe1\u606f\u7528\u4e8e\u8de8\u670d\u52a1\u8fb9\u754c\u7684\u8ddf\u8e2a\u4e0a\u4e0b\u6587\u4f20\u64ad\u3002 \u4ee5\u4e0b\u662f\u6211\u4eec\u9700\u8981\u5728\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5bf9\u6bcf\u4e2a\u53d1\u51fa\u7684\u8bf7\u6c42\u8fdb\u884c\u4f20\u64ad\u7684\u7279\u5b9a\u5934\u6587\u4ef6\u540d\u79f0 \uff1a x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid ` x-b3-sampled x-b3-flags b3 \u5982\u679c\u4f60\u4f7f\u7528Lightstep\uff0c\u4f60\u8fd8\u9700\u8981\u8f6c\u53d1\u540d\u4e3a x-ot-span-context \u7684\u5934\u3002 \u4f20\u64ad\u5934\u4fe1\u606f\u6700\u5e38\u89c1\u7684\u65b9\u6cd5\u662f\u4ece\u4f20\u5165\u7684\u8bf7\u6c42\u4e2d\u590d\u5236\u5b83\u4eec\uff0c\u5e76\u5c06\u5b83\u4eec\u5305\u542b\u5728\u6240\u6709\u4ece\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u53d1\u51fa\u7684\u8bf7\u6c42\u4e2d \u4f60\u7528Istio\u670d\u52a1\u7f51\u683c\u5f97\u5230\u7684\u8ddf\u8e2a\u53ea\u5728\u670d\u52a1\u8fb9\u754c\u6355\u83b7\u3002\u4e3a\u4e86\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u7684\u884c\u4e3a\u5e76\u6392\u9664\u6545\u969c\uff0c\u4f60\u9700\u8981\u901a\u8fc7\u521b\u5efa\u989d\u5916\u7684\u8de8\u5ea6\uff08span)\u6765\u6b63\u786e\u68c0\u6d4b\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u3002 \u8981\u5b89\u88c5Zipkin\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528addons\u6587\u4ef6\u5939\u4e2d\u7684\uff1a zipkin.yaml \u6587\u4ef6\u3002 $ kubectl apply -f istio-1.10.3/samples/addons/extras/zipkin.yaml deployment.apps/zipkin created service/tracing created service/zipkin created \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c getmesh istioctl dashboard zipkin \u6765\u6253\u5f00Zipkin\u4eea\u8868\u677f\u3002\u5728\u7528\u6237\u754c\u9762\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u8ddf\u8e2a\u67e5\u8be2\u7684\u6807\u51c6\u3002\u70b9\u51fb\u6309\u94ae\uff0c\u4ece\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9 serviceName \uff0c\u7136\u540e\u9009\u62e9 customers. default service\uff0c\u70b9\u51fb\u641c\u7d22\u6309\u94ae\uff08\u6216\u6309\u56de\u8f66\u952e\uff09\uff0c\u5c31\u53ef\u4ee5\u641c\u7d22\u5230 trace \u4fe1\u606f\u3002 \u6211\u4eec\u53ef\u4ee5\u70b9\u51fb\u4e2a\u522btrace\u6765\u6df1\u5165\u6316\u6398\u4e0d\u540c\u7684\u8de8\u5ea6\u3002\u8be6\u7ec6\u7684\u89c6\u56fe\u5c06\u663e\u793a\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u65f6\u95f4\uff0c\u4ee5\u53ca\u8bf7\u6c42\u7684\u7ec6\u8282\uff0c\u5982\u65b9\u6cd5\u3001\u534f\u8bae\u3001\u72b6\u6001\u7801\u7b49\u3002 \u7531\u4e8e\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u670d\u52a1\u5728\u8fd0\u884c\uff08Nginx)\uff0c\u6240\u4ee5\u4f60\u4e0d\u4f1a\u770b\u5230\u5f88\u591a\u7ec6\u8282\u3002\u7a0d\u540e\uff0c\u6211\u4eec\u5c06\u56de\u5230Zipkin\uff0c\u66f4\u8be6\u7ec6\u5730\u63a2\u7d22\u8fd9\u4e9btrace","title":"5\u3001\u4f7f\u7528Zipkin\u8fdb\u884c\u5206\u5e03\u5f0f\u8ffd\u8e2a"},{"location":"chap8/3Istio_mon/#6kiali","text":"Kiali\u662f\u4e00\u4e2a\u57fa\u4e8eIstio\u7684\u670d\u52a1\u7f51\u683c\u7684\u7ba1\u7406\u63a7\u5236\u53f0 \u3002\u5b83\u63d0\u4f9b\u4e86\u4eea\u8868\u76d8\u3001\u53ef\u89c2\u5bdf\u6027\uff0c\u5e76\u8ba9\u6211\u4eec\u901a\u8fc7\u5f3a\u5927\u7684\u914d\u7f6e\u548c\u9a8c\u8bc1\u80fd\u529b\u6765\u64cd\u4f5c\u7f51\u683c\u3002\u5b83\u901a\u8fc7\u63a8\u65ad\u6d41\u91cf\u62d3\u6251\u6765\u663e\u793a\u670d\u52a1\u7f51\u683c\uff0c\u5e76\u663e\u793a\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u51b5\u3002 Kiali\u63d0\u4f9b\u4e86\u8be6\u7ec6\u7684\u6307\u6807\uff0c\u5f3a\u5927\u7684\u9a8c\u8bc1\uff0cGrafana\u8bbf\u95ee\uff0c\u4ee5\u53ca\u4e0e Jaeger \u7684\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7684\u5f3a\u5927\u96c6\u6210\u3002 \u8981\u5b89\u88c5Kiali\uff0c\u8bf7\u4f7f\u7528 addons \u6587\u4ef6\u5939\u4e2d\u7684 kiali.yaml \u6587\u4ef6\uff1a kubectl apply -f istio-1.10.3/samples/addons/kiali.yaml \u6ce8\u610f\uff0c\u5982\u679c\u4f60\u770b\u5230\u4efb\u4f55\u9519\u8bef\uff0c\u4f8b\u5982\u5728\u7248\u672c monitoringkiali/vlalpha \u4e2d\u6ca1\u6709\u5339\u914d\u7684 MonitoringDashboard , \u8bf7\u91cd\u65b0\u8fd0\u884c kubectl apply \u547d\u4ee4\u3002\u95ee\u9898\u662f\uff0c\u5728\u5b89\u88c5CRD\uff08\u81ea\u5b9a \u5b9a\u4e49\u7684\u8d44\u6e90\u65f6\uff0c\u53ef\u80fd\u5b58\u5728\u4e00\u4e2a\u5339\u914d\u6761\u4ef6)\u3002 \u6211\u4eec\u53ef\u4ee5\u7528 getmesh istioctl dashboard kiali \u6253\u5f00 Kiali Kiali\u53ef\u4ee5\u751f\u6210\u4e00\u4e2a\u50cf\u4e0b\u56fe\u8fd9\u6837\u7684\u670d\u52a1\u56fe\u3002 \u8be5\u56fe\u5411\u6211\u4eec\u5c55\u793a\u4e86\u670d\u52a1\u7684\u62d3\u6251\u7ed3\u6784\uff0c\u5e76\u5c06\u670d\u52a1\u7684\u901a\u4fe1\u65b9\u5f0f\u53ef\u89c6\u5316\u3002\u5b83\u8fd8\u663e\u793a\u4e86\u5165\u7ad9\u548c\u51fa\u7ad9\u7684\u6307 \u6807\uff0c\u4ee5\u53ca\u901a\u8fc7\u8fde\u63a5Jaeger\u548cGrafana\uff08\u5982\u679c\u5b89\u88c5\u4e86\uff09\u7684\u8ffd\u8e2a\u3002\u56fe\u4e2d\u7684\u989c\u8272\u4ee3\u8868\u670d\u52a1\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u51b5\u3002\u7ea2\u8272\u6216\u6a59\u8272\u7684\u8282\u70b9\u53ef\u80fd\u9700\u8981\u6ce8\u610f\u3002\u7ec4\u4ef6\u4e4b\u95f4\u7684\u8fb9\u7684\u989c\u8272\u4ee3\u8868\u8fd9\u4e9b\u7ec4\u4ef6\u4e4b\u95f4\u7684\u8bf7\u6c42\u7684\u5065\u5eb7\u72b6\u51b5\u3002\u8282\u70b9\u5f62\u72b6\u8868\u793a\u7ec4\u4ef6\u7684\u7c7b\u578b\uff0c\u5982\u670d\u52a1\u3001\u5de5\u4f5c\u8d1f\u8f7d\u6216\u5e94\u7528\u7a0b\u5e8f\u3002 \u8282\u70b9\u548c\u8fb9\u7684\u5065\u5eb7\u72b6\u51b5\u4f1a\u6839\u636e\u7528\u6237\u7684\u504f\u597d\u81ea\u52a8\u5237\u65b0\u3002\u8be5\u56fe\u4e5f\u53ef\u4ee5\u6682\u505c\u4ee5\u68c0\u67e5\u4e00\u4e2a\u7279\u5b9a\u7684\u72b6\u6001\uff0c\u6216\u56de\u653e\u4ee5\u91cd\u65b0\u68c0\u67e5\u4e00\u4e2a\u7279\u5b9a\u7684\u65f6\u671f\u3002 Kiali\u63d0\u4f9b\u521b\u5efa\u3001\u66f4\u65b0\u548c\u5220\u9664Istio\u914d\u7f6e\u7684\u64cd\u4f5c\uff0c\u7531\u5411\u5bfc\u9a71\u52a8\u3002\u6211\u4eec\u53ef\u4ee5\u914d\u7f6e\u8bf7\u6c42\u8def\u7531\u3001\u6545\u969c\u6ce8\u5165\u3001\u6d41\u91cf\u8f6c\u79fb\u548c\u8bf7\u6c42\u8d85\u65f6\uff0c\u6240\u6709\u8fd9\u4e9b\u90fd\u6765\u81ea\u7528\u6237\u754c\u9762\u3002\u5982\u679c\u6211\u4eec\u6709\u4efb\u4f55\u73b0\u6709\u7684Istio\u914d\u7f6e\u5df2\u7ecf\u90e8\u7f72, Kiali\u53ef\u4ee5\u9a8c\u8bc1\u5b83\u5e76\u62a5\u544a\u4efb\u4f55\u8b66\u544a\u6216\u9519\u8bef\u3002","title":"6\u3001Kiali"},{"location":"chap8/3Istio_mon/#7","text":"1\u3001Prometheus\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684\uff1f A \u8bb0\u5f55\u6307\u6807\uff0c\u8ddf\u8e2aIstio\u548c\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5 B \u53ef\u89c6\u5316\u670d\u52a1\u4e4b\u95f4\u7684\u6d41\u91cf C \u91c7\u96c6\u5206\u5e03\u5f0f\u8ddf\u8e2a D \u90e8\u7f72\u5206\u5e03\u5f0f\u5e94\u7528 2\u3001\u4ec0\u4e48\u662fZipkin? A \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf B \u53ef\u89c6\u5316\u6d41\u91cf\u7684\u5e73\u53f0 C \u6536\u96c6\u670d\u52a1\u65e5\u5fd7\u7684\u6846\u67b6 D \u8bb0\u5f55Istio\u670d\u52a1\u5065\u5eb7\u7684\u51ed\u6761 3\u3001\u4ec0\u4e48\u662fKiali? A \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf B Grafana\u63d2\u4ef6 C Istio\u53ef\u89c2\u6d4b\u6027\u9762\u677f D \u65e5\u5fd7\u6536\u96c6\u5de5\u5177 4\u3001\u4f60\u53ef\u4ee5\u4f7f\u7528Istio CLI\u4e2d\u7684\u54ea\u4e2a\u8f85\u52a9\u547d\u4ee4\u6765\u6253\u5f00 Prometheus/Grafana/Jaeger/Zipkin? A istioctl open dash B istiocti dashboard open C istioctl --dashboard D istioctl dashboard 5\u3001Istio\u4f9d\u9760\u54ea\u4e9b\u5934\u4fe1\u606f\u6765\u8fdb\u884c\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1f A X-headers B B3 header\u548cEnvoy requestID C Host\u548cUser header D Request ID header 6\u3001\u4ec0\u4e48\u662fGrafana? A \u50a8\u5b58\u591a\u4e2a\u6765\u6e90\u7684\u65e5\u5fd7\u7684\u89e3\u51b3\u65b9\u6848 B Prometheus\u548c\u5176\u4ed6\u6765\u6e90\u7684\u6570\u636e\u7684\u53ef\u89c6\u5316\u5e73\u53f0 C \u6536\u96c6\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7684\u6846\u67b6 D \u7528\u4e8e\u53ef\u89c6\u5316\u6570\u636e\u7684Prometheus\u63d2\u4ef6","title":"7\u3001\u53ef\u89c2\u6d4b\u6027\u6d4b\u8bd5"},{"location":"chap8/4Istio_net_control/","text":"\u7b2c\u56db\u8282 \u6d41\u91cf\u7ba1\u7406 0\u3001Traffic Management Traffic routing Service resiliency and failure injection Envoy filters Labs: Exposing services using Gateway resource Observing failure injection and delays Simple traffic routing Advanced traffic routing Quiz 1\u3001\u4f7f\u7528Gateway \u4f5c\u4e3a Istio \u5b89\u88c5\u7684\u4e00\u90e8\u5206\uff0c\u6211\u4eec\u5b89\u88c5\u4e86Istio\u7684\u5165\u53e3\u548c\u51fa\u53e3\u7f51\u5173\u3002 \u8fd9\u4e24\u4e2a\u7f51\u5173\u90fd\u8fd0\u884c\u4e00\u4e2aEnvoy\u4ee3\u7406\u5b9e\u4f8b\uff0c\u5b83\u4eec\u5728\u7f51\u683c\u7684\u8fb9\u7f18\u4f5c\u4e3a\u8d1f\u8f7d\u5747\u8861\u5668\u8fd0\u884c\u3002\u5165\u53e3\u7f51\u5173\u63a5\u6536\u5165\u7ad9\u8fde\u63a5\uff0c\u800c\u51fa\u53e3\u7f51\u5173\u63a5\u6536 \u4ece\u96c6\u7fa4\u51fa\u53bb\u7684\u8fde\u63a5\u3002 \u4f7f\u7528\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u8fdb\u5165\u96c6\u7fa4\u7684\u6d41\u91cf\u5e94\u7528\u8def\u7531\u89c4\u5219\u3002\u6211\u4eec\u53ef\u4ee5\u6709\u4e00\u4e2a\u6307\u5411\u5165\u53e3\u7f51\u5173\u7684\u5355\u4e00\u5916\u90e8IP\u5730\u5740\uff0c\u5e76\u6839\u636e\u4e3b\u673a\u5934\u5c06\u6d41\u91cf\u8def\u7531\u5230\u96c6\u7fa4\u5185\u7684\u4e0d\u540c\u670d\u52a1 \u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528Gateway\u8d44\u6e90\u6765\u914d\u7f6e\u7f51\u5173\u3002\u7f51\u5173\u8d44\u6e90\u63cf\u8ff0\u4e86\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u66b4\u9732\u7aef\u53e3\u3001\u534f\u8bae\u3001SNI \uff08\u670d\u52a1\u5668\u540d\u79f0\u6307\u793a\uff09\u914d\u7f6e\u7b49\u3002 \u7f51\u5173\u8d44\u6e90\u5728\u80cc\u540e\u63a7\u5236\u7740Envoy\u4ee3\u7406\u5728\u7f51\u7edc\u63a5\u53e3\u4e0a\u7684\u76d1\u542c\u65b9\u5f0f\u4ee5\u53ca\u5b83\u51fa\u793a\u7684\u8bc1\u4e66\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u7f51\u5173\u8d44\u6e90\u7684\u4f8b\u5b50\uff1a apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: my-gateway namespace: default spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - dev.example.com - test.example.com \u4e0a\u8ff0\u7f51\u5173\u8d44\u6e90\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u4ee3\u7406\uff0c \u4f5c\u4e3a\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c\u4e3a\u5165\u53e3\u66b4\u973280\u7aef\u53e3\u3002 \u7f51\u5173\u914d\u7f6e\u88ab\u5e94\u7528\u4e8e Istio \u5165\u53e3\u7f51\u5173\u4ee3\u7406\uff0c\u6211\u4eec\u5c06\u5176\u90e8\u7f72\u5230 istio-system \u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u8bbe\u7f6e\u4e86\u6807\u7b7e istio:ingressgateway \u3002 \u901a\u8fc7\u7f51\u5173\u8d44\u6e90\uff0c\u6211\u4eec\u53ea\u80fd\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\u3002 hosts \u5b57\u6bb5\u4f5c\u4e3a\u4e00\u4e2a\u8fc7\u6ee4\u5668\uff0c\u53ea\u6709\u4ee5 dev.example.com \u548c test.example.com \u4e3a\u76ee\u7684\u5730\u7684\u6d41\u91cf\u4f1a\u88ab\u5141\u8bb8\u901a\u8fc7\u3002 \u4e3a\u4e86\u63a7\u5236\u548c\u8f6c\u53d1\u6d41\u91cf\u5230\u96c6\u7fa4\u5185\u8fd0\u884c\u7684\u5b9e\u9645 Kubernetes \u670d\u52a1\uff0c\u6211\u4eec\u5fc5\u987b\u7528\u7279\u5b9a\u7684\u4e3b\u673a\u540d\uff08\u4f8b\u5982 dev.example.com \u548c test.example.com \uff09\u914d\u7f6e\u4e00\u4e2a VirtualService \uff0c\u7136\u540e\u5c06\u7f51\u5173\u8fde\u63a5\u5230 \u5b83\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u4f5c\u4e3aIstio\u5b89\u88c5demo\u7684\u4e00\u90e8\u5206\u800c\u90e8\u7f72\u7684Ingress\u7f51\u5173\u521b\u5efa\u4e86\u4e00\u4e2a\u5177\u6709 Load Balancer\u7c7b\u578b\u7684Kubernetes\u670d\u52a1\uff0c\u5e76\u4e3a\u5176\u5206\u914d\u4e86\u4e00\u4e2a\u5916\u90e8IP: $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.106.113.25 <none> 3000/TCP 23h istio-egressgateway ClusterIP 10.104.176.79 <none> 80/TCP,443/TCP 3d3h istio-ingressgateway LoadBalancer 10.105.159.70 localhost 15021:31875/TCP,80:32344/TCP,443:31252/TCP,31400:31315/TCP,15443:31199/TCP 3d3h istiod ClusterIP 10.96.216.110 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP 3d3h LoadBalancer Kubernetes\u670d\u52a1\u7c7b\u578b\u7684\u5de5\u4f5c\u65b9\u5f0f\u53d6\u51b3\u4e8e\u6211\u4eec\u8fd0\u884cKubernetes\u96c6\u7fa4\u7684\u65b9\u5f0f\u548c\u5730\u70b9\u3002\u5bf9\u4e8e\u4e91\u6258\u7ba1\u7684\u96c6\u7fa4\uff08GCPS. AWS\u3001 Azure\u7b49\uff09\uff0c\u5728\u4f60\u7684\u4e91\u8d26\u6237\u4e2d\u914d\u7f6e\u4e86\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u8d44\u6e90\uff0cKubernetes LoadBalancer\u670d\u52a1\u5c06\u83b7\u5f97\u4e00\u4e2a\u5206\u914d\u7ed9\u5b83\u7684\u5916\u90e8IP\u5730\u5740\u3002\u5047\u8bbe\u6211\u4eec\u6b63\u5728\u4f7f\u7528Minikube\u6216DockerDesktop\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5916\u90e8IP\u5730\u5740\u5c06\u88ab\u8bbe\u7f6e\u4e3alocalhost (Docker Desktop)\uff0c\u6216\u8005\uff0c\u5982\u679c\u6211\u4eec\u4f7f\u7528Minikube\uff0c\u5b83\u5c06\u4fdd\u6301\u5f85\u5b9a\uff0c\u6211\u4eec\u5c06\u4e0d\u5f97\u4e0d\u4f7f\u7528minikube tunnel\u547d\u4ee4\u6765\u83b7\u5f97\u4e00\u4e2aIP\u5730\u5740\u3002 \u9664\u4e86\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u90e8\u7f72\u4e00\u4e2a\u51fa\u53e3\u7f51\u5173\u6765\u63a7\u5236\u548c\u8fc7\u6ee4\u79bb\u5f00\u7f51\u683c\u7684\u6d41\u91cf\u3002 \u5c31\u50cf\u6211\u4eec\u914d\u7f6e\u5165\u53e3\u7f51\u5173\u4e00\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u76f8\u540c\u7684\u7f51\u5173\u8d44\u6e90\u6765\u914d\u7f6e\u51fa\u53e3\u7f51\u5173\u3002\u8fd9\u4f7f\u6211\u4eec\u80fd\u591f\u96c6\u4e2d\u7ba1\u7406\u6240\u6709\u6d41\u51fa\u7684\u6d41\u91cf\u3001\u65e5\u5fd7\u548c\u6388\u6743\u3002 2\u3001\u7b80\u5355\u8def\u7531 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 VirtualService \u8d44\u6e90\u5728Istio\u670d\u52a1\u7f51\u683c\u4e2d\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002 \u901a\u8fc7 VirtualService , \u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u6d41\u91cf\u8def\u7531\u89c4\u5219\uff0c\u5e76\u5728\u5ba2\u6237\u7aef\u8bd5\u56fe\u8fde\u63a5\u5230\u670d\u52a1\u65f6\u5e94\u7528\u8fd9\u4e9b\u89c4\u5219\u3002\u4f8b\u5982\u5411 dev.example.com \u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff0c\u6700\u7ec8\u5230\u8fbe\u76ee\u6807\u670d\u52a1\u3002 \u8ba9\u6211\u4eec\u770b\u4e00\u4e0b\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c customers \u5e94\u7528\u7a0b\u5e8f\u7684\u4e24\u4e2a\u7248\u672c\uff08v1\u548cv2\uff09\u7684\u4f8b\u5b50\u3002\u6211\u4eec\u6709\u4e24\u4e2a Kubernetes \u90e8\u7f72\uff0c customers-v1 \u548c customers-v2 \u3002 \u5c5e\u4e8e\u8fd9\u4e9b\u90e8\u7f72\u7684Pod\u6709\u4e00\u4e2a\u6807\u7b7e version: v1 \u6216\u4e00\u4e2a\u6807\u7b7e version: v2 \u7684\u8bbe\u7f6e\u3002 \u6211\u4eec\u60f3\u628aVirtualService\u914d\u7f6e\u4e3a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u5e94\u7528\u7a0b\u5e8f\u7684V1\u7248\u672c\u300270\uff05\u7684\u4f20\u5165\u6d41\u91cf\u5e94\u8be5\u88ab\u8def\u7531\u5230V1\u7248\u672c\u300230\uff05\u7684\u8bf7\u6c42\u5e94\u8be5\u88ab\u53d1\u9001\u5230\u5e94\u7528\u7a0b\u5e8f\u7684V2\u7248\u672c\u3002 \u4e0b\u9762\u662f\u4e0a\u8ff0\u60c5\u51b5\u4e0b VirtualService \u8d44\u6e90\u7684\u6837\u5b50\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers-route spec: hosts: - customers.default.svc.cluster.local http: - name: customers-v1-routes route: - destination: host: customers.default.svc.cluster.local subset: v1 weight: 70 - name: customers-v2-routes route: - destination: host: customers.default.svc.cluster.local subset: v2 weight: 30 \u5728 hosts \u5b57\u6bb5\u4e0b\uff0c\u6211\u4eec\u8981\u5b9a\u4e49\u6d41\u91cf\u88ab\u53d1\u9001\u5230\u7684\u76ee\u6807\u4e3b\u673a\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u8fd9\u5c31\u662f customers.default.svc.cluster.local Kubernetes\u670d\u52a1\u3002 \u4e0b\u4e00\u4e2a\u5b57\u6bb5\u662fhttp\uff0c\u8fd9\u4e2a\u5b57\u6bb5\u5305\u542b\u4e00\u4e2aHTTP\u6d41\u91cf\u7684\u8def\u7531\u89c4\u5219\u7684\u6709\u5e8f\u5217\u8868\u3002 destination \u662f\u6307\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u7684\u4e00\u4e2a\u670d\u52a1\uff0c\u4e5f\u662f\u8def\u7531\u89c4\u5219\u5904\u7406\u540e\u8bf7\u6c42\u5c06\u88ab\u53d1\u9001\u5230\u7684\u76ee\u7684\u5730 Istio \u7684\u670d\u52a1\u6ce8\u518c\u8868\u5305\u542b\u6240\u6709\u7684Kubernetes\u670d\u52a1\uff0c\u4ee5\u53ca\u4efb\u4f55\u7528 ServiceEntry \u8d44\u6e90\u58f0\u660e\u7684\u670d\u52a1\u3002 \u6211\u4eec\u4e5f\u5728\u8bbe\u7f6e\u6bcf\u4e2a\u76ee\u7684\u5730\u7684\u6743\u91cd\uff08weight)\u3002\u6743\u91cd\u7b49\u4e8e\u53d1\u9001\u5230\u6bcf\u4e2a\u5b50\u96c6\u7684\u6d41\u91cf\u7684\u6bd4\u4f8b\u3002\u6240\u6709\u6743\u91cd\u7684\u603b\u548c\u5e94\u8be5\u662f100\u3002\u5982\u679c\u6211\u4eec\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u76ee\u7684\u5730\uff0c\u6743\u91cd\u88ab\u5047\u5b9a\u4e3a100\u3002 \u901a\u8fc7 gateways \u5b57\u6bb5\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6307\u5b9a\u6211\u4eec\u60f3\u8981\u7ed1\u5b9a\u8fd9\u4e2a VirtualService \u7684\u7f51\u5173\u540d\u79f0 \u3002\u6bd4\u5982 \u8bf4\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers-route spec: hosts: - customers.default.svc.cluster.local gateways: - my-gateway http: ... \u4e0a\u9762\u7684YAML\u5c06 customers-route VirtualService\u7ed1\u5b9a\u5230\u540d\u4e3a my-gateway \u7684\u7f51\u5173\u4e0a\u3002\u8fd9 \u6709\u6548\u5730\u66b4\u9732\u4e86\u901a\u8fc7\u7f51\u5173\u7684\u76ee\u6807\u8def\u7531\u3002 \u5f53\u4e00\u4e2a VirtualService \u88ab\u9644\u52a0\u5230\u4e00\u4e2a\u7f51\u5173\u4e0a\u65f6, \u53ea\u5141\u8bb8\u5728\u7f51\u5173\u8d44\u6e90\u4e2d\u5b9a\u4e49\u7684\u4e3b\u673a\u3002 \u4e0b\u8868\u89e3\u91ca\u4e86\u7f51\u5173\u8d44\u6e90\u4e2d\u7684 hosts \u5b57\u6bb5\u5982\u4f55\u4f5c\u4e3a\u8fc7\u6ee4\u5668\uff0c VirtualService \u4e2d\u7684hosts\u5b57\u6bb5\u5982\u4f55\u4f5c\u4e3a\u5339\u914d 3\u3001Subset\u548cDestination Rule \u76ee\u7684\u5730\u6307\u7684\u662f\u4e0d\u540c\u7684\u5b50\u96c6\uff08subset\uff09\u6216\u670d\u52a1\u7248\u672c\u3002\u901a\u8fc7\u5b50\u96c6\uff0c\u6211\u4eec\u53ef\u4ee5\u8bc6\u522b\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u53d8\u4f53\u3002 \u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u6709\u4e24\u4e2a\u5b50\u96c6\uff0cv1\u548cv2\uff0c\u5b83\u4eec\u5bf9\u5e94\u4e8e\u6211\u4eeccustomer\u670d\u52a1\u7684\u4e24\u4e2a\u4e0d\u540c\u7248\u672c\u3002\u6bcf\u4e2a\u5b50\u96c6\u90fd\u4f7f\u7528\u952e\uff0f\u503c\u5bf9\uff08\u6807\u7b7e\uff09\u7684\u7ec4\u5408\u6765\u786e\u5b9a\u54ea\u4e9bPod\u8981\u5305\u542b\u5728\u5b50\u96c6\u4e2d\u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u540d\u4e3a DestinationRule \u7684\u8d44\u6e90\u7c7b\u578b\u4e2d\u58f0\u660e\u5b50\u96c6\u3002 \u4e0b\u9762\u662f\u5b9a\u4e49\u4e86\u4e24\u4e2a\u5b50\u96c6\u7684DestinationRule\u8d44\u6e90\u7684\u6837\u5b50\u3002 apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers-destination spec: host: customers.default.svc.cluster.local subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 \u8ba9\u6211\u4eec\u770b\u770b\u6211\u4eec\u53ef\u4ee5\u5728DestinationRule\u4e2d\u8bbe\u7f6e\u7684\u6d41\u91cf\u7b56\u7565\u3002 3-1 Destination Rule\u4e2d\u7684\u6d41\u91cf\u7b56\u7565 \u901a\u8fc7 DestinationRule \uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u8bbe\u7f6e\uff0c\u5982\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u3001\u8fde\u63a5\u6c60\u5927\u5c0f\u3001\u5c40\u90e8\u5f02\u5e38\u68c0\u6d4b\u7b49\uff0c\u5728\u8def\u7531\u53d1\u751f\u540e\u5e94\u7528\u4e8e\u6d41\u91cf\u3002\u6211\u4eec\u53ef\u4ee5\u5728trafficPolicy\u5b57\u6bb5\u4e0b\u8bbe\u7f6e\u6d41\u91cf\u7b56\u7565\u8bbe\u7f6e\u3002 \u4ee5\u4e0b\u662f\u8fd9\u4e9b\u8bbe\u7f6e\uff1a \u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e \u8fde\u63a5\u6c60\u8bbe\u7f6e \u5c40\u90e8\u5f02\u5e38\u70b9\u68c0\u6d4b \u5ba2\u6237\u7aefTLS\u8bbe\u7f6e \u7aef\u53e3\u6d41\u91cf\u7b56\u7565 Traffic Policies Load balancer settings Connection pool settings Outlier detection Client TLS settings Port traffic policy \u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e \u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u76ee\u7684\u5730\u4f7f\u7528\u54ea\u79cd\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u5e26\u6709\u6d41\u91cf\u7b56\u7565\u7684DestinationRule\u7684\u4f8b\u5b50\uff0c\u5b83\u628a\u76ee\u7684\u5730\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u8bbe\u7f6e\u4e3a round-robin apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers-destination spec: host: customers.default.svc.cluster.local trafficPolicy: loadBalancer: simple: ROUND_ROBIN subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 \u6211\u4eec\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u57fa\u4e8e\u54c8\u5e0c\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5e76\u6839\u636eHTTP\u5934\u3001cookies\u6216\u5176\u4ed6\u8bf7\u6c42\u5c5e\u6027\u63d0\u4f9b\u4f1a\u8bdd\u4eb2\u548c\u6027\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u6d41\u91cf\u7b56\u7565\u7684\u7247\u6bb5\uff0c\u5b83\u8bbe\u7f6e\u4e86\u57fa\u4e8e\u54c8\u5e0c\u7684\u8d1f\u8f7d\u5747\u8861 \uff0c\u5e76\u4f7f\u7528\u4e00\u4e2a\u53eb\u505a location \u7684 cookie \u6765\u5b9e\u73b0\u4eb2\u548c\u529b\u3002 trafficPolicy: loadBalancer: consistentHash: httpCookie: name: location ttl: 4s 3-2 \u8fde\u63a5\u6c60\u914d\u7f6e \u8fd9\u4e9b\u8bbe\u7f6e\u53ef\u4ee5\u5728TCP\u548cHTTP\u5c42\u9762\u5e94\u7528\u4e8e\u4e0a\u6e38\u670d\u52a1\u7684\u6bcf\u4e2a\u4e3b\u673a, \u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u4eec\u6765\u63a7\u5236\u94fe\u63a5\u91cf \u4e0b\u9762\u662f\u4e00\u4e2a\u7247\u6bb5\uff0c\u663e\u793a\u4e86\u6211\u4eec\u5982\u4f55\u8bbe\u7f6e\u5bf9\u670d\u52a1\u7684\u5e76\u53d1\u8bf7\u6c42\u7684\u9650\u5236\u3002 spec: host: myredissrv.prod.svc.cluster.local trafficPolicy: connectionPool: http: http2MaxRequests: 50 3-3 \u5f02\u5e38\u70b9\u68c0\u6d4b \u5f02\u5e38\u70b9\u68c0\u6d4b\u662f\u4e00\u4e2a\u65ad\u8def\u5668\u7684\u5b9e\u73b0\uff0c\u5b83\u8ddf\u8e2a\u4e0a\u6e38\u670d\u52a1\u4e2d\u6bcf\u4e2a\u4e3b\u673a\uff08Pod)\u7684\u72b6\u6001\u3002 \u5982\u679c\u4e00\u4e2a\u4e3b\u673a\u5f00\u59cb\u8fd4\u56de5xx HTTP\u9519\u8bef\uff0c\u5b83\u5c31\u4f1a\u5728\u9884\u5b9a\u7684\u65f6\u95f4\u5185\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\u3002\u5bf9\u4e8eTCP\u670d\u52a1\uff0cEnvoy\u5c06\u8fde\u63a5\u8d85\u65f6\u6216\u5931\u8d25\u8ba1\u7b97\u4e3a\u9519\u8bef \u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5b83\u8bbe\u7f6e\u4e86500\u4e2a\u5e76\u53d1\u7684HTTP2\u8bf7\u6c42\uff08 http2MaxRequests \uff09\u7684\u9650\u5236\uff0c\u6bcf\u4e2a\u8fde\u63a5\u4e0d\u8d85\u8fc710\u4e2a\u8bf7\u6c42\uff08 maxRequestsPerConnection )\u5230\u8be5\u670d\u52a1\u3002 \u6bcf5\u5206\u949f\u626b\u63cf\u4e00\u6b21\u4e0a\u6e38\u4e3b\u673a\uff08Pod) (interval)\uff0c\u5982\u679c\u5176\u4e2d\u4efb\u4f55\u4e00\u4e2a\u4e3b\u673a\u8fde\u7eed\u5931\u8d2510\u6b21 (contracticalErrors),Envoy\u4f1a\u5c06\u5176\u5f39\u51fa10\u5206\u949f\uff08baseEjectionTime)\u3002 3-4 \u5ba2\u6237\u7aefTLS\u8bbe\u7f6e \u5305\u542b\u4efb\u4f55\u4e0e\u4e0a\u6e38\u670d\u52a1\u8fde\u63a5\u7684\u4e01LS\u76f8\u5173\u8bbe\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u4f7f\u7528\u63d0\u4f9b\u7684\u8bc1\u4e66\u914d\u7f6emTLS\u7684\u4f8b\u5b50\u3002 trafficPolicy: tls: mode: MUTUAL clientCertificate: /etc/certs/cert.pem privateKey: /etc/certs/key.pem caCertificates: /etc/certs/ca.pem \u5176\u4ed6\u652f\u6301\u7684TLS\u6a21\u5f0f\u6709 DISABLE \uff08\u6ca1\u6709TLS\u8fde\u63a5\uff09, SIMPLE\uff08\u5728\u4e0a\u6e38\u7aef\u70b9\u53d1\u8d77TLS\u8fde\u63a5,\uff09 ISTIO_MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09 3-5 \u7aef\u53e3\u6d41\u91cf\u7b56\u7565 \u4f7f\u7528 portLevelSettings \u5b57\u6bb5\uff0c\u6211 \u4eec\u53ef\u4ee5\u5c06\u6d41\u91cf\u7b56\u7565\u5e94\u7528\u4e8e\u5355\u4e2a\u7aef\u53e3 \u3002\u6bd4\u5982\u8bf4\uff1a trafficPolicy: portLevelSettings: - port: number: 80 loadBalancer: simple: LEAST_CONN - port: number: 8000 loadBalancer: simple: ROUND_ROBIN 4\u3001\u5f39\u6027 \u5f39\u6027\uff08Resiliency\uff09\u662f\u6307\u5728\u9762\u5bf9\u6545\u969c\u548c\u5bf9\u6b63\u5e38\u8fd0\u884c\u7684\u6311\u6218\u65f6\uff0c\u63d0\u4f9b\u548c\u4fdd\u6301\u53ef\u63a5\u53d7\u7684\u670d\u52a1\u6c34\u5e73\u7684\u80fd\u529b\u3002 \u8fd9\u4e0d\u662f\u4e3a\u4e86\u907f\u514d\u6545\u969c\uff0c\u800c\u662f\u4ee5\u4e00\u79cd\u6ca1\u6709\u505c\u673a\u6216\u6570\u636e\u4e22\u5931\u7684\u65b9\u5f0f\u6765\u5e94\u5bf9\u6545\u969c\u3002\u5f39\u6027\u7684\u76ee\u6807 \u662f\u5728\u6545\u969c\u53d1\u751f\u540e\u5c06\u670d\u52a1\u6062\u590d\u5230\u4e00\u4e2a\u5b8c\u5168\u6b63\u5e38\u7684\u72b6\u6001 \u3002 Provide and maintain an acceptable level of service in the face of faults and challenges to regular operation . Timeouts Retry policies Configurable on VirtualService Retries Number of retries Timeout per try Conditions to retry on Note: endpoint that caused the retry is not included in the LB pool on the next try. \u4f7f\u670d\u52a1\u53ef\u7528\u7684\u4e00\u4e2a\u5173\u952e\u56e0\u7d20\u662f\u5728\u63d0\u51fa\u670d\u52a1\u8bf7\u6c42\u65f6\u4f7f\u7528\u8d85\u65f6\uff08timeout\uff09\u548c\u91cd\u8bd5\uff08retry\uff09\u7b56\u7565\u3002 \u6211\u4eec\u53ef\u4ee5\u5728 Istio \u7684 VirtualService \u4e0a\u914d\u7f6e\u8fd9\u4e24\u8005\u3002 \u4f7f\u7528\u8d85\u65f6\u5b57\u6bb5\u7684\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u4e3aHTTP\u8bf7\u6c42\u5b9a\u4e49\u4e00\u4e2a\u8d85\u65f6\u3002\u5982\u679c\u8bf7\u6c42\u7684\u65f6\u95f4\u8d85\u8fc7\u4e86\u8d85\u65f6\u5b57\u6bb5\u4e2d\u6307\u5b9a\u7684\u503c\uff0cEnvoy\u4ee3\u7406\u5c06\u653e\u5f03\u8bf7\u6c42\uff0c\u5e76\u5c06\u5176\u6807\u8bb0\u4e3a\u8d85\u65f6\uff08\u5411\u5e94\u7528\u7a0b\u5e8f\u8fd4\u56de\u4e00\u4e2aHTTP 408) \u3002 \u8fde\u63a5\u4fdd\u6301\u5f00\u653e\uff0c\u9664\u975e\u89e6\u53d1\u4e86\u5f02\u5e38\u70b9\u68c0\u6d4b\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u4e3a\u8def\u7531\u8bbe\u7f6e\u8d85\u65f6\u7684\u4f8b\u5b50\uff1a ... - route: - destination: host: customers.default.svc.cluster.local subset: v1 timeout: 10s ... \u9664\u4e86\u8d85\u65f6\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u914d\u7f6e\u66f4\u7ec6\u5316\u7684\u91cd\u8bd5\u7b56\u7565\u3002\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u4e00\u4e2a\u7ed9\u5b9a\u8bf7\u6c42\u7684\u91cd\u8bd5\u6b21\u6570\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u4ee5\u53ca\u6211\u4eec\u60f3\u8981\u91cd\u8bd5\u7684\u5177\u4f53\u6761\u4ef6\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u53ea\u5728\u4e0a\u6e38\u670d\u52a1\u5668\u8fd4\u56de5xx\u54cd\u5e94\u4ee3\u7801\u65f6\u91cd\u8bd5\u8bf7\u6c42\uff0c\u6216\u8005\u53ea\u5728\u7f51\u5173\u9519\u8bef\uff08HTTP 5O2\u3001 503\u6216504\uff09\u65f6\u91cd\u8bd5\uff0c\u6216\u8005\u751a\u81f3\u5728\u8bf7\u6c42\u5934\u4e2d\u6307\u5b9a\u53ef\u91cd\u8bd5\u7684\u72b6\u6001\u4ee3\u7801\u3002 \u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\u3002\u5f53Envoy\u91cd\u8bd5\u4e00\u4e2a\u5931\u8d25\u7684\u8bf7\u6c42\u65f6\uff0c \u6700\u521d\u5931\u8d25\u5e76\u5bfc\u81f4\u91cd\u8bd5\u7684\u7aef\u70b9\u5c31\u4e0d\u518d\u5305\u542b\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u4e86 \u3002\u5047\u8bbeKubernetes\u670d\u52a1\u67093\u4e2a\u7aef\u70b9\uff08Pod)\uff0c\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u4e86\uff0c \u5e76\u51fa\u73b0\u4e86\u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u4ee3\u7801\u3002 \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u5b83\u4e0d\u4f1a\u518d\u5411\u539f\u6765\u7684\u7aef\u70b9\u91cd\u65b0\u53d1\u9001\u8bf7\u6c42\u3002\u76f8\u53cd\uff0c\u5b83\u5c06\u628a\u8bf7\u6c42\u53d1 \u9001\u5230\u4e24\u4e2a\u6ca1\u6709\u5931\u8d25\u7684\u7aef\u70b9\u4e2d\u7684\u4e00\u4e2a\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff0c\u8bf4\u660e\u5982\u4f55\u4e3a\u4e00\u4e2a\u7279\u5b9a\u7684\u76ee\u7684\u5730\u8bbe\u7f6e\u91cd\u8bd5\u7b56\u7565\u3002 ... - route: - destination: host: customers.default.svc.cluster.local subset: v1 retries: attempts: 10 perTryTimeout: 2s retryOn: connect-failure,reset ... \u4e0a\u8ff0\u91cd\u8bd5\u7b56\u7565\u5c06\u5c1d\u8bd5\u91cd\u8bd5\u4efb\u4f55\u8fde\u63a5\u8d85\u65f6\uff08connect-failure)\u6216\u670d\u52a1\u5668\u5b8c\u5168\u4e0d\u54cd\u5e94 (reset)\u7684\u5931\u8d25\u8bf7\u6c42\u3002\u6211\u4eec\u5c06\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a2\u79d2\uff0c\u5c1d\u8bd5\u7684\u6b21\u6570\u8bbe\u7f6e\u4e3a10\u6b21\u3002 \u6ce8\u610f\uff0c\u5982\u679c\u540c\u65f6\u8bbe\u7f6e\u91cd\u8bd5\u548c\u8d85\u65f6\uff0c\u8d85\u65f6\u503c\u5c06\u662f\u8bf7\u6c42\u7b49\u5f85\u7684\u6700\u957f\u65f6\u95f4\u3002\u5982\u679c\u6211\u4eec\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\u6307\u5b9a\u4e8610\u79d2\u7684\u8d85\u65f6\uff0c\u90a3\u4e48\u5373\u4f7f\u91cd\u8bd5\u7b56\u7565\u4e2d\u8fd8\u5269\u4e0b\u4e00\u4e9b\u5c1d\u8bd5\uff0c\u6211\u4eec\u4e5f\u53ea\u80fd\u6700\u591a\u7b49\u5f8510\u79d2 \u3002 \u53c2\u9605 x-envoy-retry 5\u3001\u6545\u969c\u6ce8\u5165 \u4e3a\u4e86\u5e2e\u52a9\u6211\u4eec\u63d0\u9ad8\u670d\u52a1\u7684\u5f39\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u6545\u969c\u6ce8\u5165\u529f\u80fd\u3002\u6211\u4eec\u53ef\u4ee5\u5728HTTP\u6d41\u91cf\u4e0a\u5e94\u7528\u6545\u969c\u6ce8\u5165\u7b56\u7565\uff0c\u5728\u8f6c\u53d1\u76ee\u7684\u5730\u7684\u8bf7\u6c42\u65f6\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u6545\u969c\u6ce8\u5165\u3002 \u6709\u4e24\u79cd\u7c7b\u578b\u7684\u6545\u969c\u6ce8\u5165\u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u8f6c\u53d1\u524d\u5ef6\u8fdf\uff08delay\uff09\u8bf7\u6c42\uff0c\u6a21\u62df\u7f13\u6162\u7684\u7f51\u7edc\u6216\u8fc7\u8f7d\u7684\u670d\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u4e2d\u6b62\uff08abort) HTTP\u8bf7\u6c42 \uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u7279\u5b9a\u7684HTTP\u9519\u8bef\u4ee3\u7801\u7ed9\u8c03\u7528\u8005\u3002 \u901a\u8fc7\u4e2d\u6b62\uff0c \u6211\u4eec\u53ef\u4ee5\u6a21\u62df\u4e00\u4e2a\u6709\u6545\u969c\u7684\u4e0a\u6e38\u670d\u52a1 \u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u4e2d\u6b62HTTP\u8bf7\u6c42\u5e76\u8fd4\u56de HTTP 404 \u7684\u4f8b\u5b50\uff0c\u9488\u5bf930\uff05\u7684\u4f20\u5165\u8bf7\u6c42\u3002 - route: - destination: host: customers.default.svc.cluster.local subset: v1 fault: abort: percentage: value: 30 httpStatus: 404 \u5982\u679c\u6211\u4eec\u4e0d\u6307\u5b9a\u767e\u5206\u6bd4\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u4e2d\u6b62 \u3002\u8bf7\u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u4f1a\u5f71\u54cd\u4f7f\u7528\u8be5 VirtualService\u7684\u670d\u52a1\u3002\u5b83\u5e76\u4e0d\u5f71\u54cd\u8be5\u670d\u52a1\u7684\u6240\u6709\u6d88\u8d39\u8005\u3002 \u540c\u6837\u5730\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 fixedDelay \u5b57\u6bb5\u5bf9\u8bf7\u6c42\u5e94\u7528\u4e00\u4e2a\u53ef\u9009\u7684\u5ef6\u8fdf\u3002 - route: - destination: host: customers.default.svc.cluster.local subset: v1 fault: delay: percentage: value: 5 fixedDelay: 3s \u4e0a\u8ff0\u8bbe\u7f6e\u5c06\u5bf9 5\uff05 \u7684\u4f20\u5165\u8bf7\u6c42\u5e94\u75283\u79d2\u7684\u5ef6\u8fdf\u3002 \u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u5c06\u4e0d\u4f1a\u89e6\u53d1\u6211\u4eec\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u6ce8\u5165\u4e86\u4e00\u4e2aHTTP 500\u7684\u9519\u8bef\uff0c\u914d\u7f6e\u4e3aHTTP 500\u4e0a\u7684\u91cd\u8bd5\u7b56\u7565\u5c06\u4e0d\u4f1a\u88ab\u89e6\u53d1\u3002 6\u3001\u9ad8\u7ea7\u8def\u7531 \u5728\u524d\u9762\uff0c\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u5229\u7528\u6d41\u91cf\u7684\u6bd4\u4f8b\uff08weight\u5b57\u6bb5\uff09\u5728\u591a\u4e2a\u5b50\u96c6\u4e4b\u95f4\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u7eaf\u7cb9\u7684\u57fa\u4e8e\u6743\u91cd\u7684\u6d41\u91cf\u8def\u7531\u6216\u5206\u5272\u5df2\u7ecf\u8db3\u591f\u4e86\u3002\u7136\u800c\uff0c\u5728\u6709\u4e9b\u573a\u666f\u548c\u60c5\u51b5\u4e0b\uff0c\u6211 \u4eec\u53ef\u80fd\u9700\u8981\u5bf9\u6d41\u91cf\u5982\u4f55\u88ab\u5206\u5272\u548c\u8f6c\u53d1\u5230\u76ee\u6807\u670d\u52a1\u8fdb\u884c\u66f4\u7ec6\u5316\u7684\u63a7\u5236\u3002 Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528\u4f20\u5165\u8bf7\u6c42\u7684\u4e00\u90e8\u5206\uff0c\u5e76\u5c06\u5176\u4e0e\u5b9a\u4e49\u7684\u503c\u76f8\u5339\u914d\u3002\u4f8b\u5982\uff0c \u6211\u4eec\u53ef\u4ee5\u5339\u914d\u4f20\u5165\u8bf7\u6c42\u7684URI\u524d\u7f00\uff0c\u5e76\u57fa\u4e8e\u6b64\u8def\u7531\u6d41\u91cf \u3002 \u4e0a\u8ff0\u6bcf\u4e2a\u5c5e\u6027\u90fd\u53ef\u4ee5\u7528\u8fd9\u4e9b\u65b9\u6cd5\u4e2d\u7684\u4e00\u79cd\u8fdb\u884c\u5339\u914d \u7cbe\u786e\u5339\u914d\uff1a\u4f8b\u5982\uff0c exact: \"value\" \u5339\u914d\u7cbe\u786e\u7684\u5b57\u7b26\u4e32 \u524d\u7f00\u5339\u914d\uff1a\u4f8b\u5982\uff0c prefix: \"value\" \u53ea\u5339\u914d\u524d\u7f00 \u6b63\u5219\u5339\u914d: \u4f8b\u5982\uff0c regex: \"value\" \u6839\u636e ECMAscript \u98ce\u683c\u7684\u6b63\u5219\u8fdb\u884c\u5339\u914d \u4f8b\u5982\uff0c\u5047\u8bbe\u8bf7\u6c42\u7684URI\u770b\u8d77\u6765\u50cf\u8fd9\u6837 https://dev.example.com/v1/api \u4e3a\u4e86\u5339\u914d\u8be5\u8bf7\u6c42\u7684URI\uff0c\u6211\u4eec\u4f1a\u8fd9\u6837\u5199\uff1a http: - match: - uri: prefix: /v1 \u4e0a\u8ff0\u7247\u6bb5\u5c06\u5339\u914d\u4f20\u5165\u7684\u8bf7\u6c42\uff0c\u5e76\u4e14\u8bf7\u6c42\u5c06\u88ab\u8def\u7531\u5230\u8be5\u8def\u7531\u4e2d\u5b9a\u4e49\u7684\u76ee\u7684\u5730\u3002 \u53e6\u4e00\u4e2a\u4f8b\u5b50\u662f\u4f7f\u7528\u6b63\u5219\u5e76\u5728\u5934\u4e0a\u8fdb\u884c\u5339\u914d \u3002 http: - match: - headers: user-agent: regex: '.*Firefox.*' \u4e0a\u8ff0\u5339\u914d\u5c06\u5339\u914d\u4efb\u4f55\u7528\u6237\u4ee3\u7406\u5934\u4e0eRegex\u5339\u914d\u7684\u8bf7\u6c42\u3002 6-1 \u91cd\u5b9a\u5411\u548c\u91cd\u5199\u8bf7\u6c42 \u5728\u5934\u4fe1\u606f\u548c\u5176\u4ed6\u8bf7\u6c42\u5c5e\u6027\u4e0a\u8fdb\u884c\u5339\u914d\u662f\u6709\u7528\u7684\uff0c\u4f46\u6709\u65f6\u6211\u4eec\u53ef\u80fd\u9700\u8981\u901a\u8fc7\u8bf7\u6c42URI\u4e2d\u7684\u503c\u6765\u5339\u914d\u8bf7\u6c42\u3002 \u4f8b\u5982\uff0c\u8ba9\u6211\u4eec\u8003\u8651\u8fd9\u6837\u4e00\u79cd\u60c5\u51b5\uff1a\u4f20\u5165\u7684\u8bf7\u6c42\u4f7f\u7528 /v1/api \u8def\u5f84\uff0c\u800c\u6211\u4eec\u60f3\u628a\u8bf7\u6c42\u8def\u7531\u5230 /v2/api \u7acb\u6e4d\u70b9\u3002 \u8fd9\u6837\u505a\u7684\u65b9\u6cd5\u662f\u91cd\u5199\u6240\u6709\u4f20\u5165\u7684\u8bf7\u6c42\u548c\u4e0e /v1/api \u5339\u914d\u7684 authority/host headers \u5230 /v2/api \u3002 \u4f8b\u5982\uff1a ... http: - match: - headers: my-header: exact: hello redirect: uri: /hello authority: my-service.default.svc.cluster.local:8000 ... redirect \u548c destination \u5b57\u6bb5\u662f\u76f8\u4e92\u6392\u65a5\u7684\u3002\u5982\u679c\u6211\u4eec\u4f7f\u7528redirect\uff0c\u5c31\u4e0d\u9700\u8981\u8bbe\u7f6e destination \u3002 6-2 AND \u548c OR\u8bed\u4e49 \u5728\u8fdb\u884c\u5339\u914d\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528AND\u548cOR\u4e24\u79cd\u8bed\u4e49\u3002\u8ba9\u6211\u4eec\u770b\u4e00\u4e0b\u4e0b\u9762\u7684\u7247\u6bb5\uff1a AND ... http: - match: - uri: prefix: /v1 headers: my-header: exact: hello ... \u4e0a\u9762\u7684\u7247\u6bb5\u4f7f\u7528\u7684\u662fAND\u8bed\u4e49\u3002\u8fd9\u610f\u6627\u7740URI\u524d\u7f00\u9700\u8981\u4e0e /v1 \u76f8\u5339\u914d\uff0c\u5e76\u4e14\u5934\u4fe1\u606f my-header \u6709\u4e00\u4e2a\u786e\u5207\u7684\u503chello OR \u8981\u4f7f\u7528OR\u8bed\u4e49\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u53e6\u4e00\u4e2a match \u9879\uff0c\u50cf\u8fd9\u6837\uff1a ... http: - match: - uri: prefix: /v1 ... - match: - headers: my-header: exact: hello ... \u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5c06\u9996\u5148\u5bf9URI\u524d\u7f00\u8fdb\u884c\u5339\u914d\uff0c\u5982\u679c\u5339\u914d\uff0c\u8bf7\u6c42\u5c06\u88ab\u8def\u7531\u5230\u76ee\u7684\u5730\u3002 \u5982\u679c\u7b2c\u4e00 \u4e2a\u4e0d\u5339\u914d\uff0c\u7b97\u6cd5\u4f1a\u8f6c\u79fb\u5230\u7b2c\u4e8c\u4e2a\uff0c\u5e76\u5c1d\u8bd5\u5339\u914d\u5934\u3002 \u5982\u679c\u6211\u4eec\u7701\u7565\u8def\u7531\u4e0a\u7684\u5339\u914d\u5b57\u6bb5, \u5b83\u5c06\u603b\u662f\u8bc4\u4f30\u4e3atrue 7\u3001ServiceEntry \u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206 \u3002 \u5f53\u4e00\u4e2a\u670d\u52a1\u5728\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u65f6\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u6d41\u91cf\u8def\u7531\u3001\u6545\u969c\u6ce8\u5165\u548c\u5176\u4ed6\u7f51\u683c\u529f\u80fd\uff0c\u5c31\u50cf\u6211\u4eec\u5bf9\u5176\u4ed6\u670d\u52a1\u4e00\u6837\u3002 7-1 ServiceEntry Resource Add entries to Istio's service registry Use traffic routing, failure injection, and other features against external services \u4e0b\u9762\u662f\u4e00\u4e2a ServiceEntry \u8d44\u6e90\u7684\u4f8b\u5b50\uff0c\u5b83\u58f0\u660e\u4e86\u4e00\u4e2a\u53ef\u4ee5\u901a\u8fc7HTTPS\u8bbf\u95ee\u7684\u5916\u90e8API ( api.external-svc.com )\u3002 apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: external-svc spec: hosts: - api.external-svc.com ports: - number: 443 name: https protocol: TLS resolution: DNS location: MESH_EXTERNAL hosts \u5b57\u6bb5\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u5916\u90e8API\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cEnvoy sidecar\u4f1a\u6839\u636e\u4e0b\u9762\u7684\u5c42\u6b21\u7ed3\u6784\u6765\u8fdb\u884c\u68c0\u67e5\u3002\u5982\u679c\u4efb\u4f55\u4e00\u9879\u4e0d\u80fd\u88ab\u68c0\u67e5\uff0cEnvoy\u5c31\u4f1a\u8f6c\u5230\u5c42\u6b21\u7ed3\u6784\u4e2d\u7684\u4e0b\u4e00\u9879\u3002 HTTP Authority\u5934\uff08\u5728HTTP/2\u4e2d\uff09\u548cHost\u5934\uff08HTTP/1.1\u4e2d\uff09 SNI IP\u5730\u5740\u548c\u7aef\u53e3 \u5982\u679c\u4e0a\u8ff0\u6570\u503c\u90fd\u65e0\u6cd5\u68c0\u67e5\uff0cEnvoy\u4f1a\u6839\u636eIstio\u7684\u5b89\u88c5\u914d\u7f6e\uff0c\u76f2\u76ee\u5730\u8f6c\u53d1\u8bf7\u6c42\u6216\u653e\u5f03\u8be5\u8bf7\u6c42\u3002 7-2 WorkloadEntry Handle migration of VM workloads to Kubernetes Specify VM workloads and make them part of Istio's service registry \u4e0eWorkloadEntry\u8d44\u6e90\u4e00\u8d77\uff0c \u6211\u4eec\u53ef\u4ee5\u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5411Kubernetes\u8fc1\u79fb\u7684\u95ee\u9898 \u3002 \u5728Workload Entry\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ec6\u8282\uff08\u540d\u79f0\u3001\u5730\u5740\u3001\u6807\u7b7e\uff09\uff0c\u7136\u540e\u4f7f\u7528ServiceEntry\u4e2d\u7684 workloadSelector \u5b57\u6bb5\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3a Istio \u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206\u3002 \u4f8b\u5982\uff0c\u5047\u8bbecustomers\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6b63\u5728\u4e24\u4e2a\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u3002\u6b64\u5916\uff0c\u6211\u4eec\u5df2\u7ecf\u6709\u5728Kuternetes\u4e2d\u8fd0\u884c\u7684Pod\uff0c\u5176\u6807\u7b7e\u4e3a app: customers \u8ba9\u6211\u4eec\u8fd9\u6837\u6765\u5b9a\u4e49WorkloadEntry\u8d44\u6e90\uff1a apiVersion: networking.istio.io/v1alpha3 kind: WorkloadEntry metadata: name: customers-vm-1 spec: serviceAccount: customers address: 1.0.0.0 labels: app: customers instance-id: vm1 --- apiVersion: networking.istio.io/v1alpha3 kind: WorkloadEntry metadata: name: customers-vm-2 spec: serviceAccount: customers address: 2.0.0.0 labels: app: customers instance-id: vm2 \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a ServiceEntry \u8d44\u6e90\uff0c\u8be5\u8d44\u6e90\u540c\u65f6\u8de8\u8d8aKubernetes\u4e2d\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u548c\u865a\u62df\u673a\uff1a apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: customers-svc spec: hosts: - customers.com location: MESH_INTERNAL ports: - number: 80 name: http protocol: HTTP resolution: STATIC workloadSelector: labels: app: customers \u5728location\u5b57\u6bb5\u4e2d\u8bbe\u7f6e MESH_INTERNAL \uff0c\u8fd9\u662f\u8bf4\u8fd9\u4e2a\u670d\u52a1\u662f\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002\u8fd9\u4e2a\u503c\u901a\u5e38\u7528\u4e8e\u5305\u62ec\u672a\u7ba1\u7406\u7684\u57fa\u7840\u8bbe\u65bd\uff08VM\uff09\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u60c5\u51b5\u3002 \u8fd9\u4e2a\u5b57\u6bb5\u7684\u53e6\u4e00\u4e2a\u503c\uff0c MESH_EXTERNAL \uff0c\u7528\u4e8e\u901a\u8fc7API\u6d88\u8d39\u7684\u5916\u90e8\u670d\u52a1\u3002 MESH_EXTERNAL \u548c MESH_EXTERNAL \u8bbe\u7f6e\u63a7\u5236\u4e86\u7f51\u683c\u4e2d\u7684sidecar\u5982\u4f55\u5c1d\u8bd5\u4e0e\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u901a\u4fe1\uff0c\u5305\u62ec\u5b83\u4eec\u662f\u5426\u4f1a\u9ed8\u8ba4\u4f7f\u7528Istio\u53cc\u5411TLS\u3002 8\u3001Sidecar \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c \u6ce8\u5165\u7684sidecar\u4ee3\u7406\u63a5\u6536\u6240\u6709\u7aef\u53e3\u7684\u6d41\u91cf\uff0c\u5e76\u4e14\u5728\u8f6c\u53d1\u6d41\u91cf\u65f6\u53ef\u4ee5\u5230\u8fbe\u7f51\u683c\u4e2d\u7684\u4efb\u4f55\u670d\u52a1 \u3002 \u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u80fd\u60f3\u6539\u53d8\u8fd9\u79cd\u914d\u7f6e\uff0c\u914d\u7f6e\u4ee3\u7406\uff0c\u6240\u4ee5\u5b83\u53ea\u80fd\u4f7f\u7528\u7279\u5b9a\u7684\u7aef\u53e3\u548c\u8bbf\u95ee\u67d0\u4e9b\u670d\u8d44\u6e90\u3002 \u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u4f60\u53ef\u4ee5\u5728Istio\u4e2d\u4f7f\u7528Sidecar\u8d44\u6e90 Sidecar\u8d44\u6e90\u53ef\u4ee5\u88ab\u90e8\u7f72\u5230Kubernetes\u96c6\u7fa4\u5185\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u4f46\u5982\u679c\u6ca1\u6709\u5b9a\u4e49\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\uff0c\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u53ea\u80fd\u6709\u4e00\u4e2asidecar\u8d44\u6e90\u3002 Sidecar\u8d44\u6e90\u7531\u4e09\u90e8\u5206\u7ec4\u6210\uff0c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u3001\u4e00\u4e2a\u5165\u53e3\uff08ingress)\u76d1\u542c\u5668\u548c\u4e00\u4e2a\u51fa\u53e3 (egress)\u76d1\u542c\u5668\u3002 Sidecar Resource Proxies accept traffic on all ports Configure Sidecar to specific ports/services Three parts: Workload selector Ingress listener Egress listener 8-1 \u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668 \u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u51b3\u5b9a\u4e86\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u4f1a\u53d7\u5230sidecar\u914d\u7f6e\u7684\u5f71\u54cd \u3002 \u4f60\u53ef\u4ee5\u51b3\u5b9a\u63a7\u5236\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709sidecar\uff0c\u800c\u4e0d\u8003\u8651\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6216\u8005\u63d0\u4f9b\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\uff0c\u5c06\u914d\u7f6e\u53ea\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 \u4f8b\u5982\uff0c\u8fd9\u4e2aYAML\u9002\u7528\u4e8e\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u5185\u7684\u6240\u6709\u4ee3\u7406\uff0c\u56e0\u4e3a\u6ca1\u6709\u5b9a\u4e49\u9009\u62e9\u5668\u3002 apiVersion: networking.istio.io/v1alpha3 kind: Sidecar metadata: name: default-sidecar namespace: default spec: egress: - hosts: - \"default/*\" - \"istio-system/*\" - \"staging/*\" \u5728egress\u90e8\u5206\uff0c\u6211\u4eec\u6307\u5b9a\u4ee3\u7406\u53ef\u4ee5\u8bbf\u95ee\u8fd0\u884c\u5728 default \u3001 istio-system \u548c Staging \u547d\u540d\u7a7a\u95f4\u7684\u670d\u52a1\u3002 \u8981\u5c06\u8d44\u6e90\u4ec5\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 workloadSelector \u5b57\u6bb5\u3002 \u4f8b\u5982\uff0c\u5c06\u9009\u62e9\u5668\u8bbe\u7f6e\u4e3a version:v1 \u5c06\u53ea\u9002\u7528\u4e8e\u6709\u8be5\u6807\u7b7e\u8bbe\u7f6e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 apiVersion: networking.istio.io/v1alpha3 kind: Sidecar metadata: name: default-sidecar namespace: default spec: workloadSelector: labels: version: v1 egress: - hosts: - \"default/*\" - \"istio-system/*\" - \"staging/*\" 8-2 \u5165\u53e3\u548c\u51fa\u53e3\u76d1\u542c\u5668 \u8d44\u6e90\u7684\u5165\u53e3\uff08ingress)\u76d1\u542c\u5668\u90e8\u5206\u5b9a\u4e49\u4e86\u54ea\u4e9b\u5165\u7ad9\u6d41\u91cf\u88ab\u63a5\u53d7\u3002\u540c\u6837\u5730\uff0c\u901a\u8fc7\u51fa\u53e3 (egress)\u76d1\u542c\u5668\uff0c\u4f60\u53ef\u4ee5\u5b9a\u4e49\u51fa\u7ad9\u6d41\u91cf\u7684\u5c5e\u6027 \u3002 \u6bcf\u4e2a\u5165\u53e3\u76d1\u542c\u5668\u90fd\u9700\u8981\u4e00\u4e2a\u7aef\u53e3\u8bbe\u7f6e\uff0c\u4ee5\u4fbf\u63a5\u6536\u6d41\u91cf\uff08\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\u76843000)\u548c\u4e00\u4e2a\u9ed8\u8ba4\u7684\u7aef\u70b9 \u3002\u9ed8\u8ba4\u7aef\u70b9\u53ef\u4ee5\u662f\u4e00\u4e2a\u56de\u73afIP\u7aef\u70b9\u6216Unix\u57df\u5957\u63a5\u5b57\u3002\u7aef\u70b9\u914d\u7f6e\u4e86\u6d41\u91cf\u5c06\u88ab\u8f6c\u53d1\u5230\u54ea\u91cc\u3002 ... ingress: - port: number: 3000 protocol: HTTP name: somename defaultEndpoint: 127.0.0.1:8080 ... \u4e0a\u9762\u7684\u7247\u6bb5\u5c06\u5165\u53e3\u76d1\u542c\u5668\u914d\u7f6e\u4e3a\u5728\u7aef\u53e33000\u4e0a\u76d1\u542c\uff0c\u5e76\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u670d\u52a1\u76d1\u542c\u7684\u7aef\u53e38080\u4e0a\u7684\u56de\u73afIP\u3002 \u6b64\u5916\uff0c\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6ebind\u5b57\u6bb5\uff0c\u4ee5\u6307\u5b9a\u4e00\u4e2aIP\u5730\u5740\u6216\u57df\u5957\u63a5\u5b57\uff0c\u6211\u4eec\u5e0c\u671b\u4ee3\u7406\u76d1\u542c\u4f20\u5165\u7684\u6d41\u91cf\u3002\u6700\u540e\uff0c\u5b57\u6bb5 captureMode \u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u5982\u4f55\u4ee5\u53ca\u662f\u5426\u6355\u83b7\u6d41\u91cf\u3002 \u51fa\u53e3\u76d1\u542c\u5668\u6709\u7c7b\u4f3c\u7684\u5b57\u6bb5\uff0c\u4f46\u589e\u52a0\u4e86 hosts \u5b57\u6bb5\u3002\u901a\u8fc7 hosts \u5b57\u6bb5, \u4f60\u53ef\u4ee5\u7528 default \u6216 namespace/dnsName \u7684\u683c\u5f0f\u6307\u5b9a\u670d\u52a1\u4e3b\u673a\u3002\u4f8b\u5982 myservice.default \u6216 default/* \u3002 \u5728 hosts \u5b57\u6bb5\u4e2d\u6307\u5b9a\u7684\u670d\u52a1\u53ef\u4ee5\u662f\u6765\u81ea\u7f51\u683c\u6ce8\u518c\u8868\u7684\u5b9e\u9645\u670d\u52a1\u3001\u5916\u90e8\u670d\u52a1\uff08\u7528 ServiceEntry \u5b9a\u4e49\uff09, \u6216\u865a\u62df\u670d\u52a1\u3002 egress: - port: number: 8080 protocol: HTTP hosts: - \"staging/*\" \u901a\u8fc7\u4e0a\u9762\u7684 YAML\uff0c sidecar \u4ee3\u7406\u4e86\u8fd0\u884c\u5728\u547d\u540d\u7a7a\u95f4\u7684\u670d\u52a1\u7684 8080 \u7aef\u53e3\u7684\u6d41\u91cf \u3002 9\u3001Envoy Filter EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531 Istio Pilot \u751f\u6210\u7684Envoy\u914d\u7f6e\u3002 \u4f7f\u7528\u8be5\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u66f4\u65b0\u6570\u503c\uff0c\u6dfb\u52a0\u7279\u5b9a\u7684\u8fc7\u6ee4\u5668\uff0c\u751a\u81f3\u6dfb\u52a0\u65b0\u7684\u76d1\u542c\u5668\u3001\u96c6\u7fa4\u7b49\u7b49\u3002\u5c0f\u5fc3\u4f7f\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u56e0\u4e3a\u4e0d\u6b63\u786e\u7684 \u5b9a\u5236\u53ef\u80fd\u4f1a\u7834\u574f\u6574\u4e2a\u7f51\u683c\u7684\u7a33\u5b9a\u6027\u3002 \u8fc7\u6ee4\u5668\u662f\u53e0\u52a0\u5e94\u7528\u7684\uff0c\u8fd9\u610f\u6627\u7740\u5bf9\u4e8e\u7279\u5b9a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u7279\u5b9a\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u53ef\u4ee5\u6709\u4efb\u4f55\u6570\u91cf\u7684\u8fc7\u6ee4\u5668\u3002 \u6839\u547d\u540d\u7a7a\u95f4\uff08\u4f8b\u5982 istio-system )\u4e2d\u7684\u8fc7\u6ee4\u5668\u9996\u5148\u88ab\u5e94\u7528\uff0c\u7136\u540e\u662f\u5de5\u4f5c\u8d1f\u8f7d\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u5339\u914d\u8fc7\u6ee4\u5668\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a EnvoyFilter \u7684\u4f8b\u5b50\uff0c\u5b83\u5728\u8bf7\u6c42\u4e2d\u6dfb\u52a0\u4e86\u4e00\u4e2a\u540d\u4e3a api-version \u7684\u5934\u3002 apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata: name: api-header-filter namespace: default spec: workloadSelector: labels: app: web-frontend configPatches: - applyTo: HTTP_FILTER match: context: SIDECAR_INBOUND listener: portNumber: 8080 filterChain: filter: name: \"envoy.http_connection_manager\" subFilter: name: \"envoy.router\" patch: operation: INSERT_BEFORE value: name: envoy.lua typed_config: \"@type\": \"type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua\" inlineCode: | function envoy_on_response(response_handle) response_handle:headers():add(\"api-version\", \"v1\") end \u5982\u679c\u4f60\u5411 \uff04GATEWAY_URL \u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f60\u53ef\u4ee5\u6ce8\u610f\u5230 api-version \u5934\u88ab\u6dfb\u52a0\u4e86\uff0c\u5982\u4e0b\u6240 $ curl -s -I -X HEAD http://$GATEWAY_URL HTTP/1.1 200 OK x-powered-by: Express content-type: text/html; charset=utf-8 content-length: 2471 etag: W/\"9a7-hEXE7lJW5CDgD+e2FypGgChcgho\" date: Tue, 17 Nov 2020 00:40:16 GMT x-envoy-upstream-service-time: 32 api-version: v1 server: istio-envoy","title":"\u7b2c\u56db\u8282 \u6d41\u91cf\u7ba1\u7406"},{"location":"chap8/4Istio_net_control/#_1","text":"","title":"\u7b2c\u56db\u8282 \u6d41\u91cf\u7ba1\u7406"},{"location":"chap8/4Istio_net_control/#0traffic-management","text":"Traffic routing Service resiliency and failure injection Envoy filters Labs: Exposing services using Gateway resource Observing failure injection and delays Simple traffic routing Advanced traffic routing Quiz","title":"0\u3001Traffic Management"},{"location":"chap8/4Istio_net_control/#1gateway","text":"\u4f5c\u4e3a Istio \u5b89\u88c5\u7684\u4e00\u90e8\u5206\uff0c\u6211\u4eec\u5b89\u88c5\u4e86Istio\u7684\u5165\u53e3\u548c\u51fa\u53e3\u7f51\u5173\u3002 \u8fd9\u4e24\u4e2a\u7f51\u5173\u90fd\u8fd0\u884c\u4e00\u4e2aEnvoy\u4ee3\u7406\u5b9e\u4f8b\uff0c\u5b83\u4eec\u5728\u7f51\u683c\u7684\u8fb9\u7f18\u4f5c\u4e3a\u8d1f\u8f7d\u5747\u8861\u5668\u8fd0\u884c\u3002\u5165\u53e3\u7f51\u5173\u63a5\u6536\u5165\u7ad9\u8fde\u63a5\uff0c\u800c\u51fa\u53e3\u7f51\u5173\u63a5\u6536 \u4ece\u96c6\u7fa4\u51fa\u53bb\u7684\u8fde\u63a5\u3002 \u4f7f\u7528\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u8fdb\u5165\u96c6\u7fa4\u7684\u6d41\u91cf\u5e94\u7528\u8def\u7531\u89c4\u5219\u3002\u6211\u4eec\u53ef\u4ee5\u6709\u4e00\u4e2a\u6307\u5411\u5165\u53e3\u7f51\u5173\u7684\u5355\u4e00\u5916\u90e8IP\u5730\u5740\uff0c\u5e76\u6839\u636e\u4e3b\u673a\u5934\u5c06\u6d41\u91cf\u8def\u7531\u5230\u96c6\u7fa4\u5185\u7684\u4e0d\u540c\u670d\u52a1 \u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528Gateway\u8d44\u6e90\u6765\u914d\u7f6e\u7f51\u5173\u3002\u7f51\u5173\u8d44\u6e90\u63cf\u8ff0\u4e86\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u66b4\u9732\u7aef\u53e3\u3001\u534f\u8bae\u3001SNI \uff08\u670d\u52a1\u5668\u540d\u79f0\u6307\u793a\uff09\u914d\u7f6e\u7b49\u3002 \u7f51\u5173\u8d44\u6e90\u5728\u80cc\u540e\u63a7\u5236\u7740Envoy\u4ee3\u7406\u5728\u7f51\u7edc\u63a5\u53e3\u4e0a\u7684\u76d1\u542c\u65b9\u5f0f\u4ee5\u53ca\u5b83\u51fa\u793a\u7684\u8bc1\u4e66\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u7f51\u5173\u8d44\u6e90\u7684\u4f8b\u5b50\uff1a apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: my-gateway namespace: default spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - dev.example.com - test.example.com \u4e0a\u8ff0\u7f51\u5173\u8d44\u6e90\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u4ee3\u7406\uff0c \u4f5c\u4e3a\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668 \uff0c\u4e3a\u5165\u53e3\u66b4\u973280\u7aef\u53e3\u3002 \u7f51\u5173\u914d\u7f6e\u88ab\u5e94\u7528\u4e8e Istio \u5165\u53e3\u7f51\u5173\u4ee3\u7406\uff0c\u6211\u4eec\u5c06\u5176\u90e8\u7f72\u5230 istio-system \u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u8bbe\u7f6e\u4e86\u6807\u7b7e istio:ingressgateway \u3002 \u901a\u8fc7\u7f51\u5173\u8d44\u6e90\uff0c\u6211\u4eec\u53ea\u80fd\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\u3002 hosts \u5b57\u6bb5\u4f5c\u4e3a\u4e00\u4e2a\u8fc7\u6ee4\u5668\uff0c\u53ea\u6709\u4ee5 dev.example.com \u548c test.example.com \u4e3a\u76ee\u7684\u5730\u7684\u6d41\u91cf\u4f1a\u88ab\u5141\u8bb8\u901a\u8fc7\u3002 \u4e3a\u4e86\u63a7\u5236\u548c\u8f6c\u53d1\u6d41\u91cf\u5230\u96c6\u7fa4\u5185\u8fd0\u884c\u7684\u5b9e\u9645 Kubernetes \u670d\u52a1\uff0c\u6211\u4eec\u5fc5\u987b\u7528\u7279\u5b9a\u7684\u4e3b\u673a\u540d\uff08\u4f8b\u5982 dev.example.com \u548c test.example.com \uff09\u914d\u7f6e\u4e00\u4e2a VirtualService \uff0c\u7136\u540e\u5c06\u7f51\u5173\u8fde\u63a5\u5230 \u5b83\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u4f5c\u4e3aIstio\u5b89\u88c5demo\u7684\u4e00\u90e8\u5206\u800c\u90e8\u7f72\u7684Ingress\u7f51\u5173\u521b\u5efa\u4e86\u4e00\u4e2a\u5177\u6709 Load Balancer\u7c7b\u578b\u7684Kubernetes\u670d\u52a1\uff0c\u5e76\u4e3a\u5176\u5206\u914d\u4e86\u4e00\u4e2a\u5916\u90e8IP: $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.106.113.25 <none> 3000/TCP 23h istio-egressgateway ClusterIP 10.104.176.79 <none> 80/TCP,443/TCP 3d3h istio-ingressgateway LoadBalancer 10.105.159.70 localhost 15021:31875/TCP,80:32344/TCP,443:31252/TCP,31400:31315/TCP,15443:31199/TCP 3d3h istiod ClusterIP 10.96.216.110 <none> 15010/TCP,15012/TCP,443/TCP,15014/TCP 3d3h LoadBalancer Kubernetes\u670d\u52a1\u7c7b\u578b\u7684\u5de5\u4f5c\u65b9\u5f0f\u53d6\u51b3\u4e8e\u6211\u4eec\u8fd0\u884cKubernetes\u96c6\u7fa4\u7684\u65b9\u5f0f\u548c\u5730\u70b9\u3002\u5bf9\u4e8e\u4e91\u6258\u7ba1\u7684\u96c6\u7fa4\uff08GCPS. AWS\u3001 Azure\u7b49\uff09\uff0c\u5728\u4f60\u7684\u4e91\u8d26\u6237\u4e2d\u914d\u7f6e\u4e86\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u8d44\u6e90\uff0cKubernetes LoadBalancer\u670d\u52a1\u5c06\u83b7\u5f97\u4e00\u4e2a\u5206\u914d\u7ed9\u5b83\u7684\u5916\u90e8IP\u5730\u5740\u3002\u5047\u8bbe\u6211\u4eec\u6b63\u5728\u4f7f\u7528Minikube\u6216DockerDesktop\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5916\u90e8IP\u5730\u5740\u5c06\u88ab\u8bbe\u7f6e\u4e3alocalhost (Docker Desktop)\uff0c\u6216\u8005\uff0c\u5982\u679c\u6211\u4eec\u4f7f\u7528Minikube\uff0c\u5b83\u5c06\u4fdd\u6301\u5f85\u5b9a\uff0c\u6211\u4eec\u5c06\u4e0d\u5f97\u4e0d\u4f7f\u7528minikube tunnel\u547d\u4ee4\u6765\u83b7\u5f97\u4e00\u4e2aIP\u5730\u5740\u3002 \u9664\u4e86\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u90e8\u7f72\u4e00\u4e2a\u51fa\u53e3\u7f51\u5173\u6765\u63a7\u5236\u548c\u8fc7\u6ee4\u79bb\u5f00\u7f51\u683c\u7684\u6d41\u91cf\u3002 \u5c31\u50cf\u6211\u4eec\u914d\u7f6e\u5165\u53e3\u7f51\u5173\u4e00\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u76f8\u540c\u7684\u7f51\u5173\u8d44\u6e90\u6765\u914d\u7f6e\u51fa\u53e3\u7f51\u5173\u3002\u8fd9\u4f7f\u6211\u4eec\u80fd\u591f\u96c6\u4e2d\u7ba1\u7406\u6240\u6709\u6d41\u51fa\u7684\u6d41\u91cf\u3001\u65e5\u5fd7\u548c\u6388\u6743\u3002","title":"1\u3001\u4f7f\u7528Gateway"},{"location":"chap8/4Istio_net_control/#2","text":"\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 VirtualService \u8d44\u6e90\u5728Istio\u670d\u52a1\u7f51\u683c\u4e2d\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002 \u901a\u8fc7 VirtualService , \u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u6d41\u91cf\u8def\u7531\u89c4\u5219\uff0c\u5e76\u5728\u5ba2\u6237\u7aef\u8bd5\u56fe\u8fde\u63a5\u5230\u670d\u52a1\u65f6\u5e94\u7528\u8fd9\u4e9b\u89c4\u5219\u3002\u4f8b\u5982\u5411 dev.example.com \u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff0c\u6700\u7ec8\u5230\u8fbe\u76ee\u6807\u670d\u52a1\u3002 \u8ba9\u6211\u4eec\u770b\u4e00\u4e0b\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c customers \u5e94\u7528\u7a0b\u5e8f\u7684\u4e24\u4e2a\u7248\u672c\uff08v1\u548cv2\uff09\u7684\u4f8b\u5b50\u3002\u6211\u4eec\u6709\u4e24\u4e2a Kubernetes \u90e8\u7f72\uff0c customers-v1 \u548c customers-v2 \u3002 \u5c5e\u4e8e\u8fd9\u4e9b\u90e8\u7f72\u7684Pod\u6709\u4e00\u4e2a\u6807\u7b7e version: v1 \u6216\u4e00\u4e2a\u6807\u7b7e version: v2 \u7684\u8bbe\u7f6e\u3002 \u6211\u4eec\u60f3\u628aVirtualService\u914d\u7f6e\u4e3a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u5e94\u7528\u7a0b\u5e8f\u7684V1\u7248\u672c\u300270\uff05\u7684\u4f20\u5165\u6d41\u91cf\u5e94\u8be5\u88ab\u8def\u7531\u5230V1\u7248\u672c\u300230\uff05\u7684\u8bf7\u6c42\u5e94\u8be5\u88ab\u53d1\u9001\u5230\u5e94\u7528\u7a0b\u5e8f\u7684V2\u7248\u672c\u3002 \u4e0b\u9762\u662f\u4e0a\u8ff0\u60c5\u51b5\u4e0b VirtualService \u8d44\u6e90\u7684\u6837\u5b50\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers-route spec: hosts: - customers.default.svc.cluster.local http: - name: customers-v1-routes route: - destination: host: customers.default.svc.cluster.local subset: v1 weight: 70 - name: customers-v2-routes route: - destination: host: customers.default.svc.cluster.local subset: v2 weight: 30 \u5728 hosts \u5b57\u6bb5\u4e0b\uff0c\u6211\u4eec\u8981\u5b9a\u4e49\u6d41\u91cf\u88ab\u53d1\u9001\u5230\u7684\u76ee\u6807\u4e3b\u673a\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u8fd9\u5c31\u662f customers.default.svc.cluster.local Kubernetes\u670d\u52a1\u3002 \u4e0b\u4e00\u4e2a\u5b57\u6bb5\u662fhttp\uff0c\u8fd9\u4e2a\u5b57\u6bb5\u5305\u542b\u4e00\u4e2aHTTP\u6d41\u91cf\u7684\u8def\u7531\u89c4\u5219\u7684\u6709\u5e8f\u5217\u8868\u3002 destination \u662f\u6307\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u7684\u4e00\u4e2a\u670d\u52a1\uff0c\u4e5f\u662f\u8def\u7531\u89c4\u5219\u5904\u7406\u540e\u8bf7\u6c42\u5c06\u88ab\u53d1\u9001\u5230\u7684\u76ee\u7684\u5730 Istio \u7684\u670d\u52a1\u6ce8\u518c\u8868\u5305\u542b\u6240\u6709\u7684Kubernetes\u670d\u52a1\uff0c\u4ee5\u53ca\u4efb\u4f55\u7528 ServiceEntry \u8d44\u6e90\u58f0\u660e\u7684\u670d\u52a1\u3002 \u6211\u4eec\u4e5f\u5728\u8bbe\u7f6e\u6bcf\u4e2a\u76ee\u7684\u5730\u7684\u6743\u91cd\uff08weight)\u3002\u6743\u91cd\u7b49\u4e8e\u53d1\u9001\u5230\u6bcf\u4e2a\u5b50\u96c6\u7684\u6d41\u91cf\u7684\u6bd4\u4f8b\u3002\u6240\u6709\u6743\u91cd\u7684\u603b\u548c\u5e94\u8be5\u662f100\u3002\u5982\u679c\u6211\u4eec\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u76ee\u7684\u5730\uff0c\u6743\u91cd\u88ab\u5047\u5b9a\u4e3a100\u3002 \u901a\u8fc7 gateways \u5b57\u6bb5\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6307\u5b9a\u6211\u4eec\u60f3\u8981\u7ed1\u5b9a\u8fd9\u4e2a VirtualService \u7684\u7f51\u5173\u540d\u79f0 \u3002\u6bd4\u5982 \u8bf4\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers-route spec: hosts: - customers.default.svc.cluster.local gateways: - my-gateway http: ... \u4e0a\u9762\u7684YAML\u5c06 customers-route VirtualService\u7ed1\u5b9a\u5230\u540d\u4e3a my-gateway \u7684\u7f51\u5173\u4e0a\u3002\u8fd9 \u6709\u6548\u5730\u66b4\u9732\u4e86\u901a\u8fc7\u7f51\u5173\u7684\u76ee\u6807\u8def\u7531\u3002 \u5f53\u4e00\u4e2a VirtualService \u88ab\u9644\u52a0\u5230\u4e00\u4e2a\u7f51\u5173\u4e0a\u65f6, \u53ea\u5141\u8bb8\u5728\u7f51\u5173\u8d44\u6e90\u4e2d\u5b9a\u4e49\u7684\u4e3b\u673a\u3002 \u4e0b\u8868\u89e3\u91ca\u4e86\u7f51\u5173\u8d44\u6e90\u4e2d\u7684 hosts \u5b57\u6bb5\u5982\u4f55\u4f5c\u4e3a\u8fc7\u6ee4\u5668\uff0c VirtualService \u4e2d\u7684hosts\u5b57\u6bb5\u5982\u4f55\u4f5c\u4e3a\u5339\u914d","title":"2\u3001\u7b80\u5355\u8def\u7531"},{"location":"chap8/4Istio_net_control/#3subsetdestination-rule","text":"\u76ee\u7684\u5730\u6307\u7684\u662f\u4e0d\u540c\u7684\u5b50\u96c6\uff08subset\uff09\u6216\u670d\u52a1\u7248\u672c\u3002\u901a\u8fc7\u5b50\u96c6\uff0c\u6211\u4eec\u53ef\u4ee5\u8bc6\u522b\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u53d8\u4f53\u3002 \u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u6709\u4e24\u4e2a\u5b50\u96c6\uff0cv1\u548cv2\uff0c\u5b83\u4eec\u5bf9\u5e94\u4e8e\u6211\u4eeccustomer\u670d\u52a1\u7684\u4e24\u4e2a\u4e0d\u540c\u7248\u672c\u3002\u6bcf\u4e2a\u5b50\u96c6\u90fd\u4f7f\u7528\u952e\uff0f\u503c\u5bf9\uff08\u6807\u7b7e\uff09\u7684\u7ec4\u5408\u6765\u786e\u5b9a\u54ea\u4e9bPod\u8981\u5305\u542b\u5728\u5b50\u96c6\u4e2d\u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u540d\u4e3a DestinationRule \u7684\u8d44\u6e90\u7c7b\u578b\u4e2d\u58f0\u660e\u5b50\u96c6\u3002 \u4e0b\u9762\u662f\u5b9a\u4e49\u4e86\u4e24\u4e2a\u5b50\u96c6\u7684DestinationRule\u8d44\u6e90\u7684\u6837\u5b50\u3002 apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers-destination spec: host: customers.default.svc.cluster.local subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 \u8ba9\u6211\u4eec\u770b\u770b\u6211\u4eec\u53ef\u4ee5\u5728DestinationRule\u4e2d\u8bbe\u7f6e\u7684\u6d41\u91cf\u7b56\u7565\u3002","title":"3\u3001Subset\u548cDestination Rule"},{"location":"chap8/4Istio_net_control/#3-1-destination-rule","text":"\u901a\u8fc7 DestinationRule \uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u8bbe\u7f6e\uff0c\u5982\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u3001\u8fde\u63a5\u6c60\u5927\u5c0f\u3001\u5c40\u90e8\u5f02\u5e38\u68c0\u6d4b\u7b49\uff0c\u5728\u8def\u7531\u53d1\u751f\u540e\u5e94\u7528\u4e8e\u6d41\u91cf\u3002\u6211\u4eec\u53ef\u4ee5\u5728trafficPolicy\u5b57\u6bb5\u4e0b\u8bbe\u7f6e\u6d41\u91cf\u7b56\u7565\u8bbe\u7f6e\u3002 \u4ee5\u4e0b\u662f\u8fd9\u4e9b\u8bbe\u7f6e\uff1a \u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e \u8fde\u63a5\u6c60\u8bbe\u7f6e \u5c40\u90e8\u5f02\u5e38\u70b9\u68c0\u6d4b \u5ba2\u6237\u7aefTLS\u8bbe\u7f6e \u7aef\u53e3\u6d41\u91cf\u7b56\u7565 Traffic Policies Load balancer settings Connection pool settings Outlier detection Client TLS settings Port traffic policy \u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e \u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u76ee\u7684\u5730\u4f7f\u7528\u54ea\u79cd\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u5e26\u6709\u6d41\u91cf\u7b56\u7565\u7684DestinationRule\u7684\u4f8b\u5b50\uff0c\u5b83\u628a\u76ee\u7684\u5730\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u8bbe\u7f6e\u4e3a round-robin apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers-destination spec: host: customers.default.svc.cluster.local trafficPolicy: loadBalancer: simple: ROUND_ROBIN subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 \u6211\u4eec\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u57fa\u4e8e\u54c8\u5e0c\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u5e76\u6839\u636eHTTP\u5934\u3001cookies\u6216\u5176\u4ed6\u8bf7\u6c42\u5c5e\u6027\u63d0\u4f9b\u4f1a\u8bdd\u4eb2\u548c\u6027\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u6d41\u91cf\u7b56\u7565\u7684\u7247\u6bb5\uff0c\u5b83\u8bbe\u7f6e\u4e86\u57fa\u4e8e\u54c8\u5e0c\u7684\u8d1f\u8f7d\u5747\u8861 \uff0c\u5e76\u4f7f\u7528\u4e00\u4e2a\u53eb\u505a location \u7684 cookie \u6765\u5b9e\u73b0\u4eb2\u548c\u529b\u3002 trafficPolicy: loadBalancer: consistentHash: httpCookie: name: location ttl: 4s","title":"3-1 Destination Rule\u4e2d\u7684\u6d41\u91cf\u7b56\u7565"},{"location":"chap8/4Istio_net_control/#3-2","text":"\u8fd9\u4e9b\u8bbe\u7f6e\u53ef\u4ee5\u5728TCP\u548cHTTP\u5c42\u9762\u5e94\u7528\u4e8e\u4e0a\u6e38\u670d\u52a1\u7684\u6bcf\u4e2a\u4e3b\u673a, \u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u4eec\u6765\u63a7\u5236\u94fe\u63a5\u91cf \u4e0b\u9762\u662f\u4e00\u4e2a\u7247\u6bb5\uff0c\u663e\u793a\u4e86\u6211\u4eec\u5982\u4f55\u8bbe\u7f6e\u5bf9\u670d\u52a1\u7684\u5e76\u53d1\u8bf7\u6c42\u7684\u9650\u5236\u3002 spec: host: myredissrv.prod.svc.cluster.local trafficPolicy: connectionPool: http: http2MaxRequests: 50","title":"3-2 \u8fde\u63a5\u6c60\u914d\u7f6e"},{"location":"chap8/4Istio_net_control/#3-3","text":"\u5f02\u5e38\u70b9\u68c0\u6d4b\u662f\u4e00\u4e2a\u65ad\u8def\u5668\u7684\u5b9e\u73b0\uff0c\u5b83\u8ddf\u8e2a\u4e0a\u6e38\u670d\u52a1\u4e2d\u6bcf\u4e2a\u4e3b\u673a\uff08Pod)\u7684\u72b6\u6001\u3002 \u5982\u679c\u4e00\u4e2a\u4e3b\u673a\u5f00\u59cb\u8fd4\u56de5xx HTTP\u9519\u8bef\uff0c\u5b83\u5c31\u4f1a\u5728\u9884\u5b9a\u7684\u65f6\u95f4\u5185\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\u3002\u5bf9\u4e8eTCP\u670d\u52a1\uff0cEnvoy\u5c06\u8fde\u63a5\u8d85\u65f6\u6216\u5931\u8d25\u8ba1\u7b97\u4e3a\u9519\u8bef \u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5b83\u8bbe\u7f6e\u4e86500\u4e2a\u5e76\u53d1\u7684HTTP2\u8bf7\u6c42\uff08 http2MaxRequests \uff09\u7684\u9650\u5236\uff0c\u6bcf\u4e2a\u8fde\u63a5\u4e0d\u8d85\u8fc710\u4e2a\u8bf7\u6c42\uff08 maxRequestsPerConnection )\u5230\u8be5\u670d\u52a1\u3002 \u6bcf5\u5206\u949f\u626b\u63cf\u4e00\u6b21\u4e0a\u6e38\u4e3b\u673a\uff08Pod) (interval)\uff0c\u5982\u679c\u5176\u4e2d\u4efb\u4f55\u4e00\u4e2a\u4e3b\u673a\u8fde\u7eed\u5931\u8d2510\u6b21 (contracticalErrors),Envoy\u4f1a\u5c06\u5176\u5f39\u51fa10\u5206\u949f\uff08baseEjectionTime)\u3002","title":"3-3 \u5f02\u5e38\u70b9\u68c0\u6d4b"},{"location":"chap8/4Istio_net_control/#3-4-tls","text":"\u5305\u542b\u4efb\u4f55\u4e0e\u4e0a\u6e38\u670d\u52a1\u8fde\u63a5\u7684\u4e01LS\u76f8\u5173\u8bbe\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u4f7f\u7528\u63d0\u4f9b\u7684\u8bc1\u4e66\u914d\u7f6emTLS\u7684\u4f8b\u5b50\u3002 trafficPolicy: tls: mode: MUTUAL clientCertificate: /etc/certs/cert.pem privateKey: /etc/certs/key.pem caCertificates: /etc/certs/ca.pem \u5176\u4ed6\u652f\u6301\u7684TLS\u6a21\u5f0f\u6709 DISABLE \uff08\u6ca1\u6709TLS\u8fde\u63a5\uff09, SIMPLE\uff08\u5728\u4e0a\u6e38\u7aef\u70b9\u53d1\u8d77TLS\u8fde\u63a5,\uff09 ISTIO_MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09","title":"3-4 \u5ba2\u6237\u7aefTLS\u8bbe\u7f6e"},{"location":"chap8/4Istio_net_control/#3-5","text":"\u4f7f\u7528 portLevelSettings \u5b57\u6bb5\uff0c\u6211 \u4eec\u53ef\u4ee5\u5c06\u6d41\u91cf\u7b56\u7565\u5e94\u7528\u4e8e\u5355\u4e2a\u7aef\u53e3 \u3002\u6bd4\u5982\u8bf4\uff1a trafficPolicy: portLevelSettings: - port: number: 80 loadBalancer: simple: LEAST_CONN - port: number: 8000 loadBalancer: simple: ROUND_ROBIN","title":"3-5 \u7aef\u53e3\u6d41\u91cf\u7b56\u7565"},{"location":"chap8/4Istio_net_control/#4","text":"\u5f39\u6027\uff08Resiliency\uff09\u662f\u6307\u5728\u9762\u5bf9\u6545\u969c\u548c\u5bf9\u6b63\u5e38\u8fd0\u884c\u7684\u6311\u6218\u65f6\uff0c\u63d0\u4f9b\u548c\u4fdd\u6301\u53ef\u63a5\u53d7\u7684\u670d\u52a1\u6c34\u5e73\u7684\u80fd\u529b\u3002 \u8fd9\u4e0d\u662f\u4e3a\u4e86\u907f\u514d\u6545\u969c\uff0c\u800c\u662f\u4ee5\u4e00\u79cd\u6ca1\u6709\u505c\u673a\u6216\u6570\u636e\u4e22\u5931\u7684\u65b9\u5f0f\u6765\u5e94\u5bf9\u6545\u969c\u3002\u5f39\u6027\u7684\u76ee\u6807 \u662f\u5728\u6545\u969c\u53d1\u751f\u540e\u5c06\u670d\u52a1\u6062\u590d\u5230\u4e00\u4e2a\u5b8c\u5168\u6b63\u5e38\u7684\u72b6\u6001 \u3002 Provide and maintain an acceptable level of service in the face of faults and challenges to regular operation . Timeouts Retry policies Configurable on VirtualService Retries Number of retries Timeout per try Conditions to retry on Note: endpoint that caused the retry is not included in the LB pool on the next try. \u4f7f\u670d\u52a1\u53ef\u7528\u7684\u4e00\u4e2a\u5173\u952e\u56e0\u7d20\u662f\u5728\u63d0\u51fa\u670d\u52a1\u8bf7\u6c42\u65f6\u4f7f\u7528\u8d85\u65f6\uff08timeout\uff09\u548c\u91cd\u8bd5\uff08retry\uff09\u7b56\u7565\u3002 \u6211\u4eec\u53ef\u4ee5\u5728 Istio \u7684 VirtualService \u4e0a\u914d\u7f6e\u8fd9\u4e24\u8005\u3002 \u4f7f\u7528\u8d85\u65f6\u5b57\u6bb5\u7684\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u4e3aHTTP\u8bf7\u6c42\u5b9a\u4e49\u4e00\u4e2a\u8d85\u65f6\u3002\u5982\u679c\u8bf7\u6c42\u7684\u65f6\u95f4\u8d85\u8fc7\u4e86\u8d85\u65f6\u5b57\u6bb5\u4e2d\u6307\u5b9a\u7684\u503c\uff0cEnvoy\u4ee3\u7406\u5c06\u653e\u5f03\u8bf7\u6c42\uff0c\u5e76\u5c06\u5176\u6807\u8bb0\u4e3a\u8d85\u65f6\uff08\u5411\u5e94\u7528\u7a0b\u5e8f\u8fd4\u56de\u4e00\u4e2aHTTP 408) \u3002 \u8fde\u63a5\u4fdd\u6301\u5f00\u653e\uff0c\u9664\u975e\u89e6\u53d1\u4e86\u5f02\u5e38\u70b9\u68c0\u6d4b\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u4e3a\u8def\u7531\u8bbe\u7f6e\u8d85\u65f6\u7684\u4f8b\u5b50\uff1a ... - route: - destination: host: customers.default.svc.cluster.local subset: v1 timeout: 10s ... \u9664\u4e86\u8d85\u65f6\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u914d\u7f6e\u66f4\u7ec6\u5316\u7684\u91cd\u8bd5\u7b56\u7565\u3002\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u4e00\u4e2a\u7ed9\u5b9a\u8bf7\u6c42\u7684\u91cd\u8bd5\u6b21\u6570\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u4ee5\u53ca\u6211\u4eec\u60f3\u8981\u91cd\u8bd5\u7684\u5177\u4f53\u6761\u4ef6\u3002 \u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u53ea\u5728\u4e0a\u6e38\u670d\u52a1\u5668\u8fd4\u56de5xx\u54cd\u5e94\u4ee3\u7801\u65f6\u91cd\u8bd5\u8bf7\u6c42\uff0c\u6216\u8005\u53ea\u5728\u7f51\u5173\u9519\u8bef\uff08HTTP 5O2\u3001 503\u6216504\uff09\u65f6\u91cd\u8bd5\uff0c\u6216\u8005\u751a\u81f3\u5728\u8bf7\u6c42\u5934\u4e2d\u6307\u5b9a\u53ef\u91cd\u8bd5\u7684\u72b6\u6001\u4ee3\u7801\u3002 \u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\u3002\u5f53Envoy\u91cd\u8bd5\u4e00\u4e2a\u5931\u8d25\u7684\u8bf7\u6c42\u65f6\uff0c \u6700\u521d\u5931\u8d25\u5e76\u5bfc\u81f4\u91cd\u8bd5\u7684\u7aef\u70b9\u5c31\u4e0d\u518d\u5305\u542b\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u4e86 \u3002\u5047\u8bbeKubernetes\u670d\u52a1\u67093\u4e2a\u7aef\u70b9\uff08Pod)\uff0c\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u4e86\uff0c \u5e76\u51fa\u73b0\u4e86\u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u4ee3\u7801\u3002 \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u5b83\u4e0d\u4f1a\u518d\u5411\u539f\u6765\u7684\u7aef\u70b9\u91cd\u65b0\u53d1\u9001\u8bf7\u6c42\u3002\u76f8\u53cd\uff0c\u5b83\u5c06\u628a\u8bf7\u6c42\u53d1 \u9001\u5230\u4e24\u4e2a\u6ca1\u6709\u5931\u8d25\u7684\u7aef\u70b9\u4e2d\u7684\u4e00\u4e2a\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff0c\u8bf4\u660e\u5982\u4f55\u4e3a\u4e00\u4e2a\u7279\u5b9a\u7684\u76ee\u7684\u5730\u8bbe\u7f6e\u91cd\u8bd5\u7b56\u7565\u3002 ... - route: - destination: host: customers.default.svc.cluster.local subset: v1 retries: attempts: 10 perTryTimeout: 2s retryOn: connect-failure,reset ... \u4e0a\u8ff0\u91cd\u8bd5\u7b56\u7565\u5c06\u5c1d\u8bd5\u91cd\u8bd5\u4efb\u4f55\u8fde\u63a5\u8d85\u65f6\uff08connect-failure)\u6216\u670d\u52a1\u5668\u5b8c\u5168\u4e0d\u54cd\u5e94 (reset)\u7684\u5931\u8d25\u8bf7\u6c42\u3002\u6211\u4eec\u5c06\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a2\u79d2\uff0c\u5c1d\u8bd5\u7684\u6b21\u6570\u8bbe\u7f6e\u4e3a10\u6b21\u3002 \u6ce8\u610f\uff0c\u5982\u679c\u540c\u65f6\u8bbe\u7f6e\u91cd\u8bd5\u548c\u8d85\u65f6\uff0c\u8d85\u65f6\u503c\u5c06\u662f\u8bf7\u6c42\u7b49\u5f85\u7684\u6700\u957f\u65f6\u95f4\u3002\u5982\u679c\u6211\u4eec\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\u6307\u5b9a\u4e8610\u79d2\u7684\u8d85\u65f6\uff0c\u90a3\u4e48\u5373\u4f7f\u91cd\u8bd5\u7b56\u7565\u4e2d\u8fd8\u5269\u4e0b\u4e00\u4e9b\u5c1d\u8bd5\uff0c\u6211\u4eec\u4e5f\u53ea\u80fd\u6700\u591a\u7b49\u5f8510\u79d2 \u3002 \u53c2\u9605 x-envoy-retry","title":"4\u3001\u5f39\u6027"},{"location":"chap8/4Istio_net_control/#5","text":"\u4e3a\u4e86\u5e2e\u52a9\u6211\u4eec\u63d0\u9ad8\u670d\u52a1\u7684\u5f39\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u6545\u969c\u6ce8\u5165\u529f\u80fd\u3002\u6211\u4eec\u53ef\u4ee5\u5728HTTP\u6d41\u91cf\u4e0a\u5e94\u7528\u6545\u969c\u6ce8\u5165\u7b56\u7565\uff0c\u5728\u8f6c\u53d1\u76ee\u7684\u5730\u7684\u8bf7\u6c42\u65f6\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u6545\u969c\u6ce8\u5165\u3002 \u6709\u4e24\u79cd\u7c7b\u578b\u7684\u6545\u969c\u6ce8\u5165\u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u8f6c\u53d1\u524d\u5ef6\u8fdf\uff08delay\uff09\u8bf7\u6c42\uff0c\u6a21\u62df\u7f13\u6162\u7684\u7f51\u7edc\u6216\u8fc7\u8f7d\u7684\u670d\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u4e2d\u6b62\uff08abort) HTTP\u8bf7\u6c42 \uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u7279\u5b9a\u7684HTTP\u9519\u8bef\u4ee3\u7801\u7ed9\u8c03\u7528\u8005\u3002 \u901a\u8fc7\u4e2d\u6b62\uff0c \u6211\u4eec\u53ef\u4ee5\u6a21\u62df\u4e00\u4e2a\u6709\u6545\u969c\u7684\u4e0a\u6e38\u670d\u52a1 \u3002 \u4e0b\u9762\u662f\u4e00\u4e2a\u4e2d\u6b62HTTP\u8bf7\u6c42\u5e76\u8fd4\u56de HTTP 404 \u7684\u4f8b\u5b50\uff0c\u9488\u5bf930\uff05\u7684\u4f20\u5165\u8bf7\u6c42\u3002 - route: - destination: host: customers.default.svc.cluster.local subset: v1 fault: abort: percentage: value: 30 httpStatus: 404 \u5982\u679c\u6211\u4eec\u4e0d\u6307\u5b9a\u767e\u5206\u6bd4\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u4e2d\u6b62 \u3002\u8bf7\u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u4f1a\u5f71\u54cd\u4f7f\u7528\u8be5 VirtualService\u7684\u670d\u52a1\u3002\u5b83\u5e76\u4e0d\u5f71\u54cd\u8be5\u670d\u52a1\u7684\u6240\u6709\u6d88\u8d39\u8005\u3002 \u540c\u6837\u5730\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 fixedDelay \u5b57\u6bb5\u5bf9\u8bf7\u6c42\u5e94\u7528\u4e00\u4e2a\u53ef\u9009\u7684\u5ef6\u8fdf\u3002 - route: - destination: host: customers.default.svc.cluster.local subset: v1 fault: delay: percentage: value: 5 fixedDelay: 3s \u4e0a\u8ff0\u8bbe\u7f6e\u5c06\u5bf9 5\uff05 \u7684\u4f20\u5165\u8bf7\u6c42\u5e94\u75283\u79d2\u7684\u5ef6\u8fdf\u3002 \u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u5c06\u4e0d\u4f1a\u89e6\u53d1\u6211\u4eec\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u6ce8\u5165\u4e86\u4e00\u4e2aHTTP 500\u7684\u9519\u8bef\uff0c\u914d\u7f6e\u4e3aHTTP 500\u4e0a\u7684\u91cd\u8bd5\u7b56\u7565\u5c06\u4e0d\u4f1a\u88ab\u89e6\u53d1\u3002","title":"5\u3001\u6545\u969c\u6ce8\u5165"},{"location":"chap8/4Istio_net_control/#6","text":"\u5728\u524d\u9762\uff0c\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u5229\u7528\u6d41\u91cf\u7684\u6bd4\u4f8b\uff08weight\u5b57\u6bb5\uff09\u5728\u591a\u4e2a\u5b50\u96c6\u4e4b\u95f4\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u7eaf\u7cb9\u7684\u57fa\u4e8e\u6743\u91cd\u7684\u6d41\u91cf\u8def\u7531\u6216\u5206\u5272\u5df2\u7ecf\u8db3\u591f\u4e86\u3002\u7136\u800c\uff0c\u5728\u6709\u4e9b\u573a\u666f\u548c\u60c5\u51b5\u4e0b\uff0c\u6211 \u4eec\u53ef\u80fd\u9700\u8981\u5bf9\u6d41\u91cf\u5982\u4f55\u88ab\u5206\u5272\u548c\u8f6c\u53d1\u5230\u76ee\u6807\u670d\u52a1\u8fdb\u884c\u66f4\u7ec6\u5316\u7684\u63a7\u5236\u3002 Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528\u4f20\u5165\u8bf7\u6c42\u7684\u4e00\u90e8\u5206\uff0c\u5e76\u5c06\u5176\u4e0e\u5b9a\u4e49\u7684\u503c\u76f8\u5339\u914d\u3002\u4f8b\u5982\uff0c \u6211\u4eec\u53ef\u4ee5\u5339\u914d\u4f20\u5165\u8bf7\u6c42\u7684URI\u524d\u7f00\uff0c\u5e76\u57fa\u4e8e\u6b64\u8def\u7531\u6d41\u91cf \u3002 \u4e0a\u8ff0\u6bcf\u4e2a\u5c5e\u6027\u90fd\u53ef\u4ee5\u7528\u8fd9\u4e9b\u65b9\u6cd5\u4e2d\u7684\u4e00\u79cd\u8fdb\u884c\u5339\u914d \u7cbe\u786e\u5339\u914d\uff1a\u4f8b\u5982\uff0c exact: \"value\" \u5339\u914d\u7cbe\u786e\u7684\u5b57\u7b26\u4e32 \u524d\u7f00\u5339\u914d\uff1a\u4f8b\u5982\uff0c prefix: \"value\" \u53ea\u5339\u914d\u524d\u7f00 \u6b63\u5219\u5339\u914d: \u4f8b\u5982\uff0c regex: \"value\" \u6839\u636e ECMAscript \u98ce\u683c\u7684\u6b63\u5219\u8fdb\u884c\u5339\u914d \u4f8b\u5982\uff0c\u5047\u8bbe\u8bf7\u6c42\u7684URI\u770b\u8d77\u6765\u50cf\u8fd9\u6837 https://dev.example.com/v1/api \u4e3a\u4e86\u5339\u914d\u8be5\u8bf7\u6c42\u7684URI\uff0c\u6211\u4eec\u4f1a\u8fd9\u6837\u5199\uff1a http: - match: - uri: prefix: /v1 \u4e0a\u8ff0\u7247\u6bb5\u5c06\u5339\u914d\u4f20\u5165\u7684\u8bf7\u6c42\uff0c\u5e76\u4e14\u8bf7\u6c42\u5c06\u88ab\u8def\u7531\u5230\u8be5\u8def\u7531\u4e2d\u5b9a\u4e49\u7684\u76ee\u7684\u5730\u3002 \u53e6\u4e00\u4e2a\u4f8b\u5b50\u662f\u4f7f\u7528\u6b63\u5219\u5e76\u5728\u5934\u4e0a\u8fdb\u884c\u5339\u914d \u3002 http: - match: - headers: user-agent: regex: '.*Firefox.*' \u4e0a\u8ff0\u5339\u914d\u5c06\u5339\u914d\u4efb\u4f55\u7528\u6237\u4ee3\u7406\u5934\u4e0eRegex\u5339\u914d\u7684\u8bf7\u6c42\u3002","title":"6\u3001\u9ad8\u7ea7\u8def\u7531"},{"location":"chap8/4Istio_net_control/#6-1","text":"\u5728\u5934\u4fe1\u606f\u548c\u5176\u4ed6\u8bf7\u6c42\u5c5e\u6027\u4e0a\u8fdb\u884c\u5339\u914d\u662f\u6709\u7528\u7684\uff0c\u4f46\u6709\u65f6\u6211\u4eec\u53ef\u80fd\u9700\u8981\u901a\u8fc7\u8bf7\u6c42URI\u4e2d\u7684\u503c\u6765\u5339\u914d\u8bf7\u6c42\u3002 \u4f8b\u5982\uff0c\u8ba9\u6211\u4eec\u8003\u8651\u8fd9\u6837\u4e00\u79cd\u60c5\u51b5\uff1a\u4f20\u5165\u7684\u8bf7\u6c42\u4f7f\u7528 /v1/api \u8def\u5f84\uff0c\u800c\u6211\u4eec\u60f3\u628a\u8bf7\u6c42\u8def\u7531\u5230 /v2/api \u7acb\u6e4d\u70b9\u3002 \u8fd9\u6837\u505a\u7684\u65b9\u6cd5\u662f\u91cd\u5199\u6240\u6709\u4f20\u5165\u7684\u8bf7\u6c42\u548c\u4e0e /v1/api \u5339\u914d\u7684 authority/host headers \u5230 /v2/api \u3002 \u4f8b\u5982\uff1a ... http: - match: - headers: my-header: exact: hello redirect: uri: /hello authority: my-service.default.svc.cluster.local:8000 ... redirect \u548c destination \u5b57\u6bb5\u662f\u76f8\u4e92\u6392\u65a5\u7684\u3002\u5982\u679c\u6211\u4eec\u4f7f\u7528redirect\uff0c\u5c31\u4e0d\u9700\u8981\u8bbe\u7f6e destination \u3002","title":"6-1 \u91cd\u5b9a\u5411\u548c\u91cd\u5199\u8bf7\u6c42"},{"location":"chap8/4Istio_net_control/#6-2-and-or","text":"\u5728\u8fdb\u884c\u5339\u914d\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528AND\u548cOR\u4e24\u79cd\u8bed\u4e49\u3002\u8ba9\u6211\u4eec\u770b\u4e00\u4e0b\u4e0b\u9762\u7684\u7247\u6bb5\uff1a AND ... http: - match: - uri: prefix: /v1 headers: my-header: exact: hello ... \u4e0a\u9762\u7684\u7247\u6bb5\u4f7f\u7528\u7684\u662fAND\u8bed\u4e49\u3002\u8fd9\u610f\u6627\u7740URI\u524d\u7f00\u9700\u8981\u4e0e /v1 \u76f8\u5339\u914d\uff0c\u5e76\u4e14\u5934\u4fe1\u606f my-header \u6709\u4e00\u4e2a\u786e\u5207\u7684\u503chello OR \u8981\u4f7f\u7528OR\u8bed\u4e49\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u53e6\u4e00\u4e2a match \u9879\uff0c\u50cf\u8fd9\u6837\uff1a ... http: - match: - uri: prefix: /v1 ... - match: - headers: my-header: exact: hello ... \u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5c06\u9996\u5148\u5bf9URI\u524d\u7f00\u8fdb\u884c\u5339\u914d\uff0c\u5982\u679c\u5339\u914d\uff0c\u8bf7\u6c42\u5c06\u88ab\u8def\u7531\u5230\u76ee\u7684\u5730\u3002 \u5982\u679c\u7b2c\u4e00 \u4e2a\u4e0d\u5339\u914d\uff0c\u7b97\u6cd5\u4f1a\u8f6c\u79fb\u5230\u7b2c\u4e8c\u4e2a\uff0c\u5e76\u5c1d\u8bd5\u5339\u914d\u5934\u3002 \u5982\u679c\u6211\u4eec\u7701\u7565\u8def\u7531\u4e0a\u7684\u5339\u914d\u5b57\u6bb5, \u5b83\u5c06\u603b\u662f\u8bc4\u4f30\u4e3atrue","title":"6-2 AND \u548c OR\u8bed\u4e49"},{"location":"chap8/4Istio_net_control/#7serviceentry","text":"\u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206 \u3002 \u5f53\u4e00\u4e2a\u670d\u52a1\u5728\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u65f6\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u6d41\u91cf\u8def\u7531\u3001\u6545\u969c\u6ce8\u5165\u548c\u5176\u4ed6\u7f51\u683c\u529f\u80fd\uff0c\u5c31\u50cf\u6211\u4eec\u5bf9\u5176\u4ed6\u670d\u52a1\u4e00\u6837\u3002","title":"7\u3001ServiceEntry"},{"location":"chap8/4Istio_net_control/#7-1-serviceentry-resource","text":"Add entries to Istio's service registry Use traffic routing, failure injection, and other features against external services \u4e0b\u9762\u662f\u4e00\u4e2a ServiceEntry \u8d44\u6e90\u7684\u4f8b\u5b50\uff0c\u5b83\u58f0\u660e\u4e86\u4e00\u4e2a\u53ef\u4ee5\u901a\u8fc7HTTPS\u8bbf\u95ee\u7684\u5916\u90e8API ( api.external-svc.com )\u3002 apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: external-svc spec: hosts: - api.external-svc.com ports: - number: 443 name: https protocol: TLS resolution: DNS location: MESH_EXTERNAL hosts \u5b57\u6bb5\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u5916\u90e8API\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cEnvoy sidecar\u4f1a\u6839\u636e\u4e0b\u9762\u7684\u5c42\u6b21\u7ed3\u6784\u6765\u8fdb\u884c\u68c0\u67e5\u3002\u5982\u679c\u4efb\u4f55\u4e00\u9879\u4e0d\u80fd\u88ab\u68c0\u67e5\uff0cEnvoy\u5c31\u4f1a\u8f6c\u5230\u5c42\u6b21\u7ed3\u6784\u4e2d\u7684\u4e0b\u4e00\u9879\u3002 HTTP Authority\u5934\uff08\u5728HTTP/2\u4e2d\uff09\u548cHost\u5934\uff08HTTP/1.1\u4e2d\uff09 SNI IP\u5730\u5740\u548c\u7aef\u53e3 \u5982\u679c\u4e0a\u8ff0\u6570\u503c\u90fd\u65e0\u6cd5\u68c0\u67e5\uff0cEnvoy\u4f1a\u6839\u636eIstio\u7684\u5b89\u88c5\u914d\u7f6e\uff0c\u76f2\u76ee\u5730\u8f6c\u53d1\u8bf7\u6c42\u6216\u653e\u5f03\u8be5\u8bf7\u6c42\u3002","title":"7-1 ServiceEntry Resource"},{"location":"chap8/4Istio_net_control/#7-2-workloadentry","text":"Handle migration of VM workloads to Kubernetes Specify VM workloads and make them part of Istio's service registry \u4e0eWorkloadEntry\u8d44\u6e90\u4e00\u8d77\uff0c \u6211\u4eec\u53ef\u4ee5\u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5411Kubernetes\u8fc1\u79fb\u7684\u95ee\u9898 \u3002 \u5728Workload Entry\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ec6\u8282\uff08\u540d\u79f0\u3001\u5730\u5740\u3001\u6807\u7b7e\uff09\uff0c\u7136\u540e\u4f7f\u7528ServiceEntry\u4e2d\u7684 workloadSelector \u5b57\u6bb5\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3a Istio \u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206\u3002 \u4f8b\u5982\uff0c\u5047\u8bbecustomers\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6b63\u5728\u4e24\u4e2a\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u3002\u6b64\u5916\uff0c\u6211\u4eec\u5df2\u7ecf\u6709\u5728Kuternetes\u4e2d\u8fd0\u884c\u7684Pod\uff0c\u5176\u6807\u7b7e\u4e3a app: customers \u8ba9\u6211\u4eec\u8fd9\u6837\u6765\u5b9a\u4e49WorkloadEntry\u8d44\u6e90\uff1a apiVersion: networking.istio.io/v1alpha3 kind: WorkloadEntry metadata: name: customers-vm-1 spec: serviceAccount: customers address: 1.0.0.0 labels: app: customers instance-id: vm1 --- apiVersion: networking.istio.io/v1alpha3 kind: WorkloadEntry metadata: name: customers-vm-2 spec: serviceAccount: customers address: 2.0.0.0 labels: app: customers instance-id: vm2 \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a ServiceEntry \u8d44\u6e90\uff0c\u8be5\u8d44\u6e90\u540c\u65f6\u8de8\u8d8aKubernetes\u4e2d\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u548c\u865a\u62df\u673a\uff1a apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: customers-svc spec: hosts: - customers.com location: MESH_INTERNAL ports: - number: 80 name: http protocol: HTTP resolution: STATIC workloadSelector: labels: app: customers \u5728location\u5b57\u6bb5\u4e2d\u8bbe\u7f6e MESH_INTERNAL \uff0c\u8fd9\u662f\u8bf4\u8fd9\u4e2a\u670d\u52a1\u662f\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002\u8fd9\u4e2a\u503c\u901a\u5e38\u7528\u4e8e\u5305\u62ec\u672a\u7ba1\u7406\u7684\u57fa\u7840\u8bbe\u65bd\uff08VM\uff09\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u60c5\u51b5\u3002 \u8fd9\u4e2a\u5b57\u6bb5\u7684\u53e6\u4e00\u4e2a\u503c\uff0c MESH_EXTERNAL \uff0c\u7528\u4e8e\u901a\u8fc7API\u6d88\u8d39\u7684\u5916\u90e8\u670d\u52a1\u3002 MESH_EXTERNAL \u548c MESH_EXTERNAL \u8bbe\u7f6e\u63a7\u5236\u4e86\u7f51\u683c\u4e2d\u7684sidecar\u5982\u4f55\u5c1d\u8bd5\u4e0e\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u901a\u4fe1\uff0c\u5305\u62ec\u5b83\u4eec\u662f\u5426\u4f1a\u9ed8\u8ba4\u4f7f\u7528Istio\u53cc\u5411TLS\u3002","title":"7-2 WorkloadEntry"},{"location":"chap8/4Istio_net_control/#8sidecar","text":"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c \u6ce8\u5165\u7684sidecar\u4ee3\u7406\u63a5\u6536\u6240\u6709\u7aef\u53e3\u7684\u6d41\u91cf\uff0c\u5e76\u4e14\u5728\u8f6c\u53d1\u6d41\u91cf\u65f6\u53ef\u4ee5\u5230\u8fbe\u7f51\u683c\u4e2d\u7684\u4efb\u4f55\u670d\u52a1 \u3002 \u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u80fd\u60f3\u6539\u53d8\u8fd9\u79cd\u914d\u7f6e\uff0c\u914d\u7f6e\u4ee3\u7406\uff0c\u6240\u4ee5\u5b83\u53ea\u80fd\u4f7f\u7528\u7279\u5b9a\u7684\u7aef\u53e3\u548c\u8bbf\u95ee\u67d0\u4e9b\u670d\u8d44\u6e90\u3002 \u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u4f60\u53ef\u4ee5\u5728Istio\u4e2d\u4f7f\u7528Sidecar\u8d44\u6e90 Sidecar\u8d44\u6e90\u53ef\u4ee5\u88ab\u90e8\u7f72\u5230Kubernetes\u96c6\u7fa4\u5185\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u4f46\u5982\u679c\u6ca1\u6709\u5b9a\u4e49\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\uff0c\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u53ea\u80fd\u6709\u4e00\u4e2asidecar\u8d44\u6e90\u3002 Sidecar\u8d44\u6e90\u7531\u4e09\u90e8\u5206\u7ec4\u6210\uff0c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u3001\u4e00\u4e2a\u5165\u53e3\uff08ingress)\u76d1\u542c\u5668\u548c\u4e00\u4e2a\u51fa\u53e3 (egress)\u76d1\u542c\u5668\u3002 Sidecar Resource Proxies accept traffic on all ports Configure Sidecar to specific ports/services Three parts: Workload selector Ingress listener Egress listener","title":"8\u3001Sidecar"},{"location":"chap8/4Istio_net_control/#8-1","text":"\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u51b3\u5b9a\u4e86\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u4f1a\u53d7\u5230sidecar\u914d\u7f6e\u7684\u5f71\u54cd \u3002 \u4f60\u53ef\u4ee5\u51b3\u5b9a\u63a7\u5236\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709sidecar\uff0c\u800c\u4e0d\u8003\u8651\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6216\u8005\u63d0\u4f9b\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\uff0c\u5c06\u914d\u7f6e\u53ea\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 \u4f8b\u5982\uff0c\u8fd9\u4e2aYAML\u9002\u7528\u4e8e\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u5185\u7684\u6240\u6709\u4ee3\u7406\uff0c\u56e0\u4e3a\u6ca1\u6709\u5b9a\u4e49\u9009\u62e9\u5668\u3002 apiVersion: networking.istio.io/v1alpha3 kind: Sidecar metadata: name: default-sidecar namespace: default spec: egress: - hosts: - \"default/*\" - \"istio-system/*\" - \"staging/*\" \u5728egress\u90e8\u5206\uff0c\u6211\u4eec\u6307\u5b9a\u4ee3\u7406\u53ef\u4ee5\u8bbf\u95ee\u8fd0\u884c\u5728 default \u3001 istio-system \u548c Staging \u547d\u540d\u7a7a\u95f4\u7684\u670d\u52a1\u3002 \u8981\u5c06\u8d44\u6e90\u4ec5\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 workloadSelector \u5b57\u6bb5\u3002 \u4f8b\u5982\uff0c\u5c06\u9009\u62e9\u5668\u8bbe\u7f6e\u4e3a version:v1 \u5c06\u53ea\u9002\u7528\u4e8e\u6709\u8be5\u6807\u7b7e\u8bbe\u7f6e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 apiVersion: networking.istio.io/v1alpha3 kind: Sidecar metadata: name: default-sidecar namespace: default spec: workloadSelector: labels: version: v1 egress: - hosts: - \"default/*\" - \"istio-system/*\" - \"staging/*\"","title":"8-1 \u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668"},{"location":"chap8/4Istio_net_control/#8-2","text":"\u8d44\u6e90\u7684\u5165\u53e3\uff08ingress)\u76d1\u542c\u5668\u90e8\u5206\u5b9a\u4e49\u4e86\u54ea\u4e9b\u5165\u7ad9\u6d41\u91cf\u88ab\u63a5\u53d7\u3002\u540c\u6837\u5730\uff0c\u901a\u8fc7\u51fa\u53e3 (egress)\u76d1\u542c\u5668\uff0c\u4f60\u53ef\u4ee5\u5b9a\u4e49\u51fa\u7ad9\u6d41\u91cf\u7684\u5c5e\u6027 \u3002 \u6bcf\u4e2a\u5165\u53e3\u76d1\u542c\u5668\u90fd\u9700\u8981\u4e00\u4e2a\u7aef\u53e3\u8bbe\u7f6e\uff0c\u4ee5\u4fbf\u63a5\u6536\u6d41\u91cf\uff08\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\u76843000)\u548c\u4e00\u4e2a\u9ed8\u8ba4\u7684\u7aef\u70b9 \u3002\u9ed8\u8ba4\u7aef\u70b9\u53ef\u4ee5\u662f\u4e00\u4e2a\u56de\u73afIP\u7aef\u70b9\u6216Unix\u57df\u5957\u63a5\u5b57\u3002\u7aef\u70b9\u914d\u7f6e\u4e86\u6d41\u91cf\u5c06\u88ab\u8f6c\u53d1\u5230\u54ea\u91cc\u3002 ... ingress: - port: number: 3000 protocol: HTTP name: somename defaultEndpoint: 127.0.0.1:8080 ... \u4e0a\u9762\u7684\u7247\u6bb5\u5c06\u5165\u53e3\u76d1\u542c\u5668\u914d\u7f6e\u4e3a\u5728\u7aef\u53e33000\u4e0a\u76d1\u542c\uff0c\u5e76\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u670d\u52a1\u76d1\u542c\u7684\u7aef\u53e38080\u4e0a\u7684\u56de\u73afIP\u3002 \u6b64\u5916\uff0c\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6ebind\u5b57\u6bb5\uff0c\u4ee5\u6307\u5b9a\u4e00\u4e2aIP\u5730\u5740\u6216\u57df\u5957\u63a5\u5b57\uff0c\u6211\u4eec\u5e0c\u671b\u4ee3\u7406\u76d1\u542c\u4f20\u5165\u7684\u6d41\u91cf\u3002\u6700\u540e\uff0c\u5b57\u6bb5 captureMode \u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u5982\u4f55\u4ee5\u53ca\u662f\u5426\u6355\u83b7\u6d41\u91cf\u3002 \u51fa\u53e3\u76d1\u542c\u5668\u6709\u7c7b\u4f3c\u7684\u5b57\u6bb5\uff0c\u4f46\u589e\u52a0\u4e86 hosts \u5b57\u6bb5\u3002\u901a\u8fc7 hosts \u5b57\u6bb5, \u4f60\u53ef\u4ee5\u7528 default \u6216 namespace/dnsName \u7684\u683c\u5f0f\u6307\u5b9a\u670d\u52a1\u4e3b\u673a\u3002\u4f8b\u5982 myservice.default \u6216 default/* \u3002 \u5728 hosts \u5b57\u6bb5\u4e2d\u6307\u5b9a\u7684\u670d\u52a1\u53ef\u4ee5\u662f\u6765\u81ea\u7f51\u683c\u6ce8\u518c\u8868\u7684\u5b9e\u9645\u670d\u52a1\u3001\u5916\u90e8\u670d\u52a1\uff08\u7528 ServiceEntry \u5b9a\u4e49\uff09, \u6216\u865a\u62df\u670d\u52a1\u3002 egress: - port: number: 8080 protocol: HTTP hosts: - \"staging/*\" \u901a\u8fc7\u4e0a\u9762\u7684 YAML\uff0c sidecar \u4ee3\u7406\u4e86\u8fd0\u884c\u5728\u547d\u540d\u7a7a\u95f4\u7684\u670d\u52a1\u7684 8080 \u7aef\u53e3\u7684\u6d41\u91cf \u3002","title":"8-2 \u5165\u53e3\u548c\u51fa\u53e3\u76d1\u542c\u5668"},{"location":"chap8/4Istio_net_control/#9envoy-filter","text":"EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531 Istio Pilot \u751f\u6210\u7684Envoy\u914d\u7f6e\u3002 \u4f7f\u7528\u8be5\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u66f4\u65b0\u6570\u503c\uff0c\u6dfb\u52a0\u7279\u5b9a\u7684\u8fc7\u6ee4\u5668\uff0c\u751a\u81f3\u6dfb\u52a0\u65b0\u7684\u76d1\u542c\u5668\u3001\u96c6\u7fa4\u7b49\u7b49\u3002\u5c0f\u5fc3\u4f7f\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u56e0\u4e3a\u4e0d\u6b63\u786e\u7684 \u5b9a\u5236\u53ef\u80fd\u4f1a\u7834\u574f\u6574\u4e2a\u7f51\u683c\u7684\u7a33\u5b9a\u6027\u3002 \u8fc7\u6ee4\u5668\u662f\u53e0\u52a0\u5e94\u7528\u7684\uff0c\u8fd9\u610f\u6627\u7740\u5bf9\u4e8e\u7279\u5b9a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u7279\u5b9a\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u53ef\u4ee5\u6709\u4efb\u4f55\u6570\u91cf\u7684\u8fc7\u6ee4\u5668\u3002 \u6839\u547d\u540d\u7a7a\u95f4\uff08\u4f8b\u5982 istio-system )\u4e2d\u7684\u8fc7\u6ee4\u5668\u9996\u5148\u88ab\u5e94\u7528\uff0c\u7136\u540e\u662f\u5de5\u4f5c\u8d1f\u8f7d\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u5339\u914d\u8fc7\u6ee4\u5668\u3002 \u4e0b\u9762\u662f\u4e00\u4e2a EnvoyFilter \u7684\u4f8b\u5b50\uff0c\u5b83\u5728\u8bf7\u6c42\u4e2d\u6dfb\u52a0\u4e86\u4e00\u4e2a\u540d\u4e3a api-version \u7684\u5934\u3002 apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata: name: api-header-filter namespace: default spec: workloadSelector: labels: app: web-frontend configPatches: - applyTo: HTTP_FILTER match: context: SIDECAR_INBOUND listener: portNumber: 8080 filterChain: filter: name: \"envoy.http_connection_manager\" subFilter: name: \"envoy.router\" patch: operation: INSERT_BEFORE value: name: envoy.lua typed_config: \"@type\": \"type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua\" inlineCode: | function envoy_on_response(response_handle) response_handle:headers():add(\"api-version\", \"v1\") end \u5982\u679c\u4f60\u5411 \uff04GATEWAY_URL \u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f60\u53ef\u4ee5\u6ce8\u610f\u5230 api-version \u5934\u88ab\u6dfb\u52a0\u4e86\uff0c\u5982\u4e0b\u6240 $ curl -s -I -X HEAD http://$GATEWAY_URL HTTP/1.1 200 OK x-powered-by: Express content-type: text/html; charset=utf-8 content-length: 2471 etag: W/\"9a7-hEXE7lJW5CDgD+e2FypGgChcgho\" date: Tue, 17 Nov 2020 00:40:16 GMT x-envoy-upstream-service-time: 32 api-version: v1 server: istio-envoy","title":"9\u3001Envoy Filter"},{"location":"chap8/5Istio_net_control_exp/","text":"\u7b2c\u4e94\u8282 \u6d41\u91cf\u7ba1\u7406\u5b9e\u9a8c\u4e0e\u6d4b\u8bd5 1\u3001\u521b\u5efa\u90e8\u7f72\u5e76\u4f7f\u7528\u7f51\u5173\u66b4\u9732 \u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e00\u4e2aHello World\u5e94\u7528\u7a0b\u5e8f\u3002 \u7136\u540e\u6211\u4eec\u5c06\u90e8\u7f72\u4e00\u4e2a Gateway\u8d44\u6e90\u548c\u4e00\u4e2a\u4e0eGateway\u7ed1\u5b9a\u7684VirtualService\uff0c\u4ee5\u4fbf\u5728\u5916\u90e8IP\u5730\u5740\u4e0a\u516c\u5f00\u8be5\u5e94\u7528\u7a0b\u5e8f\u3002 \u8ba9\u6211\u4eec\u5148\u4ece\u90e8\u7f72Gateway\u8d44\u6e90\u5f00\u59cb\u3002\u6211\u4eec\u5c06\u628a hosts \u5b57\u6bb5\u8bbe\u7f6e\u4e3a \uff0a \uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4ece\u5916\u90e8IP\u5730\u5740\u8bbf\u95ee\u5165\u53e3\u7f51\u5173\u3002\u5982\u679c\u6211\u4eec\u60f3\u901a\u8fc7\u57df\u540d\u8bbf\u95ee\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06 hosts \u7684\u503c\u8bbe\u7f6e\u4e3a\u57df\u540d\uff08\u4f8b\u5982 example.com )\uff0c\u7136\u540e\u5c06\u5916\u90e8IP\u5730\u5740\u6dfb\u52a0\u5230\u8be5\u57df\u540d\u7684A\u8bb0\u5f55\u4e2d\u3002 gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' $ kubectl apply -f gateway-210119-085144.yaml gateway.networking.istio.io/gateway created \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a gateway.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f gateway.yaml \u90e8\u7f72\u8be5\u7f51\u5173\u3002 \u5982\u679c\u6211\u4eec\u8bd5\u56fe\u8bbf\u95ee\u5165\u53e3\u7f51\u5173\u7684\u5916\u90e8IP\u5730\u5740\uff0c\u6211\u4eec\u5c06\u5f97\u5230\u4e00\u4e2a HTTP 404 \uff0c\u56e0\u4e3a\u6ca1\u6709\u4efb\u4f55\u7ed1\u5b9a\u5230\u7f51\u5173\u7684 VirtualService \u3002\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u8def\u7531\uff0c\u6240\u4ee5\u5165\u53e3\u4ee3\u7406\u4e0d\u77e5\u9053\u8981\u628a\u6d41\u91cf\u8def\u7531\u5230\u54ea\u91cc\u3002 \u8981\u83b7\u5f97\u5165\u53e3\u7f51\u5173\u7684\u5916\u90e8iP\u5730\u5740\uff0c\u8bf7\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5e76\u67e5\u770b EXTERNAL-IP \u5217\u7684\u503c\uff1a $ kubectl get svc -l=istio=ingressgateway -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-ingressgateway LoadBalancer 10.105.159.70 localhost 15021:31875/TCP,80:32344/TCP,443:31252/TCP,31400:31315/TCP,15443:31199/TCP 7d5h \u5728\u6574\u4e2a\u8bfe\u7a0b\u7684\u5176\u4f59\u90e8\u5206\uff0c\u5f53\u6211\u4eec\u8c08\u5230\u5165\u53e3\u7f51\u5173\u7684\u5916\u90e8IP\u65f6\uff0c\u6211\u4eec\u5c06\u5728\u4f8b\u5b50\u548c\u6587\u672c\u4e2d\u4f7f\u7528 GATEWAY URL \u3002 \u4e0b\u4e00\u6b65\u662f\u521b\u5efa Hello World \u90e8\u7f72\u548c\u670d\u52a1\u3002 Hello world \u5e94\u7528\u7a0b\u5e8f\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u7f51\u7ad9\uff0c\u53ea\u662f\u6e32\u67d3 \"Hello world\" hello-world.yaml apiVersion: apps/v1 kind: Deployment metadata: name: hello-world labels: app: hello-world spec: replicas: 1 selector: matchLabels: app: hello-world template: metadata: labels: app: hello-world spec: containers: - image: gcr.io/tetratelabs/hello-world:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: hello-world labels: app: hello-world spec: selector: app: hello-world ports: - port: 80 name: http targetPort: 3000 $ kubectl get pod,svc -l=app=hello-world NAME READY STATUS RESTARTS AGE pod/hello-world-85c8685dd-gf9xf 2/2 Running 0 5m4s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/hello-world ClusterIP 10.102.151.188 <none> 80/TCP 5m4s \u4e0b\u4e00\u6b65\u662f\u4e3a hello-world \u670d\u52a1\u521b\u5efa\u4e00\u4e2a VirtualService \uff0c\u5e76\u5c06\u5176\u7ed1\u5b9a\u5230 Gateway \u8d44\u6e90\u4e0a\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: hello-world spec: hosts: - \"*\" gateways: - gateway http: - route: - destination: host: hello-world.default.svc.cluster.local port: number: 80 \u6211\u4eec\u5728 hosts \u5b57\u6bb5\u4e2d\u4f7f\u7528 * \uff0c\u5c31\u50cf\u6211\u4eec\u5728Gateway\u4e2d\u505a\u7684\u90a3\u6837\u3002\u6211\u4eec\u8fd8\u5c06\u4e4b\u524d\u521b\u5efa\u7684 Gateway \u8d44\u6e90\uff08gateway\uff09\u6dfb\u52a0\u5230 gateways \u6570\u7ec4\u4e2d\u3002 \u6700\u540e\uff0c\u6211\u4eec\u6307\u5b9a\u4e86\u4e00\u4e2a\u76ee\u7684\u5730\u4e3a Kubernetes \u670d\u52a1 hello-world.default.svc.cluster.local \u7684\u5355\u4e00\u8def\u7531\u3002 \u5c06\u4e0a\u8ff0 YAML \u4fdd\u5b58\u4e3a vs-hello-world.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f vs-hello-world.yaml \u521b\u5efaVirtualService\u3002 \u5982\u679c\u4f60\u770b\u4e00\u4e0b\u90e8\u7f72\u7684 VirtualService , \u4f60\u5e94\u8be5\u770b\u5230\u7c7b\u4f3c\u7684\u8f93\u51fa\uff1a $ kubectl get vs NAME GATEWAYS HOSTS AGE hello-world [\"gateway\"] [\"*\"] 25s \u5982\u679c\u6211\u4eec\u5bf9 GATEWAY URL \u8fd0\u884c cURL \u6216\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u5b83\uff0c\u6211\u4eec\u5c06\u5f97\u5230 Hello World \u7684\u54cd\u5e94\uff1a curl -v http://localhost * Trying 127.0.0.1:80... * TCP_NODELAY set * Connected to localhost (127.0.0.1) port 80 (#0) > GET / HTTP/1.1 > Host: localhost > User-Agent: curl/7.65.1 > Accept: */* > * Mark bundle as not supporting multiuse < HTTP/1.1 200 OK < date: Sat, 09 Oct 2021 14:17:41 GMT < content-length: 11 < content-type: text/plain; charset=utf-8 < x-envoy-upstream-service-time: 25 < server: istio-envoy < * Connection #0 to host localhost left intact Hello World \u53e6\u5916\uff0c\u6ce8\u610f\u5230server\u5934\u8bbe\u7f6e\u4e3aistio-envoy\uff0c\u544a\u8bc9\u6211\u4eec\u8be5\u8bf7\u6c42\u901a\u8fc7\u4e86Envoy\u4ee3\u7406\u3002 \u6e05\u7406 \u5220\u9664Deployment\u3001 Services VirtualService\u548cGateway $ kubectl delete deploy hello-world deployment.apps \"hello-world\" deleted $ kubectl delete service hello-world service \"hello-world\" deleted $ kubectl delete vs hello-world virtualservice.networking.istio.io \"hello-world\" deleted $ kubectl delete gateway gateway gateway.networking.istio.io \"gateway\" deleted 2\u3001\u5728Grafana\u3001 Zipkin\u548cKiali\u4e2d\u89c2\u5bdf\u6545\u969c\u6ce8\u5165\u548c\u5ef6\u8fdf\u60c5\u51b5 \u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c \u6211\u4eec\u5c06\u90e8\u7f72Web\u524d\u7aef\u548c Customer V1 \u670d\u52a1\u3002\u7136\u540e\uff0c\u6211\u4eec\u5c06\u5728Zipkin\u3001 Kiali \u548cGrafana\u4e2d\u6ce8\u5165\u6545\u969c\u548c\u5ef6\u8fdf\uff0c\u5e76\u89c2\u5bdf\u5b83\u4eec\u3002 gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' $ kubectl get svc -l=istio=ingressgateway -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-ingressgateway LoadBalancer 10.105.159.70 localhost 15021:31875/TCP,80:32344/TCP,443:31252/TCP,31400:31315/TCP,15443:31199/TCP 8d \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a gateway.yaml \u5e76\u4f7f\u7528 kubectl apply -f gateway.yaml \u521b\u5efa\u7f51\u5173\u3002 \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u90e8\u7f72 Web Frontend \u3001 Service \u548c VirtualService web-frontend.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: containers: - image: pj3677/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 $ kubectl get vs NAME GATEWAYS HOSTS AGE web-frontend [\"gateway\"] [\"*\"] 83s \u5c06\u4e0a\u8ff0 YAML \u4fdd\u5b58\u4e3a web-frontend.yaml \uff0c\u5e76\u4f7f\u7528 kubect1 apply -f web-frontend.yaml \u521b\u5efa\u8d44\u6e90\u3002 \u6700\u540e\uff0c\u6211\u4eec\u5c06\u90e8\u7f72 Customers v1 \u548c\u76f8\u5e94\u7684\u8d44\u6e90\u3002 customers-default.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers spec: host: customers.default.svc.cluster.local subsets: - name: v1 labels: version: v1 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 $ kubectl apply -f customers-210121-151301.yaml deployment.apps/customers-v1 created service/customers created destinationrule.networking.istio.io/customers created virtualservice.networking.istio.io/customers created Delay inject\uff08\u5ef6\u8fdf\u6ce8\u5165\uff09 customers-delay.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 fault: delay: percent: 50 fixedDelay: 5s $ kubectl apply -f customersdelay-210121-151301.yaml virtualservice.networking.istio.io/customers configured \u5c06\u4e0a\u8ff0 YAML \u4fdd\u5b58\u4e3a customers-delay.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f customers-delay.yaml \u66f4\u65b0 VirtualService \u3002 \u4e3a\u4e86\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf\uff0c\u8ba9\u6211\u4eec\u6253\u5f00\u4e00\u4e2a\u5355\u72ec\u7684\u7ec8\u7aef\u7a97\u53e3\uff0c\u5f00\u59cb\u5411 GATEWAY URL \u53d1\u51fa\u65e0\u7a77\u7684\u5faa\u73af\u8bf7\u6c42\u3002 while true; do curl http://$GATEWAY_URL/; done while true; do curl http://127.0.0.1/; done \u6211\u4eec\u5e94\u8be5\u5f00\u59cb\u6ce8\u610f\u5230\u4e00\u4e9b\u8bf7\u6c42\u7684\u65f6\u95f4\u6bd4\u5e73\u65f6\u957f\u3002\u8ba9\u6211\u4eec\u6253\u5f00Grafana\u5e76\u89c2\u5bdf\u8fd9\u4e9b\u5ef6\u8fdf\u3002 $ istioctl dash grafana http://localhost:3000 \u5f53Grafana\u6253\u5f00\u65f6\uff0c\u70b9\u51fb\u4e3b\u9875\u548c Istio Service Dashboard \u3002\u5728\u4eea\u8868\u677f\u4e0a\uff0c\u786e\u4fdd\u5728\u670d\u52a1\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9 customers.default.svc.cluster.local \u5982\u679c\u4f60\u5c55\u5f00 Client Workload \u9762\u677f\uff0c\u4f60\u4f1a\u53d1\u73b0\u5ba2\u6237\u7aef\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u56fe\u4e0a\u7684\u6301\u7eed\u65f6\u95f4\u589e\u52a0\u4e86\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u4f60\u53ef\u4ee5\u6ce8\u610f\u5230 web-frontend.default.svc.cluster.local \u670d\u52a1\u65b9\u9762\u4e5f\u6709\u540c\u6837\u7684\u5ef6\u8fdf\u3002 \u8ba9\u6211\u4eec\u770b\u770b\u8fd9\u4e2a\u5ef6\u8fdf\u5728 Zipkin \u4e2d\u662f\u5982\u4f55\u663e\u793a\u7684\u3002 \u7528 istioctl dash zipkin \u6253\u5f00Zipkin\u3002 \u5728\u4e3b\u5c4f\u5e55\u4e0a\uff0c\u9009\u62e9 serviceName \u548c web-frontend.default \uff0c\u7136\u540e\u6dfb\u52a0 minDuration \u6761\u4ef6\uff0c \u8f93\u5165 5S \uff0c\u70b9\u51fb\u641c\u7d22\u6309\u94ae\uff0c\u627e\u5230 trace \u70b9\u51fb\u5176\u4e2d\u4e00\u4e2atrace\uff0c\u6253\u5f00\u8be6\u7ec6\u4fe1\u606f\u9875\u9762\u3002\u5728\u8be6\u60c5\u9875\u4e0a\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6301\u7eed\u65f6\u95f4\u662f5\u79d2\u3002 \u5355\u4e2atrace\u67094\u4e2aspan\u2014\u2014\u70b9\u51fb3\u4e2a\u8de8\u5ea6\uff0c\u4ee3\u8868\u4ece web-frontend \u5230\u5ba2\u6237\u670d\u52a1\u7684\u8bf7\u6c42\u3002 \u4f60\u4f1a\u6ce8\u610f\u5230\u5728\u7ec6\u8282\u4e2d\uff0c response_flags \u6807\u7b7e\u8bbe\u7f6e\u4e3a DI \u3002 \"DI\u201d\u4ee3\u8868\u201d\u5ef6\u8fdf\u6ce8\u5165\u201d\uff0c\u8868\u793a\u8be5\u8bf7\u6c42\u88ab\u5ef6\u8fdf\u4e86 \u3002 Fault inject\uff08\u6545\u969c\u6ce8\u5165\uff09 \u8ba9\u6211\u4eec\u518d\u6b21\u66f4\u65b0 VirtualService \uff0c\u8fd9\u4e00\u6b21\uff0c\u6211\u4eec\u5c06\u6ce8\u5165\u4e00\u4e2a\u6545\u969c\uff0c\u5bf950\uff05\u7684\u8bf7\u6c42\u8fd4\u56de HTTP 500 \u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 fault: abort: httpStatus: 500 percentage: value: 50 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a customers\u4e00fault.yaml \uff0c\u7136\u540e\u7528 kubectl apply -f customers-fault.yaml \u66f4\u65b0 VirtualService \u3002 \u5c31\u50cf\u524d\u9762\u4e00\u6837\uff0c\u6211\u4eec\u5c06\u5f00\u59cb\u6ce8\u610f\u5230\u6765\u81ea\u8bf7\u6c42\u5faa\u73af\u7684\u5931\u8d25\u3002\u5982\u679c\u6211\u4eec\u56de\u5230Grafana\u5e76\u6253\u5f00 Istio Service Dashboard \uff0c \u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u5ba2\u6237\u7aef\u7684\u6210\u529f\u7387\u5728\u4e0b\u964d\uff0c\u5e76\u4e14\u5728\u6309\u6765\u6e90\u548c\u54cd\u5e94\u4ee3\u7801\u5212\u5206\u7684\u4f20\u5165\u8bf7\u6c42\u56fe\u4e0a 500 \u54cd\u5e94\u5728\u589e\u52a0\uff0c\u5982\u56fe\u6240\u793a\u3002 $ kubectl apply -f customersfault-210121-151301.yaml virtualservice.networking.istio.io/customers configured \u5728Zipkin\u4e2d\u4e5f\u6709\u7c7b\u4f3c\u7684\u60c5\u51b5\u3002\u5982\u679c\u6211\u4eec\u518d\u6b21\u641c\u7d22 trace \uff08\u6211\u4eec\u53ef\u4ee5\u5220\u9664\u6700\u5c0f\u6301\u7eed\u65f6\u95f4\uff09\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6709\u9519\u8bef\u7684trace\u4f1a\u4ee5\u7ea2\u8272\u663e\u793a\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u8ba9\u6211\u4eec\u4e5f\u6253\u5f00Kiali ( istioctl dash kiali )\uff0c\u901a\u8fc7\u70b9\u51fbGraph\u9879\u67e5\u770b\u670d\u52a1\u56fe\u3002\u4f60\u4f1a\u6ce8\u610f\u5230web- frontend\u670d\u52a1\u6709\u4e00\u4e2a\u7ea2\u8272\u7684\u8fb9\u6846\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u5982\u679c\u6211\u4eec\u70b9\u51fb web-frontend \u670d\u52a1\uff0c\u770b\u770b\u53f3\u8fb9\u7684\u4fa7\u8fb9\u680f\uff0c\u4f60\u4f1a\u53d1\u73b0HTTP\u8bf7\u6c42\u7684\u7ec6\u8282\u3002\u56fe\u4e2d\u663e\u793a\u4e86\u6210\u529f\u548c\u5931\u8d25\u7684\u767e\u5206\u6bd4\uff0c\u8fd9\u4e24\u4e2a\u6570\u5b57\u90fd\u572850\uff05\u5de6\u53f3\uff0c\u8fd9\u4e0e\u6211\u4eec\u5728VirtualService\u4e2d\u8bbe\u7f6e \u7684\u767e\u5206\u6bd4\u503c\u76f8\u4e00\u81f4\u3002 \u6e05\u7406 \u5220\u9664DepIoyment\u3001 Services VirtuaIService\u3001 DestinationRule\u548cGateway $ kubectl delete deploy web-frontend deployment.apps \"web-frontend\" deleted $ kubectl delete svc customers web-frontend service \"customers\" deleted service \"web-frontend\" deleted $ kubectl delete vs customers web-frontend virtualservice.networking.istio.io \"customers\" deleted virtualservice.networking.istio.io \"web-frontend\" deleted $ kubectl delete gateway gateway gateway.networking.istio.io \"gateway\" deleted 3\u3001\u7b80\u5355\u6d41\u91cf\u8def\u7531 \u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u6743\u91cd\u5728\u4e0d\u540c\u7684\u670d\u52a1\u7248\u672c\u4e4b\u95f4\u8def\u7531\u6d41\u91cf\u3002\u7136\u540e\uff0c\u6211\u4eec\u5c06\u90e8\u7f72 Customers \u670d\u52a1\u7248\u672c v2 \uff0c\u5e76\u4f7f\u7528\u5b50\u96c6\u5728\u8fd9\u4e24\u4e2a\u7248\u672c\u4e4b\u95f4\u5206\u914d\u6d41\u91cf\u3002 \u8ba9\u6211\u4eec\u4ece\u90e8\u7f72Gateway\u5f00\u59cb gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u521b\u5efa Web Frontend \u548c Customers \u670d\u52a1\u7684\u90e8\u7f72\u4ee5\u53ca\u76f8\u5e94\u7684 Kubernetes \u670d\u52a1\u3002\u8ba9\u6211\u4eec\u9996\u5148\u4ece web-frontend \u5f00\u59cb\uff1a web-frontend.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 \u6ce8\u610f\uff0c\u6211\u4eec\u6b63\u5728\u8bbe\u7f6e\u4e00\u4e2a\u540d\u4e3a CUSTOMER_SERVICE_URL \u7684\u73af\u5883\u53d8\u91cf\uff0c\u5b83\u6307\u5411\u6211\u4eec\u63a5\u4e0b\u6765\u8981\u90e8\u7f72\u7684 customer \u670d\u52a1\u3002We\u5315Frontend\u4f7f\u7528\u8fd9\u4e2aURL\u6765\u8c03\u7528 Customers \u670d\u52a1\u3002 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a web-frontend.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f web-frontend.yaml \u521b\u5efa\u90e8\u7f72\u548c\u670d\u52a1\u3002 $ kubectl apply -f webfrontend-210121-151152.yaml deployment.apps/web-frontend created service/web-frontend created \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u90e8\u7f72 Customers \u670d\u52a1\u7684 v1 \u7248\u672c\u4e86\u3002\u6ce8\u610f\u6211\u4eec\u662f\u5982\u4f55\u5728Pod\u6a21\u677f\u4e2d\u8bbe\u7f6e version: v1 \u6807\u7b7e\u7684\u3002 \u7136\u800c\uff0c\u8be5\u670d\u52a1\u5728\u5176\u9009\u62e9\u5668\u4e2d\u53ea\u4f7f\u7528 app: customers \u3002 \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5c06\u5728 Destination Rule \u4e2d\u521b\u5efa\u5b50\u96c6\uff0c\u8fd9\u4e9b\u5b50\u96c6\u5c06\u5728\u9009\u62e9\u5668\u4e2d\u5e94\u7528\u989d\u5916\u7684\u7248\u672c\u6807\u7b7e\uff0c\u4f7f\u6211\u4eec\u80fd\u591f\u5230\u8fbe\u8fd0\u884c\u7279\u5b9a\u7248\u672c\u7684 Pod customers-v1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 $ kubectl apply -f customersvs-210121-151152.yaml virtualservice.networking.istio.io/customers created \u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a custmers-v1.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f customers-v1.yaml \u521b\u5efa\u90e8\u7f72\u548c\u670d\u52a1\u3002 \u6211\u4eec\u5e94\u8be5\u6709\u4e24\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u548c\u8fd0\u884c\uff1a $ kubectl get pod NAME READY STATUS RESTARTS AGE customers-v1-7b5b4b76fc-t8sgx 2/2 Running 0 23h web-frontend-69b64f974c-lplmx 2/2 Running 0 9m25s \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4e3a web-frontend \u521b\u5efa\u4e00\u4e2a VirtualService \uff0c\u5e76\u5c06\u5176\u7ed1\u5b9a\u5230Gateway\u8d44\u6e90\u4e0a\uff1a web-frontend-vs.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 $ kubectl apply -f webfrontendvs-210121-151152.yaml virtualservice.networking.istio.io/web-frontend created $ kubectl get vs NAME GATEWAYS HOSTS AGE web-frontend [\"gateway\"] [\"*\"] 12s \u521b\u5efaV1 and V2\u4e24\u4e2a\u5b50\u96c6 \u5982\u679c\u6211\u4eec\u90e8\u7f72\u4e86Customers\u670d\u52a1 v2 \u7248\u672c\uff0c\u6211\u4eec\u5728\u8c03\u7528 http://customers.default.svc.cluster.local \uff0c\u5f97\u5230\u7684\u56de\u5e94\u5c06\u662f\u968f\u673a\u7684\u3002\u5b83\u4eec\u8981\u4e48\u6765\u81ea Customers \u670d\u52a1\u7684 v2 \u7248\u672c\uff0c\u8981\u4e48\u6765\u81ea v1 \u7248\u672c\u3002 \u6211\u4eec\u9700\u8981\u4e3a Customers \u670d\u52a1\u521b\u5efa Destination Rule \uff0c\u5e76\u5b9a\u4e49\u4e24\u4e2a\u5b50\u96c6\uff0c\u4ee3\u8868 v1 \u548c v2 \u7248\u672c\u3002 \u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a VirtualService \uff0c\u5e76\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230v1\u7248\u672c\u7684\u5b50\u96c6\u3002 \u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e0d\u5f71\u54cd\u73b0\u6709\u670d\u52a1\u7684\u60c5\u51b5\u4e0b\u90e8\u7f72v2\u7248\u672c\u7684Customers\u670d\u52a1\u3002 \u8ba9\u6211\u4eec\u4ece Destination Rule \u548c\u4e24\u4e2a\u5b50\u96c6\u5f00\u59cb\uff1a customers-dr.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers spec: host: customers.default.svc.cluster.local subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 $ kubectl apply -f customersdr-210121-151152.yaml destinationrule.networking.istio.io/customers created \u6211\u4eec\u53ef\u4ee5\u521b\u5efa VirtualService \u5e76\u5728\u76ee\u6807\u4e2d\u6307\u5b9a v1 \u5b50\u96c6\uff1a customers-vs.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - customers.default.svc.cluster.local http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 $ kubectl get vs NAME GATEWAYS HOSTS AGE customers [\"customers.default.svc.cluster.local\"] 3s web-frontend [\"gateway\"] [\"*\"] 33m \u6bcf\u5f53\u6709\u8bf7\u6c42\u88ab\u53d1\u9001\u5230 Kubernetes Customers \u670d\u52a1\u65f6\uff0c\u5b83\u5c06\u88ab\u8def\u7531\u5230\u540c\u4e00\u670d\u52a1\u7684v1\u5b50\u96c6\u3002 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a customers-vs.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f customers-vs.yaml \u521b\u5efa VirtualService \u521b\u5efa V2 \u7684 Customers Deployment \u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u51c6\u5907\u597d\u90e8\u7f72 v2 \u7248\u7684 Customers \u670d\u52a1\u4e86\u3002 v2 \u7248\u672c\u8fd4\u56de\u4e0e\u524d\u4e00\u7248\u672c\u76f8\u540c\u7684\u5ba2\u6237\u5217\u8868\uff0c\u4f46\u5b83\u4e5f\u5305\u62ec\u57ce\u5e02\u540d\u79f0\u3002 \u8ba9\u6211\u4eec\u521b\u5efa Customers v2 \u90e8\u7f72\u3002\u6211\u4eec\u4e0d\u9700\u8981\u90e8\u7f72 Kubernetes \u670d\u52a1\uff0c\u56e0\u4e3a\u6211\u4eec\u5df2\u7ecf\u90e8\u7f72\u4e86\u4e00\u4e2av1\u7248\u672c\u7684\u670d\u52a1\u3002 customers-v2.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v2 labels: app: customers version: v2 spec: replicas: 1 selector: matchLabels: app: customers version: v2 template: metadata: labels: app: customers version: v2 spec: containers: - image: gcr.io/tetratelabs/customers:2.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 $ kubectl apply -f customersv2-210121-151152.yaml deployment.apps/customers-v2 created \u8be5\u90e8\u7f72\u4e0e v1 \u90e8\u7f72\u51e0\u4e4e\u76f8\u540c\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\u6240\u4f7f\u7528\u7684 Docker \u955c\u50cf\u7248\u672c\u548c\u8bbe\u7f6e\u5728\u7248\u672c\u6807\u7b7e\u4e0a\u7684 v2 \u503c\u3002 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a customers-v2.yaml \u521b\u5efa\u90e8\u7f72\u3002 \u5e76\u4f7f\u7528 kubectl apply -f customers-v2.yaml \u8ba9\u6211\u4eec\u4f7f\u7528 weight \u5b57\u6bb5\u5e76\u4fee\u6539 virtualService \uff0c\u4f7f 50\uff05 \u7684\u6d41\u91cf\u88ab\u53d1\u9001\u5230 v1\u5b50 \u96c6\uff0c\u53e6 50% \u53d1\u9001\u5230 v2 \u5b50\u96c6\u3002 \u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u7b2c\u4e8c\u4e2a destination \uff0c\u6709\u76f8\u540c\u7684\u4e3b\u673a\u540d\uff0c\u4f46\u6709\u4e0d\u540c\u7684\u5b50\u96c6\u3002\u6211\u4eec\u8fd8\u5c06\u4e3a destination \u6dfb\u52a0 weight:50 \uff0c\u4ee5\u4fbf\u5728\u4e24\u4e2a\u7248\u672c\u4e4b\u95f4\u5e73\u5747\u5206\u914d\u6d41\u91cf customers-50-50.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 weight: 50 - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v2 weight: 50 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a customers-50-50.yaml \u5e76\u4f7f\u7528 kubectl apply -f customers-50-50.yaml \u66f4\u65b0 VirtualService \u3002 \u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 GATEWAY_URL , \u5237\u65b0\u51e0\u6b21\u9875\u9762\uff0c\u770b\u770b\u4e0d\u540c\u7684\u54cd\u5e94\u3002\u6765\u81ea Customers v2 \u7684\u54cd\u5e94\u663e\u793a\u5728\u4e0b\u56fe\u4e2d $ kubectl get vs NAME GATEWAYS HOSTS AGE customers [\"customers.default.svc.cluster.local\"] 16m web-frontend [\"gateway\"] [\"*\"] 50m $ istioctl dashboard kiali http://localhost:20001/kiali \u4e3a\u4e86\u6539\u53d8\u53d1\u9001\u5230\u4e00\u4e2a\u6216\u53e6\u4e00\u4e2a\u7248\u672c\u7684\u6d41\u91cf\u6bd4\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u66f4\u65b0VirtualService\u3002\u540c\u6837\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u6dfb\u52a0 v3 \u6216 v4 \u7248\u672c\uff0c\u5e76\u5728\u8fd9\u4e9b\u7248\u672c\u4e4b\u95f4\u5206\u5272\u6d41\u91cf\u3002 \u6e05\u7406 \u5220\u9664Deployments\u3001 Services\u3001 VirtualServices\u3001 DestinationRule\u548cGateway : kubectl delete -f . 4\u3001\u9ad8\u7ea7\u6d41\u91cf\u8def\u7531 \u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u8bf7\u6c42\u5c5e\u6027\u591a\u4e2a\u670d\u52a1\u7248\u672c\u4e4b\u95f4\u8def\u7531\u6d41\u91cf\u3002 \u6211\u4eec\u5c06\u4ece\u90e8\u7f72Gateway\u5f00\u59cb\uff1a gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' kubectl apply -f 1gateway.yaml gateway.networking.istio.io/gateway created \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u90e8\u7f72Web\u524d\u7aef\u3001 Customersv1 \u3001 Customersv2 \uff0c\u4ee5\u53ca\u76f8\u5e94\u7684 Vi rtualServices \u548c Destination Rule \u3002\u4e00\u65e6\u4e00\u5207\u90e8\u7f72\u5b8c\u6bd5\uff0c\u6240\u6709\u6d41\u91cf\u5c06\u88ab\u8def\u7531\u5230 Customers v1 \u3002 webfrontend.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 $ kubectl apply -f 2webfrontend.yaml deployment.apps/web-frontend created service/web-frontend created virtualservice.networking.istio.io/web-frontend created apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- apiVersion: apps/v1 kind: Deployment metadata: name: customers-v2 labels: app: customers version: v2 spec: replicas: 1 selector: matchLabels: app: customers version: v2 template: metadata: labels: app: customers version: v2 spec: containers: - image: gcr.io/tetratelabs/customers:2.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers spec: host: customers.default.svc.cluster.local subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 $ kubectl apply -f 3customers.yaml deployment.apps/customers-v1 created deployment.apps/customers-v2 created service/customers created virtualservice.networking.istio.io/customers created destinationrule.networking.istio.io/customers created \u4e3a\u4e86\u786e\u4fdd\u4e00\u5207\u90e8\u7f72\u548c\u5de5\u4f5c\u6b63\u5e38\uff0c\u6253\u5f00 GATEWAY_URL \u5e94\u5e76\u786e\u4fdd\u6211\u4eec\u4ece Customersv1 \u83b7\u5f97\u54cd\u5e94 \u6211\u4eec\u5c06\u66f4\u65b0Customers\u7684VirtualService\uff0c\u5e76\u66f4\u65b0\u6d41\u91cf\u5728\u4e24\u4e2a\u7248\u672c\u7684Customers\u670d\u52a1\u4e4b\u95f4\u7684\u8def\u7531 \u8ba9\u6211\u4eec\u770b\u4e00\u4e0b YAML \uff0c \u5982\u679c\u8bf7\u6c42\u4e2d\u5305\u542b\u4e00\u4e2a header user debug \uff0c\u5c31\u628a\u6d41\u91cf\u8def\u7531\u5230 Customersv2 \u3002\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u8fd9\u4e2aheader\uff0c\u6211\u4eec\u5c31\u88ab\u8def\u7531\u5230 Customersv1 customersvs.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - match: - headers: user: exact: debug route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v2 - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 http: - match: - headers: user: exact: debug $ kubectl get vs NAME GATEWAYS HOSTS AGE customers [\"customers.default.svc.cluster.local\"] 9m2s web-frontend [\"gateway\"] [\"*\"] 11m http://127.0.0.1/ header \u5339\u914d apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - match: - headers: user: exact: debug route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v2 - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 $kubectl apply -f 4customersvs.yaml virtualservice.networking.istio.io/customers configured \u5982\u679c\u6211\u4eec\u4e0d\u63d0\u4f9b\u7aef\u53e3\u53f7\uff0c VirtualService \u4e2d\u7684\u76ee\u7684\u5730\u4e5f\u4f1a\u5de5\u4f5c\u3002\u8fd9\u662f\u56e0\u4e3a\u8be5\u670d\u52a1\u53ea\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7aef\u53e3\u3002 \u5982\u679c\u6211\u4eec\u6253\u5f00 GATEWAY_URL \uff0c\u6211\u4eec\u4ecd\u7136\u5e94\u8be5\u5f97\u5230\u6765\u81ea Customers v1 \u7684\u54cd\u5e94\u3002 \u5982\u679c\u6211\u4eec\u5728\u8bf7\u6c42\u4e2d\u6dfb\u52a0 header user: debug \uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230 customers \u7684\u54cd\u5e94\u662f\u6765\u81ea Customers v2 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 ModHeader \u6269\u5c55\u6765\u4fee\u6539\u6d4f\u89c8\u5668\u4e2d\u7684\u5934\u4fe1\u606f\u3002\u53e6\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 cURL \uff0c\u50cf\u8fd9\u6837\u628a\u5934\u4fe1\u606f\u6dfb\u52a0\u5230\u8bf7\u6c42\u4e2d\u3002 $ curl -H \"user: debug\" http://127.0.0.1/ ... &lt;th class=\"px-4 py-2\"&gt;CITY&lt;/th&gt; &lt;th class=\"px-4 py-2\"&gt;NAME&lt;/th&gt; ... \u5982\u679c\u6211\u4eec\u770b\u4e00\u4e0b\u56de\u590d\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u6709\u4e24\u680f CITY\u548cNAME\u3002 \u6e05\u7406 \u5220\u9664DepIoyment\u3001 Services\u3001 VirtualService\u3001 DestinationRule\u548cGateway: $ kubectl delete -f . 5\u3001\u6d41\u91cf\u7ba1\u7406\uff1a\u6d4b\u8bd5 1\u3001\u6211\u4eec\u53ef\u4ee5\u7528\u4ec0\u4e48\u8d44\u6e90\u914d\u7f6eIstlo ingress gateway? A Gateway B VirtualService C Deployment D Service Gateway : istio: ingressgateway 2\u3001\u4f7f\u7528Gateway\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u5c06\u6d41\u91cf\u8def\u7531\u5230Kubernetes\u5185\u90e8 \u7684\u4e00\u4e2a\u7279\u5b9a\u670d\u52a1\u3002\u5bf9\u8fd8\u662f\u9519\uff1f A \u5bf9 B \u9519 VirtualService 3\u3001Istio ingress \u7f51\u5173\u662f\u4f5c\u4e3a\u54ea\u79cd\u670d\u52a1\u7c7b\u578b\u90e8\u7f72\u7684\uff1f A ClusterIP B NodePort C Loadbalancer D \u4e0d\u662f\u4ee5Service\u5f62\u5f0f\u90e8\u7f72\u7684 4\u3001\u4e0b\u9762\u7684 VirtualService \u662f\u505a\u4ec0\u4e48\u7684\uff1f \u90e8\u7f72\u5728\u4e0a\u8ff0VirtualService\u65c1\u8fb9\u7684Gateway\u8d44\u6e90\uff1a A \u5c06\u6240\u6709\u8fdb\u5165\u7684\u6d41\u91cf\u901a\u8fc7ingress\u8def\u7531\u5230Orders\u670d\u52a1 B \u4ec0\u4e48\u4e5f\u4e0d\u505a\u3002\u5b83\u662f\u65e0\u6548\u7684\uff0c\u56e0\u4e3ahosts\u5b57\u6bb5\u88ab\u8bbe\u7f6e\u4e3a \uff0a \u3002 C Routes all traffic from the ingress gateway to the orders service \u5c06\u6240\u6709\u6d41\u91cf\u4ece\u5165\u53e3\u7f51\u5173\u8def\u7531\u5230Orders\u670d\u52a1 D \u865a\u62df\u670d\u52a1\u662f\u65e0\u6548\u7684\uff0c\u56e0\u4e3a\u5b83\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\u5730\u3002 5\u3001\u4f60\u53ef\u4ee5\u5728\u54ea\u4e2a\u8d44\u6e90\u4e2d\u4e3aHTTP\u6d41\u91cf\u6307\u5b9a\u8def\u7531\u89c4\u5219\uff1f A DestinationRule B VirtuaLService C Gateway D Deployment 6\u3001\u5982\u4f55\u5b9a\u4e49\u591a\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u4ee5\u4fbf\u80fd\u591f\u5728\u5b83\u4eec\u4e4b\u95f4\u8fdb\u884c\u6d41\u91cf\u8def\u7531\uff1f A \u4f7f\u7528Destination Rule\u548csubset B \u4f7f\u7528VirtualService destinations C \u5728Gateway\u5b9a\u4e49\u591a\u4e2ahost D \u5728Pod\u6a21\u677f\u4e2d\u4f7f\u7528\u6807\u7b7e 7\u3001\u5f53\u4f7f\u7528\u79bb\u7fa4\u68c0\u6d4b\u65f6\uff0c\u4e3b\u673a\u4f55\u65f6\u4f1a\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\uff1f A \u5f53\u4e0d\u54cd\u5e94\u65f6 B \u5f53\u8fd4\u56deHTTP 4xx\u9519\u8bef\u65f6 C \u5f53\u8fd4\u56deHTTP 5xx\u9519\u8bef\u65f6 D \u4e0d\u4f1a\u88ab\u5f39\u51fa 8\u3001\u5728\u79bb\u7fa4\u68c0\u6d4b\u914d\u7f6e\u4e2d\uff0c\u95f4\u9694\u8bbe\u7f6e\u6307\u7684\u662f\u4ec0\u4e48\uff1f A. \u79bb\u7fa4\u68c0\u6d4b\u5f00\u59cb\u6240\u9700\u7684\u65f6\u95f4 B. \u626b\u63cf\u4e0a\u6e38\u4e3b\u673a\u65f6\u95f4\u7684\u95f4\u9694 C. \u5f02\u5e38\u503c\u88ab\u5f39\u51fa\u7684\u65f6\u95f4\u95f4\u9694 D. \u5237\u65b0\u914d\u7f6e\u7684\u65f6\u95f4\u95f4\u9694 9\u3001\u80fd\u5c06\u6d41\u91cf\u7b56\u7565\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u7aef\u53e3\u5417\uff1f\uff08\u662f/\u5426\uff09 A \u80fd B \u4e0d\u80fd trafficPolicy: portLevelSettings: port 10\u3001 ISTIO_MUTUAL \u548c MUTUAL TLS \u6a21\u5f0f\u4e4b\u95f4\u6709\u4ec0\u4e48\u533a\u522b\uff1f A \u6ca1\u6709\u533a\u522b B ISTIO_MUTUAL \u9700\u8981\u751f\u4ea7istio\u914d\u7f6e\u6587\u4ef6\uff0c\u800cMUTUAL\u4e0d\u9700\u8981\u3002 C MUTUAL\u53ef\u4ee5\u4e0e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u4e00\u8d77\u4f7f\u7528\uff0c\u800c ISTIO_MUTUAL \u4e0d\u80fd D ISTIO_MUTUAL \u5728mTLS\u4e2d\u4f7f\u7528Istio\u7684\u8bc1\u4e66\uff0c\u800c\u5728 MUTUAL TLS \u4e2d\u4f60\u53ef\u4ee5\u7528\u4f60\u81ea\u5df1\u7684\u8bc1\u4e66 ISTIO_MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09 11. (Resiliency\uff09\u5c31\u662f\u8981\u907f\u514d\u548c\u9632\u6b62\u6545\u969c\u3002\u5bf9\u8fd8\u662f\u9519\uff1f A \u5bf9 B \u9519 \u8fd9\u4e0d\u662f\u4e3a\u4e86\u907f\u514d\u6545\u969c\uff0c\u800c\u662f\u4ee5\u4e00\u79cd\u6ca1\u6709\u505c\u673a\u6216\u6570\u636e\u4e22\u5931\u7684\u65b9\u5f0f\u6765\u5e94\u5bf9\u6545\u969c\u3002\u5f39\u6027\u7684\u76ee\u6807 \u662f\u5728\u6545\u969c\u53d1\u751f\u540e\u5c06\u670d\u52a1\u6062\u590d\u5230\u4e00\u4e2a\u5b8c\u5168\u6b63\u5e38\u7684\u72b6\u6001 12. Istio\u7684\u54ea\u4e24\u4e2a\u529f\u80fd\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u89e3\u51b3\u5f39\u6027\u95ee\u9898\uff1f A \u91cd\u8bd5\u7b56\u7565 B \u6d41\u91cf\u8def\u7531 C mTLS D \u8d85\u65f6 E \u6388\u6743\u7b56\u7565 13 \u6211\u4eec\u662f\u5426\u53ef\u4ee5\u4f7f\u7528\u6807\u5934\u6765\u6307\u5b9a\u53ef\u6536\u56de\u7684\u72b6\u6001\u4ee3\u7801\uff1f\uff08\u662f\uff0f\u5426\uff09 A \u662f B \u5426 \u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u53ea\u5728\u4e0a\u6e38\u670d\u52a1\u5668\u8fd4\u56de5xx\u54cd\u5e94\u4ee3\u7801\u65f6\u91cd\u8bd5\u8bf7\u6c42\uff0c\u6216\u8005\u53ea\u5728\u7f51\u5173\u9519\u8bef\uff08HTTP 5O2\u3001 503\u6216504\uff09\u65f6\u91cd\u8bd5\uff0c\u6216\u8005\u751a\u81f3\u5728\u8bf7\u6c42\u5934\u4e2d\u6307\u5b9a\u53ef\u91cd\u8bd5\u7684\u72b6\u6001\u4ee3\u7801\u3002 13 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f A \u4ec0\u4e48\u4e5f\u4e0d\u4f1a\u53d1\u751f\uff0c\u7aef\u70b9\u4fdd\u6301\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d B Pod\u91cd\u542f C \u4f60\u53ef\u4ee5\u914d\u7f6e\u91cd\u8bd5\u662f\u5426\u6392\u9664\u7aef\u70b9 D \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 \u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\u3002\u5f53Envoy\u91cd\u8bd5\u4e00\u4e2a\u5931\u8d25\u7684\u8bf7\u6c42\u65f6\uff0c \u6700\u521d\u5931\u8d25\u5e76\u5bfc\u81f4\u91cd\u8bd5\u7684\u7aef\u70b9\u5c31\u4e0d\u518d\u5305\u542b\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u4e86 \u3002\u5047\u8bbeKubernetes\u670d\u52a1\u67093\u4e2a\u7aef\u70b9\uff08Pod)\uff0c\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u4e86\uff0c \u5e76\u51fa\u73b0\u4e86\u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u4ee3\u7801 14 \u4f60\u80fd\u4e3a\u540c\u4e00\u4e2a\u8bf7\u6c42\u540c\u65f6\u6ce8\u5165\u5ef6\u8fdf\u548c\u4e2d\u6b62\u5417\uff1f\uff08\u662f/\u5426\uff09 A \u662f B \u5426 15 \u8003\u8651\u5230\u4e0b\u9762\u7684\u7247\u6bb5\uff0c\u6709\u591a\u5c11\u767e\u5206\u6bd4\u7684\u8bf7\u6c42\u4f1a\u88ab\u4e2d\u6b62\uff1f \u2026 fault: abort: httpStatus:404 A 0% B 100% C \u8be5\u7247\u6bb5\u662f\u65e0\u6548\u7684 D \u4e0d\u6e05\u695a\uff0c\u56e0\u4e3a\u767e\u5206\u6bd4\u672a\u6307\u5b9a \u5982\u679c\u6211\u4eec\u4e0d\u6307\u5b9a\u767e\u5206\u6bd4\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u4e2d\u6b62 16 \u6545\u969c\u6ce8\u5165\u662f\u5426\u89e6\u53d1\u91cd\u8bd5\u7b56\u7565\uff1f\uff08\u662f\uff0f\u5426\uff09 A \u662f B \u5426 \u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u5c06\u4e0d\u4f1a\u89e6\u53d1\u6211\u4eec\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u6ce8\u5165\u4e86\u4e00\u4e2aHTTP 500\u7684\u9519\u8bef\uff0c\u914d\u7f6e\u4e3aHTTP 500\u4e0a\u7684\u91cd\u8bd5\u7b56\u7565\u5c06\u4e0d\u4f1a\u88ab\u89e6\u53d1\u3002 17 \u4f60\u53ef\u4ee5\u4f7f\u7528 VirtualService \u4e2d\u7684\u54ea\u4e2a\u5b57\u6bb5\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230Kubernetes\u4e2d\u4e00\u4e2a\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\uff1f A destination B authority C redirect D host-redirect ... http: - match: - headers: my-header: exact: hello redirect: uri: /hello authority: my-service.default.svc.cluster.local:8000 ... 18 \u5728\u7f16\u5199\u5339\u914d\u89c4\u5219\u65f6\uff0c\u5982\u4f55\u8868\u8fbeAND\u548cOR\u7684\u8bed\u4e49 \uff1f A \u5bf9\u4e8eOR\uff0c\u4f60\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a\u5355\u72ec\u7684\u5339\u914d\u6761\u76ee\uff0c\u800c\u5bf9\u4e8eAND\uff0c\u4f60\u5728\u4e00\u4e2a\u5355\u4e00\u7684\u5339\u914d\u6761\u76ee\u4e2d\u5305\u62ec\u6240\u6709\u7684\u6761\u4ef6 B \u4f60\u4e0d\u80fd\u8fd9\u6837\u505a\u3002\u53ea\u5141\u8bb8\u4f7f\u7528OR\u8bed\u4e49 C \u4f60\u4e0d\u80fd\u8fd9\u6837\u505a\u3002\u53ea\u5141\u8bb8\u4f7f\u7528AND\u8bed\u4e49 D \u5bf9\u4e8eOR\uff0c\u5728\u4e00\u4e2a\u5355\u4e00\u7684\u5339\u914d\u6761\u76ee\u4e2d\u5305\u62ec\u6240\u6709\u6761\u4ef6\uff0c\u5bf9\u4e8eAND\uff0c\u6dfb\u52a0\u4e00\u4e2a\u5355\u72ec\u7684\u5339\u914d\u6761\u76ee 19 \u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u4f7f\u5916\u90e8\u670d\u52a1\u6210\u4e3a\u4f60\u7684\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206\uff1f A Service B ServiceEntry C VirtualService D Gateway \u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206 20 Envoy sidecar\u68c0\u67e5ServiceEntry\u8d44\u6e90\u4e2d\u7684hosts\u5b57\u6bb5\u7684\u987a\u5e8f\u662f\u4ec0\u4e48\uff1f A IP\u5730\u5740\u3001\u7aef\u53e3\u3001SNI\u3001HTTP B SNI\u3001 IP\u5730\u5740\u3001\u7aef\u53e3\u3001HTTP C HTTP\u3001 SNI\u3001 IP\u5730\u5740\u3001\u7aef\u53e3 D HTTP\u3001 IP\u5730\u5740\u3001\u7aef\u53e3\u3001SNI * HTTP Authority\u5934\uff08\u5728HTTP/2\u4e2d\uff09\u548cHost\u5934\uff08HTTP/1.1\u4e2d\uff09 * SNI * IP\u5730\u5740\u548c\u7aef\u53e3 21 ServiceEntry\u8d44\u6e90\u4e2d\u7684workloadSelector\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f A \u4ece\u5916\u90e8\u96c6\u7fa4\u4e2d\u9009\u62e9pod\u5e76\u4f7f\u5176\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 B \u9009\u62e9Kubernetes\u670d\u52a1\uff0c\u4f7f\u5176\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 C \u8981\u9009\u62e9WorkloadEntry\u8d44\u6e90\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 D ServiceEntry\u6ca1\u6709workloadSelector\u5b57\u6bb5 \u5728Workload Entry\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ec6\u8282\uff08\u540d\u79f0\u3001\u5730\u5740\u3001\u6807\u7b7e\uff09\uff0c\u7136\u540e\u4f7f\u7528ServiceEntry\u4e2d\u7684 workloadSelector \u5b57\u6bb5\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3a Istio \u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206\u3002 22 \u5982\u4f55\u914d\u7f6esidecar\u4ee3\u7406\uff0c\u4f7f\u5176\u53ea\u5bf9\u67d0\u4e9b\u670d\u52a1\u4f7f\u7528\u7279\u5b9a\u7684\u7aef\u53e3\uff1f A \u4f7f\u7528Proxy\u8d44\u6e90 B \u4f7f\u7528Filter\u8d44\u6e90 C \u4f7f\u7528VirtualService\u8d44\u6e90 D \u4f7f\u7528Sidecar\u8d44\u6e90 23 Sidecar\u8d44\u6e90\u4e2d\u7684Ingress\u548cegress\u76d1\u542c\u5668\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f A \u8981\u914d\u7f6e\u54ea\u4e9b\u6d41\u91cf\u662fsidecar\u963b\u65ad\u7684 B \u8981\u5c06ingress\u548cegress\u7f51\u5173\u8fde\u63a5\u5230Sidecar\u4e0a C \u5b9a\u4e49\u54ea\u4e9b\u5165\u7ad9\uff0f\u51fa\u7ad9\u6d41\u91cf\u88absidecar\u63a5\u53d7 D Ingress\u5b57\u6bb5\u7528\u4e8e\u914d\u7f6e\u8fdb\u5165sidecar\u7684\u6d41\u91cf\uff0c\u800cegress\u5b57\u6bb5\u662f\u4e0d\u53ef\u914d\u7f6e\u7684\u3002 . * Workload selector * Ingress listener * Egress listener 24 EnvoyFilters\u662f\u5426\u7528\u4e8e\u5b9a\u5236\u7531Pilot\u751f\u6210\u7684Envoy\u914d\u7f6e\uff1f \uff08\u662f\uff0f\u5426\uff09 A \u662f B \u5426 EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531 Istio Pilot \u751f\u6210\u7684Envoy\u914d\u7f6e 25 \u5f53\u6709\u591a\u4e2aEnvoyFilter\u90e8\u7f72\u65f6\uff0c\u54ea\u4e9b\u8fc7\u6ee4\u5668\u4f1a\u5148\u88ab\u5e94\u7528\uff1f A default\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fc7\u6ee4\u5668 B \u6839\uff08\u5982istio-system)\u547d\u540d\u7a7a\u95f4\u7684\u8fc7\u6ee4\u5668 C \u5b83\u4eec\u662f\u6309\u5b57\u6bcd\u987a\u5e8f\u5e94\u7528\u7684 D \u5b83\u4eec\u662f\u6839\u636epriority\u5b57\u6bb5\u6765\u5e94\u7528\u7684 \u6839\u547d\u540d\u7a7a\u95f4\uff08\u4f8b\u5982 istio-system )\u4e2d\u7684\u8fc7\u6ee4\u5668\u9996\u5148\u88ab\u5e94\u7528\uff0c\u7136\u540e\u662f\u5de5\u4f5c\u8d1f\u8f7d\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u5339\u914d\u8fc7\u6ee4\u5668\u3002 26 \u5982\u4f55\u5c06VirtualService\u4e0eGateway\u7ed1\u5b9a\uff1f A VirtualService\u4e2d\u7684hosts\u5b57\u6bb5 B \u5c06VirtualService\u548cGateway\u5728\u540c\u4e00\u6587\u4ef6\u4e2d\u90e8\u7f72 C \u65e0\u6cd5\u505a\u5230 D \u4f7f\u7528gateways\u5b57\u6bb5 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: hello-world spec: hosts: - \"*\" gateways: - gateway http: ... 27 \u53ef\u4ee5\u5728VirtualService\u4e2d\u914d\u7f6e\u6d41\u91cf\u7b56\u7565\u3002\u5bf9\u8fd8\u662f\u9519\uff1f A \u5bf9 B \u9519 28 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48 \uff1f A \u4ec0\u4e48\u4e5f\u4e0d\u4f1a\u53d1\u751f\uff0c\u7aef\u70b9\u4fdd\u6301\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d B Pod\u91cd\u542f C \u4f60\u53ef\u4ee5\u914d\u7f6e\u662f\u5426\u6392\u9664\u7aef\u70b9 D \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 29 \u4f60\u53ef\u4ee5\u7528Workload Entry\u8d44\u6e90\u505a\u4ec0\u4e48\uff1f A \u5411Pod\u4e2d\u6ce8\u5165\u6545\u969c B \u914d\u7f6e\u5916\u90e8API C \u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5411Kubernetes\u7684\u8fc1\u79fb D \u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6d41\u91cf\u8def\u7531","title":"\u7b2c\u4e94\u8282 \u6d41\u91cf\u7ba1\u7406\u5b9e\u9a8c\u4e0e\u6d4b\u8bd5"},{"location":"chap8/5Istio_net_control_exp/#_1","text":"","title":"\u7b2c\u4e94\u8282 \u6d41\u91cf\u7ba1\u7406\u5b9e\u9a8c\u4e0e\u6d4b\u8bd5"},{"location":"chap8/5Istio_net_control_exp/#1","text":"\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e00\u4e2aHello World\u5e94\u7528\u7a0b\u5e8f\u3002 \u7136\u540e\u6211\u4eec\u5c06\u90e8\u7f72\u4e00\u4e2a Gateway\u8d44\u6e90\u548c\u4e00\u4e2a\u4e0eGateway\u7ed1\u5b9a\u7684VirtualService\uff0c\u4ee5\u4fbf\u5728\u5916\u90e8IP\u5730\u5740\u4e0a\u516c\u5f00\u8be5\u5e94\u7528\u7a0b\u5e8f\u3002 \u8ba9\u6211\u4eec\u5148\u4ece\u90e8\u7f72Gateway\u8d44\u6e90\u5f00\u59cb\u3002\u6211\u4eec\u5c06\u628a hosts \u5b57\u6bb5\u8bbe\u7f6e\u4e3a \uff0a \uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4ece\u5916\u90e8IP\u5730\u5740\u8bbf\u95ee\u5165\u53e3\u7f51\u5173\u3002\u5982\u679c\u6211\u4eec\u60f3\u901a\u8fc7\u57df\u540d\u8bbf\u95ee\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06 hosts \u7684\u503c\u8bbe\u7f6e\u4e3a\u57df\u540d\uff08\u4f8b\u5982 example.com )\uff0c\u7136\u540e\u5c06\u5916\u90e8IP\u5730\u5740\u6dfb\u52a0\u5230\u8be5\u57df\u540d\u7684A\u8bb0\u5f55\u4e2d\u3002 gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' $ kubectl apply -f gateway-210119-085144.yaml gateway.networking.istio.io/gateway created \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a gateway.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f gateway.yaml \u90e8\u7f72\u8be5\u7f51\u5173\u3002 \u5982\u679c\u6211\u4eec\u8bd5\u56fe\u8bbf\u95ee\u5165\u53e3\u7f51\u5173\u7684\u5916\u90e8IP\u5730\u5740\uff0c\u6211\u4eec\u5c06\u5f97\u5230\u4e00\u4e2a HTTP 404 \uff0c\u56e0\u4e3a\u6ca1\u6709\u4efb\u4f55\u7ed1\u5b9a\u5230\u7f51\u5173\u7684 VirtualService \u3002\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u8def\u7531\uff0c\u6240\u4ee5\u5165\u53e3\u4ee3\u7406\u4e0d\u77e5\u9053\u8981\u628a\u6d41\u91cf\u8def\u7531\u5230\u54ea\u91cc\u3002 \u8981\u83b7\u5f97\u5165\u53e3\u7f51\u5173\u7684\u5916\u90e8iP\u5730\u5740\uff0c\u8bf7\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5e76\u67e5\u770b EXTERNAL-IP \u5217\u7684\u503c\uff1a $ kubectl get svc -l=istio=ingressgateway -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-ingressgateway LoadBalancer 10.105.159.70 localhost 15021:31875/TCP,80:32344/TCP,443:31252/TCP,31400:31315/TCP,15443:31199/TCP 7d5h \u5728\u6574\u4e2a\u8bfe\u7a0b\u7684\u5176\u4f59\u90e8\u5206\uff0c\u5f53\u6211\u4eec\u8c08\u5230\u5165\u53e3\u7f51\u5173\u7684\u5916\u90e8IP\u65f6\uff0c\u6211\u4eec\u5c06\u5728\u4f8b\u5b50\u548c\u6587\u672c\u4e2d\u4f7f\u7528 GATEWAY URL \u3002 \u4e0b\u4e00\u6b65\u662f\u521b\u5efa Hello World \u90e8\u7f72\u548c\u670d\u52a1\u3002 Hello world \u5e94\u7528\u7a0b\u5e8f\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u7f51\u7ad9\uff0c\u53ea\u662f\u6e32\u67d3 \"Hello world\" hello-world.yaml apiVersion: apps/v1 kind: Deployment metadata: name: hello-world labels: app: hello-world spec: replicas: 1 selector: matchLabels: app: hello-world template: metadata: labels: app: hello-world spec: containers: - image: gcr.io/tetratelabs/hello-world:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: hello-world labels: app: hello-world spec: selector: app: hello-world ports: - port: 80 name: http targetPort: 3000 $ kubectl get pod,svc -l=app=hello-world NAME READY STATUS RESTARTS AGE pod/hello-world-85c8685dd-gf9xf 2/2 Running 0 5m4s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/hello-world ClusterIP 10.102.151.188 <none> 80/TCP 5m4s \u4e0b\u4e00\u6b65\u662f\u4e3a hello-world \u670d\u52a1\u521b\u5efa\u4e00\u4e2a VirtualService \uff0c\u5e76\u5c06\u5176\u7ed1\u5b9a\u5230 Gateway \u8d44\u6e90\u4e0a\uff1a apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: hello-world spec: hosts: - \"*\" gateways: - gateway http: - route: - destination: host: hello-world.default.svc.cluster.local port: number: 80 \u6211\u4eec\u5728 hosts \u5b57\u6bb5\u4e2d\u4f7f\u7528 * \uff0c\u5c31\u50cf\u6211\u4eec\u5728Gateway\u4e2d\u505a\u7684\u90a3\u6837\u3002\u6211\u4eec\u8fd8\u5c06\u4e4b\u524d\u521b\u5efa\u7684 Gateway \u8d44\u6e90\uff08gateway\uff09\u6dfb\u52a0\u5230 gateways \u6570\u7ec4\u4e2d\u3002 \u6700\u540e\uff0c\u6211\u4eec\u6307\u5b9a\u4e86\u4e00\u4e2a\u76ee\u7684\u5730\u4e3a Kubernetes \u670d\u52a1 hello-world.default.svc.cluster.local \u7684\u5355\u4e00\u8def\u7531\u3002 \u5c06\u4e0a\u8ff0 YAML \u4fdd\u5b58\u4e3a vs-hello-world.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f vs-hello-world.yaml \u521b\u5efaVirtualService\u3002 \u5982\u679c\u4f60\u770b\u4e00\u4e0b\u90e8\u7f72\u7684 VirtualService , \u4f60\u5e94\u8be5\u770b\u5230\u7c7b\u4f3c\u7684\u8f93\u51fa\uff1a $ kubectl get vs NAME GATEWAYS HOSTS AGE hello-world [\"gateway\"] [\"*\"] 25s \u5982\u679c\u6211\u4eec\u5bf9 GATEWAY URL \u8fd0\u884c cURL \u6216\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u5b83\uff0c\u6211\u4eec\u5c06\u5f97\u5230 Hello World \u7684\u54cd\u5e94\uff1a curl -v http://localhost * Trying 127.0.0.1:80... * TCP_NODELAY set * Connected to localhost (127.0.0.1) port 80 (#0) > GET / HTTP/1.1 > Host: localhost > User-Agent: curl/7.65.1 > Accept: */* > * Mark bundle as not supporting multiuse < HTTP/1.1 200 OK < date: Sat, 09 Oct 2021 14:17:41 GMT < content-length: 11 < content-type: text/plain; charset=utf-8 < x-envoy-upstream-service-time: 25 < server: istio-envoy < * Connection #0 to host localhost left intact Hello World \u53e6\u5916\uff0c\u6ce8\u610f\u5230server\u5934\u8bbe\u7f6e\u4e3aistio-envoy\uff0c\u544a\u8bc9\u6211\u4eec\u8be5\u8bf7\u6c42\u901a\u8fc7\u4e86Envoy\u4ee3\u7406\u3002 \u6e05\u7406 \u5220\u9664Deployment\u3001 Services VirtualService\u548cGateway $ kubectl delete deploy hello-world deployment.apps \"hello-world\" deleted $ kubectl delete service hello-world service \"hello-world\" deleted $ kubectl delete vs hello-world virtualservice.networking.istio.io \"hello-world\" deleted $ kubectl delete gateway gateway gateway.networking.istio.io \"gateway\" deleted","title":"1\u3001\u521b\u5efa\u90e8\u7f72\u5e76\u4f7f\u7528\u7f51\u5173\u66b4\u9732"},{"location":"chap8/5Istio_net_control_exp/#2grafana-zipkinkiali","text":"\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c \u6211\u4eec\u5c06\u90e8\u7f72Web\u524d\u7aef\u548c Customer V1 \u670d\u52a1\u3002\u7136\u540e\uff0c\u6211\u4eec\u5c06\u5728Zipkin\u3001 Kiali \u548cGrafana\u4e2d\u6ce8\u5165\u6545\u969c\u548c\u5ef6\u8fdf\uff0c\u5e76\u89c2\u5bdf\u5b83\u4eec\u3002 gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' $ kubectl get svc -l=istio=ingressgateway -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-ingressgateway LoadBalancer 10.105.159.70 localhost 15021:31875/TCP,80:32344/TCP,443:31252/TCP,31400:31315/TCP,15443:31199/TCP 8d \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a gateway.yaml \u5e76\u4f7f\u7528 kubectl apply -f gateway.yaml \u521b\u5efa\u7f51\u5173\u3002 \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u90e8\u7f72 Web Frontend \u3001 Service \u548c VirtualService web-frontend.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: containers: - image: pj3677/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 $ kubectl get vs NAME GATEWAYS HOSTS AGE web-frontend [\"gateway\"] [\"*\"] 83s \u5c06\u4e0a\u8ff0 YAML \u4fdd\u5b58\u4e3a web-frontend.yaml \uff0c\u5e76\u4f7f\u7528 kubect1 apply -f web-frontend.yaml \u521b\u5efa\u8d44\u6e90\u3002 \u6700\u540e\uff0c\u6211\u4eec\u5c06\u90e8\u7f72 Customers v1 \u548c\u76f8\u5e94\u7684\u8d44\u6e90\u3002 customers-default.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers spec: host: customers.default.svc.cluster.local subsets: - name: v1 labels: version: v1 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 $ kubectl apply -f customers-210121-151301.yaml deployment.apps/customers-v1 created service/customers created destinationrule.networking.istio.io/customers created virtualservice.networking.istio.io/customers created","title":"2\u3001\u5728Grafana\u3001 Zipkin\u548cKiali\u4e2d\u89c2\u5bdf\u6545\u969c\u6ce8\u5165\u548c\u5ef6\u8fdf\u60c5\u51b5"},{"location":"chap8/5Istio_net_control_exp/#delay-inject","text":"customers-delay.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 fault: delay: percent: 50 fixedDelay: 5s $ kubectl apply -f customersdelay-210121-151301.yaml virtualservice.networking.istio.io/customers configured \u5c06\u4e0a\u8ff0 YAML \u4fdd\u5b58\u4e3a customers-delay.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f customers-delay.yaml \u66f4\u65b0 VirtualService \u3002 \u4e3a\u4e86\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf\uff0c\u8ba9\u6211\u4eec\u6253\u5f00\u4e00\u4e2a\u5355\u72ec\u7684\u7ec8\u7aef\u7a97\u53e3\uff0c\u5f00\u59cb\u5411 GATEWAY URL \u53d1\u51fa\u65e0\u7a77\u7684\u5faa\u73af\u8bf7\u6c42\u3002 while true; do curl http://$GATEWAY_URL/; done while true; do curl http://127.0.0.1/; done \u6211\u4eec\u5e94\u8be5\u5f00\u59cb\u6ce8\u610f\u5230\u4e00\u4e9b\u8bf7\u6c42\u7684\u65f6\u95f4\u6bd4\u5e73\u65f6\u957f\u3002\u8ba9\u6211\u4eec\u6253\u5f00Grafana\u5e76\u89c2\u5bdf\u8fd9\u4e9b\u5ef6\u8fdf\u3002 $ istioctl dash grafana http://localhost:3000 \u5f53Grafana\u6253\u5f00\u65f6\uff0c\u70b9\u51fb\u4e3b\u9875\u548c Istio Service Dashboard \u3002\u5728\u4eea\u8868\u677f\u4e0a\uff0c\u786e\u4fdd\u5728\u670d\u52a1\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9 customers.default.svc.cluster.local \u5982\u679c\u4f60\u5c55\u5f00 Client Workload \u9762\u677f\uff0c\u4f60\u4f1a\u53d1\u73b0\u5ba2\u6237\u7aef\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u56fe\u4e0a\u7684\u6301\u7eed\u65f6\u95f4\u589e\u52a0\u4e86\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u4f60\u53ef\u4ee5\u6ce8\u610f\u5230 web-frontend.default.svc.cluster.local \u670d\u52a1\u65b9\u9762\u4e5f\u6709\u540c\u6837\u7684\u5ef6\u8fdf\u3002 \u8ba9\u6211\u4eec\u770b\u770b\u8fd9\u4e2a\u5ef6\u8fdf\u5728 Zipkin \u4e2d\u662f\u5982\u4f55\u663e\u793a\u7684\u3002 \u7528 istioctl dash zipkin \u6253\u5f00Zipkin\u3002 \u5728\u4e3b\u5c4f\u5e55\u4e0a\uff0c\u9009\u62e9 serviceName \u548c web-frontend.default \uff0c\u7136\u540e\u6dfb\u52a0 minDuration \u6761\u4ef6\uff0c \u8f93\u5165 5S \uff0c\u70b9\u51fb\u641c\u7d22\u6309\u94ae\uff0c\u627e\u5230 trace \u70b9\u51fb\u5176\u4e2d\u4e00\u4e2atrace\uff0c\u6253\u5f00\u8be6\u7ec6\u4fe1\u606f\u9875\u9762\u3002\u5728\u8be6\u60c5\u9875\u4e0a\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6301\u7eed\u65f6\u95f4\u662f5\u79d2\u3002 \u5355\u4e2atrace\u67094\u4e2aspan\u2014\u2014\u70b9\u51fb3\u4e2a\u8de8\u5ea6\uff0c\u4ee3\u8868\u4ece web-frontend \u5230\u5ba2\u6237\u670d\u52a1\u7684\u8bf7\u6c42\u3002 \u4f60\u4f1a\u6ce8\u610f\u5230\u5728\u7ec6\u8282\u4e2d\uff0c response_flags \u6807\u7b7e\u8bbe\u7f6e\u4e3a DI \u3002 \"DI\u201d\u4ee3\u8868\u201d\u5ef6\u8fdf\u6ce8\u5165\u201d\uff0c\u8868\u793a\u8be5\u8bf7\u6c42\u88ab\u5ef6\u8fdf\u4e86 \u3002","title":"Delay inject\uff08\u5ef6\u8fdf\u6ce8\u5165\uff09"},{"location":"chap8/5Istio_net_control_exp/#fault-inject","text":"\u8ba9\u6211\u4eec\u518d\u6b21\u66f4\u65b0 VirtualService \uff0c\u8fd9\u4e00\u6b21\uff0c\u6211\u4eec\u5c06\u6ce8\u5165\u4e00\u4e2a\u6545\u969c\uff0c\u5bf950\uff05\u7684\u8bf7\u6c42\u8fd4\u56de HTTP 500 \u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 fault: abort: httpStatus: 500 percentage: value: 50 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a customers\u4e00fault.yaml \uff0c\u7136\u540e\u7528 kubectl apply -f customers-fault.yaml \u66f4\u65b0 VirtualService \u3002 \u5c31\u50cf\u524d\u9762\u4e00\u6837\uff0c\u6211\u4eec\u5c06\u5f00\u59cb\u6ce8\u610f\u5230\u6765\u81ea\u8bf7\u6c42\u5faa\u73af\u7684\u5931\u8d25\u3002\u5982\u679c\u6211\u4eec\u56de\u5230Grafana\u5e76\u6253\u5f00 Istio Service Dashboard \uff0c \u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u5ba2\u6237\u7aef\u7684\u6210\u529f\u7387\u5728\u4e0b\u964d\uff0c\u5e76\u4e14\u5728\u6309\u6765\u6e90\u548c\u54cd\u5e94\u4ee3\u7801\u5212\u5206\u7684\u4f20\u5165\u8bf7\u6c42\u56fe\u4e0a 500 \u54cd\u5e94\u5728\u589e\u52a0\uff0c\u5982\u56fe\u6240\u793a\u3002 $ kubectl apply -f customersfault-210121-151301.yaml virtualservice.networking.istio.io/customers configured \u5728Zipkin\u4e2d\u4e5f\u6709\u7c7b\u4f3c\u7684\u60c5\u51b5\u3002\u5982\u679c\u6211\u4eec\u518d\u6b21\u641c\u7d22 trace \uff08\u6211\u4eec\u53ef\u4ee5\u5220\u9664\u6700\u5c0f\u6301\u7eed\u65f6\u95f4\uff09\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u6709\u9519\u8bef\u7684trace\u4f1a\u4ee5\u7ea2\u8272\u663e\u793a\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u8ba9\u6211\u4eec\u4e5f\u6253\u5f00Kiali ( istioctl dash kiali )\uff0c\u901a\u8fc7\u70b9\u51fbGraph\u9879\u67e5\u770b\u670d\u52a1\u56fe\u3002\u4f60\u4f1a\u6ce8\u610f\u5230web- frontend\u670d\u52a1\u6709\u4e00\u4e2a\u7ea2\u8272\u7684\u8fb9\u6846\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u5982\u679c\u6211\u4eec\u70b9\u51fb web-frontend \u670d\u52a1\uff0c\u770b\u770b\u53f3\u8fb9\u7684\u4fa7\u8fb9\u680f\uff0c\u4f60\u4f1a\u53d1\u73b0HTTP\u8bf7\u6c42\u7684\u7ec6\u8282\u3002\u56fe\u4e2d\u663e\u793a\u4e86\u6210\u529f\u548c\u5931\u8d25\u7684\u767e\u5206\u6bd4\uff0c\u8fd9\u4e24\u4e2a\u6570\u5b57\u90fd\u572850\uff05\u5de6\u53f3\uff0c\u8fd9\u4e0e\u6211\u4eec\u5728VirtualService\u4e2d\u8bbe\u7f6e \u7684\u767e\u5206\u6bd4\u503c\u76f8\u4e00\u81f4\u3002","title":"Fault inject\uff08\u6545\u969c\u6ce8\u5165\uff09"},{"location":"chap8/5Istio_net_control_exp/#_2","text":"\u5220\u9664DepIoyment\u3001 Services VirtuaIService\u3001 DestinationRule\u548cGateway $ kubectl delete deploy web-frontend deployment.apps \"web-frontend\" deleted $ kubectl delete svc customers web-frontend service \"customers\" deleted service \"web-frontend\" deleted $ kubectl delete vs customers web-frontend virtualservice.networking.istio.io \"customers\" deleted virtualservice.networking.istio.io \"web-frontend\" deleted $ kubectl delete gateway gateway gateway.networking.istio.io \"gateway\" deleted","title":"\u6e05\u7406"},{"location":"chap8/5Istio_net_control_exp/#3","text":"\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u6743\u91cd\u5728\u4e0d\u540c\u7684\u670d\u52a1\u7248\u672c\u4e4b\u95f4\u8def\u7531\u6d41\u91cf\u3002\u7136\u540e\uff0c\u6211\u4eec\u5c06\u90e8\u7f72 Customers \u670d\u52a1\u7248\u672c v2 \uff0c\u5e76\u4f7f\u7528\u5b50\u96c6\u5728\u8fd9\u4e24\u4e2a\u7248\u672c\u4e4b\u95f4\u5206\u914d\u6d41\u91cf\u3002 \u8ba9\u6211\u4eec\u4ece\u90e8\u7f72Gateway\u5f00\u59cb gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u521b\u5efa Web Frontend \u548c Customers \u670d\u52a1\u7684\u90e8\u7f72\u4ee5\u53ca\u76f8\u5e94\u7684 Kubernetes \u670d\u52a1\u3002\u8ba9\u6211\u4eec\u9996\u5148\u4ece web-frontend \u5f00\u59cb\uff1a web-frontend.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 \u6ce8\u610f\uff0c\u6211\u4eec\u6b63\u5728\u8bbe\u7f6e\u4e00\u4e2a\u540d\u4e3a CUSTOMER_SERVICE_URL \u7684\u73af\u5883\u53d8\u91cf\uff0c\u5b83\u6307\u5411\u6211\u4eec\u63a5\u4e0b\u6765\u8981\u90e8\u7f72\u7684 customer \u670d\u52a1\u3002We\u5315Frontend\u4f7f\u7528\u8fd9\u4e2aURL\u6765\u8c03\u7528 Customers \u670d\u52a1\u3002 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a web-frontend.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f web-frontend.yaml \u521b\u5efa\u90e8\u7f72\u548c\u670d\u52a1\u3002 $ kubectl apply -f webfrontend-210121-151152.yaml deployment.apps/web-frontend created service/web-frontend created \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u90e8\u7f72 Customers \u670d\u52a1\u7684 v1 \u7248\u672c\u4e86\u3002\u6ce8\u610f\u6211\u4eec\u662f\u5982\u4f55\u5728Pod\u6a21\u677f\u4e2d\u8bbe\u7f6e version: v1 \u6807\u7b7e\u7684\u3002 \u7136\u800c\uff0c\u8be5\u670d\u52a1\u5728\u5176\u9009\u62e9\u5668\u4e2d\u53ea\u4f7f\u7528 app: customers \u3002 \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5c06\u5728 Destination Rule \u4e2d\u521b\u5efa\u5b50\u96c6\uff0c\u8fd9\u4e9b\u5b50\u96c6\u5c06\u5728\u9009\u62e9\u5668\u4e2d\u5e94\u7528\u989d\u5916\u7684\u7248\u672c\u6807\u7b7e\uff0c\u4f7f\u6211\u4eec\u80fd\u591f\u5230\u8fbe\u8fd0\u884c\u7279\u5b9a\u7248\u672c\u7684 Pod customers-v1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 $ kubectl apply -f customersvs-210121-151152.yaml virtualservice.networking.istio.io/customers created \u5c06\u4e0a\u8ff0\u5185\u5bb9\u4fdd\u5b58\u4e3a custmers-v1.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f customers-v1.yaml \u521b\u5efa\u90e8\u7f72\u548c\u670d\u52a1\u3002 \u6211\u4eec\u5e94\u8be5\u6709\u4e24\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u548c\u8fd0\u884c\uff1a $ kubectl get pod NAME READY STATUS RESTARTS AGE customers-v1-7b5b4b76fc-t8sgx 2/2 Running 0 23h web-frontend-69b64f974c-lplmx 2/2 Running 0 9m25s \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4e3a web-frontend \u521b\u5efa\u4e00\u4e2a VirtualService \uff0c\u5e76\u5c06\u5176\u7ed1\u5b9a\u5230Gateway\u8d44\u6e90\u4e0a\uff1a web-frontend-vs.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 $ kubectl apply -f webfrontendvs-210121-151152.yaml virtualservice.networking.istio.io/web-frontend created $ kubectl get vs NAME GATEWAYS HOSTS AGE web-frontend [\"gateway\"] [\"*\"] 12s","title":"3\u3001\u7b80\u5355\u6d41\u91cf\u8def\u7531"},{"location":"chap8/5Istio_net_control_exp/#v1-and-v2","text":"\u5982\u679c\u6211\u4eec\u90e8\u7f72\u4e86Customers\u670d\u52a1 v2 \u7248\u672c\uff0c\u6211\u4eec\u5728\u8c03\u7528 http://customers.default.svc.cluster.local \uff0c\u5f97\u5230\u7684\u56de\u5e94\u5c06\u662f\u968f\u673a\u7684\u3002\u5b83\u4eec\u8981\u4e48\u6765\u81ea Customers \u670d\u52a1\u7684 v2 \u7248\u672c\uff0c\u8981\u4e48\u6765\u81ea v1 \u7248\u672c\u3002 \u6211\u4eec\u9700\u8981\u4e3a Customers \u670d\u52a1\u521b\u5efa Destination Rule \uff0c\u5e76\u5b9a\u4e49\u4e24\u4e2a\u5b50\u96c6\uff0c\u4ee3\u8868 v1 \u548c v2 \u7248\u672c\u3002 \u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a VirtualService \uff0c\u5e76\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230v1\u7248\u672c\u7684\u5b50\u96c6\u3002 \u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e0d\u5f71\u54cd\u73b0\u6709\u670d\u52a1\u7684\u60c5\u51b5\u4e0b\u90e8\u7f72v2\u7248\u672c\u7684Customers\u670d\u52a1\u3002 \u8ba9\u6211\u4eec\u4ece Destination Rule \u548c\u4e24\u4e2a\u5b50\u96c6\u5f00\u59cb\uff1a customers-dr.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers spec: host: customers.default.svc.cluster.local subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 $ kubectl apply -f customersdr-210121-151152.yaml destinationrule.networking.istio.io/customers created \u6211\u4eec\u53ef\u4ee5\u521b\u5efa VirtualService \u5e76\u5728\u76ee\u6807\u4e2d\u6307\u5b9a v1 \u5b50\u96c6\uff1a customers-vs.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - customers.default.svc.cluster.local http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 $ kubectl get vs NAME GATEWAYS HOSTS AGE customers [\"customers.default.svc.cluster.local\"] 3s web-frontend [\"gateway\"] [\"*\"] 33m \u6bcf\u5f53\u6709\u8bf7\u6c42\u88ab\u53d1\u9001\u5230 Kubernetes Customers \u670d\u52a1\u65f6\uff0c\u5b83\u5c06\u88ab\u8def\u7531\u5230\u540c\u4e00\u670d\u52a1\u7684v1\u5b50\u96c6\u3002 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a customers-vs.yaml \uff0c\u5e76\u4f7f\u7528 kubectl apply -f customers-vs.yaml \u521b\u5efa VirtualService","title":"\u521b\u5efaV1 and V2\u4e24\u4e2a\u5b50\u96c6"},{"location":"chap8/5Istio_net_control_exp/#v2-customers-deployment","text":"\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u51c6\u5907\u597d\u90e8\u7f72 v2 \u7248\u7684 Customers \u670d\u52a1\u4e86\u3002 v2 \u7248\u672c\u8fd4\u56de\u4e0e\u524d\u4e00\u7248\u672c\u76f8\u540c\u7684\u5ba2\u6237\u5217\u8868\uff0c\u4f46\u5b83\u4e5f\u5305\u62ec\u57ce\u5e02\u540d\u79f0\u3002 \u8ba9\u6211\u4eec\u521b\u5efa Customers v2 \u90e8\u7f72\u3002\u6211\u4eec\u4e0d\u9700\u8981\u90e8\u7f72 Kubernetes \u670d\u52a1\uff0c\u56e0\u4e3a\u6211\u4eec\u5df2\u7ecf\u90e8\u7f72\u4e86\u4e00\u4e2av1\u7248\u672c\u7684\u670d\u52a1\u3002 customers-v2.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v2 labels: app: customers version: v2 spec: replicas: 1 selector: matchLabels: app: customers version: v2 template: metadata: labels: app: customers version: v2 spec: containers: - image: gcr.io/tetratelabs/customers:2.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 $ kubectl apply -f customersv2-210121-151152.yaml deployment.apps/customers-v2 created \u8be5\u90e8\u7f72\u4e0e v1 \u90e8\u7f72\u51e0\u4e4e\u76f8\u540c\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\u6240\u4f7f\u7528\u7684 Docker \u955c\u50cf\u7248\u672c\u548c\u8bbe\u7f6e\u5728\u7248\u672c\u6807\u7b7e\u4e0a\u7684 v2 \u503c\u3002 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a customers-v2.yaml \u521b\u5efa\u90e8\u7f72\u3002 \u5e76\u4f7f\u7528 kubectl apply -f customers-v2.yaml \u8ba9\u6211\u4eec\u4f7f\u7528 weight \u5b57\u6bb5\u5e76\u4fee\u6539 virtualService \uff0c\u4f7f 50\uff05 \u7684\u6d41\u91cf\u88ab\u53d1\u9001\u5230 v1\u5b50 \u96c6\uff0c\u53e6 50% \u53d1\u9001\u5230 v2 \u5b50\u96c6\u3002 \u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u7b2c\u4e8c\u4e2a destination \uff0c\u6709\u76f8\u540c\u7684\u4e3b\u673a\u540d\uff0c\u4f46\u6709\u4e0d\u540c\u7684\u5b50\u96c6\u3002\u6211\u4eec\u8fd8\u5c06\u4e3a destination \u6dfb\u52a0 weight:50 \uff0c\u4ee5\u4fbf\u5728\u4e24\u4e2a\u7248\u672c\u4e4b\u95f4\u5e73\u5747\u5206\u914d\u6d41\u91cf customers-50-50.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 weight: 50 - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v2 weight: 50 \u5c06\u4e0a\u8ff0YAML\u4fdd\u5b58\u4e3a customers-50-50.yaml \u5e76\u4f7f\u7528 kubectl apply -f customers-50-50.yaml \u66f4\u65b0 VirtualService \u3002 \u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 GATEWAY_URL , \u5237\u65b0\u51e0\u6b21\u9875\u9762\uff0c\u770b\u770b\u4e0d\u540c\u7684\u54cd\u5e94\u3002\u6765\u81ea Customers v2 \u7684\u54cd\u5e94\u663e\u793a\u5728\u4e0b\u56fe\u4e2d $ kubectl get vs NAME GATEWAYS HOSTS AGE customers [\"customers.default.svc.cluster.local\"] 16m web-frontend [\"gateway\"] [\"*\"] 50m $ istioctl dashboard kiali http://localhost:20001/kiali \u4e3a\u4e86\u6539\u53d8\u53d1\u9001\u5230\u4e00\u4e2a\u6216\u53e6\u4e00\u4e2a\u7248\u672c\u7684\u6d41\u91cf\u6bd4\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u66f4\u65b0VirtualService\u3002\u540c\u6837\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u6dfb\u52a0 v3 \u6216 v4 \u7248\u672c\uff0c\u5e76\u5728\u8fd9\u4e9b\u7248\u672c\u4e4b\u95f4\u5206\u5272\u6d41\u91cf\u3002","title":"\u521b\u5efa V2 \u7684 Customers Deployment"},{"location":"chap8/5Istio_net_control_exp/#_3","text":"\u5220\u9664Deployments\u3001 Services\u3001 VirtualServices\u3001 DestinationRule\u548cGateway : kubectl delete -f .","title":"\u6e05\u7406"},{"location":"chap8/5Istio_net_control_exp/#4","text":"\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u8bf7\u6c42\u5c5e\u6027\u591a\u4e2a\u670d\u52a1\u7248\u672c\u4e4b\u95f4\u8def\u7531\u6d41\u91cf\u3002 \u6211\u4eec\u5c06\u4ece\u90e8\u7f72Gateway\u5f00\u59cb\uff1a gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' kubectl apply -f 1gateway.yaml gateway.networking.istio.io/gateway created \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u90e8\u7f72Web\u524d\u7aef\u3001 Customersv1 \u3001 Customersv2 \uff0c\u4ee5\u53ca\u76f8\u5e94\u7684 Vi rtualServices \u548c Destination Rule \u3002\u4e00\u65e6\u4e00\u5207\u90e8\u7f72\u5b8c\u6bd5\uff0c\u6240\u6709\u6d41\u91cf\u5c06\u88ab\u8def\u7531\u5230 Customers v1 \u3002 webfrontend.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 $ kubectl apply -f 2webfrontend.yaml deployment.apps/web-frontend created service/web-frontend created virtualservice.networking.istio.io/web-frontend created apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- apiVersion: apps/v1 kind: Deployment metadata: name: customers-v2 labels: app: customers version: v2 spec: replicas: 1 selector: matchLabels: app: customers version: v2 template: metadata: labels: app: customers version: v2 spec: containers: - image: gcr.io/tetratelabs/customers:2.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: customers spec: host: customers.default.svc.cluster.local subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 $ kubectl apply -f 3customers.yaml deployment.apps/customers-v1 created deployment.apps/customers-v2 created service/customers created virtualservice.networking.istio.io/customers created destinationrule.networking.istio.io/customers created \u4e3a\u4e86\u786e\u4fdd\u4e00\u5207\u90e8\u7f72\u548c\u5de5\u4f5c\u6b63\u5e38\uff0c\u6253\u5f00 GATEWAY_URL \u5e94\u5e76\u786e\u4fdd\u6211\u4eec\u4ece Customersv1 \u83b7\u5f97\u54cd\u5e94 \u6211\u4eec\u5c06\u66f4\u65b0Customers\u7684VirtualService\uff0c\u5e76\u66f4\u65b0\u6d41\u91cf\u5728\u4e24\u4e2a\u7248\u672c\u7684Customers\u670d\u52a1\u4e4b\u95f4\u7684\u8def\u7531 \u8ba9\u6211\u4eec\u770b\u4e00\u4e0b YAML \uff0c \u5982\u679c\u8bf7\u6c42\u4e2d\u5305\u542b\u4e00\u4e2a header user debug \uff0c\u5c31\u628a\u6d41\u91cf\u8def\u7531\u5230 Customersv2 \u3002\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u8fd9\u4e2aheader\uff0c\u6211\u4eec\u5c31\u88ab\u8def\u7531\u5230 Customersv1 customersvs.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - match: - headers: user: exact: debug route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v2 - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 http: - match: - headers: user: exact: debug $ kubectl get vs NAME GATEWAYS HOSTS AGE customers [\"customers.default.svc.cluster.local\"] 9m2s web-frontend [\"gateway\"] [\"*\"] 11m http://127.0.0.1/","title":"4\u3001\u9ad8\u7ea7\u6d41\u91cf\u8def\u7531"},{"location":"chap8/5Istio_net_control_exp/#header","text":"apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - match: - headers: user: exact: debug route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v2 - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 $kubectl apply -f 4customersvs.yaml virtualservice.networking.istio.io/customers configured \u5982\u679c\u6211\u4eec\u4e0d\u63d0\u4f9b\u7aef\u53e3\u53f7\uff0c VirtualService \u4e2d\u7684\u76ee\u7684\u5730\u4e5f\u4f1a\u5de5\u4f5c\u3002\u8fd9\u662f\u56e0\u4e3a\u8be5\u670d\u52a1\u53ea\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7aef\u53e3\u3002 \u5982\u679c\u6211\u4eec\u6253\u5f00 GATEWAY_URL \uff0c\u6211\u4eec\u4ecd\u7136\u5e94\u8be5\u5f97\u5230\u6765\u81ea Customers v1 \u7684\u54cd\u5e94\u3002 \u5982\u679c\u6211\u4eec\u5728\u8bf7\u6c42\u4e2d\u6dfb\u52a0 header user: debug \uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230 customers \u7684\u54cd\u5e94\u662f\u6765\u81ea Customers v2 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 ModHeader \u6269\u5c55\u6765\u4fee\u6539\u6d4f\u89c8\u5668\u4e2d\u7684\u5934\u4fe1\u606f\u3002\u53e6\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 cURL \uff0c\u50cf\u8fd9\u6837\u628a\u5934\u4fe1\u606f\u6dfb\u52a0\u5230\u8bf7\u6c42\u4e2d\u3002 $ curl -H \"user: debug\" http://127.0.0.1/ ... &lt;th class=\"px-4 py-2\"&gt;CITY&lt;/th&gt; &lt;th class=\"px-4 py-2\"&gt;NAME&lt;/th&gt; ... \u5982\u679c\u6211\u4eec\u770b\u4e00\u4e0b\u56de\u590d\uff0c\u4f60\u4f1a\u6ce8\u610f\u5230\u6709\u4e24\u680f CITY\u548cNAME\u3002 \u6e05\u7406 \u5220\u9664DepIoyment\u3001 Services\u3001 VirtualService\u3001 DestinationRule\u548cGateway: $ kubectl delete -f .","title":"header \u5339\u914d"},{"location":"chap8/5Istio_net_control_exp/#5","text":"1\u3001\u6211\u4eec\u53ef\u4ee5\u7528\u4ec0\u4e48\u8d44\u6e90\u914d\u7f6eIstlo ingress gateway? A Gateway B VirtualService C Deployment D Service Gateway : istio: ingressgateway 2\u3001\u4f7f\u7528Gateway\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u5c06\u6d41\u91cf\u8def\u7531\u5230Kubernetes\u5185\u90e8 \u7684\u4e00\u4e2a\u7279\u5b9a\u670d\u52a1\u3002\u5bf9\u8fd8\u662f\u9519\uff1f A \u5bf9 B \u9519 VirtualService 3\u3001Istio ingress \u7f51\u5173\u662f\u4f5c\u4e3a\u54ea\u79cd\u670d\u52a1\u7c7b\u578b\u90e8\u7f72\u7684\uff1f A ClusterIP B NodePort C Loadbalancer D \u4e0d\u662f\u4ee5Service\u5f62\u5f0f\u90e8\u7f72\u7684 4\u3001\u4e0b\u9762\u7684 VirtualService \u662f\u505a\u4ec0\u4e48\u7684\uff1f \u90e8\u7f72\u5728\u4e0a\u8ff0VirtualService\u65c1\u8fb9\u7684Gateway\u8d44\u6e90\uff1a A \u5c06\u6240\u6709\u8fdb\u5165\u7684\u6d41\u91cf\u901a\u8fc7ingress\u8def\u7531\u5230Orders\u670d\u52a1 B \u4ec0\u4e48\u4e5f\u4e0d\u505a\u3002\u5b83\u662f\u65e0\u6548\u7684\uff0c\u56e0\u4e3ahosts\u5b57\u6bb5\u88ab\u8bbe\u7f6e\u4e3a \uff0a \u3002 C Routes all traffic from the ingress gateway to the orders service \u5c06\u6240\u6709\u6d41\u91cf\u4ece\u5165\u53e3\u7f51\u5173\u8def\u7531\u5230Orders\u670d\u52a1 D \u865a\u62df\u670d\u52a1\u662f\u65e0\u6548\u7684\uff0c\u56e0\u4e3a\u5b83\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\u5730\u3002 5\u3001\u4f60\u53ef\u4ee5\u5728\u54ea\u4e2a\u8d44\u6e90\u4e2d\u4e3aHTTP\u6d41\u91cf\u6307\u5b9a\u8def\u7531\u89c4\u5219\uff1f A DestinationRule B VirtuaLService C Gateway D Deployment 6\u3001\u5982\u4f55\u5b9a\u4e49\u591a\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u4ee5\u4fbf\u80fd\u591f\u5728\u5b83\u4eec\u4e4b\u95f4\u8fdb\u884c\u6d41\u91cf\u8def\u7531\uff1f A \u4f7f\u7528Destination Rule\u548csubset B \u4f7f\u7528VirtualService destinations C \u5728Gateway\u5b9a\u4e49\u591a\u4e2ahost D \u5728Pod\u6a21\u677f\u4e2d\u4f7f\u7528\u6807\u7b7e 7\u3001\u5f53\u4f7f\u7528\u79bb\u7fa4\u68c0\u6d4b\u65f6\uff0c\u4e3b\u673a\u4f55\u65f6\u4f1a\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\uff1f A \u5f53\u4e0d\u54cd\u5e94\u65f6 B \u5f53\u8fd4\u56deHTTP 4xx\u9519\u8bef\u65f6 C \u5f53\u8fd4\u56deHTTP 5xx\u9519\u8bef\u65f6 D \u4e0d\u4f1a\u88ab\u5f39\u51fa 8\u3001\u5728\u79bb\u7fa4\u68c0\u6d4b\u914d\u7f6e\u4e2d\uff0c\u95f4\u9694\u8bbe\u7f6e\u6307\u7684\u662f\u4ec0\u4e48\uff1f A. \u79bb\u7fa4\u68c0\u6d4b\u5f00\u59cb\u6240\u9700\u7684\u65f6\u95f4 B. \u626b\u63cf\u4e0a\u6e38\u4e3b\u673a\u65f6\u95f4\u7684\u95f4\u9694 C. \u5f02\u5e38\u503c\u88ab\u5f39\u51fa\u7684\u65f6\u95f4\u95f4\u9694 D. \u5237\u65b0\u914d\u7f6e\u7684\u65f6\u95f4\u95f4\u9694 9\u3001\u80fd\u5c06\u6d41\u91cf\u7b56\u7565\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u7aef\u53e3\u5417\uff1f\uff08\u662f/\u5426\uff09 A \u80fd B \u4e0d\u80fd trafficPolicy: portLevelSettings: port 10\u3001 ISTIO_MUTUAL \u548c MUTUAL TLS \u6a21\u5f0f\u4e4b\u95f4\u6709\u4ec0\u4e48\u533a\u522b\uff1f A \u6ca1\u6709\u533a\u522b B ISTIO_MUTUAL \u9700\u8981\u751f\u4ea7istio\u914d\u7f6e\u6587\u4ef6\uff0c\u800cMUTUAL\u4e0d\u9700\u8981\u3002 C MUTUAL\u53ef\u4ee5\u4e0e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u4e00\u8d77\u4f7f\u7528\uff0c\u800c ISTIO_MUTUAL \u4e0d\u80fd D ISTIO_MUTUAL \u5728mTLS\u4e2d\u4f7f\u7528Istio\u7684\u8bc1\u4e66\uff0c\u800c\u5728 MUTUAL TLS \u4e2d\u4f60\u53ef\u4ee5\u7528\u4f60\u81ea\u5df1\u7684\u8bc1\u4e66 ISTIO_MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09 11. (Resiliency\uff09\u5c31\u662f\u8981\u907f\u514d\u548c\u9632\u6b62\u6545\u969c\u3002\u5bf9\u8fd8\u662f\u9519\uff1f A \u5bf9 B \u9519 \u8fd9\u4e0d\u662f\u4e3a\u4e86\u907f\u514d\u6545\u969c\uff0c\u800c\u662f\u4ee5\u4e00\u79cd\u6ca1\u6709\u505c\u673a\u6216\u6570\u636e\u4e22\u5931\u7684\u65b9\u5f0f\u6765\u5e94\u5bf9\u6545\u969c\u3002\u5f39\u6027\u7684\u76ee\u6807 \u662f\u5728\u6545\u969c\u53d1\u751f\u540e\u5c06\u670d\u52a1\u6062\u590d\u5230\u4e00\u4e2a\u5b8c\u5168\u6b63\u5e38\u7684\u72b6\u6001 12. Istio\u7684\u54ea\u4e24\u4e2a\u529f\u80fd\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u89e3\u51b3\u5f39\u6027\u95ee\u9898\uff1f A \u91cd\u8bd5\u7b56\u7565 B \u6d41\u91cf\u8def\u7531 C mTLS D \u8d85\u65f6 E \u6388\u6743\u7b56\u7565 13 \u6211\u4eec\u662f\u5426\u53ef\u4ee5\u4f7f\u7528\u6807\u5934\u6765\u6307\u5b9a\u53ef\u6536\u56de\u7684\u72b6\u6001\u4ee3\u7801\uff1f\uff08\u662f\uff0f\u5426\uff09 A \u662f B \u5426 \u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u53ea\u5728\u4e0a\u6e38\u670d\u52a1\u5668\u8fd4\u56de5xx\u54cd\u5e94\u4ee3\u7801\u65f6\u91cd\u8bd5\u8bf7\u6c42\uff0c\u6216\u8005\u53ea\u5728\u7f51\u5173\u9519\u8bef\uff08HTTP 5O2\u3001 503\u6216504\uff09\u65f6\u91cd\u8bd5\uff0c\u6216\u8005\u751a\u81f3\u5728\u8bf7\u6c42\u5934\u4e2d\u6307\u5b9a\u53ef\u91cd\u8bd5\u7684\u72b6\u6001\u4ee3\u7801\u3002 13 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f A \u4ec0\u4e48\u4e5f\u4e0d\u4f1a\u53d1\u751f\uff0c\u7aef\u70b9\u4fdd\u6301\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d B Pod\u91cd\u542f C \u4f60\u53ef\u4ee5\u914d\u7f6e\u91cd\u8bd5\u662f\u5426\u6392\u9664\u7aef\u70b9 D \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 \u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\u3002\u5f53Envoy\u91cd\u8bd5\u4e00\u4e2a\u5931\u8d25\u7684\u8bf7\u6c42\u65f6\uff0c \u6700\u521d\u5931\u8d25\u5e76\u5bfc\u81f4\u91cd\u8bd5\u7684\u7aef\u70b9\u5c31\u4e0d\u518d\u5305\u542b\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u4e86 \u3002\u5047\u8bbeKubernetes\u670d\u52a1\u67093\u4e2a\u7aef\u70b9\uff08Pod)\uff0c\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u4e86\uff0c \u5e76\u51fa\u73b0\u4e86\u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u4ee3\u7801 14 \u4f60\u80fd\u4e3a\u540c\u4e00\u4e2a\u8bf7\u6c42\u540c\u65f6\u6ce8\u5165\u5ef6\u8fdf\u548c\u4e2d\u6b62\u5417\uff1f\uff08\u662f/\u5426\uff09 A \u662f B \u5426 15 \u8003\u8651\u5230\u4e0b\u9762\u7684\u7247\u6bb5\uff0c\u6709\u591a\u5c11\u767e\u5206\u6bd4\u7684\u8bf7\u6c42\u4f1a\u88ab\u4e2d\u6b62\uff1f \u2026 fault: abort: httpStatus:404 A 0% B 100% C \u8be5\u7247\u6bb5\u662f\u65e0\u6548\u7684 D \u4e0d\u6e05\u695a\uff0c\u56e0\u4e3a\u767e\u5206\u6bd4\u672a\u6307\u5b9a \u5982\u679c\u6211\u4eec\u4e0d\u6307\u5b9a\u767e\u5206\u6bd4\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u4e2d\u6b62 16 \u6545\u969c\u6ce8\u5165\u662f\u5426\u89e6\u53d1\u91cd\u8bd5\u7b56\u7565\uff1f\uff08\u662f\uff0f\u5426\uff09 A \u662f B \u5426 \u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u5c06\u4e0d\u4f1a\u89e6\u53d1\u6211\u4eec\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u6ce8\u5165\u4e86\u4e00\u4e2aHTTP 500\u7684\u9519\u8bef\uff0c\u914d\u7f6e\u4e3aHTTP 500\u4e0a\u7684\u91cd\u8bd5\u7b56\u7565\u5c06\u4e0d\u4f1a\u88ab\u89e6\u53d1\u3002 17 \u4f60\u53ef\u4ee5\u4f7f\u7528 VirtualService \u4e2d\u7684\u54ea\u4e2a\u5b57\u6bb5\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230Kubernetes\u4e2d\u4e00\u4e2a\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\uff1f A destination B authority C redirect D host-redirect ... http: - match: - headers: my-header: exact: hello redirect: uri: /hello authority: my-service.default.svc.cluster.local:8000 ... 18 \u5728\u7f16\u5199\u5339\u914d\u89c4\u5219\u65f6\uff0c\u5982\u4f55\u8868\u8fbeAND\u548cOR\u7684\u8bed\u4e49 \uff1f A \u5bf9\u4e8eOR\uff0c\u4f60\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a\u5355\u72ec\u7684\u5339\u914d\u6761\u76ee\uff0c\u800c\u5bf9\u4e8eAND\uff0c\u4f60\u5728\u4e00\u4e2a\u5355\u4e00\u7684\u5339\u914d\u6761\u76ee\u4e2d\u5305\u62ec\u6240\u6709\u7684\u6761\u4ef6 B \u4f60\u4e0d\u80fd\u8fd9\u6837\u505a\u3002\u53ea\u5141\u8bb8\u4f7f\u7528OR\u8bed\u4e49 C \u4f60\u4e0d\u80fd\u8fd9\u6837\u505a\u3002\u53ea\u5141\u8bb8\u4f7f\u7528AND\u8bed\u4e49 D \u5bf9\u4e8eOR\uff0c\u5728\u4e00\u4e2a\u5355\u4e00\u7684\u5339\u914d\u6761\u76ee\u4e2d\u5305\u62ec\u6240\u6709\u6761\u4ef6\uff0c\u5bf9\u4e8eAND\uff0c\u6dfb\u52a0\u4e00\u4e2a\u5355\u72ec\u7684\u5339\u914d\u6761\u76ee 19 \u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u4f7f\u5916\u90e8\u670d\u52a1\u6210\u4e3a\u4f60\u7684\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206\uff1f A Service B ServiceEntry C VirtualService D Gateway \u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206 20 Envoy sidecar\u68c0\u67e5ServiceEntry\u8d44\u6e90\u4e2d\u7684hosts\u5b57\u6bb5\u7684\u987a\u5e8f\u662f\u4ec0\u4e48\uff1f A IP\u5730\u5740\u3001\u7aef\u53e3\u3001SNI\u3001HTTP B SNI\u3001 IP\u5730\u5740\u3001\u7aef\u53e3\u3001HTTP C HTTP\u3001 SNI\u3001 IP\u5730\u5740\u3001\u7aef\u53e3 D HTTP\u3001 IP\u5730\u5740\u3001\u7aef\u53e3\u3001SNI * HTTP Authority\u5934\uff08\u5728HTTP/2\u4e2d\uff09\u548cHost\u5934\uff08HTTP/1.1\u4e2d\uff09 * SNI * IP\u5730\u5740\u548c\u7aef\u53e3 21 ServiceEntry\u8d44\u6e90\u4e2d\u7684workloadSelector\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f A \u4ece\u5916\u90e8\u96c6\u7fa4\u4e2d\u9009\u62e9pod\u5e76\u4f7f\u5176\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 B \u9009\u62e9Kubernetes\u670d\u52a1\uff0c\u4f7f\u5176\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 C \u8981\u9009\u62e9WorkloadEntry\u8d44\u6e90\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 D ServiceEntry\u6ca1\u6709workloadSelector\u5b57\u6bb5 \u5728Workload Entry\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ec6\u8282\uff08\u540d\u79f0\u3001\u5730\u5740\u3001\u6807\u7b7e\uff09\uff0c\u7136\u540e\u4f7f\u7528ServiceEntry\u4e2d\u7684 workloadSelector \u5b57\u6bb5\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3a Istio \u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206\u3002 22 \u5982\u4f55\u914d\u7f6esidecar\u4ee3\u7406\uff0c\u4f7f\u5176\u53ea\u5bf9\u67d0\u4e9b\u670d\u52a1\u4f7f\u7528\u7279\u5b9a\u7684\u7aef\u53e3\uff1f A \u4f7f\u7528Proxy\u8d44\u6e90 B \u4f7f\u7528Filter\u8d44\u6e90 C \u4f7f\u7528VirtualService\u8d44\u6e90 D \u4f7f\u7528Sidecar\u8d44\u6e90 23 Sidecar\u8d44\u6e90\u4e2d\u7684Ingress\u548cegress\u76d1\u542c\u5668\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f A \u8981\u914d\u7f6e\u54ea\u4e9b\u6d41\u91cf\u662fsidecar\u963b\u65ad\u7684 B \u8981\u5c06ingress\u548cegress\u7f51\u5173\u8fde\u63a5\u5230Sidecar\u4e0a C \u5b9a\u4e49\u54ea\u4e9b\u5165\u7ad9\uff0f\u51fa\u7ad9\u6d41\u91cf\u88absidecar\u63a5\u53d7 D Ingress\u5b57\u6bb5\u7528\u4e8e\u914d\u7f6e\u8fdb\u5165sidecar\u7684\u6d41\u91cf\uff0c\u800cegress\u5b57\u6bb5\u662f\u4e0d\u53ef\u914d\u7f6e\u7684\u3002 . * Workload selector * Ingress listener * Egress listener 24 EnvoyFilters\u662f\u5426\u7528\u4e8e\u5b9a\u5236\u7531Pilot\u751f\u6210\u7684Envoy\u914d\u7f6e\uff1f \uff08\u662f\uff0f\u5426\uff09 A \u662f B \u5426 EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531 Istio Pilot \u751f\u6210\u7684Envoy\u914d\u7f6e 25 \u5f53\u6709\u591a\u4e2aEnvoyFilter\u90e8\u7f72\u65f6\uff0c\u54ea\u4e9b\u8fc7\u6ee4\u5668\u4f1a\u5148\u88ab\u5e94\u7528\uff1f A default\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fc7\u6ee4\u5668 B \u6839\uff08\u5982istio-system)\u547d\u540d\u7a7a\u95f4\u7684\u8fc7\u6ee4\u5668 C \u5b83\u4eec\u662f\u6309\u5b57\u6bcd\u987a\u5e8f\u5e94\u7528\u7684 D \u5b83\u4eec\u662f\u6839\u636epriority\u5b57\u6bb5\u6765\u5e94\u7528\u7684 \u6839\u547d\u540d\u7a7a\u95f4\uff08\u4f8b\u5982 istio-system )\u4e2d\u7684\u8fc7\u6ee4\u5668\u9996\u5148\u88ab\u5e94\u7528\uff0c\u7136\u540e\u662f\u5de5\u4f5c\u8d1f\u8f7d\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u5339\u914d\u8fc7\u6ee4\u5668\u3002 26 \u5982\u4f55\u5c06VirtualService\u4e0eGateway\u7ed1\u5b9a\uff1f A VirtualService\u4e2d\u7684hosts\u5b57\u6bb5 B \u5c06VirtualService\u548cGateway\u5728\u540c\u4e00\u6587\u4ef6\u4e2d\u90e8\u7f72 C \u65e0\u6cd5\u505a\u5230 D \u4f7f\u7528gateways\u5b57\u6bb5 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: hello-world spec: hosts: - \"*\" gateways: - gateway http: ... 27 \u53ef\u4ee5\u5728VirtualService\u4e2d\u914d\u7f6e\u6d41\u91cf\u7b56\u7565\u3002\u5bf9\u8fd8\u662f\u9519\uff1f A \u5bf9 B \u9519 28 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48 \uff1f A \u4ec0\u4e48\u4e5f\u4e0d\u4f1a\u53d1\u751f\uff0c\u7aef\u70b9\u4fdd\u6301\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d B Pod\u91cd\u542f C \u4f60\u53ef\u4ee5\u914d\u7f6e\u662f\u5426\u6392\u9664\u7aef\u70b9 D \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 29 \u4f60\u53ef\u4ee5\u7528Workload Entry\u8d44\u6e90\u505a\u4ec0\u4e48\uff1f A \u5411Pod\u4e2d\u6ce8\u5165\u6545\u969c B \u914d\u7f6e\u5916\u90e8API C \u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5411Kubernetes\u7684\u8fc1\u79fb D \u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6d41\u91cf\u8def\u7531","title":"5\u3001\u6d41\u91cf\u7ba1\u7406\uff1a\u6d4b\u8bd5"},{"location":"chap8/6Istio_secruity/","text":"\u7b2c\u516d\u8282 Istio Secuirty Authentication Authorization Mutual TLS, secure naming and identity Labs: Enabling mutual TLS Using authorization policies to control access between workloads Quiz 1\u3001\u8ba4\u8bc1(Authentication) Authentication Principal = Kubernetes service Action = HTTP request methods (e.g. GET, POST, DELETE, ...) Object = Kubernetes service All about the principal (service identity) \"Validating a credential and ensuring it's both valid and trusted\" Identity Unique identity in Kubernetes = Kubernetes service account X.509 certificate (from SA) + SPIFFE spec = Identity Naming scheme (spiffe://cluster.localinsidefault/sa/my-sa) Encoding names into X.509 Validating the X.509 to authenticate the SPIFFE identity \u4e3a\u4e86\u89e3\u91ca\u4ec0\u4e48\u662f\u8ba4\u8bc1\u6216auth\uff0c\u6211\u4eec\u5c06\u4ece\u8bbf\u95ee\u63a7\u5236\u8bd5\u56fe\u56de\u7b54\u7684\u95ee\u9898\u5f00\u59cb\uff1a\u4e00\u4e2a\u4e3b\u4f53\u80fd\u5426\u64cd\u4f5c\u53e6\u4e00\u4e2a\u5bf9\u8c61\uff1f \u5982\u679c\u6211\u4eec\u628a\u4e0a\u8ff0\u95ee\u9898\u6362\u5230Istio\u548cKubernetes\u8bed\u5883\uff0c\u90a3\u5c06\u662f\u201d\u670d\u52a1x\u80fd\u5426\u64cd\u4f5c\u670d\u52a1Y?\" \u8fd9\u4e2a\u95ee\u9898\u7684\u4e09\u4e2a\u5173\u952e\u90e8\u5206\u662f\uff1a \u59d4\u6258\u4eba\u3001\u52a8\u4f5c\u548c\u5bf9\u8c61 \u3002 \u4e3b\u4f53\u548c\u5bf9\u8c61\u90fd\u662fKubernetes\u4e2d\u7684\u670d\u52a1\u3002\u52a8\u4f5c\uff0c\u5047\u8bbe\u6211\u4eec\u8c08\u8bba\u7684\u662fHTTP\uff0c\u53ef\u4ee5\u662fGET\u3001POST\u6216\u8005PUT\u4e0b\u8bf7\u6c42\u7b49\u7b49\u3002 \u8ba4\u8bc1\u662f\u5173\u4e8e\u59d4\u6258\u4eba\uff08\u6216\u8005\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f\u670d\u52a1\u7684\u8eab\u4efd\uff09\u7684\u3002\u8ba4\u8bc1\u662f\u9a8c\u8bc1\u67d0\u79cd\u51ed\u8bc1\u7684\u884c\u4e3a\uff0c\u5e76\u786e\u4fdd\u8be5\u51ed\u8bc1\u662f\u6709\u6548\u548c\u53ef\u4fe1\u7684\u3002\u4e00\u65e6\u8fdb\u884c\u4e86\u8ba4\u8bc1\uff0c\u6211\u4eec\u5c31\u6709\u4e86\u4e00\u4e2a\u7ecf\u8fc7\u8ba4\u8bc1\u7684\u59d4\u6258\u4eba\u3002\u4e0b\u6b21\u4f60\u65c5\u884c\u65f6\uff0c\u4f60\u5411\u6d77\u5173\u5b98\u5458\u51fa\u793a\u4f60\u7684\u62a4\u7167\u6216\u8eab\u4efd\u8bc1\uff0c\u4ed6\u4eec\u4f1a\u5bf9\u5176\u8fdb\u884c\u8ba4\u8bc1\uff0c\u786e\u4fdd\u4f60\u7684\u51ed\u8bc1\uff08\u62a4\u7167\u6216\u8eab\u4efd\u8bc1\uff09\u662f\u6709\u6548\u548c\u53ef\u4fe1\u7684\u3002 \u5728Kubernetes\u4e2d\uff0c\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u88ab\u5206\u914d\u4e86\u4e00\u4e2a\u72ec\u7279\u7684\u8eab\u4efd\u6765\u4e0e\u5176\u4ed6\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u901a\u4fe1 \u2015\u8be5\u8eab\u4efd\u4ee5\u670d\u52a1\u8d26\u6237\u7684\u5f62\u5f0f\u63d0\u4f9b\u7ed9\u5de5\u4f5c\u8d1f\u8f7d\u3002\u670d\u52a1\u8d26\u6237\u662f\u8fd0\u884c\u65f6\u4e2d\u5b58\u5728\u7684\u8eab\u4efdPod Istio\u4f7f\u7528\u6765\u81ea\u670d\u52a1\u8d26\u6237\u7684 X.509 \u8bc1\u4e66\uff0c \u5b83\u6839\u636e\u540d\u4e3aSPIFFE\uff08\u6bcf\u4e2a\u4eba\u7684\u5b89\u5168\u751f\u4ea7\u8eab\u4efd\u6846\u67b6\uff09 \u7684\u89c4\u8303\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8eab\u4efd\u3002 \u8bc1\u4e66\u4e2d\u7684\u8eab\u4efd\u88ab\u7f16\u7801\u5728\u8bc1\u4e66\u7684 Subject alternate name \u5b57\u6bb5\u4e2d\uff0c\u5b83\u770b\u8d77\u6765\u50cf\u8fd9\u6837\u3002 spiffe://cluster.local/ns/<pod namespace>/sa/<pod service account> \u5f53\u4e24\u4e2a\u670d\u52a1\u5f00\u59cb\u901a\u4fe1\u65f6\uff0c\u5b83\u4eec\u9700\u8981\u4ea4\u6362\u5e26\u6709\u8eab\u4efd\u4fe1\u606f\u7684\u51ed\u8bc1\uff0c\u4ee5\u76f8\u4e92\u9a8c\u8bc1\u81ea\u5df1\u3002\u5ba2\u6237\u7aef\u6839\u636e\u5b89\u5168\u547d\u540d\u4fe1\u606f\u68c0\u67e5\u670d\u52a1\u5668\u7684\u8eab\u4efd\uff0c\u770b\u5b83\u662f\u5426\u662f\u670d\u52a1\u7684\u6388\u6743\u8fd0\u884c\u8005\u3002 \u670d\u52a1\u5668\u6839\u636e\u6388\u6743\u7b56\u7565\u786e\u5b9a\u5ba2\u6237\u53ef\u4ee5\u8bbf\u95ee\u54ea\u4e9b\u4fe1\u606f\u3002\u6b64\u5916\uff0c\u670d\u52a1\u5668\u53ef\u4ee5\u5ba1\u8ba1\u8c01\u5728\u4ec0\u4e48\u65f6\u95f4\u8bbf\u95ee\u4e86\u4ec0\u4e48\uff0c\u5e76\u51b3\u5b9a\u662f\u5426\u6279\u51c6\u6216\u62d2\u7edd\u5ba2\u6237\u5bf9\u670d\u52a1\u5668\u7684\u8c03\u7528\u3002 \u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04\u3002 \u670d\u52a1\u5668\u8eab\u4efd\u662f\u5728\u8bc1\u4e66\u4e2d\u7f16\u7801\u7684\uff0c\u800c\u670d\u52a1\u540d\u79f0\u662f\u7531\u53d1\u73b0\u670d\u52a1\u6216DNS\u4f7f\u7528\u7684\u540d\u79f0\u3002\u4ece\u4e00\u4e2a\u8eab\u4efdA\u5230\u4e00\u4e2a\u670d\u52a1\u540d\u79f0B\u7684\u5355\u4e00\u6620\u5c04\u610f\u6627\u7740\u201dA\u88ab\u5141\u8bb8\u548c\u6388\u6743\u8fd0\u884c\u670d\u52a1B\"\u3002 \u5b89\u5168\u547d\u540d\u4fe1\u606f\u7531Pilot\u751f\u6210\uff0c\u7136\u540e\u5206\u53d1\u7ed9\u6240\u6709sidecar\u4ee3\u7406\u3002 2\u3001\u8bc1\u4e66\u521b\u5efa\u548c\u8f6e\u6362 \u5bf9\u4e8e\u7f51\u683c\u4e2d\u7684\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\uff0cIstio\u63d0\u4f9b\u4e00\u4e2a X.509 \u8bc1\u4e66\u3002 \u4e00\u4e2a\u540d\u4e3a pilot-agent \u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08 istiod \uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c \u3002 Certificate creation Istio Agent Envoy's Secret Discovery Service(SDS) Citadel(part of the control plane) Istio Agent \u4e0e Envoy sidecar \u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c \u3002\u5373\u4fbf Istio \u4ee3\u7406\u5728\u6bcf\u4e2apod\u4e2d\u8fd0\u884c\u6211\u4eec\u4e5f\u8ba4\u4e3a\u5b83\u662f\u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\u3002 \u79d8\u94a5\u53d1\u73b0\u670d\u52a1(SDS)\u7b80\u5316\u4e86\u8bc1\u4e66\u7ba1\u7406\u3002\u5982\u679c\u6ca1\u6709SDS\u8bc1\u4e66\u5fc5\u987b\u4f5c\u4e3a\u79d8\u5bc6(Secret) \u521b\u5efa\uff0c\u7136\u540e\u88c5\u5165\u4ee3\u7406\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002 \u5f53\u8bc1\u4e66\u8fc7\u670b\u65f6\uff0c\u9700\u8981\u66f4\u65b0\u79d8\u5bc6\uff0c\u5e76\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u56e0\u4e3aEnvoy\u4e0d\u4f1a\u4ece\u76d8\u52a8\u6001\u91cd\u65b0\u52a0\u8f7d\u8bc1\u4e66\u3002 \u5f53\u7528SDS\u65f6SDS\u670d\u52a1\u5668\u5c06\u8bc1\u4e66\u63a8\u9001\u7ed9Envoy\u5b9e\u4f8b\u3002 \u6bcf\u5f53\u8bc1\u4e66\u8fc7\u671f\u65f6SDS\u4f1a\u63a8\u9001\u66f4\u65b0\u7684\u8bc1\u4e66Envoy\u53ef\u4ee5\u7acb\u5373\u4fbf\u7528\u5b83\u4eec\u3002\u4e0d\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u670d\u52a1\u5668\u4e5f\u4e0d\u9700\u8981\u4e2d\u65ad\u6d41\u91cf \u3002 \u5728Istio\u4e2dIstio Agent\u4f5c\u4e3aSDS\u670d\u52a1\u5668\u5b9e\u73b0\u4e86\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\u63a5\u53e3 \u6bcf\u6b21\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u8d26\u6237\u65f6, Citadel\u90fd\u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2aSPIFFE\u8eab\u4efd\u3002 \u6bcf\u5f53\u6211\u4eec\u5b89\u6392\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u65f6\uff0c Pilot\u4f1a\u7528\u5305\u62ec\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\u5728\u5185\u7684\u521d\u6021\u5316\u4fe1\u606f\u6765\u914d\u7f6e\u5176sidecar \u5f53\u5de5\u4f5c\u8d1f\u8f7d\u65c1\u8fb9\u7684Envoy\u4ee3\u7406\u542f\u52a8\u65f6\uff0c \u5b83\u4f1a\u8054\u7cfbIstio\u4ee3\u7406\u5e76\u544a\u8bc9\u5b83\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\u3002\u4ee3\u7406\u9a8c\u8bc1\u8be5\u5b9e\u4f8b\u751f\u6210CSR\uff08\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42Certicate Secret Reuqest\uff09\u5c06CSR\u4ee5\u53ca\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\u8bc1\u660e\uff08\u5728Kubernetes\u4e2d\u662fpod\u7684\u670d\u52a1\u8d26\u6237JWT\uff09\u53d1\u9001\u7ed9Citadel\u3002 Citadel\u5c06\u6267\u884c\u8ba4\u8bc1\u548c\u6388\u6743\u5e76\u4ee5\u7b7e\u540d\u7684 X.509 \u8bc1\u4e66\u4f5c\u4e3a\u56de\u5e94\u3002Istio\u4ee3\u7406\u4eceCitadel\u83b7\u53d6\u54cd\u5e94\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\u5e76\u901a\u8fc7 SDS \u548c Unix \u57df\u5957\u63a5\u5b87\u5c06\u5176\u63d0\u4f9b\u7ed9 Envoy \u3002 \u5c06\u5bc6\u94a5\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u6bd4\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u66f4\u5b89\u5168 \uff1b \u5728\u4f7f\u7528SDS\u65f6\uff0c\u7edd\u4e0d\u4f1a\u5c06\u4efb\u4f55\u5bc6\u94a5\u5199\u5165\u78c1\u76d8\u3002Istio\u4ee3\u7406\u8fd8\u5b9a\u671f\u5237\u65b0\u51ed\u8bc1\uff0c \u5728\u5f53\u524d\u51ed\u8bc1\u8fc7\u670b\u524d\u4eceCitadel\u68c0\u7d22\u4efb\u4f55\u65b0\u7684SVID(SPIFFE\u53ef\u9a8c\u8bc1\u8eab\u4efd\u6587\u4ef6\uff09 SVID\u662f\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u6548\u53ef\u4ee5\u7528\u91c7\u5411\u8d44\u6e90\u6216\u8c03\u7528\u8005\u8bc1\u660e\u5176\u8eab\u4efd\u7684\u6587\u4ef6\u5b83\u5fc5\u987b\u7531\u4e00\u4e2a\u6743\u5a01\u673a\u6784\u7b7e\u53d1\u5e76\u5305\u542b\u4e00\u4e2a SPIEFE ID , \u5b83\u4ee3\u8868\u4e86\u63d0\u51fa\u8be5\u6587\u4ef6\u7684\u670d\u52a1\u7684\u8eab\u4efd \u89e3\u51b3\u65b9\u6848\u662f\u53ef\u6269\u5c55\u7684\u56e0\u4e3a\u6d41\u7a0b\u4e2d\u7684\u6bcf\u4e2a\u7ec4\u4ef6\u53ea\u8d1f\u4ece\u4e00\u90e8\u5206\u5de5\u4f5c\u3002\u4f8b\u5982\uff0c Envoy\u8d1f\u8d23\u8fc7\u671f\u8bc1\u4e66\uff0c istio\u4ee3\u7406\u8d1f\u8d35\u751f\u6210\u79c1\u94a5\u548cCSR. CitadeL\u8d1f\u8d5e\u6388\u6743\u548c\u7b7e\u7f72\u8bc1\u4e66 3\u3001Peer and Request Authentication(\u5bf9\u7b49\u8ba4\u8bc1\u548c\u8bf7\u6c42\u8ba4\u8bc1) Peer authentication Peer authentication service-to-service All mTLS about the communication between services Request authentication end user authentication uses JWTs 3-1 Istio\u63d0\u4f9b\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1a\u5bf9\u7b49\u8ba4\u8bc1\u548c\u8bf7\u6c42\u8ba4\u8bc1 3-2 \u5bf9\u7b49\u8ba4\u8bc1 \u5bf9\u7b49\u8ba4\u8bc1\u7528\u4e8e\u670d\u52a1\u95f4\u7684\u8ba4\u8bc1\uff0c\u4ee5\u9a8c\u8bc1\u5efa\u7acb\u8fde\u63a5\u7684\u5ba2\u6237\u7aef\u3002 \u5f53\u4e24\u4e2a\u670d\u52a1\u8bd5\u56fe\u8fdb\u884c\u901a\u4fe1\u65f6\uff0c\u53cc\u5411TLS\u8981\u6c42\u5b83\u4eec\u90fd\u5411\u5bf9\u65b9\u63d0\u4f9b\u8bc1\u4e66\uff0c\u56e0\u6b64\u53cc\u65b9\u90fd\u77e5\u9053\u5b83\u4eec\u5728\u4e0e\u8c01\u4ea4\u8c08\u3002 \u5982\u679c\u6211\u4eec\u60f3\u5728\u670d\u52a1\u4e4b\u95f4\u542f\u7528\u4e25\u683c\u7684\u53cc\u5411TLS\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 PeerAuthentication \u8d44\u6e90\uff0c\u5c06 mTLS \u6a21\u5f0f\u8bbe\u7f6e\u4e3a STRICT \u3002 \u4f7f\u7528PeerAuthentication\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u7684\u53cc\u5411TLS(mTLS)\uff0c\u800c\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u4ee3\u7801\u4fee\u6539 \u3002 \u7136\u800c\uff0cIstio\u4e5f\u652f\u6301\u4e00\u79cd\u4f18\u96c5\u7684\u6a21\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u5728\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6216\u547d\u540d\u7a7a\u95f4\u5185\u8fdb\u5165\u53cc\u5411TLS\u3002 \u8fd9\u79cd\u6a21\u5f0f\u88ab\u79f0\u4e3a\u8bb8\u53ef\u6a21\u5f0f \u3002 \u5f53\u4f60\u5b89\u88c5Istio\u65f6\uff0c \u8bb8\u53ef\u6a21\u5f0f\u662f\u9ed8\u8ba4\u542f\u7528\u7684 \u3002 \u542f\u7528\u8bb8\u53ef\u6a21\u5f0f\u540e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u8bd5\u56fe\u901a\u8fc7\u53cc\u5411TLS\u8fde\u63a5\u5230\u6211\uff0c Istio\u5c06\u63d0\u4f9b\u53cc\u5411TLS \u3002 \u5982\u679c\u5ba2\u6237\u7aef\u4e0d\u4f7f\u7528\u53cc\u5411TLS, Istio\u4e5f\u53ef\u4ee5\u7528\u7eaf\u6587\u672c\u54cd\u5e94 \u3002 \u4f60\u53ef\u4ee5\u5141\u8bb8\u5ba2\u6237\u7aef\u505a\u6216\u4e0d\u505amTLS\u3002\u4f7f\u7528\u8fd9\u79cd\u6a21\u5f0f\uff0c\u4f60\u53ef\u4ee5\u5728\u4f60\u7684\u670d\u52a1\u7f51\u683c\u4e2d\u9010\u6e10\u63a8\u51fa\u53cc\u5411TLS \u3002 \u7b80\u800c\u8a00\u4e4b\uff0c PeerAuthentication \u8c08\u8bba\u7684\u662f\u5de5\u4f5c\u8d1f\u8f7d\u6216\u670d\u52a1\u7684\u901a\u4fe1\u65b9\u5f0f\uff0c\u5b83\u5e76\u6ca1\u6709\u8bf4\u5230\u6700\u7ec8\u7528\u6237\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u600e\u6837\u624d\u80fd\u8ba4\u8bc1\u7528\u6237\u5462\uff1f 3-3 \u8bf7\u6c42\u8ba4\u8bc1 \u8bf7\u6c42\u8ba4\u8bc1\uff08 RequestAuthentication \u8d44\u6e90\uff09\u9a8c\u8bc1\u4e86\u9644\u52a0\u5728\u8bf7\u6c42\u4e0a\u7684\u51ed\u8bc1\uff0c\u5b83\u88ab\u7528\u4e8e\u7ec8\u7aef\u7528\u6237\u8ba4\u8bc1\u3002 \u8bf7\u6c42\u7ea7\u8ba4\u8bc1\u662f\u901a\u8fc7 JSON Web Tokens (JWT) \u9a8c\u8bc1\u5b8c\u6210\u7684 \u3002 Istio\u652f\u6301\u4efb\u4f55 OpenID Connect \u63d0\u4f9b\u5546\uff0c\u5982AuthO\u3001 Firebase\u6216Google Auth\u3001Keycloak\u3001ORY Hydra\u3002\u56e0\u6b64\uff0c\u5c31\u50cf\u6211\u4eec\u4f7f\u7528SPIFFE\u8eab\u4efd\u6765\u9a8c\u8bc1\u670d\u52a1\u4e00\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528JWT\u4ee4\u724c\u6765\u9a8c\u8bc1\u7528\u6237\u3002 4\u3001\u53cc\u5411TLS Mutual TLS(mTLS) Traffic is re-routed through proxies Envoy starts an mTLS handshake Secure naming check is done Once mTLS connection is established: Request is forwarded to server-side proxy Server-side forwards traffic to the workload mTLS Behavior DISABLE : no TLS connection SIMPLE : originate to the upstream MUTUAL : uses mTLS and certs for auth ISTIO_MUTUAL : like MUTUAL; but uses Istlo's certs for mTLS Permissive mode Allows services to accpet both plaintext and mTLS Improves mTLS onboarding experience Gradually Install/configure sidecars for mTLS 4-1 \u53cc\u5411TLS \u670d\u52a1\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u7684\u901a\u4fe1\u662f\u901a\u8fc7Envoy\u4ee3\u7406\u8fdb\u884c\u7684\u3002\u5f53\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u4f7f\u7528mTLS\u5411\u53e6\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u53d1\u9001\u8bf7\u6c42\u65f6\uff0cIstio\u4f1a\u5c06\u6d41\u91cf\u91cd\u65b0\u8def\u7531\u5230sidecar\u4ee3\u7406\uff08Envoy)\u3002 \u7136\u540e\uff0c sidecar Envoy \u5f00\u59cb\u4e0e\u670d\u52a1\u5668\u7aef\u7684 Envoy \u8fdb\u884c mTLS \u63e1\u624b\u3002 \u5728\u63e1\u624b\u8fc7\u7a0b\u4e2d\uff0c\u8c03\u7528\u8005\u4f1a\u8fdb\u884c\u5b89\u5168\u547d\u540d\u68c0\u67e5\uff0c\u4ee5\u9a8c\u8bc1\u670d\u52a1\u5668\u8bc1\u4e66\u4e2d\u7684\u670d\u52a1\u8d26\u6237\u662f\u5426\u88ab\u6388\u6743\u8fd0\u884c\u76ee\u6807\u670d\u52a1\u3002\u4e00\u65e6 mTLS \u8fde\u63a5\u5efa\u7acb\uff0c Istio \u5c31\u4f1a\u5c06\u8bf7\u6c42\u4ece\u5ba2\u6237\u7aef\u7684 Envoy \u4ee3\u7406\u8f6c\u53d1\u5230\u670d\u52a1\u5668\u7aef\u7684 Envoy \u4ee3\u7406\u3002 \u5728\u670d\u52a1\u5668\u7aef\u7684\u6388\u6743\u540e\uff0csidecar\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u5de5\u4f5c\u8d1f\u8f7d\u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u670d\u52a1\u7684\u76ee\u6807\u89c4\u5219\u4e2d\u6539\u53d8mTLS\u884c\u4e3a\u3002 \u652f\u6301\u7684TLS\u6a21\u5f0f\u6709\uff1a DISABLE\uff08\u65e0TLS\u8fde\u63a5\uff09 SIMPLE \uff08\u5411\u4e0a\u6e38\u7aef\u70b9\u53d1\u8d77TLS\u8fde\u63a5) MUTUAL \uff08\u901a\u8fc7\u51fa\u793a\u5ba2\u6237\u7aef\u8bc1\u4e66\u8fdb\u884c\u8ba4\u8bc1\u6765\u4f7f\u7528 mTLS) ISTIO MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f46\u4f7f\u7528Istio\u81ea\u52a8\u751f\u6210\u7684\u8bc1\u4e66\u8fdb\u884cmTLS) 4-2 \u5141\u8bb8\u6a21\u5f0f \u5141\u8bb8\u6a21\u5f0f\uff08Permissive Mode)\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u9009\u9879\uff0c\u5b83\u5141\u8bb8\u4e00\u4e2a\u670d\u52a1\u540c\u65f6\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u91cf\u548c mTLS \u6d41\u91cf\u3002\u8fd9\u4e2a\u529f\u80fd\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u6539\u5584 mTLS \u7684\u7528\u6237\u4f53\u9a8c\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\u4f7f\u7528\u5141\u8bb8\u6a21\u5f0f\u914d\u7f6e\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u3002Istio\u8ddf\u8e2a\u4f7f\u7528Istio\u4ee3\u7406\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5e76\u81ea\u52a8\u5411\u5176\u53d1\u9001mTLS\u6d41\u91cf\u3002\u5982\u679c\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709\u4ee3\u7406\uff0cIstio\u5c06\u53d1\u9001\u7eaf\u6587\u672c\u6d41\u91cf\u3002 \u5f53\u4f7f\u7528\u5141\u8bb8\u6a21\u5f0f\u65f6\uff0c\u670d\u52a1\u5668\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u91cf\u548cmTLS\u6d41\u91cf\uff0c\u4e0d\u4f1a\u7834\u574f\u4efb\u4f55\u4e1c\u897f\u3002\u5141\u8bb8\u6a21\u5f0f\u7ed9\u4e86\u6211\u4eec\u65f6\u95f4\u6765\u5b89\u88c5\u548c\u914d\u7f6e sidecar \uff0c\u4ee5\u9010\u6b65\u53d1\u9001 mTLS \u6d41\u91cf\u3002 \u4e00\u65e6\u6240\u6709\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u5b89\u88c5\u4e86 sidecar \uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5207\u6362\u5230\u4e25\u683c\u7684 mTLS \u6a21\u5f0f\u3002\u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a PeerAuthentication \u8d44\u6e90\u3002\u6211\u4eec\u53ef\u4ee5\u9632\u6b62\u975e\u53cc\u5411 TLS \u6d41\u91cf\uff0c\u5e76\u8981\u6c42\u6240\u6709\u901a\u4fe1\u90fd\u4f7f\u7528mTLS \u6211\u4eec\u53ef\u4ee5\u521b\u5efa PeerAuthentication \u8d44\u6e90\uff0c\u9996\u5148\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5206\u522b\u6267\u884c\u4e25\u683c\u6a21\u5f0f\u3002 \u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u547d\u540d\u7a7a\u95f4\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f istio-system )\u521b\u5efa\u4e00\u4e2a\u7b56\u7565\uff0c\u5728\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u4e2d\u6267\u884c\u8be5\u7b56\u7565 \uff1a apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: default namespace: istio-system spec: mtls: mode: STRICT \u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6307\u5b9a selector \u5b57\u6bb5\uff0c\u5c06\u7b56\u7565\u4ec5\u5e94\u7528\u4e8e\u7f51\u683c\u4e2d\u7684\u7279\u5b9a\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4e0b\u9762\u7684\u4f8b\u5b50 \u5bf9\u5177\u6709\u6307\u5b9a\u6807\u7b7e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u542f\u7528 STRICT \u6a21\u5f0f \uff1a apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: default namespace: my-namespace spec: selector: matchLabels: app: customers mtls: mode: STRICT 5\u3001 \u6388\u6743 Authorization Can user A send a GET request to /hello on service B? Authn without authz (and vice-versa) is useless Control authenticated principals with AuthorizationPolicy Authorization policy Make use of identities extracted from PeerAuthentication and RequestAuthentication : requestPrincipals (users) principals (service/peer) Defined at mesh, namespace, and workload level Authorization policy Workloads policy applies to Action to take (deny, allow, or audit) Rules when to take action 5-1 \u6388\u6743 \u6388\u6743\u662f\u5bf9\u8bbf\u95ee\u63a7\u5236\u95ee\u9898\u4e2d\u8bbf\u95ee\u63a7\u5236\u90e8\u5206\u7684\u54cd\u5e94\u3002\u67d0\u4e2a\uff08\u7ecf\u8fc7\u8ba4\u8bc1\u7684\uff09\u4e3b\u4f53\u662f\u5426\u88ab\u5141\u8bb8\u64cd\u4f5c\u67d0\u4e2a\u5bf9\u8c61\uff1f\u7528\u6237A\u80fd\u5426\u5411\u670d\u52a1B\u7684\u8def\u5f84 /hello \u53d1\u9001\u4e00\u4e2aGET\u8bf7\u6c42\uff1f \u8bf7\u6ce8\u610f\uff0c\u5c3d\u7ba1\u4e3b\u4f53\u53ef\u4ee5\u88ab\u8ba4\u8bc1\uff0c\u4f46\u5b83\u53ef\u80fd\u4e0d\u88ab\u5141\u8bb8\u6267\u884c\u67d0\u4e2a\u52a8\u4f5c\u3002\u4f60\u7684\u516c\u53f8\u65e7\u5361\u53ef\u80fd\u662f\u6709\u6548\u7684\u3001\u771f\u5b9e\u7684\uff0c\u4f46\u6211\u4e0d\u80fd\u7528\u5b83\u6765\u8fdb\u5165\u53e6\u4e00\u5bb6\u516c\u53f8\u7684\u529e\u516c\u5ba4\u3002\u5982\u679c\u6211\u4eec\u7ee7\u7eed\u4e4b\u524d\u7684\u6d77\u5173\u5b98\u5458\u7684\u6bd4\u55bb\uff0c\u6211\u4eec\u53ef\u4ee5\u8bf4\u6388\u6743\u7c7b\u4f3c\u4e8e\u4f60\u62a4\u7167\u4e0a\u7684\u7b7e\u8bc1\u7ae0\u3002 \u8fd9\u5c31\u5f15\u51fa\u4e86\u4e0b\u4e00\u4e2a\u95ee\u9898\u2014\u2014\u6709\u8ba4\u8bc1\u800c\u65e0\u6388\u6743\uff08\u53cd\u4e4b\u4ea6\u7136\uff09\u5bf9\u6211\u4eec\u6ca1\u6709\u4ec0\u4e48\u597d\u5904\u3002\u5bf9\u4e8e\u9002\u5f53\u7684\u8bbf\u95ee\u63a7\u5236\uff0c\u6211\u4eec\u9700\u8981\u4e24\u8005\u3002 \u8ba9\u6211\u7ed9\u4f60\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5982\u679c\u6211\u4eec\u53ea\u8ba4\u8bc1\u4e3b\u4f53\u800c\u4e0d\u6388\u6743\u4ed6\u4eec\uff0c\u4ed6\u4eec\u5c31\u53ef\u4ee5\u505a\u4efb\u4f55\u4ed6\u4eec\u60f3\u505a\u7684\u4e8b\uff0c\u5bf9\u4efb\u4f55\u5bf9\u8c61\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002\u76f8\u53cd\uff0c\u5982\u679c\u6211\u4eec\u6388\u6743\u4e86\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f46\u6211\u4eec\u6ca1 \u6709\u8ba4\u8bc1\u5b83\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5047\u88c5\u6210\u5176\u4ed6\u4eba\uff0c\u518d\u6b21\u5bf9\u4efb\u4f55\u5bf9\u8c61\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002 Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528 AuthorizationPolicy \u8d44\u6e90\u5728\u7f51\u683c\u3001\u547d\u540d\u7a7a\u95f4\u548c\u5de5\u4f5c\u8d1f\u8f7d\u5c42\u9762\u5b9a\u4e49\u8bbf\u95ee\u63a7\u5236\u3002 AuthorizationPolicy \u652f\u6301 DENY \u3001 ALLOW \u3001 AUDIT \u548c CUSTOM \u64cd\u4f5c\u3002 \u6bcf\u4e2a Envoy \u4ee3\u7406\u5b9e\u4f8b\u90fd\u8fd0\u884c\u4e00\u4e2a\u6388\u6743\u5f15\u64ce \uff0c\u5728\u8fd0\u884c\u65f6\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6388\u6743\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe\u4ee3\u7406\u65f6\uff0c\u5f15\u64ce\u4f1a\u6839\u636e\u6388\u6743\u7b56\u7565\u8bc4\u4f30\u8bf7\u6c42\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u8fd4\u56de ALLOW \u6216 DENY \u3002 AUDIT \u52a8\u4f5c\u51b3\u5b9a\u662f\u5426\u8bb0\u5f55\u7b26\u5408\u89c4\u5219\u7684\u8bf7\u6c42\u3002\u6ce8\u610f AUDIT \u7b56\u7565\u5e76\u4e0d\u5f71\u54cd\u8bf7\u6c42\u88ab\u5141\u8bb8\u6216\u62d2\u7edd\u3002 \u6ca1\u6709\u5fc5\u8981\u660e\u786e\u5730\u542f\u7528\u6388\u6743\u529f\u80fd\u3002 \u4e3a\u4e86\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u6765\u5e94\u7528\u4e8e\u6211\u4eec\u7684\u5de5\u4f5c\u8d1f\u8f7d AuthorizationPolicy \u8d44\u6e90\u662f\u6211\u4eec\u53ef\u4ee5\u5229\u7528 PeerAuthentication \u7b56\u7565\u548c RequestAuthentication \u7b56\u7565\u4e2d\u7684\u4e3b\u4f53\u7684\u5730\u65b9 \u3002 \u5728\u5b9a\u4e49 Authorizationpolicy \u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u8003\u8651\u4e09\u4e2a\u90e8\u5206\uff0e \u9009\u62e9\u8981\u5e94\u7528\u8be5\u7b56\u7565\u7684\u5de5\u4f5c\u8d1f\u8f7d \u8981\u91c7\u53d6\u7684\u884c\u52a8\uff08\u62d2\u7edd\u3001\u5141\u8bb8\u6216\u5ba1\u8ba1\uff09 \u91c7\u53d6\u8be5\u884c\u52a8\u7684\u89c4\u5219 \u6211\u4eec\u770b\u770b\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u5982\u4f55\u4e0e Authonizationpolicy \u8d44\u6e90\u4e2d\u7684\u5b57\u6bb5\u76f8\u5bf9\u5e94\uff0e apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: customers-deny namespace: default spec: selector: matchLabels: app: customers version: v2 action: DENY rules: - from: - source: notNamespaces: [\"default\"] \u4f7f\u7528 selector \u548c matchLabels \uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u7b56\u7565\u6240\u9002\u7528\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 \u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u6211\u4eec\u9009\u62e9\u7684\u662f\u6240\u6709\u8bbe\u7f6e\u4e86 app: customers \u548c version: v2 \u6807\u7b7e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 action \u5b57\u6bb5\u88ab\u8bbe\u7f6e\u4e3a DENY \u6700\u540e\uff0c\u6211\u4eec\u5728 rules \u5b57\u6bb5\u4e2d\u5b9a\u4e49\u6240\u6709\u89c4\u5219\u3002\u6211\u4eec\u4f8b\u5b50\u4e2d\u7684\u89c4\u5219\u662f\u8bf4\uff0c\u5f53\u8bf7\u6c42\u6765\u81ea default \u547d\u540d\u7a7a\u95f4\u4e4b\u5916\u65f6\u62d2\u7edd customers v2 \u5de5\u4f5c\u8d1f\u8f7d\u7684\u8bf7\u6c42(action)\u3002 \u9664\u4e86\u89c4\u5219\u4e2d\u7684from\u5b57\u6bb5\u5916\uff0c \u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 to \u548c when \u5b57\u6bb5\u8fdb\u4e00\u6b65\u5b9a\u5236\u89c4\u5219\u3002\u8ba9\u6211\u4eec\u770b\u4e00\u4e2a\u4f7f\u7528\u8fd9\u4e9b\u5b57\u6bb5\u7684\u4f8b\u5b50 apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: customers-deny namespace: default spec: selector: matchLabels: app: customers version: v2 action: DENY rules: - from: - source: notNamespaces: [\"default\"] - to: - operation: methods: [\"GET\"] - when: - key: request.headers [User-Agent] values: [\"Mozilla/*\"] \u6211\u4eec\u5728\u89c4\u5219\u90e8\u5206\u6dfb\u52a0\u4e86 to \u548c when \u5b57\u6bb5\u3002\u5982\u679c\u6211\u4eec\u7ffb\u8bd1\u4e00\u4e0b\u4e0a\u9762\u7684\u89c4\u5219\uff0c\u6211\u4eec\u53ef\u4ee5\u8bf4\uff0c\u5f53\u5ba2\u6237\u7684GET\u8bf7\u6c42\u6765\u81ea default \u547d\u540d\u7a7a\u95f4\u4e4b\u5916\uff0c\u5e76\u4e14 User Agent \u5934\u7684\u503c\u4e0e\u6b63\u5219\u8868\u8fbe\u5f0f Mozilla/* \u76f8\u5339\u914d\u65f6\uff0c\u6211\u4eec\u4f1a\u62d2\u7edd customers v2 \u7684\u5de5\u4f5c\u8d1f\u8f7d \u3002 \u603b\u7684\u6765\u8bf4\uff0c to \u5b9a\u4e49\u4e86\u7b56\u7565\u6240\u5141\u8bb8\u7684\u884c\u52a8\uff0c from \u5b9a\u4e49\u4e86\u8c01\u53ef\u4ee5\u91c7\u53d6\u8fd9\u4e9b\u884c\u52a8\uff0c when \u5b9a\u4e49\u4e86\u6bcf\u4e2a\u8bf7\u6c42\u5fc5\u987b\u5177\u5907\u7684\u5c5e\u6027\uff0c\u4ee5\u4fbf\u88ab\u7b56\u7565\u6240\u5141\u8bb8\uff0c selector \u5b9a\u4e49\u4e86\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u5c06\u6267\u884c\u8be5\u7b56\u7565\u3002 \u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c \u5219\u9996\u5148\u8bc4\u4f30\u62d2\u7edd\u7684\u7b56\u7565 \u3002\u8bc4\u4f30\u9075\u5faa\u8fd9\u4e9b\u89c4\u5219\uff1a \u5982\u679c\u6709\u4e0e\u8bf7\u6c42\u76f8\u5339\u914d\u7684 DENY \u7b56\u7565\uff0c\u5219\u62d2\u7edd\u8be5\u8bf7\u6c42 \u5982\u679c\u6ca1\u6709\u9002\u5408\u8be5\u5de5\u4f5c\u8d1f\u8f7d\u7684 ALLOW \u7b56\u7565\uff0c\u5219\u5141\u8bb8\u8be5\u8bf7\u6c42 \u5982\u679c\u6709\u4efb\u4f55 ALLOW \u7b56\u7565\u4e0e\u8be5\u8bf7\u6c42\u76f8\u5339\u914d\uff0c\u5219\u5141\u8bb8\u8be5\u8bf7\u6c42\uff0e \u62d2\u7edd\u8be5\u8bf7\u6c42 5-2 \u6765\u6e90 \u6211\u4eec\u5728\u4e0a\u8ff0\u4f8b\u5b50\u4e2d\u4f7f\u7528\u7684\u6e90\u662f notNameepaces \uff0e\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u4efb\u4f55\u4e00\u4e2a\u5b57\u6bb5\u6765\u6307\u5b9a\u8bf7\u6c42\u7684\u6765\u6e90\u5982\u8868\u4e2d\u6240\u793a\uff0e 5-4 \u64cd\u4f5c \u64cd\u4f5c\u88ab\u5b9a\u4e49\u5728 to \u5b57\u6bb5\u4e0b\uff0c\u5982\u679c\u591a\u4e8e\u4e00\u4e2a\uff0c\u5219\u4f7f\u7528AND\u8bed\u4e49\u3002\u5c31\u50cf\u6765\u6e90\u4e00\u6837\uff0c\u64cd\u4f5c\u662f\u6210\u5bf9\u7684\uff0c\u6709\u6b63\u53cd\u4e24\u9762\u7684\u5339\u914d\u3002\u8bbe\u7f6e\u5728\u64cd\u4f5c\u5b57\u6bb5\u7684\u503c\u662f\u5b57\u7b26\u4e32 hosts \u548c notHosts ports \u548c notPorts methods \u548c notMethods paths \u548c notPath \u6240\u6709\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u9002\u7528\u4e8e\u8bf7\u6c42\u5c5e\u965b\u3002\u4f8b\u5982\uff0c\u8981\u5728\u4e00\u4e2a\u7279\u5b9a\u7684\u8bf7\u6c42\u8def\u5f84\u4e0a\u8fdb\u884c\u5339\u914d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8def\u5f84\u3002 \uff3b\"/api/*\",\"/admin\"\uff3d \u6216\u7279\u5b9a\u7684\u7aef\u53e3 ports: [\"8080\"] \uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002 5-5 \u6761\u4ef6 \u4e3a\u4e86\u6307\u5b9a\u6761\u4ef6\uff0c\u6211\u4eec\u5fc5\u987b\u63d0\u4f9b\u4e00\u4e2a key \u5b57\u6bb5\u3002 key \u5b57\u6bb5\u662f\u4e00\u4e2a Istio \u5c5e\u6027\u7684\u540d\u79f0\u3002\u4f8b\u5982\uff0c requsst.headers \u3001 source.ip \u3001 destinatisn.port \u7b49\u7b49\u3002 \u6761\u4ef6\u7684\u7b2c\u4e8c\u90e8\u5206\u662f values \u6216 notValues \u7684\u5b57\u7b26\u4e32\u5217\u8868\u3002\u4e0b\u9762\u662f\u4e00\u4e2a when \u6761\u4ef6\u7684\u7247\u6bb5\uff1a ... - when: - key: source.ip notValues: [\"10.0.1.1\"] 6\u3001\u5b9e\u9a8c1 \u542f\u7528mTLS \u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u90e8\u7f72\u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\uff08WebFrontend\u548cCustomers\u670d\u52a1\uff09\u3002 Web\u524d\u7aef\u7684\u90e8\u7f72\u5c06\u4e0d\u5305\u542bEnvoy\u4ee3\u7406sidecar\uff0c\u800cCustomers\u670d\u52a1\u5c06\u88ab\u6ce8\u5165sidecar \u3002\u901a\u8fc7\u8fd9\u4e2a\u8bbe\u7f6e\uff0c\u6211\u4eec\u5c06\u770b\u5230Istio\u5982\u4f55\u540c\u65f6\u53d1\u9001mTLS\u548c\u7eaf\u6587\u672c\u6d41\u91cf\uff0c\u4ee5\u53ca\u5982\u4f55\u5c06TLS\u6a21\u5f0f\u6539\u4e3aSTRICT\u3002 \u8ba9\u6211\u4eec\u4ece\u90e8\u7f72\u4e00\u4e2aGateway\u8d44\u6e90\u5f00\u59cb\uff1a 1gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' $ kubectl apply -f 1gateway.yaml gateway.networking.istio.io/gateway created $ kubectl get gateway NAME AGE gateway 2m41s \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u521b\u5efa WebFrontend \u548c Customers \u670d\u52a1\u7684\u90e8\u7f72\u4ee5\u53ca\u76f8\u5173\u7684 Kubernetes \u5728\u670d\u52a1\u3002\u5f00\u59cb\u90e8\u7f72\u4e4b\u524d\uff0c \u6211\u4eec\u5c06\u7981\u7528 default \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u81ea\u52a8 sidecar \u6ce8\u5165\uff0c \u8fd9\u6837\u4ee3\u7406\u5c31\u4e0d\u88ab\u6ce8\u5165\u5230 Web \u524d\u7aef\u90e8\u7f72\u4e2d\u3002\u5728\u6211\u4eec\u90e8\u7f72 Customers \u670d\u52a1\u4e4b\u524d\uff0c\u6211\u4eec\u5c06\u518d\u6b21\u542f\u7528\u6ce8\u5165 \u3002 $ kubectl label namespace default istio-injection- namespace/default labeled \u7981\u7528\u6ce8\u5165\u540e\uff0c\u90e8\u7f72 web-frontend 2webfrontend.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 3customersv1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 $ kubectl apply -f 2webfrontend.yaml deployment.apps/web-frontend created service/web-frontend created virtualservice.networking.istio.io/web-frontend created \u5982\u679c\u6211\u4eec\u770b\u4e00\u4e0b\u6b63\u5728\u8fd0\u884c\u7684Pod\uff0c\u6211\u4eec\u5e94\u8be5\u770b\u5230\u6709\u4e00\u4e2aPod\u6b63\u5728\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\uff0c\u7531READY\u680f\u4e2d\u76841/1\u8868\u793a\uff1a $ kubectl get pod NAME READY STATUS RESTARTS AGE web-frontend-69b64f974c-cr79v 1/1 Running 0 29s \u542f\u7528\u81ea\u52a8\u6ce8\u5165\uff1a $ kubectl label namespace default istio-injection=enabled namespace/default labeled \u90e8\u7f72Customers\u670d\u52a1\u7684 v1 \u7248\u672c 3customersv1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 $ kubectl apply -f 3customersv1.yaml deployment.apps/customers-v1 created service/customers created virtualservice.networking.istio.io/customers created $ kubectl get pod NAME READY STATUS RESTARTS AGE customers-v1-7b5b4b76fc-zttpn 2/2 Running 0 21s web-frontend-69b64f974c-cr79v 1/1 Running 0 21m \u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u4ece GATEWAY_URL \u8bbf\u95ee\u7f51\u9875\uff0c\u6211\u4eec\u4f1a\u5f97\u5230\u5e26\u6709\u5ba2\u670d\u4eba\u5458\u56de\u5e94\u7684\u7f51\u9875\u3002 \u8bbf\u95ee GATEWAY_URL \u4e4b\u6240\u4ee5\u6709\u6548\uff0c\u662f\u56e0\u4e3a\u91c7\u7528\u4e86\u8bb8\u53ef\u6a21\u5f0f\uff0c\u7eaf\u6587\u672c\u6d41\u91cf\u88ab\u53d1\u9001\u5230\u6ca1\u6709\u4ee3\u7406\u7684\u670d\u52a1\u3002\u5728\u8fd9\u79cd\u6e05\u51b5\u4e0b\uff0c\u5165\u53e3\u7f51\u5173\u5c06\u7eaf\u6587\u672c\u6d41\u91cf\u53d1\u9001\u5230Web\u524d\u7aef\uff0c\u56e0\u4e3a\u6ca1\u6709\u4ee3\u7406 \u5982\u679c\u6211\u4eec\u7528 istioctl dashboard kiali \u6253\u5f00Kiali\uff0c\u770b\u4e00\u4e0bGraph\uff0c\u4f60\u4f1a\u53d1\u73b0Kiali\u68c0\u6d4b\u5230\u4ece\u5165\u53e3\u7f51\u5173\u5230Web\u524d\u7aef\u7684\u8c03\u7528\u3002\u7136\u800c\uff0c\u5bf9Customers\u670d\u52a1\u7684\u8c03\u7528\u662f\u6765\u81ea\u672a\u77e5\u7684\u670d\u52a1\u3002\u8fd9\u662f\u56e0\u4e3aWeb\u524d\u7aef\u65c1\u8fb9\u6ca1\u6709\u4ee3\u7406\uff0cIstio\u4e0d\u77e5\u9053\u8fd9\u4e2a\u670d\u52a1\u662f\u8c01\u3001\u5728\u54ea\u91cc\u3001\u662f\u4ec0\u4e48\u3002 \u8ba9\u6211\u4eec\u66f4\u65b0 Customers \u7684 Virtualservice \u5e76\u5c06\u7f51\u5173\u9644\u52a0\u5230\u5b83\u4e0a\u9762\u3002\u8fd9\u5c06\u4f7f\u6211\u4eec\u80fd\u591f\u76f4\u63a5\u8c03\u7528 Customers \u7684\u670d\u52a1 4vscustomersgateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' gateways: - gateway http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 $ kubectl apply -f 4vscustomersgateway.yaml virtualservice.networking.istio.io/customers configured \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a Host \u5934\u4e86\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5165\u53e3\u7f51\u5173( GATEWAY_URL )\u5c06\u8bf7\u6c42\u53d1\u9001\u5230 Customers \u670d\u52a1\uff1a $ curl -H \"Host: customers.default.svc.cluster.local\" http://127.0.0.1 [{\"name\":\"Jewel Schaefer\"},{\"name\":\"Raleigh Larson\"},{\"name\":\"Eloise Senger\"},{\"name\":\"Moshe Zieme\"},{\"name\":\"Filiberto Lubowitz\"},{\"name\":\"Ms.Kadin Kling\"},{\"name\":\"Jennyfer Bergstrom\"},{\"name\":\"Candelario Rutherford\"},{\"name\":\"Kenyatta Flatley\"},{\"name\":\"Gianni Pouros\"}] \u4e3a\u4e86\u901a\u8fc7Ingress\u7ed9Web\u524d\u7aef\u548cCustomers\u670d\u52a1\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf\uff0c\u6253\u5f00\u4e24\u4e2a\u7ec8\u7aef\u7a97\u53e3\uff0c\u5206\u522b\u8fd0\u884c\u4e00\u6761\u547d\u4ee4\uff1a // Terminal1 while true; do curl -H \"Host: customers.default.svc.cluster.local\" http://127.0.0.1; done // Terminal2 while true; do curl http://127.0.0.1/; done \u6253\u5f00Kiali\uff0c\u770b\u4e00\u4e0b\u56fe\u8868\u3002\u5728Display\u4e0b\u62c9\u83dc\u5355\u4e2d\uff0c\u786e\u4fdd\u6211\u4eec\u9009\u4e2dSecurity\u9009\u9879\u3002\u4f60\u5e94\u8be5\u770b\u5230\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u4e0b\u56fe\u7684\u56fe\u8868 \u6ce8\u610f\u5728\u5165\u53e3\u7f51\u5173\u548c Customers \u670d\u52a1\u4e4b\u95f4\u6709\u4e00\u4e2a\u6302\u9501\u56fe\u6807\uff0c\u8fd9\u610f\u6627\u7740\u6d41\u91cf\u662f\u4f7f\u7528mTLS\u53d1\u9001\u7684\u3002 \u5982\u679c\u4f60\u6ca1\u6709\u770b\u5230\u6302\u9501\u56fe, \u6807\u8bf7\u70b9\u51fb Display \u4e8c\u4e0b\u62c9\u83dc\u5355\uff0c\u786e\u4fdd Security \u9009\u9879\u88ab\u9009\u4e2d\u3002 \u7136\u800c\uff0c\u5728\u672a\u77e5\u7684\uff08web\u524d\u7aef\uff09\u548cCustomers\u670d\u52a1\u4e4b\u95f4\uff0c\u4ee5\u53ca istio-ingress-gateway \u548c web \u524d\u7aef\u4e4b\u95f4\uff0c\u90fd\u6ca1\u6709\u6302\u9501\u3002 Istio \u5728\u6ca1\u6709\u6ce8\u5165 sidecar \u7684\u6e05\u51b5\u4e0b\u5411\u670d\u52a1\u53d1\u9001\u7eaf\u6587\u672c\u6d41\u91cf\u3002 \u8ba9\u6211\u4eec\u770b\u770b\u5982\u679c\u6211\u4eec\u5728 STRICT \u6a21\u5f0f\u4e0b\u542f\u7528 mTLS \u4f1a\u53d1\u751f\u4ec0\u4e48\u3002 \u6211\u4eec\u9884\u8ba1\u4ece\u524d\u7aef\u5230 Customers \u670d\u52a1\u7684\u8c03\u7528\u4f1a\u5f00\u59cb\u5931\u8d25\uff0c\u56e0\u4e3a\u6ca1\u6709\u6ce8\u5165\u4ee3\u7406\u6765\u8fdb\u884c mTLS \u901a\u4fe1\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4ece\u5165\u53e3\u7f51\u5173\u5230 Customers \u670d\u52a1\u7684\u8c03\u7528\u5c06\u7ee7\u7eed\u5de5\u4f5c 5strictmtls.yaml apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: default namespace: default spec: mtls: mode: STRICT $ kubectl apply -f 5strictmtls.yaml peerauthentication.security.istio.io/default created \u5982\u679c\u6211\u4eec\u4ecd\u7136\u5728\u8fd0\u884c\u8bf7\u6c42\u5faa\u73af\uff0c\u6211\u4eec\u5c06\u5f00\u59cb\u770b\u5230\u6765\u81ea web \u524d\u7aef\u7684 ECONNRESET \u9519\u8bef\u4fe1\u606f\u3002 \u8fd9\u4e2a\u9519\u8bef\u8868\u660e\uff0cCustomers\u7aef\u5173\u95ed\u4e86\u8fde\u63a5\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u671f\u5f85\u7740\u4e00\u4e2a mTLS \u8fde\u63a5 CONNRESET\"\"read ECONNRESET\"\"read ECONNRESET\"^C \u53e6\u4e00\u65b9\u9762\uff0c\u6211\u4eec\u76f4\u63a5\u5411 Customers \u670d\u52a1\u53d1\u51fa\u7684\u8bf7\u6c42\u7ee7\u7eed\u5de5\u4f5c\uff0c\u56e0\u4e3a Customers \u670d\u52a1\u65c1\u8fb9\u6709\u4e00\u4e2a Envoy \u4ee3\u7406\u5728\u8fd0\u884c\uff0c\u5b83\u53ef\u4ee5\u8fdb\u884c mTLS \u5982\u679c\u6211\u4eec\u5220\u9664\u4e4b\u524d\u90e8\u7f72\u7684 PeerAuthentication \u8d44\u6e90( kubectl delete peerauthentication default ),Istio\u5c31\u4f1a\u961f\u590d\u5230\u9ed8\u8ba4\u72b6\u6001\uff08 PERMISSIVE \u6a21\u5f0f\uff09\uff0c\u9519\u8bef\u4e5f\u4f1a\u6d88\u5931 7\u3001\u5b9e\u9a8c2 \u8bbf\u95ee\u63a7\u5236 \u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u6388\u6743\u7b56\u7565\u6765\u63a7\u5236\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u7684\u8bbf\u95ee\u3002 \u9996\u5148\u90e8\u7f72 Gateway 1gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' $ kubectl apply -f 1gateway.yaml gateway.networking.istio.io/gateway created \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u521b\u5efaWeb\u524d\u7aef\u90e8\u7f72\u3001\u670d\u52a1\u8d26\u6237\u3001\u670d\u52a1\u548c VirtualService . 2webfrontend.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-frontend --- apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: serviceAccountName: web-frontend containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 $ kubectl apply -f 2webfrontend.yaml serviceaccount/web-frontend created deployment.apps/web-frontend created service/web-frontend created virtualservice.networking.istio.io/web-frontend created 3customersv1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 $ kubectl apply -f 3customersv1.yaml deployment.apps/customers-v1 created service/customers created virtualservice.networking.istio.io/customers created $ kubectl get vs NAME GATEWAYS HOSTS AGE customers [\"customers.default.svc.cluster.local\"] 6s web-frontend [\"gateway\"] [\"*\"] 19s \u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u4ece GATEWAY_URL \u8bbf\u95ee\u7f51\u9875\uff0c\u6211\u4eec\u4f1a\u5f97\u5230\u5e26\u6709\u5ba2\u670d\u4eba\u5458\u56de\u5e94\u7684\u7f51\u9875\u3002 7-1 \u6388\u6743\u7b56\u7565\u62d2\u7edd \u8ba9\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u62d2\u7edd default \u547d\u540d\u7a7a\u95f4\u7684\u6240\u6709\u8bf7\u6c42 4denyall.yaml apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: deny-all namespace: default spec: {} $ kubectl apply -f 4denyall.yaml authorizationpolicy.security.istio.io/deny-all created \u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u4ece GATEWAY_URL \u8bbf\u95ee\u7f51\u9875\u3002 RBAC: access denied \u540c\u6837\u5982\u679c\u6211\u4eec\u8bd5\u56fe\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\u4e00\u4e2aPod\u5e76\u4ece default \u547d\u540d\u7a7a\u95f4\u5185\u5411 Web \u524d\u7aef\u6216 customers \u670d\u52a1\u63d0\u51fa\u8bf7\u6c42\u6211\u4eec\u4f1a\u5f97\u5230\u540c\u6837\u7684\u9519\u8bef $ kubectl run curl --image=radial/busyboxplus:cur l -i --ttykubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a futu re version. Use kubectl run --generator=run-pod/v1 or kubectl create instead. If you don't see a command prompt, try pressing enter. [ root@curl-6cd5b579fb-2xcx9:/ ]$ curl customers RBAC: access denied [ root@curl-6cd5b579fb-2xcx9:/ ]$ curl web-frontend RBAC: access denied \u5728\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u90fd\u5f97\u5230\u4e86\u62d2\u7edd\u8bbf\u95ee\u7684\u9519\u8bef 7-2 ALLOW \u52a8\u4f5c\u5141\u8bb8\u4ece\u5165\u53e3\u7f51\u5173\u5411web-frontend \u6211\u4eec\u8981\u505a\u7684\u7b2c\u4e00\u4ef6\u4e8b\u662f\u4f7f\u7528 ALLOW \u52a8\u4f5c\u5141\u8bb8\u4ece\u5165\u53e3\u7f51\u5173\u5411 web-frontend \u5e94\u7528\u7a0b\u5e8f\u53d1\u9001\u8bf7\u6c42 \u3002\u5728\u89c4\u5219\u4e2d\u6211\u4eec\u6307\u5b9a\u4e86\u5165\u53e3\u7f51\u5173\u8fd0\u884c\u7684\u6e90\u547d\u540d\u7a7a\u95f4\uff08 istio-system \uff09\u548c\u5165\u53e3\u7f51\u5173\u7684\u670d\u52a1\u8d26\u6237\u540d\u79f0 5allow-webfrontend-customers.yaml apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: allow-ingress-frontend namespace: default spec: selector: matchLabels: app: web-frontend action: ALLOW rules: - from: - source: namespaces: [\"istio-system\"] - source: principals: [\"istio-ingressgateway-service-account\"] - source: principals: [\"cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"] $ kubectl apply -f 5allowingressfrontend.yaml authorizationpolicy.security.istio.io/allow-ingress-frontend created $ curl http://127.0.0.1 \"Request failed with status code 403\" \u8bf7\u6ce8\u610f\u7b56\u5cea\u9700\u8981\u51e0\u79d2\u949f\u624d\u80fd\u5206\u53d1\u5230\u6240\u6709\u4ee3\u7406\u6240\u4ee5\u4f60\u53ef\u80fd\u4ecd\u7136\u4f1a\u770b\u5230 node: access denied \u7684\u6d88\u606f\u65f6\u95f4\u4e3a\u51e0\u79d2\u949f \u8fd9\u4e2a\u9519\u8bef\u6765\u81ea customers \u670d\u52a1\u2014\u2014\u8bb0\u5f97\u6211\u4eec\u5141\u8bb8\u8c03\u7528Web\u524d\u7aef\u3002 \u7136\u800c web-fronted \u4ecd\u7136\u4e0d\u80fd\u8c03\u7528 customers \u670d\u52a1 \u5982\u679c\u6211\u4eec\u56de\u5230\u6211\u4eec\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\u7684 curl Pod \u5c1d\u8bd5\u8bf7\u6c42 http://web-fronted \u6211\u4eec\u4f1a\u5f97\u5230\u4e00\u4e2aRBAC\u9519\u8bef\u3002DENY\u7b56\u7565\u662f\u6709\u6548\u7684\u6211\u4eec\u53ea\u5141\u8bb8\u4ece\u5165\u53e3\u7f51\u5173\u8fdb\u884c\u8c03\u7528 \u5f53\u6211\u4eec\u90e8\u7f72Web\u524d\u7aef\u65f6\u6211\u4eec\u4e5f\u4e3aPod\u521b\u5efa\u4e86\u4e00\u4e2a\u670d\u52a1\u8d26\u6237\uff08\u5426\u5219\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709Pod\u90fd\u88ab\u5206\u914d\u4e86\u9ed8\u8ba4\u7684\u670d\u52a1\u8d26\u6237\uff09\u3002\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8be5\u670d\u52a1\u8d26\u6237\u6765\u6307\u5b9acustomers\u670d\u52a1\u8c03\u7528\u7684\u6765\u6e90\uff0e 6allowwebfrontendcustomers.yaml apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: allow-web-frontend-customers namespace: default spec: selector: matchLabels: app: customers version: v1 action: ALLOW rules: - from: - source: namespaces: [\"default\"] - source: principals: [\"web-frontend\"] principals: [\"cluster.local/ns/default/sa/web-frontend\"] $ kubectl apply -f 6allowwebfrontendcustomers.yaml authorizationpolicy.security.istio.io/allow-web-frontend-customers created \u4e00\u65e6\u7b56\u7565\u88ab\u521b\u5efa\u6211\u4eec\u5c06\u770b\u5230Web\u524d\u7aef\u518d\u6b21\u5de5\u4f5c\u2015\u5b83\u5c06\u83b7\u5f97customers\u670d\u52a1\u7684\u56de\u5e94 $ curl http://127.0.0.1 <!DOCTYPE html> ... \u6211\u4eec\u4f7f\u7528\u4e86\u591a\u4e2a\u6388\u6743\u7b56\u7565\u660e\u786e\u5730\u5141\u8bb8\u961f\u5165\u53e3\u5230\u524d\u7aef\u4ee5\u53ca\u961f\u524d\u7aef\u5230 customers \u670d\u52a1\u7684\u8c03\u7528\u3002 \u4f7f\u7528 deny-all \u7b56\u7565\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u5f00\u59cb\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u3001\u7ba1\u7406\u7136\u540e\u660e\u786e\u5730\u5141\u8bb8\u6211\u4eec\u5e0c\u671b\u5728\u670d\u52a1\u4e4b\u95f4\u53d1\u751f\u7684\u901a\u4fe1 8\u3001\u5b89\u5168\u6d4b\u8bd5 1\u3001\u5728\u901a\u4fe1\u65f6\uff0cEnvoy\u4ee3\u7406\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u51ed\u8bc1\uff1f A \u7528\u6237\u548c\u5bc6\u7801 B API\u79d8\u94a5 C Token D X509\u8bc1\u4e66 Validating the X.509 to authenticate the SPIFFE identity 2\u3001\u54ea\u4e2a\u7ec4\u4ef6\u4e3a\u4e00\u4e2a\u670d\u52a1\u8d26\u6237\u521b\u5efaSPIFFE\u8eab\u4efd\uff1f A Pilot B Citadel C Mixer D Envoy SDS \u6bcf\u6b21\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u8d26\u6237\u65f6, Citadel\u90fd\u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2aSPIFFE\u8eab\u4efd\u3002 3\u3001\u4f60\u4f1a\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u542f\u7528\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4e25\u683cmTLS\u6a21\u5f0f\uff1f A IstioAuth B ClusterRole C PeerAuthentication D Auth apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: default namespace: default spec: mtls: mode: STRICT 4\u3001AuthorizationPolicy\u8d44\u6e90\u4e2d\u4f7f\u7528\u54ea\u4e24\u4e2a\u52a8\u4f5c\uff1f ACCPET\u548cRJECT VALIDATE\u548cCANCEL DENY\u548cACCEPT DENY\u548cALLOW \u6bcf\u4e2a Envoy \u4ee3\u7406\u5b9e\u4f8b\u90fd\u8fd0\u884c\u4e00\u4e2a\u6388\u6743\u5f15\u64ce \uff0c\u5728\u8fd0\u884c\u65f6\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6388\u6743\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe\u4ee3\u7406\u65f6\uff0c\u5f15\u64ce\u4f1a\u6839\u636e\u6388\u6743\u7b56\u7565\u8bc4\u4f30\u8bf7\u6c42\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u8fd4\u56de ALLOW \u6216 DENY 5\u3001\u5f53\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\uff08SDS)\u66f4\u65b0\u8bc1\u4e66\u65f6\uff0c\u662f\u5426\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u4ee5\u4f7f\u7528\u65b0\u8bc1\u4e66\u3002 A \u662f B \u5426 6\u3001AUDIT\u52a8\u4f5c\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f A \u8bb0\u5f55\u548c\u62d2\u7edd\u8bf7\u6c42\uff0e B \u8bb0\u5f55\u8bf7\u6c42 C \u53d1\u9001\u8c13\u6c42\u901a\u77e5 D \u8bb0\u5f55\u548c\u5141\u8bb8\u8bf7\u6c42 AUDIT \u52a8\u4f5c\u51b3\u5b9a\u662f\u5426\u8bb0\u5f55\u7b26\u5408\u89c4\u5219\u7684\u8bf7\u6c42\u3002\u6ce8\u610f AUDIT \u7b56\u7565\u5e76\u4e0d\u5f71\u54cd\u8bf7\u6c42\u88ab\u5141\u8bb8\u6216\u62d2\u7edd\u3002 7\u3001\u4ec0\u4e48\u662f\u5141\u8bb8\u6a21\u5f0f\uff08permissive mode)? A \u4e00\u4e2a\u5141\u8bb8\u670d\u52a1\u540c\u65f6\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u6700\u548cmTLS\u6d41\u91cf\u7684\u9009\u9879 B \u4e00\u4e2a\u5141\u8bb8\u670d\u52a1\u53ea\u63a5\u53d7\u660e\u6587\u6d41\u91cf\u7684\u9009\u9879 C\u4e00\u4e2a\u5141\u8bb8\u7528\u6237\u76f4\u63a5\u5411\u670d\u52a1\u63d0\u51fa\u8bf7\u6c42\u7684\u9009\u9879 D \u4e00\u4e2a\u5141\u8bb8\u4f60\u4fbf\u7528\u57fa\u4e8e\u4ee4\u724c\u7684\u8ba4\u8bc1\u7684\u9009\u9879 Allows services to accpet both plaintext and mTLS 8\u3001\u662f\u5426\u53ef\u4ee5\u5728Istio\u4e2d\u4f7f\u7528JSON Web Tokens (JWTs)? A \u662f B \u5426 9\u3001\u9009\u62e9\u4e09\u4e2a\u8d1f\u8d35\u5728\u8fd0\u884c\u65f6\u521b\u5efa\u8eab\u4efd\u7684\u7ec4\u4ef6 A Citedel B lstio Agent C Envoys Secret Discovery Service D Pilot E citadel-agent E Envoy proxy 10\u3001\u4f7f\u7528\u8bb8\u53ef\u6a21\u5f0f\u53ef\u4ee5\u6539\u5584mTLS\u7684\u4e0a\u673a\u4f53\u9a8c\u3002 \u662f \u5426 11\u3001 Istlo Agent\u7684\u5de5\u4f5c\u662f\u4ec0\u4e48\uff1f A \u4e0eEnvoy sidecar\u5408\u4f5c\uff0c\u901a\u8fc7\u4e13\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\uff0c\u5e2e\u52a9\u4ed6\u4eec\u94fe\u63a5\u5230Service mesh B \u4e0eIstio PIot\u5408\u4f5c\uff0c\u914d\u7f6eCitadel C \u4e0eCitadel\u5408\u4f5c\uff0c\u5728Ku bernetes\u7684\u79d8\u5bc6\u4e2d\u5bf9\u8bc1\u4e66\u8fdb\u884c\u7f16\u7801 D \u9a8c\u8bc1 ISTIO_MUTUAL \u914d\u7f6e Istio Agent \u4e0e Envoy sidecar \u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c 12\u3001Istlo\u63d0\u4f9b\u54ea\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1f A \u5bf9\u7b49\u548c\u8bf7\u6c42\u8ba4\u8bc1 B JWT\u4ee4\u724c\u548c\u5bc6\u7801\u8ba4\u8bc1 C Istio\u53ea\u63d0\u4f9b\u5bf9\u7b49\u8ba4\u8bc1 D \u591a\u56e0\u7d20\u8ba4\u8bc1\u548c\u5be1\u4e8e\u8bc1\u4e66\u7684\u8ba4\u8bc1 13 Istlo\u4ee3\u7406\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u5b58\u50a8\u5728\u54ea\u91cc\uff1f \u78c1\u76d8 Secret\u4e2d \u5185\u5b58 \u94a5\u5319\u548c\u8bc1\u4e66\u4e0d\u5b58\u50a8\u5728\u4efb\u4f55\u5730\u65b9 Istio\u4ee3\u7406\u4eceCitadel\u83b7\u53d6\u54cd\u5e94\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\u5e76\u901a\u8fc7 SDS \u548c Unix \u57df\u5957\u63a5\u5b87\u5c06\u5176\u63d0\u4f9b\u7ed9 Envoy \u3002 \u5c06\u5bc6\u94a5\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u6bd4\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u66f4\u5b89\u5168 \uff1b \u5728\u4f7f\u7528SDS\u65f6\uff0c\u7edd\u4e0d\u4f1a\u5c06\u4efb\u4f55\u5bc6\u94a5\u5199\u5165\u78c1\u76d8\u3002Istio\u4ee3\u7406\u8fd8\u5b9a\u671f\u5237\u65b0\u51ed\u8bc1\uff0c \u5728\u5f53\u524d\u51ed\u8bc1\u8fc7\u670b\u524d\u4eceCitadel\u68c0\u7d22\u4efb\u4f55\u65b0\u7684SVID(SPIFFE\u53ef\u9a8c\u8bc1\u8eab\u4efd\u6587\u4ef6\uff09 15 \u54ea\u79cd\u4ee3\u7406\u4e0eistiod\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u5b9e\u73b0\u94a5\u5319\u548c\u8bc1\u4e66\u8f6e\u6362\u7684\u81ea\u52a8\u5316 A envoy-agent B pilot-agent C citadel-agent D sds-agent \u4e00\u4e2a\u540d\u4e3a pilot-agent \u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08 istiod \uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c \u3002 16\u3001\u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u54ea\u4e9b\u5185\u5bb9\uff1f A \u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04 B \u52a0\u5bc6\u7684Kubernetes secret C Base64\u7f16\u7801\u7684\u670d\u52a1\u540d\u79f0 D \u5bc6\u7801\u548c\u8bc1\u4e66 \u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04\u3002 17\u3001\u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c\u54ea\u4e9b\u7b56\u7565\u4f1a\u5148\u88ab\u8bc4\u4f30\uff1f Deny \u7b56\u7565 ALLOW\u7b56\u7565 AUDIT\u7b56\u7565 \u7b56\u7565\u662f\u968f\u673a\u8bc4\u4f30\u7684 \u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c \u5219\u9996\u5148\u8bc4\u4f30\u62d2\u7edd\u7684\u7b56\u7565 \u3002 18\u3001\u4f60\u5982\u4f55\u5728Istio\u4e2d\u542f\u7528\u6388\u6743\u529f\u80fd\uff1f A \u521b\u5efaPeerAuthentication \u8d44\u6e90 B \u914d\u7f6eRBAC C \u90e8\u7f72AuthPolicv\u8d44\u6e90 D \u4e0d\u9700\u8981\u660e\u786e\u5730\u542f\u7528\u8be5\u529f\u80fd \u6ca1\u6709\u5fc5\u8981\u660e\u786e\u5730\u542f\u7528\u6388\u6743\u529f\u80fd\u3002 \u4e3a\u4e86\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u6765\u5e94\u7528\u4e8e\u6211\u4eec\u7684\u5de5\u4f5c\u8d1f\u8f7d AuthorizationPolicy \u8d44\u6e90\u662f\u6211\u4eec\u53ef\u4ee5\u5229\u7528 PeerAuthentication \u7b56\u7565\u548c RequestAuthentication \u7b56\u7565\u4e2d\u7684\u4e3b\u4f53\u7684\u5730\u65b9 \u3002 19\u3001Istio\u5982\u4f55\u9a8c\u8bc1\u7528\u6237\uff0f\u8fdb\u7a0b\u7684\u8eab\u4efd\uff1f A \u901a\u8fc7\u63d0\u793a\u5bc6\u7801\uff08\u7528\u6237\uff09\u548cAPI\u79d8\u94a5\uff08\u8fc7\u7a0b\uff09 B \u901a\u8fc7\u4f7f\u7528PeerAuthentication\u8d44\u6e90 C \u901a\u8fc7\u4ece\u8bf7\u6c42\u4e2d\u63d0\u53d6\u51ed\u8bc1 D \u901a\u8fc7\u7b2c\u4e09\u65b9\u670d\u52a1 20\u3001\u5728Kubernetes\u4e2d\uff0c\u54ea\u4e2a\u8d44\u6e90\u4ee3\u8868\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\uff1f A \u7528\u6237\u5bf9\u8c61 B Service Account C Context D \u8bc1\u4e66 21 \u4f60\u5982\u4f55\u5728\u6574\u4e2a\u7f51\u683c\u4e2d\u5f3a\u5236\u6267\u884c\u4e25\u683c\u7684mTLS\u6a21\u5f0f\uff1f A \u901a\u8fc7\u90e8\u7f72\u4e00\u4e2aClusterRoIe\u5e76\u5c06mode\u5b57\u6bb5\u8bbe\u7f6e\u4e3aMUTUAL B \u901a\u8fc7\u90e8\u7f72\u4e00\u4e2aDestinationRule\u5e76\u5c06policy\u8bbe\u7f6e\u4e3a ISTIO_ MUTUAL C \u4f60\u4e0d\u80fd\u5728\u5168\u5c40\u8303\u56f4\u5185\u6267\u884c\u4e25\u683c\u7684mTLS\uff08\u53ea\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\uff09 D \u901a\u8fc7\u5c06 PeerAuthentication \u8d44\u6e90\u90e8\u7f72\u5230\u6839\u547d\u540d\u7a7a\u95f4(Istlo system\uff09\u4e2d \u6211\u4eec\u53ef\u4ee5\u521b\u5efa PeerAuthentication \u8d44\u6e90\uff0c\u9996\u5148\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5206\u522b\u6267\u884c\u4e25\u683c\u6a21\u5f0f\u3002 \u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u547d\u540d\u7a7a\u95f4\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f istio-system )\u521b\u5efa\u4e00\u4e2a\u7b56\u7565\uff0c\u5728\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u4e2d\u6267\u884c\u8be5\u7b56\u7565 \uff1a 22 \u5bf9\u7b49\u8ba4\u8bc1\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684\uff1f A \u7528\u6237\u8ba4\u8bc1 B \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762\u4e4b\u95f4\u7684\u8ba4\u8bc1 C \u5bf9\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684Envoy\u4ee3\u7406\u8fdb\u884c\u8ba4\u8bc1 D \u670d\u52a1\u95f4\u8ba4\u8bc1 23 \u5982\u679cKubernetes\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709Envoy\u4ee3\u7406\uff0cIstio\u662f\u5426\u4f1a\u53d1\u9001mTLS\u6d41\u91cf\uff1f A \u662f B \u5426 24 Authorization Policy\u8d44\u6e90\u4e2d\u7684selector\u548cmatchLabel\u5b57 \u6bb5\u6709\u4ec0\u4e48\u7528\u9014\uff1f A \u8981\u628a\u5de5\u4f5c\u8d1f\u8f7d\u4ece\u7b56\u7565\u4e2d\u6392\u9664\u51fa\u53bb B \u8981\u9009\u62e9\u7b56\u7565\u9002\u7528\u7684\u5de5\u4f5c\u8d1f\u8f7d C \u8981\u62d2\u7edd\u9009\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d D \u5141\u8bb8\u9009\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d","title":"\u7b2c\u516d\u8282 Istio Secuirty"},{"location":"chap8/6Istio_secruity/#istio-secuirty","text":"Authentication Authorization Mutual TLS, secure naming and identity Labs: Enabling mutual TLS Using authorization policies to control access between workloads Quiz","title":"\u7b2c\u516d\u8282 Istio Secuirty"},{"location":"chap8/6Istio_secruity/#1authentication","text":"Authentication Principal = Kubernetes service Action = HTTP request methods (e.g. GET, POST, DELETE, ...) Object = Kubernetes service All about the principal (service identity) \"Validating a credential and ensuring it's both valid and trusted\" Identity Unique identity in Kubernetes = Kubernetes service account X.509 certificate (from SA) + SPIFFE spec = Identity Naming scheme (spiffe://cluster.localinsidefault/sa/my-sa) Encoding names into X.509 Validating the X.509 to authenticate the SPIFFE identity \u4e3a\u4e86\u89e3\u91ca\u4ec0\u4e48\u662f\u8ba4\u8bc1\u6216auth\uff0c\u6211\u4eec\u5c06\u4ece\u8bbf\u95ee\u63a7\u5236\u8bd5\u56fe\u56de\u7b54\u7684\u95ee\u9898\u5f00\u59cb\uff1a\u4e00\u4e2a\u4e3b\u4f53\u80fd\u5426\u64cd\u4f5c\u53e6\u4e00\u4e2a\u5bf9\u8c61\uff1f \u5982\u679c\u6211\u4eec\u628a\u4e0a\u8ff0\u95ee\u9898\u6362\u5230Istio\u548cKubernetes\u8bed\u5883\uff0c\u90a3\u5c06\u662f\u201d\u670d\u52a1x\u80fd\u5426\u64cd\u4f5c\u670d\u52a1Y?\" \u8fd9\u4e2a\u95ee\u9898\u7684\u4e09\u4e2a\u5173\u952e\u90e8\u5206\u662f\uff1a \u59d4\u6258\u4eba\u3001\u52a8\u4f5c\u548c\u5bf9\u8c61 \u3002 \u4e3b\u4f53\u548c\u5bf9\u8c61\u90fd\u662fKubernetes\u4e2d\u7684\u670d\u52a1\u3002\u52a8\u4f5c\uff0c\u5047\u8bbe\u6211\u4eec\u8c08\u8bba\u7684\u662fHTTP\uff0c\u53ef\u4ee5\u662fGET\u3001POST\u6216\u8005PUT\u4e0b\u8bf7\u6c42\u7b49\u7b49\u3002 \u8ba4\u8bc1\u662f\u5173\u4e8e\u59d4\u6258\u4eba\uff08\u6216\u8005\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f\u670d\u52a1\u7684\u8eab\u4efd\uff09\u7684\u3002\u8ba4\u8bc1\u662f\u9a8c\u8bc1\u67d0\u79cd\u51ed\u8bc1\u7684\u884c\u4e3a\uff0c\u5e76\u786e\u4fdd\u8be5\u51ed\u8bc1\u662f\u6709\u6548\u548c\u53ef\u4fe1\u7684\u3002\u4e00\u65e6\u8fdb\u884c\u4e86\u8ba4\u8bc1\uff0c\u6211\u4eec\u5c31\u6709\u4e86\u4e00\u4e2a\u7ecf\u8fc7\u8ba4\u8bc1\u7684\u59d4\u6258\u4eba\u3002\u4e0b\u6b21\u4f60\u65c5\u884c\u65f6\uff0c\u4f60\u5411\u6d77\u5173\u5b98\u5458\u51fa\u793a\u4f60\u7684\u62a4\u7167\u6216\u8eab\u4efd\u8bc1\uff0c\u4ed6\u4eec\u4f1a\u5bf9\u5176\u8fdb\u884c\u8ba4\u8bc1\uff0c\u786e\u4fdd\u4f60\u7684\u51ed\u8bc1\uff08\u62a4\u7167\u6216\u8eab\u4efd\u8bc1\uff09\u662f\u6709\u6548\u548c\u53ef\u4fe1\u7684\u3002 \u5728Kubernetes\u4e2d\uff0c\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u88ab\u5206\u914d\u4e86\u4e00\u4e2a\u72ec\u7279\u7684\u8eab\u4efd\u6765\u4e0e\u5176\u4ed6\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u901a\u4fe1 \u2015\u8be5\u8eab\u4efd\u4ee5\u670d\u52a1\u8d26\u6237\u7684\u5f62\u5f0f\u63d0\u4f9b\u7ed9\u5de5\u4f5c\u8d1f\u8f7d\u3002\u670d\u52a1\u8d26\u6237\u662f\u8fd0\u884c\u65f6\u4e2d\u5b58\u5728\u7684\u8eab\u4efdPod Istio\u4f7f\u7528\u6765\u81ea\u670d\u52a1\u8d26\u6237\u7684 X.509 \u8bc1\u4e66\uff0c \u5b83\u6839\u636e\u540d\u4e3aSPIFFE\uff08\u6bcf\u4e2a\u4eba\u7684\u5b89\u5168\u751f\u4ea7\u8eab\u4efd\u6846\u67b6\uff09 \u7684\u89c4\u8303\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8eab\u4efd\u3002 \u8bc1\u4e66\u4e2d\u7684\u8eab\u4efd\u88ab\u7f16\u7801\u5728\u8bc1\u4e66\u7684 Subject alternate name \u5b57\u6bb5\u4e2d\uff0c\u5b83\u770b\u8d77\u6765\u50cf\u8fd9\u6837\u3002 spiffe://cluster.local/ns/<pod namespace>/sa/<pod service account> \u5f53\u4e24\u4e2a\u670d\u52a1\u5f00\u59cb\u901a\u4fe1\u65f6\uff0c\u5b83\u4eec\u9700\u8981\u4ea4\u6362\u5e26\u6709\u8eab\u4efd\u4fe1\u606f\u7684\u51ed\u8bc1\uff0c\u4ee5\u76f8\u4e92\u9a8c\u8bc1\u81ea\u5df1\u3002\u5ba2\u6237\u7aef\u6839\u636e\u5b89\u5168\u547d\u540d\u4fe1\u606f\u68c0\u67e5\u670d\u52a1\u5668\u7684\u8eab\u4efd\uff0c\u770b\u5b83\u662f\u5426\u662f\u670d\u52a1\u7684\u6388\u6743\u8fd0\u884c\u8005\u3002 \u670d\u52a1\u5668\u6839\u636e\u6388\u6743\u7b56\u7565\u786e\u5b9a\u5ba2\u6237\u53ef\u4ee5\u8bbf\u95ee\u54ea\u4e9b\u4fe1\u606f\u3002\u6b64\u5916\uff0c\u670d\u52a1\u5668\u53ef\u4ee5\u5ba1\u8ba1\u8c01\u5728\u4ec0\u4e48\u65f6\u95f4\u8bbf\u95ee\u4e86\u4ec0\u4e48\uff0c\u5e76\u51b3\u5b9a\u662f\u5426\u6279\u51c6\u6216\u62d2\u7edd\u5ba2\u6237\u5bf9\u670d\u52a1\u5668\u7684\u8c03\u7528\u3002 \u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04\u3002 \u670d\u52a1\u5668\u8eab\u4efd\u662f\u5728\u8bc1\u4e66\u4e2d\u7f16\u7801\u7684\uff0c\u800c\u670d\u52a1\u540d\u79f0\u662f\u7531\u53d1\u73b0\u670d\u52a1\u6216DNS\u4f7f\u7528\u7684\u540d\u79f0\u3002\u4ece\u4e00\u4e2a\u8eab\u4efdA\u5230\u4e00\u4e2a\u670d\u52a1\u540d\u79f0B\u7684\u5355\u4e00\u6620\u5c04\u610f\u6627\u7740\u201dA\u88ab\u5141\u8bb8\u548c\u6388\u6743\u8fd0\u884c\u670d\u52a1B\"\u3002 \u5b89\u5168\u547d\u540d\u4fe1\u606f\u7531Pilot\u751f\u6210\uff0c\u7136\u540e\u5206\u53d1\u7ed9\u6240\u6709sidecar\u4ee3\u7406\u3002","title":"1\u3001\u8ba4\u8bc1(Authentication)"},{"location":"chap8/6Istio_secruity/#2","text":"\u5bf9\u4e8e\u7f51\u683c\u4e2d\u7684\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\uff0cIstio\u63d0\u4f9b\u4e00\u4e2a X.509 \u8bc1\u4e66\u3002 \u4e00\u4e2a\u540d\u4e3a pilot-agent \u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08 istiod \uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c \u3002 Certificate creation Istio Agent Envoy's Secret Discovery Service(SDS) Citadel(part of the control plane) Istio Agent \u4e0e Envoy sidecar \u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c \u3002\u5373\u4fbf Istio \u4ee3\u7406\u5728\u6bcf\u4e2apod\u4e2d\u8fd0\u884c\u6211\u4eec\u4e5f\u8ba4\u4e3a\u5b83\u662f\u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\u3002 \u79d8\u94a5\u53d1\u73b0\u670d\u52a1(SDS)\u7b80\u5316\u4e86\u8bc1\u4e66\u7ba1\u7406\u3002\u5982\u679c\u6ca1\u6709SDS\u8bc1\u4e66\u5fc5\u987b\u4f5c\u4e3a\u79d8\u5bc6(Secret) \u521b\u5efa\uff0c\u7136\u540e\u88c5\u5165\u4ee3\u7406\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002 \u5f53\u8bc1\u4e66\u8fc7\u670b\u65f6\uff0c\u9700\u8981\u66f4\u65b0\u79d8\u5bc6\uff0c\u5e76\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u56e0\u4e3aEnvoy\u4e0d\u4f1a\u4ece\u76d8\u52a8\u6001\u91cd\u65b0\u52a0\u8f7d\u8bc1\u4e66\u3002 \u5f53\u7528SDS\u65f6SDS\u670d\u52a1\u5668\u5c06\u8bc1\u4e66\u63a8\u9001\u7ed9Envoy\u5b9e\u4f8b\u3002 \u6bcf\u5f53\u8bc1\u4e66\u8fc7\u671f\u65f6SDS\u4f1a\u63a8\u9001\u66f4\u65b0\u7684\u8bc1\u4e66Envoy\u53ef\u4ee5\u7acb\u5373\u4fbf\u7528\u5b83\u4eec\u3002\u4e0d\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u670d\u52a1\u5668\u4e5f\u4e0d\u9700\u8981\u4e2d\u65ad\u6d41\u91cf \u3002 \u5728Istio\u4e2dIstio Agent\u4f5c\u4e3aSDS\u670d\u52a1\u5668\u5b9e\u73b0\u4e86\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\u63a5\u53e3 \u6bcf\u6b21\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u8d26\u6237\u65f6, Citadel\u90fd\u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2aSPIFFE\u8eab\u4efd\u3002 \u6bcf\u5f53\u6211\u4eec\u5b89\u6392\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u65f6\uff0c Pilot\u4f1a\u7528\u5305\u62ec\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\u5728\u5185\u7684\u521d\u6021\u5316\u4fe1\u606f\u6765\u914d\u7f6e\u5176sidecar \u5f53\u5de5\u4f5c\u8d1f\u8f7d\u65c1\u8fb9\u7684Envoy\u4ee3\u7406\u542f\u52a8\u65f6\uff0c \u5b83\u4f1a\u8054\u7cfbIstio\u4ee3\u7406\u5e76\u544a\u8bc9\u5b83\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\u3002\u4ee3\u7406\u9a8c\u8bc1\u8be5\u5b9e\u4f8b\u751f\u6210CSR\uff08\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42Certicate Secret Reuqest\uff09\u5c06CSR\u4ee5\u53ca\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\u8bc1\u660e\uff08\u5728Kubernetes\u4e2d\u662fpod\u7684\u670d\u52a1\u8d26\u6237JWT\uff09\u53d1\u9001\u7ed9Citadel\u3002 Citadel\u5c06\u6267\u884c\u8ba4\u8bc1\u548c\u6388\u6743\u5e76\u4ee5\u7b7e\u540d\u7684 X.509 \u8bc1\u4e66\u4f5c\u4e3a\u56de\u5e94\u3002Istio\u4ee3\u7406\u4eceCitadel\u83b7\u53d6\u54cd\u5e94\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\u5e76\u901a\u8fc7 SDS \u548c Unix \u57df\u5957\u63a5\u5b87\u5c06\u5176\u63d0\u4f9b\u7ed9 Envoy \u3002 \u5c06\u5bc6\u94a5\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u6bd4\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u66f4\u5b89\u5168 \uff1b \u5728\u4f7f\u7528SDS\u65f6\uff0c\u7edd\u4e0d\u4f1a\u5c06\u4efb\u4f55\u5bc6\u94a5\u5199\u5165\u78c1\u76d8\u3002Istio\u4ee3\u7406\u8fd8\u5b9a\u671f\u5237\u65b0\u51ed\u8bc1\uff0c \u5728\u5f53\u524d\u51ed\u8bc1\u8fc7\u670b\u524d\u4eceCitadel\u68c0\u7d22\u4efb\u4f55\u65b0\u7684SVID(SPIFFE\u53ef\u9a8c\u8bc1\u8eab\u4efd\u6587\u4ef6\uff09 SVID\u662f\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u6548\u53ef\u4ee5\u7528\u91c7\u5411\u8d44\u6e90\u6216\u8c03\u7528\u8005\u8bc1\u660e\u5176\u8eab\u4efd\u7684\u6587\u4ef6\u5b83\u5fc5\u987b\u7531\u4e00\u4e2a\u6743\u5a01\u673a\u6784\u7b7e\u53d1\u5e76\u5305\u542b\u4e00\u4e2a SPIEFE ID , \u5b83\u4ee3\u8868\u4e86\u63d0\u51fa\u8be5\u6587\u4ef6\u7684\u670d\u52a1\u7684\u8eab\u4efd \u89e3\u51b3\u65b9\u6848\u662f\u53ef\u6269\u5c55\u7684\u56e0\u4e3a\u6d41\u7a0b\u4e2d\u7684\u6bcf\u4e2a\u7ec4\u4ef6\u53ea\u8d1f\u4ece\u4e00\u90e8\u5206\u5de5\u4f5c\u3002\u4f8b\u5982\uff0c Envoy\u8d1f\u8d23\u8fc7\u671f\u8bc1\u4e66\uff0c istio\u4ee3\u7406\u8d1f\u8d35\u751f\u6210\u79c1\u94a5\u548cCSR. CitadeL\u8d1f\u8d5e\u6388\u6743\u548c\u7b7e\u7f72\u8bc1\u4e66","title":"2\u3001\u8bc1\u4e66\u521b\u5efa\u548c\u8f6e\u6362"},{"location":"chap8/6Istio_secruity/#3peer-and-request-authentication","text":"Peer authentication Peer authentication service-to-service All mTLS about the communication between services Request authentication end user authentication uses JWTs","title":"3\u3001Peer and Request Authentication(\u5bf9\u7b49\u8ba4\u8bc1\u548c\u8bf7\u6c42\u8ba4\u8bc1)"},{"location":"chap8/6Istio_secruity/#3-1-istio","text":"","title":"3-1 Istio\u63d0\u4f9b\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1a\u5bf9\u7b49\u8ba4\u8bc1\u548c\u8bf7\u6c42\u8ba4\u8bc1"},{"location":"chap8/6Istio_secruity/#3-2","text":"\u5bf9\u7b49\u8ba4\u8bc1\u7528\u4e8e\u670d\u52a1\u95f4\u7684\u8ba4\u8bc1\uff0c\u4ee5\u9a8c\u8bc1\u5efa\u7acb\u8fde\u63a5\u7684\u5ba2\u6237\u7aef\u3002 \u5f53\u4e24\u4e2a\u670d\u52a1\u8bd5\u56fe\u8fdb\u884c\u901a\u4fe1\u65f6\uff0c\u53cc\u5411TLS\u8981\u6c42\u5b83\u4eec\u90fd\u5411\u5bf9\u65b9\u63d0\u4f9b\u8bc1\u4e66\uff0c\u56e0\u6b64\u53cc\u65b9\u90fd\u77e5\u9053\u5b83\u4eec\u5728\u4e0e\u8c01\u4ea4\u8c08\u3002 \u5982\u679c\u6211\u4eec\u60f3\u5728\u670d\u52a1\u4e4b\u95f4\u542f\u7528\u4e25\u683c\u7684\u53cc\u5411TLS\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 PeerAuthentication \u8d44\u6e90\uff0c\u5c06 mTLS \u6a21\u5f0f\u8bbe\u7f6e\u4e3a STRICT \u3002 \u4f7f\u7528PeerAuthentication\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u7684\u53cc\u5411TLS(mTLS)\uff0c\u800c\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u4ee3\u7801\u4fee\u6539 \u3002 \u7136\u800c\uff0cIstio\u4e5f\u652f\u6301\u4e00\u79cd\u4f18\u96c5\u7684\u6a21\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u5728\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6216\u547d\u540d\u7a7a\u95f4\u5185\u8fdb\u5165\u53cc\u5411TLS\u3002 \u8fd9\u79cd\u6a21\u5f0f\u88ab\u79f0\u4e3a\u8bb8\u53ef\u6a21\u5f0f \u3002 \u5f53\u4f60\u5b89\u88c5Istio\u65f6\uff0c \u8bb8\u53ef\u6a21\u5f0f\u662f\u9ed8\u8ba4\u542f\u7528\u7684 \u3002 \u542f\u7528\u8bb8\u53ef\u6a21\u5f0f\u540e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u8bd5\u56fe\u901a\u8fc7\u53cc\u5411TLS\u8fde\u63a5\u5230\u6211\uff0c Istio\u5c06\u63d0\u4f9b\u53cc\u5411TLS \u3002 \u5982\u679c\u5ba2\u6237\u7aef\u4e0d\u4f7f\u7528\u53cc\u5411TLS, Istio\u4e5f\u53ef\u4ee5\u7528\u7eaf\u6587\u672c\u54cd\u5e94 \u3002 \u4f60\u53ef\u4ee5\u5141\u8bb8\u5ba2\u6237\u7aef\u505a\u6216\u4e0d\u505amTLS\u3002\u4f7f\u7528\u8fd9\u79cd\u6a21\u5f0f\uff0c\u4f60\u53ef\u4ee5\u5728\u4f60\u7684\u670d\u52a1\u7f51\u683c\u4e2d\u9010\u6e10\u63a8\u51fa\u53cc\u5411TLS \u3002 \u7b80\u800c\u8a00\u4e4b\uff0c PeerAuthentication \u8c08\u8bba\u7684\u662f\u5de5\u4f5c\u8d1f\u8f7d\u6216\u670d\u52a1\u7684\u901a\u4fe1\u65b9\u5f0f\uff0c\u5b83\u5e76\u6ca1\u6709\u8bf4\u5230\u6700\u7ec8\u7528\u6237\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u600e\u6837\u624d\u80fd\u8ba4\u8bc1\u7528\u6237\u5462\uff1f","title":"3-2 \u5bf9\u7b49\u8ba4\u8bc1"},{"location":"chap8/6Istio_secruity/#3-3","text":"\u8bf7\u6c42\u8ba4\u8bc1\uff08 RequestAuthentication \u8d44\u6e90\uff09\u9a8c\u8bc1\u4e86\u9644\u52a0\u5728\u8bf7\u6c42\u4e0a\u7684\u51ed\u8bc1\uff0c\u5b83\u88ab\u7528\u4e8e\u7ec8\u7aef\u7528\u6237\u8ba4\u8bc1\u3002 \u8bf7\u6c42\u7ea7\u8ba4\u8bc1\u662f\u901a\u8fc7 JSON Web Tokens (JWT) \u9a8c\u8bc1\u5b8c\u6210\u7684 \u3002 Istio\u652f\u6301\u4efb\u4f55 OpenID Connect \u63d0\u4f9b\u5546\uff0c\u5982AuthO\u3001 Firebase\u6216Google Auth\u3001Keycloak\u3001ORY Hydra\u3002\u56e0\u6b64\uff0c\u5c31\u50cf\u6211\u4eec\u4f7f\u7528SPIFFE\u8eab\u4efd\u6765\u9a8c\u8bc1\u670d\u52a1\u4e00\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528JWT\u4ee4\u724c\u6765\u9a8c\u8bc1\u7528\u6237\u3002","title":"3-3 \u8bf7\u6c42\u8ba4\u8bc1"},{"location":"chap8/6Istio_secruity/#4tls","text":"Mutual TLS(mTLS) Traffic is re-routed through proxies Envoy starts an mTLS handshake Secure naming check is done Once mTLS connection is established: Request is forwarded to server-side proxy Server-side forwards traffic to the workload mTLS Behavior DISABLE : no TLS connection SIMPLE : originate to the upstream MUTUAL : uses mTLS and certs for auth ISTIO_MUTUAL : like MUTUAL; but uses Istlo's certs for mTLS Permissive mode Allows services to accpet both plaintext and mTLS Improves mTLS onboarding experience Gradually Install/configure sidecars for mTLS","title":"4\u3001\u53cc\u5411TLS"},{"location":"chap8/6Istio_secruity/#4-1-tls","text":"\u670d\u52a1\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u7684\u901a\u4fe1\u662f\u901a\u8fc7Envoy\u4ee3\u7406\u8fdb\u884c\u7684\u3002\u5f53\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u4f7f\u7528mTLS\u5411\u53e6\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u53d1\u9001\u8bf7\u6c42\u65f6\uff0cIstio\u4f1a\u5c06\u6d41\u91cf\u91cd\u65b0\u8def\u7531\u5230sidecar\u4ee3\u7406\uff08Envoy)\u3002 \u7136\u540e\uff0c sidecar Envoy \u5f00\u59cb\u4e0e\u670d\u52a1\u5668\u7aef\u7684 Envoy \u8fdb\u884c mTLS \u63e1\u624b\u3002 \u5728\u63e1\u624b\u8fc7\u7a0b\u4e2d\uff0c\u8c03\u7528\u8005\u4f1a\u8fdb\u884c\u5b89\u5168\u547d\u540d\u68c0\u67e5\uff0c\u4ee5\u9a8c\u8bc1\u670d\u52a1\u5668\u8bc1\u4e66\u4e2d\u7684\u670d\u52a1\u8d26\u6237\u662f\u5426\u88ab\u6388\u6743\u8fd0\u884c\u76ee\u6807\u670d\u52a1\u3002\u4e00\u65e6 mTLS \u8fde\u63a5\u5efa\u7acb\uff0c Istio \u5c31\u4f1a\u5c06\u8bf7\u6c42\u4ece\u5ba2\u6237\u7aef\u7684 Envoy \u4ee3\u7406\u8f6c\u53d1\u5230\u670d\u52a1\u5668\u7aef\u7684 Envoy \u4ee3\u7406\u3002 \u5728\u670d\u52a1\u5668\u7aef\u7684\u6388\u6743\u540e\uff0csidecar\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u5de5\u4f5c\u8d1f\u8f7d\u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u670d\u52a1\u7684\u76ee\u6807\u89c4\u5219\u4e2d\u6539\u53d8mTLS\u884c\u4e3a\u3002 \u652f\u6301\u7684TLS\u6a21\u5f0f\u6709\uff1a DISABLE\uff08\u65e0TLS\u8fde\u63a5\uff09 SIMPLE \uff08\u5411\u4e0a\u6e38\u7aef\u70b9\u53d1\u8d77TLS\u8fde\u63a5) MUTUAL \uff08\u901a\u8fc7\u51fa\u793a\u5ba2\u6237\u7aef\u8bc1\u4e66\u8fdb\u884c\u8ba4\u8bc1\u6765\u4f7f\u7528 mTLS) ISTIO MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f46\u4f7f\u7528Istio\u81ea\u52a8\u751f\u6210\u7684\u8bc1\u4e66\u8fdb\u884cmTLS)","title":"4-1 \u53cc\u5411TLS"},{"location":"chap8/6Istio_secruity/#4-2","text":"\u5141\u8bb8\u6a21\u5f0f\uff08Permissive Mode)\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u9009\u9879\uff0c\u5b83\u5141\u8bb8\u4e00\u4e2a\u670d\u52a1\u540c\u65f6\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u91cf\u548c mTLS \u6d41\u91cf\u3002\u8fd9\u4e2a\u529f\u80fd\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u6539\u5584 mTLS \u7684\u7528\u6237\u4f53\u9a8c\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\u4f7f\u7528\u5141\u8bb8\u6a21\u5f0f\u914d\u7f6e\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u3002Istio\u8ddf\u8e2a\u4f7f\u7528Istio\u4ee3\u7406\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5e76\u81ea\u52a8\u5411\u5176\u53d1\u9001mTLS\u6d41\u91cf\u3002\u5982\u679c\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709\u4ee3\u7406\uff0cIstio\u5c06\u53d1\u9001\u7eaf\u6587\u672c\u6d41\u91cf\u3002 \u5f53\u4f7f\u7528\u5141\u8bb8\u6a21\u5f0f\u65f6\uff0c\u670d\u52a1\u5668\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u91cf\u548cmTLS\u6d41\u91cf\uff0c\u4e0d\u4f1a\u7834\u574f\u4efb\u4f55\u4e1c\u897f\u3002\u5141\u8bb8\u6a21\u5f0f\u7ed9\u4e86\u6211\u4eec\u65f6\u95f4\u6765\u5b89\u88c5\u548c\u914d\u7f6e sidecar \uff0c\u4ee5\u9010\u6b65\u53d1\u9001 mTLS \u6d41\u91cf\u3002 \u4e00\u65e6\u6240\u6709\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u5b89\u88c5\u4e86 sidecar \uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5207\u6362\u5230\u4e25\u683c\u7684 mTLS \u6a21\u5f0f\u3002\u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a PeerAuthentication \u8d44\u6e90\u3002\u6211\u4eec\u53ef\u4ee5\u9632\u6b62\u975e\u53cc\u5411 TLS \u6d41\u91cf\uff0c\u5e76\u8981\u6c42\u6240\u6709\u901a\u4fe1\u90fd\u4f7f\u7528mTLS \u6211\u4eec\u53ef\u4ee5\u521b\u5efa PeerAuthentication \u8d44\u6e90\uff0c\u9996\u5148\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5206\u522b\u6267\u884c\u4e25\u683c\u6a21\u5f0f\u3002 \u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u547d\u540d\u7a7a\u95f4\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f istio-system )\u521b\u5efa\u4e00\u4e2a\u7b56\u7565\uff0c\u5728\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u4e2d\u6267\u884c\u8be5\u7b56\u7565 \uff1a apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: default namespace: istio-system spec: mtls: mode: STRICT \u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6307\u5b9a selector \u5b57\u6bb5\uff0c\u5c06\u7b56\u7565\u4ec5\u5e94\u7528\u4e8e\u7f51\u683c\u4e2d\u7684\u7279\u5b9a\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4e0b\u9762\u7684\u4f8b\u5b50 \u5bf9\u5177\u6709\u6307\u5b9a\u6807\u7b7e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u542f\u7528 STRICT \u6a21\u5f0f \uff1a apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: default namespace: my-namespace spec: selector: matchLabels: app: customers mtls: mode: STRICT","title":"4-2 \u5141\u8bb8\u6a21\u5f0f"},{"location":"chap8/6Istio_secruity/#5","text":"","title":"5\u3001 \u6388\u6743"},{"location":"chap8/6Istio_secruity/#authorization","text":"Can user A send a GET request to /hello on service B? Authn without authz (and vice-versa) is useless Control authenticated principals with AuthorizationPolicy","title":"Authorization"},{"location":"chap8/6Istio_secruity/#authorization-policy","text":"Make use of identities extracted from PeerAuthentication and RequestAuthentication : requestPrincipals (users) principals (service/peer) Defined at mesh, namespace, and workload level","title":"Authorization policy"},{"location":"chap8/6Istio_secruity/#authorization-policy_1","text":"Workloads policy applies to Action to take (deny, allow, or audit) Rules when to take action","title":"Authorization policy"},{"location":"chap8/6Istio_secruity/#5-1","text":"\u6388\u6743\u662f\u5bf9\u8bbf\u95ee\u63a7\u5236\u95ee\u9898\u4e2d\u8bbf\u95ee\u63a7\u5236\u90e8\u5206\u7684\u54cd\u5e94\u3002\u67d0\u4e2a\uff08\u7ecf\u8fc7\u8ba4\u8bc1\u7684\uff09\u4e3b\u4f53\u662f\u5426\u88ab\u5141\u8bb8\u64cd\u4f5c\u67d0\u4e2a\u5bf9\u8c61\uff1f\u7528\u6237A\u80fd\u5426\u5411\u670d\u52a1B\u7684\u8def\u5f84 /hello \u53d1\u9001\u4e00\u4e2aGET\u8bf7\u6c42\uff1f \u8bf7\u6ce8\u610f\uff0c\u5c3d\u7ba1\u4e3b\u4f53\u53ef\u4ee5\u88ab\u8ba4\u8bc1\uff0c\u4f46\u5b83\u53ef\u80fd\u4e0d\u88ab\u5141\u8bb8\u6267\u884c\u67d0\u4e2a\u52a8\u4f5c\u3002\u4f60\u7684\u516c\u53f8\u65e7\u5361\u53ef\u80fd\u662f\u6709\u6548\u7684\u3001\u771f\u5b9e\u7684\uff0c\u4f46\u6211\u4e0d\u80fd\u7528\u5b83\u6765\u8fdb\u5165\u53e6\u4e00\u5bb6\u516c\u53f8\u7684\u529e\u516c\u5ba4\u3002\u5982\u679c\u6211\u4eec\u7ee7\u7eed\u4e4b\u524d\u7684\u6d77\u5173\u5b98\u5458\u7684\u6bd4\u55bb\uff0c\u6211\u4eec\u53ef\u4ee5\u8bf4\u6388\u6743\u7c7b\u4f3c\u4e8e\u4f60\u62a4\u7167\u4e0a\u7684\u7b7e\u8bc1\u7ae0\u3002 \u8fd9\u5c31\u5f15\u51fa\u4e86\u4e0b\u4e00\u4e2a\u95ee\u9898\u2014\u2014\u6709\u8ba4\u8bc1\u800c\u65e0\u6388\u6743\uff08\u53cd\u4e4b\u4ea6\u7136\uff09\u5bf9\u6211\u4eec\u6ca1\u6709\u4ec0\u4e48\u597d\u5904\u3002\u5bf9\u4e8e\u9002\u5f53\u7684\u8bbf\u95ee\u63a7\u5236\uff0c\u6211\u4eec\u9700\u8981\u4e24\u8005\u3002 \u8ba9\u6211\u7ed9\u4f60\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5982\u679c\u6211\u4eec\u53ea\u8ba4\u8bc1\u4e3b\u4f53\u800c\u4e0d\u6388\u6743\u4ed6\u4eec\uff0c\u4ed6\u4eec\u5c31\u53ef\u4ee5\u505a\u4efb\u4f55\u4ed6\u4eec\u60f3\u505a\u7684\u4e8b\uff0c\u5bf9\u4efb\u4f55\u5bf9\u8c61\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002\u76f8\u53cd\uff0c\u5982\u679c\u6211\u4eec\u6388\u6743\u4e86\u4e00\u4e2a\u8bf7\u6c42\uff0c\u4f46\u6211\u4eec\u6ca1 \u6709\u8ba4\u8bc1\u5b83\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5047\u88c5\u6210\u5176\u4ed6\u4eba\uff0c\u518d\u6b21\u5bf9\u4efb\u4f55\u5bf9\u8c61\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002 Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528 AuthorizationPolicy \u8d44\u6e90\u5728\u7f51\u683c\u3001\u547d\u540d\u7a7a\u95f4\u548c\u5de5\u4f5c\u8d1f\u8f7d\u5c42\u9762\u5b9a\u4e49\u8bbf\u95ee\u63a7\u5236\u3002 AuthorizationPolicy \u652f\u6301 DENY \u3001 ALLOW \u3001 AUDIT \u548c CUSTOM \u64cd\u4f5c\u3002 \u6bcf\u4e2a Envoy \u4ee3\u7406\u5b9e\u4f8b\u90fd\u8fd0\u884c\u4e00\u4e2a\u6388\u6743\u5f15\u64ce \uff0c\u5728\u8fd0\u884c\u65f6\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6388\u6743\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe\u4ee3\u7406\u65f6\uff0c\u5f15\u64ce\u4f1a\u6839\u636e\u6388\u6743\u7b56\u7565\u8bc4\u4f30\u8bf7\u6c42\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u8fd4\u56de ALLOW \u6216 DENY \u3002 AUDIT \u52a8\u4f5c\u51b3\u5b9a\u662f\u5426\u8bb0\u5f55\u7b26\u5408\u89c4\u5219\u7684\u8bf7\u6c42\u3002\u6ce8\u610f AUDIT \u7b56\u7565\u5e76\u4e0d\u5f71\u54cd\u8bf7\u6c42\u88ab\u5141\u8bb8\u6216\u62d2\u7edd\u3002 \u6ca1\u6709\u5fc5\u8981\u660e\u786e\u5730\u542f\u7528\u6388\u6743\u529f\u80fd\u3002 \u4e3a\u4e86\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u6765\u5e94\u7528\u4e8e\u6211\u4eec\u7684\u5de5\u4f5c\u8d1f\u8f7d AuthorizationPolicy \u8d44\u6e90\u662f\u6211\u4eec\u53ef\u4ee5\u5229\u7528 PeerAuthentication \u7b56\u7565\u548c RequestAuthentication \u7b56\u7565\u4e2d\u7684\u4e3b\u4f53\u7684\u5730\u65b9 \u3002 \u5728\u5b9a\u4e49 Authorizationpolicy \u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u8003\u8651\u4e09\u4e2a\u90e8\u5206\uff0e \u9009\u62e9\u8981\u5e94\u7528\u8be5\u7b56\u7565\u7684\u5de5\u4f5c\u8d1f\u8f7d \u8981\u91c7\u53d6\u7684\u884c\u52a8\uff08\u62d2\u7edd\u3001\u5141\u8bb8\u6216\u5ba1\u8ba1\uff09 \u91c7\u53d6\u8be5\u884c\u52a8\u7684\u89c4\u5219 \u6211\u4eec\u770b\u770b\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u5982\u4f55\u4e0e Authonizationpolicy \u8d44\u6e90\u4e2d\u7684\u5b57\u6bb5\u76f8\u5bf9\u5e94\uff0e apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: customers-deny namespace: default spec: selector: matchLabels: app: customers version: v2 action: DENY rules: - from: - source: notNamespaces: [\"default\"] \u4f7f\u7528 selector \u548c matchLabels \uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u7b56\u7565\u6240\u9002\u7528\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 \u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u6211\u4eec\u9009\u62e9\u7684\u662f\u6240\u6709\u8bbe\u7f6e\u4e86 app: customers \u548c version: v2 \u6807\u7b7e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 action \u5b57\u6bb5\u88ab\u8bbe\u7f6e\u4e3a DENY \u6700\u540e\uff0c\u6211\u4eec\u5728 rules \u5b57\u6bb5\u4e2d\u5b9a\u4e49\u6240\u6709\u89c4\u5219\u3002\u6211\u4eec\u4f8b\u5b50\u4e2d\u7684\u89c4\u5219\u662f\u8bf4\uff0c\u5f53\u8bf7\u6c42\u6765\u81ea default \u547d\u540d\u7a7a\u95f4\u4e4b\u5916\u65f6\u62d2\u7edd customers v2 \u5de5\u4f5c\u8d1f\u8f7d\u7684\u8bf7\u6c42(action)\u3002 \u9664\u4e86\u89c4\u5219\u4e2d\u7684from\u5b57\u6bb5\u5916\uff0c \u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 to \u548c when \u5b57\u6bb5\u8fdb\u4e00\u6b65\u5b9a\u5236\u89c4\u5219\u3002\u8ba9\u6211\u4eec\u770b\u4e00\u4e2a\u4f7f\u7528\u8fd9\u4e9b\u5b57\u6bb5\u7684\u4f8b\u5b50 apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: customers-deny namespace: default spec: selector: matchLabels: app: customers version: v2 action: DENY rules: - from: - source: notNamespaces: [\"default\"] - to: - operation: methods: [\"GET\"] - when: - key: request.headers [User-Agent] values: [\"Mozilla/*\"] \u6211\u4eec\u5728\u89c4\u5219\u90e8\u5206\u6dfb\u52a0\u4e86 to \u548c when \u5b57\u6bb5\u3002\u5982\u679c\u6211\u4eec\u7ffb\u8bd1\u4e00\u4e0b\u4e0a\u9762\u7684\u89c4\u5219\uff0c\u6211\u4eec\u53ef\u4ee5\u8bf4\uff0c\u5f53\u5ba2\u6237\u7684GET\u8bf7\u6c42\u6765\u81ea default \u547d\u540d\u7a7a\u95f4\u4e4b\u5916\uff0c\u5e76\u4e14 User Agent \u5934\u7684\u503c\u4e0e\u6b63\u5219\u8868\u8fbe\u5f0f Mozilla/* \u76f8\u5339\u914d\u65f6\uff0c\u6211\u4eec\u4f1a\u62d2\u7edd customers v2 \u7684\u5de5\u4f5c\u8d1f\u8f7d \u3002 \u603b\u7684\u6765\u8bf4\uff0c to \u5b9a\u4e49\u4e86\u7b56\u7565\u6240\u5141\u8bb8\u7684\u884c\u52a8\uff0c from \u5b9a\u4e49\u4e86\u8c01\u53ef\u4ee5\u91c7\u53d6\u8fd9\u4e9b\u884c\u52a8\uff0c when \u5b9a\u4e49\u4e86\u6bcf\u4e2a\u8bf7\u6c42\u5fc5\u987b\u5177\u5907\u7684\u5c5e\u6027\uff0c\u4ee5\u4fbf\u88ab\u7b56\u7565\u6240\u5141\u8bb8\uff0c selector \u5b9a\u4e49\u4e86\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u5c06\u6267\u884c\u8be5\u7b56\u7565\u3002 \u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c \u5219\u9996\u5148\u8bc4\u4f30\u62d2\u7edd\u7684\u7b56\u7565 \u3002\u8bc4\u4f30\u9075\u5faa\u8fd9\u4e9b\u89c4\u5219\uff1a \u5982\u679c\u6709\u4e0e\u8bf7\u6c42\u76f8\u5339\u914d\u7684 DENY \u7b56\u7565\uff0c\u5219\u62d2\u7edd\u8be5\u8bf7\u6c42 \u5982\u679c\u6ca1\u6709\u9002\u5408\u8be5\u5de5\u4f5c\u8d1f\u8f7d\u7684 ALLOW \u7b56\u7565\uff0c\u5219\u5141\u8bb8\u8be5\u8bf7\u6c42 \u5982\u679c\u6709\u4efb\u4f55 ALLOW \u7b56\u7565\u4e0e\u8be5\u8bf7\u6c42\u76f8\u5339\u914d\uff0c\u5219\u5141\u8bb8\u8be5\u8bf7\u6c42\uff0e \u62d2\u7edd\u8be5\u8bf7\u6c42","title":"5-1 \u6388\u6743"},{"location":"chap8/6Istio_secruity/#5-2","text":"\u6211\u4eec\u5728\u4e0a\u8ff0\u4f8b\u5b50\u4e2d\u4f7f\u7528\u7684\u6e90\u662f notNameepaces \uff0e\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u4efb\u4f55\u4e00\u4e2a\u5b57\u6bb5\u6765\u6307\u5b9a\u8bf7\u6c42\u7684\u6765\u6e90\u5982\u8868\u4e2d\u6240\u793a\uff0e","title":"5-2 \u6765\u6e90"},{"location":"chap8/6Istio_secruity/#5-4","text":"\u64cd\u4f5c\u88ab\u5b9a\u4e49\u5728 to \u5b57\u6bb5\u4e0b\uff0c\u5982\u679c\u591a\u4e8e\u4e00\u4e2a\uff0c\u5219\u4f7f\u7528AND\u8bed\u4e49\u3002\u5c31\u50cf\u6765\u6e90\u4e00\u6837\uff0c\u64cd\u4f5c\u662f\u6210\u5bf9\u7684\uff0c\u6709\u6b63\u53cd\u4e24\u9762\u7684\u5339\u914d\u3002\u8bbe\u7f6e\u5728\u64cd\u4f5c\u5b57\u6bb5\u7684\u503c\u662f\u5b57\u7b26\u4e32 hosts \u548c notHosts ports \u548c notPorts methods \u548c notMethods paths \u548c notPath \u6240\u6709\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u9002\u7528\u4e8e\u8bf7\u6c42\u5c5e\u965b\u3002\u4f8b\u5982\uff0c\u8981\u5728\u4e00\u4e2a\u7279\u5b9a\u7684\u8bf7\u6c42\u8def\u5f84\u4e0a\u8fdb\u884c\u5339\u914d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8def\u5f84\u3002 \uff3b\"/api/*\",\"/admin\"\uff3d \u6216\u7279\u5b9a\u7684\u7aef\u53e3 ports: [\"8080\"] \uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002","title":"5-4 \u64cd\u4f5c"},{"location":"chap8/6Istio_secruity/#5-5","text":"\u4e3a\u4e86\u6307\u5b9a\u6761\u4ef6\uff0c\u6211\u4eec\u5fc5\u987b\u63d0\u4f9b\u4e00\u4e2a key \u5b57\u6bb5\u3002 key \u5b57\u6bb5\u662f\u4e00\u4e2a Istio \u5c5e\u6027\u7684\u540d\u79f0\u3002\u4f8b\u5982\uff0c requsst.headers \u3001 source.ip \u3001 destinatisn.port \u7b49\u7b49\u3002 \u6761\u4ef6\u7684\u7b2c\u4e8c\u90e8\u5206\u662f values \u6216 notValues \u7684\u5b57\u7b26\u4e32\u5217\u8868\u3002\u4e0b\u9762\u662f\u4e00\u4e2a when \u6761\u4ef6\u7684\u7247\u6bb5\uff1a ... - when: - key: source.ip notValues: [\"10.0.1.1\"]","title":"5-5 \u6761\u4ef6"},{"location":"chap8/6Istio_secruity/#61-mtls","text":"\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u90e8\u7f72\u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\uff08WebFrontend\u548cCustomers\u670d\u52a1\uff09\u3002 Web\u524d\u7aef\u7684\u90e8\u7f72\u5c06\u4e0d\u5305\u542bEnvoy\u4ee3\u7406sidecar\uff0c\u800cCustomers\u670d\u52a1\u5c06\u88ab\u6ce8\u5165sidecar \u3002\u901a\u8fc7\u8fd9\u4e2a\u8bbe\u7f6e\uff0c\u6211\u4eec\u5c06\u770b\u5230Istio\u5982\u4f55\u540c\u65f6\u53d1\u9001mTLS\u548c\u7eaf\u6587\u672c\u6d41\u91cf\uff0c\u4ee5\u53ca\u5982\u4f55\u5c06TLS\u6a21\u5f0f\u6539\u4e3aSTRICT\u3002 \u8ba9\u6211\u4eec\u4ece\u90e8\u7f72\u4e00\u4e2aGateway\u8d44\u6e90\u5f00\u59cb\uff1a 1gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' $ kubectl apply -f 1gateway.yaml gateway.networking.istio.io/gateway created $ kubectl get gateway NAME AGE gateway 2m41s \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u521b\u5efa WebFrontend \u548c Customers \u670d\u52a1\u7684\u90e8\u7f72\u4ee5\u53ca\u76f8\u5173\u7684 Kubernetes \u5728\u670d\u52a1\u3002\u5f00\u59cb\u90e8\u7f72\u4e4b\u524d\uff0c \u6211\u4eec\u5c06\u7981\u7528 default \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u81ea\u52a8 sidecar \u6ce8\u5165\uff0c \u8fd9\u6837\u4ee3\u7406\u5c31\u4e0d\u88ab\u6ce8\u5165\u5230 Web \u524d\u7aef\u90e8\u7f72\u4e2d\u3002\u5728\u6211\u4eec\u90e8\u7f72 Customers \u670d\u52a1\u4e4b\u524d\uff0c\u6211\u4eec\u5c06\u518d\u6b21\u542f\u7528\u6ce8\u5165 \u3002 $ kubectl label namespace default istio-injection- namespace/default labeled \u7981\u7528\u6ce8\u5165\u540e\uff0c\u90e8\u7f72 web-frontend 2webfrontend.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 3customersv1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 $ kubectl apply -f 2webfrontend.yaml deployment.apps/web-frontend created service/web-frontend created virtualservice.networking.istio.io/web-frontend created \u5982\u679c\u6211\u4eec\u770b\u4e00\u4e0b\u6b63\u5728\u8fd0\u884c\u7684Pod\uff0c\u6211\u4eec\u5e94\u8be5\u770b\u5230\u6709\u4e00\u4e2aPod\u6b63\u5728\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\uff0c\u7531READY\u680f\u4e2d\u76841/1\u8868\u793a\uff1a $ kubectl get pod NAME READY STATUS RESTARTS AGE web-frontend-69b64f974c-cr79v 1/1 Running 0 29s \u542f\u7528\u81ea\u52a8\u6ce8\u5165\uff1a $ kubectl label namespace default istio-injection=enabled namespace/default labeled \u90e8\u7f72Customers\u670d\u52a1\u7684 v1 \u7248\u672c 3customersv1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 $ kubectl apply -f 3customersv1.yaml deployment.apps/customers-v1 created service/customers created virtualservice.networking.istio.io/customers created $ kubectl get pod NAME READY STATUS RESTARTS AGE customers-v1-7b5b4b76fc-zttpn 2/2 Running 0 21s web-frontend-69b64f974c-cr79v 1/1 Running 0 21m \u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u4ece GATEWAY_URL \u8bbf\u95ee\u7f51\u9875\uff0c\u6211\u4eec\u4f1a\u5f97\u5230\u5e26\u6709\u5ba2\u670d\u4eba\u5458\u56de\u5e94\u7684\u7f51\u9875\u3002 \u8bbf\u95ee GATEWAY_URL \u4e4b\u6240\u4ee5\u6709\u6548\uff0c\u662f\u56e0\u4e3a\u91c7\u7528\u4e86\u8bb8\u53ef\u6a21\u5f0f\uff0c\u7eaf\u6587\u672c\u6d41\u91cf\u88ab\u53d1\u9001\u5230\u6ca1\u6709\u4ee3\u7406\u7684\u670d\u52a1\u3002\u5728\u8fd9\u79cd\u6e05\u51b5\u4e0b\uff0c\u5165\u53e3\u7f51\u5173\u5c06\u7eaf\u6587\u672c\u6d41\u91cf\u53d1\u9001\u5230Web\u524d\u7aef\uff0c\u56e0\u4e3a\u6ca1\u6709\u4ee3\u7406 \u5982\u679c\u6211\u4eec\u7528 istioctl dashboard kiali \u6253\u5f00Kiali\uff0c\u770b\u4e00\u4e0bGraph\uff0c\u4f60\u4f1a\u53d1\u73b0Kiali\u68c0\u6d4b\u5230\u4ece\u5165\u53e3\u7f51\u5173\u5230Web\u524d\u7aef\u7684\u8c03\u7528\u3002\u7136\u800c\uff0c\u5bf9Customers\u670d\u52a1\u7684\u8c03\u7528\u662f\u6765\u81ea\u672a\u77e5\u7684\u670d\u52a1\u3002\u8fd9\u662f\u56e0\u4e3aWeb\u524d\u7aef\u65c1\u8fb9\u6ca1\u6709\u4ee3\u7406\uff0cIstio\u4e0d\u77e5\u9053\u8fd9\u4e2a\u670d\u52a1\u662f\u8c01\u3001\u5728\u54ea\u91cc\u3001\u662f\u4ec0\u4e48\u3002 \u8ba9\u6211\u4eec\u66f4\u65b0 Customers \u7684 Virtualservice \u5e76\u5c06\u7f51\u5173\u9644\u52a0\u5230\u5b83\u4e0a\u9762\u3002\u8fd9\u5c06\u4f7f\u6211\u4eec\u80fd\u591f\u76f4\u63a5\u8c03\u7528 Customers \u7684\u670d\u52a1 4vscustomersgateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' gateways: - gateway http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 $ kubectl apply -f 4vscustomersgateway.yaml virtualservice.networking.istio.io/customers configured \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a Host \u5934\u4e86\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5165\u53e3\u7f51\u5173( GATEWAY_URL )\u5c06\u8bf7\u6c42\u53d1\u9001\u5230 Customers \u670d\u52a1\uff1a $ curl -H \"Host: customers.default.svc.cluster.local\" http://127.0.0.1 [{\"name\":\"Jewel Schaefer\"},{\"name\":\"Raleigh Larson\"},{\"name\":\"Eloise Senger\"},{\"name\":\"Moshe Zieme\"},{\"name\":\"Filiberto Lubowitz\"},{\"name\":\"Ms.Kadin Kling\"},{\"name\":\"Jennyfer Bergstrom\"},{\"name\":\"Candelario Rutherford\"},{\"name\":\"Kenyatta Flatley\"},{\"name\":\"Gianni Pouros\"}] \u4e3a\u4e86\u901a\u8fc7Ingress\u7ed9Web\u524d\u7aef\u548cCustomers\u670d\u52a1\u4ea7\u751f\u4e00\u4e9b\u6d41\u91cf\uff0c\u6253\u5f00\u4e24\u4e2a\u7ec8\u7aef\u7a97\u53e3\uff0c\u5206\u522b\u8fd0\u884c\u4e00\u6761\u547d\u4ee4\uff1a // Terminal1 while true; do curl -H \"Host: customers.default.svc.cluster.local\" http://127.0.0.1; done // Terminal2 while true; do curl http://127.0.0.1/; done \u6253\u5f00Kiali\uff0c\u770b\u4e00\u4e0b\u56fe\u8868\u3002\u5728Display\u4e0b\u62c9\u83dc\u5355\u4e2d\uff0c\u786e\u4fdd\u6211\u4eec\u9009\u4e2dSecurity\u9009\u9879\u3002\u4f60\u5e94\u8be5\u770b\u5230\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u4e0b\u56fe\u7684\u56fe\u8868 \u6ce8\u610f\u5728\u5165\u53e3\u7f51\u5173\u548c Customers \u670d\u52a1\u4e4b\u95f4\u6709\u4e00\u4e2a\u6302\u9501\u56fe\u6807\uff0c\u8fd9\u610f\u6627\u7740\u6d41\u91cf\u662f\u4f7f\u7528mTLS\u53d1\u9001\u7684\u3002 \u5982\u679c\u4f60\u6ca1\u6709\u770b\u5230\u6302\u9501\u56fe, \u6807\u8bf7\u70b9\u51fb Display \u4e8c\u4e0b\u62c9\u83dc\u5355\uff0c\u786e\u4fdd Security \u9009\u9879\u88ab\u9009\u4e2d\u3002 \u7136\u800c\uff0c\u5728\u672a\u77e5\u7684\uff08web\u524d\u7aef\uff09\u548cCustomers\u670d\u52a1\u4e4b\u95f4\uff0c\u4ee5\u53ca istio-ingress-gateway \u548c web \u524d\u7aef\u4e4b\u95f4\uff0c\u90fd\u6ca1\u6709\u6302\u9501\u3002 Istio \u5728\u6ca1\u6709\u6ce8\u5165 sidecar \u7684\u6e05\u51b5\u4e0b\u5411\u670d\u52a1\u53d1\u9001\u7eaf\u6587\u672c\u6d41\u91cf\u3002 \u8ba9\u6211\u4eec\u770b\u770b\u5982\u679c\u6211\u4eec\u5728 STRICT \u6a21\u5f0f\u4e0b\u542f\u7528 mTLS \u4f1a\u53d1\u751f\u4ec0\u4e48\u3002 \u6211\u4eec\u9884\u8ba1\u4ece\u524d\u7aef\u5230 Customers \u670d\u52a1\u7684\u8c03\u7528\u4f1a\u5f00\u59cb\u5931\u8d25\uff0c\u56e0\u4e3a\u6ca1\u6709\u6ce8\u5165\u4ee3\u7406\u6765\u8fdb\u884c mTLS \u901a\u4fe1\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4ece\u5165\u53e3\u7f51\u5173\u5230 Customers \u670d\u52a1\u7684\u8c03\u7528\u5c06\u7ee7\u7eed\u5de5\u4f5c 5strictmtls.yaml apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: default namespace: default spec: mtls: mode: STRICT $ kubectl apply -f 5strictmtls.yaml peerauthentication.security.istio.io/default created \u5982\u679c\u6211\u4eec\u4ecd\u7136\u5728\u8fd0\u884c\u8bf7\u6c42\u5faa\u73af\uff0c\u6211\u4eec\u5c06\u5f00\u59cb\u770b\u5230\u6765\u81ea web \u524d\u7aef\u7684 ECONNRESET \u9519\u8bef\u4fe1\u606f\u3002 \u8fd9\u4e2a\u9519\u8bef\u8868\u660e\uff0cCustomers\u7aef\u5173\u95ed\u4e86\u8fde\u63a5\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u671f\u5f85\u7740\u4e00\u4e2a mTLS \u8fde\u63a5 CONNRESET\"\"read ECONNRESET\"\"read ECONNRESET\"^C \u53e6\u4e00\u65b9\u9762\uff0c\u6211\u4eec\u76f4\u63a5\u5411 Customers \u670d\u52a1\u53d1\u51fa\u7684\u8bf7\u6c42\u7ee7\u7eed\u5de5\u4f5c\uff0c\u56e0\u4e3a Customers \u670d\u52a1\u65c1\u8fb9\u6709\u4e00\u4e2a Envoy \u4ee3\u7406\u5728\u8fd0\u884c\uff0c\u5b83\u53ef\u4ee5\u8fdb\u884c mTLS \u5982\u679c\u6211\u4eec\u5220\u9664\u4e4b\u524d\u90e8\u7f72\u7684 PeerAuthentication \u8d44\u6e90( kubectl delete peerauthentication default ),Istio\u5c31\u4f1a\u961f\u590d\u5230\u9ed8\u8ba4\u72b6\u6001\uff08 PERMISSIVE \u6a21\u5f0f\uff09\uff0c\u9519\u8bef\u4e5f\u4f1a\u6d88\u5931","title":"6\u3001\u5b9e\u9a8c1 \u542f\u7528mTLS"},{"location":"chap8/6Istio_secruity/#72","text":"\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u6388\u6743\u7b56\u7565\u6765\u63a7\u5236\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u7684\u8bbf\u95ee\u3002 \u9996\u5148\u90e8\u7f72 Gateway 1gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' $ kubectl apply -f 1gateway.yaml gateway.networking.istio.io/gateway created \u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u521b\u5efaWeb\u524d\u7aef\u90e8\u7f72\u3001\u670d\u52a1\u8d26\u6237\u3001\u670d\u52a1\u548c VirtualService . 2webfrontend.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-frontend --- apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: serviceAccountName: web-frontend containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 $ kubectl apply -f 2webfrontend.yaml serviceaccount/web-frontend created deployment.apps/web-frontend created service/web-frontend created virtualservice.networking.istio.io/web-frontend created 3customersv1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 1 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 $ kubectl apply -f 3customersv1.yaml deployment.apps/customers-v1 created service/customers created virtualservice.networking.istio.io/customers created $ kubectl get vs NAME GATEWAYS HOSTS AGE customers [\"customers.default.svc.cluster.local\"] 6s web-frontend [\"gateway\"] [\"*\"] 19s \u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u4ece GATEWAY_URL \u8bbf\u95ee\u7f51\u9875\uff0c\u6211\u4eec\u4f1a\u5f97\u5230\u5e26\u6709\u5ba2\u670d\u4eba\u5458\u56de\u5e94\u7684\u7f51\u9875\u3002","title":"7\u3001\u5b9e\u9a8c2 \u8bbf\u95ee\u63a7\u5236"},{"location":"chap8/6Istio_secruity/#7-1","text":"\u8ba9\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u62d2\u7edd default \u547d\u540d\u7a7a\u95f4\u7684\u6240\u6709\u8bf7\u6c42 4denyall.yaml apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: deny-all namespace: default spec: {} $ kubectl apply -f 4denyall.yaml authorizationpolicy.security.istio.io/deny-all created \u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u4ece GATEWAY_URL \u8bbf\u95ee\u7f51\u9875\u3002 RBAC: access denied \u540c\u6837\u5982\u679c\u6211\u4eec\u8bd5\u56fe\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\u4e00\u4e2aPod\u5e76\u4ece default \u547d\u540d\u7a7a\u95f4\u5185\u5411 Web \u524d\u7aef\u6216 customers \u670d\u52a1\u63d0\u51fa\u8bf7\u6c42\u6211\u4eec\u4f1a\u5f97\u5230\u540c\u6837\u7684\u9519\u8bef $ kubectl run curl --image=radial/busyboxplus:cur l -i --ttykubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a futu re version. Use kubectl run --generator=run-pod/v1 or kubectl create instead. If you don't see a command prompt, try pressing enter. [ root@curl-6cd5b579fb-2xcx9:/ ]$ curl customers RBAC: access denied [ root@curl-6cd5b579fb-2xcx9:/ ]$ curl web-frontend RBAC: access denied \u5728\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u90fd\u5f97\u5230\u4e86\u62d2\u7edd\u8bbf\u95ee\u7684\u9519\u8bef","title":"7-1 \u6388\u6743\u7b56\u7565\u62d2\u7edd"},{"location":"chap8/6Istio_secruity/#7-2-allow-web-frontend","text":"\u6211\u4eec\u8981\u505a\u7684\u7b2c\u4e00\u4ef6\u4e8b\u662f\u4f7f\u7528 ALLOW \u52a8\u4f5c\u5141\u8bb8\u4ece\u5165\u53e3\u7f51\u5173\u5411 web-frontend \u5e94\u7528\u7a0b\u5e8f\u53d1\u9001\u8bf7\u6c42 \u3002\u5728\u89c4\u5219\u4e2d\u6211\u4eec\u6307\u5b9a\u4e86\u5165\u53e3\u7f51\u5173\u8fd0\u884c\u7684\u6e90\u547d\u540d\u7a7a\u95f4\uff08 istio-system \uff09\u548c\u5165\u53e3\u7f51\u5173\u7684\u670d\u52a1\u8d26\u6237\u540d\u79f0 5allow-webfrontend-customers.yaml apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: allow-ingress-frontend namespace: default spec: selector: matchLabels: app: web-frontend action: ALLOW rules: - from: - source: namespaces: [\"istio-system\"] - source: principals: [\"istio-ingressgateway-service-account\"] - source: principals: [\"cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"] $ kubectl apply -f 5allowingressfrontend.yaml authorizationpolicy.security.istio.io/allow-ingress-frontend created $ curl http://127.0.0.1 \"Request failed with status code 403\" \u8bf7\u6ce8\u610f\u7b56\u5cea\u9700\u8981\u51e0\u79d2\u949f\u624d\u80fd\u5206\u53d1\u5230\u6240\u6709\u4ee3\u7406\u6240\u4ee5\u4f60\u53ef\u80fd\u4ecd\u7136\u4f1a\u770b\u5230 node: access denied \u7684\u6d88\u606f\u65f6\u95f4\u4e3a\u51e0\u79d2\u949f \u8fd9\u4e2a\u9519\u8bef\u6765\u81ea customers \u670d\u52a1\u2014\u2014\u8bb0\u5f97\u6211\u4eec\u5141\u8bb8\u8c03\u7528Web\u524d\u7aef\u3002 \u7136\u800c web-fronted \u4ecd\u7136\u4e0d\u80fd\u8c03\u7528 customers \u670d\u52a1 \u5982\u679c\u6211\u4eec\u56de\u5230\u6211\u4eec\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\u7684 curl Pod \u5c1d\u8bd5\u8bf7\u6c42 http://web-fronted \u6211\u4eec\u4f1a\u5f97\u5230\u4e00\u4e2aRBAC\u9519\u8bef\u3002DENY\u7b56\u7565\u662f\u6709\u6548\u7684\u6211\u4eec\u53ea\u5141\u8bb8\u4ece\u5165\u53e3\u7f51\u5173\u8fdb\u884c\u8c03\u7528 \u5f53\u6211\u4eec\u90e8\u7f72Web\u524d\u7aef\u65f6\u6211\u4eec\u4e5f\u4e3aPod\u521b\u5efa\u4e86\u4e00\u4e2a\u670d\u52a1\u8d26\u6237\uff08\u5426\u5219\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709Pod\u90fd\u88ab\u5206\u914d\u4e86\u9ed8\u8ba4\u7684\u670d\u52a1\u8d26\u6237\uff09\u3002\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8be5\u670d\u52a1\u8d26\u6237\u6765\u6307\u5b9acustomers\u670d\u52a1\u8c03\u7528\u7684\u6765\u6e90\uff0e 6allowwebfrontendcustomers.yaml apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: allow-web-frontend-customers namespace: default spec: selector: matchLabels: app: customers version: v1 action: ALLOW rules: - from: - source: namespaces: [\"default\"] - source: principals: [\"web-frontend\"] principals: [\"cluster.local/ns/default/sa/web-frontend\"] $ kubectl apply -f 6allowwebfrontendcustomers.yaml authorizationpolicy.security.istio.io/allow-web-frontend-customers created \u4e00\u65e6\u7b56\u7565\u88ab\u521b\u5efa\u6211\u4eec\u5c06\u770b\u5230Web\u524d\u7aef\u518d\u6b21\u5de5\u4f5c\u2015\u5b83\u5c06\u83b7\u5f97customers\u670d\u52a1\u7684\u56de\u5e94 $ curl http://127.0.0.1 <!DOCTYPE html> ... \u6211\u4eec\u4f7f\u7528\u4e86\u591a\u4e2a\u6388\u6743\u7b56\u7565\u660e\u786e\u5730\u5141\u8bb8\u961f\u5165\u53e3\u5230\u524d\u7aef\u4ee5\u53ca\u961f\u524d\u7aef\u5230 customers \u670d\u52a1\u7684\u8c03\u7528\u3002 \u4f7f\u7528 deny-all \u7b56\u7565\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u5f00\u59cb\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u3001\u7ba1\u7406\u7136\u540e\u660e\u786e\u5730\u5141\u8bb8\u6211\u4eec\u5e0c\u671b\u5728\u670d\u52a1\u4e4b\u95f4\u53d1\u751f\u7684\u901a\u4fe1","title":"7-2 ALLOW \u52a8\u4f5c\u5141\u8bb8\u4ece\u5165\u53e3\u7f51\u5173\u5411web-frontend"},{"location":"chap8/6Istio_secruity/#8","text":"1\u3001\u5728\u901a\u4fe1\u65f6\uff0cEnvoy\u4ee3\u7406\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u51ed\u8bc1\uff1f A \u7528\u6237\u548c\u5bc6\u7801 B API\u79d8\u94a5 C Token D X509\u8bc1\u4e66 Validating the X.509 to authenticate the SPIFFE identity 2\u3001\u54ea\u4e2a\u7ec4\u4ef6\u4e3a\u4e00\u4e2a\u670d\u52a1\u8d26\u6237\u521b\u5efaSPIFFE\u8eab\u4efd\uff1f A Pilot B Citadel C Mixer D Envoy SDS \u6bcf\u6b21\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u8d26\u6237\u65f6, Citadel\u90fd\u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2aSPIFFE\u8eab\u4efd\u3002 3\u3001\u4f60\u4f1a\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u542f\u7528\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4e25\u683cmTLS\u6a21\u5f0f\uff1f A IstioAuth B ClusterRole C PeerAuthentication D Auth apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: default namespace: default spec: mtls: mode: STRICT 4\u3001AuthorizationPolicy\u8d44\u6e90\u4e2d\u4f7f\u7528\u54ea\u4e24\u4e2a\u52a8\u4f5c\uff1f ACCPET\u548cRJECT VALIDATE\u548cCANCEL DENY\u548cACCEPT DENY\u548cALLOW \u6bcf\u4e2a Envoy \u4ee3\u7406\u5b9e\u4f8b\u90fd\u8fd0\u884c\u4e00\u4e2a\u6388\u6743\u5f15\u64ce \uff0c\u5728\u8fd0\u884c\u65f6\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6388\u6743\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe\u4ee3\u7406\u65f6\uff0c\u5f15\u64ce\u4f1a\u6839\u636e\u6388\u6743\u7b56\u7565\u8bc4\u4f30\u8bf7\u6c42\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u8fd4\u56de ALLOW \u6216 DENY 5\u3001\u5f53\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\uff08SDS)\u66f4\u65b0\u8bc1\u4e66\u65f6\uff0c\u662f\u5426\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u4ee5\u4f7f\u7528\u65b0\u8bc1\u4e66\u3002 A \u662f B \u5426 6\u3001AUDIT\u52a8\u4f5c\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f A \u8bb0\u5f55\u548c\u62d2\u7edd\u8bf7\u6c42\uff0e B \u8bb0\u5f55\u8bf7\u6c42 C \u53d1\u9001\u8c13\u6c42\u901a\u77e5 D \u8bb0\u5f55\u548c\u5141\u8bb8\u8bf7\u6c42 AUDIT \u52a8\u4f5c\u51b3\u5b9a\u662f\u5426\u8bb0\u5f55\u7b26\u5408\u89c4\u5219\u7684\u8bf7\u6c42\u3002\u6ce8\u610f AUDIT \u7b56\u7565\u5e76\u4e0d\u5f71\u54cd\u8bf7\u6c42\u88ab\u5141\u8bb8\u6216\u62d2\u7edd\u3002 7\u3001\u4ec0\u4e48\u662f\u5141\u8bb8\u6a21\u5f0f\uff08permissive mode)? A \u4e00\u4e2a\u5141\u8bb8\u670d\u52a1\u540c\u65f6\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u6700\u548cmTLS\u6d41\u91cf\u7684\u9009\u9879 B \u4e00\u4e2a\u5141\u8bb8\u670d\u52a1\u53ea\u63a5\u53d7\u660e\u6587\u6d41\u91cf\u7684\u9009\u9879 C\u4e00\u4e2a\u5141\u8bb8\u7528\u6237\u76f4\u63a5\u5411\u670d\u52a1\u63d0\u51fa\u8bf7\u6c42\u7684\u9009\u9879 D \u4e00\u4e2a\u5141\u8bb8\u4f60\u4fbf\u7528\u57fa\u4e8e\u4ee4\u724c\u7684\u8ba4\u8bc1\u7684\u9009\u9879 Allows services to accpet both plaintext and mTLS 8\u3001\u662f\u5426\u53ef\u4ee5\u5728Istio\u4e2d\u4f7f\u7528JSON Web Tokens (JWTs)? A \u662f B \u5426 9\u3001\u9009\u62e9\u4e09\u4e2a\u8d1f\u8d35\u5728\u8fd0\u884c\u65f6\u521b\u5efa\u8eab\u4efd\u7684\u7ec4\u4ef6 A Citedel B lstio Agent C Envoys Secret Discovery Service D Pilot E citadel-agent E Envoy proxy 10\u3001\u4f7f\u7528\u8bb8\u53ef\u6a21\u5f0f\u53ef\u4ee5\u6539\u5584mTLS\u7684\u4e0a\u673a\u4f53\u9a8c\u3002 \u662f \u5426 11\u3001 Istlo Agent\u7684\u5de5\u4f5c\u662f\u4ec0\u4e48\uff1f A \u4e0eEnvoy sidecar\u5408\u4f5c\uff0c\u901a\u8fc7\u4e13\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\uff0c\u5e2e\u52a9\u4ed6\u4eec\u94fe\u63a5\u5230Service mesh B \u4e0eIstio PIot\u5408\u4f5c\uff0c\u914d\u7f6eCitadel C \u4e0eCitadel\u5408\u4f5c\uff0c\u5728Ku bernetes\u7684\u79d8\u5bc6\u4e2d\u5bf9\u8bc1\u4e66\u8fdb\u884c\u7f16\u7801 D \u9a8c\u8bc1 ISTIO_MUTUAL \u914d\u7f6e Istio Agent \u4e0e Envoy sidecar \u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c 12\u3001Istlo\u63d0\u4f9b\u54ea\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1f A \u5bf9\u7b49\u548c\u8bf7\u6c42\u8ba4\u8bc1 B JWT\u4ee4\u724c\u548c\u5bc6\u7801\u8ba4\u8bc1 C Istio\u53ea\u63d0\u4f9b\u5bf9\u7b49\u8ba4\u8bc1 D \u591a\u56e0\u7d20\u8ba4\u8bc1\u548c\u5be1\u4e8e\u8bc1\u4e66\u7684\u8ba4\u8bc1 13 Istlo\u4ee3\u7406\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u5b58\u50a8\u5728\u54ea\u91cc\uff1f \u78c1\u76d8 Secret\u4e2d \u5185\u5b58 \u94a5\u5319\u548c\u8bc1\u4e66\u4e0d\u5b58\u50a8\u5728\u4efb\u4f55\u5730\u65b9 Istio\u4ee3\u7406\u4eceCitadel\u83b7\u53d6\u54cd\u5e94\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\u5e76\u901a\u8fc7 SDS \u548c Unix \u57df\u5957\u63a5\u5b87\u5c06\u5176\u63d0\u4f9b\u7ed9 Envoy \u3002 \u5c06\u5bc6\u94a5\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u6bd4\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u66f4\u5b89\u5168 \uff1b \u5728\u4f7f\u7528SDS\u65f6\uff0c\u7edd\u4e0d\u4f1a\u5c06\u4efb\u4f55\u5bc6\u94a5\u5199\u5165\u78c1\u76d8\u3002Istio\u4ee3\u7406\u8fd8\u5b9a\u671f\u5237\u65b0\u51ed\u8bc1\uff0c \u5728\u5f53\u524d\u51ed\u8bc1\u8fc7\u670b\u524d\u4eceCitadel\u68c0\u7d22\u4efb\u4f55\u65b0\u7684SVID(SPIFFE\u53ef\u9a8c\u8bc1\u8eab\u4efd\u6587\u4ef6\uff09 15 \u54ea\u79cd\u4ee3\u7406\u4e0eistiod\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u5b9e\u73b0\u94a5\u5319\u548c\u8bc1\u4e66\u8f6e\u6362\u7684\u81ea\u52a8\u5316 A envoy-agent B pilot-agent C citadel-agent D sds-agent \u4e00\u4e2a\u540d\u4e3a pilot-agent \u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08 istiod \uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c \u3002 16\u3001\u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u54ea\u4e9b\u5185\u5bb9\uff1f A \u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04 B \u52a0\u5bc6\u7684Kubernetes secret C Base64\u7f16\u7801\u7684\u670d\u52a1\u540d\u79f0 D \u5bc6\u7801\u548c\u8bc1\u4e66 \u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04\u3002 17\u3001\u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c\u54ea\u4e9b\u7b56\u7565\u4f1a\u5148\u88ab\u8bc4\u4f30\uff1f Deny \u7b56\u7565 ALLOW\u7b56\u7565 AUDIT\u7b56\u7565 \u7b56\u7565\u662f\u968f\u673a\u8bc4\u4f30\u7684 \u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c \u5219\u9996\u5148\u8bc4\u4f30\u62d2\u7edd\u7684\u7b56\u7565 \u3002 18\u3001\u4f60\u5982\u4f55\u5728Istio\u4e2d\u542f\u7528\u6388\u6743\u529f\u80fd\uff1f A \u521b\u5efaPeerAuthentication \u8d44\u6e90 B \u914d\u7f6eRBAC C \u90e8\u7f72AuthPolicv\u8d44\u6e90 D \u4e0d\u9700\u8981\u660e\u786e\u5730\u542f\u7528\u8be5\u529f\u80fd \u6ca1\u6709\u5fc5\u8981\u660e\u786e\u5730\u542f\u7528\u6388\u6743\u529f\u80fd\u3002 \u4e3a\u4e86\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u6765\u5e94\u7528\u4e8e\u6211\u4eec\u7684\u5de5\u4f5c\u8d1f\u8f7d AuthorizationPolicy \u8d44\u6e90\u662f\u6211\u4eec\u53ef\u4ee5\u5229\u7528 PeerAuthentication \u7b56\u7565\u548c RequestAuthentication \u7b56\u7565\u4e2d\u7684\u4e3b\u4f53\u7684\u5730\u65b9 \u3002 19\u3001Istio\u5982\u4f55\u9a8c\u8bc1\u7528\u6237\uff0f\u8fdb\u7a0b\u7684\u8eab\u4efd\uff1f A \u901a\u8fc7\u63d0\u793a\u5bc6\u7801\uff08\u7528\u6237\uff09\u548cAPI\u79d8\u94a5\uff08\u8fc7\u7a0b\uff09 B \u901a\u8fc7\u4f7f\u7528PeerAuthentication\u8d44\u6e90 C \u901a\u8fc7\u4ece\u8bf7\u6c42\u4e2d\u63d0\u53d6\u51ed\u8bc1 D \u901a\u8fc7\u7b2c\u4e09\u65b9\u670d\u52a1 20\u3001\u5728Kubernetes\u4e2d\uff0c\u54ea\u4e2a\u8d44\u6e90\u4ee3\u8868\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\uff1f A \u7528\u6237\u5bf9\u8c61 B Service Account C Context D \u8bc1\u4e66 21 \u4f60\u5982\u4f55\u5728\u6574\u4e2a\u7f51\u683c\u4e2d\u5f3a\u5236\u6267\u884c\u4e25\u683c\u7684mTLS\u6a21\u5f0f\uff1f A \u901a\u8fc7\u90e8\u7f72\u4e00\u4e2aClusterRoIe\u5e76\u5c06mode\u5b57\u6bb5\u8bbe\u7f6e\u4e3aMUTUAL B \u901a\u8fc7\u90e8\u7f72\u4e00\u4e2aDestinationRule\u5e76\u5c06policy\u8bbe\u7f6e\u4e3a ISTIO_ MUTUAL C \u4f60\u4e0d\u80fd\u5728\u5168\u5c40\u8303\u56f4\u5185\u6267\u884c\u4e25\u683c\u7684mTLS\uff08\u53ea\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\uff09 D \u901a\u8fc7\u5c06 PeerAuthentication \u8d44\u6e90\u90e8\u7f72\u5230\u6839\u547d\u540d\u7a7a\u95f4(Istlo system\uff09\u4e2d \u6211\u4eec\u53ef\u4ee5\u521b\u5efa PeerAuthentication \u8d44\u6e90\uff0c\u9996\u5148\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5206\u522b\u6267\u884c\u4e25\u683c\u6a21\u5f0f\u3002 \u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u547d\u540d\u7a7a\u95f4\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f istio-system )\u521b\u5efa\u4e00\u4e2a\u7b56\u7565\uff0c\u5728\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u4e2d\u6267\u884c\u8be5\u7b56\u7565 \uff1a 22 \u5bf9\u7b49\u8ba4\u8bc1\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684\uff1f A \u7528\u6237\u8ba4\u8bc1 B \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762\u4e4b\u95f4\u7684\u8ba4\u8bc1 C \u5bf9\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684Envoy\u4ee3\u7406\u8fdb\u884c\u8ba4\u8bc1 D \u670d\u52a1\u95f4\u8ba4\u8bc1 23 \u5982\u679cKubernetes\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709Envoy\u4ee3\u7406\uff0cIstio\u662f\u5426\u4f1a\u53d1\u9001mTLS\u6d41\u91cf\uff1f A \u662f B \u5426 24 Authorization Policy\u8d44\u6e90\u4e2d\u7684selector\u548cmatchLabel\u5b57 \u6bb5\u6709\u4ec0\u4e48\u7528\u9014\uff1f A \u8981\u628a\u5de5\u4f5c\u8d1f\u8f7d\u4ece\u7b56\u7565\u4e2d\u6392\u9664\u51fa\u53bb B \u8981\u9009\u62e9\u7b56\u7565\u9002\u7528\u7684\u5de5\u4f5c\u8d1f\u8f7d C \u8981\u62d2\u7edd\u9009\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d D \u5141\u8bb8\u9009\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d","title":"8\u3001\u5b89\u5168\u6d4b\u8bd5"},{"location":"chap8/7Istio_adv_feas/","text":"\u7b2c\u4e03\u8282 Istio\u9ad8\u7ea7\u529f\u80fd Advanced Features Installing Isho on multiple clusters Network deployment models Control plane deployment models Mesh deployment models Tenancy models Working with VM workloads Lab: Connecting a VM to Istlo service mesh Quiz 1\u3001\u591a\u96c6\u7fa4\u90e8\u7f72 \u591a\u96c6\u7fa4\u90e8\u7f72\uff08\u4e24\u4e2a\u6216\u66f4\u591a\u7684\u96c6\u7fa4\uff09\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7a0b\u5ea6\u7684\u9694\u79bb\u548c\u53ef\u7528\u6027\uff0c\u4f46\u6211\u4eec\u4ed8\u51fa\u7684\u4ee3\u4ef7\u662f\u589e\u52a0\u4e86\u590d\u6742\u6027\u3002\u5982\u679c\u573a\u666f\u8981\u6c42\u9ad8\u53ef\u7528\u6027\uff08HA)\uff0c\u6211\u4eec\u5c06\u4e0d\u5f97\u4e0d\u5728\u591a\u4e2a\u533a\u57df\u548c\u5730\u533a\u90e8\u7f72\u96c6\u7fa4\u3002 \u6211\u4eec\u9700\u8981\u505a\u51fa\u7684\u4e0b\u4e00\u4e2a\u51b3\u5b9a\u662f\uff0c\u51b3\u5b9a\u6211\u4eec\u662f\u5426\u8981\u5728\u4e00\u4e2a\u7f51\u7edc\u5185\u8fd0\u884c\u96c6\u7fa4\uff0c\u6216\u8005\u662f\u5426\u8981\u4f7f\u7528\u591a\u4e2a\u7f51\u7edc\u3002 \u4e0b\u56fe\u663e\u793a\u4e86\u4e00\u4e2a\u591a\u96c6\u7fa4\u65b9\u6848\uff08\u96c6\u7fa4A\u3001B\u548cC)\uff0c\u8de8\u4e24\u4e2a\u7f51\u7edc\u90e8\u7f72\u3002 Mesh Deployment Models Service communicate across mesh boundaries Cleaner organizational boundary Stronger isolation Reuse service names and namespaces 1-1 \u7f51\u7edc\u90e8\u7f72\u6a21\u5f0f \u5f53\u6d89\u53ca\u5230\u591a\u4e2a\u7f51\u7edc\u65f6\uff0c\u96c6\u7fa4\u5185\u90e8\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5fc5\u987b\u4f7f\u7528Istio\u7f51\u5173\u624d\u80fd\u5230\u8fbe\u5176\u4ed6\u96c6\u7fa4\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4f7f\u7528\u591a\u4e2a\u7f51\u7edc\u53ef\u4ee5\u5b9e\u73b0\u66f4\u597d\u7684\u5bb9\u9519\u548c\u7f51\u7edc\u5730\u5740\u7684\u6269\u5c55 1-2 \u63a7\u5236\u5e73\u9762\u90e8\u7f72\u6a21\u578b Istio\u670d\u52a1\u7f51\u683c\u4f7f\u7528\u63a7\u5236\u5e73\u9762\u6765\u914d\u7f6e\u7f51\u683c\u5185\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6240\u8fde\u63a5\u7684\u63a7\u5236\u5e73\u9762\u53d6\u51b3\u4e8e\u5176\u914d\u7f6e\u3002 \u5728\u6700\u7b80\u5355\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\uff0c\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u53ea\u6709\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u3002\u8fd9\u5c31\u662f\u6211\u4eec\u5728\u672c\u8bfe\u7a0b\u4e2d\u4e00\u76f4\u4f7f\u7528\u7684\u914d\u7f6e\u3002 \u5171\u4eab\u63a7\u5236\u5e73\u9762\u6a21\u578b\u6d89\u53ca\u591a\u4e2a\u96c6\u7fa4\uff0c\u63a7\u5236\u5e73\u9762\u53ea\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\u3002\u8be5\u96c6\u7fa4\u88ab\u79f0\u4e3a\u4e3b\u96c6\u7fa4\uff0c\u800c\u90e8\u7f72\u4e2d\u7684\u5176\u4ed6\u96c6\u7fa4\u88ab\u79f0\u4e3a\u8fdc\u7a0b\u96c6\u7fa4\u3002\u8fd9\u4e9b\u96c6\u7fa4\u6ca1\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762\uff0c\u76f8\u53cd\uff0c\u5b83\u4eec\u4ece\u4e3b\u96c6\u7fa4\u5171\u4eab\u63a7\u5236\u5e73\u9762 \u3002 \u53e6\u4e00\u79cd\u90e8\u7f72\u6a21\u5f0f\u662f\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684\u96c6\u7fa4\u90fd\u89c6\u4e3a\u7531\u5916\u90e8\u63a7\u5236\u5e73\u9762\u63a7\u5236\u7684\u8fdc\u7a0b\u96c6\u7fa4 \u3002 \u8fd9\u4f7f\u6211\u4eec\u5728\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u6709\u4e86\u5b8c\u5168\u7684\u5206\u79bb \u3002\u4e00\u4e2a\u5178\u578b\u7684\u5916\u90e8\u63a7\u5236\u5e73\u9762\u7684\u4f8b\u5b50\u662f\u5f53\u4e00\u4e2a\u4e91\u4f9b\u5e94\u5546\u5728\u7ba1\u7406\u5b83\u3002 \u4e3a\u4e86\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\uff0c\u6211\u4eec\u5e94\u8be5\u5728\u591a\u4e2a\u96c6\u7fa4\u3001\u533a\u57df\u6216\u5730\u533a\u90e8\u7f72\u591a\u4e2a\u63a7\u5236\u5e73\u9762\u5b9e\u4f8b \uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u8fd9\u79cd\u6a21\u5f0f\u63d0\u4f9b\u4e86\u66f4\u597d\u7684\u53ef\u7528\u80dc\u548c\u914d\u7f6e\u9694\u79bb\u3002\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u53d8\u5f97\u4e0d\u53ef\u7528\u90a3\u4e48\u505c\u673a\u5c31\u53ea\u9650\u4e8e\u8fd9\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u3002\u4e3a\u4e86\u6539\u5584\u8fd9\u4e00\u70b9\u4f60\u53ef\u4ee5\u5b9e\u65bd\u6545\u969c\u8f6c\u79fb\u5e76\u914d\u7f6e\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u4f8b\u5728\u53d1\u751f\u6545\u969c\u65f6\u8fde\u63a5\u5230\u53e6\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\uff0e \u4e3a\u4e86\u8fbe\u5230\u6700\u9ad8\u7684\u53ef\u7528\u6027\u6211\u4eec\u53ef\u4ee5\u5728\u591a\u4e2a\u96c6\u7fa4\u5185\u90e8\u7f72\u4e00\u4e2a\u63a7\u5236\u5e73\u9762 1-3 \u7f51\u683c\u90e8\u7f72\u6a21\u578b \u5230\u76ee\u524d\u4e3a\u6b62\u6211\u4eec\u6240\u770b\u7684\u6240\u6709\u56fe\u8868\u548c\u573a\u666f\u90fd\u662f\u4f7f\u7528\u5355\u4e00\u7684\u7f51\u683c\u3002\u5728\u5355\u7f51\u683c\u6a21\u578b\u4e2d\u6240\u6709\u7684\u670d\u52a1\u90fd\u5728\u4e00\u4e2a\u7f51\u683c\u4e2d\u4e0d\u7ba1\u5b83\u4eec\u8de8\u8d8a\u591a\u5c11\u96c6\u7fa4\u548c\u7f51\u7edc \u5c06\u591a\u4e2a\u7f51\u683c\u8054\u5408\u8d77\u6765\u7684\u90e8\u7f72\u6a21\u578b\u88ab\u79f0\u4e3a\u591a\u7f51\u683c\u90e8\u7f72\u3002\u5728\u8fd9\u79cd\u6a21\u5f0f\u4e0b\u670d\u52a1\u53ef\u4ee5\u8de8\u7f51\u683c\u8fb9\u754c\u8fdb\u884c\u901a\u4fe1\u3002\u8be5\u6a21\u578b\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u66f4\u6e05\u6670\u7684\u7ec4\u7ec7\u8fb9\u754c\u66f4\u5f3a\u7684\u9694\u79bb\u80dc\u5e76\u5141\u8bb8\u6211\u4eec\u91cd\u590d\u4f7f\u7528\u670d\u52a1\u540d\u79f0\u548c\u547d\u540d\u7a7a\u95f4 \u5f53\u8054\u5408\u4e24\u4e2a\u7f51\u683c\u65f6\u6bcf\u4e2a\u7f51\u683c\u53ef\u4ee5\u66b4\u9732\u4e00\u7ec4\u670d\u52a1\u548c\u8eab\u4efd\u6240\u6709\u53c2\u4e0e\u7684\u7f51\u683c\u90fd\u53ef\u4ee5\u8bc6\u522b\u8fd9\u4e9b\u8eab\u4efd\u3002\u4e3a\u4e86\u5b9e\u73b0\u8de8\u7f51\u683c\u7684\u670d\u52a1\u901a\u4fe1\u6211\u4eec\u5fc5\u987b\u5728\u4e24\u4e2a\u7f51\u683c\u4e4b\u95f4\u5b9e\u73b0\u4fe1\u4efb\u3002\u4fe1\u4efb\u53ef\u4ee5\u901a\u8fc7\u5411\u7f51\u683c\u5bfc \u5165\u4fe1\u4efb\u5305\u548c\u4e3a\u8fd9\u4e9b\u8eab\u4efd\u914d\u7f6e\u672c\u5730\u7b56\u7565\u6765\u5efa\u7acb 1-4 \u79df\u6237\u6a21\u5f0f Tenancy models Tenant = group of users sharing common access and privileges to workloads Network configuration and policy used for isolation Istio: namespace and cluster tenancies (soft multi-tenancy) Namespace is a unit of tenancy \u79df\u6237\u662f\u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650\u7684\u7528\u6237\u3002\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u901a\u8fc7\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565\u5b8c\u6210\u7684 \u3002 Istio\u652f\u6301\u547d\u540d\u7a7a\u95f4\u548c\u96c6\u7fa4\u79df\u6237\u3002\u8bf7\u6ce8\u610f\u6211\u4eec\u5728\u8fd9\u91cc\u8c08\u8bba\u7684\u79df\u6237\u662f\u8f6f\u591a\u79df\u6237\u800c\u4e0d\u662f\u786c\u79df\u6237\u3002 \u5f53\u591a\u4e2a\u79df\u6237\u5171\u4eab\u540c\u4e00\u4e2aIstio\u63a7\u5236\u5e73\u9762\u65f6\u6ca1\u6709\u4fdd\u8bc1\u5bf9\u8bf8\u5982\u566a\u97f3\u90bb\u5c45\u95ee\u9898\u7684\u4fdd\u62a4 \u5728\u4e00\u4e2a\u7f51\u683c\u4e2dIstio\u4f7f\u7528\u547d\u540d\u7a7a\u95f4\u4f5c\u4e3a\u79df\u6237\u7684\u5355\u4f4d\u3002 \u5982\u679c\u4f7f\u7528Kubernetes\u6211\u4eec\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90e8\u7f72\u6388\u4e88\u6743\u9650\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6765\u81ea\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u7684\u670d\u52a1\u53ef\u4ee5\u901a\u8fc7\u5b8c\u5168\u9650\u5b9a\u540d\u76f8\u4e92\u901a\u4fe1 \u5728\u5b89\u5168\u6a21\u5757\u4e2d\u6211\u4eec\u5df2\u7ecf\u5b66\u4f1a\u4e86\u5982\u4f55\u4f7f\u7528\u6388\u6743\u7b56\u7565\u6765\u63d0\u9ad8\u9694\u79bb\u5ea6\u5e76\u9650\u5236\u53ea\u5bf9\u9002\u5f53\u7684\u8c03\u7528\u8005\u8fdb\u884c\u8bbf\u95ee\uff0e \u5728\u591a\u96c6\u7fa4\u90e8\u7f72\u6a21\u578b\u4e2d\u6bcf\u4e2a\u96c6\u7fa4\u4e2d\u5171\u4eab\u76f8\u540c\u540d\u79f0\u7684\u547d\u540d\u7a7a\u95f4\u88ab\u8ba4\u4e3a\u662f\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u3002 \u96c6\u7fa4A\u4e2ddefault\u547d\u540d\u7a7a\u95f4\u7684Customers\u670d\u52a1\u4e0e\u96c6\u7fa4B\u4e2ddefault\u547d\u540d\u7a7a\u95f4\u4e2d\u7684Customers\u670d\u52a1\u6307\u7684\u662f\u540c\u4e00\u4e2a\u670d\u52a1\u3002\u5f53\u6d41\u91cf\u88ab\u53d1\u9001\u5230Customers\u670d\u52a1\u65f6\u8d1f\u8f7d\u5747\u8861\u5728\u4e24\u4e2a\u670d\u52a1\u7684\u5408\u5e76\u7aef\u70b9\u4e0a\u8fdb\u884c\u5982\u4e0b\u56fe\u6240\u793a \u4e3a\u4e86\u5728Istio\u4e2d\u914d\u7f6e\u96c6\u7fa4\u79df\u7ea6\uff0c\u6211\u4eec\u9700\u8981\u5c06\u6bcf\u4e2a\u96c6\u7fa4\u914d\u7f6e\u4e3a\u4e00\u4e2a\u72ec\u7acb\u7684\u670d\u52a1\u7f51\u683c\u3002 \u7f51\u683c\u53ef\u4ee5\u7531\u4e0d\u540c\u7684\u56e2\u961f\u63a7\u5236\u548c\u64cd\u4f5c\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u7f51\u683c\u8fde\u63a5\u5230\u4e00\u8d77\uff0c\u5f62\u6210\u4e00\u4e2a\u591a\u7f51\u683c\u90e8\u7f72\u3002\u5982\u679c\u6211\u4eec\u4f7f\u7528\u4e0e\u4e4b\u524d\u76f8\u540c\u7684\u4f8b\u5b50\uff0c\u5728\u96c6\u7fa4A\u7684default\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u7684\u670d\u52a1Customers\u4e0e\u96c6\u7fa4B\u7684default\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u670d\u52a1Customers\u6240\u6307\u7684\u4e0d\u662f\u540c\u4e00\u4e2a\u670d\u52a1\u3002 \u79df\u6237\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u662f\u9694\u79bb\u4e0d\u540c\u79df\u6237\u7684\u914d\u7f6e\u3002\u76ee\u524d\uff0cIstio\u5e76\u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u8fc7\uff0c\u5b83\u901a\u8fc7\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u7684\u8303\u56f4\u914d\u7f6e\u6765\u5c1d\u8bd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 \u3002 1-5 \u6700\u4f73\u591a\u96c6\u7fa4\u90e8\u7f72 Best multi-cluster deployment Each cluster has its own control plane Use multi-mesh deployments External system for orchestrating meshes Always use ingress gateways across cluster Pod-to-pod connectivity can slow down and complicate things \u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\u662f\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762 \u3002\u5bf9\u4e8e\u6b63\u5e38\u7684\u670d\u52a1\u7f51\u683c\u90e8\u7f72\u89c4\u6a21\u5efa\u8bae\u4f60\u4f7f\u7528\u591a\u7f51\u683c\u90e8\u7f72\uff0c\u5e76\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u7cfb\u7edf\u5728\u5916\u90e8\u534f\u8c03\u7f51\u683c\u3002 \u4e00\u822c\u5efa\u8bae\u603b\u662f\u5728\u96c6\u7fa4\u95f4\u4f7f\u7528\u5165\u53e3\u7f51\u5173\uff0c\u5373\u4f7f\u5b83\u4eec\u5728\u540c\u4e00\u4e2a\u7f51\u7edc\u4e2d\u3002\u76f4\u63a5\u7684pod\u5230pod\u7684\u8fde\u63a5\u9700\u8981\u5728\u591a\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u586b\u5145\u7ec8\u7aef\u6570\u636e\uff0c\u8fd9\u53ef\u80fd\u4f1a\u4f7f\u4e8b\u6e05\u53d8\u5f97\u7f13\u6162\u548c\u590d\u6742\u3002\u4e00\u4e2a\u66f4\u7b80\u5355\u7684\u89e3\u51b3\u65b9\u6848\u662f\u8ba9\u6d41\u91cf\u901a\u8fc7\u8de8\u96c6\u7fa4\u7684\u5165\u53e3\u6765\u6d41\u52a8\u3002 2\u3001\u865a\u62df\u673a\u8d1f\u8f7d \u5982\u679c\u6211\u4eec\u6709\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5b83\u4eec\u8fde\u63a5\u5230Istio\u670d\u52a1\u7f51\u683c\uff0c\u4f7f\u5176\u6210\u4e3a\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002 \u5e26\u6709\u865a\u62df\u673a\u7684Istio\u670d\u52a1\u7f51\u683c\u6709\u4e24\u79cd\u67b6\u6784\uff1a\u5355\u7f51\u7edc\u67b6\u6784\u548c\u591a\u7f51\u7edc\u67b6\u6784\u3002 Working with VM Workloads Connect VMS to Istio service mesh Steps: Install Istio with meshExpension setting (IstioOperator) 0 Create a dedicated namespace and service account Extract Istio's root certificate Collett network CIDR information Configure VM (install sidecar package, copy certs and config) 2-1 \u5355\u7f51\u7edc\u67b6\u6784 \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u7f51\u7edc\u3002Kubernetes\u96c6\u7fa4\u548c\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u5728\u540c\u4e00\u4e2a\u7f51\u7edc\u4e2d\uff0c\u5b83\u4eec\u53ef\u4ee5\u76f4\u63a5\u76f8\u4e92\u901a\u4fe1\u3002 \u63a7\u5236\u5e73\u9762\u7684\u6d41\u91cf\uff08\u914d\u7f6e\u66f4\u65b0\u3001\u8bc1\u4e66\u7b7e\u7f72\uff09\u662f\u901a\u8fc7Gatewey\u53d1\u9001\u7684\u3002 \u865a\u62df\u673a\u88ab\u914d\u7f6e\u4e86\u7f51\u5173\u5730\u5740\uff0c\u6240\u4ee5\u5b83\u4eec\u5728\u542f\u52a8\u65f6\u53ef\u4ee5\u8fde\u63a5\u5230\u63a7\u5236\u5e73\u9762 2-2 \u591a\u7f51\u7edc\u67b6\u6784 \u591a\u7f51\u7edc\u67b6\u6784\u6a2a\u8de8\u591a\u4e2a\u7f51\u7edc\u3002Kubernetes\u96c6\u7fa4\u5728\u4e00\u4e2a\u7f51\u7edc\u5185\uff0c\u800c\u865a\u62df\u673a\u5219\u5728\u53e6\u4e00\u4e2a\u7f51\u7edc\u5185\u3002\u8fd9\u4f7f\u5f97Kubernetes\u96c6\u7fa4\u4e2d\u7684Pod\u548c\u865a\u62df\u673a\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u65e0\u6cd5\u76f4\u63a5\u76f8\u4e92\u901a\u4fe1 \u6240\u6709\u7684\u6d41\u91cf\u63a7\u5236\u5e73\u9762\u548cpod\u5230\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6d41\u91cf\u90e1\u6d41\u7ecf\u7f51\u5173\u7f51\u5173\u4f5c\u4e3a\u4e24\u4e2a\u7f51\u7edc\u4e4b\u95f4\u7684\u6865\u6881 2-3 Istio\u4e2d\u5982\u4f55\u8868\u793a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\uff1f \u5728Istio\u670d\u52a1\u7f51\u683c\u4e2d\u6709\u4e24\u79cd\u65b9\u5f0f\u91c7\u8868\u793a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d \u5de5\u4f5c\u8d1f\u8f7d\u7ec4(WorkloadGroup\u8d44\u6e90\uff09\u7c7b\u4f3c\u4e8eKubernetes \u4e2d\u7684\u90e8\u7f72(Deployments)\u5b83\u4ee3\u8868\u4e86\u5171\u4eab\u5171\u540c\u5c5e\u6027\u7684\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u903b\u8f91\u7ec4 \u63cf\u8ff0\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee(WorkloadEntry\u8d44\u6e90\uff09\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee\u7c7b\u4f3c\u4e8ePod\u5b83\u4ee3\u8868\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5355\u4e00\u5b9e\u4f8b \u8bf7\u6ce8\u610f\uff0c\u521b\u5efa\u8d44\u6e90\u5c06\u4e0d\u4f1a\u63d0\u4f9b\u6216\u8fd0\u884c\u4efb\u4f55\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u4e70\u4f8b\u3002 \u8fd9\u4e9b\u8d44\u6e90\u53ea\u662f\u7528\u6765\u5f15\u7528\u6216\u6307\u5411\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684 \u3002 Istio\u4f7f\u7528\u5b83\u4eec\u6765\u4e86\u89e3\u5982\u4f55\u9002\u5f53\u62bd\u914d\u7f6e\u7f51\u683c\u5c06\u54ea\u4e9b\u670b\u52a1\u6dfb\u52a0\u5230\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u7b49\u7b49 \u4e3a\u4e86\u5c06\u865a\u62df\u673a\u6dfb\u52a0\u5230\u7f51\u683c\u4e2d\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u7ec4\u4f5c\u4e3a\u6478\u677f\u3002\u7136\u540e\u5f53\u6211\u4eec\u914d\u7f6e\u5e76\u5c06\u865a\u62df\u673a\u6dfb\u52a0\u5230\u7f51\u683c\u4e2d\u65f6\u63a7\u5236\u5e73\u9762\u4f1a\u76ee\u52a8\u521b\u5efa\u4e00\u4e2a\u76f8\u5e94\u7684WorkloadEntry \u6211\u4eec\u5df2\u7ecf\u63d0\u5230WorkloadEntry\u7684\u4f5c\u7528\u7c7b\u4f3c\u4e8ePod\u3002\u5728\u6dfb\u52a0\u865a\u62df\u673a\u65f6\u4f1a\u521b\u5efa WorkloadEntry \u8d44\u6e90\u800c\u5f53\u865a\u62df\u673a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4ece\u7f51\u683c\u4e2d\u79fb\u9664\u65f6\u8be5\u8d44\u6e90\u4f1a\u88ab\u76ee\u52a8\u5220\u9664 \u9664\u4e86 WorkloadEntry \u8d44\u6e90\u5916\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2aKubernetes\u670d\u52a1\u3002\u521b\u5efa\u4e00\u4e2aKubernetes\u670d\u52a1\u7ed9\u4e86\u6211\u4eec\u4e00\u4e2a\u7a33\u8db3\u7684\u4e3b\u673a\u540d\u548cIP\u5730\u5740\u4ee5\u4fbf\u4f7f\u7528\u9009\u62e9\u5668\u5b57\u6bb5\u8bbf\u95ee\u865a\u4f3c\u673a\u5de5\u4f5c\u8d1f\u8f7d\u548cpod\u3002 \u8fd9\u4e5f\u4fbf\u6211\u4eec\u80fd\u591f\u901a\u8fc7 DestinationRule \u548c Virtualservice \u8d44\u6e90\u4fbf\u7528 Istio \u7684\u8def\u7531\u529f\u80fd 3\u3001\u5c06\u865a\u62df\u673a\u5f15\u5165\u5230Istio Mesh \u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u5c06\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u5230Kubernetes\u96c6\u7fa4\u4e0a\u8fd0\u884c\u7684 Istio\u670d\u52a1\u7f51\u683c\u3002Kubernetes\u96c6\u7fa4\u548c\u865a\u62df\u673a\u90fd\u5c06\u5728\u8c37\u6b4c\u4e91\u5e73\u53f0\uff08GCP)\u4e0a\u8fd0\u884c\u3002\u6211\u4eec\u5c06\u4f7f\u7528\u5355\u4e00\u7f51\u7edc\u67b6\u6784 \u5728\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2aKubernetes\u96c6\u7fa4\u540e\u6211\u4eec\u53ef\u4ee5\u4e0b\u8f7d\u3001\u5b89\u88c5\u548c\u914d\u7f6eIstio. 3-1 \u5728Kubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5Istio \u8ba9\u6211\u4eec\u4e0b\u8f7d Istio 1.10.3 $ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh - \u4e0b\u8f7d\u4e86Istio\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 IstioOperator \u6765\u5b89\u88c5\u5b83\uff0c\u5b83\u53ef\u4ee5\u8bbe\u7f6e\u7f51\u683cID\u3001\u96c6\u7fa4\u540d\u79f0\u548c\u7f51\u7edc\u540d\u79f0\u3002\u7f51\u7edc\u540d\u79f0\u5c06\u662f\u7a7a\u7684\u56e0\u4e3a\u6211\u4eec\u8981\u7528\u5355\u4e00\u7f51\u7edc\u67b6\u6784 \u8ba9\u6211\u4eec\u6765\u8bbe\u7f6e\u51e0\u4e2a\u73af\u5883\u53d8\u91cf\u6211\u4eec\u5c06\u5728\u672c\u5b9e\u9a8c\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u53d8\u91cf export SERVICE_ACCOUNT=\"vm-sa\" export VM_APP=\"hello-vm\" export VM_NAMESPACE=\"vm-namespace\" export WORK_DIR=\"${HOME}/vmfiles\" export CLUSTER_NETWORK=\"\" export VM_NETWORK=\"\" export CLUSTER=\"Kubernetes\" \u6211\u4eec\u8fd8\u53ef\u4ee5\u521b\u5efa $WORK_DIR \u5728\u8fd9\u91cc\u6211\u4eec\u5c06\u5b58\u50a8\u8bc1\u4e66\u548c\u5176\u4ed6\u6211\u4eec\u5fc5\u987b\u590d\u5236\u5230\u865a\u62df\u673a\u4e0a\u7684\u6587\u4ef6 istioctl operator init mkdir -p $WORK_DIR \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u521d\u59cb\u5316 Istio Operator \u5e76\u5b89\u88c5Istio: \u4e00\u65e6 Operator \u88ab\u521d\u59cb\u5316\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa IstioOperator \u8d44\u6e90\uff0c\u6307\u5b9a\u7f51\u683cID\u3001\u96c6\u7fa4\u540d\u79f0\u548c\u7f51\u7edc\u5e76\u5b89\u88c5 Istio : cat << EOF | kubectl apply -f - apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata: name: istio namespace: istio-system spec: values: global: meshID: mesh1 multiCluster: clusterName: \"${CLUSTER}\" network: \"${CLUSTER_NETWORK}\" EOF \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 kubectl get iop -n istio-system \u547d\u4ee4\u6765\u68c0\u67e5 Istio \u5b89\u88c5\u72b6\u6001\u4f55\u65f6\u53d8\u4e3a\u5065\u5eb7 \u5728\u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u5c06\u5b89\u88c5\u4e1c\u897f\u5411\u7f51\u5173\u3002\u8fd9\u662f\u63a7\u5236\u5e73\u9762\u7528\u6765\u4e0e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5bf9\u8bdd\u7684\u7f51\u5173\uff0c\u53cd\u4e4b\u4ea6\u7136 gen-eastwest-gateway.sh \u811a\u672c\u662f\u6211\u4eec\u4e4b\u524d\u4e0b\u8f7d\u7684Istio\u5305\u7684\u4e00\u90e8\u5206\u3002\u5c06\u6587\u4ef6\u5939\u6539\u4e3a\uff08\u6216\u4f60\u89e3\u538b`Istio\u7684\u6587\u4ef6\u5939\uff09\u5e76\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a samples/multicluster/gen-eastwest-gateway.sh --single-cluster | istioctl install -y -f - gen-eastwesi-gateway.sh \u811a\u672c\u4f7f\u7528\u4e00\u4e2a IstioOperetor \u6765\u90e8\u7f72\u4e00\u4e2a\u989d\u5916\u7684\u7f51\u5173\uff0c\u540d\u4e3a istio-eastwestgateway \u5e76\u914d\u7f6e\u670d\u52a1\u7aef\u53e3\u3002 \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Kubernetes \u670d\u52a1\u6765\u68c0\u67e5\u65b0\u7f51\u5173\u6700\u540e\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u914d\u7f6e\u7f51\u5173\uff0c\u901a\u8fc7\u5b83\u6765\u66b4\u9732\u63a7\u5236\u5e73\u9762\uff08 istiod )\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u90e8\u7f72 expose-istiod.yaml \u6587\u4ef6\u6765\u505a\u5230\u8fd9\u4e00\u70b9\uff1a $ kubectl apply -n istio-system -f samples/multicluster/expose-istiod.yaml gateway.networking.istio.io/istiod-gateway created virtualservice.networking.istio.io/istiod-vs created 3-2 \u51c6\u5907\u865a\u62df\u673a\u547d\u540d\u7a7a\u95f4\u548c\u6587\u4ef6 \u5bf9\u4e8e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6211\u4eec\u5fc5\u987b\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u547d\u540d\u7a7a\u95f4\u6765\u5b58\u50a8 WorkloadEntry \u8d44\u6e90\u548c\u4efb\u4f55\u5176\u4ed6\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u76f8\u5173\u7684\u8d44\u6e90\u3002 \u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u5fc5\u987b\u5bfc\u51fa\u96c6\u7fa4\u73af\u5883\u6587\u4ef6\u3001\u4ee4\u724c\u3001\u8bc1\u4e66\u548c\u5176\u4ed6\u6211\u4eec\u5fc5\u987b\u8f6c\u79fb\u5230\u865a\u62df\u673a\u4e0a\u7684\u6587\u4ef6\u3002 \u6211\u4eec\u5c06\u628a\u6240\u6709\u6587\u4ef6\u5b58\u653e\u5728\u6211\u4eec\u5728\u5b9e\u9a8c\u5f00\u59cb\u65f6\u521b\u5efa\u7684\u4e32 $WORK_DIR \u4e2d\u8ba9\u6211\u4eec\u5728\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u865a\u62df\u673a\u547d\u540d\u7a7a\u95f4\u548c\u6211\u4eec\u5c06\u7528\u4e8e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\uff1a $ kubectl create ns \"${VM_NAMESPACE}\" namespace/vm-namespace created $ kubectl create serviceaccount \"${SERVICE_ACCOUNT}\" -n \"${VM_NAMESPACE}\" serviceaccount/vm-sa created \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a WorkloadGroup \u8d44\u6e90\u5e76\u5c06\u5176\u4fdd\u5b58\u5230 workloadgroup.yaml \u4e2d\uff1a cat <<EOF > workloadgroup.yaml apiVersion: networking.istio.io/v1alpha3 kind: WorkloadGroup metadata: name: \"${VM_APP}\" namespace: \"${VM_NAMESPACE}\" spec: metadata: labels: app: \"${VM_APP}\" template: serviceAccount: \"${SERVICE_ACCOUNT}\" network: \"${VM_NETWORK}\" EOF \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a WorkloadGroup \u8d44\u6e90\u5e76\u5c06\u5176\u4fdd\u5b58\u5230 workloadgroup.yaml \u4e2d\uff1a $ kubectl apply -n istio-system -f samples/multicluster/expose-istiod.yaml gateway.networking.istio.io/istiod-gateway created virtualservice.networking.istio.io/istiod-vs created $ kubectl create ns \"${VM_NAMESPACE}\" namespace/vm-namespace created $ kubectl create serviceaccount \"${SERVICE_ACCOUNT}\" -n \"${VM_NAMESPACE}\" serviceaccount/vm-sa created $ istioctl x workload entry configure -f workloadgroup.yaml -o \"${WORK_DIR}\" --clusterID \"${CLUSTER}\" Warning: a security token for namespace \"vm-namespace\" and service account \"vm-sa\" has been generated and stored at \"/vmfiles/istio-token\" configuration generation into directory /vmfiles was successful 3-3 \u914d\u7f6e\u865a\u62df\u673a \u73b0\u5728\u662f\u65f6\u5019\u521b\u5efa\u548c\u914d\u7f6e\u4e00\u4e2a\u865a\u62df\u673a\u4e86\u3002GCP\u4e2d\u8fd0\u884c\u8fd9\u4e2a\u865a\u62df\u673a\u5c31\u50cfKubernetes\u96c6\u7fa4\u4e00\u6837\u3002\u865a\u62df\u673a\u4f7f\u7528\u7684\u662f Debian CNU/Linux10\uff08Buster \u955c\u50cf\u3002\u786e\u4fdd\u4f60\u5728\u9632\u706b\u5899\u90e8\u5206\u52fe\u9009\u4e86\u5141\u8bb8HTTP\u6d41\u91cf\u5e76\u4e14\u4f60\u6709SSH\u8bbf\u95ee\u8be5\u5b9e\u4f8b\u7684\u6743\u9650 \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u6211\u4eec\u572880\u7aef\u53e3\u8fd0\u884c\u4e00\u4e2a\u7b80\u5355\u7684 Python HTTP \u670d\u52a1\u5668\u3002\u4f60\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u7aef\u53e3\u4e0a\u914d\u7f6e\u4efb\u4f55\u5176\u4ed6\u670d\u52a1\u3002\u53ea\u8981\u786e\u4fdd\u4f60\u914d\u7f6e\u4e86\u76f8\u5e94\u7684\u5b89\u5168\u548c\u9632\u706b\u5899\u89c4\u5219. 1.\u5c06 $WORK_DIR \u4e2d\u7684\u6587\u4ef6\u590d\u5236\u5230\u5b9e\u4f8b\u7684\u4e3b\u6587\u4ef6\u5939\u4e2d\u3002\u76f8\u5e94\u5730\u66ff\u6362 USERNAME \u548c INSTANCE_IP $ scp $WORK_DIR/* [USERNAME]@[INSTANCE_IP]:~ Enter passphrase for key '/Users/peterj/.ssh/id_rsa': bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8) cluster.env 100% 589 12.6KB/s 00:00 hosts 100% 38 0.8KB/s 00:00 istio-token 100% 906 19.4KB/s 00:00 mesh.yaml 100% 667 14.4KB/s 00:00 root-cert.pem 100% 1094 23.5KB/s 00:00 \u6216\u8005\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 gcloud \u547d\u4ee4\u548c\u4e70\u4f8b\u540d\u79f0\uff1a gcloud compute scp --zone=us-west1-b ${WORK_DIR}/* [INSTANCE_NAME]:~ 2.SSH\u8fdb\u5165\u5b9e\u4f8b,\u5c06\u6839\u8bc1\u4e66\u590d\u5236\u5230 /etc/certs sudo mkdir -p /etc/certs sudo cp root-cert.pem /etc/certs/root-cert.pem 3.\u62f7\u8d1d istio-token \u6587\u4ef6\u5230 /var/run/secrets/tokens \u76ee\u5f55 sudo mkdir -p /var/run/secrets/tokens sudo cp istio-token /var/run/secrets/tokens/istio-token 4.\u4e0b\u8f7d\u548c\u5b89\u88c5 Istio sidecar \u5305\uff1a curl -LO https://storage.googleapis.com/istio-release/releases/1.10.3/deb/istio-sidecar.deb sudo dpkg -i istio-sidecar.deb 5.\u62f7\u8d1d cluster.env \u5230 /var/lib/istio/envoy/ sudo cp cluster.env /var/lib/istio/envoy/cluster.env 6.\u5c06 Mesh \u914d\u7f6e\uff08 mesh.yaml )\u6dfb\u52a0\u5230 /etc/istio/config/mesh sudo cp mesh.yaml /etc/istio/config/mesh 7.\u5c06 istiod host \u6dfb\u52a0\u5230 /etc/hosts sudo sh -c 'cat $(eval echo ~$SUDO_USER)/hosts >> /etc/hosts' 8.\u5c06 /etc/certs \u548c /var/lib/istio/envoy \u7684\u6240\u6709\u8005\u4fee\u6539\u4e3aistio proxy: sudo mkdir -p /etc/istio/proxy sudo chown -R istio-proxy /var/lib/istio /etc/certs /etc/istio/proxy /etc/istio/config /var/run/secrets /etc/certs/root-cert.pem \u4ee5\u4e0a\u90fd\u5c31\u7eea\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u865a\u62df\u673a\u4e2d\u542f\u52a8 Istio\uff1a sudo systemctl start istio \u865a\u62df\u673a\u88ab\u914d\u7f6e\u4e3a\u4e0eKubernetes\u96c6\u7fa4\u4e2dIstio\u7684\u63a7\u5236\u5e73\u9762\u901a\u4fe1 3-4 \u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u670d\u52a1 \u4ece\u865a\u62df\u673a\u8bbf\u95ee\u670d\u52a1 \u8ba9\u6211\u4eec\u5728Kubernetes\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e00\u4e2a Hello word \u5e94\u7528\u7a0b\u5e8f\u3002\u9996\u5148\u6211\u4eec\u9700\u8981\u5728 default \u547d\u540d\u7a7a\u95f4\u4e2d\u542f\u7528\u81ea\u52a8 sidecar \u6ce8\u5165 hello-world.yaml apiVersion: apps/v1 kind: Deployment metadata: name: hello-world labels: app: hello-world spec: replicas: 1 selector: matchLabels: app: hello-world template: metadata: labels: app: hello-world spec: containers: - image: gcr.io/tetratelabs/hello-world:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: hello-world labels: app: hello-world spec: selector: app: hello-world ports: - port: 80 name: http targetPort: 3000 \u7b49\u5f85Pod\u51c6\u5907\u597d\u7136\u540e\u56de\u5230\u865a\u62df\u673a\u4e0a\u5c1d\u8bd5\u8bbf\u95ee Kubernetes \u670d\u52a1 $ curl http://hello-world.default Hello World \u4f60\u53ef\u4ee5\u4ece\u865a\u62df\u673a\u4e0a\u8bbf\u95ee\u5728\u4f60\u7684Kubernetes\u96c6\u7fa4\u5185\u8fd0\u884c\u7684\u4efb\u4f55\u670d\u52a1 3-5 \u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u670d\u52a1 \u6211\u4eec\u4e5f\u53f8\u4ee5\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u3002\u5207\u6362\u5230\u5b9e\u4f8b\u4e0a\u8fd0\u884c\u4e00\u4e2a\u7b80\u5355\u7684 Python HTTP \u670d\u52a1\u5668 $ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... \u5982\u679c\u4f60\u8bd5\u56fe\u76f4\u63a5 curl \u5230\u5b9e\u4f8b IP\uff0c\u4f60\u4f1a\u5f97\u5230\u4e00\u4e2a\u54cd\u5e94\uff08\u76ee\u5f55\u5217\u8868\uff09\u3002 $ curl [INSTANCE_IP] <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\" \"http://www.w3.org/TR/html4/strict.dtd\"> <html> <head> <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"> <title>Directory listing for /</title> </head> <body> <h1>Directory listing for /</h1> <hr> ... \u4f46\u6211\u4eec\u8981\u505a\u7684\u662f\u5c06\u5de5\u4f5c\u8d1f\u8f7d\uff08Python HTTP\u670d\u52a1\uff09\u6dfb\u52a0\u5230\u7f51\u683c\u4e2d\u3002\u51fa\u4e8e\u8fd9\u4e2a\u539f\u56e0\u6211\u4eec\u5728\u524d\u9762\u521b\u5efa\u4e86\u865a\u62df\u673a\u547d\u540d\u7a7a\u95f4\u6240\u4ee5\u8ba9\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u4ee3\u8868\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u6548\u7684 Kubernetes \u670d\u52a1 \u6ce8\u610f\uff0c\u540d\u79f0\u548c\u6807\u7b7e\u503c\u7b49\u4e8e\u6211\u4eec\u4e4b\u524d\u8bbe\u7f6e\u7684 VM_APP \u73af\u8c19\u604b\u660c\u7684\u503c\u3002\u4e0d\u8981\u5fd8\u8bb0\u5c06\u670d\u52a1\u90e8\u7f72\u5230 VM_NAMESPACE hello-vm-service.yaml apiVersion: v1 kind: Service metadata: name: hello-vm labels: app: hello-vm spec: ports: - port: 80 name: http-vm targetPort: 80 selector: app: hello-vm kubectl apply -f hello-vm-service.yaml -n vm-namespace \u5c06\u5176\u90e8\u7f72\u5230VM\u547d\u540d\u7a7a\u95f4\uff0c\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u4fbf\u7528\u4e70\u9a8c\u6027\u7684\u865a\u62df\u673a\u76ee\u52a8\u6ce8\u518c\u5b83\u5c06\u81ea\u52a8\u521b\u5efa WorkloadEntry \u8d44\u6e90\u6211\u4eec\u9700\u8981\u624b\u52a8\u521b\u5efa\u5b83\u4eec \u6211\u4eec\u9700\u8981\u4e00\u4e2a\u4ee3\u8868\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684 WorkloadEntry \u2014\u2014\u8be5\u8d44\u6e90\u4f7f\u7528\u865a\u62df\u673a\u670d\u52a1\u8d26\u6237( SERVICE_ACCOUNT )\u548c\u6807\u7b7e\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u540d\u79f0\uff08 VM_APP \uff09\u3002 \u6ce8\u610f\uff0c\u6211\u4eec\u8fd8\u9700\u83b7\u5f97\u865a\u62df\u673a\u7684\u5185\u90e8 IP \u5730\u5740\uff0c \u8fd9\u6837Istio\u5c31\u77e5\u9053\u5728\u54ea\u91cc\u53ef\u4ee5\u5230\u8fbe\u865a\u62df\u673a\u3002\u8ba9\u6211\u4eec\u628a\u5b83\u5b58\u50a8\u5728\u53e6\u4e00\u4e2a\u73af\u5883\u53d8\u91cf\u4e2d\uff08\u786e\u4fdd\u7528\u4f60\u7684\u503c\u66ff\u6362 INSTANCE_NAME \u548c ZONE )\u3002 export VM_IP=$(gcloud compute instances describe [INSTANCE_NAME] --format='get(networkInterfaces[0].networkIP)' --zone=[ZONE]) workloadentry.yaml cat <<EOF> workloadentry.yaml apiVersion: networking.istio.io/v1alpha3 kind: WorkloadEntry metadata: name: ${VM_APP} namespace: ${VM_NAMESPACE} spec: serviceAccount: ${SERVICE_ACCOUNT} address: ${VM_IP} labels: app: ${VM_APP} instance-id: vm1 EOF kubectl apply -n ${VM_NAMESPACE} -f workloadentry.yaml \u4e3a\u4e86\u628a\u865a\u62df\u673a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u52a0\u5165\u5230\u7f51\u683c\u5185\u6211\u4eec\u8fd8\u9700\u8981\u5b9a\u4e49ServiceEntry cat <<EOF>> serviceentry.yaml apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: ${VM_APP} spec: hosts: - ${VM_APP} location: MESH_INTERNAL ports: - number: 80 name: http protocol: HTTP targetPort: 80 resolution: STATIC workloadSelector: labels: app: ${VM_APP} \u8bf7\u6ce8\u610f\uff0cWorkloadEntry \u548c ServiceEntry \u5728\u672a\u6765\u6700\u7ec8\u5c06\u81ea\u52a8\u521b\u5efa\u3002 kubectl apply -n ${VM_NAMESPACE} -f serviceentry.yaml \u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u4fbf\u7528Kubernetes\u670d\u52a1\u540d\u79f0 hello-vm.vm-namespace \u6765\u8bbf\u95ee\u865a\u4f3c\u673a\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8ba9\u6211\u4eec\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\u4e00\u4e2aPod\u5e76\u5c1d\u8bd5\u4ece\u90a3\u91cc\u8bbf\u95ee\u8be5\u670d\u52a1 $ kubectl run curl --image=radial/busyboxplus:curl -i --tty If you don't see a command prompt, try pressing enter. [ root@curl:/ ]$ Pod\u4e2d\u7684\u547d\u4ee4\u63d0\u793a\u540e\u4f60\u53ef\u4ee5\u8fd0\u884ccurl\u5e76\u8bbf\u95ee\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4f60\u5e94\u8be5\u770b\u5230\u4e00\u4e2a\u76ee\u5f55\u5217\u8868\u540c\u6837\u5730\u4f60\u4f1a\u6ce8\u610f\u5230\u5728 HTTP \u670d\u52a1\u5668\u8fd0\u884c\u7684\u5b9e\u4f8b\u4e0a\u6709\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\uff1a [ root@curl:/ ]$ curl hello-vm.vm-namespace <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\" \"http://www.w3.org/TR/html4/strict.dtd\"> <html> <head> <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"> <title>Directory listing for /</title> </head> <body> <h1>Directory listing for /</h1> <hr> ... 4\u3001\u9ad8\u7ea7\u529f\u80fd\u6d4b\u8bd5 1\u3001Istio\u5728\u7f51\u683c\u4e2d\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u79df\u6237\u5355\u4f4d\uff1f A. Deployment B. \u7528\u6237\u7ec4 C. Namespace D. \u96c6\u7fa4 \u5728\u4e00\u4e2a\u7f51\u683c\u4e2dIstio\u4f7f\u7528\u547d\u540d\u7a7a\u95f4\u4f5c\u4e3a\u79df\u6237\u7684\u5355\u4f4d\u3002 2\u3001\u4f60\u4f7f\u7528\u54ea\u4e9b\u8d44\u6e90\u5c06\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c\uff1f A. Deployment \u548c Service B. VirtualService \u548c Deployment C. Ingress \u548c Deployment D. WorkloadGroup \u548c WorkloadEntry \u5de5\u4f5c\u8d1f\u8f7d\u7ec4(WorkloadGroup\u8d44\u6e90\uff09\u7c7b\u4f3c\u4e8eKubernetes \u4e2d\u7684\u90e8\u7f72(Deployments)\u5b83\u4ee3\u8868\u4e86\u5171\u4eab\u5171\u540c\u5c5e\u6027\u7684\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u903b\u8f91\u7ec4 \u63cf\u8ff0\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee(WorkloadEntry\u8d44\u6e90\uff09\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee\u7c7b\u4f3c\u4e8ePod\u5b83\u4ee3\u8868\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5355\u4e00\u5b9e\u4f8b 3\u3001\u4f60\u662f\u5426\u53ef\u4ee5\u901a\u8fc7\u5c06\u6240\u6709\u96c6\u7fa4\u4f5c\u4e3a\u8fdc\u7a0b\u96c6\u7fa4\u6765\u5b9e\u73b0\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u7684\u5b8c\u5168\u5206\u79bb\uff1f\uff08\u662f/\u5426\uff1f) A \u662f B \u5426 \u53e6\u4e00\u79cd\u90e8\u7f72\u6a21\u5f0f\u662f\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684\u96c6\u7fa4\u90fd\u89c6\u4e3a\u7531\u5916\u90e8\u63a7\u5236\u5e73\u9762\u63a7\u5236\u7684\u8fdc\u7a0b\u96c6\u7fa4 \u3002 \u8fd9\u4f7f\u6211\u4eec\u5728\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u6709\u4e86\u5b8c\u5168\u7684\u5206\u79bb \u3002 4\u3001Istio\u662f\u5982\u4f55\u89e3\u51b3\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u914d\u7f6e\u9694\u79bb\u7684\uff1f A. \u901a\u8fc7\u4f7f\u7528\u5355\u72ec\u7684\u63a7\u5236\u5e73\u9762 B. \u901a\u8fc7\u5728\u96c6\u7fa4\u5916\u5b58\u50a8\u914d\u7f6e C. \u4e0d\u53ef\u884c D \u901a\u8fc7\u5bf9etcd\u4e2d\u7684\u914d\u7f6e\u548c\u79d8\u5bc6\u8fdb\u884c\u52a0\u5bc6 \u79df\u6237\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u662f\u9694\u79bb\u4e0d\u540c\u79df\u6237\u7684\u914d\u7f6e\u3002\u76ee\u524d\uff0cIstio\u5e76\u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u8fc7\uff0c\u5b83\u901a\u8fc7\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u7684\u8303\u56f4\u914d\u7f6e\u6765\u5c1d\u8bd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 5\u3001\u591a\u96c6\u7fa4\u90e8\u7f72\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f A \u4e3a\u4e86\u83b7\u5f97\u66f4\u5927\u7a0b\u5ea6\u7684\u9694\u79bb\u548c\u53ef\u7528\u6027 \uff0e B \u4e3a\u4e86\u63d0\u9ad8\u670d\u52a1\u7f51\u683c\u7684\u6027\u80fd C \u4e3a\u4e86\u5f15\u865a\u62df\u673a\u8d1f\u8f7d D \u518d\u90e8\u7f72\u591a\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u65f6\uff0c\u4e3a\u4e86\u8282\u7701\u6210\u672c \u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\u662f\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762 \u3002\u5bf9\u4e8e\u6b63\u5e38\u7684\u670d\u52a1\u7f51\u683c\u90e8\u7f72\u89c4\u6a21\u5efa\u8bae\u4f60\u4f7f\u7528\u591a\u7f51\u683c\u90e8\u7f72\uff0c\u5e76\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u7cfb\u7edf\u5728\u5916\u90e8\u534f\u8c03\u7f51\u683c\u3002 6\u3001\u4ec0\u4e48\u662f\u79df\u6237\uff1f A \u5355\u4e2a\u96c6\u7fa4\u53ca\u5176\u6240\u6709\u7528\u6237 B \u4e00\u7ec4\u7528\u6237\u5171\u4eab\u4e00\u7ec4\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650 C \u591a\u4e2a\u96c6\u7fa4\u5171\u4eab\u76f8\u540c\u7684\u7528\u6237\u8d26\u6237 D \u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u96c6\u7fa4 \u79df\u6237\u662f\u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650\u7684\u7528\u6237\u3002\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u901a\u8fc7\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565\u5b8c\u6210\u7684 \u3002 7\u3001\u90e8\u7f72\u591a\u4e2a\u63a7\u5236\u5e73\u9762\u662f\u5426\u80fd\u63d0\u9ad8\u6210\u672c\u6548\u7387\uff1f\uff08\u662f\uff0f\u5426\uff09 \u662f \u5426 8\u3001What does the shared control plane model involve? A \u5728\u4e91\u63d0\u4f9b\u5546\u5904\u5e26\u6709\u63a7\u5236\u5e73\u9762\u7684\u5355\u4e00\u96c6\u7fa4\u90e8\u7f72 B \u591a\u4e2a\u96c6\u7fa4\u63a7\u5236\u5e73\u9762\u53ea\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff08\u4e3b\u96c6\u7fa4\uff09 C \u591a\u4e2a\u96c6\u7fa4\uff0c\u6bcf\u4e2a\u96c6\u7fa4\u6709\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\uff0c\u53ef\u4ee5\u5728\u4efb\u4f55\u65f6\u5019\u53d1\u6325\u5171\u4eab\u63a7\u5236\u5e73\u9762\u4f5c\u7528 D \u5728\u4f7f\u7528\u591a\u4e2a\u96bd\u7fa4\u65f6\u80fd\u591f\u56de\u9000\u5230\u4e0d\u540c\u7684\u63a7\u5236\u5e73\u9762 9\u3001\u4ec0\u4e48\u88ab\u8ba4\u4e3a\u662f\u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\uff1f A \u6bcf\u4e2a\u96c6\u7fa4\u5171\u4eab\u6570\u636e\u5e73\u9762 B \u6bcf\u4e2a\u96c6\u7fa4\u5171\u4eab\u63a7\u5236\u5e73\u9762 C \u6bcf\u4e2a\u96c6\u7fa4\u90fd\u4f9d\u8d56\u4e00\u4e2a\u63a7\u5236\u6570\u636e\u5e73\u9762 D \u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762 10\u3001\u4e3a\u4e86\u652f\u6301\u96c6\u7fa4\u79df\u6237\uff0c\u4f60\u9700\u8981\u914d\u7f6e\u591a\u4e2a\u96c6\u7fa4\u6765\u5171\u4eab\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u3002\uff08\u662f\uff0f\u5426\uff1f) A \u662f B \u5426 11\u3001\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1f \u4f7f\u7528namespace \u4f7f\u7528\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565 \u4f7f\u7528EnvoyFilter \u4f7f\u7528Sidecar\u8d44\u6e90 12\u3001\u5de5\u4f5c\u8d1f\u8f7d\u5e94\u8be5\u5982\u4f55\u5728\u96c6\u7fa4\u4e4b\u95f4\u8fdb\u884c\u901a\u4fe1\uff1f \u76f4\u63a5\u4ece\u4e00\u4e2aPod\u5230\u53e6\u4e00\u4e2aPod \u901a\u8fc7ingress gateway \u4ece\u4e00\u4e2aKubernetes\u670d\u52a1\u5230\u4e0d\u540c\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e2a\u7aef\u70b9 \u4f7f\u7528\u5916\u90e8gateway","title":"\u7b2c\u4e03\u8282 Istio\u9ad8\u7ea7\u529f\u80fd"},{"location":"chap8/7Istio_adv_feas/#istio","text":"","title":"\u7b2c\u4e03\u8282 Istio\u9ad8\u7ea7\u529f\u80fd"},{"location":"chap8/7Istio_adv_feas/#advanced-features","text":"Installing Isho on multiple clusters Network deployment models Control plane deployment models Mesh deployment models Tenancy models Working with VM workloads Lab: Connecting a VM to Istlo service mesh Quiz","title":"Advanced Features"},{"location":"chap8/7Istio_adv_feas/#1","text":"\u591a\u96c6\u7fa4\u90e8\u7f72\uff08\u4e24\u4e2a\u6216\u66f4\u591a\u7684\u96c6\u7fa4\uff09\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7a0b\u5ea6\u7684\u9694\u79bb\u548c\u53ef\u7528\u6027\uff0c\u4f46\u6211\u4eec\u4ed8\u51fa\u7684\u4ee3\u4ef7\u662f\u589e\u52a0\u4e86\u590d\u6742\u6027\u3002\u5982\u679c\u573a\u666f\u8981\u6c42\u9ad8\u53ef\u7528\u6027\uff08HA)\uff0c\u6211\u4eec\u5c06\u4e0d\u5f97\u4e0d\u5728\u591a\u4e2a\u533a\u57df\u548c\u5730\u533a\u90e8\u7f72\u96c6\u7fa4\u3002 \u6211\u4eec\u9700\u8981\u505a\u51fa\u7684\u4e0b\u4e00\u4e2a\u51b3\u5b9a\u662f\uff0c\u51b3\u5b9a\u6211\u4eec\u662f\u5426\u8981\u5728\u4e00\u4e2a\u7f51\u7edc\u5185\u8fd0\u884c\u96c6\u7fa4\uff0c\u6216\u8005\u662f\u5426\u8981\u4f7f\u7528\u591a\u4e2a\u7f51\u7edc\u3002 \u4e0b\u56fe\u663e\u793a\u4e86\u4e00\u4e2a\u591a\u96c6\u7fa4\u65b9\u6848\uff08\u96c6\u7fa4A\u3001B\u548cC)\uff0c\u8de8\u4e24\u4e2a\u7f51\u7edc\u90e8\u7f72\u3002 Mesh Deployment Models Service communicate across mesh boundaries Cleaner organizational boundary Stronger isolation Reuse service names and namespaces","title":"1\u3001\u591a\u96c6\u7fa4\u90e8\u7f72"},{"location":"chap8/7Istio_adv_feas/#1-1","text":"\u5f53\u6d89\u53ca\u5230\u591a\u4e2a\u7f51\u7edc\u65f6\uff0c\u96c6\u7fa4\u5185\u90e8\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5fc5\u987b\u4f7f\u7528Istio\u7f51\u5173\u624d\u80fd\u5230\u8fbe\u5176\u4ed6\u96c6\u7fa4\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4f7f\u7528\u591a\u4e2a\u7f51\u7edc\u53ef\u4ee5\u5b9e\u73b0\u66f4\u597d\u7684\u5bb9\u9519\u548c\u7f51\u7edc\u5730\u5740\u7684\u6269\u5c55","title":"1-1 \u7f51\u7edc\u90e8\u7f72\u6a21\u5f0f"},{"location":"chap8/7Istio_adv_feas/#1-2","text":"Istio\u670d\u52a1\u7f51\u683c\u4f7f\u7528\u63a7\u5236\u5e73\u9762\u6765\u914d\u7f6e\u7f51\u683c\u5185\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6240\u8fde\u63a5\u7684\u63a7\u5236\u5e73\u9762\u53d6\u51b3\u4e8e\u5176\u914d\u7f6e\u3002 \u5728\u6700\u7b80\u5355\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\uff0c\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u53ea\u6709\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u3002\u8fd9\u5c31\u662f\u6211\u4eec\u5728\u672c\u8bfe\u7a0b\u4e2d\u4e00\u76f4\u4f7f\u7528\u7684\u914d\u7f6e\u3002 \u5171\u4eab\u63a7\u5236\u5e73\u9762\u6a21\u578b\u6d89\u53ca\u591a\u4e2a\u96c6\u7fa4\uff0c\u63a7\u5236\u5e73\u9762\u53ea\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\u3002\u8be5\u96c6\u7fa4\u88ab\u79f0\u4e3a\u4e3b\u96c6\u7fa4\uff0c\u800c\u90e8\u7f72\u4e2d\u7684\u5176\u4ed6\u96c6\u7fa4\u88ab\u79f0\u4e3a\u8fdc\u7a0b\u96c6\u7fa4\u3002\u8fd9\u4e9b\u96c6\u7fa4\u6ca1\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762\uff0c\u76f8\u53cd\uff0c\u5b83\u4eec\u4ece\u4e3b\u96c6\u7fa4\u5171\u4eab\u63a7\u5236\u5e73\u9762 \u3002 \u53e6\u4e00\u79cd\u90e8\u7f72\u6a21\u5f0f\u662f\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684\u96c6\u7fa4\u90fd\u89c6\u4e3a\u7531\u5916\u90e8\u63a7\u5236\u5e73\u9762\u63a7\u5236\u7684\u8fdc\u7a0b\u96c6\u7fa4 \u3002 \u8fd9\u4f7f\u6211\u4eec\u5728\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u6709\u4e86\u5b8c\u5168\u7684\u5206\u79bb \u3002\u4e00\u4e2a\u5178\u578b\u7684\u5916\u90e8\u63a7\u5236\u5e73\u9762\u7684\u4f8b\u5b50\u662f\u5f53\u4e00\u4e2a\u4e91\u4f9b\u5e94\u5546\u5728\u7ba1\u7406\u5b83\u3002 \u4e3a\u4e86\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\uff0c\u6211\u4eec\u5e94\u8be5\u5728\u591a\u4e2a\u96c6\u7fa4\u3001\u533a\u57df\u6216\u5730\u533a\u90e8\u7f72\u591a\u4e2a\u63a7\u5236\u5e73\u9762\u5b9e\u4f8b \uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u8fd9\u79cd\u6a21\u5f0f\u63d0\u4f9b\u4e86\u66f4\u597d\u7684\u53ef\u7528\u80dc\u548c\u914d\u7f6e\u9694\u79bb\u3002\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u53d8\u5f97\u4e0d\u53ef\u7528\u90a3\u4e48\u505c\u673a\u5c31\u53ea\u9650\u4e8e\u8fd9\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u3002\u4e3a\u4e86\u6539\u5584\u8fd9\u4e00\u70b9\u4f60\u53ef\u4ee5\u5b9e\u65bd\u6545\u969c\u8f6c\u79fb\u5e76\u914d\u7f6e\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u4f8b\u5728\u53d1\u751f\u6545\u969c\u65f6\u8fde\u63a5\u5230\u53e6\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\uff0e \u4e3a\u4e86\u8fbe\u5230\u6700\u9ad8\u7684\u53ef\u7528\u6027\u6211\u4eec\u53ef\u4ee5\u5728\u591a\u4e2a\u96c6\u7fa4\u5185\u90e8\u7f72\u4e00\u4e2a\u63a7\u5236\u5e73\u9762","title":"1-2 \u63a7\u5236\u5e73\u9762\u90e8\u7f72\u6a21\u578b"},{"location":"chap8/7Istio_adv_feas/#1-3","text":"\u5230\u76ee\u524d\u4e3a\u6b62\u6211\u4eec\u6240\u770b\u7684\u6240\u6709\u56fe\u8868\u548c\u573a\u666f\u90fd\u662f\u4f7f\u7528\u5355\u4e00\u7684\u7f51\u683c\u3002\u5728\u5355\u7f51\u683c\u6a21\u578b\u4e2d\u6240\u6709\u7684\u670d\u52a1\u90fd\u5728\u4e00\u4e2a\u7f51\u683c\u4e2d\u4e0d\u7ba1\u5b83\u4eec\u8de8\u8d8a\u591a\u5c11\u96c6\u7fa4\u548c\u7f51\u7edc \u5c06\u591a\u4e2a\u7f51\u683c\u8054\u5408\u8d77\u6765\u7684\u90e8\u7f72\u6a21\u578b\u88ab\u79f0\u4e3a\u591a\u7f51\u683c\u90e8\u7f72\u3002\u5728\u8fd9\u79cd\u6a21\u5f0f\u4e0b\u670d\u52a1\u53ef\u4ee5\u8de8\u7f51\u683c\u8fb9\u754c\u8fdb\u884c\u901a\u4fe1\u3002\u8be5\u6a21\u578b\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u66f4\u6e05\u6670\u7684\u7ec4\u7ec7\u8fb9\u754c\u66f4\u5f3a\u7684\u9694\u79bb\u80dc\u5e76\u5141\u8bb8\u6211\u4eec\u91cd\u590d\u4f7f\u7528\u670d\u52a1\u540d\u79f0\u548c\u547d\u540d\u7a7a\u95f4 \u5f53\u8054\u5408\u4e24\u4e2a\u7f51\u683c\u65f6\u6bcf\u4e2a\u7f51\u683c\u53ef\u4ee5\u66b4\u9732\u4e00\u7ec4\u670d\u52a1\u548c\u8eab\u4efd\u6240\u6709\u53c2\u4e0e\u7684\u7f51\u683c\u90fd\u53ef\u4ee5\u8bc6\u522b\u8fd9\u4e9b\u8eab\u4efd\u3002\u4e3a\u4e86\u5b9e\u73b0\u8de8\u7f51\u683c\u7684\u670d\u52a1\u901a\u4fe1\u6211\u4eec\u5fc5\u987b\u5728\u4e24\u4e2a\u7f51\u683c\u4e4b\u95f4\u5b9e\u73b0\u4fe1\u4efb\u3002\u4fe1\u4efb\u53ef\u4ee5\u901a\u8fc7\u5411\u7f51\u683c\u5bfc \u5165\u4fe1\u4efb\u5305\u548c\u4e3a\u8fd9\u4e9b\u8eab\u4efd\u914d\u7f6e\u672c\u5730\u7b56\u7565\u6765\u5efa\u7acb","title":"1-3 \u7f51\u683c\u90e8\u7f72\u6a21\u578b"},{"location":"chap8/7Istio_adv_feas/#1-4","text":"Tenancy models Tenant = group of users sharing common access and privileges to workloads Network configuration and policy used for isolation Istio: namespace and cluster tenancies (soft multi-tenancy) Namespace is a unit of tenancy \u79df\u6237\u662f\u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650\u7684\u7528\u6237\u3002\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u901a\u8fc7\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565\u5b8c\u6210\u7684 \u3002 Istio\u652f\u6301\u547d\u540d\u7a7a\u95f4\u548c\u96c6\u7fa4\u79df\u6237\u3002\u8bf7\u6ce8\u610f\u6211\u4eec\u5728\u8fd9\u91cc\u8c08\u8bba\u7684\u79df\u6237\u662f\u8f6f\u591a\u79df\u6237\u800c\u4e0d\u662f\u786c\u79df\u6237\u3002 \u5f53\u591a\u4e2a\u79df\u6237\u5171\u4eab\u540c\u4e00\u4e2aIstio\u63a7\u5236\u5e73\u9762\u65f6\u6ca1\u6709\u4fdd\u8bc1\u5bf9\u8bf8\u5982\u566a\u97f3\u90bb\u5c45\u95ee\u9898\u7684\u4fdd\u62a4 \u5728\u4e00\u4e2a\u7f51\u683c\u4e2dIstio\u4f7f\u7528\u547d\u540d\u7a7a\u95f4\u4f5c\u4e3a\u79df\u6237\u7684\u5355\u4f4d\u3002 \u5982\u679c\u4f7f\u7528Kubernetes\u6211\u4eec\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90e8\u7f72\u6388\u4e88\u6743\u9650\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6765\u81ea\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u7684\u670d\u52a1\u53ef\u4ee5\u901a\u8fc7\u5b8c\u5168\u9650\u5b9a\u540d\u76f8\u4e92\u901a\u4fe1 \u5728\u5b89\u5168\u6a21\u5757\u4e2d\u6211\u4eec\u5df2\u7ecf\u5b66\u4f1a\u4e86\u5982\u4f55\u4f7f\u7528\u6388\u6743\u7b56\u7565\u6765\u63d0\u9ad8\u9694\u79bb\u5ea6\u5e76\u9650\u5236\u53ea\u5bf9\u9002\u5f53\u7684\u8c03\u7528\u8005\u8fdb\u884c\u8bbf\u95ee\uff0e \u5728\u591a\u96c6\u7fa4\u90e8\u7f72\u6a21\u578b\u4e2d\u6bcf\u4e2a\u96c6\u7fa4\u4e2d\u5171\u4eab\u76f8\u540c\u540d\u79f0\u7684\u547d\u540d\u7a7a\u95f4\u88ab\u8ba4\u4e3a\u662f\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u3002 \u96c6\u7fa4A\u4e2ddefault\u547d\u540d\u7a7a\u95f4\u7684Customers\u670d\u52a1\u4e0e\u96c6\u7fa4B\u4e2ddefault\u547d\u540d\u7a7a\u95f4\u4e2d\u7684Customers\u670d\u52a1\u6307\u7684\u662f\u540c\u4e00\u4e2a\u670d\u52a1\u3002\u5f53\u6d41\u91cf\u88ab\u53d1\u9001\u5230Customers\u670d\u52a1\u65f6\u8d1f\u8f7d\u5747\u8861\u5728\u4e24\u4e2a\u670d\u52a1\u7684\u5408\u5e76\u7aef\u70b9\u4e0a\u8fdb\u884c\u5982\u4e0b\u56fe\u6240\u793a \u4e3a\u4e86\u5728Istio\u4e2d\u914d\u7f6e\u96c6\u7fa4\u79df\u7ea6\uff0c\u6211\u4eec\u9700\u8981\u5c06\u6bcf\u4e2a\u96c6\u7fa4\u914d\u7f6e\u4e3a\u4e00\u4e2a\u72ec\u7acb\u7684\u670d\u52a1\u7f51\u683c\u3002 \u7f51\u683c\u53ef\u4ee5\u7531\u4e0d\u540c\u7684\u56e2\u961f\u63a7\u5236\u548c\u64cd\u4f5c\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u7f51\u683c\u8fde\u63a5\u5230\u4e00\u8d77\uff0c\u5f62\u6210\u4e00\u4e2a\u591a\u7f51\u683c\u90e8\u7f72\u3002\u5982\u679c\u6211\u4eec\u4f7f\u7528\u4e0e\u4e4b\u524d\u76f8\u540c\u7684\u4f8b\u5b50\uff0c\u5728\u96c6\u7fa4A\u7684default\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u7684\u670d\u52a1Customers\u4e0e\u96c6\u7fa4B\u7684default\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u670d\u52a1Customers\u6240\u6307\u7684\u4e0d\u662f\u540c\u4e00\u4e2a\u670d\u52a1\u3002 \u79df\u6237\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u662f\u9694\u79bb\u4e0d\u540c\u79df\u6237\u7684\u914d\u7f6e\u3002\u76ee\u524d\uff0cIstio\u5e76\u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u8fc7\uff0c\u5b83\u901a\u8fc7\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u7684\u8303\u56f4\u914d\u7f6e\u6765\u5c1d\u8bd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 \u3002","title":"1-4 \u79df\u6237\u6a21\u5f0f"},{"location":"chap8/7Istio_adv_feas/#1-5","text":"Best multi-cluster deployment Each cluster has its own control plane Use multi-mesh deployments External system for orchestrating meshes Always use ingress gateways across cluster Pod-to-pod connectivity can slow down and complicate things \u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\u662f\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762 \u3002\u5bf9\u4e8e\u6b63\u5e38\u7684\u670d\u52a1\u7f51\u683c\u90e8\u7f72\u89c4\u6a21\u5efa\u8bae\u4f60\u4f7f\u7528\u591a\u7f51\u683c\u90e8\u7f72\uff0c\u5e76\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u7cfb\u7edf\u5728\u5916\u90e8\u534f\u8c03\u7f51\u683c\u3002 \u4e00\u822c\u5efa\u8bae\u603b\u662f\u5728\u96c6\u7fa4\u95f4\u4f7f\u7528\u5165\u53e3\u7f51\u5173\uff0c\u5373\u4f7f\u5b83\u4eec\u5728\u540c\u4e00\u4e2a\u7f51\u7edc\u4e2d\u3002\u76f4\u63a5\u7684pod\u5230pod\u7684\u8fde\u63a5\u9700\u8981\u5728\u591a\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u586b\u5145\u7ec8\u7aef\u6570\u636e\uff0c\u8fd9\u53ef\u80fd\u4f1a\u4f7f\u4e8b\u6e05\u53d8\u5f97\u7f13\u6162\u548c\u590d\u6742\u3002\u4e00\u4e2a\u66f4\u7b80\u5355\u7684\u89e3\u51b3\u65b9\u6848\u662f\u8ba9\u6d41\u91cf\u901a\u8fc7\u8de8\u96c6\u7fa4\u7684\u5165\u53e3\u6765\u6d41\u52a8\u3002","title":"1-5 \u6700\u4f73\u591a\u96c6\u7fa4\u90e8\u7f72"},{"location":"chap8/7Istio_adv_feas/#2","text":"\u5982\u679c\u6211\u4eec\u6709\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5b83\u4eec\u8fde\u63a5\u5230Istio\u670d\u52a1\u7f51\u683c\uff0c\u4f7f\u5176\u6210\u4e3a\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002 \u5e26\u6709\u865a\u62df\u673a\u7684Istio\u670d\u52a1\u7f51\u683c\u6709\u4e24\u79cd\u67b6\u6784\uff1a\u5355\u7f51\u7edc\u67b6\u6784\u548c\u591a\u7f51\u7edc\u67b6\u6784\u3002 Working with VM Workloads Connect VMS to Istio service mesh Steps: Install Istio with meshExpension setting (IstioOperator) 0 Create a dedicated namespace and service account Extract Istio's root certificate Collett network CIDR information Configure VM (install sidecar package, copy certs and config)","title":"2\u3001\u865a\u62df\u673a\u8d1f\u8f7d"},{"location":"chap8/7Istio_adv_feas/#2-1","text":"\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u7f51\u7edc\u3002Kubernetes\u96c6\u7fa4\u548c\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u5728\u540c\u4e00\u4e2a\u7f51\u7edc\u4e2d\uff0c\u5b83\u4eec\u53ef\u4ee5\u76f4\u63a5\u76f8\u4e92\u901a\u4fe1\u3002 \u63a7\u5236\u5e73\u9762\u7684\u6d41\u91cf\uff08\u914d\u7f6e\u66f4\u65b0\u3001\u8bc1\u4e66\u7b7e\u7f72\uff09\u662f\u901a\u8fc7Gatewey\u53d1\u9001\u7684\u3002 \u865a\u62df\u673a\u88ab\u914d\u7f6e\u4e86\u7f51\u5173\u5730\u5740\uff0c\u6240\u4ee5\u5b83\u4eec\u5728\u542f\u52a8\u65f6\u53ef\u4ee5\u8fde\u63a5\u5230\u63a7\u5236\u5e73\u9762","title":"2-1 \u5355\u7f51\u7edc\u67b6\u6784"},{"location":"chap8/7Istio_adv_feas/#2-2","text":"\u591a\u7f51\u7edc\u67b6\u6784\u6a2a\u8de8\u591a\u4e2a\u7f51\u7edc\u3002Kubernetes\u96c6\u7fa4\u5728\u4e00\u4e2a\u7f51\u7edc\u5185\uff0c\u800c\u865a\u62df\u673a\u5219\u5728\u53e6\u4e00\u4e2a\u7f51\u7edc\u5185\u3002\u8fd9\u4f7f\u5f97Kubernetes\u96c6\u7fa4\u4e2d\u7684Pod\u548c\u865a\u62df\u673a\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u65e0\u6cd5\u76f4\u63a5\u76f8\u4e92\u901a\u4fe1 \u6240\u6709\u7684\u6d41\u91cf\u63a7\u5236\u5e73\u9762\u548cpod\u5230\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6d41\u91cf\u90e1\u6d41\u7ecf\u7f51\u5173\u7f51\u5173\u4f5c\u4e3a\u4e24\u4e2a\u7f51\u7edc\u4e4b\u95f4\u7684\u6865\u6881","title":"2-2 \u591a\u7f51\u7edc\u67b6\u6784"},{"location":"chap8/7Istio_adv_feas/#2-3-istio","text":"\u5728Istio\u670d\u52a1\u7f51\u683c\u4e2d\u6709\u4e24\u79cd\u65b9\u5f0f\u91c7\u8868\u793a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d \u5de5\u4f5c\u8d1f\u8f7d\u7ec4(WorkloadGroup\u8d44\u6e90\uff09\u7c7b\u4f3c\u4e8eKubernetes \u4e2d\u7684\u90e8\u7f72(Deployments)\u5b83\u4ee3\u8868\u4e86\u5171\u4eab\u5171\u540c\u5c5e\u6027\u7684\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u903b\u8f91\u7ec4 \u63cf\u8ff0\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee(WorkloadEntry\u8d44\u6e90\uff09\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee\u7c7b\u4f3c\u4e8ePod\u5b83\u4ee3\u8868\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5355\u4e00\u5b9e\u4f8b \u8bf7\u6ce8\u610f\uff0c\u521b\u5efa\u8d44\u6e90\u5c06\u4e0d\u4f1a\u63d0\u4f9b\u6216\u8fd0\u884c\u4efb\u4f55\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u4e70\u4f8b\u3002 \u8fd9\u4e9b\u8d44\u6e90\u53ea\u662f\u7528\u6765\u5f15\u7528\u6216\u6307\u5411\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684 \u3002 Istio\u4f7f\u7528\u5b83\u4eec\u6765\u4e86\u89e3\u5982\u4f55\u9002\u5f53\u62bd\u914d\u7f6e\u7f51\u683c\u5c06\u54ea\u4e9b\u670b\u52a1\u6dfb\u52a0\u5230\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u4e2d\u7b49\u7b49 \u4e3a\u4e86\u5c06\u865a\u62df\u673a\u6dfb\u52a0\u5230\u7f51\u683c\u4e2d\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u7ec4\u4f5c\u4e3a\u6478\u677f\u3002\u7136\u540e\u5f53\u6211\u4eec\u914d\u7f6e\u5e76\u5c06\u865a\u62df\u673a\u6dfb\u52a0\u5230\u7f51\u683c\u4e2d\u65f6\u63a7\u5236\u5e73\u9762\u4f1a\u76ee\u52a8\u521b\u5efa\u4e00\u4e2a\u76f8\u5e94\u7684WorkloadEntry \u6211\u4eec\u5df2\u7ecf\u63d0\u5230WorkloadEntry\u7684\u4f5c\u7528\u7c7b\u4f3c\u4e8ePod\u3002\u5728\u6dfb\u52a0\u865a\u62df\u673a\u65f6\u4f1a\u521b\u5efa WorkloadEntry \u8d44\u6e90\u800c\u5f53\u865a\u62df\u673a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4ece\u7f51\u683c\u4e2d\u79fb\u9664\u65f6\u8be5\u8d44\u6e90\u4f1a\u88ab\u76ee\u52a8\u5220\u9664 \u9664\u4e86 WorkloadEntry \u8d44\u6e90\u5916\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2aKubernetes\u670d\u52a1\u3002\u521b\u5efa\u4e00\u4e2aKubernetes\u670d\u52a1\u7ed9\u4e86\u6211\u4eec\u4e00\u4e2a\u7a33\u8db3\u7684\u4e3b\u673a\u540d\u548cIP\u5730\u5740\u4ee5\u4fbf\u4f7f\u7528\u9009\u62e9\u5668\u5b57\u6bb5\u8bbf\u95ee\u865a\u4f3c\u673a\u5de5\u4f5c\u8d1f\u8f7d\u548cpod\u3002 \u8fd9\u4e5f\u4fbf\u6211\u4eec\u80fd\u591f\u901a\u8fc7 DestinationRule \u548c Virtualservice \u8d44\u6e90\u4fbf\u7528 Istio \u7684\u8def\u7531\u529f\u80fd","title":"2-3 Istio\u4e2d\u5982\u4f55\u8868\u793a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\uff1f"},{"location":"chap8/7Istio_adv_feas/#3istio-mesh","text":"\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u5c06\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u5230Kubernetes\u96c6\u7fa4\u4e0a\u8fd0\u884c\u7684 Istio\u670d\u52a1\u7f51\u683c\u3002Kubernetes\u96c6\u7fa4\u548c\u865a\u62df\u673a\u90fd\u5c06\u5728\u8c37\u6b4c\u4e91\u5e73\u53f0\uff08GCP)\u4e0a\u8fd0\u884c\u3002\u6211\u4eec\u5c06\u4f7f\u7528\u5355\u4e00\u7f51\u7edc\u67b6\u6784 \u5728\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2aKubernetes\u96c6\u7fa4\u540e\u6211\u4eec\u53ef\u4ee5\u4e0b\u8f7d\u3001\u5b89\u88c5\u548c\u914d\u7f6eIstio.","title":"3\u3001\u5c06\u865a\u62df\u673a\u5f15\u5165\u5230Istio Mesh"},{"location":"chap8/7Istio_adv_feas/#3-1-kubernetesistio","text":"\u8ba9\u6211\u4eec\u4e0b\u8f7d Istio 1.10.3 $ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.10.3 sh - \u4e0b\u8f7d\u4e86Istio\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 IstioOperator \u6765\u5b89\u88c5\u5b83\uff0c\u5b83\u53ef\u4ee5\u8bbe\u7f6e\u7f51\u683cID\u3001\u96c6\u7fa4\u540d\u79f0\u548c\u7f51\u7edc\u540d\u79f0\u3002\u7f51\u7edc\u540d\u79f0\u5c06\u662f\u7a7a\u7684\u56e0\u4e3a\u6211\u4eec\u8981\u7528\u5355\u4e00\u7f51\u7edc\u67b6\u6784 \u8ba9\u6211\u4eec\u6765\u8bbe\u7f6e\u51e0\u4e2a\u73af\u5883\u53d8\u91cf\u6211\u4eec\u5c06\u5728\u672c\u5b9e\u9a8c\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u53d8\u91cf export SERVICE_ACCOUNT=\"vm-sa\" export VM_APP=\"hello-vm\" export VM_NAMESPACE=\"vm-namespace\" export WORK_DIR=\"${HOME}/vmfiles\" export CLUSTER_NETWORK=\"\" export VM_NETWORK=\"\" export CLUSTER=\"Kubernetes\" \u6211\u4eec\u8fd8\u53ef\u4ee5\u521b\u5efa $WORK_DIR \u5728\u8fd9\u91cc\u6211\u4eec\u5c06\u5b58\u50a8\u8bc1\u4e66\u548c\u5176\u4ed6\u6211\u4eec\u5fc5\u987b\u590d\u5236\u5230\u865a\u62df\u673a\u4e0a\u7684\u6587\u4ef6 istioctl operator init mkdir -p $WORK_DIR \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u521d\u59cb\u5316 Istio Operator \u5e76\u5b89\u88c5Istio: \u4e00\u65e6 Operator \u88ab\u521d\u59cb\u5316\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa IstioOperator \u8d44\u6e90\uff0c\u6307\u5b9a\u7f51\u683cID\u3001\u96c6\u7fa4\u540d\u79f0\u548c\u7f51\u7edc\u5e76\u5b89\u88c5 Istio : cat << EOF | kubectl apply -f - apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata: name: istio namespace: istio-system spec: values: global: meshID: mesh1 multiCluster: clusterName: \"${CLUSTER}\" network: \"${CLUSTER_NETWORK}\" EOF \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 kubectl get iop -n istio-system \u547d\u4ee4\u6765\u68c0\u67e5 Istio \u5b89\u88c5\u72b6\u6001\u4f55\u65f6\u53d8\u4e3a\u5065\u5eb7 \u5728\u4e0b\u4e00\u6b65\uff0c\u6211\u4eec\u5c06\u5b89\u88c5\u4e1c\u897f\u5411\u7f51\u5173\u3002\u8fd9\u662f\u63a7\u5236\u5e73\u9762\u7528\u6765\u4e0e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5bf9\u8bdd\u7684\u7f51\u5173\uff0c\u53cd\u4e4b\u4ea6\u7136 gen-eastwest-gateway.sh \u811a\u672c\u662f\u6211\u4eec\u4e4b\u524d\u4e0b\u8f7d\u7684Istio\u5305\u7684\u4e00\u90e8\u5206\u3002\u5c06\u6587\u4ef6\u5939\u6539\u4e3a\uff08\u6216\u4f60\u89e3\u538b`Istio\u7684\u6587\u4ef6\u5939\uff09\u5e76\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a samples/multicluster/gen-eastwest-gateway.sh --single-cluster | istioctl install -y -f - gen-eastwesi-gateway.sh \u811a\u672c\u4f7f\u7528\u4e00\u4e2a IstioOperetor \u6765\u90e8\u7f72\u4e00\u4e2a\u989d\u5916\u7684\u7f51\u5173\uff0c\u540d\u4e3a istio-eastwestgateway \u5e76\u914d\u7f6e\u670d\u52a1\u7aef\u53e3\u3002 \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Kubernetes \u670d\u52a1\u6765\u68c0\u67e5\u65b0\u7f51\u5173\u6700\u540e\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u914d\u7f6e\u7f51\u5173\uff0c\u901a\u8fc7\u5b83\u6765\u66b4\u9732\u63a7\u5236\u5e73\u9762\uff08 istiod )\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u90e8\u7f72 expose-istiod.yaml \u6587\u4ef6\u6765\u505a\u5230\u8fd9\u4e00\u70b9\uff1a $ kubectl apply -n istio-system -f samples/multicluster/expose-istiod.yaml gateway.networking.istio.io/istiod-gateway created virtualservice.networking.istio.io/istiod-vs created","title":"3-1 \u5728Kubernetes\u96c6\u7fa4\u4e0a\u5b89\u88c5Istio"},{"location":"chap8/7Istio_adv_feas/#3-2","text":"\u5bf9\u4e8e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u6211\u4eec\u5fc5\u987b\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u547d\u540d\u7a7a\u95f4\u6765\u5b58\u50a8 WorkloadEntry \u8d44\u6e90\u548c\u4efb\u4f55\u5176\u4ed6\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u76f8\u5173\u7684\u8d44\u6e90\u3002 \u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u5fc5\u987b\u5bfc\u51fa\u96c6\u7fa4\u73af\u5883\u6587\u4ef6\u3001\u4ee4\u724c\u3001\u8bc1\u4e66\u548c\u5176\u4ed6\u6211\u4eec\u5fc5\u987b\u8f6c\u79fb\u5230\u865a\u62df\u673a\u4e0a\u7684\u6587\u4ef6\u3002 \u6211\u4eec\u5c06\u628a\u6240\u6709\u6587\u4ef6\u5b58\u653e\u5728\u6211\u4eec\u5728\u5b9e\u9a8c\u5f00\u59cb\u65f6\u521b\u5efa\u7684\u4e32 $WORK_DIR \u4e2d\u8ba9\u6211\u4eec\u5728\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u865a\u62df\u673a\u547d\u540d\u7a7a\u95f4\u548c\u6211\u4eec\u5c06\u7528\u4e8e\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u670d\u52a1\u8d26\u6237\uff1a $ kubectl create ns \"${VM_NAMESPACE}\" namespace/vm-namespace created $ kubectl create serviceaccount \"${SERVICE_ACCOUNT}\" -n \"${VM_NAMESPACE}\" serviceaccount/vm-sa created \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a WorkloadGroup \u8d44\u6e90\u5e76\u5c06\u5176\u4fdd\u5b58\u5230 workloadgroup.yaml \u4e2d\uff1a cat <<EOF > workloadgroup.yaml apiVersion: networking.istio.io/v1alpha3 kind: WorkloadGroup metadata: name: \"${VM_APP}\" namespace: \"${VM_NAMESPACE}\" spec: metadata: labels: app: \"${VM_APP}\" template: serviceAccount: \"${SERVICE_ACCOUNT}\" network: \"${VM_NETWORK}\" EOF \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a WorkloadGroup \u8d44\u6e90\u5e76\u5c06\u5176\u4fdd\u5b58\u5230 workloadgroup.yaml \u4e2d\uff1a $ kubectl apply -n istio-system -f samples/multicluster/expose-istiod.yaml gateway.networking.istio.io/istiod-gateway created virtualservice.networking.istio.io/istiod-vs created $ kubectl create ns \"${VM_NAMESPACE}\" namespace/vm-namespace created $ kubectl create serviceaccount \"${SERVICE_ACCOUNT}\" -n \"${VM_NAMESPACE}\" serviceaccount/vm-sa created $ istioctl x workload entry configure -f workloadgroup.yaml -o \"${WORK_DIR}\" --clusterID \"${CLUSTER}\" Warning: a security token for namespace \"vm-namespace\" and service account \"vm-sa\" has been generated and stored at \"/vmfiles/istio-token\" configuration generation into directory /vmfiles was successful","title":"3-2 \u51c6\u5907\u865a\u62df\u673a\u547d\u540d\u7a7a\u95f4\u548c\u6587\u4ef6"},{"location":"chap8/7Istio_adv_feas/#3-3","text":"\u73b0\u5728\u662f\u65f6\u5019\u521b\u5efa\u548c\u914d\u7f6e\u4e00\u4e2a\u865a\u62df\u673a\u4e86\u3002GCP\u4e2d\u8fd0\u884c\u8fd9\u4e2a\u865a\u62df\u673a\u5c31\u50cfKubernetes\u96c6\u7fa4\u4e00\u6837\u3002\u865a\u62df\u673a\u4f7f\u7528\u7684\u662f Debian CNU/Linux10\uff08Buster \u955c\u50cf\u3002\u786e\u4fdd\u4f60\u5728\u9632\u706b\u5899\u90e8\u5206\u52fe\u9009\u4e86\u5141\u8bb8HTTP\u6d41\u91cf\u5e76\u4e14\u4f60\u6709SSH\u8bbf\u95ee\u8be5\u5b9e\u4f8b\u7684\u6743\u9650 \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u6211\u4eec\u572880\u7aef\u53e3\u8fd0\u884c\u4e00\u4e2a\u7b80\u5355\u7684 Python HTTP \u670d\u52a1\u5668\u3002\u4f60\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u7aef\u53e3\u4e0a\u914d\u7f6e\u4efb\u4f55\u5176\u4ed6\u670d\u52a1\u3002\u53ea\u8981\u786e\u4fdd\u4f60\u914d\u7f6e\u4e86\u76f8\u5e94\u7684\u5b89\u5168\u548c\u9632\u706b\u5899\u89c4\u5219. 1.\u5c06 $WORK_DIR \u4e2d\u7684\u6587\u4ef6\u590d\u5236\u5230\u5b9e\u4f8b\u7684\u4e3b\u6587\u4ef6\u5939\u4e2d\u3002\u76f8\u5e94\u5730\u66ff\u6362 USERNAME \u548c INSTANCE_IP $ scp $WORK_DIR/* [USERNAME]@[INSTANCE_IP]:~ Enter passphrase for key '/Users/peterj/.ssh/id_rsa': bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8) cluster.env 100% 589 12.6KB/s 00:00 hosts 100% 38 0.8KB/s 00:00 istio-token 100% 906 19.4KB/s 00:00 mesh.yaml 100% 667 14.4KB/s 00:00 root-cert.pem 100% 1094 23.5KB/s 00:00 \u6216\u8005\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 gcloud \u547d\u4ee4\u548c\u4e70\u4f8b\u540d\u79f0\uff1a gcloud compute scp --zone=us-west1-b ${WORK_DIR}/* [INSTANCE_NAME]:~ 2.SSH\u8fdb\u5165\u5b9e\u4f8b,\u5c06\u6839\u8bc1\u4e66\u590d\u5236\u5230 /etc/certs sudo mkdir -p /etc/certs sudo cp root-cert.pem /etc/certs/root-cert.pem 3.\u62f7\u8d1d istio-token \u6587\u4ef6\u5230 /var/run/secrets/tokens \u76ee\u5f55 sudo mkdir -p /var/run/secrets/tokens sudo cp istio-token /var/run/secrets/tokens/istio-token 4.\u4e0b\u8f7d\u548c\u5b89\u88c5 Istio sidecar \u5305\uff1a curl -LO https://storage.googleapis.com/istio-release/releases/1.10.3/deb/istio-sidecar.deb sudo dpkg -i istio-sidecar.deb 5.\u62f7\u8d1d cluster.env \u5230 /var/lib/istio/envoy/ sudo cp cluster.env /var/lib/istio/envoy/cluster.env 6.\u5c06 Mesh \u914d\u7f6e\uff08 mesh.yaml )\u6dfb\u52a0\u5230 /etc/istio/config/mesh sudo cp mesh.yaml /etc/istio/config/mesh 7.\u5c06 istiod host \u6dfb\u52a0\u5230 /etc/hosts sudo sh -c 'cat $(eval echo ~$SUDO_USER)/hosts >> /etc/hosts' 8.\u5c06 /etc/certs \u548c /var/lib/istio/envoy \u7684\u6240\u6709\u8005\u4fee\u6539\u4e3aistio proxy: sudo mkdir -p /etc/istio/proxy sudo chown -R istio-proxy /var/lib/istio /etc/certs /etc/istio/proxy /etc/istio/config /var/run/secrets /etc/certs/root-cert.pem \u4ee5\u4e0a\u90fd\u5c31\u7eea\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u865a\u62df\u673a\u4e2d\u542f\u52a8 Istio\uff1a sudo systemctl start istio \u865a\u62df\u673a\u88ab\u914d\u7f6e\u4e3a\u4e0eKubernetes\u96c6\u7fa4\u4e2dIstio\u7684\u63a7\u5236\u5e73\u9762\u901a\u4fe1","title":"3-3 \u914d\u7f6e\u865a\u62df\u673a"},{"location":"chap8/7Istio_adv_feas/#3-4","text":"\u4ece\u865a\u62df\u673a\u8bbf\u95ee\u670d\u52a1 \u8ba9\u6211\u4eec\u5728Kubernetes\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e00\u4e2a Hello word \u5e94\u7528\u7a0b\u5e8f\u3002\u9996\u5148\u6211\u4eec\u9700\u8981\u5728 default \u547d\u540d\u7a7a\u95f4\u4e2d\u542f\u7528\u81ea\u52a8 sidecar \u6ce8\u5165 hello-world.yaml apiVersion: apps/v1 kind: Deployment metadata: name: hello-world labels: app: hello-world spec: replicas: 1 selector: matchLabels: app: hello-world template: metadata: labels: app: hello-world spec: containers: - image: gcr.io/tetratelabs/hello-world:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: hello-world labels: app: hello-world spec: selector: app: hello-world ports: - port: 80 name: http targetPort: 3000 \u7b49\u5f85Pod\u51c6\u5907\u597d\u7136\u540e\u56de\u5230\u865a\u62df\u673a\u4e0a\u5c1d\u8bd5\u8bbf\u95ee Kubernetes \u670d\u52a1 $ curl http://hello-world.default Hello World \u4f60\u53ef\u4ee5\u4ece\u865a\u62df\u673a\u4e0a\u8bbf\u95ee\u5728\u4f60\u7684Kubernetes\u96c6\u7fa4\u5185\u8fd0\u884c\u7684\u4efb\u4f55\u670d\u52a1","title":"3-4 \u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u670d\u52a1"},{"location":"chap8/7Istio_adv_feas/#3-5","text":"\u6211\u4eec\u4e5f\u53f8\u4ee5\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u3002\u5207\u6362\u5230\u5b9e\u4f8b\u4e0a\u8fd0\u884c\u4e00\u4e2a\u7b80\u5355\u7684 Python HTTP \u670d\u52a1\u5668 $ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... \u5982\u679c\u4f60\u8bd5\u56fe\u76f4\u63a5 curl \u5230\u5b9e\u4f8b IP\uff0c\u4f60\u4f1a\u5f97\u5230\u4e00\u4e2a\u54cd\u5e94\uff08\u76ee\u5f55\u5217\u8868\uff09\u3002 $ curl [INSTANCE_IP] <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\" \"http://www.w3.org/TR/html4/strict.dtd\"> <html> <head> <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"> <title>Directory listing for /</title> </head> <body> <h1>Directory listing for /</h1> <hr> ... \u4f46\u6211\u4eec\u8981\u505a\u7684\u662f\u5c06\u5de5\u4f5c\u8d1f\u8f7d\uff08Python HTTP\u670d\u52a1\uff09\u6dfb\u52a0\u5230\u7f51\u683c\u4e2d\u3002\u51fa\u4e8e\u8fd9\u4e2a\u539f\u56e0\u6211\u4eec\u5728\u524d\u9762\u521b\u5efa\u4e86\u865a\u62df\u673a\u547d\u540d\u7a7a\u95f4\u6240\u4ee5\u8ba9\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u4ee3\u8868\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u6548\u7684 Kubernetes \u670d\u52a1 \u6ce8\u610f\uff0c\u540d\u79f0\u548c\u6807\u7b7e\u503c\u7b49\u4e8e\u6211\u4eec\u4e4b\u524d\u8bbe\u7f6e\u7684 VM_APP \u73af\u8c19\u604b\u660c\u7684\u503c\u3002\u4e0d\u8981\u5fd8\u8bb0\u5c06\u670d\u52a1\u90e8\u7f72\u5230 VM_NAMESPACE hello-vm-service.yaml apiVersion: v1 kind: Service metadata: name: hello-vm labels: app: hello-vm spec: ports: - port: 80 name: http-vm targetPort: 80 selector: app: hello-vm kubectl apply -f hello-vm-service.yaml -n vm-namespace \u5c06\u5176\u90e8\u7f72\u5230VM\u547d\u540d\u7a7a\u95f4\uff0c\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u4fbf\u7528\u4e70\u9a8c\u6027\u7684\u865a\u62df\u673a\u76ee\u52a8\u6ce8\u518c\u5b83\u5c06\u81ea\u52a8\u521b\u5efa WorkloadEntry \u8d44\u6e90\u6211\u4eec\u9700\u8981\u624b\u52a8\u521b\u5efa\u5b83\u4eec \u6211\u4eec\u9700\u8981\u4e00\u4e2a\u4ee3\u8868\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684 WorkloadEntry \u2014\u2014\u8be5\u8d44\u6e90\u4f7f\u7528\u865a\u62df\u673a\u670d\u52a1\u8d26\u6237( SERVICE_ACCOUNT )\u548c\u6807\u7b7e\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u540d\u79f0\uff08 VM_APP \uff09\u3002 \u6ce8\u610f\uff0c\u6211\u4eec\u8fd8\u9700\u83b7\u5f97\u865a\u62df\u673a\u7684\u5185\u90e8 IP \u5730\u5740\uff0c \u8fd9\u6837Istio\u5c31\u77e5\u9053\u5728\u54ea\u91cc\u53ef\u4ee5\u5230\u8fbe\u865a\u62df\u673a\u3002\u8ba9\u6211\u4eec\u628a\u5b83\u5b58\u50a8\u5728\u53e6\u4e00\u4e2a\u73af\u5883\u53d8\u91cf\u4e2d\uff08\u786e\u4fdd\u7528\u4f60\u7684\u503c\u66ff\u6362 INSTANCE_NAME \u548c ZONE )\u3002 export VM_IP=$(gcloud compute instances describe [INSTANCE_NAME] --format='get(networkInterfaces[0].networkIP)' --zone=[ZONE]) workloadentry.yaml cat <<EOF> workloadentry.yaml apiVersion: networking.istio.io/v1alpha3 kind: WorkloadEntry metadata: name: ${VM_APP} namespace: ${VM_NAMESPACE} spec: serviceAccount: ${SERVICE_ACCOUNT} address: ${VM_IP} labels: app: ${VM_APP} instance-id: vm1 EOF kubectl apply -n ${VM_NAMESPACE} -f workloadentry.yaml \u4e3a\u4e86\u628a\u865a\u62df\u673a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u52a0\u5165\u5230\u7f51\u683c\u5185\u6211\u4eec\u8fd8\u9700\u8981\u5b9a\u4e49ServiceEntry cat <<EOF>> serviceentry.yaml apiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: ${VM_APP} spec: hosts: - ${VM_APP} location: MESH_INTERNAL ports: - number: 80 name: http protocol: HTTP targetPort: 80 resolution: STATIC workloadSelector: labels: app: ${VM_APP} \u8bf7\u6ce8\u610f\uff0cWorkloadEntry \u548c ServiceEntry \u5728\u672a\u6765\u6700\u7ec8\u5c06\u81ea\u52a8\u521b\u5efa\u3002 kubectl apply -n ${VM_NAMESPACE} -f serviceentry.yaml \u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u4fbf\u7528Kubernetes\u670d\u52a1\u540d\u79f0 hello-vm.vm-namespace \u6765\u8bbf\u95ee\u865a\u4f3c\u673a\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u8ba9\u6211\u4eec\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\u4e00\u4e2aPod\u5e76\u5c1d\u8bd5\u4ece\u90a3\u91cc\u8bbf\u95ee\u8be5\u670d\u52a1 $ kubectl run curl --image=radial/busyboxplus:curl -i --tty If you don't see a command prompt, try pressing enter. [ root@curl:/ ]$ Pod\u4e2d\u7684\u547d\u4ee4\u63d0\u793a\u540e\u4f60\u53ef\u4ee5\u8fd0\u884ccurl\u5e76\u8bbf\u95ee\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4f60\u5e94\u8be5\u770b\u5230\u4e00\u4e2a\u76ee\u5f55\u5217\u8868\u540c\u6837\u5730\u4f60\u4f1a\u6ce8\u610f\u5230\u5728 HTTP \u670d\u52a1\u5668\u8fd0\u884c\u7684\u5b9e\u4f8b\u4e0a\u6709\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\uff1a [ root@curl:/ ]$ curl hello-vm.vm-namespace <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\" \"http://www.w3.org/TR/html4/strict.dtd\"> <html> <head> <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"> <title>Directory listing for /</title> </head> <body> <h1>Directory listing for /</h1> <hr> ...","title":"3-5 \u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u670d\u52a1"},{"location":"chap8/7Istio_adv_feas/#4","text":"1\u3001Istio\u5728\u7f51\u683c\u4e2d\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u79df\u6237\u5355\u4f4d\uff1f A. Deployment B. \u7528\u6237\u7ec4 C. Namespace D. \u96c6\u7fa4 \u5728\u4e00\u4e2a\u7f51\u683c\u4e2dIstio\u4f7f\u7528\u547d\u540d\u7a7a\u95f4\u4f5c\u4e3a\u79df\u6237\u7684\u5355\u4f4d\u3002 2\u3001\u4f60\u4f7f\u7528\u54ea\u4e9b\u8d44\u6e90\u5c06\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c\uff1f A. Deployment \u548c Service B. VirtualService \u548c Deployment C. Ingress \u548c Deployment D. WorkloadGroup \u548c WorkloadEntry \u5de5\u4f5c\u8d1f\u8f7d\u7ec4(WorkloadGroup\u8d44\u6e90\uff09\u7c7b\u4f3c\u4e8eKubernetes \u4e2d\u7684\u90e8\u7f72(Deployments)\u5b83\u4ee3\u8868\u4e86\u5171\u4eab\u5171\u540c\u5c5e\u6027\u7684\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u903b\u8f91\u7ec4 \u63cf\u8ff0\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee(WorkloadEntry\u8d44\u6e90\uff09\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee\u7c7b\u4f3c\u4e8ePod\u5b83\u4ee3\u8868\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5355\u4e00\u5b9e\u4f8b 3\u3001\u4f60\u662f\u5426\u53ef\u4ee5\u901a\u8fc7\u5c06\u6240\u6709\u96c6\u7fa4\u4f5c\u4e3a\u8fdc\u7a0b\u96c6\u7fa4\u6765\u5b9e\u73b0\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u7684\u5b8c\u5168\u5206\u79bb\uff1f\uff08\u662f/\u5426\uff1f) A \u662f B \u5426 \u53e6\u4e00\u79cd\u90e8\u7f72\u6a21\u5f0f\u662f\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684\u96c6\u7fa4\u90fd\u89c6\u4e3a\u7531\u5916\u90e8\u63a7\u5236\u5e73\u9762\u63a7\u5236\u7684\u8fdc\u7a0b\u96c6\u7fa4 \u3002 \u8fd9\u4f7f\u6211\u4eec\u5728\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u6709\u4e86\u5b8c\u5168\u7684\u5206\u79bb \u3002 4\u3001Istio\u662f\u5982\u4f55\u89e3\u51b3\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u914d\u7f6e\u9694\u79bb\u7684\uff1f A. \u901a\u8fc7\u4f7f\u7528\u5355\u72ec\u7684\u63a7\u5236\u5e73\u9762 B. \u901a\u8fc7\u5728\u96c6\u7fa4\u5916\u5b58\u50a8\u914d\u7f6e C. \u4e0d\u53ef\u884c D \u901a\u8fc7\u5bf9etcd\u4e2d\u7684\u914d\u7f6e\u548c\u79d8\u5bc6\u8fdb\u884c\u52a0\u5bc6 \u79df\u6237\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u662f\u9694\u79bb\u4e0d\u540c\u79df\u6237\u7684\u914d\u7f6e\u3002\u76ee\u524d\uff0cIstio\u5e76\u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u8fc7\uff0c\u5b83\u901a\u8fc7\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u7684\u8303\u56f4\u914d\u7f6e\u6765\u5c1d\u8bd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 5\u3001\u591a\u96c6\u7fa4\u90e8\u7f72\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f A \u4e3a\u4e86\u83b7\u5f97\u66f4\u5927\u7a0b\u5ea6\u7684\u9694\u79bb\u548c\u53ef\u7528\u6027 \uff0e B \u4e3a\u4e86\u63d0\u9ad8\u670d\u52a1\u7f51\u683c\u7684\u6027\u80fd C \u4e3a\u4e86\u5f15\u865a\u62df\u673a\u8d1f\u8f7d D \u518d\u90e8\u7f72\u591a\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u65f6\uff0c\u4e3a\u4e86\u8282\u7701\u6210\u672c \u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\u662f\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762 \u3002\u5bf9\u4e8e\u6b63\u5e38\u7684\u670d\u52a1\u7f51\u683c\u90e8\u7f72\u89c4\u6a21\u5efa\u8bae\u4f60\u4f7f\u7528\u591a\u7f51\u683c\u90e8\u7f72\uff0c\u5e76\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u7cfb\u7edf\u5728\u5916\u90e8\u534f\u8c03\u7f51\u683c\u3002 6\u3001\u4ec0\u4e48\u662f\u79df\u6237\uff1f A \u5355\u4e2a\u96c6\u7fa4\u53ca\u5176\u6240\u6709\u7528\u6237 B \u4e00\u7ec4\u7528\u6237\u5171\u4eab\u4e00\u7ec4\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650 C \u591a\u4e2a\u96c6\u7fa4\u5171\u4eab\u76f8\u540c\u7684\u7528\u6237\u8d26\u6237 D \u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u96c6\u7fa4 \u79df\u6237\u662f\u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650\u7684\u7528\u6237\u3002\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u901a\u8fc7\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565\u5b8c\u6210\u7684 \u3002 7\u3001\u90e8\u7f72\u591a\u4e2a\u63a7\u5236\u5e73\u9762\u662f\u5426\u80fd\u63d0\u9ad8\u6210\u672c\u6548\u7387\uff1f\uff08\u662f\uff0f\u5426\uff09 \u662f \u5426 8\u3001What does the shared control plane model involve? A \u5728\u4e91\u63d0\u4f9b\u5546\u5904\u5e26\u6709\u63a7\u5236\u5e73\u9762\u7684\u5355\u4e00\u96c6\u7fa4\u90e8\u7f72 B \u591a\u4e2a\u96c6\u7fa4\u63a7\u5236\u5e73\u9762\u53ea\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff08\u4e3b\u96c6\u7fa4\uff09 C \u591a\u4e2a\u96c6\u7fa4\uff0c\u6bcf\u4e2a\u96c6\u7fa4\u6709\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\uff0c\u53ef\u4ee5\u5728\u4efb\u4f55\u65f6\u5019\u53d1\u6325\u5171\u4eab\u63a7\u5236\u5e73\u9762\u4f5c\u7528 D \u5728\u4f7f\u7528\u591a\u4e2a\u96bd\u7fa4\u65f6\u80fd\u591f\u56de\u9000\u5230\u4e0d\u540c\u7684\u63a7\u5236\u5e73\u9762 9\u3001\u4ec0\u4e48\u88ab\u8ba4\u4e3a\u662f\u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\uff1f A \u6bcf\u4e2a\u96c6\u7fa4\u5171\u4eab\u6570\u636e\u5e73\u9762 B \u6bcf\u4e2a\u96c6\u7fa4\u5171\u4eab\u63a7\u5236\u5e73\u9762 C \u6bcf\u4e2a\u96c6\u7fa4\u90fd\u4f9d\u8d56\u4e00\u4e2a\u63a7\u5236\u6570\u636e\u5e73\u9762 D \u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762 10\u3001\u4e3a\u4e86\u652f\u6301\u96c6\u7fa4\u79df\u6237\uff0c\u4f60\u9700\u8981\u914d\u7f6e\u591a\u4e2a\u96c6\u7fa4\u6765\u5171\u4eab\u4e00\u4e2a\u63a7\u5236\u5e73\u9762\u3002\uff08\u662f\uff0f\u5426\uff1f) A \u662f B \u5426 11\u3001\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1f \u4f7f\u7528namespace \u4f7f\u7528\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565 \u4f7f\u7528EnvoyFilter \u4f7f\u7528Sidecar\u8d44\u6e90 12\u3001\u5de5\u4f5c\u8d1f\u8f7d\u5e94\u8be5\u5982\u4f55\u5728\u96c6\u7fa4\u4e4b\u95f4\u8fdb\u884c\u901a\u4fe1\uff1f \u76f4\u63a5\u4ece\u4e00\u4e2aPod\u5230\u53e6\u4e00\u4e2aPod \u901a\u8fc7ingress gateway \u4ece\u4e00\u4e2aKubernetes\u670d\u52a1\u5230\u4e0d\u540c\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e2a\u7aef\u70b9 \u4f7f\u7528\u5916\u90e8gateway","title":"4\u3001\u9ad8\u7ea7\u529f\u80fd\u6d4b\u8bd5"},{"location":"chap8/8Istio_trouble_shoot/","text":"\u7b2c\u516b\u8282 Istio \u95ee\u9898\u6392\u67e5 1\u3001Envoy\u57fa\u7840 \u4e3a\u4e86\u6392\u9664Istio\u7684\u95ee\u9898\uff0c\u5bf9Envoy\u7684\u5de5\u4f5c\u539f\u7406\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u4e86\u89e3\u662f\u5f88\u6709\u5e2e\u52a9\u7684\u3002Envoy\u914d\u7f6e\u662f \u4e00\u4e2aJSON\u6587\u4ef6\uff0c\u5206\u4e3a\u591a\u4e2a\u90e8\u5206\u3002\u6211\u4eec\u9700\u8981\u4e86\u89e3Envoy\u7684\u57fa\u672c\u6982\u5ff5\u662f\u76d1\u542c\u5668\u3001\u8def\u7531\u3001\u96c6\u7fa4\u548c\u7aef\u70b9\u3002 \u8fd9\u4e9b\u6982\u5ff5\u6620\u5c04\u5230istio\u548cKubernetes\u8d44\u6e90\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 Basics of Envoy JSON configuration Basic concepts: Listeners Routes Cluster Endpoints Multiple listeners for each sidecar Inbound: 0.0.0.0:15006 Outbound: 0.0.0.0:15001 Listeners hands off requests off to a virtual listener Default: PassthroughCluster \u76d1\u542c\u5668\u662f\u547d\u540d\u7684\u7f51\u7edc\u4f4d\u7f6e\uff0c\u901a\u5e38\u662f\u4e00\u4e2aIP\u548c\u7aef\u53e3\u3002Envoy\u5bf9\u8fd9\u4e9b\u4f4d\u7f6e\u8fdb\u884c\u76d1\u542c\uff0c\u8fd9\u662f\u5b83\u63a5\u6536\u548c\u8fde\u63a5\u548c\u8bf7\u6c42\u7684\u5730\u65b9\u3002 \u6bcf\u4e2asidecar\u90fd\u6709\u591a\u4e2a\u76d1\u542c\u5668\u751f\u6210\u3002 \u6bcf\u4e2asidecar\u90fd\u6709\u4e00\u4e2a\u76d1\u542c\u5668 \uff0c\u5b83\u88ab\u7ed1\u5b9a\u5230 0.0.0.0:15006 \u3002 \u8fd9\u662f IP Tables \u5c06\u6240\u6709\u5165\u7ad9\u6d41\u91cf\u53d1\u9001\u5230Pod\u7684\u5730\u5740\u3002\u7b2c\u4e8c\u4e2a\u76d1\u542c\u5668\u88ab\u7ed1\u5b9a\u5230 0.0.0.0:15001 \uff0c\u8fd9\u662f\u6240\u6709\u4ecePod\u4e2d\u51fa\u7ad9\u7684\u6d41\u91cf\u5730\u5740\u3002 \u5f53\u4e00\u4e2a\u8bf7\u6c42\u88ab\u91cd\u5b9a\u5411\uff08\u4f7f\u7528IP Tables\u914d\u7f6e\uff09\u523015001\u7aef\u53e3\u65f6\uff0c\u76d1\u542c\u5668\u4f1a\u628a\u5b83\u4ea4\u7ed9\u4e0e\u8bf7\u6c42\u7684\u539f\u59cb\u76ee\u7684\u5730\u6700\u5339\u914d\u7684\u865a\u62df\u76d1\u542c\u5668\u3002 \u5982\u679c\u5b83\u627e\u4e0d\u5230\u76ee\u7684\u5730\uff0c\u5b83\u5c31\u6839\u636e\u914d\u7f6e\u7684 OutboundTrafficPolicy \u6765\u53d1\u9001\u6d41\u91cf\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8bf7\u6c42\u88ab\u53d1\u9001\u5230 PassthroughCluster , \u8be5\u96c6\u7fa4\u8fde\u63a5\u5230\u5e94\u7528\u7a0b\u5e8f\u9009\u62e9\u7684\u76ee\u7684\u5730\uff0cEnvoy\u6ca1\u6709\u8fdb\u884c\u4efb\u4f55\u8d1f\u8f7d\u5747\u8861 \u3002 2\u3001Envoy\u5b9e\u4f8b \u8ba9\u6211\u4eec\u4ee5 Web \u524d\u7aef\u548c customers \u670d\u52a1\u4e3a\u4f8b\uff0c\u770b\u770b Envoy \u5982\u4f55\u786e\u5b9a\u5c06\u8bf7\u6c42\u4eceWeb\u524d\u7aef\u53d1\u9001\u5230 customers \u670d\u52a1\uff08 customers.default.svc.cluster.local \uff09\u7684\u4f4d\u7f6e\u3002 1gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' 2webfrontend.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-frontend --- apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: serviceAccountName: web-frontend containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 3customersv1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 3 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 kubectl apply -f *.yaml 2-1 istioctl proxy-config \u5217\u51fa\u76d1\u542c\u5668 \u4f7f\u7528 istioctl proxy-config \u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u5217\u51faweb\u524d\u7aefpod\u7684\u6240\u6709\u76d1\u542c\u5668\u3002 $ istioctl proxy-config listeners web-frontend-74dd5cbcdc-8mfpb ADDRESS PORT MATCH DESTINATION 10.96.0.10 53 ALL Cluster: outbound|53||kube-dns.kube-system.svc.cluster.local 0.0.0.0 80 Trans: raw_buffer; App: HTTP Route: 80 0.0.0.0 80 ALL PassthroughCluster 10.104.176.79 443 ALL Cluster: outbound|443||istio-egressgateway.istio-system.svc.cluster.local 10.105.159.70 443 ALL Cluster: outbound|443||istio-ingressgateway.istio-system.svc.cluster.local 10.96.0.1 443 ALL Cluster: outbound|443||kubernetes.default.svc.cluster.local 10.96.216.110 443 ALL Cluster: outbound|443||istiod.istio-system.svc.cluster.local 10.106.113.25 3000 Trans: raw_buffer; App: HTTP Route: grafana.istio-system.svc.cluster.local:3000 10.106.113.25 3000 ALL Cluster: outbound|3000||grafana.istio-system.svc.cluster.local 0.0.0.0 8383 Trans: raw_buffer; App: HTTP Route: 8383 0.0.0.0 8383 ALL PassthroughCluster 10.100.136.154 9000 Trans: raw_buffer; App: HTTP Route: minio.velero.svc.cluster.local:9000 10.100.136.154 9000 ALL Cluster: outbound|9000||minio.velero.svc.cluster.local 10.100.136.154 9001 Trans: raw_buffer; App: HTTP Route: minio.velero.svc.cluster.local:9001 10.100.136.154 9001 ALL Cluster: outbound|9001||minio.velero.svc.cluster.local 0.0.0.0 9090 Trans: raw_buffer; App: HTTP Route: 9090 0.0.0.0 9090 ALL PassthroughCluster 10.96.0.10 9153 Trans: raw_buffer; App: HTTP Route: kube-dns.kube-system.svc.cluster.local:9153 10.96.0.10 9153 ALL Cluster: outbound|9153||kube-dns.kube-system.svc.cluster.local 0.0.0.0 9411 Trans: raw_buffer; App: HTTP Route: 9411 0.0.0.0 9411 ALL PassthroughCluster 0.0.0.0 15001 ALL PassthroughCluster 0.0.0.0 15001 Addr: *:15001 Non-HTTP/Non-TCP 0.0.0.0 15006 Addr: *:15006 Non-HTTP/Non-TCP 0.0.0.0 15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: raw_buffer; App: HTTP; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: raw_buffer; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:8080 Cluster: inbound|8080|| 0.0.0.0 15006 Trans: raw_buffer; Addr: *:8080 Cluster: inbound|8080|| 0.0.0.0 15010 Trans: raw_buffer; App: HTTP Route: 15010 0.0.0.0 15010 ALL PassthroughCluster 10.96.216.110 15012 ALL Cluster: outbound|15012||istiod.istio-system.svc.cluster.local 0.0.0.0 15014 Trans: raw_buffer; App: HTTP Route: 15014 0.0.0.0 15014 ALL PassthroughCluster 0.0.0.0 15021 ALL Inline Route: /healthz/ready* 10.105.159.70 15021 Trans: raw_buffer; App: HTTP Route: istio-ingressgateway.istio-system.svc.cluster.local:15021 10.105.159.70 15021 ALL Cluster: outbound|15021||istio-ingressgateway.istio-system.svc.cluster.local 0.0.0.0 15090 ALL Inline Route: /stats/prometheus* 10.105.159.70 15443 ALL Cluster: outbound|15443||istio-ingressgateway.istio-system.svc.cluster.local 0.0.0.0 20001 Trans: raw_buffer; App: HTTP Route: 20001 0.0.0.0 20001 ALL PassthroughCluster 10.105.159.70 31400 ALL Cluster: outbound|31400||istio-ingressgateway.istio-system.svc.cluster.local \u4eceWeb\u524d\u7aef\u5230customers\u7684\u8bf7\u6c42\u662f\u4e00\u4e2a\u5411\u5916\u7684HTTP\u8bf7\u6c42\uff0c\u7aef\u53e3\u4e3a80\u3002 \u8fd9\u610f\u5473\u7740\u5b83\u88ab\u79fb\u4ea4\u7ed9\u4e86 0.0.0.0:80 \u7684\u865a\u62df\u76d1\u542c\u5668\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Istio CLI \u6309\u5730\u5740\u548c\u7aef\u53e3\u6765\u8fc7\u6ee4\u76d1\u542c\u5668\u3002 \u4f60\u53ef\u4ee5 \u6dfb\u52a0 -o json \u6765\u83b7\u5f97\u76d1\u542c\u5668\u7684JSON\u8868\u793a\uff1a $ istioctl proxy-config listeners web-frontend-74dd5cbcdc-8mfpb --address 0.0.0.0 --port 80 -o json ... \"statPrefix\": \"outbound_0.0.0.0_80\", \"rds\": { \"configSource\": { \"ads\": {}, \"initialFetchTimeout\": \"0s\", \"resourceApiVersion\": \"V3\" }, \"routeConfigName\": \"80\" }, ... Listener\u4f7f\u7528RDS\uff08\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff09\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f80)\u3002 \u8def\u7531\u9644\u5c5e\u4e8e\u76d1\u542c\u5668\uff0c\u5305\u542b\u5c06\u865a\u62df\u4e3b\u673a\u6620\u5c04\u5230\u96c6\u7fa4\u7684\u89c4\u5219\u3002\u8fd9\u5141\u8bb8\u6211\u4eec\u521b\u5efa\u6d41\u91cf\u8def\u7531\u89c4\u5219\uff0c\u56e0\u4e3aEnvoy\u53ef\u4ee5\u67e5\u770b\u5934\u6587\u4ef6\u6216\u8def\u5f84\uff08\u8bf7\u6c42\u5143\u6570\u636e\uff09\u5e76\u5bf9\u6d41\u91cf\u8fdb\u884c\u8def\u7531\u3002 \u8def\u7531\uff08route)\u9009\u62e9\u96c6\u7fa4\uff08cluster)\u3002\u96c6\u7fa4\u662f\u4e00\u7ec4\u63a5\u53d7\u6d41\u91cf\u7684\u7c7b\u4f3c\u7684\u4e0a\u6e38\u4e3b\u673a\u2014\u2014\u5b83\u662f\u4e00\u4e2a\u7aef\u70b9\u7684\u96c6\u5408\u3002\u4f8b\u5982\uff0cWeb\u524d\u7aef\u670d\u52a1\u7684\u6240\u6709\u5b9e\u4f8b\u7684\u96c6\u5408\u5c31\u662f\u4e00\u4e2a\u96c6\u7fa4\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u96c6\u7fa4\u5185\u914d\u7f6e\u5f39\u6027\u529f\u80fd\uff0c\u5982\u65ad\u8def\u5668\u3001\u79bb\u7fa4\u68c0\u6d4b\u548cTLS\u914d\u7f6e \u3002 \u4f7f\u7528routes\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u540d\u79f0\u8fc7\u6ee4\u6240\u6709\u7684\u8def\u7531\u6765\u83b7\u5f97\u8def\u7531\u7684\u8be6\u7ec6\u4fe1\u606f \u3002 $ istioctl proxy-config routes web-frontend-74dd5cbcdc-8mfpb --address 0.0.0.0 --port 80 -o json [ { \"name\": \"80\", \"virtualHosts\": [ { \"name\": \"allow_any\", \"domains\": [ \"*\" ], \"routes\": [ { \"name\": \"allow_any\", \"match\": { \"prefix\": \"/\" }, \"route\": { \"cluster\": \"PassthroughCluster\", \"timeout\": \"0s\", \"maxGrpcTimeout\": \"0s\" } } ], \"includeRequestAttemptCount\": true }, { \"name\": \"customers.default.svc.cluster.local:80\", \"domains\": [ \"customers.default.svc.cluster.local\", \"customers.default.svc.cluster.local:80\", \"customers\", \"customers:80\", \"customers.default.svc\", \"customers.default.svc:80\", \"customers.default\", \"customers.default:80\", \"10.109.29.3\", \"10.109.29.3:80\" ], \"routes\": [ { \"match\": { \"prefix\": \"/\" }, \"route\": { \"cluster\": \"outbound|80||customers.default.svc.cluster.local\", \"timeout\": \"0s\", \"retryPolicy\": { \"retryOn\": \"connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes\", \"numRetries\": 2, \"retryHostPredicate\": [ { \"name\": \"envoy.retry_host_predicates.previous_hosts\" } ], \"hostSelectionRetryMaxAttempts\": \"5\", \"retriableStatusCodes\": [ 503 ] }, \"maxGrpcTimeout\": \"0s\" }, ] ..... \u8def\u753180\u914d\u7f6e\u4e3a\u6bcf\u4e2a\u670d\u52a1\u90fd\u6709\u4e00\u4e2a\u865a\u62df\u4e3b\u673a\u3002 \u7136\u800c\uff0c\u7531\u4e8e\u6211\u4eec\u7684\u8bf7\u6c42\u88ab\u53d1\u9001\u5230 customers.default.svc.cluster.local , Envoy\u4f1a\u9009\u62e9\u4e0e\u5176\u4e2d\u4e00\u4e2a\u57df\u5339\u914d\u7684\u865a\u62df\u4e3b\u673a ( customers.default.svc.cluster.local:80 \uff09 \u3002 \u4e00\u65e6\u57df\u88ab\u5339\u914d\uff0c\u7279\u6b8a\u7684\u8def\u7531\u89c4\u5219 Envoy \u5c31\u4f1a\u67e5\u770b\u8def\u7531\uff0c\u5e76\u9009\u62e9\u7b2c\u4e00\u4e2a\u5339\u914d\u8bf7\u6c42\u7684\u8def\u7531\u3002\u7531\u4e8e\u6211\u4eec\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u5b83\u5339\u914d\u7b2c\u4e00\u4e2a\uff08\u4e5f\u662f\u552f\u4e00\u7684\uff09\u5b9a\u4e49\u7684\u8def\u7531\uff0c\u5e76\u6307\u793aEnvoy\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u540d\u4e3a\u7684\u96c6\u7fa4\u3002 outbound|80|v1|customers.default.svc.cluster.local \u7684\u96c6\u7fa4 \u6ce8\u610f\u96c6\u7fa4\u540d\u79f0\u4e2d\u7684v1\u662f\u56e0\u4e3a\u6211\u4eec\u90e8\u7f72\u4e86\u4e00\u4e2a DestinationRule \u6765\u521b\u5efa v1 \u5b50\u96c6\u3002\u5982\u679c\u4e00\u4e2a\u670d\u52a1\u6ca1\u6709\u5b50\u96c6\uff0c\u8fd9\u90e8\u5206\u5c31\u7559\u7a7a\uff1a outbound|80||customers.default.svc.cluster.local \u73b0\u5728\u6211\u4eec\u6709\u4e86\u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u66f4\u591a\u7684\u7ec6\u8282\u3002 \u4e3a\u4e86\u5f97\u5230\u4e00\u4e2a\u6e05\u695a\u663e\u793aFQDN\u3001\u7aef\u53e3\u3001\u5b50\u96c6\u548c\u5176\u4ed6\u4fe1\u606f\u7684\u8f93\u51fa\uff0c\u4f60\u53ef\u4ee5\u7701\u7565 -o json \u6807\u5fd7\u3002 $ istioctl proxy-config cluster web-frontend-74dd5cbcdc-8mfpb --fqdn customers.default.svc.cluster.loc al SERVICE FQDN PORT SUBSET DIRECTION TYPE DESTINATION RULE customers.default.svc.cluster.local 80 - outbound EDS \u6700\u540e\uff0c\u4f7f\u7528\u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u8bf7\u6c42\u6700\u7ec8\u5c06\u5230\u8fbe\u7684\u5b9e\u9645\u7aef\u70b9\uff1a $ istioctl proxy-config endpoints web-frontend-74dd5cbcdc-8mfpb --cluster \"outbound|80|v1|customers.default.svc.cluster.local\" ENDPOINT STATUS OUTLIER CHECK CLUSTER 10.1.1.152:3000 HEALTHY OK outbound|80||customers.default.svc.cluster.local \u7aef\u70b9\u5730\u5740\u7b49\u4e8ecustomers\u5e94\u7528\u7a0b\u5e8f\u6b63\u5728\u8fd0\u884c\u7684pod IP\u3002\u5982\u679c\u6211\u4eec\u6269\u5c55customers\u7684\u90e8\u7f72\u989d\u5916\u7684\u7aef\u70b9\u4f1a\u51fa\u73b0\u5728\u8f93\u51fa\u4e2d\uff0c\u50cf\u8fd9\u6837\uff1a $ kubectl get pod NAME READY STATUS RESTARTS AGE curl-6cd5b579fb-2xcx9 2/2 Running 3 9d customers-v1-7b5b4b76fc-dslg9 2/2 Running 0 24m customers-v1-7b5b4b76fc-rh8zb 2/2 Running 0 18s customers-v1-7b5b4b76fc-x7jb8 2/2 Running 0 18s web-frontend-74dd5cbcdc-8mfpb 2/2 Running 0 24m $ istioctl proxy-config endpoints web-frontend-74dd5cbcdc-8mfpb --cluster \"outbound|80||customers.defa ult.svc.cluster.local\" ENDPOINT STATUS OUTLIER CHECK CLUSTER 10.1.1.152:3000 HEALTHY OK outbound|80||customers.default.svc.cluster.local 10.1.1.153:3000 HEALTHY OK outbound|80||customers.default.svc.cluster.local 10.1.1.154:3000 HEALTHY OK outbound|80||customers.default.svc.cluster.local 3\u3001\u8c03\u8bd5\u5907\u5fd8\u5f55 \u6bcf\u5f53\u4f60\u9047\u5230\u914d\u7f6e\u95ee\u9898\u65f6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u8fd9\u7ec4\u6b65\u9aa4\u6765\u6d4f\u89c8\u548c\u89e3\u51b3\u95ee\u9898\u3002\u5728\u7b2c\u4e00\u90e8\u5206\uff0c\u6211\u4eec\u8981\u68c0\u67e5\u914d \u7f6e\u662f\u5426\u6709\u6548\u3002\u5982\u679c\u914d\u7f6e\u662f\u6709\u6548\u7684\uff0c\u4e0b\u4e00\u6b65\u5c31\u662f\u770b\u770b\u8fd0\u884c\u65f6\u662f\u5982\u4f55\u5904\u7406\u914d\u7f6e\u7684\uff0c\u4e3a\u6b64\uff0c\u4f60\u9700\u8981\u5bf9 Envoy\u914d\u7f6e\u6709\u57fa\u672c\u7684\u4e86\u89e3\u3002 Checklist for debugging Configuration validation Runtime validation 3-1 \u914d\u7f6e 1\uff0e\u914d\u7f6e\u662f\u5426\u6709\u6548\uff1f Istio CLI\u6709\u4e00\u4e2a\u53ebvalidate\u7684\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u9a8c\u8bc1.YAML\u914d\u7f6e\u3002YAML\u6700\u5e38\u89c1\u7684\u95ee\u9898\u662f\u7f29\u8fdb\u548c\u6570\u7ec4\u7b26\u53f7\u76f8\u5173\u7684\u95ee\u9898\u3002\u8981\u9a8c\u8bc1\u4e00\u4e2a\u914d\u7f6e\uff0c\u8bf7\u5c06YAML\u6587\u4ef6\u4f20\u9012\u7ed9validate\u547d\u4ee4\uff0c\u50cf\u8fd9\u6837\uff1a $ istioctl validate -f myresource.yaml validation succeed \u5982\u679c\u8d44\u6e90\u662f\u65e0\u6548\u7684\uff0cCLI\u4f1a\u7ed9\u6211\u4eec\u4e00\u4e2a\u8be6\u7ec6\u7684\u9519\u8bef\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u62fc\u9519\u4e86\u4e00\u4e2a\u5b57\u6bb5\u540d\uff1a unknown field \"worloadSelector\" in v1alpha3.ServiceEntry \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u53e6\u4e00\u4e2a\u547d\u4ee4 istioctl analyze \u3002 \u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u6d4bIstio\u914d\u7f6e\u7684\u6f5c \u5728\u95ee\u9898\u3002\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u672c\u5730\u7684\u4e00\u7ec4\u914d\u7f6e\u6587\u4ef6\u6216\u5b9e\u65f6\u96c6\u7fa4\u8fd0\u884c\u5b83\u3002\u540c\u65f6\uff0c\u5bfb\u627e\u6765\u81eaistiod\u7684\u4efb\u4f55\u8b66\u544a\u6216\u9519\u8bef\u3002 \u4e0b\u9762\u662f\u8be5\u547d\u4ee4\u7684\u4e00\u4e2a\u8f93\u51fa\u6837\u672c\uff0c\u5b83\u6355\u6349\u5230\u4e86\u76ee\u7684\u5730\u4e3b\u673a\u540d\u79f0\u4e2d\u7684\u4e00\u4e2a\u9519\u5b57\uff1a $ istioctl analyze Error [IST0101] (VirtualService customers.default) Referenced host not found: \"cusomers.default.svc.cluster.local\" Error [IST0101] (VirtualService customers.default) Referenced host+subset in destinationrule not found: \"cusomers.default.svc.cluster.local+v1\" Error: Analyzers found issues when analyzing namespace: default. See https://istio.io/docs/reference/config/analysis for more information about causes and resolutions. 2\uff0e\u547d\u540d\u662f\u5426\u6b63\u786e\uff1f\u8d44\u6e90\u662f\u5426\u5728\u6b63\u786e\u7684\u547d\u540d\u7a7a\u95f4 \uff1f Nearly all Istio resources are namespace scoped Selectors are also namespaced Common misconfiguration: Publishing VirtualService in default , binding to a gateway in istio-system Deploying Sidecar in istio-system , referencing VirtualService from application namespace \u51e0\u4e4e\u6240\u6709\u7684Istio\u8d44\u6e90\u90fd\u662f\u547d\u540d\u7a7a\u95f4\u8303\u56f4\u7684\u3002\u786e\u4fdd\u5b83\u4eec\u4e0e\u4f60\u6b63\u5728\u5904\u7406\u7684\u670d\u52a1\u5904\u4e8e\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u3002\u5c06Istio\u8d44\u6e90\u653e\u5728\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u5c24\u5176\u91cd\u8981\uff0c\u56e0\u4e3a\u9009\u62e9\u5668\u4e5f\u662f\u6709\u547d\u540d\u7a7a\u95f4\u7684\u3002 \u4e00\u4e2a\u5e38\u89c1\u7684\u9519\u8bef\u914d\u7f6e\u662f\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u53d1\u5e03VirtualService\uff08\u4f8b\u5982default)\uff0c\u7136\u540e\u4f7f\u7528 istio: ingressgateway \u9009\u62e9\u5668\u6765\u7ed1\u5b9a\u5230 istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u7684ingress\u7f51\u5173\u90e8\u7f72\u3002\u8fd9\u53ea\u6709\u5728\u4f60\u7684 VirtualService \u4e5f\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u65f6\u624d\u6709\u6548\u3002 \u540c\u6837\u5730\uff0c\u4e0d\u8981\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u5f15\u7528\u7528\u5e94\u7528\u7a0b\u5e8f\u547d\u540d\u7a7a\u95f4\u4e2d\u7684 VirtualService \u7684Sidecar\u8d44\u6e90\u3002\u76f8\u53cd\uff0c\u4e3a\u6bcf\u4e2a\u9700\u8981\u5165\u53e3\u7684\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u4e00\u7ec4Envoy\u7f51\u5173\u3002 3\uff0e\u8d44\u6e90\u9009\u62e9\u5668\u662f\u5426\u6b63\u786e\uff1f \u9a8c\u8bc1\u90e8\u7f72\u4e2d\u7684pod\u662f\u5426\u6709\u6b63\u786e\u7684\u6807\u7b7e\u8bbe\u7f6e\u3002\u6b63\u5982\u4e0a\u4e00\u6b65\u63d0\u5230\u7684\uff0c\u8d44\u6e90\u9009\u62e9\u5668\u4e0e\u8d44\u6e90\u53d1\u5e03\u7684\u547d\u540d \u7a7a\u95f4\u7ed1\u5b9a\u3002 \u5728\u8fd9\u4e00\u70b9\u4e0a\uff0c\u6211\u4eec\u5e94\u8be5\u6709\u7406\u7531\u76f8\u4fe1\uff0c\u914d\u7f6e\u662f\u6b63\u786e\u7684\u3002\u63a5\u4e0b\u6765\u7684\u6b65\u9aa4\u662f\u8fdb\u4e00\u6b65\u7814\u7a76\u8fd0\u884c\u65f6\u7cfb\u7edf\u662f \u5982\u4f55\u5904\u7406\u914d\u7f6e\u7684\u3002 3-2 \u8fd0\u884c\u65f6 Istio CLI \u7684\u4e00\u4e2a\u5b9e\u9a8c\u6027\u529f\u80fd\u53ef\u4ee5\u63d0\u4f9b\u4fe1\u606f\uff0c\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u5f71\u54cdPod\u6216\u670d\u52a1\u7684\u914d\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u9488\u5bf9Pod\u8fd0\u884cdescribe\u547d\u4ee4\u7684\u4f8b\u5b50\uff0c\u8fd9\u4e2aPod\u7684\u4e3b\u673a\u540d\u79f0\u4e2d\u6709\u4e00\u4e2a\u9519\u5b57\uff1a $ istioctl x describe pod customers-v1-64455cd4c6-xvjzm.default Pod: customers-v1-64455cd4c6-xvjzm Pod Ports: 3000 (svc), 15090 (istio-proxy) -------------------- Service: customers Port: http 80/HTTP targets pod port 3000 DestinationRule: customers for \"customers.default.svc.cluster.local\" Matching subsets: v1 No Traffic Policy VirtualService: customers WARNING: No destinations match pod subsets (checked 1 HTTP routes) Route to cusomers.default.svc.cluster.local \u00b7\u00b7\u00b7 $ istioctl x describe pod customers-v1-7b5b4b76fc-dslg9 Pod: customers-v1-7b5b4b76fc-dslg9 Pod Ports: 3000 (svc), 15090 (istio-proxy) -------------------- Service: customers Port: http 80/HTTP targets pod port 3000 VirtualService: customers 1 HTTP route(s) 1. Envoy\u662f\u5426\u63a5\u53d7\uff08ACK\uff09\u8be5\u914d\u7f6e\uff1f \u4f60\u53ef\u4ee5\u4f7f\u7528 istioctl proxy-status \u547d\u4ee4\u6765\u68c0\u67e5\u72b6\u6001\uff0c\u770b\u770bEnvoy\u662f\u5426\u63a5\u53d7\u914d\u7f6e\u3002\u6211\u4eec\u5e0c\u671b\u6240\u6709\u4e1c\u897f\u7684\u72b6\u6001\u90fd\u8bbe\u7f6e\u4e3aSYNCHED\u3002\u4efb\u4f55\u5176\u4ed6\u503c\u90fd\u53ef\u80fd\u8868\u660e\u6709\u9519\u8bef\uff0c\u4f60\u5e94\u8be5\u68c0\u67e5Pilot\u7684\u65e5\u65e5\u5fd7\u3002 $ istioctl proxy-status NAME CDS LDS EDS RDS ISTIOD VERSION curl-6cd5b579fb-2xcx9.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 customers-v1-7b5b4b76fc-dslg9.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 customers-v1-7b5b4b76fc-rh8zb.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 customers-v1-7b5b4b76fc-x7jb8.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 istio-egressgateway-5547fcc8fc-7kj9c.istio-system SYNCED SYNCED SYNCED NOT SENT istiod-6659979bdf-l7kgk 1.10.3 istio-ingressgateway-8f568d595-b2d6q.istio-system SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 web-frontend-74dd5cbcdc-8mfpb.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 \u5217\u8868\u663e\u793a\u6240\u6709\u8fde\u63a5\u5230 Pilot \u5b9e\u4f8b\u7684\u4ee3\u7406\u3002\u5982\u679c\u5217\u8868\u4e2d\u7f3a\u5c11\u4e00\u4e2a\u4ee3\u7406\uff0c\u8fd9\u610f\u6627\u7740\u5b83\u6ca1\u6709\u8fde\u63a5\u5230Pilot\uff0c\u4e5f\u6ca1\u6709\u6536\u5230\u4efb\u4f55\u914d\u7f6e\u3002\u5982\u679c\u4efb\u4f55\u4e00\u4e2a\u4ee3\u7406\u88ab\u6807\u8bb0\u4e3aSTALE\uff0c\u53ef\u80fd\u6709\u7f51\u7edc\u95ee\u9898\uff0c\u6216\u8005\u6211\u4eec \u9700\u8981\u6269\u5c55Pilot \u5982\u679cEnvoy\u63a5\u53d7\u4e86\u914d\u7f6e\uff0c\u4f46\u6211\u4eec\u4ecd\u7136\u770b\u5230\u95ee\u9898\uff0c\u6211\u4eec\u9700\u8981\u786e\u4fdd\u914d\u7f6e\u5728Envoy\u4e2d\u7684\u8868\u73b0\u7b26\u5408\u9884\u671f\u3002 2\uff0e\u914d\u7f6e\u5728Envoy\u4e2d\u7684\u8868\u73b0\u548c\u9884\u671f\u7684\u4e00\u6837\u5417\uff1f \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 proxy-config \u547d\u4ee4\u6765\u68c0\u7d22\u7279\u5b9a Envoy \u5b9e\u4f8b\u7684\u4fe1\u606f\u3002\u8bf7\u53c2\u8003\u4e0b\u9762\u7684\u8868\u683c\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u7d22\u4e0d\u540c\u7684\u4ee3\u7406\u914d\u7f6e\u3002 \u8be5\u547d\u4ee4\u4ece Envoy \u7684\u7ba1\u7406\u7aef\u70b9\uff08\u4e3b\u8981\u662f /config_dump \uff09\u6536\u96c6\u6570\u636e\uff0c\u5b83\u5305\u542b\u4e86\u5f88\u591a\u6709\u7528\u7684\u4fe1\u606f\u3002 \u53e6\u5916\uff0c\u8bf7\u53c2\u8003\u663e\u793aEnvoy\u548cIstio\u8d44\u6e90\u4e4b\u95f4\u6620\u5c04\u7684\u56fe\u3002\u4f8b\u5982\uff0c\u8bb8\u591a VirtualService \u89c4\u5219\u5c06\u8868\u73b0\u4e3a Envoy \u8def\u7531\uff0c\u800c DestinationRules \u548c ServiceEntries \u5219\u8868\u73b0\u4e3aCluster DestinationRules \u4e0d\u4f1a\u51fa\u73b0\u5728\u914d\u7f6e\u4e2d\uff0c\u9664\u975e\u5176\u4e3b\u673a\u7684 ServiceEntry \u9996\u5148\u5b58\u5728 \u3002 \u8ba9\u6211\u4eec\u4ee5\u5ba2\u6237\u7684 VirtualService \u4e3a\u4f8b\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 weight: 80 - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v2 weight: 20 timeout: 5s \u5982\u679c\u4f60\u8fd0\u884c istioctl proxy-config routes[POD\uff3d-o json \u547d\u4ee4\uff0c\u4f60\u4f1a\u770b\u5230\u52a0\u6743\u76ee\u7684\u5730\u548c\u8d85\u65f6\u662f\u5982\u4f55\u5728\u914d\u7f6e\u4e2d\u4f53\u73b0\u7684\uff1a .. { \"name\": \"80\", \"virtualHosts\": [ { \"name\": \"customers.default.svc.cluster.local:80\", \"domains\": [ \"customers.default.svc.cluster.local\", ... ], \"routes\": [ { \"match\": {\"prefix\": \"/\"}, \"route\": { \"weightedClusters\": { \"clusters\": [ { \"name\": \"outbound|80|v1|customers.default.svc.cluster.local\", \"weight\": 80 }, { \"name\": \"outbound|80|v2|customers.default.svc.cluster.local\", \"weight\": 20 } ] }, \"timeout\": \"5s\", ... \u5f53\u4f60\u8bc4\u4f30VirtualService\u65f6\uff0c\u4f60\u8981\u5bfb\u627e\u4e3b\u673a\u540d\u662f\u5426\u50cf\u4f60\u5199\u7684\u90a3\u6837\u51fa\u73b0\u5728Envoy\u914d\u7f6e\u4e2d\uff08\u4f8b\u5982 customers.default.svc.cluster.local )\uff0c\u4ee5\u53ca\u8def\u7531\u662f\u5426\u5b58\u5728(\u89c1\u8f93\u51fa\u4e2d\u768480-20\u6d41\u91cf\u5206\u5272\uff09\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e4b\u524d\u7684\u4f8b\u5b50\uff0c\u901a\u8fc7\u76d1\u542c\u5668\u3001\u8def\u7531\u548c\u96c6\u7fa4(\u548c\u7aef\u70b9\uff09\u6765\u8ffd\u8e2a\u8c03\u7528\u3002 Envoy\u8fc7\u6ee4\u5668\u4f1a\u8868\u73b0\u5728\u4f60\u544a\u8bc9Istio\u628a\u5b83\u4eec\u653e\u5728\u54ea\u91cc\uff08EnvoyFilter\u8d44\u6e90\u4e2d\u7684applyTo\u5b57\u6bb5\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u574f\u7684\u8fc7\u6ee4\u5668\u4f1a\u8868\u73b0\u4e3aEnvoy\u62d2\u7edd\u914d\u7f6e\uff08\u5373\u4e0d\u663e\u793aSYNCED\u72b6\u6001\uff09\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u9700\u8981\u68c0\u67e5Istiod\u65e5\u5fd7\u4e2d\u7684\u9519\u8bef 3. Istiod (Pilot\uff09\u4e2d\u662f\u5426\u6709\u9519\u8bef\uff1f \u4ecePilot\u67e5\u770b\u9519\u8bef\u7684\u6700\u5feb\u65b9\u6cd5\u662f\u8ddf\u8e2a\u65e5\u5fd7\uff08\u4f7f\u7528 --follow \u6807\u5fd7\uff09\uff0c\u7136\u540e\u5e94\u7528\u914d\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u6765\u81eaPilot\u7684\u9519\u8bef\u7684\u4f8b\u5b50\uff0c\u8fd9\u662f\u7531\u4e8e\u8fc7\u6ee4\u5668\u7684\u5185\u8054\u4ee3\u7801\u4e2d\u7684\u4e00\u4e2a\u9519\u5b57\u800c\u5bfc\u81f4\u7684\u3002 2020-11-20T21:49:16.017487Z warn ads ADS:LDS: ACK ERROR sidecar~10.120.1.8~web-frontend-58d497b6f8-lwqkg.default~default.svc.cluster.local-4 Internal:Error adding/updating listener (s) virtualInbound: script load error: [string\"fction envoy_on_response (response_handle)...\"]:1: '=' expected near 'envoy_on_response' \u5982\u679c\u914d\u7f6e\u6839\u672c\u6ca1\u6709\u51fa\u73b0\u5728Envoy\u4e2d\uff08Envoy\u6ca1\u6709ACK\u5b83\uff09\uff0c\u6216\u8005\u5b83\u662f\u4e00\u4e2aEnvoyFilter\u914d\u7f6e\uff0c\u90a3\u4e48\u8fd9\u4e2a\u914d\u7f6e\u5f88\u53ef\u80fd\u662f\u65e0\u6548\u7684\u3002Istio\u65e0\u6cd5\u4ece\u8bed\u6cd5\u4e0a\u9a8c\u8bc1EnvoyFilter\u5185\u90e8\u7684\u914d\u7f6e\u3002\u53e6\u4e00\u4e2a\u95ee\u9898\u53ef\u80fd\u662f\uff0c\u8fc7\u6ee4\u5668\u5728Envoy\u7684\u914d\u7f6e\u4e2d\u4f4d\u4e8e\u9519\u8bef\u7684\u4f4d\u7f6e\u3002 \u65e0\u8bba\u54ea\u79cd\u60c5\u51b5\uff0cEnvoy\u90fd\u4f1a\u62d2\u7edd\u8be5\u914d\u7f6e\uff0c\u56e0\u4e3a\u5b83\u662f\u65e0\u6548\u7684\uff0cPilot\u4f1a\u8bb0\u5f55\u8fd9\u4e2a\u9519\u8bef\u3002\u4e00\u822c\u6765 \u8bf4\uff0c\u4f60\u53ef\u4ee5\u641c\u7d22\u4f60\u7684\u8d44\u6e90\u7684\u540d\u79f0\u6765\u627e\u5230\u9519\u8bef\u3002 \u5728\u8fd9\u91cc\uff0c\u4f60\u5fc5\u987b\u4f7f\u7528\u5224\u65ad\u529b\u6765\u786e\u5b9a\u5b83\u662f\u4f60\u5199\u7684\u914d\u7f6e\u4e2d\u7684\u9519\u8bef\uff0c\u8fd8\u662fPilot\u7684\u9519\u8bef\u5bfc\u81f4\u5b83\u4ea7\u751f\u4e86 \u4e00\u4e2a\u65e0\u6548\u7684\u914d\u7f6e\u3002 3-3 \u68c0\u67e5Envoy\u65e5\u5fd7 \u8981\u68c0\u67e5Envoy\u4ee3\u7406\u7684\u65e5\u5fd7\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 kubectl logs \u547d\u4ee4\uff1a kubect1 logs PODNAME -c istio-proxy \u4e00n NAMESPACE \u8981\u4e86\u89e3\u8bbf\u95ee\u65e5\u5fd7\u7684\u683c\u5f0f\u548c\u54cd\u5e94\u6807\u5fd7\uff0c\u6211\u4eec\u53ef\u4ee5\u53c2\u8003Envoy\u8bbf\u95ee\u65e5\u5fd7\u7684\u5185\u5bb9 \u6700\u5e38\u89c1\u7684\u54cd\u5e94\u6807\u5fd7\u3002 NP\uff1a\u6ca1\u6709\u914d\u7f6e\u8def\u7531\uff0c\u68c0\u67e5DestinationRule\u6216VirtualService UO\uff1a\u4e0a\u6e38\u6ea2\u51fa\u5e76\u65ad\u8def\u3002\u68c0\u67e5DestinationRule\u4e2d\u7684\u65ad\u8def\u5668\u914d\u7f6e\u3002 UF:\u4e0a\u6e38\u8fde\u63a5\u5931\u8d25\uff0c\u5982\u679c\u4f7f\u7528Istio\u8ba4\u8bc1\uff0c\u68c0\u67e5mTLS\u914d\u7f6e\u3002 UH\uff1a\u6ca1\u6709\u5065\u5eb7\u7684\u4e0a\u6e38\u4e3b\u673a\u3002 3-4 \u914d\u7f6e istiod \u65e5\u5fd7 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528ControlZ\u4eea\u8868\u677f\uff0c\u901a\u8fc7 Logging Scopes \u83dc\u5355\u914d\u7f6e\u5806\u6808\u8ddf\u8e2a\u7ea7\u522b\u548c\u65e5\u5fd7\u7ea7\u522b\u3002 \u8981\u6253\u5f00\u4eea\u8868\u677f\uff0c\u8bf7\u8fd0\u884c\uff1a istioctl dashboard controlz $(kubectl -n istio-system get pods -l app=istiod -o jsonpath='{.items [0].metadata.name}').istio-system \u4eea\u8868\u677f\u6253\u5f00\u540e\uff0c\u70b9\u51fbLogging Scopes\u9009\u9879\uff0c\u8c03\u6574\u65e5\u5fd7\u7ea7\u522b\u548c\u5806\u6808\u8ddf\u8e2a\u7ea7\u522b\u3002 4\u3001\u95ee\u9898\u68c0\u6d4b\u68c0\u6d4b 1\u3001\u5982\u679c\u865a\u62df\u76d1\u542c\u5668\u627e\u4e0d\u5230\u8bf7\u6c42\u7684\u76ee\u7684\u5730\u4f1a\u600e\u6837\uff1f A \u629b\u5f03\u8be5\u8bf7\u6c42 B \u8df3\u8f6c\u5230\u7b2c\u4e8c\u63a5\u8fd1\u7684\u8bf7\u6c42 C \u6839\u636eOutboundTrafficPolicy\u53d1\u9001\u6d41\u91cf D \u6839\u636e\u865a\u62df\u670d\u52a1\u7684\u8981\u6c42\u53d1\u9001\u6d41\u91cf \u5f53\u4e00\u4e2a\u8bf7\u6c42\u88ab\u91cd\u5b9a\u5411\uff08\u4f7f\u7528IP Tables\u914d\u7f6e\uff09\u523015001\u7aef\u53e3\u65f6\uff0c\u76d1\u542c\u5668\u4f1a\u628a\u5b83\u4ea4\u7ed9\u4e0e\u8bf7\u6c42\u7684\u539f\u59cb\u76ee\u7684\u5730\u6700\u5339\u914d\u7684\u865a\u62df\u76d1\u542c\u5668\u3002** \u5982\u679c\u5b83\u627e\u4e0d\u5230\u76ee\u7684\u5730\uff0c\u5b83\u5c31\u6839\u636e\u914d\u7f6e\u7684 OutboundTrafficPolicy \u6765\u53d1\u9001\u6d41\u91cf\u3002 2\u3001\u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e2aIstio CLI\u547d\u4ee4\u6765\u5217\u51fa\u6240\u6709\u76d1\u542c\u5668\uff1f A istiocti get listeners B istiocti proxy-config listeners C istiocti describe listeners D istioctl config listeners istioctl proxy-config \u5217\u51fa\u76d1\u542c\u5668 3\u3001\u76d1\u542c\u5668\u4f7f\u7528\u54ea\u4e2a\u670d\u52a1\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e\uff1f A SDS B RDS(route discovery service) C Listener service D Envoy service Listener\u4f7f\u7528RDS\uff08\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff09\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f80) 4\u3001Envoy\u7684\u57fa\u672c\u6982\u5ff5\u662f\u4ec0\u4e48\uff1f A listener\u3001route\u3001cluster\u548cendpoint B request\u3001response\u548cendpoint C request\u3001header\u548ccookies D header\u3001cluster\u548croute 5\u3001Envoy\u4e3a\u6bcf\u4e2asidecar\u751f\u6210\u4e00\u4e2a\u76d1\u542c\u5668\u3002\uff08\u5bf9/\u9519\uff09 A True B False \u6bcf\u4e2asidecar\u90fd\u6709\u591a\u4e2a\u76d1\u542c\u5668\u751f\u6210\u3002 \u6bcf\u4e2asidecar\u90fd\u6709\u4e00\u4e2a\u76d1\u542c\u5668 \uff0c\u5b83\u88ab\u7ed1\u5b9a\u5230 0.0.0.0:15006 \u3002 6\u3001Where are the circuit breakers defined? A In virtual listeners B In endpoint configuration C In clusters configuration D In routes configuration 7\u3001\u4ec0\u4e48\u7c7b\u578b\u7684\u6d41\u91cf\u4f1a\u88ab\u8def\u7531\u523015006\u7aef\u53e3\uff1f A \u5165\u7ad9Pod\u6d41\u91cf B \u51fa\u7ad9Pod \u6d41\u91cf C \u6240\u6709\u6d41\u91cf D \u6ca1\u6709\u6d41\u91cf","title":"\u7b2c\u516b\u8282 Istio \u95ee\u9898\u6392\u67e5"},{"location":"chap8/8Istio_trouble_shoot/#istio","text":"","title":"\u7b2c\u516b\u8282 Istio \u95ee\u9898\u6392\u67e5"},{"location":"chap8/8Istio_trouble_shoot/#1envoy","text":"\u4e3a\u4e86\u6392\u9664Istio\u7684\u95ee\u9898\uff0c\u5bf9Envoy\u7684\u5de5\u4f5c\u539f\u7406\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u4e86\u89e3\u662f\u5f88\u6709\u5e2e\u52a9\u7684\u3002Envoy\u914d\u7f6e\u662f \u4e00\u4e2aJSON\u6587\u4ef6\uff0c\u5206\u4e3a\u591a\u4e2a\u90e8\u5206\u3002\u6211\u4eec\u9700\u8981\u4e86\u89e3Envoy\u7684\u57fa\u672c\u6982\u5ff5\u662f\u76d1\u542c\u5668\u3001\u8def\u7531\u3001\u96c6\u7fa4\u548c\u7aef\u70b9\u3002 \u8fd9\u4e9b\u6982\u5ff5\u6620\u5c04\u5230istio\u548cKubernetes\u8d44\u6e90\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002","title":"1\u3001Envoy\u57fa\u7840"},{"location":"chap8/8Istio_trouble_shoot/#basics-of-envoy","text":"JSON configuration Basic concepts: Listeners Routes Cluster Endpoints Multiple listeners for each sidecar Inbound: 0.0.0.0:15006 Outbound: 0.0.0.0:15001 Listeners hands off requests off to a virtual listener Default: PassthroughCluster \u76d1\u542c\u5668\u662f\u547d\u540d\u7684\u7f51\u7edc\u4f4d\u7f6e\uff0c\u901a\u5e38\u662f\u4e00\u4e2aIP\u548c\u7aef\u53e3\u3002Envoy\u5bf9\u8fd9\u4e9b\u4f4d\u7f6e\u8fdb\u884c\u76d1\u542c\uff0c\u8fd9\u662f\u5b83\u63a5\u6536\u548c\u8fde\u63a5\u548c\u8bf7\u6c42\u7684\u5730\u65b9\u3002 \u6bcf\u4e2asidecar\u90fd\u6709\u591a\u4e2a\u76d1\u542c\u5668\u751f\u6210\u3002 \u6bcf\u4e2asidecar\u90fd\u6709\u4e00\u4e2a\u76d1\u542c\u5668 \uff0c\u5b83\u88ab\u7ed1\u5b9a\u5230 0.0.0.0:15006 \u3002 \u8fd9\u662f IP Tables \u5c06\u6240\u6709\u5165\u7ad9\u6d41\u91cf\u53d1\u9001\u5230Pod\u7684\u5730\u5740\u3002\u7b2c\u4e8c\u4e2a\u76d1\u542c\u5668\u88ab\u7ed1\u5b9a\u5230 0.0.0.0:15001 \uff0c\u8fd9\u662f\u6240\u6709\u4ecePod\u4e2d\u51fa\u7ad9\u7684\u6d41\u91cf\u5730\u5740\u3002 \u5f53\u4e00\u4e2a\u8bf7\u6c42\u88ab\u91cd\u5b9a\u5411\uff08\u4f7f\u7528IP Tables\u914d\u7f6e\uff09\u523015001\u7aef\u53e3\u65f6\uff0c\u76d1\u542c\u5668\u4f1a\u628a\u5b83\u4ea4\u7ed9\u4e0e\u8bf7\u6c42\u7684\u539f\u59cb\u76ee\u7684\u5730\u6700\u5339\u914d\u7684\u865a\u62df\u76d1\u542c\u5668\u3002 \u5982\u679c\u5b83\u627e\u4e0d\u5230\u76ee\u7684\u5730\uff0c\u5b83\u5c31\u6839\u636e\u914d\u7f6e\u7684 OutboundTrafficPolicy \u6765\u53d1\u9001\u6d41\u91cf\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8bf7\u6c42\u88ab\u53d1\u9001\u5230 PassthroughCluster , \u8be5\u96c6\u7fa4\u8fde\u63a5\u5230\u5e94\u7528\u7a0b\u5e8f\u9009\u62e9\u7684\u76ee\u7684\u5730\uff0cEnvoy\u6ca1\u6709\u8fdb\u884c\u4efb\u4f55\u8d1f\u8f7d\u5747\u8861 \u3002","title":"Basics of Envoy"},{"location":"chap8/8Istio_trouble_shoot/#2envoy","text":"\u8ba9\u6211\u4eec\u4ee5 Web \u524d\u7aef\u548c customers \u670d\u52a1\u4e3a\u4f8b\uff0c\u770b\u770b Envoy \u5982\u4f55\u786e\u5b9a\u5c06\u8bf7\u6c42\u4eceWeb\u524d\u7aef\u53d1\u9001\u5230 customers \u670d\u52a1\uff08 customers.default.svc.cluster.local \uff09\u7684\u4f4d\u7f6e\u3002 1gateway.yaml apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - '*' 2webfrontend.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-frontend --- apiVersion: apps/v1 kind: Deployment metadata: name: web-frontend labels: app: web-frontend spec: replicas: 1 selector: matchLabels: app: web-frontend template: metadata: labels: app: web-frontend version: v1 spec: serviceAccountName: web-frontend containers: - image: gcr.io/tetratelabs/web-frontend:1.0.0 imagePullPolicy: Always name: web ports: - containerPort: 8080 env: - name: CUSTOMER_SERVICE_URL value: 'http://customers.default.svc.cluster.local' --- kind: Service apiVersion: v1 metadata: name: web-frontend labels: app: web-frontend spec: selector: app: web-frontend ports: - port: 80 name: http targetPort: 8080 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: web-frontend spec: hosts: - '*' gateways: - gateway http: - route: - destination: host: web-frontend.default.svc.cluster.local port: number: 80 3customersv1.yaml apiVersion: apps/v1 kind: Deployment metadata: name: customers-v1 labels: app: customers version: v1 spec: replicas: 3 selector: matchLabels: app: customers version: v1 template: metadata: labels: app: customers version: v1 spec: containers: - image: gcr.io/tetratelabs/customers:1.0.0 imagePullPolicy: Always name: svc ports: - containerPort: 3000 --- kind: Service apiVersion: v1 metadata: name: customers labels: app: customers spec: selector: app: customers ports: - port: 80 name: http targetPort: 3000 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 kubectl apply -f *.yaml","title":"2\u3001Envoy\u5b9e\u4f8b"},{"location":"chap8/8Istio_trouble_shoot/#2-1-istioctl-proxy-config","text":"\u4f7f\u7528 istioctl proxy-config \u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u5217\u51faweb\u524d\u7aefpod\u7684\u6240\u6709\u76d1\u542c\u5668\u3002 $ istioctl proxy-config listeners web-frontend-74dd5cbcdc-8mfpb ADDRESS PORT MATCH DESTINATION 10.96.0.10 53 ALL Cluster: outbound|53||kube-dns.kube-system.svc.cluster.local 0.0.0.0 80 Trans: raw_buffer; App: HTTP Route: 80 0.0.0.0 80 ALL PassthroughCluster 10.104.176.79 443 ALL Cluster: outbound|443||istio-egressgateway.istio-system.svc.cluster.local 10.105.159.70 443 ALL Cluster: outbound|443||istio-ingressgateway.istio-system.svc.cluster.local 10.96.0.1 443 ALL Cluster: outbound|443||kubernetes.default.svc.cluster.local 10.96.216.110 443 ALL Cluster: outbound|443||istiod.istio-system.svc.cluster.local 10.106.113.25 3000 Trans: raw_buffer; App: HTTP Route: grafana.istio-system.svc.cluster.local:3000 10.106.113.25 3000 ALL Cluster: outbound|3000||grafana.istio-system.svc.cluster.local 0.0.0.0 8383 Trans: raw_buffer; App: HTTP Route: 8383 0.0.0.0 8383 ALL PassthroughCluster 10.100.136.154 9000 Trans: raw_buffer; App: HTTP Route: minio.velero.svc.cluster.local:9000 10.100.136.154 9000 ALL Cluster: outbound|9000||minio.velero.svc.cluster.local 10.100.136.154 9001 Trans: raw_buffer; App: HTTP Route: minio.velero.svc.cluster.local:9001 10.100.136.154 9001 ALL Cluster: outbound|9001||minio.velero.svc.cluster.local 0.0.0.0 9090 Trans: raw_buffer; App: HTTP Route: 9090 0.0.0.0 9090 ALL PassthroughCluster 10.96.0.10 9153 Trans: raw_buffer; App: HTTP Route: kube-dns.kube-system.svc.cluster.local:9153 10.96.0.10 9153 ALL Cluster: outbound|9153||kube-dns.kube-system.svc.cluster.local 0.0.0.0 9411 Trans: raw_buffer; App: HTTP Route: 9411 0.0.0.0 9411 ALL PassthroughCluster 0.0.0.0 15001 ALL PassthroughCluster 0.0.0.0 15001 Addr: *:15001 Non-HTTP/Non-TCP 0.0.0.0 15006 Addr: *:15006 Non-HTTP/Non-TCP 0.0.0.0 15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: raw_buffer; App: HTTP; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: raw_buffer; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:8080 Cluster: inbound|8080|| 0.0.0.0 15006 Trans: raw_buffer; Addr: *:8080 Cluster: inbound|8080|| 0.0.0.0 15010 Trans: raw_buffer; App: HTTP Route: 15010 0.0.0.0 15010 ALL PassthroughCluster 10.96.216.110 15012 ALL Cluster: outbound|15012||istiod.istio-system.svc.cluster.local 0.0.0.0 15014 Trans: raw_buffer; App: HTTP Route: 15014 0.0.0.0 15014 ALL PassthroughCluster 0.0.0.0 15021 ALL Inline Route: /healthz/ready* 10.105.159.70 15021 Trans: raw_buffer; App: HTTP Route: istio-ingressgateway.istio-system.svc.cluster.local:15021 10.105.159.70 15021 ALL Cluster: outbound|15021||istio-ingressgateway.istio-system.svc.cluster.local 0.0.0.0 15090 ALL Inline Route: /stats/prometheus* 10.105.159.70 15443 ALL Cluster: outbound|15443||istio-ingressgateway.istio-system.svc.cluster.local 0.0.0.0 20001 Trans: raw_buffer; App: HTTP Route: 20001 0.0.0.0 20001 ALL PassthroughCluster 10.105.159.70 31400 ALL Cluster: outbound|31400||istio-ingressgateway.istio-system.svc.cluster.local \u4eceWeb\u524d\u7aef\u5230customers\u7684\u8bf7\u6c42\u662f\u4e00\u4e2a\u5411\u5916\u7684HTTP\u8bf7\u6c42\uff0c\u7aef\u53e3\u4e3a80\u3002 \u8fd9\u610f\u5473\u7740\u5b83\u88ab\u79fb\u4ea4\u7ed9\u4e86 0.0.0.0:80 \u7684\u865a\u62df\u76d1\u542c\u5668\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Istio CLI \u6309\u5730\u5740\u548c\u7aef\u53e3\u6765\u8fc7\u6ee4\u76d1\u542c\u5668\u3002 \u4f60\u53ef\u4ee5 \u6dfb\u52a0 -o json \u6765\u83b7\u5f97\u76d1\u542c\u5668\u7684JSON\u8868\u793a\uff1a $ istioctl proxy-config listeners web-frontend-74dd5cbcdc-8mfpb --address 0.0.0.0 --port 80 -o json ... \"statPrefix\": \"outbound_0.0.0.0_80\", \"rds\": { \"configSource\": { \"ads\": {}, \"initialFetchTimeout\": \"0s\", \"resourceApiVersion\": \"V3\" }, \"routeConfigName\": \"80\" }, ... Listener\u4f7f\u7528RDS\uff08\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff09\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f80)\u3002 \u8def\u7531\u9644\u5c5e\u4e8e\u76d1\u542c\u5668\uff0c\u5305\u542b\u5c06\u865a\u62df\u4e3b\u673a\u6620\u5c04\u5230\u96c6\u7fa4\u7684\u89c4\u5219\u3002\u8fd9\u5141\u8bb8\u6211\u4eec\u521b\u5efa\u6d41\u91cf\u8def\u7531\u89c4\u5219\uff0c\u56e0\u4e3aEnvoy\u53ef\u4ee5\u67e5\u770b\u5934\u6587\u4ef6\u6216\u8def\u5f84\uff08\u8bf7\u6c42\u5143\u6570\u636e\uff09\u5e76\u5bf9\u6d41\u91cf\u8fdb\u884c\u8def\u7531\u3002 \u8def\u7531\uff08route)\u9009\u62e9\u96c6\u7fa4\uff08cluster)\u3002\u96c6\u7fa4\u662f\u4e00\u7ec4\u63a5\u53d7\u6d41\u91cf\u7684\u7c7b\u4f3c\u7684\u4e0a\u6e38\u4e3b\u673a\u2014\u2014\u5b83\u662f\u4e00\u4e2a\u7aef\u70b9\u7684\u96c6\u5408\u3002\u4f8b\u5982\uff0cWeb\u524d\u7aef\u670d\u52a1\u7684\u6240\u6709\u5b9e\u4f8b\u7684\u96c6\u5408\u5c31\u662f\u4e00\u4e2a\u96c6\u7fa4\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u96c6\u7fa4\u5185\u914d\u7f6e\u5f39\u6027\u529f\u80fd\uff0c\u5982\u65ad\u8def\u5668\u3001\u79bb\u7fa4\u68c0\u6d4b\u548cTLS\u914d\u7f6e \u3002 \u4f7f\u7528routes\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u540d\u79f0\u8fc7\u6ee4\u6240\u6709\u7684\u8def\u7531\u6765\u83b7\u5f97\u8def\u7531\u7684\u8be6\u7ec6\u4fe1\u606f \u3002 $ istioctl proxy-config routes web-frontend-74dd5cbcdc-8mfpb --address 0.0.0.0 --port 80 -o json [ { \"name\": \"80\", \"virtualHosts\": [ { \"name\": \"allow_any\", \"domains\": [ \"*\" ], \"routes\": [ { \"name\": \"allow_any\", \"match\": { \"prefix\": \"/\" }, \"route\": { \"cluster\": \"PassthroughCluster\", \"timeout\": \"0s\", \"maxGrpcTimeout\": \"0s\" } } ], \"includeRequestAttemptCount\": true }, { \"name\": \"customers.default.svc.cluster.local:80\", \"domains\": [ \"customers.default.svc.cluster.local\", \"customers.default.svc.cluster.local:80\", \"customers\", \"customers:80\", \"customers.default.svc\", \"customers.default.svc:80\", \"customers.default\", \"customers.default:80\", \"10.109.29.3\", \"10.109.29.3:80\" ], \"routes\": [ { \"match\": { \"prefix\": \"/\" }, \"route\": { \"cluster\": \"outbound|80||customers.default.svc.cluster.local\", \"timeout\": \"0s\", \"retryPolicy\": { \"retryOn\": \"connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes\", \"numRetries\": 2, \"retryHostPredicate\": [ { \"name\": \"envoy.retry_host_predicates.previous_hosts\" } ], \"hostSelectionRetryMaxAttempts\": \"5\", \"retriableStatusCodes\": [ 503 ] }, \"maxGrpcTimeout\": \"0s\" }, ] ..... \u8def\u753180\u914d\u7f6e\u4e3a\u6bcf\u4e2a\u670d\u52a1\u90fd\u6709\u4e00\u4e2a\u865a\u62df\u4e3b\u673a\u3002 \u7136\u800c\uff0c\u7531\u4e8e\u6211\u4eec\u7684\u8bf7\u6c42\u88ab\u53d1\u9001\u5230 customers.default.svc.cluster.local , Envoy\u4f1a\u9009\u62e9\u4e0e\u5176\u4e2d\u4e00\u4e2a\u57df\u5339\u914d\u7684\u865a\u62df\u4e3b\u673a ( customers.default.svc.cluster.local:80 \uff09 \u3002 \u4e00\u65e6\u57df\u88ab\u5339\u914d\uff0c\u7279\u6b8a\u7684\u8def\u7531\u89c4\u5219 Envoy \u5c31\u4f1a\u67e5\u770b\u8def\u7531\uff0c\u5e76\u9009\u62e9\u7b2c\u4e00\u4e2a\u5339\u914d\u8bf7\u6c42\u7684\u8def\u7531\u3002\u7531\u4e8e\u6211\u4eec\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u5b83\u5339\u914d\u7b2c\u4e00\u4e2a\uff08\u4e5f\u662f\u552f\u4e00\u7684\uff09\u5b9a\u4e49\u7684\u8def\u7531\uff0c\u5e76\u6307\u793aEnvoy\u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u540d\u4e3a\u7684\u96c6\u7fa4\u3002 outbound|80|v1|customers.default.svc.cluster.local \u7684\u96c6\u7fa4 \u6ce8\u610f\u96c6\u7fa4\u540d\u79f0\u4e2d\u7684v1\u662f\u56e0\u4e3a\u6211\u4eec\u90e8\u7f72\u4e86\u4e00\u4e2a DestinationRule \u6765\u521b\u5efa v1 \u5b50\u96c6\u3002\u5982\u679c\u4e00\u4e2a\u670d\u52a1\u6ca1\u6709\u5b50\u96c6\uff0c\u8fd9\u90e8\u5206\u5c31\u7559\u7a7a\uff1a outbound|80||customers.default.svc.cluster.local \u73b0\u5728\u6211\u4eec\u6709\u4e86\u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u66f4\u591a\u7684\u7ec6\u8282\u3002 \u4e3a\u4e86\u5f97\u5230\u4e00\u4e2a\u6e05\u695a\u663e\u793aFQDN\u3001\u7aef\u53e3\u3001\u5b50\u96c6\u548c\u5176\u4ed6\u4fe1\u606f\u7684\u8f93\u51fa\uff0c\u4f60\u53ef\u4ee5\u7701\u7565 -o json \u6807\u5fd7\u3002 $ istioctl proxy-config cluster web-frontend-74dd5cbcdc-8mfpb --fqdn customers.default.svc.cluster.loc al SERVICE FQDN PORT SUBSET DIRECTION TYPE DESTINATION RULE customers.default.svc.cluster.local 80 - outbound EDS \u6700\u540e\uff0c\u4f7f\u7528\u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u8bf7\u6c42\u6700\u7ec8\u5c06\u5230\u8fbe\u7684\u5b9e\u9645\u7aef\u70b9\uff1a $ istioctl proxy-config endpoints web-frontend-74dd5cbcdc-8mfpb --cluster \"outbound|80|v1|customers.default.svc.cluster.local\" ENDPOINT STATUS OUTLIER CHECK CLUSTER 10.1.1.152:3000 HEALTHY OK outbound|80||customers.default.svc.cluster.local \u7aef\u70b9\u5730\u5740\u7b49\u4e8ecustomers\u5e94\u7528\u7a0b\u5e8f\u6b63\u5728\u8fd0\u884c\u7684pod IP\u3002\u5982\u679c\u6211\u4eec\u6269\u5c55customers\u7684\u90e8\u7f72\u989d\u5916\u7684\u7aef\u70b9\u4f1a\u51fa\u73b0\u5728\u8f93\u51fa\u4e2d\uff0c\u50cf\u8fd9\u6837\uff1a $ kubectl get pod NAME READY STATUS RESTARTS AGE curl-6cd5b579fb-2xcx9 2/2 Running 3 9d customers-v1-7b5b4b76fc-dslg9 2/2 Running 0 24m customers-v1-7b5b4b76fc-rh8zb 2/2 Running 0 18s customers-v1-7b5b4b76fc-x7jb8 2/2 Running 0 18s web-frontend-74dd5cbcdc-8mfpb 2/2 Running 0 24m $ istioctl proxy-config endpoints web-frontend-74dd5cbcdc-8mfpb --cluster \"outbound|80||customers.defa ult.svc.cluster.local\" ENDPOINT STATUS OUTLIER CHECK CLUSTER 10.1.1.152:3000 HEALTHY OK outbound|80||customers.default.svc.cluster.local 10.1.1.153:3000 HEALTHY OK outbound|80||customers.default.svc.cluster.local 10.1.1.154:3000 HEALTHY OK outbound|80||customers.default.svc.cluster.local","title":"2-1 istioctl proxy-config\u5217\u51fa\u76d1\u542c\u5668"},{"location":"chap8/8Istio_trouble_shoot/#3","text":"\u6bcf\u5f53\u4f60\u9047\u5230\u914d\u7f6e\u95ee\u9898\u65f6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u8fd9\u7ec4\u6b65\u9aa4\u6765\u6d4f\u89c8\u548c\u89e3\u51b3\u95ee\u9898\u3002\u5728\u7b2c\u4e00\u90e8\u5206\uff0c\u6211\u4eec\u8981\u68c0\u67e5\u914d \u7f6e\u662f\u5426\u6709\u6548\u3002\u5982\u679c\u914d\u7f6e\u662f\u6709\u6548\u7684\uff0c\u4e0b\u4e00\u6b65\u5c31\u662f\u770b\u770b\u8fd0\u884c\u65f6\u662f\u5982\u4f55\u5904\u7406\u914d\u7f6e\u7684\uff0c\u4e3a\u6b64\uff0c\u4f60\u9700\u8981\u5bf9 Envoy\u914d\u7f6e\u6709\u57fa\u672c\u7684\u4e86\u89e3\u3002 Checklist for debugging Configuration validation Runtime validation","title":"3\u3001\u8c03\u8bd5\u5907\u5fd8\u5f55"},{"location":"chap8/8Istio_trouble_shoot/#3-1","text":"1\uff0e\u914d\u7f6e\u662f\u5426\u6709\u6548\uff1f Istio CLI\u6709\u4e00\u4e2a\u53ebvalidate\u7684\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u9a8c\u8bc1.YAML\u914d\u7f6e\u3002YAML\u6700\u5e38\u89c1\u7684\u95ee\u9898\u662f\u7f29\u8fdb\u548c\u6570\u7ec4\u7b26\u53f7\u76f8\u5173\u7684\u95ee\u9898\u3002\u8981\u9a8c\u8bc1\u4e00\u4e2a\u914d\u7f6e\uff0c\u8bf7\u5c06YAML\u6587\u4ef6\u4f20\u9012\u7ed9validate\u547d\u4ee4\uff0c\u50cf\u8fd9\u6837\uff1a $ istioctl validate -f myresource.yaml validation succeed \u5982\u679c\u8d44\u6e90\u662f\u65e0\u6548\u7684\uff0cCLI\u4f1a\u7ed9\u6211\u4eec\u4e00\u4e2a\u8be6\u7ec6\u7684\u9519\u8bef\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u62fc\u9519\u4e86\u4e00\u4e2a\u5b57\u6bb5\u540d\uff1a unknown field \"worloadSelector\" in v1alpha3.ServiceEntry \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u53e6\u4e00\u4e2a\u547d\u4ee4 istioctl analyze \u3002 \u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u6d4bIstio\u914d\u7f6e\u7684\u6f5c \u5728\u95ee\u9898\u3002\u6211\u4eec\u53ef\u4ee5\u9488\u5bf9\u672c\u5730\u7684\u4e00\u7ec4\u914d\u7f6e\u6587\u4ef6\u6216\u5b9e\u65f6\u96c6\u7fa4\u8fd0\u884c\u5b83\u3002\u540c\u65f6\uff0c\u5bfb\u627e\u6765\u81eaistiod\u7684\u4efb\u4f55\u8b66\u544a\u6216\u9519\u8bef\u3002 \u4e0b\u9762\u662f\u8be5\u547d\u4ee4\u7684\u4e00\u4e2a\u8f93\u51fa\u6837\u672c\uff0c\u5b83\u6355\u6349\u5230\u4e86\u76ee\u7684\u5730\u4e3b\u673a\u540d\u79f0\u4e2d\u7684\u4e00\u4e2a\u9519\u5b57\uff1a $ istioctl analyze Error [IST0101] (VirtualService customers.default) Referenced host not found: \"cusomers.default.svc.cluster.local\" Error [IST0101] (VirtualService customers.default) Referenced host+subset in destinationrule not found: \"cusomers.default.svc.cluster.local+v1\" Error: Analyzers found issues when analyzing namespace: default. See https://istio.io/docs/reference/config/analysis for more information about causes and resolutions. 2\uff0e\u547d\u540d\u662f\u5426\u6b63\u786e\uff1f\u8d44\u6e90\u662f\u5426\u5728\u6b63\u786e\u7684\u547d\u540d\u7a7a\u95f4 \uff1f Nearly all Istio resources are namespace scoped Selectors are also namespaced Common misconfiguration: Publishing VirtualService in default , binding to a gateway in istio-system Deploying Sidecar in istio-system , referencing VirtualService from application namespace \u51e0\u4e4e\u6240\u6709\u7684Istio\u8d44\u6e90\u90fd\u662f\u547d\u540d\u7a7a\u95f4\u8303\u56f4\u7684\u3002\u786e\u4fdd\u5b83\u4eec\u4e0e\u4f60\u6b63\u5728\u5904\u7406\u7684\u670d\u52a1\u5904\u4e8e\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u3002\u5c06Istio\u8d44\u6e90\u653e\u5728\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u5c24\u5176\u91cd\u8981\uff0c\u56e0\u4e3a\u9009\u62e9\u5668\u4e5f\u662f\u6709\u547d\u540d\u7a7a\u95f4\u7684\u3002 \u4e00\u4e2a\u5e38\u89c1\u7684\u9519\u8bef\u914d\u7f6e\u662f\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u53d1\u5e03VirtualService\uff08\u4f8b\u5982default)\uff0c\u7136\u540e\u4f7f\u7528 istio: ingressgateway \u9009\u62e9\u5668\u6765\u7ed1\u5b9a\u5230 istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u7684ingress\u7f51\u5173\u90e8\u7f72\u3002\u8fd9\u53ea\u6709\u5728\u4f60\u7684 VirtualService \u4e5f\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u65f6\u624d\u6709\u6548\u3002 \u540c\u6837\u5730\uff0c\u4e0d\u8981\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u5f15\u7528\u7528\u5e94\u7528\u7a0b\u5e8f\u547d\u540d\u7a7a\u95f4\u4e2d\u7684 VirtualService \u7684Sidecar\u8d44\u6e90\u3002\u76f8\u53cd\uff0c\u4e3a\u6bcf\u4e2a\u9700\u8981\u5165\u53e3\u7684\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u4e00\u7ec4Envoy\u7f51\u5173\u3002 3\uff0e\u8d44\u6e90\u9009\u62e9\u5668\u662f\u5426\u6b63\u786e\uff1f \u9a8c\u8bc1\u90e8\u7f72\u4e2d\u7684pod\u662f\u5426\u6709\u6b63\u786e\u7684\u6807\u7b7e\u8bbe\u7f6e\u3002\u6b63\u5982\u4e0a\u4e00\u6b65\u63d0\u5230\u7684\uff0c\u8d44\u6e90\u9009\u62e9\u5668\u4e0e\u8d44\u6e90\u53d1\u5e03\u7684\u547d\u540d \u7a7a\u95f4\u7ed1\u5b9a\u3002 \u5728\u8fd9\u4e00\u70b9\u4e0a\uff0c\u6211\u4eec\u5e94\u8be5\u6709\u7406\u7531\u76f8\u4fe1\uff0c\u914d\u7f6e\u662f\u6b63\u786e\u7684\u3002\u63a5\u4e0b\u6765\u7684\u6b65\u9aa4\u662f\u8fdb\u4e00\u6b65\u7814\u7a76\u8fd0\u884c\u65f6\u7cfb\u7edf\u662f \u5982\u4f55\u5904\u7406\u914d\u7f6e\u7684\u3002","title":"3-1 \u914d\u7f6e"},{"location":"chap8/8Istio_trouble_shoot/#3-2","text":"Istio CLI \u7684\u4e00\u4e2a\u5b9e\u9a8c\u6027\u529f\u80fd\u53ef\u4ee5\u63d0\u4f9b\u4fe1\u606f\uff0c\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u5f71\u54cdPod\u6216\u670d\u52a1\u7684\u914d\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u9488\u5bf9Pod\u8fd0\u884cdescribe\u547d\u4ee4\u7684\u4f8b\u5b50\uff0c\u8fd9\u4e2aPod\u7684\u4e3b\u673a\u540d\u79f0\u4e2d\u6709\u4e00\u4e2a\u9519\u5b57\uff1a $ istioctl x describe pod customers-v1-64455cd4c6-xvjzm.default Pod: customers-v1-64455cd4c6-xvjzm Pod Ports: 3000 (svc), 15090 (istio-proxy) -------------------- Service: customers Port: http 80/HTTP targets pod port 3000 DestinationRule: customers for \"customers.default.svc.cluster.local\" Matching subsets: v1 No Traffic Policy VirtualService: customers WARNING: No destinations match pod subsets (checked 1 HTTP routes) Route to cusomers.default.svc.cluster.local \u00b7\u00b7\u00b7 $ istioctl x describe pod customers-v1-7b5b4b76fc-dslg9 Pod: customers-v1-7b5b4b76fc-dslg9 Pod Ports: 3000 (svc), 15090 (istio-proxy) -------------------- Service: customers Port: http 80/HTTP targets pod port 3000 VirtualService: customers 1 HTTP route(s) 1. Envoy\u662f\u5426\u63a5\u53d7\uff08ACK\uff09\u8be5\u914d\u7f6e\uff1f \u4f60\u53ef\u4ee5\u4f7f\u7528 istioctl proxy-status \u547d\u4ee4\u6765\u68c0\u67e5\u72b6\u6001\uff0c\u770b\u770bEnvoy\u662f\u5426\u63a5\u53d7\u914d\u7f6e\u3002\u6211\u4eec\u5e0c\u671b\u6240\u6709\u4e1c\u897f\u7684\u72b6\u6001\u90fd\u8bbe\u7f6e\u4e3aSYNCHED\u3002\u4efb\u4f55\u5176\u4ed6\u503c\u90fd\u53ef\u80fd\u8868\u660e\u6709\u9519\u8bef\uff0c\u4f60\u5e94\u8be5\u68c0\u67e5Pilot\u7684\u65e5\u65e5\u5fd7\u3002 $ istioctl proxy-status NAME CDS LDS EDS RDS ISTIOD VERSION curl-6cd5b579fb-2xcx9.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 customers-v1-7b5b4b76fc-dslg9.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 customers-v1-7b5b4b76fc-rh8zb.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 customers-v1-7b5b4b76fc-x7jb8.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 istio-egressgateway-5547fcc8fc-7kj9c.istio-system SYNCED SYNCED SYNCED NOT SENT istiod-6659979bdf-l7kgk 1.10.3 istio-ingressgateway-8f568d595-b2d6q.istio-system SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 web-frontend-74dd5cbcdc-8mfpb.default SYNCED SYNCED SYNCED SYNCED istiod-6659979bdf-l7kgk 1.10.3 \u5217\u8868\u663e\u793a\u6240\u6709\u8fde\u63a5\u5230 Pilot \u5b9e\u4f8b\u7684\u4ee3\u7406\u3002\u5982\u679c\u5217\u8868\u4e2d\u7f3a\u5c11\u4e00\u4e2a\u4ee3\u7406\uff0c\u8fd9\u610f\u6627\u7740\u5b83\u6ca1\u6709\u8fde\u63a5\u5230Pilot\uff0c\u4e5f\u6ca1\u6709\u6536\u5230\u4efb\u4f55\u914d\u7f6e\u3002\u5982\u679c\u4efb\u4f55\u4e00\u4e2a\u4ee3\u7406\u88ab\u6807\u8bb0\u4e3aSTALE\uff0c\u53ef\u80fd\u6709\u7f51\u7edc\u95ee\u9898\uff0c\u6216\u8005\u6211\u4eec \u9700\u8981\u6269\u5c55Pilot \u5982\u679cEnvoy\u63a5\u53d7\u4e86\u914d\u7f6e\uff0c\u4f46\u6211\u4eec\u4ecd\u7136\u770b\u5230\u95ee\u9898\uff0c\u6211\u4eec\u9700\u8981\u786e\u4fdd\u914d\u7f6e\u5728Envoy\u4e2d\u7684\u8868\u73b0\u7b26\u5408\u9884\u671f\u3002 2\uff0e\u914d\u7f6e\u5728Envoy\u4e2d\u7684\u8868\u73b0\u548c\u9884\u671f\u7684\u4e00\u6837\u5417\uff1f \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 proxy-config \u547d\u4ee4\u6765\u68c0\u7d22\u7279\u5b9a Envoy \u5b9e\u4f8b\u7684\u4fe1\u606f\u3002\u8bf7\u53c2\u8003\u4e0b\u9762\u7684\u8868\u683c\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u7d22\u4e0d\u540c\u7684\u4ee3\u7406\u914d\u7f6e\u3002 \u8be5\u547d\u4ee4\u4ece Envoy \u7684\u7ba1\u7406\u7aef\u70b9\uff08\u4e3b\u8981\u662f /config_dump \uff09\u6536\u96c6\u6570\u636e\uff0c\u5b83\u5305\u542b\u4e86\u5f88\u591a\u6709\u7528\u7684\u4fe1\u606f\u3002 \u53e6\u5916\uff0c\u8bf7\u53c2\u8003\u663e\u793aEnvoy\u548cIstio\u8d44\u6e90\u4e4b\u95f4\u6620\u5c04\u7684\u56fe\u3002\u4f8b\u5982\uff0c\u8bb8\u591a VirtualService \u89c4\u5219\u5c06\u8868\u73b0\u4e3a Envoy \u8def\u7531\uff0c\u800c DestinationRules \u548c ServiceEntries \u5219\u8868\u73b0\u4e3aCluster DestinationRules \u4e0d\u4f1a\u51fa\u73b0\u5728\u914d\u7f6e\u4e2d\uff0c\u9664\u975e\u5176\u4e3b\u673a\u7684 ServiceEntry \u9996\u5148\u5b58\u5728 \u3002 \u8ba9\u6211\u4eec\u4ee5\u5ba2\u6237\u7684 VirtualService \u4e3a\u4f8b\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: customers spec: hosts: - 'customers.default.svc.cluster.local' http: - route: - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v1 weight: 80 - destination: host: customers.default.svc.cluster.local port: number: 80 subset: v2 weight: 20 timeout: 5s \u5982\u679c\u4f60\u8fd0\u884c istioctl proxy-config routes[POD\uff3d-o json \u547d\u4ee4\uff0c\u4f60\u4f1a\u770b\u5230\u52a0\u6743\u76ee\u7684\u5730\u548c\u8d85\u65f6\u662f\u5982\u4f55\u5728\u914d\u7f6e\u4e2d\u4f53\u73b0\u7684\uff1a .. { \"name\": \"80\", \"virtualHosts\": [ { \"name\": \"customers.default.svc.cluster.local:80\", \"domains\": [ \"customers.default.svc.cluster.local\", ... ], \"routes\": [ { \"match\": {\"prefix\": \"/\"}, \"route\": { \"weightedClusters\": { \"clusters\": [ { \"name\": \"outbound|80|v1|customers.default.svc.cluster.local\", \"weight\": 80 }, { \"name\": \"outbound|80|v2|customers.default.svc.cluster.local\", \"weight\": 20 } ] }, \"timeout\": \"5s\", ... \u5f53\u4f60\u8bc4\u4f30VirtualService\u65f6\uff0c\u4f60\u8981\u5bfb\u627e\u4e3b\u673a\u540d\u662f\u5426\u50cf\u4f60\u5199\u7684\u90a3\u6837\u51fa\u73b0\u5728Envoy\u914d\u7f6e\u4e2d\uff08\u4f8b\u5982 customers.default.svc.cluster.local )\uff0c\u4ee5\u53ca\u8def\u7531\u662f\u5426\u5b58\u5728(\u89c1\u8f93\u51fa\u4e2d\u768480-20\u6d41\u91cf\u5206\u5272\uff09\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e4b\u524d\u7684\u4f8b\u5b50\uff0c\u901a\u8fc7\u76d1\u542c\u5668\u3001\u8def\u7531\u548c\u96c6\u7fa4(\u548c\u7aef\u70b9\uff09\u6765\u8ffd\u8e2a\u8c03\u7528\u3002 Envoy\u8fc7\u6ee4\u5668\u4f1a\u8868\u73b0\u5728\u4f60\u544a\u8bc9Istio\u628a\u5b83\u4eec\u653e\u5728\u54ea\u91cc\uff08EnvoyFilter\u8d44\u6e90\u4e2d\u7684applyTo\u5b57\u6bb5\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u574f\u7684\u8fc7\u6ee4\u5668\u4f1a\u8868\u73b0\u4e3aEnvoy\u62d2\u7edd\u914d\u7f6e\uff08\u5373\u4e0d\u663e\u793aSYNCED\u72b6\u6001\uff09\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u9700\u8981\u68c0\u67e5Istiod\u65e5\u5fd7\u4e2d\u7684\u9519\u8bef 3. Istiod (Pilot\uff09\u4e2d\u662f\u5426\u6709\u9519\u8bef\uff1f \u4ecePilot\u67e5\u770b\u9519\u8bef\u7684\u6700\u5feb\u65b9\u6cd5\u662f\u8ddf\u8e2a\u65e5\u5fd7\uff08\u4f7f\u7528 --follow \u6807\u5fd7\uff09\uff0c\u7136\u540e\u5e94\u7528\u914d\u7f6e\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u6765\u81eaPilot\u7684\u9519\u8bef\u7684\u4f8b\u5b50\uff0c\u8fd9\u662f\u7531\u4e8e\u8fc7\u6ee4\u5668\u7684\u5185\u8054\u4ee3\u7801\u4e2d\u7684\u4e00\u4e2a\u9519\u5b57\u800c\u5bfc\u81f4\u7684\u3002 2020-11-20T21:49:16.017487Z warn ads ADS:LDS: ACK ERROR sidecar~10.120.1.8~web-frontend-58d497b6f8-lwqkg.default~default.svc.cluster.local-4 Internal:Error adding/updating listener (s) virtualInbound: script load error: [string\"fction envoy_on_response (response_handle)...\"]:1: '=' expected near 'envoy_on_response' \u5982\u679c\u914d\u7f6e\u6839\u672c\u6ca1\u6709\u51fa\u73b0\u5728Envoy\u4e2d\uff08Envoy\u6ca1\u6709ACK\u5b83\uff09\uff0c\u6216\u8005\u5b83\u662f\u4e00\u4e2aEnvoyFilter\u914d\u7f6e\uff0c\u90a3\u4e48\u8fd9\u4e2a\u914d\u7f6e\u5f88\u53ef\u80fd\u662f\u65e0\u6548\u7684\u3002Istio\u65e0\u6cd5\u4ece\u8bed\u6cd5\u4e0a\u9a8c\u8bc1EnvoyFilter\u5185\u90e8\u7684\u914d\u7f6e\u3002\u53e6\u4e00\u4e2a\u95ee\u9898\u53ef\u80fd\u662f\uff0c\u8fc7\u6ee4\u5668\u5728Envoy\u7684\u914d\u7f6e\u4e2d\u4f4d\u4e8e\u9519\u8bef\u7684\u4f4d\u7f6e\u3002 \u65e0\u8bba\u54ea\u79cd\u60c5\u51b5\uff0cEnvoy\u90fd\u4f1a\u62d2\u7edd\u8be5\u914d\u7f6e\uff0c\u56e0\u4e3a\u5b83\u662f\u65e0\u6548\u7684\uff0cPilot\u4f1a\u8bb0\u5f55\u8fd9\u4e2a\u9519\u8bef\u3002\u4e00\u822c\u6765 \u8bf4\uff0c\u4f60\u53ef\u4ee5\u641c\u7d22\u4f60\u7684\u8d44\u6e90\u7684\u540d\u79f0\u6765\u627e\u5230\u9519\u8bef\u3002 \u5728\u8fd9\u91cc\uff0c\u4f60\u5fc5\u987b\u4f7f\u7528\u5224\u65ad\u529b\u6765\u786e\u5b9a\u5b83\u662f\u4f60\u5199\u7684\u914d\u7f6e\u4e2d\u7684\u9519\u8bef\uff0c\u8fd8\u662fPilot\u7684\u9519\u8bef\u5bfc\u81f4\u5b83\u4ea7\u751f\u4e86 \u4e00\u4e2a\u65e0\u6548\u7684\u914d\u7f6e\u3002","title":"3-2 \u8fd0\u884c\u65f6"},{"location":"chap8/8Istio_trouble_shoot/#3-3-envoy","text":"\u8981\u68c0\u67e5Envoy\u4ee3\u7406\u7684\u65e5\u5fd7\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 kubectl logs \u547d\u4ee4\uff1a kubect1 logs PODNAME -c istio-proxy \u4e00n NAMESPACE \u8981\u4e86\u89e3\u8bbf\u95ee\u65e5\u5fd7\u7684\u683c\u5f0f\u548c\u54cd\u5e94\u6807\u5fd7\uff0c\u6211\u4eec\u53ef\u4ee5\u53c2\u8003Envoy\u8bbf\u95ee\u65e5\u5fd7\u7684\u5185\u5bb9 \u6700\u5e38\u89c1\u7684\u54cd\u5e94\u6807\u5fd7\u3002 NP\uff1a\u6ca1\u6709\u914d\u7f6e\u8def\u7531\uff0c\u68c0\u67e5DestinationRule\u6216VirtualService UO\uff1a\u4e0a\u6e38\u6ea2\u51fa\u5e76\u65ad\u8def\u3002\u68c0\u67e5DestinationRule\u4e2d\u7684\u65ad\u8def\u5668\u914d\u7f6e\u3002 UF:\u4e0a\u6e38\u8fde\u63a5\u5931\u8d25\uff0c\u5982\u679c\u4f7f\u7528Istio\u8ba4\u8bc1\uff0c\u68c0\u67e5mTLS\u914d\u7f6e\u3002 UH\uff1a\u6ca1\u6709\u5065\u5eb7\u7684\u4e0a\u6e38\u4e3b\u673a\u3002","title":"3-3 \u68c0\u67e5Envoy\u65e5\u5fd7"},{"location":"chap8/8Istio_trouble_shoot/#3-4-istiod","text":"\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528ControlZ\u4eea\u8868\u677f\uff0c\u901a\u8fc7 Logging Scopes \u83dc\u5355\u914d\u7f6e\u5806\u6808\u8ddf\u8e2a\u7ea7\u522b\u548c\u65e5\u5fd7\u7ea7\u522b\u3002 \u8981\u6253\u5f00\u4eea\u8868\u677f\uff0c\u8bf7\u8fd0\u884c\uff1a istioctl dashboard controlz $(kubectl -n istio-system get pods -l app=istiod -o jsonpath='{.items [0].metadata.name}').istio-system \u4eea\u8868\u677f\u6253\u5f00\u540e\uff0c\u70b9\u51fbLogging Scopes\u9009\u9879\uff0c\u8c03\u6574\u65e5\u5fd7\u7ea7\u522b\u548c\u5806\u6808\u8ddf\u8e2a\u7ea7\u522b\u3002","title":"3-4 \u914d\u7f6e istiod \u65e5\u5fd7"},{"location":"chap8/8Istio_trouble_shoot/#4","text":"1\u3001\u5982\u679c\u865a\u62df\u76d1\u542c\u5668\u627e\u4e0d\u5230\u8bf7\u6c42\u7684\u76ee\u7684\u5730\u4f1a\u600e\u6837\uff1f A \u629b\u5f03\u8be5\u8bf7\u6c42 B \u8df3\u8f6c\u5230\u7b2c\u4e8c\u63a5\u8fd1\u7684\u8bf7\u6c42 C \u6839\u636eOutboundTrafficPolicy\u53d1\u9001\u6d41\u91cf D \u6839\u636e\u865a\u62df\u670d\u52a1\u7684\u8981\u6c42\u53d1\u9001\u6d41\u91cf \u5f53\u4e00\u4e2a\u8bf7\u6c42\u88ab\u91cd\u5b9a\u5411\uff08\u4f7f\u7528IP Tables\u914d\u7f6e\uff09\u523015001\u7aef\u53e3\u65f6\uff0c\u76d1\u542c\u5668\u4f1a\u628a\u5b83\u4ea4\u7ed9\u4e0e\u8bf7\u6c42\u7684\u539f\u59cb\u76ee\u7684\u5730\u6700\u5339\u914d\u7684\u865a\u62df\u76d1\u542c\u5668\u3002** \u5982\u679c\u5b83\u627e\u4e0d\u5230\u76ee\u7684\u5730\uff0c\u5b83\u5c31\u6839\u636e\u914d\u7f6e\u7684 OutboundTrafficPolicy \u6765\u53d1\u9001\u6d41\u91cf\u3002 2\u3001\u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e2aIstio CLI\u547d\u4ee4\u6765\u5217\u51fa\u6240\u6709\u76d1\u542c\u5668\uff1f A istiocti get listeners B istiocti proxy-config listeners C istiocti describe listeners D istioctl config listeners istioctl proxy-config \u5217\u51fa\u76d1\u542c\u5668 3\u3001\u76d1\u542c\u5668\u4f7f\u7528\u54ea\u4e2a\u670d\u52a1\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e\uff1f A SDS B RDS(route discovery service) C Listener service D Envoy service Listener\u4f7f\u7528RDS\uff08\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff09\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f80) 4\u3001Envoy\u7684\u57fa\u672c\u6982\u5ff5\u662f\u4ec0\u4e48\uff1f A listener\u3001route\u3001cluster\u548cendpoint B request\u3001response\u548cendpoint C request\u3001header\u548ccookies D header\u3001cluster\u548croute 5\u3001Envoy\u4e3a\u6bcf\u4e2asidecar\u751f\u6210\u4e00\u4e2a\u76d1\u542c\u5668\u3002\uff08\u5bf9/\u9519\uff09 A True B False \u6bcf\u4e2asidecar\u90fd\u6709\u591a\u4e2a\u76d1\u542c\u5668\u751f\u6210\u3002 \u6bcf\u4e2asidecar\u90fd\u6709\u4e00\u4e2a\u76d1\u542c\u5668 \uff0c\u5b83\u88ab\u7ed1\u5b9a\u5230 0.0.0.0:15006 \u3002 6\u3001Where are the circuit breakers defined? A In virtual listeners B In endpoint configuration C In clusters configuration D In routes configuration 7\u3001\u4ec0\u4e48\u7c7b\u578b\u7684\u6d41\u91cf\u4f1a\u88ab\u8def\u7531\u523015006\u7aef\u53e3\uff1f A \u5165\u7ad9Pod\u6d41\u91cf B \u51fa\u7ad9Pod \u6d41\u91cf C \u6240\u6709\u6d41\u91cf D \u6ca1\u6709\u6d41\u91cf","title":"4\u3001\u95ee\u9898\u68c0\u6d4b\u68c0\u6d4b"},{"location":"chap8/9Istio_real_instance/","text":"\u7b2c\u4e5d\u8282 \u5b9e\u9645\u6848\u4f8b \u5728\u672c\u6a21\u5757\u4e2d\uff0c\u6211\u4eec\u5c06\u90e8\u7f72\u540d\u4e3a Online Boutique \u7684\u5fae\u670d\u52a1\u6f14\u793a\u5e94\u7528\u7a0b\u5e8f\uff0c\u8bd5\u7528Istio\u7684\u4e0d\u540c\u529f\u80fd Online Boutique \u662f\u4e00\u4e2a\u4e91\u539f\u751f\u5fae\u670d\u52a1\u6f14\u793a\u5e94\u7528\u7a0b\u5e8f\u3002 Online Boutique \u662f\u4e00\u4e2a\u753110\u4e2a\u5fae\u670d \u52a1\u7ec4\u6210\u7684\u5e94\u7528\u3002\u8be5\u5e94\u7528\u662f\u4e00\u4e2a\u57fa\u4e8eWeb\u7684\u7535\u5b50\u5546\u52a1\u5e94\u7528\uff0c\u7528\u6237\u53ef\u4ee5\u6d4f\u89c8\u5546\u54c1\uff0c\u5c06\u5176\u6dfb\u52a0\u5230\u8d2d\u7269\u8f66\uff0c\u5e76\u8d2d\u4e70\u5546\u54c1\u3002 Deploy microservices demo application(Online Boutique) Demonstrate how to use lstio features; Traffic routing Fault injection Resiliency 1\u3001\u521b\u5efa\u96c6\u7fa4 \u6211\u4eec\u5c06\u4f7f\u7528\u8c37\u6b4c\u4e91\u5e73\u53f0\u6765\u6258\u7ba1Kubernetes\u96c6\u7fa4\u3002\u6253\u5f00\u5e76\u767b\u5f55\u5230\u4f60\u7684GCP\u63a7\u5236\u53f0\u8d26\u6237\uff0c\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u521b\u5efa\u4e00\u4e2aKubernetes\u96c6\u7fa4\u3002 1\uff0e\u4ece\u5bfc\u822a\u4e2d\uff0c\u9009\u62e9Kubernetes Engine 2\uff0e\u70b9\u51fb\u521b\u5efa\u96c6\u7fa4\u3002 3\uff0e\u5c06\u96c6\u7fa4\u547d\u540d\u4e3a Boutique-demo 4\uff0e\u9009\u62e9\u533a\u57df\u9009\u9879\uff0c\u9009\u62e9\u6700\u63a5\u8fd1\u4f60\u7684\u4f4d\u7f6e\u7684\u533a\u57df\u3002 5\uff0e\u70b9\u51fb default-pool \uff0c\u5728\u8282\u70b9\u6570\u4e2d\u8f93\u51655 6\uff0e\u70b9\u51fbNodes\uff08\u8282\u70b9\uff09\u3002 7\uff0e\u70b9\u51fb\u673a\u5668\u914d\u7f6e\u673a\u5668\u7c7b\u578b\u4e0b\u62c9\uff0c\u9009\u62e9 e2-medium (2 vCPU, 4 GB memory)\u3002 8\uff0e\u70b9\u51fb\u201dCreate\u201d\u6765\u521b\u5efa\u96c6\u7fa4\u3002 \u96c6\u7fa4\u7684\u521b\u5efa\u5c06\u9700\u8981\u51e0\u5206\u949f\u7684\u65f6\u95f4\u3002\u4e00\u65e6\u5b89\u88c5\u5b8c\u6210\uff0c\u96c6\u7fa4\u5c06\u663e\u793a\u5728\u5217\u8868\u4e2d\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u4f60\u4e5f\u53ef\u4ee5\u5c06Online Boutique\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u6258\u7ba1\u5728\u5176\u4ed6\u4e91\u5e73\u53f0\u4e0a\u7684Ku bernetes\u96c6 \u7fa4\uff0c\u5982Azure\u6216AWS\u3002 \u8bbf\u95ee\u96c6\u7fa4 \u6211\u4eec\u6709\u4e24\u79cd\u65b9\u5f0f\u6765\u8bbf\u95ee\u96c6\u7fa4\u3002\u6211\u4eec\u53ef\u4ee5\u4ece\u6d4f\u89c8\u5668\u4e2d\u4f7f\u7528Cloud Shell\u3002\u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u70b9\u51fb\u96c6 \u7fa4\u65c1\u8fb9\u7684Connect\uff0c\u7136\u540e\u70b9\u51fbRun in Cloud Shell\u6309\u94ae\u3002\u70b9\u51fb\u8be5\u6309\u94ae\u53ef\u4ee5\u6253\u5f00Cloud Shell\uff0c\u5e76\u914d\u7f6eKubernetes CLI\u6765\u8bbf\u95ee\u8be5\u96c6\u7fa4\u3002 \u7b2c\u4e8c\u4e2a\u9009\u62e9\u662f\u5728\u4f60\u7684\u7535\u8111\u4e0a\u5b89\u88c5gcloud CLI\uff0c\u7136\u540e\u4ece\u4f60\u7684\u7535\u8111\u4e0a\u8fd0\u884c\u76f8\u540c\u7684\u547d\u4ee4\u3002 2\u3001\u5b89\u88c5Istio \u5b89\u88c5Istlo \u6211\u4eec\u5c06\u4f7f\u7528GetMesh CLI\u5728\u96c6\u7fa4\u4e2d\u5b89\u88c5 Istio 1.1O.3 \u3002 1\uff0e\u4e0b\u8f7dGetMesh CLI: curl -sL https://istio.tetratelabs.io/getmesh/install.sh | bash 2\uff0e\u5b89\u88c5Istio: istioctl install --set profile=demo \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u7ed9\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u8bbe\u7f6e\u4e0a istio-injection=enabled \u6807\u7b7e\uff1a kubectl label namespace default istio-injection=enabled 3\u3001\u90e8\u7f72 Online Boutique \u5e94\u7528 \u5728\u96c6\u7fa4\u548cIstio\u51c6\u5907\u597d\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u514b\u9686\u5728 Online Boutique \u5e94\u7528\u5e93\u3002 3-1 \u514b\u9686\u4ed3\u5e93 git clone https://github.com/GoogleCloudPlatform/microservices-demo.git 3-2 \u524d\u5f80 microservices-demo \u76ee\u5f55 cd microservices-demo 3-3 \u521b\u5efaKubernetes\u8d44\u6e90 \uff1a kubectl apply -f release/kubernetes-manifests.yaml 3-4 \u68c0\u67e5\u6240\u6709Pod\u90fd\u5728\u8fd0\u884c\uff1a $ kubectl get pods NAME READY STATUS RESTARTS AGE adservice-5c9c7c997f-n627f 2/2 Running 0 2m15s cartservice-6d99678dd6-767fb 2/2 Running 2 2m16s checkoutservice-779cb9bfdf-l2rs9 2/2 Running 0 2m18s currencyservice-5db6c7d559-9drtc 2/2 Running 0 2m16s emailservice-5c47dc87bf-dk7qv 2/2 Running 0 2m18s frontend-5fcb8cdcdc-8c9dk 2/2 Running 0 2m17s loadgenerator-79bff5bd57-q9qkd 2/2 Running 4 2m16s paymentservice-6564cb7fb9-f6dwr 2/2 Running 0 2m17s productcatalogservice-5db9444549-hkzv7 2/2 Running 0 2m17s recommendationservice-ff6878cf5-jsghw 2/2 Running 0 2m18s redis-cart-57bd646894-zb7ch 2/2 Running 0 2m15s shippingservice-f47755f97-dk7k9 2/2 Running 0 2m15s 3-5 \u521b\u5efaIstio\u8d44\u6e90 \uff1a kubectl apply -f ./istio-maifest \u90e8\u7f72\u4e86\u4e00\u5207\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5f97\u5230\u5165\u53e3\u7f51\u5173\u7684IP\u5730\u5740\u5e76\u6253\u5f00\u524d\u7aef\u670d\u52a1\uff1a INGRESS_HOST=\"$(kubectl -n istio-system get service istio-ingressgateway \\ -o jsonpath='{.status.loadBalancer.ingress[0].ip}')\" echo \"$INGRESS_HOST\" \u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 INGRESS_HOST \uff0c\u4f60\u4f1a\u770b\u5230\u524d\u7aef\u670d\u52a1\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u6211\u4eec\u9700\u8981\u505a\u7684\u6700\u540e\u4e00\u4ef6\u4e8b\u662f\u5220\u9664 frontend-external \u670d\u52a1\u3002 frontend-external \u670d\u52a1\u662f\u4e00\u4e2a LoadBalancer \u670d\u52a1\uff0c\u5b83\u66b4\u9732\u4e86\u524d\u7aef\u3002\u7531\u4e8e\u6211\u4eec\u6b63\u5728\u4f7f\u7528Istio\u7684\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u4e0d\u518d\u9700\u8981\u8fd9\u4e2aLoadBalancer\u670d\u52a1\u4e86\u3002 \u5220\u9664\u670d\u52a1\uff0c\u8fd0\u884c\uff1a kubectl delete svc frontend-external Online Boutique \u5e94\u7528\u6e05\u5355\u8fd8\u5305\u62ec\u4e00\u4e2a\u8d1f\u8f7d\u53d1\u751f\u5668\uff0c\u5b83\u6b63\u5728\u751f\u6210\u5bf9\u6240\u6709\u670d\u52a1\u7684\u8bf7\u6c42\u2015\u8fd9\u662f\u4e3a\u4e86\u8ba9\u6211\u4eec\u80fd\u591f\u6a21\u62df\u7f51\u7ad9\u7684\u6d41\u91cf\u3002 $ istioctl dashboard kiali http://localhost:20001/kiali 4\u3001\u8def\u7531\u6d41\u91cf \u6211\u4eec\u5df2\u7ecf\u5efa\u7acb\u4e86\u4e00\u4e2a\u65b0\u7684Docker\u955c\u50cf\uff0c\u5b83\u4f7f\u7528\u4e86\u4e0e\u5f53\u524d\u8fd0\u884c\u7684\u524d\u7aef\u670d\u52a1\u4e0d\u540c\u7684\u6807\u5934\u3002\u8ba9\u6211\u4eec\u770b\u770b\u5982\u4f55\u90e8\u7f72\u6240\u9700\u7684\u8d44\u6e90\u5e76\u5c06\u4e00\u5b9a\u6bd4\u4f8b\u7684\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684\u524d\u7aef\u670d\u52a1\u7248\u672c\u3002 \u5728\u6211\u4eec\u521b\u5efa\u4efb\u4f55\u8d44\u6e90\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u5220\u9664\u73b0\u6709\u7684\u524d\u7aef\u90e8\u7f72\uff08 kubectl delete deploy frontend )\uff0c\u5e76\u521b\u5efa\u4e00\u4e2a\u7248\u672c\u6807\u7b7e\u8bbe\u7f6e\u4e3a original \u3002 $ kubectl delete deploy frontend deployment.apps \"frontend\" deleted $ curl localhost no healthy upstream 1frontendoriginal.yaml apiVersion: apps/v1 kind: Deployment metadata: name: frontend spec: selector: matchLabels: app: frontend version: original template: metadata: labels: app: frontend version: original annotations: sidecar.istio.io/rewriteAppHTTPProbers: \"true\" spec: containers: - name: server image: gcr.io/google-samples/microservices-demo/frontend:v0.2.1 ports: - containerPort: 8080 readinessProbe: initialDelaySeconds: 10 httpGet: path: \"/_healthz\" port: 8080 httpHeaders: - name: \"Cookie\" value: \"shop_session-id=x-readiness-probe\" livenessProbe: initialDelaySeconds: 10 httpGet: path: \"/_healthz\" port: 8080 httpHeaders: - name: \"Cookie\" value: \"shop_session-id=x-liveness-probe\" env: - name: PORT value: \"8080\" - name: PRODUCT_CATALOG_SERVICE_ADDR value: \"productcatalogservice:3550\" - name: CURRENCY_SERVICE_ADDR value: \"currencyservice:7000\" - name: CART_SERVICE_ADDR value: \"cartservice:7070\" - name: RECOMMENDATION_SERVICE_ADDR value: \"recommendationservice:8080\" - name: SHIPPING_SERVICE_ADDR value: \"shippingservice:50051\" - name: CHECKOUT_SERVICE_ADDR value: \"checkoutservice:5050\" - name: AD_SERVICE_ADDR value: \"adservice:9555\" - name: ENV_PLATFORM value: \"gcp\" resources: requests: cpu: 100m memory: 64Mi limits: cpu: 200m memory: 128Mi \u73b0\u5728\u6211\u4eec\u51c6\u5907\u521b\u5efa\u4e00\u4e2a DestinationRule \uff0c\u5b9a\u4e49\u4e24\u4e2a\u7248\u672c\u7684\u524d\u7aef\u2014\u2014\u73b0\u6709\u7684original\u548c\u65b0\u7684\uff08v1)\u3002 frontenddr.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: frontend spec: host: frontend.default.svc.cluster.local subsets: - name: original labels: version: original - name: v1 labels: version: 1.0.0 $ kubectl apply -f 2frontenddr.yaml destinationrule.networking.istio.io/frontend created \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u66f4\u65b0VirtualService\uff0c\u5e76\u6307\u5b9a\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u7684\u5b50\u96c6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5c06\u628a\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u539f\u59cb\u7248\u672c\u7684\u524d\u7aef\u3002 3frontendvs.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: frontend-ingress spec: hosts: - '*' gateways: - frontend-gateway http: - route: - destination: host: frontend port: number: 80 subset: original $ kubectl apply -f 3frontendvs.yaml virtualservice.networking.istio.io/frontend-ingress configured \u73b0\u5728\u6211\u4eec\u5c06\u65b0\u521b\u5efa\u65b0\u7684 VirtualService \u914d\u7f6e\u4e3a\u5c06\u6240\u6709\u8fdb\u5165\u7684\u6d41\u91cf\u8def\u7531\u5230original\u5b50\u96c6\uff0c\u6211\u4eec\u53ef\u4ee5\u5b89\u5168\u5730\u521b\u5efa\u65b0\u7684\u524d\u7aef\u90e8\u7f72 apiVersion: apps/v1 kind: Deployment metadata: name: frontend-v1 spec: selector: matchLabels: app: frontend version: 1.0.0 template: metadata: labels: app: frontend version: 1.0.0 annotations: sidecar.istio.io/rewriteAppHTTPProbers: \"true\" spec: containers: - name: server image: gcr.io/tetratelabs/boutique-frontend:1.0.0 ports: - containerPort: 8080 readinessProbe: initialDelaySeconds: 10 httpGet: path: \"/_healthz\" port: 8080 httpHeaders: - name: \"Cookie\" value: \"shop_session-id=x-readiness-probe\" livenessProbe: initialDelaySeconds: 10 httpGet: path: \"/_healthz\" port: 8080 httpHeaders: - name: \"Cookie\" value: \"shop_session-id=x-liveness-probe\" env: - name: PORT value: \"8080\" - name: PRODUCT_CATALOG_SERVICE_ADDR value: \"productcatalogservice:3550\" - name: CURRENCY_SERVICE_ADDR value: \"currencyservice:7000\" - name: CART_SERVICE_ADDR value: \"cartservice:7070\" - name: RECOMMENDATION_SERVICE_ADDR value: \"recommendationservice:8080\" - name: SHIPPING_SERVICE_ADDR value: \"shippingservice:50051\" - name: CHECKOUT_SERVICE_ADDR value: \"checkoutservice:5050\" - name: AD_SERVICE_ADDR value: \"adservice:9555\" - name: ENV_PLATFORM value: \"gcp\" resources: requests: cpu: 100m memory: 64Mi limits: cpu: 200m memory: 128Mi $ kubectl apply -f 4frontendv1.yaml deployment.apps/frontend-v1 created $ kubectl get pod | grep front frontend-8658d97d64-rbwjw 2/2 Running 0 16m frontend-v1-664f8ff6c6-lvnwr 2/2 Running 0 61s \u5982\u679c\u6211\u4eec\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 VirtualService\u4e2d\u7684\u6743\u91cd INGRESS_HOST , \u6211\u4eec\u4ecd\u7136\u4f1a\u770b\u5230\u539f\u59cb\u7248\u672c\u7684\u524d\u7aef\u3002\u8ba9\u6211\u4eec\u66f4\u65b0\uff0c\u5f00\u59cb\u5c0630\uff05\u7684\u6d41\u91cf\u8def\u7531\u5230 v1 \u7684\u5b50\u96c6\u3002 5frontend.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: frontend-ingress spec: hosts: - '*' gateways: - frontend-gateway http: - route: - destination: host: frontend port: number: 80 subset: original weight: 70 - destination: host: frontend port: number: 80 subset: v1 weight: 30 $ kubectl apply -f 5frontend30.yaml virtualservice.networking.istio.io/frontend-ingress configured \u5982\u679c\u6211\u4eec\u5237\u65b0\u51e0\u6b21\u7f51\u9875\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u6765\u81ea\u524d\u7aefv1\u7684\u66f4\u65b0\u6807\u5934 5\u3001\u6545\u969c\u6ce8\u5165 \u5728\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u4e3a\u63a8\u8350\u670d\u52a1\u5f15\u51655\u79d2\u7684\u5ef6\u8fdf\u3002Envoy\u5c06\u4e3a50\uff05\u7684\u8bf7\u6c42\u6ce8\u5165\u5ef6\u8fdf\u3002 recommendationdelay.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: recommendationservice spec: hosts: - recommendationservice http: - route: - destination: host: recommendationservice fault: delay: percentage: value: 50 fixedDelay: 5s $ kubectl get vs NAME GATEWAYS HOSTS AGE frontend [\"frontend.default.svc.cluster.local\"] 28h frontend-ingress [\"frontend-gateway\"] [\"*\"] 28h recommendationservice [\"recommendationservice\"] 84s \u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 INGRESS_HOST \uff0c\u7136\u540e\u70b9\u51fb\u5176\u4e2d\u4e00\u4e2a\u4ea7\u54c1\u3002\u63a8\u8350\u670d\u52a1\u7684\u7ed3\u679c\u663e\u793a\u5728\u5c4f\u5e55\u5e95\u90e8\u7684\u201dOther Products You Might Light\u201c\u90e8\u5206\u3002 \u5982\u679c\u6211\u4eec\u5237\u65b0\u51e0\u6b21\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\uff0c\u8be5\u9875\u9762\u8981\u4e48\u7acb\u5373\u52a0\u8f7d\uff0c\u8981\u4e48\u6709\u4e00\u4e2a\u5ef6\u8fdf\u52a0\u8f7d\u9875\u9762\u3002\u8fd9\u4e2a\u5ef6\u8fdf\u662f\u7531\u4e8e\u6211\u4eec\u6ce8\u5165\u4e865\u79d2\u7684\u5ef6\u8fdf \u3002 \u6211\u4eec\u53ef\u4ee5\u6253\u5f00Grafana ( istioctl dash grafana )\u548cIstio\u670d\u52a1\u4eea\u8868\u677f\u3002\u786e\u4fdd\u4ece\u670d\u52a1\u5217\u8868\u4e2d\u9009\u62e9 recommendationsservice \uff0c\u5728Reporter\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9source\uff0c\u5e76\u67e5\u770b\u663e\u793a\u5ef6\u8fdf\u7684 Client Request Duration \uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u540c\u6837\u5730\uff0c\u6211\u4eec\u53ef\u4ee5\u6ce8\u5165\u4e00\u4e2a\u4e2d\u6b62\u3002\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4e3a\u53d1\u9001\u5230\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u768450\uff05\u7684\u8bf7\u6c42\u6ce8\u5165\u4e00\u4e2a HTTP 5000 productcatalogserviceabort.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: productcatalogservice spec: hosts: - productcatalogservice http: - route: - destination: host: productcatalogservice fault: abort: percentage: value: 50 httpStatus: 500 $ kubectl apply -f 7productcatalogserviceabort.yaml virtualservice.networking.istio.io/productcatalogservice created $ kubectl get vs NAME GATEWAYS HOSTS AGE frontend [\"frontend.default.svc.cluster.local\"] 28h frontend-ingress [\"frontend-gateway\"] [\"*\"] 28h productcatalogservice [\"productcatalogservice\"] 12s recommendationservice [\"recommendationservice\"] 11m \u5982\u679c\u6211\u4eec\u5237\u65b0\u51e0\u6b21\u4ea7\u54c1\u9875\u9762\uff0c\u6211\u4eec\u5e94\u8be5\u5f97\u5230\u5982\u4e0b\u56fe\u6240\u793a\u7684\u9519\u8bef\u4fe1\u606f\u3002 \u8bf7\u6ce8\u610f\uff0c\u9519\u8bef\u4fe1\u606f\u8bf4\uff0c\u5931\u8d25\u7684\u539f\u56e0\u662f\u6545\u969c\u8fc7\u6ee4\u5668\u4e2d\u6b62\u3002\u5982\u679c\u6211\u4eec\u6253\u5f00Grafana ( istioctl dash grafana )\uff0c\u6211\u4eec\u4e5f\u4f1a\u6ce8\u610f\u5230\u56fe\u4e2d\u62a5\u544a\u7684\u9519\u8bef\u3002 6\u3001\u5f39\u6027 \u4e3a\u4e86\u6f14\u793a\u5f39\u6027\u529f\u80fd\uff0c\u6211\u4eec\u5c06\u5728\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u90e8\u7f72\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a EXTRA LATENCY \u7684\u73af\u5883\u53d8\u91cf\u3002\u8fd9\u4e2a\u53d8\u91cf\u4f1a\u5728\u6bcf\u6b21\u8c03\u7528\u670d\u52a1\u65f6\u6ce8\u5165\u4e00\u4e2a\u989d\u5916\u7684\u4f53\u7720\u3002 \u901a\u8fc7\u8fd0\u884c kubectl edit deploy productcatalogservice \u6765\u7f16\u8f91\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u90e8\u7f72\u3002 \u8fd9\u5c06\u6253\u5f00\u4e00\u4e2a\u7f16\u8f91\u5668\u3002\u6eda\u52a8\u5230\u6709\u73af\u5883\u53d8\u91cf\u7684\u90e8\u5206\uff0c\u6dfb\u52a0 EXTRA_LATENCY \u73af\u5883\u53d8\u91cf\u3002 ... spec: containers: - env: - name: EXTRA_LATENCY value: 6s ... $ kubectl edit deploy productcatalogservice deployment.apps/productcatalogservice edited \u4fdd\u5b58\u5e76\u63a8\u51fa\u7f16\u8f91\u5668\u3002 \u5982\u679c\u6211\u4eec\u5237\u65b0\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u9875\u9762\u9700\u89816\u79d2\u7684\u65f6\u95f4\u6765\u52a0\u8f7d\u2014\u2014\u90a3\u662f\u7531\u4e8e\u6211\u4eec\u6ce8\u5165\u7684\u5ef6\u8fdf\u3002 \u8ba9\u6211\u4eec\u7ed9\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u6dfb\u52a0\u4e00\u4e2a2\u79d2\u7684\u8d85\u65f6\u3002 productcatalogservice-timeout.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: productcatalogservice spec: hosts: - productcatalogservice http: - route: - destination: host: productcatalogservice timeout: 2s \u5982\u679c\u6211\u4eec\u5237\u65b0\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u4e00\u4e2a\u9519\u8bef\u4fe1\u606f\u7684\u51fa\u73b0 $ kubectl apply -f 8productcatalogservice-timeout.yaml virtualservice.networking.istio.io/productcatalogservice created $ kubectl get vs NAME GATEWAYS HOSTS AGE frontend [\"frontend.default.svc.cluster.local\"] 29h frontend-ingress [\"frontend-gateway\"] [\"*\"] 18m productcatalogservice [\"productcatalogservice\"] 18s \u8be5\u9519\u8bef\u8868\u660e\u5bf9\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u7684\u8bf7\u6c42\u8d85\u65f6\u4e86\u3002\u6211\u4eec\u4fee\u6539\u4e86\u670d\u52a1\uff0c\u589e\u52a0\u4e866\u79d2\u7684\u5ef6\u8fdf\uff0c\u5e76\u5c06\u8d85\u65f6\u8bbe\u7f6e\u4e3a2\u79d2\u3002 \u8ba9\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u91cd\u8bd5\u7b56\u7565\uff0c\u6709\u4e09\u6b21\u5c1d\u8bd5\uff0c\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u4e3a1\u79d2\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: productcatalogservice spec: hosts: - productcatalogservice http: - route: - destination: host: productcatalogservice retries: attempts: 3 perTryTimeout: 1s $ kubectl apply -f 9productcatalogservice-att.yaml virtualservice.networking.istio.io/productcatalogservice configured \u7531\u4e8e\u6211\u4eec\u5728\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u90e8\u7f72\u4e2d\u7559\u4e0b\u4e86\u989d\u5916\u7684\u5ef6\u8fdf\uff0c\u6211\u4eec\u4ecd\u7136\u4f1a\u770b\u5230\u9519\u8bef\u3002\u8ba9\u6211\u4eec\u6253\u5f00 Zipkin \u4e2d\u7684\u8ffd\u8e2a\uff0c\u770b\u770b\u91cd\u8bd5\u7b56\u7565\u7684\u4f5c\u7528\u3002 \u4f7f\u7528 istioctl dash zipkin \u6765\u6253\u5f00Zipkin\u4eea\u8868\u76d8\u3002\u70b9\u51fb\u5341\u6309\u94ae\uff0c\u9009\u62e9 serviceName \u548c frontend.default \u3002\u4e3a\u4e86\u53ea\u5f97\u5230\u81f3\u5c11\u4e00\u79d2\u949f\u7684\u54cd\u5e94\uff08\u8fd9\u5c31\u662f\u6211\u4eec\u7684 perTryTimeout )\uff0c\u9009\u62e9 minDuration \uff0c\u5728\u6587\u672c\u6846\u4e2d\u8f93\u51651s\u3002\u70b9\u51fb\u641c\u7d22\u6309\u94ae\uff0c\u663e\u793a\u6240\u6709\u8ffd\u8e2a\u3002 \u70b9\u51fbFilter\u6309\u94ae \uff0c\u4ece\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9 productCatalogService.default \u3002\u4f60\u5e94\u8be5\u770b\u5230\u82b1\u4e861\u79d2\u949f\u7684trace\u3002\u8fd9\u4e9btrace\u5bf9\u5e94\u4e8e\u6211\u4eec\u4e4b\u524d\u5b9a\u4e49\u7684 perTryTimeout","title":"\u7b2c\u4e5d\u8282 \u5b9e\u9645\u6848\u4f8b"},{"location":"chap8/9Istio_real_instance/#_1","text":"\u5728\u672c\u6a21\u5757\u4e2d\uff0c\u6211\u4eec\u5c06\u90e8\u7f72\u540d\u4e3a Online Boutique \u7684\u5fae\u670d\u52a1\u6f14\u793a\u5e94\u7528\u7a0b\u5e8f\uff0c\u8bd5\u7528Istio\u7684\u4e0d\u540c\u529f\u80fd Online Boutique \u662f\u4e00\u4e2a\u4e91\u539f\u751f\u5fae\u670d\u52a1\u6f14\u793a\u5e94\u7528\u7a0b\u5e8f\u3002 Online Boutique \u662f\u4e00\u4e2a\u753110\u4e2a\u5fae\u670d \u52a1\u7ec4\u6210\u7684\u5e94\u7528\u3002\u8be5\u5e94\u7528\u662f\u4e00\u4e2a\u57fa\u4e8eWeb\u7684\u7535\u5b50\u5546\u52a1\u5e94\u7528\uff0c\u7528\u6237\u53ef\u4ee5\u6d4f\u89c8\u5546\u54c1\uff0c\u5c06\u5176\u6dfb\u52a0\u5230\u8d2d\u7269\u8f66\uff0c\u5e76\u8d2d\u4e70\u5546\u54c1\u3002 Deploy microservices demo application(Online Boutique) Demonstrate how to use lstio features; Traffic routing Fault injection Resiliency","title":"\u7b2c\u4e5d\u8282 \u5b9e\u9645\u6848\u4f8b"},{"location":"chap8/9Istio_real_instance/#1","text":"\u6211\u4eec\u5c06\u4f7f\u7528\u8c37\u6b4c\u4e91\u5e73\u53f0\u6765\u6258\u7ba1Kubernetes\u96c6\u7fa4\u3002\u6253\u5f00\u5e76\u767b\u5f55\u5230\u4f60\u7684GCP\u63a7\u5236\u53f0\u8d26\u6237\uff0c\u5e76\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u521b\u5efa\u4e00\u4e2aKubernetes\u96c6\u7fa4\u3002 1\uff0e\u4ece\u5bfc\u822a\u4e2d\uff0c\u9009\u62e9Kubernetes Engine 2\uff0e\u70b9\u51fb\u521b\u5efa\u96c6\u7fa4\u3002 3\uff0e\u5c06\u96c6\u7fa4\u547d\u540d\u4e3a Boutique-demo 4\uff0e\u9009\u62e9\u533a\u57df\u9009\u9879\uff0c\u9009\u62e9\u6700\u63a5\u8fd1\u4f60\u7684\u4f4d\u7f6e\u7684\u533a\u57df\u3002 5\uff0e\u70b9\u51fb default-pool \uff0c\u5728\u8282\u70b9\u6570\u4e2d\u8f93\u51655 6\uff0e\u70b9\u51fbNodes\uff08\u8282\u70b9\uff09\u3002 7\uff0e\u70b9\u51fb\u673a\u5668\u914d\u7f6e\u673a\u5668\u7c7b\u578b\u4e0b\u62c9\uff0c\u9009\u62e9 e2-medium (2 vCPU, 4 GB memory)\u3002 8\uff0e\u70b9\u51fb\u201dCreate\u201d\u6765\u521b\u5efa\u96c6\u7fa4\u3002 \u96c6\u7fa4\u7684\u521b\u5efa\u5c06\u9700\u8981\u51e0\u5206\u949f\u7684\u65f6\u95f4\u3002\u4e00\u65e6\u5b89\u88c5\u5b8c\u6210\uff0c\u96c6\u7fa4\u5c06\u663e\u793a\u5728\u5217\u8868\u4e2d\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u4f60\u4e5f\u53ef\u4ee5\u5c06Online Boutique\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u6258\u7ba1\u5728\u5176\u4ed6\u4e91\u5e73\u53f0\u4e0a\u7684Ku bernetes\u96c6 \u7fa4\uff0c\u5982Azure\u6216AWS\u3002","title":"1\u3001\u521b\u5efa\u96c6\u7fa4"},{"location":"chap8/9Istio_real_instance/#_2","text":"\u6211\u4eec\u6709\u4e24\u79cd\u65b9\u5f0f\u6765\u8bbf\u95ee\u96c6\u7fa4\u3002\u6211\u4eec\u53ef\u4ee5\u4ece\u6d4f\u89c8\u5668\u4e2d\u4f7f\u7528Cloud Shell\u3002\u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u70b9\u51fb\u96c6 \u7fa4\u65c1\u8fb9\u7684Connect\uff0c\u7136\u540e\u70b9\u51fbRun in Cloud Shell\u6309\u94ae\u3002\u70b9\u51fb\u8be5\u6309\u94ae\u53ef\u4ee5\u6253\u5f00Cloud Shell\uff0c\u5e76\u914d\u7f6eKubernetes CLI\u6765\u8bbf\u95ee\u8be5\u96c6\u7fa4\u3002 \u7b2c\u4e8c\u4e2a\u9009\u62e9\u662f\u5728\u4f60\u7684\u7535\u8111\u4e0a\u5b89\u88c5gcloud CLI\uff0c\u7136\u540e\u4ece\u4f60\u7684\u7535\u8111\u4e0a\u8fd0\u884c\u76f8\u540c\u7684\u547d\u4ee4\u3002","title":"\u8bbf\u95ee\u96c6\u7fa4"},{"location":"chap8/9Istio_real_instance/#2istio","text":"\u5b89\u88c5Istlo \u6211\u4eec\u5c06\u4f7f\u7528GetMesh CLI\u5728\u96c6\u7fa4\u4e2d\u5b89\u88c5 Istio 1.1O.3 \u3002 1\uff0e\u4e0b\u8f7dGetMesh CLI: curl -sL https://istio.tetratelabs.io/getmesh/install.sh | bash 2\uff0e\u5b89\u88c5Istio: istioctl install --set profile=demo \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u7ed9\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u8bbe\u7f6e\u4e0a istio-injection=enabled \u6807\u7b7e\uff1a kubectl label namespace default istio-injection=enabled","title":"2\u3001\u5b89\u88c5Istio"},{"location":"chap8/9Istio_real_instance/#3online-boutique","text":"\u5728\u96c6\u7fa4\u548cIstio\u51c6\u5907\u597d\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u514b\u9686\u5728 Online Boutique \u5e94\u7528\u5e93\u3002","title":"3\u3001\u90e8\u7f72Online Boutique \u5e94\u7528"},{"location":"chap8/9Istio_real_instance/#3-1","text":"git clone https://github.com/GoogleCloudPlatform/microservices-demo.git","title":"3-1 \u514b\u9686\u4ed3\u5e93"},{"location":"chap8/9Istio_real_instance/#3-2-microservices-demo","text":"cd microservices-demo","title":"3-2 \u524d\u5f80microservices-demo\u76ee\u5f55"},{"location":"chap8/9Istio_real_instance/#3-3-kubernetes","text":"kubectl apply -f release/kubernetes-manifests.yaml","title":"3-3 \u521b\u5efaKubernetes\u8d44\u6e90\uff1a"},{"location":"chap8/9Istio_real_instance/#3-4-pod","text":"$ kubectl get pods NAME READY STATUS RESTARTS AGE adservice-5c9c7c997f-n627f 2/2 Running 0 2m15s cartservice-6d99678dd6-767fb 2/2 Running 2 2m16s checkoutservice-779cb9bfdf-l2rs9 2/2 Running 0 2m18s currencyservice-5db6c7d559-9drtc 2/2 Running 0 2m16s emailservice-5c47dc87bf-dk7qv 2/2 Running 0 2m18s frontend-5fcb8cdcdc-8c9dk 2/2 Running 0 2m17s loadgenerator-79bff5bd57-q9qkd 2/2 Running 4 2m16s paymentservice-6564cb7fb9-f6dwr 2/2 Running 0 2m17s productcatalogservice-5db9444549-hkzv7 2/2 Running 0 2m17s recommendationservice-ff6878cf5-jsghw 2/2 Running 0 2m18s redis-cart-57bd646894-zb7ch 2/2 Running 0 2m15s shippingservice-f47755f97-dk7k9 2/2 Running 0 2m15s","title":"3-4 \u68c0\u67e5\u6240\u6709Pod\u90fd\u5728\u8fd0\u884c\uff1a"},{"location":"chap8/9Istio_real_instance/#3-5-istio","text":"kubectl apply -f ./istio-maifest \u90e8\u7f72\u4e86\u4e00\u5207\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5f97\u5230\u5165\u53e3\u7f51\u5173\u7684IP\u5730\u5740\u5e76\u6253\u5f00\u524d\u7aef\u670d\u52a1\uff1a INGRESS_HOST=\"$(kubectl -n istio-system get service istio-ingressgateway \\ -o jsonpath='{.status.loadBalancer.ingress[0].ip}')\" echo \"$INGRESS_HOST\" \u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 INGRESS_HOST \uff0c\u4f60\u4f1a\u770b\u5230\u524d\u7aef\u670d\u52a1\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u6211\u4eec\u9700\u8981\u505a\u7684\u6700\u540e\u4e00\u4ef6\u4e8b\u662f\u5220\u9664 frontend-external \u670d\u52a1\u3002 frontend-external \u670d\u52a1\u662f\u4e00\u4e2a LoadBalancer \u670d\u52a1\uff0c\u5b83\u66b4\u9732\u4e86\u524d\u7aef\u3002\u7531\u4e8e\u6211\u4eec\u6b63\u5728\u4f7f\u7528Istio\u7684\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u4e0d\u518d\u9700\u8981\u8fd9\u4e2aLoadBalancer\u670d\u52a1\u4e86\u3002 \u5220\u9664\u670d\u52a1\uff0c\u8fd0\u884c\uff1a kubectl delete svc frontend-external Online Boutique \u5e94\u7528\u6e05\u5355\u8fd8\u5305\u62ec\u4e00\u4e2a\u8d1f\u8f7d\u53d1\u751f\u5668\uff0c\u5b83\u6b63\u5728\u751f\u6210\u5bf9\u6240\u6709\u670d\u52a1\u7684\u8bf7\u6c42\u2015\u8fd9\u662f\u4e3a\u4e86\u8ba9\u6211\u4eec\u80fd\u591f\u6a21\u62df\u7f51\u7ad9\u7684\u6d41\u91cf\u3002 $ istioctl dashboard kiali http://localhost:20001/kiali","title":"3-5 \u521b\u5efaIstio\u8d44\u6e90\uff1a"},{"location":"chap8/9Istio_real_instance/#4","text":"\u6211\u4eec\u5df2\u7ecf\u5efa\u7acb\u4e86\u4e00\u4e2a\u65b0\u7684Docker\u955c\u50cf\uff0c\u5b83\u4f7f\u7528\u4e86\u4e0e\u5f53\u524d\u8fd0\u884c\u7684\u524d\u7aef\u670d\u52a1\u4e0d\u540c\u7684\u6807\u5934\u3002\u8ba9\u6211\u4eec\u770b\u770b\u5982\u4f55\u90e8\u7f72\u6240\u9700\u7684\u8d44\u6e90\u5e76\u5c06\u4e00\u5b9a\u6bd4\u4f8b\u7684\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684\u524d\u7aef\u670d\u52a1\u7248\u672c\u3002 \u5728\u6211\u4eec\u521b\u5efa\u4efb\u4f55\u8d44\u6e90\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u5220\u9664\u73b0\u6709\u7684\u524d\u7aef\u90e8\u7f72\uff08 kubectl delete deploy frontend )\uff0c\u5e76\u521b\u5efa\u4e00\u4e2a\u7248\u672c\u6807\u7b7e\u8bbe\u7f6e\u4e3a original \u3002 $ kubectl delete deploy frontend deployment.apps \"frontend\" deleted $ curl localhost no healthy upstream 1frontendoriginal.yaml apiVersion: apps/v1 kind: Deployment metadata: name: frontend spec: selector: matchLabels: app: frontend version: original template: metadata: labels: app: frontend version: original annotations: sidecar.istio.io/rewriteAppHTTPProbers: \"true\" spec: containers: - name: server image: gcr.io/google-samples/microservices-demo/frontend:v0.2.1 ports: - containerPort: 8080 readinessProbe: initialDelaySeconds: 10 httpGet: path: \"/_healthz\" port: 8080 httpHeaders: - name: \"Cookie\" value: \"shop_session-id=x-readiness-probe\" livenessProbe: initialDelaySeconds: 10 httpGet: path: \"/_healthz\" port: 8080 httpHeaders: - name: \"Cookie\" value: \"shop_session-id=x-liveness-probe\" env: - name: PORT value: \"8080\" - name: PRODUCT_CATALOG_SERVICE_ADDR value: \"productcatalogservice:3550\" - name: CURRENCY_SERVICE_ADDR value: \"currencyservice:7000\" - name: CART_SERVICE_ADDR value: \"cartservice:7070\" - name: RECOMMENDATION_SERVICE_ADDR value: \"recommendationservice:8080\" - name: SHIPPING_SERVICE_ADDR value: \"shippingservice:50051\" - name: CHECKOUT_SERVICE_ADDR value: \"checkoutservice:5050\" - name: AD_SERVICE_ADDR value: \"adservice:9555\" - name: ENV_PLATFORM value: \"gcp\" resources: requests: cpu: 100m memory: 64Mi limits: cpu: 200m memory: 128Mi \u73b0\u5728\u6211\u4eec\u51c6\u5907\u521b\u5efa\u4e00\u4e2a DestinationRule \uff0c\u5b9a\u4e49\u4e24\u4e2a\u7248\u672c\u7684\u524d\u7aef\u2014\u2014\u73b0\u6709\u7684original\u548c\u65b0\u7684\uff08v1)\u3002 frontenddr.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: frontend spec: host: frontend.default.svc.cluster.local subsets: - name: original labels: version: original - name: v1 labels: version: 1.0.0 $ kubectl apply -f 2frontenddr.yaml destinationrule.networking.istio.io/frontend created \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u66f4\u65b0VirtualService\uff0c\u5e76\u6307\u5b9a\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u7684\u5b50\u96c6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5c06\u628a\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u539f\u59cb\u7248\u672c\u7684\u524d\u7aef\u3002 3frontendvs.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: frontend-ingress spec: hosts: - '*' gateways: - frontend-gateway http: - route: - destination: host: frontend port: number: 80 subset: original $ kubectl apply -f 3frontendvs.yaml virtualservice.networking.istio.io/frontend-ingress configured \u73b0\u5728\u6211\u4eec\u5c06\u65b0\u521b\u5efa\u65b0\u7684 VirtualService \u914d\u7f6e\u4e3a\u5c06\u6240\u6709\u8fdb\u5165\u7684\u6d41\u91cf\u8def\u7531\u5230original\u5b50\u96c6\uff0c\u6211\u4eec\u53ef\u4ee5\u5b89\u5168\u5730\u521b\u5efa\u65b0\u7684\u524d\u7aef\u90e8\u7f72 apiVersion: apps/v1 kind: Deployment metadata: name: frontend-v1 spec: selector: matchLabels: app: frontend version: 1.0.0 template: metadata: labels: app: frontend version: 1.0.0 annotations: sidecar.istio.io/rewriteAppHTTPProbers: \"true\" spec: containers: - name: server image: gcr.io/tetratelabs/boutique-frontend:1.0.0 ports: - containerPort: 8080 readinessProbe: initialDelaySeconds: 10 httpGet: path: \"/_healthz\" port: 8080 httpHeaders: - name: \"Cookie\" value: \"shop_session-id=x-readiness-probe\" livenessProbe: initialDelaySeconds: 10 httpGet: path: \"/_healthz\" port: 8080 httpHeaders: - name: \"Cookie\" value: \"shop_session-id=x-liveness-probe\" env: - name: PORT value: \"8080\" - name: PRODUCT_CATALOG_SERVICE_ADDR value: \"productcatalogservice:3550\" - name: CURRENCY_SERVICE_ADDR value: \"currencyservice:7000\" - name: CART_SERVICE_ADDR value: \"cartservice:7070\" - name: RECOMMENDATION_SERVICE_ADDR value: \"recommendationservice:8080\" - name: SHIPPING_SERVICE_ADDR value: \"shippingservice:50051\" - name: CHECKOUT_SERVICE_ADDR value: \"checkoutservice:5050\" - name: AD_SERVICE_ADDR value: \"adservice:9555\" - name: ENV_PLATFORM value: \"gcp\" resources: requests: cpu: 100m memory: 64Mi limits: cpu: 200m memory: 128Mi $ kubectl apply -f 4frontendv1.yaml deployment.apps/frontend-v1 created $ kubectl get pod | grep front frontend-8658d97d64-rbwjw 2/2 Running 0 16m frontend-v1-664f8ff6c6-lvnwr 2/2 Running 0 61s \u5982\u679c\u6211\u4eec\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 VirtualService\u4e2d\u7684\u6743\u91cd INGRESS_HOST , \u6211\u4eec\u4ecd\u7136\u4f1a\u770b\u5230\u539f\u59cb\u7248\u672c\u7684\u524d\u7aef\u3002\u8ba9\u6211\u4eec\u66f4\u65b0\uff0c\u5f00\u59cb\u5c0630\uff05\u7684\u6d41\u91cf\u8def\u7531\u5230 v1 \u7684\u5b50\u96c6\u3002 5frontend.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: frontend-ingress spec: hosts: - '*' gateways: - frontend-gateway http: - route: - destination: host: frontend port: number: 80 subset: original weight: 70 - destination: host: frontend port: number: 80 subset: v1 weight: 30 $ kubectl apply -f 5frontend30.yaml virtualservice.networking.istio.io/frontend-ingress configured \u5982\u679c\u6211\u4eec\u5237\u65b0\u51e0\u6b21\u7f51\u9875\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u6765\u81ea\u524d\u7aefv1\u7684\u66f4\u65b0\u6807\u5934","title":"4\u3001\u8def\u7531\u6d41\u91cf"},{"location":"chap8/9Istio_real_instance/#5","text":"\u5728\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u4e3a\u63a8\u8350\u670d\u52a1\u5f15\u51655\u79d2\u7684\u5ef6\u8fdf\u3002Envoy\u5c06\u4e3a50\uff05\u7684\u8bf7\u6c42\u6ce8\u5165\u5ef6\u8fdf\u3002 recommendationdelay.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: recommendationservice spec: hosts: - recommendationservice http: - route: - destination: host: recommendationservice fault: delay: percentage: value: 50 fixedDelay: 5s $ kubectl get vs NAME GATEWAYS HOSTS AGE frontend [\"frontend.default.svc.cluster.local\"] 28h frontend-ingress [\"frontend-gateway\"] [\"*\"] 28h recommendationservice [\"recommendationservice\"] 84s \u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 INGRESS_HOST \uff0c\u7136\u540e\u70b9\u51fb\u5176\u4e2d\u4e00\u4e2a\u4ea7\u54c1\u3002\u63a8\u8350\u670d\u52a1\u7684\u7ed3\u679c\u663e\u793a\u5728\u5c4f\u5e55\u5e95\u90e8\u7684\u201dOther Products You Might Light\u201c\u90e8\u5206\u3002 \u5982\u679c\u6211\u4eec\u5237\u65b0\u51e0\u6b21\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\uff0c\u8be5\u9875\u9762\u8981\u4e48\u7acb\u5373\u52a0\u8f7d\uff0c\u8981\u4e48\u6709\u4e00\u4e2a\u5ef6\u8fdf\u52a0\u8f7d\u9875\u9762\u3002\u8fd9\u4e2a\u5ef6\u8fdf\u662f\u7531\u4e8e\u6211\u4eec\u6ce8\u5165\u4e865\u79d2\u7684\u5ef6\u8fdf \u3002 \u6211\u4eec\u53ef\u4ee5\u6253\u5f00Grafana ( istioctl dash grafana )\u548cIstio\u670d\u52a1\u4eea\u8868\u677f\u3002\u786e\u4fdd\u4ece\u670d\u52a1\u5217\u8868\u4e2d\u9009\u62e9 recommendationsservice \uff0c\u5728Reporter\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9source\uff0c\u5e76\u67e5\u770b\u663e\u793a\u5ef6\u8fdf\u7684 Client Request Duration \uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u540c\u6837\u5730\uff0c\u6211\u4eec\u53ef\u4ee5\u6ce8\u5165\u4e00\u4e2a\u4e2d\u6b62\u3002\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4e3a\u53d1\u9001\u5230\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u768450\uff05\u7684\u8bf7\u6c42\u6ce8\u5165\u4e00\u4e2a HTTP 5000 productcatalogserviceabort.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: productcatalogservice spec: hosts: - productcatalogservice http: - route: - destination: host: productcatalogservice fault: abort: percentage: value: 50 httpStatus: 500 $ kubectl apply -f 7productcatalogserviceabort.yaml virtualservice.networking.istio.io/productcatalogservice created $ kubectl get vs NAME GATEWAYS HOSTS AGE frontend [\"frontend.default.svc.cluster.local\"] 28h frontend-ingress [\"frontend-gateway\"] [\"*\"] 28h productcatalogservice [\"productcatalogservice\"] 12s recommendationservice [\"recommendationservice\"] 11m \u5982\u679c\u6211\u4eec\u5237\u65b0\u51e0\u6b21\u4ea7\u54c1\u9875\u9762\uff0c\u6211\u4eec\u5e94\u8be5\u5f97\u5230\u5982\u4e0b\u56fe\u6240\u793a\u7684\u9519\u8bef\u4fe1\u606f\u3002 \u8bf7\u6ce8\u610f\uff0c\u9519\u8bef\u4fe1\u606f\u8bf4\uff0c\u5931\u8d25\u7684\u539f\u56e0\u662f\u6545\u969c\u8fc7\u6ee4\u5668\u4e2d\u6b62\u3002\u5982\u679c\u6211\u4eec\u6253\u5f00Grafana ( istioctl dash grafana )\uff0c\u6211\u4eec\u4e5f\u4f1a\u6ce8\u610f\u5230\u56fe\u4e2d\u62a5\u544a\u7684\u9519\u8bef\u3002","title":"5\u3001\u6545\u969c\u6ce8\u5165"},{"location":"chap8/9Istio_real_instance/#6","text":"\u4e3a\u4e86\u6f14\u793a\u5f39\u6027\u529f\u80fd\uff0c\u6211\u4eec\u5c06\u5728\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u90e8\u7f72\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a EXTRA LATENCY \u7684\u73af\u5883\u53d8\u91cf\u3002\u8fd9\u4e2a\u53d8\u91cf\u4f1a\u5728\u6bcf\u6b21\u8c03\u7528\u670d\u52a1\u65f6\u6ce8\u5165\u4e00\u4e2a\u989d\u5916\u7684\u4f53\u7720\u3002 \u901a\u8fc7\u8fd0\u884c kubectl edit deploy productcatalogservice \u6765\u7f16\u8f91\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u90e8\u7f72\u3002 \u8fd9\u5c06\u6253\u5f00\u4e00\u4e2a\u7f16\u8f91\u5668\u3002\u6eda\u52a8\u5230\u6709\u73af\u5883\u53d8\u91cf\u7684\u90e8\u5206\uff0c\u6dfb\u52a0 EXTRA_LATENCY \u73af\u5883\u53d8\u91cf\u3002 ... spec: containers: - env: - name: EXTRA_LATENCY value: 6s ... $ kubectl edit deploy productcatalogservice deployment.apps/productcatalogservice edited \u4fdd\u5b58\u5e76\u63a8\u51fa\u7f16\u8f91\u5668\u3002 \u5982\u679c\u6211\u4eec\u5237\u65b0\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u9875\u9762\u9700\u89816\u79d2\u7684\u65f6\u95f4\u6765\u52a0\u8f7d\u2014\u2014\u90a3\u662f\u7531\u4e8e\u6211\u4eec\u6ce8\u5165\u7684\u5ef6\u8fdf\u3002 \u8ba9\u6211\u4eec\u7ed9\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u6dfb\u52a0\u4e00\u4e2a2\u79d2\u7684\u8d85\u65f6\u3002 productcatalogservice-timeout.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: productcatalogservice spec: hosts: - productcatalogservice http: - route: - destination: host: productcatalogservice timeout: 2s \u5982\u679c\u6211\u4eec\u5237\u65b0\u9875\u9762\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u4e00\u4e2a\u9519\u8bef\u4fe1\u606f\u7684\u51fa\u73b0 $ kubectl apply -f 8productcatalogservice-timeout.yaml virtualservice.networking.istio.io/productcatalogservice created $ kubectl get vs NAME GATEWAYS HOSTS AGE frontend [\"frontend.default.svc.cluster.local\"] 29h frontend-ingress [\"frontend-gateway\"] [\"*\"] 18m productcatalogservice [\"productcatalogservice\"] 18s \u8be5\u9519\u8bef\u8868\u660e\u5bf9\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u7684\u8bf7\u6c42\u8d85\u65f6\u4e86\u3002\u6211\u4eec\u4fee\u6539\u4e86\u670d\u52a1\uff0c\u589e\u52a0\u4e866\u79d2\u7684\u5ef6\u8fdf\uff0c\u5e76\u5c06\u8d85\u65f6\u8bbe\u7f6e\u4e3a2\u79d2\u3002 \u8ba9\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u91cd\u8bd5\u7b56\u7565\uff0c\u6709\u4e09\u6b21\u5c1d\u8bd5\uff0c\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u4e3a1\u79d2\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: productcatalogservice spec: hosts: - productcatalogservice http: - route: - destination: host: productcatalogservice retries: attempts: 3 perTryTimeout: 1s $ kubectl apply -f 9productcatalogservice-att.yaml virtualservice.networking.istio.io/productcatalogservice configured \u7531\u4e8e\u6211\u4eec\u5728\u4ea7\u54c1\u76ee\u5f55\u670d\u52a1\u90e8\u7f72\u4e2d\u7559\u4e0b\u4e86\u989d\u5916\u7684\u5ef6\u8fdf\uff0c\u6211\u4eec\u4ecd\u7136\u4f1a\u770b\u5230\u9519\u8bef\u3002\u8ba9\u6211\u4eec\u6253\u5f00 Zipkin \u4e2d\u7684\u8ffd\u8e2a\uff0c\u770b\u770b\u91cd\u8bd5\u7b56\u7565\u7684\u4f5c\u7528\u3002 \u4f7f\u7528 istioctl dash zipkin \u6765\u6253\u5f00Zipkin\u4eea\u8868\u76d8\u3002\u70b9\u51fb\u5341\u6309\u94ae\uff0c\u9009\u62e9 serviceName \u548c frontend.default \u3002\u4e3a\u4e86\u53ea\u5f97\u5230\u81f3\u5c11\u4e00\u79d2\u949f\u7684\u54cd\u5e94\uff08\u8fd9\u5c31\u662f\u6211\u4eec\u7684 perTryTimeout )\uff0c\u9009\u62e9 minDuration \uff0c\u5728\u6587\u672c\u6846\u4e2d\u8f93\u51651s\u3002\u70b9\u51fb\u641c\u7d22\u6309\u94ae\uff0c\u663e\u793a\u6240\u6709\u8ffd\u8e2a\u3002 \u70b9\u51fbFilter\u6309\u94ae \uff0c\u4ece\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9 productCatalogService.default \u3002\u4f60\u5e94\u8be5\u770b\u5230\u82b1\u4e861\u79d2\u949f\u7684trace\u3002\u8fd9\u4e9btrace\u5bf9\u5e94\u4e8e\u6211\u4eec\u4e4b\u524d\u5b9a\u4e49\u7684 perTryTimeout","title":"6\u3001\u5f39\u6027"},{"location":"chap9/1Istio_intro_ppt/","text":"\u7b2c\u4e00\u8282 istio\u6d45\u6790 (Slide\u5907\u6848\uff09 1\u3001istio\u7b80\u4ecb istio\u662f\u4e00\u4e2a\u5f00\u6e90\u670d\u52a1\u7f51\u683c\u5e73\u53f0\uff0c\u5b83\u53ef\u4ee5\u63a7\u5236\u5fae\u670d\u52a1\u4e4b\u95f4\u6570\u636e\u7684\u5171\u4eab\u65b9\u5f0f\uff0c\u5176\u9644\u5e26\u7684 API \u53ef\u4ee5\u5c06 Istio \u96c6\u6210\u5230\u4efb\u4f55\u65e5\u5fd7\u8bb0\u5f55\u5e73\u53f0\u3001\u9065\u6d4b\u6216\u7b56\u7565\u7cfb\u7edf\u4e2d \u3002 \u5728\u8bbe\u8ba1\u4e0a\uff0cIstio \u53ef\u4ee5\u5728\u591a\u79cd\u73af\u5883\u4e2d\u8fd0\u884c\uff1a\u4f01\u4e1a\u672c\u5730\u3001\u4e91\u6258\u7ba1\u3001Kubernetes\u5bb9\u5668\uff0c\u6216\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u670d\u52a1\u7b49\u3002 Istio \u63d0\u4f9b\u4e00\u79cd\u7b80\u5355\u7684\u65b9\u5f0f\u6765\u4e3a\u5df2\u90e8\u7f72\u7684\u670d\u52a1\u5efa\u7acb\u7f51\u7edc\uff0c\u8be5\u7f51\u7edc\u5177\u6709\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u95f4\u8ba4\u8bc1\u3001\u76d1\u63a7\u7b49\u529f\u80fd \uff0c \u53ea\u9700\u8981\u5bf9\u670d\u52a1\u7684\u4ee3\u7801\u8fdb\u884c\u4e00\u70b9\u6216\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u6539\u52a8\uff0c\u8ba9\u670d\u52a1\u652f\u6301 Istio\uff0c \u53ea\u9700\u8981\u5728\u73af\u5883\u4e2d\u90e8\u7f72\u4e00\u4e2a\u7279\u6b8a\u7684 sidecar \u4ee3\u7406\uff0c\u4f7f\u7528 Istio \u63a7\u5236\u5e73\u9762\u529f\u80fd\u914d\u7f6e\u548c\u7ba1\u7406\u4ee3\u7406\uff0c\u62e6\u622a\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1 \uff1a HTTP\u3001gRPC\u3001WebSocket \u548c TCP \u6d41\u91cf\u7684\u81ea\u52a8\u8d1f\u8f7d\u5747\u8861\u3002 \u901a\u8fc7\u4e30\u5bcc\u7684\u8def\u7531\u89c4\u5219\u3001\u91cd\u8bd5\u3001\u6545\u969c\u8f6c\u79fb\u548c\u6545\u969c\u6ce8\u5165\uff0c\u53ef\u4ee5\u5bf9\u6d41\u91cf\u884c\u4e3a\u8fdb\u884c\u7ec6\u7c92\u5ea6\u63a7\u5236 \u3002 \u53ef\u63d2\u5165\u7684\u7b56\u7565\u5c42\u548c\u914d\u7f6e API\uff0c\u652f\u6301\u8bbf\u95ee\u63a7\u5236\u3001\u901f\u7387\u9650\u5236\u548c\u914d\u989d\u3002 \u5bf9\u51fa\u5165\u96c6\u7fa4\u5165\u53e3\u548c\u51fa\u53e3\u4e2d\u6240\u6709\u6d41\u91cf\u7684\u81ea\u52a8\u5ea6\u91cf\u6307\u6807\u3001\u65e5\u5fd7\u8bb0\u5f55\u548c\u8ffd\u8e2a\u3002 \u901a\u8fc7\u5f3a\u5927\u7684\u57fa\u4e8e\u8eab\u4efd\u7684\u9a8c\u8bc1\u548c\u6388\u6743\uff0c\u5728\u96c6\u7fa4\u4e2d\u5b9e\u73b0\u5b89\u5168\u7684\u670d\u52a1\u95f4\u901a\u4fe1\u3002 2\u3001istio \u6846\u67b6 2-1 istio\u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 \u6570\u636e\u5e73\u9762 \u7531\u4e00\u7ec4\u667a\u80fd\u4ee3\u7406\uff08Envoy\uff09\u7ec4\u6210\uff0c\u88ab\u90e8\u7f72\u4e3a sidecar \u3002\u8fd9\u4e9b\u4ee3\u7406\u8d1f\u8d23\u534f\u8c03\u548c\u63a7\u5236\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1\u3002\u4ed6\u4eec\u8fd8\u6536\u96c6\u548c\u62a5\u544a\u6240\u6709\u7f51\u683c\u6d41\u91cf\u7684\u9065\u6d4b\u6570\u636e\u3002 \u63a7\u5236\u5e73\u9762 \u7ba1\u7406\u5e76\u914d\u7f6e\u4ee3\u7406\u6765\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002 istio \u4e2d\u7684\u6d41\u91cf\u5206\u4e3a\u6570\u636e\u5e73\u9762\u6d41\u91cf\u548c\u63a7\u5236\u5e73\u9762\u6d41\u91cf\u3002 \u6570\u636e\u5e73\u9762\u6d41\u91cf\u662f\u6307\u5de5\u4f5c\u8d1f\u8f7d\u7684\u4e1a\u52a1\u903b\u8f91\u53d1\u9001\u548c\u63a5\u6536\u7684\u6d88\u606f \u63a7\u5236\u5e73\u9762\u6d41\u91cf\u662f\u6307\u5728 Istio \u7ec4\u4ef6\u4e4b\u95f4\u53d1\u9001\u7684\u914d\u7f6e\u548c\u63a7\u5236\u6d88\u606f\u7528\u6765\u7f16\u6392\u7f51\u683c\u7684\u884c\u4e3a \u3002 Istio \u4e2d\u7684\u6d41\u91cf\u7ba1\u7406\u7279\u6307\u6570\u636e\u5e73\u9762\u6d41\u91cf\u3002 3\u3001Envoy Istio \u4f7f\u7528 Envoy \u4ee3\u7406\u7684\u6269\u5c55\u7248\u672c\u3002Envoy \u662f\u7528 C++ \u5f00\u53d1\u7684\u9ad8\u6027\u80fd\u4ee3\u7406\uff0c\u7528\u4e8e\u534f\u8c03\u670d\u52a1\u7f51\u683c\u4e2d\u6240\u6709\u670d\u52a1\u7684\u5165\u7ad9\u548c\u51fa\u7ad9\u6d41\u91cf\u3002 Envoy \u4ee3\u7406\u662f\u552f\u4e00\u4e0e\u6570\u636e\u5e73\u9762\u6d41\u91cf\u4ea4\u4e92\u7684 Istio \u7ec4\u4ef6 \u3002 Envoy \u4ee3\u7406\u88ab\u90e8\u7f72\u4e3a\u670d\u52a1\u7684 sidecar \uff0c\u5728\u903b\u8f91\u4e0a\u4e3a\u670d\u52a1\u589e\u52a0\u4e86 Envoy \u7684\u8bb8\u591a\u5185\u7f6e\u7279\u6027\uff0c\u4f8b\u5982: \u52a8\u6001\u670d\u52a1\u53d1\u73b0 \u8d1f\u8f7d\u5747\u8861 TLS \u7ec8\u7aef HTTP/2 \u4e0e gRPC \u4ee3\u7406 \u7194\u65ad\u5668 \u5065\u5eb7\u68c0\u67e5 \u57fa\u4e8e\u767e\u5206\u6bd4\u6d41\u91cf\u5206\u5272\u7684\u5206\u9636\u6bb5\u53d1\u5e03 \u6545\u969c\u6ce8\u5165 \u4e30\u5bcc\u7684\u6307\u6807 \u8fd9\u79cd sidecar \u90e8\u7f72\u5141\u8bb8 Istio \u63d0\u53d6\u5927\u91cf\u5173\u4e8e\u6d41\u91cf\u884c\u4e3a\u7684\u4fe1\u53f7\u4f5c\u4e3a\u5c5e\u6027\u3002 Istio \u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u5c5e\u6027\u6765\u5b9e\u65bd\u7b56\u7565\u51b3\u7b56\uff0c\u5e76\u5c06\u5176\u53d1\u9001\u5230\u76d1\u89c6\u7cfb\u7edf\u4ee5\u63d0\u4f9b\u6709\u5173\u6574\u4e2a\u7f51\u683c\u884c\u4e3a\u7684\u4fe1\u606f\u3002 sidecar \u4ee3\u7406\u6a21\u578b\u53ef\u4ee5\u5b9e\u73b0\u73b0\u6709\u7684\u90e8\u7f72\u6dfb\u52a0 Istio \u529f\u80fd\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u8bbe\u8ba1\u67b6\u6784\u6216\u91cd\u5199\u4ee3\u7801 \u3002 4\u3001Pilot Pilot \u4e3a Envoy sidecar \u63d0\u4f9b\u670d\u52a1\u53d1\u73b0\u3001\u7528\u4e8e\u667a\u80fd\u8def\u7531\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff08\u4f8b\u5982\uff0cA/B \u6d4b\u8bd5\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\uff09\u4ee5\u53ca\u5f39\u6027\u529f\u80fd\uff08\u8d85\u65f6\u3001\u91cd\u8bd5\u3001\u7194\u65ad\u5668\u7b49\uff09 \u3002 Pilot \u5c06\u63a7\u5236\u6d41\u91cf\u884c\u4e3a\u7684\u9ad8\u7ea7\u8def\u7531\u89c4\u5219\u8f6c\u6362\u4e3a\u7279\u5b9a\u4e8e\u73af\u5883\u7684\u914d\u7f6e\uff0c\u5e76\u5728\u8fd0\u884c\u65f6\u5c06\u5b83\u4eec\u4f20\u64ad\u5230 sidecar\u3002 Pilot \u5c06\u7279\u5b9a\u4e8e\u5e73\u53f0\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\u62bd\u8c61\u51fa\u6765\uff0c\u5e76\u5c06\u5b83\u4eec\u5408\u6210\u4e3a\u4efb\u4f55\u7b26\u5408 Envoy API \u7684 sidecar \u90fd\u53ef\u4ee5\u4f7f\u7528\u7684\u6807\u51c6\u683c\u5f0f\u3002 \u5e73\u53f0\u542f\u52a8\u4e00\u4e2a\u670d\u52a1\u7684\u65b0\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u901a\u77e5\u5176\u5e73\u53f0\u9002\u914d\u5668\u3002 \u5e73\u53f0\u9002\u914d\u5668\u4f7f\u7528 Pilot \u62bd\u8c61\u6a21\u578b\u6ce8\u518c\u5b9e\u4f8b\u3002 Pilot \u5c06\u6d41\u91cf\u89c4\u5219\u548c\u914d\u7f6e\u6d3e\u53d1\u7ed9 Envoy \u4ee3\u7406\uff0c\u6765\u4f20\u8fbe\u6b64\u6b21\u66f4\u6539 \u3002 \u8fd9\u79cd\u677e\u8026\u5408\u5141\u8bb8 Istio \u5728 Kubernetes\u3001Consul \u6216 Nomad \u7b49\u591a\u79cd\u73af\u5883\u4e2d\u8fd0\u884c\uff0c\u540c\u65f6\u7ef4\u62a4\u76f8\u540c\u7684 operator \u63a5\u53e3\u6765\u8fdb\u884c\u6d41\u91cf\u7ba1\u7406\u3002\u53ef\u4ee5\u4f7f\u7528 Istio \u7684\u6d41\u91cf\u7ba1\u7406 API \u6765\u6307\u793a Pilot \u4f18\u5316 Envoy \u914d\u7f6e\uff0c\u4ee5\u4fbf\u5bf9\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\u8fdb\u884c\u66f4\u7ec6\u7c92\u5ea6\u5730\u63a7\u5236\u3002 5\u3001Citadel Citadel \u901a\u8fc7\u5185\u7f6e\u7684\u8eab\u4efd\u548c\u8bc1\u4e66\u7ba1\u7406\uff0c\u53ef\u4ee5\u652f\u6301\u5f3a\u5927\u7684\u670d\u52a1\u5230\u670d\u52a1\u4ee5\u53ca\u6700\u7ec8\u7528\u6237\u7684\u8eab\u4efd\u9a8c\u8bc1\uff0c\u53ef\u4ee5\u4f7f\u7528 Citadel \u6765\u5347\u7ea7\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u672a\u52a0\u5bc6\u6d41\u91cf\uff0c \u4f7f\u7528 Citadel\uff0coperator \u53ef\u4ee5\u6267\u884c\u57fa\u4e8e\u670d\u52a1\u8eab\u4efd\u7684\u7b56\u7565\uff0c\u800c\u4e0d\u662f\u76f8\u5bf9\u4e0d\u7a33\u5b9a\u7684 3 \u5c42\u6216 4 \u5c42\u7f51\u7edc\u6807\u8bc6 \u3002 6\u3001Galley Galley \u662f Istio \u7684\u914d\u7f6e\u9a8c\u8bc1\u3001\u63d0\u53d6\u3001\u5904\u7406\u548c\u5206\u53d1\u7ec4\u4ef6 \u3002\u5b83\u8d1f\u8d23\u5c06\u5176\u4f59\u7684 Istio \u7ec4\u4ef6\u4e0e\u4ece\u5e95\u5c42\u5e73\u53f0\uff08\u4f8b\u5982 Kubernetes\uff09\u83b7\u53d6\u7528\u6237\u914d\u7f6e\u7684\u7ec6\u8282\u9694\u79bb\u5f00\u6765\u3002 7\u3001Istio\u8bbe\u8ba1\u76ee\u6807 \u51e0\u4e2a\u5173\u952e\u7684\u8bbe\u8ba1\u76ee\u6807\u5f62\u6210\u4e86 Istio \u7684\u67b6\u6784\u3002\u8fd9\u4e9b\u76ee\u6807\u5bf9\u4e8e\u4f7f\u7cfb\u7edf\u80fd\u591f\u5927\u89c4\u6a21\u548c\u9ad8\u6027\u80fd\u5730\u5904\u7406\u670d\u52a1\u662f\u81f3\u5173\u91cd\u8981\u7684\u3002 1. \u900f\u660e\u5ea6\u6700\u5927\u5316 \u4e3a\u4e86\u91c7\u7528 Istio\uff0c\u8fd0\u7ef4\u4eba\u5458\u6216\u5f00\u53d1\u4eba\u5458\u9700\u8981\u505a\u5c3d\u53ef\u80fd\u5c11\u7684\u5de5\u4f5c\uff0c\u624d\u80fd\u4ece\u7cfb\u7edf\u4e2d\u83b7\u5f97\u771f\u6b63\u7684\u4ef7\u503c\u3002\u4e3a\u6b64\uff0cIstio \u53ef\u4ee5\u81ea\u52a8\u5c06\u81ea\u5df1\u6ce8\u5165\u5230\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u8def\u5f84\u4e2d\u3002Istio \u4f7f\u7528 sidecar \u4ee3\u7406\u6765\u6355\u83b7\u6d41\u91cf\uff0c\u5e76\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u5728\u4e0d\u66f4\u6539\u5df2\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\uff0c\u81ea\u52a8\u5bf9\u7f51\u7edc\u5c42\u8fdb\u884c\u914d\u7f6e\uff0c\u4ee5\u5b9e\u73b0\u901a\u8fc7\u8fd9\u4e9b\u4ee3\u7406\u6765\u8def\u7531\u6d41\u91cf\u3002 \u5728 Kubernetes \u4e2d\uff0c\u4ee3\u7406\u88ab\u6ce8\u5165\u5230pods\u4e2d\uff0c\u901a\u8fc7\u7f16\u5199iptables\u89c4\u5219\u6765\u6355\u83b7\u6d41\u91cf\u3002 \u4e00\u65e6 sidecar \u4ee3\u7406\u88ab\u6ce8\u5165\u4ee5\u53ca\u6d41\u91cf\u8def\u7531\u88ab\u7f16\u7a0b\uff0cIstio \u5c31\u53ef\u4ee5\u534f\u8c03\u6240\u6709\u7684\u6d41\u91cf\u3002\u8fd9\u4e2a\u539f\u5219\u4e5f\u9002\u7528\u4e8e\u6027\u80fd \u3002\u5f53\u5c06 Istio \u5e94\u7528\u4e8e\u90e8\u7f72\u65f6\uff0c\u8fd0\u7ef4\u4eba\u5458\u4f1a\u770b\u5230\u6240\u63d0\u4f9b\u529f\u80fd\u7684\u8d44\u6e90\u6210\u672c\u589e\u52a0\u7684\u6700\u5c0f\u3002\u7ec4\u4ef6\u548c API \u7684\u8bbe\u8ba1\u5fc5\u987b\u8003\u8651\u5230\u6027\u80fd\u548c\u53ef\u4f38\u7f29\u6027\u3002 2 \u53ef\u6269\u5c55\u6027 \u968f\u7740\u8fd0\u7ef4\u4eba\u5458\u548c\u5f00\u53d1\u4eba\u5458\u8d8a\u6765\u8d8a\u4f9d\u8d56\u4e8e Istio \u63d0\u4f9b\u7684\u529f\u80fd\uff0c\u7cfb\u7edf\u5fc5\u987b\u968f\u7740\u4ed6\u4eec\u7684\u9700\u6c42\u800c\u589e\u957f\u3002 \u5728\u7ee7\u7eed\u6dfb\u52a0\u65b0\u7279\u6027\u65f6\uff0c\u6700\u5927\u7684\u9700\u6c42\u662f\u6269\u5c55\u7b56\u7565\u7cfb\u7edf\u7684\u80fd\u529b\uff0c\u4e0e\u5176\u4ed6\u7b56\u7565\u548c\u63a7\u5236\u6e90\u7684\u96c6\u6210\uff0c\u4ee5\u53ca\u5c06\u5173\u4e8e\u7f51\u683c\u884c\u4e3a\u7684\u4fe1\u53f7\u4f20\u64ad\u5230\u5176\u4ed6\u7cfb\u7edf\u8fdb\u884c\u5206\u6790\u7684\u80fd\u529b\u3002\u7b56\u7565\u8fd0\u884c\u65f6\u652f\u6301\u7528\u4e8e\u63a5\u5165\u5176\u4ed6\u670d\u52a1\u7684\u6807\u51c6\u6269\u5c55\u673a\u5236\u3002\u6b64\u5916\uff0c\u5b83\u5141\u8bb8\u6269\u5c55\u5176\u8bcd\u6c47\u8868\uff0c\u5141\u8bb8\u6839\u636e\u7f51\u683c\u751f\u6210\u7684\u65b0\u4fe1\u53f7\u6267\u884c\u7b56\u7565\u3002 3 \u53ef\u79fb\u690d\u6027 \u4f7f\u7528 Istio \u7684\u751f\u6001\u7cfb\u7edf\u5728\u8bb8\u591a\u65b9\u9762\u90fd\u6709\u6240\u4e0d\u540c\u3002Istio \u5fc5\u987b\u5728\u4efb\u4f55\u4e91\u73af\u5883\u6216\u672c\u5730\u73af\u5883\u4e2d\u901a\u8fc7\u6700\u5c0f\u7684\u52aa\u529b\u5c31\u80fd\u8fd0\u884c\u8d77\u6765\u3002\u5c06\u57fa\u4e8e Istio \u7684\u670d\u52a1\u79fb\u690d\u5230\u65b0\u73af\u5883\u7684\u4efb\u52a1\u5fc5\u987b\u662f\u5bb9\u6613\u5b9e\u73b0\u7684\u3002 \u4f7f\u7528 Istio\uff0c\u53ef\u4ee5\u64cd\u4f5c\u90e8\u7f72\u5230\u591a\u4e2a\u73af\u5883\u4e2d\u7684\u5355\u4e2a\u670d\u52a1\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u5728\u591a\u4e2a\u4e91\u4e0a\u90e8\u7f72\u6765\u5b9e\u73b0\u5197\u4f59\u3002 \u7b56\u7565\u4e00\u81f4\u6027\uff1a\u5c06\u7b56\u7565\u5e94\u7528\u4e8e\u670d\u52a1\u4e4b\u95f4\u7684 API \u8c03\u7528\u63d0\u4f9b\u4e86\u5bf9\u7f51\u683c\u884c\u4e3a\u7684\u5927\u91cf\u63a7\u5236\u3002\u7136\u800c\uff0c\u5c06\u7b56\u7565\u5e94\u7528\u5728\u533a\u522b\u4e8e API \u5c42\u4e0a\u7684\u8d44\u6e90\u4e5f\u540c\u6837\u91cd\u8981\u3002\u4f8b\u5982\uff0c\u5728\u673a\u5668\u5b66\u4e60\u8bad\u7ec3\u4efb\u52a1\u6d88\u8017\u7684 CPU \u6570\u91cf\u4e0a\u5e94\u7528\u914d\u989d\u6bd4\u5728\u53d1\u8d77\u4efb\u52a1\u7684\u8bf7\u6c42\u8c03\u7528\u4e0a\u5e94\u7528\u914d\u989d\u66f4\u6709\u7528\u3002\u4e3a\u6b64\uff0cIstio \u4f7f\u7528\u81ea\u5df1\u7684 API \u5c06\u7b56\u7565\u7cfb\u7edf\u7ef4\u62a4\u4e3a\u4e00\u4e2a\u72ec\u7acb\u7684\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u5c06\u7b56\u7565\u7cfb\u7edf\u96c6\u6210\u5230 sidecar \u4ee3\u7406\u4e2d\uff0c\u4ece\u800c\u5141\u8bb8\u670d\u52a1\u6839\u636e\u9700\u8981\u76f4\u63a5\u4e0e\u4e4b\u96c6\u6210\u3002 8\u3001istio\u7ec4\u4ef6\u8be6\u89e3 8-1 Istio\u7684sidecar\u4ee3\u7406 \u7f51\u7edc\u6a21\u578b\u53d1\u5c55 \u6211\u4eec\u56de\u987e\u8ba1\u7b97\u7f51\u7edc\u7684\u53d1\u5c55\u53f2\u3002\u5728\u5206\u7ec4\u4ea4\u6362\u7f51\u7edc\u7684\u51fa\u73b0\u540e\uff0c\u9700\u8981\u7528\u6237\u81ea\u5df1\u6765\u4f7f\u7528\u63e1\u624b\u3001\u91cd\u4f20\u548c\u56e0\u7279\u7f51\u5c06\u4e00\u5806\u6570\u636e\u5305\u8f6c\u6362\u4e3a\u6709\u5e8f\u7684\u5b57\u8282\u6d41\u3002\u51fa\u4e8e\u4e92\u64cd\u4f5c\u6027\u548c\u7b80\u5355\u6027\u7684\u8003\u8651\uff0c\u53c8\u51fa\u73b0\u4e86\u201c\u6700\u4f73\u5b9e\u8df5\u201d\u6d41\u6570\u636e\u5305\uff1aTCP\u3002TCP\u7684\u6807\u51c6\u5316\u4f7f\u5f97\u4e00\u4ee3\u7a0b\u5e8f\u5458\u6446\u8131\u4e86\u6ed1\u52a8\u7a97\u53e3\uff0c\u91cd\u8bd5\u548c\u62e5\u585e\u5d29\u6e83\u7684\u5b9e\u73b0\u3002 \u63a5\u7740\uff0c\u8bb8\u591a\u8bf7\u6c42/\u54cd\u5e94\u5728TCP\u534f\u8bae\u4e4b\u4e0a\u8fd0\u884c\uff0c\u5176\u4e2d\u8bb8\u591a\u6700\u7ec8\u8fc1\u79fb\u5230HTTP\uff08\u6216HTTP/2\u6216gRPC\uff09\u3002HTTP\u534f\u8bae\u4e0d\u4ec5\u4ec5\u7528\u4e8e\u57fa\u4e8e\u6d4f\u89c8\u5668\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd8\u6709\u50cfMongo\u8fd9\u6837\u7684\u6570\u636e\u5e93\u4e5f\u63d0\u4f9bHTTP\u63a5\u53e3\uff0c\u6781\u5927\u7684\u63d0\u5347\u4e86\u5f00\u53d1\u7684\u4fbf\u5229\u6027\u548c\u6807\u51c6\u5316\u3002 \u800c\u5fae\u670d\u52a1\u7684\u901a\u4fe1\u6a21\u5f0f\u4e2d\u7684 API \u548c\u76f8\u5173\u5b9e\u73b0\u5f62\u6210\u4e86\u65b0\u7684\u901a\u4fe1\u5c42\uff0c\u670d\u52a1\u7f51\u683c\uff08ServiceMesh\uff09\u53ef\u4ee5\u89c6\u4f5c\u8fd9\u4e9b\u65b0\u8981\u7d20\u7684\u96c6\u5927\u6210\u8005\u3002 \u901a\u8baf\u5c42\u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u6709\u4ee5\u4e0b\u9009\u62e9\uff1a \u7528\u5e93\u7684\u5f62\u5f0f\u5728\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5bfc\u5165\u4f7f\u7528\u3002 \u7528\u8282\u70b9\u4ee3\u7406\u6216\u5b88\u62a4\u7a0b\u5e8f\u7684\u5f62\u5f0f\u4e3a\u7279\u5b9a\u8282\u70b9/\u8ba1\u7b97\u673a\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u63d0\u4f9b\u670d\u52a1\u3002 \u7528Sidecar\u5bb9\u5668\u7684\u5f62\u5f0f\u8fd0\u884c\uff0c\u548c\u5e94\u7528\u5bb9\u5668\u4e00\u540c\u8fd0\u884c \u3002 \u670d\u52a1\u7f51\u683c\u5b9e\u73b0\u65b9\u5f0f lib\u6a21\u5f0f \u4f7f\u7528\u5ba2\u6237\u7aef\u5e93\u6709\u4e24\u4e2a\u597d\u5904\uff1a\u6bcf\u9879\u670d\u52a1\u90fd\u4f7f\u7528\u672c\u5730\u8d44\u6e90\uff0c\u5e76\u4e14\u5f00\u53d1\u4eba\u5458\u6709\u6743\u81ea\u884c\u9009\u62e9\u73b0\u6709\u5e93\u6216\u8005\u6784\u5efa\u65b0\u7684\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u5e93\u3002 \u800c\u5176\u6700\u5927\u7684\u7f3a\u70b9\u662f\u57fa\u7840\u8bbe\u65bd\u4e0e\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u7d27\u5bc6\u8026\u5408\u5728\u4e00\u8d77\uff0c\u5ba2\u6237\u7aef\u5e93\u7684\u4e0d\u7edf\u4e00\uff0c\u7279\u5b9a\u8bed\u8a00\u7684\u8bbe\u8ba1\u4f7f\u5f97\u4ed6\u4eec\u7684\u529f\u80fd\u548c\u884c\u4e3a\u65e0\u6cd5\u4fdd\u6301\u4e00\u81f4\u3002\u5927\u89c4\u6a21\u91c7\u7528\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u5f39\u6027\u5e93\u7684\u4ee3\u4ef7\u5f88\u9ad8\uff0c\u4e00\u822c\u662f\u5f88\u96be\u5d4c\u5165\u672a\u5f00\u53d1\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u6216\u8005\u5b8c\u5168\u4e0d\u80fd\u5408\u5e76\u5230\u73b0\u6709\u7684\u67b6\u6784\u4e2d\u3002\u5e76\u4e14\u5728\u5927\u578b\u73af\u5883\u4e2d\uff0c\u534f\u8c03\u5347\u7ea7\u5ba2\u6237\u7aef\u5e93\u4e5f\u662f\u5f88\u56f0\u96be\u7684\u3002 \u5982\u4f55\u5728\u4e3a\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5b9e\u4f8b\u4f7f\u7528\u670d\u52a1\u4ee3\u7406\uff0c\u5e94\u7528\u7a0b\u5e8f\u4e0d\u518d\u9700\u8981\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u5f39\u6027\u5e93\u6765\u5904\u7406\u7194\u65ad\uff0c\u8d85\u65f6\uff0c\u91cd\u8bd5\uff0c\u670d\u52a1\u53d1\u73b0\uff0c\u8d1f\u8f7d\u5747\u8861\u7b49\u3002\u5176\u4e2dKubernetes\u4f7f\u7528\u8282\u70b9\u4ee3\u7406proxy\u7684\u6a21\u5f0f\uff0cistio\u4f7f\u7528Sidecar\u6ce8\u5165\u7684\u6a21\u5f0f\u3002 proxy \u6a21\u5f0f \u5728\u6b64\u67b6\u6784\u4e2d\uff0c\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u8fd0\u884c\u4e00\u4e2a\u5355\u72ec\u7684\u4ee3\u7406\uff08\u901a\u5e38\u662f\u7528\u6237\u8fdb\u7a0b\uff09\uff0c\u4e3a\u5f02\u6784\u7684\u670d\u52a1\u63d0\u4f9b\u8d1f\u8f7d\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u8be5\u6a21\u578b\u4e0e\u5e93\u6a21\u578b\u76f8\u53cd\uff1a\u5b83\u4e0d\u5173\u5fc3\u5e94\u7528\u7a0b\u5e8f\u7684\u8bed\u8a00\uff0c\u53ef\u4ee5\u4e3a\u8bb8\u591a\u4e0d\u540c\u7684\u5fae\u670d\u52a1\u79df\u6237\u63d0\u4f9b\u670d\u52a1\u3002\u4f8b\u5982\uff0cKubernetes\u9ed8\u8ba4\u7684kube-proxy\u4ee3\u7406\u3002 \u4f18\u70b9 \u901a\u8fc7\u8282\u70b9\u5171\u4eab\u5f00\u9500\uff08\u5c24\u5176\u662f\u5185\u5b58\uff09 \u66f4\u5c11\u3001\u66f4\u5bb9\u6613\u6269\u5c55\u548c\u5206\u53d1\u914d\u7f6e\u4fe1\u606f \u7f3a\u70b9 \u5bf9\u5171\u4eab\u8d44\u6e90\u7684\u7ba1\u7406\u590d\u6742\uff0c\u6613\u51fa\u73b0\u5355\u70b9\u6545\u969c Sidecar\u6a21\u5f0f \u5728Sidecar\u6a21\u5f0f\u4e0b\uff0c\u589e\u52a0\u670d\u52a1\u4ee3\u7406\u8981\u505a\u4e24\u4e2a\u4e8b\u60c5\uff1aSidecar\u6ce8\u5165\u548c\u7f51\u7edc\u6d41\u91cf\u6355\u83b7\u3002Sidecar\u6ce8\u5165\u662f\u5c06\u4e00\u4e2a\u4ee3\u7406\u6dfb\u52a0\u5230\u4e00\u4e2a\u7ed9\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u65b9\u6cd5\uff0c\u800c\u7f51\u7edc\u6d41\u91cf\u7684\u6355\u83b7\u5219\u662f\u4e00\u79cd\u5c06\u5165\u7ad9\u6d41\u91cf\u5b9a\u5411\u5230\u4ee3\u7406\u5e76\u5c06\u51fa\u7ad9\u6d41\u91cf\u4e5f\u5b9a\u5411\u5230\u4ee3\u7406\u7684\u65b9\u6cd5\u3002 9\u3001\u4e3a\u4ec0\u4e48\u9700\u8981istio\uff1f \u6211\u4eec\u5df2\u7ecf\u6709\u4e86\u5bb9\u5668\u7684\u534f\u8c03\u5668\uff0c\u4f8b\u5982Kubernetes\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981\u53e6\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u5462\uff1f\u968f\u7740\u5fae\u670d\u52a1\u548c\u5bb9\u5668\u6210\u4e3a\u4e3b\u6d41\uff0c\u5bb9\u5668\u534f\u8c03\u5668\u63d0\u4f9b\u4e86\u96c6\u7fa4\uff08\u8282\u70b9\u548c\u5bb9\u5668\uff09\u6240\u9700\u7684\u5927\u90e8\u5206\u7684\u529f\u80fd\uff0c\u8fd9\u4e9b\u529f\u80fd\u4e3b\u8981\u662f\u96c6\u4e2d\u5728\u57fa\u7840\u8bbe\u65bd\u7ea7\u522b\u7684\u8c03\u5ea6\uff0c\u53d1\u73b0\u548c\u5065\u5eb7\u72b6\u51b5\uff0c\u800c\u7f3a\u5c11\u5fae\u670d\u52a1\u6240\u9700\u7684\u670d\u52a1\u7ea7\u522b\u7684\u529f\u80fd\u3002istio\u662f\u4e13\u7528\u4e8e\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u53d8\u5f97\u66f4\u52a0\u5b89\u5168\uff0c\u5feb\u901f\uff0c\u9ad8\u6548\u7684\u57fa\u7840\u8bbe\u65bd\u3002 10\u3001Sidecar \u6ce8\u5165\u53ca\u6d41\u91cf\u52ab\u6301\u6b65\u9aa4\u6982\u8ff0 istio sidecar\u6ce8\u5165\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u4e3a\u624b\u52a8\u6ce8\u5165\uff0c\u81ea\u52a8\u6ce8\u5165\u3002 \u4e0b\u9762\u662f\u4ece Sidecar \u6ce8\u5165\u3001Pod \u542f\u52a8\u5230 Sidecar proxy \u62e6\u622a\u6d41\u91cf\u53ca Envoy \u5904\u7406\u8def\u7531\u7684\u6b65\u9aa4\u6982\u89c8\u3002 Kubernetes \u901a\u8fc7 Admission Controller \u81ea\u52a8\u6ce8\u5165\uff0c\u6216\u8005\u7528\u6237\u4f7f\u7528 istioctl \u547d\u4ee4\u624b\u52a8\u6ce8\u5165 sidecar \u5bb9\u5668\u3002 \u5e94\u7528 YAML \u914d\u7f6e\u90e8\u7f72\u5e94\u7528\uff0c\u6b64\u65f6 Kubernetes API server \u63a5\u6536\u5230\u7684\u670d\u52a1\u521b\u5efa\u914d\u7f6e\u6587\u4ef6\u4e2d\u5df2\u7ecf\u5305\u542b\u4e86 Init \u5bb9\u5668\u53ca sidecar proxy \u5728 sidecar proxy \u5bb9\u5668\u548c\u5e94\u7528\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\uff0c\u9996\u5148\u8fd0\u884cinit-container\uff0cinit-container\u7528\u4e8e\u8bbe\u7f6e iptables\uff08Istio \u4e2d\u9ed8\u8ba4\u7684\u6d41\u91cf\u62e6\u622a\u65b9\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528 BPF\u3001IPVS \u7b49\u65b9\u5f0f\uff09 \u5c06\u8fdb\u5165 pod \u7684\u6d41\u91cf\u52ab\u6301\u5230 Envoy sidecar proxy\u3002\u6240\u6709 TCP \u6d41\u91cf\uff08Envoy \u76ee\u524d\u53ea\u652f\u6301 TCP \u6d41\u91cf\uff09\u5c06\u88ab sidecar \u52ab\u6301\uff0c\u5176\u4ed6\u534f\u8bae\u7684\u6d41\u91cf\u5c06\u6309\u539f\u6765\u7684\u76ee\u7684\u5730\u8bf7\u6c42\u3002 \u542f\u52a8 Pod \u4e2d\u7684 Envoy sidecar proxy \u548c\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u3002 \u4e0d\u8bba\u662f\u8fdb\u5165\u8fd8\u662f\u4ece Pod \u53d1\u51fa\u7684 TCP \u8bf7\u6c42\u90fd\u4f1a\u88ab iptables \u52ab\u6301\uff0cinbound \u6d41\u91cf\u88ab\u52ab\u6301\u540e\u7ecf Inbound Handler \u5904\u7406\u540e\u8f6c\u4ea4\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u5904\u7406\uff0coutbound \u6d41\u91cf\u88ab iptables \u52ab\u6301\u540e\u8f6c\u4ea4\u7ed9 Outbound Handler \u5904\u7406\uff0c\u5e76\u786e\u5b9a\u8f6c\u53d1\u7684 upstream \u548c Endpoint\u3002 Sidecar proxy \u8bf7\u6c42 Pilot \u4f7f\u7528 xDS \u534f\u8bae\u540c\u6b65 Envoy \u914d\u7f6e\uff0c\u5176\u4e2d\u5305\u62ec LDS\u3001EDS\u3001CDS \u7b49\uff0c\u4e0d\u8fc7\u4e3a\u4e86\u4fdd\u8bc1\u66f4\u65b0\u7684\u987a\u5e8f\uff0cEnvoy \u4f1a\u76f4\u63a5\u4f7f\u7528 ADS \u5411 Pilot \u8bf7\u6c42\u914d\u7f6e\u66f4\u65b0\u3002 11\u3001Envoy Envoy \u67b6\u6784 Downstream/\u4e0b\u6e38\uff1a\u4e0b\u6e38\u4e3b\u673a\u8fde\u63a5\u5230 Envoy\uff0c\u53d1\u9001\u8bf7\u6c42\u5e76\u63a5\u6536\u54cd\u5e94\u3002 Upstream/\u4e0a\u6e38\uff1a\u4e0a\u6e38\u4e3b\u673a\u63a5\u6536\u6765\u81ea Envoy \u7684\u8fde\u63a5\u548c\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u54cd\u5e94 \u3002 Listener/\u76d1\u542c\u5668\uff1a\u76d1\u542c\u5668\u662f\u547d\u540d\u7f51\u5730\u5740\uff08\u4f8b\u5982\uff0c\u7aef\u53e3\u3001unix domain socket\u7b49)\uff0c\u53ef\u4ee5\u88ab\u4e0b\u6e38\u5ba2\u6237\u7aef\u8fde\u63a5\u3002Envoy \u66b4\u9732\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u76d1\u542c\u5668\u7ed9\u4e0b\u6e38\u4e3b\u673a\u8fde\u63a5 Cluster/\u96c6\u7fa4\uff1a\u96c6\u7fa4\u662f\u6307 Envoy \u8fde\u63a5\u5230\u7684\u903b\u8f91\u4e0a\u76f8\u540c\u7684\u4e00\u7ec4\u4e0a\u6e38\u4e3b\u673a\u3002Envoy \u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u6765\u53d1\u73b0\u96c6\u7fa4\u7684\u6210\u5458\u3002\u53ef\u4ee5\u9009\u62e9\u901a\u8fc7\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6765\u786e\u5b9a\u96c6\u7fa4\u6210\u5458\u7684\u5065\u5eb7\u72b6\u6001\u3002Envoy \u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u51b3\u5b9a\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u54ea\u4e2a\u96c6\u7fa4\u6210\u5458\u3002 12\u3001Envoy\u5728istio\u7684\u5de5\u4f5c\u539f\u7406 Listener\u662f\u4e00\u4e2a\u53ef\u4ee5\u63a5\u6536\u4e0b\u6e38\u5ba2\u6237\u7aef\u8fde\u63a5\u7684\u6307\u5b9a\u7684\u7f51\u7edc\u4f4d\u7f6e\uff08\u4f8b\u5982\uff0c\u7aef\u53e3\uff0cunix\u57df\u5957\u63a5\u5b57\u7b49\uff09\u3002Envoy\u516c\u5f00\u4e00\u4e2a\u6216\u591a\u4e2aListener\uff0c\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\u662f\u5bf9\u5916\u5f00\u653e\u7aef\u53e3\uff0c\u5916\u90e8\u5ba2\u6237\u53ef\u4ee5\u4f7f\u7528\u8be5\u7aef\u53e3\u5efa\u7acb\u8fde\u63a5\u3002\u53ef\u4ee5\u9009\u62e9\u4e3aListener\u914d\u7f6e\u4e00\u7cfb\u5217\u7684\u7684\u76d1\u542c\u5668\u8fc7\u6ee4\u5668Listener Filter\uff0c\u7528\u4e8e\u64cd\u4f5c\u8fde\u63a5\u5143\u6570\u636e\uff0c\u5728\u4e0d\u5bf9\u6838\u5fc3\u8fdb\u884c\u53d8\u66f4\u7684\u60c5\u51b5\u4e0b\u63d0\u4f9b\u66f4\u597d\u7684\u7cfb\u7edf\u96c6\u6210\u3002 \u53ef\u4ee5\u4f7f\u7528\u9759\u6001\u914d\u7f6e\u6587\u4ef6\u6216\u8005\u901a\u8fc7API\u52a8\u6001\u914d\u7f6e\u8bbe\u7f6e\u76d1\u542c\u5668\uff08Listerens\uff09\uff0c\u8def\u7531\uff08routes\uff09\uff0c\u96c6\u7fa4\uff08clusters\uff09\uff0c\u7aef\u70b9\uff08endpoints\uff09\uff0c\u8fd9\u4e9bAPI\u5305\u62ec\u76d1\u542c\u5668\u53d1\u73b0\u670d\u52a1\uff08LDS\uff09\uff0c\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff08RDS\uff09\uff0c\u96c6\u7fa4\u53d1\u73b0\u670d\u52a1\uff08CDS\uff09\uff0c\u7aef\u70b9\u53d1\u73b0\u670d\u52a1\uff08EDS\uff09\uff0c\u8fd9\u4e9b\u670d\u52a1\u53d1\u73b0\u7684\u96c6\u5408\u79f0\u4e3axDS \u3002 13\u3001Istiod \u6ce8\uff1aistio\u7684\u7f51\u7edc\u67b6\u6784\u6709\u591a\u6b21\u5927\u7684\u6f14\u8fdb\uff0c\u76ee\u524d\u7248\u672cv1.8\u662f\u5982\u4e0b\u7684\u67b6\u6784\u6a21\u5f0f\u3002\u67b6\u6784\u6f14\u8fdb\u7684\u76ee\u7684\u53ef\u4ee5\u53c2\u8003\u4e0b\u6587\u7684\u6587\u732e(\u4ecb\u7ecd istiod\uff1a\u7b80\u5316\u63a7\u5236\u5e73\u9762)\u3002 \u672c\u7ae0\u8282\u4e3b\u8981\u4ecb\u7ecdpilot\u7684\u5b9e\u73b0\u3002 Pilot\u8d1f\u8d23\u5bf9istio\u4e2d\u90e8\u7f72\u7684\u6570\u636e\u5e73\u9762\u3001\u5165\u53e3\u7f51\u5173\u3001\u51fa\u53e3\u7f51\u5173\u3001\u4ee5\u53ca\u670d\u52a1\u4ee3\u7406\u8fdb\u884c\u7f16\u7a0b\u3002\u4e3b\u8981\u662f\u5982\u4e0b3\u4e2a\u914d\u7f6e\uff0c \u7f51\u683c\u914d\u7f6e\uff1a\u670d\u52a1\u7f51\u683c\u7684\u4e00\u7ec4\u5168\u5c40\u914d\u7f6e \u7f51\u7edc\u914d\u7f6e\uff1aserviceEntry\u3001DestinationRule\u3001VirtualService\u3001Gateway\u548c\u670d\u52a1\u4ee3\u7406\u7684\u914d\u7f6e \u670d\u52a1\u53d1\u73b0\uff1a\u6765\u81ea\u6ce8\u518c\u8868\u7684\u6709\u5173\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u5e95\u5c42\u5e73\u53f0\u4e2d\u7684\u670d\u52a1\u76ee\u5f55\u7684\u4f4d\u7f6e\u548c\u5143\u6570\u636e\u4fe1\u606f\u3002 Pilot\u6839\u636e\u7f51\u683c\u914d\u7f6e\u3001\u7f51\u7edc\u914d\u7f6e\u3001\u670d\u52a1\u53d1\u73b0\u8fd9\u4e09\u4e2a\u914d\u7f6e\u521b\u5efa\u8d44\u6e90\u548c\u90e8\u7f72\u72b6\u7684\u6a21\u578b\u3002\u5f53\u670d\u52a1\u4ee3\u7406\u5f02\u6b65\u5730\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\uff0c\u4ed6\u4eec\u5c06\u8fde\u63a5\u5230Pilot\u3002Pilot\u6839\u636e\u6807\u7b7e\u548c\u670d\u52a1\u4ee3\u7406\u9644\u5c5e\u7684\u670d\u52a1\u5c06\u670d\u52a1\u4ee3\u7406\u8fdb\u884c\u5206\u7ec4\u3002Pilot\u4f7f\u7528\u8fd9\u4e2a\u6a21\u578b\u4e3a\u6bcf\u7ec4\u8fde\u63a5\u7684\u670d\u52a1\u4ee3\u7406\uff0c\u751f\u6210\u53d1\u73b0\u670d\u52a1\uff08xDS\uff09\u54cd\u5e94\uff0c\u5f53\u670d\u52a1\u4ee3\u7406\u8fde\u63a5\u540e\uff0cPilot\u53d1\u9001\u73af\u5883\u7684\u5f53\u524d\u7684\u72b6\u6001\u548c\u914d\u7f6e\u3002\u5982\u679c\u57fa\u7840\u5e73\u53f0\u7684\u72b6\u6001\u53d8\u5316\u65f6\uff0c\u6a21\u578b\u4f1a\u4ee5\u4e00\u5b9a\u7684\u9891\u7387\u8fdb\u884c\u66f4\u65b0\uff0c\u66f4\u65b0\u6a21\u578b\u9700\u8981\u66f4\u65b0\u5f53\u524d\u7684xDS\u7684\u914d\u7f6e\u96c6\uff0c\u5f53xDS\u914d\u7f6e\u6539\u53d8\u540e\uff0cPilot\u4f1a\u8ba1\u7b97\u53d7\u5f71\u54cd\u7684\u670d\u52a1\u4ee3\u7406\u7ec4\uff0c\u5e76\u5c06\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u63a8\u9001\u7ed9\u4ed6\u4eec\u3002","title":"\u7b2c\u4e00\u8282 istio\u6d45\u6790 (Slide\u5907\u6848\uff09"},{"location":"chap9/1Istio_intro_ppt/#istio-slide","text":"","title":"\u7b2c\u4e00\u8282 istio\u6d45\u6790 (Slide\u5907\u6848\uff09"},{"location":"chap9/1Istio_intro_ppt/#1istio","text":"istio\u662f\u4e00\u4e2a\u5f00\u6e90\u670d\u52a1\u7f51\u683c\u5e73\u53f0\uff0c\u5b83\u53ef\u4ee5\u63a7\u5236\u5fae\u670d\u52a1\u4e4b\u95f4\u6570\u636e\u7684\u5171\u4eab\u65b9\u5f0f\uff0c\u5176\u9644\u5e26\u7684 API \u53ef\u4ee5\u5c06 Istio \u96c6\u6210\u5230\u4efb\u4f55\u65e5\u5fd7\u8bb0\u5f55\u5e73\u53f0\u3001\u9065\u6d4b\u6216\u7b56\u7565\u7cfb\u7edf\u4e2d \u3002 \u5728\u8bbe\u8ba1\u4e0a\uff0cIstio \u53ef\u4ee5\u5728\u591a\u79cd\u73af\u5883\u4e2d\u8fd0\u884c\uff1a\u4f01\u4e1a\u672c\u5730\u3001\u4e91\u6258\u7ba1\u3001Kubernetes\u5bb9\u5668\uff0c\u6216\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u670d\u52a1\u7b49\u3002 Istio \u63d0\u4f9b\u4e00\u79cd\u7b80\u5355\u7684\u65b9\u5f0f\u6765\u4e3a\u5df2\u90e8\u7f72\u7684\u670d\u52a1\u5efa\u7acb\u7f51\u7edc\uff0c\u8be5\u7f51\u7edc\u5177\u6709\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u95f4\u8ba4\u8bc1\u3001\u76d1\u63a7\u7b49\u529f\u80fd \uff0c \u53ea\u9700\u8981\u5bf9\u670d\u52a1\u7684\u4ee3\u7801\u8fdb\u884c\u4e00\u70b9\u6216\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u6539\u52a8\uff0c\u8ba9\u670d\u52a1\u652f\u6301 Istio\uff0c \u53ea\u9700\u8981\u5728\u73af\u5883\u4e2d\u90e8\u7f72\u4e00\u4e2a\u7279\u6b8a\u7684 sidecar \u4ee3\u7406\uff0c\u4f7f\u7528 Istio \u63a7\u5236\u5e73\u9762\u529f\u80fd\u914d\u7f6e\u548c\u7ba1\u7406\u4ee3\u7406\uff0c\u62e6\u622a\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1 \uff1a HTTP\u3001gRPC\u3001WebSocket \u548c TCP \u6d41\u91cf\u7684\u81ea\u52a8\u8d1f\u8f7d\u5747\u8861\u3002 \u901a\u8fc7\u4e30\u5bcc\u7684\u8def\u7531\u89c4\u5219\u3001\u91cd\u8bd5\u3001\u6545\u969c\u8f6c\u79fb\u548c\u6545\u969c\u6ce8\u5165\uff0c\u53ef\u4ee5\u5bf9\u6d41\u91cf\u884c\u4e3a\u8fdb\u884c\u7ec6\u7c92\u5ea6\u63a7\u5236 \u3002 \u53ef\u63d2\u5165\u7684\u7b56\u7565\u5c42\u548c\u914d\u7f6e API\uff0c\u652f\u6301\u8bbf\u95ee\u63a7\u5236\u3001\u901f\u7387\u9650\u5236\u548c\u914d\u989d\u3002 \u5bf9\u51fa\u5165\u96c6\u7fa4\u5165\u53e3\u548c\u51fa\u53e3\u4e2d\u6240\u6709\u6d41\u91cf\u7684\u81ea\u52a8\u5ea6\u91cf\u6307\u6807\u3001\u65e5\u5fd7\u8bb0\u5f55\u548c\u8ffd\u8e2a\u3002 \u901a\u8fc7\u5f3a\u5927\u7684\u57fa\u4e8e\u8eab\u4efd\u7684\u9a8c\u8bc1\u548c\u6388\u6743\uff0c\u5728\u96c6\u7fa4\u4e2d\u5b9e\u73b0\u5b89\u5168\u7684\u670d\u52a1\u95f4\u901a\u4fe1\u3002","title":"1\u3001istio\u7b80\u4ecb"},{"location":"chap9/1Istio_intro_ppt/#2istio","text":"","title":"2\u3001istio \u6846\u67b6"},{"location":"chap9/1Istio_intro_ppt/#2-1-istio","text":"\u6570\u636e\u5e73\u9762 \u7531\u4e00\u7ec4\u667a\u80fd\u4ee3\u7406\uff08Envoy\uff09\u7ec4\u6210\uff0c\u88ab\u90e8\u7f72\u4e3a sidecar \u3002\u8fd9\u4e9b\u4ee3\u7406\u8d1f\u8d23\u534f\u8c03\u548c\u63a7\u5236\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u901a\u4fe1\u3002\u4ed6\u4eec\u8fd8\u6536\u96c6\u548c\u62a5\u544a\u6240\u6709\u7f51\u683c\u6d41\u91cf\u7684\u9065\u6d4b\u6570\u636e\u3002 \u63a7\u5236\u5e73\u9762 \u7ba1\u7406\u5e76\u914d\u7f6e\u4ee3\u7406\u6765\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002 istio \u4e2d\u7684\u6d41\u91cf\u5206\u4e3a\u6570\u636e\u5e73\u9762\u6d41\u91cf\u548c\u63a7\u5236\u5e73\u9762\u6d41\u91cf\u3002 \u6570\u636e\u5e73\u9762\u6d41\u91cf\u662f\u6307\u5de5\u4f5c\u8d1f\u8f7d\u7684\u4e1a\u52a1\u903b\u8f91\u53d1\u9001\u548c\u63a5\u6536\u7684\u6d88\u606f \u63a7\u5236\u5e73\u9762\u6d41\u91cf\u662f\u6307\u5728 Istio \u7ec4\u4ef6\u4e4b\u95f4\u53d1\u9001\u7684\u914d\u7f6e\u548c\u63a7\u5236\u6d88\u606f\u7528\u6765\u7f16\u6392\u7f51\u683c\u7684\u884c\u4e3a \u3002 Istio \u4e2d\u7684\u6d41\u91cf\u7ba1\u7406\u7279\u6307\u6570\u636e\u5e73\u9762\u6d41\u91cf\u3002","title":"2-1 istio\u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762"},{"location":"chap9/1Istio_intro_ppt/#3envoy","text":"Istio \u4f7f\u7528 Envoy \u4ee3\u7406\u7684\u6269\u5c55\u7248\u672c\u3002Envoy \u662f\u7528 C++ \u5f00\u53d1\u7684\u9ad8\u6027\u80fd\u4ee3\u7406\uff0c\u7528\u4e8e\u534f\u8c03\u670d\u52a1\u7f51\u683c\u4e2d\u6240\u6709\u670d\u52a1\u7684\u5165\u7ad9\u548c\u51fa\u7ad9\u6d41\u91cf\u3002 Envoy \u4ee3\u7406\u662f\u552f\u4e00\u4e0e\u6570\u636e\u5e73\u9762\u6d41\u91cf\u4ea4\u4e92\u7684 Istio \u7ec4\u4ef6 \u3002 Envoy \u4ee3\u7406\u88ab\u90e8\u7f72\u4e3a\u670d\u52a1\u7684 sidecar \uff0c\u5728\u903b\u8f91\u4e0a\u4e3a\u670d\u52a1\u589e\u52a0\u4e86 Envoy \u7684\u8bb8\u591a\u5185\u7f6e\u7279\u6027\uff0c\u4f8b\u5982: \u52a8\u6001\u670d\u52a1\u53d1\u73b0 \u8d1f\u8f7d\u5747\u8861 TLS \u7ec8\u7aef HTTP/2 \u4e0e gRPC \u4ee3\u7406 \u7194\u65ad\u5668 \u5065\u5eb7\u68c0\u67e5 \u57fa\u4e8e\u767e\u5206\u6bd4\u6d41\u91cf\u5206\u5272\u7684\u5206\u9636\u6bb5\u53d1\u5e03 \u6545\u969c\u6ce8\u5165 \u4e30\u5bcc\u7684\u6307\u6807 \u8fd9\u79cd sidecar \u90e8\u7f72\u5141\u8bb8 Istio \u63d0\u53d6\u5927\u91cf\u5173\u4e8e\u6d41\u91cf\u884c\u4e3a\u7684\u4fe1\u53f7\u4f5c\u4e3a\u5c5e\u6027\u3002 Istio \u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u5c5e\u6027\u6765\u5b9e\u65bd\u7b56\u7565\u51b3\u7b56\uff0c\u5e76\u5c06\u5176\u53d1\u9001\u5230\u76d1\u89c6\u7cfb\u7edf\u4ee5\u63d0\u4f9b\u6709\u5173\u6574\u4e2a\u7f51\u683c\u884c\u4e3a\u7684\u4fe1\u606f\u3002 sidecar \u4ee3\u7406\u6a21\u578b\u53ef\u4ee5\u5b9e\u73b0\u73b0\u6709\u7684\u90e8\u7f72\u6dfb\u52a0 Istio \u529f\u80fd\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u8bbe\u8ba1\u67b6\u6784\u6216\u91cd\u5199\u4ee3\u7801 \u3002","title":"3\u3001Envoy"},{"location":"chap9/1Istio_intro_ppt/#4pilot","text":"Pilot \u4e3a Envoy sidecar \u63d0\u4f9b\u670d\u52a1\u53d1\u73b0\u3001\u7528\u4e8e\u667a\u80fd\u8def\u7531\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff08\u4f8b\u5982\uff0cA/B \u6d4b\u8bd5\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\uff09\u4ee5\u53ca\u5f39\u6027\u529f\u80fd\uff08\u8d85\u65f6\u3001\u91cd\u8bd5\u3001\u7194\u65ad\u5668\u7b49\uff09 \u3002 Pilot \u5c06\u63a7\u5236\u6d41\u91cf\u884c\u4e3a\u7684\u9ad8\u7ea7\u8def\u7531\u89c4\u5219\u8f6c\u6362\u4e3a\u7279\u5b9a\u4e8e\u73af\u5883\u7684\u914d\u7f6e\uff0c\u5e76\u5728\u8fd0\u884c\u65f6\u5c06\u5b83\u4eec\u4f20\u64ad\u5230 sidecar\u3002 Pilot \u5c06\u7279\u5b9a\u4e8e\u5e73\u53f0\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\u62bd\u8c61\u51fa\u6765\uff0c\u5e76\u5c06\u5b83\u4eec\u5408\u6210\u4e3a\u4efb\u4f55\u7b26\u5408 Envoy API \u7684 sidecar \u90fd\u53ef\u4ee5\u4f7f\u7528\u7684\u6807\u51c6\u683c\u5f0f\u3002 \u5e73\u53f0\u542f\u52a8\u4e00\u4e2a\u670d\u52a1\u7684\u65b0\u5b9e\u4f8b\uff0c\u8be5\u5b9e\u4f8b\u901a\u77e5\u5176\u5e73\u53f0\u9002\u914d\u5668\u3002 \u5e73\u53f0\u9002\u914d\u5668\u4f7f\u7528 Pilot \u62bd\u8c61\u6a21\u578b\u6ce8\u518c\u5b9e\u4f8b\u3002 Pilot \u5c06\u6d41\u91cf\u89c4\u5219\u548c\u914d\u7f6e\u6d3e\u53d1\u7ed9 Envoy \u4ee3\u7406\uff0c\u6765\u4f20\u8fbe\u6b64\u6b21\u66f4\u6539 \u3002 \u8fd9\u79cd\u677e\u8026\u5408\u5141\u8bb8 Istio \u5728 Kubernetes\u3001Consul \u6216 Nomad \u7b49\u591a\u79cd\u73af\u5883\u4e2d\u8fd0\u884c\uff0c\u540c\u65f6\u7ef4\u62a4\u76f8\u540c\u7684 operator \u63a5\u53e3\u6765\u8fdb\u884c\u6d41\u91cf\u7ba1\u7406\u3002\u53ef\u4ee5\u4f7f\u7528 Istio \u7684\u6d41\u91cf\u7ba1\u7406 API \u6765\u6307\u793a Pilot \u4f18\u5316 Envoy \u914d\u7f6e\uff0c\u4ee5\u4fbf\u5bf9\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6d41\u91cf\u8fdb\u884c\u66f4\u7ec6\u7c92\u5ea6\u5730\u63a7\u5236\u3002","title":"4\u3001Pilot"},{"location":"chap9/1Istio_intro_ppt/#5citadel","text":"Citadel \u901a\u8fc7\u5185\u7f6e\u7684\u8eab\u4efd\u548c\u8bc1\u4e66\u7ba1\u7406\uff0c\u53ef\u4ee5\u652f\u6301\u5f3a\u5927\u7684\u670d\u52a1\u5230\u670d\u52a1\u4ee5\u53ca\u6700\u7ec8\u7528\u6237\u7684\u8eab\u4efd\u9a8c\u8bc1\uff0c\u53ef\u4ee5\u4f7f\u7528 Citadel \u6765\u5347\u7ea7\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u672a\u52a0\u5bc6\u6d41\u91cf\uff0c \u4f7f\u7528 Citadel\uff0coperator \u53ef\u4ee5\u6267\u884c\u57fa\u4e8e\u670d\u52a1\u8eab\u4efd\u7684\u7b56\u7565\uff0c\u800c\u4e0d\u662f\u76f8\u5bf9\u4e0d\u7a33\u5b9a\u7684 3 \u5c42\u6216 4 \u5c42\u7f51\u7edc\u6807\u8bc6 \u3002","title":"5\u3001Citadel"},{"location":"chap9/1Istio_intro_ppt/#6galley","text":"Galley \u662f Istio \u7684\u914d\u7f6e\u9a8c\u8bc1\u3001\u63d0\u53d6\u3001\u5904\u7406\u548c\u5206\u53d1\u7ec4\u4ef6 \u3002\u5b83\u8d1f\u8d23\u5c06\u5176\u4f59\u7684 Istio \u7ec4\u4ef6\u4e0e\u4ece\u5e95\u5c42\u5e73\u53f0\uff08\u4f8b\u5982 Kubernetes\uff09\u83b7\u53d6\u7528\u6237\u914d\u7f6e\u7684\u7ec6\u8282\u9694\u79bb\u5f00\u6765\u3002","title":"6\u3001Galley"},{"location":"chap9/1Istio_intro_ppt/#7istio","text":"\u51e0\u4e2a\u5173\u952e\u7684\u8bbe\u8ba1\u76ee\u6807\u5f62\u6210\u4e86 Istio \u7684\u67b6\u6784\u3002\u8fd9\u4e9b\u76ee\u6807\u5bf9\u4e8e\u4f7f\u7cfb\u7edf\u80fd\u591f\u5927\u89c4\u6a21\u548c\u9ad8\u6027\u80fd\u5730\u5904\u7406\u670d\u52a1\u662f\u81f3\u5173\u91cd\u8981\u7684\u3002","title":"7\u3001Istio\u8bbe\u8ba1\u76ee\u6807"},{"location":"chap9/1Istio_intro_ppt/#1","text":"\u4e3a\u4e86\u91c7\u7528 Istio\uff0c\u8fd0\u7ef4\u4eba\u5458\u6216\u5f00\u53d1\u4eba\u5458\u9700\u8981\u505a\u5c3d\u53ef\u80fd\u5c11\u7684\u5de5\u4f5c\uff0c\u624d\u80fd\u4ece\u7cfb\u7edf\u4e2d\u83b7\u5f97\u771f\u6b63\u7684\u4ef7\u503c\u3002\u4e3a\u6b64\uff0cIstio \u53ef\u4ee5\u81ea\u52a8\u5c06\u81ea\u5df1\u6ce8\u5165\u5230\u670d\u52a1\u4e4b\u95f4\u7684\u6240\u6709\u7f51\u7edc\u8def\u5f84\u4e2d\u3002Istio \u4f7f\u7528 sidecar \u4ee3\u7406\u6765\u6355\u83b7\u6d41\u91cf\uff0c\u5e76\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u5728\u4e0d\u66f4\u6539\u5df2\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\uff0c\u81ea\u52a8\u5bf9\u7f51\u7edc\u5c42\u8fdb\u884c\u914d\u7f6e\uff0c\u4ee5\u5b9e\u73b0\u901a\u8fc7\u8fd9\u4e9b\u4ee3\u7406\u6765\u8def\u7531\u6d41\u91cf\u3002 \u5728 Kubernetes \u4e2d\uff0c\u4ee3\u7406\u88ab\u6ce8\u5165\u5230pods\u4e2d\uff0c\u901a\u8fc7\u7f16\u5199iptables\u89c4\u5219\u6765\u6355\u83b7\u6d41\u91cf\u3002 \u4e00\u65e6 sidecar \u4ee3\u7406\u88ab\u6ce8\u5165\u4ee5\u53ca\u6d41\u91cf\u8def\u7531\u88ab\u7f16\u7a0b\uff0cIstio \u5c31\u53ef\u4ee5\u534f\u8c03\u6240\u6709\u7684\u6d41\u91cf\u3002\u8fd9\u4e2a\u539f\u5219\u4e5f\u9002\u7528\u4e8e\u6027\u80fd \u3002\u5f53\u5c06 Istio \u5e94\u7528\u4e8e\u90e8\u7f72\u65f6\uff0c\u8fd0\u7ef4\u4eba\u5458\u4f1a\u770b\u5230\u6240\u63d0\u4f9b\u529f\u80fd\u7684\u8d44\u6e90\u6210\u672c\u589e\u52a0\u7684\u6700\u5c0f\u3002\u7ec4\u4ef6\u548c API \u7684\u8bbe\u8ba1\u5fc5\u987b\u8003\u8651\u5230\u6027\u80fd\u548c\u53ef\u4f38\u7f29\u6027\u3002","title":"1. \u900f\u660e\u5ea6\u6700\u5927\u5316"},{"location":"chap9/1Istio_intro_ppt/#2","text":"\u968f\u7740\u8fd0\u7ef4\u4eba\u5458\u548c\u5f00\u53d1\u4eba\u5458\u8d8a\u6765\u8d8a\u4f9d\u8d56\u4e8e Istio \u63d0\u4f9b\u7684\u529f\u80fd\uff0c\u7cfb\u7edf\u5fc5\u987b\u968f\u7740\u4ed6\u4eec\u7684\u9700\u6c42\u800c\u589e\u957f\u3002 \u5728\u7ee7\u7eed\u6dfb\u52a0\u65b0\u7279\u6027\u65f6\uff0c\u6700\u5927\u7684\u9700\u6c42\u662f\u6269\u5c55\u7b56\u7565\u7cfb\u7edf\u7684\u80fd\u529b\uff0c\u4e0e\u5176\u4ed6\u7b56\u7565\u548c\u63a7\u5236\u6e90\u7684\u96c6\u6210\uff0c\u4ee5\u53ca\u5c06\u5173\u4e8e\u7f51\u683c\u884c\u4e3a\u7684\u4fe1\u53f7\u4f20\u64ad\u5230\u5176\u4ed6\u7cfb\u7edf\u8fdb\u884c\u5206\u6790\u7684\u80fd\u529b\u3002\u7b56\u7565\u8fd0\u884c\u65f6\u652f\u6301\u7528\u4e8e\u63a5\u5165\u5176\u4ed6\u670d\u52a1\u7684\u6807\u51c6\u6269\u5c55\u673a\u5236\u3002\u6b64\u5916\uff0c\u5b83\u5141\u8bb8\u6269\u5c55\u5176\u8bcd\u6c47\u8868\uff0c\u5141\u8bb8\u6839\u636e\u7f51\u683c\u751f\u6210\u7684\u65b0\u4fe1\u53f7\u6267\u884c\u7b56\u7565\u3002","title":"2 \u53ef\u6269\u5c55\u6027"},{"location":"chap9/1Istio_intro_ppt/#3","text":"\u4f7f\u7528 Istio \u7684\u751f\u6001\u7cfb\u7edf\u5728\u8bb8\u591a\u65b9\u9762\u90fd\u6709\u6240\u4e0d\u540c\u3002Istio \u5fc5\u987b\u5728\u4efb\u4f55\u4e91\u73af\u5883\u6216\u672c\u5730\u73af\u5883\u4e2d\u901a\u8fc7\u6700\u5c0f\u7684\u52aa\u529b\u5c31\u80fd\u8fd0\u884c\u8d77\u6765\u3002\u5c06\u57fa\u4e8e Istio \u7684\u670d\u52a1\u79fb\u690d\u5230\u65b0\u73af\u5883\u7684\u4efb\u52a1\u5fc5\u987b\u662f\u5bb9\u6613\u5b9e\u73b0\u7684\u3002 \u4f7f\u7528 Istio\uff0c\u53ef\u4ee5\u64cd\u4f5c\u90e8\u7f72\u5230\u591a\u4e2a\u73af\u5883\u4e2d\u7684\u5355\u4e2a\u670d\u52a1\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u5728\u591a\u4e2a\u4e91\u4e0a\u90e8\u7f72\u6765\u5b9e\u73b0\u5197\u4f59\u3002 \u7b56\u7565\u4e00\u81f4\u6027\uff1a\u5c06\u7b56\u7565\u5e94\u7528\u4e8e\u670d\u52a1\u4e4b\u95f4\u7684 API \u8c03\u7528\u63d0\u4f9b\u4e86\u5bf9\u7f51\u683c\u884c\u4e3a\u7684\u5927\u91cf\u63a7\u5236\u3002\u7136\u800c\uff0c\u5c06\u7b56\u7565\u5e94\u7528\u5728\u533a\u522b\u4e8e API \u5c42\u4e0a\u7684\u8d44\u6e90\u4e5f\u540c\u6837\u91cd\u8981\u3002\u4f8b\u5982\uff0c\u5728\u673a\u5668\u5b66\u4e60\u8bad\u7ec3\u4efb\u52a1\u6d88\u8017\u7684 CPU \u6570\u91cf\u4e0a\u5e94\u7528\u914d\u989d\u6bd4\u5728\u53d1\u8d77\u4efb\u52a1\u7684\u8bf7\u6c42\u8c03\u7528\u4e0a\u5e94\u7528\u914d\u989d\u66f4\u6709\u7528\u3002\u4e3a\u6b64\uff0cIstio \u4f7f\u7528\u81ea\u5df1\u7684 API \u5c06\u7b56\u7565\u7cfb\u7edf\u7ef4\u62a4\u4e3a\u4e00\u4e2a\u72ec\u7acb\u7684\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u5c06\u7b56\u7565\u7cfb\u7edf\u96c6\u6210\u5230 sidecar \u4ee3\u7406\u4e2d\uff0c\u4ece\u800c\u5141\u8bb8\u670d\u52a1\u6839\u636e\u9700\u8981\u76f4\u63a5\u4e0e\u4e4b\u96c6\u6210\u3002","title":"3 \u53ef\u79fb\u690d\u6027"},{"location":"chap9/1Istio_intro_ppt/#8istio","text":"","title":"8\u3001istio\u7ec4\u4ef6\u8be6\u89e3"},{"location":"chap9/1Istio_intro_ppt/#8-1-istiosidecar","text":"\u7f51\u7edc\u6a21\u578b\u53d1\u5c55 \u6211\u4eec\u56de\u987e\u8ba1\u7b97\u7f51\u7edc\u7684\u53d1\u5c55\u53f2\u3002\u5728\u5206\u7ec4\u4ea4\u6362\u7f51\u7edc\u7684\u51fa\u73b0\u540e\uff0c\u9700\u8981\u7528\u6237\u81ea\u5df1\u6765\u4f7f\u7528\u63e1\u624b\u3001\u91cd\u4f20\u548c\u56e0\u7279\u7f51\u5c06\u4e00\u5806\u6570\u636e\u5305\u8f6c\u6362\u4e3a\u6709\u5e8f\u7684\u5b57\u8282\u6d41\u3002\u51fa\u4e8e\u4e92\u64cd\u4f5c\u6027\u548c\u7b80\u5355\u6027\u7684\u8003\u8651\uff0c\u53c8\u51fa\u73b0\u4e86\u201c\u6700\u4f73\u5b9e\u8df5\u201d\u6d41\u6570\u636e\u5305\uff1aTCP\u3002TCP\u7684\u6807\u51c6\u5316\u4f7f\u5f97\u4e00\u4ee3\u7a0b\u5e8f\u5458\u6446\u8131\u4e86\u6ed1\u52a8\u7a97\u53e3\uff0c\u91cd\u8bd5\u548c\u62e5\u585e\u5d29\u6e83\u7684\u5b9e\u73b0\u3002 \u63a5\u7740\uff0c\u8bb8\u591a\u8bf7\u6c42/\u54cd\u5e94\u5728TCP\u534f\u8bae\u4e4b\u4e0a\u8fd0\u884c\uff0c\u5176\u4e2d\u8bb8\u591a\u6700\u7ec8\u8fc1\u79fb\u5230HTTP\uff08\u6216HTTP/2\u6216gRPC\uff09\u3002HTTP\u534f\u8bae\u4e0d\u4ec5\u4ec5\u7528\u4e8e\u57fa\u4e8e\u6d4f\u89c8\u5668\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd8\u6709\u50cfMongo\u8fd9\u6837\u7684\u6570\u636e\u5e93\u4e5f\u63d0\u4f9bHTTP\u63a5\u53e3\uff0c\u6781\u5927\u7684\u63d0\u5347\u4e86\u5f00\u53d1\u7684\u4fbf\u5229\u6027\u548c\u6807\u51c6\u5316\u3002 \u800c\u5fae\u670d\u52a1\u7684\u901a\u4fe1\u6a21\u5f0f\u4e2d\u7684 API \u548c\u76f8\u5173\u5b9e\u73b0\u5f62\u6210\u4e86\u65b0\u7684\u901a\u4fe1\u5c42\uff0c\u670d\u52a1\u7f51\u683c\uff08ServiceMesh\uff09\u53ef\u4ee5\u89c6\u4f5c\u8fd9\u4e9b\u65b0\u8981\u7d20\u7684\u96c6\u5927\u6210\u8005\u3002 \u901a\u8baf\u5c42\u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u6709\u4ee5\u4e0b\u9009\u62e9\uff1a \u7528\u5e93\u7684\u5f62\u5f0f\u5728\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5bfc\u5165\u4f7f\u7528\u3002 \u7528\u8282\u70b9\u4ee3\u7406\u6216\u5b88\u62a4\u7a0b\u5e8f\u7684\u5f62\u5f0f\u4e3a\u7279\u5b9a\u8282\u70b9/\u8ba1\u7b97\u673a\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u63d0\u4f9b\u670d\u52a1\u3002 \u7528Sidecar\u5bb9\u5668\u7684\u5f62\u5f0f\u8fd0\u884c\uff0c\u548c\u5e94\u7528\u5bb9\u5668\u4e00\u540c\u8fd0\u884c \u3002 \u670d\u52a1\u7f51\u683c\u5b9e\u73b0\u65b9\u5f0f lib\u6a21\u5f0f \u4f7f\u7528\u5ba2\u6237\u7aef\u5e93\u6709\u4e24\u4e2a\u597d\u5904\uff1a\u6bcf\u9879\u670d\u52a1\u90fd\u4f7f\u7528\u672c\u5730\u8d44\u6e90\uff0c\u5e76\u4e14\u5f00\u53d1\u4eba\u5458\u6709\u6743\u81ea\u884c\u9009\u62e9\u73b0\u6709\u5e93\u6216\u8005\u6784\u5efa\u65b0\u7684\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u5e93\u3002 \u800c\u5176\u6700\u5927\u7684\u7f3a\u70b9\u662f\u57fa\u7840\u8bbe\u65bd\u4e0e\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u7d27\u5bc6\u8026\u5408\u5728\u4e00\u8d77\uff0c\u5ba2\u6237\u7aef\u5e93\u7684\u4e0d\u7edf\u4e00\uff0c\u7279\u5b9a\u8bed\u8a00\u7684\u8bbe\u8ba1\u4f7f\u5f97\u4ed6\u4eec\u7684\u529f\u80fd\u548c\u884c\u4e3a\u65e0\u6cd5\u4fdd\u6301\u4e00\u81f4\u3002\u5927\u89c4\u6a21\u91c7\u7528\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u5f39\u6027\u5e93\u7684\u4ee3\u4ef7\u5f88\u9ad8\uff0c\u4e00\u822c\u662f\u5f88\u96be\u5d4c\u5165\u672a\u5f00\u53d1\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u6216\u8005\u5b8c\u5168\u4e0d\u80fd\u5408\u5e76\u5230\u73b0\u6709\u7684\u67b6\u6784\u4e2d\u3002\u5e76\u4e14\u5728\u5927\u578b\u73af\u5883\u4e2d\uff0c\u534f\u8c03\u5347\u7ea7\u5ba2\u6237\u7aef\u5e93\u4e5f\u662f\u5f88\u56f0\u96be\u7684\u3002 \u5982\u4f55\u5728\u4e3a\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5b9e\u4f8b\u4f7f\u7528\u670d\u52a1\u4ee3\u7406\uff0c\u5e94\u7528\u7a0b\u5e8f\u4e0d\u518d\u9700\u8981\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u5f39\u6027\u5e93\u6765\u5904\u7406\u7194\u65ad\uff0c\u8d85\u65f6\uff0c\u91cd\u8bd5\uff0c\u670d\u52a1\u53d1\u73b0\uff0c\u8d1f\u8f7d\u5747\u8861\u7b49\u3002\u5176\u4e2dKubernetes\u4f7f\u7528\u8282\u70b9\u4ee3\u7406proxy\u7684\u6a21\u5f0f\uff0cistio\u4f7f\u7528Sidecar\u6ce8\u5165\u7684\u6a21\u5f0f\u3002 proxy \u6a21\u5f0f \u5728\u6b64\u67b6\u6784\u4e2d\uff0c\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u8fd0\u884c\u4e00\u4e2a\u5355\u72ec\u7684\u4ee3\u7406\uff08\u901a\u5e38\u662f\u7528\u6237\u8fdb\u7a0b\uff09\uff0c\u4e3a\u5f02\u6784\u7684\u670d\u52a1\u63d0\u4f9b\u8d1f\u8f7d\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u8be5\u6a21\u578b\u4e0e\u5e93\u6a21\u578b\u76f8\u53cd\uff1a\u5b83\u4e0d\u5173\u5fc3\u5e94\u7528\u7a0b\u5e8f\u7684\u8bed\u8a00\uff0c\u53ef\u4ee5\u4e3a\u8bb8\u591a\u4e0d\u540c\u7684\u5fae\u670d\u52a1\u79df\u6237\u63d0\u4f9b\u670d\u52a1\u3002\u4f8b\u5982\uff0cKubernetes\u9ed8\u8ba4\u7684kube-proxy\u4ee3\u7406\u3002 \u4f18\u70b9 \u901a\u8fc7\u8282\u70b9\u5171\u4eab\u5f00\u9500\uff08\u5c24\u5176\u662f\u5185\u5b58\uff09 \u66f4\u5c11\u3001\u66f4\u5bb9\u6613\u6269\u5c55\u548c\u5206\u53d1\u914d\u7f6e\u4fe1\u606f \u7f3a\u70b9 \u5bf9\u5171\u4eab\u8d44\u6e90\u7684\u7ba1\u7406\u590d\u6742\uff0c\u6613\u51fa\u73b0\u5355\u70b9\u6545\u969c Sidecar\u6a21\u5f0f \u5728Sidecar\u6a21\u5f0f\u4e0b\uff0c\u589e\u52a0\u670d\u52a1\u4ee3\u7406\u8981\u505a\u4e24\u4e2a\u4e8b\u60c5\uff1aSidecar\u6ce8\u5165\u548c\u7f51\u7edc\u6d41\u91cf\u6355\u83b7\u3002Sidecar\u6ce8\u5165\u662f\u5c06\u4e00\u4e2a\u4ee3\u7406\u6dfb\u52a0\u5230\u4e00\u4e2a\u7ed9\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u65b9\u6cd5\uff0c\u800c\u7f51\u7edc\u6d41\u91cf\u7684\u6355\u83b7\u5219\u662f\u4e00\u79cd\u5c06\u5165\u7ad9\u6d41\u91cf\u5b9a\u5411\u5230\u4ee3\u7406\u5e76\u5c06\u51fa\u7ad9\u6d41\u91cf\u4e5f\u5b9a\u5411\u5230\u4ee3\u7406\u7684\u65b9\u6cd5\u3002","title":"8-1 Istio\u7684sidecar\u4ee3\u7406"},{"location":"chap9/1Istio_intro_ppt/#9istio","text":"\u6211\u4eec\u5df2\u7ecf\u6709\u4e86\u5bb9\u5668\u7684\u534f\u8c03\u5668\uff0c\u4f8b\u5982Kubernetes\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981\u53e6\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u5462\uff1f\u968f\u7740\u5fae\u670d\u52a1\u548c\u5bb9\u5668\u6210\u4e3a\u4e3b\u6d41\uff0c\u5bb9\u5668\u534f\u8c03\u5668\u63d0\u4f9b\u4e86\u96c6\u7fa4\uff08\u8282\u70b9\u548c\u5bb9\u5668\uff09\u6240\u9700\u7684\u5927\u90e8\u5206\u7684\u529f\u80fd\uff0c\u8fd9\u4e9b\u529f\u80fd\u4e3b\u8981\u662f\u96c6\u4e2d\u5728\u57fa\u7840\u8bbe\u65bd\u7ea7\u522b\u7684\u8c03\u5ea6\uff0c\u53d1\u73b0\u548c\u5065\u5eb7\u72b6\u51b5\uff0c\u800c\u7f3a\u5c11\u5fae\u670d\u52a1\u6240\u9700\u7684\u670d\u52a1\u7ea7\u522b\u7684\u529f\u80fd\u3002istio\u662f\u4e13\u7528\u4e8e\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u53d8\u5f97\u66f4\u52a0\u5b89\u5168\uff0c\u5feb\u901f\uff0c\u9ad8\u6548\u7684\u57fa\u7840\u8bbe\u65bd\u3002","title":"9\u3001\u4e3a\u4ec0\u4e48\u9700\u8981istio\uff1f"},{"location":"chap9/1Istio_intro_ppt/#10sidecar","text":"istio sidecar\u6ce8\u5165\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u4e3a\u624b\u52a8\u6ce8\u5165\uff0c\u81ea\u52a8\u6ce8\u5165\u3002 \u4e0b\u9762\u662f\u4ece Sidecar \u6ce8\u5165\u3001Pod \u542f\u52a8\u5230 Sidecar proxy \u62e6\u622a\u6d41\u91cf\u53ca Envoy \u5904\u7406\u8def\u7531\u7684\u6b65\u9aa4\u6982\u89c8\u3002 Kubernetes \u901a\u8fc7 Admission Controller \u81ea\u52a8\u6ce8\u5165\uff0c\u6216\u8005\u7528\u6237\u4f7f\u7528 istioctl \u547d\u4ee4\u624b\u52a8\u6ce8\u5165 sidecar \u5bb9\u5668\u3002 \u5e94\u7528 YAML \u914d\u7f6e\u90e8\u7f72\u5e94\u7528\uff0c\u6b64\u65f6 Kubernetes API server \u63a5\u6536\u5230\u7684\u670d\u52a1\u521b\u5efa\u914d\u7f6e\u6587\u4ef6\u4e2d\u5df2\u7ecf\u5305\u542b\u4e86 Init \u5bb9\u5668\u53ca sidecar proxy \u5728 sidecar proxy \u5bb9\u5668\u548c\u5e94\u7528\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\uff0c\u9996\u5148\u8fd0\u884cinit-container\uff0cinit-container\u7528\u4e8e\u8bbe\u7f6e iptables\uff08Istio \u4e2d\u9ed8\u8ba4\u7684\u6d41\u91cf\u62e6\u622a\u65b9\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528 BPF\u3001IPVS \u7b49\u65b9\u5f0f\uff09 \u5c06\u8fdb\u5165 pod \u7684\u6d41\u91cf\u52ab\u6301\u5230 Envoy sidecar proxy\u3002\u6240\u6709 TCP \u6d41\u91cf\uff08Envoy \u76ee\u524d\u53ea\u652f\u6301 TCP \u6d41\u91cf\uff09\u5c06\u88ab sidecar \u52ab\u6301\uff0c\u5176\u4ed6\u534f\u8bae\u7684\u6d41\u91cf\u5c06\u6309\u539f\u6765\u7684\u76ee\u7684\u5730\u8bf7\u6c42\u3002 \u542f\u52a8 Pod \u4e2d\u7684 Envoy sidecar proxy \u548c\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u3002 \u4e0d\u8bba\u662f\u8fdb\u5165\u8fd8\u662f\u4ece Pod \u53d1\u51fa\u7684 TCP \u8bf7\u6c42\u90fd\u4f1a\u88ab iptables \u52ab\u6301\uff0cinbound \u6d41\u91cf\u88ab\u52ab\u6301\u540e\u7ecf Inbound Handler \u5904\u7406\u540e\u8f6c\u4ea4\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u5904\u7406\uff0coutbound \u6d41\u91cf\u88ab iptables \u52ab\u6301\u540e\u8f6c\u4ea4\u7ed9 Outbound Handler \u5904\u7406\uff0c\u5e76\u786e\u5b9a\u8f6c\u53d1\u7684 upstream \u548c Endpoint\u3002 Sidecar proxy \u8bf7\u6c42 Pilot \u4f7f\u7528 xDS \u534f\u8bae\u540c\u6b65 Envoy \u914d\u7f6e\uff0c\u5176\u4e2d\u5305\u62ec LDS\u3001EDS\u3001CDS \u7b49\uff0c\u4e0d\u8fc7\u4e3a\u4e86\u4fdd\u8bc1\u66f4\u65b0\u7684\u987a\u5e8f\uff0cEnvoy \u4f1a\u76f4\u63a5\u4f7f\u7528 ADS \u5411 Pilot \u8bf7\u6c42\u914d\u7f6e\u66f4\u65b0\u3002","title":"10\u3001Sidecar \u6ce8\u5165\u53ca\u6d41\u91cf\u52ab\u6301\u6b65\u9aa4\u6982\u8ff0"},{"location":"chap9/1Istio_intro_ppt/#11envoy","text":"Envoy \u67b6\u6784 Downstream/\u4e0b\u6e38\uff1a\u4e0b\u6e38\u4e3b\u673a\u8fde\u63a5\u5230 Envoy\uff0c\u53d1\u9001\u8bf7\u6c42\u5e76\u63a5\u6536\u54cd\u5e94\u3002 Upstream/\u4e0a\u6e38\uff1a\u4e0a\u6e38\u4e3b\u673a\u63a5\u6536\u6765\u81ea Envoy \u7684\u8fde\u63a5\u548c\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u54cd\u5e94 \u3002 Listener/\u76d1\u542c\u5668\uff1a\u76d1\u542c\u5668\u662f\u547d\u540d\u7f51\u5730\u5740\uff08\u4f8b\u5982\uff0c\u7aef\u53e3\u3001unix domain socket\u7b49)\uff0c\u53ef\u4ee5\u88ab\u4e0b\u6e38\u5ba2\u6237\u7aef\u8fde\u63a5\u3002Envoy \u66b4\u9732\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u76d1\u542c\u5668\u7ed9\u4e0b\u6e38\u4e3b\u673a\u8fde\u63a5 Cluster/\u96c6\u7fa4\uff1a\u96c6\u7fa4\u662f\u6307 Envoy \u8fde\u63a5\u5230\u7684\u903b\u8f91\u4e0a\u76f8\u540c\u7684\u4e00\u7ec4\u4e0a\u6e38\u4e3b\u673a\u3002Envoy \u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u6765\u53d1\u73b0\u96c6\u7fa4\u7684\u6210\u5458\u3002\u53ef\u4ee5\u9009\u62e9\u901a\u8fc7\u4e3b\u52a8\u5065\u5eb7\u68c0\u67e5\u6765\u786e\u5b9a\u96c6\u7fa4\u6210\u5458\u7684\u5065\u5eb7\u72b6\u6001\u3002Envoy \u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u51b3\u5b9a\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u54ea\u4e2a\u96c6\u7fa4\u6210\u5458\u3002","title":"11\u3001Envoy"},{"location":"chap9/1Istio_intro_ppt/#12envoyistio","text":"Listener\u662f\u4e00\u4e2a\u53ef\u4ee5\u63a5\u6536\u4e0b\u6e38\u5ba2\u6237\u7aef\u8fde\u63a5\u7684\u6307\u5b9a\u7684\u7f51\u7edc\u4f4d\u7f6e\uff08\u4f8b\u5982\uff0c\u7aef\u53e3\uff0cunix\u57df\u5957\u63a5\u5b57\u7b49\uff09\u3002Envoy\u516c\u5f00\u4e00\u4e2a\u6216\u591a\u4e2aListener\uff0c\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\u662f\u5bf9\u5916\u5f00\u653e\u7aef\u53e3\uff0c\u5916\u90e8\u5ba2\u6237\u53ef\u4ee5\u4f7f\u7528\u8be5\u7aef\u53e3\u5efa\u7acb\u8fde\u63a5\u3002\u53ef\u4ee5\u9009\u62e9\u4e3aListener\u914d\u7f6e\u4e00\u7cfb\u5217\u7684\u7684\u76d1\u542c\u5668\u8fc7\u6ee4\u5668Listener Filter\uff0c\u7528\u4e8e\u64cd\u4f5c\u8fde\u63a5\u5143\u6570\u636e\uff0c\u5728\u4e0d\u5bf9\u6838\u5fc3\u8fdb\u884c\u53d8\u66f4\u7684\u60c5\u51b5\u4e0b\u63d0\u4f9b\u66f4\u597d\u7684\u7cfb\u7edf\u96c6\u6210\u3002 \u53ef\u4ee5\u4f7f\u7528\u9759\u6001\u914d\u7f6e\u6587\u4ef6\u6216\u8005\u901a\u8fc7API\u52a8\u6001\u914d\u7f6e\u8bbe\u7f6e\u76d1\u542c\u5668\uff08Listerens\uff09\uff0c\u8def\u7531\uff08routes\uff09\uff0c\u96c6\u7fa4\uff08clusters\uff09\uff0c\u7aef\u70b9\uff08endpoints\uff09\uff0c\u8fd9\u4e9bAPI\u5305\u62ec\u76d1\u542c\u5668\u53d1\u73b0\u670d\u52a1\uff08LDS\uff09\uff0c\u8def\u7531\u53d1\u73b0\u670d\u52a1\uff08RDS\uff09\uff0c\u96c6\u7fa4\u53d1\u73b0\u670d\u52a1\uff08CDS\uff09\uff0c\u7aef\u70b9\u53d1\u73b0\u670d\u52a1\uff08EDS\uff09\uff0c\u8fd9\u4e9b\u670d\u52a1\u53d1\u73b0\u7684\u96c6\u5408\u79f0\u4e3axDS \u3002","title":"12\u3001Envoy\u5728istio\u7684\u5de5\u4f5c\u539f\u7406"},{"location":"chap9/1Istio_intro_ppt/#13istiod","text":"\u6ce8\uff1aistio\u7684\u7f51\u7edc\u67b6\u6784\u6709\u591a\u6b21\u5927\u7684\u6f14\u8fdb\uff0c\u76ee\u524d\u7248\u672cv1.8\u662f\u5982\u4e0b\u7684\u67b6\u6784\u6a21\u5f0f\u3002\u67b6\u6784\u6f14\u8fdb\u7684\u76ee\u7684\u53ef\u4ee5\u53c2\u8003\u4e0b\u6587\u7684\u6587\u732e(\u4ecb\u7ecd istiod\uff1a\u7b80\u5316\u63a7\u5236\u5e73\u9762)\u3002 \u672c\u7ae0\u8282\u4e3b\u8981\u4ecb\u7ecdpilot\u7684\u5b9e\u73b0\u3002 Pilot\u8d1f\u8d23\u5bf9istio\u4e2d\u90e8\u7f72\u7684\u6570\u636e\u5e73\u9762\u3001\u5165\u53e3\u7f51\u5173\u3001\u51fa\u53e3\u7f51\u5173\u3001\u4ee5\u53ca\u670d\u52a1\u4ee3\u7406\u8fdb\u884c\u7f16\u7a0b\u3002\u4e3b\u8981\u662f\u5982\u4e0b3\u4e2a\u914d\u7f6e\uff0c \u7f51\u683c\u914d\u7f6e\uff1a\u670d\u52a1\u7f51\u683c\u7684\u4e00\u7ec4\u5168\u5c40\u914d\u7f6e \u7f51\u7edc\u914d\u7f6e\uff1aserviceEntry\u3001DestinationRule\u3001VirtualService\u3001Gateway\u548c\u670d\u52a1\u4ee3\u7406\u7684\u914d\u7f6e \u670d\u52a1\u53d1\u73b0\uff1a\u6765\u81ea\u6ce8\u518c\u8868\u7684\u6709\u5173\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u5e95\u5c42\u5e73\u53f0\u4e2d\u7684\u670d\u52a1\u76ee\u5f55\u7684\u4f4d\u7f6e\u548c\u5143\u6570\u636e\u4fe1\u606f\u3002 Pilot\u6839\u636e\u7f51\u683c\u914d\u7f6e\u3001\u7f51\u7edc\u914d\u7f6e\u3001\u670d\u52a1\u53d1\u73b0\u8fd9\u4e09\u4e2a\u914d\u7f6e\u521b\u5efa\u8d44\u6e90\u548c\u90e8\u7f72\u72b6\u7684\u6a21\u578b\u3002\u5f53\u670d\u52a1\u4ee3\u7406\u5f02\u6b65\u5730\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\uff0c\u4ed6\u4eec\u5c06\u8fde\u63a5\u5230Pilot\u3002Pilot\u6839\u636e\u6807\u7b7e\u548c\u670d\u52a1\u4ee3\u7406\u9644\u5c5e\u7684\u670d\u52a1\u5c06\u670d\u52a1\u4ee3\u7406\u8fdb\u884c\u5206\u7ec4\u3002Pilot\u4f7f\u7528\u8fd9\u4e2a\u6a21\u578b\u4e3a\u6bcf\u7ec4\u8fde\u63a5\u7684\u670d\u52a1\u4ee3\u7406\uff0c\u751f\u6210\u53d1\u73b0\u670d\u52a1\uff08xDS\uff09\u54cd\u5e94\uff0c\u5f53\u670d\u52a1\u4ee3\u7406\u8fde\u63a5\u540e\uff0cPilot\u53d1\u9001\u73af\u5883\u7684\u5f53\u524d\u7684\u72b6\u6001\u548c\u914d\u7f6e\u3002\u5982\u679c\u57fa\u7840\u5e73\u53f0\u7684\u72b6\u6001\u53d8\u5316\u65f6\uff0c\u6a21\u578b\u4f1a\u4ee5\u4e00\u5b9a\u7684\u9891\u7387\u8fdb\u884c\u66f4\u65b0\uff0c\u66f4\u65b0\u6a21\u578b\u9700\u8981\u66f4\u65b0\u5f53\u524d\u7684xDS\u7684\u914d\u7f6e\u96c6\uff0c\u5f53xDS\u914d\u7f6e\u6539\u53d8\u540e\uff0cPilot\u4f1a\u8ba1\u7b97\u53d7\u5f71\u54cd\u7684\u670d\u52a1\u4ee3\u7406\u7ec4\uff0c\u5e76\u5c06\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u63a8\u9001\u7ed9\u4ed6\u4eec\u3002","title":"13\u3001Istiod"},{"location":"chap9/24Istio_troubleshoot/","text":"\u7b2c\u4e94\u8282 Istio \u5e38\u89c1\u7684 10 \u4e2a\u5f02\u5e38\u5206\u6790 1\u3001Service \u7aef\u53e3\u547d\u540d\u7ea6\u675f Istio \u652f\u6301\u591a\u5e73\u53f0\uff0c\u4e0d\u8fc7 Istio \u548c Kubernetes \u7684\u517c\u5bb9\u6027\u662f\u6700\u4f18\u7684\uff0c\u4e0d\u7ba1\u662f\u8bbe\u8ba1\u7406\u5ff5\uff0c\u6838\u5fc3\u56e2\u961f\u8fd8\u662f\u793e\u533a\uff0c \u90fd\u6709\u4e00\u8109\u76f8\u627f\u7684\u610f\u601d\u3002 \u4f46 Istio \u548c Kubernetes \u7684\u9002\u914d\u5e76\u975e\u5b8c\u5168\u6ca1\u6709\u51b2\u7a81\uff0c\u4e00\u4e2a\u5178\u578b\u95ee\u9898\u5c31\u662f Istio \u9700\u8981 Kubernetes Service \u6309\u7167\u534f\u8bae\u8fdb\u884c\u7aef\u53e3\u547d\u540d\uff08 Port Naming \uff09 \u3002 \u7aef\u53e3\u547d\u540d\u4e0d\u6ee1\u8db3\u7ea6\u675f\u800c\u5bfc\u81f4\u7684\u6d41\u91cf\u5f02\u5e38\uff0c\u662f\u4f7f\u7528 Mesh \u8fc7\u7a0b\u4e2d\u6700\u5e38\u89c1\u7684\u95ee\u9898\uff0c\u5176\u73b0\u8c61\u662f\u534f\u8bae\u76f8\u5173\u7684\u6d41\u63a7\u89c4\u5219\u4e0d\u751f\u6548\uff0c\u8fd9\u901a\u5e38\u53ef\u4ee5\u901a\u8fc7\u68c0\u67e5\u8be5 Port LDS \u4e2d filter \u7684\u7c7b\u578b\u6765\u5b9a\u4f4d \u3002 1-1 \u539f\u56e0 Kubernetes \u7684\u7f51\u7edc\u5bf9\u5e94\u7528\u5c42\u662f\u65e0\u611f\u77e5\u7684 \uff0c Kubernetes \u7684\u4e3b\u8981\u6d41\u91cf\u8f6c\u53d1\u903b\u8f91\u53d1\u751f\u5728 Node \u4e0a\uff0c\u7531 iptables/IPVS \u6765\u5b9e\u73b0\uff0c\u8fd9\u4e9b\u89c4\u5219\u5e76\u4e0d\u5173\u5fc3\u5e94\u7528\u5c42\u91cc\u662f\u4ec0\u4e48\u534f\u8bae\u3002 Istio \u7684\u6838\u5fc3\u80fd\u529b\u662f\u5bf9 7 \u5c42\u6d41\u91cf\u8fdb\u884c\u7ba1\u63a7\uff0c\u4f46\u524d\u63d0\u6761\u4ef6\u662f Istio \u5fc5\u987b\u77e5\u9053\u6bcf\u4e2a\u53d7\u7ba1\u63a7\u7684\u670d\u52a1\u662f\u4ec0\u4e48\u534f\u8bae\uff0c Istio \u4f1a\u6839\u636e\u7aef\u53e3\u534f\u8bae\u7684\u4e0d\u540c\uff0c\u4e0b\u53d1\u4e0d\u540c\u7684\u6d41\u63a7\u529f\u80fd\uff08 Envoy filter \uff09\uff0c\u800c Kubernetes \u8d44\u6e90\u5b9a\u4e49\u91cc\u5e76\u4e0d\u5305\u62ec\u4e03\u5c42\u534f\u8bae\u4fe1\u606f\uff0c\u6240\u4ee5 Istio \u9700\u8981\u7528\u6237\u663e\u5f0f\u63d0\u4f9b\u3002 Istio \u7684\u89e3\u51b3\u65b9\u6848\uff1aProtocol Sniffing \u534f\u8bae\u55c5\u63a2\u6982\u8981\uff1a \u68c0\u6d4b TLS CLIENT_HELLO \u63d0\u53d6 SNI\u3001ALPN\u3001NPN \u7b49\u4fe1\u606f \u57fa\u4e8e\u5e38\u89c1\u534f\u8bae\u7684\u5df2\u77e5\u5178\u578b\u7ed3\u6784\uff0c\u5c1d\u8bd5\u68c0\u6d4b\u5e94\u7528\u5c42 Plaintext \u5185\u5bb9\uff1a \u57fa\u4e8e HTTP2 spec: Connection Preface \uff0c\u5224\u65ad\u662f\u5426\u4e3a HTTP/2 \u57fa\u4e8e HTTP header \u7ed3\u6784\uff0c\u5224\u65ad\u662f\u5426\u662f HTTP/1.x \u8fc7\u7a0b\u4e2d\u4f1a\u8bbe\u7f6e\u8d85\u65f6\u63a7\u5236\u548c\u68c0\u6d4b\u5305\u5927\u5c0f\u9650\u5236\uff0c \u9ed8\u8ba4\u6309\u7167\u534f\u8bae TCP \u5904\u7406 1-2 \u6700\u4f73\u5b9e\u8df5 Protocol Sniffing \u51cf\u5c11\u4e86\u65b0\u624b\u4f7f\u7528 Istio \u6240\u9700\u7684\u914d\u7f6e\uff0c\u4f46\u662f\u53ef\u80fd\u4f1a\u5e26\u6765\u4e0d\u786e\u5b9a\u7684\u884c\u4e3a\u3002\u4e0d\u786e\u5b9a\u7684\u884c\u4e3a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u662f\u5e94\u8be5\u5c3d\u91cf\u907f\u514d\u7684\u3002 \u4e00\u4e9b\u55c5\u63a2\u5931\u6548\u7684\u4f8b\u5b50\uff1a \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4f7f\u7528\u7740\u67d0\u7c7b\u975e\u6807\u51c6\u7684\u4e03\u5c42\u534f\u8bae\uff0c\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u53ef\u4ee5\u6b63\u786e\u89e3\u6790\uff0c\u4f46\u662f\u4e0d\u80fd\u786e\u4fdd Istio \u81ea\u52a8\u55c5\u63a2\u903b\u8f91\u8ba4\u53ef\u8fd9\u7c7b\u975e\u6807\u51c6\u534f\u8bae\u3002\u6bd4\u5982\u5bf9\u4e8e HTTP \u534f\u8bae\uff0c\u6807\u51c6\u7684\u6362\u884c\u5206\u9694\u662f\u7528 CRLF \uff080x0d 0x0a , \u4f46\u662f\u5927\u90e8\u5206 HTTP \u7c7b\u5e93\u4f1a\u4f7f\u7528\u5e76\u8ba4\u53ef LF\uff080x0a\uff09 \u4f5c\u4e3a\u5206\u9694\u3002 \u67d0\u4e9b\u81ea\u5b9a\u4e49\u79c1\u6709\u534f\u8bae\uff0c\u6570\u636e\u6d41\u7684\u8d77\u59cb\u683c\u5f0f\u548c HTTP \u62a5\u6587\u683c\u5f0f\u7c7b\u4f3c\uff0c\u4f46\u662f\u540e\u7eed\u6570\u636e\u6d41\u662f\u81ea\u5b9a\u4e49\u683c\u5f0f\uff1a \u672a\u5f00\u542f\u55c5\u63a2\u65f6\uff1a\u6570\u636e\u6d41\u6309\u7167 L4 TCP \u8fdb\u884c\u8def\u7531\uff0c\u7b26\u5408\u7528\u6237\u671f\u671b \u5982\u679c\u5f00\u542f\u55c5\u63a2\uff1a\u6570\u636e\u6d41\u6700\u5f00\u59cb\u4f1a\u88ab\u8ba4\u5b9a\u4e3a L7 http \u534f\u8bae\uff0c\u4f46\u662f\u540e\u7eed\u6570\u636e\u4e0d\u7b26\u5408 HTTP \u683c\u5f0f\uff0c\u6d41\u91cf\u5c06\u88ab\u4e2d\u65ad \u5efa\u8bae\u751f\u4ea7\u73af\u5883\u4e0d\u4f7f\u7528\u534f\u8bae\u55c5\u63a2\uff0c\u63a5\u5165 Mesh \u7684 Service \u5e94\u8be5\u6309\u7167\u7ea6\u5b9a\u4f7f\u7528\u534f\u8bae\u524d\u7f00\u8fdb\u884c\u547d\u540d \u3002 2\u3001\u6d41\u63a7\u89c4\u5219\u4e0b\u53d1\u987a\u5e8f\u95ee\u9898 2-1 \u5f02\u5e38\u63cf\u8ff0 \u5728\u6279\u91cf\u66f4\u65b0\u6d41\u91cf\u89c4\u5219\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5076\u5c14\u4f1a\u51fa\u73b0\u6d41\u91cf\u5f02\u5e38\uff08 503 \uff09\uff0c Envoy \u65e5\u5fd7\u4e2d RESPONSE_FLAGS \u5305\u542b \u300cNR\u300d \u6807\u5fd7\uff08 No route configured \uff09\uff0c\u6301\u7eed\u65f6\u95f4\u4e0d\u957f\uff0c\u4f1a\u81ea\u52a8\u6062\u590d\u3002 2-2 \u539f\u56e0\u5206\u6790 \u5f53\u7528\u6237\u4f7f\u7528 kubectl apply -f multiple-virtualservice-destinationrule.yaml \u65f6 \u8fd9\u4e9b\u5bf9\u8c61\u7684\u4f20\u64ad\u548c\u751f\u6548\u5148\u540e\u987a\u5e8f\u662f\u4e0d\u4fdd\u8bc1\u7684\uff0c\u6240\u8c13\u6700\u7ec8\u4e00\u81f4\u6027\uff0c\u6bd4\u5982 VirtualService \u4e2d\u5f15\u7528\u4e86\u67d0\u4e00\u4e2a DestinationRule \u5b9a\u4e49\u7684\u5b50\u7248\u672c\uff0c\u4f46\u662f\u8fd9\u4e2a DestinationRule \u8d44\u6e90\u7684\u4f20\u64ad\u548c\u751f\u6548\u53ef\u80fd\u5728\u65f6\u95f4\u4e0a\u843d\u540e\u4e8e\u8be5 VirtualService \u8d44\u6e90\u3002 \u6700\u4f73\u5b9e\u8df5\uff1a Make Before Break \u5c06\u66f4\u65b0\u8fc7\u7a0b\u4ece\u6279\u91cf\u5355\u6b65\u62c6\u5206\u4e3a\u591a\u6b65\u9aa4\uff0c \u786e\u4fdd\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u5f15\u7528\u4e0d\u5b58\u5728\u7684 subset \uff1a \u5f53\u65b0\u589e DestinationRule subset \u65f6\uff0c \u5e94\u8be5\u5148 apply DestinationRule subset \uff0c\u7b49\u5f85 subset \u751f\u6548\u540e\uff0c\u518d apply \u5f15\u7528\u4e86\u8be5 subset \u7684 VirtualService \u3002 \u5f53\u5220\u9664 DestinationRule subset \u65f6\uff0c\u5e94\u8be5\u5148 \u5220\u9664 VirtualService \u4e2d\u5bf9\u8be5 subset \u7684\u5f15\u7528\uff0c\u7b49\u5f85 VirtualService \u7684\u4fee\u6539\u751f\u6548\u540e\uff0c\u5728\u6267\u884c\u5220\u9664 DestinationRule subset \u3002 3. \u8bf7\u6c42\u4e2d\u65ad\u5206\u6790 \u8bf7\u6c42\u5f02\u5e38\uff0c\u5230\u5e95\u662f Istio \u6d41\u63a7\u89c4\u5219\u5bfc\u81f4\uff0c\u8fd8\u662f\u4e1a\u52a1\u5e94\u7528\u7684\u8fd4\u56de\uff0c\u6d41\u91cf\u65ad\u70b9\u51fa\u73b0\u5728\u54ea\u4e2a\u5177\u4f53\u7684 Pod\uff1f \u8fd9\u662f\u4f7f\u7528 Mesh \u6700\u5e38\u89c1\u7684\u56f0\u5883\uff0c\u5728\u5fae\u670d\u52a1\u4e2d\u5f15\u5165 Envoy \u4f5c\u4e3a\u4ee3\u7406\u540e\uff0c\u5f53\u6d41\u91cf\u8bbf\u95ee\u548c\u9884\u671f\u884c\u4e3a\u4e0d\u7b26\u65f6\uff0c\u7528\u6237\u5f88\u96be\u5feb\u901f\u786e\u5b9a\u95ee\u9898\u662f\u51fa\u5728\u54ea\u4e2a\u73af\u8282\u3002\u5ba2\u6237\u7aef\u6536\u5230\u7684\u5f02\u5e38\u54cd\u5e94\uff0c\u8bf8\u5982 403 \u3001 404 \u3001 503 \u6216\u8005\u8fde\u63a5\u4e2d\u65ad\u7b49\uff0c\u53ef\u80fd\u662f\u94fe\u8def\u4e2d\u4efb\u4e00 Sidecar \u6267\u884c\u6d41\u91cf\u7ba1\u63a7\u7684\u7ed3\u679c\uff0c \u4f46\u4e5f\u6709\u53ef\u80fd\u662f\u6765\u81ea\u67d0\u4e2a\u670d\u52a1\u7684\u5408\u7406\u903b\u8f91\u54cd\u5e94\u3002 Envoy \u6d41\u91cf\u6a21\u578b Envoy \u63a5\u53d7\u8bf7\u6c42\u6d41\u91cf\u53eb\u505a Downstream \uff0c Envoy \u53d1\u51fa\u8bf7\u6c42\u6d41\u91cf\u53eb\u505a Upstream \u3002\u5728\u5904\u7406 Downstream \u548c Upstream \u8fc7\u7a0b\u4e2d\uff0c\u5206\u522b\u4f1a\u6d89\u53ca 2 \u4e2a\u6d41\u91cf\u7aef\u70b9\uff0c\u5373\u8bf7\u6c42\u7684\u53d1\u8d77\u7aef\u548c\u63a5\u6536\u7aef \uff1a \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c Envoy \u4f1a\u6839\u636e\u7528\u6237\u89c4\u5219\uff0c\u8ba1\u7b97\u51fa\u7b26\u5408\u6761\u4ef6\u7684\u8f6c\u53d1\u76ee\u7684\u4e3b\u673a\u96c6\u5408\uff0c\u8fd9\u4e2a\u96c6\u5408\u53eb\u505a UPSTREAM_CLUSTER \uff0c\u5e76\u6839\u636e\u8d1f\u8f7d\u5747\u8861\u89c4\u5219\uff0c\u4ece\u8fd9\u4e2a\u96c6\u5408\u4e2d\u9009\u62e9\u4e00\u4e2a host \u4f5c\u4e3a\u6d41\u91cf\u8f6c\u53d1\u7684\u63a5\u6536\u7aef\u70b9\uff0c\u8fd9\u4e2a host \u5c31\u662f UPSTREAM_HOST \u3002 \u4ee5\u4e0a\u5c31\u662f Envoy \u8bf7\u6c42\u5904\u7406\u7684\u6d41\u91cf\u4e94\u5143\u7ec4\u4fe1\u606f\uff0c \u8fd9\u662f Envoy \u65e5\u5fd7\u91cc\u6700\u91cd\u8981\u7684\u90e8\u5206\uff0c\u901a\u8fc7\u8fd9\u4e2a\u4e94\u5143\u7ec4\u6211\u4eec\u53ef\u4ee5\u51c6\u786e\u7684\u89c2\u6d4b\u6d41\u91cf\u300c\u4ece\u54ea\u91cc\u6765\u300d\u548c\u300c\u5230\u54ea\u91cc\u53bb\u300d\u3002 UPSTREAM_CLUSTER DOWNSTREAM_REMOTE_ADDRESS DOWNSTREAM_LOCAL_ADDRESS UPSTREAM_LOCAL_ADDRESS UPSTREAM_HOST \u65e5\u5fd7\u5206\u6790\u793a\u4f8b \u901a\u8fc7\u65e5\u5fd7\u91cd\u70b9\u89c2\u6d4b 2 \u4e2a\u4fe1\u606f\uff1a \u65ad\u70b9\u662f\u5728\u54ea\u91cc \uff1f \u539f\u56e0\u662f\u4ec0\u4e48\uff1f \u793a\u4f8b\u4e00\uff1a\u4e00\u6b21\u6b63\u5e38\u7684 client-server \u8bf7\u6c42\u3002 \u53ef\u4ee5\u770b\u5230 2 \u7aef\u65e5\u5fd7\u5305\u542b\u76f8\u540c\u7684 request ID \uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06\u6d41\u91cf\u5206\u6790\u4e32\u8054\u8d77\u6765\u3002 \u793a\u4f8b\u4e8c\uff1a no healthy upstream \uff0c\u6bd4\u5982\u76ee\u6807 deployment \u5065\u5eb7\u526f\u672c\u6570\u4e3a 0 \u3002 \u65e5\u5fd7\u4e2d flag\u300cUH\u300d \u8868\u793a upstream cluster \u4e2d\u6ca1\u6709\u5065\u5eb7\u7684 host \u3002 \u793a\u4f8b\u4e09\uff1a No route configured \uff0c\u6bd4\u5982 DestinationRule \u7f3a\u4e4f\u5bf9\u5e94\u7684 subset \u65e5\u5fd7\u4e2d flag\u300cNR\u300d \u8868\u793a\u627e\u4e0d\u5230\u8def\u7531\u3002 \u793a\u4f8b\u56db\uff1a Upstream connection failure \uff0c\u6bd4\u5982\u670d\u52a1\u672a\u6b63\u5e38\u76d1\u542c\u7aef\u53e3\u3002 \u65e5\u5fd7\u4e2d flag\u300cUF\u300d \u8868\u793a Upstream \u8fde\u63a5\u5931\u8d25\uff0c\u636e\u6b64\u53ef\u4ee5\u5224\u65ad\u51fa\u6d41\u91cf\u65ad\u70b9\u4f4d\u7f6e\u3002 4\u3001 Sidecar \u548c User Container \u542f\u52a8\u987a\u5e8f 4-1 \u5f02\u5e38\u63cf\u8ff0 Sidecar \u6a21\u5f0f\u5728 Kubernetes \u4e16\u754c\u5f88\u6d41\u884c\uff0c\u4f46\u5bf9\u76ee\u524d\u7684 Kubernetes\uff08V1.17\uff09 \u6765\u8bf4\uff0c\u5e76\u6ca1\u6709 Sidecar \u7684\u6982\u5ff5\uff0c Sidecar \u5bb9\u5668\u7684\u89d2\u8272\u662f\u7528\u6237\u4e3b\u89c2\u8d4b\u4e88\u7684\u3002 \u5bf9 Istio \u7528\u6237\u6765\u8bf4\uff0c\u4e00\u4e2a\u5e38\u89c1\u7684\u56f0\u6270\u662f\uff1a Sidecar \u548c\u7528\u6237\u5bb9\u5668\u7684\u542f\u52a8\u987a\u5e8f\uff1a Sidecar\uff08Envoy\uff09 \u548c\u7528\u6237\u5bb9\u5668\u7684\u542f\u52a8\u987a\u5e8f\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u5982\u679c\u7528\u6237\u5bb9\u5668\u5148\u542f\u52a8\u4e86\uff0c Envoy \u8fd8\u672a\u5b8c\u6210\u542f\u52a8\uff0c\u8fd9\u65f6\u5019\u7528\u6237\u5bb9\u5668\u5f80\u5916\u53d1\u9001\u8bf7\u6c42\uff0c\u8bf7\u6c42\u4ecd\u7136\u4f1a\u88ab\u62e6\u622a\uff0c\u53d1\u5f80\u672a\u542f\u52a8\u7684 Envoy \uff0c\u8bf7\u6c42\u5f02\u5e38\u3002 \u5728 Pod \u7ec8\u6b62\u9636\u6bb5\uff0c\u4e5f\u4f1a\u6709\u7c7b\u4f3c\u7684\u5f02\u5e38\uff0c\u6839\u6e90\u4ecd\u7136\u662f Sidecar \u548c\u666e\u901a\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u7684\u4e0d\u786e\u5b9a\u6027\u3002 4-2 \u89e3\u51b3\u65b9\u6848 \u76ee\u524d\u5e38\u89c4\u7684\u89c4\u907f\u65b9\u6848\u4e3b\u8981\u662f\u6709\u8fd9\u6837\u51e0\u79cd\uff1a \u4e1a\u52a1\u5bb9\u5668\u5ef6\u8fdf\u51e0\u79d2\u542f\u52a8\uff0c\u6216\u8005\u5931\u8d25\u91cd\u8bd5 \u542f\u52a8\u811a\u672c\u4e2d\u4e3b\u52a8\u63a2\u6d4b Envoy \u662f\u5426 ready \uff0c\u5982 127.0.0.1:15020/healthz/ready \u65e0\u8bba\u54ea\u79cd\u65b9\u6848\u90fd\u663e\u5f97\u5f88\u8e69\u811a\uff0c\u4e3a\u4e86\u5f7b\u5e95\u89e3\u51b3\u4e0a\u8ff0\u75db\u70b9\uff0c \u4ece Kubernetes 1.18 \u7248\u672c\u5f00\u59cb\uff0c Kubernetes \u5185\u7f6e\u7684 Sidecar \u529f\u80fd\u5c06\u786e\u4fdd Sidecar \u5728\u6b63\u5e38\u4e1a\u52a1\u6d41\u7a0b\u5f00\u59cb\u4e4b\u524d\u5c31\u542f\u52a8\u5e76\u8fd0\u884c\uff0c\u5373\u901a\u8fc7\u66f4\u6539 Pod \u7684\u542f\u52a8\u751f\u547d\u5468\u671f\uff0c\u5728 init \u5bb9\u5668\u5b8c\u6210\u540e\u542f\u52a8 Sidecar \u5bb9\u5668\uff0c\u5728 Sidecar \u5bb9\u5668\u5c31\u7eea\u540e\u542f\u52a8\u4e1a\u52a1\u5bb9\u5668\uff0c\u4ece\u542f\u52a8\u6d41\u7a0b\u4e0a\u4fdd\u8bc1\u987a\u5e8f\u6027 \u3002 init \u5bb9\u5668 => Sidecar \u5bb9\u5668 => \u4e1a\u52a1\u5bb9\u5668 \u800c Pod \u7ec8\u6b62\u9636\u6bb5\uff0c\u53ea\u6709\u5f53\u6240\u6709\u666e\u901a\u5bb9\u5668\u90fd\u5df2\u5230\u8fbe\u7ec8\u6b62\u72b6\u6001\uff08 Succeeded for restartPolicy=OnFailure \u6216 Succeeded/Failed for restartPolicy=Never \uff09\uff0c\u624d\u4f1a\u5411 Sidecar \u5bb9\u5668\u53d1\u9001 SIGTERM \u4fe1\u53f7\u3002 5\u3001 Ingress Gateway \u548c Service \u7aef\u53e3\u8054\u52a8 Ingress Gateway \u89c4\u5219\u4e0d\u751f\u6548\u7684\u4e00\u4e2a\u5e38\u89c1\u539f\u56e0\u662f\uff1a Gateway \u7684\u76d1\u542c\u7aef\u53e3\u5728\u5bf9\u5e94\u7684 Kubernetes Service \u4e0a\u6ca1\u6709\u5f00\u542f\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u7406\u89e3 Istio Ingress Gateway \u548c Kubernetes Service \u7684\u5173\u7cfb\uff1a \u4e0a\u56fe\u4e2d\uff0c\u867d\u7136 Gateway \u5b9a\u4e49\u671f\u671b\u7ba1\u63a7\u7aef\u53e3 b \u548c c \uff0c\u4f46\u662f\u5b83\u5bf9\u5e94\u7684 Service \uff08\u901a\u8fc7\u817e\u8baf\u4e91 CLB\uff09\u53ea\u5f00\u542f\u4e86\u7aef\u53e3 a \u548c b \uff0c\u56e0\u6b64\u6700\u7ec8\u4ece LB \u7aef\u53e3 b \u8fdb\u6765\u7684\u6d41\u91cf\u624d\u80fd\u88ab Istio Gateway \u7ba1\u63a7\u3002 Istio Gateway \u548c Kubernetes Service \u6ca1\u6709\u76f4\u63a5\u7684\u5173\u8054\uff0c\u4e8c\u8005\u90fd\u662f\u901a\u8fc7 selector \u53bb\u7ed1\u5b9a Pod \uff0c\u5b9e\u73b0\u95f4\u63a5\u5173\u8054\u3002 Istio CRD Gateway \u53ea\u5b9e\u73b0\u4e86\u5c06\u7528\u6237\u6d41\u63a7\u89c4\u5219\u4e0b\u53d1\u5230\u7f51\u683c\u8fb9\u7f18\u8282\u70b9\uff0c\u6d41\u91cf\u4ecd\u9700\u8981\u901a\u8fc7 LB \u63a7\u5236\u624d\u80fd\u8fdb\u5165\u7f51 \u683c\u3002 \u817e\u8baf\u4e91 TKE Mesh \u5b9e\u73b0\u4e86 Gateway-Service \u5b9a\u4e49\u4e2d\u7684 Port \u52a8\u6001\u8054\u52a8\uff0c\u8ba9\u7528\u6237\u805a\u7126\u5728\u7f51\u683c\u5185\u7684\u914d\u7f6e\u3002 6\u3001 VirtualService \u4f5c\u7528\u57df VirtualService \u5305\u542b\u4e86\u5927\u90e8\u5206 outbound \u7aef\u7684\u6d41\u91cf\u89c4\u5219\uff0c\u5b83\u65e2\u53ef\u4ee5\u5e94\u7528\u5230\u7f51\u683c\u5185\u90e8\u6570\u636e\u9762\u4ee3\u7406\u4e2d\uff0c \u4e5f\u53ef\u4ee5\u5e94\u7528\u5230\u7f51\u683c\u8fb9\u7f18\u7684\u4ee3\u7406\u4e2d\u3002 VirtualService \u7684\u5c5e\u6027 Gateways \u7528\u4e8e\u6307\u5b9a VirtualService \u7684\u751f\u6548\u8303\u56f4\uff1a \u5982\u679c VirtualService.gateways \u4e3a\u7a7a\uff0c\u5219 Istio \u4e3a\u5176\u8d4b\u9ed8\u8ba4\u503c Mesh \uff0c\u4ee3\u8868\u751f\u6548\u8303\u56f4\u4e3a\u7f51\u683c\u5185\u90e8 \u5982\u679c\u5e0c\u671b VirtualService \u5e94\u7528\u5230\u5177\u4f53\u8fb9\u7f18\u7f51\u5173\u4e0a\uff0c\u5219\u9700\u8981\u663e\u793a\u4e3a\u5176\u8d4b\u503c\uff1a gateway-name1 \uff0c gateway-name2 \u5982\u679c\u5e0c\u671b VirtualService \u540c\u65f6\u5e94\u7528\u5230\u7f51\u683c\u5185\u90e8\u548c\u8fb9\u7f18\u7f51\u5173\u4e0a\uff0c\u5219\u9700\u8981\u663e\u793a\u5730\u628a Mesh \u503c\u52a0\u5165 VirtualService.gateways \uff0c\u5982 Mesh \uff0c gateway-name1 \uff0c gateway-name2 \u4e00\u4e2a\u5e38\u89c1\u7684\u95ee\u9898\u662f\u4ee5\u4e0a\u7684\u7b2c\u4e09\u79cd\u60c5\u51b5\uff0c VirtualService \u6700\u5f00\u59cb\u4f5c\u7528\u4e8e\u7f51\u5173\u5185\u90e8\uff0c\u540e\u7eed\u8981\u5c06\u5176\u89c4\u5219\u6269\u5c55\u5230\u8fb9\u7f18\u7f51\u5173\u4e0a\uff0c\u7528\u6237\u5f80\u5f80\u53ea\u4f1a\u6dfb\u52a0\u5177\u4f53 Gateway Name \uff0c\u800c\u9057\u6f0f Mesh \uff1a Istio \u81ea\u52a8\u7ed9 VirtualService.gateways \u8bbe\u7f6e\u9ed8\u8ba4\u503c\uff0c\u672c\u610f\u662f\u4e3a\u4e86\u7b80\u5316\u7528\u6237\u7684\u914d\u7f6e\uff0c\u4f46\u662f\u5f80\u5f80\u4f1a\u5bfc\u81f4\u7528\u6237\u5e94\u7528\u4e0d\u5f53\uff0c\u4e00\u4e2a feature \u4e00\u4e0d\u5c0f\u5fc3\u4f1a\u88ab\u7528\u6210\u4e86 bug \u3002 7\u3001 VirtualService \u4e0d\u652f\u6301 Host Fragment 7-1 \u5f02\u5e38\u6848\u4f8b \u5bf9\u67d0\u4e00 host \u65b0\u589e\u3001\u4fee\u6539 VirtualService \uff0c\u53d1\u73b0\u89c4\u5219\u59cb\u7ec8\u65e0\u6cd5\u751f\u6548\uff0c\u6392\u67e5\u53d1\u73b0\u5b58\u5728\u5176\u4ed6 VirtualService \u4e5f\u5bf9\u8be5 host \u5e94\u7528\u4e86\u5176\u4ed6\u89c4\u5219\uff0c\u89c4\u5219\u5185\u5bb9\u53ef\u80fd\u4e0d\u51b2\u7a81\uff0c\u4f46\u8fd8\u662f\u53ef\u80fd\u51fa\u73b0\u5176\u4e2d\u4e00\u4e9b\u89c4\u5219\u65e0\u6cd5\u751f\u6548\u7684\u60c5\u51b5\u3002 7-2 \u80cc\u666f VirtualService \u91cc\u7684\u89c4\u5219\uff0c\u6309\u7167 host \u8fdb\u884c\u805a\u5408 \u968f\u7740\u4e1a\u52a1\u7684\u589e\u957f\uff0c VirtualService \u7684\u5185\u5bb9\u4f1a\u5feb\u901f\u589e\u957f\uff0c\u4e00\u4e2a host \u7684\u6d41\u63a7\u89c4\u5219\uff0c\u53ef\u80fd\u4f1a\u7531\u4e0d\u540c\u7684\u56e2\u961f\u5206\u5e03\u7ef4\u62a4\u3002\u5982\u5b89\u5168\u89c4\u5219\u548c\u4e1a\u52a1\u89c4\u5219\u5206\u5f00\uff0c\u4e0d\u540c\u4e1a\u52a1\u6309\u7167\u5b50 path \u5206\u5f00 \u76ee\u524d Istio \u5bf9 cross-resource VirtualService \u7684\u652f\u6301\u60c5\u51b5\uff1a \u5728\u7f51\u683c\u8fb9\u7f18\uff08 Gateway \uff09\uff0c\u540c\u4e00\u4e2a host \u7684\u6d41\u63a7\u89c4\u5219\uff0c\u652f\u6301\u5206\u5e03\u5230\u591a\u4e2a VirtualService \u5bf9\u8c61\u4e2d\uff0c Istio \u81ea\u52a8\u805a\u5408\uff0c\u4f46\u4f9d\u8d56\u5b9a\u4e49\u987a\u5e8f\u4ee5\u53ca\u7528\u6237\u81ea\u884c\u907f\u514d\u51b2\u7a81 \u3002 \u5728\u7f51\u683c\u5185\u90e8\uff08 for Sidecar \uff09\uff0c\u540c\u4e00\u4e2a host \u7684\u6d41\u63a7\u89c4\u5219\uff0c\u4e0d\u652f\u6301\u5206\u5e03\u5230\u591a\u4e2a VirtualService \u5bf9\u8c61\u4e2d\uff0c\u5982\u679c\u540c\u4e00\u4e2a host \u5b58\u5728\u591a\u4e2a VirtualService \uff0c\u53ea\u6709\u7b2c\u4e00\u4e2a VirtualService \u751f\u6548\uff0c\u4e14\u6ca1\u6709\u51b2\u7a81\u68c0\u6d4b\u3002 VirtualService \u4e0d\u80fd\u5f88\u597d\u652f\u6301 host \u89c4\u5219\u5206\u7247\uff0c\u4f7f\u5f97\u56e2\u961f\u7684\u7ef4\u62a4\u804c\u8d23\u4e0d\u80fd\u5f88\u597d\u7684\u89e3\u8026\uff0c\u914d\u7f6e\u4eba\u5458\u9700\u8981\u77e5\u6089\u76ee\u6807 host \u7684\u6240\u6709\u6d41\u63a7\u89c4\u5219\uff0c\u624d\u6709\u4fe1\u5fc3\u53bb\u4fee\u6539 VirtualService \u3002 Istio \u89e3\u51b3\u65b9\u6848\uff1a Virtual Service chaining\uff08plan in 1.6\uff09 Istio \u8ba1\u5212\u5728 1.6 \u4e2d\u652f\u6301 Virtual Service \u4ee3\u7406\u94fe\uff1a Virtual Service \u652f\u6301\u5206\u7247\u5b9a\u4e49 + \u4ee3\u7406\u94fe \u652f\u6301\u56e2\u961f\u5bf9\u540c\u4e00 host \u7684 Virtual Service \u8fdb\u884c\u7075\u6d3b\u5206\u7247\uff0c\u6bd4\u5982\u6309\u7167 SecOps/Netops/Business \u7279\u6027\u5206\u79bb\uff0c\u5404\u56e2\u961f\u7ef4\u62a4\u5404\u79cd\u72ec\u7acb\u7684 Virtual Service 8\u3001\u5168\u94fe\u8def\u8ddf\u8e2a\u5e76\u975e\u5b8c\u5168\u900f\u660e\u63a5\u5165 8-1 \u5f02\u5e38\u6848\u4f8b \u5fae\u670d\u52a1\u63a5\u5165 Service Mesh \u540e\uff0c\u94fe\u8def\u8ddf\u8e2a\u6570\u636e\u6ca1\u6709\u5f62\u6210\u4e32\u8054\u3002 8-2 \u539f\u56e0 Service Mesh \u9065\u6d4b\u7cfb\u7edf\u4e2d\uff0c\u5bf9\u8c03\u7528\u94fe\u8ddf\u8e2a\u7684\u5b9e\u73b0\uff0c\u5e76\u975e\u5b8c\u5168\u7684\u96f6\u5165\u4fb5\uff0c\u9700\u8981\u7528\u6237\u4e1a\u52a1\u4f5c\u51fa\u5c11\u91cf\u7684\u4fee\u6539\u624d\u80fd\u652f\u6301\uff0c\u5177\u4f53\u5730\uff0c\u5728\u7528\u6237\u53d1\u51fa\uff08 HTTP/gRPC \uff09 RPC \u65f6\uff0c \u9700\u8981\u4e3b\u52a8\u5c06\u4e0a\u6e38\u8bf7\u6c42\u4e2d\u5b58\u5728\u7684 B3 trace headers\u5199 \u5165\u4e0b\u6e38 RPC \u8bf7\u6c42\u5934\u4e2d\uff0c\u8fd9\u4e9b headers \u5305\u62ec\uff1a \u6709\u90e8\u5206\u7528\u6237\u96be\u4ee5\u7406\u89e3\uff1a\u65e2\u7136 inbound \u6d41\u91cf\u548c outbound \u6d41\u91cf\u5df2\u7ecf\u5b8c\u5168\u88ab\u62e6\u622a\u5230 Envoy \uff0c Envoy \u53ef\u4ee5\u5b9e\u73b0\u5b8c\u5168\u7684\u6d41\u91cf\u7ba1\u63a7\u548c\u4fee\u6539\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981\u5e94\u7528\u663e\u793a\u7b2c\u4f20\u9012 headers \uff1f \u5bf9\u4e8e Envoy \u6765\u8bf4\uff0c inbound \u8bf7\u6c42\u548c outbound \u8bf7\u6c42\u5b8c\u5168\u662f\u72ec\u7acb\u7684\uff0c Envoy \u65e0\u6cd5\u611f\u77e5\u8bf7\u6c42\u4e4b\u95f4\u7684\u5173\u8054\u3002\u5b9e\u9645\u4e0a\u8fd9\u4e9b\u8bf7\u6c42\u5230\u5e95\u6709\u65e0\u4e0a\u4e0b\u7ea7\u5173\u8054\uff0c\u5b8c\u5168\u7531\u5e94\u7528\u81ea\u5df1\u51b3\u5b9a\u3002 \u4e3e\u4e00\u4e2a\u7279\u6b8a\u7684\u4e1a\u52a1\u573a\u666f\uff0c\u5982\u679c Pod X \u63a5\u6536\u5230 \u8bf7\u6c42 A \uff0c\u89e6\u53d1\u7684\u4e1a\u52a1\u903b\u8f91\u662f\uff1a\u6bcf\u9694 10 \u79d2 \u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\u5230 Pod Y \uff0c\u5982 B1 \uff0c B2 \uff0c B3 \uff0c\u90a3\u4e48\u8fd9\u4e9b\u6247\u51fa\u7684\u8bf7\u6c42 Bx\uff08x=1\uff0c2\uff0c3\u2026\u2026\uff09 \uff0c\u548c\u8bf7\u6c42 A \u662f\u4ec0\u4e48\u5173\u7cfb\uff1f\u4e1a\u52a1\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u51b3\u7b56\uff1a\u8ba4\u4e3a A \u662f Bx \u7684\u7236\u8bf7\u6c42\uff0c\u6216\u8005\u8ba4\u4e3a Bx \u662f\u72ec\u7acb\u7684\u9876\u5c42\u8bf7\u6c42\u3002 9\u3001 mTLS \u5bfc\u81f4\u8fde\u63a5\u4e2d\u65ad \u5728\u5f00\u542f Istio mTLS \u7684\u7528\u6237\u573a\u666f\u4e2d\uff0c\u8bbf\u95ee\u51fa\u73b0 connection termination \u662f\u4e00\u4e2a\u9ad8\u9891\u7684\u5f02\u5e38\uff1a \u8fd9\u4e2a\u5f02\u5e38\u7684\u539f\u56e0\u548c DestinationRule \u4e2d\u7684 mTLS \u914d\u7f6e\u6709\u5173\uff0c\u662f Istio \u4e2d\u4e00\u4e2a\u4e0d\u5065\u58ee\u7684\u63a5\u53e3\u8bbe\u8ba1\u3002 \u5f53\u901a\u8fc7 MeshPolicy \u5f00\u542f\u5168\u5c40 mTLS \uff0c \u5982\u679c\u7f51\u683c\u4e2d\u6ca1\u6709\u5b9a\u4e49\u5176\u4ed6\u7684 DestinationRule \uff0c mTLS \u6b63\u5e38\u8fd0\u884c \u5982\u679c\u540e\u7eed\u7f51\u683c\u4e2d\u65b0\u589e\u4e86 DestinationRule \uff0c\u800c DestinationRule \u4e2d\u53ef\u4ee5\u8986\u76d6\u5b50\u7248\u672c\u7684 mTLS \u503c\uff08\u9ed8\u8ba4\u662f\u4e0d\u5f00\u542f\uff01\uff09\uff0c\u7528\u6237\u5728\u4f7f\u7528 DestinationRule \u65f6\uff0c\u5f80\u5f80\u5f88\u5c11\u53bb\u5173\u6ce8 mTLS \u5c5e\u6027\uff08\u7559\u7a7a\uff09\u3002\u6700\u7ec8\u5bfc\u81f4\u589e DestinationRule \u540e mTLS \u53d8\u6210\u4e86\u4e0d\u5f00\u542f\uff0c\u5bfc\u81f4 c onnection termination \u4e3a\u4e86\u4fee\u590d\u4ee5\u4e0a\u95ee\u9898\uff0c\u7528\u6237\u4e0d\u5f97\u4e0d\u5728\u6240\u6709 DestinationRule \u4e2d\u589e\u52a0 mTLS \u5c5e\u6027\u5e76\u8bbe\u7f6e\u4e3a\u5f00\u542f \u8fd9\u79cd Istio mTLS \u7528\u6237\u63a5\u53e3\u6781\u5ea6\u4e0d\u53cb\u597d\uff0c\u867d\u7136 mTLS \u9ed8\u8ba4\u505a\u5230\u4e86\u5168\u5c40\u900f\u660e\uff0c\u4e1a\u52a1\u611f\u77e5\u4e0d\u5230 mTLS \u7684\u5b58\u5728\uff0c\u4f46\u662f\u4e00\u65e6\u4e1a\u52a1\u5b9a\u4e49\u4e86 DestinationRule \uff0c DestinationRule \u5c31\u5fc5\u987b\u8981\u77e5\u9053\u5f53\u524d mTLS \u662f\u5426\u5f00\u542f\uff0c\u5e76\u4f5c\u51fa\u8c03\u6574\u3002\u8bd5\u60f3 mTLS \u914d\u7f6e\u4ea4\u7531\u5b89\u5168\u56e2\u961f\u8d1f\u8d23\uff0c\u800c\u4e1a\u52a1\u56e2\u961f\u8d1f\u8d23\u5404\u81ea\u7684 DestinationRule \uff0c\u56e2\u961f\u95f4\u7684\u8026\u5408\u4f1a\u975e\u5e38\u4e25\u91cd\u3002 10\u3001 \u7528\u6237\u670d\u52a1\u76d1\u542c\u5730\u5740\u9650\u5236 10-1 \u5f02\u5e38\u63cf\u8ff0 \u5982\u679c\u7528\u6237\u5bb9\u5668\u4e2d\u4e1a\u52a1\u8fdb\u7a0b\u76d1\u542c\u7684\u5730\u5740\u662f\u5177\u4f53IP\uff08Pod IP\uff09\uff0c\u800c\u4e0d\u662f 0.0.0.0 \uff0c\u8be5\u7528\u6237\u5bb9\u5668\u65e0\u6cd5\u6b63\u5e38\u63a5\u5165 Istio\uff0c\u6d41\u91cf\u8def\u7531\u5931\u8d25\u3002 \u8fd9\u662f\u53c8\u4e00\u4e2a\u6311\u6218 Istio \u6700\u5927\u900f\u660e\u5316\uff08 Maximize Transparency \uff09\u8bbe\u8ba1\u76ee\u6807 \u7684\u573a\u666f\u3002 10-2 \u539f\u56e0\u5206\u6790 Istio-proxy \u4e2d\u7684\u4e00\u6bb5 iptables \uff1a \u5176\u4e2d\uff0c ISTIO_IN_REDIRECT \u662f virtualInbound \uff0c\u7aef\u53e3 15006\uff1bISTIO_REDIRECT \u662f virtualOutbound \uff0c\u7aef\u53e3 15001 \u3002 \u5173\u952e\u70b9\u662f\u89c4\u5219\u4e8c\uff1a\u5982\u679c destination \u4e0d\u662f 127.0.0.1/32 \uff0c\u8f6c\u7ed9 15006 \uff08 virtualInbound \uff0c Envoy \u76d1\u542c\uff09\uff0c\u8fd9\u91cc\u5bfc\u81f4\u4e86\u5bf9 Pod IP \u7684\u6d41\u91cf\u59cb\u7ec8\u4f1a\u56de\u5230 Envoy \u3002 \u5bf9\u8be5\u89c4\u5219\u7684\u89e3\u91ca\uff1a # Redirect app calls back to itself via Envoy when using the service VIP or endpoint # address, e.g. appN => Envoy (client) => Envoy (server) => appN. \u8be5\u89c4\u5219\u662f\u5e0c\u671b\u5728\u8fd9\u91cc\u8d77\u4f5c\u7528\uff1a\u5047\u8bbe\u5f53\u524d Pod a \u5c5e\u4e8e service A \uff0c Pod \u4e2d\u7528\u6237\u5bb9\u5668\u901a\u8fc7\u670d\u52a1\u540d\u8bbf\u95ee\u670d\u52a1 A \uff0c Envoy \u4e2d\u8d1f\u8f7d\u5747\u8861\u903b\u8f91\u5c06\u8fd9\u6b21\u8bbf\u95ee\u8f6c\u53d1\u5230\u4e86\u5f53\u524d\u7684 Pod IP \uff0c Istio \u5e0c\u671b\u8fd9\u79cd\u573a\u666f\u670d\u52a1\u7aef\u4ecd\u7136\u6709\u6d41\u91cf\u7ba1\u63a7\u80fd\u529b\u3002\u5982\u56fe\u793a\uff1a 10-3 \u6539\u9020\u5efa\u8bae \u5efa\u8bae\u5e94\u7528\u5728\u63a5\u5165 Istio \u4e4b\u524d\uff0c\u8c03\u6574\u670d\u52a1\u76d1\u542c\u5730\u5740\uff0c\u4f7f\u7528 0.0.0.0 \u800c\u4e0d\u662f\u5177\u4f53 IP \u3002","title":"\u7b2c\u4e94\u8282 Istio \u5e38\u89c1\u7684 10 \u4e2a\u5f02\u5e38\u5206\u6790"},{"location":"chap9/24Istio_troubleshoot/#istio-10","text":"","title":"\u7b2c\u4e94\u8282 Istio \u5e38\u89c1\u7684 10 \u4e2a\u5f02\u5e38\u5206\u6790"},{"location":"chap9/24Istio_troubleshoot/#1service","text":"Istio \u652f\u6301\u591a\u5e73\u53f0\uff0c\u4e0d\u8fc7 Istio \u548c Kubernetes \u7684\u517c\u5bb9\u6027\u662f\u6700\u4f18\u7684\uff0c\u4e0d\u7ba1\u662f\u8bbe\u8ba1\u7406\u5ff5\uff0c\u6838\u5fc3\u56e2\u961f\u8fd8\u662f\u793e\u533a\uff0c \u90fd\u6709\u4e00\u8109\u76f8\u627f\u7684\u610f\u601d\u3002 \u4f46 Istio \u548c Kubernetes \u7684\u9002\u914d\u5e76\u975e\u5b8c\u5168\u6ca1\u6709\u51b2\u7a81\uff0c\u4e00\u4e2a\u5178\u578b\u95ee\u9898\u5c31\u662f Istio \u9700\u8981 Kubernetes Service \u6309\u7167\u534f\u8bae\u8fdb\u884c\u7aef\u53e3\u547d\u540d\uff08 Port Naming \uff09 \u3002 \u7aef\u53e3\u547d\u540d\u4e0d\u6ee1\u8db3\u7ea6\u675f\u800c\u5bfc\u81f4\u7684\u6d41\u91cf\u5f02\u5e38\uff0c\u662f\u4f7f\u7528 Mesh \u8fc7\u7a0b\u4e2d\u6700\u5e38\u89c1\u7684\u95ee\u9898\uff0c\u5176\u73b0\u8c61\u662f\u534f\u8bae\u76f8\u5173\u7684\u6d41\u63a7\u89c4\u5219\u4e0d\u751f\u6548\uff0c\u8fd9\u901a\u5e38\u53ef\u4ee5\u901a\u8fc7\u68c0\u67e5\u8be5 Port LDS \u4e2d filter \u7684\u7c7b\u578b\u6765\u5b9a\u4f4d \u3002","title":"1\u3001Service \u7aef\u53e3\u547d\u540d\u7ea6\u675f"},{"location":"chap9/24Istio_troubleshoot/#1-1","text":"Kubernetes \u7684\u7f51\u7edc\u5bf9\u5e94\u7528\u5c42\u662f\u65e0\u611f\u77e5\u7684 \uff0c Kubernetes \u7684\u4e3b\u8981\u6d41\u91cf\u8f6c\u53d1\u903b\u8f91\u53d1\u751f\u5728 Node \u4e0a\uff0c\u7531 iptables/IPVS \u6765\u5b9e\u73b0\uff0c\u8fd9\u4e9b\u89c4\u5219\u5e76\u4e0d\u5173\u5fc3\u5e94\u7528\u5c42\u91cc\u662f\u4ec0\u4e48\u534f\u8bae\u3002 Istio \u7684\u6838\u5fc3\u80fd\u529b\u662f\u5bf9 7 \u5c42\u6d41\u91cf\u8fdb\u884c\u7ba1\u63a7\uff0c\u4f46\u524d\u63d0\u6761\u4ef6\u662f Istio \u5fc5\u987b\u77e5\u9053\u6bcf\u4e2a\u53d7\u7ba1\u63a7\u7684\u670d\u52a1\u662f\u4ec0\u4e48\u534f\u8bae\uff0c Istio \u4f1a\u6839\u636e\u7aef\u53e3\u534f\u8bae\u7684\u4e0d\u540c\uff0c\u4e0b\u53d1\u4e0d\u540c\u7684\u6d41\u63a7\u529f\u80fd\uff08 Envoy filter \uff09\uff0c\u800c Kubernetes \u8d44\u6e90\u5b9a\u4e49\u91cc\u5e76\u4e0d\u5305\u62ec\u4e03\u5c42\u534f\u8bae\u4fe1\u606f\uff0c\u6240\u4ee5 Istio \u9700\u8981\u7528\u6237\u663e\u5f0f\u63d0\u4f9b\u3002 Istio \u7684\u89e3\u51b3\u65b9\u6848\uff1aProtocol Sniffing \u534f\u8bae\u55c5\u63a2\u6982\u8981\uff1a \u68c0\u6d4b TLS CLIENT_HELLO \u63d0\u53d6 SNI\u3001ALPN\u3001NPN \u7b49\u4fe1\u606f \u57fa\u4e8e\u5e38\u89c1\u534f\u8bae\u7684\u5df2\u77e5\u5178\u578b\u7ed3\u6784\uff0c\u5c1d\u8bd5\u68c0\u6d4b\u5e94\u7528\u5c42 Plaintext \u5185\u5bb9\uff1a \u57fa\u4e8e HTTP2 spec: Connection Preface \uff0c\u5224\u65ad\u662f\u5426\u4e3a HTTP/2 \u57fa\u4e8e HTTP header \u7ed3\u6784\uff0c\u5224\u65ad\u662f\u5426\u662f HTTP/1.x \u8fc7\u7a0b\u4e2d\u4f1a\u8bbe\u7f6e\u8d85\u65f6\u63a7\u5236\u548c\u68c0\u6d4b\u5305\u5927\u5c0f\u9650\u5236\uff0c \u9ed8\u8ba4\u6309\u7167\u534f\u8bae TCP \u5904\u7406","title":"1-1 \u539f\u56e0"},{"location":"chap9/24Istio_troubleshoot/#1-2","text":"Protocol Sniffing \u51cf\u5c11\u4e86\u65b0\u624b\u4f7f\u7528 Istio \u6240\u9700\u7684\u914d\u7f6e\uff0c\u4f46\u662f\u53ef\u80fd\u4f1a\u5e26\u6765\u4e0d\u786e\u5b9a\u7684\u884c\u4e3a\u3002\u4e0d\u786e\u5b9a\u7684\u884c\u4e3a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u662f\u5e94\u8be5\u5c3d\u91cf\u907f\u514d\u7684\u3002 \u4e00\u4e9b\u55c5\u63a2\u5931\u6548\u7684\u4f8b\u5b50\uff1a \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4f7f\u7528\u7740\u67d0\u7c7b\u975e\u6807\u51c6\u7684\u4e03\u5c42\u534f\u8bae\uff0c\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u53ef\u4ee5\u6b63\u786e\u89e3\u6790\uff0c\u4f46\u662f\u4e0d\u80fd\u786e\u4fdd Istio \u81ea\u52a8\u55c5\u63a2\u903b\u8f91\u8ba4\u53ef\u8fd9\u7c7b\u975e\u6807\u51c6\u534f\u8bae\u3002\u6bd4\u5982\u5bf9\u4e8e HTTP \u534f\u8bae\uff0c\u6807\u51c6\u7684\u6362\u884c\u5206\u9694\u662f\u7528 CRLF \uff080x0d 0x0a , \u4f46\u662f\u5927\u90e8\u5206 HTTP \u7c7b\u5e93\u4f1a\u4f7f\u7528\u5e76\u8ba4\u53ef LF\uff080x0a\uff09 \u4f5c\u4e3a\u5206\u9694\u3002 \u67d0\u4e9b\u81ea\u5b9a\u4e49\u79c1\u6709\u534f\u8bae\uff0c\u6570\u636e\u6d41\u7684\u8d77\u59cb\u683c\u5f0f\u548c HTTP \u62a5\u6587\u683c\u5f0f\u7c7b\u4f3c\uff0c\u4f46\u662f\u540e\u7eed\u6570\u636e\u6d41\u662f\u81ea\u5b9a\u4e49\u683c\u5f0f\uff1a \u672a\u5f00\u542f\u55c5\u63a2\u65f6\uff1a\u6570\u636e\u6d41\u6309\u7167 L4 TCP \u8fdb\u884c\u8def\u7531\uff0c\u7b26\u5408\u7528\u6237\u671f\u671b \u5982\u679c\u5f00\u542f\u55c5\u63a2\uff1a\u6570\u636e\u6d41\u6700\u5f00\u59cb\u4f1a\u88ab\u8ba4\u5b9a\u4e3a L7 http \u534f\u8bae\uff0c\u4f46\u662f\u540e\u7eed\u6570\u636e\u4e0d\u7b26\u5408 HTTP \u683c\u5f0f\uff0c\u6d41\u91cf\u5c06\u88ab\u4e2d\u65ad \u5efa\u8bae\u751f\u4ea7\u73af\u5883\u4e0d\u4f7f\u7528\u534f\u8bae\u55c5\u63a2\uff0c\u63a5\u5165 Mesh \u7684 Service \u5e94\u8be5\u6309\u7167\u7ea6\u5b9a\u4f7f\u7528\u534f\u8bae\u524d\u7f00\u8fdb\u884c\u547d\u540d \u3002","title":"1-2 \u6700\u4f73\u5b9e\u8df5"},{"location":"chap9/24Istio_troubleshoot/#2","text":"","title":"2\u3001\u6d41\u63a7\u89c4\u5219\u4e0b\u53d1\u987a\u5e8f\u95ee\u9898"},{"location":"chap9/24Istio_troubleshoot/#2-1","text":"\u5728\u6279\u91cf\u66f4\u65b0\u6d41\u91cf\u89c4\u5219\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5076\u5c14\u4f1a\u51fa\u73b0\u6d41\u91cf\u5f02\u5e38\uff08 503 \uff09\uff0c Envoy \u65e5\u5fd7\u4e2d RESPONSE_FLAGS \u5305\u542b \u300cNR\u300d \u6807\u5fd7\uff08 No route configured \uff09\uff0c\u6301\u7eed\u65f6\u95f4\u4e0d\u957f\uff0c\u4f1a\u81ea\u52a8\u6062\u590d\u3002","title":"2-1 \u5f02\u5e38\u63cf\u8ff0"},{"location":"chap9/24Istio_troubleshoot/#2-2","text":"\u5f53\u7528\u6237\u4f7f\u7528 kubectl apply -f multiple-virtualservice-destinationrule.yaml \u65f6 \u8fd9\u4e9b\u5bf9\u8c61\u7684\u4f20\u64ad\u548c\u751f\u6548\u5148\u540e\u987a\u5e8f\u662f\u4e0d\u4fdd\u8bc1\u7684\uff0c\u6240\u8c13\u6700\u7ec8\u4e00\u81f4\u6027\uff0c\u6bd4\u5982 VirtualService \u4e2d\u5f15\u7528\u4e86\u67d0\u4e00\u4e2a DestinationRule \u5b9a\u4e49\u7684\u5b50\u7248\u672c\uff0c\u4f46\u662f\u8fd9\u4e2a DestinationRule \u8d44\u6e90\u7684\u4f20\u64ad\u548c\u751f\u6548\u53ef\u80fd\u5728\u65f6\u95f4\u4e0a\u843d\u540e\u4e8e\u8be5 VirtualService \u8d44\u6e90\u3002 \u6700\u4f73\u5b9e\u8df5\uff1a Make Before Break \u5c06\u66f4\u65b0\u8fc7\u7a0b\u4ece\u6279\u91cf\u5355\u6b65\u62c6\u5206\u4e3a\u591a\u6b65\u9aa4\uff0c \u786e\u4fdd\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u5f15\u7528\u4e0d\u5b58\u5728\u7684 subset \uff1a \u5f53\u65b0\u589e DestinationRule subset \u65f6\uff0c \u5e94\u8be5\u5148 apply DestinationRule subset \uff0c\u7b49\u5f85 subset \u751f\u6548\u540e\uff0c\u518d apply \u5f15\u7528\u4e86\u8be5 subset \u7684 VirtualService \u3002 \u5f53\u5220\u9664 DestinationRule subset \u65f6\uff0c\u5e94\u8be5\u5148 \u5220\u9664 VirtualService \u4e2d\u5bf9\u8be5 subset \u7684\u5f15\u7528\uff0c\u7b49\u5f85 VirtualService \u7684\u4fee\u6539\u751f\u6548\u540e\uff0c\u5728\u6267\u884c\u5220\u9664 DestinationRule subset \u3002","title":"2-2 \u539f\u56e0\u5206\u6790"},{"location":"chap9/24Istio_troubleshoot/#3","text":"\u8bf7\u6c42\u5f02\u5e38\uff0c\u5230\u5e95\u662f Istio \u6d41\u63a7\u89c4\u5219\u5bfc\u81f4\uff0c\u8fd8\u662f\u4e1a\u52a1\u5e94\u7528\u7684\u8fd4\u56de\uff0c\u6d41\u91cf\u65ad\u70b9\u51fa\u73b0\u5728\u54ea\u4e2a\u5177\u4f53\u7684 Pod\uff1f \u8fd9\u662f\u4f7f\u7528 Mesh \u6700\u5e38\u89c1\u7684\u56f0\u5883\uff0c\u5728\u5fae\u670d\u52a1\u4e2d\u5f15\u5165 Envoy \u4f5c\u4e3a\u4ee3\u7406\u540e\uff0c\u5f53\u6d41\u91cf\u8bbf\u95ee\u548c\u9884\u671f\u884c\u4e3a\u4e0d\u7b26\u65f6\uff0c\u7528\u6237\u5f88\u96be\u5feb\u901f\u786e\u5b9a\u95ee\u9898\u662f\u51fa\u5728\u54ea\u4e2a\u73af\u8282\u3002\u5ba2\u6237\u7aef\u6536\u5230\u7684\u5f02\u5e38\u54cd\u5e94\uff0c\u8bf8\u5982 403 \u3001 404 \u3001 503 \u6216\u8005\u8fde\u63a5\u4e2d\u65ad\u7b49\uff0c\u53ef\u80fd\u662f\u94fe\u8def\u4e2d\u4efb\u4e00 Sidecar \u6267\u884c\u6d41\u91cf\u7ba1\u63a7\u7684\u7ed3\u679c\uff0c \u4f46\u4e5f\u6709\u53ef\u80fd\u662f\u6765\u81ea\u67d0\u4e2a\u670d\u52a1\u7684\u5408\u7406\u903b\u8f91\u54cd\u5e94\u3002 Envoy \u6d41\u91cf\u6a21\u578b Envoy \u63a5\u53d7\u8bf7\u6c42\u6d41\u91cf\u53eb\u505a Downstream \uff0c Envoy \u53d1\u51fa\u8bf7\u6c42\u6d41\u91cf\u53eb\u505a Upstream \u3002\u5728\u5904\u7406 Downstream \u548c Upstream \u8fc7\u7a0b\u4e2d\uff0c\u5206\u522b\u4f1a\u6d89\u53ca 2 \u4e2a\u6d41\u91cf\u7aef\u70b9\uff0c\u5373\u8bf7\u6c42\u7684\u53d1\u8d77\u7aef\u548c\u63a5\u6536\u7aef \uff1a \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c Envoy \u4f1a\u6839\u636e\u7528\u6237\u89c4\u5219\uff0c\u8ba1\u7b97\u51fa\u7b26\u5408\u6761\u4ef6\u7684\u8f6c\u53d1\u76ee\u7684\u4e3b\u673a\u96c6\u5408\uff0c\u8fd9\u4e2a\u96c6\u5408\u53eb\u505a UPSTREAM_CLUSTER \uff0c\u5e76\u6839\u636e\u8d1f\u8f7d\u5747\u8861\u89c4\u5219\uff0c\u4ece\u8fd9\u4e2a\u96c6\u5408\u4e2d\u9009\u62e9\u4e00\u4e2a host \u4f5c\u4e3a\u6d41\u91cf\u8f6c\u53d1\u7684\u63a5\u6536\u7aef\u70b9\uff0c\u8fd9\u4e2a host \u5c31\u662f UPSTREAM_HOST \u3002 \u4ee5\u4e0a\u5c31\u662f Envoy \u8bf7\u6c42\u5904\u7406\u7684\u6d41\u91cf\u4e94\u5143\u7ec4\u4fe1\u606f\uff0c \u8fd9\u662f Envoy \u65e5\u5fd7\u91cc\u6700\u91cd\u8981\u7684\u90e8\u5206\uff0c\u901a\u8fc7\u8fd9\u4e2a\u4e94\u5143\u7ec4\u6211\u4eec\u53ef\u4ee5\u51c6\u786e\u7684\u89c2\u6d4b\u6d41\u91cf\u300c\u4ece\u54ea\u91cc\u6765\u300d\u548c\u300c\u5230\u54ea\u91cc\u53bb\u300d\u3002 UPSTREAM_CLUSTER DOWNSTREAM_REMOTE_ADDRESS DOWNSTREAM_LOCAL_ADDRESS UPSTREAM_LOCAL_ADDRESS UPSTREAM_HOST \u65e5\u5fd7\u5206\u6790\u793a\u4f8b \u901a\u8fc7\u65e5\u5fd7\u91cd\u70b9\u89c2\u6d4b 2 \u4e2a\u4fe1\u606f\uff1a \u65ad\u70b9\u662f\u5728\u54ea\u91cc \uff1f \u539f\u56e0\u662f\u4ec0\u4e48\uff1f","title":"3. \u8bf7\u6c42\u4e2d\u65ad\u5206\u6790"},{"location":"chap9/24Istio_troubleshoot/#client-server","text":"\u53ef\u4ee5\u770b\u5230 2 \u7aef\u65e5\u5fd7\u5305\u542b\u76f8\u540c\u7684 request ID \uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06\u6d41\u91cf\u5206\u6790\u4e32\u8054\u8d77\u6765\u3002","title":"\u793a\u4f8b\u4e00\uff1a\u4e00\u6b21\u6b63\u5e38\u7684 client-server \u8bf7\u6c42\u3002"},{"location":"chap9/24Istio_troubleshoot/#no-healthy-upstream-deployment-0","text":"\u65e5\u5fd7\u4e2d flag\u300cUH\u300d \u8868\u793a upstream cluster \u4e2d\u6ca1\u6709\u5065\u5eb7\u7684 host \u3002","title":"\u793a\u4f8b\u4e8c\uff1ano healthy upstream\uff0c\u6bd4\u5982\u76ee\u6807 deployment \u5065\u5eb7\u526f\u672c\u6570\u4e3a 0\u3002"},{"location":"chap9/24Istio_troubleshoot/#no-route-configured-destinationrule-subset","text":"\u65e5\u5fd7\u4e2d flag\u300cNR\u300d \u8868\u793a\u627e\u4e0d\u5230\u8def\u7531\u3002","title":"\u793a\u4f8b\u4e09\uff1aNo route configured\uff0c\u6bd4\u5982 DestinationRule \u7f3a\u4e4f\u5bf9\u5e94\u7684 subset"},{"location":"chap9/24Istio_troubleshoot/#upstream-connection-failure","text":"\u65e5\u5fd7\u4e2d flag\u300cUF\u300d \u8868\u793a Upstream \u8fde\u63a5\u5931\u8d25\uff0c\u636e\u6b64\u53ef\u4ee5\u5224\u65ad\u51fa\u6d41\u91cf\u65ad\u70b9\u4f4d\u7f6e\u3002","title":"\u793a\u4f8b\u56db\uff1aUpstream connection failure\uff0c\u6bd4\u5982\u670d\u52a1\u672a\u6b63\u5e38\u76d1\u542c\u7aef\u53e3\u3002"},{"location":"chap9/24Istio_troubleshoot/#4-sidecar-user-container","text":"","title":"4\u3001 Sidecar \u548c User Container \u542f\u52a8\u987a\u5e8f"},{"location":"chap9/24Istio_troubleshoot/#4-1","text":"Sidecar \u6a21\u5f0f\u5728 Kubernetes \u4e16\u754c\u5f88\u6d41\u884c\uff0c\u4f46\u5bf9\u76ee\u524d\u7684 Kubernetes\uff08V1.17\uff09 \u6765\u8bf4\uff0c\u5e76\u6ca1\u6709 Sidecar \u7684\u6982\u5ff5\uff0c Sidecar \u5bb9\u5668\u7684\u89d2\u8272\u662f\u7528\u6237\u4e3b\u89c2\u8d4b\u4e88\u7684\u3002 \u5bf9 Istio \u7528\u6237\u6765\u8bf4\uff0c\u4e00\u4e2a\u5e38\u89c1\u7684\u56f0\u6270\u662f\uff1a Sidecar \u548c\u7528\u6237\u5bb9\u5668\u7684\u542f\u52a8\u987a\u5e8f\uff1a Sidecar\uff08Envoy\uff09 \u548c\u7528\u6237\u5bb9\u5668\u7684\u542f\u52a8\u987a\u5e8f\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u5982\u679c\u7528\u6237\u5bb9\u5668\u5148\u542f\u52a8\u4e86\uff0c Envoy \u8fd8\u672a\u5b8c\u6210\u542f\u52a8\uff0c\u8fd9\u65f6\u5019\u7528\u6237\u5bb9\u5668\u5f80\u5916\u53d1\u9001\u8bf7\u6c42\uff0c\u8bf7\u6c42\u4ecd\u7136\u4f1a\u88ab\u62e6\u622a\uff0c\u53d1\u5f80\u672a\u542f\u52a8\u7684 Envoy \uff0c\u8bf7\u6c42\u5f02\u5e38\u3002 \u5728 Pod \u7ec8\u6b62\u9636\u6bb5\uff0c\u4e5f\u4f1a\u6709\u7c7b\u4f3c\u7684\u5f02\u5e38\uff0c\u6839\u6e90\u4ecd\u7136\u662f Sidecar \u548c\u666e\u901a\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u7684\u4e0d\u786e\u5b9a\u6027\u3002","title":"4-1 \u5f02\u5e38\u63cf\u8ff0"},{"location":"chap9/24Istio_troubleshoot/#4-2","text":"\u76ee\u524d\u5e38\u89c4\u7684\u89c4\u907f\u65b9\u6848\u4e3b\u8981\u662f\u6709\u8fd9\u6837\u51e0\u79cd\uff1a \u4e1a\u52a1\u5bb9\u5668\u5ef6\u8fdf\u51e0\u79d2\u542f\u52a8\uff0c\u6216\u8005\u5931\u8d25\u91cd\u8bd5 \u542f\u52a8\u811a\u672c\u4e2d\u4e3b\u52a8\u63a2\u6d4b Envoy \u662f\u5426 ready \uff0c\u5982 127.0.0.1:15020/healthz/ready \u65e0\u8bba\u54ea\u79cd\u65b9\u6848\u90fd\u663e\u5f97\u5f88\u8e69\u811a\uff0c\u4e3a\u4e86\u5f7b\u5e95\u89e3\u51b3\u4e0a\u8ff0\u75db\u70b9\uff0c \u4ece Kubernetes 1.18 \u7248\u672c\u5f00\u59cb\uff0c Kubernetes \u5185\u7f6e\u7684 Sidecar \u529f\u80fd\u5c06\u786e\u4fdd Sidecar \u5728\u6b63\u5e38\u4e1a\u52a1\u6d41\u7a0b\u5f00\u59cb\u4e4b\u524d\u5c31\u542f\u52a8\u5e76\u8fd0\u884c\uff0c\u5373\u901a\u8fc7\u66f4\u6539 Pod \u7684\u542f\u52a8\u751f\u547d\u5468\u671f\uff0c\u5728 init \u5bb9\u5668\u5b8c\u6210\u540e\u542f\u52a8 Sidecar \u5bb9\u5668\uff0c\u5728 Sidecar \u5bb9\u5668\u5c31\u7eea\u540e\u542f\u52a8\u4e1a\u52a1\u5bb9\u5668\uff0c\u4ece\u542f\u52a8\u6d41\u7a0b\u4e0a\u4fdd\u8bc1\u987a\u5e8f\u6027 \u3002 init \u5bb9\u5668 => Sidecar \u5bb9\u5668 => \u4e1a\u52a1\u5bb9\u5668 \u800c Pod \u7ec8\u6b62\u9636\u6bb5\uff0c\u53ea\u6709\u5f53\u6240\u6709\u666e\u901a\u5bb9\u5668\u90fd\u5df2\u5230\u8fbe\u7ec8\u6b62\u72b6\u6001\uff08 Succeeded for restartPolicy=OnFailure \u6216 Succeeded/Failed for restartPolicy=Never \uff09\uff0c\u624d\u4f1a\u5411 Sidecar \u5bb9\u5668\u53d1\u9001 SIGTERM \u4fe1\u53f7\u3002","title":"4-2 \u89e3\u51b3\u65b9\u6848"},{"location":"chap9/24Istio_troubleshoot/#5-ingress-gateway-service","text":"Ingress Gateway \u89c4\u5219\u4e0d\u751f\u6548\u7684\u4e00\u4e2a\u5e38\u89c1\u539f\u56e0\u662f\uff1a Gateway \u7684\u76d1\u542c\u7aef\u53e3\u5728\u5bf9\u5e94\u7684 Kubernetes Service \u4e0a\u6ca1\u6709\u5f00\u542f\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u7406\u89e3 Istio Ingress Gateway \u548c Kubernetes Service \u7684\u5173\u7cfb\uff1a \u4e0a\u56fe\u4e2d\uff0c\u867d\u7136 Gateway \u5b9a\u4e49\u671f\u671b\u7ba1\u63a7\u7aef\u53e3 b \u548c c \uff0c\u4f46\u662f\u5b83\u5bf9\u5e94\u7684 Service \uff08\u901a\u8fc7\u817e\u8baf\u4e91 CLB\uff09\u53ea\u5f00\u542f\u4e86\u7aef\u53e3 a \u548c b \uff0c\u56e0\u6b64\u6700\u7ec8\u4ece LB \u7aef\u53e3 b \u8fdb\u6765\u7684\u6d41\u91cf\u624d\u80fd\u88ab Istio Gateway \u7ba1\u63a7\u3002 Istio Gateway \u548c Kubernetes Service \u6ca1\u6709\u76f4\u63a5\u7684\u5173\u8054\uff0c\u4e8c\u8005\u90fd\u662f\u901a\u8fc7 selector \u53bb\u7ed1\u5b9a Pod \uff0c\u5b9e\u73b0\u95f4\u63a5\u5173\u8054\u3002 Istio CRD Gateway \u53ea\u5b9e\u73b0\u4e86\u5c06\u7528\u6237\u6d41\u63a7\u89c4\u5219\u4e0b\u53d1\u5230\u7f51\u683c\u8fb9\u7f18\u8282\u70b9\uff0c\u6d41\u91cf\u4ecd\u9700\u8981\u901a\u8fc7 LB \u63a7\u5236\u624d\u80fd\u8fdb\u5165\u7f51 \u683c\u3002 \u817e\u8baf\u4e91 TKE Mesh \u5b9e\u73b0\u4e86 Gateway-Service \u5b9a\u4e49\u4e2d\u7684 Port \u52a8\u6001\u8054\u52a8\uff0c\u8ba9\u7528\u6237\u805a\u7126\u5728\u7f51\u683c\u5185\u7684\u914d\u7f6e\u3002","title":"5\u3001 Ingress Gateway \u548c Service \u7aef\u53e3\u8054\u52a8"},{"location":"chap9/24Istio_troubleshoot/#6-virtualservice","text":"VirtualService \u5305\u542b\u4e86\u5927\u90e8\u5206 outbound \u7aef\u7684\u6d41\u91cf\u89c4\u5219\uff0c\u5b83\u65e2\u53ef\u4ee5\u5e94\u7528\u5230\u7f51\u683c\u5185\u90e8\u6570\u636e\u9762\u4ee3\u7406\u4e2d\uff0c \u4e5f\u53ef\u4ee5\u5e94\u7528\u5230\u7f51\u683c\u8fb9\u7f18\u7684\u4ee3\u7406\u4e2d\u3002 VirtualService \u7684\u5c5e\u6027 Gateways \u7528\u4e8e\u6307\u5b9a VirtualService \u7684\u751f\u6548\u8303\u56f4\uff1a \u5982\u679c VirtualService.gateways \u4e3a\u7a7a\uff0c\u5219 Istio \u4e3a\u5176\u8d4b\u9ed8\u8ba4\u503c Mesh \uff0c\u4ee3\u8868\u751f\u6548\u8303\u56f4\u4e3a\u7f51\u683c\u5185\u90e8 \u5982\u679c\u5e0c\u671b VirtualService \u5e94\u7528\u5230\u5177\u4f53\u8fb9\u7f18\u7f51\u5173\u4e0a\uff0c\u5219\u9700\u8981\u663e\u793a\u4e3a\u5176\u8d4b\u503c\uff1a gateway-name1 \uff0c gateway-name2 \u5982\u679c\u5e0c\u671b VirtualService \u540c\u65f6\u5e94\u7528\u5230\u7f51\u683c\u5185\u90e8\u548c\u8fb9\u7f18\u7f51\u5173\u4e0a\uff0c\u5219\u9700\u8981\u663e\u793a\u5730\u628a Mesh \u503c\u52a0\u5165 VirtualService.gateways \uff0c\u5982 Mesh \uff0c gateway-name1 \uff0c gateway-name2 \u4e00\u4e2a\u5e38\u89c1\u7684\u95ee\u9898\u662f\u4ee5\u4e0a\u7684\u7b2c\u4e09\u79cd\u60c5\u51b5\uff0c VirtualService \u6700\u5f00\u59cb\u4f5c\u7528\u4e8e\u7f51\u5173\u5185\u90e8\uff0c\u540e\u7eed\u8981\u5c06\u5176\u89c4\u5219\u6269\u5c55\u5230\u8fb9\u7f18\u7f51\u5173\u4e0a\uff0c\u7528\u6237\u5f80\u5f80\u53ea\u4f1a\u6dfb\u52a0\u5177\u4f53 Gateway Name \uff0c\u800c\u9057\u6f0f Mesh \uff1a Istio \u81ea\u52a8\u7ed9 VirtualService.gateways \u8bbe\u7f6e\u9ed8\u8ba4\u503c\uff0c\u672c\u610f\u662f\u4e3a\u4e86\u7b80\u5316\u7528\u6237\u7684\u914d\u7f6e\uff0c\u4f46\u662f\u5f80\u5f80\u4f1a\u5bfc\u81f4\u7528\u6237\u5e94\u7528\u4e0d\u5f53\uff0c\u4e00\u4e2a feature \u4e00\u4e0d\u5c0f\u5fc3\u4f1a\u88ab\u7528\u6210\u4e86 bug \u3002","title":"6\u3001 VirtualService \u4f5c\u7528\u57df"},{"location":"chap9/24Istio_troubleshoot/#7-virtualservice-host-fragment","text":"","title":"7\u3001 VirtualService \u4e0d\u652f\u6301 Host Fragment"},{"location":"chap9/24Istio_troubleshoot/#7-1","text":"\u5bf9\u67d0\u4e00 host \u65b0\u589e\u3001\u4fee\u6539 VirtualService \uff0c\u53d1\u73b0\u89c4\u5219\u59cb\u7ec8\u65e0\u6cd5\u751f\u6548\uff0c\u6392\u67e5\u53d1\u73b0\u5b58\u5728\u5176\u4ed6 VirtualService \u4e5f\u5bf9\u8be5 host \u5e94\u7528\u4e86\u5176\u4ed6\u89c4\u5219\uff0c\u89c4\u5219\u5185\u5bb9\u53ef\u80fd\u4e0d\u51b2\u7a81\uff0c\u4f46\u8fd8\u662f\u53ef\u80fd\u51fa\u73b0\u5176\u4e2d\u4e00\u4e9b\u89c4\u5219\u65e0\u6cd5\u751f\u6548\u7684\u60c5\u51b5\u3002","title":"7-1 \u5f02\u5e38\u6848\u4f8b"},{"location":"chap9/24Istio_troubleshoot/#7-2","text":"VirtualService \u91cc\u7684\u89c4\u5219\uff0c\u6309\u7167 host \u8fdb\u884c\u805a\u5408 \u968f\u7740\u4e1a\u52a1\u7684\u589e\u957f\uff0c VirtualService \u7684\u5185\u5bb9\u4f1a\u5feb\u901f\u589e\u957f\uff0c\u4e00\u4e2a host \u7684\u6d41\u63a7\u89c4\u5219\uff0c\u53ef\u80fd\u4f1a\u7531\u4e0d\u540c\u7684\u56e2\u961f\u5206\u5e03\u7ef4\u62a4\u3002\u5982\u5b89\u5168\u89c4\u5219\u548c\u4e1a\u52a1\u89c4\u5219\u5206\u5f00\uff0c\u4e0d\u540c\u4e1a\u52a1\u6309\u7167\u5b50 path \u5206\u5f00 \u76ee\u524d Istio \u5bf9 cross-resource VirtualService \u7684\u652f\u6301\u60c5\u51b5\uff1a \u5728\u7f51\u683c\u8fb9\u7f18\uff08 Gateway \uff09\uff0c\u540c\u4e00\u4e2a host \u7684\u6d41\u63a7\u89c4\u5219\uff0c\u652f\u6301\u5206\u5e03\u5230\u591a\u4e2a VirtualService \u5bf9\u8c61\u4e2d\uff0c Istio \u81ea\u52a8\u805a\u5408\uff0c\u4f46\u4f9d\u8d56\u5b9a\u4e49\u987a\u5e8f\u4ee5\u53ca\u7528\u6237\u81ea\u884c\u907f\u514d\u51b2\u7a81 \u3002 \u5728\u7f51\u683c\u5185\u90e8\uff08 for Sidecar \uff09\uff0c\u540c\u4e00\u4e2a host \u7684\u6d41\u63a7\u89c4\u5219\uff0c\u4e0d\u652f\u6301\u5206\u5e03\u5230\u591a\u4e2a VirtualService \u5bf9\u8c61\u4e2d\uff0c\u5982\u679c\u540c\u4e00\u4e2a host \u5b58\u5728\u591a\u4e2a VirtualService \uff0c\u53ea\u6709\u7b2c\u4e00\u4e2a VirtualService \u751f\u6548\uff0c\u4e14\u6ca1\u6709\u51b2\u7a81\u68c0\u6d4b\u3002 VirtualService \u4e0d\u80fd\u5f88\u597d\u652f\u6301 host \u89c4\u5219\u5206\u7247\uff0c\u4f7f\u5f97\u56e2\u961f\u7684\u7ef4\u62a4\u804c\u8d23\u4e0d\u80fd\u5f88\u597d\u7684\u89e3\u8026\uff0c\u914d\u7f6e\u4eba\u5458\u9700\u8981\u77e5\u6089\u76ee\u6807 host \u7684\u6240\u6709\u6d41\u63a7\u89c4\u5219\uff0c\u624d\u6709\u4fe1\u5fc3\u53bb\u4fee\u6539 VirtualService \u3002 Istio \u89e3\u51b3\u65b9\u6848\uff1a Virtual Service chaining\uff08plan in 1.6\uff09 Istio \u8ba1\u5212\u5728 1.6 \u4e2d\u652f\u6301 Virtual Service \u4ee3\u7406\u94fe\uff1a Virtual Service \u652f\u6301\u5206\u7247\u5b9a\u4e49 + \u4ee3\u7406\u94fe \u652f\u6301\u56e2\u961f\u5bf9\u540c\u4e00 host \u7684 Virtual Service \u8fdb\u884c\u7075\u6d3b\u5206\u7247\uff0c\u6bd4\u5982\u6309\u7167 SecOps/Netops/Business \u7279\u6027\u5206\u79bb\uff0c\u5404\u56e2\u961f\u7ef4\u62a4\u5404\u79cd\u72ec\u7acb\u7684 Virtual Service","title":"7-2 \u80cc\u666f"},{"location":"chap9/24Istio_troubleshoot/#8","text":"","title":"8\u3001\u5168\u94fe\u8def\u8ddf\u8e2a\u5e76\u975e\u5b8c\u5168\u900f\u660e\u63a5\u5165"},{"location":"chap9/24Istio_troubleshoot/#8-1","text":"\u5fae\u670d\u52a1\u63a5\u5165 Service Mesh \u540e\uff0c\u94fe\u8def\u8ddf\u8e2a\u6570\u636e\u6ca1\u6709\u5f62\u6210\u4e32\u8054\u3002","title":"8-1 \u5f02\u5e38\u6848\u4f8b"},{"location":"chap9/24Istio_troubleshoot/#8-2","text":"Service Mesh \u9065\u6d4b\u7cfb\u7edf\u4e2d\uff0c\u5bf9\u8c03\u7528\u94fe\u8ddf\u8e2a\u7684\u5b9e\u73b0\uff0c\u5e76\u975e\u5b8c\u5168\u7684\u96f6\u5165\u4fb5\uff0c\u9700\u8981\u7528\u6237\u4e1a\u52a1\u4f5c\u51fa\u5c11\u91cf\u7684\u4fee\u6539\u624d\u80fd\u652f\u6301\uff0c\u5177\u4f53\u5730\uff0c\u5728\u7528\u6237\u53d1\u51fa\uff08 HTTP/gRPC \uff09 RPC \u65f6\uff0c \u9700\u8981\u4e3b\u52a8\u5c06\u4e0a\u6e38\u8bf7\u6c42\u4e2d\u5b58\u5728\u7684 B3 trace headers\u5199 \u5165\u4e0b\u6e38 RPC \u8bf7\u6c42\u5934\u4e2d\uff0c\u8fd9\u4e9b headers \u5305\u62ec\uff1a \u6709\u90e8\u5206\u7528\u6237\u96be\u4ee5\u7406\u89e3\uff1a\u65e2\u7136 inbound \u6d41\u91cf\u548c outbound \u6d41\u91cf\u5df2\u7ecf\u5b8c\u5168\u88ab\u62e6\u622a\u5230 Envoy \uff0c Envoy \u53ef\u4ee5\u5b9e\u73b0\u5b8c\u5168\u7684\u6d41\u91cf\u7ba1\u63a7\u548c\u4fee\u6539\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981\u5e94\u7528\u663e\u793a\u7b2c\u4f20\u9012 headers \uff1f \u5bf9\u4e8e Envoy \u6765\u8bf4\uff0c inbound \u8bf7\u6c42\u548c outbound \u8bf7\u6c42\u5b8c\u5168\u662f\u72ec\u7acb\u7684\uff0c Envoy \u65e0\u6cd5\u611f\u77e5\u8bf7\u6c42\u4e4b\u95f4\u7684\u5173\u8054\u3002\u5b9e\u9645\u4e0a\u8fd9\u4e9b\u8bf7\u6c42\u5230\u5e95\u6709\u65e0\u4e0a\u4e0b\u7ea7\u5173\u8054\uff0c\u5b8c\u5168\u7531\u5e94\u7528\u81ea\u5df1\u51b3\u5b9a\u3002 \u4e3e\u4e00\u4e2a\u7279\u6b8a\u7684\u4e1a\u52a1\u573a\u666f\uff0c\u5982\u679c Pod X \u63a5\u6536\u5230 \u8bf7\u6c42 A \uff0c\u89e6\u53d1\u7684\u4e1a\u52a1\u903b\u8f91\u662f\uff1a\u6bcf\u9694 10 \u79d2 \u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\u5230 Pod Y \uff0c\u5982 B1 \uff0c B2 \uff0c B3 \uff0c\u90a3\u4e48\u8fd9\u4e9b\u6247\u51fa\u7684\u8bf7\u6c42 Bx\uff08x=1\uff0c2\uff0c3\u2026\u2026\uff09 \uff0c\u548c\u8bf7\u6c42 A \u662f\u4ec0\u4e48\u5173\u7cfb\uff1f\u4e1a\u52a1\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u51b3\u7b56\uff1a\u8ba4\u4e3a A \u662f Bx \u7684\u7236\u8bf7\u6c42\uff0c\u6216\u8005\u8ba4\u4e3a Bx \u662f\u72ec\u7acb\u7684\u9876\u5c42\u8bf7\u6c42\u3002","title":"8-2 \u539f\u56e0"},{"location":"chap9/24Istio_troubleshoot/#9-mtls","text":"\u5728\u5f00\u542f Istio mTLS \u7684\u7528\u6237\u573a\u666f\u4e2d\uff0c\u8bbf\u95ee\u51fa\u73b0 connection termination \u662f\u4e00\u4e2a\u9ad8\u9891\u7684\u5f02\u5e38\uff1a \u8fd9\u4e2a\u5f02\u5e38\u7684\u539f\u56e0\u548c DestinationRule \u4e2d\u7684 mTLS \u914d\u7f6e\u6709\u5173\uff0c\u662f Istio \u4e2d\u4e00\u4e2a\u4e0d\u5065\u58ee\u7684\u63a5\u53e3\u8bbe\u8ba1\u3002 \u5f53\u901a\u8fc7 MeshPolicy \u5f00\u542f\u5168\u5c40 mTLS \uff0c \u5982\u679c\u7f51\u683c\u4e2d\u6ca1\u6709\u5b9a\u4e49\u5176\u4ed6\u7684 DestinationRule \uff0c mTLS \u6b63\u5e38\u8fd0\u884c \u5982\u679c\u540e\u7eed\u7f51\u683c\u4e2d\u65b0\u589e\u4e86 DestinationRule \uff0c\u800c DestinationRule \u4e2d\u53ef\u4ee5\u8986\u76d6\u5b50\u7248\u672c\u7684 mTLS \u503c\uff08\u9ed8\u8ba4\u662f\u4e0d\u5f00\u542f\uff01\uff09\uff0c\u7528\u6237\u5728\u4f7f\u7528 DestinationRule \u65f6\uff0c\u5f80\u5f80\u5f88\u5c11\u53bb\u5173\u6ce8 mTLS \u5c5e\u6027\uff08\u7559\u7a7a\uff09\u3002\u6700\u7ec8\u5bfc\u81f4\u589e DestinationRule \u540e mTLS \u53d8\u6210\u4e86\u4e0d\u5f00\u542f\uff0c\u5bfc\u81f4 c onnection termination \u4e3a\u4e86\u4fee\u590d\u4ee5\u4e0a\u95ee\u9898\uff0c\u7528\u6237\u4e0d\u5f97\u4e0d\u5728\u6240\u6709 DestinationRule \u4e2d\u589e\u52a0 mTLS \u5c5e\u6027\u5e76\u8bbe\u7f6e\u4e3a\u5f00\u542f \u8fd9\u79cd Istio mTLS \u7528\u6237\u63a5\u53e3\u6781\u5ea6\u4e0d\u53cb\u597d\uff0c\u867d\u7136 mTLS \u9ed8\u8ba4\u505a\u5230\u4e86\u5168\u5c40\u900f\u660e\uff0c\u4e1a\u52a1\u611f\u77e5\u4e0d\u5230 mTLS \u7684\u5b58\u5728\uff0c\u4f46\u662f\u4e00\u65e6\u4e1a\u52a1\u5b9a\u4e49\u4e86 DestinationRule \uff0c DestinationRule \u5c31\u5fc5\u987b\u8981\u77e5\u9053\u5f53\u524d mTLS \u662f\u5426\u5f00\u542f\uff0c\u5e76\u4f5c\u51fa\u8c03\u6574\u3002\u8bd5\u60f3 mTLS \u914d\u7f6e\u4ea4\u7531\u5b89\u5168\u56e2\u961f\u8d1f\u8d23\uff0c\u800c\u4e1a\u52a1\u56e2\u961f\u8d1f\u8d23\u5404\u81ea\u7684 DestinationRule \uff0c\u56e2\u961f\u95f4\u7684\u8026\u5408\u4f1a\u975e\u5e38\u4e25\u91cd\u3002","title":"9\u3001 mTLS \u5bfc\u81f4\u8fde\u63a5\u4e2d\u65ad"},{"location":"chap9/24Istio_troubleshoot/#10","text":"","title":"10\u3001 \u7528\u6237\u670d\u52a1\u76d1\u542c\u5730\u5740\u9650\u5236"},{"location":"chap9/24Istio_troubleshoot/#10-1","text":"\u5982\u679c\u7528\u6237\u5bb9\u5668\u4e2d\u4e1a\u52a1\u8fdb\u7a0b\u76d1\u542c\u7684\u5730\u5740\u662f\u5177\u4f53IP\uff08Pod IP\uff09\uff0c\u800c\u4e0d\u662f 0.0.0.0 \uff0c\u8be5\u7528\u6237\u5bb9\u5668\u65e0\u6cd5\u6b63\u5e38\u63a5\u5165 Istio\uff0c\u6d41\u91cf\u8def\u7531\u5931\u8d25\u3002 \u8fd9\u662f\u53c8\u4e00\u4e2a\u6311\u6218 Istio \u6700\u5927\u900f\u660e\u5316\uff08 Maximize Transparency \uff09\u8bbe\u8ba1\u76ee\u6807 \u7684\u573a\u666f\u3002","title":"10-1 \u5f02\u5e38\u63cf\u8ff0"},{"location":"chap9/24Istio_troubleshoot/#10-2","text":"Istio-proxy \u4e2d\u7684\u4e00\u6bb5 iptables \uff1a \u5176\u4e2d\uff0c ISTIO_IN_REDIRECT \u662f virtualInbound \uff0c\u7aef\u53e3 15006\uff1bISTIO_REDIRECT \u662f virtualOutbound \uff0c\u7aef\u53e3 15001 \u3002 \u5173\u952e\u70b9\u662f\u89c4\u5219\u4e8c\uff1a\u5982\u679c destination \u4e0d\u662f 127.0.0.1/32 \uff0c\u8f6c\u7ed9 15006 \uff08 virtualInbound \uff0c Envoy \u76d1\u542c\uff09\uff0c\u8fd9\u91cc\u5bfc\u81f4\u4e86\u5bf9 Pod IP \u7684\u6d41\u91cf\u59cb\u7ec8\u4f1a\u56de\u5230 Envoy \u3002 \u5bf9\u8be5\u89c4\u5219\u7684\u89e3\u91ca\uff1a # Redirect app calls back to itself via Envoy when using the service VIP or endpoint # address, e.g. appN => Envoy (client) => Envoy (server) => appN. \u8be5\u89c4\u5219\u662f\u5e0c\u671b\u5728\u8fd9\u91cc\u8d77\u4f5c\u7528\uff1a\u5047\u8bbe\u5f53\u524d Pod a \u5c5e\u4e8e service A \uff0c Pod \u4e2d\u7528\u6237\u5bb9\u5668\u901a\u8fc7\u670d\u52a1\u540d\u8bbf\u95ee\u670d\u52a1 A \uff0c Envoy \u4e2d\u8d1f\u8f7d\u5747\u8861\u903b\u8f91\u5c06\u8fd9\u6b21\u8bbf\u95ee\u8f6c\u53d1\u5230\u4e86\u5f53\u524d\u7684 Pod IP \uff0c Istio \u5e0c\u671b\u8fd9\u79cd\u573a\u666f\u670d\u52a1\u7aef\u4ecd\u7136\u6709\u6d41\u91cf\u7ba1\u63a7\u80fd\u529b\u3002\u5982\u56fe\u793a\uff1a","title":"10-2 \u539f\u56e0\u5206\u6790"},{"location":"chap9/24Istio_troubleshoot/#10-3","text":"\u5efa\u8bae\u5e94\u7528\u5728\u63a5\u5165 Istio \u4e4b\u524d\uff0c\u8c03\u6574\u670d\u52a1\u76d1\u542c\u5730\u5740\uff0c\u4f7f\u7528 0.0.0.0 \u800c\u4e0d\u662f\u5177\u4f53 IP \u3002","title":"10-3 \u6539\u9020\u5efa\u8bae"},{"location":"chap9/2Istio_security/","text":"\u7b2c\u4e8c\u8282 Istio \u5b89\u5168\u6700\u4f73\u5b9e\u8df5 Istio \u7684\u5b89\u5168\u529f\u80fd\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u8eab\u4efd\u3001\u7b56\u7565\u3001\u900f\u660e\u7684 TLS \u52a0\u5bc6\u4ee5\u53ca\u8ba4\u8bc1\u3001\u6388\u6743\u548c\u5ba1\u8ba1\uff08AAA\uff09\u5de5\u5177\u6765\u4fdd\u62a4\u4f60\u7684\u670d\u52a1\u548c\u6570\u636e\u3002\u7136\u800c\uff0c\u4e3a\u4e86\u5145\u5206\u5b89\u5168\u5730\u5229\u7528\u8fd9\u4e9b\u529f\u80fd\uff0c\u5fc5\u987b\u6ce8\u610f\u9075\u5faa\u6700\u4f73\u5b9e\u8df5 1\u3001\u53cc\u5411 TLS Istio \u5c06\u5c3d\u53ef\u80fd\u4f7f\u7528 \u53cc\u5411TLS \u5bf9\u6d41\u91cf\u8fdb\u884c\u81ea\u52a8\u52a0\u5bc6\u3002 \u7136\u800c\uff0c\u4ee3\u7406\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u88ab\u914d\u7f6e\u4e3a\u8bb8\u53ef\u6a21\u5f0f\uff08 Permissive Mode \uff09\uff0c\u8fd9\u610f\u5473\u7740\u4ed6\u4eec\u5c06\u63a5\u53d7\u53cc\u5411 TLS \u548c\u660e\u6587\u6d41\u91cf \u3002 \u7136\u800c\uff0c\u4ec5\u9760\u53cc\u5411 TLS \u5e76\u4e0d\u8db3\u4ee5\u4fdd\u8bc1\u6d41\u91cf\u7684\u5b89\u5168\uff0c\u56e0\u4e3a\u5b83\u53ea\u63d0\u4f9b\u8ba4\u8bc1\uff0c\u800c\u4e0d\u662f\u6388\u6743\u3002\u8fd9\u610f\u5473\u7740\uff0c\u4efb\u4f55\u62e5\u6709\u6709\u6548\u8bc1\u4e66\u7684\u4eba\u4ecd\u7136\u53ef\u4ee5\u8bbf\u95ee\u4e00\u4e2a\u670d\u52a1\u3002 \u4e3a\u4e86\u5b8c\u5168\u9501\u5b9a\u6d41\u91cf\uff0c\u5efa\u8bae\u914d\u7f6e\u6388\u6743\u7b56\u7565 \u3002\u8fd9\u5141\u8bb8\u521b\u5efa\u7ec6\u7c92\u5ea6\u7684\u7b56\u7565\u6765\u5141\u8bb8\u6216\u62d2\u7edd\u6d41\u91cf\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u53ea\u5141\u8bb8\u6765\u81ea app \u547d\u540d\u7a7a\u95f4\u7684\u8bf7\u6c42\u8bbf\u95ee hello-world \u670d\u52a1\u3002 2\u3001\u6388\u6743\u7b56\u7565 Istio \u6388\u6743\u5728 Istio \u5b89\u5168\u4e2d\u8d77\u7740\u5173\u952e\u4f5c\u7528\u3002\u5b83\u9700\u8981\u52aa\u529b\u914d\u7f6e\u6b63\u786e\u7684\u6388\u6743\u7b56\u7565\uff0c\u4ee5\u6700\u597d\u5730\u4fdd\u62a4\u4f60\u7684\u96c6\u7fa4\u3002\u4e86\u89e3\u8fd9\u4e9b\u914d\u7f6e\u7684\u5f71\u54cd\u662f\u5f88\u91cd\u8981\u7684\uff0c\u56e0\u4e3a Istio \u65e0\u6cd5\u786e\u5b9a\u6240\u6709\u7528\u6237\u7684\u6b63\u786e\u6388\u6743\u3002\u8bf7\u5168\u7a0b\u5173\u6ce8\u672c\u8282\u5185\u5bb9\u3002 2-1 \u5e94\u7528\u9ed8\u8ba4\u62d2\u7edd\u7684\u6388\u6743\u7b56\u7565 \u6211\u4eec\u5efa\u8bae\u4f60\u6309\u7167 default-deny \u6a21\u5f0f\u5b9a\u4e49\u4f60\u7684 Istio \u6388\u6743\u7b56\u7565\uff0c\u4ee5\u589e\u5f3a\u96c6\u7fa4\u7684\u5b89\u5168\u6001\u52bf\u3002 \u9ed8\u8ba4\u62d2\u7edd\u6388\u6743\u6a21\u5f0f\u610f\u5473\u7740\u4f60\u7684\u7cfb\u7edf\u9ed8\u8ba4\u62d2\u7edd\u6240\u6709\u8bf7\u6c42\uff0c\u800c\u4f60\u5b9a\u4e49\u4e86\u5141\u8bb8\u8bf7\u6c42\u7684\u6761\u4ef6 \u3002\u5982\u679c\u4f60\u9519\u8fc7\u4e86\u4e00\u4e9b\u6761\u4ef6\uff0c \u6d41\u91cf\u5c06\u88ab\u610f\u5916\u5730\u62d2\u7edd\uff0c\u800c\u4e0d\u662f\u6d41\u91cf\u88ab\u610f\u5916\u5730\u5141\u8bb8 \u3002\u540e\u8005\u901a\u5e38\u662f\u4e00\u4e2a\u5b89\u5168\u4e8b\u4ef6\uff0c\u800c\u524d\u8005\u53ef\u80fd\u4f1a\u5bfc\u81f4\u7cdf\u7cd5\u7684\u7528\u6237\u4f53\u9a8c\u3001\u670d\u52a1\u4e2d\u65ad\u6216\u4e0d\u7b26\u5408\u4f60\u7684 SLO/SLA\u3002 \u4f8b\u5982\uff0c\u5728 HTTP \u6d41\u91cf\u7684\u6388\u6743\u4efb\u52a1\u4e2d\uff0c\u540d\u4e3a allow-nothing \u7684\u6388\u6743\u7b56\u7565\u786e\u4fdd\u6240\u6709\u6d41\u91cf\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u88ab\u62d2\u7edd\u3002\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c\u5176\u4ed6\u6388\u6743\u7b56\u7565\u6839\u636e\u7279\u5b9a\u6761\u4ef6\u5141\u8bb8\u6d41\u91cf\u3002 2-2 \u5728\u8def\u5f84\u89c4\u8303\u5316\u4e0a\u5b9a\u5236\u4f60\u7684\u7cfb\u7edf Istio \u6388\u6743\u7b56\u7565\u53ef\u4ee5\u57fa\u4e8e HTTP \u8bf7\u6c42\u4e2d\u7684 URL \u8def\u5f84\u3002\u8def\u5f84\u89c4\u8303\u5316\uff08\u53c8\u79f0 URI \u89c4\u8303\u5316\uff09 \u5bf9\u4f20\u5165\u8bf7\u6c42\u7684\u8def\u5f84\u8fdb\u884c\u4fee\u6539\u548c\u6807\u51c6\u5316\uff0c\u4ece\u800c\u4f7f\u89c4\u8303\u5316\u540e\u7684\u8def\u5f84\u80fd\u591f\u4ee5\u6807\u51c6\u65b9\u5f0f\u8fdb\u884c\u5904\u7406\u3002\u8bed\u6cd5\u4e0a\u4e0d\u540c\u7684\u8def\u5f84\u5728\u8def\u5f84\u89c4\u8303\u5316\u540e\u53ef\u80fd\u662f\u7b49\u540c\u7684\u3002 Istio \u652f\u6301\u4ee5\u4e0b\u8bf7\u6c42\u8def\u5f84\u7684\u89c4\u8303\u5316\u65b9\u6848\uff0c\u7136\u540e\u518d\u6839\u636e\u6388\u6743\u7b56\u7565\u8fdb\u884c\u8bc4\u4f30\u548c\u8def\u7531\u8bf7\u6c42\uff1a \u8be5\u914d\u7f6e\u662f\u901a\u8fc7 mesh \u914d\u7f6e\u4e2d\u7684 pathNormalization \u5b57\u6bb5\u6307\u5b9a\u7684\u3002 \u4e3a\u4e86\u5f3a\u8c03\u8fd9\u4e00\u70b9\uff0c\u89c4\u8303\u5316\u7b97\u6cd5\u662f\u6309\u7167\u4ee5\u4e0b\u987a\u5e8f\u8fdb\u884c\u7684\uff1a \u767e\u5206\u6bd4\u89e3\u7801 %2F \u3001 %2f \u3001 %5C \u548c %5c \u5408\u5e76\u659c\u7ebf 2-3 \u914d\u7f6e\u7684\u4f8b\u5b50 \u786e\u4fdd Envoy \u89c4\u8303\u5316\u8bf7\u6c42\u8def\u5f84\u4ee5\u7b26\u5408\u4f60\u7684\u540e\u7aef\u670d\u52a1\u7684\u671f\u671b\uff0c\u5bf9\u4f60\u7684\u7cfb\u7edf\u5b89\u5168\u81f3\u5173\u91cd\u8981\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u53ef\u4ee5\u4f5c\u4e3a\u4f60\u914d\u7f6e\u7cfb\u7edf\u7684\u53c2\u8003\u3002\u89c4\u8303\u5316\u7684 URL \u8def\u5f84\uff0c\u5982\u679c\u9009\u62e9\u4e86 NONE \uff0c\u5219\u662f\u539f\u59cb\u7684 URL \u8def\u5f84\u5c06\uff1a \u7528\u6765\u5bf9\u7167\u6388\u6743\u7b56\u7565\u8fdb\u884c\u68c0\u67e5 \u8f6c\u53d1\u5230\u540e\u7aef\u5e94\u7528\u7a0b\u5e8f 2-4 \u5982\u4f55\u914d\u7f6e \u4f60\u53ef\u4ee5\u4f7f\u7528 istioctl \u6765\u66f4\u65b0 mesh \u914d\u7f6e $ istioctl upgrade --set meshConfig.pathNormalization.normalization=DECODE_AND_MERGE_SLASHES \u6216\u901a\u8fc7\u6539\u53d8\u4f60\u7684 Operator \u91cd\u5199\u6587\u4ef6 $ cat <<EOF > iop.yaml apiVersion: install.istio.io/v1alpha1 kind: IstioOperator spec: meshConfig: pathNormalization: normalization: DECODE_AND_MERGE_SLASHES EOF $ istioctl install -f iop.yaml \u53e6\u5916\uff0c\u5982\u679c\u4f60\u60f3\u76f4\u63a5\u7f16\u8f91 Mesh \u914d\u7f6e\uff0c\u4f60\u53ef\u4ee5\u5c06 pathNormalization \u6dfb\u52a0\u5230 mesh \u914d\u7f6e\u4e2d\uff0c\u8be5\u914d\u7f6e\u662f istio-<REVISION_ID> \u7684 CongfigMap \uff0c\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u9009\u62e9 DECODE_AND_MERGE_SLASHES \u9009\u9879\uff0c\u4f60\u4fee\u6539 mesh \u914d\u7f6e\u5982\u4e0b\uff1a apiVersion: v1 data: mesh: |- ... pathNormalization: normalization: DECODE_AND_MERGE_SLASHES ... 2-5 \u4e0d\u592a\u5e38\u89c1\u7684\u89c4\u8303\u5316\u914d\u7f6e \u5927\u5c0f\u5199\u89c4\u8303\u5316 \u5728\u67d0\u4e9b\u73af\u5883\u4e2d\uff0c\u4ee5\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u7684\u65b9\u5f0f\u6bd4\u8f83\u6388\u6743\u7b56\u7565\u4e2d\u7684\u8def\u5f84\u53ef\u80fd\u662f\u6709\u7528\u7684\u3002\u4f8b\u5982\uff0c\u5c06 https://myurl/get \u548c https://myurl/GeT \u7b49\u540c\u5bf9\u5f85\u3002 \u5728\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 EnvoyFilter\u3002 \u8fd9\u4e2a\u8fc7\u6ee4\u5668\u5c06\u6539\u53d8\u7528\u4e8e\u6bd4\u8f83\u7684\u8def\u5f84\u548c\u5448\u73b0\u7ed9\u5e94\u7528\u7a0b\u5e8f\u7684\u8def\u5f84\u3002 apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata: name: ingress-case-insensitive namespace: istio-system spec: configPatches: - applyTo: HTTP_FILTER match: context: GATEWAY listener: filterChain: filter: name: \"envoy.filters.network.http_connection_manager\" subFilter: name: \"envoy.filters.http.router\" patch: operation: INSERT_BEFORE value: name: envoy.lua typed_config: \"@type\": \"type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua\" inlineCode: | function envoy_on_request(request_handle) local path = request_handle:headers():get(\":path\") request_handle:headers():replace(\":path\", string.lower(path)) end 3\u3001\u4e86\u89e3\u6d41\u91cf\u91c7\u96c6\u7684\u9650\u5236 Istio sidecar \u7684\u5de5\u4f5c\u539f\u7406\u662f\u6355\u83b7\u5165\u7ad9\u6d41\u91cf\u548c\u51fa\u7ad9\u6d41\u91cf\uff0c\u5e76\u901a\u8fc7 sidecar \u4ee3\u7406\u5f15\u5bfc\u5b83\u4eec\u3002 \u7136\u800c\uff0c\u5e76\u4e0d\u662f\u6240\u6709\u7684\u6d41\u91cf\u90fd\u88ab\u6355\u83b7\uff1a \u91cd\u5b9a\u5411\u53ea\u5904\u7406\u57fa\u4e8e TCP \u7684\u6d41\u91cf\u3002\u4efb\u4f55 UDP \u6216 ICMP \u6570\u636e\u5305\u90fd\u4e0d\u4f1a\u88ab\u6355\u83b7\u6216\u4fee\u6539\u3002 Sidecar \u4f7f\u7528\u7684\u8bb8\u591a\u7aef\u53e3\u4ee5\u53ca 22 \u53f7\u7aef\u53e3\u7684\u5165\u7ad9\u6355\u83b7\u88ab\u7981\u7528\u3002\u8fd9\u4e2a\u5217\u8868\u53ef\u4ee5\u901a\u8fc7 traffic.sidecar.istio.io/excludeInboundPorts \u7b49\u9009\u9879\u6765\u6269\u5c55 \u3002 \u51fa\u7ad9\u6355\u83b7\u540c\u6837\u53ef\u4ee5\u901a\u8fc7 traffic.sidecar.istio.io/excludeOutboundPorts \u7b49\u8bbe\u7f6e\u6216\u5176\u4ed6\u65b9\u5f0f\u51cf\u5c11\u3002 \u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u7528\u7a0b\u5e8f\u548c\u5176 sidecar \u4ee3\u7406\u4e4b\u95f4\u7684\u5b89\u5168\u8fb9\u754c\u6700\u5c0f\u3002 \u5bf9 sidecar \u7684\u914d\u7f6e\u662f\u4ee5\u6bcf\u4e2a\u6a21\u5757\u4e3a\u57fa\u7840\u7684\uff0c\u5e76\u4e14\u4e24\u8005\u90fd\u5728\u540c\u4e00\u4e2a\u7f51\u7edc / \u8fdb\u7a0b\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u3002\u56e0\u6b64\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u6709\u80fd\u529b\u5220\u9664\u91cd\u5b9a\u5411\u89c4\u5219\uff0c\u5e76\u5220\u9664\u3001\u6539\u53d8\u3001\u7ec8\u6b62\u6216\u66ff\u6362 sidecar \u4ee3\u7406\u3002 \u8fd9\u5141\u8bb8\u4e00\u4e2a pod \u6545\u610f\u7ed5\u8fc7\u5b83\u7684 sidecar \u7684\u51fa\u7ad9\u6d41\u91cf\u6216\u6545\u610f\u8ba9\u5165\u7ad9\u6d41\u91cf\u7ed5\u8fc7\u5b83\u7684 sidecar\u3002 \u56e0\u6b64\uff0c\u4f9d\u9760 Istio \u65e0\u6761\u4ef6\u5730\u6355\u83b7\u6240\u6709\u6d41\u91cf\u662f\u4e0d\u5b89\u5168\u7684\u3002\u76f8\u53cd\uff0c\u5b89\u5168\u8fb9\u754c\u662f\u5ba2\u6237\u7aef\u4e0d\u80fd\u7ed5\u8fc7\u53e6\u4e00\u4e2a pod \u7684 sidecar\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u6211\u5728 9080 \u7aef\u53e3\u8fd0\u884c review \u5e94\u7528\u7a0b\u5e8f\uff0c\u6211\u53ef\u4ee5\u5047\u8bbe\u6765\u81ea productpage \u5e94\u7528\u7a0b\u5e8f\u7684\u6240\u6709\u6d41\u91cf\u5c06\u88ab sidecar \u4ee3\u7406\u6355\u83b7\uff0c\u5176\u4e2d Istio \u8ba4\u8bc1\u548c\u6388\u6743\u7b56\u7565\u53ef\u80fd\u9002\u7528\u3002 3-1 \u5229\u7528 NetworkPolicy \u8fdb\u884c\u6df1\u5ea6\u9632\u5fa1 \u4e3a\u4e86\u8fdb\u4e00\u6b65\u786e\u4fdd\u6d41\u91cf\u5b89\u5168\uff0cIstio \u7b56\u7565\u53ef\u4ee5\u4e0e Kubernetes \u7f51\u7edc\u7b56\u7565\u5206\u5c42\u3002\u8fd9\u5b9e\u73b0\u4e86\u4e00\u4e2a\u5f3a\u5927\u7684\u6df1\u5ea6\u9632\u5fa1\u7b56\u7565\uff0c\u53ef\u4ee5\u7528\u6765\u8fdb\u4e00\u6b65\u52a0\u5f3a\u4f60\u7684\u7f51\u683c\u7684\u5b89\u5168\u6027\u3002 \u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u53ea\u5141\u8bb8\u6d41\u91cf\u5230\u6211\u4eec review \u5e94\u7528\u7a0b\u5e8f\u7684 9080 \u7aef\u53e3\u3002\u5982\u679c\u96c6\u7fa4\u4e2d\u7684 Pod \u88ab\u7834\u574f\u6216\u5b58\u5728\u5b89\u5168\u6f0f\u6d1e\uff0c\u8fd9\u53ef\u80fd\u4f1a\u9650\u5236\u6216\u963b\u6b62\u653b\u51fb\u8005\u7684\u8fdb\u5c55\u3002 3-2 \u786e\u4fdd\u51fa\u53e3\u6d41\u91cf\u7684\u5b89\u5168 \u4e00\u4e2a\u5e38\u89c1\u7684\u8bef\u89e3\u662f\uff0c\u50cf outboundTrafficPolicy: REGISTRY_ONLY \u4f5c\u4e3a\u4e00\u4e2a\u5b89\u5168\u7b56\u7565\uff0c\u9632\u6b62\u6240\u6709\u5bf9\u672a\u7533\u62a5\u670d\u52a1\u7684\u8bbf\u95ee\u3002\u7136\u800c\uff0c\u5982\u4e0a\u6240\u8ff0\uff0c\u8fd9\u5e76\u4e0d\u662f\u4e00\u4e2a\u5f3a\u5927\u7684\u5b89\u5168\u8fb9\u754c\uff0c\u5e94\u8be5\u88ab\u8ba4\u4e3a\u662f\u5c3d\u529b\u800c\u4e3a\u3002 \u867d\u7136\u8fd9\u5bf9\u9632\u6b62\u610f\u5916\u7684\u4f9d\u8d56\u6027\u5f88\u6709\u7528\uff0c\u4f46\u5982\u679c\u4f60\u60f3\u4fdd\u8bc1\u51fa\u53e3\u6d41\u91cf\u7684\u5b89\u5168\uff0c\u5e76\u5f3a\u5236\u8981\u6c42\u6240\u6709\u51fa\u7ad9\u6d41\u91cf\u901a\u8fc7\u4ee3\u7406\uff0c \u4f60\u5e94\u8be5\u4f9d\u9760 Egress Gateway \u3002 \u5f53\u4e0e\u7f51\u7edc\u7b56\u7565\u76f8\u7ed3\u5408\u65f6\uff0c\u4f60\u53ef\u4ee5\u5f3a\u5236\u6240\u6709\u7684\u6d41\u91cf\uff0c\u6216\u4e00\u4e9b\u5b50\u96c6\uff0c\u901a\u8fc7\u51fa\u53e3\u7f51\u5173\u3002\u8fd9\u786e\u4fdd\u4e86\u5373\u4f7f\u5ba2\u6237\u610f\u5916\u5730\u6216\u6076\u610f\u5730\u7ed5\u8fc7\u4ed6\u4eec\u7684 sidecar\uff0c\u8be5\u8bf7\u6c42\u4e5f\u4f1a\u88ab\u963b\u6b62\u3002 4\u3001\u5f53\u4f7f\u7528 TLS \u53d1\u8d77\u65f6\uff0c\u5728\u76ee\u7684\u5730\u89c4\u5219\u4e2d\u914d\u7f6e TLS \u9a8c\u8bc1 Istio \u63d0\u4f9b\u4e86\u4ece\u4e00\u4e2a sidecar \u4ee3\u7406\u6216\u7f51\u5173\u53d1\u8d77 TLS \u7684\u80fd\u529b\u3002\u8fd9\u4f7f\u5f97\u53d1\u9001\u7eaf\u6587\u672c HTTP \u6d41\u91cf\u7684\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u900f\u660e\u5730 \u201c\u5347\u7ea7 \u201c\u5230 HTTPS\u3002 \u5728\u914d\u7f6e DestinationRule \u7684 tls \u8bbe\u7f6e\u65f6\uff0c\u5fc5\u987b\u6ce8\u610f\u6307\u5b9a caCertificates \u5b57\u6bb5\u3002\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\uff0c\u670d\u52a1\u5668\u7684\u8bc1\u4e66\u5c06\u4e0d\u4f1a\u88ab\u9a8c\u8bc1\u3002 apiVersion: networking.istio.io/v1beta1 kind: DestinationRule metadata: name: google-tls spec: host: google.com trafficPolicy: tls: mode: SIMPLE caCertificates: /etc/ssl/certs/ca-certificates.crt 5\u3001\u7f51\u5173 \u5728\u8fd0\u884c Istio \u7f51\u5173\u65f6\uff0c\u6d89\u53ca\u4e00\u4e9b\u8d44\u6e90\uff1a Gateways\uff0c\u5b83\u63a7\u5236\u7f51\u5173\u7684\u7aef\u53e3\u548c TLS \u8bbe\u7f6e \u3002 VirtualServices\uff0c\u63a7\u5236\u8def\u7531\u903b\u8f91\u3002\u8fd9\u4e9b\u90fd\u662f\u901a\u8fc7\u5728\u7f51\u5173\u5b57\u6bb5\u4e2d\u7684\u76f4\u63a5\u5f15\u7528\u548c\u5728\u7f51\u5173\u548cVirtualService \u7684 hosts \u5b57\u6bb5\u4e2d\u7684\u76f8\u4e92\u7ea6\u5b9a\u4e0e Gateway \u76f8\u5173\u8054\u7684 \u3002 5-1 \u9650\u5236 Gateway \u521b\u5efa\u6743\u9650 \u5efa\u8bae\u5c06 Gateway \u8d44\u6e90\u7684\u521b\u5efa\u9650\u5236\u5728\u53d7\u4fe1\u4efb\u7684\u96c6\u7fa4\u7ba1\u7406\u5458\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7 Kubernetes RBAC \u7b56\u7565\u6216 Open Policy Agent\u7b49\u5de5\u5177\u5b9e\u73b0\u3002 5-2 \u907f\u514d\u8fc7\u4e8e\u5bbd\u6cdb\u7684 hosts \u914d\u7f6e \u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u907f\u514d\u5728 Gateway \u4e2d\u8fdb\u884c\u8fc7\u4e8e\u5e7f\u6cdb\u7684 hosts \u8bbe\u7f6e\u3002 \u4f8b\u5982\uff0c\u8fd9\u79cd\u914d\u7f6e\u5c06\u5141\u8bb8\u4efb\u4f55 VirtualService \u7ed1\u5b9a\u5230 Gateway\uff0c\u53ef\u80fd\u4f1a\u66b4\u9732\u51fa\u610f\u5916\u7684\u57df\uff1a servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*\" \u8fd9\u5e94\u8be5\u88ab\u9501\u5b9a\uff0c\u53ea\u5141\u8bb8\u7279\u5b9a\u57df\u6216\u7279\u5b9a\u547d\u540d\u7a7a\u95f4\u3002 servers: - port: number: 80 name: http protocol: HTTP hosts: - \"foo.example.com\" # \u53ea\u5141\u8bb8 foo.example.com \u7684 VirtualServices - \"default/bar.example.com\" # \u53ea\u5141\u8bb8 default \u547d\u540d\u7a7a\u95f4 bar.example.com \u7684 VirtualServices - \"route-namespace/*\" # \u53ea\u5141\u8bb8 route-namespace \u547d\u540d\u7a7a\u95f4\u7684 VirtualServices 5-3 \u9694\u79bb\u654f\u611f\u670d\u52a1 \u53ef\u80fd\u9700\u8981\u5bf9\u654f\u611f\u670d\u52a1\u5b9e\u65bd\u66f4\u4e25\u683c\u7684\u7269\u7406\u9694\u79bb\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u80fd\u60f3\u4e3a\u654f\u611f\u7684 payment.example.com \u8fd0\u884c\u4e00\u4e2a\u4e13\u7528\u7684\u7f51\u5173\u5b9e\u4f8b\uff0c\u800c\u4e3a\u4e0d\u592a\u654f\u611f\u7684\u57df\u540d\u5982 blog.example.com \u548c store.example.com \u4f7f\u7528\u4e00\u4e2a\u5355\u4e00\u7684\u5171\u4eab\u7f51\u5173\u5b9e\u4f8b\u3002 \u8fd9\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u66f4\u5f3a\u5927\u7684\u6df1\u5ea6\u9632\u5fa1\uff0c\u5e76\u6709\u52a9\u4e8e\u6ee1\u8db3\u67d0\u4e9b\u76d1\u7ba1\u5408\u89c4\u51c6\u5219\u3002 5-4 \u5728\u653e\u5bbd\u7684 SNI \u4e3b\u673a\u5339\u914d\u4e0b\uff0c\u660e\u786e\u5730\u7981\u7528\u6240\u6709\u654f\u611f\u7684 http \u4e3b\u673a \u5728\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a\u4f7f\u7528\u591a\u4e2a Gateways \u6765\u5b9a\u4e49\u53cc\u5411 TLS \u548c\u7b80\u5355 TLS \u662f\u5408\u7406\u7684\u3002\u4f8b\u5982\uff0c\u5bf9 SNI \u4e3b\u673a admin.example.com \u4f7f\u7528\u53cc\u5411 TLS\uff0c\u5bf9 SNI \u4e3b\u673a *.example.com \u4f7f\u7528\u7b80\u5355 TLS \u3002 kind: Gateway metadata: name: guestgateway spec: selector: istio: ingressgateway servers: - port: number: 443 name: https protocol: HTTPS hosts: - \"*.example.com\" tls: mode: SIMPLE --- kind: Gateway metadata: name: admingateway spec: selector: istio: ingressgateway servers: - port: number: 443 name: https protocol: HTTPS hosts: - admin.example.com tls: mode: MUTUAL \u5982\u679c\u6709\u5fc5\u8981\u8fdb\u884c\u4e0a\u8ff0\u64cd\u4f5c\uff0c\u5f3a\u70c8\u5efa\u8bae\u5728\u9644\u52a0\u5230 *.example.com \u7684 VirtualService \u4e2d\u660e\u786e\u7981\u7528 http \u4e3b\u673a admin.example.com \u3002 \u539f\u56e0\u662f\u76ee\u524d\u5e95\u5c42\u7684 envoy \u4ee3\u7406\u4e0d\u9700\u8981 http 1 \u5934 Host \u6216 http 2 \u4f2a\u5934 :authority \u7684 SNI \u7ea6\u675f\u540e\uff0c\u653b\u51fb\u8005\u53ef\u4ee5\u91cd\u65b0\u4f7f\u7528 guest-SNI TLS \u8fde\u63a5\u6765\u8bbf\u95ee admin VirtualService \u3002 http \u54cd\u5e94\u4ee3\u7801 421 \u662f\u4e3a\u8fd9\u79cd Host SNI \u4e0d\u5339\u914d\u800c\u8bbe\u8ba1\u7684\uff0c\u53ef\u4ee5\u7528\u6765\u5b9e\u73b0\u7981\u7528\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: disable-sensitive spec: hosts: - \"admin.example.com\" gateways: - guestgateway http: - match: - uri: prefix: / fault: abort: percentage: value: 100 httpStatus: 421 route: - destination: port: number: 8000 host: dest.default.cluster.local 6\u3001\u534f\u8bae\u68c0\u6d4b Istio \u4f1a\u81ea\u52a8\u786e\u5b9a\u5b83\u6240\u770b\u5230\u7684\u6d41\u91cf\u7684\u534f\u8bae\u3002\u4e3a\u4e86\u907f\u514d\u610f\u5916\u6216\u6545\u610f\u7684\u6f0f\u68c0\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u610f\u5916\u7684\u6d41\u91cf\u884c\u4e3a\uff0c\u5efa\u8bae\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\u660e\u786e\u58f0\u660e\u534f\u8bae\u3002 7\u3001CNI \u4e3a\u4e86\u900f\u660e\u5730\u6355\u83b7\u6240\u6709\u6d41\u91cf\uff0cIstio \u4f9d\u8d56\u4e8e istio-init initContainer \u6240\u914d\u7f6e\u7684 iptables \u89c4\u5219\u3002\u8fd9\u589e\u52a0\u4e86\u4e00\u4e2a\u8981\u6c42\uff0c\u5373 NET_ADMIN \u548c NET_RAW \u7684\u80fd\u529b\u5fc5\u987b\u5bf9 pod \u53ef\u7528\u3002 \u4e3a\u4e86\u51cf\u5c11\u6388\u4e88 pod \u7684\u6743\u9650\uff0cIstio \u63d0\u4f9b\u4e86\u4e00\u4e2a CNI \u63d2\u4ef6\uff0c\u5b83\u6d88\u9664\u4e86\u8fd9\u4e2a\u8981\u6c42\u3002 Istio CNI \u63d2\u4ef6\u76ee\u524d\u662f\u4e00\u4e2a alpha \u529f\u80fd\u3002 8\u3001\u4f7f\u7528\u52a0\u56fa\u7684 docker \u955c\u50cf Istio \u7684\u9ed8\u8ba4 docker \u955c\u50cf\uff0c\u5305\u62ec\u90a3\u4e9b\u7531\u63a7\u5236\u5e73\u9762\u3001\u7f51\u5173\u548c sidecar \u4ee3\u7406\u8fd0\u884c\u7684\u955c\u50cf\uff0c\u90fd\u662f\u57fa\u4e8e ubuntu \u7684\u3002\u8fd9\u63d0\u4f9b\u4e86\u5404\u79cd\u5de5\u5177\uff0c\u5982 bash \u548c curl\uff0c\u8fd9\u4ee5\u65b9\u4fbf\u4e3a\u4ee3\u4ef7\uff0c\u589e\u52a0\u4e86\u653b\u51fb\u9762\u3002 Istio \u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e\u65e0\u53d1\u884c\u7248\u955c\u50cf\u7684\u5c0f\u578b\u955c\u50cf\uff0c\u51cf\u5c11\u4e86\u955c\u50cf\u4e2d\u7684\u4f9d\u8d56\u6027\u3002 \u65e0\u53d1\u884c\u7248\u7684\u955c\u50cf\u76ee\u524d\u662f\u4e00\u4e2a alpha \u529f\u80fd\u3002 9\u3001\u53d1\u5e03\u548c\u5b89\u5168\u7b56\u7565 \u4e3a\u4e86\u786e\u4fdd\u4f60\u7684\u96c6\u7fa4\u6709\u6700\u65b0\u7684\u5df2\u77e5\u6f0f\u6d1e\u7684\u5b89\u5168\u8865\u4e01\uff0c\u91cd\u8981\u7684\u662f\u4fdd\u6301\u5728 Istio \u7684\u6700\u65b0\u8865\u4e01\u7248\u672c\u4e0a\uff0c\u5e76\u786e\u4fdd\u4f60\u5728\u4e00\u4e2a\u652f\u6301\u7684\u7248\u672c\u4e0a\uff0c\u4ecd\u5728\u63a5\u6536\u5b89\u5168\u8865\u4e01\u3002 10\u3001\u68c0\u6d4b\u65e0\u6548\u914d\u7f6e \u867d\u7136 Istio \u5728\u521b\u5efa\u8d44\u6e90\u65f6\u63d0\u4f9b\u4e86\u9a8c\u8bc1\uff0c\u4f46\u8fd9\u4e9b\u68c0\u67e5\u4e0d\u80fd\u6293\u4f4f\u6240\u6709\u963b\u6b62\u914d\u7f6e\u5728\u7f51\u683c\u4e2d\u5206\u5e03\u7684\u95ee\u9898\u3002\u8fd9\u53ef\u80fd\u5bfc\u81f4\u5e94\u7528\u7684\u7b56\u7565\u88ab\u610f\u5916\u5730\u5ffd\u7565\uff0c\u4ece\u800c\u5bfc\u81f4\u610f\u5916\u7684\u7ed3\u679c\u3002 \u5728\u5e94\u7528\u914d\u7f6e\u4e4b\u524d\u6216\u4e4b\u540e\u8fd0\u884c istioctl analyze \uff0c\u4ee5\u786e\u4fdd\u914d\u7f6e\u6709\u6548 \u3002 \u76d1\u63a7\u63a7\u5236\u5e73\u9762\u7684\u62d2\u7edd\u914d\u7f6e\u3002\u9664\u4e86\u65e5\u5fd7\u4e4b\u5916\uff0c\u8fd9\u4e9b\u90fd\u662f\u901a\u8fc7 pilot_total_xds_rejects \u6307\u6807\u6765\u663e\u793a\u7684 \u3002 \u6d4b\u8bd5\u4f60\u7684\u914d\u7f6e\uff0c\u4ee5\u786e\u4fdd\u5b83\u7ed9\u51fa\u9884\u671f\u7684\u7ed3\u679c\u3002\u5bf9\u4e8e\u5b89\u5168\u7b56\u7565\u6765\u8bf4\uff0c\u8fd0\u884c\u6b63\u9762\u548c\u8d1f\u9762\u7684\u6d4b\u8bd5\u662f\u6709\u7528\u7684\uff0c\u4ee5\u786e\u4fdd\u4f60\u4e0d\u4f1a\u610f\u5916\u5730\u9650\u5236\u8fc7\u591a\u6216\u8fc7\u5c11\u7684\u6d41\u91cf\u3002 11\u3001\u9501\u5b9a\u7aef\u53e3 Istio \u914d\u7f6e\u4e86\u5404\u79cd\u53ef\u80fd\u88ab\u9501\u5b9a\u7684\u7aef\u53e3\uff0c\u4ee5\u63d0\u9ad8\u5b89\u5168\u6027\u3002 11-1 \u63a7\u5236\u5e73\u9762 Istiod \u4e3a\u65b9\u4fbf\u8d77\u89c1\uff0c\u9ed8\u8ba4\u66b4\u9732\u4e86\u51e0\u4e2a\u672a\u7ecf\u8ba4\u8bc1\u7684\u660e\u6587\u7aef\u53e3\u3002\u5982\u679c\u9700\u8981\uff0c\u8fd9\u4e9b\u7aef\u53e3\u53ef\u4ee5\u88ab\u5173\u95ed\u3002 8080 \u7aef\u53e3\u66b4\u9732\u4e86\u8c03\u8bd5\u63a5\u53e3\uff0c\u5b83\u63d0\u4f9b\u4e86\u5bf9\u96c6\u7fa4\u72b6\u6001\u7684\u5404\u79cd\u7ec6\u8282\u7684\u8bfb\u53d6\u6743\u9650\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u5728 Istiod \u4e0a\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf ENABLE_DEBUG_ON_HTTP=false \u6765\u7981\u7528\u3002\u8b66\u544a\uff1a\u8bb8\u591a istioctl \u547d\u4ee4\u90fd\u4f9d\u8d56\u4e8e\u8fd9\u4e2a\u63a5\u53e3\uff0c\u5982\u679c\u5b83\u88ab\u7981\u7528\uff0c\u5c06\u65e0\u6cd5\u8fd0\u884c \u3002 15010 \u7aef\u53e3\u901a\u8fc7\u660e\u6587\u66b4\u9732 XDS \u670d\u52a1\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u5728 Istiod \u90e8\u7f72\u4e2d\u6dfb\u52a0 --grpcAddr=\"\" \u6807\u5fd7\u6765\u7981\u7528\u3002\u6ce8\u610f\uff1a\u9ad8\u5ea6\u654f\u611f\u7684\u670d\u52a1\uff0c\u5982\u8bc1\u4e66\u7b7e\u7f72\u548c\u5206\u53d1\u670d\u52a1\uff0c\u7edd\u4e0d\u901a\u8fc7\u660e\u6587\u63d0\u4f9b \u3002 11-2 \u6570\u636e\u5e73\u9762 \u8be5\u4ee3\u7406\u66b4\u9732\u4e86\u5404\u79cd\u7aef\u53e3\u3002\u5bf9\u5916\u66b4\u9732\u7684\u662f 15090 \u7aef\u53e3\uff08\u9065\u6d4b\uff09\u548c 15021 \u7aef\u53e3\uff08\u5065\u5eb7\u68c0\u67e5\uff09\u3002 \u7aef\u53e3 15020 \u548c 15000 \u63d0\u4f9b\u8c03\u8bd5\u7aef\u70b9\u3002\u8fd9\u4e9b\u7aef\u53e3\u53ea\u5728\u672c\u5730\u4e3b\u673a\u4e0a\u66b4\u9732\u3002\u56e0\u6b64\uff0c\u8fd0\u884c\u5728\u4e0e\u4ee3\u7406\u76f8\u540c\u7684 pod \u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u8bbf\u95ee\uff1b\u5728 sidecar \u548c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u6ca1\u6709\u4fe1\u4efb\u8fb9\u754c\u3002 12 \u914d\u7f6e\u7b2c\u4e09\u65b9\u670d\u52a1\u8d26\u6237\u4ee4\u724c \u4e3a\u4e86\u4e0e Istio \u63a7\u5236\u5e73\u9762\u8fdb\u884c\u8ba4\u8bc1\uff0cIstio \u4ee3\u7406\u5c06\u4f7f\u7528\u670d\u52a1\u8d26\u6237\u4ee4\u724c\u3002Kubernetes \u652f\u6301\u8fd9\u79cd\u4ee4\u724c\u7684\u4e24\u79cd\u5f62\u5f0f\uff1a \u7b2c\u4e09\u65b9\u4ee4\u724c\uff0c\u6709\u4e00\u4e2a\u8303\u56f4\u5185\u7684\u53d7\u4f17\u548c\u5230\u671f\u65f6\u95f4 \u3002 \u7b2c\u4e00\u65b9\u4ee4\u724c\uff0c\u6ca1\u6709\u8fc7\u671f\uff0c\u5e76\u88ab\u5b89\u88c5\u5230\u6240\u6709\u7684 Pod \u4e2d \u3002 \u7531\u4e8e\u7b2c\u4e00\u65b9\u4ee4\u724c\u7684\u5c5e\u6027\u4e0d\u592a\u5b89\u5168\uff0cIstio \u5c06\u9ed8\u8ba4\u4f7f\u7528\u7b2c\u4e09\u65b9\u4ee4\u724c\u3002\u7136\u800c\uff0c\u8fd9\u4e2a\u529f\u80fd\u5e76\u4e0d\u662f\u5728\u6240\u6709\u7684 Kubernetes \u5e73\u53f0\u4e0a\u90fd\u542f\u7528\u7684\u3002 \u5982\u679c\u4f60\u4f7f\u7528 istioctl \u6765\u5b89\u88c5\uff0c\u5c06\u4f1a\u81ea\u52a8\u68c0\u6d4b\u5230\u652f\u6301\u3002\u8fd9\u4e5f\u53ef\u4ee5\u624b\u52a8\u5b8c\u6210\uff0c\u901a\u8fc7\u4f20\u9012 --set values.global.jwtPolicy=third-party-jwt \u6216 --set values.global.jwtPolicy=first-party-jwt \u8fdb\u884c\u914d\u7f6e\u3002 \u8981\u786e\u5b9a\u4f60\u7684\u96c6\u7fa4\u662f\u5426\u652f\u6301\u7b2c\u4e09\u65b9\u4ee4\u724c\uff0c\u5bfb\u627e TokenRequest API \u3002\u5982\u679c\u8fd9\u6ca1\u6709\u8fd4\u56de\u54cd\u5e94\uff0c\u90a3\u4e48\u8be5\u529f\u80fd\u5c31\u4e0d\u88ab\u652f\u6301\u3002 $ kubectl get --raw /api/v1 | jq '.resources[] | select(.name | index(\"serviceaccounts/token\"))' { \"name\": \"serviceaccounts/token\", \"singularName\": \"\", \"namespaced\": true, \"group\": \"authentication.k8s.io\", \"version\": \"v1\", \"kind\": \"TokenRequest\", \"verbs\": [ \"create\" ] } 13 \u914d\u7f6e\u4e0b\u6e38\u8fde\u63a5\u7684\u9650\u5236 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\uff08\u548c Envoy\uff09\u5bf9\u4e0b\u6e38\u8fde\u63a5\u7684\u6570\u91cf\u6ca1\u6709\u9650\u5236\u3002\u8fd9\u53ef\u80fd\u88ab\u6076\u610f\u884c\u4e3a\u8005\u5229\u7528\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f60\u5fc5\u987b\u4e3a\u4f60\u7684\u73af\u5883\u914d\u7f6e\u4e00\u4e2a\u9002\u5f53\u7684\u8fde\u63a5\u9650\u5236\u3002 \u901a\u8fc7\u4e0b\u8f7d custom-bootstrap-runtime.yaml \u521b\u5efa\u4e00\u4e2a ConfigMap\u3002\u6839\u636e\u4f60\u7684\u90e8\u7f72\u4e2d\u5404\u4e2a\u7f51\u5173\u5b9e\u4f8b\u6240\u9700\u7684\u5e76\u53d1\u8fde\u63a5\u6570\uff0c\u66f4\u65b0 ConfigMap \u4e2d\u7684 global_downstream_max_connections \u3002\u4e00\u65e6\u8fbe\u5230\u9650\u5236\uff0cEnvoy \u5c06\u5f00\u59cb\u62d2\u7edd tcp \u8fde\u63a5\u3002 $ kubectl -n istio-system apply -f custom-bootstrap-runtime.yaml \u5165\u53e3\u7f51\u5173\u90e8\u7f72\u6253\u8865\u4e01\uff0c\u4ee5\u4f7f\u7528\u4e0a\u8ff0\u914d\u7f6e\u3002\u4e0b\u8f7d gateway-patch.yaml \u5e76\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5e94\u7528\u5b83\u3002 $ kubectl --namespace istio-system patch deployment istio-ingressgateway --patch \"$(cat gateway-patch.yaml)\" \u786e\u8ba4\u65b0\u7684\u9650\u5236\u5df2\u7ecf\u5230\u4f4d\u3002","title":"\u7b2c\u4e8c\u8282 Istio \u5b89\u5168\u6700\u4f73\u5b9e\u8df5"},{"location":"chap9/2Istio_security/#istio","text":"Istio \u7684\u5b89\u5168\u529f\u80fd\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u8eab\u4efd\u3001\u7b56\u7565\u3001\u900f\u660e\u7684 TLS \u52a0\u5bc6\u4ee5\u53ca\u8ba4\u8bc1\u3001\u6388\u6743\u548c\u5ba1\u8ba1\uff08AAA\uff09\u5de5\u5177\u6765\u4fdd\u62a4\u4f60\u7684\u670d\u52a1\u548c\u6570\u636e\u3002\u7136\u800c\uff0c\u4e3a\u4e86\u5145\u5206\u5b89\u5168\u5730\u5229\u7528\u8fd9\u4e9b\u529f\u80fd\uff0c\u5fc5\u987b\u6ce8\u610f\u9075\u5faa\u6700\u4f73\u5b9e\u8df5","title":"\u7b2c\u4e8c\u8282 Istio \u5b89\u5168\u6700\u4f73\u5b9e\u8df5"},{"location":"chap9/2Istio_security/#1-tls","text":"Istio \u5c06\u5c3d\u53ef\u80fd\u4f7f\u7528 \u53cc\u5411TLS \u5bf9\u6d41\u91cf\u8fdb\u884c\u81ea\u52a8\u52a0\u5bc6\u3002 \u7136\u800c\uff0c\u4ee3\u7406\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u88ab\u914d\u7f6e\u4e3a\u8bb8\u53ef\u6a21\u5f0f\uff08 Permissive Mode \uff09\uff0c\u8fd9\u610f\u5473\u7740\u4ed6\u4eec\u5c06\u63a5\u53d7\u53cc\u5411 TLS \u548c\u660e\u6587\u6d41\u91cf \u3002 \u7136\u800c\uff0c\u4ec5\u9760\u53cc\u5411 TLS \u5e76\u4e0d\u8db3\u4ee5\u4fdd\u8bc1\u6d41\u91cf\u7684\u5b89\u5168\uff0c\u56e0\u4e3a\u5b83\u53ea\u63d0\u4f9b\u8ba4\u8bc1\uff0c\u800c\u4e0d\u662f\u6388\u6743\u3002\u8fd9\u610f\u5473\u7740\uff0c\u4efb\u4f55\u62e5\u6709\u6709\u6548\u8bc1\u4e66\u7684\u4eba\u4ecd\u7136\u53ef\u4ee5\u8bbf\u95ee\u4e00\u4e2a\u670d\u52a1\u3002 \u4e3a\u4e86\u5b8c\u5168\u9501\u5b9a\u6d41\u91cf\uff0c\u5efa\u8bae\u914d\u7f6e\u6388\u6743\u7b56\u7565 \u3002\u8fd9\u5141\u8bb8\u521b\u5efa\u7ec6\u7c92\u5ea6\u7684\u7b56\u7565\u6765\u5141\u8bb8\u6216\u62d2\u7edd\u6d41\u91cf\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u53ea\u5141\u8bb8\u6765\u81ea app \u547d\u540d\u7a7a\u95f4\u7684\u8bf7\u6c42\u8bbf\u95ee hello-world \u670d\u52a1\u3002","title":"1\u3001\u53cc\u5411 TLS"},{"location":"chap9/2Istio_security/#2","text":"Istio \u6388\u6743\u5728 Istio \u5b89\u5168\u4e2d\u8d77\u7740\u5173\u952e\u4f5c\u7528\u3002\u5b83\u9700\u8981\u52aa\u529b\u914d\u7f6e\u6b63\u786e\u7684\u6388\u6743\u7b56\u7565\uff0c\u4ee5\u6700\u597d\u5730\u4fdd\u62a4\u4f60\u7684\u96c6\u7fa4\u3002\u4e86\u89e3\u8fd9\u4e9b\u914d\u7f6e\u7684\u5f71\u54cd\u662f\u5f88\u91cd\u8981\u7684\uff0c\u56e0\u4e3a Istio \u65e0\u6cd5\u786e\u5b9a\u6240\u6709\u7528\u6237\u7684\u6b63\u786e\u6388\u6743\u3002\u8bf7\u5168\u7a0b\u5173\u6ce8\u672c\u8282\u5185\u5bb9\u3002","title":"2\u3001\u6388\u6743\u7b56\u7565"},{"location":"chap9/2Istio_security/#2-1","text":"\u6211\u4eec\u5efa\u8bae\u4f60\u6309\u7167 default-deny \u6a21\u5f0f\u5b9a\u4e49\u4f60\u7684 Istio \u6388\u6743\u7b56\u7565\uff0c\u4ee5\u589e\u5f3a\u96c6\u7fa4\u7684\u5b89\u5168\u6001\u52bf\u3002 \u9ed8\u8ba4\u62d2\u7edd\u6388\u6743\u6a21\u5f0f\u610f\u5473\u7740\u4f60\u7684\u7cfb\u7edf\u9ed8\u8ba4\u62d2\u7edd\u6240\u6709\u8bf7\u6c42\uff0c\u800c\u4f60\u5b9a\u4e49\u4e86\u5141\u8bb8\u8bf7\u6c42\u7684\u6761\u4ef6 \u3002\u5982\u679c\u4f60\u9519\u8fc7\u4e86\u4e00\u4e9b\u6761\u4ef6\uff0c \u6d41\u91cf\u5c06\u88ab\u610f\u5916\u5730\u62d2\u7edd\uff0c\u800c\u4e0d\u662f\u6d41\u91cf\u88ab\u610f\u5916\u5730\u5141\u8bb8 \u3002\u540e\u8005\u901a\u5e38\u662f\u4e00\u4e2a\u5b89\u5168\u4e8b\u4ef6\uff0c\u800c\u524d\u8005\u53ef\u80fd\u4f1a\u5bfc\u81f4\u7cdf\u7cd5\u7684\u7528\u6237\u4f53\u9a8c\u3001\u670d\u52a1\u4e2d\u65ad\u6216\u4e0d\u7b26\u5408\u4f60\u7684 SLO/SLA\u3002 \u4f8b\u5982\uff0c\u5728 HTTP \u6d41\u91cf\u7684\u6388\u6743\u4efb\u52a1\u4e2d\uff0c\u540d\u4e3a allow-nothing \u7684\u6388\u6743\u7b56\u7565\u786e\u4fdd\u6240\u6709\u6d41\u91cf\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u88ab\u62d2\u7edd\u3002\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c\u5176\u4ed6\u6388\u6743\u7b56\u7565\u6839\u636e\u7279\u5b9a\u6761\u4ef6\u5141\u8bb8\u6d41\u91cf\u3002","title":"2-1 \u5e94\u7528\u9ed8\u8ba4\u62d2\u7edd\u7684\u6388\u6743\u7b56\u7565"},{"location":"chap9/2Istio_security/#2-2","text":"Istio \u6388\u6743\u7b56\u7565\u53ef\u4ee5\u57fa\u4e8e HTTP \u8bf7\u6c42\u4e2d\u7684 URL \u8def\u5f84\u3002\u8def\u5f84\u89c4\u8303\u5316\uff08\u53c8\u79f0 URI \u89c4\u8303\u5316\uff09 \u5bf9\u4f20\u5165\u8bf7\u6c42\u7684\u8def\u5f84\u8fdb\u884c\u4fee\u6539\u548c\u6807\u51c6\u5316\uff0c\u4ece\u800c\u4f7f\u89c4\u8303\u5316\u540e\u7684\u8def\u5f84\u80fd\u591f\u4ee5\u6807\u51c6\u65b9\u5f0f\u8fdb\u884c\u5904\u7406\u3002\u8bed\u6cd5\u4e0a\u4e0d\u540c\u7684\u8def\u5f84\u5728\u8def\u5f84\u89c4\u8303\u5316\u540e\u53ef\u80fd\u662f\u7b49\u540c\u7684\u3002 Istio \u652f\u6301\u4ee5\u4e0b\u8bf7\u6c42\u8def\u5f84\u7684\u89c4\u8303\u5316\u65b9\u6848\uff0c\u7136\u540e\u518d\u6839\u636e\u6388\u6743\u7b56\u7565\u8fdb\u884c\u8bc4\u4f30\u548c\u8def\u7531\u8bf7\u6c42\uff1a \u8be5\u914d\u7f6e\u662f\u901a\u8fc7 mesh \u914d\u7f6e\u4e2d\u7684 pathNormalization \u5b57\u6bb5\u6307\u5b9a\u7684\u3002 \u4e3a\u4e86\u5f3a\u8c03\u8fd9\u4e00\u70b9\uff0c\u89c4\u8303\u5316\u7b97\u6cd5\u662f\u6309\u7167\u4ee5\u4e0b\u987a\u5e8f\u8fdb\u884c\u7684\uff1a \u767e\u5206\u6bd4\u89e3\u7801 %2F \u3001 %2f \u3001 %5C \u548c %5c \u5408\u5e76\u659c\u7ebf","title":"2-2 \u5728\u8def\u5f84\u89c4\u8303\u5316\u4e0a\u5b9a\u5236\u4f60\u7684\u7cfb\u7edf"},{"location":"chap9/2Istio_security/#2-3","text":"\u786e\u4fdd Envoy \u89c4\u8303\u5316\u8bf7\u6c42\u8def\u5f84\u4ee5\u7b26\u5408\u4f60\u7684\u540e\u7aef\u670d\u52a1\u7684\u671f\u671b\uff0c\u5bf9\u4f60\u7684\u7cfb\u7edf\u5b89\u5168\u81f3\u5173\u91cd\u8981\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u53ef\u4ee5\u4f5c\u4e3a\u4f60\u914d\u7f6e\u7cfb\u7edf\u7684\u53c2\u8003\u3002\u89c4\u8303\u5316\u7684 URL \u8def\u5f84\uff0c\u5982\u679c\u9009\u62e9\u4e86 NONE \uff0c\u5219\u662f\u539f\u59cb\u7684 URL \u8def\u5f84\u5c06\uff1a \u7528\u6765\u5bf9\u7167\u6388\u6743\u7b56\u7565\u8fdb\u884c\u68c0\u67e5 \u8f6c\u53d1\u5230\u540e\u7aef\u5e94\u7528\u7a0b\u5e8f","title":"2-3 \u914d\u7f6e\u7684\u4f8b\u5b50"},{"location":"chap9/2Istio_security/#2-4","text":"\u4f60\u53ef\u4ee5\u4f7f\u7528 istioctl \u6765\u66f4\u65b0 mesh \u914d\u7f6e $ istioctl upgrade --set meshConfig.pathNormalization.normalization=DECODE_AND_MERGE_SLASHES \u6216\u901a\u8fc7\u6539\u53d8\u4f60\u7684 Operator \u91cd\u5199\u6587\u4ef6 $ cat <<EOF > iop.yaml apiVersion: install.istio.io/v1alpha1 kind: IstioOperator spec: meshConfig: pathNormalization: normalization: DECODE_AND_MERGE_SLASHES EOF $ istioctl install -f iop.yaml \u53e6\u5916\uff0c\u5982\u679c\u4f60\u60f3\u76f4\u63a5\u7f16\u8f91 Mesh \u914d\u7f6e\uff0c\u4f60\u53ef\u4ee5\u5c06 pathNormalization \u6dfb\u52a0\u5230 mesh \u914d\u7f6e\u4e2d\uff0c\u8be5\u914d\u7f6e\u662f istio-<REVISION_ID> \u7684 CongfigMap \uff0c\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u9009\u62e9 DECODE_AND_MERGE_SLASHES \u9009\u9879\uff0c\u4f60\u4fee\u6539 mesh \u914d\u7f6e\u5982\u4e0b\uff1a apiVersion: v1 data: mesh: |- ... pathNormalization: normalization: DECODE_AND_MERGE_SLASHES ...","title":"2-4 \u5982\u4f55\u914d\u7f6e"},{"location":"chap9/2Istio_security/#2-5","text":"\u5927\u5c0f\u5199\u89c4\u8303\u5316 \u5728\u67d0\u4e9b\u73af\u5883\u4e2d\uff0c\u4ee5\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u7684\u65b9\u5f0f\u6bd4\u8f83\u6388\u6743\u7b56\u7565\u4e2d\u7684\u8def\u5f84\u53ef\u80fd\u662f\u6709\u7528\u7684\u3002\u4f8b\u5982\uff0c\u5c06 https://myurl/get \u548c https://myurl/GeT \u7b49\u540c\u5bf9\u5f85\u3002 \u5728\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 EnvoyFilter\u3002 \u8fd9\u4e2a\u8fc7\u6ee4\u5668\u5c06\u6539\u53d8\u7528\u4e8e\u6bd4\u8f83\u7684\u8def\u5f84\u548c\u5448\u73b0\u7ed9\u5e94\u7528\u7a0b\u5e8f\u7684\u8def\u5f84\u3002 apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata: name: ingress-case-insensitive namespace: istio-system spec: configPatches: - applyTo: HTTP_FILTER match: context: GATEWAY listener: filterChain: filter: name: \"envoy.filters.network.http_connection_manager\" subFilter: name: \"envoy.filters.http.router\" patch: operation: INSERT_BEFORE value: name: envoy.lua typed_config: \"@type\": \"type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua\" inlineCode: | function envoy_on_request(request_handle) local path = request_handle:headers():get(\":path\") request_handle:headers():replace(\":path\", string.lower(path)) end","title":"2-5 \u4e0d\u592a\u5e38\u89c1\u7684\u89c4\u8303\u5316\u914d\u7f6e"},{"location":"chap9/2Istio_security/#3","text":"Istio sidecar \u7684\u5de5\u4f5c\u539f\u7406\u662f\u6355\u83b7\u5165\u7ad9\u6d41\u91cf\u548c\u51fa\u7ad9\u6d41\u91cf\uff0c\u5e76\u901a\u8fc7 sidecar \u4ee3\u7406\u5f15\u5bfc\u5b83\u4eec\u3002 \u7136\u800c\uff0c\u5e76\u4e0d\u662f\u6240\u6709\u7684\u6d41\u91cf\u90fd\u88ab\u6355\u83b7\uff1a \u91cd\u5b9a\u5411\u53ea\u5904\u7406\u57fa\u4e8e TCP \u7684\u6d41\u91cf\u3002\u4efb\u4f55 UDP \u6216 ICMP \u6570\u636e\u5305\u90fd\u4e0d\u4f1a\u88ab\u6355\u83b7\u6216\u4fee\u6539\u3002 Sidecar \u4f7f\u7528\u7684\u8bb8\u591a\u7aef\u53e3\u4ee5\u53ca 22 \u53f7\u7aef\u53e3\u7684\u5165\u7ad9\u6355\u83b7\u88ab\u7981\u7528\u3002\u8fd9\u4e2a\u5217\u8868\u53ef\u4ee5\u901a\u8fc7 traffic.sidecar.istio.io/excludeInboundPorts \u7b49\u9009\u9879\u6765\u6269\u5c55 \u3002 \u51fa\u7ad9\u6355\u83b7\u540c\u6837\u53ef\u4ee5\u901a\u8fc7 traffic.sidecar.istio.io/excludeOutboundPorts \u7b49\u8bbe\u7f6e\u6216\u5176\u4ed6\u65b9\u5f0f\u51cf\u5c11\u3002 \u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u7528\u7a0b\u5e8f\u548c\u5176 sidecar \u4ee3\u7406\u4e4b\u95f4\u7684\u5b89\u5168\u8fb9\u754c\u6700\u5c0f\u3002 \u5bf9 sidecar \u7684\u914d\u7f6e\u662f\u4ee5\u6bcf\u4e2a\u6a21\u5757\u4e3a\u57fa\u7840\u7684\uff0c\u5e76\u4e14\u4e24\u8005\u90fd\u5728\u540c\u4e00\u4e2a\u7f51\u7edc / \u8fdb\u7a0b\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u3002\u56e0\u6b64\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u6709\u80fd\u529b\u5220\u9664\u91cd\u5b9a\u5411\u89c4\u5219\uff0c\u5e76\u5220\u9664\u3001\u6539\u53d8\u3001\u7ec8\u6b62\u6216\u66ff\u6362 sidecar \u4ee3\u7406\u3002 \u8fd9\u5141\u8bb8\u4e00\u4e2a pod \u6545\u610f\u7ed5\u8fc7\u5b83\u7684 sidecar \u7684\u51fa\u7ad9\u6d41\u91cf\u6216\u6545\u610f\u8ba9\u5165\u7ad9\u6d41\u91cf\u7ed5\u8fc7\u5b83\u7684 sidecar\u3002 \u56e0\u6b64\uff0c\u4f9d\u9760 Istio \u65e0\u6761\u4ef6\u5730\u6355\u83b7\u6240\u6709\u6d41\u91cf\u662f\u4e0d\u5b89\u5168\u7684\u3002\u76f8\u53cd\uff0c\u5b89\u5168\u8fb9\u754c\u662f\u5ba2\u6237\u7aef\u4e0d\u80fd\u7ed5\u8fc7\u53e6\u4e00\u4e2a pod \u7684 sidecar\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u6211\u5728 9080 \u7aef\u53e3\u8fd0\u884c review \u5e94\u7528\u7a0b\u5e8f\uff0c\u6211\u53ef\u4ee5\u5047\u8bbe\u6765\u81ea productpage \u5e94\u7528\u7a0b\u5e8f\u7684\u6240\u6709\u6d41\u91cf\u5c06\u88ab sidecar \u4ee3\u7406\u6355\u83b7\uff0c\u5176\u4e2d Istio \u8ba4\u8bc1\u548c\u6388\u6743\u7b56\u7565\u53ef\u80fd\u9002\u7528\u3002","title":"3\u3001\u4e86\u89e3\u6d41\u91cf\u91c7\u96c6\u7684\u9650\u5236"},{"location":"chap9/2Istio_security/#3-1-networkpolicy","text":"\u4e3a\u4e86\u8fdb\u4e00\u6b65\u786e\u4fdd\u6d41\u91cf\u5b89\u5168\uff0cIstio \u7b56\u7565\u53ef\u4ee5\u4e0e Kubernetes \u7f51\u7edc\u7b56\u7565\u5206\u5c42\u3002\u8fd9\u5b9e\u73b0\u4e86\u4e00\u4e2a\u5f3a\u5927\u7684\u6df1\u5ea6\u9632\u5fa1\u7b56\u7565\uff0c\u53ef\u4ee5\u7528\u6765\u8fdb\u4e00\u6b65\u52a0\u5f3a\u4f60\u7684\u7f51\u683c\u7684\u5b89\u5168\u6027\u3002 \u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u53ea\u5141\u8bb8\u6d41\u91cf\u5230\u6211\u4eec review \u5e94\u7528\u7a0b\u5e8f\u7684 9080 \u7aef\u53e3\u3002\u5982\u679c\u96c6\u7fa4\u4e2d\u7684 Pod \u88ab\u7834\u574f\u6216\u5b58\u5728\u5b89\u5168\u6f0f\u6d1e\uff0c\u8fd9\u53ef\u80fd\u4f1a\u9650\u5236\u6216\u963b\u6b62\u653b\u51fb\u8005\u7684\u8fdb\u5c55\u3002","title":"3-1 \u5229\u7528 NetworkPolicy \u8fdb\u884c\u6df1\u5ea6\u9632\u5fa1"},{"location":"chap9/2Istio_security/#3-2","text":"\u4e00\u4e2a\u5e38\u89c1\u7684\u8bef\u89e3\u662f\uff0c\u50cf outboundTrafficPolicy: REGISTRY_ONLY \u4f5c\u4e3a\u4e00\u4e2a\u5b89\u5168\u7b56\u7565\uff0c\u9632\u6b62\u6240\u6709\u5bf9\u672a\u7533\u62a5\u670d\u52a1\u7684\u8bbf\u95ee\u3002\u7136\u800c\uff0c\u5982\u4e0a\u6240\u8ff0\uff0c\u8fd9\u5e76\u4e0d\u662f\u4e00\u4e2a\u5f3a\u5927\u7684\u5b89\u5168\u8fb9\u754c\uff0c\u5e94\u8be5\u88ab\u8ba4\u4e3a\u662f\u5c3d\u529b\u800c\u4e3a\u3002 \u867d\u7136\u8fd9\u5bf9\u9632\u6b62\u610f\u5916\u7684\u4f9d\u8d56\u6027\u5f88\u6709\u7528\uff0c\u4f46\u5982\u679c\u4f60\u60f3\u4fdd\u8bc1\u51fa\u53e3\u6d41\u91cf\u7684\u5b89\u5168\uff0c\u5e76\u5f3a\u5236\u8981\u6c42\u6240\u6709\u51fa\u7ad9\u6d41\u91cf\u901a\u8fc7\u4ee3\u7406\uff0c \u4f60\u5e94\u8be5\u4f9d\u9760 Egress Gateway \u3002 \u5f53\u4e0e\u7f51\u7edc\u7b56\u7565\u76f8\u7ed3\u5408\u65f6\uff0c\u4f60\u53ef\u4ee5\u5f3a\u5236\u6240\u6709\u7684\u6d41\u91cf\uff0c\u6216\u4e00\u4e9b\u5b50\u96c6\uff0c\u901a\u8fc7\u51fa\u53e3\u7f51\u5173\u3002\u8fd9\u786e\u4fdd\u4e86\u5373\u4f7f\u5ba2\u6237\u610f\u5916\u5730\u6216\u6076\u610f\u5730\u7ed5\u8fc7\u4ed6\u4eec\u7684 sidecar\uff0c\u8be5\u8bf7\u6c42\u4e5f\u4f1a\u88ab\u963b\u6b62\u3002","title":"3-2 \u786e\u4fdd\u51fa\u53e3\u6d41\u91cf\u7684\u5b89\u5168"},{"location":"chap9/2Istio_security/#4-tls-tls","text":"Istio \u63d0\u4f9b\u4e86\u4ece\u4e00\u4e2a sidecar \u4ee3\u7406\u6216\u7f51\u5173\u53d1\u8d77 TLS \u7684\u80fd\u529b\u3002\u8fd9\u4f7f\u5f97\u53d1\u9001\u7eaf\u6587\u672c HTTP \u6d41\u91cf\u7684\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u900f\u660e\u5730 \u201c\u5347\u7ea7 \u201c\u5230 HTTPS\u3002 \u5728\u914d\u7f6e DestinationRule \u7684 tls \u8bbe\u7f6e\u65f6\uff0c\u5fc5\u987b\u6ce8\u610f\u6307\u5b9a caCertificates \u5b57\u6bb5\u3002\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\uff0c\u670d\u52a1\u5668\u7684\u8bc1\u4e66\u5c06\u4e0d\u4f1a\u88ab\u9a8c\u8bc1\u3002 apiVersion: networking.istio.io/v1beta1 kind: DestinationRule metadata: name: google-tls spec: host: google.com trafficPolicy: tls: mode: SIMPLE caCertificates: /etc/ssl/certs/ca-certificates.crt","title":"4\u3001\u5f53\u4f7f\u7528 TLS \u53d1\u8d77\u65f6\uff0c\u5728\u76ee\u7684\u5730\u89c4\u5219\u4e2d\u914d\u7f6e TLS \u9a8c\u8bc1"},{"location":"chap9/2Istio_security/#5","text":"\u5728\u8fd0\u884c Istio \u7f51\u5173\u65f6\uff0c\u6d89\u53ca\u4e00\u4e9b\u8d44\u6e90\uff1a Gateways\uff0c\u5b83\u63a7\u5236\u7f51\u5173\u7684\u7aef\u53e3\u548c TLS \u8bbe\u7f6e \u3002 VirtualServices\uff0c\u63a7\u5236\u8def\u7531\u903b\u8f91\u3002\u8fd9\u4e9b\u90fd\u662f\u901a\u8fc7\u5728\u7f51\u5173\u5b57\u6bb5\u4e2d\u7684\u76f4\u63a5\u5f15\u7528\u548c\u5728\u7f51\u5173\u548cVirtualService \u7684 hosts \u5b57\u6bb5\u4e2d\u7684\u76f8\u4e92\u7ea6\u5b9a\u4e0e Gateway \u76f8\u5173\u8054\u7684 \u3002","title":"5\u3001\u7f51\u5173"},{"location":"chap9/2Istio_security/#5-1-gateway","text":"\u5efa\u8bae\u5c06 Gateway \u8d44\u6e90\u7684\u521b\u5efa\u9650\u5236\u5728\u53d7\u4fe1\u4efb\u7684\u96c6\u7fa4\u7ba1\u7406\u5458\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7 Kubernetes RBAC \u7b56\u7565\u6216 Open Policy Agent\u7b49\u5de5\u5177\u5b9e\u73b0\u3002","title":"5-1 \u9650\u5236 Gateway \u521b\u5efa\u6743\u9650"},{"location":"chap9/2Istio_security/#5-2-hosts","text":"\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u907f\u514d\u5728 Gateway \u4e2d\u8fdb\u884c\u8fc7\u4e8e\u5e7f\u6cdb\u7684 hosts \u8bbe\u7f6e\u3002 \u4f8b\u5982\uff0c\u8fd9\u79cd\u914d\u7f6e\u5c06\u5141\u8bb8\u4efb\u4f55 VirtualService \u7ed1\u5b9a\u5230 Gateway\uff0c\u53ef\u80fd\u4f1a\u66b4\u9732\u51fa\u610f\u5916\u7684\u57df\uff1a servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*\" \u8fd9\u5e94\u8be5\u88ab\u9501\u5b9a\uff0c\u53ea\u5141\u8bb8\u7279\u5b9a\u57df\u6216\u7279\u5b9a\u547d\u540d\u7a7a\u95f4\u3002 servers: - port: number: 80 name: http protocol: HTTP hosts: - \"foo.example.com\" # \u53ea\u5141\u8bb8 foo.example.com \u7684 VirtualServices - \"default/bar.example.com\" # \u53ea\u5141\u8bb8 default \u547d\u540d\u7a7a\u95f4 bar.example.com \u7684 VirtualServices - \"route-namespace/*\" # \u53ea\u5141\u8bb8 route-namespace \u547d\u540d\u7a7a\u95f4\u7684 VirtualServices","title":"5-2 \u907f\u514d\u8fc7\u4e8e\u5bbd\u6cdb\u7684 hosts \u914d\u7f6e"},{"location":"chap9/2Istio_security/#5-3","text":"\u53ef\u80fd\u9700\u8981\u5bf9\u654f\u611f\u670d\u52a1\u5b9e\u65bd\u66f4\u4e25\u683c\u7684\u7269\u7406\u9694\u79bb\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u80fd\u60f3\u4e3a\u654f\u611f\u7684 payment.example.com \u8fd0\u884c\u4e00\u4e2a\u4e13\u7528\u7684\u7f51\u5173\u5b9e\u4f8b\uff0c\u800c\u4e3a\u4e0d\u592a\u654f\u611f\u7684\u57df\u540d\u5982 blog.example.com \u548c store.example.com \u4f7f\u7528\u4e00\u4e2a\u5355\u4e00\u7684\u5171\u4eab\u7f51\u5173\u5b9e\u4f8b\u3002 \u8fd9\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u66f4\u5f3a\u5927\u7684\u6df1\u5ea6\u9632\u5fa1\uff0c\u5e76\u6709\u52a9\u4e8e\u6ee1\u8db3\u67d0\u4e9b\u76d1\u7ba1\u5408\u89c4\u51c6\u5219\u3002","title":"5-3 \u9694\u79bb\u654f\u611f\u670d\u52a1"},{"location":"chap9/2Istio_security/#5-4-sni-http","text":"\u5728\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a\u4f7f\u7528\u591a\u4e2a Gateways \u6765\u5b9a\u4e49\u53cc\u5411 TLS \u548c\u7b80\u5355 TLS \u662f\u5408\u7406\u7684\u3002\u4f8b\u5982\uff0c\u5bf9 SNI \u4e3b\u673a admin.example.com \u4f7f\u7528\u53cc\u5411 TLS\uff0c\u5bf9 SNI \u4e3b\u673a *.example.com \u4f7f\u7528\u7b80\u5355 TLS \u3002 kind: Gateway metadata: name: guestgateway spec: selector: istio: ingressgateway servers: - port: number: 443 name: https protocol: HTTPS hosts: - \"*.example.com\" tls: mode: SIMPLE --- kind: Gateway metadata: name: admingateway spec: selector: istio: ingressgateway servers: - port: number: 443 name: https protocol: HTTPS hosts: - admin.example.com tls: mode: MUTUAL \u5982\u679c\u6709\u5fc5\u8981\u8fdb\u884c\u4e0a\u8ff0\u64cd\u4f5c\uff0c\u5f3a\u70c8\u5efa\u8bae\u5728\u9644\u52a0\u5230 *.example.com \u7684 VirtualService \u4e2d\u660e\u786e\u7981\u7528 http \u4e3b\u673a admin.example.com \u3002 \u539f\u56e0\u662f\u76ee\u524d\u5e95\u5c42\u7684 envoy \u4ee3\u7406\u4e0d\u9700\u8981 http 1 \u5934 Host \u6216 http 2 \u4f2a\u5934 :authority \u7684 SNI \u7ea6\u675f\u540e\uff0c\u653b\u51fb\u8005\u53ef\u4ee5\u91cd\u65b0\u4f7f\u7528 guest-SNI TLS \u8fde\u63a5\u6765\u8bbf\u95ee admin VirtualService \u3002 http \u54cd\u5e94\u4ee3\u7801 421 \u662f\u4e3a\u8fd9\u79cd Host SNI \u4e0d\u5339\u914d\u800c\u8bbe\u8ba1\u7684\uff0c\u53ef\u4ee5\u7528\u6765\u5b9e\u73b0\u7981\u7528\u3002 apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: disable-sensitive spec: hosts: - \"admin.example.com\" gateways: - guestgateway http: - match: - uri: prefix: / fault: abort: percentage: value: 100 httpStatus: 421 route: - destination: port: number: 8000 host: dest.default.cluster.local","title":"5-4 \u5728\u653e\u5bbd\u7684 SNI \u4e3b\u673a\u5339\u914d\u4e0b\uff0c\u660e\u786e\u5730\u7981\u7528\u6240\u6709\u654f\u611f\u7684 http \u4e3b\u673a"},{"location":"chap9/2Istio_security/#6","text":"Istio \u4f1a\u81ea\u52a8\u786e\u5b9a\u5b83\u6240\u770b\u5230\u7684\u6d41\u91cf\u7684\u534f\u8bae\u3002\u4e3a\u4e86\u907f\u514d\u610f\u5916\u6216\u6545\u610f\u7684\u6f0f\u68c0\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u610f\u5916\u7684\u6d41\u91cf\u884c\u4e3a\uff0c\u5efa\u8bae\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\u660e\u786e\u58f0\u660e\u534f\u8bae\u3002","title":"6\u3001\u534f\u8bae\u68c0\u6d4b"},{"location":"chap9/2Istio_security/#7cni","text":"\u4e3a\u4e86\u900f\u660e\u5730\u6355\u83b7\u6240\u6709\u6d41\u91cf\uff0cIstio \u4f9d\u8d56\u4e8e istio-init initContainer \u6240\u914d\u7f6e\u7684 iptables \u89c4\u5219\u3002\u8fd9\u589e\u52a0\u4e86\u4e00\u4e2a\u8981\u6c42\uff0c\u5373 NET_ADMIN \u548c NET_RAW \u7684\u80fd\u529b\u5fc5\u987b\u5bf9 pod \u53ef\u7528\u3002 \u4e3a\u4e86\u51cf\u5c11\u6388\u4e88 pod \u7684\u6743\u9650\uff0cIstio \u63d0\u4f9b\u4e86\u4e00\u4e2a CNI \u63d2\u4ef6\uff0c\u5b83\u6d88\u9664\u4e86\u8fd9\u4e2a\u8981\u6c42\u3002 Istio CNI \u63d2\u4ef6\u76ee\u524d\u662f\u4e00\u4e2a alpha \u529f\u80fd\u3002","title":"7\u3001CNI"},{"location":"chap9/2Istio_security/#8-docker","text":"Istio \u7684\u9ed8\u8ba4 docker \u955c\u50cf\uff0c\u5305\u62ec\u90a3\u4e9b\u7531\u63a7\u5236\u5e73\u9762\u3001\u7f51\u5173\u548c sidecar \u4ee3\u7406\u8fd0\u884c\u7684\u955c\u50cf\uff0c\u90fd\u662f\u57fa\u4e8e ubuntu \u7684\u3002\u8fd9\u63d0\u4f9b\u4e86\u5404\u79cd\u5de5\u5177\uff0c\u5982 bash \u548c curl\uff0c\u8fd9\u4ee5\u65b9\u4fbf\u4e3a\u4ee3\u4ef7\uff0c\u589e\u52a0\u4e86\u653b\u51fb\u9762\u3002 Istio \u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e\u65e0\u53d1\u884c\u7248\u955c\u50cf\u7684\u5c0f\u578b\u955c\u50cf\uff0c\u51cf\u5c11\u4e86\u955c\u50cf\u4e2d\u7684\u4f9d\u8d56\u6027\u3002 \u65e0\u53d1\u884c\u7248\u7684\u955c\u50cf\u76ee\u524d\u662f\u4e00\u4e2a alpha \u529f\u80fd\u3002","title":"8\u3001\u4f7f\u7528\u52a0\u56fa\u7684 docker \u955c\u50cf"},{"location":"chap9/2Istio_security/#9","text":"\u4e3a\u4e86\u786e\u4fdd\u4f60\u7684\u96c6\u7fa4\u6709\u6700\u65b0\u7684\u5df2\u77e5\u6f0f\u6d1e\u7684\u5b89\u5168\u8865\u4e01\uff0c\u91cd\u8981\u7684\u662f\u4fdd\u6301\u5728 Istio \u7684\u6700\u65b0\u8865\u4e01\u7248\u672c\u4e0a\uff0c\u5e76\u786e\u4fdd\u4f60\u5728\u4e00\u4e2a\u652f\u6301\u7684\u7248\u672c\u4e0a\uff0c\u4ecd\u5728\u63a5\u6536\u5b89\u5168\u8865\u4e01\u3002","title":"9\u3001\u53d1\u5e03\u548c\u5b89\u5168\u7b56\u7565"},{"location":"chap9/2Istio_security/#10","text":"\u867d\u7136 Istio \u5728\u521b\u5efa\u8d44\u6e90\u65f6\u63d0\u4f9b\u4e86\u9a8c\u8bc1\uff0c\u4f46\u8fd9\u4e9b\u68c0\u67e5\u4e0d\u80fd\u6293\u4f4f\u6240\u6709\u963b\u6b62\u914d\u7f6e\u5728\u7f51\u683c\u4e2d\u5206\u5e03\u7684\u95ee\u9898\u3002\u8fd9\u53ef\u80fd\u5bfc\u81f4\u5e94\u7528\u7684\u7b56\u7565\u88ab\u610f\u5916\u5730\u5ffd\u7565\uff0c\u4ece\u800c\u5bfc\u81f4\u610f\u5916\u7684\u7ed3\u679c\u3002 \u5728\u5e94\u7528\u914d\u7f6e\u4e4b\u524d\u6216\u4e4b\u540e\u8fd0\u884c istioctl analyze \uff0c\u4ee5\u786e\u4fdd\u914d\u7f6e\u6709\u6548 \u3002 \u76d1\u63a7\u63a7\u5236\u5e73\u9762\u7684\u62d2\u7edd\u914d\u7f6e\u3002\u9664\u4e86\u65e5\u5fd7\u4e4b\u5916\uff0c\u8fd9\u4e9b\u90fd\u662f\u901a\u8fc7 pilot_total_xds_rejects \u6307\u6807\u6765\u663e\u793a\u7684 \u3002 \u6d4b\u8bd5\u4f60\u7684\u914d\u7f6e\uff0c\u4ee5\u786e\u4fdd\u5b83\u7ed9\u51fa\u9884\u671f\u7684\u7ed3\u679c\u3002\u5bf9\u4e8e\u5b89\u5168\u7b56\u7565\u6765\u8bf4\uff0c\u8fd0\u884c\u6b63\u9762\u548c\u8d1f\u9762\u7684\u6d4b\u8bd5\u662f\u6709\u7528\u7684\uff0c\u4ee5\u786e\u4fdd\u4f60\u4e0d\u4f1a\u610f\u5916\u5730\u9650\u5236\u8fc7\u591a\u6216\u8fc7\u5c11\u7684\u6d41\u91cf\u3002","title":"10\u3001\u68c0\u6d4b\u65e0\u6548\u914d\u7f6e"},{"location":"chap9/2Istio_security/#11","text":"Istio \u914d\u7f6e\u4e86\u5404\u79cd\u53ef\u80fd\u88ab\u9501\u5b9a\u7684\u7aef\u53e3\uff0c\u4ee5\u63d0\u9ad8\u5b89\u5168\u6027\u3002","title":"11\u3001\u9501\u5b9a\u7aef\u53e3"},{"location":"chap9/2Istio_security/#11-1","text":"Istiod \u4e3a\u65b9\u4fbf\u8d77\u89c1\uff0c\u9ed8\u8ba4\u66b4\u9732\u4e86\u51e0\u4e2a\u672a\u7ecf\u8ba4\u8bc1\u7684\u660e\u6587\u7aef\u53e3\u3002\u5982\u679c\u9700\u8981\uff0c\u8fd9\u4e9b\u7aef\u53e3\u53ef\u4ee5\u88ab\u5173\u95ed\u3002 8080 \u7aef\u53e3\u66b4\u9732\u4e86\u8c03\u8bd5\u63a5\u53e3\uff0c\u5b83\u63d0\u4f9b\u4e86\u5bf9\u96c6\u7fa4\u72b6\u6001\u7684\u5404\u79cd\u7ec6\u8282\u7684\u8bfb\u53d6\u6743\u9650\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u5728 Istiod \u4e0a\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf ENABLE_DEBUG_ON_HTTP=false \u6765\u7981\u7528\u3002\u8b66\u544a\uff1a\u8bb8\u591a istioctl \u547d\u4ee4\u90fd\u4f9d\u8d56\u4e8e\u8fd9\u4e2a\u63a5\u53e3\uff0c\u5982\u679c\u5b83\u88ab\u7981\u7528\uff0c\u5c06\u65e0\u6cd5\u8fd0\u884c \u3002 15010 \u7aef\u53e3\u901a\u8fc7\u660e\u6587\u66b4\u9732 XDS \u670d\u52a1\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u5728 Istiod \u90e8\u7f72\u4e2d\u6dfb\u52a0 --grpcAddr=\"\" \u6807\u5fd7\u6765\u7981\u7528\u3002\u6ce8\u610f\uff1a\u9ad8\u5ea6\u654f\u611f\u7684\u670d\u52a1\uff0c\u5982\u8bc1\u4e66\u7b7e\u7f72\u548c\u5206\u53d1\u670d\u52a1\uff0c\u7edd\u4e0d\u901a\u8fc7\u660e\u6587\u63d0\u4f9b \u3002","title":"11-1 \u63a7\u5236\u5e73\u9762"},{"location":"chap9/2Istio_security/#11-2","text":"\u8be5\u4ee3\u7406\u66b4\u9732\u4e86\u5404\u79cd\u7aef\u53e3\u3002\u5bf9\u5916\u66b4\u9732\u7684\u662f 15090 \u7aef\u53e3\uff08\u9065\u6d4b\uff09\u548c 15021 \u7aef\u53e3\uff08\u5065\u5eb7\u68c0\u67e5\uff09\u3002 \u7aef\u53e3 15020 \u548c 15000 \u63d0\u4f9b\u8c03\u8bd5\u7aef\u70b9\u3002\u8fd9\u4e9b\u7aef\u53e3\u53ea\u5728\u672c\u5730\u4e3b\u673a\u4e0a\u66b4\u9732\u3002\u56e0\u6b64\uff0c\u8fd0\u884c\u5728\u4e0e\u4ee3\u7406\u76f8\u540c\u7684 pod \u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u8bbf\u95ee\uff1b\u5728 sidecar \u548c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u6ca1\u6709\u4fe1\u4efb\u8fb9\u754c\u3002","title":"11-2 \u6570\u636e\u5e73\u9762"},{"location":"chap9/2Istio_security/#12","text":"\u4e3a\u4e86\u4e0e Istio \u63a7\u5236\u5e73\u9762\u8fdb\u884c\u8ba4\u8bc1\uff0cIstio \u4ee3\u7406\u5c06\u4f7f\u7528\u670d\u52a1\u8d26\u6237\u4ee4\u724c\u3002Kubernetes \u652f\u6301\u8fd9\u79cd\u4ee4\u724c\u7684\u4e24\u79cd\u5f62\u5f0f\uff1a \u7b2c\u4e09\u65b9\u4ee4\u724c\uff0c\u6709\u4e00\u4e2a\u8303\u56f4\u5185\u7684\u53d7\u4f17\u548c\u5230\u671f\u65f6\u95f4 \u3002 \u7b2c\u4e00\u65b9\u4ee4\u724c\uff0c\u6ca1\u6709\u8fc7\u671f\uff0c\u5e76\u88ab\u5b89\u88c5\u5230\u6240\u6709\u7684 Pod \u4e2d \u3002 \u7531\u4e8e\u7b2c\u4e00\u65b9\u4ee4\u724c\u7684\u5c5e\u6027\u4e0d\u592a\u5b89\u5168\uff0cIstio \u5c06\u9ed8\u8ba4\u4f7f\u7528\u7b2c\u4e09\u65b9\u4ee4\u724c\u3002\u7136\u800c\uff0c\u8fd9\u4e2a\u529f\u80fd\u5e76\u4e0d\u662f\u5728\u6240\u6709\u7684 Kubernetes \u5e73\u53f0\u4e0a\u90fd\u542f\u7528\u7684\u3002 \u5982\u679c\u4f60\u4f7f\u7528 istioctl \u6765\u5b89\u88c5\uff0c\u5c06\u4f1a\u81ea\u52a8\u68c0\u6d4b\u5230\u652f\u6301\u3002\u8fd9\u4e5f\u53ef\u4ee5\u624b\u52a8\u5b8c\u6210\uff0c\u901a\u8fc7\u4f20\u9012 --set values.global.jwtPolicy=third-party-jwt \u6216 --set values.global.jwtPolicy=first-party-jwt \u8fdb\u884c\u914d\u7f6e\u3002 \u8981\u786e\u5b9a\u4f60\u7684\u96c6\u7fa4\u662f\u5426\u652f\u6301\u7b2c\u4e09\u65b9\u4ee4\u724c\uff0c\u5bfb\u627e TokenRequest API \u3002\u5982\u679c\u8fd9\u6ca1\u6709\u8fd4\u56de\u54cd\u5e94\uff0c\u90a3\u4e48\u8be5\u529f\u80fd\u5c31\u4e0d\u88ab\u652f\u6301\u3002 $ kubectl get --raw /api/v1 | jq '.resources[] | select(.name | index(\"serviceaccounts/token\"))' { \"name\": \"serviceaccounts/token\", \"singularName\": \"\", \"namespaced\": true, \"group\": \"authentication.k8s.io\", \"version\": \"v1\", \"kind\": \"TokenRequest\", \"verbs\": [ \"create\" ] }","title":"12 \u914d\u7f6e\u7b2c\u4e09\u65b9\u670d\u52a1\u8d26\u6237\u4ee4\u724c"},{"location":"chap9/2Istio_security/#13","text":"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cIstio\uff08\u548c Envoy\uff09\u5bf9\u4e0b\u6e38\u8fde\u63a5\u7684\u6570\u91cf\u6ca1\u6709\u9650\u5236\u3002\u8fd9\u53ef\u80fd\u88ab\u6076\u610f\u884c\u4e3a\u8005\u5229\u7528\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f60\u5fc5\u987b\u4e3a\u4f60\u7684\u73af\u5883\u914d\u7f6e\u4e00\u4e2a\u9002\u5f53\u7684\u8fde\u63a5\u9650\u5236\u3002 \u901a\u8fc7\u4e0b\u8f7d custom-bootstrap-runtime.yaml \u521b\u5efa\u4e00\u4e2a ConfigMap\u3002\u6839\u636e\u4f60\u7684\u90e8\u7f72\u4e2d\u5404\u4e2a\u7f51\u5173\u5b9e\u4f8b\u6240\u9700\u7684\u5e76\u53d1\u8fde\u63a5\u6570\uff0c\u66f4\u65b0 ConfigMap \u4e2d\u7684 global_downstream_max_connections \u3002\u4e00\u65e6\u8fbe\u5230\u9650\u5236\uff0cEnvoy \u5c06\u5f00\u59cb\u62d2\u7edd tcp \u8fde\u63a5\u3002 $ kubectl -n istio-system apply -f custom-bootstrap-runtime.yaml \u5165\u53e3\u7f51\u5173\u90e8\u7f72\u6253\u8865\u4e01\uff0c\u4ee5\u4f7f\u7528\u4e0a\u8ff0\u914d\u7f6e\u3002\u4e0b\u8f7d gateway-patch.yaml \u5e76\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5e94\u7528\u5b83\u3002 $ kubectl --namespace istio-system patch deployment istio-ingressgateway --patch \"$(cat gateway-patch.yaml)\" \u786e\u8ba4\u65b0\u7684\u9650\u5236\u5df2\u7ecf\u5230\u4f4d\u3002","title":"13 \u914d\u7f6e\u4e0b\u6e38\u8fde\u63a5\u7684\u9650\u5236"},{"location":"chap9/3Istio_service_entry/","text":"\u7b2c\u4e09\u8282 \u8bb0\u4e00\u6b21 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def 1\u3001\u80cc\u666f \u6700\u8fd1\u5728\u5f00\u59cb\u7814\u7a76 istio \u4f7f\u7528\uff0c\u5df2\u7ecf\u5728\u4e00\u4e2a\u672a\u5b89\u88c5 istio \u96c6\u7fa4\u7684\u73af\u5883\u4e2d\u6210\u529f\u641e\u5b9a istio \u5b89\u88c5\u914d\u7f6e\u4e14\u80fd\u6b63\u5e38\u4f7f\u7528\u3002 \u4f46\u662f\u6700\u8fd1\u5728\u4e00\u4e2a\u65b0\u5347\u7ea7\u7684 istio \u7248\u672c(1.11.0)\u7684\u96c6\u7fa4\u4e2d\uff0c\u6240\u6709\u88ab\u6ce8\u5165 istio sidecar \u7684 pod \u5747\u65e0\u6cd5\u5bf9\u5916\u8bbf\u95ee https\u3002 \u5bfc\u81f4\u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u3002\u5177\u4f53\u8868\u73b0\u4e3a IP \u80fd\u901a\uff0c\u4f46\u662f\u65e0\u6cd5 tls \u63e1\u624b\u6210\u529f\u3002 \u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u7684\u521d\u671f\u8868\u73b0\u4e3a\u83b7\u53d6\u914d\u7f6e\u65f6\u63d0\u793a 404\u3002 \u5728\u4e00\u6bb5\u65f6\u95f4\u540e\u7a81\u7136\u8868\u73b0\u4e3a\u65e0\u6cd5\u5efa\u7acb tls \uff0c\u8fd4\u56de 000\u3002 \u6240\u6709\u5bf9\u5916\u7684 https \u670d\u52a1\u5747\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u3002 \u5728\u521d\u671f debug \u540e\uff0c\u8868\u73b0\u66f4\u4e3a\u8be1\u5f02\uff0c\u5728\u4e0d\u540c\u7684 pod \u4e2d\u6709\u4e0d\u540c\u7684\u8868\u73b0\uff1a \u7531\u4e8e\u5df2\u7ecf\u65e0\u6cd5\u83b7\u5f97\u6848\u53d1\u65f6\u7684 shell \u8f93\u51fa\uff0c\u5c31\u4ec5\u6587\u5b57\u53d9\u8ff0\u3002 \u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u7a81\u7136\u62d2\u7edd\u8fde\u63a5\u3002 \u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u8fd4\u56de\u4e0e\u670d\u52a1\u7aef\u672c\u8eab\u4e0d\u7b26\u5408\u7684\u8bc1\u4e66\u3002\u4f8b\u5982\uff1a curl https://baidu.com \u63d0\u793a\u670d\u52a1\u7aef\u8bc1\u4e66\u4e3a *.example.com \u3002 \u5728\u8df3\u8fc7\u8bc1\u4e66\u9a8c\u8bc1\u540e\uff0c\u670d\u52a1\u7aef\u54cd\u5e94\u4e86\u975e\u9884\u671f\u7684\u5185\u5bb9\u3002 2\u3001\u521d\u6b65\u5206\u6790 \u7531\u4e8e\u65e0\u6cd5\u8bbf\u95ee\u5916\u90e8 https \uff0c\u521d\u671f\u731c\u60f3\u53ef\u80fd\u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u8bbf\u95ee\u7b56\u7565\u6216\u8005\u5176\u4ed6\u5b89\u5168\u76f8\u5173\u914d\u7f6e\uff0c\u6216\u8005\u5728 https \u4ee3\u7406\u4e0a\u51fa\u73b0\u4e86\u67d0\u4e9b\u914d\u7f6e\u9519\u8bef\u3002 \u5728\u95ee\u9898\u51fa\u73b0\u540e\u7684\u4e00\u6bb5\u65f6\u95f4\u4e2d\uff0c\u6211\u4eec\u5bf9\u6bd4\u4e86\u6b63\u5e38\u4f7f\u7528 istio \u96c6\u7fa4\u548c\u95ee\u9898\u96c6\u7fa4\u7684 istio \u914d\u7f6e\uff0c\u6240\u6709 crd\u3002\u5747\u672a\u53d1\u73b0\u7279\u6b8a\u914d\u7f6e\u3002 \u4f46\u662f\u989d\u5916\u7684\uff0c\u8be5\u96c6\u7fa4\u6709\u51e0\u4e2a\u6bd4\u8f83\u7279\u6b8a\u7684\u5730\u65b9\uff1a 1\u3001\u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u5bf9\u5916\uff08\u516c\u7f51\u670d\u52a1\uff09\u8bbf\u95ee\u7684 serviceentry\uff0c\u5982\u4e0b \uff1a $ kubectl -n default get serviceentries.networking.istio.io NAME HOSTS LOCATION RESOLUTION AGE external-svc-https-qqapi [baike.baidu.com www.baidu.com www.bing.com apis.baidu.com nlp.xiaoi.com api.map.baidu.com music.baidu.com api.spotify.com api.cognitive.microsoft.com dict.baidu.com baike.baidu.com www.baidu.com sina.com.cn apistore.baidu.com api.heweather.com api.openweathermap.org ...] MESH_EXTERNAL 72m \u90e8\u5206\u9690\u79c1\u57df\u540d\u5df2\u7ecf\u5220\u9664\uff0c\u8fd9\u6761\u914d\u7f6e\u91cc\u9762\u7684\u57df\u540d\u603b\u6570\u591a\u8fbe\u51e0\u5341\u6761\u3002 \u7ecf\u8fc7\u8be2\u95ee\uff0c\u5f97\u5230\u7684\u7b54\u590d\u4e3a\uff1a\u9700\u8981\u5728 serviceentry \u4e2d\u52a0\u4e0a\u8fd9\u4e9b\u57df\u540d\u624d\u80fd\u4f7f mesh \u4e2d\u7684\u670d\u52a1\u6b63\u5e38\u5bf9\u5916\u8bbf\u95ee\u3002 2\u3001\u96c6\u7fa4\u4e2d\u8fd8\u8fd0\u884c\u4e86\u4e00\u4e2a dns-controller ,\u662f\u4e00\u4e2a\u548c istio \u6709\u5173\u7684\u63a7\u5236\u5668\u3002 \u7528\u4e8e\u8de8\u96c6\u7fa4\u7684 dns \u53d1\u73b0\u7b49\u3002\u5728\u8fd9\u91cc\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u5bf9 mesh \u7684\u57df\u540d\u505a\u4e86 CNAME \u7c7b\u4f3c\u7684\u64cd\u4f5c\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5728\u547d\u540d\u7a7a\u95f4 abc \u4e2d\u8fd0\u884c\u7740\u670d\u52a1 service-api , \u9ed8\u8ba4\u8bbf\u95ee\u57df\u540d\u4e3a service-api.abc ,\u5728 istio \u4e2d\u9700\u8981\u5b9e\u73b0\u80fd\u591f\u901a\u8fc7 service-api.hello \u8bbf\u95ee\u3002\u4e8e\u662f\u8be5 controller \u5728\u7a7a\u95f4\u5185\u751f\u6210\u4e86\u670d\u52a1\u5bf9\u5e94\u7684 serviceentry \u7528\u4e8e \u201cCNAME\u201d \u3002 \u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a \u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f \u56e0\u4e3a istio \u9ed8\u8ba4\u4e0d\u9650\u5236 mesh \u5bf9\u516c\u7f51\u7684\u8bbf\u95ee\uff0c\u800c\u4e14\u5728\u6b63\u5e38\u7684\u96c6\u7fa4\u4e2d\u4e5f\u65e0\u9700\u8fd9\u4e2a\u914d\u7f6e\u3002 \u5728\u8fd9\u4e4b\u524d\uff0c\u7531\u4e8e\u9ed8\u8ba4 sidecar \u83b7\u53d6\u5168\u5c40\u7684 mesh \u914d\u7f6e\u5bfc\u81f4 sidecar \u5185\u5b58\u5360\u7528\u8d85 1GB\u3002\u6211\u4eec\u8fd8\u4f7f\u7528\u4e86 sidecar \u5c06\u914d\u7f6e\u9650\u5236\u5728\u5f53\u524d\u4e00\u4e2a\u7a7a\u95f4\u5185\u4ee5\u51cf\u5c11 sidecar \u5360\u7528\u3002 apiVersion: networking.istio.io/v1beta1 kind: Sidecar spec: egress: - hosts: - ./* 3\u3001\u5c1d\u8bd5\u89e3\u51b3 \u5728\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u51e0\u4e2a\u65b9\u5411\uff1a \u6709\u53cd\u9988\u8bf4 serviceentry \u6ca1\u6709\u52a0\u4e0a\u3002\u4e5f\u5c31\u662f\u4e0a\u9762\u8bf4\u7684\u5bf9\u516c\u7f51\u8bbf\u95ee\u7684 serviceentry \u3002\u4e5f\u5c1d\u8bd5\u589e\u52a0\u4e86\u5bf9\u5e94\u57df\u540d\u7684 serviceentry \uff0c\u95ee\u9898\u4f9d\u7136\u5b58\u5728\u3002\u4f46\u8fd9\u6bd4\u4e4b\u524d\u597d\u4e00\u70b9\uff0c\u88ab\u6dfb\u52a0\u7684\u57df\u540d\u80fd\u591f\u6210\u529f\u8bbf\u95ee\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761\u8def\u6709\u6548\uff0c\u4f46\u53c8\u4e0d\u5b8c\u5168\u6709\u6548\u3002\u7b2c\u4e00\u4e2a\u95ee\u9898\u4f9d\u65e7\u6ca1\u6709\u88ab\u89e3\u7b54\u3002 \u65b0\u5f00\u4e86\u4e00\u4e2a\u7a7a\u95f4 istio-demo \u5e76\u90e8\u7f72\u4e86 book-info \u793a\u4f8b\u7a0b\u5e8f\u3002\u5728\u90e8\u7f72\u6210\u529f\u7684\u793a\u4f8b\u7a0b\u5e8f\u4e2d\uff0c\u4e5f\u5b58\u5728\u4e0a\u8ff0\u95ee\u9898\u3002 \u5728\u540e\u6765\u7684 debug \u4e2d\uff0c\u6211\u4eec\u5728 pod \u4e2d\u5c1d\u8bd5\u5efa\u7acb tls \u8fde\u63a5 \uff1a \u9664\u4e86\u76f4\u63a5\u5728\u63e1\u624b\u9636\u6bb5\u5c31\u88ab\u670d\u52a1\u7aef\u5173\u95ed\u8fde\u63a5\u7684\u60c5\u51b5\u5916\uff0c\u8fd8\u9047\u5230\u4e86\uff1a $ curl https://baidu.com SSL: certificate subject name '*.example.com' does not match target host name 'baidu.com' \u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff1a '*.example.com' \u662f\u54ea\u91cc\u6765\u7684\uff1f\u6709\u4e2d\u95f4\u4eba\u5417\uff1f\u4e2d\u95f4\u4eba\u662f\u8c01\uff0c\u8bc1\u4e66\u5728\u54ea\u91cc\u914d\u7f6e\u7684\uff1f 4\u3001\u8f6c\u6298\u70b9 \u56e0\u4e3a\u95ee\u9898\u51fa\u73b0\u4e8e https \u65e0\u6cd5\u5efa\u7acb\u8fde\u63a5\uff0c\u6240\u4ee5\u65b9\u5411\u4e00\u76f4\u88ab\u5f15\u5411\u4e86 tls \u4ee3\u7406\u4e4b\u7c7b\u7684\u95ee\u9898\u3002 \u76f4\u5230\uff1a $ curl -k https://baidu.com 404 page not found \u8fd9\u91cc\u662f\u8bbf\u95ee\u7684\u4f17\u6240\u5468\u77e5\u7684\u57df\u540d\uff0c\u4e3a\u4ec0\u4e48\u8fd4\u56de\u4e86 \"404 page not found\"\uff1f\u8fd9\u4e2a\u54cd\u5e94\u8bf4\u660e\u4e86\u8be5\u54cd\u5e94\u5e94\u8be5\u6765\u81ea\u4e8e\u67d0\u4e2a\u5185\u90e8 golang \u8bed\u8a00\u7f16\u5199\u7684\u670d\u52a1\u3002 \u5728\u8bbf\u95ee\u5176\u4ed6 https \u57df\u540d\u4e5f\u6709\u540c\u6837\u7684\u6548\u679c\uff0c\u4f3c\u4e4e\u6240\u6709 https \u8bbf\u95ee\u90fd\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u5185\u90e8\u7684\u670d\u52a1\u3002 \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u90fd\u662f\u4f7f\u7528\u5230\u7684 istio proxy-status \u547d\u4ee4\u6765\u67e5\u770b sidecar \u914d\u7f6e\u6ce8\u5165\u72b6\u6001\uff0c\u4e5f\u672a\u89c1\u660e\u663e\u5f02\u5e38\u3002 \u65e0\u5948\u4e4b\u4e0b\uff0c\u6211\u5c1d\u8bd5\u4f7f\u7528\u4e86 istioctl proxy-config \u67e5\u770b sidecar \u914d\u7f6e\uff0c\u4e5f\u5c31\u662f envoy \u7684\u914d\u7f6e\u3002 $istioctl proxy-config all sample-c59f744df-8kq7m.istio-demo ... 0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com 0.0.0.0 443 SNI: i.xiaoi.com Cluster: outbound|443||i.xiaoi.com 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name 0.0.0.0 443 SNI: dict.baidu.com Cluster: outbound|443||dict.baidu.com 0.0.0.0 443 SNI: datarobotapi.bdia.com.cn Cluster: outbound|443||datarobotapi.bdia.com.cn ... \u5728\u8fd9\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u4e2d\uff0c\u5728\u4e0a\u5343\u4e2a\u89c4\u5219\u4e2d\u53d1\u73b0\u4e86\u8fd9\u4e48\u4e00\u6761 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name . \u76f4\u89c9\u5c31\u662f\u8fd9\u4e2a\u89c4\u5219\u6709\u95ee\u9898\u3002\u731c\u6d4b\u8fd9\u4e2a\u89c4\u5219\u7684\u5b58\u5728\u5c06\u5176\u5339\u914d\u7684 443 \u7aef\u53e3 ALL \u7684\u6d41\u91cf\u8f6c\u53d1\u81f3\u4e86 traefik.cutom-name ,\u8fd9\u4e2a traefik.cutom-name \u662f \u4e0a\u9762\u8bf4\u5230\u7684 dns-controller \u751f\u6210\u7684\u7528\u4e8e CNAME \u7684 serviceentry \u3002 \u5982\u679c\u80fd\u591f\u8bc1\u660e \"404 page not found\" \u662f\u6765\u81ea traefik \u7684\uff0c\u90a3\u4e48\u5c31\u662f\u8fd9\u91cc\u7684\u95ee\u9898\u4e86\u3002\u4e8e\u662f\uff1a $ curl -k -vvv https://baidu.com ... * Server certificate: * subject: ...=traefik... ... 404 page not found \u5728 curl \u7ed9\u51fa\u7684 debug \u4fe1\u606f\u4e2d\u53d1\u73b0\u4e86\u670d\u52a1\u7aef\u4f7f\u7528\u7684 tls \u8bc1\u4e66\uff0csubject \u4e2d\u5305\u542b\u4e86 traefik \u7b49\u5b57\u6bb5\u3002\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e2a\u8bc1\u4e66\u662f traefik \u81ea\u7b7e\u53d1\u7684\u3002\u5b9e\u9524\u4e86\u8fd9\u4e2a\u540e\u7aef\u670d\u52a1\u5c31\u662f traefik\u3002 \u53ef\u4ee5\u65ad\u5b9a\uff0c\u67d0\u4e2a\u9519\u8bef\u7684\u914d\u7f6e\u5bfc\u81f4\u751f\u6210\u4e86 0.0.0.0:433 -> traefik.cutom-name \u7684\u6620\u5c04\u3002 \u540e\u6765\u5728\u9605\u8bfb\u4e86 envoy \u7684\u6587\u6863LDS\u540e\uff0c\u89e3\u91ca\u4e86\u8fd9\u4e9b\u89c4\u5219\u7684\u7528\u9014\u3002 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name \u8868\u793a\u5339\u914d\u6240\u6709 IP \u5730\u5740 & 443 \u7aef\u53e3 & \u6240\u6709 SNI \u7684\u6d41\u91cf\u5747 mesh \u5230\u76ee\u7684\u670d\u52a1 traefik.cutom-name 5\u3001\u9010\u6e10\u6e05\u6670 \u65e2\u7136\u548c traefik.cutom-name \u6709\u5173\uff0c\u4e5f\u5c31\u662f\u548c\u4e0a\u9762\u8bf4\u5230\u7684 dns-controller \u6709\u5173\uff0c\u548c\u5176\u751f\u6210\u7684 serviceentry \u6709\u5173\u3002\u4ee5\u5176\u4e2d\u4e00\u6761\u4e3e\u4f8b\uff1a apiVersion: networking.istio.io/v1beta1 kind: ServiceEntry metadata: namespace: abc name: traefik-cutom-name spec: hosts: - traefik.cutom-name location: MESH_INTERNAL ports: - name: https-443 number: 443 protocol: TLS resolution: DNS dns-controller \u751f\u6210\u4e86\u4e0a\u8ff0\u7684 serviceentry\u3002\u4e4d\u770b\u8fd8\u672a\u5bdf\u89c9\u5230\u95ee\u9898\uff0c\u4f46\u80af\u5b9a\u6709\u95ee\u9898\u3002 \u5728\u7ffb\u9605 ServiceEntry \u6587\u6863 \u540e\u3002\u6700\u7ec8\u53d1\u73b0\u95ee\u9898\uff1a \u6ca1\u6709\u8bbe\u7f6e spec.addresses \u3002 \u5176\u8bbe\u7f6e\u4e3a MESH_INTERNAL \u4f46\u662f\u6ca1\u6709\u6307\u5b9a\u8be5 service \u7684\u540e\u7aef\u3002\u65e2\u6ca1\u6709\u6307\u5b9a\u5230\u671f\u671b\u670d\u52a1 DNS \u4e5f\u6ca1\u6709\u6307\u5b9a IP\u3002\u90a3\u4e48\u6b64\u65f6\u9ed8\u8ba4\u884c\u4e3a\u662f\uff0c\u5c06 dns traefik.cutom-name \u4f5c\u4e3a\u4e0a\u6e38\uff0c\u901a\u8fc7\u8be5 dns \u53bb\u53d1\u73b0\u670d\u52a1\u7684 endpoint \u3002 \u7531\u4e8e\u66f4\u6539\u4e86 coredns \u7684\u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u6682\u65f6\u6ca1\u6709\u95ee\u9898\u3002 envoy \u6839\u636e\u8fd9\u90e8\u5206\u751f\u6210 cluster \u5e76\u914d\u7f6e\u4f7f\u7528 DNS \u4f5c\u4e3a EDS \u3002 \u4f46\u5728\u6ca1\u6709\u8bbe\u7f6e spec.addresses \u65f6,\u8fd9\u4e2a addresses \u53ef\u4ee5\u586b\u5199 IP \u4e5f\u53ef\u586b\u5199 endpoint \u6240\u5728\u7684 CIDR \u3002envoy \u6839\u636e\u6b64\u90e8\u5206\u751f\u6210\u7684 listene r \u5219\u4f1a\u4f7f\u7528 0.0.0.0 \u4f5c\u4e3a IP \u5730\u5740\u3002\u90a3\u8fd9\u4f1a\u4ea7\u751f\u4ec0\u4e48\u95ee\u9898\u5462\uff1f \u4e3e\u4e2a \ud83c\udf30 \u6817\u5b50\uff1a \u5982\u679c serviceentry A \u672a\u8bbe\u7f6e addresses \u5e76\u914d\u7f6e 443 \u7aef\u53e3\u670d\u52a1\uff0c\u90a3\u4e48\u5728 envoy \u751f\u6210 listener \u4e3a\uff1a 0.0.0.0:443 -> service A \u3002 \u6b64\u65f6\u8bbf\u95ee https://baidu.com \u65f6\u5219\u4f1a\u5339\u914d\u5230\u8be5 listener \uff0c envoy \u5219\u5c06\u6570\u636e\u5305\u53d1\u5f80\u8be5\u670d\u52a1\u3002\u4e5f \u5c31\u4f1a\u6536\u5230 tls \u8bc1\u4e66\u4e0e\u9884\u671f\u4e0d\u4e00\u81f4\u7684\u7ed3\u679c\u3002\u540c\u7406\u6240\u6709\u4f7f\u7528 443 \u7aef\u53e3\u7684\u670d\u52a1\u4e5f\u4f1a\u5982\u6b64\u3002\u5982\u679c\u6709\u591a\u4e2a serviceentry \u90fd\u4f7f\u7528 443 \u7aef\u53e3\uff0c\u5219\u5728\u751f\u6210 listener \u65f6\u4f1a\u968f\u673a\u9009\u62e9\u4e86\u4e00\u4e2a\u670d\u52a1(\u8be5\u903b\u8f91\u7531 listio \u63a7\u5236)\u3002 \u89e3\u51b3\u529e\u6cd5\uff1a \u6307\u5b9a address \u5230 k8s service clusterIP \u6307\u5b9a address \u5230 k8s service CIDR \u7531\u4e8e\u53ef\u4ee5\u76f4\u63a5\u62ff\u5230 service IP \u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u586b\u5199 service IP\u3002 6\u3001\u89e3\u51b3 \u5728\u66f4\u6539\u63a7\u5236\u5668\u903b\u8f91\u540e\uff1a apiVersion: networking.istio.io/v1beta1 kind: ServiceEntry metadata: name: traefik-cutom-name namespace: abc spec: addresses: - <service cluster IP> # \u6307\u5b9a\u4e86 addresses,\u8be6\u60c5\u53c2\u770bistio\u6587\u6863\u3002 endpoints: - address: traefik.abc hosts: - traefik.cutom-name location: MESH_INTERNAL ports: - name: https-443 number: 443 protocol: TLS resolution: DNS \u518d\u6b21\u67e5\u770b config-dump $istioctl proxy-config all sample-55c7969547-z92zk.istio-demo 0.0.0.0 80 ALL PassthroughCluster 0.0.0.0 443 ALL PassthroughCluster 0.0.0.0 443 SNI: traefik.custom-name Cluster: outbound|443||traefik.custom-name \u89c4\u5219\u4e00\u5207\u6b63\u5e38\u3002 PassthroughCluster \u662f\u4e00\u6761\u7279\u6b8a\u89c4\u5219\uff0c\u8868\u793a\u6d41\u91cf\u4e0d\u7ecf\u8fc7\u4fee\u6539\u76f4\u63a5\u51fa istio\u3002 7\u3001\u590d\u76d8 \u597d\u7684\uff0c\u73b0\u5728 debug \u7684\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u51e0\u4e2a\u95ee\u9898\u4e5f\u5f97\u5230\u89e3\u51b3\u3002 \u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f \u5728\u4e4b\u524d\u7684\u4f7f\u7528\u4e2d\uff0c\u7531\u4e8e\u8be5 bug \u7684\u5b58\u5728\uff0c\u4f7f\u5f97\u8bbf\u95ee\u5411\u516c\u7f51\u7684 https \u670d\u52a1\u5747\u88ab\u8f6c\u53d1\u5230\u4e86\u5185\u90e8\u67d0\u4e2a\u670d\u52a1\u3002\u6240\u4ee5\u65e0\u6cd5\u8bbf\u95ee\uff0c \u5728\u8fd9\u6837\u7684\u60c5\u51b5\u4e0b\u589e\u52a0 MESH_EXTERNAL serviceentry \u76f8\u5f53\u4e8e\u5728\u89c4\u5219\u4e2d\u589e\u52a0\u4e86\u7279\u6b8a\u5339\u914d\u7684\u89c4\u5219,\u4f7f\u5f97\u80fd\u591f\u5339\u914d\u6210\u529f\uff0c\u6d41\u91cf\u5f97\u4ee5\u51fa istio\u3002\u4e3e\u4f8b: 0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com \u5728\u8be5 bug \u4fee\u590d\u540e\uff0c\u4e0d\u518d\u9700\u8981\u5bf9\u516c\u7f51\u7684\u670d\u52a1\u505a\u914d\u7f6e\u4e86\u3002 *.example.com' \u662f\u54ea\u91cc\u6765\u7684\uff1f *.example.com \u5b9e\u9645\u662f\u540e\u7aef\u67d0\u4e2a\u670d\u52a1\u4e0a\u4f7f\u7528\u7684\u8bc1\u4e66\uff0c\u7531\u4e8e\u9519\u8bef\u7684\u914d\u7f6e,\u6570\u636e\u5305\u9519\u8bef\u5206\u53d1\u3002\u5b9e\u9645\u6240\u6709\u7684 https \u5747\u8fde\u5230\u4e86\u8fd9\u4e2a\u9519\u8bef\u7684\u540e\u7aef\u3002 \u4e3a\u4ec0\u4e48\u4e0d\u540c\u7684 pod \u4e0b\u8868\u73b0\u4e0d\u4e00\u81f4\uff0c\u6709\u7684\u63e1\u624b\u5931\u8d25\uff0c\u6709\u7684\u63d0\u793a\u8bc1\u4e66\u9519\u8bef\uff1f \u5728 sidecar \u914d\u7f6e\u7684\u8fc7\u7a0b\u4e2d\uff0c 0.0.0.0 443 ALL \u8fd9\u6837\u7684\u89c4\u5219( serviceentry )\u4f1a\u6709\u591a\u4e2a\uff0c\u5728\u751f\u6210\u89c4\u5219\u7684\u65f6\u5019\uff0c\u4f1a\u5e76\u53d1\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u540e\u7aef\u4f5c\u4e3a\u8be5\u5730\u5740\u4e0a\u7684\u670d\u52a1\u3002\u5982\u679c\u8fde\u63a5\u5230\u4e86 mysql \u8fd9\u7c7b\u7684\u670d\u52a1\uff0c\u5219\u65e0\u6cd5\u63e1\u624b\u6210\u529f\u3002 \u4e3a\u4ec0\u4e48\u672a\u6307\u5b9a address \u7684 serviceentry \u4f1a\u88ab\u5339\u914d\u5230 0.0.0.0 \uff1f \u8fd9\u662f istio \u7684\u8003\u8651\uff0c\u5728\u7ffb\u770b\u6e90\u7801 conversion.go#L57 \u540e\u53d1\u73b0 0.0.0.0 \u662f\u5176\u9ed8\u8ba4\u503c\u3002 \u4e3a\u4ec0\u4e48\u5728\u6b64\u6b21\u5347\u7ea7\u540e\u624d\u53d1\u73b0\u95ee\u9898\uff1f * \u56e0\u4e3a sidecar \u914d\u7f6e\u7684\u5b58\u5728\u3002\u5728\u4e4b\u524d\u7684 istio \u4e5f\u5b58\u5728\u8be5\u95ee\u9898\uff0c\u53ea\u662f\u901a\u8fc7\u4e3a\u5916\u90e8 https \u8bbe\u7f6e serviceentry \u5f97\u4ee5\u89c4\u907f\u3002\u800c\u4e14\u8be5\u89c4\u5219\u5b58\u5728 default \u547d\u540d\u7a7a\u95f4\u5185\u3002\u5728\u5347\u7ea7\u540e\uff0c\u6211\u4eec\u5bf9\u7a7a\u95f4\u8bbe\u7f6e\u4e86 sidecar \u3002\u4f7f\u5f97 default \u7a7a\u95f4\u7684 serviceentry \u65e0\u6cd5\u4f20\u64ad\u5230\u5176\u4ed6\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5176\u4ed6\u7a7a\u95f4\u7684 https \u5747\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u540e\u7aef\u670d\u52a1\u3002","title":"\u7b2c\u4e09\u8282 \u8bb0\u4e00\u6b21 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def"},{"location":"chap9/3Istio_service_entry/#istio-serviceentry","text":"","title":"\u7b2c\u4e09\u8282 \u8bb0\u4e00\u6b21 Istio ServiceEntry \u7684\u586b\u5751\u4e4b\u8def"},{"location":"chap9/3Istio_service_entry/#1","text":"\u6700\u8fd1\u5728\u5f00\u59cb\u7814\u7a76 istio \u4f7f\u7528\uff0c\u5df2\u7ecf\u5728\u4e00\u4e2a\u672a\u5b89\u88c5 istio \u96c6\u7fa4\u7684\u73af\u5883\u4e2d\u6210\u529f\u641e\u5b9a istio \u5b89\u88c5\u914d\u7f6e\u4e14\u80fd\u6b63\u5e38\u4f7f\u7528\u3002 \u4f46\u662f\u6700\u8fd1\u5728\u4e00\u4e2a\u65b0\u5347\u7ea7\u7684 istio \u7248\u672c(1.11.0)\u7684\u96c6\u7fa4\u4e2d\uff0c\u6240\u6709\u88ab\u6ce8\u5165 istio sidecar \u7684 pod \u5747\u65e0\u6cd5\u5bf9\u5916\u8bbf\u95ee https\u3002 \u5bfc\u81f4\u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u3002\u5177\u4f53\u8868\u73b0\u4e3a IP \u80fd\u901a\uff0c\u4f46\u662f\u65e0\u6cd5 tls \u63e1\u624b\u6210\u529f\u3002 \u65e0\u6cd5\u4e0b\u53d1\u914d\u7f6e\u7684\u521d\u671f\u8868\u73b0\u4e3a\u83b7\u53d6\u914d\u7f6e\u65f6\u63d0\u793a 404\u3002 \u5728\u4e00\u6bb5\u65f6\u95f4\u540e\u7a81\u7136\u8868\u73b0\u4e3a\u65e0\u6cd5\u5efa\u7acb tls \uff0c\u8fd4\u56de 000\u3002 \u6240\u6709\u5bf9\u5916\u7684 https \u670d\u52a1\u5747\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u3002 \u5728\u521d\u671f debug \u540e\uff0c\u8868\u73b0\u66f4\u4e3a\u8be1\u5f02\uff0c\u5728\u4e0d\u540c\u7684 pod \u4e2d\u6709\u4e0d\u540c\u7684\u8868\u73b0\uff1a \u7531\u4e8e\u5df2\u7ecf\u65e0\u6cd5\u83b7\u5f97\u6848\u53d1\u65f6\u7684 shell \u8f93\u51fa\uff0c\u5c31\u4ec5\u6587\u5b57\u53d9\u8ff0\u3002 \u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u7a81\u7136\u62d2\u7edd\u8fde\u63a5\u3002 \u5728 tls \u63e1\u624b\u9636\u6bb5\uff0c\u670d\u52a1\u7aef\u8fd4\u56de\u4e0e\u670d\u52a1\u7aef\u672c\u8eab\u4e0d\u7b26\u5408\u7684\u8bc1\u4e66\u3002\u4f8b\u5982\uff1a curl https://baidu.com \u63d0\u793a\u670d\u52a1\u7aef\u8bc1\u4e66\u4e3a *.example.com \u3002 \u5728\u8df3\u8fc7\u8bc1\u4e66\u9a8c\u8bc1\u540e\uff0c\u670d\u52a1\u7aef\u54cd\u5e94\u4e86\u975e\u9884\u671f\u7684\u5185\u5bb9\u3002","title":"1\u3001\u80cc\u666f"},{"location":"chap9/3Istio_service_entry/#2","text":"\u7531\u4e8e\u65e0\u6cd5\u8bbf\u95ee\u5916\u90e8 https \uff0c\u521d\u671f\u731c\u60f3\u53ef\u80fd\u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u8bbf\u95ee\u7b56\u7565\u6216\u8005\u5176\u4ed6\u5b89\u5168\u76f8\u5173\u914d\u7f6e\uff0c\u6216\u8005\u5728 https \u4ee3\u7406\u4e0a\u51fa\u73b0\u4e86\u67d0\u4e9b\u914d\u7f6e\u9519\u8bef\u3002 \u5728\u95ee\u9898\u51fa\u73b0\u540e\u7684\u4e00\u6bb5\u65f6\u95f4\u4e2d\uff0c\u6211\u4eec\u5bf9\u6bd4\u4e86\u6b63\u5e38\u4f7f\u7528 istio \u96c6\u7fa4\u548c\u95ee\u9898\u96c6\u7fa4\u7684 istio \u914d\u7f6e\uff0c\u6240\u6709 crd\u3002\u5747\u672a\u53d1\u73b0\u7279\u6b8a\u914d\u7f6e\u3002 \u4f46\u662f\u989d\u5916\u7684\uff0c\u8be5\u96c6\u7fa4\u6709\u51e0\u4e2a\u6bd4\u8f83\u7279\u6b8a\u7684\u5730\u65b9\uff1a 1\u3001\u5728 istio \u4e0a\u8bbe\u7f6e\u4e86\u5bf9\u5916\uff08\u516c\u7f51\u670d\u52a1\uff09\u8bbf\u95ee\u7684 serviceentry\uff0c\u5982\u4e0b \uff1a $ kubectl -n default get serviceentries.networking.istio.io NAME HOSTS LOCATION RESOLUTION AGE external-svc-https-qqapi [baike.baidu.com www.baidu.com www.bing.com apis.baidu.com nlp.xiaoi.com api.map.baidu.com music.baidu.com api.spotify.com api.cognitive.microsoft.com dict.baidu.com baike.baidu.com www.baidu.com sina.com.cn apistore.baidu.com api.heweather.com api.openweathermap.org ...] MESH_EXTERNAL 72m \u90e8\u5206\u9690\u79c1\u57df\u540d\u5df2\u7ecf\u5220\u9664\uff0c\u8fd9\u6761\u914d\u7f6e\u91cc\u9762\u7684\u57df\u540d\u603b\u6570\u591a\u8fbe\u51e0\u5341\u6761\u3002 \u7ecf\u8fc7\u8be2\u95ee\uff0c\u5f97\u5230\u7684\u7b54\u590d\u4e3a\uff1a\u9700\u8981\u5728 serviceentry \u4e2d\u52a0\u4e0a\u8fd9\u4e9b\u57df\u540d\u624d\u80fd\u4f7f mesh \u4e2d\u7684\u670d\u52a1\u6b63\u5e38\u5bf9\u5916\u8bbf\u95ee\u3002 2\u3001\u96c6\u7fa4\u4e2d\u8fd8\u8fd0\u884c\u4e86\u4e00\u4e2a dns-controller ,\u662f\u4e00\u4e2a\u548c istio \u6709\u5173\u7684\u63a7\u5236\u5668\u3002 \u7528\u4e8e\u8de8\u96c6\u7fa4\u7684 dns \u53d1\u73b0\u7b49\u3002\u5728\u8fd9\u91cc\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u5bf9 mesh \u7684\u57df\u540d\u505a\u4e86 CNAME \u7c7b\u4f3c\u7684\u64cd\u4f5c\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5728\u547d\u540d\u7a7a\u95f4 abc \u4e2d\u8fd0\u884c\u7740\u670d\u52a1 service-api , \u9ed8\u8ba4\u8bbf\u95ee\u57df\u540d\u4e3a service-api.abc ,\u5728 istio \u4e2d\u9700\u8981\u5b9e\u73b0\u80fd\u591f\u901a\u8fc7 service-api.hello \u8bbf\u95ee\u3002\u4e8e\u662f\u8be5 controller \u5728\u7a7a\u95f4\u5185\u751f\u6210\u4e86\u670d\u52a1\u5bf9\u5e94\u7684 serviceentry \u7528\u4e8e \u201cCNAME\u201d \u3002 \u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e00\u4e2a\u95ee\u9898\uff1a \u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f \u56e0\u4e3a istio \u9ed8\u8ba4\u4e0d\u9650\u5236 mesh \u5bf9\u516c\u7f51\u7684\u8bbf\u95ee\uff0c\u800c\u4e14\u5728\u6b63\u5e38\u7684\u96c6\u7fa4\u4e2d\u4e5f\u65e0\u9700\u8fd9\u4e2a\u914d\u7f6e\u3002 \u5728\u8fd9\u4e4b\u524d\uff0c\u7531\u4e8e\u9ed8\u8ba4 sidecar \u83b7\u53d6\u5168\u5c40\u7684 mesh \u914d\u7f6e\u5bfc\u81f4 sidecar \u5185\u5b58\u5360\u7528\u8d85 1GB\u3002\u6211\u4eec\u8fd8\u4f7f\u7528\u4e86 sidecar \u5c06\u914d\u7f6e\u9650\u5236\u5728\u5f53\u524d\u4e00\u4e2a\u7a7a\u95f4\u5185\u4ee5\u51cf\u5c11 sidecar \u5360\u7528\u3002 apiVersion: networking.istio.io/v1beta1 kind: Sidecar spec: egress: - hosts: - ./*","title":"2\u3001\u521d\u6b65\u5206\u6790"},{"location":"chap9/3Istio_service_entry/#3","text":"\u5728\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u4e86\u51e0\u4e2a\u65b9\u5411\uff1a \u6709\u53cd\u9988\u8bf4 serviceentry \u6ca1\u6709\u52a0\u4e0a\u3002\u4e5f\u5c31\u662f\u4e0a\u9762\u8bf4\u7684\u5bf9\u516c\u7f51\u8bbf\u95ee\u7684 serviceentry \u3002\u4e5f\u5c1d\u8bd5\u589e\u52a0\u4e86\u5bf9\u5e94\u57df\u540d\u7684 serviceentry \uff0c\u95ee\u9898\u4f9d\u7136\u5b58\u5728\u3002\u4f46\u8fd9\u6bd4\u4e4b\u524d\u597d\u4e00\u70b9\uff0c\u88ab\u6dfb\u52a0\u7684\u57df\u540d\u80fd\u591f\u6210\u529f\u8bbf\u95ee\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6761\u8def\u6709\u6548\uff0c\u4f46\u53c8\u4e0d\u5b8c\u5168\u6709\u6548\u3002\u7b2c\u4e00\u4e2a\u95ee\u9898\u4f9d\u65e7\u6ca1\u6709\u88ab\u89e3\u7b54\u3002 \u65b0\u5f00\u4e86\u4e00\u4e2a\u7a7a\u95f4 istio-demo \u5e76\u90e8\u7f72\u4e86 book-info \u793a\u4f8b\u7a0b\u5e8f\u3002\u5728\u90e8\u7f72\u6210\u529f\u7684\u793a\u4f8b\u7a0b\u5e8f\u4e2d\uff0c\u4e5f\u5b58\u5728\u4e0a\u8ff0\u95ee\u9898\u3002 \u5728\u540e\u6765\u7684 debug \u4e2d\uff0c\u6211\u4eec\u5728 pod \u4e2d\u5c1d\u8bd5\u5efa\u7acb tls \u8fde\u63a5 \uff1a \u9664\u4e86\u76f4\u63a5\u5728\u63e1\u624b\u9636\u6bb5\u5c31\u88ab\u670d\u52a1\u7aef\u5173\u95ed\u8fde\u63a5\u7684\u60c5\u51b5\u5916\uff0c\u8fd8\u9047\u5230\u4e86\uff1a $ curl https://baidu.com SSL: certificate subject name '*.example.com' does not match target host name 'baidu.com' \u5728\u8fd9\u91cc\u51fa\u73b0\u4e86\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff1a '*.example.com' \u662f\u54ea\u91cc\u6765\u7684\uff1f\u6709\u4e2d\u95f4\u4eba\u5417\uff1f\u4e2d\u95f4\u4eba\u662f\u8c01\uff0c\u8bc1\u4e66\u5728\u54ea\u91cc\u914d\u7f6e\u7684\uff1f","title":"3\u3001\u5c1d\u8bd5\u89e3\u51b3"},{"location":"chap9/3Istio_service_entry/#4","text":"\u56e0\u4e3a\u95ee\u9898\u51fa\u73b0\u4e8e https \u65e0\u6cd5\u5efa\u7acb\u8fde\u63a5\uff0c\u6240\u4ee5\u65b9\u5411\u4e00\u76f4\u88ab\u5f15\u5411\u4e86 tls \u4ee3\u7406\u4e4b\u7c7b\u7684\u95ee\u9898\u3002 \u76f4\u5230\uff1a $ curl -k https://baidu.com 404 page not found \u8fd9\u91cc\u662f\u8bbf\u95ee\u7684\u4f17\u6240\u5468\u77e5\u7684\u57df\u540d\uff0c\u4e3a\u4ec0\u4e48\u8fd4\u56de\u4e86 \"404 page not found\"\uff1f\u8fd9\u4e2a\u54cd\u5e94\u8bf4\u660e\u4e86\u8be5\u54cd\u5e94\u5e94\u8be5\u6765\u81ea\u4e8e\u67d0\u4e2a\u5185\u90e8 golang \u8bed\u8a00\u7f16\u5199\u7684\u670d\u52a1\u3002 \u5728\u8bbf\u95ee\u5176\u4ed6 https \u57df\u540d\u4e5f\u6709\u540c\u6837\u7684\u6548\u679c\uff0c\u4f3c\u4e4e\u6240\u6709 https \u8bbf\u95ee\u90fd\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u5185\u90e8\u7684\u670d\u52a1\u3002 \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u90fd\u662f\u4f7f\u7528\u5230\u7684 istio proxy-status \u547d\u4ee4\u6765\u67e5\u770b sidecar \u914d\u7f6e\u6ce8\u5165\u72b6\u6001\uff0c\u4e5f\u672a\u89c1\u660e\u663e\u5f02\u5e38\u3002 \u65e0\u5948\u4e4b\u4e0b\uff0c\u6211\u5c1d\u8bd5\u4f7f\u7528\u4e86 istioctl proxy-config \u67e5\u770b sidecar \u914d\u7f6e\uff0c\u4e5f\u5c31\u662f envoy \u7684\u914d\u7f6e\u3002 $istioctl proxy-config all sample-c59f744df-8kq7m.istio-demo ... 0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com 0.0.0.0 443 SNI: i.xiaoi.com Cluster: outbound|443||i.xiaoi.com 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name 0.0.0.0 443 SNI: dict.baidu.com Cluster: outbound|443||dict.baidu.com 0.0.0.0 443 SNI: datarobotapi.bdia.com.cn Cluster: outbound|443||datarobotapi.bdia.com.cn ... \u5728\u8fd9\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u4e2d\uff0c\u5728\u4e0a\u5343\u4e2a\u89c4\u5219\u4e2d\u53d1\u73b0\u4e86\u8fd9\u4e48\u4e00\u6761 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name . \u76f4\u89c9\u5c31\u662f\u8fd9\u4e2a\u89c4\u5219\u6709\u95ee\u9898\u3002\u731c\u6d4b\u8fd9\u4e2a\u89c4\u5219\u7684\u5b58\u5728\u5c06\u5176\u5339\u914d\u7684 443 \u7aef\u53e3 ALL \u7684\u6d41\u91cf\u8f6c\u53d1\u81f3\u4e86 traefik.cutom-name ,\u8fd9\u4e2a traefik.cutom-name \u662f \u4e0a\u9762\u8bf4\u5230\u7684 dns-controller \u751f\u6210\u7684\u7528\u4e8e CNAME \u7684 serviceentry \u3002 \u5982\u679c\u80fd\u591f\u8bc1\u660e \"404 page not found\" \u662f\u6765\u81ea traefik \u7684\uff0c\u90a3\u4e48\u5c31\u662f\u8fd9\u91cc\u7684\u95ee\u9898\u4e86\u3002\u4e8e\u662f\uff1a $ curl -k -vvv https://baidu.com ... * Server certificate: * subject: ...=traefik... ... 404 page not found \u5728 curl \u7ed9\u51fa\u7684 debug \u4fe1\u606f\u4e2d\u53d1\u73b0\u4e86\u670d\u52a1\u7aef\u4f7f\u7528\u7684 tls \u8bc1\u4e66\uff0csubject \u4e2d\u5305\u542b\u4e86 traefik \u7b49\u5b57\u6bb5\u3002\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e2a\u8bc1\u4e66\u662f traefik \u81ea\u7b7e\u53d1\u7684\u3002\u5b9e\u9524\u4e86\u8fd9\u4e2a\u540e\u7aef\u670d\u52a1\u5c31\u662f traefik\u3002 \u53ef\u4ee5\u65ad\u5b9a\uff0c\u67d0\u4e2a\u9519\u8bef\u7684\u914d\u7f6e\u5bfc\u81f4\u751f\u6210\u4e86 0.0.0.0:433 -> traefik.cutom-name \u7684\u6620\u5c04\u3002 \u540e\u6765\u5728\u9605\u8bfb\u4e86 envoy \u7684\u6587\u6863LDS\u540e\uff0c\u89e3\u91ca\u4e86\u8fd9\u4e9b\u89c4\u5219\u7684\u7528\u9014\u3002 0.0.0.0 443 ALL Cluster: outbound|443||traefik.cutom-name \u8868\u793a\u5339\u914d\u6240\u6709 IP \u5730\u5740 & 443 \u7aef\u53e3 & \u6240\u6709 SNI \u7684\u6d41\u91cf\u5747 mesh \u5230\u76ee\u7684\u670d\u52a1 traefik.cutom-name","title":"4\u3001\u8f6c\u6298\u70b9"},{"location":"chap9/3Istio_service_entry/#5","text":"\u65e2\u7136\u548c traefik.cutom-name \u6709\u5173\uff0c\u4e5f\u5c31\u662f\u548c\u4e0a\u9762\u8bf4\u5230\u7684 dns-controller \u6709\u5173\uff0c\u548c\u5176\u751f\u6210\u7684 serviceentry \u6709\u5173\u3002\u4ee5\u5176\u4e2d\u4e00\u6761\u4e3e\u4f8b\uff1a apiVersion: networking.istio.io/v1beta1 kind: ServiceEntry metadata: namespace: abc name: traefik-cutom-name spec: hosts: - traefik.cutom-name location: MESH_INTERNAL ports: - name: https-443 number: 443 protocol: TLS resolution: DNS dns-controller \u751f\u6210\u4e86\u4e0a\u8ff0\u7684 serviceentry\u3002\u4e4d\u770b\u8fd8\u672a\u5bdf\u89c9\u5230\u95ee\u9898\uff0c\u4f46\u80af\u5b9a\u6709\u95ee\u9898\u3002 \u5728\u7ffb\u9605 ServiceEntry \u6587\u6863 \u540e\u3002\u6700\u7ec8\u53d1\u73b0\u95ee\u9898\uff1a \u6ca1\u6709\u8bbe\u7f6e spec.addresses \u3002 \u5176\u8bbe\u7f6e\u4e3a MESH_INTERNAL \u4f46\u662f\u6ca1\u6709\u6307\u5b9a\u8be5 service \u7684\u540e\u7aef\u3002\u65e2\u6ca1\u6709\u6307\u5b9a\u5230\u671f\u671b\u670d\u52a1 DNS \u4e5f\u6ca1\u6709\u6307\u5b9a IP\u3002\u90a3\u4e48\u6b64\u65f6\u9ed8\u8ba4\u884c\u4e3a\u662f\uff0c\u5c06 dns traefik.cutom-name \u4f5c\u4e3a\u4e0a\u6e38\uff0c\u901a\u8fc7\u8be5 dns \u53bb\u53d1\u73b0\u670d\u52a1\u7684 endpoint \u3002 \u7531\u4e8e\u66f4\u6539\u4e86 coredns \u7684\u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u6682\u65f6\u6ca1\u6709\u95ee\u9898\u3002 envoy \u6839\u636e\u8fd9\u90e8\u5206\u751f\u6210 cluster \u5e76\u914d\u7f6e\u4f7f\u7528 DNS \u4f5c\u4e3a EDS \u3002 \u4f46\u5728\u6ca1\u6709\u8bbe\u7f6e spec.addresses \u65f6,\u8fd9\u4e2a addresses \u53ef\u4ee5\u586b\u5199 IP \u4e5f\u53ef\u586b\u5199 endpoint \u6240\u5728\u7684 CIDR \u3002envoy \u6839\u636e\u6b64\u90e8\u5206\u751f\u6210\u7684 listene r \u5219\u4f1a\u4f7f\u7528 0.0.0.0 \u4f5c\u4e3a IP \u5730\u5740\u3002\u90a3\u8fd9\u4f1a\u4ea7\u751f\u4ec0\u4e48\u95ee\u9898\u5462\uff1f \u4e3e\u4e2a \ud83c\udf30 \u6817\u5b50\uff1a \u5982\u679c serviceentry A \u672a\u8bbe\u7f6e addresses \u5e76\u914d\u7f6e 443 \u7aef\u53e3\u670d\u52a1\uff0c\u90a3\u4e48\u5728 envoy \u751f\u6210 listener \u4e3a\uff1a 0.0.0.0:443 -> service A \u3002 \u6b64\u65f6\u8bbf\u95ee https://baidu.com \u65f6\u5219\u4f1a\u5339\u914d\u5230\u8be5 listener \uff0c envoy \u5219\u5c06\u6570\u636e\u5305\u53d1\u5f80\u8be5\u670d\u52a1\u3002\u4e5f \u5c31\u4f1a\u6536\u5230 tls \u8bc1\u4e66\u4e0e\u9884\u671f\u4e0d\u4e00\u81f4\u7684\u7ed3\u679c\u3002\u540c\u7406\u6240\u6709\u4f7f\u7528 443 \u7aef\u53e3\u7684\u670d\u52a1\u4e5f\u4f1a\u5982\u6b64\u3002\u5982\u679c\u6709\u591a\u4e2a serviceentry \u90fd\u4f7f\u7528 443 \u7aef\u53e3\uff0c\u5219\u5728\u751f\u6210 listener \u65f6\u4f1a\u968f\u673a\u9009\u62e9\u4e86\u4e00\u4e2a\u670d\u52a1(\u8be5\u903b\u8f91\u7531 listio \u63a7\u5236)\u3002 \u89e3\u51b3\u529e\u6cd5\uff1a \u6307\u5b9a address \u5230 k8s service clusterIP \u6307\u5b9a address \u5230 k8s service CIDR \u7531\u4e8e\u53ef\u4ee5\u76f4\u63a5\u62ff\u5230 service IP \u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u586b\u5199 service IP\u3002","title":"5\u3001\u9010\u6e10\u6e05\u6670"},{"location":"chap9/3Istio_service_entry/#6","text":"\u5728\u66f4\u6539\u63a7\u5236\u5668\u903b\u8f91\u540e\uff1a apiVersion: networking.istio.io/v1beta1 kind: ServiceEntry metadata: name: traefik-cutom-name namespace: abc spec: addresses: - <service cluster IP> # \u6307\u5b9a\u4e86 addresses,\u8be6\u60c5\u53c2\u770bistio\u6587\u6863\u3002 endpoints: - address: traefik.abc hosts: - traefik.cutom-name location: MESH_INTERNAL ports: - name: https-443 number: 443 protocol: TLS resolution: DNS \u518d\u6b21\u67e5\u770b config-dump $istioctl proxy-config all sample-55c7969547-z92zk.istio-demo 0.0.0.0 80 ALL PassthroughCluster 0.0.0.0 443 ALL PassthroughCluster 0.0.0.0 443 SNI: traefik.custom-name Cluster: outbound|443||traefik.custom-name \u89c4\u5219\u4e00\u5207\u6b63\u5e38\u3002 PassthroughCluster \u662f\u4e00\u6761\u7279\u6b8a\u89c4\u5219\uff0c\u8868\u793a\u6d41\u91cf\u4e0d\u7ecf\u8fc7\u4fee\u6539\u76f4\u63a5\u51fa istio\u3002","title":"6\u3001\u89e3\u51b3"},{"location":"chap9/3Istio_service_entry/#7","text":"\u597d\u7684\uff0c\u73b0\u5728 debug \u7684\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u51e0\u4e2a\u95ee\u9898\u4e5f\u5f97\u5230\u89e3\u51b3\u3002 \u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u589e\u52a0\u516c\u7f51\u57df\u540d\u7684 serviceentry \u624d\u80fd\u591f\u8bbf\u95ee\u516c\u7f51\u57df\u540d\uff1f \u5728\u4e4b\u524d\u7684\u4f7f\u7528\u4e2d\uff0c\u7531\u4e8e\u8be5 bug \u7684\u5b58\u5728\uff0c\u4f7f\u5f97\u8bbf\u95ee\u5411\u516c\u7f51\u7684 https \u670d\u52a1\u5747\u88ab\u8f6c\u53d1\u5230\u4e86\u5185\u90e8\u67d0\u4e2a\u670d\u52a1\u3002\u6240\u4ee5\u65e0\u6cd5\u8bbf\u95ee\uff0c \u5728\u8fd9\u6837\u7684\u60c5\u51b5\u4e0b\u589e\u52a0 MESH_EXTERNAL serviceentry \u76f8\u5f53\u4e8e\u5728\u89c4\u5219\u4e2d\u589e\u52a0\u4e86\u7279\u6b8a\u5339\u914d\u7684\u89c4\u5219,\u4f7f\u5f97\u80fd\u591f\u5339\u914d\u6210\u529f\uff0c\u6d41\u91cf\u5f97\u4ee5\u51fa istio\u3002\u4e3e\u4f8b: 0.0.0.0 443 SNI: music.baidu.com Cluster: outbound|443||music.baidu.com \u5728\u8be5 bug \u4fee\u590d\u540e\uff0c\u4e0d\u518d\u9700\u8981\u5bf9\u516c\u7f51\u7684\u670d\u52a1\u505a\u914d\u7f6e\u4e86\u3002 *.example.com' \u662f\u54ea\u91cc\u6765\u7684\uff1f *.example.com \u5b9e\u9645\u662f\u540e\u7aef\u67d0\u4e2a\u670d\u52a1\u4e0a\u4f7f\u7528\u7684\u8bc1\u4e66\uff0c\u7531\u4e8e\u9519\u8bef\u7684\u914d\u7f6e,\u6570\u636e\u5305\u9519\u8bef\u5206\u53d1\u3002\u5b9e\u9645\u6240\u6709\u7684 https \u5747\u8fde\u5230\u4e86\u8fd9\u4e2a\u9519\u8bef\u7684\u540e\u7aef\u3002 \u4e3a\u4ec0\u4e48\u4e0d\u540c\u7684 pod \u4e0b\u8868\u73b0\u4e0d\u4e00\u81f4\uff0c\u6709\u7684\u63e1\u624b\u5931\u8d25\uff0c\u6709\u7684\u63d0\u793a\u8bc1\u4e66\u9519\u8bef\uff1f \u5728 sidecar \u914d\u7f6e\u7684\u8fc7\u7a0b\u4e2d\uff0c 0.0.0.0 443 ALL \u8fd9\u6837\u7684\u89c4\u5219( serviceentry )\u4f1a\u6709\u591a\u4e2a\uff0c\u5728\u751f\u6210\u89c4\u5219\u7684\u65f6\u5019\uff0c\u4f1a\u5e76\u53d1\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u540e\u7aef\u4f5c\u4e3a\u8be5\u5730\u5740\u4e0a\u7684\u670d\u52a1\u3002\u5982\u679c\u8fde\u63a5\u5230\u4e86 mysql \u8fd9\u7c7b\u7684\u670d\u52a1\uff0c\u5219\u65e0\u6cd5\u63e1\u624b\u6210\u529f\u3002 \u4e3a\u4ec0\u4e48\u672a\u6307\u5b9a address \u7684 serviceentry \u4f1a\u88ab\u5339\u914d\u5230 0.0.0.0 \uff1f \u8fd9\u662f istio \u7684\u8003\u8651\uff0c\u5728\u7ffb\u770b\u6e90\u7801 conversion.go#L57 \u540e\u53d1\u73b0 0.0.0.0 \u662f\u5176\u9ed8\u8ba4\u503c\u3002 \u4e3a\u4ec0\u4e48\u5728\u6b64\u6b21\u5347\u7ea7\u540e\u624d\u53d1\u73b0\u95ee\u9898\uff1f * \u56e0\u4e3a sidecar \u914d\u7f6e\u7684\u5b58\u5728\u3002\u5728\u4e4b\u524d\u7684 istio \u4e5f\u5b58\u5728\u8be5\u95ee\u9898\uff0c\u53ea\u662f\u901a\u8fc7\u4e3a\u5916\u90e8 https \u8bbe\u7f6e serviceentry \u5f97\u4ee5\u89c4\u907f\u3002\u800c\u4e14\u8be5\u89c4\u5219\u5b58\u5728 default \u547d\u540d\u7a7a\u95f4\u5185\u3002\u5728\u5347\u7ea7\u540e\uff0c\u6211\u4eec\u5bf9\u7a7a\u95f4\u8bbe\u7f6e\u4e86 sidecar \u3002\u4f7f\u5f97 default \u7a7a\u95f4\u7684 serviceentry \u65e0\u6cd5\u4f20\u64ad\u5230\u5176\u4ed6\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5176\u4ed6\u7a7a\u95f4\u7684 https \u5747\u88ab\u8f6c\u5230\u4e86\u67d0\u4e2a\u540e\u7aef\u670d\u52a1\u3002","title":"7\u3001\u590d\u76d8"},{"location":"chap9/4Istio_istio_skill/","text":"\u7b2c\u56db\u8282 \u4f7f\u7528 Istio \u7684\u5341\u4e2a\u6280\u5de7 1\u3001\u4f7f\u7528 Kubectl Sniff \u548c Wireshark \u4e0d\u77e5\u9053\u5927\u5bb6\u6709\u6ca1\u6709\u542c\u8bf4\u8fc7 Wireshark\u3002Sniff \u63d0\u4f9b\u4e86\u4e00\u79cd\u62bd\u8c61\u6982\u5ff5\uff0c\u8ba9\u6211\u4eec\u53ef\u4ee5\u4fa6\u542c\u90a3\u4e9b\u901a\u8fc7 Wireshark \u8fdb\u5165\u79bb\u5f00 Istio \u4ee3\u7406\u7684\u6570\u636e\u5305\u3002 Sniff \u975e\u5e38\u9002\u5408\u4e8e\u5e95\u5c42\u5206\u6790\uff0c\u5b83\u53ef\u4ee5\u5c06\u95ee\u9898\u7684\u6839\u672c\u539f\u56e0\u9694\u79bb\u5230\u5e94\u7528\u7a0b\u5e8f\u7ea7\u548c Envoy \u7ea7\u3002 \u9996\u5148\u901a\u8fc7 global.proxy.privileged=true \u5728 IstioOperator CRD \u4e0a\u542f\u7528\u7279\u6743\u6a21\u5f0f\uff0c\u7136\u540e\u5c06\u4ee5\u4e0b\u6ce8\u91ca\u6dfb\u52a0\u5230 Deployment \u3002 \u5728 Wireshark \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6355\u6349 GRPC \u8bf7\u6c42\u5e76\u8fdb\u884c\u8fc7\u6ee4\uff0c\u7136\u540e\u901a\u8fc7\u8bf7\u6c42\u7684\u751f\u547d\u5468\u671f\u6765\u786e\u5b9a ingress \u548c egress\uff0c\u6700\u540e\u79fb\u690d\u672c\u5730\u670d\u52a1\uff0c\u4f7f\u7528 BloomRPC \u6216 Postman \u9694\u79bb\u8fde\u63a5\u95ee\u9898\u3002 1-1 \u9996\u5148\u4f7f\u7528 Envoy \u901a\u8fc7\u5728 docker-compose \u6587\u4ef6\u4e2d\u8fd0\u884c Envoy \u4e86\u89e3\u5982\u4f55\u914d\u7f6e Envoy \u8fc7\u6ee4\u5668\u94fe\uff08filter chain\uff09\uff0c\u53ef\u4ee5\u66f4\u5bb9\u6613\u5730\u5bf9\u8bf7\u6c42\u955c\u50cf\u548c WASM \u7b49\u66f4\u6539\u8fdb\u884c\u539f\u578b\u6539\u53d8\uff08prototype change\uff09\u3002\u5728\u5c06 Envoy \u8f6c\u6362\u4e3a Istio \u914d\u7f6e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5bf9 Envoy \u8db3\u591f\u4e86\u89e3\u53ef\u4ee5\u63d0\u4f9b\u5f88\u591a\u5e2e\u52a9\u3002 1-2 \u8ba4\u771f\u9605\u8bfb\u53d1\u884c\u8bf4\u660e \u5728\u4e4b\u524d\u7684 Istio \u5347\u7ea7\u8fc7\u7a0b\u4e2d\uff0c\u5f88\u591a\u4eba\u4e0d\u5c0f\u5fc3\u9519\u8fc7\u4e86\u4e00\u4e2a\u66f4\u6539\uff0c\u5373 Envoy \u72b6\u6001\u7aef\u53e3\u4fee\u6539\uff08 15020->15021 \uff09\u3002 2\u3001\u5728 Istio Operator \u4e0a\u4f7f\u7528 Istioctl \u751f\u6210\u58f0\u660e\u6587\u4ef6 \u6700\u8fd1\u6709\u4eba\u4ece v1.6 \u5230 v1.7 \u8fdb\u884c\u4e86\u5347\u7ea7\uff0c \u5e76\u6ce8\u610f\u5230 Operator \u7531\u4e8e\u7ed3\u6784\uff08\u6807\u7b7e->\u5b9e\u7269\u6807\u7b7e\uff1aEnvoyFilter\uff09\u7684\u66f4\u6539\u800c\u65e0\u6cd5\u5b8c\u6210\u8c03\u534f\uff08reconciliation loop\uff09\uff0c\u5e0c\u671b Operator \u80fd\u591f\u4ee5\u5411\u540e\u517c\u5bb9\u7684\u65b9\u5f0f\u5904\u7406\u6b64\u5347\u7ea7 \u3002\u751f\u6210\u7684\u58f0\u660e\u6587\u4ef6\u5f88\u5bb9\u6613\u901a\u8fc7 Istio Overlay API \u6216 Kustomize \u6765\u5904\u7406\u672a\u901a\u8fc7 Operator CRD \u516c\u5f00\u7684\u5b57\u6bb5\u3002 \u627e\u5230\u793a\u4f8b\u58f0\u660e\u6587\u4ef6\u540e\uff0c\u786e\u8ba4\u793a\u4f8b\u4e0e\u4ee3\u7406\u5bb9\u5668\u4e2d\u7684 Envoy API/Protobuf \u7248\u672c\u5bf9\u9f50 \u3002 \u5982\u679c\u5c06 Istio Ingress Gateway \u7528\u4f5c GKE \u4e0a\u96c6\u7fa4\u7684 Ingress\uff0c\u5e76\u8981\u542f\u7528 HTTPS\uff0c\u8bf7\u5728 Istio Ingress Gateway \u670d\u52a1\u7684\u5355\u4e2a\u4e0a\u6e38\u8bbe\u7f6e\u4e00\u4e2a Ingress \u5bf9\u8c61\u3002 \u6dfb\u52a0\u9759\u6001 IP \u8ba1\u7b97\u5730\u5740\uff08Static IP Compute Address\uff09\u3001\u8bc1\u4e66\u7ba1\u7406\uff08Managed Certificate\uff09\u548c BackendConfig\uff08\u8bbe\u7f6e\u8fd0\u884c\u72b6\u51b5\u68c0\u67e5\uff09\uff0c\u53ef\u4ee5\u65b9\u4fbf\u6211\u4eec\u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u5668\u63d0\u4f9b\u5b89\u5168\u8bbf\u95ee\u3002 \u8bf7\u6c42\u955c\u50cf\u662f\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u8fdb\u884c\u6d4b\u8bd5\u7684\u6709\u529b\u624b\u6bb5\u3002 \u5982\u679c\u5728\u5b89\u88c5\u4e2d\u542f\u7528\u4e86\u6b64\u529f\u80fd\uff0c\u4f46\u51fa\u73b0\u4e0b\u6e38\u670d\u52a1\u62d2\u7edd\u8bf7\u6c42\u7684\u60c5\u51b5\uff0c\u6ce8\u610f\u67e5\u770b\u4e3b\u673a\u5934\uff08Host Header\uff09\u3002Envoy \u5c06 \u201c-shadow\u201d \u9644\u52a0\u5230\u4e3b\u673a\u5934\u3002 \u5982\u679c\u4f7f\u7528\u7684\u662f Vanilla Envoy\uff0c\u90a3\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u4fa6\u542c\u5668\u6765\u89e3\u51b3\u8be5\u95ee\u9898\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Istio \u6dfb\u52a0\u4e00\u4e2a\u5355\u72ec\u7684 Envoy \u90e8\u7f72\u6765\u91cd\u5199\u6807\u5934\u3002 \u540c\u6837\uff0c\u5982\u679c\u8981\u4f7f\u7528 istio-ingressgateway \u96c6\u7fa4\u955c\u50cf\u5728\u8fb9\u7f18\u5b9e\u73b0\u8bf7\u6c42\u955c\u50cf\uff0c\u8981\u5728 mesh \u865a\u62df\u670d\u52a1\u4e2d\u6dfb\u52a0\u672c\u5730\u670d\u52a1\u540d\u79f0\u548c\u5173\u952e\u5b57\u3002 JWT \u9a8c\u8bc1\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6709\u8da3\u7684\u62bd\u8c61\u6982\u5ff5\uff0c\u5b83\u5141\u8bb8 service \u77e5\u9053\u5b83\u662f\u5426\u901a\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u3002 \u4e0e\u201c\u9000\u51fa\uff08opt out\uff09\u201d\u57fa\u4e8e\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u6807\u7b7e\u65b9\u6848\u76f8\u6bd4\uff0c\u201c\u52a0\u5165\uff08opt in\uff09\u201d\u53ef\u80fd\u4f1a\u66b4\u9732\u7684\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684 service\u3002 \u4f7f\u7528 Open Policy Agent \u4e4b\u7c7b\u7684\u5de5\u5177\u53ef\u4ee5\u5728\u5de5\u4f5c\u8d1f\u8f7d\u4e0a\u5f3a\u5236\u4f7f\u7528\u5fc5\u9700\u7684\u6807\u7b7e\uff0c\u4ee5\u786e\u4fdd\u6240\u6709 service \u4e0a\u90fd\u5e26\u6709\u8eab\u4efd\u9a8c\u8bc1\u6807\u7b7e\u3002 GRPC JSON \u8f6c\u7801\u5668\u53ef\u4ee5\u5e2e\u52a9\u5de5\u7a0b\u5e08\u5c06\u7a0b\u5e8f\u4ee3\u7801\u4ece JSON \u8f6c\u7801\u4e3a GRPC\u3002 \u4e0d\u8fc7\uff0c\u5c06\u90e8\u7f72\u66f4\u6539\u5230 proto descriptor \u7684\u8fc7\u7a0b\u6709\u4e9b\u7b28\u91cd\u3002\u6709\u79cd\u89e3\u51b3\u65b9\u6cd5\u662f\u7528 base64 \u7f16\u7801 proto descriptor \u5e76\u5c06\u5176\u4f5c\u4e3a secret \u5b89\u88c5\uff0c\u4f46\u7531\u4e8e\u5728 Protobuf \u5b9a\u4e49\u66f4\u6539\u65f6\uff0c\u9700\u8981\u5bf9\u4e8c\u8fdb\u5236\u6587\u4ef6\u8fdb\u884c base64 \u7f16\u7801\uff0c\u8fd9\u975e\u5e38\u9ebb\u70e6\uff0c\u56e0\u6b64\u8fd9\u79cd\u65b9\u6cd5\u4e0d\u592a\u597d\u3002\u6709\u79cd\u7a0d\u5fae\u597d\u4e00\u70b9\u7684\u65b9\u6cd5\u662f\u4f7f\u7528\u63cf\u8ff0\u7b26\uff08descriptor\uff09\u6784\u5efa\u5bb9\u5668\u955c\u50cf\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u5177\u6709\u5171\u4eab\u5185\u5b58\u91cf\u7684 initContainer \u8fd0\u884c\u3002\u5728 pod \u542f\u52a8\u540e\uff0cinitContainer \u4f1a\u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u5230\u5171\u4eab\u5377\u7a7a\u95f4\u4e2d\uff0c\u5e76\u4e14 Istio \u4ee3\u7406\u5bb9\u5668\u53ef\u4ee5\u8fdb\u884c\u8bbf\u95ee\u3002 Envoy \u4e3a\u8fc7\u6ee4\u5668\uff08filter\uff09\u63d0\u4f9b\u4e86\u4e00\u79cd\u4fee\u6539\u865a\u62df\u4e3b\u673a\u7279\u5b9a\u914d\u7f6e\u7684\u65b9\u6cd5\u3002 \u4ece Istio \u6765\u8bf4\uff0c\u8fd9\u610f\u5473\u7740\u53ef\u4ee5\u66f4\u6539\u7279\u5b9a\u865a\u62df\u4e3b\u673a\u8def\u5f84\u4e0a\u73b0\u6709\u8fc7\u6ee4\u5668\u529f\u80fd\u3002\u6b64\u529f\u80fd\u9002\u7528\u4e8e\u7279\u5b9a\u8fc7\u6ee4\u5668\uff0c\u4f46\u4e0d\u9002\u7528\u4e8e WASM \u7b49\u8fc7\u6ee4\u5668\u3002","title":"\u7b2c\u56db\u8282 \u4f7f\u7528 Istio \u7684\u5341\u4e2a\u6280\u5de7"},{"location":"chap9/4Istio_istio_skill/#istio","text":"","title":"\u7b2c\u56db\u8282 \u4f7f\u7528 Istio \u7684\u5341\u4e2a\u6280\u5de7"},{"location":"chap9/4Istio_istio_skill/#1-kubectl-sniff-wireshark","text":"\u4e0d\u77e5\u9053\u5927\u5bb6\u6709\u6ca1\u6709\u542c\u8bf4\u8fc7 Wireshark\u3002Sniff \u63d0\u4f9b\u4e86\u4e00\u79cd\u62bd\u8c61\u6982\u5ff5\uff0c\u8ba9\u6211\u4eec\u53ef\u4ee5\u4fa6\u542c\u90a3\u4e9b\u901a\u8fc7 Wireshark \u8fdb\u5165\u79bb\u5f00 Istio \u4ee3\u7406\u7684\u6570\u636e\u5305\u3002 Sniff \u975e\u5e38\u9002\u5408\u4e8e\u5e95\u5c42\u5206\u6790\uff0c\u5b83\u53ef\u4ee5\u5c06\u95ee\u9898\u7684\u6839\u672c\u539f\u56e0\u9694\u79bb\u5230\u5e94\u7528\u7a0b\u5e8f\u7ea7\u548c Envoy \u7ea7\u3002 \u9996\u5148\u901a\u8fc7 global.proxy.privileged=true \u5728 IstioOperator CRD \u4e0a\u542f\u7528\u7279\u6743\u6a21\u5f0f\uff0c\u7136\u540e\u5c06\u4ee5\u4e0b\u6ce8\u91ca\u6dfb\u52a0\u5230 Deployment \u3002 \u5728 Wireshark \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6355\u6349 GRPC \u8bf7\u6c42\u5e76\u8fdb\u884c\u8fc7\u6ee4\uff0c\u7136\u540e\u901a\u8fc7\u8bf7\u6c42\u7684\u751f\u547d\u5468\u671f\u6765\u786e\u5b9a ingress \u548c egress\uff0c\u6700\u540e\u79fb\u690d\u672c\u5730\u670d\u52a1\uff0c\u4f7f\u7528 BloomRPC \u6216 Postman \u9694\u79bb\u8fde\u63a5\u95ee\u9898\u3002","title":"1\u3001\u4f7f\u7528 Kubectl Sniff \u548c Wireshark"},{"location":"chap9/4Istio_istio_skill/#1-1-envoy","text":"\u901a\u8fc7\u5728 docker-compose \u6587\u4ef6\u4e2d\u8fd0\u884c Envoy \u4e86\u89e3\u5982\u4f55\u914d\u7f6e Envoy \u8fc7\u6ee4\u5668\u94fe\uff08filter chain\uff09\uff0c\u53ef\u4ee5\u66f4\u5bb9\u6613\u5730\u5bf9\u8bf7\u6c42\u955c\u50cf\u548c WASM \u7b49\u66f4\u6539\u8fdb\u884c\u539f\u578b\u6539\u53d8\uff08prototype change\uff09\u3002\u5728\u5c06 Envoy \u8f6c\u6362\u4e3a Istio \u914d\u7f6e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5bf9 Envoy \u8db3\u591f\u4e86\u89e3\u53ef\u4ee5\u63d0\u4f9b\u5f88\u591a\u5e2e\u52a9\u3002","title":"1-1 \u9996\u5148\u4f7f\u7528 Envoy"},{"location":"chap9/4Istio_istio_skill/#1-2","text":"\u5728\u4e4b\u524d\u7684 Istio \u5347\u7ea7\u8fc7\u7a0b\u4e2d\uff0c\u5f88\u591a\u4eba\u4e0d\u5c0f\u5fc3\u9519\u8fc7\u4e86\u4e00\u4e2a\u66f4\u6539\uff0c\u5373 Envoy \u72b6\u6001\u7aef\u53e3\u4fee\u6539\uff08 15020->15021 \uff09\u3002","title":"1-2 \u8ba4\u771f\u9605\u8bfb\u53d1\u884c\u8bf4\u660e"},{"location":"chap9/4Istio_istio_skill/#2-istio-operator-istioctl","text":"\u6700\u8fd1\u6709\u4eba\u4ece v1.6 \u5230 v1.7 \u8fdb\u884c\u4e86\u5347\u7ea7\uff0c \u5e76\u6ce8\u610f\u5230 Operator \u7531\u4e8e\u7ed3\u6784\uff08\u6807\u7b7e->\u5b9e\u7269\u6807\u7b7e\uff1aEnvoyFilter\uff09\u7684\u66f4\u6539\u800c\u65e0\u6cd5\u5b8c\u6210\u8c03\u534f\uff08reconciliation loop\uff09\uff0c\u5e0c\u671b Operator \u80fd\u591f\u4ee5\u5411\u540e\u517c\u5bb9\u7684\u65b9\u5f0f\u5904\u7406\u6b64\u5347\u7ea7 \u3002\u751f\u6210\u7684\u58f0\u660e\u6587\u4ef6\u5f88\u5bb9\u6613\u901a\u8fc7 Istio Overlay API \u6216 Kustomize \u6765\u5904\u7406\u672a\u901a\u8fc7 Operator CRD \u516c\u5f00\u7684\u5b57\u6bb5\u3002 \u627e\u5230\u793a\u4f8b\u58f0\u660e\u6587\u4ef6\u540e\uff0c\u786e\u8ba4\u793a\u4f8b\u4e0e\u4ee3\u7406\u5bb9\u5668\u4e2d\u7684 Envoy API/Protobuf \u7248\u672c\u5bf9\u9f50 \u3002 \u5982\u679c\u5c06 Istio Ingress Gateway \u7528\u4f5c GKE \u4e0a\u96c6\u7fa4\u7684 Ingress\uff0c\u5e76\u8981\u542f\u7528 HTTPS\uff0c\u8bf7\u5728 Istio Ingress Gateway \u670d\u52a1\u7684\u5355\u4e2a\u4e0a\u6e38\u8bbe\u7f6e\u4e00\u4e2a Ingress \u5bf9\u8c61\u3002 \u6dfb\u52a0\u9759\u6001 IP \u8ba1\u7b97\u5730\u5740\uff08Static IP Compute Address\uff09\u3001\u8bc1\u4e66\u7ba1\u7406\uff08Managed Certificate\uff09\u548c BackendConfig\uff08\u8bbe\u7f6e\u8fd0\u884c\u72b6\u51b5\u68c0\u67e5\uff09\uff0c\u53ef\u4ee5\u65b9\u4fbf\u6211\u4eec\u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u5668\u63d0\u4f9b\u5b89\u5168\u8bbf\u95ee\u3002 \u8bf7\u6c42\u955c\u50cf\u662f\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u8fdb\u884c\u6d4b\u8bd5\u7684\u6709\u529b\u624b\u6bb5\u3002 \u5982\u679c\u5728\u5b89\u88c5\u4e2d\u542f\u7528\u4e86\u6b64\u529f\u80fd\uff0c\u4f46\u51fa\u73b0\u4e0b\u6e38\u670d\u52a1\u62d2\u7edd\u8bf7\u6c42\u7684\u60c5\u51b5\uff0c\u6ce8\u610f\u67e5\u770b\u4e3b\u673a\u5934\uff08Host Header\uff09\u3002Envoy \u5c06 \u201c-shadow\u201d \u9644\u52a0\u5230\u4e3b\u673a\u5934\u3002 \u5982\u679c\u4f7f\u7528\u7684\u662f Vanilla Envoy\uff0c\u90a3\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u4fa6\u542c\u5668\u6765\u89e3\u51b3\u8be5\u95ee\u9898\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Istio \u6dfb\u52a0\u4e00\u4e2a\u5355\u72ec\u7684 Envoy \u90e8\u7f72\u6765\u91cd\u5199\u6807\u5934\u3002 \u540c\u6837\uff0c\u5982\u679c\u8981\u4f7f\u7528 istio-ingressgateway \u96c6\u7fa4\u955c\u50cf\u5728\u8fb9\u7f18\u5b9e\u73b0\u8bf7\u6c42\u955c\u50cf\uff0c\u8981\u5728 mesh \u865a\u62df\u670d\u52a1\u4e2d\u6dfb\u52a0\u672c\u5730\u670d\u52a1\u540d\u79f0\u548c\u5173\u952e\u5b57\u3002 JWT \u9a8c\u8bc1\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6709\u8da3\u7684\u62bd\u8c61\u6982\u5ff5\uff0c\u5b83\u5141\u8bb8 service \u77e5\u9053\u5b83\u662f\u5426\u901a\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u3002 \u4e0e\u201c\u9000\u51fa\uff08opt out\uff09\u201d\u57fa\u4e8e\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u6807\u7b7e\u65b9\u6848\u76f8\u6bd4\uff0c\u201c\u52a0\u5165\uff08opt in\uff09\u201d\u53ef\u80fd\u4f1a\u66b4\u9732\u7684\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684 service\u3002 \u4f7f\u7528 Open Policy Agent \u4e4b\u7c7b\u7684\u5de5\u5177\u53ef\u4ee5\u5728\u5de5\u4f5c\u8d1f\u8f7d\u4e0a\u5f3a\u5236\u4f7f\u7528\u5fc5\u9700\u7684\u6807\u7b7e\uff0c\u4ee5\u786e\u4fdd\u6240\u6709 service \u4e0a\u90fd\u5e26\u6709\u8eab\u4efd\u9a8c\u8bc1\u6807\u7b7e\u3002 GRPC JSON \u8f6c\u7801\u5668\u53ef\u4ee5\u5e2e\u52a9\u5de5\u7a0b\u5e08\u5c06\u7a0b\u5e8f\u4ee3\u7801\u4ece JSON \u8f6c\u7801\u4e3a GRPC\u3002 \u4e0d\u8fc7\uff0c\u5c06\u90e8\u7f72\u66f4\u6539\u5230 proto descriptor \u7684\u8fc7\u7a0b\u6709\u4e9b\u7b28\u91cd\u3002\u6709\u79cd\u89e3\u51b3\u65b9\u6cd5\u662f\u7528 base64 \u7f16\u7801 proto descriptor \u5e76\u5c06\u5176\u4f5c\u4e3a secret \u5b89\u88c5\uff0c\u4f46\u7531\u4e8e\u5728 Protobuf \u5b9a\u4e49\u66f4\u6539\u65f6\uff0c\u9700\u8981\u5bf9\u4e8c\u8fdb\u5236\u6587\u4ef6\u8fdb\u884c base64 \u7f16\u7801\uff0c\u8fd9\u975e\u5e38\u9ebb\u70e6\uff0c\u56e0\u6b64\u8fd9\u79cd\u65b9\u6cd5\u4e0d\u592a\u597d\u3002\u6709\u79cd\u7a0d\u5fae\u597d\u4e00\u70b9\u7684\u65b9\u6cd5\u662f\u4f7f\u7528\u63cf\u8ff0\u7b26\uff08descriptor\uff09\u6784\u5efa\u5bb9\u5668\u955c\u50cf\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u5177\u6709\u5171\u4eab\u5185\u5b58\u91cf\u7684 initContainer \u8fd0\u884c\u3002\u5728 pod \u542f\u52a8\u540e\uff0cinitContainer \u4f1a\u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u590d\u5236\u5230\u5171\u4eab\u5377\u7a7a\u95f4\u4e2d\uff0c\u5e76\u4e14 Istio \u4ee3\u7406\u5bb9\u5668\u53ef\u4ee5\u8fdb\u884c\u8bbf\u95ee\u3002 Envoy \u4e3a\u8fc7\u6ee4\u5668\uff08filter\uff09\u63d0\u4f9b\u4e86\u4e00\u79cd\u4fee\u6539\u865a\u62df\u4e3b\u673a\u7279\u5b9a\u914d\u7f6e\u7684\u65b9\u6cd5\u3002 \u4ece Istio \u6765\u8bf4\uff0c\u8fd9\u610f\u5473\u7740\u53ef\u4ee5\u66f4\u6539\u7279\u5b9a\u865a\u62df\u4e3b\u673a\u8def\u5f84\u4e0a\u73b0\u6709\u8fc7\u6ee4\u5668\u529f\u80fd\u3002\u6b64\u529f\u80fd\u9002\u7528\u4e8e\u7279\u5b9a\u8fc7\u6ee4\u5668\uff0c\u4f46\u4e0d\u9002\u7528\u4e8e WASM \u7b49\u8fc7\u6ee4\u5668\u3002","title":"2\u3001\u5728 Istio Operator \u4e0a\u4f7f\u7528 Istioctl \u751f\u6210\u58f0\u660e\u6587\u4ef6"},{"location":"chap9/5istio_interview/","text":"\u7b2c\u4e94\u8282 Istio\u9762\u8bd5 \u4f20\u7edf\u6846\u67b6\u7ec4\u4ef6\u5b58\u5728\u7684\u95ee\u9898 \u5404\u79cd\u57fa\u7840\u7ec4\u4ef6\u7ef4\u62a4\u6210\u672c\u6bd4\u8f83\u9ad8\uff0c\u5355\u70b9\u98ce\u9669\u5b58\u5728\u3002 \u5404\u8bed\u8a00\u5ba2\u6237\u7aef\u7279\u6027\u96be\u4ee5\u7edf\u4e00\uff0c\u7194\u65ad\u3001\u91cd\u8bd5\u7b49\u7279\u6027\u5b9e\u73b0\u9887\u6709\u4e0d\u540c\uff0c\u4e14\u4e0d\u80fd\u505a\u5230\u52a8\u6001\u7ebf\u4e0a\u8fdb\u884c\u8c03\u6574\u3002 \u5ba2\u6237\u7aef\u7248\u672c\u8fed\u4ee3\u96be\u4ee5\u63a8\u52a8\u3002 \u5fae\u670d\u52a1\u67d0\u4e9b\u80fd\u529b\u4e0a\u8ddf\u5176\u4ed6\u5927\u5382\u8fd8\u6709\u5dee\u8ddd\u3002 \u4e0e\u793e\u533a\u3001\u4e91\u539f\u751f\u8ddd\u79bb\u8f83\u8fdc\uff0c\u914d\u5408\u5e38\u89c1\u7684\u5f00\u6e90\u9879\u76ee\u7d27\u5bc6\u5ea6\u8f83\u5dee\u3002 Service Mesh \u53ef\u4ee5\u5f88\u597d\u7684\u89e3\u51b3\u4e0a\u9762\u7684\u8fd9\u4e9b\u95ee\u9898\uff1a \u63d0\u5347\u5fae\u670d\u52a1\u6cbb\u7406\u80fd\u529b\uff0c \u89c4\u8303\u7684\u5f15\u5165\u7cbe\u51c6\u7684\u7194\u65ad\u3001\u9650\u6d41\u3001\u6d41\u91cf\u7ba1\u7406\u7b49\u624b\u6bb5\u3002 \u51cf\u5c11\u5ba2\u6237\u7aef\u7ef4\u62a4\u3001\u8fed\u4ee3\u7684\u6295\u5165 \u3002 \u63d0\u5347\u670d\u52a1\u95f4\u901a\u4fe1\u901f\u5ea6 \u3002 \u5177\u5907\u6545\u969c\u6ce8\u5165\u80fd\u529b \u3002 \u5177\u5907\u52a8\u6001\u670d\u52a1\u8def\u7531\u8c03\u6574\u7684\u80fd\u529b \u3002 \u8fc1\u79fb\u5230Istio\u7684\u57fa\u672c\u8981\u6c42 \u4fdd\u8bc1\u4e1a\u52a1\u65e0\u611f\u77e5\u8fc1\u79fb\uff0c\u4e0d\u53d8\u66f4\u4ee3\u7801 \u4fdd\u8bc1\u53ef\u56de\u6eda \u4fdd\u8bc1\u9ad8\u53ef\u7528 \u4fdd\u8bc1\u6027\u80fd\u65e0\u660e\u663e\u4e0b\u6ed1 \u4fdd\u8bc1 Mesh \u5185\u7684\u670d\u52a1\u548c\u539f\u670d\u52a1\u53ef\u4ee5\u4e92\u76f8\u8bbf\u95ee \u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8 \u670d\u52a1\u7f51\u683c\u5982\u4f55\u5e2e\u52a9\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u903b\u8f91: \u5c06\u903b\u8f91\u5206\u79bb\u5230\u57fa\u7840\u5b9e\u65bd\u5c42 \u4ece\u5b8f\u89c2\u4e0a\u770b\uff0cIstio\u670d\u52a1\u7f51\u683c\u7531\u54ea\u4e24\u90e8\u5206\u7ec4\u6210: \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 \u670d\u52a1\u7f51\u683c\u7684\u4ee3\u7406\u4e5f\u53eb\u505a\u4ec0\u4e48: Sidecar Istio\u4e2d\u7684\u54ea\u4e2a\u7ec4\u4ef6\u53ef\u4ee5\u5c06YAML\u89c4\u5219\u8f6c\u6362\u4e3aEnvoy\u914d\u7f6e: Istiod \u4ece\u4e0b\u9762\u7684\u5217\u8868\u4e2d\u9009\u51fa\u5fae\u670d\u52a1\u67b6\u6784\u7684\u4e24\u4e2a\u597d\u5904\uff1f: \u53ef\u4f38\u7f29\u6027 & \u66f4\u5c0f\u7684\u56e2\u961f \u4e3a\u4ec0\u4e48\u9700\u8981\u670d\u52a1\u7f51\u683c \u4f7f\u7528\u6307\u6807\u8bc6\u522b\uff0c\u6027\u80fd\u548c\u53ef\u9760\u6027\u95ee\u9898 \u5728Grafana\u7b49\u5de5\u5177\u4e2d\u5b9e\u73b0\u6307\u6807\u7684\u53ef\u89c6\u5316\uff1b\u8fd9\u8fdb\u4e00\u6b65\u5141\u8bb8\u6539\u53d8\u5e76\u4e0ePagerDuty\u6574\u5408 \u4f7f\u7528Jaeger\u6216Zipkin\u5bf9\u670d\u52a1\u8fdb\u884c\u8c03\u8bd5\u548c\u8ffd\u8e2a \u57fa\u4e8e\u6743\u91cd\u548c\u8bf7\u6c42\u7684\u6d41\u91cf\u8def\u7531\uff0c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0cA/B\u6d4b\u8bd5 \u6d41\u91cf\u955c\u50cf \u901a\u8fc7\u8d85\u65f6\u548c\u91cd\u8bd5\u63d0\u9ad8\u670d\u52a1\u7684\u5f39\u6027 \u901a\u8fc7\u5728\u670d\u52a1\u4e4b\u95f4\u6ce8\u5165\u6545\u969c\u548c\u5ef6\u8fdf\u6765\u8fdb\u884c\u6df7\u6c8c\u6d4b\u8bd5 \u68c0\u6d4b\u548c\u5f39\u51fa\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u5b9e\u4f8b\u7684\u65ad\u8def\u5668\u3002 Istlo\u7b80\u4ecb Istio\u662f\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\u7684\u5f00\u6e90\u5b9e\u73b0\u3002\u4ece\u5b8f\u89c2\u4e0a\u6765\u770bIstio\u652f\u6301\u4ee5\u4e0b\u529f\u80fd\u3002 \u6d41\u91cf\u7ba1\u7406 \u53ef\u89c2\u5bdf\u6027 \u5b89\u5168\u6027 Istio\u7ec4\u4ef6 \u6570\u636e\u5e73\u9762\uff1a \u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531\u8d1f\u8d23\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u53d1\u73b0\u3001\u5065\u5eb7\u68c0\u67e5\u548c\u6388\u6743/\u8ba4\u8bc1\u7684Envoy\u4ee3\u7406\u3002\u8fd9\u4e9b\u4ee3\u7406\u6bcf\u4e2a\u5b9e\u4f8b\u670d\u52a1\u5b9e\u4f8b\u8981\u8fb9\u8fd0\u884c\uff0c\u62e6\u622a\u6240\u6709\u4f20\u5165\u548c\u4f20\u51fa\u7684\u7528\u6237\u6d41\u91cf Envoy (data plane) High-performance proxy (C++) Injected next to application containers Intercepts all traffic for the service Pluggable extension model based on WebAssembly \u63a7\u5236\u5e73\u9762\uff1a \u670d\u52a1\u7f51\u683c\u4e2d\u7684\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\u914d\u7f6e\u5e76\u63a7\u5236\u6570\u636e\u5e73\u9762\u3002 \u5b83\u7531API\u548c\u5de5\u5177\u7ec4\u6210\u7528\u4e8e\u7ba1\u7406\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002 \u670d\u52a1\u7f51\u683c\u8fd0\u7ef4\u53ef\u4ee5\u8bbf\u95ee\u63a7\u5236\u5e73\u9762\u4ee5\u914d\u7f6e\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002\u4f8b\u5982\uff0c\u5c06\u6d41\u91cf\u914d\u7f6e\u5e94\u7528\u4e8e\u63a7\u5236\u5e73\u9762\u7ffb\u8bd1\u914d\u7f6e\u5e76\u5c06\u5176\u63a8\u9001\u5230\u6570\u636e\u5e73\u9762 Istiod (control plane) Service discovery Configuration Certificate management Converts YAML to Envoy-readable configuration propagates it to all sidecars in the mesh Envoy\uff1a Envoy\u4ee3\u7406\u662f\u4e2a\u73b0\u4ee3\u7684\u3001\u9ad8\u6027\u80fd\u8fb9\u7f18\u7684\u3001\u5c0f\u578b\u7684L7\u4ee3\u7406\u3002Envoy\u662f\u4e3a\u5927\u578b\u73b0\u4ee3\u9762\u5411\u670d\u52a1\u67b6\u6784\u8bbe\u8ba1\u7684\u3002\u5b83\u53ef\u4ee5\u4e0eNginx\u548cHAproxy\u7b49\u8f6f\u4ef6\u8d1f\u622a\u5747\u8857\u5668\u76f8\u5ab2\u7f8e\u3002 \u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7 Istio\u751f\u6210\u4e09\u79cd\u7c7b\u578b\u7684\u9065\u6d4b\u6570\u636e\uff0c\u4e3a\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b\u53ef\u89c2\u5bdf\u6027\uff1a \u6307\u6807\u5ea6\u91cf\uff08Metric) \u5206\u5e03\u5f0f\u8ffd\u8e2a \u8bbf\u95ee\u65e5\u5fd7 \u6307\u6807 Istlo\u57fa\u4e8e\u56db\u4e2a\u9ec4\u91d1\u4fe1\u53f7\u751f\u6210\u6307\u6807\uff1a\u5ef6\u8fdf\u3001\u6d41\u91cf\u3001\u9519\u8bef\u548c\u9971\u548c\u5ea6\u3002 Latency : the time it takes to service a request Traffic : how much demand is placed on the system Errors : rate of failed requests Saturation : how full the most constrained resources of service are Zipkin\uff1a Trace and spans Trace : collection of spans Span : name, start/finish timestamp, tags, context Tags : applied to all spans, used for querying/filtering Spans are sent to the collector to validate, index & store the data Distributed Tracing with Zipkin Zipkin = distributed tracing system Discover latency and performance issues Requirements: propagate HTTP headers (B3 and Envoy request ID) Traces captured at service boundaries Instrument your applications Prometheus\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684\uff1a \u8bb0\u5f55\u6307\u6807\uff0c\u8ddf\u8e2aIstio\u548c\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5 \u4ec0\u4e48\u662fZipkin\uff1a \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf \u4ec0\u4e48\u662fKiali\uff1a Istio\u53ef\u89c2\u6d4b\u6027\u9762\u677f Istio\u4f9d\u9760\u54ea\u4e9b\u5934\u4fe1\u606f\u6765\u8fdb\u884c\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1a B3 header\u548cEnvoy requestID \u4ec0\u4e48\u662fGrafana\uff1a Prometheus\u548c\u5176\u4ed6\u6765\u6e90\u7684\u6570\u636e\u7684\u53ef\u89c6\u5316\u5e73\u53f0 \u6d41\u91cf\u7ba1\u7406 \u4f7f\u7528Gateway \u4f7f\u7528\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u8fdb\u5165\u96c6\u7fa4\u7684\u6d41\u91cf\u5e94\u7528\u8def\u7531\u89c4\u5219\u3002\u6211\u4eec\u53ef\u4ee5\u6709\u4e00\u4e2a\u6307\u5411\u5165\u53e3\u7f51\u5173\u7684\u5355\u4e00\u5916\u90e8IP\u5730\u5740\uff0c\u5e76\u6839\u636e\u4e3b\u673a\u5934\u5c06\u6d41\u91cf\u8def\u7531\u5230\u96c6\u7fa4\u5185\u7684\u4e0d\u540c\u670d\u52a1\u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528Gateway\u8d44\u6e90\u6765\u914d\u7f6e\u7f51\u5173\u3002\u7f51\u5173\u8d44\u6e90\u63cf\u8ff0\u4e86\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u66b4\u9732\u7aef\u53e3\u3001\u534f\u8bae\u3001SNI \uff08\u670d\u52a1\u5668\u540d\u79f0\u6307\u793a\uff09\u914d\u7f6e\u7b49\u3002 kind: Gateway \u7b80\u5355\u8def\u7531 \u4f7f\u7528VirtualService\u8d44\u6e90\u5728Istio\u670d\u52a1\u7f51\u683c\u4e2d\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002 \u76ee\u7684\u5730\u6307\u7684\u662f\u4e0d\u540c\u7684\u5b50\u96c6\uff08subset\uff09\u6216\u670d\u52a1\u7248\u672c\u3002\u901a\u8fc7\u5b50\u96c6\uff0c\u6211\u4eec\u53ef\u4ee5\u8bc6\u522b\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u53d8\u4f53\u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u540d\u4e3aDestinationRule\u7684\u8d44\u6e90\u7c7b\u578b\u4e2d\u58f0\u660e\u5b50\u96c6, Destination Rule\u4e2d\u7684\u6d41\u91cf\u7b56\u7565 \u3002 \u6211\u4eec\u53ef\u4ee5\u5728 trafficPolicy \u5b57\u6bb5\u4e0b\u8bbe\u7f6e\u6d41\u91cf\u7b56\u7565\u8bbe\u7f6e: kind: DestinationRule Load balancer settings Connection pool settings Outlier detection Client TLS settings Port traffic policy Load balancer settings trafficPolicy: loadBalancer: simple: ROUND_ROBIN Connection pool settings trafficPolicy: connectionPool: http: http2MaxRequests: 50 \u5f02\u5e38\u70b9\u68c0\u6d4b \u5982\u679c\u4e00\u4e2a\u4e3b\u673a\u5f00\u59cb\u8fd4\u56de5xx HTTP\u9519\u8bef\uff0c\u5b83\u5c31\u4f1a\u5728\u9884\u5b9a\u7684\u65f6\u95f4\u5185\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\u3002\u5bf9\u4e8eTCP\u670d\u52a1\uff0cEnvoy\u5c06\u8fde\u63a5\u8d85\u65f6\u6216\u5931\u8d25\u8ba1\u7b97\u4e3a\u9519\u8bef\u3002 \u5ba2\u6237\u7aefTLS\u8bbe\u7f6e \u5176\u4ed6\u652f\u6301\u7684TLS\u6a21\u5f0f\u6709DISABLE\uff08\u6ca1\u6709TLS\u8fde\u63a5\uff09, SIMPLE\uff08\u5728\u4e0a\u6e38\u7aef\u70b9\u53d1\u8d77TLS\u8fde\u63a5,\uff09 ISTIO_MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09 trafficPolicy: tls: mode: MUTUAL clientCertificate: /etc/certs/cert.pem privateKey: /etc/certs/key.pem caCertificates: /etc/certs/ca.pem \u7aef\u53e3\u6d41\u91cf\u7b56\u7565 trafficPolicy: portLevelSettings: - port: number: 80 loadBalancer: simple: LEAST_CONN \u5f39\u6027 \u8fd9\u4e0d\u662f\u4e3a\u4e86\u907f\u514d\u6545\u969c\uff0c\u800c\u662f\u4ee5\u4e00\u79cd\u6ca1\u6709\u505c\u673a\u6216\u6570\u636e\u4e22\u5931\u7684\u65b9\u5f0f\u6765\u5e94\u5bf9\u6545\u969c\u3002\u5f39\u6027\u7684\u76ee\u6807 \u662f\u5728\u6545\u969c\u53d1\u751f\u540e\u5c06\u670d\u52a1\u6062\u590d\u5230\u4e00\u4e2a\u5b8c\u5168\u6b63\u5e38\u7684\u72b6\u6001 Timeouts Retry policies Configurable on VirtualService Retries Number of retries Timeout per try Conditions to retry o \u4f7f\u670d\u52a1\u53ef\u7528\u7684\u4e00\u4e2a\u5173\u952e\u56e0\u7d20\u662f\u5728\u63d0\u51fa\u670d\u52a1\u8bf7\u6c42\u65f6\u4f7f\u7528\u8d85\u65f6\uff08timeout\uff09\u548c\u91cd\u8bd5\uff08retry\uff09\u7b56\u7565\u3002 \u6211\u4eec\u53ef\u4ee5\u5728Istio\u7684VirtualService\u4e0a\u914d\u7f6e\u8fd9\u4e24\u8005\u3002 ... - route: - destination: host: customers.default.svc.cluster.local subset: v1 timeout: 10s \u91cd\u8bd5\u7b56\u7565 ... - route: - destination: host: customers.default.svc.cluster.local subset: v1 retries: attempts: 10 perTryTimeout: 2s retryOn: connect-failure,reset ... \u4e0a\u8ff0\u91cd\u8bd5\u7b56\u7565\u5c06\u5c1d\u8bd5\u91cd\u8bd5\u4efb\u4f55\u8fde\u63a5\u8d85\u65f6\uff08connect-failure)\u6216\u670d\u52a1\u5668\u5b8c\u5168\u4e0d\u54cd\u5e94 (reset)\u7684\u5931\u8d25\u8bf7\u6c42\u3002\u6211\u4eec\u5c06\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a2\u79d2\uff0c\u5c1d\u8bd5\u7684\u6b21\u6570\u8bbe\u7f6e\u4e3a10\u6b21\u3002 \u6545\u969c\u6ce8\u5165 \u6709\u4e24\u79cd\u7c7b\u578b\u7684\u6545\u969c\u6ce8\u5165 \u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u8f6c\u53d1\u524d\u5ef6\u8fdf\uff08delay\uff09\u8bf7\u6c42\uff0c\u6a21\u62df\u7f13\u6162\u7684\u7f51\u7edc\u6216\u8fc7\u8f7d\u7684\u670d\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u4e2d\u6b62\uff08abort) HTTP\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u7279\u5b9a\u7684HTTP\u9519\u8bef\u4ee3\u7801\u7ed9\u8c03\u7528\u8005\u3002 \u53ef\u9009\u7684\u5ef6\u8fdf - route: - destination: host: customers.default.svc.cluster.local subset: v1 fault: abort: percentage: value: 30 httpStatus: 404 fault: delay: percentage: value: 5 fixedDelay: 3s \u9ad8\u7ea7\u8def\u7531 Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528\u4f20\u5165\u8bf7\u6c42\u7684\u4e00\u90e8\u5206\uff0c\u5e76\u5c06\u5176\u4e0e\u5b9a\u4e49\u7684\u503c\u76f8\u5339\u914d\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u5339\u914d\u4f20\u5165\u8bf7\u6c42\u7684URI\u524d\u7f00\uff0c\u5e76\u57fa\u4e8e\u6b64\u8def\u7531\u6d41\u91cf\u3002 \u91cd\u5b9a\u5411\u548c\u91cd\u5199\u8bf7\u6c42 ... http: - match: - headers: my-header: exact: hello redirect: uri: /hello authority: my-service.default.svc.cluster.local:8000 ... ServiceEntry \u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002 Add entries to Istio's service registry Use traffic routing, failure injection, and other features against external services kind: ServiceEntry hosts: - api.external-svc.com ports: - number: 443 name: https protocol: TLS resolution: DNS location: MESH_EXTERNAL WorkloadEntry Handle migration of VM workloads to Kubernetes Specify VM workloads and make them part of Istio's service registry \u5728 Workload Entry \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ec6\u8282\uff08\u540d\u79f0\u3001\u5730\u5740\u3001\u6807\u7b7e\uff09\uff0c\u7136\u540e\u4f7f\u7528 ServiceEntry \u4e2d\u7684 workloadSelector \u5b57\u6bb5\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206\u3002 Sidecar Sidecar\u8d44\u6e90\u7531\u4e09\u90e8\u5206\u7ec4\u6210\uff0c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u3001\u4e00\u4e2a\u5165\u53e3\uff08ingress)\u76d1\u542c\u5668\u548c\u4e00\u4e2a\u51fa\u53e3 (egress)\u76d1\u542c\u5668\u3002 Sidecar Resource Proxies accept traffic on all ports Configure Sidecar to specific ports/services Three parts: Workload selector Ingress listener Egress listener \u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u51b3\u5b9a\u4e86\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u4f1a\u53d7\u5230sidecar\u914d\u7f6e\u7684\u5f71\u54cd\u3002 Envoy Filter EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531Istio Pilot\u751f\u6210\u7684Envoy\u914d\u7f6e\u3002\u4f7f\u7528\u8be5\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u66f4\u65b0\u6570\u503c\uff0c\u6dfb\u52a0\u7279\u5b9a\u7684\u8fc7\u6ee4\u5668\uff0c\u751a\u81f3\u6dfb\u52a0\u65b0\u7684\u76d1\u542c\u5668\u3001\u96c6\u7fa4\u7b49\u7b49\u3002\u5c0f\u5fc3\u4f7f\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u56e0\u4e3a\u4e0d\u6b63\u786e\u7684 \u5b9a\u5236\u53ef\u80fd\u4f1a\u7834\u574f\u6574\u4e2a\u7f51\u683c\u7684\u7a33\u5b9a\u6027\u3002 kind: EnvoyFilter \u6d4b\u8bd5 \u6211\u4eec\u53ef\u4ee5\u7528\u4ec0\u4e48\u8d44\u6e90\u914d\u7f6eIstlo ingress gateway? Gateway : istio: ingressgateway \u4f7f\u7528 VirtualService \u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u5c06\u6d41\u91cf\u8def\u7531\u5230Kubernetes\u5185\u90e8\u7684\u4e00\u4e2a\u7279\u5b9a\u670d\u52a1\u3002 Istio ingress \u7f51\u5173\u662f\u4f5c\u4e3a\u54ea\u79cd\u670d\u52a1\u7c7b\u578b\u90e8\u7f72\u7684\uff1f: Loadbalancer \u4f60\u53ef\u4ee5\u5728\u54ea\u4e2a\u8d44\u6e90\u4e2d\u4e3aHTTP\u6d41\u91cf\u6307\u5b9a\u8def\u7531\u89c4\u5219\uff1f: VirtuaLService \u5982\u4f55\u5b9a\u4e49\u591a\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u4ee5\u4fbf\u80fd\u591f\u5728\u5b83\u4eec\u4e4b\u95f4\u8fdb\u884c\u6d41\u91cf\u8def\u7531\uff1f \u4f7f\u7528Destination Rule\u548csubset \u5f53\u4f7f\u7528\u79bb\u7fa4\u68c0\u6d4b\u65f6\uff0c\u4e3b\u673a\u4f55\u65f6\u4f1a\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\uff1f \u5f53\u8fd4\u56deHTTP 5xx\u9519\u8bef\u65f6 \u5728\u79bb\u7fa4\u68c0\u6d4b\u914d\u7f6e\u4e2d\uff0c\u95f4\u9694\u8bbe\u7f6e\u6307\u7684\u662f\u4ec0\u4e48 \u626b\u63cf\u4e0a\u6e38\u4e3b\u673a\u65f6\u95f4\u7684\u95f4\u9694 \u80fd\u5c06\u6d41\u91cf\u7b56\u7565\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u7aef\u53e3\u5417\uff1f: \u80fd trafficPolicy: portLevelSettings: port ISTIO_MUTUAL \u548c MUTUAL TLS \u6a21\u5f0f\u4e4b\u95f4\u6709\u4ec0\u4e48\u533a\u522b\uff1f ISTIO_MUTUAL \u5728mTLS\u4e2d\u4f7f\u7528Istio\u7684\u8bc1\u4e66\uff0c\u800c\u5728MUTUAL TLS\u4e2d\u4f60\u53ef\u4ee5\u7528\u4f60\u81ea\u5df1\u7684\u8bc1\u4e66 ISTIO_MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09 \u6211\u4eec\u53ef\u4ee5\u53ea\u5728\u4e0a\u6e38\u670d\u52a1\u5668\u8fd4\u56de5xx\u54cd\u5e94\u4ee3\u7801\u65f6\u91cd\u8bd5\u8bf7\u6c42\uff0c\u6216\u8005\u53ea\u5728\u7f51\u5173\u9519\u8bef\uff08HTTP 5O2\u3001 503\u6216504\uff09\u65f6\u91cd\u8bd5\uff0c\u6216\u8005\u751a\u81f3\u5728\u8bf7\u6c42\u5934\u4e2d\u6307\u5b9a\u53ef\u91cd\u8bd5\u7684\u72b6\u6001\u4ee3\u7801\u3002 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48: \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 \u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\u3002\u5f53Envoy\u91cd\u8bd5\u4e00\u4e2a\u5931\u8d25\u7684\u8bf7\u6c42\u65f6\uff0c\u6700\u521d\u5931\u8d25\u5e76\u5bfc\u81f4\u91cd\u8bd5\u7684\u7aef\u70b9\u5c31\u4e0d\u518d\u5305\u542b\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u4e86\u3002\u5047\u8bbeKubernetes\u670d\u52a1\u67093\u4e2a\u7aef\u70b9\uff08Pod)\uff0c\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u4e86\uff0c \u5e76\u51fa\u73b0\u4e86\u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u4ee3\u7801 \u4f60\u80fd\u4e3a\u540c\u4e00\u4e2a\u8bf7\u6c42\u540c\u65f6\u6ce8\u5165\u5ef6\u8fdf\u548c\u4e2d\u6b62\u5417. \u662f \u8003\u8651\u5230\u4e0b\u9762\u7684\u7247\u6bb5\uff0c\u6709\u591a\u5c11\u767e\u5206\u6bd4\u7684\u8bf7\u6c42\u4f1a\u88ab\u4e2d\u6b62\uff1f \u5982\u679c\u6211\u4eec\u4e0d\u6307\u5b9a\u767e\u5206\u6bd4\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u4e2d\u6b62 \u6545\u969c\u6ce8\u5165\u662f\u5426\u89e6\u53d1\u91cd\u8bd5\u7b56\u7565\uff1f \u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u5c06\u4e0d\u4f1a\u89e6\u53d1\u6211\u4eec\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u6ce8\u5165\u4e86\u4e00\u4e2aHTTP 500\u7684\u9519\u8bef\uff0c\u914d\u7f6e\u4e3aHTTP 500\u4e0a\u7684\u91cd\u8bd5\u7b56\u7565\u5c06\u4e0d\u4f1a\u88ab\u89e6\u53d1 \u3002 \u4f60\u53ef\u4ee5\u4f7f\u7528VirtualService\u4e2d\u7684\u54ea\u4e2a\u5b57\u6bb5\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230Kubernetes\u4e2d\u4e00\u4e2a\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\uff1f redirect \u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u4f7f\u5916\u90e8\u670d\u52a1\u6210\u4e3a\u4f60\u7684\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206 ServiceEntry \u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206 Envoy sidecar\u68c0\u67e5ServiceEntry\u8d44\u6e90\u4e2d\u7684hosts\u5b57\u6bb5\u7684\u987a\u5e8f\u662f\u4ec0\u4e48. HTTP\u3001 SNI\u3001 IP\u5730\u5740\u3001\u7aef\u53e3 ServiceEntry\u8d44\u6e90\u4e2d\u7684workloadSelector\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f \u8981\u9009\u62e9WorkloadEntry\u8d44\u6e90\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 \u5982\u4f55\u914d\u7f6esidecar\u4ee3\u7406\uff0c\u4f7f\u5176\u53ea\u5bf9\u67d0\u4e9b\u670d\u52a1\u4f7f\u7528\u7279\u5b9a\u7684\u7aef\u53e3 \u4f7f\u7528Sidecar\u8d44\u6e90 Sidecar\u8d44\u6e90\u4e2d\u7684Ingress\u548cegress\u76d1\u542c\u5668\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48 \u5b9a\u4e49\u54ea\u4e9b\u5165\u7ad9\uff0f\u51fa\u7ad9\u6d41\u91cf\u88absidecar\u63a5\u53d7 Workload selector Ingress listener Egress listener EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531Istio Pilot\u751f\u6210\u7684Envoy\u914d\u7f6e \u5f53\u6709\u591a\u4e2aEnvoyFilter\u90e8\u7f72\u65f6\uff0c\u54ea\u4e9b\u8fc7\u6ee4\u5668\u4f1a\u5148\u88ab\u5e94\u7528 \u6839\uff08\u5982istio-system)\u547d\u540d\u7a7a\u95f4\u7684\u8fc7\u6ee4\u5668 \u6839\u547d\u540d\u7a7a\u95f4\uff08\u4f8b\u5982istio-system)\u4e2d\u7684\u8fc7\u6ee4\u5668\u9996\u5148\u88ab\u5e94\u7528\uff0c\u7136\u540e\u662f\u5de5\u4f5c\u8d1f\u8f7d\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u5339\u914d\u8fc7\u6ee4\u5668\u3002 \u5982\u4f55\u5c06VirtualService\u4e0eGateway\u7ed1\u5b9a \u4f7f\u7528gateways\u5b57\u6bb5 ... kind: VirtualService ... spec: hosts: - \"*\" gateways: - gateway Destination Rule\u914d\u7f6e\u6d41\u91cf\u7b56\u7565 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48 \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 \u4f60\u53ef\u4ee5\u7528Workload Entry\u8d44\u6e90\u505a\u4ec0\u4e48\uff1f \u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5411Kubernetes\u7684\u8fc1\u79fb Istio Secuirty \u8ba4\u8bc1(Authentication) Authentication Principal = Kubernetes service Action = HTTP request methods (e.g. GET, POST, DELETE, ...) Object = Kubernetes service All about the principal (service identity) \"Validating a credential and ensuring it's both valid and trusted\" Identity Unique identity in Kubernetes = Kubernetes service account X.509 certificate (from SA) + SPIFFE spec = Identity Naming scheme (spiffe://cluster.localinsidefault/sa/my-sa) Encoding names into X.509 Validating the X.509 to authenticate the SPIFFE identity \u8bc1\u4e66\u521b\u5efa\u548c\u8f6e\u6362 \u5bf9\u4e8e\u7f51\u683c\u4e2d\u7684\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\uff0cIstio\u63d0\u4f9b\u4e00\u4e2a X.509 \u8bc1\u4e66\u3002 \u4e00\u4e2a\u540d\u4e3a pilot-agent \u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c \uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08istiod\uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c\u3002 Certificate creation Istio Agent Envoy's Secret Discovery Service(SDS) Citadel(part of the control plane) Istio Agent\u4e0eEnvoy sidecar\u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c \u3002\u5373\u4fbfIstio\u4ee3\u7406\u5728\u6bcf\u4e2apod\u4e2d\u8fd0\u884c\u6211\u4eec\u4e5f\u8ba4\u4e3a\u5b83\u662f\u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\u3002 \u79d8\u94a5\u53d1\u73b0\u670d\u52a1(SDS)\u7b80\u5316\u4e86\u8bc1\u4e66\u7ba1\u7406\u3002\u5982\u679c\u6ca1\u6709SDS\u8bc1\u4e66\u5fc5\u987b\u4f5c\u4e3a\u79d8\u5bc6(Secret) \u521b\u5efa\uff0c\u7136\u540e\u88c5\u5165\u4ee3\u7406\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002 \u6bcf\u5f53\u8bc1\u4e66\u8fc7\u671f\u65f6SDS\u4f1a\u63a8\u9001\u66f4\u65b0\u7684\u8bc1\u4e66Envoy\u53ef\u4ee5\u7acb\u5373\u4fbf\u7528\u5b83\u4eec\u3002\u4e0d\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u670d\u52a1\u5668\u4e5f\u4e0d\u9700\u8981\u4e2d\u65ad\u6d41\u91cf\u3002 Peer and Request Authentication(\u5bf9\u7b49\u8ba4\u8bc1\u548c\u8bf7\u6c42\u8ba4\u8bc1) Peer authentication Peer authentication service-to-service All mTLS about the communication between services Request authentication end user authentication uses JWTs \u53cc\u5411TLS Mutual TLS(mTLS) Traffic is re-routed through proxies Envoy starts an mTLS handshake Secure naming check is done Once mTLS connection is established: Request is forwarded to server-side proxy Server-side forwards traffic to the workload mTLS Behavior DISABLE : no TLS connection SIMPLE : originate to the upstream MUTUAL : uses mTLS and certs for auth ISTIO_MUTUAL : like MUTUAL; but uses Istlo's certs for mTLS Permissive mode Allows services to accpet both plaintext and mTLS Improves mTLS onboarding experience Gradually Install/configure sidecars for mTLS \u6388\u6743 Authorization Can user A send a GET request to /hello on service B? Authn without authz (and vice-versa) is useless Control authenticated principals with AuthorizationPolicy Authorization policy Make use of identities extracted from PeerAuthentication and RequestAuthentication : requestPrincipals (users) principals (service/peer) Defined at mesh, namespace, and workload level Authorization policy Workloads policy applies to Action to take (deny, allow, or audit) Rules when to take action Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528 AuthorizationPolicy \u8d44\u6e90\u5728\u7f51\u683c\u3001\u547d\u540d\u7a7a\u95f4\u548c\u5de5\u4f5c\u8d1f\u8f7d\u5c42\u9762\u5b9a\u4e49\u8bbf\u95ee\u63a7\u5236\u3002 AuthorizationPolicy \u652f\u6301DENY\u3001ALLOW\u3001 AUDIT\u548cCUSTOM\u64cd\u4f5c \u3002 kind: AuthorizationPolicy \u5b89\u5168\u6d4b\u8bd5 \u5728\u901a\u4fe1\u65f6\uff0cEnvoy\u4ee3\u7406\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u51ed\u8bc1: X509\u8bc1\u4e66 Validating the X.509 to authenticate the SPIFFE identity \u54ea\u4e2a\u7ec4\u4ef6\u4e3a\u4e00\u4e2a\u670d\u52a1\u8d26\u6237\u521b\u5efaSPIFFE\u8eab\u4efd\uff1f Citadel \u6bcf\u6b21\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u8d26\u6237\u65f6, Citadel\u90fd\u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2aSPIFFE\u8eab\u4efd \u3002 \u4f60\u4f1a\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u542f\u7528\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4e25\u683cmTLS\u6a21\u5f0f\uff1f PeerAuthentication AuthorizationPolicy\u8d44\u6e90\u4e2d\u4f7f\u7528\u54ea\u4e24\u4e2a\u52a8\u4f5c\uff1f DENY\u548cALLOW \u6bcf\u4e2aEnvoy\u4ee3\u7406\u5b9e\u4f8b\u90fd\u8fd0\u884c\u4e00\u4e2a\u6388\u6743\u5f15\u64ce\uff0c\u5728\u8fd0\u884c\u65f6\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6388\u6743\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe\u4ee3\u7406\u65f6\uff0c\u5f15\u64ce\u4f1a\u6839\u636e\u6388\u6743\u7b56\u7565\u8bc4\u4f30\u8bf7\u6c42\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u8fd4\u56deALLOW\u6216DENY \u5f53\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\uff08SDS)\u66f4\u65b0\u8bc1\u4e66\u65f6\uff0c\u662f\u5426\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u4ee5\u4f7f\u7528\u65b0\u8bc1\u4e66\u3002 \u5426 AUDIT\u52a8\u4f5c\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f \u8bb0\u5f55\u8bf7\u6c42 AUDIT\u52a8\u4f5c\u51b3\u5b9a\u662f\u5426\u8bb0\u5f55\u7b26\u5408\u89c4\u5219\u7684\u8bf7\u6c42\u3002\u6ce8\u610fAUDIT\u7b56\u7565\u5e76\u4e0d\u5f71\u54cd\u8bf7\u6c42\u88ab\u5141\u8bb8\u6216\u62d2\u7edd\u3002 \u4ec0\u4e48\u662f\u5141\u8bb8\u6a21\u5f0f\uff08permissive mode)? \u4e00\u4e2a\u5141\u8bb8\u670d\u52a1\u540c\u65f6\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u6700\u548cmTLS\u6d41\u91cf\u7684\u9009\u9879 \u662f\u5426\u53ef\u4ee5\u5728Istio\u4e2d\u4f7f\u7528JSON Web Tokens (JWTs)? \u662f \u9009\u62e9\u4e09\u4e2a\u8d1f\u8d35\u5728\u8fd0\u884c\u65f6\u521b\u5efa\u8eab\u4efd\u7684\u7ec4\u4ef6 Citedel \u3001 lstio Agent \u3001Envoys Secret Discovery Service Istlo Agent\u7684\u5de5\u4f5c\u662f\u4ec0\u4e48\uff1f \u4e0eEnvoy sidecar\u5408\u4f5c\uff0c\u901a\u8fc7\u4e13\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\uff0c\u5e2e\u52a9\u4ed6\u4eec\u94fe\u63a5\u5230Service mesh Istio Agent\u4e0eEnvoy sidecar\u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c Istlo\u63d0\u4f9b\u54ea\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1f \u5bf9\u7b49\u548c\u8bf7\u6c42\u8ba4\u8bc1 Istlo\u4ee3\u7406\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u5b58\u50a8\u5728\u54ea\u91cc\uff1f \u5185\u5b58 \u5c06\u5bc6\u94a5\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u6bd4\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u66f4\u5b89\u5168\uff1b \u5728\u4f7f\u7528SDS\u65f6\uff0c\u7edd\u4e0d\u4f1a\u5c06\u4efb\u4f55\u5bc6\u94a5\u5199\u5165\u78c1\u76d8\u3002Istio\u4ee3\u7406\u8fd8\u5b9a\u671f\u5237\u65b0\u51ed\u8bc1\uff0c \u5728\u5f53\u524d\u51ed\u8bc1\u8fc7\u670b\u524d\u4eceCitadel\u68c0\u7d22\u4efb\u4f55\u65b0\u7684SVID(SPIFFE\u53ef\u9a8c\u8bc1\u8eab\u4efd\u6587\u4ef6\uff09 \u54ea\u79cd\u4ee3\u7406\u4e0eistiod\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u5b9e\u73b0\u94a5\u5319\u548c\u8bc1\u4e66\u8f6e\u6362\u7684\u81ea\u52a8\u5316 pilot-agent \u4e00\u4e2a\u540d\u4e3a pilot-agent \u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08istiod\uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c\u3002 \u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u54ea\u4e9b\u5185\u5bb9\uff1f \u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04 \u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c\u54ea\u4e9b\u7b56\u7565\u4f1a\u5148\u88ab\u8bc4\u4f30\uff1f Deny \u7b56\u7565 \u4f60\u5982\u4f55\u5728Istio\u4e2d\u542f\u7528\u6388\u6743\u529f\u80fd\uff1f \u4e0d\u9700\u8981\u660e\u786e\u5730\u542f\u7528\u8be5\u529f\u80fd \u6ca1\u6709\u5fc5\u8981\u660e\u786e\u5730\u542f\u7528\u6388\u6743\u529f\u80fd\u3002 \u4e3a\u4e86\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u6765\u5e94\u7528\u4e8e\u6211\u4eec\u7684\u5de5\u4f5c\u8d1f\u8f7d AuthorizationPolicy \u8d44\u6e90\u662f\u6211\u4eec\u53ef\u4ee5\u5229\u7528 PeerAuthentication \u7b56\u7565\u548c RequestAuthentication \u7b56\u7565\u4e2d\u7684\u4e3b\u4f53\u7684\u5730\u65b9 \u3002 Istio\u5982\u4f55\u9a8c\u8bc1\u7528\u6237\uff0f\u8fdb\u7a0b\u7684\u8eab\u4efd \u901a\u8fc7\u4ece\u8bf7\u6c42\u4e2d\u63d0\u53d6\u51ed\u8bc1 \u4f60\u5982\u4f55\u5728\u6574\u4e2a\u7f51\u683c\u4e2d\u5f3a\u5236\u6267\u884c\u4e25\u683c\u7684mTLS\u6a21\u5f0f \u901a\u8fc7\u5c06PeerAuthentication\u8d44\u6e90\u90e8\u7f72\u5230\u6839\u547d\u540d\u7a7a\u95f4(Istlo system\uff09\u4e2d \u6211\u4eec\u53ef\u4ee5\u521b\u5efaPeerAuthentication\u8d44\u6e90\uff0c\u9996\u5148\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5206\u522b\u6267\u884c\u4e25\u683c\u6a21\u5f0f\u3002\u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u547d\u540d\u7a7a\u95f4\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662fistio-system)\u521b\u5efa\u4e00\u4e2a\u7b56\u7565\uff0c\u5728\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u4e2d\u6267\u884c\u8be5\u7b56\u7565\uff1a \u5bf9\u7b49\u8ba4\u8bc1\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684: \u670d\u52a1\u95f4\u8ba4\u8bc1 \u679cKubernetes\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709Envoy\u4ee3\u7406\uff0cIstio\u662f\u5426\u4f1a\u53d1\u9001mTLS\u6d41\u91cf \u5426 Authorization Policy\u8d44\u6e90\u4e2d\u7684selector\u548cmatchLabel\u5b57 \u6bb5\u6709\u4ec0\u4e48\u7528\u9014 \u8981\u9009\u62e9\u7b56\u7565\u9002\u7528\u7684\u5de5\u4f5c\u8d1f\u8f7d \u9ad8\u7ea7\u529f\u80fd\u6d4b\u8bd5 Istio\u5728\u7f51\u683c\u4e2d\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u79df\u6237\u5355\u4f4d: Namespace \u4f60\u4f7f\u7528\u54ea\u4e9b\u8d44\u6e90\u5c06\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c\uff1f WorkloadGroup \u548c WorkloadEntry \u5de5\u4f5c\u8d1f\u8f7d\u7ec4(WorkloadGroup\u8d44\u6e90\uff09\u7c7b\u4f3c\u4e8eKubernetes \u4e2d\u7684\u90e8\u7f72(Deployments)\u5b83\u4ee3\u8868\u4e86\u5171\u4eab\u5171\u540c\u5c5e\u6027\u7684\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u903b\u8f91\u7ec4 \u63cf\u8ff0\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee(WorkloadEntry\u8d44\u6e90\uff09\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee\u7c7b\u4f3c\u4e8ePod\u5b83\u4ee3\u8868\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5355\u4e00\u5b9e\u4f8b \u4f60\u662f\u5426\u53ef\u4ee5\u901a\u8fc7\u5c06\u6240\u6709\u96c6\u7fa4\u4f5c\u4e3a\u8fdc\u7a0b\u96c6\u7fa4\u6765\u5b9e\u73b0\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u7684\u5b8c\u5168\u5206\u79bb\uff1f \u662f \u53e6\u4e00\u79cd\u90e8\u7f72\u6a21\u5f0f\u662f\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684\u96c6\u7fa4\u90fd\u89c6\u4e3a\u7531\u5916\u90e8\u63a7\u5236\u5e73\u9762\u63a7\u5236\u7684\u8fdc\u7a0b\u96c6\u7fa4\u3002\u8fd9\u4f7f\u6211\u4eec\u5728\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u6709\u4e86\u5b8c\u5168\u7684\u5206\u79bb\u3002 Istio\u662f\u5982\u4f55\u89e3\u51b3\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u914d\u7f6e\u9694\u79bb\u7684: \u4e0d\u53ef\u884c \u79df\u6237\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u662f\u9694\u79bb\u4e0d\u540c\u79df\u6237\u7684\u914d\u7f6e\u3002\u76ee\u524d\uff0cIstio\u5e76\u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u8fc7\uff0c\u5b83\u901a\u8fc7\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u7684\u8303\u56f4\u914d\u7f6e\u6765\u5c1d\u8bd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 \u591a\u96c6\u7fa4\u90e8\u7f72\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f \u4e3a\u4e86\u83b7\u5f97\u66f4\u5927\u7a0b\u5ea6\u7684\u9694\u79bb\u548c\u53ef\u7528\u6027 \uff0e \u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\u662f\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762\u3002\u5bf9\u4e8e\u6b63\u5e38\u7684\u670d\u52a1\u7f51\u683c\u90e8\u7f72\u89c4\u6a21\u5efa\u8bae\u4f60\u4f7f\u7528\u591a\u7f51\u683c\u90e8\u7f72\uff0c\u5e76\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u7cfb\u7edf\u5728\u5916\u90e8\u534f\u8c03\u7f51\u683c\u3002 \u4ec0\u4e48\u662f\u79df\u6237\uff1f \u79df\u6237\u662f\u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650\u7684\u7528\u6237\u3002\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u901a\u8fc7\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565\u5b8c\u6210\u7684 \u3002 What does the shared control plane model involve? \u591a\u4e2a\u96c6\u7fa4\u63a7\u5236\u5e73\u9762\u53ea\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff08\u4e3b\u96c6\u7fa4\uff09 \u4ec0\u4e48\u88ab\u8ba4\u4e3a\u662f\u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\uff1f \u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762 \u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1f \u4f7f\u7528\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565 \u5de5\u4f5c\u8d1f\u8f7d\u5e94\u8be5\u5982\u4f55\u5728\u96c6\u7fa4\u4e4b\u95f4\u8fdb\u884c\u901a\u4fe1\uff1f \u901a\u8fc7ingress gateway Istio \u95ee\u9898\u6392\u67e5 istioctl proxy-config \u5217\u51fa\u76d1\u542c\u5668 \u914d\u7f6e istioctl validate -f myresource.yaml \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u53e6\u4e00\u4e2a\u547d\u4ee4 istioctl analyze istioctl proxy-status istioctl dashboard controlz \u5982\u679c\u865a\u62df\u76d1\u542c\u5668\u627e\u4e0d\u5230\u8bf7\u6c42\u7684\u76ee\u7684\u5730\u4f1a\u600e\u6837 \u6839\u636eOutboundTrafficPolicy\u53d1\u9001\u6d41\u91cf \u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e2aIstio CLI\u547d\u4ee4\u6765\u5217\u51fa\u6240\u6709\u76d1\u542c\u5668 istiocti proxy-config listeners \u76d1\u542c\u5668\u4f7f\u7528\u54ea\u4e2a\u670d\u52a1\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e RDS(route discovery service) Envoy\u7684\u57fa\u672c\u6982\u5ff5\u662f\u4ec0\u4e48\uff1f listener\u3001route\u3001cluster\u548cendpoint \u6bcf\u4e2asidecar\u90fd\u6709\u591a\u4e2a\u76d1\u542c\u5668\u751f\u6210\u3002\u6bcf\u4e2asidecar\u90fd\u6709\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u5b83\u88ab\u7ed1\u5b9a\u5230 0.0.0.0:15006 Where are the circuit breakers defined In clusters configuration \u4ec0\u4e48\u7c7b\u578b\u7684\u6d41\u91cf\u4f1a\u88ab\u8def\u7531\u523015006\u7aef\u53e3 \u5165\u7ad9Pod\u6d41\u91cf","title":"\u7b2c\u4e94\u8282 Istio\u9762\u8bd5"},{"location":"chap9/5istio_interview/#istio","text":"","title":"\u7b2c\u4e94\u8282 Istio\u9762\u8bd5"},{"location":"chap9/5istio_interview/#_1","text":"\u5404\u79cd\u57fa\u7840\u7ec4\u4ef6\u7ef4\u62a4\u6210\u672c\u6bd4\u8f83\u9ad8\uff0c\u5355\u70b9\u98ce\u9669\u5b58\u5728\u3002 \u5404\u8bed\u8a00\u5ba2\u6237\u7aef\u7279\u6027\u96be\u4ee5\u7edf\u4e00\uff0c\u7194\u65ad\u3001\u91cd\u8bd5\u7b49\u7279\u6027\u5b9e\u73b0\u9887\u6709\u4e0d\u540c\uff0c\u4e14\u4e0d\u80fd\u505a\u5230\u52a8\u6001\u7ebf\u4e0a\u8fdb\u884c\u8c03\u6574\u3002 \u5ba2\u6237\u7aef\u7248\u672c\u8fed\u4ee3\u96be\u4ee5\u63a8\u52a8\u3002 \u5fae\u670d\u52a1\u67d0\u4e9b\u80fd\u529b\u4e0a\u8ddf\u5176\u4ed6\u5927\u5382\u8fd8\u6709\u5dee\u8ddd\u3002 \u4e0e\u793e\u533a\u3001\u4e91\u539f\u751f\u8ddd\u79bb\u8f83\u8fdc\uff0c\u914d\u5408\u5e38\u89c1\u7684\u5f00\u6e90\u9879\u76ee\u7d27\u5bc6\u5ea6\u8f83\u5dee\u3002","title":"\u4f20\u7edf\u6846\u67b6\u7ec4\u4ef6\u5b58\u5728\u7684\u95ee\u9898"},{"location":"chap9/5istio_interview/#service-mesh","text":"\u63d0\u5347\u5fae\u670d\u52a1\u6cbb\u7406\u80fd\u529b\uff0c \u89c4\u8303\u7684\u5f15\u5165\u7cbe\u51c6\u7684\u7194\u65ad\u3001\u9650\u6d41\u3001\u6d41\u91cf\u7ba1\u7406\u7b49\u624b\u6bb5\u3002 \u51cf\u5c11\u5ba2\u6237\u7aef\u7ef4\u62a4\u3001\u8fed\u4ee3\u7684\u6295\u5165 \u3002 \u63d0\u5347\u670d\u52a1\u95f4\u901a\u4fe1\u901f\u5ea6 \u3002 \u5177\u5907\u6545\u969c\u6ce8\u5165\u80fd\u529b \u3002 \u5177\u5907\u52a8\u6001\u670d\u52a1\u8def\u7531\u8c03\u6574\u7684\u80fd\u529b \u3002","title":"Service Mesh \u53ef\u4ee5\u5f88\u597d\u7684\u89e3\u51b3\u4e0a\u9762\u7684\u8fd9\u4e9b\u95ee\u9898\uff1a"},{"location":"chap9/5istio_interview/#istio_1","text":"\u4fdd\u8bc1\u4e1a\u52a1\u65e0\u611f\u77e5\u8fc1\u79fb\uff0c\u4e0d\u53d8\u66f4\u4ee3\u7801 \u4fdd\u8bc1\u53ef\u56de\u6eda \u4fdd\u8bc1\u9ad8\u53ef\u7528 \u4fdd\u8bc1\u6027\u80fd\u65e0\u660e\u663e\u4e0b\u6ed1 \u4fdd\u8bc1 Mesh \u5185\u7684\u670d\u52a1\u548c\u539f\u670d\u52a1\u53ef\u4ee5\u4e92\u76f8\u8bbf\u95ee","title":"\u8fc1\u79fb\u5230Istio\u7684\u57fa\u672c\u8981\u6c42"},{"location":"chap9/5istio_interview/#istio_2","text":"\u670d\u52a1\u7f51\u683c\u5982\u4f55\u5e2e\u52a9\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u903b\u8f91: \u5c06\u903b\u8f91\u5206\u79bb\u5230\u57fa\u7840\u5b9e\u65bd\u5c42 \u4ece\u5b8f\u89c2\u4e0a\u770b\uff0cIstio\u670d\u52a1\u7f51\u683c\u7531\u54ea\u4e24\u90e8\u5206\u7ec4\u6210: \u6570\u636e\u5e73\u9762\u548c\u63a7\u5236\u5e73\u9762 \u670d\u52a1\u7f51\u683c\u7684\u4ee3\u7406\u4e5f\u53eb\u505a\u4ec0\u4e48: Sidecar Istio\u4e2d\u7684\u54ea\u4e2a\u7ec4\u4ef6\u53ef\u4ee5\u5c06YAML\u89c4\u5219\u8f6c\u6362\u4e3aEnvoy\u914d\u7f6e: Istiod \u4ece\u4e0b\u9762\u7684\u5217\u8868\u4e2d\u9009\u51fa\u5fae\u670d\u52a1\u67b6\u6784\u7684\u4e24\u4e2a\u597d\u5904\uff1f: \u53ef\u4f38\u7f29\u6027 & \u66f4\u5c0f\u7684\u56e2\u961f","title":"\u670d\u52a1\u7f51\u683c\u548c Istio \u6982\u89c8"},{"location":"chap9/5istio_interview/#_2","text":"\u4f7f\u7528\u6307\u6807\u8bc6\u522b\uff0c\u6027\u80fd\u548c\u53ef\u9760\u6027\u95ee\u9898 \u5728Grafana\u7b49\u5de5\u5177\u4e2d\u5b9e\u73b0\u6307\u6807\u7684\u53ef\u89c6\u5316\uff1b\u8fd9\u8fdb\u4e00\u6b65\u5141\u8bb8\u6539\u53d8\u5e76\u4e0ePagerDuty\u6574\u5408 \u4f7f\u7528Jaeger\u6216Zipkin\u5bf9\u670d\u52a1\u8fdb\u884c\u8c03\u8bd5\u548c\u8ffd\u8e2a \u57fa\u4e8e\u6743\u91cd\u548c\u8bf7\u6c42\u7684\u6d41\u91cf\u8def\u7531\uff0c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0cA/B\u6d4b\u8bd5 \u6d41\u91cf\u955c\u50cf \u901a\u8fc7\u8d85\u65f6\u548c\u91cd\u8bd5\u63d0\u9ad8\u670d\u52a1\u7684\u5f39\u6027 \u901a\u8fc7\u5728\u670d\u52a1\u4e4b\u95f4\u6ce8\u5165\u6545\u969c\u548c\u5ef6\u8fdf\u6765\u8fdb\u884c\u6df7\u6c8c\u6d4b\u8bd5 \u68c0\u6d4b\u548c\u5f39\u51fa\u4e0d\u5065\u5eb7\u7684\u670d\u52a1\u5b9e\u4f8b\u7684\u65ad\u8def\u5668\u3002","title":"\u4e3a\u4ec0\u4e48\u9700\u8981\u670d\u52a1\u7f51\u683c"},{"location":"chap9/5istio_interview/#istlo","text":"Istio\u662f\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\u7684\u5f00\u6e90\u5b9e\u73b0\u3002\u4ece\u5b8f\u89c2\u4e0a\u6765\u770bIstio\u652f\u6301\u4ee5\u4e0b\u529f\u80fd\u3002 \u6d41\u91cf\u7ba1\u7406 \u53ef\u89c2\u5bdf\u6027 \u5b89\u5168\u6027","title":"Istlo\u7b80\u4ecb"},{"location":"chap9/5istio_interview/#istio_3","text":"\u6570\u636e\u5e73\u9762\uff1a \u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u7531\u8d1f\u8d23\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u670d\u52a1\u53d1\u73b0\u3001\u5065\u5eb7\u68c0\u67e5\u548c\u6388\u6743/\u8ba4\u8bc1\u7684Envoy\u4ee3\u7406\u3002\u8fd9\u4e9b\u4ee3\u7406\u6bcf\u4e2a\u5b9e\u4f8b\u670d\u52a1\u5b9e\u4f8b\u8981\u8fb9\u8fd0\u884c\uff0c\u62e6\u622a\u6240\u6709\u4f20\u5165\u548c\u4f20\u51fa\u7684\u7528\u6237\u6d41\u91cf Envoy (data plane) High-performance proxy (C++) Injected next to application containers Intercepts all traffic for the service Pluggable extension model based on WebAssembly \u63a7\u5236\u5e73\u9762\uff1a \u670d\u52a1\u7f51\u683c\u4e2d\u7684\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\u914d\u7f6e\u5e76\u63a7\u5236\u6570\u636e\u5e73\u9762\u3002 \u5b83\u7531API\u548c\u5de5\u5177\u7ec4\u6210\u7528\u4e8e\u7ba1\u7406\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002 \u670d\u52a1\u7f51\u683c\u8fd0\u7ef4\u53ef\u4ee5\u8bbf\u95ee\u63a7\u5236\u5e73\u9762\u4ee5\u914d\u7f6e\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u6570\u636e\u5e73\u9762\u884c\u4e3a\u3002\u4f8b\u5982\uff0c\u5c06\u6d41\u91cf\u914d\u7f6e\u5e94\u7528\u4e8e\u63a7\u5236\u5e73\u9762\u7ffb\u8bd1\u914d\u7f6e\u5e76\u5c06\u5176\u63a8\u9001\u5230\u6570\u636e\u5e73\u9762 Istiod (control plane) Service discovery Configuration Certificate management Converts YAML to Envoy-readable configuration propagates it to all sidecars in the mesh Envoy\uff1a Envoy\u4ee3\u7406\u662f\u4e2a\u73b0\u4ee3\u7684\u3001\u9ad8\u6027\u80fd\u8fb9\u7f18\u7684\u3001\u5c0f\u578b\u7684L7\u4ee3\u7406\u3002Envoy\u662f\u4e3a\u5927\u578b\u73b0\u4ee3\u9762\u5411\u670d\u52a1\u67b6\u6784\u8bbe\u8ba1\u7684\u3002\u5b83\u53ef\u4ee5\u4e0eNginx\u548cHAproxy\u7b49\u8f6f\u4ef6\u8d1f\u622a\u5747\u8857\u5668\u76f8\u5ab2\u7f8e\u3002","title":"Istio\u7ec4\u4ef6"},{"location":"chap9/5istio_interview/#_3","text":"Istio\u751f\u6210\u4e09\u79cd\u7c7b\u578b\u7684\u9065\u6d4b\u6570\u636e\uff0c\u4e3a\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b\u53ef\u89c2\u5bdf\u6027\uff1a \u6307\u6807\u5ea6\u91cf\uff08Metric) \u5206\u5e03\u5f0f\u8ffd\u8e2a \u8bbf\u95ee\u65e5\u5fd7 \u6307\u6807 Istlo\u57fa\u4e8e\u56db\u4e2a\u9ec4\u91d1\u4fe1\u53f7\u751f\u6210\u6307\u6807\uff1a\u5ef6\u8fdf\u3001\u6d41\u91cf\u3001\u9519\u8bef\u548c\u9971\u548c\u5ea6\u3002 Latency : the time it takes to service a request Traffic : how much demand is placed on the system Errors : rate of failed requests Saturation : how full the most constrained resources of service are Zipkin\uff1a Trace and spans Trace : collection of spans Span : name, start/finish timestamp, tags, context Tags : applied to all spans, used for querying/filtering Spans are sent to the collector to validate, index & store the data Distributed Tracing with Zipkin Zipkin = distributed tracing system Discover latency and performance issues Requirements: propagate HTTP headers (B3 and Envoy request ID) Traces captured at service boundaries Instrument your applications Prometheus\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684\uff1a \u8bb0\u5f55\u6307\u6807\uff0c\u8ddf\u8e2aIstio\u548c\u7f51\u683c\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5065\u5eb7\u72b6\u51b5 \u4ec0\u4e48\u662fZipkin\uff1a \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf \u4ec0\u4e48\u662fKiali\uff1a Istio\u53ef\u89c2\u6d4b\u6027\u9762\u677f Istio\u4f9d\u9760\u54ea\u4e9b\u5934\u4fe1\u606f\u6765\u8fdb\u884c\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1a B3 header\u548cEnvoy requestID \u4ec0\u4e48\u662fGrafana\uff1a Prometheus\u548c\u5176\u4ed6\u6765\u6e90\u7684\u6570\u636e\u7684\u53ef\u89c6\u5316\u5e73\u53f0","title":"\u53ef\u89c2\u5bdf\u6027\uff1a\u9065\u6d4b\u548c\u65e5\u5fd7"},{"location":"chap9/5istio_interview/#_4","text":"","title":"\u6d41\u91cf\u7ba1\u7406"},{"location":"chap9/5istio_interview/#gateway","text":"\u4f7f\u7528\u5165\u53e3\u7f51\u5173\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u8fdb\u5165\u96c6\u7fa4\u7684\u6d41\u91cf\u5e94\u7528\u8def\u7531\u89c4\u5219\u3002\u6211\u4eec\u53ef\u4ee5\u6709\u4e00\u4e2a\u6307\u5411\u5165\u53e3\u7f51\u5173\u7684\u5355\u4e00\u5916\u90e8IP\u5730\u5740\uff0c\u5e76\u6839\u636e\u4e3b\u673a\u5934\u5c06\u6d41\u91cf\u8def\u7531\u5230\u96c6\u7fa4\u5185\u7684\u4e0d\u540c\u670d\u52a1\u3002 \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528Gateway\u8d44\u6e90\u6765\u914d\u7f6e\u7f51\u5173\u3002\u7f51\u5173\u8d44\u6e90\u63cf\u8ff0\u4e86\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u66b4\u9732\u7aef\u53e3\u3001\u534f\u8bae\u3001SNI \uff08\u670d\u52a1\u5668\u540d\u79f0\u6307\u793a\uff09\u914d\u7f6e\u7b49\u3002 kind: Gateway","title":"\u4f7f\u7528Gateway"},{"location":"chap9/5istio_interview/#_5","text":"\u4f7f\u7528VirtualService\u8d44\u6e90\u5728Istio\u670d\u52a1\u7f51\u683c\u4e2d\u8fdb\u884c\u6d41\u91cf\u8def\u7531\u3002 \u76ee\u7684\u5730\u6307\u7684\u662f\u4e0d\u540c\u7684\u5b50\u96c6\uff08subset\uff09\u6216\u670d\u52a1\u7248\u672c\u3002\u901a\u8fc7\u5b50\u96c6\uff0c\u6211\u4eec\u53ef\u4ee5\u8bc6\u522b\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u53d8\u4f53\u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u540d\u4e3aDestinationRule\u7684\u8d44\u6e90\u7c7b\u578b\u4e2d\u58f0\u660e\u5b50\u96c6, Destination Rule\u4e2d\u7684\u6d41\u91cf\u7b56\u7565 \u3002 \u6211\u4eec\u53ef\u4ee5\u5728 trafficPolicy \u5b57\u6bb5\u4e0b\u8bbe\u7f6e\u6d41\u91cf\u7b56\u7565\u8bbe\u7f6e: kind: DestinationRule Load balancer settings Connection pool settings Outlier detection Client TLS settings Port traffic policy Load balancer settings trafficPolicy: loadBalancer: simple: ROUND_ROBIN Connection pool settings trafficPolicy: connectionPool: http: http2MaxRequests: 50 \u5f02\u5e38\u70b9\u68c0\u6d4b \u5982\u679c\u4e00\u4e2a\u4e3b\u673a\u5f00\u59cb\u8fd4\u56de5xx HTTP\u9519\u8bef\uff0c\u5b83\u5c31\u4f1a\u5728\u9884\u5b9a\u7684\u65f6\u95f4\u5185\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\u3002\u5bf9\u4e8eTCP\u670d\u52a1\uff0cEnvoy\u5c06\u8fde\u63a5\u8d85\u65f6\u6216\u5931\u8d25\u8ba1\u7b97\u4e3a\u9519\u8bef\u3002 \u5ba2\u6237\u7aefTLS\u8bbe\u7f6e \u5176\u4ed6\u652f\u6301\u7684TLS\u6a21\u5f0f\u6709DISABLE\uff08\u6ca1\u6709TLS\u8fde\u63a5\uff09, SIMPLE\uff08\u5728\u4e0a\u6e38\u7aef\u70b9\u53d1\u8d77TLS\u8fde\u63a5,\uff09 ISTIO_MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09 trafficPolicy: tls: mode: MUTUAL clientCertificate: /etc/certs/cert.pem privateKey: /etc/certs/key.pem caCertificates: /etc/certs/ca.pem \u7aef\u53e3\u6d41\u91cf\u7b56\u7565 trafficPolicy: portLevelSettings: - port: number: 80 loadBalancer: simple: LEAST_CONN \u5f39\u6027 \u8fd9\u4e0d\u662f\u4e3a\u4e86\u907f\u514d\u6545\u969c\uff0c\u800c\u662f\u4ee5\u4e00\u79cd\u6ca1\u6709\u505c\u673a\u6216\u6570\u636e\u4e22\u5931\u7684\u65b9\u5f0f\u6765\u5e94\u5bf9\u6545\u969c\u3002\u5f39\u6027\u7684\u76ee\u6807 \u662f\u5728\u6545\u969c\u53d1\u751f\u540e\u5c06\u670d\u52a1\u6062\u590d\u5230\u4e00\u4e2a\u5b8c\u5168\u6b63\u5e38\u7684\u72b6\u6001 Timeouts Retry policies Configurable on VirtualService Retries Number of retries Timeout per try Conditions to retry o \u4f7f\u670d\u52a1\u53ef\u7528\u7684\u4e00\u4e2a\u5173\u952e\u56e0\u7d20\u662f\u5728\u63d0\u51fa\u670d\u52a1\u8bf7\u6c42\u65f6\u4f7f\u7528\u8d85\u65f6\uff08timeout\uff09\u548c\u91cd\u8bd5\uff08retry\uff09\u7b56\u7565\u3002 \u6211\u4eec\u53ef\u4ee5\u5728Istio\u7684VirtualService\u4e0a\u914d\u7f6e\u8fd9\u4e24\u8005\u3002 ... - route: - destination: host: customers.default.svc.cluster.local subset: v1 timeout: 10s \u91cd\u8bd5\u7b56\u7565 ... - route: - destination: host: customers.default.svc.cluster.local subset: v1 retries: attempts: 10 perTryTimeout: 2s retryOn: connect-failure,reset ... \u4e0a\u8ff0\u91cd\u8bd5\u7b56\u7565\u5c06\u5c1d\u8bd5\u91cd\u8bd5\u4efb\u4f55\u8fde\u63a5\u8d85\u65f6\uff08connect-failure)\u6216\u670d\u52a1\u5668\u5b8c\u5168\u4e0d\u54cd\u5e94 (reset)\u7684\u5931\u8d25\u8bf7\u6c42\u3002\u6211\u4eec\u5c06\u6bcf\u6b21\u5c1d\u8bd5\u7684\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u4e3a2\u79d2\uff0c\u5c1d\u8bd5\u7684\u6b21\u6570\u8bbe\u7f6e\u4e3a10\u6b21\u3002 \u6545\u969c\u6ce8\u5165 \u6709\u4e24\u79cd\u7c7b\u578b\u7684\u6545\u969c\u6ce8\u5165 \u3002 \u6211\u4eec\u53ef\u4ee5\u5728\u8f6c\u53d1\u524d\u5ef6\u8fdf\uff08delay\uff09\u8bf7\u6c42\uff0c\u6a21\u62df\u7f13\u6162\u7684\u7f51\u7edc\u6216\u8fc7\u8f7d\u7684\u670d\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u4e2d\u6b62\uff08abort) HTTP\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u7279\u5b9a\u7684HTTP\u9519\u8bef\u4ee3\u7801\u7ed9\u8c03\u7528\u8005\u3002 \u53ef\u9009\u7684\u5ef6\u8fdf - route: - destination: host: customers.default.svc.cluster.local subset: v1 fault: abort: percentage: value: 30 httpStatus: 404 fault: delay: percentage: value: 5 fixedDelay: 3s","title":"\u7b80\u5355\u8def\u7531"},{"location":"chap9/5istio_interview/#_6","text":"Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528\u4f20\u5165\u8bf7\u6c42\u7684\u4e00\u90e8\u5206\uff0c\u5e76\u5c06\u5176\u4e0e\u5b9a\u4e49\u7684\u503c\u76f8\u5339\u914d\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u5339\u914d\u4f20\u5165\u8bf7\u6c42\u7684URI\u524d\u7f00\uff0c\u5e76\u57fa\u4e8e\u6b64\u8def\u7531\u6d41\u91cf\u3002 \u91cd\u5b9a\u5411\u548c\u91cd\u5199\u8bf7\u6c42 ... http: - match: - headers: my-header: exact: hello redirect: uri: /hello authority: my-service.default.svc.cluster.local:8000 ...","title":"\u9ad8\u7ea7\u8def\u7531"},{"location":"chap9/5istio_interview/#serviceentry","text":"\u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206\u3002 Add entries to Istio's service registry Use traffic routing, failure injection, and other features against external services kind: ServiceEntry hosts: - api.external-svc.com ports: - number: 443 name: https protocol: TLS resolution: DNS location: MESH_EXTERNAL","title":"ServiceEntry"},{"location":"chap9/5istio_interview/#workloadentry","text":"Handle migration of VM workloads to Kubernetes Specify VM workloads and make them part of Istio's service registry \u5728 Workload Entry \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u5728\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ec6\u8282\uff08\u540d\u79f0\u3001\u5730\u5740\u3001\u6807\u7b7e\uff09\uff0c\u7136\u540e\u4f7f\u7528 ServiceEntry \u4e2d\u7684 workloadSelector \u5b57\u6bb5\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206\u3002","title":"WorkloadEntry"},{"location":"chap9/5istio_interview/#sidecar","text":"Sidecar\u8d44\u6e90\u7531\u4e09\u90e8\u5206\u7ec4\u6210\uff0c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u3001\u4e00\u4e2a\u5165\u53e3\uff08ingress)\u76d1\u542c\u5668\u548c\u4e00\u4e2a\u51fa\u53e3 (egress)\u76d1\u542c\u5668\u3002 Sidecar Resource Proxies accept traffic on all ports Configure Sidecar to specific ports/services Three parts: Workload selector Ingress listener Egress listener \u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u5668\u51b3\u5b9a\u4e86\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u4f1a\u53d7\u5230sidecar\u914d\u7f6e\u7684\u5f71\u54cd\u3002","title":"Sidecar"},{"location":"chap9/5istio_interview/#envoy-filter","text":"EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531Istio Pilot\u751f\u6210\u7684Envoy\u914d\u7f6e\u3002\u4f7f\u7528\u8be5\u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u66f4\u65b0\u6570\u503c\uff0c\u6dfb\u52a0\u7279\u5b9a\u7684\u8fc7\u6ee4\u5668\uff0c\u751a\u81f3\u6dfb\u52a0\u65b0\u7684\u76d1\u542c\u5668\u3001\u96c6\u7fa4\u7b49\u7b49\u3002\u5c0f\u5fc3\u4f7f\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u56e0\u4e3a\u4e0d\u6b63\u786e\u7684 \u5b9a\u5236\u53ef\u80fd\u4f1a\u7834\u574f\u6574\u4e2a\u7f51\u683c\u7684\u7a33\u5b9a\u6027\u3002 kind: EnvoyFilter","title":"Envoy Filter"},{"location":"chap9/5istio_interview/#_7","text":"\u6211\u4eec\u53ef\u4ee5\u7528\u4ec0\u4e48\u8d44\u6e90\u914d\u7f6eIstlo ingress gateway? Gateway : istio: ingressgateway \u4f7f\u7528 VirtualService \u8d44\u6e90\uff0c\u4f60\u53ef\u4ee5\u5c06\u6d41\u91cf\u8def\u7531\u5230Kubernetes\u5185\u90e8\u7684\u4e00\u4e2a\u7279\u5b9a\u670d\u52a1\u3002 Istio ingress \u7f51\u5173\u662f\u4f5c\u4e3a\u54ea\u79cd\u670d\u52a1\u7c7b\u578b\u90e8\u7f72\u7684\uff1f: Loadbalancer \u4f60\u53ef\u4ee5\u5728\u54ea\u4e2a\u8d44\u6e90\u4e2d\u4e3aHTTP\u6d41\u91cf\u6307\u5b9a\u8def\u7531\u89c4\u5219\uff1f: VirtuaLService \u5982\u4f55\u5b9a\u4e49\u591a\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u4ee5\u4fbf\u80fd\u591f\u5728\u5b83\u4eec\u4e4b\u95f4\u8fdb\u884c\u6d41\u91cf\u8def\u7531\uff1f \u4f7f\u7528Destination Rule\u548csubset \u5f53\u4f7f\u7528\u79bb\u7fa4\u68c0\u6d4b\u65f6\uff0c\u4e3b\u673a\u4f55\u65f6\u4f1a\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u5f39\u51fa\uff1f \u5f53\u8fd4\u56deHTTP 5xx\u9519\u8bef\u65f6 \u5728\u79bb\u7fa4\u68c0\u6d4b\u914d\u7f6e\u4e2d\uff0c\u95f4\u9694\u8bbe\u7f6e\u6307\u7684\u662f\u4ec0\u4e48 \u626b\u63cf\u4e0a\u6e38\u4e3b\u673a\u65f6\u95f4\u7684\u95f4\u9694 \u80fd\u5c06\u6d41\u91cf\u7b56\u7565\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u7aef\u53e3\u5417\uff1f: \u80fd trafficPolicy: portLevelSettings: port ISTIO_MUTUAL \u548c MUTUAL TLS \u6a21\u5f0f\u4e4b\u95f4\u6709\u4ec0\u4e48\u533a\u522b\uff1f ISTIO_MUTUAL \u5728mTLS\u4e2d\u4f7f\u7528Istio\u7684\u8bc1\u4e66\uff0c\u800c\u5728MUTUAL TLS\u4e2d\u4f60\u53ef\u4ee5\u7528\u4f60\u81ea\u5df1\u7684\u8bc1\u4e66 ISTIO_MUTUAL \uff08\u4e0eMUTUAL\u7c7b\u4f3c\uff0c\u4f7f\u7528Istio\u7684mTLS\u8bc1\u4e66\uff09 \u6211\u4eec\u53ef\u4ee5\u53ea\u5728\u4e0a\u6e38\u670d\u52a1\u5668\u8fd4\u56de5xx\u54cd\u5e94\u4ee3\u7801\u65f6\u91cd\u8bd5\u8bf7\u6c42\uff0c\u6216\u8005\u53ea\u5728\u7f51\u5173\u9519\u8bef\uff08HTTP 5O2\u3001 503\u6216504\uff09\u65f6\u91cd\u8bd5\uff0c\u6216\u8005\u751a\u81f3\u5728\u8bf7\u6c42\u5934\u4e2d\u6307\u5b9a\u53ef\u91cd\u8bd5\u7684\u72b6\u6001\u4ee3\u7801\u3002 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48: \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 \u91cd\u8bd5\u548c\u8d85\u65f6\u90fd\u53d1\u751f\u5728\u5ba2\u6237\u7aef\u3002\u5f53Envoy\u91cd\u8bd5\u4e00\u4e2a\u5931\u8d25\u7684\u8bf7\u6c42\u65f6\uff0c\u6700\u521d\u5931\u8d25\u5e76\u5bfc\u81f4\u91cd\u8bd5\u7684\u7aef\u70b9\u5c31\u4e0d\u518d\u5305\u542b\u5728\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u4e86\u3002\u5047\u8bbeKubernetes\u670d\u52a1\u67093\u4e2a\u7aef\u70b9\uff08Pod)\uff0c\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u4e86\uff0c \u5e76\u51fa\u73b0\u4e86\u53ef\u91cd\u8bd5\u7684\u9519\u8bef\u4ee3\u7801 \u4f60\u80fd\u4e3a\u540c\u4e00\u4e2a\u8bf7\u6c42\u540c\u65f6\u6ce8\u5165\u5ef6\u8fdf\u548c\u4e2d\u6b62\u5417. \u662f \u8003\u8651\u5230\u4e0b\u9762\u7684\u7247\u6bb5\uff0c\u6709\u591a\u5c11\u767e\u5206\u6bd4\u7684\u8bf7\u6c42\u4f1a\u88ab\u4e2d\u6b62\uff1f \u5982\u679c\u6211\u4eec\u4e0d\u6307\u5b9a\u767e\u5206\u6bd4\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u4e2d\u6b62 \u6545\u969c\u6ce8\u5165\u662f\u5426\u89e6\u53d1\u91cd\u8bd5\u7b56\u7565\uff1f \u6ce8\u610f\uff0c\u6545\u969c\u6ce8\u5165\u5c06\u4e0d\u4f1a\u89e6\u53d1\u6211\u4eec\u5728\u8def\u7531\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u91cd\u8bd5\u7b56\u7565\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u6ce8\u5165\u4e86\u4e00\u4e2aHTTP 500\u7684\u9519\u8bef\uff0c\u914d\u7f6e\u4e3aHTTP 500\u4e0a\u7684\u91cd\u8bd5\u7b56\u7565\u5c06\u4e0d\u4f1a\u88ab\u89e6\u53d1 \u3002 \u4f60\u53ef\u4ee5\u4f7f\u7528VirtualService\u4e2d\u7684\u54ea\u4e2a\u5b57\u6bb5\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230Kubernetes\u4e2d\u4e00\u4e2a\u5b8c\u5168\u4e0d\u540c\u7684\u670d\u52a1\uff1f redirect \u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u4f7f\u5916\u90e8\u670d\u52a1\u6210\u4e3a\u4f60\u7684\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206 ServiceEntry \u901a\u8fc7ServiceEntry\u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u5411Istio\u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u6dfb\u52a0\u989d\u5916\u7684\u6761\u76ee\uff0c\u4f7f\u4e0d\u5c5e\u4e8e\u6211\u4eec\u7f51\u683c\u7684\u5916\u90e8\u670d\u52a1\u6216\u5185\u90e8\u670d\u52a1\u770b\u8d77\u6765\u50cf\u662f\u6211\u4eec\u670d\u52a1\u7f51\u683c\u7684\u4e00\u90e8\u5206 Envoy sidecar\u68c0\u67e5ServiceEntry\u8d44\u6e90\u4e2d\u7684hosts\u5b57\u6bb5\u7684\u987a\u5e8f\u662f\u4ec0\u4e48. HTTP\u3001 SNI\u3001 IP\u5730\u5740\u3001\u7aef\u53e3 ServiceEntry\u8d44\u6e90\u4e2d\u7684workloadSelector\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f \u8981\u9009\u62e9WorkloadEntry\u8d44\u6e90\uff0c\u4f7f\u865a\u62df\u673a\u6210\u4e3aIstio\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u8868\u7684\u4e00\u90e8\u5206 \u5982\u4f55\u914d\u7f6esidecar\u4ee3\u7406\uff0c\u4f7f\u5176\u53ea\u5bf9\u67d0\u4e9b\u670d\u52a1\u4f7f\u7528\u7279\u5b9a\u7684\u7aef\u53e3 \u4f7f\u7528Sidecar\u8d44\u6e90 Sidecar\u8d44\u6e90\u4e2d\u7684Ingress\u548cegress\u76d1\u542c\u5668\u5b57\u6bb5\u7684\u76ee\u7684\u662f\u4ec0\u4e48 \u5b9a\u4e49\u54ea\u4e9b\u5165\u7ad9\uff0f\u51fa\u7ad9\u6d41\u91cf\u88absidecar\u63a5\u53d7 Workload selector Ingress listener Egress listener EnvoyFilter\u8d44\u6e90\u5141\u8bb8\u4f60\u5b9a\u5236\u7531Istio Pilot\u751f\u6210\u7684Envoy\u914d\u7f6e \u5f53\u6709\u591a\u4e2aEnvoyFilter\u90e8\u7f72\u65f6\uff0c\u54ea\u4e9b\u8fc7\u6ee4\u5668\u4f1a\u5148\u88ab\u5e94\u7528 \u6839\uff08\u5982istio-system)\u547d\u540d\u7a7a\u95f4\u7684\u8fc7\u6ee4\u5668 \u6839\u547d\u540d\u7a7a\u95f4\uff08\u4f8b\u5982istio-system)\u4e2d\u7684\u8fc7\u6ee4\u5668\u9996\u5148\u88ab\u5e94\u7528\uff0c\u7136\u540e\u662f\u5de5\u4f5c\u8d1f\u8f7d\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709\u5339\u914d\u8fc7\u6ee4\u5668\u3002 \u5982\u4f55\u5c06VirtualService\u4e0eGateway\u7ed1\u5b9a \u4f7f\u7528gateways\u5b57\u6bb5 ... kind: VirtualService ... spec: hosts: - \"*\" gateways: - gateway Destination Rule\u914d\u7f6e\u6d41\u91cf\u7b56\u7565 \u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u5931\u8d25\u5e76\u89e6\u53d1\u91cd\u8bd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48 \u5f53Envoy\u91cd\u8bd5\u8bf7\u6c42\u65f6\uff0c\u7aef\u70b9\u88ab\u4ece\u8d1f\u8f7d\u5747\u8861\u6c60\u4e2d\u6392\u9664 \u4f60\u53ef\u4ee5\u7528Workload Entry\u8d44\u6e90\u505a\u4ec0\u4e48\uff1f \u5904\u7406\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u5411Kubernetes\u7684\u8fc1\u79fb","title":"\u6d4b\u8bd5"},{"location":"chap9/5istio_interview/#istio-secuirty","text":"","title":"Istio Secuirty"},{"location":"chap9/5istio_interview/#authentication","text":"Authentication Principal = Kubernetes service Action = HTTP request methods (e.g. GET, POST, DELETE, ...) Object = Kubernetes service All about the principal (service identity) \"Validating a credential and ensuring it's both valid and trusted\" Identity Unique identity in Kubernetes = Kubernetes service account X.509 certificate (from SA) + SPIFFE spec = Identity Naming scheme (spiffe://cluster.localinsidefault/sa/my-sa) Encoding names into X.509 Validating the X.509 to authenticate the SPIFFE identity","title":"\u8ba4\u8bc1(Authentication)"},{"location":"chap9/5istio_interview/#_8","text":"\u5bf9\u4e8e\u7f51\u683c\u4e2d\u7684\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\uff0cIstio\u63d0\u4f9b\u4e00\u4e2a X.509 \u8bc1\u4e66\u3002 \u4e00\u4e2a\u540d\u4e3a pilot-agent \u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c \uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08istiod\uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c\u3002 Certificate creation Istio Agent Envoy's Secret Discovery Service(SDS) Citadel(part of the control plane) Istio Agent\u4e0eEnvoy sidecar\u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c \u3002\u5373\u4fbfIstio\u4ee3\u7406\u5728\u6bcf\u4e2apod\u4e2d\u8fd0\u884c\u6211\u4eec\u4e5f\u8ba4\u4e3a\u5b83\u662f\u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\u3002 \u79d8\u94a5\u53d1\u73b0\u670d\u52a1(SDS)\u7b80\u5316\u4e86\u8bc1\u4e66\u7ba1\u7406\u3002\u5982\u679c\u6ca1\u6709SDS\u8bc1\u4e66\u5fc5\u987b\u4f5c\u4e3a\u79d8\u5bc6(Secret) \u521b\u5efa\uff0c\u7136\u540e\u88c5\u5165\u4ee3\u7406\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002 \u6bcf\u5f53\u8bc1\u4e66\u8fc7\u671f\u65f6SDS\u4f1a\u63a8\u9001\u66f4\u65b0\u7684\u8bc1\u4e66Envoy\u53ef\u4ee5\u7acb\u5373\u4fbf\u7528\u5b83\u4eec\u3002\u4e0d\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u670d\u52a1\u5668\u4e5f\u4e0d\u9700\u8981\u4e2d\u65ad\u6d41\u91cf\u3002","title":"\u8bc1\u4e66\u521b\u5efa\u548c\u8f6e\u6362"},{"location":"chap9/5istio_interview/#peer-and-request-authentication","text":"Peer authentication Peer authentication service-to-service All mTLS about the communication between services Request authentication end user authentication uses JWTs","title":"Peer and Request Authentication(\u5bf9\u7b49\u8ba4\u8bc1\u548c\u8bf7\u6c42\u8ba4\u8bc1)"},{"location":"chap9/5istio_interview/#tls","text":"Mutual TLS(mTLS) Traffic is re-routed through proxies Envoy starts an mTLS handshake Secure naming check is done Once mTLS connection is established: Request is forwarded to server-side proxy Server-side forwards traffic to the workload mTLS Behavior DISABLE : no TLS connection SIMPLE : originate to the upstream MUTUAL : uses mTLS and certs for auth ISTIO_MUTUAL : like MUTUAL; but uses Istlo's certs for mTLS Permissive mode Allows services to accpet both plaintext and mTLS Improves mTLS onboarding experience Gradually Install/configure sidecars for mTLS","title":"\u53cc\u5411TLS"},{"location":"chap9/5istio_interview/#_9","text":"Authorization Can user A send a GET request to /hello on service B? Authn without authz (and vice-versa) is useless Control authenticated principals with AuthorizationPolicy Authorization policy Make use of identities extracted from PeerAuthentication and RequestAuthentication : requestPrincipals (users) principals (service/peer) Defined at mesh, namespace, and workload level Authorization policy Workloads policy applies to Action to take (deny, allow, or audit) Rules when to take action Istio\u5141\u8bb8\u6211\u4eec\u4f7f\u7528 AuthorizationPolicy \u8d44\u6e90\u5728\u7f51\u683c\u3001\u547d\u540d\u7a7a\u95f4\u548c\u5de5\u4f5c\u8d1f\u8f7d\u5c42\u9762\u5b9a\u4e49\u8bbf\u95ee\u63a7\u5236\u3002 AuthorizationPolicy \u652f\u6301DENY\u3001ALLOW\u3001 AUDIT\u548cCUSTOM\u64cd\u4f5c \u3002 kind: AuthorizationPolicy","title":"\u6388\u6743"},{"location":"chap9/5istio_interview/#_10","text":"\u5728\u901a\u4fe1\u65f6\uff0cEnvoy\u4ee3\u7406\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u51ed\u8bc1: X509\u8bc1\u4e66 Validating the X.509 to authenticate the SPIFFE identity \u54ea\u4e2a\u7ec4\u4ef6\u4e3a\u4e00\u4e2a\u670d\u52a1\u8d26\u6237\u521b\u5efaSPIFFE\u8eab\u4efd\uff1f Citadel \u6bcf\u6b21\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u8d26\u6237\u65f6, Citadel\u90fd\u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2aSPIFFE\u8eab\u4efd \u3002 \u4f60\u4f1a\u4f7f\u7528\u54ea\u79cd\u8d44\u6e90\u6765\u542f\u7528\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4e25\u683cmTLS\u6a21\u5f0f\uff1f PeerAuthentication AuthorizationPolicy\u8d44\u6e90\u4e2d\u4f7f\u7528\u54ea\u4e24\u4e2a\u52a8\u4f5c\uff1f DENY\u548cALLOW \u6bcf\u4e2aEnvoy\u4ee3\u7406\u5b9e\u4f8b\u90fd\u8fd0\u884c\u4e00\u4e2a\u6388\u6743\u5f15\u64ce\uff0c\u5728\u8fd0\u884c\u65f6\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6388\u6743\u3002\u5f53\u8bf7\u6c42\u5230\u8fbe\u4ee3\u7406\u65f6\uff0c\u5f15\u64ce\u4f1a\u6839\u636e\u6388\u6743\u7b56\u7565\u8bc4\u4f30\u8bf7\u6c42\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u8fd4\u56deALLOW\u6216DENY \u5f53\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\uff08SDS)\u66f4\u65b0\u8bc1\u4e66\u65f6\uff0c\u662f\u5426\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7406\u4ee5\u4f7f\u7528\u65b0\u8bc1\u4e66\u3002 \u5426 AUDIT\u52a8\u4f5c\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f \u8bb0\u5f55\u8bf7\u6c42 AUDIT\u52a8\u4f5c\u51b3\u5b9a\u662f\u5426\u8bb0\u5f55\u7b26\u5408\u89c4\u5219\u7684\u8bf7\u6c42\u3002\u6ce8\u610fAUDIT\u7b56\u7565\u5e76\u4e0d\u5f71\u54cd\u8bf7\u6c42\u88ab\u5141\u8bb8\u6216\u62d2\u7edd\u3002 \u4ec0\u4e48\u662f\u5141\u8bb8\u6a21\u5f0f\uff08permissive mode)? \u4e00\u4e2a\u5141\u8bb8\u670d\u52a1\u540c\u65f6\u63a5\u53d7\u7eaf\u6587\u672c\u6d41\u6700\u548cmTLS\u6d41\u91cf\u7684\u9009\u9879 \u662f\u5426\u53ef\u4ee5\u5728Istio\u4e2d\u4f7f\u7528JSON Web Tokens (JWTs)? \u662f \u9009\u62e9\u4e09\u4e2a\u8d1f\u8d35\u5728\u8fd0\u884c\u65f6\u521b\u5efa\u8eab\u4efd\u7684\u7ec4\u4ef6 Citedel \u3001 lstio Agent \u3001Envoys Secret Discovery Service Istlo Agent\u7684\u5de5\u4f5c\u662f\u4ec0\u4e48\uff1f \u4e0eEnvoy sidecar\u5408\u4f5c\uff0c\u901a\u8fc7\u4e13\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\uff0c\u5e2e\u52a9\u4ed6\u4eec\u94fe\u63a5\u5230Service mesh Istio Agent\u4e0eEnvoy sidecar\u4e00\u8d77\u5de5\u4f5c\u901a\u8fc7\u5b89\u5168\u5730\u4f20\u9012\u914d\u7f6e\u548c\u79d8\u5bc6\u5e2e\u52a9\u5b83\u4eec\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c Istlo\u63d0\u4f9b\u54ea\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1f \u5bf9\u7b49\u548c\u8bf7\u6c42\u8ba4\u8bc1 Istlo\u4ee3\u7406\u5c06\u5bc6\u94a5\u548c\u8bc1\u4e66\u5b58\u50a8\u5728\u54ea\u91cc\uff1f \u5185\u5b58 \u5c06\u5bc6\u94a5\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u6bd4\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u66f4\u5b89\u5168\uff1b \u5728\u4f7f\u7528SDS\u65f6\uff0c\u7edd\u4e0d\u4f1a\u5c06\u4efb\u4f55\u5bc6\u94a5\u5199\u5165\u78c1\u76d8\u3002Istio\u4ee3\u7406\u8fd8\u5b9a\u671f\u5237\u65b0\u51ed\u8bc1\uff0c \u5728\u5f53\u524d\u51ed\u8bc1\u8fc7\u670b\u524d\u4eceCitadel\u68c0\u7d22\u4efb\u4f55\u65b0\u7684SVID(SPIFFE\u53ef\u9a8c\u8bc1\u8eab\u4efd\u6587\u4ef6\uff09 \u54ea\u79cd\u4ee3\u7406\u4e0eistiod\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u5b9e\u73b0\u94a5\u5319\u548c\u8bc1\u4e66\u8f6e\u6362\u7684\u81ea\u52a8\u5316 pilot-agent \u4e00\u4e2a\u540d\u4e3a pilot-agent \u7684\u4ee3\u7406\u5728\u6bcf\u4e2aEnvoy\u4ee3\u7406\u65c1\u8fb9\u8fd0\u884c\uff0c\u5e76\u4e0e\u63a7\u5236\u5e73\u9762\uff08istiod\uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u81ea\u52a8\u8fdb\u884c\u5bc6\u94a5\u548c\u8bc1\u4e66\u7684\u8f6e\u8f6c\u3002 \u5b89\u5168\u547d\u540d\u4fe1\u606f\u5305\u542b\u54ea\u4e9b\u5185\u5bb9\uff1f \u4ece\u670d\u52a1\u8eab\u4efd\u5230\u670d\u52a1\u540d\u79f0\u7684\u6620\u5c04 \u5982\u679c\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u6709\u591a\u4e2a\u7b56\u7565\uff0c\u54ea\u4e9b\u7b56\u7565\u4f1a\u5148\u88ab\u8bc4\u4f30\uff1f Deny \u7b56\u7565 \u4f60\u5982\u4f55\u5728Istio\u4e2d\u542f\u7528\u6388\u6743\u529f\u80fd\uff1f \u4e0d\u9700\u8981\u660e\u786e\u5730\u542f\u7528\u8be5\u529f\u80fd \u6ca1\u6709\u5fc5\u8981\u660e\u786e\u5730\u542f\u7528\u6388\u6743\u529f\u80fd\u3002 \u4e3a\u4e86\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6388\u6743\u7b56\u7565\u6765\u5e94\u7528\u4e8e\u6211\u4eec\u7684\u5de5\u4f5c\u8d1f\u8f7d AuthorizationPolicy \u8d44\u6e90\u662f\u6211\u4eec\u53ef\u4ee5\u5229\u7528 PeerAuthentication \u7b56\u7565\u548c RequestAuthentication \u7b56\u7565\u4e2d\u7684\u4e3b\u4f53\u7684\u5730\u65b9 \u3002 Istio\u5982\u4f55\u9a8c\u8bc1\u7528\u6237\uff0f\u8fdb\u7a0b\u7684\u8eab\u4efd \u901a\u8fc7\u4ece\u8bf7\u6c42\u4e2d\u63d0\u53d6\u51ed\u8bc1 \u4f60\u5982\u4f55\u5728\u6574\u4e2a\u7f51\u683c\u4e2d\u5f3a\u5236\u6267\u884c\u4e25\u683c\u7684mTLS\u6a21\u5f0f \u901a\u8fc7\u5c06PeerAuthentication\u8d44\u6e90\u90e8\u7f72\u5230\u6839\u547d\u540d\u7a7a\u95f4(Istlo system\uff09\u4e2d \u6211\u4eec\u53ef\u4ee5\u521b\u5efaPeerAuthentication\u8d44\u6e90\uff0c\u9996\u5148\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5206\u522b\u6267\u884c\u4e25\u683c\u6a21\u5f0f\u3002\u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u547d\u540d\u7a7a\u95f4\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662fistio-system)\u521b\u5efa\u4e00\u4e2a\u7b56\u7565\uff0c\u5728\u6574\u4e2a\u670d\u52a1\u7f51\u683c\u4e2d\u6267\u884c\u8be5\u7b56\u7565\uff1a \u5bf9\u7b49\u8ba4\u8bc1\u662f\u7528\u6765\u505a\u4ec0\u4e48\u7684: \u670d\u52a1\u95f4\u8ba4\u8bc1 \u679cKubernetes\u5de5\u4f5c\u8d1f\u8f7d\u6ca1\u6709Envoy\u4ee3\u7406\uff0cIstio\u662f\u5426\u4f1a\u53d1\u9001mTLS\u6d41\u91cf \u5426 Authorization Policy\u8d44\u6e90\u4e2d\u7684selector\u548cmatchLabel\u5b57 \u6bb5\u6709\u4ec0\u4e48\u7528\u9014 \u8981\u9009\u62e9\u7b56\u7565\u9002\u7528\u7684\u5de5\u4f5c\u8d1f\u8f7d","title":"\u5b89\u5168\u6d4b\u8bd5"},{"location":"chap9/5istio_interview/#_11","text":"Istio\u5728\u7f51\u683c\u4e2d\u4f7f\u7528\u4ec0\u4e48\u4f5c\u4e3a\u79df\u6237\u5355\u4f4d: Namespace \u4f60\u4f7f\u7528\u54ea\u4e9b\u8d44\u6e90\u5c06\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u5230\u670d\u52a1\u7f51\u683c\uff1f WorkloadGroup \u548c WorkloadEntry \u5de5\u4f5c\u8d1f\u8f7d\u7ec4(WorkloadGroup\u8d44\u6e90\uff09\u7c7b\u4f3c\u4e8eKubernetes \u4e2d\u7684\u90e8\u7f72(Deployments)\u5b83\u4ee3\u8868\u4e86\u5171\u4eab\u5171\u540c\u5c5e\u6027\u7684\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u903b\u8f91\u7ec4 \u63cf\u8ff0\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee(WorkloadEntry\u8d44\u6e90\uff09\u3002\u5de5\u4f5c\u8d1f\u8f7d\u6761\u76ee\u7c7b\u4f3c\u4e8ePod\u5b83\u4ee3\u8868\u4e86\u4e00\u4e2a\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5355\u4e00\u5b9e\u4f8b \u4f60\u662f\u5426\u53ef\u4ee5\u901a\u8fc7\u5c06\u6240\u6709\u96c6\u7fa4\u4f5c\u4e3a\u8fdc\u7a0b\u96c6\u7fa4\u6765\u5b9e\u73b0\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u7684\u5b8c\u5168\u5206\u79bb\uff1f \u662f \u53e6\u4e00\u79cd\u90e8\u7f72\u6a21\u5f0f\u662f\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684\u96c6\u7fa4\u90fd\u89c6\u4e3a\u7531\u5916\u90e8\u63a7\u5236\u5e73\u9762\u63a7\u5236\u7684\u8fdc\u7a0b\u96c6\u7fa4\u3002\u8fd9\u4f7f\u6211\u4eec\u5728\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u6709\u4e86\u5b8c\u5168\u7684\u5206\u79bb\u3002 Istio\u662f\u5982\u4f55\u89e3\u51b3\u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u914d\u7f6e\u9694\u79bb\u7684: \u4e0d\u53ef\u884c \u79df\u6237\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u662f\u9694\u79bb\u4e0d\u540c\u79df\u6237\u7684\u914d\u7f6e\u3002\u76ee\u524d\uff0cIstio\u5e76\u6ca1\u6709\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u8fc7\uff0c\u5b83\u901a\u8fc7\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u7684\u8303\u56f4\u914d\u7f6e\u6765\u5c1d\u8bd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 \u591a\u96c6\u7fa4\u90e8\u7f72\u7684\u76ee\u7684\u662f\u4ec0\u4e48\uff1f \u4e3a\u4e86\u83b7\u5f97\u66f4\u5927\u7a0b\u5ea6\u7684\u9694\u79bb\u548c\u53ef\u7528\u6027 \uff0e \u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\u662f\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762\u3002\u5bf9\u4e8e\u6b63\u5e38\u7684\u670d\u52a1\u7f51\u683c\u90e8\u7f72\u89c4\u6a21\u5efa\u8bae\u4f60\u4f7f\u7528\u591a\u7f51\u683c\u90e8\u7f72\uff0c\u5e76\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u7cfb\u7edf\u5728\u5916\u90e8\u534f\u8c03\u7f51\u683c\u3002 \u4ec0\u4e48\u662f\u79df\u6237\uff1f \u79df\u6237\u662f\u4e00\u7ec4\u5171\u4eab\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5171\u540c\u8bbf\u95ee\u6743\u548c\u6743\u9650\u7684\u7528\u6237\u3002\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u901a\u8fc7\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565\u5b8c\u6210\u7684 \u3002 What does the shared control plane model involve? \u591a\u4e2a\u96c6\u7fa4\u63a7\u5236\u5e73\u9762\u53ea\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff08\u4e3b\u96c6\u7fa4\uff09 \u4ec0\u4e48\u88ab\u8ba4\u4e3a\u662f\u6700\u4f73\u7684\u591a\u96c6\u7fa4\u90e8\u7f72\u62d3\u6251\u7ed3\u6784\uff1f \u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762 \u4e0d\u540c\u79df\u6237\u4e4b\u95f4\u7684\u9694\u79bb\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1f \u4f7f\u7528\u7f51\u7edc\u914d\u7f6e\u548c\u7b56\u7565 \u5de5\u4f5c\u8d1f\u8f7d\u5e94\u8be5\u5982\u4f55\u5728\u96c6\u7fa4\u4e4b\u95f4\u8fdb\u884c\u901a\u4fe1\uff1f \u901a\u8fc7ingress gateway","title":"\u9ad8\u7ea7\u529f\u80fd\u6d4b\u8bd5"},{"location":"chap9/5istio_interview/#istio_4","text":"istioctl proxy-config \u5217\u51fa\u76d1\u542c\u5668 \u914d\u7f6e istioctl validate -f myresource.yaml \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u53e6\u4e00\u4e2a\u547d\u4ee4 istioctl analyze istioctl proxy-status istioctl dashboard controlz \u5982\u679c\u865a\u62df\u76d1\u542c\u5668\u627e\u4e0d\u5230\u8bf7\u6c42\u7684\u76ee\u7684\u5730\u4f1a\u600e\u6837 \u6839\u636eOutboundTrafficPolicy\u53d1\u9001\u6d41\u91cf \u4f60\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e2aIstio CLI\u547d\u4ee4\u6765\u5217\u51fa\u6240\u6709\u76d1\u542c\u5668 istiocti proxy-config listeners \u76d1\u542c\u5668\u4f7f\u7528\u54ea\u4e2a\u670d\u52a1\u6765\u5bfb\u627e\u8def\u7531\u914d\u7f6e RDS(route discovery service) Envoy\u7684\u57fa\u672c\u6982\u5ff5\u662f\u4ec0\u4e48\uff1f listener\u3001route\u3001cluster\u548cendpoint \u6bcf\u4e2asidecar\u90fd\u6709\u591a\u4e2a\u76d1\u542c\u5668\u751f\u6210\u3002\u6bcf\u4e2asidecar\u90fd\u6709\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u5b83\u88ab\u7ed1\u5b9a\u5230 0.0.0.0:15006 Where are the circuit breakers defined In clusters configuration \u4ec0\u4e48\u7c7b\u578b\u7684\u6d41\u91cf\u4f1a\u88ab\u8def\u7531\u523015006\u7aef\u53e3 \u5165\u7ad9Pod\u6d41\u91cf","title":"Istio \u95ee\u9898\u6392\u67e5"},{"location":"chap9/6k8s_mtls/","text":"6 Kubernetes \u7684 mTLS \u6307\u5357 \u7b80\u4ecb Mutual TLS\uff08\u53cc\u5411 TLS\uff09\uff0c\u6216\u79f0 mTLS\uff0c\u662f Kubernetes \u4e2d\u7684\u4e00\u4e2a\u70ed\u95e8\u8bdd\u9898\uff0c\u5c24\u5176\u662f\u5bf9\u4e8e\u90a3\u4e9b\u8d1f\u8d23\u4e3a\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u4f20\u8f93\u5c42\u52a0\u5bc6\u7684\u4eba\u6765\u8bf4\u3002\u4f46\u662f\uff0c\u4f60\u6709\u6ca1\u6709\u8003\u8651\u8fc7\uff0c\u4ec0\u4e48\u662f mTLS\uff0c\u5b83\u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u5b89\u5168\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981 mTLS\uff1f \u4ec0\u4e48\u662f mTLS\uff1f \u5bf9\u4e8e\u5e38\u89c4 TLS\uff0c\u53ea\u9700\u8981\u670d\u52a1\u7aef\u8ba4\u8bc1\uff0cmTLS \u76f8\u5bf9\u6765\u8bf4\u6709\u4e00\u4e2a\u989d\u5916\u7684\u89c4\u5b9a\uff1a \u5ba2\u6237\u7aef\u4e5f\u8981\u7ecf\u8fc7\u8ba4\u8bc1 \u3002\u4f46\u8fd9\u610f\u5473\u7740\u4ec0\u4e48\uff0c\u4e3a\u4ec0\u4e48\u8981\u8fd9\u6837\u505a\u5462\uff1f \u5728\u56de\u7b54\u8fd9\u4e9b\u95ee\u9898\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u5bf9 TLS \u6709\u4e00\u4e2a\u57fa\u672c\u7684\u4e86\u89e3\u3002 TLS \u662f\u4e00\u4e2a\u4f20\u8f93\u5c42\u534f\u8bae\uff0c\u65e8\u5728\u4e3a TCP \u8fde\u63a5\u63d0\u4f9b\u5b89\u5168\u4fdd\u969c\uff08\u6211\u4eec\u5c06\u5728\u4e0b\u9762\u770b\u5230\u5b89\u5168\u7684\u786e\u5207\u542b\u4e49\uff09 \u3002TLS \u5728\u4f20\u8f93\u5c42\u5de5\u4f5c\uff0c\u53ef\u4ee5\u4e0e\u4efb\u4f55\u4f7f\u7528 TCP \u7684\u5e94\u7528\u5c42\u534f\u8bae\u7ed3\u5408\u4f7f\u7528\u3002 \u4f8b\u5982\uff0cHTTPS \u662f HTTP \u4e0e TLS \u7684\u7ed3\u5408\uff08HTTPS \u4e2d\u7684 S \u6307\u7684\u662f SSL\uff0c\u5373 TLS \u7684\u524d\u8eab\uff09\uff0c HTTP \u4e0d\u9700\u8981\u505a\u4efb\u4f55\u6539\u53d8\u6765\u9002\u5e94 TLS \uff08\u81f3\u5c11\uff0c\u5728\u534f\u8bae\u5c42\u9762\u3002 \u5728\u5b9e\u8df5\u4e2d\uff0c\u968f\u7740 HTTPS \u7684\u5f15\u5165\uff0cHTTP \u7684\u4f7f\u7528\u65b9\u5f0f\u80af\u5b9a\u5df2\u7ecf\u53d1\u751f\u4e86\u53d8\u5316\u3002\u4f8b\u5982\uff0c\u50cf HSTS \u8fd9\u6837\u7684\u529f\u80fd\u73b0\u5728\u88ab\u7528\u6765\u9632\u6b62 HTTPS \u53ef\u80fd\u53d1\u751f\u7684\u67d0\u4e9b\u7c7b\u578b\u7684\u653b\u51fb\uff09\u3002 \u56e0\u4e3a TLS \u4e2d\u5b58\u5728\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u4f7f\u5f97\u5176\u4ece\u5b89\u5168\u7684\u89d2\u5ea6\u6765\u770b\u662f\u4e0d\u7406\u60f3\u7684\u3002TLS \u89c4\u8303\u590d\u6742\uff0c\u800c\u4e14\u6ca1\u6709\u5f97\u5230\u5145\u5206\u7684\u8bf4\u660e\uff0c\u6709\u4e9b\u5730\u65b9\u5e76\u6ca1\u6709\u771f\u6b63\u7684\u610f\u4e49\uff0c\u800c\u4e14\u4e0d\u7ba1\u600e\u6837\uff0c\u5b9e\u73b0\u8d77\u6765\u4e5f\u4e0d\u4f1a 100% \u7b26\u5408 TLS \u89c4\u8303\u3002 TLS \u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u5b89\u5168\u6027\uff1f \u5927\u591a\u6570\u4eba\u628a TLS \u4e0e\u52a0\u5bc6\u8054\u7cfb\u8d77\u6765\u3002\u4f46 TLS \u4e0d\u4ec5\u4ec5\u662f\u8fd9\u6837\u3002TLS \u4e3a\u8fde\u63a5\u63d0\u4f9b\u4e86\u4e09\u79cd\u5b89\u5168\u4fdd\u8bc1\uff1a \u771f\u5b9e\u6027 \uff1a\u4efb\u4f55\u4e00\u65b9\u90fd\u80fd\u8bc1\u660e\u4ed6\u4eec\u662f\u81ea\u5df1\u6240\u58f0\u79f0\u7684\u8eab\u4efd\u3002 \u4fdd\u5bc6\u6027 \uff1a\u5176\u4ed6\u4eba\u65e0\u6cd5\u770b\u5230\u6b63\u5728\u4ea4\u6362\u7684\u6570\u636e\u3002 \u5b8c\u6574\u6027 \uff1a\u6536\u5230\u7684\u6570\u636e\u4e0e\u53d1\u9001\u7684\u6570\u636e\u76f8\u540c\u3002 \u56e0\u6b64\uff0c\u867d\u7136 TLS \u786e\u5b9e\u7ed9\u4f60\u63d0\u4f9b\u4e86\u52a0\u5bc6 \u2014\u2014 \u8fd9\u5c31\u662f\u5b83\u5b9e\u73b0\u4fdd\u5bc6\u7684\u65b9\u5f0f \u2014\u2014 \u4f46\u4ece TLS \u7684\u89d2\u5ea6\u6765\u770b\uff0c\u8fd9\u5bf9\u5b89\u5168\u901a\u4fe1\u6765\u8bf4\u662f\u4e0d\u591f\u7684\uff1a \u4f60\u9700\u8981\u6240\u6709\u8fd9\u4e09\u79cd\u5c5e\u6027\u3002\u5982\u679c\u4f60\u6ca1\u6709\u771f\u5b9e\u6027\uff0c\u90a3\u4e48\u6709\u4eba\u5c31\u53ef\u4ee5\u5728\u8fde\u63a5\u7684\u53e6\u4e00\u7aef\u8fdb\u884c\u6b3a\u9a97\u3002\u5982\u679c\u4f60\u6ca1\u6709\u5b8c\u6574\u6027\uff0c\u90a3\u4e48\u6709\u4eba\u53ef\u4ee5\u4fee\u6539\u901a\u4fe1\u4e2d\u7684\u5173\u952e\u4fe1\u606f\u3002\u5982\u679c\u4f60\u6ca1\u6709\u4fdd\u5bc6\u6027\uff0c\u90a3\u4e48\u4efb\u4f55\u4eba\u90fd\u53ef\u4ee5\u76d1\u542c\u3002 mTLS \u4ec0\u4e48\u65f6\u5019\u6709\u7528\uff1f \u56de\u5230\u6211\u4eec\u6700\u521d\u7684\u5b9a\u4e49\uff1amTLS \u662f\u7b80\u5355\u7684\u5e38\u89c4 TLS\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u989d\u5916\u7684\u89c4\u5b9a\uff0c\u5373\u5ba2\u6237\u7aef\u4e5f\u8981\u7ecf\u8fc7\u8ba4\u8bc1\u3002\u6709\u4e86\u5bf9 TLS \u7684\u57fa\u672c\u4e86\u89e3\uff0c\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u89e3\u6790\u8fd9\u4e2a\u58f0\u660e\u4e86\u3002TLS \u4fdd\u8bc1\u4e86\u771f\u5b9e\u6027\uff0c\u4f46\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8fd9\u53ea\u53d1\u751f\u5728\u4e00\u4e2a\u65b9\u5411\u4e0a\uff1a \u5ba2\u6237\u7aef\u5bf9\u670d\u52a1\u5668\u8fdb\u884c\u8ba4\u8bc1\uff0c\u4f46\u670d\u52a1\u5668\u5e76\u4e0d\u5bf9\u5ba2\u6237\u7aef\u8fdb\u884c\u8ba4\u8bc1 \u3002 \u4e3a\u4ec0\u4e48 TLS \u7684\u9ed8\u8ba4\u53ea\u5728\u4e00\u4e2a\u65b9\u5411\u8fdb\u884c\u8ba4\u8bc1\uff1f \u56e0\u4e3a\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u5f80\u5f80\u662f\u4e0d\u76f8\u5173\u7684 \u3002\u4f8b\u5982\uff0c\u5728\u52a0\u8f7d\u8fd9\u4e2a\u9875\u9762\u65f6\uff0c\u4f60\u7684\u6d4f\u89c8\u5668\u5df2\u7ecf\u9a8c\u8bc1\u4e86\u8981\u8bbf\u95ee\u7684\u7f51\u7ad9\u670d\u52a1\u7aef\u7684\u8eab\u4efd\uff0c\u4f46\u670d\u52a1\u7aef\u5e76\u6ca1\u6709\u9a8c\u8bc1\u4f60\u7684\u6d4f\u89c8\u5668\u7684\u8eab\u4efd\u3002\u5b83\u5b9e\u9645\u4e0a\u5e76\u4e0d\u5173\u5fc3\u4f60\u7684\u6d4f\u89c8\u5668\u7684\u8eab\u4efd\u3002 \u5f53\u7136\uff0c\u4e0d\u9a8c\u8bc1\u5ba2\u6237\u7aef\u8eab\u4efd\u5bf9\u4e8e\u63d0\u4f9b\u7f51\u9875\u670d\u52a1\u662f\u6709\u610f\u4e49\u7684\uff0c\u4f46\u6709\u5f88\u591a\u7c7b\u578b\u7684\u901a\u4fe1\uff0c\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u4e5f\u5f88\u91cd\u8981\u3002\u4f8b\u5982 API \u8c03\u7528\uff1a\u5982\u679c\u4f60\u8c03\u7528\u50cf GitHub \u8fd9\u6837\u7684\u670d\u52a1\uff0c\u90a3\u4e48 GitHub \u9700\u8981\u77e5\u9053\u4f60\u662f\u8c01 \u2014\u2014 \u9664\u5176\u4ed6\u539f\u56e0\u5916\uff0c\u8fd9\u6837\u4ed6\u4eec\u5c31\u53ef\u4ee5\u7ed9\u4f60\u53d1\u9001\u8d26\u5355\u3002\u5982\u679c\u4e0d\u5411 GitHub \u63d0\u4f9b\u67d0\u79cd\u5ba2\u6237\u7aef\u8eab\u4efd\uff0c\u4f60\u5c31\u4e0d\u80fd\u5bf9 GitHub \u7684 API \u8fdb\u884c\u8c03\u7528\u3002 \u4f46 GitHub \u5e76\u4e0d\u4f7f\u7528 mTLS\u3002\u76f8\u53cd\uff0c\u4f60\u901a\u8fc7\u7ed9 GitHub \u4e00\u4e2a\u79d8\u5bc6\u7684\u8ba4\u8bc1\u4ee4\u724c\uff08token\uff09\u6765\u8ba4\u8bc1\u81ea\u5df1\uff0c \u8fd9\u4e2a\u4ee4\u724c\u662f\u521b\u5efa\u8d26\u6237\u65f6\u5206\u914d\u7ed9\u4f60\u7684\u3002\u5766\u7387\u5730\u8bf4\uff0cmTLS \u8bbe\u7f6e\u8d77\u6765\u5f88\u70e6\u4eba \uff08\u540e\u9762\u4f1a\u6709\u5f88\u591a\u8fd9\u65b9\u9762\u7684\u5185\u5bb9\uff09\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u63d0\u4f9b\u50cf GitHub \u8fd9\u6837\u7684\u516c\u5171 API\uff0c\u4f60\u53ef\u80fd\u4f1a\u53ea\u4f7f\u7528 auth token\u3002 \u7136\u800c\uff0c\u4f7f\u7528 mTLS \u7684\u8ba4\u8bc1\u6709\u4e00\u4e9b\u975e\u5e38\u5f3a\u5927\u7684 auth token \u65b9\u6cd5\u6ca1\u6709\u7684\u4f18\u52bf\u3002 \u9996\u5148\uff0cmTLS \u8ba4\u8bc1\u53ef\u4ee5\u5b8c\u5168\u5728\u5e94\u7528\u7a0b\u5e8f\u4e4b\u5916\u5b8c\u6210\uff0c\u4e0d\u9700\u8981\u4efb\u4f55\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u529f\u80fd\u6765\u521b\u5efa\u3001\u6ce8\u518c\u6216\u7ba1\u7406\u8eab\u4efd\u3002 \u4f7f\u7528 auth token \u65f6\uff0c\u5728\u4f60\u8fdb\u884c\u7b2c\u4e00\u6b21 GitHub API \u8c03\u7528\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u767b\u5f55\u7f51\u7ad9\uff0c\u521b\u5efa\u4e00\u4e2a\u8d26\u6237\uff0c\u83b7\u5f97\u4ee4\u724c\uff08\u5c3d\u7ba1\u8fd9\u4e2a\u5ba2\u6237\u7aef\u4ee4\u724c\u6d41\u7a0b\u6ca1\u6709\u4f7f\u7528 TLS \u5ba2\u6237\u7aef\u8ba4\u8bc1\uff0c\u4f46\u5b83\u4ecd\u7136\u4f9d\u9760 TLS \u670d\u52a1\u5668\u8ba4\u8bc1\u6765\u4fdd\u8bc1\u5b89\u5168\u3002TLS \u786e\u4fdd\u4ee4\u724c\u6765\u81ea GitHub \u800c\u4e0d\u662f\u4e00\u4e2a\u4f2a\u88c5\u8005\uff09\u3002 GitHub \u7684 API \u5fc5\u987b\u77e5\u9053\u8fd9\u4e2a auth token\uff0c\u5e76\u63d0\u4f9b\u5c06\u5176\u4f20\u9012\u7ed9 API \u8c03\u7528\u548c\u7ba1\u7406\u5b83\u7684\u65b9\u6cd5\u3002 \u4f46\u6709\u4e86 mTLS\uff0c \u4e00\u4e2a\u5168\u65b0\u7684\u5ba2\u6237\u7aef\u5c31\u53ef\u4ee5\u76f4\u63a5\u8ba4\u8bc1\u81ea\u5df1\uff0c\u5373\u4f7f\u4ece\u6ca1\u6709\u4eba\u89c1\u8fc7\u5b83 \u3002\u800c\u5e94\u7528\u7a0b\u5e8f\u4e0d\u9700\u8981\u77e5\u9053\u4efb\u4f55\u5173\u4e8e\u8ba4\u8bc1\u7684\u4e8b\u60c5\uff0c\u4e5f\u4e0d\u9700\u8981\u63d0\u4f9b\u7aef\u70b9\u6765\u7ba1\u7406\u8ba4\u8bc1\u3002 \u7efc\u4e0a\u6240\u8ff0\uff0c\u6211\u4eec\u770b\u5230 mTLS \u975e\u5e38\u9002\u5408\u4ee5\u4e0b\u60c5\u51b5\uff1a \u4f60\u9700\u8981\u5b89\u5168\u901a\u4fe1\uff1b \u4f60\u5173\u5fc3\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\uff1b \u4e0d\u60f3\u4e3a\u7ba1\u7406\u8eab\u4efd\u5efa\u7acb\u5e94\u7528\u7ea7\u6d41\u7a0b\uff1b \u4f60\u53ef\u4ee5\u7ba1\u7406\u5b9e\u9645\u5b9e\u65bd\u7684\u590d\u6742\u6027\u3002 \u6709\u79cd\u573a\u666f\u5177\u6709\u6240\u6709\u8fd9\u4e9b\u7279\u5f81\uff0c\u90a3\u5c31\u662f\u5fae\u670d\u52a1\uff01 \u4f7f\u7528 mTLS \u6765\u4fdd\u62a4\u5fae\u670d\u52a1\u7684\u5b89\u5168 mTLS \u662f\u4fdd\u8bc1\u5fae\u670d\u52a1\u4e4b\u95f4\u8de8\u670d\u52a1\u901a\u4fe1\u5b89\u5168\u7684\u597d\u65b9\u6cd5\uff0c\u539f\u56e0\u5c31\u5728\u4e0a\u9762\u3002 \u9996\u5148\uff0c\u4f60\u60f3\u8981\u5b89\u5168\u7684\u901a\u4fe1\u3002\u5f53\u6211\u4eec\u628a\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u62c6\u5206\u4e3a\u591a\u4e2a\u670d\u52a1\u65f6\uff0c\u6211\u4eec\u6700\u7ec8\u4f1a\u5728\u8fd9\u4e9b\u670d\u52a1\u4e4b\u95f4\u7684\u7f51\u7edc\u4e0a\u53d1\u9001\u654f\u611f\u6570\u636e\u3002\u4efb\u4f55\u80fd\u591f\u8fdb\u5165\u7f51\u7edc\u7684\u4eba\u90fd\u6709\u53ef\u80fd\u8bfb\u53d6\u8fd9\u4e9b\u654f\u611f\u6570\u636e\u5e76\u4f2a\u9020\u8bf7\u6c42\u3002 \u7b2c\u4e8c\uff0c\u4f60\u5173\u5fc3\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u3002\u9996\u5148\uff0c\u4f60\u8981\u786e\u4fdd\u4f60\u80fd\u77e5\u9053\u8c03\u7528\u662f\u4ec0\u4e48\u65f6\u5019\u53d1\u751f\u7684\uff0c\u4ee5\u4fbf\u8fdb\u884c\u8bca\u65ad\uff0c\u5e76\u6b63\u786e\u8bb0\u5f55\u6307\u6807\u7b49\u4e8b\u9879\u3002\u6b64\u5916\uff0c\u4f60\u53ef\u80fd\u60f3\u5bf9\u8fd9\u4e9b\u8eab\u4efd\u8fdb\u884c\u6388\u6743\uff08\u5141\u8bb8 A \u8c03\u7528 B \u5417\uff09\u3002\u6211\u4eec\u5c06\u5728\u540e\u9762\u8ba8\u8bba\u66f4\u591a\u5173\u4e8e\u6388\u6743\u7684\u95ee\u9898\u3002 \u7b2c\u4e09\uff0c\u4f60\u5e76\u4e0d\u771f\u7684\u60f3\u4e3a\u7ba1\u7406\u670d\u52a1\u8eab\u4efd\u5efa\u7acb\u5e94\u7528\u7ea7\u7684\u6d41\u7a0b\u3002\u8fd9\u4e0d\u662f\u4e1a\u52a1\u903b\u8f91\uff0c\u5f00\u53d1\u4eba\u5458\u7684\u65f6\u95f4\u6700\u597d\u7528\u5728\u5176\u4ed6\u5730\u65b9\u3002 \u6700\u540e\uff0c\u5982\u679c\u4f60\u63a7\u5236\u4e86\u5e73\u53f0\uff0c\u4f60\u5b9e\u9645\u4e0a\u53ef\u4ee5\u7ba1\u7406\u5b9e\u65bd mTLS \u7684\u590d\u6742\u6027\u3002\u6216\u8005\u81f3\u5c11\uff0c\u6bd4 GitHub \u505a\u5f97\u66f4\u597d\u3002\u5728\u6211\u4eec\u7684 GitHub \u4f8b\u5b50\u4e2d\uff0c\u6bcf\u4e2a\u7528\u6237\u90fd\u5fc5\u987b\u89e3\u51b3\u5bf9 GitHub \u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u7684\u96be\u9898\u3002\u8fd9\u4e2a\u6311\u6218\u8d8a\u96be\uff0c\u5bf9\u7528\u6237\u5c31\u8d8a\u4e0d\u5229\uff08\u5bf9 GitHub \u7684\u5e95\u7ebf\u4e5f\u8d8a\u4e0d\u5229\uff09\u3002\u4f46\u662f\uff0c\u5982\u679c\u6211\u4eec\u80fd\u5728\u5e73\u53f0\u5c42\u9762\u4e0a\u5b9e\u73b0 mTLS\uff0c\u6211\u4eec\u5c31\u80fd\u4e00\u6b21\u6027\u652f\u4ed8\u6210\u672c\uff0c\u800c\u4e0d\u662f\u4e3a\u6bcf\u4e2a\u670d\u52a1\u6216\u6bcf\u4e2a\u7528\u6237\u652f\u4ed8\u3002 \u7efc\u4e0a\u6240\u8ff0\uff0cmTLS \u975e\u5e38\u9002\u7528\u4e8e\u786e\u4fdd\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u5b89\u5168\u3002\u4f46\u662f\u6709\u4e00\u4e2a\u95ee\u9898\u3002 \u5b9e\u65bd TLS \u7684\u96be\u70b9\uff1a\u8bc1\u4e66\u7ba1\u7406 \u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u4e3a mTLS \u63cf\u7ed8\u4e86\u4e00\u5e45\u7f8e\u597d\u7684\u56fe\u666f\u3002\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u6109\u5feb\u5730\u76f8\u4e92\u8ba4\u8bc1\uff0c\u7136\u540e\u5b83\u4eec\u4e4b\u95f4\u7684\u901a\u4fe1\u5c31\u5b89\u5168\u4e86\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c \u963b\u788d mTLS \u5de5\u4f5c\u7684\u6700\u5927\u6311\u6218\u662f\u8bc1\u4e66\u7ba1\u7406 \u3002 TLS \u4e2d\u7684\u8ba4\u8bc1\u662f\u901a\u8fc7 \u516c\u94a5\u5bc6\u7801\u5b66\u548c\u516c\u94a5\u57fa\u7840\u8bbe\u65bd\uff08PKI\uff09\u8fdb\u884c\u7684 \u3002\u8fd9\u4e24\u8005\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u5de8\u5927\u7684\u8bdd\u9898\uff0c\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u6211\u4eec\u4e0d\u4f1a\u53bb\u8ba8\u8bba\u8fd9\u4e9b\u7ec6\u8282\u3002\u4f46\u7b80\u800c\u8a00\u4e4b\uff0c\u5b83\u4eec\u6d89\u53ca\u5927\u91cf\u7684\u8bc1\u4e66\u3002 TLS \u8ba4\u8bc1\u57fa\u4e8e X.509 \u8bc1\u4e66\u3002 X.509 \u8bc1\u4e66\u4e2d\u5305\u542b\u8eab\u4efd\u548c\u516c\u94a5 \u3002\u516c\u94a5\u6709\u4e00\u4e2a\u76f8\u5e94\u7684\u79c1\u94a5\uff0c\u5b83\u4e0d\u662f\u8bc1\u4e66\u7684\u4e00\u90e8\u5206\u3002TLS \u8ba4\u8bc1\u5206\u4e24\u6b65\uff0c \u7b2c\u4e00\u6b65\u662f\u5411\u5bf9\u65b9\u5c55\u793a\u4f60\u7684\u8bc1\u4e66\uff0c\u7136\u540e\u7528\u79c1\u94a5\u6765\u8bc1\u660e\u8bc1\u4e66\u4e2d\u5305\u542b\u7684\u8eab\u4efd\u5c5e\u4e8e\u4f60\uff08\u516c\u94a5\u5bc6\u7801\u5b66\u7684\u795e\u5947\u4e4b\u5904\u5728\u4e8e\uff0c\u4efb\u4f55\u590d\u5236\u8bc1\u4e66\u7684\u4eba\u90fd\u65e0\u6cd5\u8fdb\u884c\u8fd9\u79cd\u8bc1\u660e\uff0c\u56e0\u4e3a\u4ed6\u4eec\u6ca1\u6709\u79c1\u94a5\u3002\u56e0\u6b64\uff0c\u4f60\u53ef\u4ee5\u975e\u5e38\u81ea\u7531\u5730\u4f7f\u7528\u8bc1\u4e66\uff0c\u5305\u62ec\u901a\u8fc7\u660e\u6587\u6e20\u9053\u53d1\u9001\u8bc1\u4e66\u6216\u5c06\u5176\u5b58\u50a8\u5728\u516c\u5f00\u573a\u5408\uff09\u3002 X.509 \u8bc1\u4e66\u662f\u7531\u4e00\u4e2a \u8bc1\u4e66\u6388\u6743\u673a\u6784\uff08Certificate Authority\uff0c\u7b80\u79f0 CA\uff09 \u7b7e\u7f72\uff0c\u5176\u4e2d\u5305\u62ec\u53d7 CA \u4fe1\u4efb\u8be5\u7684\u8eab\u4efd\u3002 \u8bc1\u4e66\u7528\u4e8e TLS \u8ba4\u8bc1\u7684\u7b2c\u4e8c\u6b65\uff1a\u5982\u679c\u6709\u4eba\u5411\u4f60\u5c55\u793a\u4ed6\u4eec\u7684\u8eab\u4efd\u5e76\u8bc1\u660e\u4ed6\u4eec\u62e5\u6709\u8be5\u8eab\u4efd\uff0c\u4f60\u73b0\u5728\u5fc5\u987b\u51b3\u5b9a\u662f\u5426\u4fe1\u4efb\u8be5\u8eab\u4efd\u3002 TLS \u5728\u8fd9\u91cc\u4f7f\u7528\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u89c4\u5219\uff1a\u5982\u679c\u8bc1\u4e66\u662f\u7531 CA \u7b7e\u7f72\u7684\uff0c\u4e14\u4f60\u4fe1\u4efb\u8be5 CA\uff0c\u90a3\u4e48\u4f60\u5c31\u5e94\u8be5\u4fe1\u4efb\u8be5\u8eab\u4efd\u3002\u5982\u4f55\u9a8c\u8bc1 CA \u5bf9\u8bc1\u4e66\u7684\u7b7e\u540d\uff1f\u901a\u8fc7\u4f7f\u7528\u8be5 CA \u672c\u8eab\u7684 X.509 \u8bc1\u4e66\u3002\u600e\u4e48\u77e5\u9053\u662f\u5426\u5e94\u8be5\u4fe1\u4efb\u8be5 CA\uff1f \u55ef\uff0c\u8fd9\u4e2a\u5c31\u4e0e TLS \u534f\u8bae\u672c\u8eab\u65e0\u5173\uff0c\u4f60\u4f1a\u88ab\u5916\u754c\u544a\u77e5\u5e94\u8be5\u4fe1\u4efb\u5b83\uff08\u4f8b\u5982\uff0c\u4f60\u7684\u6d4f\u89c8\u5668\u5e26\u6709\u77e5\u540d\u516c\u5171 CA \u7684\u8bc1\u4e66\uff0c\u5982 Verisign\u3001Digicert \u7b49\uff0c\u8fd9\u4e9b\u8bc1\u4e66\u5728\u53d1\u5e03\u65f6\u88ab\u6253\u5305\u5728\u4e00\u8d77\u3002\u5f53\u4f60\u4e0b\u8f7d Firefox \u65f6\uff0c\u4f60\u76f8\u4fe1 Mozilla \u5df2\u7ecf\u628a\u6b63\u786e\u7684\u8bc1\u4e66\u653e\u8fdb\u4e86\u6d4f\u89c8\u5668\u3002\u5bf9\u4e8e\u96c6\u7fa4\u5185\u7684\u901a\u4fe1\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u6211\u4eec\u81ea\u5df1\u7684 CA\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u4e5f\u5fc5\u987b\u4ee5\u4e00\u79cd\u5b89\u5168\u7684\u65b9\u5f0f\uff0c\u5c06\u8fd9\u4e2a CA \u7684\u8bc1\u4e66\u5206\u53d1\u7ed9\u96c6\u7fa4\u7684\u6bcf\u4e2a\u90e8\u5206\uff0c\u8fd9\u4e9b\u90e8\u5206\u9700\u8981\u505a\u51fa\u4fe1\u4efb\u51b3\u5b9a\uff09\u3002 CA \u4e5f\u7b7e\u53d1\u8bc1\u4e66\u3002\u8981\u83b7\u5f97\u8bc1\u4e66\uff0c\u4f60\u9996\u5148\u8981\u521b\u5efa\u516c\u94a5\u548c\u79c1\u94a5\u5bf9\u3002\u4f60\u4fdd\u7559\u79c1\u94a5\uff0c\u55ef\uff0c\u79c1\u94a5 \u2014\u2014 \u5343\u4e07\u4e0d\u8981\u5728\u7f51\u7edc\u4e0a\u53d1\u9001\u79c1\u94a5 \u2014\u2014 \u4f60\u5411 CA \u53d1\u9001\u4e00\u4e2a\u5305\u542b\u516c\u94a5\u548c\u4f60\u8eab\u4efd\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff08Certificate Signing Request\uff0c\u7b80\u79f0 CSR\uff09\u3002 \u5982\u679c CA \u6279\u51c6\u4e86\u8fd9\u4e2a\u8bf7\u6c42\uff0c\u5b83\u5c31\u4f1a\u521b\u5efa\u548c\u7b7e\u7f72\u8bc1\u4e66\uff0c\u5e76\u628a\u8bc1\u4e66\u53d1\u9001\u7ed9\u4f60\u3002 \u6240\u4ee5\uff0c\u8bc1\u4e66\u7ba1\u7406\u5c31\u662f\u5c31\u6210\u4e86\u8bc1\u4e66\u521b\u5efa\u548c\u5206\u53d1\u6d41\u7a0b\u4e2d\u7684\u6311\u6218\u3002\u6211\u4eec\u9700\u8981\u786e\u4fdd\u6709\u4e00\u4e2a CA\uff0c\u6bcf\u4e2a\u670d\u52a1\u90fd\u53ef\u4ee5\u5411\u5176\u53d1\u9001 CSR\uff0c\u800c\u4e14 CA \u53ef\u4ee5\u628a\u8bc1\u4e66\u53d1\u9001\u7ed9\u670d\u52a1\u3002\u6211\u4eec\u8fd8\u9700\u8981\u786e\u4fdd CA \u7684\u5b89\u5168\uff0c\u6ca1\u6709\u4eba\u80fd\u591f\u8bbf\u95ee\u4efb\u4f55\u670d\u52a1\u7684\u79c1\u94a5\uff0c\u800c\u4e14\u6bcf\u4e2a\u670d\u52a1\u90fd\u77e5\u9053\u81ea\u5df1\u7684\u8eab\u4efd\uff0c\u800c\u4e14\u4e0d\u80fd\u88ab\u6539\u53d8\u3002 \u5728 Kubernetes \u8fd9\u6837\u7684\u73af\u5883\u4e2d\uff0c\u670d\u52a1\u5b9e\u9645\u4e0a\u662f\u4e00\u7ec4\u4e0d\u65ad\u53d8\u5316\u7684\u526f\u672c\uff0c\u53ef\u4ee5\u968f\u65f6\u521b\u5efa\u6216\u9500\u6bc1\uff0c\u6bcf\u4e2a\u526f\u672c\u90fd\u9700\u8981\u81ea\u5df1\u7684\u8bc1\u4e66\uff0c\u8fd9\u4f7f\u5f97\u8bc1\u4e66\u5206\u53d1\u7684\u6311\u6218\u66f4\u52a0\u4e25\u5cfb\u3002 \u800c\u4e14 \uff0c \u7531\u4e8e\u5728\u5b9e\u8df5\u4e2d\uff0c\u51cf\u5c11\u8bc1\u4e66\u66b4\u9732\u635f\u5931\uff08\u5373\u5f53\u6709\u4eba\u672a\u7ecf\u6388\u6743\u83b7\u5f97\u79d8\u94a5\u65f6\uff09 \u7684\u6700\u597d\u65b9\u6cd5\u662f\u8bc1\u4e66\u8f6e\u6362 \uff1a\u7f29\u77ed\u8bc1\u4e66\u7684\u5bff\u547d\uff0c\u5728\u8bc1\u4e66\u8fc7\u671f\u524d\u91cd\u65b0\u9881\u53d1\u3002\u8fd9\u610f\u5473\u7740\u6211\u4eec\u9700\u8981\u6bcf\u9694 n \u5c0f\u65f6\u4e3a\u6bcf\u4e2a\u526f\u672c\u91cd\u590d\u6574\u4e2a\u8bc1\u4e66\u8bf7\u6c42\u548c\u7b7e\u540d\u7684\u6d41\u7a0b\u3002 \u5982\u679c\u6211\u4eec\u60f3\u5728\u591a\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u6269\u5c55\u5b89\u5168\u901a\u4fe1\uff0c\u9700\u8981\u4e00\u79cd\u65b9\u6cd5\u6765\u786e\u4fdd\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u4ea7\u751f\u7684\u8eab\u4efd\u53ef\u4ee5\u88ab\u5176\u4ed6\u96c6\u7fa4\u6240\u4f7f\u7528\uff0c\u800c\u4e14\u5982\u679c\u67d0\u4e2a\u96c6\u7fa4\u88ab\u7834\u574f\uff0c\u6211\u4eec\u53ef\u4ee5\u7981\u7528\u8be5\u96c6\u7fa4\u800c\u4e0d\u7981\u7528\u5176\u4ed6\u96c6\u7fa4\uff0c\u8fd9\u5c31\u8fdb\u4e00\u6b65\u589e\u52a0\u4e86\u8bc1\u4e66\u7ba1\u7406\u7684\u590d\u6742\u6027\uff0c\u56e0\u4e3a\u8fd9\u5c06\u4ea7\u751f\u66f4\u591a\u7684\u8bc1\u4e66\u3002 \u603b\u4e4b\uff0c\u5b9e\u65bd mTLS \u6d89\u53ca\u5230\u7ba1\u7406\u5927\u91cf\u7684\u8bc1\u4e66\uff0c\u6d88\u8017\u5927\u91cf\u7684\u65f6\u95f4\u3002\u8fd9\u4e00\u6311\u6218\u7684\u590d\u6742\u6027\u4ee4\u4eba\u751f\u754f\u3002\u4f46\u5c3d\u7ba1\u5982\u6b64\uff0cmTLS \u5728 Kubernetes \u7684\u4e16\u754c\u91cc\u5df2\u7ecf\u770b\u5230\u4e86\u4e00\u4e9b\u590d\u5174\u7684\u8d8b\u52bf\u3002\u8fd9\u662f\u56e0\u4e3a\u6709\u4e00\u95e8\u6280\u672f\u4f7f mTLS \u53d8\u5f97\u53ef\u884c\uff1a\u670d\u52a1\u7f51\u683c\u3002 Kubernetes\u3001mTLS \u548c\u670d\u52a1\u7f51\u683c \u670d\u52a1\u7f51\u683c\u662f\u4e3a\u96c6\u7fa4\u5f00\u542f mTLS \u7684\u4e00\u4e2a\u7edd\u4f73\u7684\u673a\u5236\u3002\u5b83\u4e0d\u4ec5\u53ef\u4ee5\u5904\u7406\u8bc1\u4e66\u7ba1\u7406\u7684\u6311\u6218\uff0c\u8fd8\u53ef\u4ee5\u5904\u7406\u5efa\u7acb\u548c\u63a5\u6536 TLS \u8fde\u63a5\u672c\u8eab\u3002\u5b83\u4f7f\u5f97\u4e3a\u96c6\u7fa4\u6dfb\u52a0 mTLS \u6210\u4e3a\u4e00\u4e2a\u96f6\u914d\u7f6e\u7684\u64cd\u4f5c\uff1a\u5f53\u4f60\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88c5\u670d\u52a1\u7f51\u683c\u7684\u65f6\u5019\uff0c\u7f51\u683c\u5316\u7684 pod \u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u90fd\u81ea\u52a8\u88ab mTLS \u5316\u3002\u5bf9\u4e8e\u50cf mTLS \u8fd9\u6837\u590d\u6742\u7684\u4e1c\u897f\u6765\u8bf4\uff0c\u8fd9\u662f\u5f88\u4e0d\u53ef\u601d\u8bae\u7684\u3002 \u8fd9\u4e00\u5207\u4e4b\u6240\u4ee5\u80fd\u591f\u5b9e\u73b0\uff0c\u662f\u56e0\u4e3a Kubernetes \u4f7f\u4e00\u4e9b\u672c\u6765\u975e\u5e38\u590d\u6742\u7684\u4e8b\u60c5\uff0c\u5982 sidecar \u6a21\u5f0f\uff0c\u53d8\u5f97\u7b80\u5355\u6613\u884c\u3002\u5f97\u76ca\u4e8e Kubernetes\uff0c\u670d\u52a1\u7f51\u683c\u53ef\u4ee5\uff1a \u900f\u660e\u5730\u5c06\u4e00\u4e2a sidecar \u4ee3\u7406\u6ce8\u5165\u5230\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684 pod \u4e2d\uff0c\u5e76\u901a\u8fc7\u8be5\u4ee3\u7406\u8def\u7531\u6240\u6709\u8fdb\u51fa pod \u7684 TCP \u901a\u4fe1\u3002 \u5c06\u4e00\u4e2a\u5185\u90e8 CA \u4f5c\u4e3a\u5176\u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\uff0c\u7b7e\u53d1 TLS \u8bc1\u4e66\uff0c\u5e76\u5c06\u8be5 CA \u7684\u8bc1\u4e66\u5b89\u5168\u5730\u5206\u914d\u7ed9\u6240\u6709\u4ee3\u7406\u3002 \u4f7f\u7528\u8fd9\u4e2a CA \u5411\u6bcf\u4e2a\u4ee3\u7406\u53d1\u653e\u77ed\u671f\u7684\u8bc1\u4e66\uff0c\u4e0e pod \u7684 Kubernetes ServiceAccount \u8eab\u4efd\u76f8\u8054\u7cfb\u3002 \u6bcf\u9694 N \u5c0f\u65f6\u91cd\u65b0\u7b7e\u53d1\u8fd9\u4e9b\u8bc1\u4e66\u3002 \u8ba9\u6bcf\u4e2a\u4ee3\u7406\u5bf9\u6240\u6709\u4f7f\u7528\u8fd9\u4e9b\u8bc1\u4e66\u7684 pod \u7684\u8fde\u63a5\u6267\u884c mTLS\uff0c\u786e\u4fdd\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u53cc\u65b9\u90fd\u6709\u6709\u6548\u7684\u8eab\u4efd\u3002 \u5728\u8fde\u63a5\u8fdb\u5165\u5e94\u7528\u7a0b\u5e8f\u4e4b\u524d\uff0c\u4f7f\u7528\u8fd9\u4e9b\u8eab\u4efd\u5e94\u7528\u6388\u6743\u7b56\u7565\u3002 \u5f53\u7136\uff0c\u8fd9\u53ea\u662f\u4e00\u79cd\u7b80\u5316\u7684\u63cf\u8ff0\u3002\u4f8b\u5982\uff0cLinkerd \u5b9e\u9645\u4e0a\u4f7f\u7528\u4e86\u4e24\u7ea7 CA\uff0c\u4e00\u4e2a\u5728\u96c6\u7fa4\u5c42\u9762\uff0c\u4e00\u4e2a\u5728\u5168\u5c40\u5c42\u9762\uff0c\u4ee5\u4fbf\u5141\u8bb8\u8de8\u96c6\u7fa4\u901a\u4fe1\u3002Linkerd \u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a\u4fe1\u4efb\u6839\uff0c\u6240\u4ee5\u4f60\u4e5f\u53ef\u4ee5\u8f6e\u6d41\u4f7f\u7528 CA\u3002 \u5e38\u89c1\u95ee\u9898\uff1amTLS \u5b9e\u9645\u4e0a\u80fd\u4fdd\u62a4\u4ec0\u4e48\uff1f \u4e8b\u5b9e\u4e0a\uff0cmTLS \u53ea\u80fd\u7528\u4e8e\u9632\u6b62\u7279\u5b9a\u7684\u653b\u51fb\uff1a \u672a\u7ecf\u6388\u6743\u7684\u7f51\u7edc\u8bbf\u95ee\u3002\u963b\u6b62\u5165\u4fb5\u8005\u55c5\u63a2\u7f51\u7edc\u8bf7\u6c42\u4e2d\u7684\u5185\u5bb9\uff0c\u963b\u6b62\u5192\u5145\u670d\u52a1\u8fdb\u884c\u8bbf\u95ee \u3002 \u4f46\u662f\u6709\u5f88\u591a\u4e1c\u897f\u662f mTLS \u4e0d\u80fd\u4fdd\u62a4\u7684\uff0c\u4f8b\u5982\u672a\u7ecf\u6388\u6743\u4e3b\u673a\u8bbf\u95ee\u3002\u5982\u679c\u9ed1\u5ba2\u5165\u4fb5\u8fdb\u4e86\u4e3b\u673a\uff0cmTLS \u4fdd\u62a4\u5c31\u65e0\u6d4e\u4e8e\u4e8b\u4e86\uff1a\u5165\u4fb5\u8005\u53ef\u4ee5\u8bfb\u53d6\u5bc6\u5319\uff0c\u55c5\u63a2\u6216\u6b3a\u9a97\u8fde\u63a5\uff0c\u98a0\u8986 CA \u5e76\u9020\u6210\u7834\u574f\uff0c\u6216\u4efb\u4f55\u5176\u4ed6\u6076\u610f\u6d3b\u52a8\u3002 \u786e\u4fdd Kubernetes \u7684\u5b89\u5168\u5e76\u4e0d\u5bb9\u6613\uff0c\u5b9e\u9645\u4e0a mTLS \u53ea\u89e3\u51b3\u4e86 Kubernetes \u7684\u4e00\u5c0f\u90e8\u5206\u5b89\u5168\u6f0f\u6d1e\u3002 mTLS \u4e0e IPSec \u6216 Wireguard \u7b49\u7f51\u7edc\u5c42\u52a0\u5bc6\u76f8\u6bd4\u600e\u4e48\u6837\uff1f \u5728 Kubernetes \u4e2d\uff0c\u4e00\u4e9b CNI \u63d2\u4ef6\u5982 Calico \u548c Cilium \u53ef\u4ee5\u901a\u8fc7 IPSec \u6216 Wireguard \u7b49\u534f\u8bae\u63d0\u4f9b\u7f51\u7edc\u5c42\u52a0\u5bc6\u3002\u50cf\u670d\u52a1\u7f51\u683c\u4e00\u6837\uff0c\u8fd9\u79cd\u7f51\u7edc\u5c42\u52a0\u5bc6\u53ef\u4ee5\u63d0\u4f9b\u4f20\u8f93\u5c42\u52a0\u5bc6\uff0c\u800c\u5e94\u7528\u7a0b\u5e8f\u672c\u8eab\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u4e8b\u60c5\u3002 \u867d\u7136\u7f51\u7edc\u5c42\u52a0\u5bc6\u53ef\u4ee5\u4e0e mTLS \u7ed3\u5408\u4f7f\u7528\uff0c\u4f5c\u4e3a\u4e00\u79cd\u6df1\u5ea6\u9632\u5fa1\u7684\u5f62\u5f0f\uff0c\u4f46\u6709\u51e0\u4e2a\u539f\u56e0\u53ef\u4ee5\u8bf4\u660e\u7f51\u7edc\u5c42\u52a0\u5bc6\u4e0d\u8db3\u4ee5\u66ff\u4ee3 mTLS\u3002 \u5982\u4f60\u6240\u6599\uff0c\u7f51\u7edc\u5c42\u52a0\u5bc6\u7684\u6700\u5927\u7f3a\u70b9\u662f\u56f4\u7ed5\u8eab\u4efd\u7684\u3002\u56e0\u4e3a\u5b83\u4eec\u5728\u7f51\u7edc\u5c42\u5de5\u4f5c\uff0cWireguard \u548c IPSec \u53ea\u80fd\u63d0\u4f9b\u7f51\u7edc\u8eab\u4efd\uff0c\u800c\u4e0d\u662f\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u5b83\u4eec\u4e0d\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u672c\u8eab\u56fa\u6709\u7684\u8eab\u4efd\uff08\u6bd4\u5982 SPIFFE \u6216\u8005 Kubernetes \u7684 ServiceAccount\uff09\uff0c\u800c\u662f\u4f7f\u7528\u8be5\u5de5\u4f5c\u8d1f\u8f7d\u8fd0\u884c\u7684 IP \u5730\u5740\u3002 \u4f9d\u9760\u7f51\u7edc\u8eab\u4efd\u6709\u4e00\u7cfb\u5217\u7684\u95ee\u9898\uff0c\u5305\u62ec\uff1a \u8eab\u4efd\u7ec8\u6b62\u5728\u96c6\u7fa4\u8fb9\u754c\u3002Kubernetes \u4e2d\u7684 IP \u5730\u5740\u662f\u4ee5\u96c6\u7fa4\u4e3a\u8303\u56f4\u7684\uff0c\u5f53\u8de8\u8d8a\u96c6\u7fa4\u8fb9\u754c\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u5fc5\u987b\u60f3\u51fa\u53e6\u4e00\u79cd\u8eab\u4efd\u673a\u5236\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u6b63\u5728\u8fdb\u884c\u8de8\u96c6\u7fa4\u901a\u4fe1\uff0c\u6216\u8005\u60f3\u8981\u4e00\u4e2a\u6db5\u76d6\u975e Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u7684\u8eab\u4efd\u7cfb\u7edf\uff0cIP \u5730\u5740\u5c31\u4f1a\u843d\u7a7a\u3002 \u6ca1\u6709\u76f4\u63a5\u7684\u673a\u5236\u8fdb\u884c\u7ec6\u7c92\u5ea6\u7684\u6388\u6743\u3002\u7f51\u7edc\u5c42\u65b9\u6cd5\u4e0d\u80fd\u8bbf\u95ee\u4e03\u5c42\u4fe1\u606f\uff0c\u5982 HTTP \u8def\u7531\u3001\u52a8\u8bcd\u4ee5\u53ca gRPC \u65b9\u6cd5\uff08\u6709\u4e9b\u590d\u6742\u7684 CNI \u901a\u8fc7\u542f\u52a8\u4e00\u4e2a\u4e03\u5c42\u4ee3\u7406\u6765\u89e3\u6790\u6570\u636e\uff0c\u4ee5\u670d\u52a1\u7f51\u683c\u6a21\u5f0f\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff09\u3002 \u8fd9\u4e0d\u662f\u96f6\u4fe1\u4efb\u3002\u96f6\u4fe1\u4efb\u7684\u5b89\u5168\u6a21\u5f0f\u8981\u6c42\u6211\u4eec\u5c06\u5b89\u5168\u8fb9\u754c\u8f6c\u79fb\u5230\u5c3d\u53ef\u80fd\u7ec6\u7684\u5c42\u6b21\u3002\u5728 Kubernetes \u4e2d\uff0c\u8fd9\u4e2a\u5355\u4f4d\u5c31\u662f pod\u3002\u6709\u4e86\u670d\u52a1\u7f51\u683c\u7684 mTLS\uff0c\u4f60\u7684\u5b89\u5168\u8fb9\u754c\u5c31\u5728 pod \u5c42\u9762\uff0c\u4f46\u5bf9\u4e8e\u7f51\u7edc\u5c42\u7684\u52a0\u5bc6\uff0c\u4f60\u7684\u5b89\u5168\u8fb9\u754c\u6700\u591a\u53ea\u80fd\u5728\u4e3b\u673a\u5c42\u9762\u6267\u884c\uff1b\u4f60\u5fc5\u987b\u4fe1\u4efb\u7f51\u7edc\uff0c\u7b49\u7b49\u3002","title":"\u7b2c\u516d\u8282 Kubernetes \u7684 mTLS \u6307\u5357"},{"location":"chap9/6k8s_mtls/#6-kubernetes-mtls","text":"","title":"6 Kubernetes \u7684 mTLS \u6307\u5357"},{"location":"chap9/6k8s_mtls/#_1","text":"Mutual TLS\uff08\u53cc\u5411 TLS\uff09\uff0c\u6216\u79f0 mTLS\uff0c\u662f Kubernetes \u4e2d\u7684\u4e00\u4e2a\u70ed\u95e8\u8bdd\u9898\uff0c\u5c24\u5176\u662f\u5bf9\u4e8e\u90a3\u4e9b\u8d1f\u8d23\u4e3a\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u4f20\u8f93\u5c42\u52a0\u5bc6\u7684\u4eba\u6765\u8bf4\u3002\u4f46\u662f\uff0c\u4f60\u6709\u6ca1\u6709\u8003\u8651\u8fc7\uff0c\u4ec0\u4e48\u662f mTLS\uff0c\u5b83\u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u5b89\u5168\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981 mTLS\uff1f","title":"\u7b80\u4ecb"},{"location":"chap9/6k8s_mtls/#mtls","text":"\u5bf9\u4e8e\u5e38\u89c4 TLS\uff0c\u53ea\u9700\u8981\u670d\u52a1\u7aef\u8ba4\u8bc1\uff0cmTLS \u76f8\u5bf9\u6765\u8bf4\u6709\u4e00\u4e2a\u989d\u5916\u7684\u89c4\u5b9a\uff1a \u5ba2\u6237\u7aef\u4e5f\u8981\u7ecf\u8fc7\u8ba4\u8bc1 \u3002\u4f46\u8fd9\u610f\u5473\u7740\u4ec0\u4e48\uff0c\u4e3a\u4ec0\u4e48\u8981\u8fd9\u6837\u505a\u5462\uff1f \u5728\u56de\u7b54\u8fd9\u4e9b\u95ee\u9898\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u5bf9 TLS \u6709\u4e00\u4e2a\u57fa\u672c\u7684\u4e86\u89e3\u3002 TLS \u662f\u4e00\u4e2a\u4f20\u8f93\u5c42\u534f\u8bae\uff0c\u65e8\u5728\u4e3a TCP \u8fde\u63a5\u63d0\u4f9b\u5b89\u5168\u4fdd\u969c\uff08\u6211\u4eec\u5c06\u5728\u4e0b\u9762\u770b\u5230\u5b89\u5168\u7684\u786e\u5207\u542b\u4e49\uff09 \u3002TLS \u5728\u4f20\u8f93\u5c42\u5de5\u4f5c\uff0c\u53ef\u4ee5\u4e0e\u4efb\u4f55\u4f7f\u7528 TCP \u7684\u5e94\u7528\u5c42\u534f\u8bae\u7ed3\u5408\u4f7f\u7528\u3002 \u4f8b\u5982\uff0cHTTPS \u662f HTTP \u4e0e TLS \u7684\u7ed3\u5408\uff08HTTPS \u4e2d\u7684 S \u6307\u7684\u662f SSL\uff0c\u5373 TLS \u7684\u524d\u8eab\uff09\uff0c HTTP \u4e0d\u9700\u8981\u505a\u4efb\u4f55\u6539\u53d8\u6765\u9002\u5e94 TLS \uff08\u81f3\u5c11\uff0c\u5728\u534f\u8bae\u5c42\u9762\u3002 \u5728\u5b9e\u8df5\u4e2d\uff0c\u968f\u7740 HTTPS \u7684\u5f15\u5165\uff0cHTTP \u7684\u4f7f\u7528\u65b9\u5f0f\u80af\u5b9a\u5df2\u7ecf\u53d1\u751f\u4e86\u53d8\u5316\u3002\u4f8b\u5982\uff0c\u50cf HSTS \u8fd9\u6837\u7684\u529f\u80fd\u73b0\u5728\u88ab\u7528\u6765\u9632\u6b62 HTTPS \u53ef\u80fd\u53d1\u751f\u7684\u67d0\u4e9b\u7c7b\u578b\u7684\u653b\u51fb\uff09\u3002 \u56e0\u4e3a TLS \u4e2d\u5b58\u5728\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u4f7f\u5f97\u5176\u4ece\u5b89\u5168\u7684\u89d2\u5ea6\u6765\u770b\u662f\u4e0d\u7406\u60f3\u7684\u3002TLS \u89c4\u8303\u590d\u6742\uff0c\u800c\u4e14\u6ca1\u6709\u5f97\u5230\u5145\u5206\u7684\u8bf4\u660e\uff0c\u6709\u4e9b\u5730\u65b9\u5e76\u6ca1\u6709\u771f\u6b63\u7684\u610f\u4e49\uff0c\u800c\u4e14\u4e0d\u7ba1\u600e\u6837\uff0c\u5b9e\u73b0\u8d77\u6765\u4e5f\u4e0d\u4f1a 100% \u7b26\u5408 TLS \u89c4\u8303\u3002","title":"\u4ec0\u4e48\u662f mTLS\uff1f"},{"location":"chap9/6k8s_mtls/#tls","text":"\u5927\u591a\u6570\u4eba\u628a TLS \u4e0e\u52a0\u5bc6\u8054\u7cfb\u8d77\u6765\u3002\u4f46 TLS \u4e0d\u4ec5\u4ec5\u662f\u8fd9\u6837\u3002TLS \u4e3a\u8fde\u63a5\u63d0\u4f9b\u4e86\u4e09\u79cd\u5b89\u5168\u4fdd\u8bc1\uff1a \u771f\u5b9e\u6027 \uff1a\u4efb\u4f55\u4e00\u65b9\u90fd\u80fd\u8bc1\u660e\u4ed6\u4eec\u662f\u81ea\u5df1\u6240\u58f0\u79f0\u7684\u8eab\u4efd\u3002 \u4fdd\u5bc6\u6027 \uff1a\u5176\u4ed6\u4eba\u65e0\u6cd5\u770b\u5230\u6b63\u5728\u4ea4\u6362\u7684\u6570\u636e\u3002 \u5b8c\u6574\u6027 \uff1a\u6536\u5230\u7684\u6570\u636e\u4e0e\u53d1\u9001\u7684\u6570\u636e\u76f8\u540c\u3002 \u56e0\u6b64\uff0c\u867d\u7136 TLS \u786e\u5b9e\u7ed9\u4f60\u63d0\u4f9b\u4e86\u52a0\u5bc6 \u2014\u2014 \u8fd9\u5c31\u662f\u5b83\u5b9e\u73b0\u4fdd\u5bc6\u7684\u65b9\u5f0f \u2014\u2014 \u4f46\u4ece TLS \u7684\u89d2\u5ea6\u6765\u770b\uff0c\u8fd9\u5bf9\u5b89\u5168\u901a\u4fe1\u6765\u8bf4\u662f\u4e0d\u591f\u7684\uff1a \u4f60\u9700\u8981\u6240\u6709\u8fd9\u4e09\u79cd\u5c5e\u6027\u3002\u5982\u679c\u4f60\u6ca1\u6709\u771f\u5b9e\u6027\uff0c\u90a3\u4e48\u6709\u4eba\u5c31\u53ef\u4ee5\u5728\u8fde\u63a5\u7684\u53e6\u4e00\u7aef\u8fdb\u884c\u6b3a\u9a97\u3002\u5982\u679c\u4f60\u6ca1\u6709\u5b8c\u6574\u6027\uff0c\u90a3\u4e48\u6709\u4eba\u53ef\u4ee5\u4fee\u6539\u901a\u4fe1\u4e2d\u7684\u5173\u952e\u4fe1\u606f\u3002\u5982\u679c\u4f60\u6ca1\u6709\u4fdd\u5bc6\u6027\uff0c\u90a3\u4e48\u4efb\u4f55\u4eba\u90fd\u53ef\u4ee5\u76d1\u542c\u3002","title":"TLS \u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u5b89\u5168\u6027\uff1f"},{"location":"chap9/6k8s_mtls/#mtls_1","text":"\u56de\u5230\u6211\u4eec\u6700\u521d\u7684\u5b9a\u4e49\uff1amTLS \u662f\u7b80\u5355\u7684\u5e38\u89c4 TLS\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u989d\u5916\u7684\u89c4\u5b9a\uff0c\u5373\u5ba2\u6237\u7aef\u4e5f\u8981\u7ecf\u8fc7\u8ba4\u8bc1\u3002\u6709\u4e86\u5bf9 TLS \u7684\u57fa\u672c\u4e86\u89e3\uff0c\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u89e3\u6790\u8fd9\u4e2a\u58f0\u660e\u4e86\u3002TLS \u4fdd\u8bc1\u4e86\u771f\u5b9e\u6027\uff0c\u4f46\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8fd9\u53ea\u53d1\u751f\u5728\u4e00\u4e2a\u65b9\u5411\u4e0a\uff1a \u5ba2\u6237\u7aef\u5bf9\u670d\u52a1\u5668\u8fdb\u884c\u8ba4\u8bc1\uff0c\u4f46\u670d\u52a1\u5668\u5e76\u4e0d\u5bf9\u5ba2\u6237\u7aef\u8fdb\u884c\u8ba4\u8bc1 \u3002 \u4e3a\u4ec0\u4e48 TLS \u7684\u9ed8\u8ba4\u53ea\u5728\u4e00\u4e2a\u65b9\u5411\u8fdb\u884c\u8ba4\u8bc1\uff1f \u56e0\u4e3a\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u5f80\u5f80\u662f\u4e0d\u76f8\u5173\u7684 \u3002\u4f8b\u5982\uff0c\u5728\u52a0\u8f7d\u8fd9\u4e2a\u9875\u9762\u65f6\uff0c\u4f60\u7684\u6d4f\u89c8\u5668\u5df2\u7ecf\u9a8c\u8bc1\u4e86\u8981\u8bbf\u95ee\u7684\u7f51\u7ad9\u670d\u52a1\u7aef\u7684\u8eab\u4efd\uff0c\u4f46\u670d\u52a1\u7aef\u5e76\u6ca1\u6709\u9a8c\u8bc1\u4f60\u7684\u6d4f\u89c8\u5668\u7684\u8eab\u4efd\u3002\u5b83\u5b9e\u9645\u4e0a\u5e76\u4e0d\u5173\u5fc3\u4f60\u7684\u6d4f\u89c8\u5668\u7684\u8eab\u4efd\u3002 \u5f53\u7136\uff0c\u4e0d\u9a8c\u8bc1\u5ba2\u6237\u7aef\u8eab\u4efd\u5bf9\u4e8e\u63d0\u4f9b\u7f51\u9875\u670d\u52a1\u662f\u6709\u610f\u4e49\u7684\uff0c\u4f46\u6709\u5f88\u591a\u7c7b\u578b\u7684\u901a\u4fe1\uff0c\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u4e5f\u5f88\u91cd\u8981\u3002\u4f8b\u5982 API \u8c03\u7528\uff1a\u5982\u679c\u4f60\u8c03\u7528\u50cf GitHub \u8fd9\u6837\u7684\u670d\u52a1\uff0c\u90a3\u4e48 GitHub \u9700\u8981\u77e5\u9053\u4f60\u662f\u8c01 \u2014\u2014 \u9664\u5176\u4ed6\u539f\u56e0\u5916\uff0c\u8fd9\u6837\u4ed6\u4eec\u5c31\u53ef\u4ee5\u7ed9\u4f60\u53d1\u9001\u8d26\u5355\u3002\u5982\u679c\u4e0d\u5411 GitHub \u63d0\u4f9b\u67d0\u79cd\u5ba2\u6237\u7aef\u8eab\u4efd\uff0c\u4f60\u5c31\u4e0d\u80fd\u5bf9 GitHub \u7684 API \u8fdb\u884c\u8c03\u7528\u3002 \u4f46 GitHub \u5e76\u4e0d\u4f7f\u7528 mTLS\u3002\u76f8\u53cd\uff0c\u4f60\u901a\u8fc7\u7ed9 GitHub \u4e00\u4e2a\u79d8\u5bc6\u7684\u8ba4\u8bc1\u4ee4\u724c\uff08token\uff09\u6765\u8ba4\u8bc1\u81ea\u5df1\uff0c \u8fd9\u4e2a\u4ee4\u724c\u662f\u521b\u5efa\u8d26\u6237\u65f6\u5206\u914d\u7ed9\u4f60\u7684\u3002\u5766\u7387\u5730\u8bf4\uff0cmTLS \u8bbe\u7f6e\u8d77\u6765\u5f88\u70e6\u4eba \uff08\u540e\u9762\u4f1a\u6709\u5f88\u591a\u8fd9\u65b9\u9762\u7684\u5185\u5bb9\uff09\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u63d0\u4f9b\u50cf GitHub \u8fd9\u6837\u7684\u516c\u5171 API\uff0c\u4f60\u53ef\u80fd\u4f1a\u53ea\u4f7f\u7528 auth token\u3002 \u7136\u800c\uff0c\u4f7f\u7528 mTLS \u7684\u8ba4\u8bc1\u6709\u4e00\u4e9b\u975e\u5e38\u5f3a\u5927\u7684 auth token \u65b9\u6cd5\u6ca1\u6709\u7684\u4f18\u52bf\u3002 \u9996\u5148\uff0cmTLS \u8ba4\u8bc1\u53ef\u4ee5\u5b8c\u5168\u5728\u5e94\u7528\u7a0b\u5e8f\u4e4b\u5916\u5b8c\u6210\uff0c\u4e0d\u9700\u8981\u4efb\u4f55\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u529f\u80fd\u6765\u521b\u5efa\u3001\u6ce8\u518c\u6216\u7ba1\u7406\u8eab\u4efd\u3002 \u4f7f\u7528 auth token \u65f6\uff0c\u5728\u4f60\u8fdb\u884c\u7b2c\u4e00\u6b21 GitHub API \u8c03\u7528\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u767b\u5f55\u7f51\u7ad9\uff0c\u521b\u5efa\u4e00\u4e2a\u8d26\u6237\uff0c\u83b7\u5f97\u4ee4\u724c\uff08\u5c3d\u7ba1\u8fd9\u4e2a\u5ba2\u6237\u7aef\u4ee4\u724c\u6d41\u7a0b\u6ca1\u6709\u4f7f\u7528 TLS \u5ba2\u6237\u7aef\u8ba4\u8bc1\uff0c\u4f46\u5b83\u4ecd\u7136\u4f9d\u9760 TLS \u670d\u52a1\u5668\u8ba4\u8bc1\u6765\u4fdd\u8bc1\u5b89\u5168\u3002TLS \u786e\u4fdd\u4ee4\u724c\u6765\u81ea GitHub \u800c\u4e0d\u662f\u4e00\u4e2a\u4f2a\u88c5\u8005\uff09\u3002 GitHub \u7684 API \u5fc5\u987b\u77e5\u9053\u8fd9\u4e2a auth token\uff0c\u5e76\u63d0\u4f9b\u5c06\u5176\u4f20\u9012\u7ed9 API \u8c03\u7528\u548c\u7ba1\u7406\u5b83\u7684\u65b9\u6cd5\u3002 \u4f46\u6709\u4e86 mTLS\uff0c \u4e00\u4e2a\u5168\u65b0\u7684\u5ba2\u6237\u7aef\u5c31\u53ef\u4ee5\u76f4\u63a5\u8ba4\u8bc1\u81ea\u5df1\uff0c\u5373\u4f7f\u4ece\u6ca1\u6709\u4eba\u89c1\u8fc7\u5b83 \u3002\u800c\u5e94\u7528\u7a0b\u5e8f\u4e0d\u9700\u8981\u77e5\u9053\u4efb\u4f55\u5173\u4e8e\u8ba4\u8bc1\u7684\u4e8b\u60c5\uff0c\u4e5f\u4e0d\u9700\u8981\u63d0\u4f9b\u7aef\u70b9\u6765\u7ba1\u7406\u8ba4\u8bc1\u3002 \u7efc\u4e0a\u6240\u8ff0\uff0c\u6211\u4eec\u770b\u5230 mTLS \u975e\u5e38\u9002\u5408\u4ee5\u4e0b\u60c5\u51b5\uff1a \u4f60\u9700\u8981\u5b89\u5168\u901a\u4fe1\uff1b \u4f60\u5173\u5fc3\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\uff1b \u4e0d\u60f3\u4e3a\u7ba1\u7406\u8eab\u4efd\u5efa\u7acb\u5e94\u7528\u7ea7\u6d41\u7a0b\uff1b \u4f60\u53ef\u4ee5\u7ba1\u7406\u5b9e\u9645\u5b9e\u65bd\u7684\u590d\u6742\u6027\u3002 \u6709\u79cd\u573a\u666f\u5177\u6709\u6240\u6709\u8fd9\u4e9b\u7279\u5f81\uff0c\u90a3\u5c31\u662f\u5fae\u670d\u52a1\uff01","title":"mTLS \u4ec0\u4e48\u65f6\u5019\u6709\u7528\uff1f"},{"location":"chap9/6k8s_mtls/#mtls_2","text":"mTLS \u662f\u4fdd\u8bc1\u5fae\u670d\u52a1\u4e4b\u95f4\u8de8\u670d\u52a1\u901a\u4fe1\u5b89\u5168\u7684\u597d\u65b9\u6cd5\uff0c\u539f\u56e0\u5c31\u5728\u4e0a\u9762\u3002 \u9996\u5148\uff0c\u4f60\u60f3\u8981\u5b89\u5168\u7684\u901a\u4fe1\u3002\u5f53\u6211\u4eec\u628a\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u62c6\u5206\u4e3a\u591a\u4e2a\u670d\u52a1\u65f6\uff0c\u6211\u4eec\u6700\u7ec8\u4f1a\u5728\u8fd9\u4e9b\u670d\u52a1\u4e4b\u95f4\u7684\u7f51\u7edc\u4e0a\u53d1\u9001\u654f\u611f\u6570\u636e\u3002\u4efb\u4f55\u80fd\u591f\u8fdb\u5165\u7f51\u7edc\u7684\u4eba\u90fd\u6709\u53ef\u80fd\u8bfb\u53d6\u8fd9\u4e9b\u654f\u611f\u6570\u636e\u5e76\u4f2a\u9020\u8bf7\u6c42\u3002 \u7b2c\u4e8c\uff0c\u4f60\u5173\u5fc3\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u3002\u9996\u5148\uff0c\u4f60\u8981\u786e\u4fdd\u4f60\u80fd\u77e5\u9053\u8c03\u7528\u662f\u4ec0\u4e48\u65f6\u5019\u53d1\u751f\u7684\uff0c\u4ee5\u4fbf\u8fdb\u884c\u8bca\u65ad\uff0c\u5e76\u6b63\u786e\u8bb0\u5f55\u6307\u6807\u7b49\u4e8b\u9879\u3002\u6b64\u5916\uff0c\u4f60\u53ef\u80fd\u60f3\u5bf9\u8fd9\u4e9b\u8eab\u4efd\u8fdb\u884c\u6388\u6743\uff08\u5141\u8bb8 A \u8c03\u7528 B \u5417\uff09\u3002\u6211\u4eec\u5c06\u5728\u540e\u9762\u8ba8\u8bba\u66f4\u591a\u5173\u4e8e\u6388\u6743\u7684\u95ee\u9898\u3002 \u7b2c\u4e09\uff0c\u4f60\u5e76\u4e0d\u771f\u7684\u60f3\u4e3a\u7ba1\u7406\u670d\u52a1\u8eab\u4efd\u5efa\u7acb\u5e94\u7528\u7ea7\u7684\u6d41\u7a0b\u3002\u8fd9\u4e0d\u662f\u4e1a\u52a1\u903b\u8f91\uff0c\u5f00\u53d1\u4eba\u5458\u7684\u65f6\u95f4\u6700\u597d\u7528\u5728\u5176\u4ed6\u5730\u65b9\u3002 \u6700\u540e\uff0c\u5982\u679c\u4f60\u63a7\u5236\u4e86\u5e73\u53f0\uff0c\u4f60\u5b9e\u9645\u4e0a\u53ef\u4ee5\u7ba1\u7406\u5b9e\u65bd mTLS \u7684\u590d\u6742\u6027\u3002\u6216\u8005\u81f3\u5c11\uff0c\u6bd4 GitHub \u505a\u5f97\u66f4\u597d\u3002\u5728\u6211\u4eec\u7684 GitHub \u4f8b\u5b50\u4e2d\uff0c\u6bcf\u4e2a\u7528\u6237\u90fd\u5fc5\u987b\u89e3\u51b3\u5bf9 GitHub \u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u7684\u96be\u9898\u3002\u8fd9\u4e2a\u6311\u6218\u8d8a\u96be\uff0c\u5bf9\u7528\u6237\u5c31\u8d8a\u4e0d\u5229\uff08\u5bf9 GitHub \u7684\u5e95\u7ebf\u4e5f\u8d8a\u4e0d\u5229\uff09\u3002\u4f46\u662f\uff0c\u5982\u679c\u6211\u4eec\u80fd\u5728\u5e73\u53f0\u5c42\u9762\u4e0a\u5b9e\u73b0 mTLS\uff0c\u6211\u4eec\u5c31\u80fd\u4e00\u6b21\u6027\u652f\u4ed8\u6210\u672c\uff0c\u800c\u4e0d\u662f\u4e3a\u6bcf\u4e2a\u670d\u52a1\u6216\u6bcf\u4e2a\u7528\u6237\u652f\u4ed8\u3002 \u7efc\u4e0a\u6240\u8ff0\uff0cmTLS \u975e\u5e38\u9002\u7528\u4e8e\u786e\u4fdd\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u901a\u4fe1\u5b89\u5168\u3002\u4f46\u662f\u6709\u4e00\u4e2a\u95ee\u9898\u3002","title":"\u4f7f\u7528 mTLS \u6765\u4fdd\u62a4\u5fae\u670d\u52a1\u7684\u5b89\u5168"},{"location":"chap9/6k8s_mtls/#tls_1","text":"\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u4e3a mTLS \u63cf\u7ed8\u4e86\u4e00\u5e45\u7f8e\u597d\u7684\u56fe\u666f\u3002\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u6109\u5feb\u5730\u76f8\u4e92\u8ba4\u8bc1\uff0c\u7136\u540e\u5b83\u4eec\u4e4b\u95f4\u7684\u901a\u4fe1\u5c31\u5b89\u5168\u4e86\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c \u963b\u788d mTLS \u5de5\u4f5c\u7684\u6700\u5927\u6311\u6218\u662f\u8bc1\u4e66\u7ba1\u7406 \u3002 TLS \u4e2d\u7684\u8ba4\u8bc1\u662f\u901a\u8fc7 \u516c\u94a5\u5bc6\u7801\u5b66\u548c\u516c\u94a5\u57fa\u7840\u8bbe\u65bd\uff08PKI\uff09\u8fdb\u884c\u7684 \u3002\u8fd9\u4e24\u8005\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u5de8\u5927\u7684\u8bdd\u9898\uff0c\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u6211\u4eec\u4e0d\u4f1a\u53bb\u8ba8\u8bba\u8fd9\u4e9b\u7ec6\u8282\u3002\u4f46\u7b80\u800c\u8a00\u4e4b\uff0c\u5b83\u4eec\u6d89\u53ca\u5927\u91cf\u7684\u8bc1\u4e66\u3002 TLS \u8ba4\u8bc1\u57fa\u4e8e X.509 \u8bc1\u4e66\u3002 X.509 \u8bc1\u4e66\u4e2d\u5305\u542b\u8eab\u4efd\u548c\u516c\u94a5 \u3002\u516c\u94a5\u6709\u4e00\u4e2a\u76f8\u5e94\u7684\u79c1\u94a5\uff0c\u5b83\u4e0d\u662f\u8bc1\u4e66\u7684\u4e00\u90e8\u5206\u3002TLS \u8ba4\u8bc1\u5206\u4e24\u6b65\uff0c \u7b2c\u4e00\u6b65\u662f\u5411\u5bf9\u65b9\u5c55\u793a\u4f60\u7684\u8bc1\u4e66\uff0c\u7136\u540e\u7528\u79c1\u94a5\u6765\u8bc1\u660e\u8bc1\u4e66\u4e2d\u5305\u542b\u7684\u8eab\u4efd\u5c5e\u4e8e\u4f60\uff08\u516c\u94a5\u5bc6\u7801\u5b66\u7684\u795e\u5947\u4e4b\u5904\u5728\u4e8e\uff0c\u4efb\u4f55\u590d\u5236\u8bc1\u4e66\u7684\u4eba\u90fd\u65e0\u6cd5\u8fdb\u884c\u8fd9\u79cd\u8bc1\u660e\uff0c\u56e0\u4e3a\u4ed6\u4eec\u6ca1\u6709\u79c1\u94a5\u3002\u56e0\u6b64\uff0c\u4f60\u53ef\u4ee5\u975e\u5e38\u81ea\u7531\u5730\u4f7f\u7528\u8bc1\u4e66\uff0c\u5305\u62ec\u901a\u8fc7\u660e\u6587\u6e20\u9053\u53d1\u9001\u8bc1\u4e66\u6216\u5c06\u5176\u5b58\u50a8\u5728\u516c\u5f00\u573a\u5408\uff09\u3002 X.509 \u8bc1\u4e66\u662f\u7531\u4e00\u4e2a \u8bc1\u4e66\u6388\u6743\u673a\u6784\uff08Certificate Authority\uff0c\u7b80\u79f0 CA\uff09 \u7b7e\u7f72\uff0c\u5176\u4e2d\u5305\u62ec\u53d7 CA \u4fe1\u4efb\u8be5\u7684\u8eab\u4efd\u3002 \u8bc1\u4e66\u7528\u4e8e TLS \u8ba4\u8bc1\u7684\u7b2c\u4e8c\u6b65\uff1a\u5982\u679c\u6709\u4eba\u5411\u4f60\u5c55\u793a\u4ed6\u4eec\u7684\u8eab\u4efd\u5e76\u8bc1\u660e\u4ed6\u4eec\u62e5\u6709\u8be5\u8eab\u4efd\uff0c\u4f60\u73b0\u5728\u5fc5\u987b\u51b3\u5b9a\u662f\u5426\u4fe1\u4efb\u8be5\u8eab\u4efd\u3002 TLS \u5728\u8fd9\u91cc\u4f7f\u7528\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u89c4\u5219\uff1a\u5982\u679c\u8bc1\u4e66\u662f\u7531 CA \u7b7e\u7f72\u7684\uff0c\u4e14\u4f60\u4fe1\u4efb\u8be5 CA\uff0c\u90a3\u4e48\u4f60\u5c31\u5e94\u8be5\u4fe1\u4efb\u8be5\u8eab\u4efd\u3002\u5982\u4f55\u9a8c\u8bc1 CA \u5bf9\u8bc1\u4e66\u7684\u7b7e\u540d\uff1f\u901a\u8fc7\u4f7f\u7528\u8be5 CA \u672c\u8eab\u7684 X.509 \u8bc1\u4e66\u3002\u600e\u4e48\u77e5\u9053\u662f\u5426\u5e94\u8be5\u4fe1\u4efb\u8be5 CA\uff1f \u55ef\uff0c\u8fd9\u4e2a\u5c31\u4e0e TLS \u534f\u8bae\u672c\u8eab\u65e0\u5173\uff0c\u4f60\u4f1a\u88ab\u5916\u754c\u544a\u77e5\u5e94\u8be5\u4fe1\u4efb\u5b83\uff08\u4f8b\u5982\uff0c\u4f60\u7684\u6d4f\u89c8\u5668\u5e26\u6709\u77e5\u540d\u516c\u5171 CA \u7684\u8bc1\u4e66\uff0c\u5982 Verisign\u3001Digicert \u7b49\uff0c\u8fd9\u4e9b\u8bc1\u4e66\u5728\u53d1\u5e03\u65f6\u88ab\u6253\u5305\u5728\u4e00\u8d77\u3002\u5f53\u4f60\u4e0b\u8f7d Firefox \u65f6\uff0c\u4f60\u76f8\u4fe1 Mozilla \u5df2\u7ecf\u628a\u6b63\u786e\u7684\u8bc1\u4e66\u653e\u8fdb\u4e86\u6d4f\u89c8\u5668\u3002\u5bf9\u4e8e\u96c6\u7fa4\u5185\u7684\u901a\u4fe1\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u6211\u4eec\u81ea\u5df1\u7684 CA\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u4e5f\u5fc5\u987b\u4ee5\u4e00\u79cd\u5b89\u5168\u7684\u65b9\u5f0f\uff0c\u5c06\u8fd9\u4e2a CA \u7684\u8bc1\u4e66\u5206\u53d1\u7ed9\u96c6\u7fa4\u7684\u6bcf\u4e2a\u90e8\u5206\uff0c\u8fd9\u4e9b\u90e8\u5206\u9700\u8981\u505a\u51fa\u4fe1\u4efb\u51b3\u5b9a\uff09\u3002 CA \u4e5f\u7b7e\u53d1\u8bc1\u4e66\u3002\u8981\u83b7\u5f97\u8bc1\u4e66\uff0c\u4f60\u9996\u5148\u8981\u521b\u5efa\u516c\u94a5\u548c\u79c1\u94a5\u5bf9\u3002\u4f60\u4fdd\u7559\u79c1\u94a5\uff0c\u55ef\uff0c\u79c1\u94a5 \u2014\u2014 \u5343\u4e07\u4e0d\u8981\u5728\u7f51\u7edc\u4e0a\u53d1\u9001\u79c1\u94a5 \u2014\u2014 \u4f60\u5411 CA \u53d1\u9001\u4e00\u4e2a\u5305\u542b\u516c\u94a5\u548c\u4f60\u8eab\u4efd\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff08Certificate Signing Request\uff0c\u7b80\u79f0 CSR\uff09\u3002 \u5982\u679c CA \u6279\u51c6\u4e86\u8fd9\u4e2a\u8bf7\u6c42\uff0c\u5b83\u5c31\u4f1a\u521b\u5efa\u548c\u7b7e\u7f72\u8bc1\u4e66\uff0c\u5e76\u628a\u8bc1\u4e66\u53d1\u9001\u7ed9\u4f60\u3002 \u6240\u4ee5\uff0c\u8bc1\u4e66\u7ba1\u7406\u5c31\u662f\u5c31\u6210\u4e86\u8bc1\u4e66\u521b\u5efa\u548c\u5206\u53d1\u6d41\u7a0b\u4e2d\u7684\u6311\u6218\u3002\u6211\u4eec\u9700\u8981\u786e\u4fdd\u6709\u4e00\u4e2a CA\uff0c\u6bcf\u4e2a\u670d\u52a1\u90fd\u53ef\u4ee5\u5411\u5176\u53d1\u9001 CSR\uff0c\u800c\u4e14 CA \u53ef\u4ee5\u628a\u8bc1\u4e66\u53d1\u9001\u7ed9\u670d\u52a1\u3002\u6211\u4eec\u8fd8\u9700\u8981\u786e\u4fdd CA \u7684\u5b89\u5168\uff0c\u6ca1\u6709\u4eba\u80fd\u591f\u8bbf\u95ee\u4efb\u4f55\u670d\u52a1\u7684\u79c1\u94a5\uff0c\u800c\u4e14\u6bcf\u4e2a\u670d\u52a1\u90fd\u77e5\u9053\u81ea\u5df1\u7684\u8eab\u4efd\uff0c\u800c\u4e14\u4e0d\u80fd\u88ab\u6539\u53d8\u3002 \u5728 Kubernetes \u8fd9\u6837\u7684\u73af\u5883\u4e2d\uff0c\u670d\u52a1\u5b9e\u9645\u4e0a\u662f\u4e00\u7ec4\u4e0d\u65ad\u53d8\u5316\u7684\u526f\u672c\uff0c\u53ef\u4ee5\u968f\u65f6\u521b\u5efa\u6216\u9500\u6bc1\uff0c\u6bcf\u4e2a\u526f\u672c\u90fd\u9700\u8981\u81ea\u5df1\u7684\u8bc1\u4e66\uff0c\u8fd9\u4f7f\u5f97\u8bc1\u4e66\u5206\u53d1\u7684\u6311\u6218\u66f4\u52a0\u4e25\u5cfb\u3002 \u800c\u4e14 \uff0c \u7531\u4e8e\u5728\u5b9e\u8df5\u4e2d\uff0c\u51cf\u5c11\u8bc1\u4e66\u66b4\u9732\u635f\u5931\uff08\u5373\u5f53\u6709\u4eba\u672a\u7ecf\u6388\u6743\u83b7\u5f97\u79d8\u94a5\u65f6\uff09 \u7684\u6700\u597d\u65b9\u6cd5\u662f\u8bc1\u4e66\u8f6e\u6362 \uff1a\u7f29\u77ed\u8bc1\u4e66\u7684\u5bff\u547d\uff0c\u5728\u8bc1\u4e66\u8fc7\u671f\u524d\u91cd\u65b0\u9881\u53d1\u3002\u8fd9\u610f\u5473\u7740\u6211\u4eec\u9700\u8981\u6bcf\u9694 n \u5c0f\u65f6\u4e3a\u6bcf\u4e2a\u526f\u672c\u91cd\u590d\u6574\u4e2a\u8bc1\u4e66\u8bf7\u6c42\u548c\u7b7e\u540d\u7684\u6d41\u7a0b\u3002 \u5982\u679c\u6211\u4eec\u60f3\u5728\u591a\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u6269\u5c55\u5b89\u5168\u901a\u4fe1\uff0c\u9700\u8981\u4e00\u79cd\u65b9\u6cd5\u6765\u786e\u4fdd\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u4ea7\u751f\u7684\u8eab\u4efd\u53ef\u4ee5\u88ab\u5176\u4ed6\u96c6\u7fa4\u6240\u4f7f\u7528\uff0c\u800c\u4e14\u5982\u679c\u67d0\u4e2a\u96c6\u7fa4\u88ab\u7834\u574f\uff0c\u6211\u4eec\u53ef\u4ee5\u7981\u7528\u8be5\u96c6\u7fa4\u800c\u4e0d\u7981\u7528\u5176\u4ed6\u96c6\u7fa4\uff0c\u8fd9\u5c31\u8fdb\u4e00\u6b65\u589e\u52a0\u4e86\u8bc1\u4e66\u7ba1\u7406\u7684\u590d\u6742\u6027\uff0c\u56e0\u4e3a\u8fd9\u5c06\u4ea7\u751f\u66f4\u591a\u7684\u8bc1\u4e66\u3002 \u603b\u4e4b\uff0c\u5b9e\u65bd mTLS \u6d89\u53ca\u5230\u7ba1\u7406\u5927\u91cf\u7684\u8bc1\u4e66\uff0c\u6d88\u8017\u5927\u91cf\u7684\u65f6\u95f4\u3002\u8fd9\u4e00\u6311\u6218\u7684\u590d\u6742\u6027\u4ee4\u4eba\u751f\u754f\u3002\u4f46\u5c3d\u7ba1\u5982\u6b64\uff0cmTLS \u5728 Kubernetes \u7684\u4e16\u754c\u91cc\u5df2\u7ecf\u770b\u5230\u4e86\u4e00\u4e9b\u590d\u5174\u7684\u8d8b\u52bf\u3002\u8fd9\u662f\u56e0\u4e3a\u6709\u4e00\u95e8\u6280\u672f\u4f7f mTLS \u53d8\u5f97\u53ef\u884c\uff1a\u670d\u52a1\u7f51\u683c\u3002","title":"\u5b9e\u65bd TLS \u7684\u96be\u70b9\uff1a\u8bc1\u4e66\u7ba1\u7406"},{"location":"chap9/6k8s_mtls/#kubernetesmtls","text":"\u670d\u52a1\u7f51\u683c\u662f\u4e3a\u96c6\u7fa4\u5f00\u542f mTLS \u7684\u4e00\u4e2a\u7edd\u4f73\u7684\u673a\u5236\u3002\u5b83\u4e0d\u4ec5\u53ef\u4ee5\u5904\u7406\u8bc1\u4e66\u7ba1\u7406\u7684\u6311\u6218\uff0c\u8fd8\u53ef\u4ee5\u5904\u7406\u5efa\u7acb\u548c\u63a5\u6536 TLS \u8fde\u63a5\u672c\u8eab\u3002\u5b83\u4f7f\u5f97\u4e3a\u96c6\u7fa4\u6dfb\u52a0 mTLS \u6210\u4e3a\u4e00\u4e2a\u96f6\u914d\u7f6e\u7684\u64cd\u4f5c\uff1a\u5f53\u4f60\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88c5\u670d\u52a1\u7f51\u683c\u7684\u65f6\u5019\uff0c\u7f51\u683c\u5316\u7684 pod \u4e4b\u95f4\u7684\u6240\u6709\u901a\u4fe1\u90fd\u81ea\u52a8\u88ab mTLS \u5316\u3002\u5bf9\u4e8e\u50cf mTLS \u8fd9\u6837\u590d\u6742\u7684\u4e1c\u897f\u6765\u8bf4\uff0c\u8fd9\u662f\u5f88\u4e0d\u53ef\u601d\u8bae\u7684\u3002 \u8fd9\u4e00\u5207\u4e4b\u6240\u4ee5\u80fd\u591f\u5b9e\u73b0\uff0c\u662f\u56e0\u4e3a Kubernetes \u4f7f\u4e00\u4e9b\u672c\u6765\u975e\u5e38\u590d\u6742\u7684\u4e8b\u60c5\uff0c\u5982 sidecar \u6a21\u5f0f\uff0c\u53d8\u5f97\u7b80\u5355\u6613\u884c\u3002\u5f97\u76ca\u4e8e Kubernetes\uff0c\u670d\u52a1\u7f51\u683c\u53ef\u4ee5\uff1a \u900f\u660e\u5730\u5c06\u4e00\u4e2a sidecar \u4ee3\u7406\u6ce8\u5165\u5230\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684 pod \u4e2d\uff0c\u5e76\u901a\u8fc7\u8be5\u4ee3\u7406\u8def\u7531\u6240\u6709\u8fdb\u51fa pod \u7684 TCP \u901a\u4fe1\u3002 \u5c06\u4e00\u4e2a\u5185\u90e8 CA \u4f5c\u4e3a\u5176\u63a7\u5236\u5e73\u9762\u7684\u4e00\u90e8\u5206\uff0c\u7b7e\u53d1 TLS \u8bc1\u4e66\uff0c\u5e76\u5c06\u8be5 CA \u7684\u8bc1\u4e66\u5b89\u5168\u5730\u5206\u914d\u7ed9\u6240\u6709\u4ee3\u7406\u3002 \u4f7f\u7528\u8fd9\u4e2a CA \u5411\u6bcf\u4e2a\u4ee3\u7406\u53d1\u653e\u77ed\u671f\u7684\u8bc1\u4e66\uff0c\u4e0e pod \u7684 Kubernetes ServiceAccount \u8eab\u4efd\u76f8\u8054\u7cfb\u3002 \u6bcf\u9694 N \u5c0f\u65f6\u91cd\u65b0\u7b7e\u53d1\u8fd9\u4e9b\u8bc1\u4e66\u3002 \u8ba9\u6bcf\u4e2a\u4ee3\u7406\u5bf9\u6240\u6709\u4f7f\u7528\u8fd9\u4e9b\u8bc1\u4e66\u7684 pod \u7684\u8fde\u63a5\u6267\u884c mTLS\uff0c\u786e\u4fdd\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u53cc\u65b9\u90fd\u6709\u6709\u6548\u7684\u8eab\u4efd\u3002 \u5728\u8fde\u63a5\u8fdb\u5165\u5e94\u7528\u7a0b\u5e8f\u4e4b\u524d\uff0c\u4f7f\u7528\u8fd9\u4e9b\u8eab\u4efd\u5e94\u7528\u6388\u6743\u7b56\u7565\u3002 \u5f53\u7136\uff0c\u8fd9\u53ea\u662f\u4e00\u79cd\u7b80\u5316\u7684\u63cf\u8ff0\u3002\u4f8b\u5982\uff0cLinkerd \u5b9e\u9645\u4e0a\u4f7f\u7528\u4e86\u4e24\u7ea7 CA\uff0c\u4e00\u4e2a\u5728\u96c6\u7fa4\u5c42\u9762\uff0c\u4e00\u4e2a\u5728\u5168\u5c40\u5c42\u9762\uff0c\u4ee5\u4fbf\u5141\u8bb8\u8de8\u96c6\u7fa4\u901a\u4fe1\u3002Linkerd \u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a\u4fe1\u4efb\u6839\uff0c\u6240\u4ee5\u4f60\u4e5f\u53ef\u4ee5\u8f6e\u6d41\u4f7f\u7528 CA\u3002","title":"Kubernetes\u3001mTLS \u548c\u670d\u52a1\u7f51\u683c"},{"location":"chap9/6k8s_mtls/#mtls_3","text":"\u4e8b\u5b9e\u4e0a\uff0cmTLS \u53ea\u80fd\u7528\u4e8e\u9632\u6b62\u7279\u5b9a\u7684\u653b\u51fb\uff1a \u672a\u7ecf\u6388\u6743\u7684\u7f51\u7edc\u8bbf\u95ee\u3002\u963b\u6b62\u5165\u4fb5\u8005\u55c5\u63a2\u7f51\u7edc\u8bf7\u6c42\u4e2d\u7684\u5185\u5bb9\uff0c\u963b\u6b62\u5192\u5145\u670d\u52a1\u8fdb\u884c\u8bbf\u95ee \u3002 \u4f46\u662f\u6709\u5f88\u591a\u4e1c\u897f\u662f mTLS \u4e0d\u80fd\u4fdd\u62a4\u7684\uff0c\u4f8b\u5982\u672a\u7ecf\u6388\u6743\u4e3b\u673a\u8bbf\u95ee\u3002\u5982\u679c\u9ed1\u5ba2\u5165\u4fb5\u8fdb\u4e86\u4e3b\u673a\uff0cmTLS \u4fdd\u62a4\u5c31\u65e0\u6d4e\u4e8e\u4e8b\u4e86\uff1a\u5165\u4fb5\u8005\u53ef\u4ee5\u8bfb\u53d6\u5bc6\u5319\uff0c\u55c5\u63a2\u6216\u6b3a\u9a97\u8fde\u63a5\uff0c\u98a0\u8986 CA \u5e76\u9020\u6210\u7834\u574f\uff0c\u6216\u4efb\u4f55\u5176\u4ed6\u6076\u610f\u6d3b\u52a8\u3002 \u786e\u4fdd Kubernetes \u7684\u5b89\u5168\u5e76\u4e0d\u5bb9\u6613\uff0c\u5b9e\u9645\u4e0a mTLS \u53ea\u89e3\u51b3\u4e86 Kubernetes \u7684\u4e00\u5c0f\u90e8\u5206\u5b89\u5168\u6f0f\u6d1e\u3002","title":"\u5e38\u89c1\u95ee\u9898\uff1amTLS \u5b9e\u9645\u4e0a\u80fd\u4fdd\u62a4\u4ec0\u4e48\uff1f"},{"location":"chap9/6k8s_mtls/#mtls-ipsec-wireguard","text":"\u5728 Kubernetes \u4e2d\uff0c\u4e00\u4e9b CNI \u63d2\u4ef6\u5982 Calico \u548c Cilium \u53ef\u4ee5\u901a\u8fc7 IPSec \u6216 Wireguard \u7b49\u534f\u8bae\u63d0\u4f9b\u7f51\u7edc\u5c42\u52a0\u5bc6\u3002\u50cf\u670d\u52a1\u7f51\u683c\u4e00\u6837\uff0c\u8fd9\u79cd\u7f51\u7edc\u5c42\u52a0\u5bc6\u53ef\u4ee5\u63d0\u4f9b\u4f20\u8f93\u5c42\u52a0\u5bc6\uff0c\u800c\u5e94\u7528\u7a0b\u5e8f\u672c\u8eab\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u4e8b\u60c5\u3002 \u867d\u7136\u7f51\u7edc\u5c42\u52a0\u5bc6\u53ef\u4ee5\u4e0e mTLS \u7ed3\u5408\u4f7f\u7528\uff0c\u4f5c\u4e3a\u4e00\u79cd\u6df1\u5ea6\u9632\u5fa1\u7684\u5f62\u5f0f\uff0c\u4f46\u6709\u51e0\u4e2a\u539f\u56e0\u53ef\u4ee5\u8bf4\u660e\u7f51\u7edc\u5c42\u52a0\u5bc6\u4e0d\u8db3\u4ee5\u66ff\u4ee3 mTLS\u3002 \u5982\u4f60\u6240\u6599\uff0c\u7f51\u7edc\u5c42\u52a0\u5bc6\u7684\u6700\u5927\u7f3a\u70b9\u662f\u56f4\u7ed5\u8eab\u4efd\u7684\u3002\u56e0\u4e3a\u5b83\u4eec\u5728\u7f51\u7edc\u5c42\u5de5\u4f5c\uff0cWireguard \u548c IPSec \u53ea\u80fd\u63d0\u4f9b\u7f51\u7edc\u8eab\u4efd\uff0c\u800c\u4e0d\u662f\u5de5\u4f5c\u8d1f\u8f7d\u8eab\u4efd\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u5b83\u4eec\u4e0d\u662f\u4f7f\u7528\u5de5\u4f5c\u8d1f\u8f7d\u672c\u8eab\u56fa\u6709\u7684\u8eab\u4efd\uff08\u6bd4\u5982 SPIFFE \u6216\u8005 Kubernetes \u7684 ServiceAccount\uff09\uff0c\u800c\u662f\u4f7f\u7528\u8be5\u5de5\u4f5c\u8d1f\u8f7d\u8fd0\u884c\u7684 IP \u5730\u5740\u3002 \u4f9d\u9760\u7f51\u7edc\u8eab\u4efd\u6709\u4e00\u7cfb\u5217\u7684\u95ee\u9898\uff0c\u5305\u62ec\uff1a \u8eab\u4efd\u7ec8\u6b62\u5728\u96c6\u7fa4\u8fb9\u754c\u3002Kubernetes \u4e2d\u7684 IP \u5730\u5740\u662f\u4ee5\u96c6\u7fa4\u4e3a\u8303\u56f4\u7684\uff0c\u5f53\u8de8\u8d8a\u96c6\u7fa4\u8fb9\u754c\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u5fc5\u987b\u60f3\u51fa\u53e6\u4e00\u79cd\u8eab\u4efd\u673a\u5236\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u6b63\u5728\u8fdb\u884c\u8de8\u96c6\u7fa4\u901a\u4fe1\uff0c\u6216\u8005\u60f3\u8981\u4e00\u4e2a\u6db5\u76d6\u975e Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u7684\u8eab\u4efd\u7cfb\u7edf\uff0cIP \u5730\u5740\u5c31\u4f1a\u843d\u7a7a\u3002 \u6ca1\u6709\u76f4\u63a5\u7684\u673a\u5236\u8fdb\u884c\u7ec6\u7c92\u5ea6\u7684\u6388\u6743\u3002\u7f51\u7edc\u5c42\u65b9\u6cd5\u4e0d\u80fd\u8bbf\u95ee\u4e03\u5c42\u4fe1\u606f\uff0c\u5982 HTTP \u8def\u7531\u3001\u52a8\u8bcd\u4ee5\u53ca gRPC \u65b9\u6cd5\uff08\u6709\u4e9b\u590d\u6742\u7684 CNI \u901a\u8fc7\u542f\u52a8\u4e00\u4e2a\u4e03\u5c42\u4ee3\u7406\u6765\u89e3\u6790\u6570\u636e\uff0c\u4ee5\u670d\u52a1\u7f51\u683c\u6a21\u5f0f\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff09\u3002 \u8fd9\u4e0d\u662f\u96f6\u4fe1\u4efb\u3002\u96f6\u4fe1\u4efb\u7684\u5b89\u5168\u6a21\u5f0f\u8981\u6c42\u6211\u4eec\u5c06\u5b89\u5168\u8fb9\u754c\u8f6c\u79fb\u5230\u5c3d\u53ef\u80fd\u7ec6\u7684\u5c42\u6b21\u3002\u5728 Kubernetes \u4e2d\uff0c\u8fd9\u4e2a\u5355\u4f4d\u5c31\u662f pod\u3002\u6709\u4e86\u670d\u52a1\u7f51\u683c\u7684 mTLS\uff0c\u4f60\u7684\u5b89\u5168\u8fb9\u754c\u5c31\u5728 pod \u5c42\u9762\uff0c\u4f46\u5bf9\u4e8e\u7f51\u7edc\u5c42\u7684\u52a0\u5bc6\uff0c\u4f60\u7684\u5b89\u5168\u8fb9\u754c\u6700\u591a\u53ea\u80fd\u5728\u4e3b\u673a\u5c42\u9762\u6267\u884c\uff1b\u4f60\u5fc5\u987b\u4fe1\u4efb\u7f51\u7edc\uff0c\u7b49\u7b49\u3002","title":"mTLS \u4e0e IPSec \u6216 Wireguard \u7b49\u7f51\u7edc\u5c42\u52a0\u5bc6\u76f8\u6bd4\u600e\u4e48\u6837\uff1f"},{"location":"chap9/8istio_mtls/","text":"\u7b2c\u4e03\u8282 \u5982\u4f55\u7406\u89e3 Istio \u4e2d\u7684 mTLS \u6d41\u91cf\u52a0\u5bc6\uff1f Istio \u670d\u52a1\u7f51\u683c\u53ef\u4ee5\u5e2e\u52a9\u4e91\u539f\u751f\u5e94\u7528\u5b9e\u73b0\u81ea\u52a8 mTLS\uff0c\u5b8c\u6210\u7f51\u683c\u5185\u7684\u6d41\u91cf\u52a0\u5bc6\uff0c\u6709\u52a9\u4e8e\u7f29\u5c0f\u4e91\u539f\u751f\u90e8\u7f72\u7684\u653b\u51fb\u9762\uff0c\u662f\u6784\u5efa\u96f6\u4fe1\u4efb\u5e94\u7528\u7f51\u7edc\u7684\u5173\u952e\u6846\u67b6\u3002\u4e3a\u4e86\u7406\u89e3 Istio \u4e2d\u7684 mTLS \u6d41\u91cf\u52a0\u5bc6\uff0c\u672c\u6587\u5c06\u5305\u62ec\u4ee5\u4e0b\u5185\u5bb9\uff1a \u4ec0\u4e48\u662f TLS \u548c mTLS\uff1f TLS\uff08Transport Layer Security\uff0c\u4f20\u8f93\u5c42\u5b89\u5168\u6027\uff09\u662f\u4e00\u79cd\u5e7f\u6cdb\u91c7\u7528\u7684\u5b89\u5168\u534f\u8bae\uff0c\u7528\u4e8e\u5728\u8054\u7f51\u8ba1\u7b97\u673a\u4e4b\u95f4\u5efa\u7acb\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u548c\u52a0\u5bc6\u7684\u94fe\u63a5\uff0c\u65e8\u5728\u4fc3\u8fdb\u4e92\u8054\u7f51\u901a\u4fe1\u7684\u79c1\u5bc6\u6027\u548c\u6570\u636e\u5b89\u5168\u6027\u3002 TLS \u4f5c\u4e3a SSL\uff08Secure Socket Layer\uff0c\u5b89\u5168\u5957\u63a5\u5b57\u5c42\uff09\u7684\u7ee7\u4efb\u8005\uff0c\u5b9e\u9645\u4e0a\u662f\u7531 SSL \u6539\u540d\u800c\u6765\uff0c\u56e0\u6b64\u4eba\u4eec\u7ecf\u5e38\u5c06 TLS/SSL \u6df7\u7528\uff0c\u5728\u672c\u6587\u4e2d\u6211\u4eec\u5c06\u7edf\u79f0\u4e3a TLS \u3002 TLS 1.0 \u53d1\u5e03\u4e8e 1999 \u5e74\uff0c\u6700\u65b0\u7248\u672c\u4e3a 1.3\uff08\u53d1\u5e03\u4e8e 2018 \u5e74 8 \u6708\uff09\uff0c1.0 \u548c 1.1 \u7248\u672c\u5df2\u5f03\u7528\u3002 \u6211\u4eec\u5728\u6d4f\u89c8\u7f51\u9875\u65f6\u770b\u5230\u7684 HTTPS \u5b9e\u9645\u4e0a\u5c31\u4f7f\u7528\u4e86 TLS\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002TLS \u662f\u5efa\u7acb\u5728 TCP \u4e4b\u4e0a\u7684\uff0c\u4f5c\u4e3a OSI \u6a21\u578b\u4e2d\u7684\u4f1a\u8bdd\u5c42\u3002\u4e3a\u4e86\u4fdd\u8bc1\u517c\u5bb9\u6027\uff0cTLS \u901a\u5e38\u4f7f\u7528 443 \u7aef\u53e3\uff0c\u4f46\u662f\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4efb\u610f\u7aef\u53e3\u3002 \u5f53\u5ba2\u6237\u7aef\u9700\u8981\u9a8c\u8bc1\u670d\u52a1\u7aef\u8eab\u4efd\uff0c\u4ee5\u9632\u4e2d\u95f4\u4eba\u653b\u51fb\u540c\u65f6\u4fdd\u8bc1\u901a\u4fe1\u5b89\u5168\u7684\u60c5\u51b5\u4e0b\uff0c\u5728\u548c\u670d\u52a1\u7aef\u901a\u4fe1\u65f6\u4f1a\u8981\u6c42 TLS \u52a0\u5bc6\u3002\u4e0b\u56fe\u5c55\u793a\u4e86\u7684\u662f TLS \u52a0\u5bc6\u901a\u4fe1\u7684\u6d41\u7a0b\u3002 \u670d\u52a1\u5668\u5411\u53d7\u4fe1\u4efb\u7684 CA\uff08\u8bc1\u4e66\u7ba1\u7406\u673a\u6784\uff09\u7533\u8bf7\u5e76\u83b7\u5f97\u8bc1\u4e66\uff08X.509 \u8bc1\u4e66\uff09\uff1b \u5ba2\u6237\u7aef\u5411\u670d\u52a1\u7aef\u53d1\u8d77\u8bf7\u6c42\uff0c\u5176\u4e2d\u5305\u542b\u5ba2\u6237\u7aef\u652f\u6301\u7684 TLS \u7248\u672c\u548c\u5bc6\u7801\u7ec4\u5408\u7b49\u4fe1\u606f\uff1b \u670d\u52a1\u5668\u56de\u5e94\u5ba2\u6237\u7aef\u8bf7\u6c42\u5e76\u9644\u4e0a\u6570\u5b57\u8bc1\u4e66 \uff1b \u5ba2\u6237\u7aef\u9a8c\u8bc1\u8bc1\u4e66\u7684\u72b6\u6001\u3001\u6709\u6548\u671f\u548c\u6570\u5b57\u7b7e\u540d\u7b49\u4fe1\u606f\uff0c\u786e\u8ba4\u670d\u52a1\u5668\u7684\u8eab\u4efd \uff1b \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4f7f\u7528\u5171\u4eab\u79d8\u94a5\u5b9e\u73b0\u52a0\u5bc6\u901a\u4fe1\uff1b \u4ece\u4ee5\u4e0a\u8fc7\u7a0b\u4e2d\u4f60\u4f1a\u53d1\u73b0\uff0c\u8bc1\u4e66\u662f\u4ee3\u8868\u670d\u52a1\u5668\u8eab\u4efd\u7684\u5173\u952e\u8981\u7d20\uff0c\u5bf9\u4e8e\u4e92\u8054\u7f51\u516c\u5f00\u670d\u52a1\uff0c\u670d\u52a1\u5668\u9700\u8981\u4f7f\u7528\u6743\u5a01\u8ba4\u8bc1\u7684 CA \u9881\u53d1\u7684\u8bc1\u4e66\uff0c\u800c\u5bf9\u4e8e\u79c1\u6709\u73af\u5883\u5185\u90e8\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u4f7f\u7528 PKI\uff08Private Key Infrastructure\uff0c\u79c1\u94a5\u57fa\u7840\u8bbe\u65bd\uff09\u6765\u7ba1\u7406\u8bc1\u4e66\u3002 \u4ec0\u4e48\u662f TLS \u7ec8\u6b62\uff1f TLS \u7ec8\u6b62\uff08TLS Termination\uff09\u6307\u7684\u662f\u5728\u5c06 TLS \u52a0\u5bc6\u6d41\u91cf\u4f20\u9012\u7ed9 Web \u670d\u52a1\u5668\u4e4b\u524d\u5bf9\u5176\u8fdb\u884c\u89e3\u5bc6\u7684\u8fc7\u7a0b\u3002 \u5c06 TLS \u6d41\u91cf\u5378\u8f7d\u5230\u5165\u53e3\u7f51\u5173\u6216\u4e13\u7528\u8bbe\u5907\u4e0a\uff0c\u53ef\u4ee5\u63d0\u9ad8 Web \u5e94\u7528\u7684\u6027\u80fd\uff0c\u540c\u65f6\u786e\u4fdd\u52a0\u5bc6\u6d41\u91cf\u7684\u5b89\u5168\u6027\u3002 \u4e00\u822c\u8fd0\u884c\u5728\u96c6\u7fa4\u5165\u53e3\u5904\uff0c\u5f53\u6d41\u91cf\u5230\u8fbe\u5165\u53e3\u5904\u65f6\u5b9e\u65bd TLS \u7ec8\u6b62\uff0c\u5165\u53e3\u4e0e\u96c6\u7fa4\u5185\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u901a\u4fe1\u5c06\u76f4\u63a5\u4f7f\u7528 HTTP \u660e\u6587\uff0c\u8fd9\u6837\u53ef\u4ee5\u63d0\u9ad8\u670d\u52a1\u6027\u80fd\u3002 Istio \u9ed8\u8ba4\u5728\u5165\u53e3\u7f51\u5173\u5904\u7ec8\u6b62 TLS\uff0c\u7136\u540e\u518d\u4e3a\u7f51\u683c\u5185\u7684\u670d\u52a1\u5f00\u542f mTLS\u3002 \u4f60\u4e5f\u53ef\u4ee5\u8ba9\u6d41\u91cf\u76f4\u901a\uff08passthrough\uff09\u5230\u540e\u7aef\u670d\u52a1\u5904\u7406\uff0c\u4f8b\u5982\uff1a apiVersion: networking.istio.io/v1beta1 kind: Gateway metadata: name: sample-gateway spec: servers: - port: number: 443 name: https protocol: HTTPS tls: mode: PASSTHROUGH Istio \u4e2d\u5982\u4f55\u5b9e\u73b0\u81ea\u52a8 mTLS\uff1f \u4e0b\u56fe\u4e2d\u5c55\u793a\u7684\u662f Istio \u5b89\u5168\u67b6\u6784\u56fe\uff0c\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\u5728\u5165\u53e3\u5904\u4f7f\u7528 JWS + TLS \u8ba4\u8bc1\u548c\u52a0\u5bc6\uff0c\u5728 Istio \u7f51\u683c\u5185\u90e8\u7684\u6240\u6709\u670d\u52a1\u95f4\u90fd\u5f00\u542f\u4e86 mTLS\u3002 Istio \u4e2d\u5185\u7f6e\u4e86 CA\uff0c \u4f7f\u7528 xDS \u4e2d\u7684 SDS\uff08Secret Discovery Service\uff0c\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\uff09\u5b9e\u73b0 SVID \u8bc1\u4e66\u7684\u7b7e\u53d1\u548c\u8f6e\u6362 \u3002Istio \u7f51\u683c\u5185\u7684 mTLS \u6d41\u7a0b\u5982\u4e0b\uff1a Sidecar \u4ee3\u66ff\u5de5\u4f5c\u8d1f\u8f7d\u5411 Istiod \u7533\u8bf7\u8bc1\u4e66\uff0cIstiod \u7b7e\u53d1 SVID \u8bc1\u4e66 \u5ba2\u6237\u7aef\u8bf7\u6c42\u88ab Pod \u5185\u7684 sidecar \u62e6\u622a \uff1b \u5ba2\u6237\u7aef sidecar \u4e0e\u670d\u52a1\u7aef sidecar \u5f00\u59cb mTLS \u63e1\u624b \u3002 \u5728\u63e1\u624b\u7684\u540c\u65f6\uff0c\u5ba2\u6237\u7aef sidecar \u4e2d\u7684 JWT \u548c\u8ba4\u8bc1\u8fc7\u6ee4\u5668\u5c06\u5bf9\u8bf7\u6c42\u7684\u8eab\u4efd\u8fdb\u884c\u8ba4\u8bc1\uff0c\u8ba4\u8bc1\u901a\u8fc7\u540e\u5c06\u8eab\u4efd\u5b58\u50a8\u5728\u8fc7\u6ee4\u5668\u5143\u6570\u636e\u4e2d\uff0c\u7136\u540e\u8bf7\u6c42\u7ecf\u8fc7\u6388\u6743\u8fc7\u6ee4\u5668\uff0c\u5224\u65ad\u8bf7\u6c42\u6743\u9650\u3002 \u82e5\u8bf7\u6c42\u901a\u8fc7\u4e86\u8ba4\u8bc1\u4e0e\u6388\u6743\uff0c\u5219\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u5f00\u59cb\u5efa\u7acb\u8fde\u63a5\u8fdb\u884c\u901a\u4fe1\u3002 Istio \u4e2d\u6709\u4e09\u4e2a\u8d44\u6e90\u5bf9\u8c61\u53ef\u7528\u4e8e\u914d\u7f6e\u670d\u52a1\u95f4\u7684\u8ba4\u8bc1\u4e0e\u6388\u6743\uff1a RequestAuthentication \uff1a\u7528\u4e8e\u5b9a\u4e49\u670d\u52a1\u652f\u6301\u7684\u8bf7\u6c42\u7ea7\u8ba4\u8bc1\u65b9\u5f0f\uff0c\u76ee\u524d\u53ea\u652f\u6301 JWT\uff1b PeerAuthentication \uff1a\u914d\u7f6e\u670d\u52a1\u95f4\u7684\u4f20\u8f93\u8ba4\u8bc1\u6a21\u5f0f\uff0c\u5982 STRICT \u3001 PERMISSIVE \u6216 DISABLE \u7b49\uff0c\u4ee5\u5f00\u542f mTLS \u6216\u660e\u6587\u8bf7\u6c42\uff1b AuthorizationPolicy \uff1a\u7528\u4e8e\u6388\u6743\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5b9a\u4e49\u8c01\u53ef\u4ee5\u505a\u4ec0\u4e48\uff1f\u4f8b\u5982\u4e3b\u4f53 A \u5141\u8bb8\uff08 ALLOW \uff09\u6216\u62d2\u7edd\uff08 DENY \uff09\u6765\u81ea\u4e3b\u4f53 B \u7684\u6d41\u91cf\uff1b \u5982\u4f55\u4f7f\u7528 Istio \u4e3a\u670d\u52a1\u5f00\u542f\u81ea\u52a8 mTLS\uff1f \u4f60\u53ef\u4ee5\u5728 PeerAuthentication \u4e2d\u6307\u5b9a\u5bf9\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u65bd\u7684 mTLS \u6a21\u5f0f\u3002\u5bf9\u7b49\u8ba4\u8bc1\u652f\u6301\u4ee5\u4e0b\u6a21\u5f0f\uff1a PERMISSIVE\uff1a\u9ed8\u8ba4\u503c\uff0c\u5de5\u4f5c\u8d1f\u8f7d\u53ef\u63a5\u53d7\u53cc\u5411 TLS \u6216\u7eaf\u6587\u672c\u6d41\u91cf\uff1b STRICT\uff1a\u5de5\u4f5c\u8d1f\u8f7d\u4ec5\u63a5\u53d7 mTLS \u6d41\u91cf\uff1b DISABLE\uff1a\u7981\u7528 mTLS\u3002\u4ece\u5b89\u5168\u89d2\u5ea6\u6765\u770b\uff0c\u9664\u975e\u4f60\u6709\u81ea\u5df1\u7684\u5b89\u5168\u89e3\u51b3\u65b9\u6848\uff0c\u5426\u5219\u4e0d\u5e94\u7981\u7528 mTLS\uff1b UNSET\uff1a\u4ece\u7236\u7ea7\u7ee7\u627f\uff0c\u4f18\u5148\u7ea7\u4e3a\u670d\u52a1\u7279\u5b9a > \u547d\u540d\u7a7a\u95f4\u8303\u56f4 > \u7f51\u683c\u8303\u56f4\u7684\u8bbe\u7f6e \uff1b Istio \u7684\u5bf9\u7b49\u8ba4\u8bc1\u9ed8\u8ba4\u4f7f\u7528 PERMISSIVE \u6a21\u5f0f\uff0c\u81ea\u52a8\u5c06 mTLS \u6d41\u91cf\u53d1\u9001\u5230\u8fd9\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5c06\u7eaf\u6587\u672c\u6d41\u91cf\u53d1\u9001\u5230\u6ca1\u6709 sidecar \u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 \u5728\u5c06 Kubernetes \u670d\u52a1\u7eb3\u5165 Istio \u7f51\u683c\u540e\uff0c\u4e3a\u4e86\u9632\u6b62\u670d\u52a1\u65e0\u6cd5\u901a\u8fc7 mTLS\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u4f7f\u7528 PERMISSIVE \u6a21\u5f0f\u3002\u5f53\u6211\u60f3\u4e3a\u67d0\u4e9b\u670d\u52a1\u5f00\u542f\u4e25\u683c\u7684 mTLS \u6a21\u5f0f\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u4e24\u79cd\u65b9\u5f0f\u4e4b\u4e00\uff1a \u4f7f\u7528 PeerAuthentication \u5b9a\u4e49\u6d41\u91cf\u5982\u4f55\u5728 sidecar \u4e4b\u95f4\u4f20\u8f93 \uff1b \u4f7f\u7528 DestinationRule \u5b9a\u4e49\u6d41\u91cf\u8def\u7531\u7b56\u7565\u4e2d\u7684 TLS \u8bbe\u7f6e\uff1b \u4e0b\u9762\u4ee5\u4e3a default \u547d\u540d\u7a7a\u95f4\u4e0b\u7684 reviews \u670d\u52a1\u8bbe\u7f6e mTLS \u4e3a\u4f8b\u8bf4\u660e\u3002 \u4f7f\u7528 PeerAuthentication \u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u8bbe\u7f6e mTLS \u4f60\u53ef\u4ee5\u4f7f\u7528 namespace \u548c selector \u6307\u5b9a\u67d0\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u67d0\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u5f00\u542f\u4e25\u683c\u7684 mTLS\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\uff1a apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: foo-peer-policy namespace: default spec: selector: matchLabels: app: reviews mtls: mode: STRICT \u4f60\u4e5f\u53ef\u4ee5\u7ed9\u5b89\u88c5 Istio \u7684\u547d\u540d\u7a7a\u95f4 istio-system \u8bbe\u7f6e\u4e25\u683c\u7684 mTLS\uff0c\u90a3\u6837\u4f1a\u4e3a\u7f51\u683c\u4e2d\u7684\u6240\u6709\u670d\u52a1\u5f00\u542f\u4e25\u683c\u7684 mTLS \u4f7f\u7528 DestinationRule \u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u8bbe\u7f6e mTLS DestinationRule \u7528\u4e8e\u8bbe\u7f6e\u6d41\u91cf\u8def\u7531\u7b56\u7565\uff0c\u4f8b\u5982\u8d1f\u8f7d\u5747\u8861\u3001\u5f02\u5e38\u70b9\u68c0\u6d4b\u3001TLS \u8bbe\u7f6e\u7b49\u3002\u5176\u4e2d TLS \u8bbe\u7f6e\u4e2d\u5305\u542b\u591a\u79cd\u6a21\u5f0f\uff0c\u4f7f\u7528 ISTIO_MUTUAL \u6a21\u5f0f\u53ef\u4ee5\u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u5f00\u542f Istio \u7684\u81ea\u52a8 TLS\uff0c\u5982\u4e0b\u6240\u793a\u3002 apiVersion: networking.istio.io/v1beta1 kind: DestinationRule metadata: name: reviews namespace: default spec: host: reviews trafficPolicy: tls: mode: ISTIO_MUTUAL \u4ec0\u4e48\u65f6\u5019\u7528 mTLS\uff1f \u4e92\u8054\u7f51\u5ba2\u6237\u7aef\u5bf9 Web \u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4e00\u822c\u4f7f\u7528\u5355\u5411 TLS\uff0c\u5373\u53ea\u9700\u8981\u670d\u52a1\u7aef\u63d0\u4f9b\u8eab\u4efd\u8bc1\u660e\uff0c\u800c\u4e0d\u5173\u5fc3\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u3002 \u5f53\u4f60\u9700\u8981\u9a8c\u8bc1\u5ba2\u6237\u7aef\u8eab\u4efd\u65f6\uff0c\u4f7f\u7528\u5355\u5411 TLS \u53ef\u4ee5\u4f7f\u7528\u5bc6\u7801\u3001token\u3001\u53cc\u56e0\u5b50\u8ba4\u8bc1\u7b49\u65b9\u5f0f\u3002\u4e0d\u8fc7\u8fd9\u6837\u7684\u8ba4\u8bc1\u65b9\u5f0f\u9700\u8981\u5e94\u7528\u7a0b\u5e8f\u5185\u90e8\u652f\u6301\uff0c\u800c\u53cc\u5411 TLS \u662f\u8fd0\u884c\u5728\u5e94\u7528\u7a0b\u5e8f\u4e4b\u5916\u7684\uff0c\u4e0d\u9700\u8981\u591a\u5e94\u7528\u903b\u8f91\u8fdb\u884c\u4fee\u6539\u3002 \u5f53\u4f60\u9700\u8981\u6b63\u5982\u4f60\u5728\u4e0a\u6587\u4e2d\u770b\u5230\u7684\uff0c\u5b9e\u65bd mTLS \u7684\u670d\u52a1\u95f4\u9700\u8981\u4ea4\u6362\u8bc1\u4e66\uff0c\u5f53\u670d\u52a1\u6570\u91cf\u53d8\u5927\u65f6\uff0c\u5c31\u9700\u8981\u7ba1\u7406\u5927\u91cf\u7684\u8bc1\u4e66\uff0c\u8fd9\u9700\u8981\u6d88\u8017\u5927\u91cf\u7684\u7cbe\u529b\uff0c\u4f7f\u7528\u670d\u52a1\u7f51\u683c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u5b9e\u73b0\u81ea\u52a8 mTLS\uff0c\u5f7b\u5e95\u89e3\u51b3\u8bc1\u4e66\u7ba1\u7406\u7684\u96be\u9898\u3002 \u4ec0\u4e48\u65f6\u5019\u4e0d\u7528 mTLS\uff1f \u867d\u7136 mTLS \u662f\u786e\u4fdd\u4e91\u539f\u751f\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u95f4\u901a\u4fe1\u5b89\u5168\u7684\u9996\u9009\u534f\u8bae\uff0c \u4f46\u662f\u5e94\u7528 mTLS \u9700\u8981\u5b8c\u6210\u590d\u6742\u7684\u5bf9\u79f0\u52a0\u5bc6\u3001\u89e3\u5bc6\u8fc7\u7a0b\uff0c\u8fd9\u5c06\u975e\u5e38\u8017\u65f6\u4e14\u6d88\u8017\u5927\u91cf\u7684 CPU \u8d44\u6e90 \u5bf9\u4e8e\u67d0\u4e9b\u5b89\u5168\u7ea7\u522b\u4e0d\u9ad8\u7684\u6d41\u91cf\uff0c\u5982\u679c\u6211\u4eec\u5728\u6d41\u91cf\u5165\u53e3\u5904\u7ec8\u6b62 TLS\uff0c\u5e76\u7f51\u683c\u5185\u90e8\u4ec5\u5bf9\u9488\u5bf9\u6027\u7684\u670d\u52a1\u5f00\u542f mTLS\uff0c\u5c31\u53ef\u4ee5\u52a0\u5feb\u8bf7\u6c42\u54cd\u5e94\u548c\u51cf\u5c11\u8ba1\u7b97\u8d44\u6e90\u6d88\u8017\u3002 \u53e6\u5916\u5f53\u6709\u7684\u670d\u52a1\u65e0\u6cd5\u83b7\u53d6\u8bc1\u4e66\uff0c\u4f8b\u5982 Kubelet \u4e0a\u4f7f\u7528 HTTP \u7684\u5065\u5eb7\u68c0\u67e5\uff0c\u65e0\u6cd5\u901a\u8fc7 TLS \u8bbf\u95ee\u670d\u52a1\u5185\u7684\u5065\u5eb7\u68c0\u67e5\u7aef\u70b9\uff0c\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u4e3a Pod \u7981\u7528\u63a2\u9488\u91cd\u5199 \u6700\u540e\u5f53\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u8bbf\u95ee\u4e00\u4e9b\u5916\u90e8\u670d\u52a1\u65f6\uff0c\u4e5f\u4e0d\u9700\u8981 mTLS\u3002 \u603b\u7ed3 mTLS \u5b9e\u73b0\u4e86\u7f51\u683c\u5185\u6d41\u91cf\u7684\u52a0\u5bc6\uff0c\u662f\u6784\u5efa\u96f6\u4fe1\u4efb\u5e94\u7528\u7f51\u7edc\u7684\u5173\u952e\u4e00\u6b65\u3002\u501f\u52a9 Istio \u6211\u4eec\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u4e3a Kubernetes \u4e2d\u7684\u670d\u52a1\u5f00\u542f\u81ea\u52a8 mTLS\uff0c\u7701\u53bb\u7ba1\u7406\u8bc1\u4e66\u7684\u9ebb\u70e6\u3002\u540c\u65f6\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u9488\u5bf9\u6027\u7684\u4e3a\u7f51\u683c\u5185\u7684\u90e8\u5206\u670d\u52a1\u5f00\u542f mTLS\uff0c\u4fbf\u4e8e\u6211\u4eec\u5c06 Kubernetes \u4e2d\u7684\u670d\u52a1\u8fc1\u79fb\u5230\u7f51\u683c\u5185\u3002\u5173\u4e8e Istio \u4e2d\u7684\u8bc1\u4e66\u7ba1\u7406\uff0c\u6211\u4eec\u5c06\u5728\u4eca\u540e\u7684\u535a\u5ba2\u4e2d\u518d\u505a\u8bf4\u660e\u3002","title":"\u7b2c\u4e03\u8282 \u5982\u4f55\u7406\u89e3 Istio \u4e2d\u7684 mTLS \u6d41\u91cf\u52a0\u5bc6\uff1f"},{"location":"chap9/8istio_mtls/#istio-mtls","text":"Istio \u670d\u52a1\u7f51\u683c\u53ef\u4ee5\u5e2e\u52a9\u4e91\u539f\u751f\u5e94\u7528\u5b9e\u73b0\u81ea\u52a8 mTLS\uff0c\u5b8c\u6210\u7f51\u683c\u5185\u7684\u6d41\u91cf\u52a0\u5bc6\uff0c\u6709\u52a9\u4e8e\u7f29\u5c0f\u4e91\u539f\u751f\u90e8\u7f72\u7684\u653b\u51fb\u9762\uff0c\u662f\u6784\u5efa\u96f6\u4fe1\u4efb\u5e94\u7528\u7f51\u7edc\u7684\u5173\u952e\u6846\u67b6\u3002\u4e3a\u4e86\u7406\u89e3 Istio \u4e2d\u7684 mTLS \u6d41\u91cf\u52a0\u5bc6\uff0c\u672c\u6587\u5c06\u5305\u62ec\u4ee5\u4e0b\u5185\u5bb9\uff1a","title":"\u7b2c\u4e03\u8282 \u5982\u4f55\u7406\u89e3 Istio \u4e2d\u7684 mTLS \u6d41\u91cf\u52a0\u5bc6\uff1f"},{"location":"chap9/8istio_mtls/#tls-mtls","text":"TLS\uff08Transport Layer Security\uff0c\u4f20\u8f93\u5c42\u5b89\u5168\u6027\uff09\u662f\u4e00\u79cd\u5e7f\u6cdb\u91c7\u7528\u7684\u5b89\u5168\u534f\u8bae\uff0c\u7528\u4e8e\u5728\u8054\u7f51\u8ba1\u7b97\u673a\u4e4b\u95f4\u5efa\u7acb\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u548c\u52a0\u5bc6\u7684\u94fe\u63a5\uff0c\u65e8\u5728\u4fc3\u8fdb\u4e92\u8054\u7f51\u901a\u4fe1\u7684\u79c1\u5bc6\u6027\u548c\u6570\u636e\u5b89\u5168\u6027\u3002 TLS \u4f5c\u4e3a SSL\uff08Secure Socket Layer\uff0c\u5b89\u5168\u5957\u63a5\u5b57\u5c42\uff09\u7684\u7ee7\u4efb\u8005\uff0c\u5b9e\u9645\u4e0a\u662f\u7531 SSL \u6539\u540d\u800c\u6765\uff0c\u56e0\u6b64\u4eba\u4eec\u7ecf\u5e38\u5c06 TLS/SSL \u6df7\u7528\uff0c\u5728\u672c\u6587\u4e2d\u6211\u4eec\u5c06\u7edf\u79f0\u4e3a TLS \u3002 TLS 1.0 \u53d1\u5e03\u4e8e 1999 \u5e74\uff0c\u6700\u65b0\u7248\u672c\u4e3a 1.3\uff08\u53d1\u5e03\u4e8e 2018 \u5e74 8 \u6708\uff09\uff0c1.0 \u548c 1.1 \u7248\u672c\u5df2\u5f03\u7528\u3002 \u6211\u4eec\u5728\u6d4f\u89c8\u7f51\u9875\u65f6\u770b\u5230\u7684 HTTPS \u5b9e\u9645\u4e0a\u5c31\u4f7f\u7528\u4e86 TLS\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002TLS \u662f\u5efa\u7acb\u5728 TCP \u4e4b\u4e0a\u7684\uff0c\u4f5c\u4e3a OSI \u6a21\u578b\u4e2d\u7684\u4f1a\u8bdd\u5c42\u3002\u4e3a\u4e86\u4fdd\u8bc1\u517c\u5bb9\u6027\uff0cTLS \u901a\u5e38\u4f7f\u7528 443 \u7aef\u53e3\uff0c\u4f46\u662f\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4efb\u610f\u7aef\u53e3\u3002 \u5f53\u5ba2\u6237\u7aef\u9700\u8981\u9a8c\u8bc1\u670d\u52a1\u7aef\u8eab\u4efd\uff0c\u4ee5\u9632\u4e2d\u95f4\u4eba\u653b\u51fb\u540c\u65f6\u4fdd\u8bc1\u901a\u4fe1\u5b89\u5168\u7684\u60c5\u51b5\u4e0b\uff0c\u5728\u548c\u670d\u52a1\u7aef\u901a\u4fe1\u65f6\u4f1a\u8981\u6c42 TLS \u52a0\u5bc6\u3002\u4e0b\u56fe\u5c55\u793a\u4e86\u7684\u662f TLS \u52a0\u5bc6\u901a\u4fe1\u7684\u6d41\u7a0b\u3002 \u670d\u52a1\u5668\u5411\u53d7\u4fe1\u4efb\u7684 CA\uff08\u8bc1\u4e66\u7ba1\u7406\u673a\u6784\uff09\u7533\u8bf7\u5e76\u83b7\u5f97\u8bc1\u4e66\uff08X.509 \u8bc1\u4e66\uff09\uff1b \u5ba2\u6237\u7aef\u5411\u670d\u52a1\u7aef\u53d1\u8d77\u8bf7\u6c42\uff0c\u5176\u4e2d\u5305\u542b\u5ba2\u6237\u7aef\u652f\u6301\u7684 TLS \u7248\u672c\u548c\u5bc6\u7801\u7ec4\u5408\u7b49\u4fe1\u606f\uff1b \u670d\u52a1\u5668\u56de\u5e94\u5ba2\u6237\u7aef\u8bf7\u6c42\u5e76\u9644\u4e0a\u6570\u5b57\u8bc1\u4e66 \uff1b \u5ba2\u6237\u7aef\u9a8c\u8bc1\u8bc1\u4e66\u7684\u72b6\u6001\u3001\u6709\u6548\u671f\u548c\u6570\u5b57\u7b7e\u540d\u7b49\u4fe1\u606f\uff0c\u786e\u8ba4\u670d\u52a1\u5668\u7684\u8eab\u4efd \uff1b \u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4f7f\u7528\u5171\u4eab\u79d8\u94a5\u5b9e\u73b0\u52a0\u5bc6\u901a\u4fe1\uff1b \u4ece\u4ee5\u4e0a\u8fc7\u7a0b\u4e2d\u4f60\u4f1a\u53d1\u73b0\uff0c\u8bc1\u4e66\u662f\u4ee3\u8868\u670d\u52a1\u5668\u8eab\u4efd\u7684\u5173\u952e\u8981\u7d20\uff0c\u5bf9\u4e8e\u4e92\u8054\u7f51\u516c\u5f00\u670d\u52a1\uff0c\u670d\u52a1\u5668\u9700\u8981\u4f7f\u7528\u6743\u5a01\u8ba4\u8bc1\u7684 CA \u9881\u53d1\u7684\u8bc1\u4e66\uff0c\u800c\u5bf9\u4e8e\u79c1\u6709\u73af\u5883\u5185\u90e8\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u4f7f\u7528 PKI\uff08Private Key Infrastructure\uff0c\u79c1\u94a5\u57fa\u7840\u8bbe\u65bd\uff09\u6765\u7ba1\u7406\u8bc1\u4e66\u3002","title":"\u4ec0\u4e48\u662f TLS \u548c mTLS\uff1f"},{"location":"chap9/8istio_mtls/#tls","text":"TLS \u7ec8\u6b62\uff08TLS Termination\uff09\u6307\u7684\u662f\u5728\u5c06 TLS \u52a0\u5bc6\u6d41\u91cf\u4f20\u9012\u7ed9 Web \u670d\u52a1\u5668\u4e4b\u524d\u5bf9\u5176\u8fdb\u884c\u89e3\u5bc6\u7684\u8fc7\u7a0b\u3002 \u5c06 TLS \u6d41\u91cf\u5378\u8f7d\u5230\u5165\u53e3\u7f51\u5173\u6216\u4e13\u7528\u8bbe\u5907\u4e0a\uff0c\u53ef\u4ee5\u63d0\u9ad8 Web \u5e94\u7528\u7684\u6027\u80fd\uff0c\u540c\u65f6\u786e\u4fdd\u52a0\u5bc6\u6d41\u91cf\u7684\u5b89\u5168\u6027\u3002 \u4e00\u822c\u8fd0\u884c\u5728\u96c6\u7fa4\u5165\u53e3\u5904\uff0c\u5f53\u6d41\u91cf\u5230\u8fbe\u5165\u53e3\u5904\u65f6\u5b9e\u65bd TLS \u7ec8\u6b62\uff0c\u5165\u53e3\u4e0e\u96c6\u7fa4\u5185\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u901a\u4fe1\u5c06\u76f4\u63a5\u4f7f\u7528 HTTP \u660e\u6587\uff0c\u8fd9\u6837\u53ef\u4ee5\u63d0\u9ad8\u670d\u52a1\u6027\u80fd\u3002 Istio \u9ed8\u8ba4\u5728\u5165\u53e3\u7f51\u5173\u5904\u7ec8\u6b62 TLS\uff0c\u7136\u540e\u518d\u4e3a\u7f51\u683c\u5185\u7684\u670d\u52a1\u5f00\u542f mTLS\u3002 \u4f60\u4e5f\u53ef\u4ee5\u8ba9\u6d41\u91cf\u76f4\u901a\uff08passthrough\uff09\u5230\u540e\u7aef\u670d\u52a1\u5904\u7406\uff0c\u4f8b\u5982\uff1a apiVersion: networking.istio.io/v1beta1 kind: Gateway metadata: name: sample-gateway spec: servers: - port: number: 443 name: https protocol: HTTPS tls: mode: PASSTHROUGH","title":"\u4ec0\u4e48\u662f TLS \u7ec8\u6b62\uff1f"},{"location":"chap9/8istio_mtls/#istio-mtls_1","text":"\u4e0b\u56fe\u4e2d\u5c55\u793a\u7684\u662f Istio \u5b89\u5168\u67b6\u6784\u56fe\uff0c\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\u5728\u5165\u53e3\u5904\u4f7f\u7528 JWS + TLS \u8ba4\u8bc1\u548c\u52a0\u5bc6\uff0c\u5728 Istio \u7f51\u683c\u5185\u90e8\u7684\u6240\u6709\u670d\u52a1\u95f4\u90fd\u5f00\u542f\u4e86 mTLS\u3002 Istio \u4e2d\u5185\u7f6e\u4e86 CA\uff0c \u4f7f\u7528 xDS \u4e2d\u7684 SDS\uff08Secret Discovery Service\uff0c\u79d8\u5bc6\u53d1\u73b0\u670d\u52a1\uff09\u5b9e\u73b0 SVID \u8bc1\u4e66\u7684\u7b7e\u53d1\u548c\u8f6e\u6362 \u3002Istio \u7f51\u683c\u5185\u7684 mTLS \u6d41\u7a0b\u5982\u4e0b\uff1a Sidecar \u4ee3\u66ff\u5de5\u4f5c\u8d1f\u8f7d\u5411 Istiod \u7533\u8bf7\u8bc1\u4e66\uff0cIstiod \u7b7e\u53d1 SVID \u8bc1\u4e66 \u5ba2\u6237\u7aef\u8bf7\u6c42\u88ab Pod \u5185\u7684 sidecar \u62e6\u622a \uff1b \u5ba2\u6237\u7aef sidecar \u4e0e\u670d\u52a1\u7aef sidecar \u5f00\u59cb mTLS \u63e1\u624b \u3002 \u5728\u63e1\u624b\u7684\u540c\u65f6\uff0c\u5ba2\u6237\u7aef sidecar \u4e2d\u7684 JWT \u548c\u8ba4\u8bc1\u8fc7\u6ee4\u5668\u5c06\u5bf9\u8bf7\u6c42\u7684\u8eab\u4efd\u8fdb\u884c\u8ba4\u8bc1\uff0c\u8ba4\u8bc1\u901a\u8fc7\u540e\u5c06\u8eab\u4efd\u5b58\u50a8\u5728\u8fc7\u6ee4\u5668\u5143\u6570\u636e\u4e2d\uff0c\u7136\u540e\u8bf7\u6c42\u7ecf\u8fc7\u6388\u6743\u8fc7\u6ee4\u5668\uff0c\u5224\u65ad\u8bf7\u6c42\u6743\u9650\u3002 \u82e5\u8bf7\u6c42\u901a\u8fc7\u4e86\u8ba4\u8bc1\u4e0e\u6388\u6743\uff0c\u5219\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u5f00\u59cb\u5efa\u7acb\u8fde\u63a5\u8fdb\u884c\u901a\u4fe1\u3002 Istio \u4e2d\u6709\u4e09\u4e2a\u8d44\u6e90\u5bf9\u8c61\u53ef\u7528\u4e8e\u914d\u7f6e\u670d\u52a1\u95f4\u7684\u8ba4\u8bc1\u4e0e\u6388\u6743\uff1a RequestAuthentication \uff1a\u7528\u4e8e\u5b9a\u4e49\u670d\u52a1\u652f\u6301\u7684\u8bf7\u6c42\u7ea7\u8ba4\u8bc1\u65b9\u5f0f\uff0c\u76ee\u524d\u53ea\u652f\u6301 JWT\uff1b PeerAuthentication \uff1a\u914d\u7f6e\u670d\u52a1\u95f4\u7684\u4f20\u8f93\u8ba4\u8bc1\u6a21\u5f0f\uff0c\u5982 STRICT \u3001 PERMISSIVE \u6216 DISABLE \u7b49\uff0c\u4ee5\u5f00\u542f mTLS \u6216\u660e\u6587\u8bf7\u6c42\uff1b AuthorizationPolicy \uff1a\u7528\u4e8e\u6388\u6743\u670d\u52a1\u95f4\u7684\u6d41\u91cf\uff0c\u5b9a\u4e49\u8c01\u53ef\u4ee5\u505a\u4ec0\u4e48\uff1f\u4f8b\u5982\u4e3b\u4f53 A \u5141\u8bb8\uff08 ALLOW \uff09\u6216\u62d2\u7edd\uff08 DENY \uff09\u6765\u81ea\u4e3b\u4f53 B \u7684\u6d41\u91cf\uff1b","title":"Istio \u4e2d\u5982\u4f55\u5b9e\u73b0\u81ea\u52a8 mTLS\uff1f"},{"location":"chap9/8istio_mtls/#istio-mtls_2","text":"\u4f60\u53ef\u4ee5\u5728 PeerAuthentication \u4e2d\u6307\u5b9a\u5bf9\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u65bd\u7684 mTLS \u6a21\u5f0f\u3002\u5bf9\u7b49\u8ba4\u8bc1\u652f\u6301\u4ee5\u4e0b\u6a21\u5f0f\uff1a PERMISSIVE\uff1a\u9ed8\u8ba4\u503c\uff0c\u5de5\u4f5c\u8d1f\u8f7d\u53ef\u63a5\u53d7\u53cc\u5411 TLS \u6216\u7eaf\u6587\u672c\u6d41\u91cf\uff1b STRICT\uff1a\u5de5\u4f5c\u8d1f\u8f7d\u4ec5\u63a5\u53d7 mTLS \u6d41\u91cf\uff1b DISABLE\uff1a\u7981\u7528 mTLS\u3002\u4ece\u5b89\u5168\u89d2\u5ea6\u6765\u770b\uff0c\u9664\u975e\u4f60\u6709\u81ea\u5df1\u7684\u5b89\u5168\u89e3\u51b3\u65b9\u6848\uff0c\u5426\u5219\u4e0d\u5e94\u7981\u7528 mTLS\uff1b UNSET\uff1a\u4ece\u7236\u7ea7\u7ee7\u627f\uff0c\u4f18\u5148\u7ea7\u4e3a\u670d\u52a1\u7279\u5b9a > \u547d\u540d\u7a7a\u95f4\u8303\u56f4 > \u7f51\u683c\u8303\u56f4\u7684\u8bbe\u7f6e \uff1b Istio \u7684\u5bf9\u7b49\u8ba4\u8bc1\u9ed8\u8ba4\u4f7f\u7528 PERMISSIVE \u6a21\u5f0f\uff0c\u81ea\u52a8\u5c06 mTLS \u6d41\u91cf\u53d1\u9001\u5230\u8fd9\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5c06\u7eaf\u6587\u672c\u6d41\u91cf\u53d1\u9001\u5230\u6ca1\u6709 sidecar \u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002 \u5728\u5c06 Kubernetes \u670d\u52a1\u7eb3\u5165 Istio \u7f51\u683c\u540e\uff0c\u4e3a\u4e86\u9632\u6b62\u670d\u52a1\u65e0\u6cd5\u901a\u8fc7 mTLS\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u4f7f\u7528 PERMISSIVE \u6a21\u5f0f\u3002\u5f53\u6211\u60f3\u4e3a\u67d0\u4e9b\u670d\u52a1\u5f00\u542f\u4e25\u683c\u7684 mTLS \u6a21\u5f0f\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u4e24\u79cd\u65b9\u5f0f\u4e4b\u4e00\uff1a \u4f7f\u7528 PeerAuthentication \u5b9a\u4e49\u6d41\u91cf\u5982\u4f55\u5728 sidecar \u4e4b\u95f4\u4f20\u8f93 \uff1b \u4f7f\u7528 DestinationRule \u5b9a\u4e49\u6d41\u91cf\u8def\u7531\u7b56\u7565\u4e2d\u7684 TLS \u8bbe\u7f6e\uff1b \u4e0b\u9762\u4ee5\u4e3a default \u547d\u540d\u7a7a\u95f4\u4e0b\u7684 reviews \u670d\u52a1\u8bbe\u7f6e mTLS \u4e3a\u4f8b\u8bf4\u660e\u3002","title":"\u5982\u4f55\u4f7f\u7528 Istio \u4e3a\u670d\u52a1\u5f00\u542f\u81ea\u52a8 mTLS\uff1f"},{"location":"chap9/8istio_mtls/#peerauthentication-mtls","text":"\u4f60\u53ef\u4ee5\u4f7f\u7528 namespace \u548c selector \u6307\u5b9a\u67d0\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u67d0\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u5f00\u542f\u4e25\u683c\u7684 mTLS\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\uff1a apiVersion: security.istio.io/v1beta1 kind: PeerAuthentication metadata: name: foo-peer-policy namespace: default spec: selector: matchLabels: app: reviews mtls: mode: STRICT \u4f60\u4e5f\u53ef\u4ee5\u7ed9\u5b89\u88c5 Istio \u7684\u547d\u540d\u7a7a\u95f4 istio-system \u8bbe\u7f6e\u4e25\u683c\u7684 mTLS\uff0c\u90a3\u6837\u4f1a\u4e3a\u7f51\u683c\u4e2d\u7684\u6240\u6709\u670d\u52a1\u5f00\u542f\u4e25\u683c\u7684 mTLS","title":"\u4f7f\u7528 PeerAuthentication \u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u8bbe\u7f6e mTLS"},{"location":"chap9/8istio_mtls/#destinationrule-mtls","text":"DestinationRule \u7528\u4e8e\u8bbe\u7f6e\u6d41\u91cf\u8def\u7531\u7b56\u7565\uff0c\u4f8b\u5982\u8d1f\u8f7d\u5747\u8861\u3001\u5f02\u5e38\u70b9\u68c0\u6d4b\u3001TLS \u8bbe\u7f6e\u7b49\u3002\u5176\u4e2d TLS \u8bbe\u7f6e\u4e2d\u5305\u542b\u591a\u79cd\u6a21\u5f0f\uff0c\u4f7f\u7528 ISTIO_MUTUAL \u6a21\u5f0f\u53ef\u4ee5\u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u5f00\u542f Istio \u7684\u81ea\u52a8 TLS\uff0c\u5982\u4e0b\u6240\u793a\u3002 apiVersion: networking.istio.io/v1beta1 kind: DestinationRule metadata: name: reviews namespace: default spec: host: reviews trafficPolicy: tls: mode: ISTIO_MUTUAL","title":"\u4f7f\u7528 DestinationRule \u4e3a\u5de5\u4f5c\u8d1f\u8f7d\u8bbe\u7f6e mTLS"},{"location":"chap9/8istio_mtls/#mtls","text":"\u4e92\u8054\u7f51\u5ba2\u6237\u7aef\u5bf9 Web \u670d\u52a1\u7684\u8bbf\u95ee\uff0c\u4e00\u822c\u4f7f\u7528\u5355\u5411 TLS\uff0c\u5373\u53ea\u9700\u8981\u670d\u52a1\u7aef\u63d0\u4f9b\u8eab\u4efd\u8bc1\u660e\uff0c\u800c\u4e0d\u5173\u5fc3\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u3002 \u5f53\u4f60\u9700\u8981\u9a8c\u8bc1\u5ba2\u6237\u7aef\u8eab\u4efd\u65f6\uff0c\u4f7f\u7528\u5355\u5411 TLS \u53ef\u4ee5\u4f7f\u7528\u5bc6\u7801\u3001token\u3001\u53cc\u56e0\u5b50\u8ba4\u8bc1\u7b49\u65b9\u5f0f\u3002\u4e0d\u8fc7\u8fd9\u6837\u7684\u8ba4\u8bc1\u65b9\u5f0f\u9700\u8981\u5e94\u7528\u7a0b\u5e8f\u5185\u90e8\u652f\u6301\uff0c\u800c\u53cc\u5411 TLS \u662f\u8fd0\u884c\u5728\u5e94\u7528\u7a0b\u5e8f\u4e4b\u5916\u7684\uff0c\u4e0d\u9700\u8981\u591a\u5e94\u7528\u903b\u8f91\u8fdb\u884c\u4fee\u6539\u3002 \u5f53\u4f60\u9700\u8981\u6b63\u5982\u4f60\u5728\u4e0a\u6587\u4e2d\u770b\u5230\u7684\uff0c\u5b9e\u65bd mTLS \u7684\u670d\u52a1\u95f4\u9700\u8981\u4ea4\u6362\u8bc1\u4e66\uff0c\u5f53\u670d\u52a1\u6570\u91cf\u53d8\u5927\u65f6\uff0c\u5c31\u9700\u8981\u7ba1\u7406\u5927\u91cf\u7684\u8bc1\u4e66\uff0c\u8fd9\u9700\u8981\u6d88\u8017\u5927\u91cf\u7684\u7cbe\u529b\uff0c\u4f7f\u7528\u670d\u52a1\u7f51\u683c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u5b9e\u73b0\u81ea\u52a8 mTLS\uff0c\u5f7b\u5e95\u89e3\u51b3\u8bc1\u4e66\u7ba1\u7406\u7684\u96be\u9898\u3002","title":"\u4ec0\u4e48\u65f6\u5019\u7528 mTLS\uff1f"},{"location":"chap9/8istio_mtls/#mtls_1","text":"\u867d\u7136 mTLS \u662f\u786e\u4fdd\u4e91\u539f\u751f\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u95f4\u901a\u4fe1\u5b89\u5168\u7684\u9996\u9009\u534f\u8bae\uff0c \u4f46\u662f\u5e94\u7528 mTLS \u9700\u8981\u5b8c\u6210\u590d\u6742\u7684\u5bf9\u79f0\u52a0\u5bc6\u3001\u89e3\u5bc6\u8fc7\u7a0b\uff0c\u8fd9\u5c06\u975e\u5e38\u8017\u65f6\u4e14\u6d88\u8017\u5927\u91cf\u7684 CPU \u8d44\u6e90 \u5bf9\u4e8e\u67d0\u4e9b\u5b89\u5168\u7ea7\u522b\u4e0d\u9ad8\u7684\u6d41\u91cf\uff0c\u5982\u679c\u6211\u4eec\u5728\u6d41\u91cf\u5165\u53e3\u5904\u7ec8\u6b62 TLS\uff0c\u5e76\u7f51\u683c\u5185\u90e8\u4ec5\u5bf9\u9488\u5bf9\u6027\u7684\u670d\u52a1\u5f00\u542f mTLS\uff0c\u5c31\u53ef\u4ee5\u52a0\u5feb\u8bf7\u6c42\u54cd\u5e94\u548c\u51cf\u5c11\u8ba1\u7b97\u8d44\u6e90\u6d88\u8017\u3002 \u53e6\u5916\u5f53\u6709\u7684\u670d\u52a1\u65e0\u6cd5\u83b7\u53d6\u8bc1\u4e66\uff0c\u4f8b\u5982 Kubelet \u4e0a\u4f7f\u7528 HTTP \u7684\u5065\u5eb7\u68c0\u67e5\uff0c\u65e0\u6cd5\u901a\u8fc7 TLS \u8bbf\u95ee\u670d\u52a1\u5185\u7684\u5065\u5eb7\u68c0\u67e5\u7aef\u70b9\uff0c\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u4e3a Pod \u7981\u7528\u63a2\u9488\u91cd\u5199 \u6700\u540e\u5f53\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u8bbf\u95ee\u4e00\u4e9b\u5916\u90e8\u670d\u52a1\u65f6\uff0c\u4e5f\u4e0d\u9700\u8981 mTLS\u3002","title":"\u4ec0\u4e48\u65f6\u5019\u4e0d\u7528 mTLS\uff1f"},{"location":"chap9/8istio_mtls/#_1","text":"mTLS \u5b9e\u73b0\u4e86\u7f51\u683c\u5185\u6d41\u91cf\u7684\u52a0\u5bc6\uff0c\u662f\u6784\u5efa\u96f6\u4fe1\u4efb\u5e94\u7528\u7f51\u7edc\u7684\u5173\u952e\u4e00\u6b65\u3002\u501f\u52a9 Istio \u6211\u4eec\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u4e3a Kubernetes \u4e2d\u7684\u670d\u52a1\u5f00\u542f\u81ea\u52a8 mTLS\uff0c\u7701\u53bb\u7ba1\u7406\u8bc1\u4e66\u7684\u9ebb\u70e6\u3002\u540c\u65f6\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u9488\u5bf9\u6027\u7684\u4e3a\u7f51\u683c\u5185\u7684\u90e8\u5206\u670d\u52a1\u5f00\u542f mTLS\uff0c\u4fbf\u4e8e\u6211\u4eec\u5c06 Kubernetes \u4e2d\u7684\u670d\u52a1\u8fc1\u79fb\u5230\u7f51\u683c\u5185\u3002\u5173\u4e8e Istio \u4e2d\u7684\u8bc1\u4e66\u7ba1\u7406\uff0c\u6211\u4eec\u5c06\u5728\u4eca\u540e\u7684\u535a\u5ba2\u4e2d\u518d\u505a\u8bf4\u660e\u3002","title":"\u603b\u7ed3"},{"location":"extra/mk_book/","text":"GitHub+Travis+Mkdocs\u81ea\u52a8\u5316\u6784\u5efa\u6587\u6863\u5e93(Istio) mkdocs new jxistiobook cd jxistiobook ls docs mkdocs.yml echo \"# jxawscsaabook\" >> README.md git init git remote add origin https://github.com/Chao-Xi/jxistiobook.git # pip3 install mkdocs-awesome-pages-plugin https://travis-ci.com https://app.travis-ci.com/github/Chao-Xi/jxistiobook GITHUB_NAME : github password GITHUB_EMAIL : xichao2015@outlook.com GITHUB_API_KEY : ghp...jxhzd","title":"GitHub+Travis+Mkdocs\u81ea\u52a8\u5316\u6784\u5efa\u6587\u6863\u5e93(Istio)"},{"location":"extra/mk_book/#githubtravismkdocsistio","text":"mkdocs new jxistiobook cd jxistiobook ls docs mkdocs.yml echo \"# jxawscsaabook\" >> README.md git init git remote add origin https://github.com/Chao-Xi/jxistiobook.git # pip3 install mkdocs-awesome-pages-plugin https://travis-ci.com https://app.travis-ci.com/github/Chao-Xi/jxistiobook GITHUB_NAME : github password GITHUB_EMAIL : xichao2015@outlook.com GITHUB_API_KEY : ghp...jxhzd","title":"GitHub+Travis+Mkdocs\u81ea\u52a8\u5316\u6784\u5efa\u6587\u6863\u5e93(Istio)"}]}